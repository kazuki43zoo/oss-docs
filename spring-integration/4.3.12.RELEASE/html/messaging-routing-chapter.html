<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>6.&nbsp;Message Routing</title><link rel="stylesheet" type="text/css" href="css/manual-multipage.css"><meta name="generator" content="DocBook XSL Stylesheets V1.78.1"><link rel="home" href="index.html" title="Spring Integration Reference Manual"><link rel="up" href="spring-integration-core-messaging.html" title="Part&nbsp;IV.&nbsp;Core Messaging"><link rel="prev" href="messaging-construction-chapter.html" title="5.&nbsp;Message Construction"><link rel="next" href="messaging-transformation-chapter.html" title="7.&nbsp;Message Transformation"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">6.&nbsp;Message Routing</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="messaging-construction-chapter.html">Prev</a>&nbsp;</td><th width="60%" align="center">Part&nbsp;IV.&nbsp;Core Messaging</th><td width="20%" align="right">&nbsp;<a accesskey="n" href="messaging-transformation-chapter.html">Next</a></td></tr></table><hr></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="messaging-routing-chapter" href="#messaging-routing-chapter"></a>6.&nbsp;Message Routing</h2></div></div></div>

<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="router" href="#router"></a>6.1&nbsp;Routers</h2></div></div></div>

<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="router-overview" href="#router-overview"></a>6.1.1&nbsp;Overview</h3></div></div></div>

<p>Routers are a crucial element in many messaging architectures.
They consume Messages from a Message Channel and forward each consumed message to one or more different Message Channel depending on a set of conditions.</p>
<p>Spring Integration provides the following routers out-of-the-box:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="emphasis"><em><a class="link" href="messaging-routing-chapter.html#router-implementations-payloadtyperouter" title="PayloadTypeRouter">Payload Type Router</a></em></span>
</li><li class="listitem">
<span class="emphasis"><em><a class="link" href="messaging-routing-chapter.html#router-implementations-headervaluerouter" title="HeaderValueRouter">Header Value Router</a></em></span>
</li><li class="listitem">
<span class="emphasis"><em><a class="link" href="messaging-routing-chapter.html#router-implementations-recipientlistrouter" title="RecipientListRouter">Recipient List Router</a></em></span>
</li><li class="listitem">
<span class="emphasis"><em><a class="link" href="xml.html#xml-xpath-routing" title="35.6&nbsp;Routing XML Messages Using XPath">XPath Router (Part of the XML Module)</a></em></span>
</li><li class="listitem">
<span class="emphasis"><em><a class="link" href="messaging-routing-chapter.html#router-implementations-exception-router" title="Routing and Error handling">Error Message Exception Type Router</a></em></span>
</li><li class="listitem">
<span class="emphasis"><em><a class="link" href="messaging-routing-chapter.html#router-namespace" title="6.1.4&nbsp;Configuring (Generic) Router">(Generic) Router</a></em></span>
</li></ul></div>
<p>Router implementations share many configuration parameters.
Yet, certain differences exist between routers.
Furthermore, the availability of configuration parameters depends on whether Routers are used inside or outside of a chain.
In order to provide a quick overview, all available attributes are listed in the 2 tables below.</p>
<div class="table"><a name="d5e1928" href="#d5e1928"></a><p class="title"><b>Table&nbsp;6.1.&nbsp;Routers Outside of a Chain</b></p><div class="table-contents">

<table summary="Routers Outside of a Chain" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"><col class="col_4"><col class="col_5"><col class="col_6"><col class="col_7"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Attribute</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">router</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">header value router</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">xpath router</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">payload type router</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">recipient list router</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">exception type router</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>apply-sequence</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>default-output-channel</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>resolution-required</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>ignore-send-failures</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>timeout</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>id</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>auto-startup</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>input-channel</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>order</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>method</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>ref</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>expression</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>header-name</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>evaluate-as-string</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>xpath-expression-ref</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>converter</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="" align="left" valign="top">&nbsp;</td></tr></tbody></table>
</div></div><br class="table-break">
<div class="table"><a name="d5e2458" href="#d5e2458"></a><p class="title"><b>Table&nbsp;6.2.&nbsp;Routers Inside of a Chain</b></p><div class="table-contents">

<table summary="Routers Inside of a Chain" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"><col class="col_4"><col class="col_5"><col class="col_6"><col class="col_7"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Attribute</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">router</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">header value router</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">xpath router</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">payload type router</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">recipient list router</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">exception type router</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>apply-sequence</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>default-output-channel</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>resolution-required</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>ignore-send-failures</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>timeout</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>id</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>auto-startup</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>input-channel</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>order</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>method</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>ref</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>expression</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>header-name</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>evaluate-as-string</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>xpath-expression-ref</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>converter</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="" align="left" valign="top">&nbsp;</td></tr></tbody></table>
</div></div><br class="table-break">
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Router parameters have been more standardized across all router implementations with Spring Integration 2.1.
Consequently, there are a few minor changes that leave the possibility of breaking older Spring Integration based applications.</p>
<p>Since Spring Integration 2.1 the <code class="literal">ignore-channel-name-resolution-failures</code> attribute is removed in favor of consolidating its behavior with the <code class="literal">resolution-required</code> attribute.
Also, the <code class="literal">resolution-required</code> attribute now defaults to <code class="literal">true</code>.</p>
<p>Prior to these changes, the <code class="literal">resolution-required</code> attribute defaulted to <code class="literal">false</code> causing messages to be silently dropped when no channel was resolved and no <code class="literal">default-output-channel</code> was set.
The new behavior will require at least one resolved channel and by default will throw an <code class="literal">MessageDeliveryException</code> if no channel was determined (or an attempt to send was not successful).</p>
<p>If you do desire to drop messages silently simply set <code class="literal">default-output-channel="nullChannel"</code>.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="router-common-parameters" href="#router-common-parameters"></a>6.1.2&nbsp;Common Router Parameters</h3></div></div></div>

<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="router-common-parameters-all" href="#router-common-parameters-all"></a>Inside and Outside of a Chain</h4></div></div></div>

<p>The following parameters are valid for all routers inside and outside of chains.</p>
<div class="variablelist"><dl class="variablelist"><dt><span class="term"><span class="strong"><strong>apply-sequence</strong></span></span></dt><dd>
This attribute specifies whether sequence number and size headers should be added to each Message.
This <span class="emphasis"><em>optional</em></span> attribute defaults to <span class="emphasis"><em>false</em></span>.
</dd><dt><span class="term"><span class="strong"><strong>default-output-channel</strong></span></span></dt><dd>
If set, this attribute provides a reference to the channel, where Messages should be sent, if channel resolution fails to return any channels.
If no default output channel is provided, the router will throw an Exception.
If you would like to silently drop those messages instead, add the <code class="literal">nullChannel</code> as the default output channel attribute value.
</dd></dl></div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>A Message will only be sent to the <code class="literal">default-output-channel</code> if <code class="literal">resolution-required</code> is false and the channel is not resolved.</p>
</td></tr></table></div>
<div class="variablelist"><dl class="variablelist"><dt><span class="term"><span class="strong"><strong>resolution-required</strong></span></span></dt><dd>
If <span class="emphasis"><em>true</em></span> this attribute specifies that channel names must always be successfully resolved to channel instances that exist.
If set to <span class="emphasis"><em>true</em></span>, a <code class="literal">MessagingException</code> will be raised, in case the channel cannot be resolved.
Setting this attribute to <span class="emphasis"><em>false</em></span>, will cause any unresovable channels to be ignored.
This <span class="emphasis"><em>optional</em></span> attribute will, if not explicitly set, default to <span class="emphasis"><em>true</em></span>.
</dd></dl></div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>A Message will only be sent to the <code class="literal">default-output-channel</code>, if specified, when <code class="literal">resolution-required</code> is false and the channel is not resolved.</p>
</td></tr></table></div>
<div class="variablelist"><dl class="variablelist"><dt><span class="term"><span class="strong"><strong>ignore-send-failures</strong></span></span></dt><dd>
If set to <span class="emphasis"><em>true</em></span>, failures to send to a message channel will be ignored.
If set to <span class="emphasis"><em>false</em></span>, a <code class="literal">MessageDeliveryException</code> will be thrown instead, and if the router resolves more than one channel, any subsequent channels will not receive the message.
</dd></dl></div>
<p>The exact behavior of this attribute depends on the type of the <code class="literal">Channel</code> messages are sent to.
For example, when using direct channels (single threaded), send-failures can be caused by exceptions thrown by components much further down-stream.
However, when sending messages to a simple queue channel (asynchronous) the likelihood of an exception to be thrown is rather remote.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>While most routers will route to a single channel, they are allowed to return more than one channel name.
The <code class="literal">recipient-list-router</code>, for instance, does exactly that.
If you set this attribute to <span class="emphasis"><em>true</em></span> on a router that only routes to a single channel, any caused exception is simply swallowed, which usually makes little sense to do.
In that case it would be better to catch the exception in an error flow at the flow entry point.
Therefore, setting the <code class="literal">ignore-send-failures</code> attribute to <span class="emphasis"><em>true</em></span> usually makes more sense when the router implementation returns more than one channel name, because the other channel(s) following the one that fails would still receive the Message.</p>
</td></tr></table></div>
<p>This attribute defaults to <span class="emphasis"><em>false</em></span>.</p>
<div class="variablelist"><dl class="variablelist"><dt><span class="term"><span class="strong"><strong>timeout</strong></span></span></dt><dd>
The <code class="literal">timeout</code> attribute specifies the maximum amount of time in milliseconds to wait, when sending Messages to the target Message Channels.
By default the send operation will block indefinitely.
</dd></dl></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="router-common-parameters-top" href="#router-common-parameters-top"></a>Top-Level (Outside of a Chain)</h4></div></div></div>

<p>The following parameters are valid only across all top-level routers that are ourside of chains.</p>
<div class="variablelist"><dl class="variablelist"><dt><span class="term"><span class="strong"><strong>id</strong></span></span></dt><dd>
Identifies the underlying Spring bean definition which in case of Routers is an instance of EventDrivenConsumer or PollingConsumer depending on whether the Router&#8217;s <span class="emphasis"><em>input-channel</em></span> is a <span class="emphasis"><em>SubscribableChannel</em></span> or <span class="emphasis"><em>PollableChannel</em></span>, respectively.
This is an <span class="emphasis"><em>optional</em></span> attribute.
</dd><dt><span class="term"><span class="strong"><strong>auto-startup</strong></span></span></dt><dd>
This <code class="literal">Lifecycle</code> attribute signaled if this component should be started during startup of the Application Context.
This <span class="emphasis"><em>optional</em></span> attribute defaults to <span class="emphasis"><em>true</em></span>.
</dd><dt><span class="term"><span class="strong"><strong>input-channel</strong></span></span></dt><dd>
The receiving Message channel of this endpoint.
</dd><dt><span class="term"><span class="strong"><strong>order</strong></span></span></dt><dd>
This attribute defines the order for invocation when this endpoint is connected as a subscriber to a channel.
This is particularly relevant when that channel is using a <span class="emphasis"><em>failover</em></span> dispatching strategy.
It has no effect when this endpoint itself is a Polling Consumer for a channel with a queue.
</dd></dl></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="router-implementations" href="#router-implementations"></a>6.1.3&nbsp;Router Implementations</h3></div></div></div>

<p>Since content-based routing often requires some domain-specific logic, most use-cases will require Spring Integration&#8217;s options for delegating to POJOs using the XML namespace support and/or Annotations.
Both of these are discussed below, but first we present a couple implementations that are available out-of-the-box since they fulfill common requirements.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="router-implementations-payloadtyperouter" href="#router-implementations-payloadtyperouter"></a>PayloadTypeRouter</h4></div></div></div>

<p>A <code class="literal">PayloadTypeRouter</code> will send Messages to the channel as defined by payload-type mappings.</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"payloadTypeRouter"</span>
      <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.router.PayloadTypeRouter"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"channelMapping"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;map&gt;</span>
            <span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"java.lang.String"</span> <span class="hl-attribute">value-ref</span>=<span class="hl-value">"stringChannel"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"java.lang.Integer"</span> <span class="hl-attribute">value-ref</span>=<span class="hl-value">"integerChannel"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/map&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
<p>Configuration of the <code class="literal">PayloadTypeRouter</code> is also supported via the namespace provided by Spring Integration (see <a class="xref" href="configuration.html#configuration-namespace" title="F.2&nbsp;Namespace Support">Section&nbsp;F.2, &#8220;Namespace Support&#8221;</a>), which essentially simplifies configuration by combining the <code class="literal">&lt;router/&gt;</code> configuration and its corresponding implementation defined using a <code class="literal">&lt;bean/&gt;</code> element into a single and more concise configuration element.
The example below demonstrates a <code class="literal">PayloadTypeRouter</code> configuration which is equivalent to the one above using the namespace support:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:payload-type-router</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"routingChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:mapping</span> <span class="hl-attribute">type</span>=<span class="hl-value">"java.lang.String"</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"stringChannel"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;int:mapping</span> <span class="hl-attribute">type</span>=<span class="hl-value">"java.lang.Integer"</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"integerChannel"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/int:payload-type-router&gt;</span></pre>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="router-implementations-headervaluerouter" href="#router-implementations-headervaluerouter"></a>HeaderValueRouter</h4></div></div></div>

<p>A <code class="literal">HeaderValueRouter</code> will send Messages to the channel based on the individual header value mappings.
When a <code class="literal">HeaderValueRouter</code> is created it is initialized with the <span class="emphasis"><em>name</em></span> of the header to be evaluated.
The <span class="emphasis"><em>value</em></span> of the header could be one of two things:</p>
<p>1.
Arbitrary value</p>
<p>2.
Channel name</p>
<p>If arbitrary then additional mappings for these header values to channel names is required, otherwise no additional configuration is needed.</p>
<p>Spring Integration provides a simple namespace-based XML configuration to configure a <code class="literal">HeaderValueRouter</code>.
The example below demonstrates two types of namespace-based configuration for the <code class="literal">HeaderValueRouter</code>.</p>
<p><span class="emphasis"><em>1.
Configuration where mapping of header values to channels is required</em></span></p>
<pre class="programlisting"><span class="hl-tag">&lt;int:header-value-router</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"routingChannel"</span> <span class="hl-attribute">header-name</span>=<span class="hl-value">"testHeader"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:mapping</span> <span class="hl-attribute">value</span>=<span class="hl-value">"someHeaderValue"</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"channelA"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;int:mapping</span> <span class="hl-attribute">value</span>=<span class="hl-value">"someOtherHeaderValue"</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"channelB"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/int:header-value-router&gt;</span></pre>
<p>During the resolution process this router may encounter channel resolution failures, causing an exception.
If you want to suppress such exceptions and send unresolved messages to the default output channel (identified with the <code class="literal">default-output-channel</code> attribute) set <code class="literal">resolution-required</code> to <code class="literal">false</code>.</p>
<p>Normally, messages for which the header value is not explicitly mapped to a channel will be sent to the <code class="literal">default-output-channel</code>.
However, in cases where the header value is mapped to a channel name but the channel cannot be resolved, setting the <code class="literal">resolution-required</code> attribute to <code class="literal">false</code> will result in routing such messages to the <code class="literal">default-output-channel</code>.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>With Spring Integration 2.1 the attribute was changed from <code class="literal">ignore-channel-name-resolution-failures</code> to <code class="literal">resolution-required</code>.
Attribute <code class="literal">resolution-required</code> will default to <code class="literal">true</code>.</p>
</td></tr></table></div>
<p><span class="emphasis"><em>2.
Configuration where mapping of header values to channel names
              is not required since header values themselves represent channel names</em></span></p>
<pre class="programlisting"><span class="hl-tag">&lt;int:header-value-router</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"routingChannel"</span> <span class="hl-attribute">header-name</span>=<span class="hl-value">"testHeader"</span><span class="hl-tag">/&gt;</span></pre>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Since Spring Integration 2.1 the behavior of resolving channels is more explicit.
For example, if you ommit the <code class="literal">default-output-channel</code> attribute and the Router was unable to resolve at least one valid channel, and any channel name resolution failures were ignored by setting <code class="literal">resolution-required</code> to <code class="literal">false</code>, then a <code class="literal">MessageDeliveryException</code> is thrown.</p>
<p>Basically, by default the Router must be able to route messages successfully to at least one channel.
If you really want to drop messages, you must also have <code class="literal">default-output-channel</code> set to <code class="literal">nullChannel</code>.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="router-implementations-recipientlistrouter" href="#router-implementations-recipientlistrouter"></a>RecipientListRouter</h4></div></div></div>

<p>A <code class="literal">RecipientListRouter</code> will send each received Message to a statically defined list of Message Channels:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"recipientListRouter"</span>
      <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.router.RecipientListRouter"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"channels"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;list&gt;</span>
            <span class="hl-tag">&lt;ref</span> <span class="hl-attribute">bean</span>=<span class="hl-value">"channel1"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;ref</span> <span class="hl-attribute">bean</span>=<span class="hl-value">"channel2"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;ref</span> <span class="hl-attribute">bean</span>=<span class="hl-value">"channel3"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/list&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
<p>Spring Integration also provides namespace support for the <code class="literal">RecipientListRouter</code> configuration (see <a class="xref" href="configuration.html#configuration-namespace" title="F.2&nbsp;Namespace Support">Section&nbsp;F.2, &#8220;Namespace Support&#8221;</a>) as the example below demonstrates.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:recipient-list-router</span> <span class="hl-attribute">id</span>=<span class="hl-value">"customRouter"</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"routingChannel"</span>
        <span class="hl-attribute">timeout</span>=<span class="hl-value">"1234"</span>
        <span class="hl-attribute">ignore-send-failures</span>=<span class="hl-value">"true"</span>
        <span class="hl-attribute">apply-sequence</span>=<span class="hl-value">"true"</span><span class="hl-tag">&gt;</span>
  <span class="hl-tag">&lt;int:recipient</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"channel1"</span><span class="hl-tag">/&gt;</span>
  <span class="hl-tag">&lt;int:recipient</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"channel2"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:recipient-list-router&gt;</span></pre>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The <span class="emphasis"><em>apply-sequence</em></span> flag here has the same effect as it does for a publish-subscribe-channel, and like a publish-subscribe-channel, it is disabled by default on the recipient-list-router.
Refer to<a class="xref" href="messaging-channels-section.html#channel-configuration-pubsubchannel" title="PublishSubscribeChannel Configuration">the section called &#8220;PublishSubscribeChannel Configuration&#8221;</a> for more information.</p>
</td></tr></table></div>
<p>Another convenient option when configuring a <code class="literal">RecipientListRouter</code> is to use Spring Expression Language (SpEL) support as selectors for individual recipient channels.
This is similar to using a Filter at the beginning of <span class="emphasis"><em>chain</em></span> to act as a "Selective Consumer".
However, in this case, it&#8217;s all combined rather concisely into the router&#8217;s configuration.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:recipient-list-router</span> <span class="hl-attribute">id</span>=<span class="hl-value">"customRouter"</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"routingChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:recipient</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"channel1"</span> <span class="hl-attribute">selector-expression</span>=<span class="hl-value">"payload.equals('foo')"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int:recipient</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"channel2"</span> <span class="hl-attribute">selector-expression</span>=<span class="hl-value">"headers.containsKey('bar')"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:recipient-list-router&gt;</span></pre>
<p>In the above configuration a SpEL expression identified by the <code class="literal">selector-expression</code> attribute will be evaluated to determine if this recipient should be included in the recipient list for a given input Message.
The evaluation result of the expression must be a boolean.
If this attribute is not defined, the channel will always be among the list of recipients.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="recipient-list-router-management" href="#recipient-list-router-management"></a>RecipientListRouterManagement</h4></div></div></div>

<p>Starting with <span class="emphasis"><em>version 4.1</em></span>, the <code class="literal">RecipientListRouter</code> provides several operation to manipulate with <span class="emphasis"><em>recipients</em></span> dynamically at runtime.
These management operations are presented by <code class="literal">RecipientListRouterManagement</code> <code class="literal">@ManagedResource</code>.
They are available using <a class="xref" href="system-management-chapter.html#control-bus" title="9.6&nbsp;Control Bus">Section&nbsp;9.6, &#8220;Control Bus&#8221;</a> as well as via JMX:</p>
<pre class="programlisting"><span class="hl-tag">&lt;control-bus</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"controlBus"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;recipient-list-router</span> <span class="hl-attribute">id</span>=<span class="hl-value">"simpleRouter"</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"routingChannelA"</span><span class="hl-tag">&gt;</span>
   <span class="hl-tag">&lt;recipient</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"channel1"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/recipient-list-router&gt;</span>

<span class="hl-tag">&lt;channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"channel2"</span><span class="hl-tag">/&gt;</span></pre>
<pre class="programlisting">messagingTemplate.convertAndSend(controlBus, <span class="hl-string">"@'simpleRouter.handler'.addRecipient('channel2')"</span>);</pre>
<p>From the application start up the <code class="literal">simpleRouter</code> will have only one <code class="literal">channel1</code> recipient.
But after the <code class="literal">addRecipient</code> command above the new <code class="literal">channel2</code> recipient will be added.
It is a "registering an interest in something that is part of the Message" use case, when we may be interested in messages from the <span class="emphasis"><em>router</em></span> at some time period, so we are <span class="emphasis"><em>subscribing</em></span> to the the <code class="literal">recipient-list-router</code> and in some point decide to <span class="emphasis"><em>unsubscribe</em></span> our interest.</p>
<p>Having the runtime management operation for the <code class="literal">&lt;recipient-list-router&gt;</code>, it can be configured without any <code class="literal">&lt;recipient&gt;</code> from the start.
In this case the behaviour of <code class="literal">RecipientListRouter</code> is the same, when there is no one matching recipient for the message: if <code class="literal">defaultOutputChannel</code> is configured, the message will be sent there, otherwise the <code class="literal">MessageDeliveryException</code> is thrown.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="router-implementations-xpath-router" href="#router-implementations-xpath-router"></a>XPath Router</h4></div></div></div>

<p>The XPath Router is part of the XML Module.
As such, please read chapter <span class="emphasis"><em><a class="xref" href="xml.html#xml-xpath-routing" title="35.6&nbsp;Routing XML Messages Using XPath">Section&nbsp;35.6, &#8220;Routing XML Messages Using XPath&#8221;</a></em></span></p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="router-implementations-exception-router" href="#router-implementations-exception-router"></a>Routing and Error handling</h4></div></div></div>

<p>Spring Integration also provides a special type-based router called <code class="literal">ErrorMessageExceptionTypeRouter</code> for routing Error Messages (Messages whose <code class="literal">payload</code> is a <code class="literal">Throwable</code> instance).
<code class="literal">ErrorMessageExceptionTypeRouter</code> is very similar to the <code class="literal">PayloadTypeRouter</code>.
In fact they are almost identical.
The only difference is that while <code class="literal">PayloadTypeRouter</code> navigates the instance hierarchy of a payload instance (e.g., <code class="literal">payload.getClass().getSuperclass()</code>) to find the most specific type/channel mappings,
the <code class="literal">ErrorMessageExceptionTypeRouter</code> navigates the hierarchy of <span class="emphasis"><em>exception causes</em></span> (e.g., <code class="literal">payload.getCause()</code>)
to find the most specific <code class="literal">Throwable</code> type/channel mappings and uses <code class="literal">mappingClass.isInstance(cause)</code> to match the
<code class="literal">cause</code> to the class or any super class.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Since <span class="emphasis"><em>version 4.3</em></span> the <code class="literal">ErrorMessageExceptionTypeRouter</code> loads all mapping classes during the initialization
phase to fail-fast for a <code class="literal">ClassNotFoundException</code>.</p>
</td></tr></table></div>
<p>Below is a sample configuration for <code class="literal">ErrorMessageExceptionTypeRouter</code>.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:exception-type-router</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"inputChannel"</span>
                           <span class="hl-attribute">default-output-channel</span>=<span class="hl-value">"defaultChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:mapping</span> <span class="hl-attribute">exception-type</span>=<span class="hl-value">"java.lang.IllegalArgumentException"</span>
                 <span class="hl-attribute">channel</span>=<span class="hl-value">"illegalChannel"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int:mapping</span> <span class="hl-attribute">exception-type</span>=<span class="hl-value">"java.lang.NullPointerException"</span>
                 <span class="hl-attribute">channel</span>=<span class="hl-value">"npeChannel"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:exception-type-router&gt;</span>

<span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"illegalChannel"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"npeChannel"</span><span class="hl-tag"> /&gt;</span></pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="router-namespace" href="#router-namespace"></a>6.1.4&nbsp;Configuring (Generic) Router</h3></div></div></div>

<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_configuring_a_content_based_router_with_xml" href="#_configuring_a_content_based_router_with_xml"></a>Configuring a Content Based Router with XML</h4></div></div></div>

<p>The "router" element provides a simple way to connect a router to an input channel and also accepts the optional <code class="literal">default-output-channel</code> attribute.
The <code class="literal">ref</code> attribute references the bean name of a custom Router implementation (extending <code class="literal">AbstractMessageRouter</code>):</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:router</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"payloadTypeRouter"</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input1"</span>
            <span class="hl-attribute">default-output-channel</span>=<span class="hl-value">"defaultOutput1"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int:router</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"recipientListRouter"</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input2"</span>
            <span class="hl-attribute">default-output-channel</span>=<span class="hl-value">"defaultOutput2"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int:router</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"customRouter"</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input3"</span>
            <span class="hl-attribute">default-output-channel</span>=<span class="hl-value">"defaultOutput3"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;beans:bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"customRouterBean"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.foo.MyCustomRouter"</span><span class="hl-tag">/&gt;</span></pre>
<p>Alternatively, <code class="literal">ref</code> may point to a simple POJO that contains the @Router annotation (see below), or the <code class="literal">ref</code> may be combined with an explicit <code class="literal">method</code> name.
Specifying a <code class="literal">method</code> applies the same behavior described in the @Router annotation section below.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:router</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"somePojo"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"someMethod"</span><span class="hl-tag">/&gt;</span></pre>
<p>Using a <code class="literal">ref</code> attribute is generally recommended if the custom router implementation is referenced in other <code class="literal">&lt;router&gt;</code> definitions.
However if the custom router implementation should be scoped to a single definition of the <code class="literal">&lt;router&gt;</code>, you may provide an inner bean definition:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:router</span> <span class="hl-attribute">method</span>=<span class="hl-value">"someMethod"</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input3"</span>
            <span class="hl-attribute">default-output-channel</span>=<span class="hl-value">"defaultOutput3"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;beans:bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.foo.MyCustomRouter"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:router&gt;</span></pre>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Using both the <code class="literal">ref</code> attribute and an inner handler definition in the same <code class="literal">&lt;router&gt;</code> configuration is not allowed, as it creates an ambiguous condition, and an Exception will be thrown.</p>
</td></tr></table></div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>If the "ref" attribute references a bean that extends <code class="literal">AbstractMessageProducingHandler</code> (such as routers provided by the framework itself), the configuration is optimized referencing the router directly.
In this case, each "ref" must be to a separate bean instance (or a <code class="literal">prototype</code>-scoped bean), or use the inner <code class="literal">&lt;bean/&gt;</code> configuration type.
However, this optimization only applies if you don&#8217;t provide any router-specific attributes in the router XML definition.
If you inadvertently reference the same message handler from multiple beans, you will get a configuration exception.</p>
</td></tr></table></div>
<p><span class="emphasis"><em>Routers and the Spring Expression Language (SpEL)</em></span></p>
<p>Sometimes the routing logic may be simple and writing a separate class for it and configuring it as a bean may seem like overkill.
As of Spring Integration 2.0 we offer an alternative where you can now use SpEL to implement simple computations that previously required a custom POJO router.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>For more information about the Spring Expression Language, please refer to the respective chapter in the Spring Framework Reference Documentation at:</p>
</td></tr></table></div>
<p>null</p>
<p>Generally a SpEL expression is evaluated and the result is mapped to a channel:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:router</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"inChannel"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"payload.paymentType"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:mapping</span> <span class="hl-attribute">value</span>=<span class="hl-value">"CASH"</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"cashPaymentChannel"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int:mapping</span> <span class="hl-attribute">value</span>=<span class="hl-value">"CREDIT"</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"authorizePaymentChannel"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int:mapping</span> <span class="hl-attribute">value</span>=<span class="hl-value">"DEBIT"</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"authorizePaymentChannel"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:router&gt;</span></pre>
<p>To simplify things even more, the SpEL expression may evaluate to a channel name:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:router</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"inChannel"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"payload + 'Channel'"</span><span class="hl-tag">/&gt;</span></pre>
<p>In the above configuration the result channel will be computed by the SpEL expression which simply concatenates the value of the <code class="literal">payload</code> with the literal String <span class="emphasis"><em>Channel</em></span>.</p>
<p>Another value of SpEL for configuring routers is that an expression can actually return a <code class="literal">Collection</code>, effectively making every <code class="literal">&lt;router&gt;</code> a <span class="emphasis"><em>Recipient List Router</em></span>.
Whenever the expression returns multiple channel values the Message will be forwarded to each channel.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:router</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"inChannel"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"headers.channels"</span><span class="hl-tag">/&gt;</span></pre>
<p>In the above configuration, if the Message includes a header with the name <span class="emphasis"><em>channels</em></span> the value of which is a <code class="literal">List</code> of channel names then the Message will be sent to each channel in the list.
You may also find <span class="emphasis"><em>Collection Projection</em></span> and <span class="emphasis"><em>Collection Selection</em></span> expressions useful to select multiple channels.
For further information, please see:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="ulink" href="http://static.springsource.org/spring/docs/current/spring-framework-reference/html/expressions.html#expressions-collection-projection" target="_top">Collection Projection</a>
</li><li class="listitem">
<a class="ulink" href="http://static.springsource.org/spring/docs/current/spring-framework-reference/html/expressions.html#expressions-collection-selection" target="_top">Collection Selection</a>
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="router-annotation" href="#router-annotation"></a>Configuring a Router with Annotations</h4></div></div></div>

<p>When using <code class="literal">@Router</code> to annotate a method, the method may return either a <code class="literal">MessageChannel</code> or <code class="literal">String</code> type.
In the latter case, the endpoint will resolve the channel name as it does for the default output channel.
Additionally, the method may return either a single value or a collection.
If a collection is returned, the reply message will be sent to multiple channels.
To summarize, the following method signatures are all valid.</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Router</span></em>
<span class="hl-keyword">public</span> MessageChannel route(Message message) {...}

<em><span class="hl-annotation" style="color: gray">@Router</span></em>
<span class="hl-keyword">public</span> List&lt;MessageChannel&gt; route(Message message) {...}

<em><span class="hl-annotation" style="color: gray">@Router</span></em>
<span class="hl-keyword">public</span> String route(Foo payload) {...}

<em><span class="hl-annotation" style="color: gray">@Router</span></em>
<span class="hl-keyword">public</span> List&lt;String&gt; route(Foo payload) {...}</pre>
<p>In addition to payload-based routing, a Message may be routed based on metadata available within the message header as either a property or attribute.
In this case, a method annotated with <code class="literal">@Router</code> may include a parameter annotated with <code class="literal">@Header</code> which is mapped to a header value as illustrated below and documented in <a class="xref" href="configuration.html#annotations" title="F.6&nbsp;Annotation Support">Section&nbsp;F.6, &#8220;Annotation Support&#8221;</a>.</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Router</span></em>
<span class="hl-keyword">public</span> List&lt;String&gt; route(<em><span class="hl-annotation" style="color: gray">@Header("orderStatus")</span></em> OrderStatus status)</pre>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>For routing of XML-based Messages, including XPath support, see <a class="xref" href="xml.html" title="35.&nbsp;XML Support - Dealing with XML Payloads">Chapter&nbsp;35, <i>XML Support - Dealing with XML Payloads</i></a>.</p>
</td></tr></table></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="dynamic-routers" href="#dynamic-routers"></a>6.1.5&nbsp;Dynamic Routers</h3></div></div></div>

<p>So as you can see, Spring Integration provides quite a few different router configurations for common <span class="emphasis"><em>content-based routing</em></span> use cases as well as the option of implementing custom routers as POJOs.
For example <code class="literal">PayloadTypeRouter</code> provides a simple way to configure a router which computes <code class="literal">channels</code> based on the <code class="literal">payload type</code> of the incoming Message while <code class="literal">HeaderValueRouter</code> provides the same convenience in configuring a router which computes <code class="literal">channels</code> by evaluating the value of a particular Message Header.
There are also <span class="emphasis"><em>expression-based</em></span> (SpEL) routers where the <code class="literal">channel</code> is determined based on evaluating an expression.
Thus, these type of routers exhibit some dynamic characteristics.</p>
<p>However these routers all require <span class="emphasis"><em>static configuration</em></span>.
Even in the case of expression-based routers, the expression itself is defined as part of the router configuration which means that_the same expression operating on the same value will always result in the computation of the same channel_.
This is acceptable in most cases since such routes are well defined and therefore predictable.
But there are times when we need to change router configurations dynamically so message flows may be routed to a different channel.</p>
<p><span class="emphasis"><em>Example:</em></span></p>
<p>You might want to bring down some part of your system for maintenance and temporarily re-reroute messages to a different message flow.
Or you may want to introduce more granularity to your message flow by adding another route to handle a more concrete type of <code class="literal">java.lang.Number</code> (in the case of <code class="literal">PayloadTypeRouter</code>).</p>
<p>Unfortunately with static router configuration to accomplish this, you would have to bring down your entire application, change the configuration of the router (change routes) and bring it back up.
This is obviously not the solution.</p>
<p>The <a class="ulink" href="http://www.eaipatterns.com/DynamicRouter.html" target="_top">Dynamic Router</a> pattern describes the mechanisms by which one can change/configure routers dynamically without bringing down the system or individual routers.&nbsp;</p>
<p>Before we get into the specifics of how this is accomplished in Spring Integration, let&#8217;s quickly summarize the typical flow of the router, which consists of 3 simple steps:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="emphasis"><em>Step 1</em></span> - Compute <code class="literal">channel identifier</code> which is a value calculated by the router once it receives the Message.
Typically it is a <code class="literal">String</code> or and instance of the actual <code class="literal">MessageChannel</code>.
</li><li class="listitem">
<span class="emphasis"><em>Step 2</em></span> - Resolve <code class="literal">channel identifier</code> to <code class="literal">channel name</code>.
We&#8217;ll describe specifics of this process in a moment.
</li><li class="listitem">
<span class="emphasis"><em>Step 3</em></span> - Resolve <code class="literal">channel name</code> to the actual <code class="literal">MessageChannel</code>
</li></ul></div>
<p>There is not much that can be done with regard to dynamic routing if Step 1 results in the actual instance of the <code class="literal">MessageChannel</code>, simply because the <code class="literal">MessageChannel</code> is the <span class="emphasis"><em>final product</em></span> of any router&#8217;s job.
However, if Step 1 results in a <code class="literal">channel identifier</code> that is not an instance of <code class="literal">MessageChannel</code>, then there are quite a few possibilities to influence the process of deriving the <code class="literal">Message Channel</code>.
Lets look at couple of the examples in the context of the 3 steps mentioned above:&nbsp;</p>
<p><span class="emphasis"><em>Payload Type Router</em></span></p>
<pre class="programlisting"><span class="hl-tag">&lt;int:payload-type-router</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"routingChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:mapping</span> <span class="hl-attribute">type</span>=<span class="hl-value">"java.lang.String"</span>  <span class="hl-attribute">channel</span>=<span class="hl-value">"channel1"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;int:mapping</span> <span class="hl-attribute">type</span>=<span class="hl-value">"java.lang.Integer"</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"channel2"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/int:payload-type-router&gt;</span></pre>
<p>Within the context of the Payload Type Router the 3 steps mentioned above would be realized as:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="emphasis"><em>Step 1</em></span> - Compute <code class="literal">channel identifier</code> which is the fully qualified name of the payload type (e.g., java.lang.String).
</li><li class="listitem">
<span class="emphasis"><em>Step 2</em></span> - Resolve <code class="literal">channel identifier</code> to <code class="literal">channel name</code> where the result of the previous step is used to select the appropriate value from the <span class="emphasis"><em>payload type mapping</em></span> defined via <code class="literal">mapping</code> element.
</li><li class="listitem">
<span class="emphasis"><em>Step 3</em></span> - Resolve <code class="literal">channel name</code> to the actual instance of the <code class="literal">MessageChannel</code> as a reference to a bean within the Application Context (which is hopefully a <code class="literal">MessageChannel</code>) identified by the result of the previous step.
</li></ul></div>
<p>In other words, each step feeds the next step until the process completes.</p>
<p><span class="emphasis"><em>Header Value Router</em></span></p>
<pre class="programlisting"><span class="hl-tag">&lt;int:header-value-router</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"inputChannel"</span> <span class="hl-attribute">header-name</span>=<span class="hl-value">"testHeader"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:mapping</span> <span class="hl-attribute">value</span>=<span class="hl-value">"foo"</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"fooChannel"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;int:mapping</span> <span class="hl-attribute">value</span>=<span class="hl-value">"bar"</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"barChannel"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/int:header-value-router&gt;</span></pre>
<p>Similar to the PayloadTypeRouter:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="emphasis"><em>Step 1</em></span> - Compute <code class="literal">channel identifier</code> which is the value of the header identified by the <code class="literal">header-name</code> attribute.
</li><li class="listitem">
<span class="emphasis"><em>Step 2</em></span> - Resolve <code class="literal">channel identifier</code> to <code class="literal">channel name</code> where the result of the previous step is used to select the appropriate value from the <span class="emphasis"><em>general mapping</em></span> defined via <code class="literal">mapping</code> element.
</li><li class="listitem">
<span class="emphasis"><em>Step 3</em></span> - Resolve <code class="literal">channel name</code> to the actual instance of the <code class="literal">MessageChannel</code> as a reference to a bean within the Application Context (which is hopefully a <code class="literal">MessageChannel</code>) identified by the result of the previous step.
</li></ul></div>
<p>The above two configurations of two different router types look almost identical.
However if we look at the alternate configuration of the <code class="literal">HeaderValueRouter</code> we clearly see that there is no <code class="literal">mapping</code> sub element:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:header-value-router&nbsp;input-channel="inputChannel"&nbsp;header-name="testHeader"&gt;</span></pre>
<p>But the configuration is still perfectly valid.
So the natural question is what about the mapping in the Step 2?</p>
<p>What this means is that Step 2 is now an optional step.
If <code class="literal">mapping</code> is not defined then the <code class="literal">channel identifier</code> value computed in Step 1 will automatically be treated as the <code class="literal">channel name</code>, which will now be resolved to the actual <code class="literal">MessageChannel</code> as in Step 3.&nbsp;
What it also means is that Step 2 is one of the key steps to provide dynamic characteristics to the routers, since it introduces a process which <span class="emphasis"><em>allows you to change the way <span class="emphasis"><em>channel identifier</em></span> resolves to 'channel name'</em></span>, thus influencing the process of determining the final instance of the <code class="literal">MessageChannel</code> from the initial <code class="literal">channel identifier</code>.&nbsp;</p>
<p><span class="emphasis"><em>For Example:</em></span></p>
<p>In the above configuration let&#8217;s assume that the <code class="literal">testHeader</code> value is <span class="emphasis"><em>kermit</em></span> which is now a <code class="literal">channel identifier</code> (Step 1).
Since there is no mapping in this router, resolving this <code class="literal">channel identifier</code> to a <code class="literal">channel name</code> (Step 2) is impossible and this <code class="literal">channel identifier</code> is now treated as <code class="literal">channel name</code>.
However what if there was a mapping but for a different value?
The end result would still be the same and that is: <span class="emphasis"><em>if a new value cannot be determined through the process of resolving the <span class="emphasis"><em>channel identifier</em></span> to a <span class="emphasis"><em>channel name</em></span>, such <span class="emphasis"><em>channel identifier</em></span> becomes <span class="emphasis"><em>channel name</em></span>.</em></span></p>
<p>So all that is left is for Step 3 to resolve the <code class="literal">channel name</code> (<span class="emphasis"><em>kermit</em></span>) to an actual instance of the <code class="literal">MessageChannel</code> identified by this name.
That basically involves a bean lookup for the name provided.
So now all messages which contain the header/value pair as <code class="literal">testHeader=kermit</code> are going to be routed to a <code class="literal">MessageChannel</code> whose bean name (id) is <span class="emphasis"><em>kermit</em></span>.</p>
<p>But what if you want to route these messages to the <span class="emphasis"><em>simpson</em></span> channel? Obviously changing a static configuration will work, but will also require bringing your system down.
However if you had access to the <code class="literal">channel identifier</code> map, then you could just introduce a new mapping where the header/value pair is now <code class="literal">kermit=simpson</code>, thus allowing Step 2 to treat <span class="emphasis"><em>kermit</em></span> as a <code class="literal">channel identifier</code> while resolving it to <span class="emphasis"><em>simpson</em></span> as the <code class="literal">channel name</code> .</p>
<p>The same obviously applies for <code class="literal">PayloadTypeRouter</code>, where you can now remap or remove a particular <span class="emphasis"><em>payload type
            mapping</em></span>.
In fact, it applies to every other router, including <span class="emphasis"><em>expression-based</em></span> routers, since their computed values will now have a chance to go through Step 2 to be additionally resolved to the actual <code class="literal">channel name</code>.</p>
<p>Any router that is a subclass of the <code class="literal">AbstractMappingMessageRouter</code> (which includes most framework defined routers) is a Dynamic Router simply because the <code class="literal">channelMapping</code> is defined at the <code class="literal">AbstractMappingMessageRouter</code> level.
That map&#8217;s setter method is exposed as a public method along with <span class="emphasis"><em>setChannelMapping</em></span> and <span class="emphasis"><em>removeChannelMapping</em></span> methods.
These allow you to change/add/remove router mappings at runtime as long as you have a reference to the router itself.
It also means that you could expose these same configuration options via JMX (see <a class="xref" href="system-management-chapter.html#jmx" title="9.2&nbsp;JMX Support">Section&nbsp;9.2, &#8220;JMX Support&#8221;</a>) or the Spring Integration ControlBus (see <a class="xref" href="system-management-chapter.html#control-bus" title="9.6&nbsp;Control Bus">Section&nbsp;9.6, &#8220;Control Bus&#8221;</a>) functionality.&nbsp;</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="dynamic-routers-control-bus" href="#dynamic-routers-control-bus"></a>Manage Router Mappings using the Control Bus</h4></div></div></div>

<p>One way to manage the router mappings is through the <a class="ulink" href="http://www.eaipatterns.com/ControlBus.html" target="_top">Control Bus</a> pattern which exposes a Control Channel where you can send control messages to manage and monitor Spring Integration components, including routers.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>For more information about the Control Bus, please see chapter <span class="emphasis"><em><a class="xref" href="system-management-chapter.html#control-bus" title="9.6&nbsp;Control Bus">Section&nbsp;9.6, &#8220;Control Bus&#8221;</a></em></span>.</p>
</td></tr></table></div>
<p>Typically you would send a control message asking to invoke a particular operation on a particular managed component (e.g.
router).
Two managed operations (methods) that are specific to changing the router resolution process are:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">public void setChannelMapping(String key, String channelName)</code> - will allow you to add a new or modify an existing mapping between <code class="literal">channel identifier</code> and <code class="literal">channel name</code>
</li><li class="listitem">
<code class="literal">public void removeChannelMapping(String key)</code> - will allow you to remove a particular channel mapping, thus disconnecting the relationship between <code class="literal">channel identifier</code> and <code class="literal">channel name</code>
</li></ul></div>
<p>Note that these methods can be used for simple changes (updating a single route or adding/removing a route).
However, if you want to remove one route and add another, the updates are not atomic.
This means the routing table may be in an indeterminate state between the updates.
Starting with <span class="emphasis"><em>version 4.0</em></span>, you can now use the control bus to update the entire routing table atomically.</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">public Map&lt;String, String&gt;getChannelMappings()</code> returns the current mappings.
</li><li class="listitem">
<code class="literal">public void replaceChannelMappings(Properties channelMappings)</code> updates the mappings.
Notice that the parameter is a properties object; this allows the use of the inbuilt <code class="literal">StringToPropertiesConverter</code> by a control bus command, for example:
</li></ul></div>
<pre class="screen">"@'router.handler'.replaceChannelMappings('foo=qux \n baz=bar')"</pre>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
note that each mapping is separated by a newline character (<code class="literal">\n</code>).
For programmatic changes to the map, it is recommended that the <code class="literal">setChannelMappings</code> method is used instead, for type-safety.
Any non-String keys or values passed into <code class="literal">replaceChannelMappings</code> are ignored.
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="dynamic-routers-jmx" href="#dynamic-routers-jmx"></a>Manage Router Mappings using JMX</h4></div></div></div>

<p>You can also expose a router instance with Spring&#8217;s JMX support, and then use your favorite JMX client (e.g., JConsole) to manage those operations (methods) for changing the router&#8217;s configuration.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>For more information about Spring Integration&#8217;s JMX support, please see chapter <span class="emphasis"><em><a class="xref" href="system-management-chapter.html#jmx" title="9.2&nbsp;JMX Support">Section&nbsp;9.2, &#8220;JMX Support&#8221;</a></em></span>.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="routing-slip" href="#routing-slip"></a>Routing Slip</h4></div></div></div>

<p>Starting with <span class="emphasis"><em>version 4.1</em></span>, Spring Integration provides an implementation of the <a class="ulink" href="http://www.eaipatterns.com/RoutingTable.html" target="_top">Routing Slip</a> Enterprise Integration Pattern.
It is implemented as a <code class="literal">routingSlip</code> message header which is used to determine the next channel in <code class="literal">AbstractMessageProducingHandler</code> s, when an <code class="literal">outputChannel</code> isn&#8217;t specified for the endpoint.
This pattern is useful in complex, dynamic, cases when it can become difficult to configure multiple routers to determine message flow.
When a message arrives at an endpoint that has no <code class="literal">output-channel</code>, the <code class="literal">routingSlip</code> is consulted to determine the next channel to which the message will be sent.
When the routing slip is exhausted, normal <code class="literal">replyChannel</code> processing resumes.</p>
<p>Configuration for the <span class="emphasis"><em>Routing Slip</em></span> is presented as a <code class="literal">HeaderEnricher</code> option - a <span class="emphasis"><em>semicolon-separated</em></span> Routing Slip <code class="literal">path</code> entries:</p>
<pre class="programlisting"><span class="hl-tag">&lt;util:properties</span> <span class="hl-attribute">id</span>=<span class="hl-value">"properties"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;beans:prop</span> <span class="hl-attribute">key</span>=<span class="hl-value">"myRoutePath1"</span><span class="hl-tag">&gt;</span>channel1<span class="hl-tag">&lt;/beans:prop&gt;</span>
    <span class="hl-tag">&lt;beans:prop</span> <span class="hl-attribute">key</span>=<span class="hl-value">"myRoutePath2"</span><span class="hl-tag">&gt;</span>request.headers[myRoutingSlipChannel]<span class="hl-tag">&lt;/beans:prop&gt;</span>
<span class="hl-tag">&lt;/util:properties&gt;</span>

<span class="hl-tag">&lt;context:property-placeholder</span> <span class="hl-attribute">properties-ref</span>=<span class="hl-value">"properties"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;header-enricher</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"process"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;routing-slip</span>
        <span class="hl-attribute">value</span>=<span class="hl-value">"${myRoutePath1}; @routingSlipRoutingPojo.get(request, reply);
               routingSlipRoutingStrategy; ${myRoutePath2}; finishChannel"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/header-enricher&gt;</span></pre>
<p>In this sample we have:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
A <code class="literal">&lt;context:property-placeholder&gt;</code> configuration to demonstrate that the entries in the Routing Slip <code class="literal">path</code> can be specified as resolvable keys.
</li><li class="listitem">
The <code class="literal">&lt;header-enricher&gt;</code> <code class="literal">&lt;routing-slip&gt;</code> sub-element is used to populate the <code class="literal">RoutingSlipHeaderValueMessageProcessor</code> to the <code class="literal">HeaderEnricher</code> handler.
</li><li class="listitem">
The <code class="literal">RoutingSlipHeaderValueMessageProcessor</code> accepts a String array of resolved Routing Slip <code class="literal">path</code> entries and returns (from <code class="literal">processMessage()</code>) a <code class="literal">singletonMap</code> with the <code class="literal">path</code> as <code class="literal">key</code> and <code class="literal">0</code> as initial <code class="literal">routingSlipIndex</code>.
</li></ul></div>
<p>Routing Slip <code class="literal">path</code> entries can contain <code class="literal">MessageChannel</code> bean names, <code class="literal">RoutingSlipRouteStrategy</code> bean names and also Spring expressions (SpEL).
The <code class="literal">RoutingSlipHeaderValueMessageProcessor</code> checks each Routing Slip <code class="literal">path</code> entry against the <code class="literal">BeanFactory</code> on the first <code class="literal">processMessage</code> invocation.
It converts entries, which aren&#8217;t bean names in the application context, to <code class="literal">ExpressionEvaluatingRoutingSlipRouteStrategy</code> instances.
<code class="literal">RoutingSlipRouteStrategy</code> entries are invoked multiple times, until they return null, or an empty String.</p>
<p>Since the <span class="emphasis"><em>Routing Slip</em></span> is involved in the <code class="literal">getOutputChannel</code> process we have a <span class="emphasis"><em>request-reply</em></span> context.
The <code class="literal">RoutingSlipRouteStrategy</code> has been introduced to determine the next <code class="literal">outputChannel</code> using the <code class="literal">requestMessage</code>, as well as the <code class="literal">reply</code> object.
An implementation of this strategy should be registered as a bean in the application context and its bean name is used in the Routing Slip <code class="literal">path</code>.
The <code class="literal">ExpressionEvaluatingRoutingSlipRouteStrategy</code> implementation is provided.
It accepts a SpEL expression, and an internal <code class="literal">ExpressionEvaluatingRoutingSlipRouteStrategy.RequestAndReply</code> object is used as the <span class="emphasis"><em>root object</em></span> of the evaluation context.
This is to avoid the overhead of <code class="literal">EvaluationContext</code> creation for each <code class="literal">ExpressionEvaluatingRoutingSlipRouteStrategy.getNextPath()</code> invocation.
It is a simple Java Bean with two properties - <code class="literal">Message&lt;?&gt; request</code> and <code class="literal">Object reply</code>.
With this expression implementation, we can specify Routing Slip <code class="literal">path</code> entries using SpEL (<code class="literal">@routingSlipRoutingPojo.get(request, reply)</code>, <code class="literal">request.headers[myRoutingSlipChannel]</code>) avoiding a bean definition for the <code class="literal">RoutingSlipRouteStrategy</code>.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The <code class="literal">requestMessage</code> argument is always a <code class="literal">Message&lt;?&gt;</code>; depending on context, the reply object may be a
<code class="literal">Message&lt;?&gt;</code>, an <code class="literal">AbstractIntegrationMessageBuilder</code> or an arbitrary application domain object (if, for example,
it is returned by a POJO method invoked by a service activator).
In the first two cases, the usual "message" properties are available (<code class="literal">payload</code> and <code class="literal">headers</code>) when using SpEL (or
a Java implementation).
When an arbitrary domain object, these properties are, obviously, not available.
Care should be taken when using routing slips in conjunction with POJO methods if the result is used to determine the
next path.</p>
</td></tr></table></div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>If a <span class="emphasis"><em>Routing Slip</em></span> is involved in a distributed environment - cross-JVM application, <code class="literal">request-reply</code> through a Message Broker (e.g.
<a class="xref" href="amqp.html" title="11.&nbsp;AMQP Support">Chapter&nbsp;11, <i>AMQP Support</i></a>, <a class="xref" href="jms.html" title="20.&nbsp;JMS Support">Chapter&nbsp;20, <i>JMS Support</i></a>), or persistence <code class="literal">MessageStore</code> (<a class="xref" href="system-management-chapter.html#message-store" title="9.4&nbsp;Message Store">Section&nbsp;9.4, &#8220;Message Store&#8221;</a>) is used in the integration flow, etc., - it is recommended to <span class="strong"><strong>not</strong></span> use <span class="emphasis"><em>inline</em></span> expressions for the Routing Slip <code class="literal">path</code>.
The framework (<code class="literal">RoutingSlipHeaderValueMessageProcessor</code>) converts them to <code class="literal">ExpressionEvaluatingRoutingSlipRouteStrategy</code> objects and they are used in the <code class="literal">routingSlip</code> message header.
Since this class isn&#8217;t <code class="literal">Serializable</code> (and it can&#8217;t be, because it depends on the <code class="literal">BeanFactory</code>) the entire Message becomes non-serializable and in any distributed operation we end up with <code class="literal">NotSerializableException</code>.
To overcome this limitation, register an <code class="literal">ExpressionEvaluatingRoutingSlipRouteStrategy</code> bean with the desired SpEL and use its bean name in the Routing Slip <code class="literal">path</code> configuration.</p>
</td></tr></table></div>
<p>For Java configuration, simply add a <code class="literal">RoutingSlipHeaderValueMessageProcessor</code> instance to the <code class="literal">HeaderEnricher</code> bean definition:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<em><span class="hl-annotation" style="color: gray">@Transformer(inputChannel = "routingSlipHeaderChannel")</span></em>
<span class="hl-keyword">public</span> HeaderEnricher headerEnricher() {
    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> HeaderEnricher(Collections.singletonMap(IntegrationMessageHeaderAccessor.ROUTING_SLIP,
            <span class="hl-keyword">new</span> RoutingSlipHeaderValueMessageProcessor(<span class="hl-string">"myRoutePath1"</span>,
                                                       <span class="hl-string">"@routingSlipRoutingPojo.get(request, reply)"</span>,
                                                       <span class="hl-string">"routingSlipRoutingStrategy"</span>,
                                                       <span class="hl-string">"request.headers[myRoutingSlipChannel]"</span>,
                                                       <span class="hl-string">"finishChannel"</span>)));
}</pre>
<p>The <span class="emphasis"><em>Routing Slip</em></span> algorithm works as follows when an endpoint produces a reply and there is no <code class="literal">outputChannel</code> defined:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
The <code class="literal">routingSlipIndex</code> is used to get a value from the Routing Slip <code class="literal">path</code> list.
</li><li class="listitem">
If the value by <code class="literal">routingSlipIndex</code> is <code class="literal">String</code>, it is used to get a bean from <code class="literal">BeanFactory</code>.
</li><li class="listitem">
If a returned bean is an instance of <code class="literal">MessageChannel</code>, it is used as the next <code class="literal">outputChannel</code> and the <code class="literal">routingSlipIndex</code> is incremented in the reply message header (the Routing Slip <code class="literal">path</code> entries remain unchanged).
</li><li class="listitem">
If a returned bean is an instance of <code class="literal">RoutingSlipRouteStrategy</code> and its <code class="literal">getNextPath</code> doesn&#8217;t return an empty String, that result is used a bean name for the next <code class="literal">outputChannel</code>.
The <code class="literal">routingSlipIndex</code> remains unchanged.
</li><li class="listitem">
If <code class="literal">RoutingSlipRouteStrategy.getNextPath</code> returns an empty String, the <code class="literal">routingSlipIndex</code> is incremented and the <code class="literal">getOutputChannelFromRoutingSlip</code> is invoked recursively for the next Routing Slip <code class="literal">path</code> item;
</li><li class="listitem">
If the next Routing Slip <code class="literal">path</code> entry isn&#8217;t a String it must be an instance of <code class="literal">RoutingSlipRouteStrategy</code>;
</li><li class="listitem">
When the <code class="literal">routingSlipIndex</code> exceeds the size of the Routing Slip <code class="literal">path</code> list, the algorithm moves to the default behavior for the standard <code class="literal">replyChannel</code> header.
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="process-manager" href="#process-manager"></a>Process Manager Enterprise Integration Pattern</h4></div></div></div>

<p>The EIP also defines the <a class="ulink" href="http://www.eaipatterns.com/ProcessManager.html" target="_top">Process Manager</a> pattern.
This pattern can now easily be implemented using custom <span class="emphasis"><em>Process Manager</em></span> logic encapsulated in a <code class="literal">RoutingSlipRouteStrategy</code> within the routing slip.
In addition to a bean name, the <code class="literal">RoutingSlipRouteStrategy</code> can return any <code class="literal">MessageChannel</code> object; and there is no requirement that this <code class="literal">MessageChannel</code> instance is a bean in the application context.
This way, we can provide powerful dynamic routing logic, when there is no prediction which channel should be used; a <code class="literal">MessageChannel</code> can be created within the <code class="literal">RoutingSlipRouteStrategy</code> and returned.
A <code class="literal">FixedSubscriberChannel</code> with an associated <code class="literal">MessageHandler</code> implementation is good combination for such cases.
For example we can route to a <a class="ulink" href="https://github.com/reactor/reactor/wiki/Streams" target="_top">Reactor Stream</a>:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> PollableChannel resultsChannel() {
    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> QueueChannel();
}
<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> RoutingSlipRouteStrategy routeStrategy() {
    <span class="hl-keyword">return</span> (requestMessage, reply) -&gt; requestMessage.getPayload() <span class="hl-keyword">instanceof</span> String
            ? <span class="hl-keyword">new</span> FixedSubscriberChannel(m -&gt;
            Streams.defer((String) m.getPayload())
                    .env(<span class="hl-keyword">this</span>.reactorEnv)
                    .get()
                    .map(String::toUpperCase)
                    .consume(v -&gt; messagingTemplate().convertAndSend(resultsChannel(), v))
                    .flush())
            : <span class="hl-keyword">new</span> FixedSubscriberChannel(m -&gt;
            Streams.defer((Integer) m.getPayload())
                    .env(<span class="hl-keyword">this</span>.reactorEnv)
                    .get()
                    .map(v -&gt; v * <span class="hl-number">2</span>)
                    .consume(v -&gt; messagingTemplate().convertAndSend(resultsChannel(), v))
                    .flush());
}</pre>
</div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="filter" href="#filter"></a>6.2&nbsp;Filter</h2></div></div></div>

<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="filter-introduction" href="#filter-introduction"></a>6.2.1&nbsp;Introduction</h3></div></div></div>

<p>Message Filters are used to decide whether a Message should be passed along or dropped based on some criteria such as a Message Header value or Message content itself.
Therefore, a Message Filter is similar to a router, except that for each Message received from the filter&#8217;s input channel, that same Message may or may not be sent to the filter&#8217;s output channel.
Unlike the router, it makes no decision regarding <span class="emphasis"><em>which</em></span> Message Channel to send the Message to but only decides <span class="emphasis"><em>whether</em></span> to send.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>As you will see momentarily, the Filter also supports a discard channel, so in certain cases it <span class="emphasis"><em>can</em></span> play the role of a very simple router (or "switch") based on a boolean condition.</p>
</td></tr></table></div>
<p>In Spring Integration, a Message Filter may be configured as a Message Endpoint that delegates to an implementation of the <code class="literal">MessageSelector</code> interface.
That interface is itself quite simple:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> MessageSelector {

    <span class="hl-keyword">boolean</span> accept(Message&lt;?&gt; message);

}</pre>
<p>The <code class="literal">MessageFilter</code> constructor accepts a selector instance:</p>
<pre class="programlisting">MessageFilter filter = <span class="hl-keyword">new</span> MessageFilter(someSelector);</pre>
<p>In combination with the namespace and SpEL, very powerful filters can be configured with very little java code.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="filter-config" href="#filter-config"></a>6.2.2&nbsp;Configuring Filter</h3></div></div></div>

<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="filter-xml" href="#filter-xml"></a>Configuring a Filter with XML</h4></div></div></div>

<p>The &lt;filter&gt; element is used to create a Message-selecting endpoint.
In addition to "<code class="literal">input-channel</code> and <code class="literal">output-channel</code> attributes, it requires a <code class="literal">ref</code>.
The <code class="literal">ref</code> may point to a <code class="literal">MessageSelector</code> implementation:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:filter</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"selector"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"selector"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"example.MessageSelectorImpl"</span><span class="hl-tag">/&gt;</span></pre>
<p>Alternatively, the <code class="literal">method</code> attribute can be added at which point the <code class="literal">ref</code> may refer to any object.
The referenced method may expect either the <code class="literal">Message</code> type or the payload type of inbound Messages.
The method must return a boolean value.
If the method returns <span class="emphasis"><em>true</em></span>, the Message <span class="emphasis"><em>will</em></span> be sent to the output-channel.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:filter</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span>
    <span class="hl-attribute">ref</span>=<span class="hl-value">"exampleObject"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"someBooleanReturningMethod"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"exampleObject"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"example.SomeObject"</span><span class="hl-tag">/&gt;</span></pre>
<p>If the selector or adapted POJO method returns <code class="literal">false</code>, there are a few settings that control the handling of the rejected Message.
By default (if configured like the example above), rejected Messages will be silently dropped.
If rejection should instead result in an error condition, then set the <code class="literal">throw-exception-on-rejection</code> attribute to <code class="literal">true</code>:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:filter</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"selector"</span>
    <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span> <span class="hl-attribute">throw-exception-on-rejection</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span></pre>
<p>If you want rejected messages to be routed to a specific channel, provide that reference as the <code class="literal">discard-channel</code>:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:filter</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"selector"</span>
    <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span> <span class="hl-attribute">discard-channel</span>=<span class="hl-value">"rejectedMessages"</span><span class="hl-tag">/&gt;</span></pre>
<p>Also see <a class="xref" href="messaging-endpoints-chapter.html#advising-filters" title="8.9.6&nbsp;Advising Filters">Section&nbsp;8.9.6, &#8220;Advising Filters&#8221;</a>.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Message Filters are commonly used in conjunction with a Publish Subscribe Channel.
Many filter endpoints may be subscribed to the same channel, and they decide whether or not to pass the Message to the next endpoint which could be any of the supported types (e.g.
Service Activator).
This provides a <span class="emphasis"><em>reactive</em></span> alternative to the more <span class="emphasis"><em>proactive</em></span> approach of using a Message Router with a single Point-to-Point input channel and multiple output channels.</p>
</td></tr></table></div>
<p>Using a <code class="literal">ref</code> attribute is generally recommended if the custom filter implementation is referenced in other <code class="literal">&lt;filter&gt;</code> definitions.
However if the custom filter implementation is scoped to a single <code class="literal">&lt;filter&gt;</code> element, provide an inner bean definition:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:filter</span> <span class="hl-attribute">method</span>=<span class="hl-value">"someMethod"</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"inChannel"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"outChannel"</span><span class="hl-tag">&gt;</span>
  <span class="hl-tag">&lt;beans:bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.foo.MyCustomFilter"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/filter&gt;</span></pre>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Using both the <code class="literal">ref</code> attribute and an inner handler definition in the same <code class="literal">&lt;filter&gt;</code> configuration is not allowed, as it creates an ambiguous condition, and an Exception will be thrown.</p>
</td></tr></table></div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>If the "ref" attribute references a bean that extends <code class="literal">MessageFilter</code> (such as filters provided by the framework itself), the configuration is optimized by injecting the output channel into the filter bean directly.
In this case, each "ref" must be to a separate bean instance (or a <code class="literal">prototype</code>-scoped bean), or use the inner <code class="literal">&lt;bean/&gt;</code> configuration type.
However, this optimization only applies if you don&#8217;t provide any filter-specific attributes in the filter XML definition.
If you inadvertently reference the same message handler from multiple beans, you will get a configuration exception.</p>
</td></tr></table></div>
<p>With the introduction of SpEL support, Spring Integration added the <code class="literal">expression</code> attribute to the filter element.
It can be used to avoid Java entirely for simple filters.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:filter</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"payload.equals('nonsense')"</span><span class="hl-tag">/&gt;</span></pre>
<p>The string passed as the expression attribute will be evaluated as a SpEL expression with the Message available in the evaluation context.
If it is necessary to include the result of an expression in the scope of the application context you can use the #{} notation as defined in the <a class="ulink" href="http://docs.spring.io/spring/docs/current/spring-framework-reference/html/expressions.html#expressions-beandef" target="_top">SpEL reference documentation</a>.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:filter</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span>
            <span class="hl-attribute">expression</span>=<span class="hl-value">"payload.matches(#{filterPatterns.nonsensePattern})"</span><span class="hl-tag">/&gt;</span></pre>
<p>If the Expression itself needs to be dynamic, then an <span class="emphasis"><em>expression</em></span> sub-element may be used.
That provides a level of indirection for resolving the Expression by its key from an ExpressionSource.
That is a strategy interface that you can implement directly, or you can rely upon a version available in Spring Integration that loads Expressions from a "resource bundle" and can check for modifications after a given number of seconds.
All of this is demonstrated in the following configuration sample where the Expression could be reloaded within one minute if the underlying file had been modified.
If the ExpressionSource bean is named "expressionSource", then it is not necessary to provide the` source` attribute on the &lt;expression&gt; element, but in this case it&#8217;s shown for completeness.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:filter</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:expression</span> <span class="hl-attribute">key</span>=<span class="hl-value">"filterPatterns.example"</span> <span class="hl-attribute">source</span>=<span class="hl-value">"myExpressions"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:filter&gt;</span>

<span class="hl-tag">&lt;beans:bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myExpressions"</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myExpressions"</span>
    <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.expression.ReloadableResourceBundleExpressionSource"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;beans:property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"basename"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"config/integration/expressions"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;beans:property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"cacheSeconds"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"60"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/beans:bean&gt;</span></pre>
<p>Then, the <span class="emphasis"><em>config/integration/expressions.properties</em></span> file (or any more specific version with a locale extension to be resolved in the typical way that resource-bundles are loaded) would contain a key/value pair:</p>
<pre class="programlisting">filterPatterns.example=payload &gt; 100</pre>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>All of these examples that use <code class="literal">expression</code> as an attribute or sub-element can also be applied within transformer, router, splitter, service-activator, and header-enricher elements.
Of course, the semantics/role of the given component type would affect the interpretation of the evaluation result in the same way that the return value of a method-invocation would be interpreted.
For example, an expression can return Strings that are to be treated as Message Channel names by a router component.
However, the underlying functionality of evaluating the expression against the Message as the root object, and resolving bean names if prefixed with <span class="emphasis"><em>@</em></span> is consistent across all of the core EIP components within Spring Integration.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="filter-annotations" href="#filter-annotations"></a>Configuring a Filter with Annotations</h4></div></div></div>

<p>A filter configured using annotations would look like this.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> PetFilter {
    ...
    <em><span class="hl-annotation" style="color: gray">@Filter</span></em>  <a name="CO1-1" href="#CO1-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
    <span class="hl-keyword">public</span> <span class="hl-keyword">boolean</span> dogsOnly(String input) {
        ...
    }
}</pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO1-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>An annotation indicating that this method shall be used as a filter.
Must be specified if this class will be used as a filter.</p>
</td></tr></table></div>
<p>All of the configuration options provided by the xml element are also available for the <code class="literal">@Filter</code> annotation.</p>
<p>The filter can be either referenced explicitly from XML or, if the <code class="literal">@MessageEndpoint</code> annotation is defined on the class, detected automatically through classpath scanning.</p>
<p>Also see <a class="xref" href="messaging-endpoints-chapter.html#advising-with-annotations" title="8.9.7&nbsp;Advising Endpoints Using Annotations">Section&nbsp;8.9.7, &#8220;Advising Endpoints Using Annotations&#8221;</a>.</p>
</div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="splitter" href="#splitter"></a>6.3&nbsp;Splitter</h2></div></div></div>

<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="splitter-annotation" href="#splitter-annotation"></a>6.3.1&nbsp;Introduction</h3></div></div></div>

<p>The Splitter is a component whose role is to partition a message in several parts, and send the resulting messages to be processed independently.
Very often, they are upstream producers in a pipeline that includes an Aggregator.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_programming_model" href="#_programming_model"></a>6.3.2&nbsp;Programming model</h3></div></div></div>

<p>The API for performing splitting consists of one base class, <code class="literal">AbstractMessageSplitter</code>, which is a <code class="literal">MessageHandler</code> implementation, encapsulating features which are common to splitters, such as filling in the appropriate message headers <code class="literal">CORRELATION_ID</code>, <code class="literal">SEQUENCE_SIZE</code>, and <code class="literal">SEQUENCE_NUMBER</code> on the messages that are produced.
This enables tracking down the messages and the results of their processing (in a typical scenario, these headers would be copied over to the messages that are produced by the various transforming endpoints), and use them, for example, in a <a class="ulink" href="http://www.eaipatterns.com/DistributionAggregate.html" target="_top">Composed Message Processor</a> scenario.</p>
<p>An excerpt from <code class="literal">AbstractMessageSplitter</code> can be seen below:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">abstract</span> <span class="hl-keyword">class</span> AbstractMessageSplitter
    <span class="hl-keyword">extends</span> AbstractReplyProducingMessageConsumer {
    ...
    <span class="hl-keyword">protected</span> <span class="hl-keyword">abstract</span> Object splitMessage(Message&lt;?&gt; message);

}</pre>
<p>To implement a specific Splitter in an application, extend <code class="literal">AbstractMessageSplitter</code> and implement the <code class="literal">splitMessage</code> method, which contains logic for splitting the messages.
The return value may be one of the following:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
A <code class="literal">Collection</code> or an array of Messages, or an <code class="literal">Iterable</code> (or <code class="literal">Iterator</code>) that iterates over Messages - in this case the messages will be sent as such (after the <code class="literal">CORRELATION_ID</code>, <code class="literal">SEQUENCE_SIZE</code> and <code class="literal">SEQUENCE_NUMBER</code> are populated).
Using this approach gives more control to the developer, for example for populating custom message headers as part of the splitting process.
</li><li class="listitem">
A <code class="literal">Collection</code> or an array of non-Message objects, or an <code class="literal">Iterable</code> (or <code class="literal">Iterator</code>) that iterates over non-Message objects - works like the prior case, except that each collection element will be used as a Message payload.
Using this approach allows developers to focus on the domain objects without having to consider the Messaging system and produces code that is easier to test.
</li><li class="listitem">
a <code class="literal">Message</code> or non-Message object (but not a Collection or an Array) - it works like the previous cases, except a single message will be sent out.
</li></ul></div>
<p>In Spring Integration, any POJO can implement the splitting algorithm, provided that it defines a method that accepts a single argument and has a return value.
In this case, the return value of the method will be interpreted as described above.
The input argument might either be a <code class="literal">Message</code> or a simple POJO.
In the latter case, the splitter will receive the payload of the incoming message.
Since this decouples the code from the Spring Integration API and will typically be easier to test, it is the recommended approach.</p>
<p><span class="strong"><strong>Splitter and Iterators</strong></span></p>
<p>Starting with <span class="emphasis"><em>version 4.1</em></span>, the <code class="literal">AbstractMessageSplitter</code> supports the <code class="literal">Iterator</code> type for the <code class="literal">value</code> to split.
Note, in the case of an <code class="literal">Iterator</code> (or <code class="literal">Iterable</code>), we don&#8217;t have access to the number of underlying items and the <code class="literal">SEQUENCE_SIZE</code> header is set to <code class="literal">0</code>.
This means that the default <code class="literal">SequenceSizeReleaseStrategy</code> of an <code class="literal">&lt;aggregator&gt;</code> won&#8217;t work and the group for the <code class="literal">CORRELATION_ID</code> from the <code class="literal">splitter</code> won&#8217;t be released; it will remain as <code class="literal">incomplete</code>.
In this case you should use an appropriate custom <code class="literal">ReleaseStrategy</code> or rely on <code class="literal">send-partial-result-on-expiry</code> together with <code class="literal">group-timeout</code> or a <code class="literal">MessageGroupStoreReaper</code>.</p>
<p>An <code class="literal">Iterator</code> object is useful to avoid the need for building an entire collection in the memory before splitting.
For example, when underlying items are populated from some external system (e.g.
DataBase or FTP <code class="literal">MGET</code>) using iterations or streams.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="splitter-config" href="#splitter-config"></a>6.3.3&nbsp;Configuring Splitter</h3></div></div></div>

<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_configuring_a_splitter_using_xml" href="#_configuring_a_splitter_using_xml"></a>Configuring a Splitter using XML</h4></div></div></div>

<p>A splitter can be configured through XML as follows:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"inputChannel"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int:splitter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"splitter"</span>  <a name="CO2-1" href="#CO2-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
  ref="splitterBean"  <a name="CO2-2" href="#CO2-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
  method="split"  <a name="CO2-3" href="#CO2-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
  input-channel="inputChannel"  <a name="CO2-4" href="#CO2-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
  output-channel="outputChannel" /&gt; <a name="CO2-5" href="#CO2-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>

<span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"outputChannel"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;beans:bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"splitterBean"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"sample.PojoSplitter"</span><span class="hl-tag">/&gt;</span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO2-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The id of the splitter is <span class="emphasis"><em>optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO2-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A reference to a bean defined in the application context.
The bean must implement the splitting logic as described in the section above .<span class="emphasis"><em>Optional</em></span>.
If reference to a bean is not provided, then it is assumed that the <span class="emphasis"><em>payload</em></span> of the Message that arrived on the <code class="literal">input-channel</code> is an implementation of <code class="literal">java.util.Collection</code> and the default splitting logic will be applied to the Collection, incorporating each individual element into a Message and sending it to the <code class="literal">output-channel</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO2-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The method (defined on the bean specified above) that implements the splitting logic.<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO2-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The input channel of the splitter.
<span class="emphasis"><em>Required</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO2-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The channel to which the splitter will send the results of splitting the incoming message.
<span class="emphasis"><em>Optional (because incoming
          messages can specify a reply channel themselves)</em></span>.</p>
</td></tr></table></div>
<p>Using a <code class="literal">ref</code> attribute is generally recommended if the custom splitter implementation may be referenced in other <code class="literal">&lt;splitter&gt;</code> definitions.
However if the custom splitter handler implementation should be scoped to a single definition of the <code class="literal">&lt;splitter&gt;</code>, configure an inner bean definition:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:splitter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"testSplitter"</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"inChannel"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"split"</span>
                <span class="hl-attribute">output-channel</span>=<span class="hl-value">"outChannel"</span><span class="hl-tag">&gt;</span>
  <span class="hl-tag">&lt;beans:bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.foo.TestSplitter"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:splitter&gt;</span></pre>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Using both a <code class="literal">ref</code> attribute and an inner handler definition in the same <code class="literal">&lt;int:splitter&gt;</code> configuration is not allowed, as it creates an ambiguous condition and will result in an Exception being thrown.</p>
</td></tr></table></div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>If the "ref" attribute references a bean that extends <code class="literal">AbstractMessageProducingHandler</code> (such as splitters provided by the framework itself), the configuration is optimized by injecting the output channel into the handler directly.
In this case, each "ref" must be to a separate bean instance (or a <code class="literal">prototype</code>-scoped bean), or use the inner <code class="literal">&lt;bean/&gt;</code> configuration type.
However, this optimization only applies if you don&#8217;t provide any splitter-specific attributes in the splitter XML definition.
If you inadvertently reference the same message handler from multiple beans, you will get a configuration exception.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_configuring_a_splitter_with_annotations" href="#_configuring_a_splitter_with_annotations"></a>Configuring a Splitter with Annotations</h4></div></div></div>

<p>The <code class="literal">@Splitter</code> annotation is applicable to methods that expect either the`Message` type or the message payload type, and the return values of the method should be a <code class="literal">Collection</code> of any type.
If the returned values are not actual <code class="literal">Message</code> objects, then each item will be wrapped in a Message as its payload.
Each message will be sent to the designated output channel for the endpoint on which the <code class="literal">@Splitter</code> is defined.</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Splitter</span></em>
List&lt;LineItem&gt; extractItems(Order order) {
    <span class="hl-keyword">return</span> order.getItems()
}</pre>
<p>Also see <a class="xref" href="messaging-endpoints-chapter.html#advising-with-annotations" title="8.9.7&nbsp;Advising Endpoints Using Annotations">Section&nbsp;8.9.7, &#8220;Advising Endpoints Using Annotations&#8221;</a>.</p>
</div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="aggregator" href="#aggregator"></a>6.4&nbsp;Aggregator</h2></div></div></div>

<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="aggregator-introduction" href="#aggregator-introduction"></a>6.4.1&nbsp;Introduction</h3></div></div></div>

<p>Basically a mirror-image of the Splitter, the Aggregator is a type of Message Handler that receives multiple Messages and combines them into a single Message.
In fact, an Aggregator is often a downstream consumer in a pipeline that includes a Splitter.</p>
<p>Technically, the Aggregator is more complex than a Splitter, because it is stateful as it must hold the Messages to be aggregated and determine when the complete group of Messages is ready to be aggregated.
In order to do this it requires a <code class="literal">MessageStore</code>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="aggregator-functionality" href="#aggregator-functionality"></a>6.4.2&nbsp;Functionality</h3></div></div></div>

<p>The Aggregator combines a group of related messages, by correlating and storing them, until the group is deemed complete.
At that point, the Aggregator will create a single message by processing the whole group, and will send the aggregated message as output.</p>
<p>Implementing an Aggregator requires providing the logic to perform the aggregation (i.e., the creation of a single message from many).
Two related concepts are correlation and release.</p>
<p>Correlation determines how messages are grouped for aggregation.
In Spring Integration correlation is done by default based on the <code class="literal">IntegrationMessageHeaderAccessor.CORRELATION_ID</code> message header.
Messages with the same <code class="literal">IntegrationMessageHeaderAccessor.CORRELATION_ID</code> will be grouped together.
However, the correlation strategy may be customized to allow other ways of specifying how the messages should be grouped together by implementing a <code class="literal">CorrelationStrategy</code> (see below).</p>
<p>To determine the point at which a group of messages is ready to be processed, a <code class="literal">ReleaseStrategy</code> is consulted.
The default release strategy for the Aggregator will release a group when all messages included in a sequence are present, based on the <code class="literal">IntegrationMessageHeaderAccessor.SEQUENCE_SIZE</code> header.
This default strategy may be overridden by providing a reference to a custom <code class="literal">ReleaseStrategy</code> implementation.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="aggregator-api" href="#aggregator-api"></a>6.4.3&nbsp;Programming model</h3></div></div></div>

<p>The Aggregation API consists of a number of classes:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
The interface <code class="literal">MessageGroupProcessor</code>, and its subclasses:<code class="literal">MethodInvokingAggregatingMessageGroupProcessor</code> and <code class="literal">ExpressionEvaluatingMessageGroupProcessor</code>
</li><li class="listitem">
The <code class="literal">ReleaseStrategy</code> interface and its default implementation <code class="literal">SequenceSizeReleaseStrategy</code>
</li><li class="listitem">
The <code class="literal">CorrelationStrategy</code> interface and its default implementation <code class="literal">HeaderAttributeCorrelationStrategy</code>
</li></ul></div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_aggregatingmessagehandler" href="#_aggregatingmessagehandler"></a>AggregatingMessageHandler</h4></div></div></div>

<p>The <code class="literal">AggregatingMessageHandler</code> (subclass of <code class="literal">AbstractCorrelatingMessageHandler</code>) is a <code class="literal">MessageHandler</code> implementation, encapsulating the common functionalities of an Aggregator (and other correlating use cases), which are:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
correlating messages into a group to be aggregated
</li><li class="listitem">
maintaining those messages in a <code class="literal">MessageStore</code> until the group can be released
</li><li class="listitem">
deciding when the group can be released
</li><li class="listitem">
aggregating the released group into a single message
</li><li class="listitem">
recognizing and responding to an expired group
</li></ul></div>
<p>The responsibility of deciding how the messages should be grouped together is delegated to a <code class="literal">CorrelationStrategy</code> instance.
The responsibility of deciding whether the message group can be released is delegated to a <code class="literal">ReleaseStrategy</code> instance.</p>
<p>Here is a brief highlight of the base <code class="literal">AbstractAggregatingMessageGroupProcessor</code> (the responsibility of implementing the <code class="literal">aggregatePayloads</code> method is left to the developer):</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">abstract</span> <span class="hl-keyword">class</span> AbstractAggregatingMessageGroupProcessor
              <span class="hl-keyword">implements</span> MessageGroupProcessor {

    <span class="hl-keyword">protected</span> Map&lt;String, Object&gt; aggregateHeaders(MessageGroup group) {
        <span class="hl-comment">// default implementation exists</span>
    }

    <span class="hl-keyword">protected</span> <span class="hl-keyword">abstract</span> Object aggregatePayloads(MessageGroup group, Map&lt;String, Object&gt; defaultHeaders);

}</pre>
<p>The <code class="literal">CorrelationStrategy</code> is owned by the <code class="literal">AbstractCorrelatingMessageHandler</code> and it has a default value based on the <code class="literal">IntegrationMessageHeaderAccessor.CORRELATION_ID</code> message header:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> AbstractCorrelatingMessageHandler(MessageGroupProcessor processor, MessageGroupStore store,
        CorrelationStrategy correlationStrategy, ReleaseStrategy releaseStrategy) {
    ...
    <span class="hl-keyword">this</span>.correlationStrategy = correlationStrategy == null ?
        <span class="hl-keyword">new</span> HeaderAttributeCorrelationStrategy(IntegrationMessageHeaderAccessor.CORRELATION_ID) : correlationStrategy;
    <span class="hl-keyword">this</span>.releaseStrategy = releaseStrategy == null ? <span class="hl-keyword">new</span> SequenceSizeReleaseStrategy() : releaseStrategy;
    ...
}</pre>
<p>As for actual processing of the message group, the default implementation is the <code class="literal">DefaultAggregatingMessageGroupProcessor</code>.
It creates a single Message whose payload is a List of the payloads received for a given group.
This works well for simple Scatter Gather implementations with either a Splitter, Publish Subscribe Channel, or Recipient List Router upstream.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>When using a Publish Subscribe Channel or Recipient List Router in this type of scenario, be sure to enable the flag to <code class="literal">apply-sequence</code>.
That will add the necessary headers (CORRELATION_ID, SEQUENCE_NUMBER and SEQUENCE_SIZE).
That behavior is enabled by default for Splitters in Spring Integration, but it is not enabled for the Publish Subscribe Channel or Recipient List Router because those components may be used in a variety of contexts in which these headers are not necessary.</p>
</td></tr></table></div>
<p>When implementing a specific aggregator strategy for an application, a developer can extend <code class="literal">AbstractAggregatingMessageGroupProcessor</code> and implement the <code class="literal">aggregatePayloads</code> method.
However, there are better solutions, less coupled to the API, for implementing the aggregation logic which can be configured easily either through XML or through annotations.</p>
<p>In general, any POJO can implement the aggregation algorithm if it provides a method that accepts a single <code class="literal">java.util.List</code> as an argument (parameterized lists are supported as well).
This method will be invoked for aggregating messages as follows:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
if the argument is a <code class="literal">java.util.Collection&lt;T&gt;</code>, and the parameter type T is assignable to <code class="literal">Message</code>,
then the whole list of messages accumulated for aggregation will be sent to the aggregator
</li><li class="listitem">
if the argument is a non-parameterized <code class="literal">java.util.Collection</code> or the parameter type is not assignable to <code class="literal">Message</code>,
then the method will receive the payloads of the accumulated messages
</li><li class="listitem">
if the return type is not assignable to <code class="literal">Message</code>, then it will be treated as the payload for a Message that will be created automatically by the framework.
</li></ul></div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>In the interest of code simplicity, and promoting best practices such as low coupling, testability, etc., the preferred way of implementing the aggregation logic is through a POJO, and using the XML or annotation support for configuring it in the application.</p>
</td></tr></table></div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left"><a name="agg-message-collection" href="#agg-message-collection"></a>Important</th></tr><tr><td align="left" valign="top">
<p>The <code class="literal">SimpleMessageGroup.getMessages()</code> method returns an <code class="literal">unmodifiableCollection</code>, therefore,
if your aggregating POJO method has a <code class="literal">Collection&lt;Message&gt;</code> parameter, the argument passed in will be exactly that
<code class="literal">Collection</code> instance and, when a <code class="literal">SimpleMessageStore</code> is used for the Aggregator,
that original <code class="literal">Collection&lt;Message&gt;</code> will be cleared after releasing the group.
Hence the <code class="literal">Collection&lt;Message&gt;</code> variable in the POJO will be cleared too, if passed out of the aggregator.
If you wish to simply release that collection as-is for further processing,
it is required that you build a new <code class="literal">Collection</code> (e.g. <code class="literal">new ArrayList&lt;Message&gt;(messages)</code>)
Starting with _version 4.3, the Framework no longer copies the messages to a new collection, to avoid undesired extra
object creation.</p>
</td></tr></table></div>
<p>If the <code class="literal">MessageGroupProcessor</code> 's <code class="literal">processMessageGroup</code> method returns a collection, it must be a collection of
<code class="literal">Message&lt;?&gt;</code> s.
In this case, the messages are released individually.
Prior to <span class="emphasis"><em>version 4.2</em></span>, it was not possible to provide a <code class="literal">MessageGroupProcessor</code> using XML configuration, only POJO
methods could be used for aggregation.
Now, if the framework detects that the referenced (or inner) bean implements <code class="literal">MessageProcessor</code>, it is used as the
aggregator&#8217;s output processor.</p>
<p>If you wish to release a collection of objects from a custom <code class="literal">MessageGroupProcessor</code> as the payload of a message, your
class should extend <code class="literal">AbstractAggregatingMessageGroupProcessor</code> and implement <code class="literal">aggregatePayloads()</code>.</p>
<p>Also, since <span class="emphasis"><em>version 4.2</em></span>, a <code class="literal">SimpleMessageGroupProcessor</code> is provided; which simply returns the collection of
messages from the group, which, as indicated above, causes the released messages to be sent individually.</p>
<p>This allows the aggregator to work as a message barrier where arriving messages are held until the release strategy
fires, and the group is released, as a sequence of individual messages.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_releasestrategy" href="#_releasestrategy"></a>ReleaseStrategy</h4></div></div></div>

<p>The <code class="literal">ReleaseStrategy</code> interface is defined as follows:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> ReleaseStrategy {

  <span class="hl-keyword">boolean</span> canRelease(MessageGroup group);

}</pre>
<p>In general, any POJO can implement the completion decision logic if it provides a method that accepts a single <code class="literal">java.util.List</code> as an argument (parameterized lists are supported as well), and returns a boolean value.
This method will be invoked after the arrival of each new message, to decide whether the group is complete or not, as follows:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
if the argument is a <code class="literal">java.util.List&lt;T&gt;</code>, and the parameter type T is assignable to <code class="literal">Message</code>, then the whole list of messages accumulated in the group will be sent to the method
</li><li class="listitem">
if the argument is a non-parametrized <code class="literal">java.util.List</code> or the parameter type is not assignable to <code class="literal">Message</code>, then the method will receive the payloads of the accumulated messages
</li><li class="listitem">
the method must return true if the message group is ready for aggregation, and false otherwise.
</li></ul></div>
<p>For example:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyReleaseStrategy {

    <em><span class="hl-annotation" style="color: gray">@ReleaseStrategy</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">boolean</span> canMessagesBeReleased(List&lt;Message&lt;?&gt;&gt;) {...}
}</pre>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyReleaseStrategy {

    <em><span class="hl-annotation" style="color: gray">@ReleaseStrategy</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">boolean</span> canMessagesBeReleased(List&lt;String&gt;) {...}
}</pre>
<p>As you can see based on the above signatures, the POJO-based Release Strategy will be passed a <code class="literal">Collection</code> of not-yet-released Messages (if you need access to the whole <code class="literal">Message</code>) or a <code class="literal">Collection</code> of payload objects (if the type parameter is anything other than <code class="literal">Message</code>).
Typically this would satisfy the majority of use cases.
However if, for some reason, you need to access the full <code class="literal">MessageGroup</code> then you should simply provide an implementation of the <code class="literal">ReleaseStrategy</code> interface.</p>
<div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Warning"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Warning]" src="images/warning.png"></td><th align="left">Warning</th></tr><tr><td align="left" valign="top">
<p>When handling potentially large groups, it is important to understand how these methods are invoked because the release strategy may be invoked multiple times before the group is released.
The most efficient is an implementation of <code class="literal">ReleaseStrategy</code> because the aggregator can invoke it directly.
The second most efficient is a POJO method with a <code class="literal">Collection&lt;Message&lt;?&gt;&gt;</code> parameter type.
The least efficient is a POJO method with a <code class="literal">Collection&lt;Foo&gt;</code> type - the framework has to copy the payloads from the messages in the group into a new collection (and possibly attempt conversion on the payloads to <code class="literal">Foo</code>) every time the release strategy is called.
<code class="literal">Collection&lt;?&gt;</code> avoids the conversion but still requires creating the new <code class="literal">Collection</code>.</p>
<p><span class="strong"><strong>For these reasons, for large groups, it is recommended that you implement <code class="literal">ReleaseStrategy</code>.</strong></span></p>
</td></tr></table></div>
<p>When the group is released for aggregation, all its not-yet-released messages are processed and removed from the group.
If the group is also complete (i.e.
if all messages from a sequence have arrived or if there is no sequence defined), then the group is marked as complete.
Any new messages for this group will be sent to the discard channel (if defined).
Setting <code class="literal">expire-groups-upon-completion</code> to <code class="literal">true</code> (default is <code class="literal">false</code>) removes the entire group and any new messages, with the same correlation id as the removed group, will form a new group.
Partial sequences can be released by using a <code class="literal">MessageGroupStoreReaper</code> together with <code class="literal">send-partial-result-on-expiry</code> being set to <code class="literal">true</code>.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>To facilitate discarding of late-arriving messages, the aggregator must maintain state about the group after it has been released.
This can eventually cause out of memory conditions.
To avoid such situations, you should consider configuring a <code class="literal">MessageGroupStoreReaper</code> to remove the group metadata; the expiry parameters should be set to expire groups after it is not expected that late messages will arrive.
For information about configuring a reaper, see <a class="xref" href="messaging-routing-chapter.html#reaper" title="6.4.5&nbsp;Managing State in an Aggregator: MessageGroupStore">Section&nbsp;6.4.5, &#8220;Managing State in an Aggregator: MessageGroupStore&#8221;</a>.</p>
</td></tr></table></div>
<p>Spring Integration provides an out-of-the box implementation for <code class="literal">ReleaseStrategy</code>, the <code class="literal">SequenceSizeReleaseStrategy</code>.
This implementation consults the <code class="literal">SEQUENCE_NUMBER</code> and <code class="literal">SEQUENCE_SIZE</code> headers of each arriving message to decide when a message group is complete and ready to be aggregated.
As shown above, it is also the default strategy.</p>
<p>If you are aggregating large groups, you don&#8217;t need to release partial groups, and you don&#8217;t need to detect/reject duplicate sequences, consider using the <code class="literal">SimpleSequenceSizeReleaseStrategy</code> instead - it is much more efficient for these use cases, and will be the default in future releases when partial group release is not specified.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_aggregating_large_groups" href="#_aggregating_large_groups"></a>Aggregating Large Groups</h4></div></div></div>

<p>The 4.3 release changed the default <code class="literal">Collection</code> for messages in a <code class="literal">SimpleMessageGroup</code> to <code class="literal">HashSet</code> (it was previously a <code class="literal">BlockingQueue</code>).
This was expensive when removing individual messages from large groups (an O(n) linear scan was required).
Although the hash set is generally much faster for removing, it can be expensive for large messages because the hash has to be calculated (on both inserts and removes).
If you have messages that are expensive to hash, consider using some other collection type.
As discussed in <a class="xref" href="system-management-chapter.html#message-group-factory" title="9.4.1&nbsp;MessageGroupFactory">Section&nbsp;9.4.1, &#8220;MessageGroupFactory&#8221;</a>, a <code class="literal">SimpleMessageGroupFactory</code> is provided so you can select the <code class="literal">Collection</code> that best suits your needs.
You can also provide your own factory implementation to create some other <code class="literal">Collection&lt;Message&lt;?&gt;&gt;</code>.</p>
<p>Here is an example of how to configure an aggregator with the previous implementation and a <code class="literal">SimpleSequenceSizeReleaseStrategy</code>.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:aggregator</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"aggregate"</span>
    <span class="hl-attribute">output-channel</span>=<span class="hl-value">"out"</span> <span class="hl-attribute">message-store</span>=<span class="hl-value">"store"</span> <span class="hl-attribute">release-strategy</span>=<span class="hl-value">"releaser"</span><span class="hl-tag"> /&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"store"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.store.SimpleMessageStore"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"messageGroupFactory"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.store.SimpleMessageGroupFactory"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"BLOCKING_QUEUE"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/bean&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"releaser"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"SimpleSequenceSizeReleaseStrategy"</span><span class="hl-tag"> /&gt;</span></pre>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_correlationstrategy" href="#_correlationstrategy"></a>CorrelationStrategy</h4></div></div></div>

<p>The <code class="literal">CorrelationStrategy</code> interface is defined as follows:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> CorrelationStrategy {

  Object getCorrelationKey(Message&lt;?&gt; message);

}</pre>
<p>The method returns an Object which represents the correlation key used for associating the message with a message group.
The key must satisfy the criteria used for a key in a Map with respect to the implementation of <code class="literal">equals()</code> and <code class="literal">hashCode()</code>.</p>
<p>In general, any POJO can implement the correlation logic, and the rules for mapping a message to a method&#8217;s argument (or arguments) are the same as for a <code class="literal">ServiceActivator</code> (including support for @Header annotations).
The method must return a value, and the value must not be <code class="literal">null</code>.</p>
<p>Spring Integration provides an out-of-the box implementation for <code class="literal">CorrelationStrategy</code>, the <code class="literal">HeaderAttributeCorrelationStrategy</code>.
This implementation returns the value of one of the message headers (whose name is specified by a constructor argument) as the correlation key.
By default, the correlation strategy is a <code class="literal">HeaderAttributeCorrelationStrategy</code> returning the value of the <code class="literal">CORRELATION_ID</code> header attribute.
If you have a custom header name you would like to use for correlation, then simply configure that on an instance of <code class="literal">HeaderAttributeCorrelationStrategy</code> and provide that as a reference for the Aggregator&#8217;s correlation-strategy.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_lockregistry" href="#_lockregistry"></a>LockRegistry</h4></div></div></div>

<p>Changes to groups are thread safe; a <code class="literal">LockRegistry</code> is used to obtain a lock for the resolved correlation id.
A <code class="literal">DefaultLockRegistry</code> is used by default (in-memory).
For synchronizing updates across servers, where a shared <code class="literal">MessageGroupStore</code> is being used, a shared lock registry
must be configured.
See <a class="xref" href="messaging-routing-chapter.html#aggregator-config" title="6.4.4&nbsp;Configuring an Aggregator">Section&nbsp;6.4.4, &#8220;Configuring an Aggregator&#8221;</a> below for more information.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="aggregator-config" href="#aggregator-config"></a>6.4.4&nbsp;Configuring an Aggregator</h3></div></div></div>

<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="aggregator-xml" href="#aggregator-xml"></a>Configuring an Aggregator with XML</h4></div></div></div>

<p>Spring Integration supports the configuration of an aggregator via XML through the <code class="literal">&lt;aggregator/&gt;</code> element.
Below you can see an example of an aggregator.</p>
<pre class="programlisting"><span class="hl-tag">&lt;channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"inputChannel"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int:aggregator</span> <span class="hl-attribute">id</span>=<span class="hl-value">""</span><span class="hl-attribute">myAggregator"</span>  <a name="CO3-1" href="#CO3-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
        auto-startup="true"  <a name="CO3-2" href="#CO3-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
        input-channel="inputChannel"  <a name="CO3-3" href="#CO3-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
        output-channel="outputChannel"  <a name="CO3-4" href="#CO3-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
        discard-channel="throwAwayChannel"  <a name="CO3-5" href="#CO3-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
        message-store="persistentMessageStore"  <a name="CO3-6" href="#CO3-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>
        order="1"  <a name="CO3-7" href="#CO3-7"></a><span><img src="images/callouts/7.png" alt="7" border="0"></span>
        send-partial-result-on-expiry="false"  <a name="CO3-8" href="#CO3-8"></a><span><img src="images/callouts/8.png" alt="8" border="0"></span>
        send-timeout="1000"  <a name="CO3-9" href="#CO3-9"></a><span><img src="images/callouts/9.png" alt="9" border="0"></span>

        correlation-strategy="correlationStrategyBean"  <a name="CO3-10" href="#CO3-10"></a><span><img src="images/callouts/10.png" alt="10" border="0"></span>
        correlation-strategy-method="correlate"  <a name="CO3-11" href="#CO3-11"></a><span><img src="images/callouts/11.png" alt="11" border="0"></span>
        correlation-strategy-expression="headers['foo']"  <a name="CO3-12" href="#CO3-12"></a><span><img src="images/callouts/12.png" alt="12" border="0"></span>

        ref="aggregatorBean"  <a name="CO3-13" href="#CO3-13"></a><span><img src="images/callouts/13.png" alt="13" border="0"></span>
        method="aggregate"  <a name="CO3-14" href="#CO3-14"></a><span><img src="images/callouts/14.png" alt="14" border="0"></span>

        release-strategy="releaseStrategyBean"  <a name="CO3-15" href="#CO3-15"></a><span><img src="images/callouts/15.png" alt="15" border="0"></span>
        release-strategy-method="release"  <a name="CO3-16" href="#CO3-16"></a>(16)
        release-strategy-expression="size() == 5"  <a name="CO3-17" href="#CO3-17"></a>(17)

        expire-groups-upon-completion="false"  <a name="CO3-18" href="#CO3-18"></a>(18)
        empty-group-min-timeout="60000"  <a name="CO3-19" href="#CO3-19"></a>(19)

        lock-registry="lockRegistry"  <a name="CO3-20" href="#CO3-20"></a>(20)

        group-timeout="60000"  <a name="CO3-21" href="#CO3-21"></a>(21)
        group-timeout-expression="size() ge 2 ? 100 : -1"  <a name="CO3-22" href="#CO3-22"></a>(22)
        expire-groups-upon-timeout="true"  <a name="CO3-23" href="#CO3-23"></a>(23)

        scheduler="taskScheduler" &gt;  <a name="CO3-24" href="#CO3-24"></a>(24)
            <span class="hl-tag">&lt;expire-transactional/&gt;</span>  <a name="CO3-25" href="#CO3-25"></a>(25)
            <span class="hl-tag">&lt;expire-advice-chain/&gt;</span>  <a name="CO3-26" href="#CO3-26"></a>(26)
<span class="hl-tag">&lt;/aggregator&gt;</span>

<span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"outputChannel"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"throwAwayChannel"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"persistentMessageStore"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.jdbc.JdbcMessageStore"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"dataSource"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"aggregatorBean"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"sample.PojoAggregator"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"releaseStrategyBean"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"sample.PojoReleaseStrategy"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"correlationStrategyBean"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"sample.PojoCorrelationStrategy"</span><span class="hl-tag">/&gt;</span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO3-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The id of the aggregator is <span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO3-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Lifecycle attribute signaling if aggregator should be started during Application Context startup.
<span class="emphasis"><em>Optional (default is <span class="emphasis"><em>true</em></span>)</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO3-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The channel from which where aggregator will receive messages.
<span class="emphasis"><em>Required</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO3-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The channel to which the aggregator will send the aggregation results.
<span class="emphasis"><em>Optional (because incoming messages can specify a reply channel themselves via <span class="emphasis"><em>replyChannel</em></span> Message Header)</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO3-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The channel to which the aggregator will send the messages that timed out (if <code class="literal">send-partial-result-on-expiry</code> is <span class="emphasis"><em>false</em></span>).
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO3-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A reference to a <code class="literal">MessageGroupStore</code> used to store groups of messages under their correlation key until they are complete.
<span class="emphasis"><em>Optional</em></span>, by default a volatile in-memory store.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO3-7"><span><img src="images/callouts/7.png" alt="7" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Order of this aggregator when more than one handle is subscribed to the same DirectChannel (use for load balancing purposes).
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO3-8"><span><img src="images/callouts/8.png" alt="8" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Indicates that expired messages should be aggregated and sent to the <span class="emphasis"><em>output-channel</em></span> or <span class="emphasis"><em>replyChannel</em></span> once their containing <code class="literal">MessageGroup</code> is expired (see <code class="literal">MessageGroupStore.expireMessageGroups(long)</code>).
One way of expiring <code class="literal">MessageGroup</code> s is by configuring a <code class="literal">MessageGroupStoreReaper</code>.
However <code class="literal">MessageGroup</code> s can alternatively be expired by simply calling <code class="literal">MessageGroupStore.expireMessageGroups(timeout)</code>.
That could be accomplished via a Control Bus operation or by simply invoking that method if you have a reference to the <code class="literal">MessageGroupStore</code> instance.
Otherwise by itself this attribute has no behavior.
It only serves as an indicator of what to do (discard or send to the output/reply channel) with Messages that are still in the <code class="literal">MessageGroup</code> that is about to be expired.
<span class="emphasis"><em>Optional</em></span>.
<span class="emphasis"><em>Default - false</em></span>.
<span class="strong"><strong>NOTE:</strong></span> This attribute is more properly <code class="literal">send-partial-result-on-timeout</code> because the group may not actually expire if
<code class="literal">expire-groups-upon-timeout</code> is set to <code class="literal">false</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO3-9"><span><img src="images/callouts/9.png" alt="9" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The timeout interval to wait when sending a reply <code class="literal">Message</code> to the <code class="literal">output-channel</code> or <code class="literal">discard-channel</code>.
Defaults to <code class="literal">-1</code> - blocking indefinitely.
It is applied only if the output channel has some <span class="emphasis"><em>sending</em></span> limitations, e.g.
<code class="literal">QueueChannel</code> with a fixed <span class="emphasis"><em>capacity</em></span>.
In this case a <code class="literal">MessageDeliveryException</code> is thrown.
The <code class="literal">send-timeout</code> is ignored in case of <code class="literal">AbstractSubscribableChannel</code> implementations.
In case of <code class="literal">group-timeout(-expression)</code> the <code class="literal">MessageDeliveryException</code> from the scheduled expire task leads this task to be rescheduled.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO3-10"><span><img src="images/callouts/10.png" alt="10" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A reference to a bean that implements the message correlation (grouping) algorithm.
The bean can be an implementation of the <code class="literal">CorrelationStrategy</code> interface or a POJO.
In the latter case the correlation-strategy-method attribute must be defined as well.
<span class="emphasis"><em>Optional (by default, the aggregator will use the <code class="literal">IntegrationMessageHeaderAccessor.CORRELATION_ID</code> header)</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO3-11"><span><img src="images/callouts/11.png" alt="11" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A method defined on the bean referenced by <code class="literal">correlation-strategy</code>, that implements the correlation decision algorithm.
<span class="emphasis"><em>Optional, with restrictions (requires <code class="literal">correlation-strategy</code> to be present).</em></span></p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO3-12"><span><img src="images/callouts/12.png" alt="12" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A SpEL expression representing the correlation strategy.
Example: <code class="literal">"headers['foo']"</code>.
Only one of <code class="literal">correlation-strategy</code> or <code class="literal">correlation-strategy-expression</code> is allowed.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO3-13"><span><img src="images/callouts/13.png" alt="13" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A reference to a bean defined in the application context.
The bean must implement the aggregation logic as described above.
<span class="emphasis"><em>Optional (by default the list of aggregated Messages will become a payload of the output message).</em></span></p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO3-14"><span><img src="images/callouts/14.png" alt="14" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A method defined on the bean referenced by <code class="literal">ref</code>, that implements the message aggregation algorithm.
<span class="emphasis"><em>Optional, depends on <code class="literal">ref</code> attribute being defined.</em></span></p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO3-15"><span><img src="images/callouts/15.png" alt="15" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A reference to a bean that implements the release strategy.
The bean can be an implementation of the <code class="literal">ReleaseStrategy</code> interface or a POJO.
In the latter case the release-strategy-method attribute must be defined as well.
<span class="emphasis"><em>Optional (by default, the aggregator will use the <code class="literal">IntegrationMessageHeaderAccessor.SEQUENCE_SIZE</code> header attribute)</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO3-16">(16)</a> </p></td><td valign="top" align="left">
<p>A method defined on the bean referenced by <code class="literal">release-strategy</code>, that implements the completion decision algorithm.
<span class="emphasis"><em>Optional, with restrictions (requires <code class="literal">release-strategy</code> to be present).</em></span></p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO3-17">(17)</a> </p></td><td valign="top" align="left">
<p>A SpEL expression representing the release strategy; the root object for the expression is a <code class="literal">Collection</code> of <code class="literal">Message</code> s.
Example: <code class="literal">"size() == 5"</code>.
Only one of <code class="literal">release-strategy</code> or <code class="literal">release-strategy-expression</code> is allowed.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO3-18">(18)</a> </p></td><td valign="top" align="left">
<p>When set to true (default false), completed groups are removed from the message store, allowing subsequent messages with the same correlation to form a new group.
The default behavior is to send messages with the same correlation as a completed group to the <span class="emphasis"><em>discard-channel</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO3-19">(19)</a> </p></td><td valign="top" align="left">
<p>Only applies if a <code class="literal">MessageGroupStoreReaper</code> is configured for the <code class="literal">&lt;aggregator&gt;</code>'s <code class="literal">MessageStore</code>.
By default, when a <code class="literal">MessageGroupStoreReaper</code> is configured to expire partial groups, empty groups are also removed.
Empty groups exist after a group is released normally.
This is to enable the detection and discarding of late-arriving messages.
If you wish to expire empty groups on a longer schedule than expiring partial groups, set this property.
Empty groups will then not be removed from the <code class="literal">MessageStore</code> until they have not been modified for at least this number of milliseconds.
Note that the actual time to expire an empty group will also be affected by the reaper&#8217;s <span class="emphasis"><em>timeout</em></span> property and it could be as much as this value plus the timeout.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO3-20">(20)</a> </p></td><td valign="top" align="left">
<p>A reference to a <code class="literal">org.springframework.integration.util.LockRegistry</code> bean; used to obtain a <code class="literal">Lock</code> based on the <code class="literal">groupId</code> for concurrent operations on the <code class="literal">MessageGroup</code>.
By default, an internal <code class="literal">DefaultLockRegistry</code> is used.
Use of a distributed <code class="literal">LockRegistry</code>, such as the <code class="literal">ZookeeperLockRegistry</code>, ensures only one instance of the aggregator will operate on a group concurrently.
See <a class="xref" href="redis.html#redis-lock-registry" title="24.11&nbsp;Redis Lock Registry">Section&nbsp;24.11, &#8220;Redis Lock Registry&#8221;</a>, <a class="xref" href="gemfire.html#gemfire-lock-registry" title="16.6&nbsp;Gemfire Lock Registry">Section&nbsp;16.6, &#8220;Gemfire Lock Registry&#8221;</a>, <a class="xref" href="zookeeper.html#zk-lock-registry" title="37.3&nbsp;Zookeeper Lock Registry">Section&nbsp;37.3, &#8220;Zookeeper Lock Registry&#8221;</a> for more information.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO3-21">(21)</a> </p></td><td valign="top" align="left">
<p>A timeout in milliseconds to force the <code class="literal">MessageGroup</code> complete, when the <code class="literal">ReleaseStrategy</code> doesn&#8217;t <span class="emphasis"><em>release</em></span> the group when the current Message arrives.
This attribute provides a built-in <span class="emphasis"><em>Time-base Release Strategy</em></span> for the aggregator, when there is a need to emit a partial result (or discard the group), if a new Message does not arrive for the <code class="literal">MessageGroup</code> within the timeout.
When a new Message arrives at the aggregator, any existing <code class="literal">ScheduledFuture&lt;?&gt;</code> for its <code class="literal">MessageGroup</code> is canceled.
If the <code class="literal">ReleaseStrategy</code> returns <code class="literal">false</code> (don&#8217;t release) and the <code class="literal">groupTimeout &gt; 0</code> a new task will be scheduled to expire the group.
Setting this attribute to zero is not advised because it will effectively disable the aggregator because every message group will be immediately completed.
It is possible, however to conditionally set it to zero using an expression; see <code class="literal">group-timeout-expression</code> for information.
The action taken during the completion depends on the <code class="literal">ReleaseStrategy</code> and the <code class="literal">send-partial-group-on-expiry</code> attribute.
See <a class="xref" href="messaging-routing-chapter.html#agg-and-group-to" title="Aggregator and Group Timeout">the section called &#8220;Aggregator and Group Timeout&#8221;</a> for more information.
Mutually exclusive with <span class="emphasis"><em>group-timeout-expression</em></span> attribute.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO3-22">(22)</a> </p></td><td valign="top" align="left">
<p>The SpEL expression that evaluates to a <code class="literal">groupTimeout</code> with the <code class="literal">MessageGroup</code> as the <code class="literal">#root</code> evaluation context object.
Used for scheduling the <code class="literal">MessageGroup</code> to be forced complete.
If the expression evaluates to null or <code class="literal">&lt; 0</code>, the completion is not scheduled.
If it evaluates to zero, the group is completed immediately on the current thread.
In effect, this provides a dynamic <code class="literal">group-timeout</code> property.
See <code class="literal">group-timeout</code> for more information.
Mutually exclusive with <span class="emphasis"><em>group-timeout</em></span> attribute.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO3-23">(23)</a> </p></td><td valign="top" align="left">
<p>When a group is completed due to a timeout (or by a <code class="literal">MessageGroupStoreReaper</code>), the group is expired (completely removed) by default.
Late arriving messages will start a new group.
Set this to <code class="literal">false</code> to complete the group but have its metadata remain so that late arriving messages will be discarded.
Empty groups can be expired later using a <code class="literal">MessageGroupStoreReaper</code> together with the <code class="literal">empty-group-min-timeout</code> attribute.
Default: <span class="emphasis"><em>true</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO3-24">(24)</a> </p></td><td valign="top" align="left">
<p>A <code class="literal">TaskScheduler</code> bean reference to schedule the <code class="literal">MessageGroup</code> to be forced complete if no new message arrives for the <code class="literal">MessageGroup</code> within the <code class="literal">groupTimeout</code>.
If not provided, the default scheduler <code class="literal">taskScheduler</code>, registered in the <code class="literal">ApplicationContext</code> (<code class="literal">ThreadPoolTaskScheduler</code>) will be used.
This attribute does not apply if <code class="literal">group-timeout</code> or <code class="literal">group-timeout-expression</code> is not specified.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO3-25">(25)</a> </p></td><td valign="top" align="left">
<p>Since <span class="emphasis"><em>version 4.1</em></span>.
Allows a transaction to be started for the <code class="literal">forceComplete</code> operation.
It is initiated from a <code class="literal">group-timeout(-expression)</code> or by a <code class="literal">MessageGroupStoreReaper</code> and is not applied to the normal <code class="literal">add/release/discard</code> operations.
Only this sub-element or <code class="literal">&lt;expire-advice-chain/&gt;</code> is allowed.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO3-26">(26)</a> </p></td><td valign="top" align="left">
<p>Since <span class="emphasis"><em>version 4.1</em></span>.
Allows the configuration of any <code class="literal">Advice</code> for the <code class="literal">forceComplete</code> operation.
It is initiated from a <code class="literal">group-timeout(-expression)</code> or by a <code class="literal">MessageGroupStoreReaper</code> and is not applied to the normal <code class="literal">add/release/discard</code> operations.
Only this sub-element or <code class="literal">&lt;expire-transactional/&gt;</code> is allowed.
A transaction <code class="literal">Advice</code> can also be configured here using the Spring <code class="literal">tx</code> namespace.</p>
</td></tr></table></div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important: Expiring Groups"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Expiring Groups</th></tr><tr><td align="left" valign="top">

<p>There are two attributes related to expiring (completely removing) groups.
When a group is expired, there is no record of it and if a new message arrives with the same correlation, a new group is started.
When a group is completed (without expiry), the empty group remains and late arriving messages are discarded.
Empty groups can be removed later using a <code class="literal">MessageGroupStoreReaper</code> in combination with the <code class="literal">empty-group-min-timeout</code> attribute.</p>
<p><code class="literal">expire-groups-upon-completion</code> relates to "normal" completion - when the <code class="literal">ReleaseStrategy</code> releases the group.
This defaults to <code class="literal">false</code>.</p>
<p>If a group is not completed normally, but is released or discarded because of a timeout, the group is normally expired.
Since <span class="emphasis"><em>version 4.1</em></span>, you can now control this behavior using <code class="literal">expire-groups-upon-timeout</code>; this defaults to <code class="literal">true</code> for backwards compatibility.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>When a group is timed out, the <code class="literal">ReleaseStrategy</code> is given one more opportunity to release the group; if it does so, and <code class="literal">expire-groups-upon-timeout</code> is false, then expiration is controlled by <code class="literal">expire-groups-upon-completion</code>.
If the group is not released by the release strategy during timeout, then the expiration is controlled by the <code class="literal">expire-groups-upon-timeout</code>.
Timed-out groups are either discarded, or a partial release occurs (based on <code class="literal">send-partial-result-on-expiry</code>).</p>
</td></tr></table></div>
</td></tr></table></div>
<p>Using a <code class="literal">ref</code> attribute is generally recommended if a custom aggregator handler implementation may be referenced in other <code class="literal">&lt;aggregator&gt;</code> definitions.
However if a custom aggregator implementation is only being used by a single definition of the <code class="literal">&lt;aggregator&gt;</code>, you can use an inner bean definition (starting with version 1.0.3) to configure the aggregation POJO within the <code class="literal">&lt;aggregator&gt;</code> element:</p>
<pre class="programlisting"><span class="hl-tag">&lt;aggregator</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"sum"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;beans:bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.foo.PojoAggregator"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/aggregator&gt;</span></pre>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Using both a <code class="literal">ref</code> attribute and an inner bean definition in the same <code class="literal">&lt;aggregator&gt;</code> configuration is not allowed, as it creates an ambiguous condition.
In such cases, an Exception will be thrown.</p>
</td></tr></table></div>
<p>An example implementation of the aggregator bean looks as follows:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> PojoAggregator {

  <span class="hl-keyword">public</span> Long add(List&lt;Long&gt; results) {
    <span class="hl-keyword">long</span> total = <span class="hl-number">0l</span>;
    <span class="hl-keyword">for</span> (<span class="hl-keyword">long</span> partialResult: results) {
      total += partialResult;
    }
    <span class="hl-keyword">return</span> total;
  }
}</pre>
<p>An implementation of the completion strategy bean for the example above may be as follows:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> PojoReleaseStrategy {
...
  <span class="hl-keyword">public</span> <span class="hl-keyword">boolean</span> canRelease(List&lt;Long&gt; numbers) {
    <span class="hl-keyword">int</span> sum = <span class="hl-number">0</span>;
    <span class="hl-keyword">for</span> (<span class="hl-keyword">long</span> number: numbers) {
      sum += number;
    }
    <span class="hl-keyword">return</span> sum &gt;= maxValue;
  }
}</pre>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Wherever it makes sense, the release strategy method and the aggregator method can be combined in a single bean.</p>
</td></tr></table></div>
<p>An implementation of the correlation strategy bean for the example above may be as follows:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> PojoCorrelationStrategy {
...
  <span class="hl-keyword">public</span> Long groupNumbersByLastDigit(Long number) {
    <span class="hl-keyword">return</span> number % <span class="hl-number">10</span>;
  }
}</pre>
<p>For example, this aggregator would group numbers by some criterion (in our case the remainder after dividing by 10) and will hold the group until the sum of the numbers provided by the payloads exceeds a certain value.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Wherever it makes sense, the release strategy method, correlation strategy method and the aggregator method can be combined in a single bean (all of them or any two).</p>
</td></tr></table></div>
<p><span class="emphasis"><em>Aggregators and Spring Expression Language (SpEL)</em></span></p>
<p>Since Spring Integration 2.0, the various strategies (correlation, release, and aggregation) may be handled with <a class="ulink" href="http://docs.spring.io/spring/docs/current/spring-framework-reference/html/expressions.html" target="_top">SpEL</a> which is recommended if the logic behind such <span class="emphasis"><em>release strategy</em></span> is relatively simple.
Let&#8217;s say you have a legacy component that was designed to receive an array of objects.
We know that the default release strategy will assemble all aggregated messages in the List.
So now we have two problems.
First we need to extract individual messages from the list, and then we need to extract the payload of each message and assemble the array of objects (see code below).</p>
<pre class="programlisting"><span class="hl-keyword">public</span> String[] processRelease(List&lt;Message&lt;String&gt;&gt; messages){
    List&lt;String&gt; stringList = <span class="hl-keyword">new</span> ArrayList&lt;String&gt;();
    <span class="hl-keyword">for</span> (Message&lt;String&gt; message : messages) {
        stringList.add(message.getPayload());
    }
    <span class="hl-keyword">return</span> stringList.toArray(<span class="hl-keyword">new</span> String[]{});
}</pre>
<p>However, with SpEL such a requirement could actually be handled relatively easily with a one-line expression, thus sparing you from writing a custom class and configuring it as a bean.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:aggregator</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"aggChannel"</span>
    <span class="hl-attribute">output-channel</span>=<span class="hl-value">"replyChannel"</span>
    <span class="hl-attribute">expression</span>=<span class="hl-value">"#this.![payload].toArray()"</span><span class="hl-tag">/&gt;</span></pre>
<p>In the above configuration we are using a <a class="ulink" href="http://docs.spring.io/spring/docs/current/spring-framework-reference/html/expressions.html#expressions-collection-projection" target="_top">Collection Projection</a> expression to assemble a new collection from the payloads of all messages in the list and then transforming it to an Array, thus achieving the same result as the java code above.</p>
<p>The same expression-based approach can be applied when dealing with custom <span class="emphasis"><em>Release</em></span> and <span class="emphasis"><em>Correlation</em></span> strategies.</p>
<p>Instead of defining a bean for a custom <code class="literal">CorrelationStrategy</code> via the <code class="literal">correlation-strategy</code> attribute, you can implement your simple correlation logic via a SpEL expression and configure it via the <code class="literal">correlation-strategy-expression</code> attribute.</p>
<p>For example:</p>
<pre class="programlisting">correlation-strategy-expression="payload.person.id"</pre>
<p>In the above example it is assumed that the payload has an attribute <code class="literal">person</code> with an <code class="literal">id</code> which is going to be used to correlate messages.</p>
<p>Likewise, for the <code class="literal">ReleaseStrategy</code> you can implement your release logic as a SpEL expression and configure it via the <code class="literal">release-strategy-expression</code> attribute.
The only difference is that since ReleaseStrategy is passed the List of Messages, the root object in the SpEL evaluation context is the List itself.
That List can be referenced as <code class="literal">#this</code> within the expression.</p>
<p>For example:</p>
<pre class="programlisting">release-strategy-expression="#this.size() gt 5"</pre>
<p>In this example the root object of the SpEL Evaluation Context is the <code class="literal">MessageGroup</code> itself, and you are simply stating that as soon as there are more than 5 messages in this group, it should be released.</p>
<div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="agg-and-group-to" href="#agg-and-group-to"></a>Aggregator and Group Timeout</h5></div></div></div>

<p>Starting with <span class="emphasis"><em>version 4.0</em></span>, two new mutually exclusive attributes have been introduced: <code class="literal">group-timeout</code> and <code class="literal">group-timeout-expression</code> (see the description above).
There are some cases where it is needed to emit the aggregator result (or discard the group) after a timeout if the <code class="literal">ReleaseStrategy</code> doesn&#8217;t <span class="emphasis"><em>release</em></span> when the current Message arrives.
For this purpose the <code class="literal">groupTimeout</code> option allows scheduling the <code class="literal">MessageGroup</code> to be forced complete:</p>
<pre class="programlisting"><span class="hl-tag">&lt;aggregator</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span>
        <span class="hl-attribute">send-partial-result-on-expiry</span>=<span class="hl-value">"true"</span>
        <span class="hl-attribute">group-timeout-expression</span>=<span class="hl-value">"size() ge 2 ? 10000 : -1"</span>
        <span class="hl-attribute">release-strategy-expression</span>=<span class="hl-value">"[0].headers.sequenceNumber == [0].headers.sequenceSize"</span><span class="hl-tag">/&gt;</span></pre>
<p>With this example, the normal <span class="emphasis"><em>release</em></span> will be possible if the aggregator receives the last message in sequence as defined by the <code class="literal">release-strategy-expression</code>.
If that specific message does not arrive, the <code class="literal">groupTimeout</code> will force the group complete after 10 seconds as long as the group contains at least 2 Messages.</p>
<p>The results of forcing the group complete depends on the <code class="literal">ReleaseStrategy</code> and the <code class="literal">send-partial-result-on-expiry</code>.
First, the release strategy is again consulted to see if a <span class="emphasis"><em>normal</em></span> release is to be made - while the group won&#8217;t have changed, the <code class="literal">ReleaseStrategy</code> can decide to release the group at this time.
If the release strategy still does not release the group, it will be expired.
If <code class="literal">send-partial-result-on-expiry</code> is <code class="literal">true</code>, existing messages in the (partial) <code class="literal">MessageGroup</code> will be released as a normal aggregator reply Message to the <code class="literal">output-channel</code>, otherwise it will be discarded.</p>
<p>There is a difference between <code class="literal">groupTimeout</code> behavior and <code class="literal">MessageGroupStoreReaper</code> (see <a class="xref" href="messaging-routing-chapter.html#aggregator-config" title="6.4.4&nbsp;Configuring an Aggregator">Section&nbsp;6.4.4, &#8220;Configuring an Aggregator&#8221;</a>).
The reaper initiates forced completion for all <code class="literal">MessageGroup</code> s in the <code class="literal">MessageGroupStore</code> periodically.
The <code class="literal">groupTimeout</code> does it for each <code class="literal">MessageGroup</code> individually, if a new Message doesn&#8217;t arrive during the <code class="literal">groupTimeout</code>.
Also, the reaper can be used to remove empty groups (empty groups are retained in order to discard late messages, if <code class="literal">expire-groups-upon-completion</code> is false).</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="aggregator-annotations" href="#aggregator-annotations"></a>Configuring an Aggregator with Annotations</h4></div></div></div>

<p>An aggregator configured using annotations would look like this.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> Waiter {
  ...

  <em><span class="hl-annotation" style="color: gray">@Aggregator</span></em>  <a name="CO4-1" href="#CO4-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
  <span class="hl-keyword">public</span> Delivery aggregatingMethod(List&lt;OrderItem&gt; items) {
    ...
  }

  <em><span class="hl-annotation" style="color: gray">@ReleaseStrategy</span></em>  <a name="CO4-2" href="#CO4-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
  <span class="hl-keyword">public</span> <span class="hl-keyword">boolean</span> releaseChecker(List&lt;Message&lt;?&gt;&gt; messages) {
    ...
  }

  <em><span class="hl-annotation" style="color: gray">@CorrelationStrategy</span></em>  <a name="CO4-3" href="#CO4-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
  <span class="hl-keyword">public</span> String correlateBy(OrderItem item) {
    ...
  }
}</pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO4-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>An annotation indicating that this method shall be used as an aggregator.
Must be specified if this class will be used as an aggregator.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO4-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>An annotation indicating that this method shall be used as the release strategy of an aggregator.
If not present on any method, the aggregator will use the SequenceSizeReleaseStrategy.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO4-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>An annotation indicating that this method shall be used as the correlation strategy of an aggregator.
If no correlation strategy is indicated, the aggregator will use the <code class="literal">HeaderAttributeCorrelationStrategy</code> based on <code class="literal">CORRELATION_ID</code>.</p>
</td></tr></table></div>
<p>All of the configuration options provided by the xml element are also available for the <code class="literal">@Aggregator</code> annotation.</p>
<p>The aggregator can be either referenced explicitly from XML or, if the <code class="literal">@MessageEndpoint</code> is defined on the class, detected automatically through classpath scanning.</p>
<p>Annotation configuration (<code class="literal">@Aggregator</code> and others) for the Aggregator component covers only simple use cases,
where most default options are sufficient.
If you need more control over those options using Annotation configuration, consider using
a <code class="literal">@Bean</code> definition for the <code class="literal">AggregatingMessageHandler</code> and mark its
<code class="literal">@Bean</code> method with <code class="literal">@ServiceActivator</code>:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "aggregatorChannel")</span></em>
<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> MessageHandler aggregator(MessageGroupStore jdbcMessageGroupStore) {
     AggregatingMessageHandler aggregator =
                       <span class="hl-keyword">new</span> AggregatingMessageHandler(<span class="hl-keyword">new</span> DefaultAggregatingMessageGroupProcessor(),
                                                 jdbcMessageGroupStore);
     aggregator.setOutputChannel(resultsChannel());
     aggregator.setGroupTimeoutExpression(<span class="hl-keyword">new</span> ValueExpression&lt;&gt;(<span class="hl-number">500L</span>));
     aggregator.setTaskScheduler(<span class="hl-keyword">this</span>.taskScheduler);
     <span class="hl-keyword">return</span> aggregator;
}</pre>
<p>See <a class="xref" href="messaging-routing-chapter.html#aggregator-api" title="6.4.3&nbsp;Programming model">Section&nbsp;6.4.3, &#8220;Programming model&#8221;</a> and <a class="xref" href="configuration.html#annotations_on_beans" title="F.6.2&nbsp;Annotations on @Beans">Section&nbsp;F.6.2, &#8220;Annotations on @Beans&#8221;</a> for more information.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Starting with the <span class="emphasis"><em>version 4.2</em></span> the <code class="literal">AggregatorFactoryBean</code> is available, to simplify Java configuration
for the <code class="literal">AggregatingMessageHandler</code>.</p>
</td></tr></table></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="reaper" href="#reaper"></a>6.4.5&nbsp;Managing State in an Aggregator: MessageGroupStore</h3></div></div></div>

<p>Aggregator (and some other patterns in Spring Integration) is a stateful pattern that requires decisions to be made based on a group of messages that have arrived over a period of time, all with the same correlation key.
The design of the interfaces in the stateful patterns (e.g.
<code class="literal">ReleaseStrategy</code>) is driven by the principle that the components (whether defined by the framework or a user) should be able to remain stateless.
All state is carried by the <code class="literal">MessageGroup</code> and its management is delegated to the <code class="literal">MessageGroupStore</code>.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> MessageGroupStore {
    <span class="hl-keyword">int</span> getMessageCountForAllMessageGroups();

    <span class="hl-keyword">int</span> getMarkedMessageCountForAllMessageGroups();

    <span class="hl-keyword">int</span> getMessageGroupCount();

    MessageGroup getMessageGroup(Object groupId);

    MessageGroup addMessageToGroup(Object groupId, Message&lt;?&gt; message);

    MessageGroup markMessageGroup(MessageGroup group);

    MessageGroup removeMessageFromGroup(Object key, Message&lt;?&gt; messageToRemove);

    MessageGroup markMessageFromGroup(Object key, Message&lt;?&gt; messageToMark);

    <span class="hl-keyword">void</span> removeMessageGroup(Object groupId);

    <span class="hl-keyword">void</span> registerMessageGroupExpiryCallback(MessageGroupCallback callback);

    <span class="hl-keyword">int</span> expireMessageGroups(<span class="hl-keyword">long</span> timeout);
}</pre>
<p>For more information please refer to the <a class="ulink" href="http://docs.spring.io/spring-integration/api/org/springframework/integration/store/MessageGroupStore.html" target="_top">JavaDoc</a>.</p>
<p>The <code class="literal">MessageGroupStore</code> accumulates state information in <code class="literal">MessageGroups</code> while waiting for a release strategy to be triggered, and that event might not ever happen.
So to prevent stale messages from lingering, and for volatile stores to provide a hook for cleaning up when the application shuts down, the <code class="literal">MessageGroupStore</code> allows the user to register callbacks to apply to its <code class="literal">MessageGroups</code> when they expire.
The interface is very straightforward:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> MessageGroupCallback {

    <span class="hl-keyword">void</span> execute(MessageGroupStore messageGroupStore, MessageGroup group);

}</pre>
<p>The callback has direct access to the store and the message group so it can manage the persistent state (e.g.
by removing the group from the store entirely).</p>
<p>The <code class="literal">MessageGroupStore</code> maintains a list of these callbacks which it applies, on demand, to all messages whose timestamp is earlier than a time supplied as a parameter (see the <code class="literal">registerMessageGroupExpiryCallback(..)</code> and <code class="literal">expireMessageGroups(..)</code> methods above).</p>
<p>The <code class="literal">expireMessageGroups</code> method can be called with a timeout value.
Any message older than the current time minus this value will be expired, and have the callbacks applied.
Thus it is the user of the store that defines what is meant by message group "expiry".</p>
<p>As a convenience for users, Spring Integration provides a wrapper for the message expiry in the form of a <code class="literal">MessageGroupStoreReaper</code>:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"reaper"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org...MessageGroupStoreReaper"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"messageGroupStore"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"messageStore"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"timeout"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"30000"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;task:scheduled-tasks</span> <span class="hl-attribute">scheduler</span>=<span class="hl-value">"scheduler"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;task:scheduled</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"reaper"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"run"</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"10000"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/task:scheduled-tasks&gt;</span></pre>
<p>The reaper is a <code class="literal">Runnable</code>, and all that is happening in the example above is that the message group store&#8217;s expire method is being called once every 10 seconds.
The timeout itself is 30 seconds.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>It is important to understand that the <span class="emphasis"><em>timeout</em></span> property of the <code class="literal">MessageGroupStoreReaper</code> is an approximate value and is impacted by the the rate of the task scheduler since this property will only be checked on the next scheduled execution of the <code class="literal">MessageGroupStoreReaper</code> task.
For example if the timeout is set for 10 min, but the <code class="literal">MessageGroupStoreReaper</code> task is scheduled to run every 60 min and the last execution of the <code class="literal">MessageGroupStoreReaper</code> task happened 1 min before the timeout, the <code class="literal">MessageGroup</code> will not expire for the next 59 min.
So it is recommended to set the rate at least equal to the value of the timeout or shorter.</p>
</td></tr></table></div>
<p>In addition to the reaper, the expiry callbacks are invoked when the application shuts down via a lifecycle callback in the <code class="literal">AbstractCorrelatingMessageHandler</code>.</p>
<p>The <code class="literal">AbstractCorrelatingMessageHandler</code> registers its own expiry callback, and this is the link with the boolean flag <code class="literal">send-partial-result-on-expiry</code> in the XML configuration of the aggregator.
If the flag is set to true, then when the expiry callback is invoked, any unmarked messages in groups that are not yet released can be sent on to the output channel.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>When using a <code class="literal">MessageGroupStoreReaper</code>, it is generally recommended to use a separate <code class="literal">MessageStore</code> for each correlating endpoint.
Otherwise, unexpected results may occur because one endpoint may remove another endpoint&#8217;s groups.</p>
<p>Some <code class="literal">MessageStore</code> implementations allow using the same physical resources, by partitioning the data; for example, the <code class="literal">JdbcMessageStore</code> has a <code class="literal">region</code> property; the <code class="literal">MongoDbMessageStore</code> has a <code class="literal">collectionName</code> property.</p>
<p>For more information about <code class="literal">MessageStore</code> interface and its implementations, please read <a class="xref" href="system-management-chapter.html#message-store" title="9.4&nbsp;Message Store">Section&nbsp;9.4, &#8220;Message Store&#8221;</a>.</p>
</td></tr></table></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="resequencer" href="#resequencer"></a>6.5&nbsp;Resequencer</h2></div></div></div>

<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_introduction" href="#_introduction"></a>6.5.1&nbsp;Introduction</h3></div></div></div>

<p>Related to the Aggregator, albeit different from a functional standpoint, is the Resequencer.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="resequencer-functionality" href="#resequencer-functionality"></a>6.5.2&nbsp;Functionality</h3></div></div></div>

<p>The Resequencer works in a similar way to the Aggregator, in the sense that it uses the <code class="literal">CORRELATION_ID</code> to store messages in groups, the difference being that the Resequencer does not process the messages in any way.
It simply releases them in the order of their <code class="literal">SEQUENCE_NUMBER</code> header values.</p>
<p>With respect to that, the user might opt to release all messages at once (after the whole sequence, according to the <code class="literal">SEQUENCE_SIZE</code>, has been released), or as soon as a valid sequence is available.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_a_resequencer" href="#_configuring_a_resequencer"></a>6.5.3&nbsp;Configuring a Resequencer</h3></div></div></div>

<p>Configuring a resequencer requires only including the appropriate element in XML.</p>
<p>A sample resequencer configuration is shown below.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"inputChannel"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"outputChannel"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int:resequencer</span> <span class="hl-attribute">id</span>=<span class="hl-value">"completelyDefinedResequencer"</span>  <a name="CO5-1" href="#CO5-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
  input-channel="inputChannel"  <a name="CO5-2" href="#CO5-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
  output-channel="outputChannel"  <a name="CO5-3" href="#CO5-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
  discard-channel="discardChannel"  <a name="CO5-4" href="#CO5-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
  release-partial-sequences="true"  <a name="CO5-5" href="#CO5-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
  message-store="messageStore"  <a name="CO5-6" href="#CO5-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>
  send-partial-result-on-expiry="true"  <a name="CO5-7" href="#CO5-7"></a><span><img src="images/callouts/7.png" alt="7" border="0"></span>
  send-timeout="86420000"  <a name="CO5-8" href="#CO5-8"></a><span><img src="images/callouts/8.png" alt="8" border="0"></span>
  correlation-strategy="correlationStrategyBean"  <a name="CO5-9" href="#CO5-9"></a><span><img src="images/callouts/9.png" alt="9" border="0"></span>
  correlation-strategy-method="correlate"  <a name="CO5-10" href="#CO5-10"></a><span><img src="images/callouts/10.png" alt="10" border="0"></span>
  correlation-strategy-expression="headers['foo']"  <a name="CO5-11" href="#CO5-11"></a><span><img src="images/callouts/11.png" alt="11" border="0"></span>
  release-strategy="releaseStrategyBean"  <a name="CO5-12" href="#CO5-12"></a><span><img src="images/callouts/12.png" alt="12" border="0"></span>
  release-strategy-method="release"  <a name="CO5-13" href="#CO5-13"></a><span><img src="images/callouts/13.png" alt="13" border="0"></span>
  release-strategy-expression="size() == 10"  <a name="CO5-14" href="#CO5-14"></a><span><img src="images/callouts/14.png" alt="14" border="0"></span>
  empty-group-min-timeout="60000"  <a name="CO5-15" href="#CO5-15"></a><span><img src="images/callouts/15.png" alt="15" border="0"></span>

  lock-registry="lockRegistry"  <a name="CO5-16" href="#CO5-16"></a>(16)

  group-timeout="60000"  <a name="CO5-17" href="#CO5-17"></a>(17)
  group-timeout-expression="size() ge 2 ? 100 : -1"  <a name="CO5-18" href="#CO5-18"></a>(18)
  scheduler="taskScheduler" /&gt;  <a name="CO5-19" href="#CO5-19"></a>(19)
  expire-group-upon-timeout="false" /&gt;  <a name="CO5-20" href="#CO5-20"></a>(20)</pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO5-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The id of the resequencer is <span class="emphasis"><em>optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO5-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The input channel of the resequencer.
<span class="emphasis"><em>Required</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO5-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The channel to which the resequencer will send the reordered messages.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO5-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The channel to which the resequencer will send the messages that timed out (if <code class="literal">send-partial-result-on-timeout</code> is <span class="emphasis"><em>false)</em></span>.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO5-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Whether to send out ordered sequences as soon as they are available, or only after the whole message group arrives.
<span class="emphasis"><em>Optional (false by default)</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO5-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A reference to a <code class="literal">MessageGroupStore</code> that can be used to store groups of messages under their correlation key until they are complete.
<span class="emphasis"><em>Optional</em></span> with default a volatile in-memory store.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO5-7"><span><img src="images/callouts/7.png" alt="7" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Whether, upon the expiration of the group, the ordered group should be sent out (even if some of the messages are missing).
<span class="emphasis"><em>Optional (false by default)</em></span>.
See <a class="xref" href="messaging-routing-chapter.html#reaper" title="6.4.5&nbsp;Managing State in an Aggregator: MessageGroupStore">Section&nbsp;6.4.5, &#8220;Managing State in an Aggregator: MessageGroupStore&#8221;</a>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO5-8"><span><img src="images/callouts/8.png" alt="8" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The timeout interval to wait when sending a reply <code class="literal">Message</code> to the <code class="literal">output-channel</code> or <code class="literal">discard-channel</code>.
Defaults to <code class="literal">-1</code> - blocking indefinitely.
It is applied only if the output channel has some <span class="emphasis"><em>sending</em></span> limitations, e.g.
<code class="literal">QueueChannel</code> with a fixed <span class="emphasis"><em>capacity</em></span>.
In this case a <code class="literal">MessageDeliveryException</code> is thrown.
The <code class="literal">send-timeout</code> is ignored in case of <code class="literal">AbstractSubscribableChannel</code> implementations.
In case of <code class="literal">group-timeout(-expression)</code> the <code class="literal">MessageDeliveryException</code> from the scheduled expire task leads this task to be rescheduled.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO5-9"><span><img src="images/callouts/9.png" alt="9" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A reference to a bean that implements the message correlation (grouping) algorithm.
The bean can be an implementation of the <code class="literal">CorrelationStrategy</code> interface or a POJO.
In the latter case the correlation-strategy-method attribute must be defined as well.
<span class="emphasis"><em>Optional (by default, the aggregator will use the <code class="literal">IntegrationMessageHeaderAccessor.CORRELATION_ID</code> header)</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO5-10"><span><img src="images/callouts/10.png" alt="10" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A method defined on the bean referenced by <code class="literal">correlation-strategy</code>, that implements the correlation decision algorithm.
<span class="emphasis"><em>Optional, with restrictions (requires <code class="literal">correlation-strategy</code> to be present).</em></span></p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO5-11"><span><img src="images/callouts/11.png" alt="11" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A SpEL expression representing the correlation strategy.
Example: <code class="literal">"headers['foo']"</code>.
Only one of <code class="literal">correlation-strategy</code> or <code class="literal">correlation-strategy-expression</code> is allowed.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO5-12"><span><img src="images/callouts/12.png" alt="12" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A reference to a bean that implements the release strategy.
The bean can be an implementation of the <code class="literal">ReleaseStrategy</code> interface or a POJO.
In the latter case the release-strategy-method attribute must be defined as well.
<span class="emphasis"><em>Optional (by default, the aggregator will use the <code class="literal">IntegrationMessageHeaderAccessor.SEQUENCE_SIZE</code> header attribute)</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO5-13"><span><img src="images/callouts/13.png" alt="13" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A method defined on the bean referenced by <code class="literal">release-strategy</code>, that implements the completion decision algorithm.
<span class="emphasis"><em>Optional, with restrictions (requires <code class="literal">release-strategy</code> to be present).</em></span></p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO5-14"><span><img src="images/callouts/14.png" alt="14" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A SpEL expression representing the release strategy; the root object for the expression is a <code class="literal">Collection</code> of <code class="literal">Message</code> s.
Example: <code class="literal">"size() == 5"</code>.
Only one of <code class="literal">release-strategy</code> or <code class="literal">release-strategy-expression</code> is allowed.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO5-15"><span><img src="images/callouts/15.png" alt="15" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Only applies if a <code class="literal">MessageGroupStoreReaper</code> is configured for the <code class="literal">&lt;resequcencer&gt;</code> <code class="literal">MessageStore</code>.
By default, when a <code class="literal">MessageGroupStoreReaper</code> is configured to expire partial groups, empty groups are also removed.
Empty groups exist after a group is released normally.
This is to enable the detection and discarding of late-arriving messages.
If you wish to expire empty groups on a longer schedule than expiring partial groups, set this property.
Empty groups will then not be removed from the <code class="literal">MessageStore</code> until they have not been modified for at least this number of milliseconds.
Note that the actual time to expire an empty group will also be affected by the reaper&#8217;s <span class="emphasis"><em>timeout</em></span> property and it could be as much as this value plus the timeout.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO5-16">(16)</a> </p></td><td valign="top" align="left">
<p>See <a class="xref" href="messaging-routing-chapter.html#aggregator-xml" title="Configuring an Aggregator with XML">the section called &#8220;Configuring an Aggregator with XML&#8221;</a>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO5-17">(17)</a> </p></td><td valign="top" align="left">
<p>See <a class="xref" href="messaging-routing-chapter.html#aggregator-xml" title="Configuring an Aggregator with XML">the section called &#8220;Configuring an Aggregator with XML&#8221;</a>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO5-18">(18)</a> </p></td><td valign="top" align="left">
<p>See <a class="xref" href="messaging-routing-chapter.html#aggregator-xml" title="Configuring an Aggregator with XML">the section called &#8220;Configuring an Aggregator with XML&#8221;</a>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO5-19">(19)</a> </p></td><td valign="top" align="left">
<p>See <a class="xref" href="messaging-routing-chapter.html#aggregator-xml" title="Configuring an Aggregator with XML">the section called &#8220;Configuring an Aggregator with XML&#8221;</a>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO5-20">(20)</a> </p></td><td valign="top" align="left">
<p>When a group is completed due to a timeout (or by a <code class="literal">MessageGroupStoreReaper</code>), the empty group&#8217;s metadata is retained by default.
Late arriving messages will be immediately discarded.
Set this to <code class="literal">true</code> to remove the group completely; then, late arriving messages will start a new group and won&#8217;t be discarded until the group again times out.
The new group will never be released normally because of the "hole" in the sequence range that caused the timeout.
Empty groups can be expired (completely removed) later using a <code class="literal">MessageGroupStoreReaper</code> together with the <code class="literal">empty-group-min-timeout</code> attribute.
Default: <span class="emphasis"><em>false</em></span>.</p>
</td></tr></table></div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Since there is no custom behavior to be implemented in Java classes for resequencers, there is no annotation support for it.</p>
</td></tr></table></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="chain" href="#chain"></a>6.6&nbsp;Message Handler Chain</h2></div></div></div>

<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="chain-introduction" href="#chain-introduction"></a>6.6.1&nbsp;Introduction</h3></div></div></div>

<p>The <code class="literal">MessageHandlerChain</code> is an implementation of <code class="literal">MessageHandler</code> that can be configured as a single Message Endpoint while actually delegating to a chain of other handlers, such as Filters, Transformers, Splitters, and so on.
This can lead to a much simpler configuration when several handlers need to be connected in a fixed, linear progression.
For example, it is fairly common to provide a Transformer before other components.
Similarly, when providing a <span class="emphasis"><em>Filter</em></span> before some other component in a chain, you are essentially creating a <a class="ulink" href="http://www.eaipatterns.com/MessageSelector.html" target="_top">Selective Consumer</a>.
In either case, the chain only requires a single <code class="literal">input-channel</code> and a single <code class="literal">output-channel</code> eliminating the need to define channels for each individual component.</p>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>Spring Integration&#8217;s <code class="literal">Filter</code> provides a boolean property <code class="literal">throwExceptionOnRejection</code>.
When providing multiple Selective Consumers on the same point-to-point channel with different acceptance criteria, this value should be set to <span class="emphasis"><em>true</em></span> (the default is false) so that the dispatcher will know that the Message was rejected and as a result will attempt to pass the Message on to other subscribers.
If the Exception were not thrown, then it would appear to the dispatcher as if the Message had been passed on successfully even though the Filter had <span class="emphasis"><em>dropped</em></span> the Message to prevent further processing.
If you do indeed want to "drop" the Messages, then the Filter&#8217;s <span class="emphasis"><em>discard-channel</em></span> might be useful since it does give you a chance to perform some operation with the dropped message (e.g.
send to a JMS queue or simply write to a log).</p>
</td></tr></table></div>
<p>The handler chain simplifies configuration while internally maintaining the same degree of loose coupling between components, and it is trivial to modify the configuration if at some point a non-linear arrangement is required.</p>
<p>Internally, the chain will be expanded into a linear setup of the listed endpoints, separated by anonymous channels.
The reply channel header will not be taken into account within the chain: only after the last handler is invoked will the resulting message be forwarded on to the reply channel or the chain&#8217;s output channel.
Because of this setup all handlers except the last required to implement the MessageProducer interface (which provides a <span class="emphasis"><em>setOutputChannel()</em></span> method).
The last handler only needs an output channel if the outputChannel on the MessageHandlerChain is set.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>As with other endpoints, the <code class="literal">output-channel</code> is optional.
If there is a reply Message at the end of the chain, the output-channel takes precedence, but if not available, the chain handler will check for a reply channel header on the inbound Message as a fallback.</p>
</td></tr></table></div>
<p>In most cases there is no need to implement MessageHandlers yourself.
The next section will focus on namespace support for the chain element.
Most Spring Integration endpoints, like Service Activators and Transformers, are suitable for use within a <code class="literal">MessageHandlerChain</code>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="chain-namespace" href="#chain-namespace"></a>6.6.2&nbsp;Configuring a Chain</h3></div></div></div>

<p>The &lt;chain&gt; element provides an <code class="literal">input-channel</code> attribute, and if the last element in the chain is capable of producing reply messages (optional), it also supports an <code class="literal">output-channel</code> attribute.
The sub-elements are then filters, transformers, splitters, and service-activators.
The last element may also be a router or an outbound-channel-adapter.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:chain</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:filter</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"someSelector"</span> <span class="hl-attribute">throw-exception-on-rejection</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int:header-enricher&gt;</span>
        <span class="hl-tag">&lt;int:header</span> <span class="hl-attribute">name</span>=<span class="hl-value">"foo"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"bar"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/int:header-enricher&gt;</span>
    <span class="hl-tag">&lt;int:service-activator</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"someService"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"someMethod"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:chain&gt;</span></pre>
<p>The &lt;header-enricher&gt; element used in the above example will set a message header named "foo" with a value of "bar" on the message.
A header enricher is a specialization of <code class="literal">Transformer</code> that touches only header values.
You could obtain the same result by implementing a MessageHandler that did the header modifications and wiring that as a bean, but the header-enricher is obviously a simpler option.</p>
<p>The &lt;chain&gt; can be configured as the last <span class="emphasis"><em>black-box</em></span> consumer of the message flow.
For this solution it is enough to put at the end of the &lt;chain&gt; some &lt;outbound-channel-adapter&gt;:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:chain</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int-xml:marshalling-transformer</span> <span class="hl-attribute">marshaller</span>=<span class="hl-value">"marshaller"</span> <span class="hl-attribute">result-type</span>=<span class="hl-value">"StringResult"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;int:service-activator</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"someService"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"someMethod"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int:header-enricher&gt;</span>
        <span class="hl-tag">&lt;int:header</span> <span class="hl-attribute">name</span>=<span class="hl-value">"foo"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"bar"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/int:header-enricher&gt;</span>
    <span class="hl-tag">&lt;int:logging-channel-adapter</span> <span class="hl-attribute">level</span>=<span class="hl-value">"INFO"</span> <span class="hl-attribute">log-full-message</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:chain&gt;</span></pre>
<p><span class="emphasis"><em>Disallowed Attributes and Elements</em></span></p>
<p>It is important to note that certain attributes, such as <span class="strong"><strong>order</strong></span> and <span class="strong"><strong>input-channel</strong></span> are not allowed to be specified on components used within a <span class="emphasis"><em>chain</em></span>.
The same is true for the <span class="strong"><strong>poller</strong></span> sub-element.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>For the <span class="emphasis"><em>Spring Integration</em></span> core components, the XML Schema itself will enforce some of these constraints.
However, for non-core components or your own custom components, these constraints are enforced by the XML namespace parser, not by the XML Schema.</p>
<p>These XML namespace parser constraints were added with <span class="emphasis"><em>Spring Integration 2.2</em></span>.
The XML namespace parser will throw an <code class="literal">BeanDefinitionParsingException</code> if you try to use disallowed attributes and elements.</p>
</td></tr></table></div>
<p><span class="emphasis"><em>'id' Attribute</em></span></p>
<p>Beginning with Spring Integration 3.0, if a chain element is given an <span class="emphasis"><em>id</em></span>, the bean name for the element is a combination of the chain&#8217;s <span class="emphasis"><em>id</em></span> and the <span class="emphasis"><em>id</em></span> of the element itself.
Elements without an <span class="emphasis"><em>id</em></span> are not registered as beans, but they are given <code class="literal">componentName</code> s that include the chain id.
For example:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:chain</span> <span class="hl-attribute">id</span>=<span class="hl-value">"fooChain"</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:service-activator</span> <span class="hl-attribute">id</span>=<span class="hl-value">"fooService"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"someService"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"someMethod"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int:object-to-json-transformer/&gt;</span>
<span class="hl-tag">&lt;/int:chain&gt;</span></pre>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
The <code class="literal">&lt;chain&gt;</code> root element has an <span class="emphasis"><em>id</em></span> <span class="emphasis"><em>fooChain</em></span>.
So, the <code class="literal">AbstractEndpoint</code> implementation (<code class="literal">PollingConsumer</code> or <code class="literal">EventDrivenConsumer</code>, depending on the <span class="emphasis"><em>input-channel</em></span> type) bean takes this value as it&#8217;s bean name.
</li><li class="listitem">
The <code class="literal">MessageHandlerChain</code> bean acquires a bean alias <span class="emphasis"><em>fooChain.handler</em></span>, which allows direct access to this bean from the <code class="literal">BeanFactory</code>.
</li><li class="listitem">
The <code class="literal">&lt;service-activator&gt;</code> is not a fully-fledged Messaging Endpoint (<code class="literal">PollingConsumer</code> or <code class="literal">EventDrivenConsumer</code>) - it is simply a <code class="literal">MessageHandler</code> within the <code class="literal">&lt;chain&gt;</code>.
In this case, the bean name registered with the <code class="literal">BeanFactory</code> is <span class="emphasis"><em>fooChain$child.fooService.handler</em></span>.
</li><li class="listitem">
The <span class="emphasis"><em>componentName</em></span> of this <code class="literal">ServiceActivatingHandler</code> takes the same value, but without the <span class="emphasis"><em>.handler</em></span> suffix - <span class="emphasis"><em>fooChain$child.fooService</em></span>.
</li><li class="listitem">
The last <code class="literal">&lt;chain&gt;</code> sub-component, <code class="literal">&lt;object-to-json-transformer&gt;</code>, doesn&#8217;t have an <span class="emphasis"><em>id</em></span> attribute.
Its <span class="emphasis"><em>componentName</em></span> is based on its position in the <code class="literal">&lt;chain&gt;</code>.
In this case, it is <span class="emphasis"><em>fooChain$child#1</em></span>.
(The final element of the name is the order within the chain, beginning with <span class="emphasis"><em>#0</em></span>).
Note, this transformer isn&#8217;t registered as a bean within the application context, so, it doesn&#8217;t get a <span class="emphasis"><em>beanName</em></span>, however its <span class="emphasis"><em>componentName</em></span> has a value which is useful for logging etc.
</li></ul></div>
<p>The <span class="emphasis"><em>id</em></span> attribute for <code class="literal">&lt;chain&gt;</code> elements allows them to be eligible for <a class="link" href="system-management-chapter.html#jmx-mbean-exporter" title="9.2.7&nbsp;MBean Exporter">JMX export</a> and they are trackable via <a class="link" href="system-management-chapter.html#message-history" title="9.3&nbsp;Message History">Message History</a>.
They can also be accessed from the <code class="literal">BeanFactory</code> using the appropriate bean name as discussed above.</p>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>It is useful to provide an explicit <span class="emphasis"><em>id</em></span> attribute on <code class="literal">&lt;chain&gt;</code> s to simplify the identification of sub-components in logs, and to provide access to them from the <code class="literal">BeanFactory</code> etc.</p>
</td></tr></table></div>
<p><span class="emphasis"><em>Calling a Chain from within a Chain</em></span></p>
<p>Sometimes you need to make a nested call to another chain from within a chain and then come back and continue execution within the original chain.
To accomplish this you can utilize a Messaging Gateway by including a &lt;gateway&gt; element.
For example:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:chain&nbsp;id="main-chain"&nbsp;input-channel="in"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"out"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:header-enricher&gt;</span>
      <span class="hl-tag">&lt;int:header</span> <span class="hl-attribute">name</span>=<span class="hl-value">"name"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"Many"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;/int:header-enricher&gt;</span>
    <span class="hl-tag">&lt;int:service-activator&gt;</span>
      <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.foo.SampleService"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;/int:service-activator&gt;</span>
    <span class="hl-tag">&lt;int:gateway</span> <span class="hl-attribute">request-channel</span>=<span class="hl-value">"inputA"</span><span class="hl-tag">/&gt;</span> &nbsp;
<span class="hl-tag">&lt;/int:chain&gt;</span>

<span class="hl-tag">&lt;int:chain&nbsp;id="nested-chain-a"&nbsp;input-channel="inputA"&gt;</span>
    <span class="hl-tag">&lt;int:header-enricher&gt;</span>
        <span class="hl-tag">&lt;int:header</span> <span class="hl-attribute">name</span>=<span class="hl-value">"name"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"Moe"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;/int:header-enricher&gt;</span>
    <span class="hl-tag">&lt;int:gateway</span> <span class="hl-attribute">request-channel</span>=<span class="hl-value">"inputB"</span><span class="hl-tag">/&gt;</span>&nbsp;
    <span class="hl-tag">&lt;int:service-activator&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.foo.SampleService"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;/int:service-activator&gt;</span>
<span class="hl-tag">&lt;/int:chain&gt;</span>

<span class="hl-tag">&lt;int:chain&nbsp;id="nested-chain-b"&nbsp;input-channel="inputB"&gt;</span>
    <span class="hl-tag">&lt;int:header-enricher&gt;</span>
        <span class="hl-tag">&lt;int:header</span> <span class="hl-attribute">name</span>=<span class="hl-value">"name"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"Jack"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;/int:header-enricher&gt;</span>
    <span class="hl-tag">&lt;int:service-activator&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.foo.SampleService"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;/int:service-activator&gt;</span>
<span class="hl-tag">&lt;/int:chain&gt;</span></pre>
<p>In the above example the <span class="emphasis"><em>nested-chain-a</em></span> will be called at the end of <span class="emphasis"><em>main-chain</em></span> processing by the <span class="emphasis"><em>gateway</em></span> element configured there.
While in <span class="emphasis"><em>nested-chain-a</em></span> a call to a <span class="emphasis"><em>nested-chain-b</em></span> will be made after header enrichment and then it will come back to finish execution in <span class="emphasis"><em>nested-chain-b</em></span>.
Finally the flow returns to the <span class="emphasis"><em>main-chain</em></span>.
When the nested version of a &lt;gateway&gt; element is defined in the chain, it does not require the <code class="literal">service-interface</code> attribute.
Instead, it simple takes the message in its current state and places it on the channel defined via the <code class="literal">request-channel</code> attribute.
When the downstream flow initiated by that gateway completes, a <code class="literal">Message</code> will be returned to the gateway and continue its journey within the current chain.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="scatter-gather" href="#scatter-gather"></a>6.7&nbsp;Scatter-Gather</h2></div></div></div>

<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="scatter-gather-introduction" href="#scatter-gather-introduction"></a>6.7.1&nbsp;Introduction</h3></div></div></div>

<p>Starting with <span class="emphasis"><em>version 4.1</em></span>, Spring Integration provides an implementation of the <a class="ulink" href="http://www.eaipatterns.com/BroadcastAggregate.html" target="_top">Scatter-Gather</a> Enterprise Integration Pattern.
It is a compound endpoint, where the goal is to send a message to the recipients and aggregate the results.
Quoting the EIP Book, it is a component for scenarios like <span class="emphasis"><em>best quote</em></span>, when we need to request information from several suppliers and decide which one provides us with the best term for the requested item.</p>
<p>Previously, the pattern could be configured using discrete components, this enhancement brings more convenient configuration.</p>
<p>The <code class="literal">ScatterGatherHandler</code> is a <span class="emphasis"><em>request-reply</em></span> endpoint that combines a <code class="literal">PublishSubscribeChannel</code> (or <code class="literal">RecipientListRouter</code>) and an <code class="literal">AggregatingMessageHandler</code>.
The request message is sent to the <code class="literal">scatter</code> channel and the <code class="literal">ScatterGatherHandler</code> waits for the reply from the aggregator to sends to the <code class="literal">outputChannel</code>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="scatter-gather-functionality" href="#scatter-gather-functionality"></a>6.7.2&nbsp;Functionality</h3></div></div></div>

<p>The <code class="literal">Scatter-Gather</code> pattern suggests two scenarios - <span class="emphasis"><em>Auction</em></span> and <span class="emphasis"><em>Distribution</em></span>.
In both cases, the <code class="literal">aggregation</code> function is the same and provides all options available for the <code class="literal">AggregatingMessageHandler</code>.
Actually the <code class="literal">ScatterGatherHandler</code> just requires an <code class="literal">AggregatingMessageHandler</code> as a constructor argument.
See <a class="xref" href="messaging-routing-chapter.html#aggregator" title="6.4&nbsp;Aggregator">Section&nbsp;6.4, &#8220;Aggregator&#8221;</a> for more information.</p>
<p><span class="emphasis"><em>Auction</em></span></p>
<p>The <span class="emphasis"><em>Auction</em></span> <code class="literal">Scatter-Gather</code> variant uses <code class="literal">publish-subscribe</code> logic for the request message, where the <code class="literal">scatter</code> channel is a <code class="literal">PublishSubscribeChannel</code> with <code class="literal">apply-sequence="true"</code>.
However, this channel can be any <code class="literal">MessageChannel</code> implementation as is the case with the <code class="literal">request-channel</code> in the <code class="literal">ContentEnricher</code> (see <a class="xref" href="messaging-transformation-chapter.html#content-enricher" title="7.2&nbsp;Content Enricher">Section&nbsp;7.2, &#8220;Content Enricher&#8221;</a>) but, in this case, the end-user should support his own custom <code class="literal">correlationStrategy</code> for the <code class="literal">aggregation</code> function.</p>
<p><span class="emphasis"><em>Distribution</em></span></p>
<p>The <span class="emphasis"><em>Distribution</em></span> <code class="literal">Scatter-Gather</code> variant is based on the <code class="literal">RecipientListRouter</code> (see <a class="xref" href="messaging-routing-chapter.html#router-implementations-recipientlistrouter" title="RecipientListRouter">the section called &#8220;RecipientListRouter&#8221;</a>) with all available options for the <code class="literal">RecipientListRouter</code>.
This is the second <code class="literal">ScatterGatherHandler</code> constructor argument.
If you want to rely just on the default <code class="literal">correlationStrategy</code> for the <code class="literal">recipient-list-router</code> and the <code class="literal">aggregator</code>, you should specify <code class="literal">apply-sequence="true"</code>.
Otherwise, a custom <code class="literal">correlationStrategy</code> should be supplied for the <code class="literal">aggregator</code>.
Unlike the <code class="literal">PublishSubscribeChannel</code> (<span class="emphasis"><em>Auction</em></span>) variant, having a <code class="literal">recipient-list-router</code> <code class="literal">selector</code> option, we can <span class="emphasis"><em>filter</em></span> target suppliers based on the message.
With <code class="literal">apply-sequence="true"</code> the default <code class="literal">sequenceSize</code> will be supplied and the <code class="literal">aggregator</code> will be able to release the group correctly.
The <span class="emphasis"><em>Distribution</em></span> option is mutually exclusive with the <span class="emphasis"><em>Auction</em></span> option.</p>
<p>In both cases, the request (<span class="emphasis"><em>scatter</em></span>) message is enriched with the <code class="literal">gatherResultChannel</code> <code class="literal">QueueChannel</code> header, to wait for a reply message from the <code class="literal">aggregator</code>.</p>
<p>By default, all suppliers should send their result to the <code class="literal">replyChannel</code> header (usually by omitting the <code class="literal">output-channel</code> from the ultimate endpoint).
However, the <code class="literal">gatherChannel</code> option is also provided, allowing suppliers to send their reply to that channel for the aggregation.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="scatter-gather-namespace" href="#scatter-gather-namespace"></a>6.7.3&nbsp;Configuring a Scatter-Gather Endpoint</h3></div></div></div>

<p>For Java and Annotation configuration, the bean definition for the <code class="literal">Scatter-Gather</code> is:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> MessageHandler distributor() {
    RecipientListRouter router = <span class="hl-keyword">new</span> RecipientListRouter();
    router.setApplySequence(true);
    router.setChannels(Arrays.asList(distributionChannel1(), distributionChannel2(),
            distributionChannel3()));
    <span class="hl-keyword">return</span> router;
}

<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> MessageHandler gatherer() {
	<span class="hl-keyword">return</span> <span class="hl-keyword">new</span> AggregatingMessageHandler(
			<span class="hl-keyword">new</span> ExpressionEvaluatingMessageGroupProcessor(<span class="hl-string">"^[payload gt 5] ?: -1D"</span>),
			<span class="hl-keyword">new</span> SimpleMessageStore(),
			<span class="hl-keyword">new</span> HeaderAttributeCorrelationStrategy(
			       IntegrationMessageHeaderAccessor.CORRELATION_ID),
			<span class="hl-keyword">new</span> ExpressionEvaluatingReleaseStrategy(<span class="hl-string">"size() == 2"</span>));
}

<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "distributionChannel")</span></em>
<span class="hl-keyword">public</span> MessageHandler scatterGatherDistribution() {
	ScatterGatherHandler handler = <span class="hl-keyword">new</span> ScatterGatherHandler(distributor(), gatherer());
	handler.setOutputChannel(output());
	<span class="hl-keyword">return</span> handler;
}</pre>
<p>Here, we configure the <code class="literal">RecipientListRouter</code> <code class="literal">distributor</code> bean, with <code class="literal">applySequence="true"</code> and the list of recipient channels.
The next bean is for an <code class="literal">AggregatingMessageHandler</code>.
Finally, we inject both those beans into the <code class="literal">ScatterGatherHandler</code> bean definition and mark it as a <code class="literal">@ServiceActivator</code> to wire the Scatter-Gather component into the integration flow.</p>
<p>Configuring the <code class="literal">&lt;scatter-gather&gt;</code> endpoint using the XML namespace:</p>
<pre class="programlisting"><span class="hl-tag">&lt;scatter-gather</span>
		<span class="hl-attribute">id</span>=<span class="hl-value">""</span>  <a name="CO6-1" href="#CO6-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
		auto-startup=""  <a name="CO6-2" href="#CO6-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
		input-channel=""  <a name="CO6-3" href="#CO6-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
		output-channel=""  <a name="CO6-4" href="#CO6-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
		scatter-channel=""  <a name="CO6-5" href="#CO6-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
		gather-channel=""  <a name="CO6-6" href="#CO6-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>
		order=""  <a name="CO6-7" href="#CO6-7"></a><span><img src="images/callouts/7.png" alt="7" border="0"></span>
		phase=""  <a name="CO6-8" href="#CO6-8"></a><span><img src="images/callouts/8.png" alt="8" border="0"></span>
		send-timeout=""  <a name="CO6-9" href="#CO6-9"></a><span><img src="images/callouts/9.png" alt="9" border="0"></span>
		gather-timeout=""  <a name="CO6-10" href="#CO6-10"></a><span><img src="images/callouts/10.png" alt="10" border="0"></span>
		requires-reply="" &gt; <a name="CO6-11" href="#CO6-11"></a><span><img src="images/callouts/11.png" alt="11" border="0"></span>
			<span class="hl-tag">&lt;scatterer/&gt;</span>  <a name="CO6-12" href="#CO6-12"></a><span><img src="images/callouts/12.png" alt="12" border="0"></span>
			<span class="hl-tag">&lt;gatherer/&gt;</span>  <a name="CO6-13" href="#CO6-13"></a><span><img src="images/callouts/13.png" alt="13" border="0"></span>
<span class="hl-tag">&lt;/scatter-gather&gt;</span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO6-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The id of the Endpoint.
The <code class="literal">ScatterGatherHandler</code> bean is registered with <code class="literal">id + '.handler'</code> alias.
The <code class="literal">RecipientListRouter</code> - with <code class="literal">id + '.scatterer'</code>.
And the <code class="literal">AggregatingMessageHandler</code> with <code class="literal">id + '.gatherer'</code>.
<span class="emphasis"><em>Optional</em></span> (a default id is generated value by <code class="literal">BeanFactory</code>).</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO6-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Lifecycle attribute signaling if the Endpoint should be started during Application Context initialization.
In addition, the <code class="literal">ScatterGatherHandler</code> also implements <code class="literal">Lifecycle</code> and starts/stops the <code class="literal">gatherEndpoint</code>, which is created internally if a <code class="literal">gather-channel</code> is provided.
<span class="emphasis"><em>Optional</em></span> (default is <code class="literal">true</code>).</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO6-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The channel to receive request messages to handle them in the <code class="literal">ScatterGatherHandler</code>.
<span class="emphasis"><em>Required</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO6-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The channel to which the Scatter-Gather will send the aggregation results.
<span class="emphasis"><em>Optional (because incoming messages can specify a reply channel themselves via <code class="literal">replyChannel</code> Message Header)</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO6-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The channel to send the scatter message for the <span class="emphasis"><em>Auction</em></span> scenario.
<span class="emphasis"><em>Optional</em></span>.
Mutually exclusive with <code class="literal">&lt;scatterer&gt;</code> sub-element.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO6-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The channel to receive replies from each supplier for the aggregation.
is used as the <code class="literal">replyChannel</code> header in the scatter message.
<span class="emphasis"><em>Optional</em></span>.
By default the <code class="literal">FixedSubscriberChannel</code> is created.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO6-7"><span><img src="images/callouts/7.png" alt="7" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Order of this component when more than one handler is subscribed to the same DirectChannel (use for load balancing purposes).
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO6-8"><span><img src="images/callouts/8.png" alt="8" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Specify the phase in which the endpoint should be started and stopped.
The startup order proceeds from lowest to highest, and the shutdown order is the reverse of that.
By default this value is Integer.MAX_VALUE meaning that this container starts as late as possible and stops as soon as possible.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO6-9"><span><img src="images/callouts/9.png" alt="9" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The timeout interval to wait when sending a reply <code class="literal">Message</code> to the <code class="literal">output-channel</code>.
By default the send will block for one second.
It applies only if the output channel has some <span class="emphasis"><em>sending</em></span> limitations, e.g.
a <code class="literal">QueueChannel</code> with a fixed <span class="emphasis"><em>capacity</em></span> and is full.
In this case, a <code class="literal">MessageDeliveryException</code> is thrown.
The <code class="literal">send-timeout</code> is ignored in case of <code class="literal">AbstractSubscribableChannel</code> implementations.
In case of <code class="literal">group-timeout(-expression)</code> the <code class="literal">MessageDeliveryException</code> from the scheduled expire task leads this task to be rescheduled.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO6-10"><span><img src="images/callouts/10.png" alt="10" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Allows you to specify how long the Scatter-Gather will wait for the reply message before returning.
By default it will wait indefinitely.
<span class="emphasis"><em>null</em></span> is returned if the reply times out.
<span class="emphasis"><em>Optional</em></span>.
Defaults to <code class="literal">-1</code> - indefinitely.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO6-11"><span><img src="images/callouts/11.png" alt="11" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Specify whether the Scatter-Gather must return a non-null value.
This value is <code class="literal">true</code> by default, hence a <code class="literal">ReplyRequiredException</code> will be thrown when the underlying aggregator returns a null value after <code class="literal">gather-timeout</code>.
Note, if <code class="literal">null</code> is a possibility, the <code class="literal">gather-timeout</code> should be specified to avoid an indefinite wait.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO6-12"><span><img src="images/callouts/12.png" alt="12" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The <code class="literal">&lt;recipient-list-router&gt;</code> options.
<span class="emphasis"><em>Optional</em></span>.
Mutually exclusive with <code class="literal">scatter-channel</code> attribute.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO6-13"><span><img src="images/callouts/13.png" alt="13" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The <code class="literal">&lt;aggregator&gt;</code> options.
<span class="emphasis"><em>Required</em></span>.</p>
</td></tr></table></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="barrier" href="#barrier"></a>6.8&nbsp;Thread Barrier</h2></div></div></div>

<p>Sometimes, we need to suspend a message flow thread until some other asynchronous event occurs.
For example, consider an HTTP request that publishes a message to RabbitMQ.
We might wish to not reply to the user until the RabbitMQ broker has issued an acknowledgment that the message was
received.</p>
<p>Spring Integration <span class="emphasis"><em>version 4.2</em></span> introduced the <code class="literal">&lt;barrier/&gt;</code> component for this purpose.
The underlying <code class="literal">MessageHandler</code> is the <code class="literal">BarrierMessageHandler</code>; this class also implements
<code class="literal">MessageTriggerAction</code> where a message passed to the <code class="literal">trigger()</code> method releases a corresponding thread in the
<code class="literal">handleRequestMessage()</code> method (if present).</p>
<p>The suspended thread and trigger thread are correlated by invoking a <code class="literal">CorrelationStrategy</code> on the messages.
When a message is sent to the <code class="literal">input-channel</code>, the thread is suspended for up to <code class="literal">timeout</code> milliseconds, waiting for
a corresponding trigger message.
The default correlation strategy uses the <code class="literal">IntegrationMessageHeaderAccessor.CORRELATION_ID</code> header.
When a trigger message arrives with the same correlation, the thread is released.
The message sent to the <code class="literal">output-channel</code> after release is constructed using a <code class="literal">MessageGroupProcessor</code>.
By default, the message is a <code class="literal">Collection&lt;?&gt;</code> of the two payloads and the headers are merged, using a
<code class="literal">DefaultAggregatingMessageGroupProcessor</code>.</p>
<div class="caution" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Caution"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Caution]" src="images/caution.png"></td><th align="left">Caution</th></tr><tr><td align="left" valign="top">
<p>If the <code class="literal">trigger()</code> method is invoked first (or after the main thread times out), it will be suspended
for up to <code class="literal">timeout</code> waiting for the suspending message to arrive.
If you do not want to suspend the trigger thread, consider handing off to a <code class="literal">TaskExecutor</code> instead so its thread
will be suspended instead.</p>
</td></tr></table></div>
<p>The <code class="literal">requires-reply</code> property determines the action if the suspended thread times out before the trigger message
arrives.
By default, it is <code class="literal">false</code> which means the endpoint simply returns <code class="literal">null</code>, the flow ends and the thread returns to the
caller.
When <code class="literal">true</code>, a <code class="literal">ReplyRequiredException</code> is thrown.</p>
<p>You can call the <code class="literal">trigger()</code> method programmatically (obtain the bean reference using the name <code class="literal">barrier.handler</code>
 - where <span class="emphasis"><em>barrier</em></span> is the bean name of the barrier endpoint) or you can configure
an <code class="literal">&lt;outbound-channel-adapter/&gt;</code> to trigger the release.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Only one thread can be suspended with the same correlation; the same correlation can be used multiple times
but only once concurrently.
An exception is thrown if a second thread arrives with the same correlation.</p>
</td></tr></table></div>
<pre class="programlisting"><span class="hl-tag">&lt;int:barrier</span> <span class="hl-attribute">id</span>=<span class="hl-value">"barrier1"</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"in"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"out"</span>
        <span class="hl-attribute">correlation-strategy-expression</span>=<span class="hl-value">"headers['myHeader']"</span>
        <span class="hl-attribute">output-processor</span>=<span class="hl-value">"myOutputProcessor"</span>
        <span class="hl-attribute">discard-channel</span>=<span class="hl-value">"lateTriggerChannel"</span>
        <span class="hl-attribute">timeout</span>=<span class="hl-value">"10000"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;/int:barrier&gt;</span>

<span class="hl-tag">&lt;int:outbound-channel-adapter</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"release"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"barrier1.handler"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"trigger"</span><span class="hl-tag"> /&gt;</span></pre>
<p>In this example, a custom header is used for correlation.
Either the thread sending a message to <code class="literal">in</code> or the one sending a message to <code class="literal">release</code> will wait for
up to 10 seconds until the other arrives.
When the message is released, the <code class="literal">out</code> channel will be sent a message combining the result of invoking the
custom <code class="literal">MessageGroupProcessor</code> bean <code class="literal">myOutputProcessor</code>.
If the main thread times out and a trigger arrives later, you can configure a discard channel to which the late trigger will be sent.
Java configuration is shown below.</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Configuration</span></em>
<em><span class="hl-annotation" style="color: gray">@EnableIntegration</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> Config {

    <em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel="in")</span></em>
    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> BarrierMessageHandler barrier() {
        BarrierMessageHandler barrier = <span class="hl-keyword">new</span> BarrierMessageHandler(<span class="hl-number">10000</span>);
        barrier.setOutputChannel(out());
        barrier.setDiscardChannel(lateTriggers());
        <span class="hl-keyword">return</span> barrier;
    }

    <em><span class="hl-annotation" style="color: gray">@ServiceActivator</span></em> (inputChannel=<span class="hl-string">"release"</span>)
    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> MessageHandler releaser() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> MessageHandler() {

            <em><span class="hl-annotation" style="color: gray">@Override</span></em>
            <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> handleMessage(Message&lt;?&gt; message) <span class="hl-keyword">throws</span> MessagingException {
                barrier().trigger(message);
            }

        };
    }

}</pre>
<p>See the
<a class="ulink" href="https://github.com/spring-projects/spring-integration-samples/tree/master/basic/barrier" target="_top">barrier sample application</a>
for an example of this component.</p>
</div>
</div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="messaging-construction-chapter.html">Prev</a>&nbsp;</td><td width="20%" align="center"><a accesskey="u" href="spring-integration-core-messaging.html">Up</a></td><td width="40%" align="right">&nbsp;<a accesskey="n" href="messaging-transformation-chapter.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">5.&nbsp;Message Construction&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top">&nbsp;7.&nbsp;Message Transformation</td></tr></table></div></body></html>