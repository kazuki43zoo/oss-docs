<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>22.&nbsp;MongoDb Support</title><link rel="stylesheet" type="text/css" href="css/manual-multipage.css"><meta name="generator" content="DocBook XSL Stylesheets V1.78.1"><link rel="home" href="index.html" title="Spring Integration Reference Manual"><link rel="up" href="spring-integration-endpoints.html" title="Part&nbsp;V.&nbsp;Integration Endpoints"><link rel="prev" href="mail.html" title="21.&nbsp;Mail Support"><link rel="next" href="mqtt.html" title="23.&nbsp;MQTT Support"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">22.&nbsp;MongoDb Support</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="mail.html">Prev</a>&nbsp;</td><th width="60%" align="center">Part&nbsp;V.&nbsp;Integration Endpoints</th><td width="20%" align="right">&nbsp;<a accesskey="n" href="mqtt.html">Next</a></td></tr></table><hr></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="mongodb" href="#mongodb"></a>22.&nbsp;MongoDb Support</h2></div></div></div>

<p>As of version 2.1 Spring Integration introduces support for <a class="ulink" href="http://www.mongodb.org/" target="_top">MongoDB</a>: a <span class="emphasis"><em>"high-performance, open source, document-oriented database"</em></span>.
This support comes in the form of a MongoDB-based MessageStore.</p>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="mongodb-intro" href="#mongodb-intro"></a>22.1&nbsp;Introduction</h2></div></div></div>

<p>To download, install, and run MongoDB please refer to the <a class="ulink" href="http://www.mongodb.org/downloads" target="_top">MongoDB documentation</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="mongodb-connection" href="#mongodb-connection"></a>22.2&nbsp;Connecting to MongoDb</h2></div></div></div>

<p>To begin interacting with MongoDB you first need to connect to it.
Spring Integration builds on the support provided by another Spring project, <a class="ulink" href="http://projects.spring.io/spring-data-mongodb/" target="_top">Spring Data MongoDB</a>, which provides a factory class called <code class="literal">MongoDbFactory</code> that simplifies integration with the MongoDB Client API.</p>
<p><span class="emphasis"><em>MongoDbFactory</em></span></p>
<p>To connect to MongoDB you can use an implementation of the <code class="literal">MongoDbFactory</code> interface:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> MongoDbFactory {

	<strong class="hl-tag" style="color: blue">/**
	 * Creates a default {@link DB} instance.
	 *
	 * @return the DB instance
	 * @throws DataAccessException
	 */</strong>
	DB getDb() <span class="hl-keyword">throws</span> DataAccessException;

	<strong class="hl-tag" style="color: blue">/**
	 * Creates a {@link DB} instance to access the database with the given name.
	 *
	 * @param dbName must not be {@literal null} or empty.
	 *
	 * @return the DB instance
	 * @throws DataAccessException
	 */</strong>
	DB getDb(String dbName) <span class="hl-keyword">throws</span> DataAccessException;
}</pre>
<p>The example below shows <code class="literal">SimpleMongoDbFactory</code>, the out-of-the-box implementation:</p>
<p>In Java:</p>
<pre class="programlisting">MongoDbFactory mongoDbFactory = <span class="hl-keyword">new</span> SimpleMongoDbFactory(<span class="hl-keyword">new</span> Mongo(), <span class="hl-string">"test"</span>);</pre>
<p>Or in Spring&#8217;s XML configuration:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"mongoDbFactory"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.data.mongodb.core.SimpleMongoDbFactory"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.mongodb.Mongo"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/constructor-arg&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"test"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
<p>As you can see <code class="literal">SimpleMongoDbFactory</code> takes two arguments: 1) a <code class="literal">Mongo</code> instance and 2) a String specifying the name of the database.
If you need to configure properties such as <code class="literal">host</code>, <code class="literal">port</code>, etc, you can pass those using one of the constructors provided by the underlying <code class="literal">Mongo</code> class.
For more information on how to configure MongoDB, please refer to the <a class="ulink" href="http://docs.spring.io/spring-data/data-mongo/docs/current/reference/html/" target="_top">Spring-Data-MongoDB</a> reference.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="mongodb-message-store" href="#mongodb-message-store"></a>22.3&nbsp;MongoDB Message Store</h2></div></div></div>

<p>As described in EIP, a <a class="ulink" href="http://www.eaipatterns.com/MessageStore.html" target="_top">Message Store</a> allows you to persist Messages.
This can be very useful when dealing with components that have a capability to buffer messages (<span class="emphasis"><em>QueueChannel, Aggregator, Resequencer</em></span>, etc.) if reliability is a concern.
In Spring Integration, the <code class="literal">MessageStore</code> strategy also provides the foundation for the <a class="ulink" href="http://www.eaipatterns.com/StoreInLibrary.html" target="_top">ClaimCheck</a> pattern, which is described in EIP as well.</p>
<p>Spring Integration&#8217;s MongoDB module provides the <code class="literal">MongoDbMessageStore</code> which is an implementation of both the <code class="literal">MessageStore</code> strategy (mainly used by the <span class="emphasis"><em>ClaimCheck</em></span> pattern) and the <code class="literal">MessageGroupStore</code> strategy (mainly used by the <span class="emphasis"><em>Aggregator</em></span> and <span class="emphasis"><em>Resequencer</em></span> patterns).</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"mongoDbMessageStore"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.mongodb.store.MongoDbMessageStore"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"mongoDbFactory"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"somePersistentQueueChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:queue</span> <span class="hl-attribute">message-store</span>=<span class="hl-value">"mongoDbMessageStore"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;int:channel&gt;</span>

<span class="hl-tag">&lt;int:aggregator</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"inputChannel"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"outputChannel"</span>
         <span class="hl-attribute">message-store</span>=<span class="hl-value">"mongoDbMessageStore"</span><span class="hl-tag">/&gt;</span></pre>
<p>Above is a sample <code class="literal">MongoDbMessageStore</code> configuration that shows its usage by a <span class="emphasis"><em>QueueChannel</em></span> and an <span class="emphasis"><em>Aggregator</em></span>.
As you can see it is a simple bean configuration, and it expects a <code class="literal">MongoDbFactory</code> as a constructor argument.</p>
<p>The <code class="literal">MongoDbMessageStore</code> expands the <code class="literal">Message</code> as a Mongo document with all nested properties using the Spring Data Mongo Mapping mechanism.
It is useful when you need to have access to the <code class="literal">payload</code> or <code class="literal">headers</code> for auditing or analytics, for example, against stored messages.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>The <code class="literal">MongoDbMessageStore</code> uses a custom <code class="literal">MappingMongoConverter</code> implementation to store <code class="literal">Message</code> s as MongoDB documents and there are some limitations for the properties (<code class="literal">payload</code> and <code class="literal">header</code> values) of the <code class="literal">Message</code>.
For example, there is no ability to configure custom converters for complex domain <code class="literal">payload</code> s or <code class="literal">header</code> values.
Or to provide a custom <code class="literal">MongoTemplate</code> (or <code class="literal">MappingMongoConverter</code>).
To achieve these capabilities, an alternative MongoDB <code class="literal">MessageStore</code> implementation has been introduced; see next paragraph.</p>
</td></tr></table></div>
<p><span class="emphasis"><em>Spring Integration 3.0</em></span> introduced the <code class="literal">ConfigurableMongoDbMessageStore</code> - <code class="literal">MessageStore</code> and <code class="literal">MessageGroupStore</code> implementation.
This class can receive, as a constructor argument, a <code class="literal">MongoTemplate</code>, with which you can configure with a custom <code class="literal">WriteConcern</code>, for example.
Another constructor requires a <code class="literal">MappingMongoConverter</code>, and a <code class="literal">MongoDbFactory</code>, which allows you to provide some custom conversions for <code class="literal">Message</code> s and their properties.
Note, by default, the <code class="literal">ConfigurableMongoDbMessageStore</code> uses standard Java serialization to write/read <code class="literal">Message</code> s to/from MongoDB (see <code class="literal">MongoDbMessageBytesConverter</code>) and relies on default values for other properties from <code class="literal">MongoTemplate</code>, which is built from the provided <code class="literal">MongoDbFactory</code> and <code class="literal">MappingMongoConverter</code>.
The default name for the collection stored by the <code class="literal">ConfigurableMongoDbMessageStore</code> is <code class="literal">configurableStoreMessages</code>.
It is recommended to use this implementation for robust and flexible solutions when messages contain complex data types.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="mongodb-priority-channel-message-store" href="#mongodb-priority-channel-message-store"></a>22.3.1&nbsp;MongoDB Channel Message Store</h3></div></div></div>

<p>Starting with <span class="emphasis"><em>version 4.0</em></span>, the new <code class="literal">MongoDbChannelMessageStore</code> has been introduced; it is an optimized <code class="literal">MessageGroupStore</code> for use in <code class="literal">QueueChannel</code> s.
With <code class="literal">priorityEnabled = true</code>, it can be used in <code class="literal">&lt;int:priority-queue&gt;</code> s to achieve <span class="emphasis"><em>priority</em></span> order polling for persisted messages.
The <span class="emphasis"><em>priority</em></span> MongoDB document field is populated from the <code class="literal">IntegrationMessageHeaderAccessor.PRIORITY</code> (<code class="literal">priority</code>) message header.</p>
<p>In addition, all MongoDB <code class="literal">MessageStore</code> s now have a <code class="literal">sequence</code> field for MessageGroup documents.
The <code class="literal">sequence</code> value is the result of an <code class="literal">$inc</code> operation for a simple <code class="literal">sequence</code> document from the same collection, which is created on demand.
The <code class="literal">sequence</code> field is used in <code class="literal">poll</code> operations to provide first-in-first-out (FIFO) message order (within priority if configured) when messages are stored within the same millisecond.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>It is not recommended to use the same <code class="literal">MongoDbChannelMessageStore</code> bean for priority and non-priority, because the <code class="literal">priorityEnabled</code> option applies to the entire store.
However, the same <code class="literal">collection</code> can be used for both <code class="literal">MongoDbChannelMessageStore</code> types, because message polling from the store is sorted and uses indexes.
To configure that scenario, simply extend one message store bean from the other:</p>
</td></tr></table></div>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"channelStore"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.mongodb.store.MongoDbChannelMessageStore"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">name</span>=<span class="hl-value">"mongoDbFactory"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"mongoDbFactory"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"queueChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:queue</span> <span class="hl-attribute">message-store</span>=<span class="hl-value">"store"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:channel&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"priorityStore"</span> <span class="hl-attribute">parent</span>=<span class="hl-value">"channelStore"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"priorityEnabled"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"priorityChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:priority-queue</span> <span class="hl-attribute">message-store</span>=<span class="hl-value">"priorityStore"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:channel&gt;</span></pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="mongodb-metadata-store" href="#mongodb-metadata-store"></a>22.3.2&nbsp;MongoDB Metadata Store</h3></div></div></div>

<p>As of <span class="emphasis"><em>Spring Integration 4.2</em></span>, a new MongoDB-based <code class="literal">MetadataStore</code> (<a class="xref" href="system-management-chapter.html#metadata-store" title="9.5&nbsp;Metadata Store">Section&nbsp;9.5, &#8220;Metadata Store&#8221;</a>) implementation is available.
The <code class="literal">MongoDbMetadataStore</code> can be used to maintain metadata state across application restarts.
This new <code class="literal">MetadataStore</code> implementation can be used with adapters such as:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="xref" href="twitter.html#twitter-inbound" title="32.4&nbsp;Twitter Inbound Adapters">Section&nbsp;32.4, &#8220;Twitter Inbound Adapters&#8221;</a>
</li><li class="listitem">
<a class="xref" href="feed.html#feed-inbound-channel-adapter" title="13.2&nbsp;Feed Inbound Channel Adapter">Section&nbsp;13.2, &#8220;Feed Inbound Channel Adapter&#8221;</a>
</li><li class="listitem">
<a class="xref" href="files.html#file-reading" title="14.2&nbsp;Reading Files">Section&nbsp;14.2, &#8220;Reading Files&#8221;</a>
</li><li class="listitem">
<a class="xref" href="ftp.html#ftp-inbound" title="15.4&nbsp;FTP Inbound Channel Adapter">Section&nbsp;15.4, &#8220;FTP Inbound Channel Adapter&#8221;</a>
</li><li class="listitem">
<a class="xref" href="sftp.html#sftp-inbound" title="27.7&nbsp;SFTP Inbound Channel Adapter">Section&nbsp;27.7, &#8220;SFTP Inbound Channel Adapter&#8221;</a>
</li></ul></div>
<p>In order to instruct these adapters to use the new <code class="literal">MongoDbMetadataStore</code>, simply declare a Spring bean using the
bean name <span class="strong"><strong>metadataStore</strong></span>. The <span class="emphasis"><em>Twitter Inbound Channel Adapter</em></span> and the <span class="emphasis"><em>Feed Inbound Channel Adapter</em></span> will both
automatically pick up and use the declared <code class="literal">MongoDbMetadataStore</code>:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> MetadataStore metadataStore(MongoDbFactory factory) {
    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> MongoDbMetadataStore(factory, <span class="hl-string">"integrationMetadataStore"</span>);
}</pre>
<p>The <code class="literal">MongoDbMetadataStore</code> also implements <code class="literal">ConcurrentMetadataStore</code>, allowing it to be reliably shared across multiple
application instances where only one instance will be allowed to store or modify a key&#8217;s value.
All these operations are <span class="emphasis"><em>atomic</em></span> via MongoDB guarantees. For this purpose the <code class="literal">putIfAbsent</code> operation is implemented
as a <span class="emphasis"><em>stored</em></span> JavaScript function. Fom more information see
<a class="ulink" href="http://docs.spring.io/spring-data/data-mongo/docs/current/reference/html/#mongo.server-side-scripts" target="_top">Script Operations</a>
and <code class="literal">MongoDbMetadataStore</code> JavaDocs.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="mongodb-inbound-channel-adapter" href="#mongodb-inbound-channel-adapter"></a>22.4&nbsp;MongoDB Inbound Channel Adapter</h2></div></div></div>

<p>The <span class="emphasis"><em>MongoDb Inbound Channel Adapter</em></span> is a polling consumer that reads data from MongoDb and sends it as a Message payload.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-mongodb:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"mongoInboundAdapter"</span>
       <span class="hl-attribute">channel</span>=<span class="hl-value">"replyChannel"</span>
       <span class="hl-attribute">query</span>=<span class="hl-value">"{'name' : 'Bob'}"</span>
       <span class="hl-attribute">entity-class</span>=<span class="hl-value">"java.lang.Object"</span>
       <span class="hl-attribute">auto-startup</span>=<span class="hl-value">"false"</span><span class="hl-tag">&gt;</span>
		<span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"100"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-mongodb:inbound-channel-adapter&gt;</span></pre>
<p>As you can see from the configuration above, you configure a <span class="emphasis"><em>MongoDb Inbound Channel Adapter</em></span> using the <code class="literal">inbound-channel-adapter</code> element, providing values for various attributes such as:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">query</code> - a JSON query (see <a class="ulink" href="http://www.mongodb.org/display/DOCS/Querying" target="_top">MongoDb Querying</a>)
</li><li class="listitem">
<code class="literal">query-expression</code> - A SpEL expression that is evaluated to a JSON query String (as the <code class="literal">query</code> attribute above), or to an instance of <code class="literal">o.s.data.mongodb.core.query.Query</code>. Mutually exclusive with <code class="literal">query</code> attribute.
</li><li class="listitem">
<code class="literal">entity-class</code> - the type of the payload object; if not supplied, a <code class="literal">com.mongodb.DBObject</code> will be returned.
</li><li class="listitem">
<code class="literal">collection-name</code> or <code class="literal">collection-name-expression</code> - Identifies the name of the MongoDb collection to use.
</li><li class="listitem">
<code class="literal">mongodb-factory</code> - reference to an instance of <code class="literal">o.s.data.mongodb.MongoDbFactory</code>
</li><li class="listitem">
<p class="simpara"><code class="literal">mongo-template</code> - reference to an instance of <code class="literal">o.s.data.mongodb.core.MongoTemplate</code></p>
<pre class="literallayout">and other attributes that are common across all other inbound adapters (e.g., 'channel').</pre>
</li></ul></div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>You cannot set both <code class="literal">mongo-template</code> and <code class="literal">mongodb-factory</code>.</p>
</td></tr></table></div>
<p>The example above is relatively simple and static since it has a literal value for the <code class="literal">query</code> and uses the default name for a <code class="literal">collection</code>.
Sometimes you may need to change those values at runtime, based on some condition.
To do that, simply use their <code class="literal">-expression</code> equivalents (<code class="literal">query-expression</code> and <code class="literal">collection-name-expression</code>) where the provided expression can be any valid SpEL expression.</p>
<p>Also, you may wish to do some post-processing to the successfully processed data that was read from the MongoDb.
For example; you may want to move or remove a document after its been processed.
You can do this using Transaction Synchronization feature that was added with Spring Integration 2.2.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-mongodb:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"mongoInboundAdapter"</span>
    <span class="hl-attribute">channel</span>=<span class="hl-value">"replyChannel"</span>
    <span class="hl-attribute">query-expression</span>=<span class="hl-value">"new BasicQuery('{''name'' : ''Bob''}').limit(100)"</span>
    <span class="hl-attribute">entity-class</span>=<span class="hl-value">"java.lang.Object"</span>
    <span class="hl-attribute">auto-startup</span>=<span class="hl-value">"false"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"200"</span> <span class="hl-attribute">max-messages-per-poll</span>=<span class="hl-value">"1"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;int:transactional</span> <span class="hl-attribute">synchronization-factory</span>=<span class="hl-value">"syncFactory"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/int:poller&gt;</span>
<span class="hl-tag">&lt;/int-mongodb:inbound-channel-adapter&gt;</span>

<span class="hl-tag">&lt;int:transaction-synchronization-factory</span> <span class="hl-attribute">id</span>=<span class="hl-value">"syncFactory"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:after-commit</span>
        <span class="hl-attribute">expression</span>=<span class="hl-value">"@documentCleaner.remove(#mongoTemplate, payload, headers.mongo_collectionName)"</span>
        <span class="hl-attribute">channe</span>=<span class="hl-value">"someChannel"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:transaction-synchronization-factory&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"documentCleaner"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"foo.bar.DocumentCleaner"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"transactionManager"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.transaction.PseudoTransactionManager"</span><span class="hl-tag">/&gt;</span></pre>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> DocumentCleaner {
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> remove(MongoOperations mongoOperations, Object target, String collectionName) {
        <span class="hl-keyword">if</span> (target <span class="hl-keyword">instanceof</span> List&lt;?&gt;){
            List&lt;?&gt; documents = (List&lt;?&gt;) target;
            <span class="hl-keyword">for</span> (Object document : documents) {
                mongoOperations.remove(<span class="hl-keyword">new</span> BasicQuery(JSON.serialize(document)), collectionName);
            }
        }
    }
}</pre>
<p>As you can see from the above, all you need to do is declare your poller to be transactional with a <code class="literal">transactional</code> element.
This element can reference a real transaction manager (for example if some other part of your flow invokes JDBC).
If you don&#8217;t have a <span class="emphasis"><em>real</em></span> transaction, you can use a <code class="literal">org.springframework.integration.transaction.PseudoTransactionManager</code> which is an implementation of Spring&#8217;s <code class="literal">PlatformTransactionManager</code> and enables the use of the transaction synchronization features of the mongo adapter when there is no actual transaction.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>This does NOT make MongoDB itself transactional, it simply allows the synchronization of actions to be taken before/after success (commit) or after failure (rollback).</p>
</td></tr></table></div>
<p>Once your poller is transactional all you need to do is set an instance of the <code class="literal">o.s.i.transaction.TransactionSynchronizationFactory</code> on the <code class="literal">transactional</code> element.
<code class="literal">TransactionSynchronizationFactory</code> will create an instance of the <code class="literal">TransactionSynchronization</code>.
For your convenience, we&#8217;ve exposed a default SpEL-based <code class="literal">TransactionSynchronizationFactory</code> which allows you to configure SpEL expressions, with their execution being coordinated (synchronized) with a transaction.
Expressions for before-commit, after-commit, and after-rollback are supported, together with a channel for each where the evaluation result (if any) will be sent.
For each sub-element you can specify <code class="literal">expression</code> and/or <code class="literal">channel</code> attributes.
If only the <code class="literal">channel</code> attribute is present the received Message will be sent there as part of the particular synchronization scenario.
If only the <code class="literal">expression</code> attribute is present and the result of an expression is a non-Null value, a Message with the result as the payload will be generated and sent to a default channel (NullChannel) and will appear in the logs (DEBUG).
If you want the evaluation result to go to a specific channel add a <code class="literal">channel</code> attribute.
If the result of an expression is null or void, no Message will be generated.</p>
<p>For more information about transaction synchronization, see <a class="xref" href="transactions.html#transaction-synchronization" title="C.3&nbsp;Transaction Synchronization">Section&nbsp;C.3, &#8220;Transaction Synchronization&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="mongodb-outbound-channel-adapter" href="#mongodb-outbound-channel-adapter"></a>22.5&nbsp;MongoDB Outbound Channel Adapter</h2></div></div></div>

<p>The <span class="emphasis"><em>MongoDb Outbound Channel Adapter</em></span> allows you to write the Message payload to a MongoDb document store</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-mongodb:outbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"fullConfigWithCollectionExpression"</span>
	<span class="hl-attribute">collection-name</span>=<span class="hl-value">"myCollection"</span>
	<span class="hl-attribute">mongo-converter</span>=<span class="hl-value">"mongoConverter"</span>
	<span class="hl-attribute">mongodb-factory</span>=<span class="hl-value">"mongoDbFactory"</span><span class="hl-tag"> /&gt;</span></pre>
<p>As you can see from the configuration above, you configure a <span class="emphasis"><em>MongoDb Outbound Channel Adapter</em></span> using the <code class="literal">outbound-channel-adapter</code> element, providing values for various attributes such as:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">collection-name</code> or <code class="literal">collection-name-expression</code> - Identifies the name of the MongoDb collection to use.
</li><li class="listitem">
<code class="literal">mongo-converter</code> - reference to an instance of <code class="literal">o.s.data.mongodb.core.convert.MongoConverter</code> to assist with converting a raw java object to a JSON document representation
</li><li class="listitem">
<code class="literal">mongodb-factory</code> - reference to an instance of <code class="literal">o.s.data.mongodb.MongoDbFactory</code>
</li><li class="listitem">
<code class="literal">mongo-template</code> - reference to an instance of <code class="literal">o.s.data.mongodb.core.MongoTemplate</code> (NOTE: you can not have both mongo-template and mongodb-factory set)
</li></ul></div>
<p>and other attributes that are common across all other inbound adapters (e.g., <span class="emphasis"><em>channel</em></span>).</p>
<p>The example above is relatively simple and static since it has a literal value for the <code class="literal">collection-name</code>.
Sometimes you may need to change this value at runtime based on some condition.
To do that, simply use <code class="literal">collection-name-expression</code> where the provided expression can be any valid SpEL expression.</p>
</div>
</div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="mail.html">Prev</a>&nbsp;</td><td width="20%" align="center"><a accesskey="u" href="spring-integration-endpoints.html">Up</a></td><td width="40%" align="right">&nbsp;<a accesskey="n" href="mqtt.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">21.&nbsp;Mail Support&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top">&nbsp;23.&nbsp;MQTT Support</td></tr></table></div></body></html>