<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>Spring Integration Reference Manual</title><link rel="stylesheet" type="text/css" href="css/manual-singlepage.css"><meta name="generator" content="DocBook XSL Stylesheets V1.78.1"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div lang="en" class="book"><div class="titlepage"><div><div><h1 class="title"><a name="d5e1"></a>Spring Integration Reference Manual</h1></div><div><div class="authorgroup"><h2>Authors</h2>
      <span class="author"><span class="firstname">Mark</span> <span class="surname">Fisher</span></span>, <span class="author"><span class="firstname">Marius</span> <span class="surname">Bogoevici</span></span>, <span class="author"><span class="firstname">Iwein</span> <span class="surname">Fuld</span></span>, <span class="author"><span class="firstname">Jonas</span> <span class="surname">Partner</span></span>, <span class="author"><span class="firstname">Oleg</span> <span class="surname">Zhurakousky</span></span>, <span class="author"><span class="firstname">Gary</span> <span class="surname">Russell</span></span>, <span class="author"><span class="firstname">Dave</span> <span class="surname">Syer</span></span>, <span class="author"><span class="firstname">Josh</span> <span class="surname">Long</span></span>, <span class="author"><span class="firstname">David</span> <span class="surname">Turanski</span></span>, <span class="author"><span class="firstname">Gunnar</span> <span class="surname">Hillert</span></span>, <span class="author"><span class="firstname">Artem</span> <span class="surname">Bilan</span></span>, <span class="author"><span class="firstname">Amol</span> <span class="surname">Nayak</span></span>
    </div></div><div><p class="releaseinfo">4.3.17.RELEASE</p></div><div><p class="copyright">Copyright &copy; 2009, 2010, 2011, 2012, 2013, 2014, 2015, 2016, 2017 
          Pivotal Software, Inc. All Rights Reserved.
      </p></div><div><div class="legalnotice"><a name="d5e55" href="#d5e55"></a>
	<p>
		Copies of this document may be made for your own use and for distribution to
		others, provided that you do not charge any fee for such copies and further
		provided that each copy contains this Copyright Notice, whether distributed in
		print or electronically.
	</p>
</div></div></div><hr></div><div class="toc"><p><b>Table of Contents</b></p><dl class="toc"><dt><span class="part"><a href="#preface">I. Preface</a></span></dt><dd><dl><dt><span class="preface"><a href="#system-requirements">Requirements</a></span></dt><dd><dl><dt><span class="section"><a href="#supported-java-versions">1. Compatible Java Versions</a></span></dt><dt><span class="section"><a href="#supported-spring-versions">2. Compatible Versions of the Spring Framework</a></span></dt><dt><span class="section"><a href="#code-conventions">3. Code Conventions</a></span></dt></dl></dd><dt><span class="chapter"><a href="#_conventions_in_this_book">1. Conventions in this Book</a></span></dt></dl></dd><dt><span class="part"><a href="#whats-new-part">II. What&#8217;s new?</a></span></dt><dd><dl><dt><span class="chapter"><a href="#whats-new">2. What&#8217;s new in Spring Integration 4.3?</a></span></dt><dd><dl><dt><span class="section"><a href="#x4.3-new-components">2.1. New Components</a></span></dt><dd><dl><dt><span class="section"><a href="#_amqp_async_outbound_gateway">2.1.1. AMQP Async Outbound Gateway</a></span></dt><dt><span class="section"><a href="#_messagegroupfactory">2.1.2. MessageGroupFactory</a></span></dt><dt><span class="section"><a href="#_persistentmessagegroup">2.1.3. PersistentMessageGroup</a></span></dt><dt><span class="section"><a href="#_ftp_sftp_streaming_inbound_channel_adapters">2.1.4. FTP/SFTP Streaming Inbound Channel Adapters</a></span></dt><dt><span class="section"><a href="#_stream_transformer">2.1.5. Stream Transformer</a></span></dt><dt><span class="section"><a href="#_integration_graph">2.1.6. Integration Graph</a></span></dt><dt><span class="section"><a href="#_jdbc_lock_registry">2.1.7. JDBC Lock Registry</a></span></dt><dt><span class="section"><a href="#_leader_initiator_for_lock_registry">2.1.8. Leader Initiator for Lock Registry</a></span></dt></dl></dd><dt><span class="section"><a href="#x4.3-general">2.2. General Changes</a></span></dt><dd><dl><dt><span class="section"><a href="#_core_changes">2.2.1. Core Changes</a></span></dt><dd><dl><dt><span class="section"><a href="#_outbound_gateway_within_chain">Outbound Gateway within Chain</a></span></dt><dt><span class="section"><a href="#_async_service_activator">Async Service Activator</a></span></dt><dt><span class="section"><a href="#_messaging_annotation_support_changes">Messaging Annotation Support changes</a></span></dt><dt><span class="section"><a href="#_lifecycle_role_controller">Lifecycle Role Controller</a></span></dt></dl></dd><dt><span class="section"><a href="#_mail_changes">2.2.2. Mail Changes</a></span></dt><dd><dl><dt><span class="section"><a href="#_customizable_user_flag">Customizable User Flag</a></span></dt><dt><span class="section"><a href="#_mail_message_mapping">Mail Message Mapping</a></span></dt></dl></dd><dt><span class="section"><a href="#_jms_changes">2.2.3. JMS Changes</a></span></dt><dd><dl><dt><span class="section"><a href="#_header_mapper">Header Mapper</a></span></dt><dt><span class="section"><a href="#_async_gateway">Async Gateway</a></span></dt></dl></dd><dt><span class="section"><a href="#_aggregator_changes">2.2.4. Aggregator Changes</a></span></dt><dt><span class="section"><a href="#_tcp_udp_changes">2.2.5. TCP/UDP Changes</a></span></dt><dd><dl><dt><span class="section"><a href="#_events">Events</a></span></dt><dt><span class="section"><a href="#_stream_deserializers">Stream Deserializers</a></span></dt><dt><span class="section"><a href="#_tcp_message_mapper">TCP Message Mapper</a></span></dt></dl></dd><dt><span class="section"><a href="#_file_changes">2.2.6. File Changes</a></span></dt><dd><dl><dt><span class="section"><a href="#_destination_directory_creation">Destination Directory Creation</a></span></dt><dt><span class="section"><a href="#_buffer_size">Buffer Size</a></span></dt><dt><span class="section"><a href="#_appending_and_flushing">Appending and Flushing</a></span></dt><dt><span class="section"><a href="#_preserving_timestamps">Preserving Timestamps</a></span></dt><dt><span class="section"><a href="#_splitter_changes">Splitter Changes</a></span></dt><dt><span class="section"><a href="#_file_filters">File Filters</a></span></dt></dl></dd><dt><span class="section"><a href="#_amqp_changes">2.2.7. AMQP Changes</a></span></dt><dd><dl><dt><span class="section"><a href="#_content_type_message_converter">Content Type Message Converter</a></span></dt><dt><span class="section"><a href="#_headers_for_delayed_message_handling">Headers for Delayed Message Handling</a></span></dt><dt><span class="section"><a href="#_amqp_backed_channels">AMQP-Backed Channels</a></span></dt></dl></dd><dt><span class="section"><a href="#_redis_changes">2.2.8. Redis Changes</a></span></dt><dd><dl><dt><span class="section"><a href="#_list_push_pop_direction">List Push/Pop Direction</a></span></dt><dt><span class="section"><a href="#_queue_inbound_gateway_default_serializer">Queue Inbound Gateway Default Serializer</a></span></dt></dl></dd><dt><span class="section"><a href="#_http_changes">2.2.9. HTTP Changes</a></span></dt><dt><span class="section"><a href="#_sftp_changes">2.2.10. SFTP Changes</a></span></dt><dd><dl><dt><span class="section"><a href="#_factory_bean">Factory Bean</a></span></dt><dt><span class="section"><a href="#_inbound_channel_adapter">Inbound Channel Adapter</a></span></dt><dt><span class="section"><a href="#_chmod">chmod</a></span></dt></dl></dd><dt><span class="section"><a href="#_ftp_changes">2.2.11. FTP Changes</a></span></dt><dd><dl><dt><span class="section"><a href="#_session_changes">Session Changes</a></span></dt><dt><span class="section"><a href="#_inbound_channel_adapter_2">Inbound Channel Adapter</a></span></dt></dl></dd><dt><span class="section"><a href="#_router_changes">2.2.12. Router Changes</a></span></dt><dt><span class="section"><a href="#_header_mapping">2.2.13. Header Mapping</a></span></dt><dd><dl><dt><span class="section"><a href="#_general">General</a></span></dt><dt><span class="section"><a href="#_amqp_header_mapping">AMQP Header Mapping</a></span></dt></dl></dd><dt><span class="section"><a href="#_groovy_scripts">2.2.14. Groovy Scripts</a></span></dt><dt><span class="section"><a href="#__inboundchanneladapter">2.2.15. @InboundChannelAdapter</a></span></dt><dt><span class="section"><a href="#_xmpp_changes">2.2.16. XMPP changes</a></span></dt><dt><span class="section"><a href="#_wiretap_late_binding">2.2.17. WireTap Late Binding</a></span></dt><dt><span class="section"><a href="#_channelmessagestorequeryprovider">2.2.18. ChannelMessageStoreQueryProvider</a></span></dt><dt><span class="section"><a href="#_websocket_changes">2.2.19. WebSocket Changes</a></span></dt><dt><span class="section"><a href="#_barrier_changes">2.2.20. Barrier Changes</a></span></dt><dt><span class="section"><a href="#_amqp_changes_2">2.2.21. AMQP Changes</a></span></dt></dl></dd></dl></dd></dl></dd><dt><span class="part"><a href="#spring-integration-introduction">III. Overview of Spring Integration Framework</a></span></dt><dd><dl><dt><span class="chapter"><a href="#overview">3. Spring Integration Overview</a></span></dt><dd><dl><dt><span class="section"><a href="#overview-background">3.1. Background</a></span></dt><dt><span class="section"><a href="#overview-goalsandprinciples">3.2. Goals and Principles</a></span></dt><dt><span class="section"><a href="#overview-components">3.3. Main Components</a></span></dt><dd><dl><dt><span class="section"><a href="#overview-components-message">3.3.1. Message</a></span></dt><dt><span class="section"><a href="#overview-components-channel">3.3.2. Message Channel</a></span></dt><dt><span class="section"><a href="#overview-components-endpoint">3.3.3. Message Endpoint</a></span></dt></dl></dd><dt><span class="section"><a href="#overview-endpoints">3.4. Message Endpoints</a></span></dt><dd><dl><dt><span class="section"><a href="#overview-endpoints-transformer">3.4.1. Transformer</a></span></dt><dt><span class="section"><a href="#overview-endpoints-filter">3.4.2. Filter</a></span></dt><dt><span class="section"><a href="#overview-endpoints-router">3.4.3. Router</a></span></dt><dt><span class="section"><a href="#overview-endpoints-splitter">3.4.4. Splitter</a></span></dt><dt><span class="section"><a href="#overview-endpoints-aggregator">3.4.5. Aggregator</a></span></dt><dt><span class="section"><a href="#overview-endpoints-service-activator">3.4.6. Service Activator</a></span></dt><dt><span class="section"><a href="#overview-endpoints-channeladapter">3.4.7. Channel Adapter</a></span></dt></dl></dd><dt><span class="section"><a href="#configuration-enable-integration">3.5. Configuration and @EnableIntegration</a></span></dt><dt><span class="section"><a href="#programming-considerations">3.6. Programming Considerations</a></span></dt><dt><span class="section"><a href="#shaded">3.7. Considerations When using Packaged (e.g. Shaded) Jars</a></span></dt><dt><span class="section"><a href="#programming-tips">3.8. Programming Tips and Tricks</a></span></dt></dl></dd></dl></dd><dt><span class="part"><a href="#spring-integration-core-messaging">IV. Core Messaging</a></span></dt><dd><dl><dt><span class="chapter"><a href="#messaging-channels-section">4. Messaging Channels</a></span></dt><dd><dl><dt><span class="section"><a href="#channel">4.1. Message Channels</a></span></dt><dd><dl><dt><span class="section"><a href="#channel-interfaces">4.1.1. The MessageChannel Interface</a></span></dt><dd><dl><dt><span class="section"><a href="#channel-interfaces-pollablechannel">PollableChannel</a></span></dt><dt><span class="section"><a href="#channel-interfaces-subscribablechannel">SubscribableChannel</a></span></dt></dl></dd><dt><span class="section"><a href="#channel-implementations">4.1.2. Message Channel Implementations</a></span></dt><dd><dl><dt><span class="section"><a href="#channel-implementations-publishsubscribechannel">PublishSubscribeChannel</a></span></dt><dt><span class="section"><a href="#channel-implementations-queuechannel">QueueChannel</a></span></dt><dt><span class="section"><a href="#channel-implementations-prioritychannel">PriorityChannel</a></span></dt><dt><span class="section"><a href="#channel-implementations-rendezvouschannel">RendezvousChannel</a></span></dt><dt><span class="section"><a href="#channel-implementations-directchannel">DirectChannel</a></span></dt><dt><span class="section"><a href="#executor-channel">ExecutorChannel</a></span></dt><dt><span class="section"><a href="#channel-implementations-threadlocalchannel">Scoped Channel</a></span></dt></dl></dd><dt><span class="section"><a href="#channel-interceptors">4.1.3. Channel Interceptors</a></span></dt><dt><span class="section"><a href="#channel-template">4.1.4. MessagingTemplate</a></span></dt><dt><span class="section"><a href="#channel-configuration">4.1.5. Configuring Message Channels</a></span></dt><dd><dl><dt><span class="section"><a href="#channel-configuration-directchannel">DirectChannel Configuration</a></span></dt><dt><span class="section"><a href="#channel-datatype-channel">Datatype Channel Configuration</a></span></dt><dt><span class="section"><a href="#channel-configuration-queuechannel">QueueChannel Configuration</a></span></dt><dt><span class="section"><a href="#channel-configuration-pubsubchannel">PublishSubscribeChannel Configuration</a></span></dt><dt><span class="section"><a href="#channel-configuration-executorchannel">ExecutorChannel</a></span></dt><dt><span class="section"><a href="#channel-configuration-prioritychannel">PriorityChannel Configuration</a></span></dt><dt><span class="section"><a href="#channel-configuration-rendezvouschannel">RendezvousChannel Configuration</a></span></dt><dt><span class="section"><a href="#channel-configuration-threadlocalchannel">Scoped Channel Configuration</a></span></dt><dt><span class="section"><a href="#channel-configuration-interceptors">Channel Interceptor Configuration</a></span></dt><dt><span class="section"><a href="#global-channel-configuration-interceptors">Global Channel Interceptor Configuration</a></span></dt><dt><span class="section"><a href="#channel-wiretap">Wire Tap</a></span></dt><dt><span class="section"><a href="#conditional-wiretap">Conditional Wire Taps</a></span></dt><dt><span class="section"><a href="#channel-global-wiretap">Global Wire Tap Configuration</a></span></dt></dl></dd><dt><span class="section"><a href="#channel-special-channels">4.1.6. Special Channels</a></span></dt></dl></dd><dt><span class="section"><a href="#polling-consumer">4.2. Poller</a></span></dt><dd><dl><dt><span class="section"><a href="#_polling_consumer">4.2.1. Polling Consumer</a></span></dt><dt><span class="section"><a href="#_pollable_message_source">4.2.2. Pollable Message Source</a></span></dt><dt><span class="section"><a href="#conditional-pollers">4.2.3. Conditional Pollers for Message Sources</a></span></dt><dd><dl><dt><span class="section"><a href="#_background">Background</a></span></dt><dt><span class="section"><a href="#__smart_polling">"Smart" Polling</a></span></dt><dt><span class="section"><a href="#_simpleactiveidlemessagesourceadvice">SimpleActiveIdleMessageSourceAdvice</a></span></dt><dt><span class="section"><a href="#_compoundtriggeradvice">CompoundTriggerAdvice</a></span></dt></dl></dd></dl></dd><dt><span class="section"><a href="#channel-adapter">4.3. Channel Adapter</a></span></dt><dd><dl><dt><span class="section"><a href="#channel-adapter-namespace-inbound">4.3.1. Configuring An Inbound Channel Adapter</a></span></dt><dt><span class="section"><a href="#channel-adapter-namespace-outbound">4.3.2. Configuring An Outbound Channel Adapter</a></span></dt><dt><span class="section"><a href="#channel-adapter-expressions-and-scripts">4.3.3. Channel Adapter Expressions and Scripts</a></span></dt></dl></dd><dt><span class="section"><a href="#bridge">4.4. Messaging Bridge</a></span></dt><dd><dl><dt><span class="section"><a href="#bridge-introduction">4.4.1. Introduction</a></span></dt><dt><span class="section"><a href="#bridge-namespace">4.4.2. Configuring Bridge</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#messaging-construction-chapter">5. Message Construction</a></span></dt><dd><dl><dt><span class="section"><a href="#message">5.1. Message</a></span></dt><dd><dl><dt><span class="section"><a href="#message-interface">5.1.1. The Message Interface</a></span></dt><dt><span class="section"><a href="#message-headers">5.1.2. Message Headers</a></span></dt><dd><dl><dt><span class="section"><a href="#message-header-accessor">MessageHeaderAccessor API</a></span></dt><dt><span class="section"><a href="#message-id-generation">Message ID Generation</a></span></dt><dt><span class="section"><a href="#read-only-headers">Read-only Headers</a></span></dt><dt><span class="section"><a href="#header-propagation">Header Propagation</a></span></dt></dl></dd><dt><span class="section"><a href="#message-implementations">5.1.3. Message Implementations</a></span></dt><dt><span class="section"><a href="#message-builder">5.1.4. The MessageBuilder Helper Class</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#messaging-routing-chapter">6. Message Routing</a></span></dt><dd><dl><dt><span class="section"><a href="#router">6.1. Routers</a></span></dt><dd><dl><dt><span class="section"><a href="#router-overview">6.1.1. Overview</a></span></dt><dt><span class="section"><a href="#router-common-parameters">6.1.2. Common Router Parameters</a></span></dt><dd><dl><dt><span class="section"><a href="#router-common-parameters-all">Inside and Outside of a Chain</a></span></dt><dt><span class="section"><a href="#router-common-parameters-top">Top-Level (Outside of a Chain)</a></span></dt></dl></dd><dt><span class="section"><a href="#router-implementations">6.1.3. Router Implementations</a></span></dt><dd><dl><dt><span class="section"><a href="#router-implementations-payloadtyperouter">PayloadTypeRouter</a></span></dt><dt><span class="section"><a href="#router-implementations-headervaluerouter">HeaderValueRouter</a></span></dt><dt><span class="section"><a href="#router-implementations-recipientlistrouter">RecipientListRouter</a></span></dt><dt><span class="section"><a href="#recipient-list-router-management">RecipientListRouterManagement</a></span></dt><dt><span class="section"><a href="#router-implementations-xpath-router">XPath Router</a></span></dt><dt><span class="section"><a href="#router-implementations-exception-router">Routing and Error handling</a></span></dt></dl></dd><dt><span class="section"><a href="#router-namespace">6.1.4. Configuring (Generic) Router</a></span></dt><dd><dl><dt><span class="section"><a href="#_configuring_a_content_based_router_with_xml">Configuring a Content Based Router with XML</a></span></dt><dt><span class="section"><a href="#router-annotation">Configuring a Router with Annotations</a></span></dt></dl></dd><dt><span class="section"><a href="#dynamic-routers">6.1.5. Dynamic Routers</a></span></dt><dd><dl><dt><span class="section"><a href="#dynamic-routers-control-bus">Manage Router Mappings using the Control Bus</a></span></dt><dt><span class="section"><a href="#dynamic-routers-jmx">Manage Router Mappings using JMX</a></span></dt><dt><span class="section"><a href="#routing-slip">Routing Slip</a></span></dt><dt><span class="section"><a href="#process-manager">Process Manager Enterprise Integration Pattern</a></span></dt></dl></dd></dl></dd><dt><span class="section"><a href="#filter">6.2. Filter</a></span></dt><dd><dl><dt><span class="section"><a href="#filter-introduction">6.2.1. Introduction</a></span></dt><dt><span class="section"><a href="#filter-config">6.2.2. Configuring Filter</a></span></dt><dd><dl><dt><span class="section"><a href="#filter-xml">Configuring a Filter with XML</a></span></dt><dt><span class="section"><a href="#filter-annotations">Configuring a Filter with Annotations</a></span></dt></dl></dd></dl></dd><dt><span class="section"><a href="#splitter">6.3. Splitter</a></span></dt><dd><dl><dt><span class="section"><a href="#splitter-annotation">6.3.1. Introduction</a></span></dt><dt><span class="section"><a href="#_programming_model">6.3.2. Programming model</a></span></dt><dt><span class="section"><a href="#splitter-config">6.3.3. Configuring Splitter</a></span></dt><dd><dl><dt><span class="section"><a href="#_configuring_a_splitter_using_xml">Configuring a Splitter using XML</a></span></dt><dt><span class="section"><a href="#_configuring_a_splitter_with_annotations">Configuring a Splitter with Annotations</a></span></dt></dl></dd></dl></dd><dt><span class="section"><a href="#aggregator">6.4. Aggregator</a></span></dt><dd><dl><dt><span class="section"><a href="#aggregator-introduction">6.4.1. Introduction</a></span></dt><dt><span class="section"><a href="#aggregator-functionality">6.4.2. Functionality</a></span></dt><dt><span class="section"><a href="#aggregator-api">6.4.3. Programming model</a></span></dt><dd><dl><dt><span class="section"><a href="#_aggregatingmessagehandler">AggregatingMessageHandler</a></span></dt><dt><span class="section"><a href="#_releasestrategy">ReleaseStrategy</a></span></dt><dt><span class="section"><a href="#_aggregating_large_groups">Aggregating Large Groups</a></span></dt><dt><span class="section"><a href="#_correlationstrategy">CorrelationStrategy</a></span></dt><dt><span class="section"><a href="#_lockregistry">LockRegistry</a></span></dt></dl></dd><dt><span class="section"><a href="#aggregator-config">6.4.4. Configuring an Aggregator</a></span></dt><dd><dl><dt><span class="section"><a href="#aggregator-xml">Configuring an Aggregator with XML</a></span></dt><dt><span class="section"><a href="#aggregator-annotations">Configuring an Aggregator with Annotations</a></span></dt></dl></dd><dt><span class="section"><a href="#reaper">6.4.5. Managing State in an Aggregator: MessageGroupStore</a></span></dt></dl></dd><dt><span class="section"><a href="#resequencer">6.5. Resequencer</a></span></dt><dd><dl><dt><span class="section"><a href="#_introduction">6.5.1. Introduction</a></span></dt><dt><span class="section"><a href="#resequencer-functionality">6.5.2. Functionality</a></span></dt><dt><span class="section"><a href="#_configuring_a_resequencer">6.5.3. Configuring a Resequencer</a></span></dt></dl></dd><dt><span class="section"><a href="#chain">6.6. Message Handler Chain</a></span></dt><dd><dl><dt><span class="section"><a href="#chain-introduction">6.6.1. Introduction</a></span></dt><dt><span class="section"><a href="#chain-namespace">6.6.2. Configuring a Chain</a></span></dt></dl></dd><dt><span class="section"><a href="#scatter-gather">6.7. Scatter-Gather</a></span></dt><dd><dl><dt><span class="section"><a href="#scatter-gather-introduction">6.7.1. Introduction</a></span></dt><dt><span class="section"><a href="#scatter-gather-functionality">6.7.2. Functionality</a></span></dt><dt><span class="section"><a href="#scatter-gather-namespace">6.7.3. Configuring a Scatter-Gather Endpoint</a></span></dt></dl></dd><dt><span class="section"><a href="#barrier">6.8. Thread Barrier</a></span></dt></dl></dd><dt><span class="chapter"><a href="#messaging-transformation-chapter">7. Message Transformation</a></span></dt><dd><dl><dt><span class="section"><a href="#transformer">7.1. Transformer</a></span></dt><dd><dl><dt><span class="section"><a href="#transformer-introduction">7.1.1. Introduction</a></span></dt><dt><span class="section"><a href="#transformer-config">7.1.2. Configuring Transformer</a></span></dt><dd><dl><dt><span class="section"><a href="#transformer-namespace">Configuring Transformer with XML</a></span></dt><dt><span class="section"><a href="#_common_transformers">Common Transformers</a></span></dt><dt><span class="section"><a href="#transformer-annotation">Configuring a Transformer with Annotations</a></span></dt></dl></dd><dt><span class="section"><a href="#header-filter">7.1.3. Header Filter</a></span></dt><dt><span class="section"><a href="#_codec_based_transformers">7.1.4. Codec-Based Transformers</a></span></dt></dl></dd><dt><span class="section"><a href="#content-enricher">7.2. Content Enricher</a></span></dt><dd><dl><dt><span class="section"><a href="#content-enricher-introduction">7.2.1. Introduction</a></span></dt><dt><span class="section"><a href="#header-enricher">7.2.2. Header Enricher</a></span></dt><dd><dl><dt><span class="section"><a href="#_configuring_a_header_enricher_with_java_configuration">Configuring a Header Enricher with Java Configuration</a></span></dt><dt><span class="section"><a href="#_configuring_a_header_enricher_with_the_java_dsl">Configuring a Header Enricher with the Java DSL</a></span></dt><dt><span class="section"><a href="#header-channel-registry">Header Channel Registry</a></span></dt></dl></dd><dt><span class="section"><a href="#payload-enricher">7.2.3. Payload Enricher</a></span></dt><dd><dl><dt><span class="section"><a href="#payload-enricher-configuration">Configuration</a></span></dt><dt><span class="section"><a href="#payload-enricher-examples">Examples</a></span></dt></dl></dd></dl></dd><dt><span class="section"><a href="#claim-check">7.3. Claim Check</a></span></dt><dd><dl><dt><span class="section"><a href="#claim-check-introduction">7.3.1. Introduction</a></span></dt><dt><span class="section"><a href="#claim-check-in">7.3.2. Incoming Claim Check Transformer</a></span></dt><dt><span class="section"><a href="#claim-check-out">7.3.3. Outgoing Claim Check Transformer</a></span></dt><dt><span class="section"><a href="#_a_word_on_message_store">7.3.4. A word on Message Store</a></span></dt></dl></dd><dt><span class="section"><a href="#codec">7.4. Codec</a></span></dt><dd><dl><dt><span class="section"><a href="#_introduction_2">7.4.1. Introduction</a></span></dt><dt><span class="section"><a href="#_encodingpayloadtransformer">7.4.2. EncodingPayloadTransformer</a></span></dt><dt><span class="section"><a href="#_decodingtransformer">7.4.3. DecodingTransformer</a></span></dt><dt><span class="section"><a href="#_codecmessageconverter">7.4.4. CodecMessageConverter</a></span></dt><dt><span class="section"><a href="#_kryo">7.4.5. Kryo</a></span></dt><dd><dl><dt><span class="section"><a href="#_customizing_kryo">Customizing Kryo</a></span></dt></dl></dd></dl></dd></dl></dd><dt><span class="chapter"><a href="#messaging-endpoints-chapter">8. Messaging Endpoints</a></span></dt><dd><dl><dt><span class="section"><a href="#endpoint">8.1. Message Endpoints</a></span></dt><dd><dl><dt><span class="section"><a href="#endpoint-handler">8.1.1. Message Handler</a></span></dt><dt><span class="section"><a href="#endpoint-eventdrivenconsumer">8.1.2. Event Driven Consumer</a></span></dt><dt><span class="section"><a href="#endpoint-pollingconsumer">8.1.3. Polling Consumer</a></span></dt><dt><span class="section"><a href="#endpoint-namespace">8.1.4. Namespace Support</a></span></dt><dt><span class="section"><a href="#polling-consumer-change-polling-rate">8.1.5. Change Polling Rate at Runtime</a></span></dt><dt><span class="section"><a href="#payload-type-conversion">8.1.6. Payload Type Conversion</a></span></dt><dt><span class="section"><a href="#async-polling">8.1.7. Asynchronous polling</a></span></dt><dt><span class="section"><a href="#endpoint-inner">8.1.8. Endpoint Inner Beans</a></span></dt></dl></dd><dt><span class="section"><a href="#endpoint-roles">8.2. Endpoint Roles</a></span></dt><dt><span class="section"><a href="#leadership-event-handling">8.3. Leadership Event Handling</a></span></dt><dt><span class="section"><a href="#gateway">8.4. Messaging Gateways</a></span></dt><dd><dl><dt><span class="section"><a href="#gateway-proxy">8.4.1. Enter the GatewayProxyFactoryBean</a></span></dt><dt><span class="section"><a href="#gateway-namespace">8.4.2. Gateway XML Namespace Support</a></span></dt><dt><span class="section"><a href="#gateway-default-reply-channel">8.4.3. Setting the Default Reply Channel</a></span></dt><dt><span class="section"><a href="#gateway-configuration-annotations">8.4.4. Gateway Configuration with Annotations and/or XML</a></span></dt><dt><span class="section"><a href="#gateway-mapping">8.4.5. Mapping Method Arguments to a Message</a></span></dt><dt><span class="section"><a href="#messaging-gateway-annotation">8.4.6. @MessagingGateway Annotation</a></span></dt><dt><span class="section"><a href="#gateway-calling-no-argument-methods">8.4.7. Invoking No-Argument Methods</a></span></dt><dt><span class="section"><a href="#gateway-error-handling">8.4.8. Error Handling</a></span></dt><dt><span class="section"><a href="#async-gateway">8.4.9. Asynchronous Gateway</a></span></dt><dd><dl><dt><span class="section"><a href="#_introduction_3">Introduction</a></span></dt><dt><span class="section"><a href="#_listenablefuture">ListenableFuture</a></span></dt><dt><span class="section"><a href="#_asynctaskexecutor">AsyncTaskExecutor</a></span></dt><dt><span class="section"><a href="#gw-completable-future">CompletableFuture</a></span></dt><dt><span class="section"><a href="#_reactor_promise">Reactor Promise</a></span></dt></dl></dd><dt><span class="section"><a href="#gateway-no-response">8.4.10. Gateway behavior when no response arrives</a></span></dt></dl></dd><dt><span class="section"><a href="#service-activator">8.5. Service Activator</a></span></dt><dd><dl><dt><span class="section"><a href="#service-activator-introduction">8.5.1. Introduction</a></span></dt><dt><span class="section"><a href="#service-activator-namespace">8.5.2. Configuring Service Activator</a></span></dt><dt><span class="section"><a href="#async-service-activator">8.5.3. Asynchronous Service Activator</a></span></dt></dl></dd><dt><span class="section"><a href="#delayer">8.6. Delayer</a></span></dt><dd><dl><dt><span class="section"><a href="#delayer-introduction">8.6.1. Introduction</a></span></dt><dt><span class="section"><a href="#delayer-namespace">8.6.2. Configuring Delayer</a></span></dt><dt><span class="section"><a href="#delayer-message-store">8.6.3. Delayer and Message Store</a></span></dt></dl></dd><dt><span class="section"><a href="#scripting">8.7. Scripting support</a></span></dt><dd><dl><dt><span class="section"><a href="#scripting-config">8.7.1. Script configuration</a></span></dt></dl></dd><dt><span class="section"><a href="#groovy">8.8. Groovy support</a></span></dt><dd><dl><dt><span class="section"><a href="#groovy-config">8.8.1. Groovy configuration</a></span></dt><dt><span class="section"><a href="#groovy-control-bus">8.8.2. Control Bus</a></span></dt></dl></dd><dt><span class="section"><a href="#message-handler-advice-chain">8.9. Adding Behavior to Endpoints</a></span></dt><dd><dl><dt><span class="section"><a href="#mhac-intro">8.9.1. Introduction</a></span></dt><dt><span class="section"><a href="#advice-classes">8.9.2. Provided Advice Classes</a></span></dt><dd><dl><dt><span class="section"><a href="#retry-advice">Retry Advice</a></span></dt><dt><span class="section"><a href="#circuit-breaker-advice">Circuit Breaker Advice</a></span></dt><dt><span class="section"><a href="#expression-advice">Expression Evaluating Advice</a></span></dt></dl></dd><dt><span class="section"><a href="#custom-advice">8.9.3. Custom Advice Classes</a></span></dt><dt><span class="section"><a href="#other-advice">8.9.4. Other Advice Chain Elements</a></span></dt><dt><span class="section"><a href="#handle-message-advice">8.9.5. Handle Message Advice</a></span></dt><dt><span class="section"><a href="#advising-filters">8.9.6. Advising Filters</a></span></dt><dt><span class="section"><a href="#advising-with-annotations">8.9.7. Advising Endpoints Using Annotations</a></span></dt><dt><span class="section"><a href="#advice-order">8.9.8. Ordering Advices within an Advice Chain</a></span></dt><dt><span class="section"><a href="#advised-handler-properties">8.9.9. Advised Handler Properties</a></span></dt><dt><span class="section"><a href="#idempotent-receiver">8.9.10. Idempotent Receiver Enterprise Integration Pattern</a></span></dt></dl></dd><dt><span class="section"><a href="#logging-channel-adapter">8.10. Logging Channel Adapter</a></span></dt><dd><dl><dt><span class="section"><a href="#_configuring_with_java_configuration">8.10.1. Configuring with Java Configuration</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#system-management-chapter">9. System Management</a></span></dt><dd><dl><dt><span class="section"><a href="#metrics-management">9.1. Metrics and Management</a></span></dt><dd><dl><dt><span class="section"><a href="#_configuring_metrics_capture">9.1.1. Configuring Metrics Capture</a></span></dt><dt><span class="section"><a href="#mgmt-channel-features">9.1.2. MessageChannel Metric Features</a></span></dt><dt><span class="section"><a href="#mgmt-handler-features">9.1.3. MessageHandler Metric Features</a></span></dt><dt><span class="section"><a href="#mgmt-statistics">9.1.4. Time-Based Average Estimates</a></span></dt><dt><span class="section"><a href="#mgmt-metrics-factory">9.1.5. Metrics Factory</a></span></dt></dl></dd><dt><span class="section"><a href="#jmx">9.2. JMX Support</a></span></dt><dd><dl><dt><span class="section"><a href="#jmx-notification-listening-channel-adapter">9.2.1. Notification Listening Channel Adapter</a></span></dt><dt><span class="section"><a href="#jmx-notification-publishing-channel-adapter">9.2.2. Notification Publishing Channel Adapter</a></span></dt><dt><span class="section"><a href="#jmx-attribute-polling-channel-adapter">9.2.3. Attribute Polling Channel Adapter</a></span></dt><dt><span class="section"><a href="#tree-polling-channel-adapter">9.2.4. Tree Polling Channel Adapter</a></span></dt><dt><span class="section"><a href="#jmx-operation-invoking-channel-adapter">9.2.5. Operation Invoking Channel Adapter</a></span></dt><dt><span class="section"><a href="#jmx-operation-invoking-outbound-gateway">9.2.6. Operation Invoking Outbound Gateway</a></span></dt><dt><span class="section"><a href="#jmx-mbean-exporter">9.2.7. MBean Exporter</a></span></dt><dd><dl><dt><span class="section"><a href="#jmx-mbean-features">MBean ObjectNames</a></span></dt><dt><span class="section"><a href="#jmx-42-improvements">JMX Improvements</a></span></dt><dt><span class="section"><a href="#jmx-mbean-shutdown">Orderly Shutdown Managed Operation</a></span></dt></dl></dd></dl></dd><dt><span class="section"><a href="#message-history">9.3. Message History</a></span></dt><dd><dl><dt><span class="section"><a href="#message-history-config">9.3.1. Message History Configuration</a></span></dt></dl></dd><dt><span class="section"><a href="#message-store">9.4. Message Store</a></span></dt><dd><dl><dt><span class="section"><a href="#message-group-factory">9.4.1. MessageGroupFactory</a></span></dt><dt><span class="section"><a href="#lazy-load-message-group">9.4.2. Persistence MessageGroupStore and Lazy-Load</a></span></dt></dl></dd><dt><span class="section"><a href="#metadata-store">9.5. Metadata Store</a></span></dt><dd><dl><dt><span class="section"><a href="#idempotent-receiver-pattern">9.5.1. Idempotent Receiver and Metadata Store</a></span></dt><dt><span class="section"><a href="#metadatastore-listener">9.5.2. MetadataStoreListener</a></span></dt></dl></dd><dt><span class="section"><a href="#control-bus">9.6. Control Bus</a></span></dt><dt><span class="section"><a href="#jmx-shutdown">9.7. Orderly Shutdown</a></span></dt><dt><span class="section"><a href="#integration-graph">9.8. Integration Graph</a></span></dt><dd><dl><dt><span class="section"><a href="#_graph_runtime_model">9.8.1. Graph Runtime Model</a></span></dt></dl></dd><dt><span class="section"><a href="#_integration_graph_controller">9.9. Integration Graph Controller</a></span></dt></dl></dd></dl></dd><dt><span class="part"><a href="#spring-integration-endpoints">V. Integration Endpoints</a></span></dt><dd><dl><dt><span class="chapter"><a href="#endpoint-summary">10. Endpoint Quick Reference Table</a></span></dt><dt><span class="chapter"><a href="#amqp">11. AMQP Support</a></span></dt><dd><dl><dt><span class="section"><a href="#amqp-introduction">11.1. Introduction</a></span></dt><dt><span class="section"><a href="#amqp-inbound-channel-adapter">11.2. Inbound Channel Adapter</a></span></dt><dd><dl><dt><span class="section"><a href="#_configuring_with_java_configuration_2">11.2.1. Configuring with Java Configuration</a></span></dt><dt><span class="section"><a href="#_configuring_with_the_java_dsl">11.2.2. Configuring with the Java DSL</a></span></dt></dl></dd><dt><span class="section"><a href="#amqp-inbound-gateway">11.3. Inbound Gateway</a></span></dt><dd><dl><dt><span class="section"><a href="#_configuring_with_java_configuration_3">11.3.1. Configuring with Java Configuration</a></span></dt><dt><span class="section"><a href="#_configuring_with_the_java_dsl_2">11.3.2. Configuring with the Java DSL</a></span></dt></dl></dd><dt><span class="section"><a href="#amqp-inbound-ack">11.4. Inbound Endpoint Acknowledge Mode</a></span></dt><dt><span class="section"><a href="#amqp-outbound-channel-adapter">11.5. Outbound Channel Adapter</a></span></dt><dd><dl><dt><span class="section"><a href="#_configuring_with_java_configuration_4">11.5.1. Configuring with Java Configuration</a></span></dt><dt><span class="section"><a href="#_configuring_with_the_java_dsl_3">11.5.2. Configuring with the Java DSL</a></span></dt></dl></dd><dt><span class="section"><a href="#amqp-outbound-gateway">11.6. Outbound Gateway</a></span></dt><dd><dl><dt><span class="section"><a href="#_configuring_with_java_configuration_5">11.6.1. Configuring with Java Configuration</a></span></dt><dt><span class="section"><a href="#_configuring_with_the_java_dsl_4">11.6.2. Configuring with the Java DSL</a></span></dt></dl></dd><dt><span class="section"><a href="#amqp-async-outbound-gateway">11.7. Async Outbound Gateway</a></span></dt><dd><dl><dt><span class="section"><a href="#_configuring_with_java_configuration_6">11.7.1. Configuring with Java Configuration</a></span></dt><dt><span class="section"><a href="#_configuring_with_the_java_dsl_5">11.7.2. Configuring with the Java DSL</a></span></dt></dl></dd><dt><span class="section"><a href="#content-type-conversion-outbound">11.8. Outbound Message Conversion</a></span></dt><dt><span class="section"><a href="#amqp-user-id">11.9. Outbound User Id</a></span></dt><dt><span class="section"><a href="#amqp-delay">11.10. Delayed Message Exchange</a></span></dt><dt><span class="section"><a href="#amqp-channels">11.11. AMQP Backed Message Channels</a></span></dt><dd><dl><dt><span class="section"><a href="#_configuring_with_java_configuration_7">11.11.1. Configuring with Java Configuration</a></span></dt><dt><span class="section"><a href="#_configuring_with_the_java_dsl_6">11.11.2. Configuring with the Java DSL</a></span></dt></dl></dd><dt><span class="section"><a href="#amqp-message-headers">11.12. AMQP Message Headers</a></span></dt><dt><span class="section"><a href="#_amqp_samples">11.13. AMQP Samples</a></span></dt></dl></dd><dt><span class="chapter"><a href="#applicationevent">12. Spring ApplicationEvent Support</a></span></dt><dd><dl><dt><span class="section"><a href="#appevent-inbound">12.1. Receiving Spring Application Events</a></span></dt><dt><span class="section"><a href="#appevent-outbound">12.2. Sending Spring Application Events</a></span></dt></dl></dd><dt><span class="chapter"><a href="#feed">13. Feed Adapter</a></span></dt><dd><dl><dt><span class="section"><a href="#feed-intro">13.1. Introduction</a></span></dt><dt><span class="section"><a href="#feed-inbound-channel-adapter">13.2. Feed Inbound Channel Adapter</a></span></dt></dl></dd><dt><span class="chapter"><a href="#files">14. File Support</a></span></dt><dd><dl><dt><span class="section"><a href="#file-intro">14.1. Introduction</a></span></dt><dt><span class="section"><a href="#file-reading">14.2. Reading Files</a></span></dt><dd><dl><dt><span class="section"><a href="#file-namespace-support">14.2.1. Namespace Support</a></span></dt><dt><span class="section"><a href="#watch-service-directory-scanner">14.2.2. WatchServiceDirectoryScanner</a></span></dt><dt><span class="section"><a href="#_limiting_memory_consumption">14.2.3. Limiting Memory Consumption</a></span></dt><dt><span class="section"><a href="#_configuring_with_java_configuration_8">14.2.4. Configuring with Java Configuration</a></span></dt><dt><span class="section"><a href="#_configuring_with_the_java_dsl_7">14.2.5. Configuring with the Java DSL</a></span></dt><dt><span class="section"><a href="#file-tailing">14.2.6. 'Tail&#8217;ing Files</a></span></dt></dl></dd><dt><span class="section"><a href="#file-writing">14.3. Writing files</a></span></dt><dd><dl><dt><span class="section"><a href="#file-writing-file-names">14.3.1. Generating File Names</a></span></dt><dt><span class="section"><a href="#file-writing-output-directory">14.3.2. Specifying the Output Directory</a></span></dt><dt><span class="section"><a href="#file-writing-destination-exists">14.3.3. Dealing with Existing Destination Files</a></span></dt><dt><span class="section"><a href="#file-flushing">14.3.4. Flushing Files When using APPEND_NO_FLUSH</a></span></dt><dt><span class="section"><a href="#file-timestamps">14.3.5. File Timestamps</a></span></dt><dt><span class="section"><a href="#file-outbound-channel-adapter">14.3.6. File Outbound Channel Adapter</a></span></dt><dt><span class="section"><a href="#file-writing-output-gateway">14.3.7. Outbound Gateway</a></span></dt><dt><span class="section"><a href="#_configuring_with_java_configuration_9">14.3.8. Configuring with Java Configuration</a></span></dt><dt><span class="section"><a href="#_configuring_with_the_java_dsl_8">14.3.9. Configuring with the Java DSL</a></span></dt></dl></dd><dt><span class="section"><a href="#file-transforming">14.4. File Transformers</a></span></dt><dt><span class="section"><a href="#file-splitter">14.5. File Splitter</a></span></dt></dl></dd><dt><span class="chapter"><a href="#ftp">15. FTP/FTPS Adapters</a></span></dt><dd><dl><dt><span class="section"><a href="#ftp-intro">15.1. Introduction</a></span></dt><dt><span class="section"><a href="#ftp-session-factory">15.2. FTP Session Factory</a></span></dt><dt><span class="section"><a href="#ftp-dsf">15.3. Delegating Session Factory</a></span></dt><dt><span class="section"><a href="#ftp-inbound">15.4. FTP Inbound Channel Adapter</a></span></dt><dd><dl><dt><span class="section"><a href="#_recovering_from_failures">15.4.1. Recovering from Failures</a></span></dt><dt><span class="section"><a href="#_configuring_with_java_configuration_10">15.4.2. Configuring with Java Configuration</a></span></dt><dt><span class="section"><a href="#_configuring_with_the_java_dsl_9">15.4.3. Configuring with the Java DSL</a></span></dt></dl></dd><dt><span class="section"><a href="#ftp-streaming">15.5. FTP Streaming Inbound Channel Adapter</a></span></dt><dd><dl><dt><span class="section"><a href="#_configuring_with_java_configuration_11">15.5.1. Configuring with Java Configuration</a></span></dt></dl></dd><dt><span class="section"><a href="#ftp-outbound">15.6. FTP Outbound Channel Adapter</a></span></dt><dd><dl><dt><span class="section"><a href="#_configuring_with_java_configuration_12">15.6.1. Configuring with Java Configuration</a></span></dt><dt><span class="section"><a href="#_configuring_with_the_java_dsl_10">15.6.2. Configuring with the Java DSL</a></span></dt></dl></dd><dt><span class="section"><a href="#ftp-outbound-gateway">15.7. FTP Outbound Gateway</a></span></dt><dd><dl><dt><span class="section"><a href="#_configuring_with_java_configuration_13">15.7.1. Configuring with Java Configuration</a></span></dt><dt><span class="section"><a href="#_configuring_with_the_java_dsl_11">15.7.2. Configuring with the Java DSL</a></span></dt><dt><span class="section"><a href="#ftp-partial">15.7.3. Outbound Gateway Partial Success (mget and mput)</a></span></dt></dl></dd><dt><span class="section"><a href="#ftp-session-caching">15.8. FTP Session Caching</a></span></dt><dt><span class="section"><a href="#ftp-rft">15.9. RemoteFileTemplate</a></span></dt><dt><span class="section"><a href="#ftp-session-callback">15.10. MessageSessionCallback</a></span></dt></dl></dd><dt><span class="chapter"><a href="#gemfire">16. GemFire Support</a></span></dt><dd><dl><dt><span class="section"><a href="#gemfire-intro">16.1. Introduction</a></span></dt><dt><span class="section"><a href="#gemfire-inbound">16.2. Inbound Channel Adapter</a></span></dt><dt><span class="section"><a href="#gemfire-cq">16.3. Continuous Query Inbound Channel Adapter</a></span></dt><dt><span class="section"><a href="#gemfire-outbound">16.4. Outbound Channel Adapter</a></span></dt><dt><span class="section"><a href="#gemfire-message-store">16.5. Gemfire Message Store</a></span></dt><dt><span class="section"><a href="#gemfire-lock-registry">16.6. Gemfire Lock Registry</a></span></dt><dt><span class="section"><a href="#gemfire-metadata-store">16.7. Gemfire Metadata Store</a></span></dt></dl></dd><dt><span class="chapter"><a href="#http">17. HTTP Support</a></span></dt><dd><dl><dt><span class="section"><a href="#http-intro">17.1. Introduction</a></span></dt><dt><span class="section"><a href="#http-inbound">17.2. Http Inbound Components</a></span></dt><dt><span class="section"><a href="#http-outbound">17.3. Http Outbound Components</a></span></dt><dt><span class="section"><a href="#http-namespace">17.4. HTTP Namespace Support</a></span></dt><dd><dl><dt><span class="section"><a href="#_introduction_4">17.4.1. Introduction</a></span></dt><dt><span class="section"><a href="#_inbound">17.4.2. Inbound</a></span></dt><dt><span class="section"><a href="#_request_mapping_support">17.4.3. Request Mapping Support</a></span></dt><dt><span class="section"><a href="#http-cors">17.4.4. Cross-Origin Resource Sharing (CORS) Support</a></span></dt><dt><span class="section"><a href="#http-response-statuscode">17.4.5. Response StatusCode</a></span></dt><dt><span class="section"><a href="#_uri_template_variables_and_expressions">17.4.6. URI Template Variables and Expressions</a></span></dt><dt><span class="section"><a href="#_outbound">17.4.7. Outbound</a></span></dt><dt><span class="section"><a href="#mapping-uri-variables">17.4.8. Mapping URI Variables</a></span></dt><dt><span class="section"><a href="#_controlling_uri_encoding">17.4.9. Controlling URI Encoding</a></span></dt></dl></dd><dt><span class="section"><a href="#http-timeout">17.5. Timeout Handling</a></span></dt><dt><span class="section"><a href="#http-proxy">17.6. HTTP Proxy configuration</a></span></dt><dt><span class="section"><a href="#http-header-mapping">17.7. HTTP Header Mappings</a></span></dt><dt><span class="section"><a href="#int-graph-controller">17.8. Integration Graph Controller</a></span></dt><dt><span class="section"><a href="#http-samples">17.9. HTTP Samples</a></span></dt><dd><dl><dt><span class="section"><a href="#multipart-rest-inbound">17.9.1. Multipart HTTP request - RestTemplate (client) and Http Inbound Gateway (server)</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#jdbc">18. JDBC Support</a></span></dt><dd><dl><dt><span class="section"><a href="#jdbc-inbound-channel-adapter">18.1. Inbound Channel Adapter</a></span></dt><dd><dl><dt><span class="section"><a href="#_polling_and_transactions">18.1.1. Polling and Transactions</a></span></dt><dt><span class="section"><a href="#jdbc-max-rows-per-poll-versus-max-messages-per-poll">18.1.2. Max-rows-per-poll versus Max-messages-per-poll</a></span></dt></dl></dd><dt><span class="section"><a href="#jdbc-outbound-channel-adapter">18.2. Outbound Channel Adapter</a></span></dt><dt><span class="section"><a href="#jdbc-outbound-gateway">18.3. Outbound Gateway</a></span></dt><dt><span class="section"><a href="#jdbc-message-store">18.4. JDBC Message Store</a></span></dt><dd><dl><dt><span class="section"><a href="#jdbc-message-store-generic">18.4.1. The Generic JDBC Message Store</a></span></dt><dt><span class="section"><a href="#jdbc-message-store-channels">18.4.2. Backing Message Channels</a></span></dt><dt><span class="section"><a href="#_initializing_the_database">18.4.3. Initializing the Database</a></span></dt><dt><span class="section"><a href="#_partitioning_a_message_store">18.4.4. Partitioning a Message Store</a></span></dt></dl></dd><dt><span class="section"><a href="#stored-procedures">18.5. Stored Procedures</a></span></dt><dd><dl><dt><span class="section"><a href="#sp-supported-databases">18.5.1. Supported Databases</a></span></dt><dt><span class="section"><a href="#sp-configuration">18.5.2. Configuration</a></span></dt><dt><span class="section"><a href="#sp-common-config-params">18.5.3. Common Configuration Attributes</a></span></dt><dt><span class="section"><a href="#sp-common-config-subelements">18.5.4. Common Configuration Sub-Elements</a></span></dt><dt><span class="section"><a href="#sp-defining-parameter-sources">18.5.5. Defining Parameter Sources</a></span></dt><dt><span class="section"><a href="#stored-procedure-inbound-channel-adapter">18.5.6. Stored Procedure Inbound Channel Adapter</a></span></dt><dt><span class="section"><a href="#stored-procedure-outbound-channel-adapter">18.5.7. Stored Procedure Outbound Channel Adapter</a></span></dt><dt><span class="section"><a href="#stored-procedure-outbound-gateway">18.5.8. Stored Procedure Outbound Gateway</a></span></dt><dt><span class="section"><a href="#sp-examples">18.5.9. Examples</a></span></dt></dl></dd><dt><span class="section"><a href="#jdbc-lock-registry">18.6. JDBC Lock Registry</a></span></dt></dl></dd><dt><span class="chapter"><a href="#jpa">19. JPA Support</a></span></dt><dd><dl><dt><span class="section"><a href="#jpa-supported-persistence-providers">19.1. Supported Persistence Providers</a></span></dt><dt><span class="section"><a href="#jpa-java-implementation">19.2. Java Implementation</a></span></dt><dt><span class="section"><a href="#jpa-namespace-support">19.3. Namespace Support</a></span></dt><dd><dl><dt><span class="section"><a href="#jpa-namespace-support-common-attributes">19.3.1. Common XML Namespace Configuration Attributes</a></span></dt><dt><span class="section"><a href="#jpa-parameters">19.3.2. Providing JPA Query Parameters</a></span></dt><dt><span class="section"><a href="#jpa-transactions">19.3.3. Transaction Handling</a></span></dt></dl></dd><dt><span class="section"><a href="#jpa-inbound-channel-adapter">19.4. Inbound Channel Adapter</a></span></dt><dd><dl><dt><span class="section"><a href="#jpaInboundChannelAdapterParameters">19.4.1. Configuration Parameter Reference</a></span></dt></dl></dd><dt><span class="section"><a href="#jpa-outbound-channel-adapter">19.5. Outbound Channel Adapter</a></span></dt><dd><dl><dt><span class="section"><a href="#_using_an_entity_class">19.5.1. Using an Entity Class</a></span></dt><dt><span class="section"><a href="#_using_jpa_query_language_jpa_ql">19.5.2. Using JPA Query Language (JPA QL)</a></span></dt><dt><span class="section"><a href="#_using_native_queries">19.5.3. Using Native Queries</a></span></dt><dt><span class="section"><a href="#_using_named_queries">19.5.4. Using Named Queries</a></span></dt><dt><span class="section"><a href="#jpaOutboundChannelAdapterParameters">19.5.5. Configuration Parameter Reference</a></span></dt></dl></dd><dt><span class="section"><a href="#jpa-outbound-gateways">19.6. Outbound Gateways</a></span></dt><dd><dl><dt><span class="section"><a href="#jpa-outbound-gateway-common-parameters">19.6.1. Common Configuration Parameters</a></span></dt><dt><span class="section"><a href="#jpa-updating-outbound-gateway">19.6.2. Updating Outbound Gateway</a></span></dt><dt><span class="section"><a href="#jpa-retrieving-outbound-gateway">19.6.3. Retrieving Outbound Gateway</a></span></dt><dt><span class="section"><a href="#outboundGatewaySamples">19.6.4. JPA Outbound Gateway Samples</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#jms">20. JMS Support</a></span></dt><dd><dl><dt><span class="section"><a href="#jms-inbound-channel-adapter">20.1. Inbound Channel Adapter</a></span></dt><dd><dl><dt><span class="section"><a href="#jms-ib-transactions">20.1.1. Transactions</a></span></dt></dl></dd><dt><span class="section"><a href="#jms-message-driven-channel-adapter">20.2. Message-Driven Channel Adapter</a></span></dt><dd><dl><dt><span class="section"><a href="#jms-md-conversion-errors">20.2.1. Inbound Conversion Errors</a></span></dt></dl></dd><dt><span class="section"><a href="#jms-outbound-channel-adapter">20.3. Outbound Channel Adapter</a></span></dt><dd><dl><dt><span class="section"><a href="#jms-ob-transactions">20.3.1. Transactions</a></span></dt></dl></dd><dt><span class="section"><a href="#jms-inbound-gateway">20.4. Inbound Gateway</a></span></dt><dt><span class="section"><a href="#jms-outbound-gateway">20.5. Outbound Gateway</a></span></dt><dd><dl><dt><span class="section"><a href="#_gateway_reply_correlation">20.5.1. Gateway Reply Correlation</a></span></dt><dt><span class="section"><a href="#jms-async-gateway">20.5.2. Async Gateway</a></span></dt><dt><span class="section"><a href="#jms-og-attributes">20.5.3. Attribute Reference</a></span></dt></dl></dd><dt><span class="section"><a href="#jms-header-mapping">20.6. Mapping Message Headers to/from JMS Message</a></span></dt><dt><span class="section"><a href="#jms-conversion-and-marshalling">20.7. Message Conversion, Marshalling and Unmarshalling</a></span></dt><dt><span class="section"><a href="#jms-channel">20.8. JMS Backed Message Channels</a></span></dt><dt><span class="section"><a href="#jms-selectors">20.9. Using JMS Message Selectors</a></span></dt><dt><span class="section"><a href="#jms-samples">20.10. JMS Samples</a></span></dt></dl></dd><dt><span class="chapter"><a href="#mail">21. Mail Support</a></span></dt><dd><dl><dt><span class="section"><a href="#mail-outbound">21.1. Mail-Sending Channel Adapter</a></span></dt><dt><span class="section"><a href="#mail-inbound">21.2. Mail-Receiving Channel Adapter</a></span></dt><dt><span class="section"><a href="#mail-mapping">21.3. Inbound Mail Message Mapping</a></span></dt><dt><span class="section"><a href="#mail-namespace">21.4. Mail Namespace Support</a></span></dt><dt><span class="section"><a href="#imap-seen">21.5. Marking IMAP Messages When \Recent is Not Supported</a></span></dt><dt><span class="section"><a href="#mail-filtering">21.6. Email Message Filtering</a></span></dt><dt><span class="section"><a href="#mail-tx-sync">21.7. Transaction Synchronization</a></span></dt></dl></dd><dt><span class="chapter"><a href="#mongodb">22. MongoDb Support</a></span></dt><dd><dl><dt><span class="section"><a href="#mongodb-intro">22.1. Introduction</a></span></dt><dt><span class="section"><a href="#mongodb-connection">22.2. Connecting to MongoDb</a></span></dt><dt><span class="section"><a href="#mongodb-message-store">22.3. MongoDB Message Store</a></span></dt><dd><dl><dt><span class="section"><a href="#mongodb-priority-channel-message-store">22.3.1. MongoDB Channel Message Store</a></span></dt><dt><span class="section"><a href="#mongodb-metadata-store">22.3.2. MongoDB Metadata Store</a></span></dt></dl></dd><dt><span class="section"><a href="#mongodb-inbound-channel-adapter">22.4. MongoDB Inbound Channel Adapter</a></span></dt><dt><span class="section"><a href="#mongodb-outbound-channel-adapter">22.5. MongoDB Outbound Channel Adapter</a></span></dt></dl></dd><dt><span class="chapter"><a href="#mqtt">23. MQTT Support</a></span></dt><dd><dl><dt><span class="section"><a href="#mqtt-intro">23.1. Introduction</a></span></dt><dt><span class="section"><a href="#mqtt-inbound">23.2. Inbound (message-driven) Channel Adapter</a></span></dt><dd><dl><dt><span class="section"><a href="#_adding_removing_topics_at_runtime">23.2.1. Adding/Removing Topics at Runtime</a></span></dt><dt><span class="section"><a href="#_configuring_with_java_configuration_14">23.2.2. Configuring with Java Configuration</a></span></dt></dl></dd><dt><span class="section"><a href="#mqtt-outbound">23.3. Outbound Channel Adapter</a></span></dt><dd><dl><dt><span class="section"><a href="#_configuring_with_java_configuration_15">23.3.1. Configuring with Java Configuration</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#redis">24. Redis Support</a></span></dt><dd><dl><dt><span class="section"><a href="#redis-intro">24.1. Introduction</a></span></dt><dt><span class="section"><a href="#redis-connection">24.2. Connecting to Redis</a></span></dt><dt><span class="section"><a href="#redis-messages">24.3. Messaging with Redis</a></span></dt><dd><dl><dt><span class="section"><a href="#redis-pub-sub-channel">24.3.1. Redis Publish/Subscribe channel</a></span></dt><dt><span class="section"><a href="#redis-inbound-channel-adapter">24.3.2. Redis Inbound Channel Adapter</a></span></dt><dt><span class="section"><a href="#redis-outbound-channel-adapter">24.3.3. Redis Outbound Channel Adapter</a></span></dt><dt><span class="section"><a href="#redis-queue-inbound-channel-adapter">24.3.4. Redis Queue Inbound Channel Adapter</a></span></dt><dt><span class="section"><a href="#redis-queue-outbound-channel-adapter">24.3.5. Redis Queue Outbound Channel Adapter</a></span></dt><dt><span class="section"><a href="#redis-application-events">24.3.6. Redis Application Events</a></span></dt></dl></dd><dt><span class="section"><a href="#redis-message-store">24.4. Redis Message Store</a></span></dt><dd><dl><dt><span class="section"><a href="#redis-cms">24.4.1. Redis Channel Message Stores</a></span></dt></dl></dd><dt><span class="section"><a href="#redis-metadata-store">24.5. Redis Metadata Store</a></span></dt><dt><span class="section"><a href="#redis-store-inbound-channel-adapter">24.6. RedisStore Inbound Channel Adapter</a></span></dt><dt><span class="section"><a href="#redis-store-outbound-channel-adapter">24.7. RedisStore Outbound Channel Adapter</a></span></dt><dt><span class="section"><a href="#redis-outbound-gateway">24.8. Redis Outbound Command Gateway</a></span></dt><dt><span class="section"><a href="#redis-queue-outbound-gateway">24.9. Redis Queue Outbound Gateway</a></span></dt><dt><span class="section"><a href="#redis-queue-inbound-gateway">24.10. Redis Queue Inbound Gateway</a></span></dt><dt><span class="section"><a href="#redis-lock-registry">24.11. Redis Lock Registry</a></span></dt></dl></dd><dt><span class="chapter"><a href="#resource">25. Resource Support</a></span></dt><dd><dl><dt><span class="section"><a href="#resource-intro">25.1. Introduction</a></span></dt><dt><span class="section"><a href="#resource-inbound-channel-adapter">25.2. Resource Inbound Channel Adapter</a></span></dt></dl></dd><dt><span class="chapter"><a href="#rmi">26. RMI Support</a></span></dt><dd><dl><dt><span class="section"><a href="#rmi-intro">26.1. Introduction</a></span></dt><dt><span class="section"><a href="#rmi-outbound">26.2. Outbound RMI</a></span></dt><dt><span class="section"><a href="#rmi-inbound">26.3. Inbound RMI</a></span></dt><dt><span class="section"><a href="#rmi-namespace">26.4. RMI namespace support</a></span></dt><dt><span class="section"><a href="#_configuring_with_java_configuration_16">26.5. Configuring with Java Configuration</a></span></dt></dl></dd><dt><span class="chapter"><a href="#sftp">27. SFTP Adapters</a></span></dt><dd><dl><dt><span class="section"><a href="#sftp-intro">27.1. Introduction</a></span></dt><dt><span class="section"><a href="#sftp-session-factory">27.2. SFTP Session Factory</a></span></dt><dd><dl><dt><span class="section"><a href="#sftp-session-factory-properties">27.2.1. Configuration Properties</a></span></dt></dl></dd><dt><span class="section"><a href="#sftp-proxy-factory-bean">27.3. Proxy Factory Bean</a></span></dt><dt><span class="section"><a href="#sftp-dsf">27.4. Delegating Session Factory</a></span></dt><dt><span class="section"><a href="#sftp-session-caching">27.5. SFTP Session Caching</a></span></dt><dt><span class="section"><a href="#sftp-rft">27.6. RemoteFileTemplate</a></span></dt><dt><span class="section"><a href="#sftp-inbound">27.7. SFTP Inbound Channel Adapter</a></span></dt><dd><dl><dt><span class="section"><a href="#_recovering_from_failures_2">27.7.1. Recovering from Failures</a></span></dt><dt><span class="section"><a href="#_configuring_with_java_configuration_17">27.7.2. Configuring with Java Configuration</a></span></dt><dt><span class="section"><a href="#_configuring_with_the_java_dsl_12">27.7.3. Configuring with the Java DSL</a></span></dt></dl></dd><dt><span class="section"><a href="#sftp-streaming">27.8. SFTP Streaming Inbound Channel Adapter</a></span></dt><dd><dl><dt><span class="section"><a href="#_configuring_with_java_configuration_18">27.8.1. Configuring with Java Configuration</a></span></dt></dl></dd><dt><span class="section"><a href="#sftp-outbound">27.9. SFTP Outbound Channel Adapter</a></span></dt><dd><dl><dt><span class="section"><a href="#_configuring_with_java_configuration_19">27.9.1. Configuring with Java Configuration</a></span></dt><dt><span class="section"><a href="#_configuring_with_the_java_dsl_13">27.9.2. Configuring with the Java DSL</a></span></dt></dl></dd><dt><span class="section"><a href="#sftp-outbound-gateway">27.10. SFTP Outbound Gateway</a></span></dt><dd><dl><dt><span class="section"><a href="#_configuring_with_java_configuration_20">27.10.1. Configuring with Java Configuration</a></span></dt><dt><span class="section"><a href="#_configuring_with_the_java_dsl_14">27.10.2. Configuring with the Java DSL</a></span></dt><dt><span class="section"><a href="#sftp-partial">27.10.3. Outbound Gateway Partial Success (mget and mput)</a></span></dt></dl></dd><dt><span class="section"><a href="#sftp-jsch-logging">27.11. SFTP/JSCH Logging</a></span></dt><dt><span class="section"><a href="#sftp-session-callback">27.12. MessageSessionCallback</a></span></dt></dl></dd><dt><span class="chapter"><a href="#stomp">28. STOMP Support</a></span></dt><dd><dl><dt><span class="section"><a href="#stomp-introduction">28.1. Introduction</a></span></dt><dt><span class="section"><a href="#stomp-overview">28.2. Overview</a></span></dt><dt><span class="section"><a href="#stomp-inbound-adapter">28.3. STOMP Inbound Channel Adapter</a></span></dt><dt><span class="section"><a href="#stomp-outbound-adapter">28.4. STOMP Outbound Channel Adapter</a></span></dt><dt><span class="section"><a href="#stomp-headers">28.5. STOMP Headers Mapping</a></span></dt><dt><span class="section"><a href="#stomp-events">28.6. STOMP Integration Events</a></span></dt><dt><span class="section"><a href="#stomp-java-config">28.7. STOMP Adapters Java Configuration</a></span></dt><dt><span class="section"><a href="#stomp-namespace">28.8. STOMP Namespace Support</a></span></dt></dl></dd><dt><span class="chapter"><a href="#stream">29. Stream Support</a></span></dt><dd><dl><dt><span class="section"><a href="#stream-intro">29.1. Introduction</a></span></dt><dt><span class="section"><a href="#stream-reading">29.2. Reading from streams</a></span></dt><dt><span class="section"><a href="#stream-writing">29.3. Writing to streams</a></span></dt><dt><span class="section"><a href="#stream-namespace">29.4. Stream namespace support</a></span></dt></dl></dd><dt><span class="chapter"><a href="#syslog">30. Syslog Support</a></span></dt><dd><dl><dt><span class="section"><a href="#syslog-intro">30.1. Introduction</a></span></dt><dt><span class="section"><a href="#syslog-inbound-adapter">30.2. Syslog &lt;inbound-channel-adapter&gt;</a></span></dt><dd><dl><dt><span class="section"><a href="#syslog-inbound-examplers">30.2.1. Example Configuration</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#ip">31. TCP and UDP Support</a></span></dt><dd><dl><dt><span class="section"><a href="#ip-intro">31.1. Introduction</a></span></dt><dt><span class="section"><a href="#udp-adapters">31.2. UDP Adapters</a></span></dt><dt><span class="section"><a href="#connection-factories">31.3. TCP Connection Factories</a></span></dt><dd><dl><dt><span class="section"><a href="#caching-cf">31.3.1. TCP Caching Client Connection Factory</a></span></dt><dt><span class="section"><a href="#failover-cf">31.3.2. TCP Failover Client Connection Factory</a></span></dt></dl></dd><dt><span class="section"><a href="#ip-interceptors">31.4. TCP Connection Interceptors</a></span></dt><dt><span class="section"><a href="#tcp-events">31.5. TCP Connection Events</a></span></dt><dt><span class="section"><a href="#tcp-adapters">31.6. TCP Adapters</a></span></dt><dt><span class="section"><a href="#tcp-gateways">31.7. TCP Gateways</a></span></dt><dt><span class="section"><a href="#ip-correlation">31.8. TCP Message Correlation</a></span></dt><dd><dl><dt><span class="section"><a href="#_overview">31.8.1. Overview</a></span></dt><dt><span class="section"><a href="#_gateways">31.8.2. Gateways</a></span></dt><dt><span class="section"><a href="#_collaborating_outbound_and_inbound_channel_adapters">31.8.3. Collaborating Outbound and Inbound Channel Adapters</a></span></dt><dt><span class="section"><a href="#ip-headers">31.8.4. Transferring Headers</a></span></dt></dl></dd><dt><span class="section"><a href="#note_nio">31.9. A Note About NIO</a></span></dt><dd><dl><dt><span class="section"><a href="#_thread_pool_task_executor_with_caller_runs_policy">31.9.1. Thread Pool Task Executor with CALLER_RUNS Policy</a></span></dt></dl></dd><dt><span class="section"><a href="#ssl-tls">31.10. SSL/TLS Support</a></span></dt><dd><dl><dt><span class="section"><a href="#_overview_2">31.10.1. Overview</a></span></dt><dt><span class="section"><a href="#_getting_started">31.10.2. Getting Started</a></span></dt></dl></dd><dt><span class="section"><a href="#advanced-techniques">31.11. Advanced Techniques</a></span></dt><dd><dl><dt><span class="section"><a href="#_strategy_interfaces">31.11.1. Strategy Interfaces</a></span></dt><dt><span class="section"><a href="#_example_enabling_ssl_client_authentication">31.11.2. Example: Enabling SSL Client Authentication</a></span></dt></dl></dd><dt><span class="section"><a href="#ip-endpoint-reference">31.12. IP Configuration Attributes</a></span></dt><dt><span class="section"><a href="#ip-msg-headers">31.13. IP Message Headers</a></span></dt><dt><span class="section"><a href="#ip-annotation">31.14. Annotation-Based Configuration</a></span></dt></dl></dd><dt><span class="chapter"><a href="#twitter">32. Twitter Support</a></span></dt><dd><dl><dt><span class="section"><a href="#twitter-intro">32.1. Introduction</a></span></dt><dt><span class="section"><a href="#twitter-oauth">32.2. Twitter OAuth Configuration</a></span></dt><dt><span class="section"><a href="#_twitter_template">32.3. Twitter Template</a></span></dt><dt><span class="section"><a href="#twitter-inbound">32.4. Twitter Inbound Adapters</a></span></dt><dd><dl><dt><span class="section"><a href="#inbound-twitter-update">32.4.1. Inbound Message Channel Adapter</a></span></dt><dt><span class="section"><a href="#inbound-twitter-direct">32.4.2. Direct Inbound Message Channel Adapter</a></span></dt><dt><span class="section"><a href="#inbound-twitter-mention">32.4.3. Mentions Inbound Message Channel Adapter</a></span></dt><dt><span class="section"><a href="#inbound-twitter-search">32.4.4. Search Inbound Message Channel Adapter</a></span></dt></dl></dd><dt><span class="section"><a href="#twitter-outbound">32.5. Twitter Outbound Adapter</a></span></dt><dd><dl><dt><span class="section"><a href="#outbound-twitter-update">32.5.1. Twitter Outbound Update Channel Adapter</a></span></dt><dt><span class="section"><a href="#outbound-twitter-direct">32.5.2. Twitter Outbound Direct Message Channel Adapter</a></span></dt></dl></dd><dt><span class="section"><a href="#twitter-sog">32.6. Twitter Search Outbound Gateway</a></span></dt></dl></dd><dt><span class="chapter"><a href="#web-sockets">33. WebSockets Support</a></span></dt><dd><dl><dt><span class="section"><a href="#web-socket-introduction">33.1. Introduction</a></span></dt><dt><span class="section"><a href="#web-socket-overview">33.2. Overview</a></span></dt><dt><span class="section"><a href="#web-socket-inbound-adapter">33.3. WebSocket Inbound Channel Adapter</a></span></dt><dt><span class="section"><a href="#web-socket-outbound-adapter">33.4. WebSocket Outbound Channel Adapter</a></span></dt><dt><span class="section"><a href="#web-sockets-namespace">33.5. WebSockets Namespace Support</a></span></dt><dt><span class="section"><a href="#client-stomp-encoder">33.6. ClientStompEncoder</a></span></dt></dl></dd><dt><span class="chapter"><a href="#ws">34. Web Services Support</a></span></dt><dd><dl><dt><span class="section"><a href="#webservices-outbound">34.1. Outbound Web Service Gateways</a></span></dt><dt><span class="section"><a href="#webservices-inbound">34.2. Inbound Web Service Gateways</a></span></dt><dt><span class="section"><a href="#webservices-namespace">34.3. Web Service Namespace Support</a></span></dt><dt><span class="section"><a href="#outbound-uri">34.4. Outbound URI Configuration</a></span></dt><dt><span class="section"><a href="#ws-message-headers">34.5. WS Message Headers</a></span></dt></dl></dd><dt><span class="chapter"><a href="#xml">35. XML Support - Dealing with XML Payloads</a></span></dt><dd><dl><dt><span class="section"><a href="#xml-intro">35.1. Introduction</a></span></dt><dt><span class="section"><a href="#xpath-namespace-support">35.2. Namespace Support</a></span></dt><dd><dl><dt><span class="section"><a href="#xml-xpath-expressions">35.2.1. XPath Expressions</a></span></dt><dd><dl><dt><span class="section"><a href="#_providing_namespaces_optional_to_xpath_expressions">Providing Namespaces (Optional) to XPath Expressions</a></span></dt><dt><span class="section"><a href="#_using_xpath_expressions_with_default_namespaces">Using XPath Expressions with Default Namespaces</a></span></dt></dl></dd></dl></dd><dt><span class="section"><a href="#xml-transformation">35.3. Transforming XML Payloads</a></span></dt><dd><dl><dt><span class="section"><a href="#xml-transformation-beans">35.3.1. Configuring Transformers as Beans</a></span></dt><dd><dl><dt><span class="section"><a href="#xml-unmarshalling-transformer">UnmarshallingTransformer</a></span></dt><dt><span class="section"><a href="#xml-marshalling-transformer">MarshallingTransformer</a></span></dt><dt><span class="section"><a href="#xml-xslt-payload-transformers">XsltPayloadTransformer</a></span></dt><dt><span class="section"><a href="#xml-using-result-transformers">ResultTransformers</a></span></dt></dl></dd><dt><span class="section"><a href="#xml-transformer-namespace">35.3.2. Namespace Support for XML Transformers</a></span></dt><dt><span class="section"><a href="#xml-using-result-transformers-namespace">35.3.3. Namespace Configuration and ResultTransformers</a></span></dt></dl></dd><dt><span class="section"><a href="#xml-xpath-transformer">35.4. Transforming XML Messages Using XPath</a></span></dt><dt><span class="section"><a href="#xml-xpath-splitting">35.5. Splitting XML Messages</a></span></dt><dt><span class="section"><a href="#xml-xpath-routing">35.6. Routing XML Messages Using XPath</a></span></dt><dd><dl><dt><span class="section"><a href="#xpath-routing-converter">35.6.1. XML Payload Converter</a></span></dt></dl></dd><dt><span class="section"><a href="#xml-xpath-header-enricher">35.7. XPath Header Enricher</a></span></dt><dt><span class="section"><a href="#xml-xpath-filter">35.8. Using the XPath Filter</a></span></dt><dt><span class="section"><a href="#xpath-spel-function">35.9. #xpath SpEL Function</a></span></dt><dt><span class="section"><a href="#xml-validating-filter">35.10. XML Validating Filter</a></span></dt></dl></dd><dt><span class="chapter"><a href="#xmpp">36. XMPP Support</a></span></dt><dd><dl><dt><span class="section"><a href="#xmpp-intro">36.1. Introduction</a></span></dt><dt><span class="section"><a href="#xmpp-connection">36.2. XMPP Connection</a></span></dt><dt><span class="section"><a href="#xmpp-messages">36.3. XMPP Messages</a></span></dt><dd><dl><dt><span class="section"><a href="#xmpp-message-inbound-channel-adapter">36.3.1. Inbound Message Channel Adapter</a></span></dt><dt><span class="section"><a href="#xmpp-message-outbound-channel-adapter">36.3.2. Outbound Message Channel Adapter</a></span></dt></dl></dd><dt><span class="section"><a href="#xmpp-presence">36.4. XMPP Presence</a></span></dt><dd><dl><dt><span class="section"><a href="#xmpp-roster-inbound-channel-adapter">36.4.1. Inbound Presence Message Channel Adapter</a></span></dt><dt><span class="section"><a href="#xmpp-roster-outbound-channel-adapter">36.4.2. Outbound Presence Message Channel Adapter</a></span></dt></dl></dd><dt><span class="section"><a href="#xmpp-advanced">36.5. Advanced Configuration</a></span></dt><dt><span class="section"><a href="#xmpp-message-headers">36.6. XMPP Message Headers</a></span></dt><dt><span class="section"><a href="#xmpp-extensions">36.7. XMPP Extensions</a></span></dt></dl></dd><dt><span class="chapter"><a href="#zookeeper">37. Zookeeper Support</a></span></dt><dd><dl><dt><span class="section"><a href="#_introduction_5">37.1. Introduction</a></span></dt><dt><span class="section"><a href="#zk-metadata-store">37.2. Zookeeper Metadata Store</a></span></dt><dt><span class="section"><a href="#zk-lock-registry">37.3. Zookeeper Lock Registry</a></span></dt><dt><span class="section"><a href="#zk-leadership">37.4. Zookeeper Leadership Event Handling</a></span></dt></dl></dd></dl></dd><dt><span class="part"><a href="#spring-integration-appendices">VI. Appendices</a></span></dt><dd><dl><dt><span class="appendix"><a href="#spel">A. Spring Expression Language (SpEL)</a></span></dt><dd><dl><dt><span class="section"><a href="#spel-intro">A.1. Introduction</a></span></dt><dt><span class="section"><a href="#spel-customization">A.2. SpEL Evaluation Context Customization</a></span></dt><dt><span class="section"><a href="#spel-functions">A.3. SpEL Functions</a></span></dt><dt><span class="section"><a href="#spel-property-accessors">A.4. PropertyAccessors</a></span></dt></dl></dd><dt><span class="appendix"><a href="#message-publishing">B. Message Publishing</a></span></dt><dd><dl><dt><span class="section"><a href="#message-publishing-config">B.1. Message Publishing Configuration</a></span></dt><dd><dl><dt><span class="section"><a href="#publisher-annotation">B.1.1. Annotation-driven approach via @Publisher annotation</a></span></dt><dt><span class="section"><a href="#aop-based-interceptor">B.1.2. XML-based approach via the &lt;publishing-interceptor&gt; element</a></span></dt><dt><span class="section"><a href="#scheduled-producer">B.1.3. Producing and publishing messages based on a scheduled trigger</a></span></dt></dl></dd></dl></dd><dt><span class="appendix"><a href="#transactions">C. Transaction Support</a></span></dt><dd><dl><dt><span class="section"><a href="#transaction-support">C.1. Understanding Transactions in Message flows</a></span></dt><dd><dl><dt><span class="section"><a href="#transaction-poller">C.1.1. Poller Transaction Support</a></span></dt></dl></dd><dt><span class="section"><a href="#transaction-boundaries">C.2. Transaction Boundaries</a></span></dt><dt><span class="section"><a href="#transaction-synchronization">C.3. Transaction Synchronization</a></span></dt><dt><span class="section"><a href="#pseudo-transactions">C.4. Pseudo Transactions</a></span></dt></dl></dd><dt><span class="appendix"><a href="#security">D. Security in Spring Integration</a></span></dt><dd><dl><dt><span class="section"><a href="#security-intro">D.1. Introduction</a></span></dt><dt><span class="section"><a href="#securing-channels">D.2. Securing channels</a></span></dt><dt><span class="section"><a href="#security-context-propagation">D.3. SecurityContext Propagation</a></span></dt></dl></dd><dt><span class="appendix"><a href="#samples">E. Spring Integration Samples</a></span></dt><dd><dl><dt><span class="section"><a href="#samples-introduction">E.1. Introduction</a></span></dt><dt><span class="section"><a href="#samples-get">E.2. Where to get Samples</a></span></dt><dt><span class="section"><a href="#_submitting_samples_or_sample_requests">E.3. Submitting Samples or Sample Requests</a></span></dt><dt><span class="section"><a href="#samples-structure">E.4. Samples Structure</a></span></dt><dt><span class="section"><a href="#samples-impl">E.5. Samples</a></span></dt><dd><dl><dt><span class="section"><a href="#samples-loan-broker">E.5.1. Loan Broker</a></span></dt><dt><span class="section"><a href="#samples-cafe">E.5.2. The Cafe Sample</a></span></dt><dt><span class="section"><a href="#samples-xml-messaging">E.5.3. The XML Messaging Sample</a></span></dt></dl></dd></dl></dd><dt><span class="appendix"><a href="#configuration">F. Configuration</a></span></dt><dd><dl><dt><span class="section"><a href="#configuration-introduction">F.1. Introduction</a></span></dt><dt><span class="section"><a href="#configuration-namespace">F.2. Namespace Support</a></span></dt><dt><span class="section"><a href="#namespace-taskscheduler">F.3. Configuring the Task Scheduler</a></span></dt><dt><span class="section"><a href="#namespace-errorhandler">F.4. Error Handling</a></span></dt><dt><span class="section"><a href="#global-properties">F.5. Global Properties</a></span></dt><dt><span class="section"><a href="#annotations">F.6. Annotation Support</a></span></dt><dd><dl><dt><span class="section"><a href="#meta-annotations">F.6.1. Messaging Meta-Annotations</a></span></dt><dt><span class="section"><a href="#annotations_on_beans">F.6.2. Annotations on @Beans</a></span></dt><dt><span class="section"><a href="#_creating_a_bridge_with_annotations">F.6.3. Creating a Bridge with Annotations</a></span></dt><dt><span class="section"><a href="#_advising_annotated_endpoints">F.6.4. Advising Annotated Endpoints</a></span></dt></dl></dd><dt><span class="section"><a href="#message-mapping-rules">F.7. Message Mapping rules and conventions</a></span></dt><dd><dl><dt><span class="section"><a href="#sample-scenarios">F.7.1. Simple Scenarios</a></span></dt><dt><span class="section"><a href="#complex-scenarios">F.7.2. Complex Scenarios</a></span></dt></dl></dd></dl></dd><dt><span class="appendix"><a href="#resources">G. Additional Resources</a></span></dt><dd><dl><dt><span class="section"><a href="#resources-home">G.1. Spring Integration Home</a></span></dt></dl></dd><dt><span class="appendix"><a href="#history">H. Change History</a></span></dt><dd><dl><dt><span class="section"><a href="#migration-4.1-4.2">H.1. Changes between 4.1 and 4.2</a></span></dt><dt><span class="section"><a href="#x4.2-new-components">H.2. New Components</a></span></dt><dd><dl><dt><span class="section"><a href="#x4.2-JMX">H.2.1. Major Management/JMX Rework</a></span></dt><dt><span class="section"><a href="#x4.2-mongodb-metadata-store">H.2.2. MongoDB Metadata Store</a></span></dt><dt><span class="section"><a href="#x4.2-secured-channel-annotation">H.2.3. SecuredChannel Annotation</a></span></dt><dt><span class="section"><a href="#x4.2-security-context-propagation">H.2.4. SecurityContext Propagation</a></span></dt><dt><span class="section"><a href="#x4.2-file-splitter">H.2.5. FileSplitter</a></span></dt><dt><span class="section"><a href="#x4.2-zk">H.2.6. Zookeeper Support</a></span></dt><dt><span class="section"><a href="#x4.2-barrier">H.2.7. Thread Barrier</a></span></dt><dt><span class="section"><a href="#x4.2-stomp">H.2.8. STOMP Support</a></span></dt><dt><span class="section"><a href="#x4.2-codec">H.2.9. Codec</a></span></dt><dt><span class="section"><a href="#x4.2-prepared-statement-setter">H.2.10. Message PreparedStatement Setter</a></span></dt></dl></dd><dt><span class="section"><a href="#x4.2-general">H.3. General Changes</a></span></dt><dd><dl><dt><span class="section"><a href="#x4.2-wire-tap">H.3.1. Wire Tap</a></span></dt><dt><span class="section"><a href="#x4.2-file-changes">H.3.2. File Changes</a></span></dt><dd><dl><dt><span class="section"><a href="#_appending_new_lines">Appending New Lines</a></span></dt><dt><span class="section"><a href="#_ignoring_hidden_files">Ignoring Hidden Files</a></span></dt><dt><span class="section"><a href="#_writing_inputstream_payloads">Writing InputStream Payloads</a></span></dt><dt><span class="section"><a href="#_headdirectoryscanner">HeadDirectoryScanner</a></span></dt><dt><span class="section"><a href="#_last_modified_filter">Last Modified Filter</a></span></dt><dt><span class="section"><a href="#_watchservice_directory_scanner">WatchService Directory Scanner</a></span></dt><dt><span class="section"><a href="#_persistent_file_list_filter_changes">Persistent File List Filter Changes</a></span></dt></dl></dd><dt><span class="section"><a href="#x4.2-class-package-change">H.3.3. Class Package Change</a></span></dt><dt><span class="section"><a href="#_tcp_changes">H.3.4. TCP Changes</a></span></dt><dd><dl><dt><span class="section"><a href="#x4.2-tcp-serializers">TCP Serializers</a></span></dt><dt><span class="section"><a href="#x4.2-tcp-server-exceptions">Server Socket Exceptions</a></span></dt><dt><span class="section"><a href="#x4.2-tcp-server-port">TCP Server Port</a></span></dt><dt><span class="section"><a href="#x4.2-tcp-gw-rto">TCP Gateway Remote Timeout</a></span></dt><dt><span class="section"><a href="#x4.2-tcp-ssl">TCP SSLSession Available for Header Mapping</a></span></dt><dt><span class="section"><a href="#x4.2-tcp-events">TCP Events</a></span></dt></dl></dd><dt><span class="section"><a href="#x4.2-inbound-channel-adapter-annotation">H.3.5. @InboundChannelAdapter</a></span></dt><dt><span class="section"><a href="#x4.2-api-changes">H.3.6. API Changes</a></span></dt><dt><span class="section"><a href="#x4.2-jms-changes">H.3.7. JMS Changes</a></span></dt><dd><dl><dt><span class="section"><a href="#_reply_listener_lazy_initialization">Reply Listener Lazy Initialization</a></span></dt><dt><span class="section"><a href="#_conversion_errors_in_message_driven_endpoints">Conversion Errors in Message-Driven Endpoints</a></span></dt><dt><span class="section"><a href="#_default_acknowledge_mode">Default Acknowledge Mode</a></span></dt><dt><span class="section"><a href="#_shared_subscriptions">Shared Subscriptions</a></span></dt></dl></dd><dt><span class="section"><a href="#x4.2-conditional-pollers">H.3.8. Conditional Pollers</a></span></dt><dt><span class="section"><a href="#x4.2-amqp-changes">H.3.9. AMQP Changes</a></span></dt><dd><dl><dt><span class="section"><a href="#_publisher_confirms">Publisher Confirms</a></span></dt><dt><span class="section"><a href="#_correlation_data">Correlation Data</a></span></dt><dt><span class="section"><a href="#_the_inbound_gateway_properties">The Inbound Gateway properties</a></span></dt></dl></dd><dt><span class="section"><a href="#x4.2-xpath-splitter">H.3.10. XPath Splitter Improvements</a></span></dt><dt><span class="section"><a href="#x4.2-http-changes">H.3.11. HTTP Changes</a></span></dt><dd><dl><dt><span class="section"><a href="#_cors">CORS</a></span></dt><dt><span class="section"><a href="#_inbound_gateway_timeout">Inbound Gateway Timeout</a></span></dt><dt><span class="section"><a href="#_form_data">Form Data</a></span></dt></dl></dd><dt><span class="section"><a href="#x4.2-gw">H.3.12. Gateway Changes</a></span></dt><dd><dl><dt><span class="section"><a href="#_gateway_methods_can_return_completablefuture">Gateway Methods can Return CompletableFuture&lt;?&gt;</a></span></dt><dt><span class="section"><a href="#_messaginggateway_annotation">MessagingGateway Annotation</a></span></dt></dl></dd><dt><span class="section"><a href="#x4.2-aggregator-changes">H.3.13. Aggregator Changes</a></span></dt><dd><dl><dt><span class="section"><a href="#_aggregator_performance">Aggregator Performance</a></span></dt><dt><span class="section"><a href="#_output_message_group_processor">Output Message Group Processor</a></span></dt></dl></dd><dt><span class="section"><a href="#__s_ftp_changes">H.3.14. (S)FTP Changes</a></span></dt><dd><dl><dt><span class="section"><a href="#_inbound_channel_adapters">Inbound channel adapters</a></span></dt><dt><span class="section"><a href="#_gateway_partial_results">Gateway Partial Results</a></span></dt><dt><span class="section"><a href="#_delegating_session_factory">Delegating Session Factory</a></span></dt><dt><span class="section"><a href="#_default_sftp_session_factory">Default Sftp Session Factory</a></span></dt><dt><span class="section"><a href="#_message_session_callback">Message Session Callback</a></span></dt></dl></dd><dt><span class="section"><a href="#_websocket_changes_2">H.3.15. Websocket Changes</a></span></dt><dt><span class="section"><a href="#_application_event_adapters_changes">H.3.16. Application Event Adapters changes</a></span></dt></dl></dd><dt><span class="section"><a href="#migration-4.0-4.1">H.4. Changes between 4.0 and 4.1</a></span></dt><dd><dl><dt><span class="section"><a href="#_new_components">H.4.1. New Components</a></span></dt><dd><dl><dt><span class="section"><a href="#x4.1-promise-gateway">Promise&lt;?&gt; Gateway</a></span></dt><dt><span class="section"><a href="#x4.1-web-socket-adapters">WebSocket support</a></span></dt><dt><span class="section"><a href="#x4.1-scatter-gather">Scatter-Gather EIP pattern</a></span></dt><dt><span class="section"><a href="#x4.1-Routing-Slip">Routing Slip Pattern</a></span></dt><dt><span class="section"><a href="#x4.1-idempotent-receiver">Idempotent Receiver Pattern</a></span></dt><dt><span class="section"><a href="#x4.1-BoonJsonObjectMapper">BoonJsonObjectMapper</a></span></dt><dt><span class="section"><a href="#x4.1-redis-queue-gateways">Redis Queue Gateways</a></span></dt><dt><span class="section"><a href="#x4.1-PollSkipAdvice">PollSkipAdvice</a></span></dt></dl></dd><dt><span class="section"><a href="#x4.1-general">H.4.2. General Changes</a></span></dt><dd><dl><dt><span class="section"><a href="#x4.1-amqp-inbound-missing-queues">AMQP Inbound Endpoints, Channel</a></span></dt><dt><span class="section"><a href="#x4.1-amqp-outbound-lazy-connect">AMQP Outbound Endpoints</a></span></dt><dt><span class="section"><a href="#x4.1-sms-copy-on-get">SimpleMessageStore</a></span></dt><dt><span class="section"><a href="#x4.1-ws-encode-uri">Web Service Outbound Gateway: encode-uri</a></span></dt><dt><span class="section"><a href="#x4.1-http-status-code">Http Inbound Channel Adapter and StatusCode</a></span></dt><dt><span class="section"><a href="#x4.1-mqtt">MQTT Adapter Changes</a></span></dt><dt><span class="section"><a href="#x4.1-sftp">FTP/SFTP Adapter Changes</a></span></dt><dt><span class="section"><a href="#x4.1-splitter-iterator">Splitter and Iterator</a></span></dt><dt><span class="section"><a href="#x4.1-aggregator">Aggregator</a></span></dt><dt><span class="section"><a href="#x4.1-content-enricher-improvement">Content Enricher Improvements</a></span></dt><dt><span class="section"><a href="#x4.1-header-channel-registry">Header Channel Registry</a></span></dt><dt><span class="section"><a href="#x4.1-orderly-shutdown">Orderly Shutdown</a></span></dt><dt><span class="section"><a href="#x4.1-recipientListRouter">Management for RecipientListRouter</a></span></dt><dt><span class="section"><a href="#x4.1-AbstractHeaderMapper-changes">AbstractHeaderMapper: NON_STANDARD_HEADERS token</a></span></dt><dt><span class="section"><a href="#x4.1-amqp-channels">AMQP Channels: template-channel-transacted</a></span></dt><dt><span class="section"><a href="#x4.1-syslog">Syslog Adapter</a></span></dt><dt><span class="section"><a href="#x4.1-async-gateway">Async Gateway</a></span></dt><dt><span class="section"><a href="#x4.1-aggregator-advice-chain">Aggregator Advice Chain</a></span></dt><dt><span class="section"><a href="#x4.1-script-outbound-channel-adapter">Outbound Channel Adapter and Scripts</a></span></dt><dt><span class="section"><a href="#x4.1-reseq">Resequencer Changes</a></span></dt><dt><span class="section"><a href="#x4.1-Optional-Parameter">Optional POJO method parameter</a></span></dt><dt><span class="section"><a href="#x4.1-queue-channel-queue.typ">QueueChannel: backed Queue type</a></span></dt><dt><span class="section"><a href="#x4.1-channel-interceptor">ChannelInterceptor Changes</a></span></dt><dt><span class="section"><a href="#x4.1-mail-peek">IMAP PEEK</a></span></dt></dl></dd></dl></dd><dt><span class="section"><a href="#migration-3.0-4.0">H.5. Changes between 3.0 and 4.0</a></span></dt><dd><dl><dt><span class="section"><a href="#x4.0-new-components">H.5.1. New Components</a></span></dt><dd><dl><dt><span class="section"><a href="#x4.0-mqtt">MQTT Channel Adapters</a></span></dt><dt><span class="section"><a href="#x4.0-enable-configuration">@EnableIntegration</a></span></dt><dt><span class="section"><a href="#x4.0-component-scan">@IntegrationComponentScan</a></span></dt><dt><span class="section"><a href="#x4.0-message-history">@EnableMessageHistory</a></span></dt><dt><span class="section"><a href="#x4.0-messaging-gateway">@MessagingGateway</a></span></dt><dt><span class="section"><a href="#x4.0-boot">Spring Boot @EnableAutoConfiguration</a></span></dt><dt><span class="section"><a href="#x4.0-global-channel-interceptor">@GlobalChannelInterceptor</a></span></dt><dt><span class="section"><a href="#x4.0-integration-converter">@IntegrationConverter</a></span></dt><dt><span class="section"><a href="#x4.0-enable-publisher">@EnablePublisher</a></span></dt><dt><span class="section"><a href="#x4.0-redis-cms">Redis Channel Message Stores</a></span></dt><dt><span class="section"><a href="#x4.0-priority-channel-mondodb">MongodDB Channel Message Store</a></span></dt><dt><span class="section"><a href="#x4.0-MBeanExport-annotation">@EnableIntegrationMBeanExport</a></span></dt><dt><span class="section"><a href="#x4.0-channel-security-interceptor">ChannelSecurityInterceptorFactoryBean</a></span></dt><dt><span class="section"><a href="#x4.0-redis-outbound-gateway">Redis Command Gateway</a></span></dt><dt><span class="section"><a href="#x4.0-redis-gemfire-lock-registry">RedisLockRegistry and GemfireLockRegistry</a></span></dt><dt><span class="section"><a href="#x4.0-poller-annotation">@Poller</a></span></dt><dt><span class="section"><a href="#x4.0-inbound-channel-adapter-annotation">@InboundChannelAdapter and SmartLifecycle for Annotated Endpoints</a></span></dt><dt><span class="section"><a href="#x4.0-twitter-sog">Twitter Search Outbound Gateway</a></span></dt><dt><span class="section"><a href="#x4.0-gemfire-metadata">Gemfire Metadata Store</a></span></dt><dt><span class="section"><a href="#x4.0-bridge-annotations">@BridgeFrom and @BridgeTo Annotations</a></span></dt><dt><span class="section"><a href="#x4.0-meta-messaging-annotations">Meta Messaging Annotations</a></span></dt></dl></dd><dt><span class="section"><a href="#x4.0-general">H.5.2. General Changes</a></span></dt><dd><dl><dt><span class="section"><a href="#_requires_spring_framework_4_0">Requires Spring Framework 4.0</a></span></dt><dt><span class="section"><a href="#x4.0-xpath-header-enricher-header-type">Header Type for XPath Header Enricher</a></span></dt><dt><span class="section"><a href="#x4.0-object-to-json-transformer-result-type">Object To Json Transformer: Node Result</a></span></dt><dt><span class="section"><a href="#x4.0-jms-header-mapping">JMS Header Mapping</a></span></dt><dt><span class="section"><a href="#x4.0-jms-ob">JMS Outbound Channel Adapter</a></span></dt><dt><span class="section"><a href="#x4.0-jms-ib">JMS Inbound Channel Adapter</a></span></dt><dt><span class="section"><a href="#x4.0-datatype-channel">Datatype Channels</a></span></dt><dt><span class="section"><a href="#x4.0-retry-config">Simpler Retry Advice Configuration</a></span></dt><dt><span class="section"><a href="#x4.0-release-strategy-group-timeout">Correlation Endpoint: Time-based Release Strategy</a></span></dt><dt><span class="section"><a href="#x4.0-redis-metadata">Redis Metadata Store</a></span></dt><dt><span class="section"><a href="#x4.0-jdbc-cs">JdbcChannelMessageStore and PriorityChannel</a></span></dt><dt><span class="section"><a href="#x4.0-amqp">AMQP Endpoints Delivery Mode</a></span></dt><dt><span class="section"><a href="#x4.0-ftp">FTP Timeouts</a></span></dt><dt><span class="section"><a href="#x4.0-twitter-status-updating">Twitter: StatusUpdatingMessageHandler</a></span></dt><dt><span class="section"><a href="#x4.0-jpa-id-expression">JPA Retrieving Gateway: id-expression</a></span></dt><dt><span class="section"><a href="#x4.0-tcp-deserializer-events">TCP Deserialization Events</a></span></dt><dt><span class="section"><a href="#x4.0-bean-messaging-annotations">Messaging Annotations on @Bean Definitions</a></span></dt></dl></dd></dl></dd><dt><span class="section"><a href="#migration-2.2-3.0">H.6. Changes Between 2.2 and 3.0</a></span></dt><dd><dl><dt><span class="section"><a href="#x3.0-new-components">H.6.1. New Components</a></span></dt><dd><dl><dt><span class="section"><a href="#x3.0-request-mapping">HTTP Request Mapping</a></span></dt><dt><span class="section"><a href="#x3.0-spel-customization">Spring Expression Language (SpEL) Configuration</a></span></dt><dt><span class="section"><a href="#x3.0-spel-functions">SpEL Functions Support</a></span></dt><dt><span class="section"><a href="#x3.0-spel-property-accessors">SpEL PropertyAccessors Support</a></span></dt><dt><span class="section"><a href="#x3.0-redis-new-components">Redis: New Components</a></span></dt><dt><span class="section"><a href="#x3.0-hcr">Header Channel Registry</a></span></dt><dt><span class="section"><a href="#x3.0-configurable-mongo-MS">MongoDB support: New ConfigurableMongoDbMessageStore</a></span></dt><dt><span class="section"><a href="#x3.0-syslog">Syslog Support</a></span></dt><dt><span class="section"><a href="#x3.0-tail"><span class="emphasis"><em>Tail</em></span> Support</a></span></dt><dt><span class="section"><a href="#x3.0-jmx">JMX Support</a></span></dt><dt><span class="section"><a href="#x3.0-tcp-events">TCP/IP Connection Events and Connection Management</a></span></dt><dt><span class="section"><a href="#x3.0-inbound-script">Inbound Channel Adapter Script Support</a></span></dt><dt><span class="section"><a href="#x3.0-content-enricher-headers">Content Enricher: Headers Enrichment Support</a></span></dt></dl></dd><dt><span class="section"><a href="#x3.0-general">H.6.2. General Changes</a></span></dt><dd><dl><dt><span class="section"><a href="#x3.0-message-id">Message ID Generation</a></span></dt><dt><span class="section"><a href="#x3.0-gateway">&lt;gateway&gt; Changes</a></span></dt><dt><span class="section"><a href="#x3.0-http-endpointss">HTTP Endpoint Changes</a></span></dt><dt><span class="section"><a href="#x3.0-json-transformers">Jackson Support (JSON)</a></span></dt><dt><span class="section"><a href="#x3.0-id-for-chain-sub-components">Chain Elements <span class="emphasis"><em>id</em></span> Attribute</a></span></dt><dt><span class="section"><a href="#x3.0-corr-endpoint-empty-groups">Aggregator <span class="emphasis"><em>empty-group-min-timeout</em></span> property</a></span></dt><dt><span class="section"><a href="#x3.0-filelistfilter">Persistent File List Filters (file, (S)FTP)</a></span></dt><dt><span class="section"><a href="#x3.0-scripting-variables">Scripting Support: Variables Changes</a></span></dt><dt><span class="section"><a href="#x3.0-direct-channel-lb-ref">Direct Channel Load Balancing configuration</a></span></dt><dt><span class="section"><a href="#x3.0-pub-sub">PublishSubscribeChannel Behavior</a></span></dt><dt><span class="section"><a href="#x3.0--s-ftp-changes">FTP, SFTP and FTPS Changes</a></span></dt><dt><span class="section"><a href="#x3.0-outbound-gateway-requires-reply"><span class="emphasis"><em>requires-reply</em></span> Attribute for Outbound Gateways</a></span></dt><dt><span class="section"><a href="#x3.0-amqp-mapping">AMQP Outbound Gateway Header Mapping</a></span></dt><dt><span class="section"><a href="#x3.0-stored-proc-sql-return-type">Stored Procedure Components Improvements</a></span></dt><dt><span class="section"><a href="#x3.0-ws-outbound-uri-substitution">Web Service Outbound URI Configuration</a></span></dt><dt><span class="section"><a href="#x3.0-redis">Redis Adapter Changes</a></span></dt><dt><span class="section"><a href="#x3.0-advising-filters">Advising Filters</a></span></dt><dt><span class="section"><a href="#x3.0-annotation-advice">Advising Endpoints using Annotations</a></span></dt><dt><span class="section"><a href="#x3.0-o-t-s-t">ObjectToStringTransformer Improvements</a></span></dt><dt><span class="section"><a href="#x3.0-jpa-changes">JPA Support Changes</a></span></dt><dt><span class="section"><a href="#x3.0-dalay-expression">Delayer: delay expression</a></span></dt><dt><span class="section"><a href="#x3.0-jdbc-mysql-v5_6_4">JDBC Message Store Improvements</a></span></dt><dt><span class="section"><a href="#x3.0-event-for-imap-idle">IMAP Idle Connection Exceptions</a></span></dt><dt><span class="section"><a href="#x3.0-tcp-headers">Message Headers and TCP</a></span></dt><dt><span class="section"><a href="#x3.0-jms-mdca-te">JMS Message Driven Channel Adapter</a></span></dt><dt><span class="section"><a href="#x3.0-rmi-ec">RMI Inbound Gateway</a></span></dt><dt><span class="section"><a href="#x3.0-xslt-transformer">XsltPayloadTransformer</a></span></dt></dl></dd></dl></dd><dt><span class="section"><a href="#migration-2.1-2.2">H.7. Changes between 2.1 and 2.2</a></span></dt><dd><dl><dt><span class="section"><a href="#x2.2-new-components">H.7.1. New Components</a></span></dt><dd><dl><dt><span class="section"><a href="#x2.2-redis-store-adapters">RedisStore Inbound and Outbound Channel Adapters</a></span></dt><dt><span class="section"><a href="#x2.2-mongo-adapters">MongoDB Inbound and Outbound Channel Adapters</a></span></dt><dt><span class="section"><a href="#x2.2-jpa">JPA Endpoints</a></span></dt></dl></dd><dt><span class="section"><a href="#x2.2-general">H.7.2. General Changes</a></span></dt><dd><dl><dt><span class="section"><a href="#x2.2-spring-31">Spring 3.1 Used by Default</a></span></dt><dt><span class="section"><a href="#x2.2-handler-advice">Adding Behavior to Endpoints</a></span></dt><dt><span class="section"><a href="#x2.2-transaction-sync">Transaction Synchronization and Pseudo Transactions</a></span></dt><dt><span class="section"><a href="#x2.2-file-adapter">File Adapter - Improved File Overwrite/Append Handling</a></span></dt><dt><span class="section"><a href="#x2.2-outbound-gateways">Reply-Timeout added to more Outbound Gateways</a></span></dt><dt><span class="section"><a href="#x2.2-amqp-11">Spring-AMQP 1.1</a></span></dt><dt><span class="section"><a href="#x2.2-jdbc-11">JDBC Support - Stored Procedures Components</a></span></dt><dt><span class="section"><a href="#x2.2-jdbc-gateway-update-optional">JDBC Support - Outbound Gateway</a></span></dt><dt><span class="section"><a href="#x2.2-jdbc-message-store-channels">JDBC Support - Channel-specific Message Store Implementation</a></span></dt><dt><span class="section"><a href="#x2.2-shutdown">Orderly Shutdown</a></span></dt><dt><span class="section"><a href="#x2.2-jms-og">JMS Oubound Gateway Improvements</a></span></dt><dt><span class="section"><a href="#x2.2-o-t-j-t">object-to-json-transformer</a></span></dt><dt><span class="section"><a href="#httpChanges">HTTP Support</a></span></dt></dl></dd></dl></dd><dt><span class="section"><a href="#migration-2.0-2.1">H.8. Changes between 2.0 and 2.1</a></span></dt><dd><dl><dt><span class="section"><a href="#x2.1-new-components">H.8.1. New Components</a></span></dt><dd><dl><dt><span class="section"><a href="#x2.1-new-scripting-support">JSR-223 Scripting Support</a></span></dt><dt><span class="section"><a href="#x2.1-new-gemfire-support">GemFire Support</a></span></dt><dt><span class="section"><a href="#x2.1-new-amqp-support">AMQP Support</a></span></dt><dt><span class="section"><a href="#x2.1-new-mongodb-support">MongoDB Support</a></span></dt><dt><span class="section"><a href="#x2.1-new-redis-support">Redis Support</a></span></dt><dt><span class="section"><a href="#x2.1-new-resource-support">Support for Spring&#8217;s Resource abstraction</a></span></dt><dt><span class="section"><a href="#x2.1-new-stored-proc-support">Stored Procedure Components</a></span></dt><dt><span class="section"><a href="#x2.1-new-xpath-filter-support">XPath and XML Validating Filter</a></span></dt><dt><span class="section"><a href="#x2.1-new-payload-enricher-support">Payload Enricher</a></span></dt><dt><span class="section"><a href="#x2.1-new-ftp-outbound-gateway">FTP and SFTP Outbound Gateways</a></span></dt><dt><span class="section"><a href="#x2.1-new-ftp-session-caching">FTP Session Caching</a></span></dt></dl></dd><dt><span class="section"><a href="#x2.1-framework-refactorings">H.8.2. Framework Refactoring</a></span></dt><dd><dl><dt><span class="section"><a href="#x2.1-router-standardization">Standardizing Router Configuration</a></span></dt><dt><span class="section"><a href="#x2.1-schema-updated">XML Schemas updated to 2.1</a></span></dt></dl></dd><dt><span class="section"><a href="#x2.1-source-control-infrastructure">H.8.3. Source Control Management and Build Infrastructure</a></span></dt><dd><dl><dt><span class="section"><a href="#x2.1-move-to-github">Source Code now hosted on Github</a></span></dt><dt><span class="section"><a href="#x2.1-sonar">Improved Source Code Visibility with Sonar</a></span></dt></dl></dd><dt><span class="section"><a href="#x2.1-new-samples">H.8.4. New Samples</a></span></dt></dl></dd><dt><span class="section"><a href="#migration-1.0-2.0">H.9. Changes between 1.0 and 2.0</a></span></dt><dd><dl><dt><span class="section"><a href="#migration-spring-30-support">H.9.1. Spring 3 support</a></span></dt><dd><dl><dt><span class="section"><a href="#spel-support">Support for the Spring Expression Language (SpEL)</a></span></dt><dt><span class="section"><a href="#conversion-support">ConversionService and Converter</a></span></dt><dt><span class="section"><a href="#task-scheduler-poller-support">TaskScheduler and Trigger</a></span></dt><dt><span class="section"><a href="#rest-support">RestTemplate and HttpMessageConverter</a></span></dt></dl></dd><dt><span class="section"><a href="#new-eip">H.9.2. Enterprise Integration Pattern Additions</a></span></dt><dd><dl><dt><span class="section"><a href="#new-message-history">Message History</a></span></dt><dt><span class="section"><a href="#new-message-store">Message Store</a></span></dt><dt><span class="section"><a href="#new-claim-check">Claim Check</a></span></dt><dt><span class="section"><a href="#new-control-bus">Control Bus</a></span></dt></dl></dd><dt><span class="section"><a href="#new-adapters">H.9.3. New Channel Adapters and Gateways</a></span></dt><dd><dl><dt><span class="section"><a href="#new-ip">TCP/UDP Adapters</a></span></dt><dt><span class="section"><a href="#new-twitter">Twitter Adapters</a></span></dt><dt><span class="section"><a href="#new-xmpp">XMPP Adapters</a></span></dt><dt><span class="section"><a href="#new-ftp">FTP/FTPS Adapters</a></span></dt><dt><span class="section"><a href="#new-sftp">SFTP Adapters</a></span></dt><dt><span class="section"><a href="#new-feed">Feed Adapters</a></span></dt></dl></dd><dt><span class="section"><a href="#new-other">H.9.4. Other Additions</a></span></dt><dd><dl><dt><span class="section"><a href="#new-groovy">Groovy Support</a></span></dt><dt><span class="section"><a href="#new-map-transformer">Map Transformers</a></span></dt><dt><span class="section"><a href="#new-json-transformer">JSON Transformers</a></span></dt><dt><span class="section"><a href="#new-serialize-transformer">Serialization Transformers</a></span></dt></dl></dd><dt><span class="section"><a href="#new-refactoring">H.9.5. Framework Refactoring</a></span></dt><dt><span class="section"><a href="#new-infrastructure">H.9.6. New Source Control Management and Build Infrastructure</a></span></dt><dt><span class="section"><a href="#new-samples">H.9.7. New Spring Integration Samples</a></span></dt><dt><span class="section"><a href="#new-sts">H.9.8. Spring Tool Suite Visual Editor for Spring Integration</a></span></dt></dl></dd></dl></dd></dl></dd></dl></div>

<div class="part"><div class="titlepage"><div><div><h1 class="title"><a name="preface" href="#preface"></a>Part&nbsp;I.&nbsp;Preface</h1></div></div></div>

<div class="preface"><div class="titlepage"><div><div><h2 class="title"><a name="system-requirements" href="#system-requirements"></a>Requirements</h2></div></div></div>

<p>This section details the compatible <a class="ulink" href="http://www.oracle.com/technetwork/java/javase/downloads/index.html" target="_top">Java</a> and <a class="ulink" href="http://www.springsource.org/spring-framework" target="_top">Spring Framework</a> versions.</p>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="supported-java-versions" href="#supported-java-versions"></a>1&nbsp;Compatible Java Versions</h2></div></div></div>

<p>For <span class="emphasis"><em>Spring Integration</em></span> <span class="strong"><strong>4.3.x</strong></span>, the <span class="strong"><strong>minimum</strong></span> compatible Java version is <span class="strong"><strong>Java SE 6</strong></span>.
Older versions of Java are not supported.</p>
<p><span class="emphasis"><em>Spring Integration</em></span> <span class="strong"><strong>4.3.x</strong></span> is also compatible with <span class="strong"><strong>Java SE 7</strong></span> as well as <span class="strong"><strong>Java SE 8</strong></span>.</p>
<p>Certain features (such as <code class="literal">Optional&lt;?&gt;</code> payloads and <code class="literal">CompletableFuture</code> gateway method return types) require Java 8.</p>
<p>While the jars are compatible with Java 6, Java 8 is required to build the project.
see <a class="ulink" href="https://github.com/spring-projects/spring-integration#checking-out-and-building" target="_top">Checking out and Building</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="supported-spring-versions" href="#supported-spring-versions"></a>2&nbsp;Compatible Versions of the Spring Framework</h2></div></div></div>

<p><span class="emphasis"><em>Spring Integration</em></span> <span class="strong"><strong>4.3.x</strong></span> requires <span class="emphasis"><em>Spring Framework</em></span> <span class="strong"><strong>4.3</strong></span> or later.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="code-conventions" href="#code-conventions"></a>3&nbsp;Code Conventions</h2></div></div></div>

<p>The Spring Framework 2.0 introduced support for namespaces, which simplifies the XML configuration of the application context, and consequently Spring Integration provides broad namespace support.
This reference guide applies the following conventions for all code examples that use namespace support:</p>
<p>The <span class="strong"><strong>int</strong></span> namespace prefix will be used for Spring Integration&#8217;s core namespace support.
Each Spring Integration adapter type (module) will provide its own namespace, which is configured using the following convention:</p>
<p><span class="strong"><strong>int-</strong></span> followed by the name of the module, e.g.
<span class="strong"><strong>int-twitter</strong></span>, <span class="strong"><strong>int-stream</strong></span>, &#8230;</p>
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
  <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
  <span class="hl-attribute">xmlns:int</span>=<span class="hl-value">"http://www.springframework.org/schema/integration"</span>
  <span class="hl-attribute">xmlns:int-twitter</span>=<span class="hl-value">"http://www.springframework.org/schema/integration/twitter"</span>
  <span class="hl-attribute">xmlns:int-stream</span>=<span class="hl-value">"http://www.springframework.org/schema/integration/stream"</span>
  <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"
   http://www.springframework.org/schema/beans
   http://www.springframework.org/schema/beans/spring-beans.xsd
   http://www.springframework.org/schema/integration
   http://www.springframework.org/schema/integration/spring-integration.xsd
   http://www.springframework.org/schema/integration/twitter
   http://www.springframework.org/schema/integration/twitter/spring-integration-twitter.xsd
   http://www.springframework.org/schema/integration/stream
   http://www.springframework.org/schema/integration/stream/spring-integration-stream.xsd"</span><span class="hl-tag">&gt;</span>
&#8230;
<span class="hl-tag">&lt;/beans&gt;</span></pre>
<p>For a detailed explanation regarding Spring Integration&#8217;s namespace support see <span class="emphasis"><em><a class="xref" href="#configuration-namespace" title="F.2&nbsp;Namespace Support">Section&nbsp;F.2, &#8220;Namespace Support&#8221;</a></em></span>.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Please note that the namespace prefix can be freely chosen.
You may even choose not to use any namespace prefixes at all.
Therefore, apply the convention that suits your application needs best.
Be aware, though, that SpringSource Tool Suite&#8482; (STS) uses the same namespace conventions for Spring Integration as used in this reference guide.</p>
</td></tr></table></div>
</div>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="_conventions_in_this_book" href="#_conventions_in_this_book"></a>1.&nbsp;Conventions in this Book</h2></div></div></div>

<p>In some cases, to aid formatting, when specifying long fully-qualified class names, we shorten
the package <code class="literal">org.springframework</code> to <code class="literal">o.s</code> and <code class="literal">org.springframework.integration</code> to <code class="literal">o.s.i</code>, such as with
<code class="literal">o.s.i.transaction.TransactionSynchronizationFactory</code>.</p>
</div>
</div>
<div class="part"><div class="titlepage"><div><div><h1 class="title"><a name="whats-new-part" href="#whats-new-part"></a>Part&nbsp;II.&nbsp;What&#8217;s new?</h1></div></div></div>

<div class="partintro"><div></div>
<p>For those who are already familiar with Spring Integration, this chapter provides a brief overview of the new features of version 4.3.
If you are interested in the changes and features, that were introduced in earlier versions, please see chapter: <a class="xref" href="#history" title="Appendix&nbsp;H.&nbsp;Change History">Appendix&nbsp;H, <i>Change History</i></a></p>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="whats-new" href="#whats-new"></a>2.&nbsp;What&#8217;s new in Spring Integration 4.3?</h2></div></div></div>

<p>This chapter provides an overview of the new features and improvements that have been introduced with Spring
Integration 4.3.
If you are interested in more details, please see the Issue Tracker tickets that were resolved as part of the 4.3
development process.</p>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="x4.3-new-components" href="#x4.3-new-components"></a>2.1&nbsp;New Components</h2></div></div></div>

<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_amqp_async_outbound_gateway" href="#_amqp_async_outbound_gateway"></a>2.1.1&nbsp;AMQP Async Outbound Gateway</h3></div></div></div>

<p>See <a class="xref" href="#amqp-async-outbound-gateway" title="11.7&nbsp;Async Outbound Gateway">Section&nbsp;11.7, &#8220;Async Outbound Gateway&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_messagegroupfactory" href="#_messagegroupfactory"></a>2.1.2&nbsp;MessageGroupFactory</h3></div></div></div>

<p>The new <code class="literal">MessageGroupFactory</code> strategy has been introduced to allow a control over <code class="literal">MessageGroup</code> instances
in <code class="literal">MessageGroupStore</code> logic.
The <code class="literal">SimpleMessageGroupFactory</code> is provided for the <code class="literal">SimpleMessageGroup</code> with the <code class="literal">GroupType.HASH_SET</code> as the default
factory for the standard <code class="literal">MessageGroupStore</code> implementations.
See <a class="xref" href="#message-store" title="9.4&nbsp;Message Store">Section&nbsp;9.4, &#8220;Message Store&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_persistentmessagegroup" href="#_persistentmessagegroup"></a>2.1.3&nbsp;PersistentMessageGroup</h3></div></div></div>

<p>The <code class="literal">PersistentMessageGroup</code>, - lazy-load proxy, - implementation is provided for persistent <code class="literal">MessageGroupStore</code> s,
which return this instance for the <code class="literal">getMessageGroup()</code> when their <code class="literal">lazyLoadMessageGroups</code> is <code class="literal">true</code> (defaults).
See <a class="xref" href="#message-store" title="9.4&nbsp;Message Store">Section&nbsp;9.4, &#8220;Message Store&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_ftp_sftp_streaming_inbound_channel_adapters" href="#_ftp_sftp_streaming_inbound_channel_adapters"></a>2.1.4&nbsp;FTP/SFTP Streaming Inbound Channel Adapters</h3></div></div></div>

<p>New inbound channel adapters are provided that return an <code class="literal">InputStream</code> for each file allowing you to retrieve remote
files without writing them to the local file system
See <a class="xref" href="#ftp-streaming" title="15.5&nbsp;FTP Streaming Inbound Channel Adapter">Section&nbsp;15.5, &#8220;FTP Streaming Inbound Channel Adapter&#8221;</a> and <a class="xref" href="#sftp-streaming" title="27.8&nbsp;SFTP Streaming Inbound Channel Adapter">Section&nbsp;27.8, &#8220;SFTP Streaming Inbound Channel Adapter&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_stream_transformer" href="#_stream_transformer"></a>2.1.5&nbsp;Stream Transformer</h3></div></div></div>

<p>A new <code class="literal">StreamTransformer</code> is provided to transform an <code class="literal">InputStream</code> payload to either a <code class="literal">byte[]</code> or <code class="literal">String</code>.
See <a class="xref" href="#stream-transformer" title="Stream Transformer">the section called &#8220;Stream Transformer&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_integration_graph" href="#_integration_graph"></a>2.1.6&nbsp;Integration Graph</h3></div></div></div>

<p>A new <code class="literal">IntegrationGraphServer</code> together with the <code class="literal">IntegrationGraphController</code> REST service are provided to expose the runtime model of a Spring Integration application as a graph.
See <a class="xref" href="#integration-graph" title="9.8&nbsp;Integration Graph">Section&nbsp;9.8, &#8220;Integration Graph&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_jdbc_lock_registry" href="#_jdbc_lock_registry"></a>2.1.7&nbsp;JDBC Lock Registry</h3></div></div></div>

<p>A new <code class="literal">JdbcLockRegistry</code> is provided for distributed locks shared through the data base table.
See <a class="xref" href="#jdbc-lock-registry" title="18.6&nbsp;JDBC Lock Registry">Section&nbsp;18.6, &#8220;JDBC Lock Registry&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_leader_initiator_for_lock_registry" href="#_leader_initiator_for_lock_registry"></a>2.1.8&nbsp;Leader Initiator for Lock Registry</h3></div></div></div>

<p>A new <code class="literal">LeaderInitiator</code> implementation is provided based on the <code class="literal">LockRegistry</code> strategy.
See <a class="xref" href="#leadership-event-handling" title="8.3&nbsp;Leadership Event Handling">Section&nbsp;8.3, &#8220;Leadership Event Handling&#8221;</a> for more information.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="x4.3-general" href="#x4.3-general"></a>2.2&nbsp;General Changes</h2></div></div></div>

<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_core_changes" href="#_core_changes"></a>2.2.1&nbsp;Core Changes</h3></div></div></div>

<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_outbound_gateway_within_chain" href="#_outbound_gateway_within_chain"></a>Outbound Gateway within Chain</h4></div></div></div>

<p>Previously, it was possible to specify a <code class="literal">reply-channel</code> on an outbound gateway within a chain.
It was completely ignored; the gateway&#8217;s reply goes to the next chain element, or to the chain&#8217;s output channel
if the gateway is the last element.
This condition is now detected and disallowed.
If you have such configuration, simply remove the <code class="literal">reply-channel</code>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_async_service_activator" href="#_async_service_activator"></a>Async Service Activator</h4></div></div></div>

<p>An option to make the Service Asynchronous has been added.
See <a class="xref" href="#async-service-activator" title="8.5.3&nbsp;Asynchronous Service Activator">Section&nbsp;8.5.3, &#8220;Asynchronous Service Activator&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_messaging_annotation_support_changes" href="#_messaging_annotation_support_changes"></a>Messaging Annotation Support changes</h4></div></div></div>

<p>The Messaging Annotation Support doesn&#8217;t require any more <code class="literal">@MessageEndpoint</code> (or any other <code class="literal">@Component</code>) annotation
declaration on the class level.
To restore the previous behaviour specify the <code class="literal">spring.integration.messagingAnnotations.require.componentAnnotation</code> of
<code class="literal">spring.integration.properties</code> as <code class="literal">true</code>.
See <a class="xref" href="#global-properties" title="F.5&nbsp;Global Properties">Section&nbsp;F.5, &#8220;Global Properties&#8221;</a> and <a class="xref" href="#annotations" title="F.6&nbsp;Annotation Support">Section&nbsp;F.6, &#8220;Annotation Support&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_lifecycle_role_controller" href="#_lifecycle_role_controller"></a>Lifecycle Role Controller</h4></div></div></div>

<p>The <code class="literal">SmartLifecycleRoleController</code> now provides methods to obtain status of endpoints in roles.
See <a class="xref" href="#endpoint-roles" title="8.2&nbsp;Endpoint Roles">Section&nbsp;8.2, &#8220;Endpoint Roles&#8221;</a> for more information.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_mail_changes" href="#_mail_changes"></a>2.2.2&nbsp;Mail Changes</h3></div></div></div>

<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_customizable_user_flag" href="#_customizable_user_flag"></a>Customizable User Flag</h4></div></div></div>

<p>The customizable <code class="literal">userFlag</code> added in 4.2.2 to provide customization of the flag used to denote that the mail has been
seen is now available using the XML namespace.
See <a class="xref" href="#imap-seen" title="21.5&nbsp;Marking IMAP Messages When \Recent is Not Supported">Section&nbsp;21.5, &#8220;Marking IMAP Messages When \Recent is Not Supported&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_mail_message_mapping" href="#_mail_message_mapping"></a>Mail Message Mapping</h4></div></div></div>

<p>There is now an option to map inbound mail messages with the <code class="literal">MessageHeaders</code> containing the mail headers and the
payload containing the email content.
Previously, the payload was always the raw <code class="literal">MimeMessage</code>.
See <a class="xref" href="#mail-mapping" title="21.3&nbsp;Inbound Mail Message Mapping">Section&nbsp;21.3, &#8220;Inbound Mail Message Mapping&#8221;</a> for more information.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_jms_changes" href="#_jms_changes"></a>2.2.3&nbsp;JMS Changes</h3></div></div></div>

<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_header_mapper" href="#_header_mapper"></a>Header Mapper</h4></div></div></div>

<p>The <code class="literal">DefaultJmsHeaderMapper</code> now maps the standard <code class="literal">correlationId</code> header as a message property by invoking its
<code class="literal">toString()</code> method.
See <a class="xref" href="#jms-header-mapping" title="20.6&nbsp;Mapping Message Headers to/from JMS Message">Section&nbsp;20.6, &#8220;Mapping Message Headers to/from JMS Message&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_async_gateway" href="#_async_gateway"></a>Async Gateway</h4></div></div></div>

<p>The JMS Outbound gateway now has an <code class="literal">async</code> property.
See <a class="xref" href="#jms-async-gateway" title="20.5.2&nbsp;Async Gateway">Section&nbsp;20.5.2, &#8220;Async Gateway&#8221;</a> for more information.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_aggregator_changes" href="#_aggregator_changes"></a>2.2.4&nbsp;Aggregator Changes</h3></div></div></div>

<p>There is a change in behavior when a POJO aggregator releases a collection of <code class="literal">Message&lt;?&gt;</code> objects; this is rare but if
your application does that, you will need to make a small change to your POJO. See this <a class="xref" href="#agg-message-collection" title="Important">Important</a> note
for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_tcp_udp_changes" href="#_tcp_udp_changes"></a>2.2.5&nbsp;TCP/UDP Changes</h3></div></div></div>

<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_events" href="#_events"></a>Events</h4></div></div></div>

<p>A new <code class="literal">TcpConnectionServerListeningEvent</code> is emitted when a server connection factory is started.
See <a class="xref" href="#tcp-events" title="31.5&nbsp;TCP Connection Events">Section&nbsp;31.5, &#8220;TCP Connection Events&#8221;</a> for more information.</p>
<p>The <code class="literal">destination-expression</code> and <code class="literal">socket-expression</code> are now available for the <code class="literal">&lt;int-ip:udp-outbound-channel-adapter&gt;</code>.
See <a class="xref" href="#udp-adapters" title="31.2&nbsp;UDP Adapters">Section&nbsp;31.2, &#8220;UDP Adapters&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_stream_deserializers" href="#_stream_deserializers"></a>Stream Deserializers</h4></div></div></div>

<p>The various deserializers that can&#8217;t allocate the final buffer until the whole message has been assembled now support
pooling of the raw buffer into which the data is received, rather than creating and discarding a buffer for each
message.
See <a class="xref" href="#connection-factories" title="31.3&nbsp;TCP Connection Factories">Section&nbsp;31.3, &#8220;TCP Connection Factories&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_tcp_message_mapper" href="#_tcp_message_mapper"></a>TCP Message Mapper</h4></div></div></div>

<p>The message mapper now, optionally, sets a configured content type header.
See <a class="xref" href="#ip-msg-headers" title="31.13&nbsp;IP Message Headers">Section&nbsp;31.13, &#8220;IP Message Headers&#8221;</a> for more information.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_file_changes" href="#_file_changes"></a>2.2.6&nbsp;File Changes</h3></div></div></div>

<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_destination_directory_creation" href="#_destination_directory_creation"></a>Destination Directory Creation</h4></div></div></div>

<p>The generated file name for the <code class="literal">FileWritingMessageHandler</code> can represent <span class="emphasis"><em>sub-path</em></span> to save the desired directory
structure for file in the target directory.
See <a class="xref" href="#file-writing-file-names" title="14.3.1&nbsp;Generating File Names">Section&nbsp;14.3.1, &#8220;Generating File Names&#8221;</a> for more information.</p>
<p>The <code class="literal">FileReadingMessageSource</code> now hides the <code class="literal">WatchService</code> directory scanning logic in the inner class.
The <code class="literal">use-watch-service</code> and <code class="literal">watch-events</code> options are provided to enable such a behaviour.
The top level <code class="literal">WatchServiceDirectoryScanner</code> has been deprecated because of inconsistency around API.
See <a class="xref" href="#watch-service-directory-scanner" title="14.2.2&nbsp;WatchServiceDirectoryScanner">Section&nbsp;14.2.2, &#8220;WatchServiceDirectoryScanner&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_buffer_size" href="#_buffer_size"></a>Buffer Size</h4></div></div></div>

<p>When writing files, you can now specify the buffer size to use.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_appending_and_flushing" href="#_appending_and_flushing"></a>Appending and Flushing</h4></div></div></div>

<p>You can now avoid flushing files when appending and use a number of strategies to flush the data during idle periods.
See <a class="xref" href="#file-flushing" title="14.3.4&nbsp;Flushing Files When using APPEND_NO_FLUSH">Section&nbsp;14.3.4, &#8220;Flushing Files When using APPEND_NO_FLUSH&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_preserving_timestamps" href="#_preserving_timestamps"></a>Preserving Timestamps</h4></div></div></div>

<p>The outbound channel adapter can now be configured to set the destination file&#8217;s <code class="literal">lastmodified</code> timestamp.
See <a class="xref" href="#file-timestamps" title="14.3.5&nbsp;File Timestamps">Section&nbsp;14.3.5, &#8220;File Timestamps&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_splitter_changes" href="#_splitter_changes"></a>Splitter Changes</h4></div></div></div>

<p>The <code class="literal">FileSplitter</code> will now automatically close an (S)FTP session when the file is completely read.
This applies when the outbound gateway returns an <code class="literal">InputStream</code> or the new (S)FTP streaming channel adapters are being used.
Also a new <code class="literal">markers-json</code> options has been introduced to convert <code class="literal">FileSplitter.FileMarker</code> to JSON <code class="literal">String</code> for relaxed downstream network interaction.
See <a class="xref" href="#file-splitter" title="14.5&nbsp;File Splitter">Section&nbsp;14.5, &#8220;File Splitter&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_file_filters" href="#_file_filters"></a>File Filters</h4></div></div></div>

<p>A new <code class="literal">ChainFileListFilter</code> is provided as an alternative to <code class="literal">CompositeFileListFilter</code>.
See <a class="xref" href="#file-reading" title="14.2&nbsp;Reading Files">Section&nbsp;14.2, &#8220;Reading Files&#8221;</a> for more information.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_amqp_changes" href="#_amqp_changes"></a>2.2.7&nbsp;AMQP Changes</h3></div></div></div>

<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_content_type_message_converter" href="#_content_type_message_converter"></a>Content Type Message Converter</h4></div></div></div>

<p>The outbound endpoints now support a <code class="literal">RabbitTemplate</code> configured with a <code class="literal">ContentTypeDelegatingMessageConverter</code> such
that the converter can be chosen based on the message content type.
See <a class="xref" href="#content-type-conversion-outbound" title="11.8&nbsp;Outbound Message Conversion">Section&nbsp;11.8, &#8220;Outbound Message Conversion&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_headers_for_delayed_message_handling" href="#_headers_for_delayed_message_handling"></a>Headers for Delayed Message Handling</h4></div></div></div>

<p>Spring AMQP 1.6 adds support for
<a class="ulink" href="https://www.rabbitmq.com/blog/2015/04/16/scheduling-messages-with-rabbitmq/" target="_top">Delayed Message Exchanges</a>.
Header mapping now supports the headers (<code class="literal">amqp_delay</code> and <code class="literal">amqp_receivedDelay</code>) used by this feature.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_amqp_backed_channels" href="#_amqp_backed_channels"></a>AMQP-Backed Channels</h4></div></div></div>

<p>AMQP-backed channels now support message mapping.
See <a class="xref" href="#amqp-channels" title="11.11&nbsp;AMQP Backed Message Channels">Section&nbsp;11.11, &#8220;AMQP Backed Message Channels&#8221;</a> for more information.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_redis_changes" href="#_redis_changes"></a>2.2.8&nbsp;Redis Changes</h3></div></div></div>

<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_list_push_pop_direction" href="#_list_push_pop_direction"></a>List Push/Pop Direction</h4></div></div></div>

<p>Previously, the queue channel adapters always used the Redis List in a fixed direction,
pushing to the left end and reading from the right end.
It is now possible to configure the reading and writing direction using <code class="literal">rightPop</code> and <code class="literal">leftPush</code> options for the
<code class="literal">RedisQueueMessageDrivenEndpoint</code> and <code class="literal">RedisQueueOutboundChannelAdapter</code> respectively.
See <a class="xref" href="#redis-queue-inbound-channel-adapter" title="24.3.4&nbsp;Redis Queue Inbound Channel Adapter">Section&nbsp;24.3.4, &#8220;Redis Queue Inbound Channel Adapter&#8221;</a> and <a class="xref" href="#redis-queue-outbound-channel-adapter" title="24.3.5&nbsp;Redis Queue Outbound Channel Adapter">Section&nbsp;24.3.5, &#8220;Redis Queue Outbound Channel Adapter&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_queue_inbound_gateway_default_serializer" href="#_queue_inbound_gateway_default_serializer"></a>Queue Inbound Gateway Default Serializer</h4></div></div></div>

<p>The default serializer in the inbound gateway has been changed to a <code class="literal">JdkSerializationRedisSerializer</code> for compatibility
with the outbound gateway.
See <a class="xref" href="#redis-queue-inbound-gateway" title="24.10&nbsp;Redis Queue Inbound Gateway">Section&nbsp;24.10, &#8220;Redis Queue Inbound Gateway&#8221;</a> for more information.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_http_changes" href="#_http_changes"></a>2.2.9&nbsp;HTTP Changes</h3></div></div></div>

<p>Previously, with requests that had a body (such as <code class="literal">POST</code>) that had no <code class="literal">content-type</code> header, the body was ignored.
With this release, the content type of such requests is considered to be <code class="literal">application/octet-stream</code> as recommended
by RFC 2616.
See <a class="xref" href="#http-inbound" title="17.2&nbsp;Http Inbound Components">Section&nbsp;17.2, &#8220;Http Inbound Components&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_sftp_changes" href="#_sftp_changes"></a>2.2.10&nbsp;SFTP Changes</h3></div></div></div>

<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_factory_bean" href="#_factory_bean"></a>Factory Bean</h4></div></div></div>

<p>A new factory bean is provided to simplify the configuration of Jsch proxies for SFTP.
See <a class="xref" href="#sftp-proxy-factory-bean" title="27.3&nbsp;Proxy Factory Bean">Section&nbsp;27.3, &#8220;Proxy Factory Bean&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_inbound_channel_adapter" href="#_inbound_channel_adapter"></a>Inbound Channel Adapter</h4></div></div></div>

<p>The inbound channel adapter is now configured with a <code class="literal">FileSystemPersistentAcceptOnceFileListFilter</code> in the <code class="literal">local-filter</code> by default.
See <a class="xref" href="#sftp-inbound" title="27.7&nbsp;SFTP Inbound Channel Adapter">Section&nbsp;27.7, &#8220;SFTP Inbound Channel Adapter&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_chmod" href="#_chmod"></a>chmod</h4></div></div></div>

<p>The SFTP outbound gateway (for <code class="literal">put</code> and <code class="literal">mput</code> commands) and the SFTP outbound channel adapter now support the
<code class="literal">chmod</code> attribute to change the remote file permissions after uploading.
See <a class="xref" href="#sftp-outbound" title="27.9&nbsp;SFTP Outbound Channel Adapter">Section&nbsp;27.9, &#8220;SFTP Outbound Channel Adapter&#8221;</a> and <a class="xref" href="#sftp-outbound-gateway" title="27.10&nbsp;SFTP Outbound Gateway">Section&nbsp;27.10, &#8220;SFTP Outbound Gateway&#8221;</a> for more information.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_ftp_changes" href="#_ftp_changes"></a>2.2.11&nbsp;FTP Changes</h3></div></div></div>

<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_session_changes" href="#_session_changes"></a>Session Changes</h4></div></div></div>

<p>The <code class="literal">FtpSession</code> now supports <code class="literal">null</code> for the <code class="literal">list()</code> and <code class="literal">listNames()</code> method, since it is possible by the
underlying FTP Client.
With that the <code class="literal">FtpOutboundGateway</code> can now be configured without <code class="literal">remoteDirectory</code> expression.
And the <code class="literal">&lt;int-ftp:inbound-channel-adapter&gt;</code> can be configured without <code class="literal">remote-directory</code>/<code class="literal">remote-directory-expression</code>.
See <a class="xref" href="#ftp" title="15.&nbsp;FTP/FTPS Adapters">Chapter&nbsp;15, <i>FTP/FTPS Adapters</i></a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_inbound_channel_adapter_2" href="#_inbound_channel_adapter_2"></a>Inbound Channel Adapter</h4></div></div></div>

<p>The inbound channel adapter is now configured with a <code class="literal">FileSystemPersistentAcceptOnceFileListFilter</code> in the <code class="literal">local-filter</code> by default.
See <a class="xref" href="#ftp-inbound" title="15.4&nbsp;FTP Inbound Channel Adapter">Section&nbsp;15.4, &#8220;FTP Inbound Channel Adapter&#8221;</a> for more information.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_router_changes" href="#_router_changes"></a>2.2.12&nbsp;Router Changes</h3></div></div></div>

<p>The <code class="literal">ErrorMessageExceptionTypeRouter</code> supports now the <code class="literal">Exception</code> superclass mappings to avoid duplication
for the same channel in case of several inheritors.
For this purpose the <code class="literal">ErrorMessageExceptionTypeRouter</code> loads mapping classes during initialization to fail-fast
for a <code class="literal">ClassNotFoundException</code>.</p>
<p>See <a class="xref" href="#router" title="6.1&nbsp;Routers">Section&nbsp;6.1, &#8220;Routers&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_header_mapping" href="#_header_mapping"></a>2.2.13&nbsp;Header Mapping</h3></div></div></div>

<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_general" href="#_general"></a>General</h4></div></div></div>

<p>AMQP, WS and XMPP header mappings (e.g. <code class="literal">request-header-mapping</code>, <code class="literal">reply-header-mapping</code>) now support negated
patterns.
See <a class="xref" href="#amqp-message-headers" title="11.12&nbsp;AMQP Message Headers">Section&nbsp;11.12, &#8220;AMQP Message Headers&#8221;</a>, <a class="xref" href="#ws-message-headers" title="34.5&nbsp;WS Message Headers">Section&nbsp;34.5, &#8220;WS Message Headers&#8221;</a>, and <a class="xref" href="#xmpp-message-headers" title="36.6&nbsp;XMPP Message Headers">Section&nbsp;36.6, &#8220;XMPP Message Headers&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_amqp_header_mapping" href="#_amqp_header_mapping"></a>AMQP Header Mapping</h4></div></div></div>

<p>Previously, only standard AMQP headers were mapped by default; users had to explicitly enable mapping of user-defined
headers.
With this release all headers are mapped by default.
In addition, the inbound <code class="literal">amqp_deliveryMode</code> header is no longer mapped by default.
See <a class="xref" href="#amqp-message-headers" title="11.12&nbsp;AMQP Message Headers">Section&nbsp;11.12, &#8220;AMQP Message Headers&#8221;</a> for more information.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_groovy_scripts" href="#_groovy_scripts"></a>2.2.14&nbsp;Groovy Scripts</h3></div></div></div>

<p>Groovy scripts can now be configured with the <code class="literal">compile-static</code> hint or any other <code class="literal">CompilerConfiguration</code> options.
See <a class="xref" href="#groovy-config" title="8.8.1&nbsp;Groovy configuration">Section&nbsp;8.8.1, &#8220;Groovy configuration&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="__inboundchanneladapter" href="#__inboundchanneladapter"></a>2.2.15&nbsp;@InboundChannelAdapter</h3></div></div></div>

<p>The <code class="literal">@InboundChannelAdapter</code> has now an alias <code class="literal">channel</code> attribute for regular <code class="literal">value</code>.
In addition the target <code class="literal">SourcePollingChannelAdapter</code> components can now resolve the target <code class="literal">outputChannel</code> bean
from its provided name (<code class="literal">outputChannelName</code> options) in late-binding manner.
See <a class="xref" href="#annotations" title="F.6&nbsp;Annotation Support">Section&nbsp;F.6, &#8220;Annotation Support&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_xmpp_changes" href="#_xmpp_changes"></a>2.2.16&nbsp;XMPP changes</h3></div></div></div>

<p>The XMPP Extensions (XEP) are now supported by the XMPP channel adapters.
See <a class="xref" href="#xmpp-extensions" title="36.7&nbsp;XMPP Extensions">Section&nbsp;36.7, &#8220;XMPP Extensions&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_wiretap_late_binding" href="#_wiretap_late_binding"></a>2.2.17&nbsp;WireTap Late Binding</h3></div></div></div>

<p>The <code class="literal">WireTap</code> <code class="literal">ChannelInterceptor</code> now can accept a <code class="literal">channelName</code> which is resolved to the target <code class="literal">MessageChannel</code>
later, during the first active interceptor operation.
See <a class="xref" href="#channel-wiretap" title="Wire Tap">the section called &#8220;Wire Tap&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_channelmessagestorequeryprovider" href="#_channelmessagestorequeryprovider"></a>2.2.18&nbsp;ChannelMessageStoreQueryProvider</h3></div></div></div>

<p>The <code class="literal">ChannelMessageStoreQueryProvider</code> now supports H2 database.
See <a class="xref" href="#jdbc-message-store-channels" title="18.4.2&nbsp;Backing Message Channels">Section&nbsp;18.4.2, &#8220;Backing Message Channels&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_websocket_changes" href="#_websocket_changes"></a>2.2.19&nbsp;WebSocket Changes</h3></div></div></div>

<p>The <code class="literal">ServerWebSocketContainer</code> now exposes <code class="literal">allowedOrigins</code> option and <code class="literal">SockJsServiceOptions</code> a <code class="literal">suppressCors</code> option.
See <a class="xref" href="#web-sockets" title="33.&nbsp;WebSockets Support">Chapter&nbsp;33, <i>WebSockets Support</i></a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_barrier_changes" href="#_barrier_changes"></a>2.2.20&nbsp;Barrier Changes</h3></div></div></div>

<p>The <code class="literal">BarrierMessageHandler</code> now supports a discard channel to which late-arriving trigger messages are sent.
See <a class="xref" href="#barrier" title="6.8&nbsp;Thread Barrier">Section&nbsp;6.8, &#8220;Thread Barrier&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_amqp_changes_2" href="#_amqp_changes_2"></a>2.2.21&nbsp;AMQP Changes</h3></div></div></div>

<p>The AMQP outbound endpoints now support setting a delay expression for when using the RabbitMQ Delayed Message Exchange plugin.
See <a class="xref" href="#amqp-delay" title="11.10&nbsp;Delayed Message Exchange">Section&nbsp;11.10, &#8220;Delayed Message Exchange&#8221;</a> for more information.</p>
</div>
</div>
</div>
</div>
<div class="part"><div class="titlepage"><div><div><h1 class="title"><a name="spring-integration-introduction" href="#spring-integration-introduction"></a>Part&nbsp;III.&nbsp;Overview of Spring Integration Framework</h1></div></div></div>

<div class="partintro"><div></div>
<p>Spring Integration provides an extension of the Spring programming model to support the well-known <a class="ulink" href="http://www.eaipatterns.com/" target="_top">Enterprise Integration Patterns</a>.
It enables lightweight messaging <span class="emphasis"><em>within</em></span> Spring-based applications and supports integration with external systems via declarative adapters.
Those adapters provide a higher-level of abstraction over Spring&#8217;s support for remoting, messaging, and scheduling.
Spring Integration&#8217;s primary goal is to provide a simple model for building enterprise integration solutions while maintaining the separation of concerns that is essential for producing maintainable, testable code.</p>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="overview" href="#overview"></a>3.&nbsp;Spring Integration Overview</h2></div></div></div>

<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="overview-background" href="#overview-background"></a>3.1&nbsp;Background</h2></div></div></div>

<p>One of the key themes of the Spring Framework is <span class="emphasis"><em>inversion of control</em></span>.
In its broadest sense, this means that the framework handles responsibilities on behalf of the components that are managed within its context.
The components themselves are simplified since they are relieved of those responsibilities.
For example, <span class="emphasis"><em>dependency injection</em></span> relieves the components of the responsibility of locating or creating their dependencies.
Likewise, <span class="emphasis"><em>aspect-oriented programming</em></span> relieves business components of generic cross-cutting concerns by modularizing them into reusable aspects.
In each case, the end result is a system that is easier to test, understand, maintain, and extend.</p>
<p>Furthermore, the Spring framework and portfolio provide a comprehensive programming model for building enterprise applications.
Developers benefit from the consistency of this model and especially the fact that it is based upon well-established best practices such as programming to interfaces and favoring composition over inheritance.
Spring&#8217;s simplified abstractions and powerful support libraries boost developer productivity while simultaneously increasing the level of testability and portability.</p>
<p>Spring Integration is motivated by these same goals and principles.
It extends the Spring programming model into the messaging domain and builds upon Spring&#8217;s existing enterprise integration support to provide an even higher level of abstraction.
It supports message-driven architectures where inversion of control applies to runtime concerns, such as <span class="emphasis"><em>when</em></span> certain business logic should execute and <span class="emphasis"><em>where</em></span> the response should be sent.
It supports routing and transformation of messages so that different transports and different data formats can be integrated without impacting testability.
In other words, the messaging and integration concerns are handled by the framework, so business components are further isolated from the infrastructure and developers are relieved of complex integration responsibilities.</p>
<p>As an extension of the Spring programming model, Spring Integration provides a wide variety of configuration options including annotations, XML with namespace support, XML with generic "bean" elements, and of course direct usage of the underlying API.
That API is based upon well-defined strategy interfaces and non-invasive, delegating adapters.
Spring Integration&#8217;s design is inspired by the recognition of a strong affinity between common patterns within Spring and the well-known <a class="ulink" href="http://www.eaipatterns.com" target="_top">Enterprise Integration Patterns</a> as described in the book of the same name by Gregor Hohpe and Bobby Woolf (Addison Wesley, 2004).
Developers who have read that book should be immediately comfortable with the Spring Integration concepts and terminology.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="overview-goalsandprinciples" href="#overview-goalsandprinciples"></a>3.2&nbsp;Goals and Principles</h2></div></div></div>

<p>Spring Integration is motivated by the following goals:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Provide a simple model for implementing complex enterprise integration solutions.
</li><li class="listitem">
Facilitate asynchronous, message-driven behavior within a Spring-based application.
</li><li class="listitem">
Promote intuitive, incremental adoption for existing Spring users.
</li></ul></div>
<p>Spring Integration is guided by the following principles:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Components should be <span class="emphasis"><em>loosely coupled</em></span> for modularity and testability.
</li><li class="listitem">
The framework should enforce <span class="emphasis"><em>separation of concerns</em></span> between business logic and integration logic.
</li><li class="listitem">
Extension points should be abstract in nature but within well-defined boundaries to promote <span class="emphasis"><em>reuse</em></span> and <span class="emphasis"><em>portability</em></span>.
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="overview-components" href="#overview-components"></a>3.3&nbsp;Main Components</h2></div></div></div>

<p>From the <span class="emphasis"><em>vertical</em></span> perspective, a layered architecture facilitates separation of concerns, and interface-based contracts between layers promote loose coupling.
Spring-based applications are typically designed this way, and the Spring framework and portfolio provide a strong foundation for following this best practice for the full-stack of an enterprise application.
Message-driven architectures add a <span class="emphasis"><em>horizontal</em></span> perspective, yet these same goals are still relevant.
Just as "layered architecture" is an extremely generic and abstract paradigm, messaging systems typically follow the similarly abstract "pipes-and-filters" model.
The "filters" represent any component that is capable of producing and/or consuming messages, and the "pipes" transport the messages between filters so that the components themselves remain loosely-coupled.
It is important to note that these two high-level paradigms are not mutually exclusive.
The underlying messaging infrastructure that supports the "pipes" should still be encapsulated in a layer whose contracts are defined as interfaces.
Likewise, the "filters" themselves would typically be managed within a layer that is logically above the application&#8217;s service layer, interacting with those services through interfaces much in the same way that a web-tier would.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="overview-components-message" href="#overview-components-message"></a>3.3.1&nbsp;Message</h3></div></div></div>

<p>In Spring Integration, a Message is a generic wrapper for any Java object combined with metadata used by the framework while handling that object.
It consists of a payload and headers.
The payload can be of any type and the headers hold commonly required information such as id, timestamp, correlation id, and return address.
Headers are also used for passing values to and from connected transports.
For example, when creating a Message from a received File, the file name may be stored in a header to be accessed by downstream components.
Likewise, if a Message&#8217;s content is ultimately going to be sent by an outbound Mail adapter, the various properties (to, from, cc, subject, etc.) may be configured as Message header values by an upstream component.
Developers can also store any arbitrary key-value pairs in the headers.</p>
<div class="figure"><a name="d5e504" href="#d5e504"></a><p class="title"><b>Figure&nbsp;3.1.&nbsp;Message</b></p><div class="figure-contents">

<div class="mediaobject" align="center"><img src="images/message.jpg" align="middle" alt="Message"></div>
</div></div><br class="figure-break">
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="overview-components-channel" href="#overview-components-channel"></a>3.3.2&nbsp;Message Channel</h3></div></div></div>

<p>A Message Channel represents the "pipe" of a pipes-and-filters architecture.
Producers send Messages to a channel, and consumers receive Messages from a channel.
The Message Channel therefore decouples the messaging components, and also provides a convenient point for interception and monitoring of Messages.</p>
<div class="figure"><a name="d5e514" href="#d5e514"></a><p class="title"><b>Figure&nbsp;3.2.&nbsp;Message Channel</b></p><div class="figure-contents">

<div class="mediaobject" align="center"><img src="images/channel.jpg" align="middle" alt="Message Channel"></div>
</div></div><br class="figure-break">
<p>A Message Channel may follow either Point-to-Point or Publish/Subscribe semantics.
With a Point-to-Point channel, at most one consumer can receive each Message sent to the channel.
Publish/Subscribe channels, on the other hand, will attempt to broadcast each Message to all of its subscribers.
Spring Integration supports both of these.</p>
<p>Whereas "Point-to-Point" and "Publish/Subscribe" define the two options for <span class="emphasis"><em>how many</em></span> consumers will ultimately receive each Message, there is another important consideration: should the channel buffer messages? In Spring Integration, <span class="emphasis"><em>Pollable Channels</em></span> are capable of buffering Messages within a queue.
The advantage of buffering is that it allows for throttling the inbound Messages and thereby prevents overloading a consumer.
However, as the name suggests, this also adds some complexity, since a consumer can only receive the Messages from such a channel if a <span class="emphasis"><em>poller</em></span> is configured.
On the other hand, a consumer connected to a <span class="emphasis"><em>Subscribable Channel</em></span> is simply Message-driven.
The variety of channel implementations available in Spring Integration will be discussed in detail in <a class="xref" href="#channel-implementations" title="4.1.2&nbsp;Message Channel Implementations">Section&nbsp;4.1.2, &#8220;Message Channel Implementations&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="overview-components-endpoint" href="#overview-components-endpoint"></a>3.3.3&nbsp;Message Endpoint</h3></div></div></div>

<p>One of the primary goals of Spring Integration is to simplify the development of enterprise integration solutions through <span class="emphasis"><em>inversion of control</em></span>.
This means that you should not have to implement consumers and producers directly, and you should not even have to build Messages and invoke send or receive operations on a Message Channel.
Instead, you should be able to focus on your specific domain model with an implementation based on plain Objects.
Then, by providing declarative configuration, you can "connect" your domain-specific code to the messaging infrastructure provided by Spring Integration.
The components responsible for these connections are Message Endpoints.
This does not mean that you will necessarily connect your existing application code directly.
Any real-world enterprise integration solution will require some amount of code focused upon integration concerns such as <span class="emphasis"><em>routing</em></span> and <span class="emphasis"><em>transformation</em></span>.
The important thing is to achieve separation of concerns between such integration logic and business logic.
In other words, as with the Model-View-Controller paradigm for web applications, the goal should be to provide a thin but dedicated layer that translates inbound requests into service layer invocations, and then translates service layer return values into outbound replies.
The next section will provide an overview of the Message Endpoint types that handle these responsibilities, and in upcoming chapters, you will see how Spring Integration&#8217;s declarative configuration options provide a non-invasive way to use each of these.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="overview-endpoints" href="#overview-endpoints"></a>3.4&nbsp;Message Endpoints</h2></div></div></div>

<p>A Message Endpoint represents the "filter" of a pipes-and-filters architecture.
As mentioned above, the endpoint&#8217;s primary role is to connect application code to the messaging framework and to do so in a non-invasive manner.
In other words, the application code should ideally have no awareness of the Message objects or the Message Channels.
This is similar to the role of a Controller in the MVC paradigm.
Just as a Controller handles HTTP requests, the Message Endpoint handles Messages.
Just as Controllers are mapped to URL patterns, Message Endpoints are mapped to Message Channels.
The goal is the same in both cases: isolate application code from the infrastructure.
These concepts are discussed at length along with all of the patterns that follow in the <a class="ulink" href="http://www.eaipatterns.com" target="_top">Enterprise Integration Patterns</a> book.
Here, we provide only a high-level description of the main endpoint types supported by Spring Integration and their roles.
The chapters that follow will elaborate and provide sample code as well as configuration examples.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="overview-endpoints-transformer" href="#overview-endpoints-transformer"></a>3.4.1&nbsp;Transformer</h3></div></div></div>

<p>A Message Transformer is responsible for converting a Message&#8217;s content or structure and returning the modified Message.
Probably the most common type of transformer is one that converts the payload of the Message from one format to another (e.g.
from XML Document to java.lang.String).
Similarly, a transformer may be used to add, remove, or modify the Message&#8217;s header values.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="overview-endpoints-filter" href="#overview-endpoints-filter"></a>3.4.2&nbsp;Filter</h3></div></div></div>

<p>A Message Filter determines whether a Message should be passed to an output channel at all.
This simply requires a boolean test method that may check for a particular payload content type, a property value, the presence of a header, etc.
If the Message is accepted, it is sent to the output channel, but if not it will be dropped (or for a more severe implementation, an Exception could be thrown).
Message Filters are often used in conjunction with a Publish Subscribe channel, where multiple consumers may receive the same Message and use the filter to narrow down the set of Messages to be processed based on some criteria.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Be careful not to confuse the generic use of "filter" within the Pipes-and-Filters architectural pattern with this specific endpoint type that selectively narrows down the Messages flowing between two channels.
The Pipes-and-Filters concept of "filter" matches more closely with Spring Integration&#8217;s Message Endpoint: any component that can be connected to Message Channel(s) in order to send and/or receive Messages.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="overview-endpoints-router" href="#overview-endpoints-router"></a>3.4.3&nbsp;Router</h3></div></div></div>

<p>A Message Router is responsible for deciding what channel or channels should receive the Message next (if any).
Typically the decision is based upon the Message&#8217;s content and/or metadata available in the Message Headers.
A Message Router is often used as a dynamic alternative to a statically configured output channel on a Service Activator or other endpoint capable of sending reply Messages.
Likewise, a Message Router provides a proactive alternative to the reactive Message Filters used by multiple subscribers as described above.</p>
<div class="figure"><a name="d5e549" href="#d5e549"></a><p class="title"><b>Figure&nbsp;3.3.&nbsp;Router</b></p><div class="figure-contents">

<div class="mediaobject" align="center"><img src="images/router.jpg" align="middle" alt="Router"></div>
</div></div><br class="figure-break">
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="overview-endpoints-splitter" href="#overview-endpoints-splitter"></a>3.4.4&nbsp;Splitter</h3></div></div></div>

<p>A Splitter is another type of Message Endpoint whose responsibility is to accept a Message from its input channel, split that Message into multiple Messages, and then send each of those to its output channel.
This is typically used for dividing a "composite" payload object into a group of Messages containing the sub-divided payloads.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="overview-endpoints-aggregator" href="#overview-endpoints-aggregator"></a>3.4.5&nbsp;Aggregator</h3></div></div></div>

<p>Basically a mirror-image of the Splitter, the Aggregator is a type of Message Endpoint that receives multiple Messages and combines them into a single Message.
In fact, Aggregators are often downstream consumers in a pipeline that includes a Splitter.
Technically, the Aggregator is more complex than a Splitter, because it is required to maintain state (the Messages to-be-aggregated), to decide when the complete group of Messages is available, and to timeout if necessary.
Furthermore, in case of a timeout, the Aggregator needs to know whether to send the partial results or to discard them to a separate channel.
Spring Integration provides a <code class="literal">CorrelationStrategy</code>, a <code class="literal">ReleaseStrategy</code> and configurable settings for: timeout, whether
to send partial results upon timeout, and a discard channel.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="overview-endpoints-service-activator" href="#overview-endpoints-service-activator"></a>3.4.6&nbsp;Service Activator</h3></div></div></div>

<p>A Service Activator is a generic endpoint for connecting a service instance to the messaging system.
The input Message Channel must be configured, and if the service method to be invoked is capable of returning a value, an output Message Channel may also be provided.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The output channel is optional, since each Message may also provide its own <span class="emphasis"><em>Return Address</em></span> header.
This same rule applies for all consumer endpoints.</p>
</td></tr></table></div>
<p>The Service Activator invokes an operation on some service object to process the request Message, extracting the request Message&#8217;s payload and converting if necessary (if the method does not expect a Message-typed parameter).
Whenever the service object&#8217;s method returns a value, that return value will likewise be converted to a reply Message if necessary (if it&#8217;s not already a Message).
That reply Message is sent to the output channel.
If no output channel has been configured, then the reply will be sent to the channel specified in the Message&#8217;s "return address" if available.</p>
<p>A request-reply "Service Activator" endpoint connects a target object&#8217;s method to input and output Message Channels.</p>
<div class="figure"><a name="d5e572" href="#d5e572"></a><p class="title"><b>Figure&nbsp;3.4.&nbsp;Service Activator</b></p><div class="figure-contents">

<div class="mediaobject" align="center"><img src="images/handler-endpoint.jpg" align="middle" alt="handler endpoint"></div>
</div></div><br class="figure-break">
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>As discussed in <a class="link" href="#overview-components-channel" title="3.3.2&nbsp;Message Channel">Message Channel</a> above, channels can be <span class="emphasis"><em>Pollable</em></span> or <span class="emphasis"><em>Subscribable</em></span>; in this diagram, this is depicted by the "clock" symbol and the solid arrow (poll) and the dotted arrow (subscribe).</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="overview-endpoints-channeladapter" href="#overview-endpoints-channeladapter"></a>3.4.7&nbsp;Channel Adapter</h3></div></div></div>

<p>A Channel Adapter is an endpoint that connects a Message Channel to some other system or transport.
Channel Adapters may be either inbound or outbound.
Typically, the Channel Adapter will do some mapping between the Message and whatever object or resource is received-from or sent-to the other system (File, HTTP Request, JMS Message, etc).
Depending on the transport, the Channel Adapter may also populate or extract Message header values.
Spring Integration provides a number of Channel Adapters, and they will be described in upcoming chapters.</p>
<div class="figure"><a name="d5e587" href="#d5e587"></a><p class="title"><b>Figure&nbsp;3.5.&nbsp;An inbound "Channel Adapter" endpoint connects a source system to a MessageChannel.</b></p><div class="figure-contents">

<div class="mediaobject" align="center"><img src="images/source-endpoint.jpg" align="middle" alt="source endpoint"></div>
</div></div><br class="figure-break">
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Message sources can be <span class="emphasis"><em>Pollable</em></span> (e.g. POP3) or <span class="emphasis"><em>Message-Driven</em></span> (e.g. IMAP Idle); in this diagram, this is depicted by the "clock" symbol and the solid arrow (poll) and the dotted arrow (message-driven).</p>
</td></tr></table></div>
<div class="figure"><a name="d5e598" href="#d5e598"></a><p class="title"><b>Figure&nbsp;3.6.&nbsp;An outbound "Channel Adapter" endpoint connects a MessageChannel to a target system.</b></p><div class="figure-contents">

<div class="mediaobject" align="center"><img src="images/target-endpoint.jpg" align="middle" alt="target endpoint"></div>
</div></div><br class="figure-break">
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>As discussed in <a class="link" href="#overview-components-channel" title="3.3.2&nbsp;Message Channel">Message Channel</a> above, channels can be <span class="emphasis"><em>Pollable</em></span> or <span class="emphasis"><em>Subscribable</em></span>; in this diagram, this is depicted by the "clock" symbol and the solid arrow (poll) and the dotted arrow (subscribe).</p>
</td></tr></table></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="configuration-enable-integration" href="#configuration-enable-integration"></a>3.5&nbsp;Configuration and @EnableIntegration</h2></div></div></div>

<p>Throughout this document you will see references to XML namespace support for declaring elements in a Spring Integration flow.
This support is provided by a series of namespace parsers that generate appropriate bean definitions to implement a particular component.
For example, many endpoints consist of a <code class="literal">MessageHandler</code> bean and a <code class="literal">ConsumerEndpointFactoryBean</code> into which the handler and an input channel name are injected.</p>
<p>The first time a Spring Integration namespace element is encountered, the framework automatically declares a number of beans that are used to support the runtime environment (task scheduler, implicit channel creator, etc).</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Starting with <span class="emphasis"><em>version 4.0</em></span>, the <code class="literal">@EnableIntegration</code> annotation has been introduced, to allow the
registration of Spring Integration infrastructure beans (see
<a class="ulink" href="http://docs.spring.io/spring-integration/docs/latest-ga/api/org/springframework/integration/config/EnableIntegration.html" target="_top">JavaDocs</a>).
This annotation is required when only Java &amp; Annotation configuration is used, e.g. with Spring Boot and/or
Spring Integration Messaging Annotation support and Spring Integration Java DSL with no XML integration configuration.</p>
</td></tr></table></div>
<p>The <code class="literal">@EnableIntegration</code> annotation is also useful when you have a parent context with no Spring Integration components
and 2 or more child contexts that use Spring Integration.
It enables these common components to be declared once only, in the parent context.</p>
<p>The <code class="literal">@EnableIntegration</code> annotation registers many infrastructure components with the application context:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Registers some built-in beans, e.g. <code class="literal">errorChannel</code> and its <code class="literal">LoggingHandler</code>, <code class="literal">taskScheduler</code> for pollers,
<code class="literal">jsonPath</code> SpEL-function etc.;
</li><li class="listitem">
Adds several <code class="literal">BeanFactoryPostProcessor</code> s to enhance the <code class="literal">BeanFactory</code> for global and default integration environment;
</li><li class="listitem">
Adds several <code class="literal">BeanPostProcessor</code> s to enhance and/or convert and wrap particular beans for integration purposes;
</li><li class="listitem">
Adds annotations processors to parse Messaging Annotations and registers components for them with the application
context.
</li></ul></div>
<p>The <code class="literal">@IntegrationComponentScan</code> annotation has also been introduced to permit classpath scanning.
This annotation plays a similar role as the standard Spring Framework <code class="literal">@ComponentScan</code> annotation, but it is restricted just to Spring Integration specific components and annotations, which aren&#8217;t reachable by the standard Spring Framework component scan mechanism.
For example <a class="xref" href="#messaging-gateway-annotation" title="8.4.6&nbsp;@MessagingGateway Annotation">Section&nbsp;8.4.6, &#8220;@MessagingGateway Annotation&#8221;</a>.</p>
<p>The <code class="literal">@EnablePublisher</code> annotation has been introduced to register a <code class="literal">PublisherAnnotationBeanPostProcessor</code> bean and configure the <code class="literal">default-publisher-channel</code> for those <code class="literal">@Publisher</code> annotations which are provided without a <code class="literal">channel</code> attribute.
If more than one <code class="literal">@EnablePublisher</code> annotation is found, they must all have the same value for the default channel.
See <a class="xref" href="#publisher-annotation" title="B.1.1&nbsp;Annotation-driven approach via @Publisher annotation">Section&nbsp;B.1.1, &#8220;Annotation-driven approach via @Publisher annotation&#8221;</a> for more information.</p>
<p>The <code class="literal">@GlobalChannelInterceptor</code> annotation has been introduced to mark <code class="literal">ChannelInterceptor</code> beans for global channel interception.
This annotation is an analogue of the <code class="literal">&lt;int:channel-interceptor&gt;</code> xml element (see <a class="xref" href="#global-channel-configuration-interceptors" title="Global Channel Interceptor Configuration">the section called &#8220;Global Channel Interceptor Configuration&#8221;</a>).
<code class="literal">@GlobalChannelInterceptor</code> annotations can be placed at the class level (with a <code class="literal">@Component</code> stereotype annotation), or on <code class="literal">@Bean</code> methods within <code class="literal">@Configuration</code> classes.
In either case, the bean <span class="strong"><strong>must</strong></span> be a <code class="literal">ChannelInterceptor</code>.</p>
<p>The <code class="literal">@IntegrationConverter</code> annotation has been introduced to mark <code class="literal">Converter</code>, <code class="literal">GenericConverter</code> or <code class="literal">ConverterFactory</code> beans as candidate converters for <code class="literal">integrationConversionService</code>.
This annotation is an analogue of the <code class="literal">&lt;int:converter&gt;</code> xml element (see <a class="xref" href="#payload-type-conversion" title="8.1.6&nbsp;Payload Type Conversion">Section&nbsp;8.1.6, &#8220;Payload Type Conversion&#8221;</a>).
<code class="literal">@IntegrationConverter</code> annotations can be placed at the class level (with a <code class="literal">@Component</code> stereotype annotation), or on <code class="literal">@Bean</code> methods within <code class="literal">@Configuration</code> classes.</p>
<p>Also see <a class="xref" href="#annotations" title="F.6&nbsp;Annotation Support">Section&nbsp;F.6, &#8220;Annotation Support&#8221;</a> for more information about Messaging Annotations.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="programming-considerations" href="#programming-considerations"></a>3.6&nbsp;Programming Considerations</h2></div></div></div>

<p>It is generally recommended that you use plain old java objects (POJOs) whenever possible and only expose the framework in your code when absolutely necessary.</p>
<p>If you do expose the framework to your classes, there are some considerations that need to be taken into account, especially during application startup; some of these are listed here.</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
If your component is <code class="literal">ApplicationContextAware</code>, you should generally not "use" the <code class="literal">ApplicationContext</code> in the <code class="literal">setApplicationContext()</code> method; just store a reference and defer such uses until later in the context lifecycle.
</li><li class="listitem">
If your component is an <code class="literal">InitializingBean</code> or uses <code class="literal">@PostConstruct</code> methods, do not send any messages from these initialization methods - the application context is not yet initialized when these methods are called, and sending such messages will likely fail.
If you need to send a messages during startup, implement <code class="literal">ApplicationListener</code> and wait for the <code class="literal">ContextRefreshedEvent</code>.
Alternatively, implement <code class="literal">SmartLifecycle</code>, put your bean in a late phase, and send the messages from the <code class="literal">start()</code> method.
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="shaded" href="#shaded"></a>3.7&nbsp;Considerations When using Packaged (e.g. Shaded) Jars</h2></div></div></div>

<p>Spring Integration bootstraps certain features using Spring Framework&#8217;s <code class="literal">SpringFactories</code> mechanism to load several <code class="literal">IntegrationConfigurationInitializer</code> classes.
This includes the <code class="literal">-core</code> jar as well as certain others such as <code class="literal">-http</code>, <code class="literal">-jmx</code>, etc.
The information for this process is stored in a file <code class="literal">META-INF/spring.factories</code> in each jar.</p>
<p>Some developers prefer to repackage their application and all dependencies into a single jar using well-known tools, such as the <a class="ulink" href="https://maven.apache.org/plugins/maven-shade-plugin/" target="_top">Apache Maven Shade Plugin</a>.</p>
<p>By default, the shade plugin will not merge the <code class="literal">spring.factories</code> files when producing the shaded jar.</p>
<p>In addition to <code class="literal">spring.factories</code>, there are other <code class="literal">META-INF</code> files (<code class="literal">spring.handlers</code>, <code class="literal">spring.schemas</code>) used for XML configuration.
These also need to be merged.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p><a class="ulink" href="https://docs.spring.io/spring-boot/docs/current/reference/html/executable-jar.html" target="_top">Spring Boot&#8217;s executable jar mechanism</a> takes a different approach in that it nests the jars, thus retaining each <code class="literal">spring.factories</code> file on the class path.
So, with a Spring Boot application, nothing more is needed, if you use its default executable jar format.</p>
</td></tr></table></div>
<p>Even if you are not using Spring Boot, you can still use tooling provided by Boot to enhance the shade plugin by adding transformers for the above mentioned files.</p>
<p>The following is an example configuration for the plugin at the time of writing.
You may wish to consult the current <a class="ulink" href="https://github.com/spring-projects/spring-boot/blob/master/spring-boot-project/spring-boot-starters/spring-boot-starter-parent/pom.xml" target="_top">spring-boot-starter-parent pom</a> to see the current settings that boot uses.</p>
<p>
<b>pom.xml.&nbsp;</b>

</p><pre class="programlisting">...
    <span class="hl-tag">&lt;plugins&gt;</span>
        <span class="hl-tag">&lt;plugin&gt;</span>
            <span class="hl-tag">&lt;groupId&gt;</span>org.apache.maven.plugins<span class="hl-tag">&lt;/groupId&gt;</span>
            <span class="hl-tag">&lt;artifactId&gt;</span>maven-shade-plugin<span class="hl-tag">&lt;/artifactId&gt;</span>
            <span class="hl-tag">&lt;configuration&gt;</span>
                <span class="hl-tag">&lt;keepDependenciesWithProvidedScope&gt;</span>true<span class="hl-tag">&lt;/keepDependenciesWithProvidedScope&gt;</span>
                <span class="hl-tag">&lt;createDependencyReducedPom&gt;</span>true<span class="hl-tag">&lt;/createDependencyReducedPom&gt;</span>
            <span class="hl-tag">&lt;/configuration&gt;</span>
            <span class="hl-tag">&lt;dependencies&gt;</span>
                <span class="hl-tag">&lt;dependency&gt;</span> <a name="CO1-1" href="#CO1-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
                    <span class="hl-tag">&lt;groupId&gt;</span>org.springframework.boot<span class="hl-tag">&lt;/groupId&gt;</span>
                    <span class="hl-tag">&lt;artifactId&gt;</span>spring-boot-maven-plugin<span class="hl-tag">&lt;/artifactId&gt;</span>
                    <span class="hl-tag">&lt;version&gt;</span>${spring.boot.version}<span class="hl-tag">&lt;/version&gt;</span>
                <span class="hl-tag">&lt;/dependency&gt;</span>
            <span class="hl-tag">&lt;/dependencies&gt;</span>
            <span class="hl-tag">&lt;executions&gt;</span>
                <span class="hl-tag">&lt;execution&gt;</span>
                    <span class="hl-tag">&lt;phase&gt;</span>package<span class="hl-tag">&lt;/phase&gt;</span>
                    <span class="hl-tag">&lt;goals&gt;</span>
                        <span class="hl-tag">&lt;goal&gt;</span>shade<span class="hl-tag">&lt;/goal&gt;</span>
                    <span class="hl-tag">&lt;/goals&gt;</span>
                    <span class="hl-tag">&lt;configuration&gt;</span>
                        <span class="hl-tag">&lt;transformers&gt;</span> <a name="CO1-2" href="#CO1-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
                            <span class="hl-tag">&lt;transformer</span>
                                <span class="hl-attribute">implementation</span>=<span class="hl-value">"org.apache.maven.plugins.shade.resource.AppendingTransformer"</span><span class="hl-tag">&gt;</span>
                                <span class="hl-tag">&lt;resource&gt;</span>META-INF/spring.handlers<span class="hl-tag">&lt;/resource&gt;</span>
                            <span class="hl-tag">&lt;/transformer&gt;</span>
                            <span class="hl-tag">&lt;transformer</span>
                                <span class="hl-attribute">implementation</span>=<span class="hl-value">"org.springframework.boot.maven.PropertiesMergingResourceTransformer"</span><span class="hl-tag">&gt;</span>
                                <span class="hl-tag">&lt;resource&gt;</span>META-INF/spring.factories<span class="hl-tag">&lt;/resource&gt;</span>
                            <span class="hl-tag">&lt;/transformer&gt;</span>
                            <span class="hl-tag">&lt;transformer</span>
                                <span class="hl-attribute">implementation</span>=<span class="hl-value">"org.apache.maven.plugins.shade.resource.AppendingTransformer"</span><span class="hl-tag">&gt;</span>
                                <span class="hl-tag">&lt;resource&gt;</span>META-INF/spring.schemas<span class="hl-tag">&lt;/resource&gt;</span>
                            <span class="hl-tag">&lt;/transformer&gt;</span>
                            <span class="hl-tag">&lt;transformer</span>
                                <span class="hl-attribute">implementation</span>=<span class="hl-value">"org.apache.maven.plugins.shade.resource.ServicesResourceTransformer"</span><span class="hl-tag"> /&gt;</span>
                        <span class="hl-tag">&lt;/transformers&gt;</span>
                    <span class="hl-tag">&lt;/configuration&gt;</span>
                <span class="hl-tag">&lt;/execution&gt;</span>
            <span class="hl-tag">&lt;/executions&gt;</span>
        <span class="hl-tag">&lt;/plugin&gt;</span>
    <span class="hl-tag">&lt;/plugins&gt;</span>
...</pre><p>

</p>
<p>Specifically,</p>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO1-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>add the <code class="literal">spring-boot-maven-plugin</code> as a dependency</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO1-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>configure the transformers</p>
</td></tr></table></div>
<p>Add a property for <code class="literal">${spring.boot.version}</code> or use a version explicitly there.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="programming-tips" href="#programming-tips"></a>3.8&nbsp;Programming Tips and Tricks</h2></div></div></div>

<p>With XML configuration and Spring Integration Namespace support, the XML Parsers hide how
target beans are built and wired together.
For Java &amp; Annotation Configuration, it is important to understand the Framework API for the target end-user
applications.</p>
<p>The first class citizens for EIP implementation are <code class="literal">Message</code>, <code class="literal">Channel</code> and <code class="literal">Endpoint</code> (see <a class="xref" href="#overview-components" title="3.3&nbsp;Main Components">Section&nbsp;3.3, &#8220;Main Components&#8221;</a>
 above).
Their implementations (contracts) are:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">org.springframework.messaging.Message</code> - see <a class="xref" href="#message" title="5.1&nbsp;Message">Section&nbsp;5.1, &#8220;Message&#8221;</a>;
</li><li class="listitem">
<code class="literal">org.springframework.messaging.MessageChannel</code> - see <a class="xref" href="#channel" title="4.1&nbsp;Message Channels">Section&nbsp;4.1, &#8220;Message Channels&#8221;</a>;
</li><li class="listitem">
<code class="literal">org.springframework.integration.endpoint.AbstractEndpoint</code> - see <a class="xref" href="#polling-consumer" title="4.2&nbsp;Poller">Section&nbsp;4.2, &#8220;Poller&#8221;</a>.
</li></ul></div>
<p>The first two are simple enough to understand how to implement, configure and use, respectively;
the last one deserves more review.</p>
<p>The <code class="literal">AbstractEndpoint</code> is widely used throughout the Framework for different component implementations;
its main implementations are:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">EventDrivenConsumer</code>, when we subscribe to a <code class="literal">SubscribableChannel</code> to <span class="emphasis"><em>listen</em></span> for messages;
</li><li class="listitem">
<code class="literal">PollingConsumer</code>, when we <span class="emphasis"><em>poll</em></span> for messages from a <code class="literal">PollableChannel</code>.
</li></ul></div>
<p>Using Messaging Annotations and/or Java DSL, you shouldn&#8217;t worry about these components, because the Framework produces
them automatically via appropriate annotations and <code class="literal">BeanPostProcessor</code> s.
When building components manually, the <code class="literal">ConsumerEndpointFactoryBean</code> should be used to help to determine the target
<code class="literal">AbstractEndpoint</code> implementation based on the provided <code class="literal">inputChannel</code> property.</p>
<p>On the other hand, the <code class="literal">ConsumerEndpointFactoryBean</code> exhibits an another first class citizens in the Framework -
<code class="literal">org.springframework.messaging.MessageHandler</code>.
The goal of the implementation of this class is to <span class="emphasis"><em>handle the message consumed by the endpoint from the channel</em></span>.
All EIP components in Spring Integration are <code class="literal">MessageHandler</code> implementations,
e.g. <code class="literal">AggregatingMessageHandler</code>, <code class="literal">MessageTransformingHandler</code>, <code class="literal">AbstractMessageSplitter</code> etc.; as well as the target
protocol outbound adapters are implementations, too, e.g. <code class="literal">FileWritingMessageHandler</code>,
<code class="literal">HttpRequestExecutingMessageHandler</code>, <code class="literal">AbstractMqttMessageHandler</code> etc.
When you develop Spring Integration applications with Java &amp; Annotation Configuration, you should take a look into the
Spring Integration module to find an appropriate <code class="literal">MessageHandler</code> implementation to be used for the <code class="literal">@ServiceActivator</code>
configuration.
For example to send an XMPP message (see <a class="xref" href="#xmpp" title="36.&nbsp;XMPP Support">Chapter&nbsp;36, <i>XMPP Support</i></a>) we should configure something like this:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "input")</span></em>
<span class="hl-keyword">public</span> MessageHandler sendChatMessageHandler(XMPPConnection xmppConnection) {
    ChatMessageSendingMessageHandler handler = <span class="hl-keyword">new</span> ChatMessageSendingMessageHandler(xmppConnection);

    DefaultXmppHeaderMapper xmppHeaderMapper = <span class="hl-keyword">new</span> DefaultXmppHeaderMapper();
    xmppHeaderMapper.setRequestHeaderNames(<span class="hl-string">"*"</span>);
    handler.setHeaderMapper(xmppHeaderMapper);

    <span class="hl-keyword">return</span> handler;
}</pre>
<p>The <code class="literal">MessageHandler</code> implementations represent the <span class="emphasis"><em>outbound</em></span> and <span class="emphasis"><em>processing</em></span> part of the message flow.</p>
<p>The <span class="emphasis"><em>inbound</em></span> message flow side has its own components, which are divided to the <span class="emphasis"><em>polling</em></span> and <span class="emphasis"><em>listening</em></span> behavior.
The listening components are pretty simple and typically requires only one target class implementation to be ready to
produce messages.
Listening components can be one-way <code class="literal">MessageProducerSupport</code> implementations,
e.g. <code class="literal">AbstractMqttMessageDrivenChannelAdapter</code> and <code class="literal">ImapIdleChannelAdapter</code>; and request-reply -
<code class="literal">MessagingGatewaySupport</code> implementations, e.g. <code class="literal">AmqpInboundGateway</code> and <code class="literal">AbstractWebServiceInboundGateway</code>.</p>
<p><span class="emphasis"><em>Polling</em></span> inbound endpoints are for those protocols which don&#8217;t provide a listener API or aren&#8217;t intended for
such a behavior.
For example any File based protocol, as an FTP, any data bases (RDBMS or NoSQL) etc.</p>
<p>These inbound endpoints consist with two components: the poller configuration, to initiate the polling task periodically,
and message source class to read data from the target protocol and produce a message for the downstream integration flow.
The first class, for poller configuration, is <code class="literal">SourcePollingChannelAdapter</code>.
It is one more <code class="literal">AbstractEndpoint</code> implementation, but especially for the polling purpose for initiating an integration
flow.
Typically, with the Messaging Annotations or Java DSL, you shouldn&#8217;t worry about this class, the Framework produces
a bean for it, based on the <code class="literal">@InboundChannelAdapter</code> configuration or Java DSL particular Builder.</p>
<p>The <span class="emphasis"><em>message source</em></span> components are more important for the target application development and they all implement
the <code class="literal">MessageSource</code> interface, e.g. <code class="literal">MongoDbMessageSource</code> and <code class="literal">AbstractTwitterMessageSource</code>.
With that in mind, our config for reading data from an RDBMS table with JDBC may look like:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<em><span class="hl-annotation" style="color: gray">@InboundChannelAdapter(value = "fooChannel", poller = @Poller(fixedDelay="5000"))</span></em>
<span class="hl-keyword">public</span> MessageSource&lt;?&gt; storedProc(DataSource dataSource) {
    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> JdbcPollingChannelAdapter(dataSource, <span class="hl-string">"SELECT * FROM foo where status = 0"</span>);
}</pre>
<p>All the required <span class="emphasis"><em>inbound</em></span> and <span class="emphasis"><em>outbound</em></span> classes for the target protocols you can find in the particular Spring
Integration module, in most cases in the respective package.
For example <code class="literal">spring-integration-websocket</code> adapters are:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">o.s.i.websocket.inbound.WebSocketInboundChannelAdapter</code> - implements <code class="literal">MessageProducerSupport</code>
implementation to listen frames on the socket and produce message to the channel;
</li><li class="listitem">
<code class="literal">o.s.i.websocket.outbound.WebSocketOutboundMessageHandler</code> - the one-way
<code class="literal">AbstractMessageHandler</code> implementation to convert incoming messages to the appropriate frame and send over websocket.
</li></ul></div>
<p>If you are familiar with Spring Integration XML configuration already, starting with <span class="emphasis"><em>version 4.3</em></span>, we provide in the
XSD elements definitions the description with the pointer which target classes are used to produce beans for the adapter
or gateway, for example:</p>
<pre class="programlisting"><span class="hl-tag">&lt;xsd:element</span> <span class="hl-attribute">name</span>=<span class="hl-value">"outbound-async-gateway"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;xsd:annotation&gt;</span>
		<span class="hl-tag">&lt;xsd:documentation&gt;</span>
Configures a Consumer Endpoint for the 'o.s.i.amqp.outbound.AsyncAmqpOutboundGateway'
that will publish an AMQP Message to the provided Exchange and expect a reply Message.
The sending thread returns immediately; the reply is sent asynchronously; uses 'AsyncRabbitTemplate.sendAndReceive()'.
       <span class="hl-tag">&lt;/xsd:documentation&gt;</span>
	<span class="hl-tag">&lt;/xsd:annotation&gt;</span></pre>
</div>
</div>
</div>
<div class="part"><div class="titlepage"><div><div><h1 class="title"><a name="spring-integration-core-messaging" href="#spring-integration-core-messaging"></a>Part&nbsp;IV.&nbsp;Core Messaging</h1></div></div></div>

<div class="partintro"><div></div>
<p>This section covers all aspects of the core messaging API in Spring Integration.
Here you will learn about Messages, Message Channels, and Message Endpoints.
Many of the Enterprise Integration Patterns are covered here as well, such as Filters, Routers, Transformers, Service-Activators, Splitters, and Aggregators.
The section also contains material about System Management, including the Control Bus and Message History support.</p>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="messaging-channels-section" href="#messaging-channels-section"></a>4.&nbsp;Messaging Channels</h2></div></div></div>

<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="channel" href="#channel"></a>4.1&nbsp;Message Channels</h2></div></div></div>

<p>While the <code class="literal">Message</code> plays the crucial role of encapsulating data, it is the <code class="literal">MessageChannel</code> that decouples message producers from message consumers.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="channel-interfaces" href="#channel-interfaces"></a>4.1.1&nbsp;The MessageChannel Interface</h3></div></div></div>

<p>Spring Integration&#8217;s top-level <code class="literal">MessageChannel</code> interface is defined as follows.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> MessageChannel {

    <span class="hl-keyword">boolean</span> send(Message message);

    <span class="hl-keyword">boolean</span> send(Message message, <span class="hl-keyword">long</span> timeout);
}</pre>
<p>When sending a message, the return value will be <span class="emphasis"><em>true</em></span> if the message is sent successfully.
If the send call times out or is interrupted, then it will return <span class="emphasis"><em>false</em></span>.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="channel-interfaces-pollablechannel" href="#channel-interfaces-pollablechannel"></a>PollableChannel</h4></div></div></div>

<p>Since Message Channels may or may not buffer Messages (as discussed in the overview), there are two sub-interfaces defining the buffering (pollable) and non-buffering (subscribable) channel behavior.
Here is the definition of <code class="literal">PollableChannel</code>.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> PollableChannel <span class="hl-keyword">extends</span> MessageChannel {

    Message&lt;?&gt; receive();

    Message&lt;?&gt; receive(<span class="hl-keyword">long</span> timeout);

}</pre>
<p>Similar to the send methods, when receiving a message, the return value will be <span class="emphasis"><em>null</em></span> in the case of a timeout or interrupt.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="channel-interfaces-subscribablechannel" href="#channel-interfaces-subscribablechannel"></a>SubscribableChannel</h4></div></div></div>

<p>The <code class="literal">SubscribableChannel</code> base interface is implemented by channels that send Messages directly to their subscribed <code class="literal">MessageHandler</code> s.
Therefore, they do not provide receive methods for polling, but instead define methods for managing those subscribers:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> SubscribableChannel <span class="hl-keyword">extends</span> MessageChannel {

    <span class="hl-keyword">boolean</span> subscribe(MessageHandler handler);

    <span class="hl-keyword">boolean</span> unsubscribe(MessageHandler handler);

}</pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="channel-implementations" href="#channel-implementations"></a>4.1.2&nbsp;Message Channel Implementations</h3></div></div></div>

<p>Spring Integration provides several different Message Channel implementations.
Each is briefly described in the sections below.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="channel-implementations-publishsubscribechannel" href="#channel-implementations-publishsubscribechannel"></a>PublishSubscribeChannel</h4></div></div></div>

<p>The <code class="literal">PublishSubscribeChannel</code> implementation broadcasts any Message sent to it to all of its subscribed handlers.
This is most often used for sending <span class="emphasis"><em>Event Messages</em></span> whose primary role is notification as opposed to <span class="emphasis"><em>Document Messages</em></span> which are generally intended to be processed by a single handler.
Note that the <code class="literal">PublishSubscribeChannel</code> is intended for sending only.
Since it broadcasts to its subscribers directly when its <code class="literal">send(Message)</code> method is invoked, consumers cannot poll for Messages (it does not implement <code class="literal">PollableChannel</code> and therefore has no <code class="literal">receive()</code> method).
Instead, any subscriber must be a <code class="literal">MessageHandler</code> itself, and the subscriber&#8217;s <code class="literal">handleMessage(Message)</code> method will be invoked in turn.</p>
<p>Prior to version 3.0, invoking the send method on a <code class="literal">PublishSubscribeChannel</code> that had no subscribers returned <code class="literal">false</code>.
When used in conjunction with a <code class="literal">MessagingTemplate</code>, a <code class="literal">MessageDeliveryException</code> was thrown.
Starting with version 3.0, the behavior has changed such that a send is always considered successful if at least the minimum subscribers are present (and successfully handle the message).
This behavior can be modified by setting the <code class="literal">minSubscribers</code> property, which defaults to <code class="literal">0</code>.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>If a <code class="literal">TaskExecutor</code> is used, only the presence of the correct number of subscribers is used for this determination, because the actual handling of the message is performed asynchronously.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="channel-implementations-queuechannel" href="#channel-implementations-queuechannel"></a>QueueChannel</h4></div></div></div>

<p>The <code class="literal">QueueChannel</code> implementation wraps a queue.
Unlike the <code class="literal">PublishSubscribeChannel</code>, the <code class="literal">QueueChannel</code> has point-to-point semantics.
In other words, even if the channel has multiple consumers, only one of them should receive any Message sent to that channel.
It provides a default no-argument constructor (providing an essentially unbounded capacity of <code class="literal">Integer.MAX_VALUE</code>) as well as a constructor that accepts the queue capacity:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> QueueChannel(<span class="hl-keyword">int</span> capacity)</pre>
<p>A channel that has not reached its capacity limit will store messages in its internal queue, and the <code class="literal">send()</code> method will return immediately even if no receiver is ready to handle the message.
If the queue has reached capacity, then the sender will block until room is available.
Or, if using the send call that accepts a timeout, it will block until either room is available or the timeout period elapses, whichever occurs first.
Likewise, a receive call will return immediately if a message is available on the queue, but if the queue is empty, then a receive call may block until either a message is available or the timeout elapses.
In either case, it is possible to force an immediate return regardless of the queue&#8217;s state by passing a timeout value of 0.
Note however, that calls to the no-arg versions of <code class="literal">send()</code> and <code class="literal">receive()</code> will block indefinitely.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="channel-implementations-prioritychannel" href="#channel-implementations-prioritychannel"></a>PriorityChannel</h4></div></div></div>

<p>Whereas the <code class="literal">QueueChannel</code> enforces first-in/first-out (FIFO) ordering, the <code class="literal">PriorityChannel</code> is an alternative implementation that allows for messages to be ordered within the channel based upon a priority.
By default the priority is determined by the <span class="emphasis"><em><code class="literal">priority</code></em></span> header within each message.
However, for custom priority determination logic, a comparator of type <code class="literal">Comparator&lt;Message&lt;?&gt;&gt;</code> can be provided to the <code class="literal">PriorityChannel</code>'s constructor.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="channel-implementations-rendezvouschannel" href="#channel-implementations-rendezvouschannel"></a>RendezvousChannel</h4></div></div></div>

<p>The <code class="literal">RendezvousChannel</code> enables a "direct-handoff" scenario where a sender will block until another party invokes the channel&#8217;s <code class="literal">receive()</code> method or vice-versa.
Internally, this implementation is quite similar to the <code class="literal">QueueChannel</code> except that it uses a <code class="literal">SynchronousQueue</code> (a zero-capacity implementation of <code class="literal">BlockingQueue</code>).
This works well in situations where the sender and receiver are operating in different threads but simply dropping the message in a queue asynchronously is not appropriate.
In other words, with a <code class="literal">RendezvousChannel</code> at least the sender knows that some receiver has accepted the message, whereas with a <code class="literal">QueueChannel</code>, the message would have been stored to the internal queue and potentially never received.</p>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>Keep in mind that all of these queue-based channels are storing messages in-memory only by default.
When persistence is required, you can either provide a <span class="emphasis"><em>message-store</em></span> attribute within the <span class="emphasis"><em>queue</em></span> element to reference a persistent MessageStore implementation, or you can replace the local channel with one that is backed by a persistent broker, such as a JMS-backed channel or Channel Adapter.
The latter option allows you to take advantage of any JMS provider&#8217;s implementation for message persistence, and it will be discussed in <a class="xref" href="#jms" title="20.&nbsp;JMS Support">Chapter&nbsp;20, <i>JMS Support</i></a>.
However, when buffering in a queue is not necessary, the simplest approach is to rely upon the <code class="literal">DirectChannel</code> discussed next.</p>
</td></tr></table></div>
<p>The <code class="literal">RendezvousChannel</code> is also useful for implementing request-reply operations.
The sender can create a temporary, anonymous instance of <code class="literal">RendezvousChannel</code> which it then sets as the <span class="emphasis"><em>replyChannel</em></span> header when building a Message.
After sending that Message, the sender can immediately call receive (optionally providing a timeout value) in order to block while waiting for a reply Message.
This is very similar to the implementation used internally by many of Spring Integration&#8217;s request-reply components.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="channel-implementations-directchannel" href="#channel-implementations-directchannel"></a>DirectChannel</h4></div></div></div>

<p>The <code class="literal">DirectChannel</code> has point-to-point semantics but otherwise is more similar to the <code class="literal">PublishSubscribeChannel</code> than any of the queue-based channel implementations described above.
It implements the <code class="literal">SubscribableChannel</code> interface instead of the <code class="literal">PollableChannel</code> interface, so it dispatches Messages directly to a subscriber.
As a point-to-point channel, however, it differs from the <code class="literal">PublishSubscribeChannel</code> in that it will only send each Message to a <span class="emphasis"><em>single</em></span> subscribed <code class="literal">MessageHandler</code>.</p>
<p>In addition to being the simplest point-to-point channel option, one of its most important features is that it enables a single thread to perform the operations on "both sides" of the channel.
For example, if a handler is subscribed to a <code class="literal">DirectChannel</code>, then sending a Message to that channel will trigger invocation of that handler&#8217;s <code class="literal">handleMessage(Message)</code> method <span class="emphasis"><em>directly in the
        sender&#8217;s thread</em></span>, before the send() method invocation can return.</p>
<p>The key motivation for providing a channel implementation with this behavior is to support transactions that must span across the channel while still benefiting from the abstraction and loose coupling that the channel provides.
If the send call is invoked within the scope of a transaction, then the outcome of the handler&#8217;s invocation (e.g.
updating a database record) will play a role in determining the ultimate result of that transaction (commit or rollback).</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Since the <code class="literal">DirectChannel</code> is the simplest option and does not add any additional overhead that would be required for scheduling and managing the threads of a poller, it is the default channel type within Spring Integration.
The general idea is to define the channels for an application and then to consider which of those need to provide buffering or to throttle input, and then modify those to be queue-based <code class="literal">PollableChannels</code>.
Likewise, if a channel needs to broadcast messages, it should not be a <code class="literal">DirectChannel</code> but rather a <code class="literal">PublishSubscribeChannel</code>.
Below you will see how each of these can be configured.</p>
</td></tr></table></div>
<p>The <code class="literal">DirectChannel</code> internally delegates to a Message Dispatcher to invoke its subscribed Message Handlers, and that dispatcher can have a load-balancing strategy exposed via <span class="emphasis"><em>load-balancer</em></span> or <span class="emphasis"><em>load-balancer-ref</em></span> attributes (mutually exclusive).
The load balancing strategy is used by the Message Dispatcher to help determine how Messages are distributed amongst Message Handlers in the case that there are multiple Message Handlers subscribed to the same channel.
As a convenience the <span class="emphasis"><em>load-balancer</em></span> attribute exposes enumeration of values pointing to pre-existing implementations of <code class="literal">LoadBalancingStrategy</code>.
The "round-robin" (load-balances across the handlers in rotation) and "none" (for the cases where one wants to explicitely disable load balancing) are the only available values.
Other strategy implementations may be added in future versions.
However, since version 3.0 you can provide your own implementation of the <code class="literal">LoadBalancingStrategy</code> and inject it using <span class="emphasis"><em>load-balancer-ref</em></span> attribute which should point to a bean that implements <code class="literal">LoadBalancingStrategy</code>.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"lbRefChannel"</span><span class="hl-tag">&gt;</span>
  <span class="hl-tag">&lt;int:dispatcher</span> <span class="hl-attribute">load-balancer-ref</span>=<span class="hl-value">"lb"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:channel&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"lb"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"foo.bar.SampleLoadBalancingStrategy"</span><span class="hl-tag">/&gt;</span></pre>
<p>Note that <span class="emphasis"><em>load-balancer</em></span> or <span class="emphasis"><em>load-balancer-ref</em></span> attributes are mutually exclusive.</p>
<p>The load-balancing also works in combination with a boolean <span class="emphasis"><em>failover</em></span> property.
If the "failover" value is true (the default), then the dispatcher will fall back to any subsequent handlers as necessary when preceding handlers throw Exceptions.
The order is determined by an optional order value defined on the handlers themselves or, if no such value exists, the order in which the handlers are subscribed.</p>
<p>If a certain situation requires that the dispatcher always try to invoke the first handler, then fallback in the same fixed order sequence every time an error occurs, no load-balancing strategy should be provided.
In other words, the dispatcher still supports the failover boolean property even when no load-balancing is enabled.
Without load-balancing, however, the invocation of handlers will always begin with the first according to their order.
For example, this approach works well when there is a clear definition of primary, secondary, tertiary, and so on.
When using the namespace support, the "order" attribute on any endpoint will determine that order.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Keep in mind that load-balancing and failover only apply when a channel has more than one subscribed Message Handler.
When using the namespace support, this means that more than one endpoint shares the same channel reference in the "input-channel" attribute.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="executor-channel" href="#executor-channel"></a>ExecutorChannel</h4></div></div></div>

<p>The <code class="literal">ExecutorChannel</code> is a point-to-point channel that supports the same dispatcher configuration as <code class="literal">DirectChannel</code> (load-balancing strategy and the failover boolean property).
The key difference between these two dispatching channel types is that the <code class="literal">ExecutorChannel</code> delegates to an instance of <code class="literal">TaskExecutor</code> to perform the dispatch.
This means that the send method typically will not block, but it also means that the handler invocation may not occur in the sender&#8217;s thread.
It therefore <span class="emphasis"><em>does not support transactions spanning the sender and receiving handler</em></span>.</p>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>Note that there are occasions where the sender may block.
For example, when using a TaskExecutor with a rejection-policy that throttles back on the client (such as the <code class="literal">ThreadPoolExecutor.CallerRunsPolicy</code>), the sender&#8217;s thread will execute the method directly anytime the thread pool is at its maximum capacity and the executor&#8217;s work queue is full.
Since that situation would only occur in a non-predictable way, that obviously cannot be relied upon for transactions.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="channel-implementations-threadlocalchannel" href="#channel-implementations-threadlocalchannel"></a>Scoped Channel</h4></div></div></div>

<p>Spring Integration 1.0 provided a <code class="literal">ThreadLocalChannel</code> implementation, but that has been removed as of 2.0.
Now, there is a more general way for handling the same requirement by simply adding a "scope" attribute to a channel.
The value of the attribute can be any name of a Scope that is available within the context.
For example, in a web environment, certain Scopes are available, and any custom Scope implementations can be registered with the context.
Here&#8217;s an example of a ThreadLocal-based scope being applied to a channel, including the registration of the Scope itself.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"threadScopedChannel"</span> <span class="hl-attribute">scope</span>=<span class="hl-value">"thread"</span><span class="hl-tag">&gt;</span>
     <span class="hl-tag">&lt;int:queue /&gt;</span>
<span class="hl-tag">&lt;/int:channel&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.beans.factory.config.CustomScopeConfigurer"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"scopes"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;map&gt;</span>
            <span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"thread"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"org.springframework.context.support.SimpleThreadScope"</span><span class="hl-tag"> /&gt;</span>
        <span class="hl-tag">&lt;/map&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
<p>The channel above also delegates to a queue internally, but the channel is bound to the current thread, so the contents of the queue are as well.
That way the thread that sends to the channel will later be able to receive those same Messages, but no other thread would be able to access them.
While thread-scoped channels are rarely needed, they can be useful in situations where <code class="literal">DirectChannels</code> are being used to enforce a single thread of operation but any reply Messages should be sent to a "terminal" channel.
If that terminal channel is thread-scoped, the original sending thread can collect its replies from it.</p>
<p>Now, since any channel can be scoped, you can define your own scopes in addition to Thread Local.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="channel-interceptors" href="#channel-interceptors"></a>4.1.3&nbsp;Channel Interceptors</h3></div></div></div>

<p>One of the advantages of a messaging architecture is the ability to provide common behavior and capture meaningful information about the messages passing through the system in a non-invasive way.
Since the <code class="literal">Message</code> s are being sent to and received from <code class="literal">MessageChannels</code>, those channels provide an opportunity for intercepting the send and receive operations.
The <code class="literal">ChannelInterceptor</code> strategy interface provides methods for each of those operations:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> ChannelInterceptor {

    Message&lt;?&gt; preSend(Message&lt;?&gt; message, MessageChannel channel);

    <span class="hl-keyword">void</span> postSend(Message&lt;?&gt; message, MessageChannel channel, <span class="hl-keyword">boolean</span> sent);

    <span class="hl-keyword">void</span> afterSendCompletion(Message&lt;?&gt; message, MessageChannel channel, <span class="hl-keyword">boolean</span> sent, Exception ex);

    <span class="hl-keyword">boolean</span> preReceive(MessageChannel channel);

    Message&lt;?&gt; postReceive(Message&lt;?&gt; message, MessageChannel channel);

    <span class="hl-keyword">void</span> afterReceiveCompletion(Message&lt;?&gt; message, MessageChannel channel, Exception ex);
}</pre>
<p>After implementing the interface, registering the interceptor with a channel is just a matter of calling:</p>
<pre class="programlisting">channel.addInterceptor(someChannelInterceptor);</pre>
<p>The methods that return a Message instance can be used for transforming the Message or can return <span class="emphasis"><em>null</em></span> to prevent further processing (of course, any of the methods can throw a RuntimeException).
Also, the <code class="literal">preReceive</code> method can return <span class="emphasis"><em><code class="literal">false</code></em></span> to prevent the receive operation from proceeding.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Keep in mind that <code class="literal">receive()</code> calls are only relevant for <code class="literal">PollableChannels</code>.
In fact the <code class="literal">SubscribableChannel</code> interface does not even define a <code class="literal">receive()</code> method.
The reason for this is that when a Message is sent to a <code class="literal">SubscribableChannel</code> it will be sent directly to one or more subscribers depending on the type of channel (e.g.
a PublishSubscribeChannel sends to all of its subscribers).
Therefore, the <code class="literal">preReceive(..)</code>, <code class="literal">postReceive(..)</code> and <code class="literal">afterReceiveCompletion(..)</code> interceptor methods are only invoked when the interceptor is applied to a <code class="literal">PollableChannel</code>.</p>
</td></tr></table></div>
<p>Spring Integration also provides an implementation of the <a class="ulink" href="http://eaipatterns.com/WireTap.html" target="_top">Wire Tap</a> pattern.
It is a simple interceptor that sends the Message to another channel without otherwise altering the existing flow.
It can be very useful for debugging and monitoring.
An example is shown in <a class="xref" href="#channel-wiretap" title="Wire Tap">the section called &#8220;Wire Tap&#8221;</a>.</p>
<p>Because it is rarely necessary to implement all of the interceptor methods, a <code class="literal">ChannelInterceptorAdapter</code> class is also available for sub-classing.
It provides no-op methods (the <code class="literal">void</code> method is empty, the <code class="literal">Message</code> returning methods return the Message as-is, and the <code class="literal">boolean</code> method returns <code class="literal">true</code>).
Therefore, it is often easiest to extend that class and just implement the method(s) that you need as in the following example.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> CountingChannelInterceptor <span class="hl-keyword">extends</span> ChannelInterceptorAdapter {

    <span class="hl-keyword">private</span> <span class="hl-keyword">final</span> AtomicInteger sendCount = <span class="hl-keyword">new</span> AtomicInteger();

    <em><span class="hl-annotation" style="color: gray">@Override</span></em>
    <span class="hl-keyword">public</span> Message&lt;?&gt; preSend(Message&lt;?&gt; message, MessageChannel channel) {
        sendCount.incrementAndGet();
        <span class="hl-keyword">return</span> message;
    }
}</pre>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>The order of invocation for the interceptor methods depends on the type of channel.
As described above, the queue-based channels are the only ones where the receive method is intercepted in the first place.
Additionally, the relationship between send and receive interception depends on the timing of separate sender and receiver threads.
For example, if a receiver is already blocked while waiting for a message the order could be: preSend, preReceive, postReceive, postSend.
However, if a receiver polls after the sender has placed a message on the channel and already returned, the order would be: preSend, postSend, (some-time-elapses) preReceive, postReceive.
The time that elapses in such a case depends on a number of factors and is therefore generally unpredictable (in fact, the receive may never happen!).
Obviously, the type of queue also plays a role (e.g.
rendezvous vs.
priority).
The bottom line is that you cannot rely on the order beyond the fact that preSend will precede postSend and preReceive will precede postReceive.</p>
</td></tr></table></div>
<p>Starting with <span class="emphasis"><em>Spring Framework 4.1</em></span> and Spring Integration 4.1, the <code class="literal">ChannelInterceptor</code> provides new methods - <code class="literal">afterSendCompletion()</code> and <code class="literal">afterReceiveCompletion()</code>.
They are invoked after <code class="literal">send()/receive()</code> calls, regardless of any exception that is raised, thus allowing for resource cleanup.
Note, the Channel invokes these methods on the ChannelInterceptor List in the reverse order of the initial <code class="literal">preSend()/preReceive()</code> calls.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="channel-template" href="#channel-template"></a>4.1.4&nbsp;MessagingTemplate</h3></div></div></div>

<p>As you will see when the endpoints and their various configuration options are introduced, Spring Integration provides a foundation for messaging components that enables non-invasive invocation of your application code <span class="emphasis"><em>from the messaging system</em></span>.
However, sometimes it is necessary to invoke the messaging system <span class="emphasis"><em>from your application code</em></span>.
For convenience when implementing such use-cases, Spring Integration provides a <code class="literal">MessagingTemplate</code> that supports a variety of operations across the Message Channels, including request/reply scenarios.
For example, it is possible to send a request and wait for a reply.</p>
<pre class="programlisting">MessagingTemplate template = <span class="hl-keyword">new</span> MessagingTemplate();

Message reply = template.sendAndReceive(someChannel, <span class="hl-keyword">new</span> GenericMessage(<span class="hl-string">"test"</span>));</pre>
<p>In that example, a temporary anonymous channel would be created internally by the template.
The <span class="emphasis"><em>sendTimeout</em></span> and <span class="emphasis"><em>receiveTimeout</em></span> properties may also be set on the template, and other exchange types are also supported.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">boolean</span> send(<span class="hl-keyword">final</span> MessageChannel channel, <span class="hl-keyword">final</span> Message&lt;?&gt; message) { ...
}

<span class="hl-keyword">public</span> Message&lt;?&gt; sendAndReceive(<span class="hl-keyword">final</span> MessageChannel channel, <span class="hl-keyword">final</span> Message&lt;?&gt; request) { ..
}

<span class="hl-keyword">public</span> Message&lt;?&gt; receive(<span class="hl-keyword">final</span> PollableChannel&lt;?&gt; channel) { ...
}</pre>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>A less invasive approach that allows you to invoke simple interfaces with payload and/or header values instead of Message instances is described in <a class="xref" href="#gateway-proxy" title="8.4.1&nbsp;Enter the GatewayProxyFactoryBean">Section&nbsp;8.4.1, &#8220;Enter the GatewayProxyFactoryBean&#8221;</a>.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="channel-configuration" href="#channel-configuration"></a>4.1.5&nbsp;Configuring Message Channels</h3></div></div></div>

<p>To create a Message Channel instance, you can use the &lt;channel/&gt; element:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"exampleChannel"</span><span class="hl-tag">/&gt;</span></pre>
<p>The default channel type is <span class="emphasis"><em>Point to Point</em></span>.
To create a <span class="emphasis"><em>Publish Subscribe</em></span> channel, use the <code class="literal">&lt;publish-subscribe-channel/&gt;</code> element:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:publish-subscribe-channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"exampleChannel"</span><span class="hl-tag">/&gt;</span></pre>
<p>When using the <code class="literal">&lt;channel/&gt;</code> element without any sub-elements, it will create a <code class="literal">DirectChannel</code> instance (a <code class="literal">SubscribableChannel</code>).</p>
<p>However, you can alternatively provide a variety of <code class="literal">&lt;queue/&gt;</code> sub-elements to create any of the pollable channel types (as described in <a class="xref" href="#channel-implementations" title="4.1.2&nbsp;Message Channel Implementations">Section&nbsp;4.1.2, &#8220;Message Channel Implementations&#8221;</a>).
Examples of each are shown below.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="channel-configuration-directchannel" href="#channel-configuration-directchannel"></a>DirectChannel Configuration</h4></div></div></div>

<p>As mentioned above, <code class="literal">DirectChannel</code> is the default type.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"directChannel"</span><span class="hl-tag">/&gt;</span></pre>
<p>A default channel will have a <span class="emphasis"><em>round-robin</em></span> load-balancer and will also have failover enabled (See the discussion in <a class="xref" href="#channel-implementations-directchannel" title="DirectChannel">the section called &#8220;DirectChannel&#8221;</a> for more detail).
To disable one or both of these, add a <code class="literal">&lt;dispatcher/&gt;</code> sub-element and configure the attributes:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"failFastChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:dispatcher</span> <span class="hl-attribute">failover</span>=<span class="hl-value">"false"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/channel&gt;</span>

<span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"channelWithFixedOrderSequenceFailover"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:dispatcher</span> <span class="hl-attribute">load-balancer</span>=<span class="hl-value">"none"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:channel&gt;</span></pre>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="channel-datatype-channel" href="#channel-datatype-channel"></a>Datatype Channel Configuration</h4></div></div></div>

<p>There are times when a consumer can only process a particular type of payload and you need to therefore ensure the payload type of input Messages.
Of course the first thing that comes to mind is Message Filter.
However all that Message Filter will do is filter out Messages that are not compliant with the requirements of the consumer.
Another way would be to use a Content Based Router and route Messages with non-compliant data-types to specific Transformers to enforce transformation/conversion to the required data-type.
This of course would work, but a simpler way of accomplishing the same thing is to apply the <a class="ulink" href="http://www.eaipatterns.com/DatatypeChannel.html" target="_top">Datatype Channel</a> pattern.
You can use separate Datatype Channels for each specific payload data-type.</p>
<p>To create a Datatype Channel that only accepts messages containing a certain payload type, provide the fully-qualified class name in the channel element&#8217;s <code class="literal">datatype</code> attribute:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"numberChannel"</span> <span class="hl-attribute">datatype</span>=<span class="hl-value">"java.lang.Number"</span><span class="hl-tag">/&gt;</span></pre>
<p>Note that the type check passes for any type that is <span class="emphasis"><em>assignable</em></span> to the channel&#8217;s datatype.
In other words, the "numberChannel" above would accept messages whose payload is <code class="literal">java.lang.Integer</code> or <code class="literal">java.lang.Double</code>.
Multiple types can be provided as a comma-delimited list:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"stringOrNumberChannel"</span> <span class="hl-attribute">datatype</span>=<span class="hl-value">"java.lang.String,java.lang.Number"</span><span class="hl-tag">/&gt;</span></pre>
<p>So the <span class="emphasis"><em>numberChannel</em></span> above will only accept Messages with a data-type of <code class="literal">java.lang.Number</code>.
But what happens if the payload of the Message is not of the required type? It depends on whether you have defined a bean named <code class="literal">integrationConversionService</code> that is an instance of Spring&#8217;s <a class="ulink" href="http://static.springsource.org/spring/docs/current/spring-framework-reference/html/validation.html#core-convert-ConversionService-API" target="_top">Conversion Service</a>.
If not, then an Exception would be thrown immediately, but if you do have an "integrationConversionService" bean defined, it will be used in an attempt to convert the Message&#8217;s payload to the acceptable type.</p>
<p>You can even register custom converters.
For example, let&#8217;s say you are sending a Message with a String payload to the <span class="emphasis"><em>numberChannel</em></span> we configured above.</p>
<pre class="programlisting">MessageChannel inChannel = context.getBean(<span class="hl-string">"numberChannel"</span>, MessageChannel.<span class="hl-keyword">class</span>);
inChannel.send(<span class="hl-keyword">new</span> GenericMessage&lt;String&gt;(<span class="hl-string">"5"</span>));</pre>
<p>Typically this would be a perfectly legal operation, however since we are using Datatype Channel the result of such operation would generate an exception:</p>
<pre class="screen">Exception in thread "main" org.springframework.integration.MessageDeliveryException:
Channel 'numberChannel'
expected one of the following datataypes [class java.lang.Number],
but received [class java.lang.String]
&#8230;</pre>
<p>And rightfully so since we are requiring the payload type to be a Number while sending a String.
So we need something to convert String to a Number.
All we need to do is implement a Converter.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">class</span> StringToIntegerConverter <span class="hl-keyword">implements</span> Converter&lt;String, Integer&gt; {
    <span class="hl-keyword">public</span> Integer convert(String source) {
        <span class="hl-keyword">return</span> Integer.parseInt(source);
    }
}</pre>
<p>Then, register it as a Converter with the Integration Conversion Service:</p>
<pre class="programlisting">&lt;<span class="hl-keyword">int</span>:converter ref=<span class="hl-string">"strToInt"</span>/&gt;

&lt;bean id=<span class="hl-string">"strToInt"</span> <span class="hl-keyword">class</span>=<span class="hl-string">"org.springframework.integration.util.Demo.StringToIntegerConverter"</span>/&gt;</pre>
<p>When the <span class="emphasis"><em>converter</em></span> element is parsed, it will create the "integrationConversionService" bean on-demand if one is not already defined.
With that Converter in place, the send operation would now be successful since the Datatype Channel will use that Converter to convert the String payload to an Integer.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>For more information regarding Payload Type Conversion, please read <a class="xref" href="#payload-type-conversion" title="8.1.6&nbsp;Payload Type Conversion">Section&nbsp;8.1.6, &#8220;Payload Type Conversion&#8221;</a>.</p>
</td></tr></table></div>
<p>Beginning with <span class="emphasis"><em>version 4.0</em></span>, the <code class="literal">integrationConversionService</code> is invoked by the <code class="literal">DefaultDatatypeChannelMessageConverter</code>, which looks up the conversion service in the application context.
To use a different conversion technique, you can specify the <code class="literal">message-converter</code> attribute on the channel.
This must be a reference to a <code class="literal">MessageConverter</code> implementation.
Only the <code class="literal">fromMessage</code> method is used, which provides the converter with access to the message headers (for example if the conversion might need information from the headers, such as <code class="literal">content-type</code>).
The method can return just the converted payload, or a full <code class="literal">Message</code> object.
If the latter, the converter must be careful to copy all the headers from the inbound message.</p>
<p>Alternatively, declare a <code class="literal">&lt;bean/&gt;</code> of type <code class="literal">MessageConverter</code> with an id <code class="literal">"datatypeChannelMessageConverter"</code> and that converter will be used by all channels with a <code class="literal">datatype</code>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="channel-configuration-queuechannel" href="#channel-configuration-queuechannel"></a>QueueChannel Configuration</h4></div></div></div>

<p>To create a <code class="literal">QueueChannel</code>, use the <code class="literal">&lt;queue/&gt;</code> sub-element.
You may specify the channel&#8217;s capacity:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"queueChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;queue</span> <span class="hl-attribute">capacity</span>=<span class="hl-value">"25"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:channel&gt;</span></pre>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>If you do not provide a value for the <span class="emphasis"><em>capacity</em></span> attribute on this <code class="literal">&lt;queue/&gt;</code> sub-element, the resulting queue will be unbounded.
To avoid issues such as OutOfMemoryErrors, it is highly recommended to set an explicit value for a bounded queue.</p>
</td></tr></table></div>
<p><span class="emphasis"><em>Persistent QueueChannel Configuration</em></span></p>
<p>Since a <code class="literal">QueueChannel</code> provides the capability to buffer Messages, but does so in-memory only by default, it also introduces a possibility that Messages could be lost in the event of a system failure.
To mitigate this risk, a <code class="literal">QueueChannel</code> may be backed by a persistent implementation of the <code class="literal">MessageGroupStore</code> strategy interface.
For more details on <code class="literal">MessageGroupStore</code> and <code class="literal">MessageStore</code> see <a class="xref" href="#message-store" title="9.4&nbsp;Message Store">Section&nbsp;9.4, &#8220;Message Store&#8221;</a>.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>The <code class="literal">capacity</code> attribute is not allowed when the <code class="literal">message-store</code> attribute is used.</p>
</td></tr></table></div>
<p>When a <code class="literal">QueueChannel</code> receives a Message, it will add it to the Message Store, and when a Message is polled from a <code class="literal">QueueChannel</code>, it is removed from the Message Store.</p>
<p>By default, a <code class="literal">QueueChannel</code> stores its Messages in an in-memory Queue and can therefore lead to the lost message scenario mentioned above.
However Spring Integration provides persistent stores, such as the <code class="literal">JdbcChannelMessageStore</code>.</p>
<p>You can configure a Message Store for any <code class="literal">QueueChannel</code> by adding the <code class="literal">message-store</code> attribute as shown in the next example.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"dbBackedChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:queue</span> <span class="hl-attribute">message-store</span>=<span class="hl-value">"channelStore"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:channel&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"channelStore"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.jdbc.store.JdbcChannelMessageStore"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"dataSource"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"dataSource"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"channelMessageStoreQueryProvider"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"queryProvider"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
<p>The Spring Integration JDBC module also provides schema DDL for a number of popular databases.
These schemas are located in the <span class="emphasis"><em>org.springframework.integration.jdbc.store.channel</em></span> package of that module (spring-integration-jdbc).</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>One important feature is that with any transactional persistent store (e.g., <code class="literal">JdbcChannelMessageStore</code>), as long as the poller has a transaction configured, a Message removed from the store will only be permanently removed if the transaction completes successfully, otherwise the transaction will roll back and the Message will not be lost.</p>
</td></tr></table></div>
<p>Many other implementations of the Message Store will be available as the growing number of Spring projects related to "NoSQL" data stores provide the underlying support.
Of course, you can always provide your own implementation of the MessageGroupStore interface if you cannot find one that meets your particular needs.</p>
<p>Since <span class="emphasis"><em>version 4.0</em></span>, it is recommended that <code class="literal">QueueChannel</code> s are configured to use a <code class="literal">ChannelMessageStore</code> if possible.
These are generally optimized for this use, when compared with a general message store.
If the <code class="literal">ChannelMessageStore</code> is a <code class="literal">ChannelPriorityMessageStore</code> the messages will be received in FIFO within priority order.
The notion of priority is determined by the message store implementation.
For example the Java Configuration for the <a class="xref" href="#mongodb-priority-channel-message-store" title="22.3.1&nbsp;MongoDB Channel Message Store">Section&nbsp;22.3.1, &#8220;MongoDB Channel Message Store&#8221;</a>:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> BasicMessageGroupStore mongoDbChannelMessageStore(MongoDbFactory mongoDbFactory) {
    MongoDbChannelMessageStore store = <span class="hl-keyword">new</span> MongoDbChannelMessageStore(mongoDbFactory);
    store.setPriorityEnabled(true);
    <span class="hl-keyword">return</span> store;
}

<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> PollableChannel priorityQueue(BasicMessageGroupStore mongoDbChannelMessageStore) {
    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> QueueChannel(<span class="hl-keyword">new</span> MessageGroupQueue(mongoDbChannelMessageStore, <span class="hl-string">"priorityQueue"</span>));
}</pre>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Pay attention to the <code class="literal">MessageGroupQueue</code> class.
That is a <code class="literal">BlockingQueue</code> implementation to utilize the <code class="literal">MessageGroupStore</code> operations.</p>
</td></tr></table></div>
<p>The same with Java DSL may look like:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> IntegrationFlow priorityFlow(PriorityCapableChannelMessageStore mongoDbChannelMessageStore) {
    <span class="hl-keyword">return</span> IntegrationFlows.from((Channels c) -&gt;
            c.priority(<span class="hl-string">"priorityChannel"</span>, mongoDbChannelMessageStore, <span class="hl-string">"priorityGroup"</span>))
            ....
            .get();
}</pre>
<p>Another option to customize the QueueChannel environment is provided by the <code class="literal">ref</code> attribute of the <code class="literal">&lt;int:queue&gt;</code> sub-element.
This attribute implies the reference to any <code class="literal">java.util.Queue</code> implementation.
An implementation is provided by the <a class="ulink" href="https://github.com/reactor/reactor" target="_top">Project Reactor</a> and its <code class="literal">reactor.queue.PersistentQueue</code> implementation for the <a class="ulink" href="https://github.com/OpenHFT/Chronicle-Queue" target="_top">IndexedChronicle</a>:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> QueueChannel reactorQueue() {
    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> QueueChannel(<span class="hl-keyword">new</span> PersistentQueueSpec&lt;Message&lt;?&gt;&gt;()
                    .codec(<span class="hl-keyword">new</span> JavaSerializationCodec&lt;Message&lt;?&gt;&gt;())
                    .basePath(System.getProperty(<span class="hl-string">"java.io.tmpdir"</span>) + <span class="hl-string">"/reactor-queue"</span>)
                    .get());
}</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="channel-configuration-pubsubchannel" href="#channel-configuration-pubsubchannel"></a>PublishSubscribeChannel Configuration</h4></div></div></div>

<p>To create a <code class="literal">PublishSubscribeChannel</code>, use the &lt;publish-subscribe-channel/&gt; element.
When using this element, you can also specify the <code class="literal">task-executor</code> used for publishing Messages (if none is specified it simply publishes in the sender&#8217;s thread):</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:publish-subscribe-channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"pubsubChannel"</span> <span class="hl-attribute">task-executor</span>=<span class="hl-value">"someExecutor"</span><span class="hl-tag">/&gt;</span></pre>
<p>Alongside with the <code class="literal">Executor</code>, an <code class="literal">ErrorHandler</code> can be configured as well.
By default the <code class="literal">PublishSubscribeChannel</code> uses a <code class="literal">MessagePublishingErrorHandler</code> implementation to send error to the <code class="literal">MessageChannel</code> from the <code class="literal">errorChannel</code> header or a global <code class="literal">errorChannel</code> instance.
If an <code class="literal">Executor</code> is not configured, the <code class="literal">ErrorHandler</code> is ignored and exceptions are thrown directly to the caller&#8217;s Thread.</p>
<p>If you are providing a <span class="emphasis"><em>Resequencer</em></span> or <span class="emphasis"><em>Aggregator</em></span> downstream from a <code class="literal">PublishSubscribeChannel</code>, then you can set the <span class="emphasis"><em>apply-sequence</em></span> property on the channel to <code class="literal">true</code>.
That will indicate that the channel should set the sequence-size and sequence-number Message headers as well as the correlation id prior to passing the Messages along.
For example, if there are 5 subscribers, the sequence-size would be set to 5, and the Messages would have sequence-number header values ranging from 1 to 5.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:publish-subscribe-channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"pubsubChannel"</span> <span class="hl-attribute">apply-sequence</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span></pre>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The <code class="literal">apply-sequence</code> value is <code class="literal">false</code> by default so that a Publish Subscribe Channel can send the exact same Message instances to multiple outbound channels.
Since Spring Integration enforces immutability of the payload and header references, the channel creates new Message instances with the same payload reference but different header values when the flag is set to <code class="literal">true</code>.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="channel-configuration-executorchannel" href="#channel-configuration-executorchannel"></a>ExecutorChannel</h4></div></div></div>

<p>To create an <code class="literal">ExecutorChannel</code>, add the &lt;dispatcher&gt; sub-element along with a <code class="literal">task-executor</code> attribute.
Its value can reference any <code class="literal">TaskExecutor</code> within the context.
For example, this enables configuration of a thread-pool for dispatching messages to subscribed handlers.
As mentioned above, this does break the "single-threaded" execution context between sender and receiver so that any active transaction context will not be shared by the invocation of the handler (i.e.
the handler may throw an Exception, but the send invocation has already returned successfully).</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"executorChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:dispatcher</span> <span class="hl-attribute">task-executor</span>=<span class="hl-value">"someExecutor"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:channel&gt;</span></pre>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The <code class="literal">load-balancer</code> and <code class="literal">failover</code> options are also both available on the &lt;dispatcher/&gt; sub-element as described above in <a class="xref" href="#channel-configuration-directchannel" title="DirectChannel Configuration">the section called &#8220;DirectChannel Configuration&#8221;</a>.
The same defaults apply as well.
So, the channel will have a round-robin load-balancing strategy with failover enabled unless explicit configuration is provided for one or both of those attributes.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"executorChannelWithoutFailover"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:dispatcher</span> <span class="hl-attribute">task-executor</span>=<span class="hl-value">"someExecutor"</span> <span class="hl-attribute">failover</span>=<span class="hl-value">"false"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:channel&gt;</span></pre>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="channel-configuration-prioritychannel" href="#channel-configuration-prioritychannel"></a>PriorityChannel Configuration</h4></div></div></div>

<p>To create a <code class="literal">PriorityChannel</code>, use the <code class="literal">&lt;priority-queue/&gt;</code> sub-element:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"priorityChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:priority-queue</span> <span class="hl-attribute">capacity</span>=<span class="hl-value">"20"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:channel&gt;</span></pre>
<p>By default, the channel will consult the <code class="literal">priority</code> header of the message.
However, a custom <code class="literal">Comparator</code> reference may be provided instead.
Also, note that the <code class="literal">PriorityChannel</code> (like the other types) does support the <code class="literal">datatype</code> attribute.
As with the QueueChannel, it also supports a <code class="literal">capacity</code> attribute.
The following example demonstrates all of these:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"priorityChannel"</span> <span class="hl-attribute">datatype</span>=<span class="hl-value">"example.Widget"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:priority-queue</span> <span class="hl-attribute">comparator</span>=<span class="hl-value">"widgetComparator"</span>
                    <span class="hl-attribute">capacity</span>=<span class="hl-value">"10"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:channel&gt;</span></pre>
<p>Since <span class="emphasis"><em>version 4.0</em></span>, the <code class="literal">priority-channel</code> child element supports the <code class="literal">message-store</code> option (<code class="literal">comparator</code> and <code class="literal">capacity</code> are not allowed in that case).
The message store must be a <code class="literal">PriorityCapableChannelMessageStore</code> and, in this case, the namespace parser will declare a <code class="literal">QueueChannel</code> instead of a <code class="literal">PriorityChannel</code>.
Implementations of the <code class="literal">PriorityCapableChannelMessageStore</code> are currently provided for <code class="literal">Redis</code>, <code class="literal">JDBC</code> and <code class="literal">MongoDB</code>.
See <a class="xref" href="#channel-configuration-queuechannel" title="QueueChannel Configuration">the section called &#8220;QueueChannel Configuration&#8221;</a> and <a class="xref" href="#message-store" title="9.4&nbsp;Message Store">Section&nbsp;9.4, &#8220;Message Store&#8221;</a> for more information.
You can find sample configuration in <a class="xref" href="#jdbc-message-store-channels" title="18.4.2&nbsp;Backing Message Channels">Section&nbsp;18.4.2, &#8220;Backing Message Channels&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="channel-configuration-rendezvouschannel" href="#channel-configuration-rendezvouschannel"></a>RendezvousChannel Configuration</h4></div></div></div>

<p>A <code class="literal">RendezvousChannel</code> is created when the queue sub-element is a <code class="literal">&lt;rendezvous-queue&gt;</code>.
It does not provide any additional configuration options to those described above, and its queue does not accept any capacity value since it is a 0-capacity direct handoff queue.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"rendezvousChannel"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int:rendezvous-queue/&gt;</span>
<span class="hl-tag">&lt;/int:channel&gt;</span></pre>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="channel-configuration-threadlocalchannel" href="#channel-configuration-threadlocalchannel"></a>Scoped Channel Configuration</h4></div></div></div>

<p>Any channel can be configured with a "scope" attribute.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"threadLocalChannel"</span> <span class="hl-attribute">scope</span>=<span class="hl-value">"thread"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="channel-configuration-interceptors" href="#channel-configuration-interceptors"></a>Channel Interceptor Configuration</h4></div></div></div>

<p>Message channels may also have interceptors as described in <a class="xref" href="#channel-interceptors" title="4.1.3&nbsp;Channel Interceptors">Section&nbsp;4.1.3, &#8220;Channel Interceptors&#8221;</a>.
The <code class="literal">&lt;interceptors/&gt;</code> sub-element can be added within a <code class="literal">&lt;channel/&gt;</code> (or the more specific element types).
Provide the <code class="literal">ref</code> attribute to reference any Spring-managed object that implements the <code class="literal">ChannelInterceptor</code> interface:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"exampleChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:interceptors&gt;</span>
        <span class="hl-tag">&lt;ref</span> <span class="hl-attribute">bean</span>=<span class="hl-value">"trafficMonitoringInterceptor"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/int:interceptors&gt;</span>
<span class="hl-tag">&lt;/int:channel&gt;</span></pre>
<p>In general, it is a good idea to define the interceptor implementations in a separate location since they usually provide common behavior that can be reused across multiple channels.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="global-channel-configuration-interceptors" href="#global-channel-configuration-interceptors"></a>Global Channel Interceptor Configuration</h4></div></div></div>

<p>Channel Interceptors provide a clean and concise way of applying cross-cutting behavior per individual channel.
If the same behavior should be applied on multiple channels, configuring the same set of interceptors for each channel <span class="emphasis"><em>would not be</em></span> the most efficient way.
To avoid repeated configuration while also enabling interceptors to apply to multiple channels, Spring Integration provides <span class="emphasis"><em>Global Interceptors</em></span>.
Look at the example below:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:channel-interceptor</span> <span class="hl-attribute">pattern</span>=<span class="hl-value">"input*, bar*, foo"</span> <span class="hl-attribute">order</span>=<span class="hl-value">"3"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"foo.barSampleInterceptor"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:channel-interceptor&gt;</span></pre>
<p>or</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:channel-interceptor</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"myInterceptor"</span> <span class="hl-attribute">pattern</span>=<span class="hl-value">"input*, bar*, foo"</span> <span class="hl-attribute">order</span>=<span class="hl-value">"3"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myInterceptor"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"foo.barSampleInterceptor"</span><span class="hl-tag">/&gt;</span></pre>
<p>Each <code class="literal">&lt;channel-interceptor/&gt;</code> element allows you to define a global interceptor which will be applied on all channels that match any patterns defined via the <code class="literal">pattern</code> attribute.
In the above case the global interceptor will be applied on the <span class="emphasis"><em>foo</em></span> channel and all other channels that begin with <span class="emphasis"><em>bar</em></span> or <span class="emphasis"><em>input</em></span>.
The <span class="emphasis"><em>order</em></span> attribute allows you to manage where this interceptor will be injected if there are multiple interceptors on a given channel.
For example, channel <span class="emphasis"><em>inputChannel</em></span> could have individual interceptors configured locally (see below):</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"inputChannel"</span><span class="hl-tag">&gt;</span>&nbsp;
  <span class="hl-tag">&lt;int:interceptors&gt;</span>
    <span class="hl-tag">&lt;int:wire-tap</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"logger"</span><span class="hl-tag">/&gt;</span>&nbsp;
  <span class="hl-tag">&lt;/int:interceptors&gt;</span>
<span class="hl-tag">&lt;/int:channel&gt;</span></pre>
<p>A reasonable question is how will a global interceptor be injected in relation to other interceptors configured locally or through other global interceptor definitions? The current implementation provides a very simple mechanism for defining the order of interceptor execution.
A positive number in the <code class="literal">order</code> attribute will ensure interceptor injection after any existing interceptors and a negative number will ensure that the interceptor is injected before existing interceptors.
This means that in the above example, the global interceptor will be injected <span class="emphasis"><em>AFTER</em></span> (since its order is greater than 0) the <span class="emphasis"><em>wire-tap</em></span> interceptor configured locally.
If there were another global interceptor with a matching <code class="literal">pattern</code>, its order would be determined by comparing the values of the <code class="literal">order</code> attribute.
To inject a global interceptor <span class="emphasis"><em>BEFORE</em></span> the existing interceptors, use a negative value for the <code class="literal">order</code> attribute.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Note that both the <code class="literal">order</code> and <code class="literal">pattern</code> attributes are optional.
The default value for <code class="literal">order</code> will be 0 and for <code class="literal">pattern</code>, the default is <span class="emphasis"><em>*</em></span> (to match all channels).</p>
</td></tr></table></div>
<p>Starting with <span class="emphasis"><em>version 4.3.15</em></span>, you can configure a property <code class="literal">spring.integration.postProcessDynamicBeans = true</code> to apply any global interceptors to dynamically created <code class="literal">MessageChannel</code> beans.
See <a class="xref" href="#global-properties" title="F.5&nbsp;Global Properties">Section&nbsp;F.5, &#8220;Global Properties&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="channel-wiretap" href="#channel-wiretap"></a>Wire Tap</h4></div></div></div>

<p>As mentioned above, Spring Integration provides a simple <span class="emphasis"><em>Wire Tap</em></span> interceptor out of the box.
You can configure a <span class="emphasis"><em>Wire Tap</em></span> on any channel within an <code class="literal">&lt;interceptors/&gt;</code> element.
This is especially useful for debugging, and can be used in conjunction with Spring Integration&#8217;s logging Channel Adapter as follows:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"in"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:interceptors&gt;</span>
        <span class="hl-tag">&lt;int:wire-tap</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"logger"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/int:interceptors&gt;</span>
<span class="hl-tag">&lt;/int:channel&gt;</span>

<span class="hl-tag">&lt;int:logging-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"logger"</span> <span class="hl-attribute">level</span>=<span class="hl-value">"DEBUG"</span><span class="hl-tag">/&gt;</span></pre>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>The <span class="emphasis"><em>logging-channel-adapter</em></span> also accepts an <span class="emphasis"><em>expression</em></span> attribute so that you can evaluate a SpEL expression against <span class="emphasis"><em>payload</em></span> and/or <span class="emphasis"><em>headers</em></span> variables.
Alternatively, to simply log the full Message toString() result, provide a value of "true" for the <span class="emphasis"><em>log-full-message</em></span> attribute.
That is <code class="literal">false</code> by default so that only the payload is logged.
Setting that to <code class="literal">true</code> enables logging of all headers in addition to the payload.
The <span class="emphasis"><em>expression</em></span> option does provide the most flexibility, however (e.g.
expression="payload.user.name").</p>
</td></tr></table></div>
<p><span class="strong"><strong>A little more on Wire Tap</strong></span></p>
<p>One of the common misconceptions about the wire tap and other similar components (<a class="xref" href="#message-publishing-config" title="B.1&nbsp;Message Publishing Configuration">Section&nbsp;B.1, &#8220;Message Publishing Configuration&#8221;</a>) is that they are automatically asynchronous in nature.
Wire-tap as a component is not invoked asynchronously be default.
Instead, Spring Integration focuses on a single unified approach to configuring asynchronous behavior: the Message Channel.
What makes certain parts of the message flow <span class="emphasis"><em>sync</em></span> or <span class="emphasis"><em>async</em></span> is the type of <span class="emphasis"><em>Message Channel</em></span> that has been configured within that flow.
That is one of the primary benefits of the Message Channel abstraction.
From the inception of the framework, we have always emphasized the need and the value of the <span class="emphasis"><em>Message Channel</em></span> as a first-class citizen of the framework.
It is not just an internal, implicit realization of the EIP pattern, it is fully exposed as a configurable component to the end user.
So, the Wire-tap component is ONLY responsible for performing the following 3 tasks:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
intercept a message flow by tapping into a channel (e.g., channelA)
</li><li class="listitem">
grab each message
</li><li class="listitem">
send the message to another channel (e.g., channelB)
</li></ul></div>
<p>It is essentially a variation of the Bridge, but it is encapsulated within a channel definition (and hence easier to enable and disable without disrupting a flow).
Also, unlike the bridge, it basically forks another message flow.
Is that flow <span class="emphasis"><em>synchronous</em></span> or <span class="emphasis"><em>asynchronous</em></span>? The answer simply depends on the type of <span class="emphasis"><em>Message Channel</em></span> that <span class="emphasis"><em>channelB</em></span> is.
And, now you know that we have: <span class="emphasis"><em>Direct Channel</em></span>, <span class="emphasis"><em>Pollable Channel</em></span>, and <span class="emphasis"><em>Executor Channel</em></span> as options.
The last two do break the thread boundary making communication via such channels <span class="emphasis"><em>asynchronous</em></span> simply because the dispatching of the message from that channel to its subscribed handlers happens on a different thread than the one used to send the message to that channel.
That is what is going to make your wire-tap flow <span class="emphasis"><em>sync</em></span> or <span class="emphasis"><em>async</em></span>.
It is consistent with other components within the framework (e.g., Message Publisher) and actually brings a level of consistency and simplicity by sparing you from worrying in advance (other than writing thread safe code) whether a particular piece of code should be implemented as <span class="emphasis"><em>sync</em></span> or <span class="emphasis"><em>async</em></span>.
The actual wiring of two pieces of code (component A and component B) via <span class="emphasis"><em>Message Channel</em></span> is what makes their collaboration <span class="emphasis"><em>sync</em></span> or <span class="emphasis"><em>async</em></span>.
You may even want to change from <span class="emphasis"><em>sync</em></span> to <span class="emphasis"><em>async</em></span> in the future and <span class="emphasis"><em>Message Channel</em></span> is what&#8217;s going to allow you to do it swiftly without ever touching the code.</p>
<p>One final point regarding the Wire Tap is that, despite the rationale provided above for not being async by default, one should keep in mind it is usually desirable to hand off the Message as soon as possible.
Therefore, it would be quite common to use an asynchronous channel option as the wire-tap&#8217;s outbound channel.
Nonetheless, another reason that we do not enforce asynchronous behavior by default is that you might not want to break a transactional boundary.
Perhaps you are using the Wire Tap for auditing purposes, and you DO want the audit Messages to be sent within the original transaction.
As an example, you might connect the wire-tap to a JMS outbound-channel-adapter.
That way, you get the best of both worlds: 1) the sending of a JMS Message can occur within the transaction while 2) it is still a "fire-and-forget" action thereby preventing any noticeable delay in the main message flow.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Starting with <span class="emphasis"><em>version 4.0</em></span>, it is important to avoid circular references when an interceptor (such as <code class="literal">WireTap</code>) references a channel itself.
You need to exclude such channels from those being intercepted by the current interceptor.
This can be done with appropriate <code class="literal">patterns</code> or programmatically.
If you have a custom <code class="literal">ChannelInterceptor</code> that references a <code class="literal">channel</code>, consider implementing <code class="literal">VetoCapableInterceptor</code>.
That way, the framework will ask the interceptor if it&#8217;s OK to intercept each channel that is a candidate based on the pattern.
You can also add runtime protection in the interceptor methods that ensures that the channel is not one that is referenced by the interceptor.
The <code class="literal">WireTap</code> uses both of these techniques.</p>
</td></tr></table></div>
<p>Starting with <span class="emphasis"><em>version 4.3</em></span>, the <code class="literal">WireTap</code> has additional constructors that take a <code class="literal">channelName</code> instead of a
<code class="literal">MessageChannel</code> instance.
This can be convenient for Java Configuration and when channel auto-creation logic is being used.
The target <code class="literal">MessageChannel</code> bean is resolved from the provided <code class="literal">channelName</code> later, on the first interaction with the
interceptor.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Channel resolution requires a <code class="literal">BeanFactory</code> so the wire tap instance must be a Spring-managed bean.</p>
</td></tr></table></div>
<p>This <span class="emphasis"><em>late-binding</em></span> approach also allows simplification of typical wire-tapping patterns with Java DSL configuration:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> PollableChannel myChannel() {
    <span class="hl-keyword">return</span> MessageChannels.queue()
            .wireTap(<span class="hl-string">"loggingFlow.input"</span>)
            .get();
}

<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> IntegrationFlow loggingFlow() {
    <span class="hl-keyword">return</span> f -&gt; f.log();
}</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="conditional-wiretap" href="#conditional-wiretap"></a>Conditional Wire Taps</h4></div></div></div>

<p>Wire taps can be made conditional, using the <code class="literal">selector</code> or <code class="literal">selector-expression</code> attributes.
The <code class="literal">selector</code> references a <code class="literal">MessageSelector</code> bean, which can determine at runtime whether the message should go to the tap channel.
Similarly, the` selector-expression` is a boolean SpEL expression that performs the same purpose - if the expression evaluates to true, the message will be sent to the tap channel.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="channel-global-wiretap" href="#channel-global-wiretap"></a>Global Wire Tap Configuration</h4></div></div></div>

<p>It is possible to configure a global wire tap as a special case of the <a class="xref" href="#global-channel-configuration-interceptors" title="Global Channel Interceptor Configuration">the section called &#8220;Global Channel Interceptor Configuration&#8221;</a>.
Simply configure a top level <code class="literal">wire-tap</code> element.
Now, in addition to the normal <code class="literal">wire-tap</code> namespace support, the <code class="literal">pattern</code> and <code class="literal">order</code> attributes are supported and work in exactly the same way as with the <code class="literal">channel-interceptor</code></p>
<pre class="programlisting"><span class="hl-tag">&lt;int:wire-tap</span> <span class="hl-attribute">pattern</span>=<span class="hl-value">"input*, bar*, foo"</span> <span class="hl-attribute">order</span>=<span class="hl-value">"3"</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"wiretapChannel"</span><span class="hl-tag">/&gt;</span></pre>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>A global wire tap provides a convenient way to configure a single channel wire tap externally without modifying the existing channel configuration.
Simply set the <code class="literal">pattern</code> attribute to the target channel name.
For example, This technique may be used to configure a test case to verify messages on a channel.</p>
</td></tr></table></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="channel-special-channels" href="#channel-special-channels"></a>4.1.6&nbsp;Special Channels</h3></div></div></div>

<p>If namespace support is enabled, there are two special channels defined within the application context by default: <code class="literal">errorChannel</code> and <code class="literal">nullChannel</code>.
The <span class="emphasis"><em>nullChannel</em></span> acts like <code class="literal">/dev/null</code>, simply logging any Message sent to it at DEBUG level and returning immediately.
Any time you face channel resolution errors for a reply that you don&#8217;t care about, you can set the affected component&#8217;s <code class="literal">output-channel</code> attribute to <span class="emphasis"><em>nullChannel</em></span> (the name <span class="emphasis"><em>nullChannel</em></span> is reserved within the application context).
The <span class="emphasis"><em>errorChannel</em></span> is used internally for sending error messages and may be overridden with a custom configuration.
This is discussed in greater detail in <a class="xref" href="#namespace-errorhandler" title="F.4&nbsp;Error Handling">Section&nbsp;F.4, &#8220;Error Handling&#8221;</a>.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="polling-consumer" href="#polling-consumer"></a>4.2&nbsp;Poller</h2></div></div></div>

<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_polling_consumer" href="#_polling_consumer"></a>4.2.1&nbsp;Polling Consumer</h3></div></div></div>

<p>When Message Endpoints (Channel Adapters) are connected to channels and instantiated, they produce one of the following 2 instances:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="ulink" href="http://static.springsource.org/spring-integration/api/org/springframework/integration/endpoint/PollingConsumer.html" target="_top">PollingConsumer</a>
</li><li class="listitem">
<a class="ulink" href="http://static.springsource.org/spring-integration/api/org/springframework/integration/endpoint/EventDrivenConsumer.html" target="_top">EventDrivenConsumer</a>
</li></ul></div>
<p>The actual implementation depends on which type of channel these Endpoints are connected to.
A channel adapter connected to a channel that implements the <a class="ulink" href="http://docs.spring.io/spring/docs/current/javadoc-api/index.html?org/springframework/messaging/SubscribableChannel.html" target="_top">org.springframework.messaging.SubscribableChannel</a> interface will produce an instance of <code class="literal">EventDrivenConsumer</code>.
On the other hand, a channel adapter connected to a channel that implements the  <a class="ulink" href="http://docs.spring.io/spring/docs/current/javadoc-api/index.html?org/springframework/messaging/PollableChannel.html" target="_top">org.springframework.messaging.PollableChannel</a> interface (e.g. a QueueChannel) will produce an instance of <code class="literal">PollingConsumer</code>.</p>
<p>Polling Consumers allow Spring Integration components to actively poll for Messages, rather than to process Messages in an event-driven manner.</p>
<p>They represent a critical cross cutting concern in many messaging scenarios.
In Spring Integration, Polling Consumers are based on the pattern with the same name, which is described in the book "Enterprise Integration Patterns" by Gregor Hohpe and Bobby Woolf.
You can find a description of the pattern on the book&#8217;s website at:</p>
<p><a class="ulink" href="http://www.enterpriseintegrationpatterns.com/PollingConsumer.html" target="_top">http://www.enterpriseintegrationpatterns.com/PollingConsumer.html</a></p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_pollable_message_source" href="#_pollable_message_source"></a>4.2.2&nbsp;Pollable Message Source</h3></div></div></div>

<p>Furthermore, in Spring Integration a second variation of the Polling Consumer pattern exists.
When Inbound Channel Adapters are being used, these adapters are often wrapped by a <code class="literal">SourcePollingChannelAdapter</code>.
For example, when retrieving messages from a remote FTP Server location, the adapter described in <a class="xref" href="#ftp-inbound" title="15.4&nbsp;FTP Inbound Channel Adapter">Section&nbsp;15.4, &#8220;FTP Inbound Channel Adapter&#8221;</a> is configured with a <span class="emphasis"><em>poller</em></span> to retrieve messages periodically.
So, when components are configured with Pollers, the resulting instances are of one of the following types:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="ulink" href="http://static.springsource.org/spring-integration/api/org/springframework/integration/endpoint/PollingConsumer.html" target="_top">PollingConsumer</a>
</li><li class="listitem">
<a class="ulink" href="http://static.springsource.org/spring-integration/api/org/springframework/integration/endpoint/SourcePollingChannelAdapter.html" target="_top">SourcePollingChannelAdapter</a>
</li></ul></div>
<p>This means, Pollers are used in both inbound and outbound messaging scenarios.
Here are some use-cases that illustrate the scenarios in which Pollers are used:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Polling certain external systems such as FTP Servers, Databases, Web Services
</li><li class="listitem">
Polling internal (pollable) Message Channels
</li><li class="listitem">
Polling internal services (E.g.
repeatedly execute methods on a Java class)
</li></ul></div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>AOP Advice classes can be applied to pollers, in an <code class="literal">advice-chain</code>.
An example being a transaction advice to start a transaction.
Starting with <span class="emphasis"><em>version 4.1</em></span> a <code class="literal">PollSkipAdvice</code> is provided.
Pollers use triggers to determine the time of the next poll.
The <code class="literal">PollSkipAdvice</code> can be used to suppress (skip) a poll, perhaps because there is some downstream condition that would prevent the message to be processed properly.
To use this advice, you have to provide it with an implementation of a <code class="literal">PollSkipStrategy</code>.
Startng with version 4.2.5, a <code class="literal">SimplePollSkipStrategy</code> is provided.
Add an instance as a bean to the application context, inject it into a <code class="literal">PollSkipAdvice</code> and add that to the poller&#8217;s
advice chain.
To skip polling, call <code class="literal">skipPolls()</code>, to resume polling, call <code class="literal">reset()</code>.
<span class="emphasis"><em>Version 4.2</em></span> added more flexibility in this area - see <a class="xref" href="#conditional-pollers" title="4.2.3&nbsp;Conditional Pollers for Message Sources">Section&nbsp;4.2.3, &#8220;Conditional Pollers for Message Sources&#8221;</a>.</p>
</td></tr></table></div>
<p>This chapter is meant to only give a high-level overview regarding Polling Consumers and how they fit into the concept of message channels - <a class="xref" href="#channel" title="4.1&nbsp;Message Channels">Section&nbsp;4.1, &#8220;Message Channels&#8221;</a> and channel adapters - <a class="xref" href="#channel-adapter" title="4.3&nbsp;Channel Adapter">Section&nbsp;4.3, &#8220;Channel Adapter&#8221;</a>.
For more in-depth information regarding Messaging Endpoints in general and Polling Consumers in particular, please see<a class="xref" href="#endpoint" title="8.1&nbsp;Message Endpoints">Section&nbsp;8.1, &#8220;Message Endpoints&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="conditional-pollers" href="#conditional-pollers"></a>4.2.3&nbsp;Conditional Pollers for Message Sources</h3></div></div></div>

<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_background" href="#_background"></a>Background</h4></div></div></div>

<p><code class="literal">Advice</code> objects, in an <code class="literal">advice-chain</code> on a poller, advise the whole polling task (message retrieval and processing).
These "around advice" methods do not have access to any context for the poll, just the poll itself.
This is fine for requirements such as making a task transactional, or skipping a poll due to some external condition as discussed above.
What if we wish to take some action depending on the result of the <code class="literal">receive</code> part of the poll, or if we want to adjust the poller depending on conditions?</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="__smart_polling" href="#__smart_polling"></a>"Smart" Polling</h4></div></div></div>

<p><span class="emphasis"><em>Version 4.2</em></span> introduced the <code class="literal">AbstractMessageSourceAdvice</code>.
Any <code class="literal">Advice</code> objects in the <code class="literal">advice-chain</code> that subclass this class, are applied to just the receive operation.
Such classes implement the following methods:</p>
<pre class="programlisting">beforeReceive(MessageSource&lt;?&gt; source)</pre>
<p>This method is called before the <code class="literal">MessageSource.receive()</code> method.
It enables you to examine and or reconfigure the source at this time. Returning <code class="literal">false</code> cancels this poll (similar to the <code class="literal">PollSkipAdvice</code> mentioned above).</p>
<pre class="programlisting">Message&lt;?&gt; afterReceive(Message&lt;?&gt; result, MessageSource&lt;?&gt; source)</pre>
<p>This method is called after the <code class="literal">receive()</code> method; again, you can reconfigure the source, or take any action perhaps depending on the result (which can be <code class="literal">null</code> if there was no message created by the source).
You can even return a different message!</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important: Advice Chain Ordering"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Advice Chain Ordering</th></tr><tr><td align="left" valign="top">

<p>It is important to understand how the advice chain is processed during initialization.
<code class="literal">Advice</code> objects that do not extend <code class="literal">AbstractMessageSourceAdvice</code> are applied to the whole poll process and are all invoked first, in order, before any <code class="literal">AbstractMessageSourceAdvice</code>; then <code class="literal">AbstractMessageSourceAdvice</code> objects are invoked in order around the <code class="literal">MessageSource</code> <code class="literal">receive()</code> method.
If you have, say <code class="literal">Advice</code> objects <code class="literal">a, b, c, d</code>, where <code class="literal">b</code> and <code class="literal">d</code> are <code class="literal">AbstractMessageSourceAdvice</code>, they will be applied in the order <code class="literal">a, c, b, d</code>.
Also, if a <code class="literal">MessageSource</code> is already a <code class="literal">Proxy</code>, the <code class="literal">AbstractMessageSourceAdvice</code> will be invoked after any existing <code class="literal">Advice</code> objects.
If you wish to change the order, you should wire up the proxy yourself.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_simpleactiveidlemessagesourceadvice" href="#_simpleactiveidlemessagesourceadvice"></a>SimpleActiveIdleMessageSourceAdvice</h4></div></div></div>

<p>This advice is a simple implementation of <code class="literal">AbstractMessageSourceAdvice</code>, when used in conjunction with a <code class="literal">DynamicPeriodicTrigger</code>, it adjusts the polling frequency depending on whether or not the previous poll resulted in a message or not.
The poller must also have a reference to the same <code class="literal">DynamicPeriodicTrigger</code>.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important: Important: Async Handoff"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important: Async Handoff</th></tr><tr><td align="left" valign="top">

<p>This advice modifies the trigger based on the <code class="literal">receive()</code> result.
This will only work if the advice is called on the poller thread.
It will <span class="strong"><strong>not</strong></span> work if the poller has a <code class="literal">task-executor</code>.
To use this advice where you wish to use async operations after the result of a poll, do the async handoff later, perhaps by using an <code class="literal">ExecutorChannel</code>.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_compoundtriggeradvice" href="#_compoundtriggeradvice"></a>CompoundTriggerAdvice</h4></div></div></div>

<p>This advice allows the selection of one of two triggers based on whether a poll returns a message or not.
Consider a poller that uses a <code class="literal">CronTrigger</code>; <code class="literal">CronTrigger</code> s are immutable so cannot be altered once constructed.
Consider a use case where we want to use a cron expression to trigger a poll once each hour but, if no message is
received, poll once per minute and, when a message is retrieved, revert to using the cron expression.</p>
<p>The advice (and poller) use a <code class="literal">CompoundTrigger</code> for this purpose.
The trigger&#8217;s <code class="literal">primary</code> trigger can be a <code class="literal">CronTrigger</code>.
When the advice detects that no message is received, it adds the secondary trigger to the <code class="literal">CompoundTrigger</code>.
When the <code class="literal">CompoundTrigger</code> 's <code class="literal">nextExecutionTime</code> method is invoked, it will delegate to the secondary trigger, if
present; otherwise the primary trigger.</p>
<p>The poller must also have a reference to the same <code class="literal">CompoundTrigger</code>.</p>
<p>The following shows the configuration for the hourly cron expression with fall-back to every minute&#8230;&#8203;</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:inbound-channel-adapter</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"nullChannel"</span> <span class="hl-attribute">auto-startup</span>=<span class="hl-value">"false"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.endpoint.PollerAdviceTests.Source"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">trigger</span>=<span class="hl-value">"compoundTrigger"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;int:advice-chain&gt;</span>
            <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.aop.CompoundTriggerAdvice"</span><span class="hl-tag">&gt;</span>
                <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"compoundTrigger"</span><span class="hl-tag">/&gt;</span>
                <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"secondary"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;/bean&gt;</span>
        <span class="hl-tag">&lt;/int:advice-chain&gt;</span>
    <span class="hl-tag">&lt;/int:poller&gt;</span>
<span class="hl-tag">&lt;/int:inbound-channel-adapter&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"compoundTrigger"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.util.CompoundTrigger"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"primary"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"primary"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.scheduling.support.CronTrigger"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"0 0 * * * *"</span><span class="hl-tag"> /&gt;</span> <span class="hl-comment">&lt;!-- top of every hour --&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"secondary"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.scheduling.support.PeriodicTrigger"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"60000"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important: Important: Async Handoff"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important: Async Handoff</th></tr><tr><td align="left" valign="top">

<p>This advice modifies the trigger based on the <code class="literal">receive()</code> result.
This will only work if the advice is called on the poller thread.
It will <span class="strong"><strong>not</strong></span> work if the poller has a <code class="literal">task-executor</code>.
To use this advice where you wish to use async operations after the result of a poll, do the async handoff later, perhaps by using an <code class="literal">ExecutorChannel</code>.</p>
</td></tr></table></div>
</div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="channel-adapter" href="#channel-adapter"></a>4.3&nbsp;Channel Adapter</h2></div></div></div>

<p>A Channel Adapter is a Message Endpoint that enables connecting a single sender or receiver to a Message Channel.
Spring Integration provides a number of adapters out of the box to support various transports, such as JMS, File, HTTP, Web Services, Mail, and more.
Those will be discussed in upcoming chapters of this reference guide.
However, this chapter focuses on the simple but flexible Method-invoking Channel Adapter support.
There are both inbound and outbound adapters, and each may be configured with XML elements provided in the core namespace.
These provide an easy way to extend Spring Integration as long as you have a method that can be invoked as either a source or destination.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="channel-adapter-namespace-inbound" href="#channel-adapter-namespace-inbound"></a>4.3.1&nbsp;Configuring An Inbound Channel Adapter</h3></div></div></div>

<p>An "inbound-channel-adapter" element can invoke any method on a Spring-managed Object and send a non-null return value to a <code class="literal">MessageChannel</code> after converting it to a <code class="literal">Message</code>.
When the adapter&#8217;s subscription is activated, a poller will attempt to receive messages from the source.
The poller will be scheduled with the <code class="literal">TaskScheduler</code> according to the provided configuration.
To configure the polling interval or cron expression for an individual channel-adapter, provide a <span class="emphasis"><em>poller</em></span> element with one of the scheduling attributes, such as <span class="emphasis"><em>fixed-rate</em></span> or <span class="emphasis"><em>cron</em></span>.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:inbound-channel-adapter</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"source1"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"method1"</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"channel1"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"5000"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:inbound-channel-adapter&gt;</span>

<span class="hl-tag">&lt;int:inbound-channel-adapter</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"source2"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"method2"</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"channel2"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">cron</span>=<span class="hl-value">"30 * 9-17 * * MON-FRI"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:channel-adapter&gt;</span></pre>
<p>Also see <a class="xref" href="#channel-adapter-expressions-and-scripts" title="4.3.3&nbsp;Channel Adapter Expressions and Scripts">Section&nbsp;4.3.3, &#8220;Channel Adapter Expressions and Scripts&#8221;</a>.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>If no poller is provided, then a single default poller must be registered within the context.
See <a class="xref" href="#endpoint-namespace" title="8.1.4&nbsp;Namespace Support">Section&nbsp;8.1.4, &#8220;Namespace Support&#8221;</a> for more detail.</p>
</td></tr></table></div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important: Important: Poller Configuration"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important: Poller Configuration</th></tr><tr><td align="left" valign="top">

<p>Some <code class="literal">inbound-channel-adapter</code> types are backed by a <code class="literal">SourcePollingChannelAdapter</code> which means they contain Poller configuration which will poll the <code class="literal">MessageSource</code> (invoke a custom method which produces the value that becomes a <code class="literal">Message</code> payload) based on the configuration specified in the Poller.</p>
<p>For example:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">max-messages-per-poll</span>=<span class="hl-value">"1"</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"1000"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">max-messages-per-poll</span>=<span class="hl-value">"10"</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"1000"</span><span class="hl-tag">/&gt;</span></pre>
<p>In the the first configuration the polling task will be invoked once per poll and during such task (poll) the method (which results in the production of the Message) will be invoked once based on the <code class="literal">max-messages-per-poll</code> attribute value.
In the second configuration the polling task will be invoked 10 times per poll or until it returns <span class="emphasis"><em>null</em></span> thus possibly producing 10 Messages per poll while each poll happens at 1 second intervals.
However what if the configuration looks like this:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"1000"</span><span class="hl-tag">/&gt;</span></pre>
<p>Note there is no <code class="literal">max-messages-per-poll</code> specified.
As you&#8217;ll learn later the identical poller configuration in the <code class="literal">PollingConsumer</code> (e.g., service-activator, filter, router etc.) would have a default value of -1 for <code class="literal">max-messages-per-poll</code> which means "execute poling task non-stop unless polling method returns null (e.g., no more Messages in the QueueChannel)" and then sleep for 1 second.</p>
<p>However in the SourcePollingChannelAdapter it is a bit different.
The default value for <code class="literal">max-messages-per-poll</code> will be set to 1 by default unless you explicitly set it to a negative value (e.g., -1).
It is done so to make sure that poller can react to a LifeCycle events (e.g., start/stop) and prevent it from potentially spinning in the infinite loop if the implementation of the custom method of the <code class="literal">MessageSource</code> has a potential to never return null and happened to be non-interruptible.</p>
<p>However if you are sure that your method can return null and you need the behavior where you want to poll for as many sources as available per each poll, then you should explicitly set <code class="literal">max-messages-per-poll</code> to a negative value.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">max-messages-per-poll</span>=<span class="hl-value">"-1"</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"1000"</span><span class="hl-tag">/&gt;</span></pre>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="channel-adapter-namespace-outbound" href="#channel-adapter-namespace-outbound"></a>4.3.2&nbsp;Configuring An Outbound Channel Adapter</h3></div></div></div>

<p>An "outbound-channel-adapter" element can also connect a <code class="literal">MessageChannel</code> to any POJO consumer method that should be invoked with the payload of Messages sent to that channel.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:outbound-channel-adapter</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"channel1"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"target"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"handle"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;beans:bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"target"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.Foo"</span><span class="hl-tag">/&gt;</span></pre>
<p>If the channel being adapted is a <code class="literal">PollableChannel</code>, provide a poller sub-element:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:outbound-channel-adapter</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"channel2"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"target"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"handle"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"3000"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/int:outbound-channel-adapter&gt;</span>

<span class="hl-tag">&lt;beans:bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"target"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.Foo"</span><span class="hl-tag">/&gt;</span></pre>
<p>Using a "ref" attribute is generally recommended if the POJO consumer implementation can be reused in other <code class="literal">&lt;outbound-channel-adapter&gt;</code> definitions.
However if the consumer implementation is only referenced by a single definition of the <code class="literal">&lt;outbound-channel-adapter&gt;</code>, you can define it as inner bean:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:outbound-channel-adapter</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"channel"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"handle"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;beans:bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.Foo"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:outbound-channel-adapter&gt;</span></pre>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Using both the "ref" attribute and an inner handler definition in the same <code class="literal">&lt;outbound-channel-adapter&gt;</code> configuration is not allowed as it creates an ambiguous condition.
Such a configuration will result in an Exception being thrown.</p>
</td></tr></table></div>
<p>Any Channel Adapter can be created without a "channel" reference in which case it will implicitly create an instance of <code class="literal">DirectChannel</code>.
The created channel&#8217;s name will match the "id" attribute of the <code class="literal">&lt;inbound-channel-adapter&gt;</code> or <code class="literal">&lt;outbound-channel-adapter&gt;</code> element.
Therefore, if the "channel" is not provided, the "id" is required.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="channel-adapter-expressions-and-scripts" href="#channel-adapter-expressions-and-scripts"></a>4.3.3&nbsp;Channel Adapter Expressions and Scripts</h3></div></div></div>

<p>Like many other Spring Integration components, the <code class="literal">&lt;inbound-channel-adapter&gt;</code> and <code class="literal">&lt;outbound-channel-adapter&gt;</code> also provide support for SpEL expression evaluation.
To use SpEL, provide the expression string via the <span class="emphasis"><em>expression</em></span> attribute instead of providing the <span class="emphasis"><em>ref</em></span> and <span class="emphasis"><em>method</em></span> attributes that are used for method-invocation on a bean.
When an Expression is evaluated, it follows the same contract as method-invocation where: the <span class="emphasis"><em>expression</em></span> for an <code class="literal">&lt;inbound-channel-adapter&gt;</code> will generate a message anytime the evaluation result is a <span class="emphasis"><em>non-null</em></span> value, while the <span class="emphasis"><em>expression</em></span> for an <code class="literal">&lt;outbound-channel-adapter&gt;</code> must be the equivalent of a <span class="emphasis"><em>void</em></span> returning method invocation.</p>
<p>Starting with Spring Integration 3.0, an <code class="literal">&lt;int:inbound-channel-adapter/&gt;</code> can also be configured with a SpEL <code class="literal">&lt;expression/&gt;</code> (or even with <code class="literal">&lt;script/&gt;</code>) sub-element, for when more sophistication is required than can be achieved with the simple <span class="emphasis"><em>expression</em></span> attribute.
If you provide a script as a <code class="literal">Resource</code> using the <code class="literal">location</code> attribute, you can also set the <span class="emphasis"><em>refresh-check-delay</em></span> allowing the resource to be refreshed periodically.
If you want the script to be checked on each poll, you would need to coordinate this setting with the poller&#8217;s trigger:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:inbound-channel-adapter</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"source1"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"method1"</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"channel1"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">max-messages-per-poll</span>=<span class="hl-value">"1"</span> <span class="hl-attribute">fixed-delay</span>=<span class="hl-value">"5000"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;script:script</span> <span class="hl-attribute">lang</span>=<span class="hl-value">"ruby"</span> <span class="hl-attribute">location</span>=<span class="hl-value">"Foo.rb"</span> <span class="hl-attribute">refresh-check-delay</span>=<span class="hl-value">"5000"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:inbound-channel-adapter&gt;</span></pre>
<p>Also see the <code class="literal">cacheSeconds</code> property on the <code class="literal">ReloadableResourceBundleExpressionSource</code> when using the <code class="literal">&lt;expression/&gt;</code> sub-element.
For more information regarding expressions see <a class="xref" href="#spel" title="Appendix&nbsp;A.&nbsp;Spring Expression Language (SpEL)">Appendix&nbsp;A, <i>Spring Expression Language (SpEL)</i></a>, and for scripts - <a class="xref" href="#groovy" title="8.8&nbsp;Groovy support">Section&nbsp;8.8, &#8220;Groovy support&#8221;</a> and <a class="xref" href="#scripting" title="8.7&nbsp;Scripting support">Section&nbsp;8.7, &#8220;Scripting support&#8221;</a>.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>The <code class="literal">&lt;int:inbound-channel-adapter/&gt;</code> is an endpoint that starts a message flow via periodic triggering to poll some underlying <code class="literal">MessageSource</code>.
Since, at the time of polling, there is not yet a message object, expressions and scripts don&#8217;t have access to a root <code class="literal">Message</code>, so there are no <span class="emphasis"><em>payload</em></span> or <span class="emphasis"><em>headers</em></span> properties that are available in most other messaging SpEL expressions.
Of course, the script <span class="strong"><strong>can</strong></span> generate and return a complete <code class="literal">Message</code> object with headers and payload, or just a payload, which will be added to a message with basic headers.</p>
</td></tr></table></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="bridge" href="#bridge"></a>4.4&nbsp;Messaging Bridge</h2></div></div></div>

<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="bridge-introduction" href="#bridge-introduction"></a>4.4.1&nbsp;Introduction</h3></div></div></div>

<p>A Messaging Bridge is a relatively trivial endpoint that simply connects two Message Channels or Channel Adapters.
For example, you may want to connect a <code class="literal">PollableChannel</code> to a <code class="literal">SubscribableChannel</code> so that the subscribing endpoints do not have to worry about any polling configuration.
Instead, the Messaging Bridge provides the polling configuration.</p>
<p>By providing an intermediary poller between two channels, a Messaging Bridge can be used to throttle inbound Messages.
The poller&#8217;s trigger will determine the rate at which messages arrive on the second channel, and the poller&#8217;s "maxMessagesPerPoll" property will enforce a limit on the throughput.</p>
<p>Another valid use for a Messaging Bridge is to connect two different systems.
In such a scenario, Spring Integration&#8217;s role would be limited to making the connection between these systems and managing a poller if necessary.
It is probably more common to have at least a <span class="emphasis"><em>Transformer</em></span> between the two systems to translate between their formats, and in that case, the channels would be provided as the <span class="emphasis"><em>input-channel</em></span> and <span class="emphasis"><em>output-channel</em></span> of a Transformer endpoint.
If data format translation is not required, the Messaging Bridge may indeed be sufficient.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="bridge-namespace" href="#bridge-namespace"></a>4.4.2&nbsp;Configuring Bridge</h3></div></div></div>

<p>The &lt;bridge&gt; element is used to create a Messaging Bridge between two Message Channels or Channel Adapters.
Simply provide the "input-channel" and "output-channel" attributes:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:bridge</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span><span class="hl-tag">/&gt;</span></pre>
<p>As mentioned above, a common use case for the Messaging Bridge is to connect a <code class="literal">PollableChannel</code> to a <code class="literal">SubscribableChannel</code>, and when performing this role, the Messaging Bridge may also serve as a throttler:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:bridge</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"pollable"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"subscribable"</span><span class="hl-tag">&gt;</span>
     <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">max-messages-per-poll</span>=<span class="hl-value">"10"</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"5000"</span><span class="hl-tag">/&gt;</span>
 <span class="hl-tag">&lt;/int:bridge&gt;</span></pre>
<p>Connecting Channel Adapters is just as easy.
Here is a simple echo example between the "stdin" and "stdout" adapters from Spring Integration&#8217;s "stream" namespace.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-stream:stdin-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"stdin"</span><span class="hl-tag">/&gt;</span>

 <span class="hl-tag">&lt;int-stream:stdout-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"stdout"</span><span class="hl-tag">/&gt;</span>

 <span class="hl-tag">&lt;int:bridge</span> <span class="hl-attribute">id</span>=<span class="hl-value">"echo"</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"stdin"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"stdout"</span><span class="hl-tag">/&gt;</span></pre>
<p>Of course, the configuration would be similar for other (potentially more useful) Channel Adapter bridges, such as File to JMS, or Mail to File.
The various Channel Adapters will be discussed in upcoming chapters.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>If no <span class="emphasis"><em>output-channel</em></span> is defined on a bridge, the reply channel provided by the inbound Message will be used, if available.
If neither output or reply channel is available, an Exception will be thrown.</p>
</td></tr></table></div>
</div>
</div>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="messaging-construction-chapter" href="#messaging-construction-chapter"></a>5.&nbsp;Message Construction</h2></div></div></div>

<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="message" href="#message"></a>5.1&nbsp;Message</h2></div></div></div>

<p>The Spring Integration <code class="literal">Message</code> is a generic container for data.
Any object can be provided as the payload, and each <code class="literal">Message</code> also includes headers containing user-extensible properties as key-value pairs.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="message-interface" href="#message-interface"></a>5.1.1&nbsp;The Message Interface</h3></div></div></div>

<p>Here is the definition of the <code class="literal">Message</code> interface:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> Message&lt;T&gt; {

    T getPayload();

    MessageHeaders getHeaders();

}</pre>
<p>The <code class="literal">Message</code> is obviously a very important part of the API.
By encapsulating the data in a generic wrapper, the messaging system can pass it around without any knowledge of the data&#8217;s type.
As an application evolves to support new types, or when the types themselves are modified and/or extended, the messaging system will not be affected by such changes.
On the other hand, when some component in the messaging system <span class="emphasis"><em>does</em></span> require access to information about the <code class="literal">Message</code>, such metadata can typically be stored to and retrieved from the metadata in the Message Headers.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="message-headers" href="#message-headers"></a>5.1.2&nbsp;Message Headers</h3></div></div></div>

<p>Just as Spring Integration allows any Object to be used as the payload of a Message, it also supports any Object types as header values.
In fact, the <code class="literal">MessageHeaders</code> class implements the <span class="emphasis"><em>java.util.Map</em></span> interface:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">final</span> <span class="hl-keyword">class</span> MessageHeaders <span class="hl-keyword">implements</span> Map&lt;String, Object&gt;, Serializable {
  ...
}</pre>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Even though the MessageHeaders implements Map, it is effectively a read-only implementation.
Any attempt to <span class="emphasis"><em>put</em></span> a value in the Map will result in an <code class="literal">UnsupportedOperationException</code>.
The same applies for <span class="emphasis"><em>remove</em></span> and <span class="emphasis"><em>clear</em></span>.
Since Messages may be passed to multiple consumers, the structure of the Map cannot be modified.
Likewise, the Message&#8217;s payload Object can not be <span class="emphasis"><em>set</em></span> after the initial creation.
However, the mutability of the header values themselves (or the payload Object) is intentionally left as a decision for the framework user.</p>
</td></tr></table></div>
<p>As an implementation of Map, the headers can obviously be retrieved by calling <code class="literal">get(..)</code> with the name of the header.
Alternatively, you can provide the expected <span class="emphasis"><em>Class</em></span> as an additional parameter.
Even better, when retrieving one of the pre-defined values, convenient getters are available.
Here is an example of each of these three options:</p>
<pre class="programlisting"> Object someValue = message.getHeaders().get(<span class="hl-string">"someKey"</span>);

 CustomerId customerId = message.getHeaders().get(<span class="hl-string">"customerId"</span>, CustomerId.<span class="hl-keyword">class</span>);

 Long timestamp = message.getHeaders().getTimestamp();</pre>
<p>The following Message headers are pre-defined:</p>
<div class="table"><a name="d5e1710" href="#d5e1710"></a><p class="title"><b>Table&nbsp;5.1.&nbsp;Pre-defined Message Headers</b></p><div class="table-contents">

<table summary="Pre-defined Message Headers" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Header Name</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Header Type</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Usage</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><pre class="literallayout">MessageHeaders.ID</pre></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><pre class="literallayout">java.util.UUID</pre></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>An identifier for this message instance.
Changes each time a message is mutated.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><pre class="literallayout">MessageHeaders.
    TIMESTAMP</pre></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><pre class="literallayout">java.lang.Long</pre></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The time the message was created.
Changes each time a message is mutated.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><pre class="literallayout">MessageHeaders.
    REPLY_CHANNEL</pre></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><pre class="literallayout">java.lang.Object
(String or MessageChannel)</pre></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>A channel to which a reply (if any) will be sent when no explicit output channel is configured and there is no <code class="literal">ROUTING_SLIP</code> or the <code class="literal">ROUTING_SLIP</code> is exhausted.
If the value is a <code class="literal">String</code> it must represent a bean name, or have been generated by a <code class="literal">ChannelRegistry.</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><pre class="literallayout">MessageHeaders.
    ERROR_CHANNEL</pre></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><pre class="literallayout">java.lang.Object
(String or MessageChannel)</pre></td><td style="" align="left" valign="top"><p>A channel to which errors will be sent.
If the value is a <code class="literal">String</code> it must represent a bean name, or have been generated by a <code class="literal">ChannelRegistry.</code></p></td></tr></tbody></table>
</div></div><br class="table-break">
<p>Many inbound and outbound adapter implementations will also provide and/or expect certain headers, and additional user-defined headers can also be configured.
Constants for these headers can be found in those modules where such headers exist, for example <code class="literal">AmqpHeaders</code>, <code class="literal">JmsHeaders</code> etc.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="message-header-accessor" href="#message-header-accessor"></a>MessageHeaderAccessor API</h4></div></div></div>

<p>Starting with Spring Framework 4.0 and Spring Integration 4.0, the core Messaging abstraction has been moved to the <span class="emphasis"><em>spring-messaging</em></span> module and the new <code class="literal">MessageHeaderAccessor</code> API has been introduced to provide additional abstraction over Messaging implementations.
All (core) Spring Integration specific Message Headers constants are now declared in the <code class="literal">IntegrationMessageHeaderAccessor</code> class:</p>
<div class="table"><a name="d5e1765" href="#d5e1765"></a><p class="title"><b>Table&nbsp;5.2.&nbsp;Pre-defined Message Headers</b></p><div class="table-contents">

<table summary="Pre-defined Message Headers" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Header Name</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Header Type</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Usage</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><pre class="literallayout">IntegrationMessageHeaderAccessor.
    CORRELATION_ID</pre></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><pre class="literallayout">java.lang.Object</pre></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Used to correlate two or more messages.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><pre class="literallayout">IntegrationMessageHeaderAccessor.
    SEQUENCE_NUMBER</pre></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><pre class="literallayout">java.lang.Integer</pre></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Usually a sequence number with a group of messages with a <code class="literal">SEQUENCE_SIZE</code> but can also be used in a <code class="literal">&lt;resequencer/&gt;</code> to resequence an unbounded group of messages.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><pre class="literallayout">IntegrationMessageHeaderAccessor.
    SEQUENCE_SIZE</pre></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><pre class="literallayout">java.lang.Integer</pre></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The number of messages within a group of correlated messages.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><pre class="literallayout">IntegrationMessageHeaderAccessor.
    EXPIRATION_DATE</pre></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><pre class="literallayout">java.lang.Long</pre></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Indicates when a message is expired.
Not used by the framework directly but can be set with a header enricher and used in a <code class="literal">&lt;filter/&gt;</code> configured with an <code class="literal">UnexpiredMessageSelector</code>.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><pre class="literallayout">IntegrationMessageHeaderAccessor.
    PRIORITY</pre></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><pre class="literallayout">java.lang.Integer</pre></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Message priority; for example within a <code class="literal">PriorityChannel</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><pre class="literallayout">IntegrationMessageHeaderAccessor.
    DUPLICATE_MESSAGE</pre></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><pre class="literallayout">java.lang.Boolean</pre></td><td style="" align="left" valign="top"><p>True if a message was detected as a duplicate by an idempotent receiver interceptor.
See <a class="xref" href="#idempotent-receiver" title="8.9.10&nbsp;Idempotent Receiver Enterprise Integration Pattern">Section&nbsp;8.9.10, &#8220;Idempotent Receiver Enterprise Integration Pattern&#8221;</a>.</p></td></tr></tbody></table>
</div></div><br class="table-break">
<p>Convenient typed getters for some of these headers are provided on the <code class="literal">IntegrationMessageHeaderAccessor</code> class:</p>
<pre class="programlisting">IntegrationMessageHeaderAccessor accessor = <span class="hl-keyword">new</span> IntegrationMessageHeaderAccessor(message);
<span class="hl-keyword">int</span> sequenceNumber = accessor.getSequenceNumber();
Object correlationId = accessor.getCorrelationId();
...</pre>
<p>The following headers also appear in the <code class="literal">IntegrationMessageHeaderAccessor</code> but are generally not used by user code; their inclusion here is for completeness:</p>
<div class="table"><a name="d5e1830" href="#d5e1830"></a><p class="title"><b>Table&nbsp;5.3.&nbsp;Pre-defined Message Headers</b></p><div class="table-contents">

<table summary="Pre-defined Message Headers" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Header Name</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Header Type</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Usage</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><pre class="literallayout">IntegrationMessageHeaderAccessor.
    SEQUENCE_DETAILS</pre></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><pre class="literallayout">java.util.List&lt;
List&lt;Object&gt;&gt;</pre></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>A stack of correlation data used when nested correlation is needed (e.g.
<code class="literal">splitter-&gt;...-&gt;splitter-&gt;...-&gt;aggregator-&gt;...-&gt;aggregator</code>).</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><pre class="literallayout">IntegrationMessageHeaderAccessor.
    ROUTING_SLIP</pre></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><pre class="literallayout">java.util.Map&lt;
List&lt;Object&gt;, Integer&gt;</pre></td><td style="" align="left" valign="top"><p>See <a class="xref" href="#routing-slip" title="Routing Slip">the section called &#8220;Routing Slip&#8221;</a>.</p></td></tr></tbody></table>
</div></div><br class="table-break">
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="message-id-generation" href="#message-id-generation"></a>Message ID Generation</h4></div></div></div>

<p>When a message transitions through an application, each time it is mutated (e.g.
by a transformer) a new message id is assigned.
The message id is a <code class="literal">UUID</code>.
Beginning with <span class="emphasis"><em>Spring Integration 3.0</em></span>, the default strategy used for id generation is more efficient than the previous <code class="literal">java.util.UUID.randomUUID()</code> implementation.
It uses simple random numbers based on a secure random seed, instead of creating a secure random number each time.</p>
<p>A different UUID generation strategy can be selected by declaring a bean that implements <code class="literal">org.springframework.util.IdGenerator</code> in the application context.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Only one UUID generation strategy can be used in a classloader.
This means that if two or more application contexts are running in the same classloader, they will share the same strategy.
If one of the contexts changes the strategy, it will be used by all contexts.
If two or more contexts in the same classloader declare a bean of type <code class="literal">org.springframework.util.IdGenerator</code>, they must all be an instance of the same class, otherwise the context attempting to replace a custom strategy will fail to initialize.
If the strategy is the same, but parameterized, the strategy in the first context to initialize will be used.</p>
</td></tr></table></div>
<p>In addition to the default strategy, two additional <code class="literal">IdGenerators</code> are provided; <code class="literal">org.springframework.util.JdkIdGenerator</code> uses the previous <code class="literal">UUID.randomUUID()</code> mechanism; <code class="literal">o.s.i.support.IdGenerators.SimpleIncrementingIdGenerator</code> can be used in cases where a UUID is not really needed and a simple incrementing value is sufficient.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="read-only-headers" href="#read-only-headers"></a>Read-only Headers</h4></div></div></div>

<p>The <code class="literal">MessageHeaders.ID</code> and <code class="literal">MessageHeaders.TIMESTAMP</code> are read-only headers and they cannot be overridden.</p>
<p>Since <span class="emphasis"><em>version 4.3.2</em></span>, the <code class="literal">MessageBuilder</code> provides the <code class="literal">readOnlyHeaders(String... readOnlyHeaders)</code> API to customize a list of headers which should not be copied from an upstream <code class="literal">Message</code>.
Just the <code class="literal">MessageHeaders.ID</code> and <code class="literal">MessageHeaders.TIMESTAMP</code> are read only by default.
The global <code class="literal">spring.integration.readOnly.headers</code> property (see <a class="xref" href="#global-properties" title="F.5&nbsp;Global Properties">Section&nbsp;F.5, &#8220;Global Properties&#8221;</a>) is provided to customize <code class="literal">DefaultMessageBuilderFactory</code> for Framework components.
This can be useful when you would like do not populate some out-of-the-box headers, like <code class="literal">contentType</code> by the <code class="literal">ObjectToJsonTransformer</code> (see <a class="xref" href="#">???</a>).</p>
<p>When you try to build a new message using <code class="literal">MessageBuilder</code>, this kind of headers are ignored and particular <code class="literal">INFO</code> message is emitted to logs.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="header-propagation" href="#header-propagation"></a>Header Propagation</h4></div></div></div>

<p>When messages are processed (and modified) by message-producing endpoints (such as a <a class="link" href="#service-activator" title="8.5&nbsp;Service Activator">service activator</a>), in general, inbound headers are propagated to the outbound message.
One exception to this is a <a class="link" href="#transformer" title="7.1&nbsp;Transformer">transformer</a>, when a complete message is returned to the framework; in that case, the user code is responsible for the entire outbound message.
When a transformer just returns the payload; the inbound headers <span class="strong"><strong>are</strong></span> propagated.
Also, a header is only propagated if it does not already exist in the outbound message, allowing user code to change header values as needed.</p>
<p>Starting with <span class="emphasis"><em>version 4.3.10</em></span>, you can configure message handlers (that modify messages and produce output) to suppress the propagation of specific headers.
Call the <code class="literal">setNotPropagatedHeaders()</code> or <code class="literal">addNotPropagatedHeaders()</code> methods on the <code class="literal">MessageProducingMessageHandler</code> abstract class, to configure the header(s) you don&#8217;t want to be copied.
You can also globally suppress propagation of specific message headers by setting the <code class="literal">readOnlyHeaders</code> property in <code class="literal">META-INF/spring.integration.properties</code> to a comma-delimited list of headers.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Header propagation suppression does not apply to those endpoints that don&#8217;t modify the message, e.g. <a class="link" href="#bridge" title="4.4&nbsp;Messaging Bridge">bridges</a> and <a class="link" href="#router" title="6.1&nbsp;Routers">routers</a></p>
</td></tr></table></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="message-implementations" href="#message-implementations"></a>5.1.3&nbsp;Message Implementations</h3></div></div></div>

<p>The base implementation of the <code class="literal">Message</code> interface is <code class="literal">GenericMessage&lt;T&gt;</code>, and it provides two constructors:</p>
<pre class="programlisting"><span class="hl-keyword">new</span> GenericMessage&lt;T&gt;(T payload);

<span class="hl-keyword">new</span> GenericMessage&lt;T&gt;(T payload, Map&lt;String, Object&gt; headers)</pre>
<p>When a Message is created, a random unique id will be generated.
The constructor that accepts a Map of headers will copy the provided headers to the newly created Message.</p>
<p>There is also a convenient implementation of <code class="literal">Message</code> designed to communicate error conditions.
This implementation takes <code class="literal">Throwable</code> object as its payload:</p>
<pre class="programlisting">ErrorMessage message = <span class="hl-keyword">new</span> ErrorMessage(someThrowable);

Throwable t = message.getPayload();</pre>
<p>Notice that this implementation takes advantage of the fact that the <code class="literal">GenericMessage</code> base class is parameterized.
Therefore, as shown in both examples, no casting is necessary when retrieving the Message payload Object.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="message-builder" href="#message-builder"></a>5.1.4&nbsp;The MessageBuilder Helper Class</h3></div></div></div>

<p>You may notice that the Message interface defines retrieval methods for its payload and headers but no setters.
The reason for this is that a Message cannot be modified after its initial creation.
Therefore, when a Message instance is sent to multiple consumers (e.g.
through a Publish Subscribe Channel), if one of those consumers needs to send a reply with a different payload type, it will need to create a new Message.
As a result, the other consumers are not affected by those changes.
Keep in mind, that multiple consumers may access the same payload instance or header value, and whether such an instance is itself immutable is a decision left to the developer.
In other words, the contract for Messages is similar to that of an <span class="emphasis"><em>unmodifiable Collection</em></span>, and the MessageHeaders' map further exemplifies that; even though the MessageHeaders class implements <code class="literal">java.util.Map</code>, any attempt to invoke a <span class="emphasis"><em>put</em></span> operation (or <span class="emphasis"><em>remove</em></span> or <span class="emphasis"><em>clear</em></span>) on the MessageHeaders will result in an <code class="literal">UnsupportedOperationException</code>.</p>
<p>Rather than requiring the creation and population of a Map to pass into the GenericMessage constructor, Spring Integration does provide a far more convenient way to construct Messages: <code class="literal">MessageBuilder</code>.
The MessageBuilder provides two factory methods for creating Messages from either an existing Message or with a payload Object.
When building from an existing Message, the headers <span class="emphasis"><em>and payload</em></span> of that Message will be copied to the new Message:</p>
<pre class="programlisting">Message&lt;String&gt; message1 = MessageBuilder.withPayload(<span class="hl-string">"test"</span>)
        .setHeader(<span class="hl-string">"foo"</span>, <span class="hl-string">"bar"</span>)
        .build();

Message&lt;String&gt; message2 = MessageBuilder.fromMessage(message1).build();

assertEquals(<span class="hl-string">"test"</span>, message2.getPayload());
assertEquals(<span class="hl-string">"bar"</span>, message2.getHeaders().get(<span class="hl-string">"foo"</span>));</pre>
<p>If you need to create a Message with a new payload but still want to copy the headers from an existing Message, you can use one of the <span class="emphasis"><em>copy</em></span> methods.</p>
<pre class="programlisting">Message&lt;String&gt; message3 = MessageBuilder.withPayload(<span class="hl-string">"test3"</span>)
        .copyHeaders(message1.getHeaders())
        .build();

Message&lt;String&gt; message4 = MessageBuilder.withPayload(<span class="hl-string">"test4"</span>)
        .setHeader(<span class="hl-string">"foo"</span>, <span class="hl-number">123</span>)
        .copyHeadersIfAbsent(message1.getHeaders())
        .build();

assertEquals(<span class="hl-string">"bar"</span>, message3.getHeaders().get(<span class="hl-string">"foo"</span>));
assertEquals(<span class="hl-number">123</span>, message4.getHeaders().get(<span class="hl-string">"foo"</span>));</pre>
<p>Notice that the <code class="literal">copyHeadersIfAbsent</code> does not overwrite existing values.
Also, in the second example above, you can see how to set any user-defined header with <code class="literal">setHeader</code>.
Finally, there are set methods available for the predefined headers as well as a non-destructive method for setting any header (MessageHeaders also defines constants for the pre-defined header names).</p>
<pre class="programlisting">Message&lt;Integer&gt; importantMessage = MessageBuilder.withPayload(<span class="hl-number">99</span>)
        .setPriority(<span class="hl-number">5</span>)
        .build();

assertEquals(<span class="hl-number">5</span>, importantMessage.getHeaders().getPriority());

Message&lt;Integer&gt; lessImportantMessage = MessageBuilder.fromMessage(importantMessage)
        .setHeaderIfAbsent(IntegrationMessageHeaderAccessor.PRIORITY, <span class="hl-number">2</span>)
        .build();

assertEquals(<span class="hl-number">2</span>, lessImportantMessage.getHeaders().getPriority());</pre>
<p>The <code class="literal">priority</code> header is only considered when using a <code class="literal">PriorityChannel</code> (as described in the next chapter).
It is defined as <span class="emphasis"><em>java.lang.Integer</em></span>.</p>
</div>
</div>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="messaging-routing-chapter" href="#messaging-routing-chapter"></a>6.&nbsp;Message Routing</h2></div></div></div>

<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="router" href="#router"></a>6.1&nbsp;Routers</h2></div></div></div>

<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="router-overview" href="#router-overview"></a>6.1.1&nbsp;Overview</h3></div></div></div>

<p>Routers are a crucial element in many messaging architectures.
They consume Messages from a Message Channel and forward each consumed message to one or more different Message Channel depending on a set of conditions.</p>
<p>Spring Integration provides the following routers out-of-the-box:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="emphasis"><em><a class="link" href="#router-implementations-payloadtyperouter" title="PayloadTypeRouter">Payload Type Router</a></em></span>
</li><li class="listitem">
<span class="emphasis"><em><a class="link" href="#router-implementations-headervaluerouter" title="HeaderValueRouter">Header Value Router</a></em></span>
</li><li class="listitem">
<span class="emphasis"><em><a class="link" href="#router-implementations-recipientlistrouter" title="RecipientListRouter">Recipient List Router</a></em></span>
</li><li class="listitem">
<span class="emphasis"><em><a class="link" href="#xml-xpath-routing" title="35.6&nbsp;Routing XML Messages Using XPath">XPath Router (Part of the XML Module)</a></em></span>
</li><li class="listitem">
<span class="emphasis"><em><a class="link" href="#router-implementations-exception-router" title="Routing and Error handling">Error Message Exception Type Router</a></em></span>
</li><li class="listitem">
<span class="emphasis"><em><a class="link" href="#router-namespace" title="6.1.4&nbsp;Configuring (Generic) Router">(Generic) Router</a></em></span>
</li></ul></div>
<p>Router implementations share many configuration parameters.
Yet, certain differences exist between routers.
Furthermore, the availability of configuration parameters depends on whether Routers are used inside or outside of a chain.
In order to provide a quick overview, all available attributes are listed in the 2 tables below.</p>
<div class="table"><a name="d5e1983" href="#d5e1983"></a><p class="title"><b>Table&nbsp;6.1.&nbsp;Routers Outside of a Chain</b></p><div class="table-contents">

<table summary="Routers Outside of a Chain" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"><col class="col_4"><col class="col_5"><col class="col_6"><col class="col_7"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Attribute</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">router</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">header value router</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">xpath router</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">payload type router</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">recipient list router</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">exception type router</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>apply-sequence</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>default-output-channel</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>resolution-required</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>ignore-send-failures</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>timeout</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>id</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>auto-startup</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>input-channel</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>order</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>method</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>ref</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>expression</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>header-name</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>evaluate-as-string</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>xpath-expression-ref</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>converter</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="" align="left" valign="top">&nbsp;</td></tr></tbody></table>
</div></div><br class="table-break">
<div class="table"><a name="d5e2513" href="#d5e2513"></a><p class="title"><b>Table&nbsp;6.2.&nbsp;Routers Inside of a Chain</b></p><div class="table-contents">

<table summary="Routers Inside of a Chain" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"><col class="col_4"><col class="col_5"><col class="col_6"><col class="col_7"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Attribute</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">router</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">header value router</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">xpath router</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">payload type router</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">recipient list router</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">exception type router</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>apply-sequence</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>default-output-channel</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>resolution-required</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>ignore-send-failures</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>timeout</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>id</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>auto-startup</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>input-channel</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>order</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>method</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>ref</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>expression</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>header-name</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>evaluate-as-string</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>xpath-expression-ref</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>converter</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="" align="left" valign="top">&nbsp;</td></tr></tbody></table>
</div></div><br class="table-break">
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Router parameters have been more standardized across all router implementations with Spring Integration 2.1.
Consequently, there are a few minor changes that leave the possibility of breaking older Spring Integration based applications.</p>
<p>Since Spring Integration 2.1 the <code class="literal">ignore-channel-name-resolution-failures</code> attribute is removed in favor of consolidating its behavior with the <code class="literal">resolution-required</code> attribute.
Also, the <code class="literal">resolution-required</code> attribute now defaults to <code class="literal">true</code>.</p>
<p>Prior to these changes, the <code class="literal">resolution-required</code> attribute defaulted to <code class="literal">false</code> causing messages to be silently dropped when no channel was resolved and no <code class="literal">default-output-channel</code> was set.
The new behavior will require at least one resolved channel and by default will throw an <code class="literal">MessageDeliveryException</code> if no channel was determined (or an attempt to send was not successful).</p>
<p>If you do desire to drop messages silently simply set <code class="literal">default-output-channel="nullChannel"</code>.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="router-common-parameters" href="#router-common-parameters"></a>6.1.2&nbsp;Common Router Parameters</h3></div></div></div>

<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="router-common-parameters-all" href="#router-common-parameters-all"></a>Inside and Outside of a Chain</h4></div></div></div>

<p>The following parameters are valid for all routers inside and outside of chains.</p>
<div class="variablelist"><dl class="variablelist"><dt><span class="term"><span class="strong"><strong>apply-sequence</strong></span></span></dt><dd>
This attribute specifies whether sequence number and size headers should be added to each Message.
This <span class="emphasis"><em>optional</em></span> attribute defaults to <span class="emphasis"><em>false</em></span>.
</dd><dt><span class="term"><span class="strong"><strong>default-output-channel</strong></span></span></dt><dd>
If set, this attribute provides a reference to the channel, where Messages should be sent, if channel resolution fails to return any channels.
If no default output channel is provided, the router will throw an Exception.
If you would like to silently drop those messages instead, add the <code class="literal">nullChannel</code> as the default output channel attribute value.
</dd></dl></div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>A Message will only be sent to the <code class="literal">default-output-channel</code> if <code class="literal">resolution-required</code> is false and the channel is not resolved.</p>
</td></tr></table></div>
<div class="variablelist"><dl class="variablelist"><dt><span class="term"><span class="strong"><strong>resolution-required</strong></span></span></dt><dd>
If <span class="emphasis"><em>true</em></span> this attribute specifies that channel names must always be successfully resolved to channel instances that exist.
If set to <span class="emphasis"><em>true</em></span>, a <code class="literal">MessagingException</code> will be raised, in case the channel cannot be resolved.
Setting this attribute to <span class="emphasis"><em>false</em></span>, will cause any unresovable channels to be ignored.
This <span class="emphasis"><em>optional</em></span> attribute will, if not explicitly set, default to <span class="emphasis"><em>true</em></span>.
</dd></dl></div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>A Message will only be sent to the <code class="literal">default-output-channel</code>, if specified, when <code class="literal">resolution-required</code> is false and the channel is not resolved.</p>
</td></tr></table></div>
<div class="variablelist"><dl class="variablelist"><dt><span class="term"><span class="strong"><strong>ignore-send-failures</strong></span></span></dt><dd>
If set to <span class="emphasis"><em>true</em></span>, failures to send to a message channel will be ignored.
If set to <span class="emphasis"><em>false</em></span>, a <code class="literal">MessageDeliveryException</code> will be thrown instead, and if the router resolves more than one channel, any subsequent channels will not receive the message.
</dd></dl></div>
<p>The exact behavior of this attribute depends on the type of the <code class="literal">Channel</code> messages are sent to.
For example, when using direct channels (single threaded), send-failures can be caused by exceptions thrown by components much further down-stream.
However, when sending messages to a simple queue channel (asynchronous) the likelihood of an exception to be thrown is rather remote.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>While most routers will route to a single channel, they are allowed to return more than one channel name.
The <code class="literal">recipient-list-router</code>, for instance, does exactly that.
If you set this attribute to <span class="emphasis"><em>true</em></span> on a router that only routes to a single channel, any caused exception is simply swallowed, which usually makes little sense to do.
In that case it would be better to catch the exception in an error flow at the flow entry point.
Therefore, setting the <code class="literal">ignore-send-failures</code> attribute to <span class="emphasis"><em>true</em></span> usually makes more sense when the router implementation returns more than one channel name, because the other channel(s) following the one that fails would still receive the Message.</p>
</td></tr></table></div>
<p>This attribute defaults to <span class="emphasis"><em>false</em></span>.</p>
<div class="variablelist"><dl class="variablelist"><dt><span class="term"><span class="strong"><strong>timeout</strong></span></span></dt><dd>
The <code class="literal">timeout</code> attribute specifies the maximum amount of time in milliseconds to wait, when sending Messages to the target Message Channels.
By default the send operation will block indefinitely.
</dd></dl></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="router-common-parameters-top" href="#router-common-parameters-top"></a>Top-Level (Outside of a Chain)</h4></div></div></div>

<p>The following parameters are valid only across all top-level routers that are ourside of chains.</p>
<div class="variablelist"><dl class="variablelist"><dt><span class="term"><span class="strong"><strong>id</strong></span></span></dt><dd>
Identifies the underlying Spring bean definition which in case of Routers is an instance of EventDrivenConsumer or PollingConsumer depending on whether the Router&#8217;s <span class="emphasis"><em>input-channel</em></span> is a <span class="emphasis"><em>SubscribableChannel</em></span> or <span class="emphasis"><em>PollableChannel</em></span>, respectively.
This is an <span class="emphasis"><em>optional</em></span> attribute.
</dd><dt><span class="term"><span class="strong"><strong>auto-startup</strong></span></span></dt><dd>
This <code class="literal">Lifecycle</code> attribute signaled if this component should be started during startup of the Application Context.
This <span class="emphasis"><em>optional</em></span> attribute defaults to <span class="emphasis"><em>true</em></span>.
</dd><dt><span class="term"><span class="strong"><strong>input-channel</strong></span></span></dt><dd>
The receiving Message channel of this endpoint.
</dd><dt><span class="term"><span class="strong"><strong>order</strong></span></span></dt><dd>
This attribute defines the order for invocation when this endpoint is connected as a subscriber to a channel.
This is particularly relevant when that channel is using a <span class="emphasis"><em>failover</em></span> dispatching strategy.
It has no effect when this endpoint itself is a Polling Consumer for a channel with a queue.
</dd></dl></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="router-implementations" href="#router-implementations"></a>6.1.3&nbsp;Router Implementations</h3></div></div></div>

<p>Since content-based routing often requires some domain-specific logic, most use-cases will require Spring Integration&#8217;s options for delegating to POJOs using the XML namespace support and/or Annotations.
Both of these are discussed below, but first we present a couple implementations that are available out-of-the-box since they fulfill common requirements.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="router-implementations-payloadtyperouter" href="#router-implementations-payloadtyperouter"></a>PayloadTypeRouter</h4></div></div></div>

<p>A <code class="literal">PayloadTypeRouter</code> will send Messages to the channel as defined by payload-type mappings.</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"payloadTypeRouter"</span>
      <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.router.PayloadTypeRouter"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"channelMapping"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;map&gt;</span>
            <span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"java.lang.String"</span> <span class="hl-attribute">value-ref</span>=<span class="hl-value">"stringChannel"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"java.lang.Integer"</span> <span class="hl-attribute">value-ref</span>=<span class="hl-value">"integerChannel"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/map&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
<p>Configuration of the <code class="literal">PayloadTypeRouter</code> is also supported via the namespace provided by Spring Integration (see <a class="xref" href="#configuration-namespace" title="F.2&nbsp;Namespace Support">Section&nbsp;F.2, &#8220;Namespace Support&#8221;</a>), which essentially simplifies configuration by combining the <code class="literal">&lt;router/&gt;</code> configuration and its corresponding implementation defined using a <code class="literal">&lt;bean/&gt;</code> element into a single and more concise configuration element.
The example below demonstrates a <code class="literal">PayloadTypeRouter</code> configuration which is equivalent to the one above using the namespace support:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:payload-type-router</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"routingChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:mapping</span> <span class="hl-attribute">type</span>=<span class="hl-value">"java.lang.String"</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"stringChannel"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;int:mapping</span> <span class="hl-attribute">type</span>=<span class="hl-value">"java.lang.Integer"</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"integerChannel"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/int:payload-type-router&gt;</span></pre>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="router-implementations-headervaluerouter" href="#router-implementations-headervaluerouter"></a>HeaderValueRouter</h4></div></div></div>

<p>A <code class="literal">HeaderValueRouter</code> will send Messages to the channel based on the individual header value mappings.
When a <code class="literal">HeaderValueRouter</code> is created it is initialized with the <span class="emphasis"><em>name</em></span> of the header to be evaluated.
The <span class="emphasis"><em>value</em></span> of the header could be one of two things:</p>
<p>1.
Arbitrary value</p>
<p>2.
Channel name</p>
<p>If arbitrary then additional mappings for these header values to channel names is required, otherwise no additional configuration is needed.</p>
<p>Spring Integration provides a simple namespace-based XML configuration to configure a <code class="literal">HeaderValueRouter</code>.
The example below demonstrates two types of namespace-based configuration for the <code class="literal">HeaderValueRouter</code>.</p>
<p><span class="emphasis"><em>1.
Configuration where mapping of header values to channels is required</em></span></p>
<pre class="programlisting"><span class="hl-tag">&lt;int:header-value-router</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"routingChannel"</span> <span class="hl-attribute">header-name</span>=<span class="hl-value">"testHeader"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:mapping</span> <span class="hl-attribute">value</span>=<span class="hl-value">"someHeaderValue"</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"channelA"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;int:mapping</span> <span class="hl-attribute">value</span>=<span class="hl-value">"someOtherHeaderValue"</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"channelB"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/int:header-value-router&gt;</span></pre>
<p>During the resolution process this router may encounter channel resolution failures, causing an exception.
If you want to suppress such exceptions and send unresolved messages to the default output channel (identified with the <code class="literal">default-output-channel</code> attribute) set <code class="literal">resolution-required</code> to <code class="literal">false</code>.</p>
<p>Normally, messages for which the header value is not explicitly mapped to a channel will be sent to the <code class="literal">default-output-channel</code>.
However, in cases where the header value is mapped to a channel name but the channel cannot be resolved, setting the <code class="literal">resolution-required</code> attribute to <code class="literal">false</code> will result in routing such messages to the <code class="literal">default-output-channel</code>.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>With Spring Integration 2.1 the attribute was changed from <code class="literal">ignore-channel-name-resolution-failures</code> to <code class="literal">resolution-required</code>.
Attribute <code class="literal">resolution-required</code> will default to <code class="literal">true</code>.</p>
</td></tr></table></div>
<p><span class="emphasis"><em>2.
Configuration where mapping of header values to channel names
              is not required since header values themselves represent channel names</em></span></p>
<pre class="programlisting"><span class="hl-tag">&lt;int:header-value-router</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"routingChannel"</span> <span class="hl-attribute">header-name</span>=<span class="hl-value">"testHeader"</span><span class="hl-tag">/&gt;</span></pre>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Since Spring Integration 2.1 the behavior of resolving channels is more explicit.
For example, if you ommit the <code class="literal">default-output-channel</code> attribute and the Router was unable to resolve at least one valid channel, and any channel name resolution failures were ignored by setting <code class="literal">resolution-required</code> to <code class="literal">false</code>, then a <code class="literal">MessageDeliveryException</code> is thrown.</p>
<p>Basically, by default the Router must be able to route messages successfully to at least one channel.
If you really want to drop messages, you must also have <code class="literal">default-output-channel</code> set to <code class="literal">nullChannel</code>.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="router-implementations-recipientlistrouter" href="#router-implementations-recipientlistrouter"></a>RecipientListRouter</h4></div></div></div>

<p>A <code class="literal">RecipientListRouter</code> will send each received Message to a statically defined list of Message Channels:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"recipientListRouter"</span>
      <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.router.RecipientListRouter"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"channels"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;list&gt;</span>
            <span class="hl-tag">&lt;ref</span> <span class="hl-attribute">bean</span>=<span class="hl-value">"channel1"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;ref</span> <span class="hl-attribute">bean</span>=<span class="hl-value">"channel2"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;ref</span> <span class="hl-attribute">bean</span>=<span class="hl-value">"channel3"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/list&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
<p>Spring Integration also provides namespace support for the <code class="literal">RecipientListRouter</code> configuration (see <a class="xref" href="#configuration-namespace" title="F.2&nbsp;Namespace Support">Section&nbsp;F.2, &#8220;Namespace Support&#8221;</a>) as the example below demonstrates.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:recipient-list-router</span> <span class="hl-attribute">id</span>=<span class="hl-value">"customRouter"</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"routingChannel"</span>
        <span class="hl-attribute">timeout</span>=<span class="hl-value">"1234"</span>
        <span class="hl-attribute">ignore-send-failures</span>=<span class="hl-value">"true"</span>
        <span class="hl-attribute">apply-sequence</span>=<span class="hl-value">"true"</span><span class="hl-tag">&gt;</span>
  <span class="hl-tag">&lt;int:recipient</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"channel1"</span><span class="hl-tag">/&gt;</span>
  <span class="hl-tag">&lt;int:recipient</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"channel2"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:recipient-list-router&gt;</span></pre>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The <span class="emphasis"><em>apply-sequence</em></span> flag here has the same effect as it does for a publish-subscribe-channel, and like a publish-subscribe-channel, it is disabled by default on the recipient-list-router.
Refer to<a class="xref" href="#channel-configuration-pubsubchannel" title="PublishSubscribeChannel Configuration">the section called &#8220;PublishSubscribeChannel Configuration&#8221;</a> for more information.</p>
</td></tr></table></div>
<p>Another convenient option when configuring a <code class="literal">RecipientListRouter</code> is to use Spring Expression Language (SpEL) support as selectors for individual recipient channels.
This is similar to using a Filter at the beginning of <span class="emphasis"><em>chain</em></span> to act as a "Selective Consumer".
However, in this case, it&#8217;s all combined rather concisely into the router&#8217;s configuration.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:recipient-list-router</span> <span class="hl-attribute">id</span>=<span class="hl-value">"customRouter"</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"routingChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:recipient</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"channel1"</span> <span class="hl-attribute">selector-expression</span>=<span class="hl-value">"payload.equals('foo')"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int:recipient</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"channel2"</span> <span class="hl-attribute">selector-expression</span>=<span class="hl-value">"headers.containsKey('bar')"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:recipient-list-router&gt;</span></pre>
<p>In the above configuration a SpEL expression identified by the <code class="literal">selector-expression</code> attribute will be evaluated to determine if this recipient should be included in the recipient list for a given input Message.
The evaluation result of the expression must be a boolean.
If this attribute is not defined, the channel will always be among the list of recipients.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="recipient-list-router-management" href="#recipient-list-router-management"></a>RecipientListRouterManagement</h4></div></div></div>

<p>Starting with <span class="emphasis"><em>version 4.1</em></span>, the <code class="literal">RecipientListRouter</code> provides several operation to manipulate with <span class="emphasis"><em>recipients</em></span> dynamically at runtime.
These management operations are presented by <code class="literal">RecipientListRouterManagement</code> <code class="literal">@ManagedResource</code>.
They are available using <a class="xref" href="#control-bus" title="9.6&nbsp;Control Bus">Section&nbsp;9.6, &#8220;Control Bus&#8221;</a> as well as via JMX:</p>
<pre class="programlisting"><span class="hl-tag">&lt;control-bus</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"controlBus"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;recipient-list-router</span> <span class="hl-attribute">id</span>=<span class="hl-value">"simpleRouter"</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"routingChannelA"</span><span class="hl-tag">&gt;</span>
   <span class="hl-tag">&lt;recipient</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"channel1"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/recipient-list-router&gt;</span>

<span class="hl-tag">&lt;channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"channel2"</span><span class="hl-tag">/&gt;</span></pre>
<pre class="programlisting">messagingTemplate.convertAndSend(controlBus, <span class="hl-string">"@'simpleRouter.handler'.addRecipient('channel2')"</span>);</pre>
<p>From the application start up the <code class="literal">simpleRouter</code> will have only one <code class="literal">channel1</code> recipient.
But after the <code class="literal">addRecipient</code> command above the new <code class="literal">channel2</code> recipient will be added.
It is a "registering an interest in something that is part of the Message" use case, when we may be interested in messages from the <span class="emphasis"><em>router</em></span> at some time period, so we are <span class="emphasis"><em>subscribing</em></span> to the the <code class="literal">recipient-list-router</code> and in some point decide to <span class="emphasis"><em>unsubscribe</em></span> our interest.</p>
<p>Having the runtime management operation for the <code class="literal">&lt;recipient-list-router&gt;</code>, it can be configured without any <code class="literal">&lt;recipient&gt;</code> from the start.
In this case the behaviour of <code class="literal">RecipientListRouter</code> is the same, when there is no one matching recipient for the message: if <code class="literal">defaultOutputChannel</code> is configured, the message will be sent there, otherwise the <code class="literal">MessageDeliveryException</code> is thrown.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="router-implementations-xpath-router" href="#router-implementations-xpath-router"></a>XPath Router</h4></div></div></div>

<p>The XPath Router is part of the XML Module.
As such, please read chapter <span class="emphasis"><em><a class="xref" href="#xml-xpath-routing" title="35.6&nbsp;Routing XML Messages Using XPath">Section&nbsp;35.6, &#8220;Routing XML Messages Using XPath&#8221;</a></em></span></p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="router-implementations-exception-router" href="#router-implementations-exception-router"></a>Routing and Error handling</h4></div></div></div>

<p>Spring Integration also provides a special type-based router called <code class="literal">ErrorMessageExceptionTypeRouter</code> for routing Error Messages (Messages whose <code class="literal">payload</code> is a <code class="literal">Throwable</code> instance).
<code class="literal">ErrorMessageExceptionTypeRouter</code> is very similar to the <code class="literal">PayloadTypeRouter</code>.
In fact they are almost identical.
The only difference is that while <code class="literal">PayloadTypeRouter</code> navigates the instance hierarchy of a payload instance (e.g., <code class="literal">payload.getClass().getSuperclass()</code>) to find the most specific type/channel mappings,
the <code class="literal">ErrorMessageExceptionTypeRouter</code> navigates the hierarchy of <span class="emphasis"><em>exception causes</em></span> (e.g., <code class="literal">payload.getCause()</code>)
to find the most specific <code class="literal">Throwable</code> type/channel mappings and uses <code class="literal">mappingClass.isInstance(cause)</code> to match the
<code class="literal">cause</code> to the class or any super class.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Since <span class="emphasis"><em>version 4.3</em></span> the <code class="literal">ErrorMessageExceptionTypeRouter</code> loads all mapping classes during the initialization
phase to fail-fast for a <code class="literal">ClassNotFoundException</code>.</p>
</td></tr></table></div>
<p>Below is a sample configuration for <code class="literal">ErrorMessageExceptionTypeRouter</code>.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:exception-type-router</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"inputChannel"</span>
                           <span class="hl-attribute">default-output-channel</span>=<span class="hl-value">"defaultChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:mapping</span> <span class="hl-attribute">exception-type</span>=<span class="hl-value">"java.lang.IllegalArgumentException"</span>
                 <span class="hl-attribute">channel</span>=<span class="hl-value">"illegalChannel"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int:mapping</span> <span class="hl-attribute">exception-type</span>=<span class="hl-value">"java.lang.NullPointerException"</span>
                 <span class="hl-attribute">channel</span>=<span class="hl-value">"npeChannel"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:exception-type-router&gt;</span>

<span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"illegalChannel"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"npeChannel"</span><span class="hl-tag"> /&gt;</span></pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="router-namespace" href="#router-namespace"></a>6.1.4&nbsp;Configuring (Generic) Router</h3></div></div></div>

<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_configuring_a_content_based_router_with_xml" href="#_configuring_a_content_based_router_with_xml"></a>Configuring a Content Based Router with XML</h4></div></div></div>

<p>The "router" element provides a simple way to connect a router to an input channel and also accepts the optional <code class="literal">default-output-channel</code> attribute.
The <code class="literal">ref</code> attribute references the bean name of a custom Router implementation (extending <code class="literal">AbstractMessageRouter</code>):</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:router</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"payloadTypeRouter"</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input1"</span>
            <span class="hl-attribute">default-output-channel</span>=<span class="hl-value">"defaultOutput1"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int:router</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"recipientListRouter"</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input2"</span>
            <span class="hl-attribute">default-output-channel</span>=<span class="hl-value">"defaultOutput2"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int:router</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"customRouter"</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input3"</span>
            <span class="hl-attribute">default-output-channel</span>=<span class="hl-value">"defaultOutput3"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;beans:bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"customRouterBean"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.foo.MyCustomRouter"</span><span class="hl-tag">/&gt;</span></pre>
<p>Alternatively, <code class="literal">ref</code> may point to a simple POJO that contains the @Router annotation (see below), or the <code class="literal">ref</code> may be combined with an explicit <code class="literal">method</code> name.
Specifying a <code class="literal">method</code> applies the same behavior described in the @Router annotation section below.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:router</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"somePojo"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"someMethod"</span><span class="hl-tag">/&gt;</span></pre>
<p>Using a <code class="literal">ref</code> attribute is generally recommended if the custom router implementation is referenced in other <code class="literal">&lt;router&gt;</code> definitions.
However if the custom router implementation should be scoped to a single definition of the <code class="literal">&lt;router&gt;</code>, you may provide an inner bean definition:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:router</span> <span class="hl-attribute">method</span>=<span class="hl-value">"someMethod"</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input3"</span>
            <span class="hl-attribute">default-output-channel</span>=<span class="hl-value">"defaultOutput3"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;beans:bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.foo.MyCustomRouter"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:router&gt;</span></pre>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Using both the <code class="literal">ref</code> attribute and an inner handler definition in the same <code class="literal">&lt;router&gt;</code> configuration is not allowed, as it creates an ambiguous condition, and an Exception will be thrown.</p>
</td></tr></table></div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>If the "ref" attribute references a bean that extends <code class="literal">AbstractMessageProducingHandler</code> (such as routers provided by the framework itself), the configuration is optimized referencing the router directly.
In this case, each "ref" must be to a separate bean instance (or a <code class="literal">prototype</code>-scoped bean), or use the inner <code class="literal">&lt;bean/&gt;</code> configuration type.
However, this optimization only applies if you don&#8217;t provide any router-specific attributes in the router XML definition.
If you inadvertently reference the same message handler from multiple beans, you will get a configuration exception.</p>
</td></tr></table></div>
<p><span class="emphasis"><em>Routers and the Spring Expression Language (SpEL)</em></span></p>
<p>Sometimes the routing logic may be simple and writing a separate class for it and configuring it as a bean may seem like overkill.
As of Spring Integration 2.0 we offer an alternative where you can now use SpEL to implement simple computations that previously required a custom POJO router.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>For more information about the Spring Expression Language, please refer to the respective chapter in the Spring Framework Reference Documentation at:</p>
</td></tr></table></div>
<p>null</p>
<p>Generally a SpEL expression is evaluated and the result is mapped to a channel:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:router</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"inChannel"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"payload.paymentType"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:mapping</span> <span class="hl-attribute">value</span>=<span class="hl-value">"CASH"</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"cashPaymentChannel"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int:mapping</span> <span class="hl-attribute">value</span>=<span class="hl-value">"CREDIT"</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"authorizePaymentChannel"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int:mapping</span> <span class="hl-attribute">value</span>=<span class="hl-value">"DEBIT"</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"authorizePaymentChannel"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:router&gt;</span></pre>
<p>To simplify things even more, the SpEL expression may evaluate to a channel name:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:router</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"inChannel"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"payload + 'Channel'"</span><span class="hl-tag">/&gt;</span></pre>
<p>In the above configuration the result channel will be computed by the SpEL expression which simply concatenates the value of the <code class="literal">payload</code> with the literal String <span class="emphasis"><em>Channel</em></span>.</p>
<p>Another value of SpEL for configuring routers is that an expression can actually return a <code class="literal">Collection</code>, effectively making every <code class="literal">&lt;router&gt;</code> a <span class="emphasis"><em>Recipient List Router</em></span>.
Whenever the expression returns multiple channel values the Message will be forwarded to each channel.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:router</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"inChannel"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"headers.channels"</span><span class="hl-tag">/&gt;</span></pre>
<p>In the above configuration, if the Message includes a header with the name <span class="emphasis"><em>channels</em></span> the value of which is a <code class="literal">List</code> of channel names then the Message will be sent to each channel in the list.
You may also find <span class="emphasis"><em>Collection Projection</em></span> and <span class="emphasis"><em>Collection Selection</em></span> expressions useful to select multiple channels.
For further information, please see:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="ulink" href="http://static.springsource.org/spring/docs/current/spring-framework-reference/html/expressions.html#expressions-collection-projection" target="_top">Collection Projection</a>
</li><li class="listitem">
<a class="ulink" href="http://static.springsource.org/spring/docs/current/spring-framework-reference/html/expressions.html#expressions-collection-selection" target="_top">Collection Selection</a>
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="router-annotation" href="#router-annotation"></a>Configuring a Router with Annotations</h4></div></div></div>

<p>When using <code class="literal">@Router</code> to annotate a method, the method may return either a <code class="literal">MessageChannel</code> or <code class="literal">String</code> type.
In the latter case, the endpoint will resolve the channel name as it does for the default output channel.
Additionally, the method may return either a single value or a collection.
If a collection is returned, the reply message will be sent to multiple channels.
To summarize, the following method signatures are all valid.</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Router</span></em>
<span class="hl-keyword">public</span> MessageChannel route(Message message) {...}

<em><span class="hl-annotation" style="color: gray">@Router</span></em>
<span class="hl-keyword">public</span> List&lt;MessageChannel&gt; route(Message message) {...}

<em><span class="hl-annotation" style="color: gray">@Router</span></em>
<span class="hl-keyword">public</span> String route(Foo payload) {...}

<em><span class="hl-annotation" style="color: gray">@Router</span></em>
<span class="hl-keyword">public</span> List&lt;String&gt; route(Foo payload) {...}</pre>
<p>In addition to payload-based routing, a Message may be routed based on metadata available within the message header as either a property or attribute.
In this case, a method annotated with <code class="literal">@Router</code> may include a parameter annotated with <code class="literal">@Header</code> which is mapped to a header value as illustrated below and documented in <a class="xref" href="#annotations" title="F.6&nbsp;Annotation Support">Section&nbsp;F.6, &#8220;Annotation Support&#8221;</a>.</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Router</span></em>
<span class="hl-keyword">public</span> List&lt;String&gt; route(<em><span class="hl-annotation" style="color: gray">@Header("orderStatus")</span></em> OrderStatus status)</pre>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>For routing of XML-based Messages, including XPath support, see <a class="xref" href="#xml" title="35.&nbsp;XML Support - Dealing with XML Payloads">Chapter&nbsp;35, <i>XML Support - Dealing with XML Payloads</i></a>.</p>
</td></tr></table></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="dynamic-routers" href="#dynamic-routers"></a>6.1.5&nbsp;Dynamic Routers</h3></div></div></div>

<p>So as you can see, Spring Integration provides quite a few different router configurations for common <span class="emphasis"><em>content-based routing</em></span> use cases as well as the option of implementing custom routers as POJOs.
For example <code class="literal">PayloadTypeRouter</code> provides a simple way to configure a router which computes <code class="literal">channels</code> based on the <code class="literal">payload type</code> of the incoming Message while <code class="literal">HeaderValueRouter</code> provides the same convenience in configuring a router which computes <code class="literal">channels</code> by evaluating the value of a particular Message Header.
There are also <span class="emphasis"><em>expression-based</em></span> (SpEL) routers where the <code class="literal">channel</code> is determined based on evaluating an expression.
Thus, these type of routers exhibit some dynamic characteristics.</p>
<p>However these routers all require <span class="emphasis"><em>static configuration</em></span>.
Even in the case of expression-based routers, the expression itself is defined as part of the router configuration which means that_the same expression operating on the same value will always result in the computation of the same channel_.
This is acceptable in most cases since such routes are well defined and therefore predictable.
But there are times when we need to change router configurations dynamically so message flows may be routed to a different channel.</p>
<p><span class="emphasis"><em>Example:</em></span></p>
<p>You might want to bring down some part of your system for maintenance and temporarily re-reroute messages to a different message flow.
Or you may want to introduce more granularity to your message flow by adding another route to handle a more concrete type of <code class="literal">java.lang.Number</code> (in the case of <code class="literal">PayloadTypeRouter</code>).</p>
<p>Unfortunately with static router configuration to accomplish this, you would have to bring down your entire application, change the configuration of the router (change routes) and bring it back up.
This is obviously not the solution.</p>
<p>The <a class="ulink" href="http://www.eaipatterns.com/DynamicRouter.html" target="_top">Dynamic Router</a> pattern describes the mechanisms by which one can change/configure routers dynamically without bringing down the system or individual routers.&nbsp;</p>
<p>Before we get into the specifics of how this is accomplished in Spring Integration, let&#8217;s quickly summarize the typical flow of the router, which consists of 3 simple steps:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="emphasis"><em>Step 1</em></span> - Compute <code class="literal">channel identifier</code> which is a value calculated by the router once it receives the Message.
Typically it is a <code class="literal">String</code> or and instance of the actual <code class="literal">MessageChannel</code>.
</li><li class="listitem">
<span class="emphasis"><em>Step 2</em></span> - Resolve <code class="literal">channel identifier</code> to <code class="literal">channel name</code>.
We&#8217;ll describe specifics of this process in a moment.
</li><li class="listitem">
<span class="emphasis"><em>Step 3</em></span> - Resolve <code class="literal">channel name</code> to the actual <code class="literal">MessageChannel</code>
</li></ul></div>
<p>There is not much that can be done with regard to dynamic routing if Step 1 results in the actual instance of the <code class="literal">MessageChannel</code>, simply because the <code class="literal">MessageChannel</code> is the <span class="emphasis"><em>final product</em></span> of any router&#8217;s job.
However, if Step 1 results in a <code class="literal">channel identifier</code> that is not an instance of <code class="literal">MessageChannel</code>, then there are quite a few possibilities to influence the process of deriving the <code class="literal">Message Channel</code>.
Lets look at couple of the examples in the context of the 3 steps mentioned above:&nbsp;</p>
<p><span class="emphasis"><em>Payload Type Router</em></span></p>
<pre class="programlisting"><span class="hl-tag">&lt;int:payload-type-router</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"routingChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:mapping</span> <span class="hl-attribute">type</span>=<span class="hl-value">"java.lang.String"</span>  <span class="hl-attribute">channel</span>=<span class="hl-value">"channel1"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;int:mapping</span> <span class="hl-attribute">type</span>=<span class="hl-value">"java.lang.Integer"</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"channel2"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/int:payload-type-router&gt;</span></pre>
<p>Within the context of the Payload Type Router the 3 steps mentioned above would be realized as:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="emphasis"><em>Step 1</em></span> - Compute <code class="literal">channel identifier</code> which is the fully qualified name of the payload type (e.g., java.lang.String).
</li><li class="listitem">
<span class="emphasis"><em>Step 2</em></span> - Resolve <code class="literal">channel identifier</code> to <code class="literal">channel name</code> where the result of the previous step is used to select the appropriate value from the <span class="emphasis"><em>payload type mapping</em></span> defined via <code class="literal">mapping</code> element.
</li><li class="listitem">
<span class="emphasis"><em>Step 3</em></span> - Resolve <code class="literal">channel name</code> to the actual instance of the <code class="literal">MessageChannel</code> as a reference to a bean within the Application Context (which is hopefully a <code class="literal">MessageChannel</code>) identified by the result of the previous step.
</li></ul></div>
<p>In other words, each step feeds the next step until the process completes.</p>
<p><span class="emphasis"><em>Header Value Router</em></span></p>
<pre class="programlisting"><span class="hl-tag">&lt;int:header-value-router</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"inputChannel"</span> <span class="hl-attribute">header-name</span>=<span class="hl-value">"testHeader"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:mapping</span> <span class="hl-attribute">value</span>=<span class="hl-value">"foo"</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"fooChannel"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;int:mapping</span> <span class="hl-attribute">value</span>=<span class="hl-value">"bar"</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"barChannel"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/int:header-value-router&gt;</span></pre>
<p>Similar to the PayloadTypeRouter:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="emphasis"><em>Step 1</em></span> - Compute <code class="literal">channel identifier</code> which is the value of the header identified by the <code class="literal">header-name</code> attribute.
</li><li class="listitem">
<span class="emphasis"><em>Step 2</em></span> - Resolve <code class="literal">channel identifier</code> to <code class="literal">channel name</code> where the result of the previous step is used to select the appropriate value from the <span class="emphasis"><em>general mapping</em></span> defined via <code class="literal">mapping</code> element.
</li><li class="listitem">
<span class="emphasis"><em>Step 3</em></span> - Resolve <code class="literal">channel name</code> to the actual instance of the <code class="literal">MessageChannel</code> as a reference to a bean within the Application Context (which is hopefully a <code class="literal">MessageChannel</code>) identified by the result of the previous step.
</li></ul></div>
<p>The above two configurations of two different router types look almost identical.
However if we look at the alternate configuration of the <code class="literal">HeaderValueRouter</code> we clearly see that there is no <code class="literal">mapping</code> sub element:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:header-value-router&nbsp;input-channel="inputChannel"&nbsp;header-name="testHeader"&gt;</span></pre>
<p>But the configuration is still perfectly valid.
So the natural question is what about the mapping in the Step 2?</p>
<p>What this means is that Step 2 is now an optional step.
If <code class="literal">mapping</code> is not defined then the <code class="literal">channel identifier</code> value computed in Step 1 will automatically be treated as the <code class="literal">channel name</code>, which will now be resolved to the actual <code class="literal">MessageChannel</code> as in Step 3.&nbsp;
What it also means is that Step 2 is one of the key steps to provide dynamic characteristics to the routers, since it introduces a process which <span class="emphasis"><em>allows you to change the way <span class="emphasis"><em>channel identifier</em></span> resolves to 'channel name'</em></span>, thus influencing the process of determining the final instance of the <code class="literal">MessageChannel</code> from the initial <code class="literal">channel identifier</code>.&nbsp;</p>
<p><span class="emphasis"><em>For Example:</em></span></p>
<p>In the above configuration let&#8217;s assume that the <code class="literal">testHeader</code> value is <span class="emphasis"><em>kermit</em></span> which is now a <code class="literal">channel identifier</code> (Step 1).
Since there is no mapping in this router, resolving this <code class="literal">channel identifier</code> to a <code class="literal">channel name</code> (Step 2) is impossible and this <code class="literal">channel identifier</code> is now treated as <code class="literal">channel name</code>.
However what if there was a mapping but for a different value?
The end result would still be the same and that is: <span class="emphasis"><em>if a new value cannot be determined through the process of resolving the <span class="emphasis"><em>channel identifier</em></span> to a <span class="emphasis"><em>channel name</em></span>, such <span class="emphasis"><em>channel identifier</em></span> becomes <span class="emphasis"><em>channel name</em></span>.</em></span></p>
<p>So all that is left is for Step 3 to resolve the <code class="literal">channel name</code> (<span class="emphasis"><em>kermit</em></span>) to an actual instance of the <code class="literal">MessageChannel</code> identified by this name.
That basically involves a bean lookup for the name provided.
So now all messages which contain the header/value pair as <code class="literal">testHeader=kermit</code> are going to be routed to a <code class="literal">MessageChannel</code> whose bean name (id) is <span class="emphasis"><em>kermit</em></span>.</p>
<p>But what if you want to route these messages to the <span class="emphasis"><em>simpson</em></span> channel? Obviously changing a static configuration will work, but will also require bringing your system down.
However if you had access to the <code class="literal">channel identifier</code> map, then you could just introduce a new mapping where the header/value pair is now <code class="literal">kermit=simpson</code>, thus allowing Step 2 to treat <span class="emphasis"><em>kermit</em></span> as a <code class="literal">channel identifier</code> while resolving it to <span class="emphasis"><em>simpson</em></span> as the <code class="literal">channel name</code> .</p>
<p>The same obviously applies for <code class="literal">PayloadTypeRouter</code>, where you can now remap or remove a particular <span class="emphasis"><em>payload type
            mapping</em></span>.
In fact, it applies to every other router, including <span class="emphasis"><em>expression-based</em></span> routers, since their computed values will now have a chance to go through Step 2 to be additionally resolved to the actual <code class="literal">channel name</code>.</p>
<p>Any router that is a subclass of the <code class="literal">AbstractMappingMessageRouter</code> (which includes most framework defined routers) is a Dynamic Router simply because the <code class="literal">channelMapping</code> is defined at the <code class="literal">AbstractMappingMessageRouter</code> level.
That map&#8217;s setter method is exposed as a public method along with <span class="emphasis"><em>setChannelMapping</em></span> and <span class="emphasis"><em>removeChannelMapping</em></span> methods.
These allow you to change/add/remove router mappings at runtime as long as you have a reference to the router itself.
It also means that you could expose these same configuration options via JMX (see <a class="xref" href="#jmx" title="9.2&nbsp;JMX Support">Section&nbsp;9.2, &#8220;JMX Support&#8221;</a>) or the Spring Integration ControlBus (see <a class="xref" href="#control-bus" title="9.6&nbsp;Control Bus">Section&nbsp;9.6, &#8220;Control Bus&#8221;</a>) functionality.&nbsp;</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="dynamic-routers-control-bus" href="#dynamic-routers-control-bus"></a>Manage Router Mappings using the Control Bus</h4></div></div></div>

<p>One way to manage the router mappings is through the <a class="ulink" href="http://www.eaipatterns.com/ControlBus.html" target="_top">Control Bus</a> pattern which exposes a Control Channel where you can send control messages to manage and monitor Spring Integration components, including routers.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>For more information about the Control Bus, please see chapter <span class="emphasis"><em><a class="xref" href="#control-bus" title="9.6&nbsp;Control Bus">Section&nbsp;9.6, &#8220;Control Bus&#8221;</a></em></span>.</p>
</td></tr></table></div>
<p>Typically you would send a control message asking to invoke a particular operation on a particular managed component (e.g.
router).
Two managed operations (methods) that are specific to changing the router resolution process are:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">public void setChannelMapping(String key, String channelName)</code> - will allow you to add a new or modify an existing mapping between <code class="literal">channel identifier</code> and <code class="literal">channel name</code>
</li><li class="listitem">
<code class="literal">public void removeChannelMapping(String key)</code> - will allow you to remove a particular channel mapping, thus disconnecting the relationship between <code class="literal">channel identifier</code> and <code class="literal">channel name</code>
</li></ul></div>
<p>Note that these methods can be used for simple changes (updating a single route or adding/removing a route).
However, if you want to remove one route and add another, the updates are not atomic.
This means the routing table may be in an indeterminate state between the updates.
Starting with <span class="emphasis"><em>version 4.0</em></span>, you can now use the control bus to update the entire routing table atomically.</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">public Map&lt;String, String&gt;getChannelMappings()</code> returns the current mappings.
</li><li class="listitem">
<code class="literal">public void replaceChannelMappings(Properties channelMappings)</code> updates the mappings.
Notice that the parameter is a properties object; this allows the use of the inbuilt <code class="literal">StringToPropertiesConverter</code> by a control bus command, for example:
</li></ul></div>
<pre class="screen">"@'router.handler'.replaceChannelMappings('foo=qux \n baz=bar')"</pre>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
note that each mapping is separated by a newline character (<code class="literal">\n</code>).
For programmatic changes to the map, it is recommended that the <code class="literal">setChannelMappings</code> method is used instead, for type-safety.
Any non-String keys or values passed into <code class="literal">replaceChannelMappings</code> are ignored.
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="dynamic-routers-jmx" href="#dynamic-routers-jmx"></a>Manage Router Mappings using JMX</h4></div></div></div>

<p>You can also expose a router instance with Spring&#8217;s JMX support, and then use your favorite JMX client (e.g., JConsole) to manage those operations (methods) for changing the router&#8217;s configuration.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>For more information about Spring Integration&#8217;s JMX support, please see chapter <span class="emphasis"><em><a class="xref" href="#jmx" title="9.2&nbsp;JMX Support">Section&nbsp;9.2, &#8220;JMX Support&#8221;</a></em></span>.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="routing-slip" href="#routing-slip"></a>Routing Slip</h4></div></div></div>

<p>Starting with <span class="emphasis"><em>version 4.1</em></span>, Spring Integration provides an implementation of the <a class="ulink" href="http://www.eaipatterns.com/RoutingTable.html" target="_top">Routing Slip</a> Enterprise Integration Pattern.
It is implemented as a <code class="literal">routingSlip</code> message header which is used to determine the next channel in <code class="literal">AbstractMessageProducingHandler</code> s, when an <code class="literal">outputChannel</code> isn&#8217;t specified for the endpoint.
This pattern is useful in complex, dynamic, cases when it can become difficult to configure multiple routers to determine message flow.
When a message arrives at an endpoint that has no <code class="literal">output-channel</code>, the <code class="literal">routingSlip</code> is consulted to determine the next channel to which the message will be sent.
When the routing slip is exhausted, normal <code class="literal">replyChannel</code> processing resumes.</p>
<p>Configuration for the <span class="emphasis"><em>Routing Slip</em></span> is presented as a <code class="literal">HeaderEnricher</code> option - a <span class="emphasis"><em>semicolon-separated</em></span> Routing Slip <code class="literal">path</code> entries:</p>
<pre class="programlisting"><span class="hl-tag">&lt;util:properties</span> <span class="hl-attribute">id</span>=<span class="hl-value">"properties"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;beans:prop</span> <span class="hl-attribute">key</span>=<span class="hl-value">"myRoutePath1"</span><span class="hl-tag">&gt;</span>channel1<span class="hl-tag">&lt;/beans:prop&gt;</span>
    <span class="hl-tag">&lt;beans:prop</span> <span class="hl-attribute">key</span>=<span class="hl-value">"myRoutePath2"</span><span class="hl-tag">&gt;</span>request.headers[myRoutingSlipChannel]<span class="hl-tag">&lt;/beans:prop&gt;</span>
<span class="hl-tag">&lt;/util:properties&gt;</span>

<span class="hl-tag">&lt;context:property-placeholder</span> <span class="hl-attribute">properties-ref</span>=<span class="hl-value">"properties"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;header-enricher</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"process"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;routing-slip</span>
        <span class="hl-attribute">value</span>=<span class="hl-value">"${myRoutePath1}; @routingSlipRoutingPojo.get(request, reply);
               routingSlipRoutingStrategy; ${myRoutePath2}; finishChannel"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/header-enricher&gt;</span></pre>
<p>In this sample we have:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
A <code class="literal">&lt;context:property-placeholder&gt;</code> configuration to demonstrate that the entries in the Routing Slip <code class="literal">path</code> can be specified as resolvable keys.
</li><li class="listitem">
The <code class="literal">&lt;header-enricher&gt;</code> <code class="literal">&lt;routing-slip&gt;</code> sub-element is used to populate the <code class="literal">RoutingSlipHeaderValueMessageProcessor</code> to the <code class="literal">HeaderEnricher</code> handler.
</li><li class="listitem">
The <code class="literal">RoutingSlipHeaderValueMessageProcessor</code> accepts a String array of resolved Routing Slip <code class="literal">path</code> entries and returns (from <code class="literal">processMessage()</code>) a <code class="literal">singletonMap</code> with the <code class="literal">path</code> as <code class="literal">key</code> and <code class="literal">0</code> as initial <code class="literal">routingSlipIndex</code>.
</li></ul></div>
<p>Routing Slip <code class="literal">path</code> entries can contain <code class="literal">MessageChannel</code> bean names, <code class="literal">RoutingSlipRouteStrategy</code> bean names and also Spring expressions (SpEL).
The <code class="literal">RoutingSlipHeaderValueMessageProcessor</code> checks each Routing Slip <code class="literal">path</code> entry against the <code class="literal">BeanFactory</code> on the first <code class="literal">processMessage</code> invocation.
It converts entries, which aren&#8217;t bean names in the application context, to <code class="literal">ExpressionEvaluatingRoutingSlipRouteStrategy</code> instances.
<code class="literal">RoutingSlipRouteStrategy</code> entries are invoked multiple times, until they return null, or an empty String.</p>
<p>Since the <span class="emphasis"><em>Routing Slip</em></span> is involved in the <code class="literal">getOutputChannel</code> process we have a <span class="emphasis"><em>request-reply</em></span> context.
The <code class="literal">RoutingSlipRouteStrategy</code> has been introduced to determine the next <code class="literal">outputChannel</code> using the <code class="literal">requestMessage</code>, as well as the <code class="literal">reply</code> object.
An implementation of this strategy should be registered as a bean in the application context and its bean name is used in the Routing Slip <code class="literal">path</code>.
The <code class="literal">ExpressionEvaluatingRoutingSlipRouteStrategy</code> implementation is provided.
It accepts a SpEL expression, and an internal <code class="literal">ExpressionEvaluatingRoutingSlipRouteStrategy.RequestAndReply</code> object is used as the <span class="emphasis"><em>root object</em></span> of the evaluation context.
This is to avoid the overhead of <code class="literal">EvaluationContext</code> creation for each <code class="literal">ExpressionEvaluatingRoutingSlipRouteStrategy.getNextPath()</code> invocation.
It is a simple Java Bean with two properties - <code class="literal">Message&lt;?&gt; request</code> and <code class="literal">Object reply</code>.
With this expression implementation, we can specify Routing Slip <code class="literal">path</code> entries using SpEL (<code class="literal">@routingSlipRoutingPojo.get(request, reply)</code>, <code class="literal">request.headers[myRoutingSlipChannel]</code>) avoiding a bean definition for the <code class="literal">RoutingSlipRouteStrategy</code>.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The <code class="literal">requestMessage</code> argument is always a <code class="literal">Message&lt;?&gt;</code>; depending on context, the reply object may be a
<code class="literal">Message&lt;?&gt;</code>, an <code class="literal">AbstractIntegrationMessageBuilder</code> or an arbitrary application domain object (if, for example,
it is returned by a POJO method invoked by a service activator).
In the first two cases, the usual "message" properties are available (<code class="literal">payload</code> and <code class="literal">headers</code>) when using SpEL (or
a Java implementation).
When an arbitrary domain object, these properties are, obviously, not available.
Care should be taken when using routing slips in conjunction with POJO methods if the result is used to determine the
next path.</p>
</td></tr></table></div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>If a <span class="emphasis"><em>Routing Slip</em></span> is involved in a distributed environment - cross-JVM application, <code class="literal">request-reply</code> through a Message Broker (e.g.
<a class="xref" href="#amqp" title="11.&nbsp;AMQP Support">Chapter&nbsp;11, <i>AMQP Support</i></a>, <a class="xref" href="#jms" title="20.&nbsp;JMS Support">Chapter&nbsp;20, <i>JMS Support</i></a>), or persistence <code class="literal">MessageStore</code> (<a class="xref" href="#message-store" title="9.4&nbsp;Message Store">Section&nbsp;9.4, &#8220;Message Store&#8221;</a>) is used in the integration flow, etc., - it is recommended to <span class="strong"><strong>not</strong></span> use <span class="emphasis"><em>inline</em></span> expressions for the Routing Slip <code class="literal">path</code>.
The framework (<code class="literal">RoutingSlipHeaderValueMessageProcessor</code>) converts them to <code class="literal">ExpressionEvaluatingRoutingSlipRouteStrategy</code> objects and they are used in the <code class="literal">routingSlip</code> message header.
Since this class isn&#8217;t <code class="literal">Serializable</code> (and it can&#8217;t be, because it depends on the <code class="literal">BeanFactory</code>) the entire Message becomes non-serializable and in any distributed operation we end up with <code class="literal">NotSerializableException</code>.
To overcome this limitation, register an <code class="literal">ExpressionEvaluatingRoutingSlipRouteStrategy</code> bean with the desired SpEL and use its bean name in the Routing Slip <code class="literal">path</code> configuration.</p>
</td></tr></table></div>
<p>For Java configuration, simply add a <code class="literal">RoutingSlipHeaderValueMessageProcessor</code> instance to the <code class="literal">HeaderEnricher</code> bean definition:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<em><span class="hl-annotation" style="color: gray">@Transformer(inputChannel = "routingSlipHeaderChannel")</span></em>
<span class="hl-keyword">public</span> HeaderEnricher headerEnricher() {
    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> HeaderEnricher(Collections.singletonMap(IntegrationMessageHeaderAccessor.ROUTING_SLIP,
            <span class="hl-keyword">new</span> RoutingSlipHeaderValueMessageProcessor(<span class="hl-string">"myRoutePath1"</span>,
                                                       <span class="hl-string">"@routingSlipRoutingPojo.get(request, reply)"</span>,
                                                       <span class="hl-string">"routingSlipRoutingStrategy"</span>,
                                                       <span class="hl-string">"request.headers[myRoutingSlipChannel]"</span>,
                                                       <span class="hl-string">"finishChannel"</span>)));
}</pre>
<p>The <span class="emphasis"><em>Routing Slip</em></span> algorithm works as follows when an endpoint produces a reply and there is no <code class="literal">outputChannel</code> defined:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
The <code class="literal">routingSlipIndex</code> is used to get a value from the Routing Slip <code class="literal">path</code> list.
</li><li class="listitem">
If the value by <code class="literal">routingSlipIndex</code> is <code class="literal">String</code>, it is used to get a bean from <code class="literal">BeanFactory</code>.
</li><li class="listitem">
If a returned bean is an instance of <code class="literal">MessageChannel</code>, it is used as the next <code class="literal">outputChannel</code> and the <code class="literal">routingSlipIndex</code> is incremented in the reply message header (the Routing Slip <code class="literal">path</code> entries remain unchanged).
</li><li class="listitem">
If a returned bean is an instance of <code class="literal">RoutingSlipRouteStrategy</code> and its <code class="literal">getNextPath</code> doesn&#8217;t return an empty String, that result is used a bean name for the next <code class="literal">outputChannel</code>.
The <code class="literal">routingSlipIndex</code> remains unchanged.
</li><li class="listitem">
If <code class="literal">RoutingSlipRouteStrategy.getNextPath</code> returns an empty String, the <code class="literal">routingSlipIndex</code> is incremented and the <code class="literal">getOutputChannelFromRoutingSlip</code> is invoked recursively for the next Routing Slip <code class="literal">path</code> item;
</li><li class="listitem">
If the next Routing Slip <code class="literal">path</code> entry isn&#8217;t a String it must be an instance of <code class="literal">RoutingSlipRouteStrategy</code>;
</li><li class="listitem">
When the <code class="literal">routingSlipIndex</code> exceeds the size of the Routing Slip <code class="literal">path</code> list, the algorithm moves to the default behavior for the standard <code class="literal">replyChannel</code> header.
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="process-manager" href="#process-manager"></a>Process Manager Enterprise Integration Pattern</h4></div></div></div>

<p>The EIP also defines the <a class="ulink" href="http://www.eaipatterns.com/ProcessManager.html" target="_top">Process Manager</a> pattern.
This pattern can now easily be implemented using custom <span class="emphasis"><em>Process Manager</em></span> logic encapsulated in a <code class="literal">RoutingSlipRouteStrategy</code> within the routing slip.
In addition to a bean name, the <code class="literal">RoutingSlipRouteStrategy</code> can return any <code class="literal">MessageChannel</code> object; and there is no requirement that this <code class="literal">MessageChannel</code> instance is a bean in the application context.
This way, we can provide powerful dynamic routing logic, when there is no prediction which channel should be used; a <code class="literal">MessageChannel</code> can be created within the <code class="literal">RoutingSlipRouteStrategy</code> and returned.
A <code class="literal">FixedSubscriberChannel</code> with an associated <code class="literal">MessageHandler</code> implementation is good combination for such cases.
For example we can route to a <a class="ulink" href="https://github.com/reactor/reactor/wiki/Streams" target="_top">Reactor Stream</a>:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> PollableChannel resultsChannel() {
    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> QueueChannel();
}
<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> RoutingSlipRouteStrategy routeStrategy() {
    <span class="hl-keyword">return</span> (requestMessage, reply) -&gt; requestMessage.getPayload() <span class="hl-keyword">instanceof</span> String
            ? <span class="hl-keyword">new</span> FixedSubscriberChannel(m -&gt;
            Streams.defer((String) m.getPayload())
                    .env(<span class="hl-keyword">this</span>.reactorEnv)
                    .get()
                    .map(String::toUpperCase)
                    .consume(v -&gt; messagingTemplate().convertAndSend(resultsChannel(), v))
                    .flush())
            : <span class="hl-keyword">new</span> FixedSubscriberChannel(m -&gt;
            Streams.defer((Integer) m.getPayload())
                    .env(<span class="hl-keyword">this</span>.reactorEnv)
                    .get()
                    .map(v -&gt; v * <span class="hl-number">2</span>)
                    .consume(v -&gt; messagingTemplate().convertAndSend(resultsChannel(), v))
                    .flush());
}</pre>
</div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="filter" href="#filter"></a>6.2&nbsp;Filter</h2></div></div></div>

<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="filter-introduction" href="#filter-introduction"></a>6.2.1&nbsp;Introduction</h3></div></div></div>

<p>Message Filters are used to decide whether a Message should be passed along or dropped based on some criteria such as a Message Header value or Message content itself.
Therefore, a Message Filter is similar to a router, except that for each Message received from the filter&#8217;s input channel, that same Message may or may not be sent to the filter&#8217;s output channel.
Unlike the router, it makes no decision regarding <span class="emphasis"><em>which</em></span> Message Channel to send the Message to but only decides <span class="emphasis"><em>whether</em></span> to send.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>As you will see momentarily, the Filter also supports a discard channel, so in certain cases it <span class="emphasis"><em>can</em></span> play the role of a very simple router (or "switch") based on a boolean condition.</p>
</td></tr></table></div>
<p>In Spring Integration, a Message Filter may be configured as a Message Endpoint that delegates to an implementation of the <code class="literal">MessageSelector</code> interface.
That interface is itself quite simple:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> MessageSelector {

    <span class="hl-keyword">boolean</span> accept(Message&lt;?&gt; message);

}</pre>
<p>The <code class="literal">MessageFilter</code> constructor accepts a selector instance:</p>
<pre class="programlisting">MessageFilter filter = <span class="hl-keyword">new</span> MessageFilter(someSelector);</pre>
<p>In combination with the namespace and SpEL, very powerful filters can be configured with very little java code.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="filter-config" href="#filter-config"></a>6.2.2&nbsp;Configuring Filter</h3></div></div></div>

<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="filter-xml" href="#filter-xml"></a>Configuring a Filter with XML</h4></div></div></div>

<p>The &lt;filter&gt; element is used to create a Message-selecting endpoint.
In addition to "<code class="literal">input-channel</code> and <code class="literal">output-channel</code> attributes, it requires a <code class="literal">ref</code>.
The <code class="literal">ref</code> may point to a <code class="literal">MessageSelector</code> implementation:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:filter</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"selector"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"selector"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"example.MessageSelectorImpl"</span><span class="hl-tag">/&gt;</span></pre>
<p>Alternatively, the <code class="literal">method</code> attribute can be added at which point the <code class="literal">ref</code> may refer to any object.
The referenced method may expect either the <code class="literal">Message</code> type or the payload type of inbound Messages.
The method must return a boolean value.
If the method returns <span class="emphasis"><em>true</em></span>, the Message <span class="emphasis"><em>will</em></span> be sent to the output-channel.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:filter</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span>
    <span class="hl-attribute">ref</span>=<span class="hl-value">"exampleObject"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"someBooleanReturningMethod"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"exampleObject"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"example.SomeObject"</span><span class="hl-tag">/&gt;</span></pre>
<p>If the selector or adapted POJO method returns <code class="literal">false</code>, there are a few settings that control the handling of the rejected Message.
By default (if configured like the example above), rejected Messages will be silently dropped.
If rejection should instead result in an error condition, then set the <code class="literal">throw-exception-on-rejection</code> attribute to <code class="literal">true</code>:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:filter</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"selector"</span>
    <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span> <span class="hl-attribute">throw-exception-on-rejection</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span></pre>
<p>If you want rejected messages to be routed to a specific channel, provide that reference as the <code class="literal">discard-channel</code>:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:filter</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"selector"</span>
    <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span> <span class="hl-attribute">discard-channel</span>=<span class="hl-value">"rejectedMessages"</span><span class="hl-tag">/&gt;</span></pre>
<p>Also see <a class="xref" href="#advising-filters" title="8.9.6&nbsp;Advising Filters">Section&nbsp;8.9.6, &#8220;Advising Filters&#8221;</a>.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Message Filters are commonly used in conjunction with a Publish Subscribe Channel.
Many filter endpoints may be subscribed to the same channel, and they decide whether or not to pass the Message to the next endpoint which could be any of the supported types (e.g.
Service Activator).
This provides a <span class="emphasis"><em>reactive</em></span> alternative to the more <span class="emphasis"><em>proactive</em></span> approach of using a Message Router with a single Point-to-Point input channel and multiple output channels.</p>
</td></tr></table></div>
<p>Using a <code class="literal">ref</code> attribute is generally recommended if the custom filter implementation is referenced in other <code class="literal">&lt;filter&gt;</code> definitions.
However if the custom filter implementation is scoped to a single <code class="literal">&lt;filter&gt;</code> element, provide an inner bean definition:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:filter</span> <span class="hl-attribute">method</span>=<span class="hl-value">"someMethod"</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"inChannel"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"outChannel"</span><span class="hl-tag">&gt;</span>
  <span class="hl-tag">&lt;beans:bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.foo.MyCustomFilter"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/filter&gt;</span></pre>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Using both the <code class="literal">ref</code> attribute and an inner handler definition in the same <code class="literal">&lt;filter&gt;</code> configuration is not allowed, as it creates an ambiguous condition, and an Exception will be thrown.</p>
</td></tr></table></div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>If the "ref" attribute references a bean that extends <code class="literal">MessageFilter</code> (such as filters provided by the framework itself), the configuration is optimized by injecting the output channel into the filter bean directly.
In this case, each "ref" must be to a separate bean instance (or a <code class="literal">prototype</code>-scoped bean), or use the inner <code class="literal">&lt;bean/&gt;</code> configuration type.
However, this optimization only applies if you don&#8217;t provide any filter-specific attributes in the filter XML definition.
If you inadvertently reference the same message handler from multiple beans, you will get a configuration exception.</p>
</td></tr></table></div>
<p>With the introduction of SpEL support, Spring Integration added the <code class="literal">expression</code> attribute to the filter element.
It can be used to avoid Java entirely for simple filters.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:filter</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"payload.equals('nonsense')"</span><span class="hl-tag">/&gt;</span></pre>
<p>The string passed as the expression attribute will be evaluated as a SpEL expression with the Message available in the evaluation context.
If it is necessary to include the result of an expression in the scope of the application context you can use the #{} notation as defined in the <a class="ulink" href="http://docs.spring.io/spring/docs/current/spring-framework-reference/html/expressions.html#expressions-beandef" target="_top">SpEL reference documentation</a>.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:filter</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span>
            <span class="hl-attribute">expression</span>=<span class="hl-value">"payload.matches(#{filterPatterns.nonsensePattern})"</span><span class="hl-tag">/&gt;</span></pre>
<p>If the Expression itself needs to be dynamic, then an <span class="emphasis"><em>expression</em></span> sub-element may be used.
That provides a level of indirection for resolving the Expression by its key from an ExpressionSource.
That is a strategy interface that you can implement directly, or you can rely upon a version available in Spring Integration that loads Expressions from a "resource bundle" and can check for modifications after a given number of seconds.
All of this is demonstrated in the following configuration sample where the Expression could be reloaded within one minute if the underlying file had been modified.
If the ExpressionSource bean is named "expressionSource", then it is not necessary to provide the` source` attribute on the &lt;expression&gt; element, but in this case it&#8217;s shown for completeness.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:filter</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:expression</span> <span class="hl-attribute">key</span>=<span class="hl-value">"filterPatterns.example"</span> <span class="hl-attribute">source</span>=<span class="hl-value">"myExpressions"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:filter&gt;</span>

<span class="hl-tag">&lt;beans:bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myExpressions"</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myExpressions"</span>
    <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.expression.ReloadableResourceBundleExpressionSource"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;beans:property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"basename"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"config/integration/expressions"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;beans:property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"cacheSeconds"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"60"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/beans:bean&gt;</span></pre>
<p>Then, the <span class="emphasis"><em>config/integration/expressions.properties</em></span> file (or any more specific version with a locale extension to be resolved in the typical way that resource-bundles are loaded) would contain a key/value pair:</p>
<pre class="programlisting">filterPatterns.example=payload &gt; 100</pre>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>All of these examples that use <code class="literal">expression</code> as an attribute or sub-element can also be applied within transformer, router, splitter, service-activator, and header-enricher elements.
Of course, the semantics/role of the given component type would affect the interpretation of the evaluation result in the same way that the return value of a method-invocation would be interpreted.
For example, an expression can return Strings that are to be treated as Message Channel names by a router component.
However, the underlying functionality of evaluating the expression against the Message as the root object, and resolving bean names if prefixed with <span class="emphasis"><em>@</em></span> is consistent across all of the core EIP components within Spring Integration.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="filter-annotations" href="#filter-annotations"></a>Configuring a Filter with Annotations</h4></div></div></div>

<p>A filter configured using annotations would look like this.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> PetFilter {
    ...
    <em><span class="hl-annotation" style="color: gray">@Filter</span></em>  <a name="CO2-1" href="#CO2-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
    <span class="hl-keyword">public</span> <span class="hl-keyword">boolean</span> dogsOnly(String input) {
        ...
    }
}</pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO2-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>An annotation indicating that this method shall be used as a filter.
Must be specified if this class will be used as a filter.</p>
</td></tr></table></div>
<p>All of the configuration options provided by the xml element are also available for the <code class="literal">@Filter</code> annotation.</p>
<p>The filter can be either referenced explicitly from XML or, if the <code class="literal">@MessageEndpoint</code> annotation is defined on the class, detected automatically through classpath scanning.</p>
<p>Also see <a class="xref" href="#advising-with-annotations" title="8.9.7&nbsp;Advising Endpoints Using Annotations">Section&nbsp;8.9.7, &#8220;Advising Endpoints Using Annotations&#8221;</a>.</p>
</div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="splitter" href="#splitter"></a>6.3&nbsp;Splitter</h2></div></div></div>

<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="splitter-annotation" href="#splitter-annotation"></a>6.3.1&nbsp;Introduction</h3></div></div></div>

<p>The Splitter is a component whose role is to partition a message in several parts, and send the resulting messages to be processed independently.
Very often, they are upstream producers in a pipeline that includes an Aggregator.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_programming_model" href="#_programming_model"></a>6.3.2&nbsp;Programming model</h3></div></div></div>

<p>The API for performing splitting consists of one base class, <code class="literal">AbstractMessageSplitter</code>, which is a <code class="literal">MessageHandler</code> implementation, encapsulating features which are common to splitters, such as filling in the appropriate message headers <code class="literal">CORRELATION_ID</code>, <code class="literal">SEQUENCE_SIZE</code>, and <code class="literal">SEQUENCE_NUMBER</code> on the messages that are produced.
This enables tracking down the messages and the results of their processing (in a typical scenario, these headers would be copied over to the messages that are produced by the various transforming endpoints), and use them, for example, in a <a class="ulink" href="http://www.eaipatterns.com/DistributionAggregate.html" target="_top">Composed Message Processor</a> scenario.</p>
<p>An excerpt from <code class="literal">AbstractMessageSplitter</code> can be seen below:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">abstract</span> <span class="hl-keyword">class</span> AbstractMessageSplitter
    <span class="hl-keyword">extends</span> AbstractReplyProducingMessageConsumer {
    ...
    <span class="hl-keyword">protected</span> <span class="hl-keyword">abstract</span> Object splitMessage(Message&lt;?&gt; message);

}</pre>
<p>To implement a specific Splitter in an application, extend <code class="literal">AbstractMessageSplitter</code> and implement the <code class="literal">splitMessage</code> method, which contains logic for splitting the messages.
The return value may be one of the following:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
A <code class="literal">Collection</code> or an array of Messages, or an <code class="literal">Iterable</code> (or <code class="literal">Iterator</code>) that iterates over Messages - in this case the messages will be sent as such (after the <code class="literal">CORRELATION_ID</code>, <code class="literal">SEQUENCE_SIZE</code> and <code class="literal">SEQUENCE_NUMBER</code> are populated).
Using this approach gives more control to the developer, for example for populating custom message headers as part of the splitting process.
</li><li class="listitem">
A <code class="literal">Collection</code> or an array of non-Message objects, or an <code class="literal">Iterable</code> (or <code class="literal">Iterator</code>) that iterates over non-Message objects - works like the prior case, except that each collection element will be used as a Message payload.
Using this approach allows developers to focus on the domain objects without having to consider the Messaging system and produces code that is easier to test.
</li><li class="listitem">
a <code class="literal">Message</code> or non-Message object (but not a Collection or an Array) - it works like the previous cases, except a single message will be sent out.
</li></ul></div>
<p>In Spring Integration, any POJO can implement the splitting algorithm, provided that it defines a method that accepts a single argument and has a return value.
In this case, the return value of the method will be interpreted as described above.
The input argument might either be a <code class="literal">Message</code> or a simple POJO.
In the latter case, the splitter will receive the payload of the incoming message.
Since this decouples the code from the Spring Integration API and will typically be easier to test, it is the recommended approach.</p>
<p><span class="strong"><strong>Splitter and Iterators</strong></span></p>
<p>Starting with <span class="emphasis"><em>version 4.1</em></span>, the <code class="literal">AbstractMessageSplitter</code> supports the <code class="literal">Iterator</code> type for the <code class="literal">value</code> to split.
Note, in the case of an <code class="literal">Iterator</code> (or <code class="literal">Iterable</code>), we don&#8217;t have access to the number of underlying items and the <code class="literal">SEQUENCE_SIZE</code> header is set to <code class="literal">0</code>.
This means that the default <code class="literal">SequenceSizeReleaseStrategy</code> of an <code class="literal">&lt;aggregator&gt;</code> won&#8217;t work and the group for the <code class="literal">CORRELATION_ID</code> from the <code class="literal">splitter</code> won&#8217;t be released; it will remain as <code class="literal">incomplete</code>.
In this case you should use an appropriate custom <code class="literal">ReleaseStrategy</code> or rely on <code class="literal">send-partial-result-on-expiry</code> together with <code class="literal">group-timeout</code> or a <code class="literal">MessageGroupStoreReaper</code>.</p>
<p>An <code class="literal">Iterator</code> object is useful to avoid the need for building an entire collection in the memory before splitting.
For example, when underlying items are populated from some external system (e.g.
DataBase or FTP <code class="literal">MGET</code>) using iterations or streams.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="splitter-config" href="#splitter-config"></a>6.3.3&nbsp;Configuring Splitter</h3></div></div></div>

<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_configuring_a_splitter_using_xml" href="#_configuring_a_splitter_using_xml"></a>Configuring a Splitter using XML</h4></div></div></div>

<p>A splitter can be configured through XML as follows:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"inputChannel"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int:splitter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"splitter"</span>  <a name="CO3-1" href="#CO3-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
  ref="splitterBean"  <a name="CO3-2" href="#CO3-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
  method="split"  <a name="CO3-3" href="#CO3-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
  input-channel="inputChannel"  <a name="CO3-4" href="#CO3-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
  output-channel="outputChannel" /&gt; <a name="CO3-5" href="#CO3-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>

<span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"outputChannel"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;beans:bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"splitterBean"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"sample.PojoSplitter"</span><span class="hl-tag">/&gt;</span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO3-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The id of the splitter is <span class="emphasis"><em>optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO3-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A reference to a bean defined in the application context.
The bean must implement the splitting logic as described in the section above .<span class="emphasis"><em>Optional</em></span>.
If reference to a bean is not provided, then it is assumed that the <span class="emphasis"><em>payload</em></span> of the Message that arrived on the <code class="literal">input-channel</code> is an implementation of <code class="literal">java.util.Collection</code> and the default splitting logic will be applied to the Collection, incorporating each individual element into a Message and sending it to the <code class="literal">output-channel</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO3-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The method (defined on the bean specified above) that implements the splitting logic.<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO3-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The input channel of the splitter.
<span class="emphasis"><em>Required</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO3-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The channel to which the splitter will send the results of splitting the incoming message.
<span class="emphasis"><em>Optional (because incoming
          messages can specify a reply channel themselves)</em></span>.</p>
</td></tr></table></div>
<p>Using a <code class="literal">ref</code> attribute is generally recommended if the custom splitter implementation may be referenced in other <code class="literal">&lt;splitter&gt;</code> definitions.
However if the custom splitter handler implementation should be scoped to a single definition of the <code class="literal">&lt;splitter&gt;</code>, configure an inner bean definition:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:splitter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"testSplitter"</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"inChannel"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"split"</span>
                <span class="hl-attribute">output-channel</span>=<span class="hl-value">"outChannel"</span><span class="hl-tag">&gt;</span>
  <span class="hl-tag">&lt;beans:bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.foo.TestSplitter"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:splitter&gt;</span></pre>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Using both a <code class="literal">ref</code> attribute and an inner handler definition in the same <code class="literal">&lt;int:splitter&gt;</code> configuration is not allowed, as it creates an ambiguous condition and will result in an Exception being thrown.</p>
</td></tr></table></div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>If the "ref" attribute references a bean that extends <code class="literal">AbstractMessageProducingHandler</code> (such as splitters provided by the framework itself), the configuration is optimized by injecting the output channel into the handler directly.
In this case, each "ref" must be to a separate bean instance (or a <code class="literal">prototype</code>-scoped bean), or use the inner <code class="literal">&lt;bean/&gt;</code> configuration type.
However, this optimization only applies if you don&#8217;t provide any splitter-specific attributes in the splitter XML definition.
If you inadvertently reference the same message handler from multiple beans, you will get a configuration exception.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_configuring_a_splitter_with_annotations" href="#_configuring_a_splitter_with_annotations"></a>Configuring a Splitter with Annotations</h4></div></div></div>

<p>The <code class="literal">@Splitter</code> annotation is applicable to methods that expect either the`Message` type or the message payload type, and the return values of the method should be a <code class="literal">Collection</code> of any type.
If the returned values are not actual <code class="literal">Message</code> objects, then each item will be wrapped in a Message as its payload.
Each message will be sent to the designated output channel for the endpoint on which the <code class="literal">@Splitter</code> is defined.</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Splitter</span></em>
List&lt;LineItem&gt; extractItems(Order order) {
    <span class="hl-keyword">return</span> order.getItems()
}</pre>
<p>Also see <a class="xref" href="#advising-with-annotations" title="8.9.7&nbsp;Advising Endpoints Using Annotations">Section&nbsp;8.9.7, &#8220;Advising Endpoints Using Annotations&#8221;</a>.</p>
</div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="aggregator" href="#aggregator"></a>6.4&nbsp;Aggregator</h2></div></div></div>

<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="aggregator-introduction" href="#aggregator-introduction"></a>6.4.1&nbsp;Introduction</h3></div></div></div>

<p>Basically a mirror-image of the Splitter, the Aggregator is a type of Message Handler that receives multiple Messages and combines them into a single Message.
In fact, an Aggregator is often a downstream consumer in a pipeline that includes a Splitter.</p>
<p>Technically, the Aggregator is more complex than a Splitter, because it is stateful as it must hold the Messages to be aggregated and determine when the complete group of Messages is ready to be aggregated.
In order to do this it requires a <code class="literal">MessageStore</code>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="aggregator-functionality" href="#aggregator-functionality"></a>6.4.2&nbsp;Functionality</h3></div></div></div>

<p>The Aggregator combines a group of related messages, by correlating and storing them, until the group is deemed complete.
At that point, the Aggregator will create a single message by processing the whole group, and will send the aggregated message as output.</p>
<p>Implementing an Aggregator requires providing the logic to perform the aggregation (i.e., the creation of a single message from many).
Two related concepts are correlation and release.</p>
<p>Correlation determines how messages are grouped for aggregation.
In Spring Integration correlation is done by default based on the <code class="literal">IntegrationMessageHeaderAccessor.CORRELATION_ID</code> message header.
Messages with the same <code class="literal">IntegrationMessageHeaderAccessor.CORRELATION_ID</code> will be grouped together.
However, the correlation strategy may be customized to allow other ways of specifying how the messages should be grouped together by implementing a <code class="literal">CorrelationStrategy</code> (see below).</p>
<p>To determine the point at which a group of messages is ready to be processed, a <code class="literal">ReleaseStrategy</code> is consulted.
The default release strategy for the Aggregator will release a group when all messages included in a sequence are present, based on the <code class="literal">IntegrationMessageHeaderAccessor.SEQUENCE_SIZE</code> header.
This default strategy may be overridden by providing a reference to a custom <code class="literal">ReleaseStrategy</code> implementation.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="aggregator-api" href="#aggregator-api"></a>6.4.3&nbsp;Programming model</h3></div></div></div>

<p>The Aggregation API consists of a number of classes:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
The interface <code class="literal">MessageGroupProcessor</code>, and its subclasses:<code class="literal">MethodInvokingAggregatingMessageGroupProcessor</code> and <code class="literal">ExpressionEvaluatingMessageGroupProcessor</code>
</li><li class="listitem">
The <code class="literal">ReleaseStrategy</code> interface and its default implementation <code class="literal">SequenceSizeReleaseStrategy</code>
</li><li class="listitem">
The <code class="literal">CorrelationStrategy</code> interface and its default implementation <code class="literal">HeaderAttributeCorrelationStrategy</code>
</li></ul></div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_aggregatingmessagehandler" href="#_aggregatingmessagehandler"></a>AggregatingMessageHandler</h4></div></div></div>

<p>The <code class="literal">AggregatingMessageHandler</code> (subclass of <code class="literal">AbstractCorrelatingMessageHandler</code>) is a <code class="literal">MessageHandler</code> implementation, encapsulating the common functionalities of an Aggregator (and other correlating use cases), which are:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
correlating messages into a group to be aggregated
</li><li class="listitem">
maintaining those messages in a <code class="literal">MessageStore</code> until the group can be released
</li><li class="listitem">
deciding when the group can be released
</li><li class="listitem">
aggregating the released group into a single message
</li><li class="listitem">
recognizing and responding to an expired group
</li></ul></div>
<p>The responsibility of deciding how the messages should be grouped together is delegated to a <code class="literal">CorrelationStrategy</code> instance.
The responsibility of deciding whether the message group can be released is delegated to a <code class="literal">ReleaseStrategy</code> instance.</p>
<p>Here is a brief highlight of the base <code class="literal">AbstractAggregatingMessageGroupProcessor</code> (the responsibility of implementing the <code class="literal">aggregatePayloads</code> method is left to the developer):</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">abstract</span> <span class="hl-keyword">class</span> AbstractAggregatingMessageGroupProcessor
              <span class="hl-keyword">implements</span> MessageGroupProcessor {

    <span class="hl-keyword">protected</span> Map&lt;String, Object&gt; aggregateHeaders(MessageGroup group) {
        <span class="hl-comment">// default implementation exists</span>
    }

    <span class="hl-keyword">protected</span> <span class="hl-keyword">abstract</span> Object aggregatePayloads(MessageGroup group, Map&lt;String, Object&gt; defaultHeaders);

}</pre>
<p>The <code class="literal">CorrelationStrategy</code> is owned by the <code class="literal">AbstractCorrelatingMessageHandler</code> and it has a default value based on the <code class="literal">IntegrationMessageHeaderAccessor.CORRELATION_ID</code> message header:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> AbstractCorrelatingMessageHandler(MessageGroupProcessor processor, MessageGroupStore store,
        CorrelationStrategy correlationStrategy, ReleaseStrategy releaseStrategy) {
    ...
    <span class="hl-keyword">this</span>.correlationStrategy = correlationStrategy == null ?
        <span class="hl-keyword">new</span> HeaderAttributeCorrelationStrategy(IntegrationMessageHeaderAccessor.CORRELATION_ID) : correlationStrategy;
    <span class="hl-keyword">this</span>.releaseStrategy = releaseStrategy == null ? <span class="hl-keyword">new</span> SequenceSizeReleaseStrategy() : releaseStrategy;
    ...
}</pre>
<p>As for actual processing of the message group, the default implementation is the <code class="literal">DefaultAggregatingMessageGroupProcessor</code>.
It creates a single Message whose payload is a List of the payloads received for a given group.
This works well for simple Scatter Gather implementations with either a Splitter, Publish Subscribe Channel, or Recipient List Router upstream.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>When using a Publish Subscribe Channel or Recipient List Router in this type of scenario, be sure to enable the flag to <code class="literal">apply-sequence</code>.
That will add the necessary headers (CORRELATION_ID, SEQUENCE_NUMBER and SEQUENCE_SIZE).
That behavior is enabled by default for Splitters in Spring Integration, but it is not enabled for the Publish Subscribe Channel or Recipient List Router because those components may be used in a variety of contexts in which these headers are not necessary.</p>
</td></tr></table></div>
<p>When implementing a specific aggregator strategy for an application, a developer can extend <code class="literal">AbstractAggregatingMessageGroupProcessor</code> and implement the <code class="literal">aggregatePayloads</code> method.
However, there are better solutions, less coupled to the API, for implementing the aggregation logic which can be configured easily either through XML or through annotations.</p>
<p>In general, any POJO can implement the aggregation algorithm if it provides a method that accepts a single <code class="literal">java.util.List</code> as an argument (parameterized lists are supported as well).
This method will be invoked for aggregating messages as follows:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
if the argument is a <code class="literal">java.util.Collection&lt;T&gt;</code>, and the parameter type T is assignable to <code class="literal">Message</code>,
then the whole list of messages accumulated for aggregation will be sent to the aggregator
</li><li class="listitem">
if the argument is a non-parameterized <code class="literal">java.util.Collection</code> or the parameter type is not assignable to <code class="literal">Message</code>,
then the method will receive the payloads of the accumulated messages
</li><li class="listitem">
if the return type is not assignable to <code class="literal">Message</code>, then it will be treated as the payload for a Message that will be created automatically by the framework.
</li></ul></div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>In the interest of code simplicity, and promoting best practices such as low coupling, testability, etc., the preferred way of implementing the aggregation logic is through a POJO, and using the XML or annotation support for configuring it in the application.</p>
</td></tr></table></div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left"><a name="agg-message-collection" href="#agg-message-collection"></a>Important</th></tr><tr><td align="left" valign="top">
<p>The <code class="literal">SimpleMessageGroup.getMessages()</code> method returns an <code class="literal">unmodifiableCollection</code>, therefore,
if your aggregating POJO method has a <code class="literal">Collection&lt;Message&gt;</code> parameter, the argument passed in will be exactly that
<code class="literal">Collection</code> instance and, when a <code class="literal">SimpleMessageStore</code> is used for the Aggregator,
that original <code class="literal">Collection&lt;Message&gt;</code> will be cleared after releasing the group.
Hence the <code class="literal">Collection&lt;Message&gt;</code> variable in the POJO will be cleared too, if passed out of the aggregator.
If you wish to simply release that collection as-is for further processing,
it is required that you build a new <code class="literal">Collection</code> (e.g. <code class="literal">new ArrayList&lt;Message&gt;(messages)</code>)
Starting with _version 4.3, the Framework no longer copies the messages to a new collection, to avoid undesired extra
object creation.</p>
</td></tr></table></div>
<p>If the <code class="literal">MessageGroupProcessor</code> 's <code class="literal">processMessageGroup</code> method returns a collection, it must be a collection of
<code class="literal">Message&lt;?&gt;</code> s.
In this case, the messages are released individually.
Prior to <span class="emphasis"><em>version 4.2</em></span>, it was not possible to provide a <code class="literal">MessageGroupProcessor</code> using XML configuration, only POJO
methods could be used for aggregation.
Now, if the framework detects that the referenced (or inner) bean implements <code class="literal">MessageProcessor</code>, it is used as the
aggregator&#8217;s output processor.</p>
<p>If you wish to release a collection of objects from a custom <code class="literal">MessageGroupProcessor</code> as the payload of a message, your
class should extend <code class="literal">AbstractAggregatingMessageGroupProcessor</code> and implement <code class="literal">aggregatePayloads()</code>.</p>
<p>Also, since <span class="emphasis"><em>version 4.2</em></span>, a <code class="literal">SimpleMessageGroupProcessor</code> is provided; which simply returns the collection of
messages from the group, which, as indicated above, causes the released messages to be sent individually.</p>
<p>This allows the aggregator to work as a message barrier where arriving messages are held until the release strategy
fires, and the group is released, as a sequence of individual messages.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_releasestrategy" href="#_releasestrategy"></a>ReleaseStrategy</h4></div></div></div>

<p>The <code class="literal">ReleaseStrategy</code> interface is defined as follows:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> ReleaseStrategy {

  <span class="hl-keyword">boolean</span> canRelease(MessageGroup group);

}</pre>
<p>In general, any POJO can implement the completion decision logic if it provides a method that accepts a single <code class="literal">java.util.List</code> as an argument (parameterized lists are supported as well), and returns a boolean value.
This method will be invoked after the arrival of each new message, to decide whether the group is complete or not, as follows:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
if the argument is a <code class="literal">java.util.List&lt;T&gt;</code>, and the parameter type T is assignable to <code class="literal">Message</code>, then the whole list of messages accumulated in the group will be sent to the method
</li><li class="listitem">
if the argument is a non-parametrized <code class="literal">java.util.List</code> or the parameter type is not assignable to <code class="literal">Message</code>, then the method will receive the payloads of the accumulated messages
</li><li class="listitem">
the method must return true if the message group is ready for aggregation, and false otherwise.
</li></ul></div>
<p>For example:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyReleaseStrategy {

    <em><span class="hl-annotation" style="color: gray">@ReleaseStrategy</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">boolean</span> canMessagesBeReleased(List&lt;Message&lt;?&gt;&gt;) {...}
}</pre>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyReleaseStrategy {

    <em><span class="hl-annotation" style="color: gray">@ReleaseStrategy</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">boolean</span> canMessagesBeReleased(List&lt;String&gt;) {...}
}</pre>
<p>As you can see based on the above signatures, the POJO-based Release Strategy will be passed a <code class="literal">Collection</code> of not-yet-released Messages (if you need access to the whole <code class="literal">Message</code>) or a <code class="literal">Collection</code> of payload objects (if the type parameter is anything other than <code class="literal">Message</code>).
Typically this would satisfy the majority of use cases.
However if, for some reason, you need to access the full <code class="literal">MessageGroup</code> then you should simply provide an implementation of the <code class="literal">ReleaseStrategy</code> interface.</p>
<div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Warning"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Warning]" src="images/warning.png"></td><th align="left">Warning</th></tr><tr><td align="left" valign="top">
<p>When handling potentially large groups, it is important to understand how these methods are invoked because the release strategy may be invoked multiple times before the group is released.
The most efficient is an implementation of <code class="literal">ReleaseStrategy</code> because the aggregator can invoke it directly.
The second most efficient is a POJO method with a <code class="literal">Collection&lt;Message&lt;?&gt;&gt;</code> parameter type.
The least efficient is a POJO method with a <code class="literal">Collection&lt;Foo&gt;</code> type - the framework has to copy the payloads from the messages in the group into a new collection (and possibly attempt conversion on the payloads to <code class="literal">Foo</code>) every time the release strategy is called.
<code class="literal">Collection&lt;?&gt;</code> avoids the conversion but still requires creating the new <code class="literal">Collection</code>.</p>
<p><span class="strong"><strong>For these reasons, for large groups, it is recommended that you implement <code class="literal">ReleaseStrategy</code>.</strong></span></p>
</td></tr></table></div>
<p>When the group is released for aggregation, all its not-yet-released messages are processed and removed from the group.
If the group is also complete (i.e.
if all messages from a sequence have arrived or if there is no sequence defined), then the group is marked as complete.
Any new messages for this group will be sent to the discard channel (if defined).
Setting <code class="literal">expire-groups-upon-completion</code> to <code class="literal">true</code> (default is <code class="literal">false</code>) removes the entire group and any new messages, with the same correlation id as the removed group, will form a new group.
Partial sequences can be released by using a <code class="literal">MessageGroupStoreReaper</code> together with <code class="literal">send-partial-result-on-expiry</code> being set to <code class="literal">true</code>.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>To facilitate discarding of late-arriving messages, the aggregator must maintain state about the group after it has been released.
This can eventually cause out of memory conditions.
To avoid such situations, you should consider configuring a <code class="literal">MessageGroupStoreReaper</code> to remove the group metadata; the expiry parameters should be set to expire groups after it is not expected that late messages will arrive.
For information about configuring a reaper, see <a class="xref" href="#reaper" title="6.4.5&nbsp;Managing State in an Aggregator: MessageGroupStore">Section&nbsp;6.4.5, &#8220;Managing State in an Aggregator: MessageGroupStore&#8221;</a>.</p>
</td></tr></table></div>
<p>Spring Integration provides an out-of-the box implementation for <code class="literal">ReleaseStrategy</code>, the <code class="literal">SequenceSizeReleaseStrategy</code>.
This implementation consults the <code class="literal">SEQUENCE_NUMBER</code> and <code class="literal">SEQUENCE_SIZE</code> headers of each arriving message to decide when a message group is complete and ready to be aggregated.
As shown above, it is also the default strategy.</p>
<p>If you are aggregating large groups, you don&#8217;t need to release partial groups, and you don&#8217;t need to detect/reject duplicate sequences, consider using the <code class="literal">SimpleSequenceSizeReleaseStrategy</code> instead - it is much more efficient for these use cases, and will be the default in future releases when partial group release is not specified.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_aggregating_large_groups" href="#_aggregating_large_groups"></a>Aggregating Large Groups</h4></div></div></div>

<p>The 4.3 release changed the default <code class="literal">Collection</code> for messages in a <code class="literal">SimpleMessageGroup</code> to <code class="literal">HashSet</code> (it was previously a <code class="literal">BlockingQueue</code>).
This was expensive when removing individual messages from large groups (an O(n) linear scan was required).
Although the hash set is generally much faster for removing, it can be expensive for large messages because the hash has to be calculated (on both inserts and removes).
If you have messages that are expensive to hash, consider using some other collection type.
As discussed in <a class="xref" href="#message-group-factory" title="9.4.1&nbsp;MessageGroupFactory">Section&nbsp;9.4.1, &#8220;MessageGroupFactory&#8221;</a>, a <code class="literal">SimpleMessageGroupFactory</code> is provided so you can select the <code class="literal">Collection</code> that best suits your needs.
You can also provide your own factory implementation to create some other <code class="literal">Collection&lt;Message&lt;?&gt;&gt;</code>.</p>
<p>Here is an example of how to configure an aggregator with the previous implementation and a <code class="literal">SimpleSequenceSizeReleaseStrategy</code>.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:aggregator</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"aggregate"</span>
    <span class="hl-attribute">output-channel</span>=<span class="hl-value">"out"</span> <span class="hl-attribute">message-store</span>=<span class="hl-value">"store"</span> <span class="hl-attribute">release-strategy</span>=<span class="hl-value">"releaser"</span><span class="hl-tag"> /&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"store"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.store.SimpleMessageStore"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"messageGroupFactory"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.store.SimpleMessageGroupFactory"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"BLOCKING_QUEUE"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/bean&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"releaser"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"SimpleSequenceSizeReleaseStrategy"</span><span class="hl-tag"> /&gt;</span></pre>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_correlationstrategy" href="#_correlationstrategy"></a>CorrelationStrategy</h4></div></div></div>

<p>The <code class="literal">CorrelationStrategy</code> interface is defined as follows:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> CorrelationStrategy {

  Object getCorrelationKey(Message&lt;?&gt; message);

}</pre>
<p>The method returns an Object which represents the correlation key used for associating the message with a message group.
The key must satisfy the criteria used for a key in a Map with respect to the implementation of <code class="literal">equals()</code> and <code class="literal">hashCode()</code>.</p>
<p>In general, any POJO can implement the correlation logic, and the rules for mapping a message to a method&#8217;s argument (or arguments) are the same as for a <code class="literal">ServiceActivator</code> (including support for @Header annotations).
The method must return a value, and the value must not be <code class="literal">null</code>.</p>
<p>Spring Integration provides an out-of-the box implementation for <code class="literal">CorrelationStrategy</code>, the <code class="literal">HeaderAttributeCorrelationStrategy</code>.
This implementation returns the value of one of the message headers (whose name is specified by a constructor argument) as the correlation key.
By default, the correlation strategy is a <code class="literal">HeaderAttributeCorrelationStrategy</code> returning the value of the <code class="literal">CORRELATION_ID</code> header attribute.
If you have a custom header name you would like to use for correlation, then simply configure that on an instance of <code class="literal">HeaderAttributeCorrelationStrategy</code> and provide that as a reference for the Aggregator&#8217;s correlation-strategy.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_lockregistry" href="#_lockregistry"></a>LockRegistry</h4></div></div></div>

<p>Changes to groups are thread safe; a <code class="literal">LockRegistry</code> is used to obtain a lock for the resolved correlation id.
A <code class="literal">DefaultLockRegistry</code> is used by default (in-memory).
For synchronizing updates across servers, where a shared <code class="literal">MessageGroupStore</code> is being used, a shared lock registry
must be configured.
See <a class="xref" href="#aggregator-config" title="6.4.4&nbsp;Configuring an Aggregator">Section&nbsp;6.4.4, &#8220;Configuring an Aggregator&#8221;</a> below for more information.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="aggregator-config" href="#aggregator-config"></a>6.4.4&nbsp;Configuring an Aggregator</h3></div></div></div>

<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="aggregator-xml" href="#aggregator-xml"></a>Configuring an Aggregator with XML</h4></div></div></div>

<p>Spring Integration supports the configuration of an aggregator via XML through the <code class="literal">&lt;aggregator/&gt;</code> element.
Below you can see an example of an aggregator.</p>
<pre class="programlisting"><span class="hl-tag">&lt;channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"inputChannel"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int:aggregator</span> <span class="hl-attribute">id</span>=<span class="hl-value">""</span><span class="hl-attribute">myAggregator"</span>  <a name="CO4-1" href="#CO4-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
        auto-startup="true"  <a name="CO4-2" href="#CO4-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
        input-channel="inputChannel"  <a name="CO4-3" href="#CO4-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
        output-channel="outputChannel"  <a name="CO4-4" href="#CO4-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
        discard-channel="throwAwayChannel"  <a name="CO4-5" href="#CO4-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
        message-store="persistentMessageStore"  <a name="CO4-6" href="#CO4-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>
        order="1"  <a name="CO4-7" href="#CO4-7"></a><span><img src="images/callouts/7.png" alt="7" border="0"></span>
        send-partial-result-on-expiry="false"  <a name="CO4-8" href="#CO4-8"></a><span><img src="images/callouts/8.png" alt="8" border="0"></span>
        send-timeout="1000"  <a name="CO4-9" href="#CO4-9"></a><span><img src="images/callouts/9.png" alt="9" border="0"></span>

        correlation-strategy="correlationStrategyBean"  <a name="CO4-10" href="#CO4-10"></a><span><img src="images/callouts/10.png" alt="10" border="0"></span>
        correlation-strategy-method="correlate"  <a name="CO4-11" href="#CO4-11"></a><span><img src="images/callouts/11.png" alt="11" border="0"></span>
        correlation-strategy-expression="headers['foo']"  <a name="CO4-12" href="#CO4-12"></a><span><img src="images/callouts/12.png" alt="12" border="0"></span>

        ref="aggregatorBean"  <a name="CO4-13" href="#CO4-13"></a><span><img src="images/callouts/13.png" alt="13" border="0"></span>
        method="aggregate"  <a name="CO4-14" href="#CO4-14"></a><span><img src="images/callouts/14.png" alt="14" border="0"></span>

        release-strategy="releaseStrategyBean"  <a name="CO4-15" href="#CO4-15"></a><span><img src="images/callouts/15.png" alt="15" border="0"></span>
        release-strategy-method="release"  <a name="CO4-16" href="#CO4-16"></a>(16)
        release-strategy-expression="size() == 5"  <a name="CO4-17" href="#CO4-17"></a>(17)

        expire-groups-upon-completion="false"  <a name="CO4-18" href="#CO4-18"></a>(18)
        empty-group-min-timeout="60000"  <a name="CO4-19" href="#CO4-19"></a>(19)

        lock-registry="lockRegistry"  <a name="CO4-20" href="#CO4-20"></a>(20)

        group-timeout="60000"  <a name="CO4-21" href="#CO4-21"></a>(21)
        group-timeout-expression="size() ge 2 ? 100 : -1"  <a name="CO4-22" href="#CO4-22"></a>(22)
        expire-groups-upon-timeout="true"  <a name="CO4-23" href="#CO4-23"></a>(23)

        scheduler="taskScheduler" &gt;  <a name="CO4-24" href="#CO4-24"></a>(24)
            <span class="hl-tag">&lt;expire-transactional/&gt;</span>  <a name="CO4-25" href="#CO4-25"></a>(25)
            <span class="hl-tag">&lt;expire-advice-chain/&gt;</span>  <a name="CO4-26" href="#CO4-26"></a>(26)
<span class="hl-tag">&lt;/aggregator&gt;</span>

<span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"outputChannel"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"throwAwayChannel"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"persistentMessageStore"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.jdbc.JdbcMessageStore"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"dataSource"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"aggregatorBean"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"sample.PojoAggregator"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"releaseStrategyBean"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"sample.PojoReleaseStrategy"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"correlationStrategyBean"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"sample.PojoCorrelationStrategy"</span><span class="hl-tag">/&gt;</span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO4-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The id of the aggregator is <span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO4-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Lifecycle attribute signaling if aggregator should be started during Application Context startup.
<span class="emphasis"><em>Optional (default is <span class="emphasis"><em>true</em></span>)</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO4-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The channel from which where aggregator will receive messages.
<span class="emphasis"><em>Required</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO4-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The channel to which the aggregator will send the aggregation results.
<span class="emphasis"><em>Optional (because incoming messages can specify a reply channel themselves via <span class="emphasis"><em>replyChannel</em></span> Message Header)</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO4-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The channel to which the aggregator will send the messages that timed out (if <code class="literal">send-partial-result-on-expiry</code> is <span class="emphasis"><em>false</em></span>).
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO4-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A reference to a <code class="literal">MessageGroupStore</code> used to store groups of messages under their correlation key until they are complete.
<span class="emphasis"><em>Optional</em></span>, by default a volatile in-memory store.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO4-7"><span><img src="images/callouts/7.png" alt="7" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Order of this aggregator when more than one handle is subscribed to the same DirectChannel (use for load balancing purposes).
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO4-8"><span><img src="images/callouts/8.png" alt="8" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Indicates that expired messages should be aggregated and sent to the <span class="emphasis"><em>output-channel</em></span> or <span class="emphasis"><em>replyChannel</em></span> once their containing <code class="literal">MessageGroup</code> is expired (see <code class="literal">MessageGroupStore.expireMessageGroups(long)</code>).
One way of expiring <code class="literal">MessageGroup</code> s is by configuring a <code class="literal">MessageGroupStoreReaper</code>.
However <code class="literal">MessageGroup</code> s can alternatively be expired by simply calling <code class="literal">MessageGroupStore.expireMessageGroups(timeout)</code>.
That could be accomplished via a Control Bus operation or by simply invoking that method if you have a reference to the <code class="literal">MessageGroupStore</code> instance.
Otherwise by itself this attribute has no behavior.
It only serves as an indicator of what to do (discard or send to the output/reply channel) with Messages that are still in the <code class="literal">MessageGroup</code> that is about to be expired.
<span class="emphasis"><em>Optional</em></span>.
<span class="emphasis"><em>Default - false</em></span>.
<span class="strong"><strong>NOTE:</strong></span> This attribute is more properly <code class="literal">send-partial-result-on-timeout</code> because the group may not actually expire if
<code class="literal">expire-groups-upon-timeout</code> is set to <code class="literal">false</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO4-9"><span><img src="images/callouts/9.png" alt="9" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The timeout interval to wait when sending a reply <code class="literal">Message</code> to the <code class="literal">output-channel</code> or <code class="literal">discard-channel</code>.
Defaults to <code class="literal">-1</code> - blocking indefinitely.
It is applied only if the output channel has some <span class="emphasis"><em>sending</em></span> limitations, e.g.
<code class="literal">QueueChannel</code> with a fixed <span class="emphasis"><em>capacity</em></span>.
In this case a <code class="literal">MessageDeliveryException</code> is thrown.
The <code class="literal">send-timeout</code> is ignored in case of <code class="literal">AbstractSubscribableChannel</code> implementations.
In case of <code class="literal">group-timeout(-expression)</code> the <code class="literal">MessageDeliveryException</code> from the scheduled expire task leads this task to be rescheduled.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO4-10"><span><img src="images/callouts/10.png" alt="10" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A reference to a bean that implements the message correlation (grouping) algorithm.
The bean can be an implementation of the <code class="literal">CorrelationStrategy</code> interface or a POJO.
In the latter case the correlation-strategy-method attribute must be defined as well.
<span class="emphasis"><em>Optional (by default, the aggregator will use the <code class="literal">IntegrationMessageHeaderAccessor.CORRELATION_ID</code> header)</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO4-11"><span><img src="images/callouts/11.png" alt="11" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A method defined on the bean referenced by <code class="literal">correlation-strategy</code>, that implements the correlation decision algorithm.
<span class="emphasis"><em>Optional, with restrictions (requires <code class="literal">correlation-strategy</code> to be present).</em></span></p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO4-12"><span><img src="images/callouts/12.png" alt="12" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A SpEL expression representing the correlation strategy.
Example: <code class="literal">"headers['foo']"</code>.
Only one of <code class="literal">correlation-strategy</code> or <code class="literal">correlation-strategy-expression</code> is allowed.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO4-13"><span><img src="images/callouts/13.png" alt="13" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A reference to a bean defined in the application context.
The bean must implement the aggregation logic as described above.
<span class="emphasis"><em>Optional (by default the list of aggregated Messages will become a payload of the output message).</em></span></p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO4-14"><span><img src="images/callouts/14.png" alt="14" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A method defined on the bean referenced by <code class="literal">ref</code>, that implements the message aggregation algorithm.
<span class="emphasis"><em>Optional, depends on <code class="literal">ref</code> attribute being defined.</em></span></p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO4-15"><span><img src="images/callouts/15.png" alt="15" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A reference to a bean that implements the release strategy.
The bean can be an implementation of the <code class="literal">ReleaseStrategy</code> interface or a POJO.
In the latter case the release-strategy-method attribute must be defined as well.
<span class="emphasis"><em>Optional (by default, the aggregator will use the <code class="literal">IntegrationMessageHeaderAccessor.SEQUENCE_SIZE</code> header attribute)</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO4-16">(16)</a> </p></td><td valign="top" align="left">
<p>A method defined on the bean referenced by <code class="literal">release-strategy</code>, that implements the completion decision algorithm.
<span class="emphasis"><em>Optional, with restrictions (requires <code class="literal">release-strategy</code> to be present).</em></span></p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO4-17">(17)</a> </p></td><td valign="top" align="left">
<p>A SpEL expression representing the release strategy; the root object for the expression is a <code class="literal">Collection</code> of <code class="literal">Message</code> s.
Example: <code class="literal">"size() == 5"</code>.
Only one of <code class="literal">release-strategy</code> or <code class="literal">release-strategy-expression</code> is allowed.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO4-18">(18)</a> </p></td><td valign="top" align="left">
<p>When set to true (default false), completed groups are removed from the message store, allowing subsequent messages with the same correlation to form a new group.
The default behavior is to send messages with the same correlation as a completed group to the <span class="emphasis"><em>discard-channel</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO4-19">(19)</a> </p></td><td valign="top" align="left">
<p>Only applies if a <code class="literal">MessageGroupStoreReaper</code> is configured for the <code class="literal">&lt;aggregator&gt;</code>'s <code class="literal">MessageStore</code>.
By default, when a <code class="literal">MessageGroupStoreReaper</code> is configured to expire partial groups, empty groups are also removed.
Empty groups exist after a group is released normally.
This is to enable the detection and discarding of late-arriving messages.
If you wish to expire empty groups on a longer schedule than expiring partial groups, set this property.
Empty groups will then not be removed from the <code class="literal">MessageStore</code> until they have not been modified for at least this number of milliseconds.
Note that the actual time to expire an empty group will also be affected by the reaper&#8217;s <span class="emphasis"><em>timeout</em></span> property and it could be as much as this value plus the timeout.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO4-20">(20)</a> </p></td><td valign="top" align="left">
<p>A reference to a <code class="literal">org.springframework.integration.util.LockRegistry</code> bean; used to obtain a <code class="literal">Lock</code> based on the <code class="literal">groupId</code> for concurrent operations on the <code class="literal">MessageGroup</code>.
By default, an internal <code class="literal">DefaultLockRegistry</code> is used.
Use of a distributed <code class="literal">LockRegistry</code>, such as the <code class="literal">ZookeeperLockRegistry</code>, ensures only one instance of the aggregator will operate on a group concurrently.
See <a class="xref" href="#redis-lock-registry" title="24.11&nbsp;Redis Lock Registry">Section&nbsp;24.11, &#8220;Redis Lock Registry&#8221;</a>, <a class="xref" href="#gemfire-lock-registry" title="16.6&nbsp;Gemfire Lock Registry">Section&nbsp;16.6, &#8220;Gemfire Lock Registry&#8221;</a>, <a class="xref" href="#zk-lock-registry" title="37.3&nbsp;Zookeeper Lock Registry">Section&nbsp;37.3, &#8220;Zookeeper Lock Registry&#8221;</a> for more information.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO4-21">(21)</a> </p></td><td valign="top" align="left">
<p>A timeout in milliseconds to force the <code class="literal">MessageGroup</code> complete, when the <code class="literal">ReleaseStrategy</code> doesn&#8217;t <span class="emphasis"><em>release</em></span> the group when the current Message arrives.
This attribute provides a built-in <span class="emphasis"><em>Time-base Release Strategy</em></span> for the aggregator, when there is a need to emit a partial result (or discard the group), if a new Message does not arrive for the <code class="literal">MessageGroup</code> within the timeout.
When a new Message arrives at the aggregator, any existing <code class="literal">ScheduledFuture&lt;?&gt;</code> for its <code class="literal">MessageGroup</code> is canceled.
If the <code class="literal">ReleaseStrategy</code> returns <code class="literal">false</code> (don&#8217;t release) and the <code class="literal">groupTimeout &gt; 0</code> a new task will be scheduled to expire the group.
Setting this attribute to zero is not advised because it will effectively disable the aggregator because every message group will be immediately completed.
It is possible, however to conditionally set it to zero using an expression; see <code class="literal">group-timeout-expression</code> for information.
The action taken during the completion depends on the <code class="literal">ReleaseStrategy</code> and the <code class="literal">send-partial-group-on-expiry</code> attribute.
See <a class="xref" href="#agg-and-group-to" title="Aggregator and Group Timeout">the section called &#8220;Aggregator and Group Timeout&#8221;</a> for more information.
Mutually exclusive with <span class="emphasis"><em>group-timeout-expression</em></span> attribute.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO4-22">(22)</a> </p></td><td valign="top" align="left">
<p>The SpEL expression that evaluates to a <code class="literal">groupTimeout</code> with the <code class="literal">MessageGroup</code> as the <code class="literal">#root</code> evaluation context object.
Used for scheduling the <code class="literal">MessageGroup</code> to be forced complete.
If the expression evaluates to null or <code class="literal">&lt; 0</code>, the completion is not scheduled.
If it evaluates to zero, the group is completed immediately on the current thread.
In effect, this provides a dynamic <code class="literal">group-timeout</code> property.
See <code class="literal">group-timeout</code> for more information.
Mutually exclusive with <span class="emphasis"><em>group-timeout</em></span> attribute.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO4-23">(23)</a> </p></td><td valign="top" align="left">
<p>When a group is completed due to a timeout (or by a <code class="literal">MessageGroupStoreReaper</code>), the group is expired (completely removed) by default.
Late arriving messages will start a new group.
Set this to <code class="literal">false</code> to complete the group but have its metadata remain so that late arriving messages will be discarded.
Empty groups can be expired later using a <code class="literal">MessageGroupStoreReaper</code> together with the <code class="literal">empty-group-min-timeout</code> attribute.
Default: <span class="emphasis"><em>true</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO4-24">(24)</a> </p></td><td valign="top" align="left">
<p>A <code class="literal">TaskScheduler</code> bean reference to schedule the <code class="literal">MessageGroup</code> to be forced complete if no new message arrives for the <code class="literal">MessageGroup</code> within the <code class="literal">groupTimeout</code>.
If not provided, the default scheduler <code class="literal">taskScheduler</code>, registered in the <code class="literal">ApplicationContext</code> (<code class="literal">ThreadPoolTaskScheduler</code>) will be used.
This attribute does not apply if <code class="literal">group-timeout</code> or <code class="literal">group-timeout-expression</code> is not specified.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO4-25">(25)</a> </p></td><td valign="top" align="left">
<p>Since <span class="emphasis"><em>version 4.1</em></span>.
Allows a transaction to be started for the <code class="literal">forceComplete</code> operation.
It is initiated from a <code class="literal">group-timeout(-expression)</code> or by a <code class="literal">MessageGroupStoreReaper</code> and is not applied to the normal <code class="literal">add/release/discard</code> operations.
Only this sub-element or <code class="literal">&lt;expire-advice-chain/&gt;</code> is allowed.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO4-26">(26)</a> </p></td><td valign="top" align="left">
<p>Since <span class="emphasis"><em>version 4.1</em></span>.
Allows the configuration of any <code class="literal">Advice</code> for the <code class="literal">forceComplete</code> operation.
It is initiated from a <code class="literal">group-timeout(-expression)</code> or by a <code class="literal">MessageGroupStoreReaper</code> and is not applied to the normal <code class="literal">add/release/discard</code> operations.
Only this sub-element or <code class="literal">&lt;expire-transactional/&gt;</code> is allowed.
A transaction <code class="literal">Advice</code> can also be configured here using the Spring <code class="literal">tx</code> namespace.</p>
</td></tr></table></div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important: Expiring Groups"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Expiring Groups</th></tr><tr><td align="left" valign="top">

<p>There are two attributes related to expiring (completely removing) groups.
When a group is expired, there is no record of it and if a new message arrives with the same correlation, a new group is started.
When a group is completed (without expiry), the empty group remains and late arriving messages are discarded.
Empty groups can be removed later using a <code class="literal">MessageGroupStoreReaper</code> in combination with the <code class="literal">empty-group-min-timeout</code> attribute.</p>
<p><code class="literal">expire-groups-upon-completion</code> relates to "normal" completion - when the <code class="literal">ReleaseStrategy</code> releases the group.
This defaults to <code class="literal">false</code>.</p>
<p>If a group is not completed normally, but is released or discarded because of a timeout, the group is normally expired.
Since <span class="emphasis"><em>version 4.1</em></span>, you can now control this behavior using <code class="literal">expire-groups-upon-timeout</code>; this defaults to <code class="literal">true</code> for backwards compatibility.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>When a group is timed out, the <code class="literal">ReleaseStrategy</code> is given one more opportunity to release the group; if it does so, and <code class="literal">expire-groups-upon-timeout</code> is false, then expiration is controlled by <code class="literal">expire-groups-upon-completion</code>.
If the group is not released by the release strategy during timeout, then the expiration is controlled by the <code class="literal">expire-groups-upon-timeout</code>.
Timed-out groups are either discarded, or a partial release occurs (based on <code class="literal">send-partial-result-on-expiry</code>).</p>
</td></tr></table></div>
</td></tr></table></div>
<p>Using a <code class="literal">ref</code> attribute is generally recommended if a custom aggregator handler implementation may be referenced in other <code class="literal">&lt;aggregator&gt;</code> definitions.
However if a custom aggregator implementation is only being used by a single definition of the <code class="literal">&lt;aggregator&gt;</code>, you can use an inner bean definition (starting with version 1.0.3) to configure the aggregation POJO within the <code class="literal">&lt;aggregator&gt;</code> element:</p>
<pre class="programlisting"><span class="hl-tag">&lt;aggregator</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"sum"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;beans:bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.foo.PojoAggregator"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/aggregator&gt;</span></pre>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Using both a <code class="literal">ref</code> attribute and an inner bean definition in the same <code class="literal">&lt;aggregator&gt;</code> configuration is not allowed, as it creates an ambiguous condition.
In such cases, an Exception will be thrown.</p>
</td></tr></table></div>
<p>An example implementation of the aggregator bean looks as follows:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> PojoAggregator {

  <span class="hl-keyword">public</span> Long add(List&lt;Long&gt; results) {
    <span class="hl-keyword">long</span> total = <span class="hl-number">0l</span>;
    <span class="hl-keyword">for</span> (<span class="hl-keyword">long</span> partialResult: results) {
      total += partialResult;
    }
    <span class="hl-keyword">return</span> total;
  }
}</pre>
<p>An implementation of the completion strategy bean for the example above may be as follows:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> PojoReleaseStrategy {
...
  <span class="hl-keyword">public</span> <span class="hl-keyword">boolean</span> canRelease(List&lt;Long&gt; numbers) {
    <span class="hl-keyword">int</span> sum = <span class="hl-number">0</span>;
    <span class="hl-keyword">for</span> (<span class="hl-keyword">long</span> number: numbers) {
      sum += number;
    }
    <span class="hl-keyword">return</span> sum &gt;= maxValue;
  }
}</pre>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Wherever it makes sense, the release strategy method and the aggregator method can be combined in a single bean.</p>
</td></tr></table></div>
<p>An implementation of the correlation strategy bean for the example above may be as follows:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> PojoCorrelationStrategy {
...
  <span class="hl-keyword">public</span> Long groupNumbersByLastDigit(Long number) {
    <span class="hl-keyword">return</span> number % <span class="hl-number">10</span>;
  }
}</pre>
<p>For example, this aggregator would group numbers by some criterion (in our case the remainder after dividing by 10) and will hold the group until the sum of the numbers provided by the payloads exceeds a certain value.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Wherever it makes sense, the release strategy method, correlation strategy method and the aggregator method can be combined in a single bean (all of them or any two).</p>
</td></tr></table></div>
<p><span class="emphasis"><em>Aggregators and Spring Expression Language (SpEL)</em></span></p>
<p>Since Spring Integration 2.0, the various strategies (correlation, release, and aggregation) may be handled with <a class="ulink" href="http://docs.spring.io/spring/docs/current/spring-framework-reference/html/expressions.html" target="_top">SpEL</a> which is recommended if the logic behind such <span class="emphasis"><em>release strategy</em></span> is relatively simple.
Let&#8217;s say you have a legacy component that was designed to receive an array of objects.
We know that the default release strategy will assemble all aggregated messages in the List.
So now we have two problems.
First we need to extract individual messages from the list, and then we need to extract the payload of each message and assemble the array of objects (see code below).</p>
<pre class="programlisting"><span class="hl-keyword">public</span> String[] processRelease(List&lt;Message&lt;String&gt;&gt; messages){
    List&lt;String&gt; stringList = <span class="hl-keyword">new</span> ArrayList&lt;String&gt;();
    <span class="hl-keyword">for</span> (Message&lt;String&gt; message : messages) {
        stringList.add(message.getPayload());
    }
    <span class="hl-keyword">return</span> stringList.toArray(<span class="hl-keyword">new</span> String[]{});
}</pre>
<p>However, with SpEL such a requirement could actually be handled relatively easily with a one-line expression, thus sparing you from writing a custom class and configuring it as a bean.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:aggregator</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"aggChannel"</span>
    <span class="hl-attribute">output-channel</span>=<span class="hl-value">"replyChannel"</span>
    <span class="hl-attribute">expression</span>=<span class="hl-value">"#this.![payload].toArray()"</span><span class="hl-tag">/&gt;</span></pre>
<p>In the above configuration we are using a <a class="ulink" href="http://docs.spring.io/spring/docs/current/spring-framework-reference/html/expressions.html#expressions-collection-projection" target="_top">Collection Projection</a> expression to assemble a new collection from the payloads of all messages in the list and then transforming it to an Array, thus achieving the same result as the java code above.</p>
<p>The same expression-based approach can be applied when dealing with custom <span class="emphasis"><em>Release</em></span> and <span class="emphasis"><em>Correlation</em></span> strategies.</p>
<p>Instead of defining a bean for a custom <code class="literal">CorrelationStrategy</code> via the <code class="literal">correlation-strategy</code> attribute, you can implement your simple correlation logic via a SpEL expression and configure it via the <code class="literal">correlation-strategy-expression</code> attribute.</p>
<p>For example:</p>
<pre class="programlisting">correlation-strategy-expression="payload.person.id"</pre>
<p>In the above example it is assumed that the payload has an attribute <code class="literal">person</code> with an <code class="literal">id</code> which is going to be used to correlate messages.</p>
<p>Likewise, for the <code class="literal">ReleaseStrategy</code> you can implement your release logic as a SpEL expression and configure it via the <code class="literal">release-strategy-expression</code> attribute.
The only difference is that since ReleaseStrategy is passed the List of Messages, the root object in the SpEL evaluation context is the List itself.
That List can be referenced as <code class="literal">#this</code> within the expression.</p>
<p>For example:</p>
<pre class="programlisting">release-strategy-expression="#this.size() gt 5"</pre>
<p>In this example the root object of the SpEL Evaluation Context is the <code class="literal">MessageGroup</code> itself, and you are simply stating that as soon as there are more than 5 messages in this group, it should be released.</p>
<div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="agg-and-group-to" href="#agg-and-group-to"></a>Aggregator and Group Timeout</h5></div></div></div>

<p>Starting with <span class="emphasis"><em>version 4.0</em></span>, two new mutually exclusive attributes have been introduced: <code class="literal">group-timeout</code> and <code class="literal">group-timeout-expression</code> (see the description above).
There are some cases where it is needed to emit the aggregator result (or discard the group) after a timeout if the <code class="literal">ReleaseStrategy</code> doesn&#8217;t <span class="emphasis"><em>release</em></span> when the current Message arrives.
For this purpose the <code class="literal">groupTimeout</code> option allows scheduling the <code class="literal">MessageGroup</code> to be forced complete:</p>
<pre class="programlisting"><span class="hl-tag">&lt;aggregator</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span>
        <span class="hl-attribute">send-partial-result-on-expiry</span>=<span class="hl-value">"true"</span>
        <span class="hl-attribute">group-timeout-expression</span>=<span class="hl-value">"size() ge 2 ? 10000 : -1"</span>
        <span class="hl-attribute">release-strategy-expression</span>=<span class="hl-value">"[0].headers.sequenceNumber == [0].headers.sequenceSize"</span><span class="hl-tag">/&gt;</span></pre>
<p>With this example, the normal <span class="emphasis"><em>release</em></span> will be possible if the aggregator receives the last message in sequence as defined by the <code class="literal">release-strategy-expression</code>.
If that specific message does not arrive, the <code class="literal">groupTimeout</code> will force the group complete after 10 seconds as long as the group contains at least 2 Messages.</p>
<p>The results of forcing the group complete depends on the <code class="literal">ReleaseStrategy</code> and the <code class="literal">send-partial-result-on-expiry</code>.
First, the release strategy is again consulted to see if a <span class="emphasis"><em>normal</em></span> release is to be made - while the group won&#8217;t have changed, the <code class="literal">ReleaseStrategy</code> can decide to release the group at this time.
If the release strategy still does not release the group, it will be expired.
If <code class="literal">send-partial-result-on-expiry</code> is <code class="literal">true</code>, existing messages in the (partial) <code class="literal">MessageGroup</code> will be released as a normal aggregator reply Message to the <code class="literal">output-channel</code>, otherwise it will be discarded.</p>
<p>There is a difference between <code class="literal">groupTimeout</code> behavior and <code class="literal">MessageGroupStoreReaper</code> (see <a class="xref" href="#aggregator-config" title="6.4.4&nbsp;Configuring an Aggregator">Section&nbsp;6.4.4, &#8220;Configuring an Aggregator&#8221;</a>).
The reaper initiates forced completion for all <code class="literal">MessageGroup</code> s in the <code class="literal">MessageGroupStore</code> periodically.
The <code class="literal">groupTimeout</code> does it for each <code class="literal">MessageGroup</code> individually, if a new Message doesn&#8217;t arrive during the <code class="literal">groupTimeout</code>.
Also, the reaper can be used to remove empty groups (empty groups are retained in order to discard late messages, if <code class="literal">expire-groups-upon-completion</code> is false).</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="aggregator-annotations" href="#aggregator-annotations"></a>Configuring an Aggregator with Annotations</h4></div></div></div>

<p>An aggregator configured using annotations would look like this.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> Waiter {
  ...

  <em><span class="hl-annotation" style="color: gray">@Aggregator</span></em>  <a name="CO5-1" href="#CO5-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
  <span class="hl-keyword">public</span> Delivery aggregatingMethod(List&lt;OrderItem&gt; items) {
    ...
  }

  <em><span class="hl-annotation" style="color: gray">@ReleaseStrategy</span></em>  <a name="CO5-2" href="#CO5-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
  <span class="hl-keyword">public</span> <span class="hl-keyword">boolean</span> releaseChecker(List&lt;Message&lt;?&gt;&gt; messages) {
    ...
  }

  <em><span class="hl-annotation" style="color: gray">@CorrelationStrategy</span></em>  <a name="CO5-3" href="#CO5-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
  <span class="hl-keyword">public</span> String correlateBy(OrderItem item) {
    ...
  }
}</pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO5-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>An annotation indicating that this method shall be used as an aggregator.
Must be specified if this class will be used as an aggregator.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO5-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>An annotation indicating that this method shall be used as the release strategy of an aggregator.
If not present on any method, the aggregator will use the SequenceSizeReleaseStrategy.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO5-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>An annotation indicating that this method shall be used as the correlation strategy of an aggregator.
If no correlation strategy is indicated, the aggregator will use the <code class="literal">HeaderAttributeCorrelationStrategy</code> based on <code class="literal">CORRELATION_ID</code>.</p>
</td></tr></table></div>
<p>All of the configuration options provided by the xml element are also available for the <code class="literal">@Aggregator</code> annotation.</p>
<p>The aggregator can be either referenced explicitly from XML or, if the <code class="literal">@MessageEndpoint</code> is defined on the class, detected automatically through classpath scanning.</p>
<p>Annotation configuration (<code class="literal">@Aggregator</code> and others) for the Aggregator component covers only simple use cases,
where most default options are sufficient.
If you need more control over those options using Annotation configuration, consider using
a <code class="literal">@Bean</code> definition for the <code class="literal">AggregatingMessageHandler</code> and mark its
<code class="literal">@Bean</code> method with <code class="literal">@ServiceActivator</code>:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "aggregatorChannel")</span></em>
<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> MessageHandler aggregator(MessageGroupStore jdbcMessageGroupStore) {
     AggregatingMessageHandler aggregator =
                       <span class="hl-keyword">new</span> AggregatingMessageHandler(<span class="hl-keyword">new</span> DefaultAggregatingMessageGroupProcessor(),
                                                 jdbcMessageGroupStore);
     aggregator.setOutputChannel(resultsChannel());
     aggregator.setGroupTimeoutExpression(<span class="hl-keyword">new</span> ValueExpression&lt;&gt;(<span class="hl-number">500L</span>));
     aggregator.setTaskScheduler(<span class="hl-keyword">this</span>.taskScheduler);
     <span class="hl-keyword">return</span> aggregator;
}</pre>
<p>See <a class="xref" href="#aggregator-api" title="6.4.3&nbsp;Programming model">Section&nbsp;6.4.3, &#8220;Programming model&#8221;</a> and <a class="xref" href="#annotations_on_beans" title="F.6.2&nbsp;Annotations on @Beans">Section&nbsp;F.6.2, &#8220;Annotations on @Beans&#8221;</a> for more information.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Starting with the <span class="emphasis"><em>version 4.2</em></span> the <code class="literal">AggregatorFactoryBean</code> is available, to simplify Java configuration
for the <code class="literal">AggregatingMessageHandler</code>.</p>
</td></tr></table></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="reaper" href="#reaper"></a>6.4.5&nbsp;Managing State in an Aggregator: MessageGroupStore</h3></div></div></div>

<p>Aggregator (and some other patterns in Spring Integration) is a stateful pattern that requires decisions to be made based on a group of messages that have arrived over a period of time, all with the same correlation key.
The design of the interfaces in the stateful patterns (e.g.
<code class="literal">ReleaseStrategy</code>) is driven by the principle that the components (whether defined by the framework or a user) should be able to remain stateless.
All state is carried by the <code class="literal">MessageGroup</code> and its management is delegated to the <code class="literal">MessageGroupStore</code>.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> MessageGroupStore {
    <span class="hl-keyword">int</span> getMessageCountForAllMessageGroups();

    <span class="hl-keyword">int</span> getMarkedMessageCountForAllMessageGroups();

    <span class="hl-keyword">int</span> getMessageGroupCount();

    MessageGroup getMessageGroup(Object groupId);

    MessageGroup addMessageToGroup(Object groupId, Message&lt;?&gt; message);

    MessageGroup markMessageGroup(MessageGroup group);

    MessageGroup removeMessageFromGroup(Object key, Message&lt;?&gt; messageToRemove);

    MessageGroup markMessageFromGroup(Object key, Message&lt;?&gt; messageToMark);

    <span class="hl-keyword">void</span> removeMessageGroup(Object groupId);

    <span class="hl-keyword">void</span> registerMessageGroupExpiryCallback(MessageGroupCallback callback);

    <span class="hl-keyword">int</span> expireMessageGroups(<span class="hl-keyword">long</span> timeout);
}</pre>
<p>For more information please refer to the <a class="ulink" href="http://docs.spring.io/spring-integration/api/org/springframework/integration/store/MessageGroupStore.html" target="_top">JavaDoc</a>.</p>
<p>The <code class="literal">MessageGroupStore</code> accumulates state information in <code class="literal">MessageGroups</code> while waiting for a release strategy to be triggered, and that event might not ever happen.
So to prevent stale messages from lingering, and for volatile stores to provide a hook for cleaning up when the application shuts down, the <code class="literal">MessageGroupStore</code> allows the user to register callbacks to apply to its <code class="literal">MessageGroups</code> when they expire.
The interface is very straightforward:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> MessageGroupCallback {

    <span class="hl-keyword">void</span> execute(MessageGroupStore messageGroupStore, MessageGroup group);

}</pre>
<p>The callback has direct access to the store and the message group so it can manage the persistent state (e.g.
by removing the group from the store entirely).</p>
<p>The <code class="literal">MessageGroupStore</code> maintains a list of these callbacks which it applies, on demand, to all messages whose timestamp is earlier than a time supplied as a parameter (see the <code class="literal">registerMessageGroupExpiryCallback(..)</code> and <code class="literal">expireMessageGroups(..)</code> methods above).</p>
<p>The <code class="literal">expireMessageGroups</code> method can be called with a timeout value.
Any message older than the current time minus this value will be expired, and have the callbacks applied.
Thus it is the user of the store that defines what is meant by message group "expiry".</p>
<p>As a convenience for users, Spring Integration provides a wrapper for the message expiry in the form of a <code class="literal">MessageGroupStoreReaper</code>:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"reaper"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org...MessageGroupStoreReaper"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"messageGroupStore"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"messageStore"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"timeout"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"30000"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;task:scheduled-tasks</span> <span class="hl-attribute">scheduler</span>=<span class="hl-value">"scheduler"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;task:scheduled</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"reaper"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"run"</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"10000"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/task:scheduled-tasks&gt;</span></pre>
<p>The reaper is a <code class="literal">Runnable</code>, and all that is happening in the example above is that the message group store&#8217;s expire method is being called once every 10 seconds.
The timeout itself is 30 seconds.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>It is important to understand that the <span class="emphasis"><em>timeout</em></span> property of the <code class="literal">MessageGroupStoreReaper</code> is an approximate value and is impacted by the the rate of the task scheduler since this property will only be checked on the next scheduled execution of the <code class="literal">MessageGroupStoreReaper</code> task.
For example if the timeout is set for 10 min, but the <code class="literal">MessageGroupStoreReaper</code> task is scheduled to run every 60 min and the last execution of the <code class="literal">MessageGroupStoreReaper</code> task happened 1 min before the timeout, the <code class="literal">MessageGroup</code> will not expire for the next 59 min.
So it is recommended to set the rate at least equal to the value of the timeout or shorter.</p>
</td></tr></table></div>
<p>In addition to the reaper, the expiry callbacks are invoked when the application shuts down via a lifecycle callback in the <code class="literal">AbstractCorrelatingMessageHandler</code>.</p>
<p>The <code class="literal">AbstractCorrelatingMessageHandler</code> registers its own expiry callback, and this is the link with the boolean flag <code class="literal">send-partial-result-on-expiry</code> in the XML configuration of the aggregator.
If the flag is set to true, then when the expiry callback is invoked, any unmarked messages in groups that are not yet released can be sent on to the output channel.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>When using a <code class="literal">MessageGroupStoreReaper</code>, it is generally recommended to use a separate <code class="literal">MessageStore</code> for each correlating endpoint.
Otherwise, unexpected results may occur because one endpoint may remove another endpoint&#8217;s groups.</p>
<p>Some <code class="literal">MessageStore</code> implementations allow using the same physical resources, by partitioning the data; for example, the <code class="literal">JdbcMessageStore</code> has a <code class="literal">region</code> property; the <code class="literal">MongoDbMessageStore</code> has a <code class="literal">collectionName</code> property.</p>
<p>For more information about <code class="literal">MessageStore</code> interface and its implementations, please read <a class="xref" href="#message-store" title="9.4&nbsp;Message Store">Section&nbsp;9.4, &#8220;Message Store&#8221;</a>.</p>
</td></tr></table></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="resequencer" href="#resequencer"></a>6.5&nbsp;Resequencer</h2></div></div></div>

<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_introduction" href="#_introduction"></a>6.5.1&nbsp;Introduction</h3></div></div></div>

<p>Related to the Aggregator, albeit different from a functional standpoint, is the Resequencer.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="resequencer-functionality" href="#resequencer-functionality"></a>6.5.2&nbsp;Functionality</h3></div></div></div>

<p>The Resequencer works in a similar way to the Aggregator, in the sense that it uses the <code class="literal">CORRELATION_ID</code> to store messages in groups, the difference being that the Resequencer does not process the messages in any way.
It simply releases them in the order of their <code class="literal">SEQUENCE_NUMBER</code> header values.</p>
<p>With respect to that, the user might opt to release all messages at once (after the whole sequence, according to the <code class="literal">SEQUENCE_SIZE</code>, has been released), or as soon as a valid sequence is available.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_a_resequencer" href="#_configuring_a_resequencer"></a>6.5.3&nbsp;Configuring a Resequencer</h3></div></div></div>

<p>Configuring a resequencer requires only including the appropriate element in XML.</p>
<p>A sample resequencer configuration is shown below.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"inputChannel"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"outputChannel"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int:resequencer</span> <span class="hl-attribute">id</span>=<span class="hl-value">"completelyDefinedResequencer"</span>  <a name="CO6-1" href="#CO6-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
  input-channel="inputChannel"  <a name="CO6-2" href="#CO6-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
  output-channel="outputChannel"  <a name="CO6-3" href="#CO6-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
  discard-channel="discardChannel"  <a name="CO6-4" href="#CO6-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
  release-partial-sequences="true"  <a name="CO6-5" href="#CO6-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
  message-store="messageStore"  <a name="CO6-6" href="#CO6-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>
  send-partial-result-on-expiry="true"  <a name="CO6-7" href="#CO6-7"></a><span><img src="images/callouts/7.png" alt="7" border="0"></span>
  send-timeout="86420000"  <a name="CO6-8" href="#CO6-8"></a><span><img src="images/callouts/8.png" alt="8" border="0"></span>
  correlation-strategy="correlationStrategyBean"  <a name="CO6-9" href="#CO6-9"></a><span><img src="images/callouts/9.png" alt="9" border="0"></span>
  correlation-strategy-method="correlate"  <a name="CO6-10" href="#CO6-10"></a><span><img src="images/callouts/10.png" alt="10" border="0"></span>
  correlation-strategy-expression="headers['foo']"  <a name="CO6-11" href="#CO6-11"></a><span><img src="images/callouts/11.png" alt="11" border="0"></span>
  release-strategy="releaseStrategyBean"  <a name="CO6-12" href="#CO6-12"></a><span><img src="images/callouts/12.png" alt="12" border="0"></span>
  release-strategy-method="release"  <a name="CO6-13" href="#CO6-13"></a><span><img src="images/callouts/13.png" alt="13" border="0"></span>
  release-strategy-expression="size() == 10"  <a name="CO6-14" href="#CO6-14"></a><span><img src="images/callouts/14.png" alt="14" border="0"></span>
  empty-group-min-timeout="60000"  <a name="CO6-15" href="#CO6-15"></a><span><img src="images/callouts/15.png" alt="15" border="0"></span>

  lock-registry="lockRegistry"  <a name="CO6-16" href="#CO6-16"></a>(16)

  group-timeout="60000"  <a name="CO6-17" href="#CO6-17"></a>(17)
  group-timeout-expression="size() ge 2 ? 100 : -1"  <a name="CO6-18" href="#CO6-18"></a>(18)
  scheduler="taskScheduler" /&gt;  <a name="CO6-19" href="#CO6-19"></a>(19)
  expire-group-upon-timeout="false" /&gt;  <a name="CO6-20" href="#CO6-20"></a>(20)</pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO6-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The id of the resequencer is <span class="emphasis"><em>optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO6-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The input channel of the resequencer.
<span class="emphasis"><em>Required</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO6-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The channel to which the resequencer will send the reordered messages.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO6-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The channel to which the resequencer will send the messages that timed out (if <code class="literal">send-partial-result-on-timeout</code> is <span class="emphasis"><em>false)</em></span>.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO6-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Whether to send out ordered sequences as soon as they are available, or only after the whole message group arrives.
<span class="emphasis"><em>Optional (false by default)</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO6-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A reference to a <code class="literal">MessageGroupStore</code> that can be used to store groups of messages under their correlation key until they are complete.
<span class="emphasis"><em>Optional</em></span> with default a volatile in-memory store.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO6-7"><span><img src="images/callouts/7.png" alt="7" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Whether, upon the expiration of the group, the ordered group should be sent out (even if some of the messages are missing).
<span class="emphasis"><em>Optional (false by default)</em></span>.
See <a class="xref" href="#reaper" title="6.4.5&nbsp;Managing State in an Aggregator: MessageGroupStore">Section&nbsp;6.4.5, &#8220;Managing State in an Aggregator: MessageGroupStore&#8221;</a>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO6-8"><span><img src="images/callouts/8.png" alt="8" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The timeout interval to wait when sending a reply <code class="literal">Message</code> to the <code class="literal">output-channel</code> or <code class="literal">discard-channel</code>.
Defaults to <code class="literal">-1</code> - blocking indefinitely.
It is applied only if the output channel has some <span class="emphasis"><em>sending</em></span> limitations, e.g.
<code class="literal">QueueChannel</code> with a fixed <span class="emphasis"><em>capacity</em></span>.
In this case a <code class="literal">MessageDeliveryException</code> is thrown.
The <code class="literal">send-timeout</code> is ignored in case of <code class="literal">AbstractSubscribableChannel</code> implementations.
In case of <code class="literal">group-timeout(-expression)</code> the <code class="literal">MessageDeliveryException</code> from the scheduled expire task leads this task to be rescheduled.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO6-9"><span><img src="images/callouts/9.png" alt="9" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A reference to a bean that implements the message correlation (grouping) algorithm.
The bean can be an implementation of the <code class="literal">CorrelationStrategy</code> interface or a POJO.
In the latter case the correlation-strategy-method attribute must be defined as well.
<span class="emphasis"><em>Optional (by default, the aggregator will use the <code class="literal">IntegrationMessageHeaderAccessor.CORRELATION_ID</code> header)</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO6-10"><span><img src="images/callouts/10.png" alt="10" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A method defined on the bean referenced by <code class="literal">correlation-strategy</code>, that implements the correlation decision algorithm.
<span class="emphasis"><em>Optional, with restrictions (requires <code class="literal">correlation-strategy</code> to be present).</em></span></p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO6-11"><span><img src="images/callouts/11.png" alt="11" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A SpEL expression representing the correlation strategy.
Example: <code class="literal">"headers['foo']"</code>.
Only one of <code class="literal">correlation-strategy</code> or <code class="literal">correlation-strategy-expression</code> is allowed.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO6-12"><span><img src="images/callouts/12.png" alt="12" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A reference to a bean that implements the release strategy.
The bean can be an implementation of the <code class="literal">ReleaseStrategy</code> interface or a POJO.
In the latter case the release-strategy-method attribute must be defined as well.
<span class="emphasis"><em>Optional (by default, the aggregator will use the <code class="literal">IntegrationMessageHeaderAccessor.SEQUENCE_SIZE</code> header attribute)</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO6-13"><span><img src="images/callouts/13.png" alt="13" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A method defined on the bean referenced by <code class="literal">release-strategy</code>, that implements the completion decision algorithm.
<span class="emphasis"><em>Optional, with restrictions (requires <code class="literal">release-strategy</code> to be present).</em></span></p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO6-14"><span><img src="images/callouts/14.png" alt="14" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A SpEL expression representing the release strategy; the root object for the expression is a <code class="literal">Collection</code> of <code class="literal">Message</code> s.
Example: <code class="literal">"size() == 5"</code>.
Only one of <code class="literal">release-strategy</code> or <code class="literal">release-strategy-expression</code> is allowed.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO6-15"><span><img src="images/callouts/15.png" alt="15" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Only applies if a <code class="literal">MessageGroupStoreReaper</code> is configured for the <code class="literal">&lt;resequcencer&gt;</code> <code class="literal">MessageStore</code>.
By default, when a <code class="literal">MessageGroupStoreReaper</code> is configured to expire partial groups, empty groups are also removed.
Empty groups exist after a group is released normally.
This is to enable the detection and discarding of late-arriving messages.
If you wish to expire empty groups on a longer schedule than expiring partial groups, set this property.
Empty groups will then not be removed from the <code class="literal">MessageStore</code> until they have not been modified for at least this number of milliseconds.
Note that the actual time to expire an empty group will also be affected by the reaper&#8217;s <span class="emphasis"><em>timeout</em></span> property and it could be as much as this value plus the timeout.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO6-16">(16)</a> </p></td><td valign="top" align="left">
<p>See <a class="xref" href="#aggregator-xml" title="Configuring an Aggregator with XML">the section called &#8220;Configuring an Aggregator with XML&#8221;</a>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO6-17">(17)</a> </p></td><td valign="top" align="left">
<p>See <a class="xref" href="#aggregator-xml" title="Configuring an Aggregator with XML">the section called &#8220;Configuring an Aggregator with XML&#8221;</a>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO6-18">(18)</a> </p></td><td valign="top" align="left">
<p>See <a class="xref" href="#aggregator-xml" title="Configuring an Aggregator with XML">the section called &#8220;Configuring an Aggregator with XML&#8221;</a>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO6-19">(19)</a> </p></td><td valign="top" align="left">
<p>See <a class="xref" href="#aggregator-xml" title="Configuring an Aggregator with XML">the section called &#8220;Configuring an Aggregator with XML&#8221;</a>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO6-20">(20)</a> </p></td><td valign="top" align="left">
<p>When a group is completed due to a timeout (or by a <code class="literal">MessageGroupStoreReaper</code>), the empty group&#8217;s metadata is retained by default.
Late arriving messages will be immediately discarded.
Set this to <code class="literal">true</code> to remove the group completely; then, late arriving messages will start a new group and won&#8217;t be discarded until the group again times out.
The new group will never be released normally because of the "hole" in the sequence range that caused the timeout.
Empty groups can be expired (completely removed) later using a <code class="literal">MessageGroupStoreReaper</code> together with the <code class="literal">empty-group-min-timeout</code> attribute.
Default: <span class="emphasis"><em>false</em></span>.</p>
</td></tr></table></div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Since there is no custom behavior to be implemented in Java classes for resequencers, there is no annotation support for it.</p>
</td></tr></table></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="chain" href="#chain"></a>6.6&nbsp;Message Handler Chain</h2></div></div></div>

<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="chain-introduction" href="#chain-introduction"></a>6.6.1&nbsp;Introduction</h3></div></div></div>

<p>The <code class="literal">MessageHandlerChain</code> is an implementation of <code class="literal">MessageHandler</code> that can be configured as a single Message Endpoint while actually delegating to a chain of other handlers, such as Filters, Transformers, Splitters, and so on.
This can lead to a much simpler configuration when several handlers need to be connected in a fixed, linear progression.
For example, it is fairly common to provide a Transformer before other components.
Similarly, when providing a <span class="emphasis"><em>Filter</em></span> before some other component in a chain, you are essentially creating a <a class="ulink" href="http://www.eaipatterns.com/MessageSelector.html" target="_top">Selective Consumer</a>.
In either case, the chain only requires a single <code class="literal">input-channel</code> and a single <code class="literal">output-channel</code> eliminating the need to define channels for each individual component.</p>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>Spring Integration&#8217;s <code class="literal">Filter</code> provides a boolean property <code class="literal">throwExceptionOnRejection</code>.
When providing multiple Selective Consumers on the same point-to-point channel with different acceptance criteria, this value should be set to <span class="emphasis"><em>true</em></span> (the default is false) so that the dispatcher will know that the Message was rejected and as a result will attempt to pass the Message on to other subscribers.
If the Exception were not thrown, then it would appear to the dispatcher as if the Message had been passed on successfully even though the Filter had <span class="emphasis"><em>dropped</em></span> the Message to prevent further processing.
If you do indeed want to "drop" the Messages, then the Filter&#8217;s <span class="emphasis"><em>discard-channel</em></span> might be useful since it does give you a chance to perform some operation with the dropped message (e.g.
send to a JMS queue or simply write to a log).</p>
</td></tr></table></div>
<p>The handler chain simplifies configuration while internally maintaining the same degree of loose coupling between components, and it is trivial to modify the configuration if at some point a non-linear arrangement is required.</p>
<p>Internally, the chain will be expanded into a linear setup of the listed endpoints, separated by anonymous channels.
The reply channel header will not be taken into account within the chain: only after the last handler is invoked will the resulting message be forwarded on to the reply channel or the chain&#8217;s output channel.
Because of this setup all handlers except the last required to implement the MessageProducer interface (which provides a <span class="emphasis"><em>setOutputChannel()</em></span> method).
The last handler only needs an output channel if the outputChannel on the MessageHandlerChain is set.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>As with other endpoints, the <code class="literal">output-channel</code> is optional.
If there is a reply Message at the end of the chain, the output-channel takes precedence, but if not available, the chain handler will check for a reply channel header on the inbound Message as a fallback.</p>
</td></tr></table></div>
<p>In most cases there is no need to implement MessageHandlers yourself.
The next section will focus on namespace support for the chain element.
Most Spring Integration endpoints, like Service Activators and Transformers, are suitable for use within a <code class="literal">MessageHandlerChain</code>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="chain-namespace" href="#chain-namespace"></a>6.6.2&nbsp;Configuring a Chain</h3></div></div></div>

<p>The &lt;chain&gt; element provides an <code class="literal">input-channel</code> attribute, and if the last element in the chain is capable of producing reply messages (optional), it also supports an <code class="literal">output-channel</code> attribute.
The sub-elements are then filters, transformers, splitters, and service-activators.
The last element may also be a router or an outbound-channel-adapter.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:chain</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:filter</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"someSelector"</span> <span class="hl-attribute">throw-exception-on-rejection</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int:header-enricher&gt;</span>
        <span class="hl-tag">&lt;int:header</span> <span class="hl-attribute">name</span>=<span class="hl-value">"foo"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"bar"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/int:header-enricher&gt;</span>
    <span class="hl-tag">&lt;int:service-activator</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"someService"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"someMethod"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:chain&gt;</span></pre>
<p>The &lt;header-enricher&gt; element used in the above example will set a message header named "foo" with a value of "bar" on the message.
A header enricher is a specialization of <code class="literal">Transformer</code> that touches only header values.
You could obtain the same result by implementing a MessageHandler that did the header modifications and wiring that as a bean, but the header-enricher is obviously a simpler option.</p>
<p>The &lt;chain&gt; can be configured as the last <span class="emphasis"><em>black-box</em></span> consumer of the message flow.
For this solution it is enough to put at the end of the &lt;chain&gt; some &lt;outbound-channel-adapter&gt;:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:chain</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int-xml:marshalling-transformer</span> <span class="hl-attribute">marshaller</span>=<span class="hl-value">"marshaller"</span> <span class="hl-attribute">result-type</span>=<span class="hl-value">"StringResult"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;int:service-activator</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"someService"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"someMethod"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int:header-enricher&gt;</span>
        <span class="hl-tag">&lt;int:header</span> <span class="hl-attribute">name</span>=<span class="hl-value">"foo"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"bar"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/int:header-enricher&gt;</span>
    <span class="hl-tag">&lt;int:logging-channel-adapter</span> <span class="hl-attribute">level</span>=<span class="hl-value">"INFO"</span> <span class="hl-attribute">log-full-message</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:chain&gt;</span></pre>
<p><span class="emphasis"><em>Disallowed Attributes and Elements</em></span></p>
<p>It is important to note that certain attributes, such as <span class="strong"><strong>order</strong></span> and <span class="strong"><strong>input-channel</strong></span> are not allowed to be specified on components used within a <span class="emphasis"><em>chain</em></span>.
The same is true for the <span class="strong"><strong>poller</strong></span> sub-element.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>For the <span class="emphasis"><em>Spring Integration</em></span> core components, the XML Schema itself will enforce some of these constraints.
However, for non-core components or your own custom components, these constraints are enforced by the XML namespace parser, not by the XML Schema.</p>
<p>These XML namespace parser constraints were added with <span class="emphasis"><em>Spring Integration 2.2</em></span>.
The XML namespace parser will throw an <code class="literal">BeanDefinitionParsingException</code> if you try to use disallowed attributes and elements.</p>
</td></tr></table></div>
<p><span class="emphasis"><em>'id' Attribute</em></span></p>
<p>Beginning with Spring Integration 3.0, if a chain element is given an <span class="emphasis"><em>id</em></span>, the bean name for the element is a combination of the chain&#8217;s <span class="emphasis"><em>id</em></span> and the <span class="emphasis"><em>id</em></span> of the element itself.
Elements without an <span class="emphasis"><em>id</em></span> are not registered as beans, but they are given <code class="literal">componentName</code> s that include the chain id.
For example:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:chain</span> <span class="hl-attribute">id</span>=<span class="hl-value">"fooChain"</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:service-activator</span> <span class="hl-attribute">id</span>=<span class="hl-value">"fooService"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"someService"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"someMethod"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int:object-to-json-transformer/&gt;</span>
<span class="hl-tag">&lt;/int:chain&gt;</span></pre>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
The <code class="literal">&lt;chain&gt;</code> root element has an <span class="emphasis"><em>id</em></span> <span class="emphasis"><em>fooChain</em></span>.
So, the <code class="literal">AbstractEndpoint</code> implementation (<code class="literal">PollingConsumer</code> or <code class="literal">EventDrivenConsumer</code>, depending on the <span class="emphasis"><em>input-channel</em></span> type) bean takes this value as it&#8217;s bean name.
</li><li class="listitem">
The <code class="literal">MessageHandlerChain</code> bean acquires a bean alias <span class="emphasis"><em>fooChain.handler</em></span>, which allows direct access to this bean from the <code class="literal">BeanFactory</code>.
</li><li class="listitem">
The <code class="literal">&lt;service-activator&gt;</code> is not a fully-fledged Messaging Endpoint (<code class="literal">PollingConsumer</code> or <code class="literal">EventDrivenConsumer</code>) - it is simply a <code class="literal">MessageHandler</code> within the <code class="literal">&lt;chain&gt;</code>.
In this case, the bean name registered with the <code class="literal">BeanFactory</code> is <span class="emphasis"><em>fooChain$child.fooService.handler</em></span>.
</li><li class="listitem">
The <span class="emphasis"><em>componentName</em></span> of this <code class="literal">ServiceActivatingHandler</code> takes the same value, but without the <span class="emphasis"><em>.handler</em></span> suffix - <span class="emphasis"><em>fooChain$child.fooService</em></span>.
</li><li class="listitem">
The last <code class="literal">&lt;chain&gt;</code> sub-component, <code class="literal">&lt;object-to-json-transformer&gt;</code>, doesn&#8217;t have an <span class="emphasis"><em>id</em></span> attribute.
Its <span class="emphasis"><em>componentName</em></span> is based on its position in the <code class="literal">&lt;chain&gt;</code>.
In this case, it is <span class="emphasis"><em>fooChain$child#1</em></span>.
(The final element of the name is the order within the chain, beginning with <span class="emphasis"><em>#0</em></span>).
Note, this transformer isn&#8217;t registered as a bean within the application context, so, it doesn&#8217;t get a <span class="emphasis"><em>beanName</em></span>, however its <span class="emphasis"><em>componentName</em></span> has a value which is useful for logging etc.
</li></ul></div>
<p>The <span class="emphasis"><em>id</em></span> attribute for <code class="literal">&lt;chain&gt;</code> elements allows them to be eligible for <a class="link" href="#jmx-mbean-exporter" title="9.2.7&nbsp;MBean Exporter">JMX export</a> and they are trackable via <a class="link" href="#message-history" title="9.3&nbsp;Message History">Message History</a>.
They can also be accessed from the <code class="literal">BeanFactory</code> using the appropriate bean name as discussed above.</p>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>It is useful to provide an explicit <span class="emphasis"><em>id</em></span> attribute on <code class="literal">&lt;chain&gt;</code> s to simplify the identification of sub-components in logs, and to provide access to them from the <code class="literal">BeanFactory</code> etc.</p>
</td></tr></table></div>
<p><span class="emphasis"><em>Calling a Chain from within a Chain</em></span></p>
<p>Sometimes you need to make a nested call to another chain from within a chain and then come back and continue execution within the original chain.
To accomplish this you can utilize a Messaging Gateway by including a &lt;gateway&gt; element.
For example:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:chain&nbsp;id="main-chain"&nbsp;input-channel="in"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"out"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:header-enricher&gt;</span>
      <span class="hl-tag">&lt;int:header</span> <span class="hl-attribute">name</span>=<span class="hl-value">"name"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"Many"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;/int:header-enricher&gt;</span>
    <span class="hl-tag">&lt;int:service-activator&gt;</span>
      <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.foo.SampleService"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;/int:service-activator&gt;</span>
    <span class="hl-tag">&lt;int:gateway</span> <span class="hl-attribute">request-channel</span>=<span class="hl-value">"inputA"</span><span class="hl-tag">/&gt;</span> &nbsp;
<span class="hl-tag">&lt;/int:chain&gt;</span>

<span class="hl-tag">&lt;int:chain&nbsp;id="nested-chain-a"&nbsp;input-channel="inputA"&gt;</span>
    <span class="hl-tag">&lt;int:header-enricher&gt;</span>
        <span class="hl-tag">&lt;int:header</span> <span class="hl-attribute">name</span>=<span class="hl-value">"name"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"Moe"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;/int:header-enricher&gt;</span>
    <span class="hl-tag">&lt;int:gateway</span> <span class="hl-attribute">request-channel</span>=<span class="hl-value">"inputB"</span><span class="hl-tag">/&gt;</span>&nbsp;
    <span class="hl-tag">&lt;int:service-activator&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.foo.SampleService"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;/int:service-activator&gt;</span>
<span class="hl-tag">&lt;/int:chain&gt;</span>

<span class="hl-tag">&lt;int:chain&nbsp;id="nested-chain-b"&nbsp;input-channel="inputB"&gt;</span>
    <span class="hl-tag">&lt;int:header-enricher&gt;</span>
        <span class="hl-tag">&lt;int:header</span> <span class="hl-attribute">name</span>=<span class="hl-value">"name"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"Jack"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;/int:header-enricher&gt;</span>
    <span class="hl-tag">&lt;int:service-activator&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.foo.SampleService"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;/int:service-activator&gt;</span>
<span class="hl-tag">&lt;/int:chain&gt;</span></pre>
<p>In the above example the <span class="emphasis"><em>nested-chain-a</em></span> will be called at the end of <span class="emphasis"><em>main-chain</em></span> processing by the <span class="emphasis"><em>gateway</em></span> element configured there.
While in <span class="emphasis"><em>nested-chain-a</em></span> a call to a <span class="emphasis"><em>nested-chain-b</em></span> will be made after header enrichment and then it will come back to finish execution in <span class="emphasis"><em>nested-chain-b</em></span>.
Finally the flow returns to the <span class="emphasis"><em>main-chain</em></span>.
When the nested version of a &lt;gateway&gt; element is defined in the chain, it does not require the <code class="literal">service-interface</code> attribute.
Instead, it simple takes the message in its current state and places it on the channel defined via the <code class="literal">request-channel</code> attribute.
When the downstream flow initiated by that gateway completes, a <code class="literal">Message</code> will be returned to the gateway and continue its journey within the current chain.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="scatter-gather" href="#scatter-gather"></a>6.7&nbsp;Scatter-Gather</h2></div></div></div>

<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="scatter-gather-introduction" href="#scatter-gather-introduction"></a>6.7.1&nbsp;Introduction</h3></div></div></div>

<p>Starting with <span class="emphasis"><em>version 4.1</em></span>, Spring Integration provides an implementation of the <a class="ulink" href="http://www.eaipatterns.com/BroadcastAggregate.html" target="_top">Scatter-Gather</a> Enterprise Integration Pattern.
It is a compound endpoint, where the goal is to send a message to the recipients and aggregate the results.
Quoting the EIP Book, it is a component for scenarios like <span class="emphasis"><em>best quote</em></span>, when we need to request information from several suppliers and decide which one provides us with the best term for the requested item.</p>
<p>Previously, the pattern could be configured using discrete components, this enhancement brings more convenient configuration.</p>
<p>The <code class="literal">ScatterGatherHandler</code> is a <span class="emphasis"><em>request-reply</em></span> endpoint that combines a <code class="literal">PublishSubscribeChannel</code> (or <code class="literal">RecipientListRouter</code>) and an <code class="literal">AggregatingMessageHandler</code>.
The request message is sent to the <code class="literal">scatter</code> channel and the <code class="literal">ScatterGatherHandler</code> waits for the reply from the aggregator to sends to the <code class="literal">outputChannel</code>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="scatter-gather-functionality" href="#scatter-gather-functionality"></a>6.7.2&nbsp;Functionality</h3></div></div></div>

<p>The <code class="literal">Scatter-Gather</code> pattern suggests two scenarios - <span class="emphasis"><em>Auction</em></span> and <span class="emphasis"><em>Distribution</em></span>.
In both cases, the <code class="literal">aggregation</code> function is the same and provides all options available for the <code class="literal">AggregatingMessageHandler</code>.
Actually the <code class="literal">ScatterGatherHandler</code> just requires an <code class="literal">AggregatingMessageHandler</code> as a constructor argument.
See <a class="xref" href="#aggregator" title="6.4&nbsp;Aggregator">Section&nbsp;6.4, &#8220;Aggregator&#8221;</a> for more information.</p>
<p><span class="emphasis"><em>Auction</em></span></p>
<p>The <span class="emphasis"><em>Auction</em></span> <code class="literal">Scatter-Gather</code> variant uses <code class="literal">publish-subscribe</code> logic for the request message, where the <code class="literal">scatter</code> channel is a <code class="literal">PublishSubscribeChannel</code> with <code class="literal">apply-sequence="true"</code>.
However, this channel can be any <code class="literal">MessageChannel</code> implementation as is the case with the <code class="literal">request-channel</code> in the <code class="literal">ContentEnricher</code> (see <a class="xref" href="#content-enricher" title="7.2&nbsp;Content Enricher">Section&nbsp;7.2, &#8220;Content Enricher&#8221;</a>) but, in this case, the end-user should support his own custom <code class="literal">correlationStrategy</code> for the <code class="literal">aggregation</code> function.</p>
<p><span class="emphasis"><em>Distribution</em></span></p>
<p>The <span class="emphasis"><em>Distribution</em></span> <code class="literal">Scatter-Gather</code> variant is based on the <code class="literal">RecipientListRouter</code> (see <a class="xref" href="#router-implementations-recipientlistrouter" title="RecipientListRouter">the section called &#8220;RecipientListRouter&#8221;</a>) with all available options for the <code class="literal">RecipientListRouter</code>.
This is the second <code class="literal">ScatterGatherHandler</code> constructor argument.
If you want to rely just on the default <code class="literal">correlationStrategy</code> for the <code class="literal">recipient-list-router</code> and the <code class="literal">aggregator</code>, you should specify <code class="literal">apply-sequence="true"</code>.
Otherwise, a custom <code class="literal">correlationStrategy</code> should be supplied for the <code class="literal">aggregator</code>.
Unlike the <code class="literal">PublishSubscribeChannel</code> (<span class="emphasis"><em>Auction</em></span>) variant, having a <code class="literal">recipient-list-router</code> <code class="literal">selector</code> option, we can <span class="emphasis"><em>filter</em></span> target suppliers based on the message.
With <code class="literal">apply-sequence="true"</code> the default <code class="literal">sequenceSize</code> will be supplied and the <code class="literal">aggregator</code> will be able to release the group correctly.
The <span class="emphasis"><em>Distribution</em></span> option is mutually exclusive with the <span class="emphasis"><em>Auction</em></span> option.</p>
<p>In both cases, the request (<span class="emphasis"><em>scatter</em></span>) message is enriched with the <code class="literal">gatherResultChannel</code> <code class="literal">QueueChannel</code> header, to wait for a reply message from the <code class="literal">aggregator</code>.</p>
<p>By default, all suppliers should send their result to the <code class="literal">replyChannel</code> header (usually by omitting the <code class="literal">output-channel</code> from the ultimate endpoint).
However, the <code class="literal">gatherChannel</code> option is also provided, allowing suppliers to send their reply to that channel for the aggregation.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="scatter-gather-namespace" href="#scatter-gather-namespace"></a>6.7.3&nbsp;Configuring a Scatter-Gather Endpoint</h3></div></div></div>

<p>For Java and Annotation configuration, the bean definition for the <code class="literal">Scatter-Gather</code> is:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> MessageHandler distributor() {
    RecipientListRouter router = <span class="hl-keyword">new</span> RecipientListRouter();
    router.setApplySequence(true);
    router.setChannels(Arrays.asList(distributionChannel1(), distributionChannel2(),
            distributionChannel3()));
    <span class="hl-keyword">return</span> router;
}

<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> MessageHandler gatherer() {
	<span class="hl-keyword">return</span> <span class="hl-keyword">new</span> AggregatingMessageHandler(
			<span class="hl-keyword">new</span> ExpressionEvaluatingMessageGroupProcessor(<span class="hl-string">"^[payload gt 5] ?: -1D"</span>),
			<span class="hl-keyword">new</span> SimpleMessageStore(),
			<span class="hl-keyword">new</span> HeaderAttributeCorrelationStrategy(
			       IntegrationMessageHeaderAccessor.CORRELATION_ID),
			<span class="hl-keyword">new</span> ExpressionEvaluatingReleaseStrategy(<span class="hl-string">"size() == 2"</span>));
}

<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "distributionChannel")</span></em>
<span class="hl-keyword">public</span> MessageHandler scatterGatherDistribution() {
	ScatterGatherHandler handler = <span class="hl-keyword">new</span> ScatterGatherHandler(distributor(), gatherer());
	handler.setOutputChannel(output());
	<span class="hl-keyword">return</span> handler;
}</pre>
<p>Here, we configure the <code class="literal">RecipientListRouter</code> <code class="literal">distributor</code> bean, with <code class="literal">applySequence="true"</code> and the list of recipient channels.
The next bean is for an <code class="literal">AggregatingMessageHandler</code>.
Finally, we inject both those beans into the <code class="literal">ScatterGatherHandler</code> bean definition and mark it as a <code class="literal">@ServiceActivator</code> to wire the Scatter-Gather component into the integration flow.</p>
<p>Configuring the <code class="literal">&lt;scatter-gather&gt;</code> endpoint using the XML namespace:</p>
<pre class="programlisting"><span class="hl-tag">&lt;scatter-gather</span>
		<span class="hl-attribute">id</span>=<span class="hl-value">""</span>  <a name="CO7-1" href="#CO7-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
		auto-startup=""  <a name="CO7-2" href="#CO7-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
		input-channel=""  <a name="CO7-3" href="#CO7-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
		output-channel=""  <a name="CO7-4" href="#CO7-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
		scatter-channel=""  <a name="CO7-5" href="#CO7-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
		gather-channel=""  <a name="CO7-6" href="#CO7-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>
		order=""  <a name="CO7-7" href="#CO7-7"></a><span><img src="images/callouts/7.png" alt="7" border="0"></span>
		phase=""  <a name="CO7-8" href="#CO7-8"></a><span><img src="images/callouts/8.png" alt="8" border="0"></span>
		send-timeout=""  <a name="CO7-9" href="#CO7-9"></a><span><img src="images/callouts/9.png" alt="9" border="0"></span>
		gather-timeout=""  <a name="CO7-10" href="#CO7-10"></a><span><img src="images/callouts/10.png" alt="10" border="0"></span>
		requires-reply="" &gt; <a name="CO7-11" href="#CO7-11"></a><span><img src="images/callouts/11.png" alt="11" border="0"></span>
			<span class="hl-tag">&lt;scatterer/&gt;</span>  <a name="CO7-12" href="#CO7-12"></a><span><img src="images/callouts/12.png" alt="12" border="0"></span>
			<span class="hl-tag">&lt;gatherer/&gt;</span>  <a name="CO7-13" href="#CO7-13"></a><span><img src="images/callouts/13.png" alt="13" border="0"></span>
<span class="hl-tag">&lt;/scatter-gather&gt;</span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO7-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The id of the Endpoint.
The <code class="literal">ScatterGatherHandler</code> bean is registered with <code class="literal">id + '.handler'</code> alias.
The <code class="literal">RecipientListRouter</code> - with <code class="literal">id + '.scatterer'</code>.
And the <code class="literal">AggregatingMessageHandler</code> with <code class="literal">id + '.gatherer'</code>.
<span class="emphasis"><em>Optional</em></span> (a default id is generated value by <code class="literal">BeanFactory</code>).</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO7-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Lifecycle attribute signaling if the Endpoint should be started during Application Context initialization.
In addition, the <code class="literal">ScatterGatherHandler</code> also implements <code class="literal">Lifecycle</code> and starts/stops the <code class="literal">gatherEndpoint</code>, which is created internally if a <code class="literal">gather-channel</code> is provided.
<span class="emphasis"><em>Optional</em></span> (default is <code class="literal">true</code>).</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO7-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The channel to receive request messages to handle them in the <code class="literal">ScatterGatherHandler</code>.
<span class="emphasis"><em>Required</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO7-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The channel to which the Scatter-Gather will send the aggregation results.
<span class="emphasis"><em>Optional (because incoming messages can specify a reply channel themselves via <code class="literal">replyChannel</code> Message Header)</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO7-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The channel to send the scatter message for the <span class="emphasis"><em>Auction</em></span> scenario.
<span class="emphasis"><em>Optional</em></span>.
Mutually exclusive with <code class="literal">&lt;scatterer&gt;</code> sub-element.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO7-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The channel to receive replies from each supplier for the aggregation.
is used as the <code class="literal">replyChannel</code> header in the scatter message.
<span class="emphasis"><em>Optional</em></span>.
By default the <code class="literal">FixedSubscriberChannel</code> is created.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO7-7"><span><img src="images/callouts/7.png" alt="7" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Order of this component when more than one handler is subscribed to the same DirectChannel (use for load balancing purposes).
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO7-8"><span><img src="images/callouts/8.png" alt="8" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Specify the phase in which the endpoint should be started and stopped.
The startup order proceeds from lowest to highest, and the shutdown order is the reverse of that.
By default this value is Integer.MAX_VALUE meaning that this container starts as late as possible and stops as soon as possible.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO7-9"><span><img src="images/callouts/9.png" alt="9" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The timeout interval to wait when sending a reply <code class="literal">Message</code> to the <code class="literal">output-channel</code>.
By default the send will block for one second.
It applies only if the output channel has some <span class="emphasis"><em>sending</em></span> limitations, e.g.
a <code class="literal">QueueChannel</code> with a fixed <span class="emphasis"><em>capacity</em></span> and is full.
In this case, a <code class="literal">MessageDeliveryException</code> is thrown.
The <code class="literal">send-timeout</code> is ignored in case of <code class="literal">AbstractSubscribableChannel</code> implementations.
In case of <code class="literal">group-timeout(-expression)</code> the <code class="literal">MessageDeliveryException</code> from the scheduled expire task leads this task to be rescheduled.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO7-10"><span><img src="images/callouts/10.png" alt="10" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Allows you to specify how long the Scatter-Gather will wait for the reply message before returning.
By default it will wait indefinitely.
<span class="emphasis"><em>null</em></span> is returned if the reply times out.
<span class="emphasis"><em>Optional</em></span>.
Defaults to <code class="literal">-1</code> - indefinitely.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO7-11"><span><img src="images/callouts/11.png" alt="11" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Specify whether the Scatter-Gather must return a non-null value.
This value is <code class="literal">true</code> by default, hence a <code class="literal">ReplyRequiredException</code> will be thrown when the underlying aggregator returns a null value after <code class="literal">gather-timeout</code>.
Note, if <code class="literal">null</code> is a possibility, the <code class="literal">gather-timeout</code> should be specified to avoid an indefinite wait.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO7-12"><span><img src="images/callouts/12.png" alt="12" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The <code class="literal">&lt;recipient-list-router&gt;</code> options.
<span class="emphasis"><em>Optional</em></span>.
Mutually exclusive with <code class="literal">scatter-channel</code> attribute.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO7-13"><span><img src="images/callouts/13.png" alt="13" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The <code class="literal">&lt;aggregator&gt;</code> options.
<span class="emphasis"><em>Required</em></span>.</p>
</td></tr></table></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="barrier" href="#barrier"></a>6.8&nbsp;Thread Barrier</h2></div></div></div>

<p>Sometimes, we need to suspend a message flow thread until some other asynchronous event occurs.
For example, consider an HTTP request that publishes a message to RabbitMQ.
We might wish to not reply to the user until the RabbitMQ broker has issued an acknowledgment that the message was
received.</p>
<p>Spring Integration <span class="emphasis"><em>version 4.2</em></span> introduced the <code class="literal">&lt;barrier/&gt;</code> component for this purpose.
The underlying <code class="literal">MessageHandler</code> is the <code class="literal">BarrierMessageHandler</code>; this class also implements
<code class="literal">MessageTriggerAction</code> where a message passed to the <code class="literal">trigger()</code> method releases a corresponding thread in the
<code class="literal">handleRequestMessage()</code> method (if present).</p>
<p>The suspended thread and trigger thread are correlated by invoking a <code class="literal">CorrelationStrategy</code> on the messages.
When a message is sent to the <code class="literal">input-channel</code>, the thread is suspended for up to <code class="literal">timeout</code> milliseconds, waiting for
a corresponding trigger message.
The default correlation strategy uses the <code class="literal">IntegrationMessageHeaderAccessor.CORRELATION_ID</code> header.
When a trigger message arrives with the same correlation, the thread is released.
The message sent to the <code class="literal">output-channel</code> after release is constructed using a <code class="literal">MessageGroupProcessor</code>.
By default, the message is a <code class="literal">Collection&lt;?&gt;</code> of the two payloads and the headers are merged, using a
<code class="literal">DefaultAggregatingMessageGroupProcessor</code>.</p>
<div class="caution" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Caution"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Caution]" src="images/caution.png"></td><th align="left">Caution</th></tr><tr><td align="left" valign="top">
<p>If the <code class="literal">trigger()</code> method is invoked first (or after the main thread times out), it will be suspended
for up to <code class="literal">timeout</code> waiting for the suspending message to arrive.
If you do not want to suspend the trigger thread, consider handing off to a <code class="literal">TaskExecutor</code> instead so its thread
will be suspended instead.</p>
</td></tr></table></div>
<p>The <code class="literal">requires-reply</code> property determines the action if the suspended thread times out before the trigger message
arrives.
By default, it is <code class="literal">false</code> which means the endpoint simply returns <code class="literal">null</code>, the flow ends and the thread returns to the
caller.
When <code class="literal">true</code>, a <code class="literal">ReplyRequiredException</code> is thrown.</p>
<p>You can call the <code class="literal">trigger()</code> method programmatically (obtain the bean reference using the name <code class="literal">barrier.handler</code>
 - where <span class="emphasis"><em>barrier</em></span> is the bean name of the barrier endpoint) or you can configure
an <code class="literal">&lt;outbound-channel-adapter/&gt;</code> to trigger the release.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Only one thread can be suspended with the same correlation; the same correlation can be used multiple times
but only once concurrently.
An exception is thrown if a second thread arrives with the same correlation.</p>
</td></tr></table></div>
<pre class="programlisting"><span class="hl-tag">&lt;int:barrier</span> <span class="hl-attribute">id</span>=<span class="hl-value">"barrier1"</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"in"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"out"</span>
        <span class="hl-attribute">correlation-strategy-expression</span>=<span class="hl-value">"headers['myHeader']"</span>
        <span class="hl-attribute">output-processor</span>=<span class="hl-value">"myOutputProcessor"</span>
        <span class="hl-attribute">discard-channel</span>=<span class="hl-value">"lateTriggerChannel"</span>
        <span class="hl-attribute">timeout</span>=<span class="hl-value">"10000"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;/int:barrier&gt;</span>

<span class="hl-tag">&lt;int:outbound-channel-adapter</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"release"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"barrier1.handler"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"trigger"</span><span class="hl-tag"> /&gt;</span></pre>
<p>In this example, a custom header is used for correlation.
Either the thread sending a message to <code class="literal">in</code> or the one sending a message to <code class="literal">release</code> will wait for
up to 10 seconds until the other arrives.
When the message is released, the <code class="literal">out</code> channel will be sent a message combining the result of invoking the
custom <code class="literal">MessageGroupProcessor</code> bean <code class="literal">myOutputProcessor</code>.
If the main thread times out and a trigger arrives later, you can configure a discard channel to which the late trigger will be sent.
Java configuration is shown below.</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Configuration</span></em>
<em><span class="hl-annotation" style="color: gray">@EnableIntegration</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> Config {

    <em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel="in")</span></em>
    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> BarrierMessageHandler barrier() {
        BarrierMessageHandler barrier = <span class="hl-keyword">new</span> BarrierMessageHandler(<span class="hl-number">10000</span>);
        barrier.setOutputChannel(out());
        barrier.setDiscardChannel(lateTriggers());
        <span class="hl-keyword">return</span> barrier;
    }

    <em><span class="hl-annotation" style="color: gray">@ServiceActivator</span></em> (inputChannel=<span class="hl-string">"release"</span>)
    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> MessageHandler releaser() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> MessageHandler() {

            <em><span class="hl-annotation" style="color: gray">@Override</span></em>
            <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> handleMessage(Message&lt;?&gt; message) <span class="hl-keyword">throws</span> MessagingException {
                barrier().trigger(message);
            }

        };
    }

}</pre>
<p>See the
<a class="ulink" href="https://github.com/spring-projects/spring-integration-samples/tree/master/basic/barrier" target="_top">barrier sample application</a>
for an example of this component.</p>
</div>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="messaging-transformation-chapter" href="#messaging-transformation-chapter"></a>7.&nbsp;Message Transformation</h2></div></div></div>

<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="transformer" href="#transformer"></a>7.1&nbsp;Transformer</h2></div></div></div>

<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="transformer-introduction" href="#transformer-introduction"></a>7.1.1&nbsp;Introduction</h3></div></div></div>

<p>Message Transformers play a very important role in enabling the loose-coupling of Message Producers and Message Consumers.
Rather than requiring every Message-producing component to know what type is expected by the next consumer, Transformers can be added between those components.
Generic transformers, such as one that converts a String to an XML Document, are also highly reusable.</p>
<p>For some systems, it may be best to provide a <a class="ulink" href="http://www.eaipatterns.com/CanonicalDataModel.html" target="_top">Canonical Data Model</a>, but Spring Integration&#8217;s general philosophy is not to require any particular format.
Rather, for maximum flexibility, Spring Integration aims to provide the simplest possible model for extension.
As with the other endpoint types, the use of declarative configuration in XML and/or Annotations enables simple POJOs to be adapted for the role of Message Transformers.
These configuration options will be described below.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>For the same reason of maximizing flexibility, Spring does not require XML-based Message payloads.
Nevertheless, the framework does provide some convenient Transformers for dealing with XML-based payloads if that is indeed the right choice for your application.
For more information on those transformers, see <a class="xref" href="#xml" title="35.&nbsp;XML Support - Dealing with XML Payloads">Chapter&nbsp;35, <i>XML Support - Dealing with XML Payloads</i></a>.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="transformer-config" href="#transformer-config"></a>7.1.2&nbsp;Configuring Transformer</h3></div></div></div>

<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="transformer-namespace" href="#transformer-namespace"></a>Configuring Transformer with XML</h4></div></div></div>

<p>The &lt;transformer&gt; element is used to create a Message-transforming endpoint.
In addition to "input-channel" and "output-channel" attributes, it requires a "ref".
The "ref" may either point to an Object that contains the @Transformer annotation on a single method (see below) or it may be combined with an explicit method name value provided via the "method" attribute.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:transformer</span> <span class="hl-attribute">id</span>=<span class="hl-value">"testTransformer"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"testTransformerBean"</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"inChannel"</span>
             <span class="hl-attribute">method</span>=<span class="hl-value">"transform"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"outChannel"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;beans:bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"testTransformerBean"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.foo.TestTransformer"</span><span class="hl-tag"> /&gt;</span></pre>
<p>Using a <code class="literal">ref</code> attribute is generally recommended if the custom transformer handler implementation can be reused in other <code class="literal">&lt;transformer&gt;</code> definitions.
However if the custom transformer handler implementation should be scoped to a single definition of the <code class="literal">&lt;transformer&gt;</code>, you can define an inner bean definition:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:transformer</span> <span class="hl-attribute">id</span>=<span class="hl-value">"testTransformer"</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"inChannel"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"transform"</span>
                <span class="hl-attribute">output-channel</span>=<span class="hl-value">"outChannel"</span><span class="hl-tag">&gt;</span>
  <span class="hl-tag">&lt;beans:bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.foo.TestTransformer"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/transformer&gt;</span></pre>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Using both the "ref" attribute and an inner handler definition in the same <code class="literal">&lt;transformer&gt;</code> configuration is not allowed, as it creates an ambiguous condition and will result in an Exception being thrown.</p>
</td></tr></table></div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>If the "ref" attribute references a bean that extends <code class="literal">AbstractMessageProducingHandler</code> (such as transformers provided by the framework itself), the configuration is optimized by injecting the output channel into the handler directly.
In this case, each "ref" must be to a separate bean instance (or a <code class="literal">prototype</code>-scoped bean), or use the inner <code class="literal">&lt;bean/&gt;</code> configuration type.
If you inadvertently reference the same message handler from multiple beans, you will get a configuration exception.</p>
</td></tr></table></div>
<p>When using a POJO, the method that is used for transformation may expect either the <code class="literal">Message</code> type or the payload type of inbound Messages.
It may also accept Message header values either individually or as a full map by using the <code class="literal">@Header</code> and <code class="literal">@Headers</code> parameter annotations respectively.
The return value of the method can be any type.
If the return value is itself a <code class="literal">Message</code>, that will be passed along to the transformer&#8217;s output channel.</p>
<p>As of Spring Integration 2.0, a Message Transformer&#8217;s transformation method can no longer return <code class="literal">null</code>.
Returning <code class="literal">null</code> will result in an exception since a Message Transformer should always be expected to transform each source Message into a valid target Message.
In other words, a Message Transformer should not be used as a Message Filter since there is a dedicated <code class="literal">&lt;filter&gt;</code> option for that.
However, if you do need this type of behavior (where a component might return NULL and that should not be considered an error), a <span class="emphasis"><em>service-activator</em></span> could be used.
Its <code class="literal">requires-reply</code> value is FALSE by default, but that can be set to TRUE in order to have Exceptions thrown for NULL return values as with the transformer.</p>
<p><span class="emphasis"><em>Transformers and Spring Expression Language (SpEL)</em></span></p>
<p>Just like Routers, Aggregators and other components, as of Spring Integration 2.0 Transformers can also benefit from SpEL support (<a class="ulink" href="http://docs.spring.io/spring/docs/current/spring-framework-reference/html/expressions.html" target="_top">http://docs.spring.io/spring/docs/current/spring-framework-reference/html/expressions.html</a>) whenever transformation logic is relatively simple.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:transformer</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"inChannel"</span>
	<span class="hl-attribute">output-channel</span>=<span class="hl-value">"outChannel"</span>
	<span class="hl-attribute">expression</span>=<span class="hl-value">"payload.toUpperCase() + '- [' + T(java.lang.System).currentTimeMillis() + ']'"</span><span class="hl-tag">/&gt;</span></pre>
<p>In the above configuration we are achieving a simple transformation of the <span class="emphasis"><em>payload</em></span> with a simple SpEL expression and without writing a custom transformer.
Our <span class="emphasis"><em>payload</em></span> (assuming String) will be upper-cased and concatenated with the current timestamp with some simple formatting.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_common_transformers" href="#_common_transformers"></a>Common Transformers</h4></div></div></div>

<p>There are also a few Transformer implementations available out of the box.</p>
<div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="_object_to_string_transformer" href="#_object_to_string_transformer"></a>Object-to-String Transformer</h5></div></div></div>

<p>Because, it is fairly common to use the <code class="literal">toString()</code> representation of an Object, Spring Integration provides an <code class="literal">ObjectToStringTransformer</code> whose output is a <code class="literal">Message</code> with a String <code class="literal">payload</code>.
That String is the result of invoking the <code class="literal">toString()</code> operation on the inbound Message&#8217;s payload.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:object-to-string-transformer</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"in"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"out"</span><span class="hl-tag">/&gt;</span></pre>
<p>A potential example for this would be sending some arbitrary object to the <span class="emphasis"><em>outbound-channel-adapter</em></span> in the <span class="emphasis"><em>file</em></span> namespace.
Whereas that Channel Adapter only supports String, byte-array, or <code class="literal">java.io.File</code> payloads by default, adding this transformer immediately before the adapter will handle the necessary conversion.
Of course, that works fine as long as the result of the <code class="literal">toString()</code> call is what you want to be written to the File.
Otherwise, you can just provide a custom POJO-based Transformer via the generic <span class="emphasis"><em>transformer</em></span> element shown previously.</p>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>When debugging, this transformer is not typically necessary since the <span class="emphasis"><em>logging-channel-adapter</em></span> is capable of logging the Message payload.
Refer to <a class="xref" href="#channel-wiretap" title="Wire Tap">the section called &#8220;Wire Tap&#8221;</a> for more detail.</p>
</td></tr></table></div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The <span class="emphasis"><em>object-to-string-transformer</em></span> is very simple; it invokes <code class="literal">toString()</code> on the inbound payload.
There are two exceptions to this (since 3.0): if the payload is a <code class="literal">char[]</code>, it invokes <code class="literal">new String(payload)</code>; if the payload is a <code class="literal">byte[]</code>, it invokes <code class="literal">new String(payload, charset)</code>, where <code class="literal">charset</code> is "UTF-8" by default.
The <code class="literal">charset</code> can be modified by supplying the <span class="emphasis"><em>charset</em></span> attribute on the transformer.</p>
<p>For more sophistication (such as selection of the charset dynamically, at runtime), you can use a SpEL expression-based transformer instead; for example:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:transformer</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"in"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"out"</span>
       <span class="hl-attribute">expression</span>=<span class="hl-value">"new java.lang.String(payload, headers['myCharset']"</span><span class="hl-tag"> /&gt;</span></pre>
</td></tr></table></div>
<p>If you need to serialize an Object to a byte array or deserialize a byte array back into an Object, Spring Integration provides symmetrical serialization transformers.
These will use standard Java serialization by default, but you can provide an implementation of Spring 3.0&#8217;s Serializer or Deserializer strategies via the <span class="emphasis"><em>serializer</em></span> and <span class="emphasis"><em>deserializer</em></span> attributes, respectively.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:payload-serializing-transformer</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"objectsIn"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"bytesOut"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int:payload-deserializing-transformer</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"bytesIn"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"objectsOut"</span>
    <span class="hl-attribute">white-list</span>=<span class="hl-value">"com.mycom.*,com.yourcom.*"</span><span class="hl-tag">/&gt;</span></pre>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>When deserializing data from untrusted sources, you should consider adding a <code class="literal">white-list</code> of package/class patterns.
By default, all classes will be deserialized.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="_object_to_map_and_map_to_object_transformers" href="#_object_to_map_and_map_to_object_transformers"></a>Object-to-Map and Map-to-Object Transformers</h5></div></div></div>

<p>Spring Integration also provides <span class="emphasis"><em>Object-to-Map</em></span> and <span class="emphasis"><em>Map-to-Object</em></span> transformers which utilize the Spring Expression Language (SpEL) to serialize and de-serialize the object graphs.
The object hierarchy is introspected to the most primitive types (String, int, etc.).
The path to this type is described via SpEL, which becomes the <span class="emphasis"><em>key</em></span> in the transformed Map.
The primitive type becomes the value.</p>
<p>For example:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> Parent{
&nbsp;&nbsp; &nbsp;<span class="hl-keyword">private</span> Child child;
&nbsp;&nbsp; &nbsp;<span class="hl-keyword">private</span> String name;&nbsp;
&nbsp;&nbsp; &nbsp;<span class="hl-comment">// setters and getters are omitted</span>
}

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> Child{
&nbsp;&nbsp;&nbsp; <span class="hl-keyword">private</span> String name;&nbsp;
 &nbsp;&nbsp; <span class="hl-keyword">private</span> List&lt;String&gt; nickNames;
&nbsp; &nbsp; <span class="hl-comment">// setters and getters are omitted</span>
}</pre>
<p>...will be transformed to a Map which looks like this: <code class="literal">{person.name=George, person.child.name=Jenna, person.child.nickNames[0]=Bimbo ... etc}</code></p>
<p>The SpEL-based Map allows you to describe the object structure without sharing the actual types allowing you to restore/rebuild the object graph into a differently typed Object graph as long as you maintain the structure.</p>
<p>For example: The above structure could be easily restored back to the following Object graph via the Map-to-Object transformer:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> Father {
&nbsp;&nbsp; &nbsp;<span class="hl-keyword">private</span> Kid child;
&nbsp;&nbsp; &nbsp;<span class="hl-keyword">private</span> String name;&nbsp;
&nbsp;&nbsp; &nbsp;<span class="hl-comment">// setters and getters are omitted</span>
}

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> Kid {
&nbsp;&nbsp; &nbsp;<span class="hl-keyword">private</span> String name;&nbsp;
&nbsp;&nbsp;  <span class="hl-keyword">private</span> List&lt;String&gt; nickNames;
 &nbsp;&nbsp; <span class="hl-comment">// setters and getters are omitted</span>
}</pre>
<p>If you need to create a "structured" map, you can provide the <span class="emphasis"><em>flatten</em></span> attribute.
The default value for this attribute is <span class="emphasis"><em>true</em></span> meaning the default behavior; if you provide a <span class="emphasis"><em>false</em></span> value, then the structure will be a map of maps.</p>
<p>For example:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> Parent {
	<span class="hl-keyword">private</span> Child child;
	<span class="hl-keyword">private</span> String name;
	<span class="hl-comment">// setters and getters are omitted</span>
}

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> Child {
	<span class="hl-keyword">private</span> String name;
	<span class="hl-keyword">private</span> List&lt;String&gt; nickNames;
	<span class="hl-comment">// setters and getters are omitted</span>
}</pre>
<p>...will be transformed to a Map which looks like this: <code class="literal">{name=George, child={name=Jenna, nickNames=[Bimbo, ...]}}</code></p>
<p>To configure these transformers, Spring Integration provides namespace support Object-to-Map:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:object-to-map-transformer</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"directInput"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span><span class="hl-tag">/&gt;</span></pre>
<p>or</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:object-to-map-transformer</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"directInput"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span> <span class="hl-attribute">flatten</span>=<span class="hl-value">"false"</span><span class="hl-tag">/&gt;</span></pre>
<p>Map-to-Object</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:map-to-object-transformer</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span><span class="hl-attribute">&nbsp;</span>
  <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;output-channel</span>=<span class="hl-value">"output"</span><span class="hl-attribute">&nbsp;</span>
  <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">type</span>=<span class="hl-value">"org.foo.Person"</span><span class="hl-tag">/&gt;</span></pre>
<p>or</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:map-to-object-transformer</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"inputA"</span><span class="hl-attribute">&nbsp;</span>
  <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"outputA"</span><span class="hl-attribute">&nbsp;</span>
  <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"person"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"person"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.foo.Person"</span> <span class="hl-attribute">scope</span>=<span class="hl-value">"prototype"</span><span class="hl-tag">/&gt;</span></pre>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>NOTE: <span class="emphasis"><em>ref</em></span> and <span class="emphasis"><em>type</em></span> attributes are mutually exclusive.
You can only use one.
Also, if using the <span class="emphasis"><em>ref</em></span> attribute, you must point to a <span class="emphasis"><em>prototype</em></span> scoped bean, otherwise a BeanCreationException will be thrown.&nbsp;</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="stream-transformer" href="#stream-transformer"></a>Stream Transformer</h5></div></div></div>

<p>The <code class="literal">StreamTransformer</code> transforms <code class="literal">InputStream</code> payloads to a <code class="literal">byte[]</code> or a <code class="literal">String</code> if a <code class="literal">charset</code> is provided.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:stream-transformer</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"directInput"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span><span class="hl-tag">/&gt;</span> <span class="hl-comment">&lt;!-- byte[] --&gt;</span>

<span class="hl-tag">&lt;int:stream-transformer</span> <span class="hl-attribute">id</span>=<span class="hl-value">"withCharset"</span> <span class="hl-attribute">charset</span>=<span class="hl-value">"UTF-8"</span>
    <span class="hl-attribute">input-channel</span>=<span class="hl-value">"charsetChannel"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span><span class="hl-tag">/&gt;</span> <span class="hl-comment">&lt;!-- String --&gt;</span></pre>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<em><span class="hl-annotation" style="color: gray">@Transformer(inputChannel = "stream", outputChannel = "data")</span></em>
<span class="hl-keyword">public</span> StreamTransformer streamToBytes() {
    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> StreamTransformer(); <span class="hl-comment">// transforms to byte[]</span>
}

<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<em><span class="hl-annotation" style="color: gray">@Transformer(inputChannel = "stream", outputChannel = "data")</span></em>
<span class="hl-keyword">public</span> StreamTransformer streamToString() {
    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> StreamTransformer(<span class="hl-string">"UTF-8"</span>); <span class="hl-comment">// transforms to String</span>
}</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="_json_transformers" href="#_json_transformers"></a>JSON Transformers</h5></div></div></div>

<p><span class="emphasis"><em>Object to JSON</em></span> and <span class="emphasis"><em>JSON to Object</em></span> transformers are provided.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:object-to-json-transformer</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"objectMapperInput"</span><span class="hl-tag">/&gt;</span></pre>
<pre class="programlisting"><span class="hl-tag">&lt;int:json-to-object-transformer</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"objectMapperInput"</span>
    <span class="hl-attribute">type</span>=<span class="hl-value">"foo.MyDomainObject"</span><span class="hl-tag">/&gt;</span></pre>
<p>These use a vanilla <code class="literal">JsonObjectMapper</code> by default based on implementation from classpath.
You can provide your own custom <code class="literal">JsonObjectMapper</code> implementation with appropriate options or based on required library (e.g.
GSON).</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:json-to-object-transformer</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"objectMapperInput"</span>
    <span class="hl-attribute">type</span>=<span class="hl-value">"foo.MyDomainObject"</span> <span class="hl-attribute">object-mapper</span>=<span class="hl-value">"customObjectMapper"</span><span class="hl-tag">/&gt;</span></pre>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Beginning with version 3.0, the <code class="literal">object-mapper</code> attribute references an instance of a new strategy interface <code class="literal">JsonObjectMapper</code>.
This abstraction allows multiple implementations of json mappers to be used.
Implementations that wraphttps://github.com/RichardHightower/boon[Boon] and <a class="ulink" href="https://github.com/FasterXML" target="_top">Jackson 2</a> are provided, with the version being detected on the classpath.
These classes are <code class="literal">BoonJsonObjectMapper</code> and <code class="literal">Jackson2JsonObjectMapper</code>.</p>
<p>Note, <code class="literal">BoonJsonObjectMapper</code> is provided since <span class="emphasis"><em>version 4.1</em></span>.</p>
</td></tr></table></div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>If there are requirements to use both Jackson libraries and/or Boon in the same application, keep in mind that before version 3.0, the JSON transformers used only Jackson 1.x.
From <span class="emphasis"><em>4.1</em></span> on, the framework will select Jackson 2 by default ahead of the Boon implementation if both are on the classpath.
Jackson 1.x is no longer supported by the framework internally but, of course, you can still use it within your code.
To avoid unexpected issues with JSON mapping features, when using annotations, there may be a need to apply annotations from both Jacksons and/or Boon on domain classes:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@org.codehaus.jackson.annotate.JsonIgnoreProperties(ignoreUnknown=true)</span></em>
<em><span class="hl-annotation" style="color: gray">@com.fasterxml.jackson.annotation.JsonIgnoreProperties(ignoreUnknown=true)</span></em>
<em><span class="hl-annotation" style="color: gray">@org.boon.json.annotations.JsonIgnoreProperties("foo")</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> Foo {

        <em><span class="hl-annotation" style="color: gray">@org.codehaus.jackson.annotate.JsonProperty("fooBar")</span></em>
        <em><span class="hl-annotation" style="color: gray">@com.fasterxml.jackson.annotation.JsonProperty("fooBar")</span></em>
        <em><span class="hl-annotation" style="color: gray">@org.boon.json.annotations.JsonProperty("fooBar")</span></em>
        <span class="hl-keyword">public</span> Object bar;

}</pre>
</td></tr></table></div>
<p>You may wish to consider using a <code class="literal">FactoryBean</code> or simple factory method to create the <code class="literal">JsonObjectMapper</code> with the required characteristics.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ObjectMapperFactory {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> Jackson2JsonObjectMapper getMapper() {
        ObjectMapper mapper = <span class="hl-keyword">new</span> ObjectMapper();
        mapper.configure(JsonParser.Feature.ALLOW_COMMENTS, true);
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> Jackson2JsonObjectMapper(mapper);
    }
}</pre>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"customObjectMapper"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"foo.ObjectMapperFactory"</span>
            <span class="hl-attribute">factory-method</span>=<span class="hl-value">"getMapper"</span><span class="hl-tag">/&gt;</span></pre>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Beginning with <span class="emphasis"><em>version 2.2</em></span>, the <code class="literal">object-to-json-transformer</code> sets the <span class="emphasis"><em>content-type</em></span> header to <code class="literal">application/json</code>, by default, if the input message does not already have that header present.</p>
<p>It you wish to set the <span class="emphasis"><em>content type</em></span> header to some other value, or explicitly overwrite any existing header with some value (including <code class="literal">application/json</code>), use the <code class="literal">content-type</code> attribute.
If you wish to suppress the setting of the header, set the <code class="literal">content-type</code> attribute to an empty string (<code class="literal">""</code>).
This will result in a message with no <code class="literal">content-type</code> header, unless such a header was present on the input message.</p>
</td></tr></table></div>
<p>Beginning with <span class="emphasis"><em>version 3.0</em></span>, the <code class="literal">ObjectToJsonTransformer</code> adds headers, reflecting the source type, to the message.
Similarly, the <code class="literal">JsonToObjectTransformer</code> can use those type headers when converting the JSON to an object.
These headers are mapped in the AMQP adapters so that they are entirely compatible with the Spring-AMQP <a class="ulink" href="http://docs.spring.io/spring-amqp/api/" target="_top">JsonMessageConverter</a>.</p>
<p>This enables the following flows to work without any special configuration&#8230;&#8203;</p>
<p><code class="literal">...-&gt;amqp-outbound-adapter----&gt;</code></p>
<p><code class="literal">----&gt;amqp-inbound-adapter-&gt;json-to-object-transformer-&gt;...</code></p>
<p>Where the outbound adapter is configured with a <code class="literal">JsonMessageConverter</code> and the inbound adapter uses the default <code class="literal">SimpleMessageConverter</code>.</p>
<p><code class="literal">...-&gt;object-to-json-transformer-&gt;amqp-outbound-adapter----&gt;</code></p>
<p><code class="literal">----&gt;amqp-inbound-adapter-&gt;...</code></p>
<p>Where the outbound adapter is configured with a <code class="literal">SimpleMessageConverter</code> and the inbound adapter uses the default <code class="literal">JsonMessageConverter</code>.</p>
<p><code class="literal">...-&gt;object-to-json-transformer-&gt;amqp-outbound-adapter----&gt;</code></p>
<p><code class="literal">----&gt;amqp-inbound-adapter-&gt;json-to-object-transformer-&gt;</code></p>
<p>Where both adapters are configured with a <code class="literal">SimpleMessageConverter</code>.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>When using the headers to determine the type, you should <span class="strong"><strong>not</strong></span> provide a <code class="literal">class</code> attribute, because it takes precedence over the headers.</p>
</td></tr></table></div>
<p>In addition to JSON Transformers, Spring Integration provides a built-in <span class="emphasis"><em>#jsonPath</em></span> SpEL function for use in expressions.
For more information see <a class="xref" href="#spel" title="Appendix&nbsp;A.&nbsp;Spring Expression Language (SpEL)">Appendix&nbsp;A, <i>Spring Expression Language (SpEL)</i></a>.</p>
<p><a name="transformer-xpath-spel-function" href="#transformer-xpath-spel-function"></a><span class="strong"><strong>#xpath SpEL Function</strong></span></p>
<p>Since version <span class="emphasis"><em>3.0</em></span>, Spring Integration also provides a built-in <span class="emphasis"><em>#xpath</em></span> SpEL function for use in expressions.
For more information see <a class="xref" href="#xpath-spel-function" title="35.9&nbsp;#xpath SpEL Function">Section&nbsp;35.9, &#8220;#xpath SpEL Function&#8221;</a>.</p>
<p>Beginning with <span class="emphasis"><em>version 4.0</em></span>, the <code class="literal">ObjectToJsonTransformer</code> supports the <code class="literal">resultType</code> property, to specify the <span class="emphasis"><em>node</em></span> JSON representation.
The result node tree representation depends on the implementation of the provided <code class="literal">JsonObjectMapper</code>.
By default, the <code class="literal">ObjectToJsonTransformer</code> uses a <code class="literal">Jackson2JsonObjectMapper</code> and delegates the conversion of the object to the node tree to the <code class="literal">ObjectMapper#valueToTree</code> method.
The node JSON representation provides efficiency for using the <code class="literal">JsonPropertyAccessor</code>, when the downstream message flow uses SpEL expressions with access to the properties of the JSON data.
See <a class="xref" href="#spel-property-accessors" title="A.4&nbsp;PropertyAccessors">Section&nbsp;A.4, &#8220;PropertyAccessors&#8221;</a>.
When using Boon, the <code class="literal">NODE</code> representation is a <code class="literal">Map&lt;String, Object&gt;</code></p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="transformer-annotation" href="#transformer-annotation"></a>Configuring a Transformer with Annotations</h4></div></div></div>

<p>The <code class="literal">@Transformer</code> annotation can also be added to methods that expect either the <code class="literal">Message</code> type or the message payload type.
The return value will be handled in the exact same way as described above in the section describing the &lt;transformer&gt; element.</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Transformer</span></em>
Order generateOrder(String productId) {
    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> Order(productId);
}</pre>
<p>Transformer methods may also accept the @Header and @Headers annotations that is documented in <a class="xref" href="#annotations" title="F.6&nbsp;Annotation Support">Section&nbsp;F.6, &#8220;Annotation Support&#8221;</a></p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Transformer</span></em>
Order generateOrder(String productId, <em><span class="hl-annotation" style="color: gray">@Header("customerName")</span></em> String customer) {
    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> Order(productId, customer);
}</pre>
<p>Also see <a class="xref" href="#advising-with-annotations" title="8.9.7&nbsp;Advising Endpoints Using Annotations">Section&nbsp;8.9.7, &#8220;Advising Endpoints Using Annotations&#8221;</a>.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="header-filter" href="#header-filter"></a>7.1.3&nbsp;Header Filter</h3></div></div></div>

<p>Some times your transformation use case might be as simple as removing a few headers.
For such a use case, Spring Integration provides a <span class="emphasis"><em>Header Filter</em></span> which allows you to specify certain header names
that should be removed from the output Message (e.g. for security reasons or a value that was only needed temporarily).
Basically, the <span class="emphasis"><em>Header Filter</em></span> is the opposite  of the <span class="emphasis"><em>Header Enricher</em></span>.
The latter is discussed in <a class="xref" href="#header-enricher" title="7.2.2&nbsp;Header Enricher">Section&nbsp;7.2.2, &#8220;Header Enricher&#8221;</a>.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:header-filter</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"inputChannel"</span>
		<span class="hl-attribute">output-channel</span>=<span class="hl-value">"outputChannel"</span> <span class="hl-attribute">header-names</span>=<span class="hl-value">"lastName, state"</span><span class="hl-tag">/&gt;</span></pre>
<p>As you can see, configuration of a <span class="emphasis"><em>Header Filter</em></span> is quite simple.
It is a typical endpoint with input/output channels and a <code class="literal">header-names</code> attribute.
That attribute accepts the names of the header(s) (delimited by commas if there are multiple)
that need to be removed.
So, in the above example the headers named <span class="emphasis"><em>lastName</em></span> and <span class="emphasis"><em>state</em></span> will not be present on the outbound Message.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_codec_based_transformers" href="#_codec_based_transformers"></a>7.1.4&nbsp;Codec-Based Transformers</h3></div></div></div>

<p>See <a class="xref" href="#codec" title="7.4&nbsp;Codec">Section&nbsp;7.4, &#8220;Codec&#8221;</a>.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="content-enricher" href="#content-enricher"></a>7.2&nbsp;Content Enricher</h2></div></div></div>

<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="content-enricher-introduction" href="#content-enricher-introduction"></a>7.2.1&nbsp;Introduction</h3></div></div></div>

<p>At times you may have a requirement to enhance a request with more information than was provided by the target system.
The <a class="ulink" href="http://www.eaipatterns.com/DataEnricher.html" target="_top">Content Enricher</a> pattern describes various scenarios as well as the component (Enricher), which allows you to address such requirements.</p>
<p>The Spring Integration <code class="literal">Core</code> module includes 2 enrichers:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="#header-enricher" title="7.2.2&nbsp;Header Enricher">Header Enricher</a>
</li><li class="listitem">
<a class="link" href="#payload-enricher" title="7.2.3&nbsp;Payload Enricher">Payload Enricher</a>
</li></ul></div>
<p>Furthermore, several <span class="emphasis"><em>Adapter specific Header Enrichers</em></span> are included as well:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="#xml-xpath-header-enricher" title="35.7&nbsp;XPath Header Enricher">XPath Header Enricher (XML Module)</a>
</li><li class="listitem">
<a class="link" href="#mail-namespace" title="21.4&nbsp;Mail Namespace Support">Mail Header Enricher (Mail Module)</a>
</li><li class="listitem">
<a class="link" href="#xmpp-message-outbound-channel-adapter" title="36.3.2&nbsp;Outbound Message Channel Adapter">XMPP Header Enricher (XMPP Module)</a>
</li></ul></div>
<p>Please go to the adapter specific sections of this reference manual to learn more about those adapters.</p>
<p>For more information regarding expressions support, please see <a class="xref" href="#spel" title="Appendix&nbsp;A.&nbsp;Spring Expression Language (SpEL)">Appendix&nbsp;A, <i>Spring Expression Language (SpEL)</i></a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="header-enricher" href="#header-enricher"></a>7.2.2&nbsp;Header Enricher</h3></div></div></div>

<p>If you only need to add headers to a Message, and they are not dynamically determined by the Message content, then referencing a custom implementation of a Transformer may be overkill.
For that reason, Spring Integration provides support for the <span class="emphasis"><em>Header Enricher</em></span> pattern.
It is exposed via the <code class="literal">&lt;header-enricher&gt;</code> element.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:header-enricher</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"in"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"out"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:header</span> <span class="hl-attribute">name</span>=<span class="hl-value">"foo"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"123"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int:header</span> <span class="hl-attribute">name</span>=<span class="hl-value">"bar"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"someBean"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:header-enricher&gt;</span></pre>
<p>The <span class="emphasis"><em>Header Enricher</em></span> also provides helpful sub-elements to set well-known header names.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:header-enricher</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"in"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"out"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:error-channel</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"applicationErrorChannel"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int:reply-channel</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"quoteReplyChannel"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int:correlation-id</span> <span class="hl-attribute">value</span>=<span class="hl-value">"123"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int:priority</span> <span class="hl-attribute">value</span>=<span class="hl-value">"HIGHEST"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;routing-slip</span> <span class="hl-attribute">value</span>=<span class="hl-value">"channel1; routingSlipRoutingStrategy; request.headers[myRoutingSlipChannel]"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int:header</span> <span class="hl-attribute">name</span>=<span class="hl-value">"bar"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"someBean"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:header-enricher&gt;</span></pre>
<p>In the above configuration you can clearly see that for well-known headers such as <code class="literal">errorChannel</code>, <code class="literal">correlationId</code>, <code class="literal">priority</code>, <code class="literal">replyChannel</code>, <code class="literal">routing-slip</code> etc., instead of using generic <span class="emphasis"><em>&lt;header&gt;</em></span> sub-elements where you would have to provide both header <span class="emphasis"><em>name</em></span> and <span class="emphasis"><em>value</em></span>, you can use convenient sub-elements to set those values directly.</p>
<p>Starting with <span class="emphasis"><em>version 4.1</em></span> the <span class="emphasis"><em>Header Enricher</em></span> provides <code class="literal">routing-slip</code> sub-element.
See <a class="xref" href="#routing-slip" title="Routing Slip">the section called &#8220;Routing Slip&#8221;</a> for more information.</p>
<p><span class="strong"><strong>POJO Support</strong></span></p>
<p>Often a header value cannot be defined statically and has to be determined dynamically based on some content in the Message.
That is why <span class="emphasis"><em>Header Enricher</em></span> allows you to also specify a bean reference using the <code class="literal">ref</code> and <code class="literal">method</code> attribute.
The specified method will calculate the header value.
Let&#8217;s look at the following configuration:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:header-enricher</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"in"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"out"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:header</span> <span class="hl-attribute">name</span>=<span class="hl-value">"foo"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"computeValue"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"myBean"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:header-enricher&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myBean"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"foo.bar.MyBean"</span><span class="hl-tag">/&gt;</span></pre>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyBean {

    <span class="hl-keyword">public</span> String computeValue(String payload){
        <span class="hl-keyword">return</span> payload.toUpperCase() + <span class="hl-string">"_US"</span>;
    }
}</pre>
<p>You can also configure your POJO as inner bean:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:header-enricher</span>  <span class="hl-attribute">input-channel</span>=<span class="hl-value">"inputChannel"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"outputChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:header</span> <span class="hl-attribute">name</span>=<span class="hl-value">"some_header"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.MyEnricher"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/int:header&gt;</span>
<span class="hl-tag">&lt;/int:header-enricher&gt;</span></pre>
<p>as well as point to a Groovy script:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:header-enricher</span>  <span class="hl-attribute">input-channel</span>=<span class="hl-value">"inputChannel"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"outputChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:header</span> <span class="hl-attribute">name</span>=<span class="hl-value">"some_header"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;int-groovy:script</span> <span class="hl-attribute">location</span>=<span class="hl-value">"org/SampleGroovyHeaderEnricher.groovy"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/int:header&gt;</span>
<span class="hl-tag">&lt;/int:header-enricher&gt;</span></pre>
<p><span class="strong"><strong>SpEL Support</strong></span></p>
<p>In Spring Integration 2.0 we have introduced the convenience of the <a class="ulink" href="http://docs.spring.io/spring/docs/current/spring-framework-reference/html/expressions.html" target="_top">Spring Expression Language (SpEL)</a> to help configure many different components.
The <span class="emphasis"><em>Header Enricher</em></span> is one of them.
Looking again at the POJO example above, you can see that the computation logic to determine the header value is actually pretty simple.
A natural question would be: "is there a simpler way to accomplish this?".
That is where SpEL shows its true power.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:header-enricher</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"in"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"out"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:header</span> <span class="hl-attribute">name</span>=<span class="hl-value">"foo"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"payload.toUpperCase() + '_US'"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:header-enricher&gt;</span></pre>
<p>As you can see, by using SpEL for such simple cases, we no longer have to provide a separate class and configure it in the application context.
All we need is the <span class="emphasis"><em>expression</em></span> attribute configured with a valid SpEL expression.
The <span class="emphasis"><em>payload</em></span> and <span class="emphasis"><em>headers</em></span> variables are bound to the SpEL Evaluation Context, giving you full access to the incoming Message.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_configuring_a_header_enricher_with_java_configuration" href="#_configuring_a_header_enricher_with_java_configuration"></a>Configuring a Header Enricher with Java Configuration</h4></div></div></div>

<p>The following are some examples of Java Configuration for header enrichers:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<em><span class="hl-annotation" style="color: gray">@Transformer(inputChannel = "enrichHeadersChannel", outputChannel = "emailChannel")</span></em>
<span class="hl-keyword">public</span> HeaderEnricher enrichHeaders() {
    Map&lt;String, ? <span class="hl-keyword">extends</span> HeaderValueMessageProcessor&lt;?&gt;&gt; headersToAdd =
            Collections.singletonMap(<span class="hl-string">"emailUrl"</span>,
                      <span class="hl-keyword">new</span> StaticHeaderValueMessageProcessor&lt;&gt;(<span class="hl-keyword">this</span>.imapUrl));
    HeaderEnricher enricher = <span class="hl-keyword">new</span> HeaderEnricher(headersToAdd);
    <span class="hl-keyword">return</span> enricher;
}

<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<em><span class="hl-annotation" style="color: gray">@Transformer(inputChannel="enrichHeadersChannel", outputChannel="emailChannel")</span></em>
<span class="hl-keyword">public</span> HeaderEnricher enrichHeaders() {
    Map&lt;String, HeaderValueMessageProcessor&lt;?&gt;&gt; headersToAdd = <span class="hl-keyword">new</span> HashMap&lt;&gt;();
    headersToAdd.put(<span class="hl-string">"emailUrl"</span>, <span class="hl-keyword">new</span> StaticHeaderValueMessageProcessor&lt;String&gt;(<span class="hl-keyword">this</span>.imapUrl));
    Expression expression = <span class="hl-keyword">new</span> SpelExpressionParser().parseExpression(<span class="hl-string">"payload.from[0].toString()"</span>);
    headersToAdd.put(<span class="hl-string">"from"</span>,
               <span class="hl-keyword">new</span> ExpressionEvaluatingHeaderValueMessageProcessor&lt;&gt;(expression, String.<span class="hl-keyword">class</span>));
    HeaderEnricher enricher = <span class="hl-keyword">new</span> HeaderEnricher(headersToAdd);
    <span class="hl-keyword">return</span> enricher;
}</pre>
<p>The first adds a single literal header.
The second adds two headers - a literal header and one based on a SpEL expression.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_configuring_a_header_enricher_with_the_java_dsl" href="#_configuring_a_header_enricher_with_the_java_dsl"></a>Configuring a Header Enricher with the Java DSL</h4></div></div></div>

<p>The following is an example of Java DSL Configuration for a header enricher:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> IntegrationFlow enrichHeadersInFlow() {
    <span class="hl-keyword">return</span> f -&gt; f
                ...
                .enrichHeaders(h -&gt; h.header(<span class="hl-string">"emailUrl"</span>, <span class="hl-keyword">this</span>.emailUrl)
                                     .headerExpression(<span class="hl-string">"from"</span>, <span class="hl-string">"payload.from[0].toString()"</span>))
                .handle(...);
}</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="header-channel-registry" href="#header-channel-registry"></a>Header Channel Registry</h4></div></div></div>

<p>Starting with <span class="emphasis"><em>Spring Integration 3.0</em></span>, a new sub-element <code class="literal">&lt;int:header-channels-to-string/&gt;</code> is available; it has no attributes.
This converts existing <code class="literal">replyChannel</code> and <code class="literal">errorChannel</code> headers (when they are a <code class="literal">MessageChannel</code>) to a String and stores the channel(s) in a registry for later resolution when it is time to send a reply, or handle an error.
This is useful for cases where the headers might be lost; for example when serializing a message into a message store or when transporting the message over JMS.
If the header does not already exist, or it is not a <code class="literal">MessageChannel</code>, no changes are made.</p>
<p>Use of this functionality requires the presence of a <code class="literal">HeaderChannelRegistry</code> bean.
By default, the framework creates a <code class="literal">DefaultHeaderChannelRegistry</code> with the default expiry (60 seconds).
Channels are removed from the registry after this time.
To change this, simply define a bean with id <code class="literal">integrationHeaderChannelRegistry</code> and configure the required default delay using a constructor argument (milliseconds).</p>
<p>Since <span class="emphasis"><em>version 4.1</em></span>, you can set a property <code class="literal">removeOnGet</code> to <code class="literal">true</code> on the <code class="literal">&lt;bean/&gt;</code> definition, and the mapping entry will be removed immediately on first use.
This might be useful in a high-volume environment and when the channel is only used once, rather than waiting for the reaper to remove it.</p>
<p>The <code class="literal">HeaderChannelRegistry</code> has a <code class="literal">size()</code> method to determine the current size of the registry.
The <code class="literal">runReaper()</code> method cancels the current scheduled task and runs the reaper immediately; the task is then scheduled to run again based on the current delay.
These methods can be invoked directly by getting a reference to the registry, or you can send a message with, for example, the following content to a control bus:</p>
<pre class="screen">"@integrationHeaderChannelRegistry.runReaper()"</pre>
<p>This sub-element is a convenience only, and is the equivalent of specifying:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:reply-channel</span>
    <span class="hl-attribute">expression</span>=<span class="hl-value">"@integrationHeaderChannelRegistry.channelToChannelName(headers.replyChannel)"</span>
    <span class="hl-attribute">overwrite</span>=<span class="hl-value">"true"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;int:error-channel</span>
    <span class="hl-attribute">expression</span>=<span class="hl-value">"@integrationHeaderChannelRegistry.channelToChannelName(headers.errorChannel)"</span>
    <span class="hl-attribute">overwrite</span>=<span class="hl-value">"true"</span><span class="hl-tag"> /&gt;</span></pre>
<p>Starting with <span class="emphasis"><em>version 4.1</em></span>, you can now override the registry&#8217;s configured reaper delay, so the the channel mapping is retained for at least the specified time, regardless of the reaper delay:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:header-enricher</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"inputTtl"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"next"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:header-channels-to-string</span> <span class="hl-attribute">time-to-live-expression</span>=<span class="hl-value">"120000"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/int:header-enricher&gt;</span>

<span class="hl-tag">&lt;int:header-enricher</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"inputCustomTtl"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"next"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:header-channels-to-string</span>
        <span class="hl-attribute">time-to-live-expression</span>=<span class="hl-value">"headers['channelTTL'] ?: 120000"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/int:header-enricher&gt;</span></pre>
<p>In the first case, the time to live for every header channel mapping will be 2 minutes; in the second case, the time to live is specified in the message header and uses an elvis operator to use 2 minutes if there is no header.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="payload-enricher" href="#payload-enricher"></a>7.2.3&nbsp;Payload Enricher</h3></div></div></div>

<p>In certain situations the Header Enricher, as discussed above, may not be sufficient and payloads themselves may have to be enriched with additional information.
For example, order messages that enter the Spring Integration messaging system have to look up the order&#8217;s customer based on the provided customer number and then enrich the original payload with that information.</p>
<p>Since Spring Integration 2.1, the Payload Enricher is provided.
A Payload Enricher defines an endpoint that passes a <code class="literal">Message</code> to the exposed request channel and then expects a reply message.
The reply message then becomes the root object for evaluation of expressions to enrich the target payload.</p>
<p>The Payload Enricher provides full XML namespace support via the <code class="literal">enricher</code> element.
In order to send request messages, the payload enricher has a <code class="literal">request-channel</code> attribute that allows you to dispatch messages to a request channel.</p>
<p>Basically by defining the request channel, the Payload Enricher acts as a Gateway, waiting for the message that were sent to the request channel to return, and the Enricher then augments the message&#8217;s payload with the data provided by the reply message.</p>
<p>When sending messages to the request channel you also have the option to only send a subset of the original payload using the <code class="literal">request-payload-expression</code> attribute.</p>
<p>The enriching of payloads is configured through SpEL expressions, providing users with a maximum degree of flexibility.
Therefore, users are not only able to enrich payloads with direct values from the reply channel&#8217;s <code class="literal">Message</code>, but they can use SpEL expressions to extract a subset from that Message, only, or to apply addtional inline transformations, allowing them to further manipulate the data.</p>
<p>If you only need to enrich payloads with static values, you don&#8217;t have to provide the <code class="literal">request-channel</code> attribute.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Enrichers are a variant of Transformers and in many cases you could use a Payload Enricher or a generic Transformer implementation to add additional data to your messages payloads.
Thus, familiarize yourself with all transformation-capable components that are provided by Spring Integration and carefully select the implementation that semantically fits your business case best.</p>
</td></tr></table></div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="payload-enricher-configuration" href="#payload-enricher-configuration"></a>Configuration</h4></div></div></div>

<p>Below, please find an overview of all available configuration options that are available for the payload enricher:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:enricher</span> <span class="hl-attribute">request-channel</span>=<span class="hl-value">""</span>                           <a name="CO8-1" href="#CO8-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
              auto-startup="true"                          <a name="CO8-2" href="#CO8-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
              id=""                                        <a name="CO8-3" href="#CO8-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
              order=""                                     <a name="CO8-4" href="#CO8-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
              output-channel=""                            <a name="CO8-5" href="#CO8-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
              request-payload-expression=""                <a name="CO8-6" href="#CO8-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>
              reply-channel=""                             <a name="CO8-7" href="#CO8-7"></a><span><img src="images/callouts/7.png" alt="7" border="0"></span>
              error-channel=""                             <a name="CO8-8" href="#CO8-8"></a><span><img src="images/callouts/8.png" alt="8" border="0"></span>
              send-timeout=""                              <a name="CO8-9" href="#CO8-9"></a><span><img src="images/callouts/9.png" alt="9" border="0"></span>
              should-clone-payload="false"&gt;                <a name="CO8-10" href="#CO8-10"></a><span><img src="images/callouts/10.png" alt="10" border="0"></span>
    <span class="hl-tag">&lt;int:poller&gt;</span><span class="hl-tag">&lt;/int:poller&gt;</span>                              <a name="CO8-11" href="#CO8-11"></a><span><img src="images/callouts/11.png" alt="11" border="0"></span>
    <span class="hl-tag">&lt;int:property</span> <span class="hl-attribute">name</span>=<span class="hl-value">""</span> <span class="hl-attribute">expression</span>=<span class="hl-value">""</span> <span class="hl-attribute">null-result-expression</span>=<span class="hl-value">"'Could not determine the name'"</span><span class="hl-tag">/&gt;</span>   <a name="CO8-12" href="#CO8-12"></a><span><img src="images/callouts/12.png" alt="12" border="0"></span>
    <span class="hl-tag">&lt;int:property</span> <span class="hl-attribute">name</span>=<span class="hl-value">""</span> <span class="hl-attribute">value</span>=<span class="hl-value">"23"</span> <span class="hl-attribute">type</span>=<span class="hl-value">"java.lang.Integer"</span> <span class="hl-attribute">null-result-expression</span>=<span class="hl-value">"'0'"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int:header</span> <span class="hl-attribute">name</span>=<span class="hl-value">""</span> <span class="hl-attribute">expression</span>=<span class="hl-value">""</span> <span class="hl-attribute">null-result-expression</span>=<span class="hl-value">""</span><span class="hl-tag">/&gt;</span>   <a name="CO8-13" href="#CO8-13"></a><span><img src="images/callouts/13.png" alt="13" border="0"></span>
    <span class="hl-tag">&lt;int:header</span> <span class="hl-attribute">name</span>=<span class="hl-value">""</span> <span class="hl-attribute">value</span>=<span class="hl-value">""</span> <span class="hl-attribute">overwrite</span>=<span class="hl-value">""</span> <span class="hl-attribute">type</span>=<span class="hl-value">""</span> <span class="hl-attribute">null-result-expression</span>=<span class="hl-value">""</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:enricher&gt;</span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO8-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Channel to which a Message will be sent to get the data to use for enrichment.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO8-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Lifecycle attribute signaling if this component should be started during Application Context startup.
Defaults to true.<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO8-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Id of the underlying bean definition, which is either an <code class="literal">EventDrivenConsumer</code> or a <code class="literal">PollingConsumer</code>.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO8-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Specifies the order for invocation when this endpoint is connected as a subscriber to a channel.
This is particularly relevant when that channel is using a "failover" dispatching strategy.
It has no effect when this endpoint itself is a Polling Consumer for a channel with a queue.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO8-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Identifies the Message channel where a Message will be sent after it is being processed by this endpoint.<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO8-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>By default the original message&#8217;s payload will be used as payload that will be send to the <code class="literal">request-channel</code>.
By specifying a SpEL expression as value for the <code class="literal">request-payload-expression</code> attribute, a subset of the original payload, a header value or any other resolvable SpEL expression can be used as the basis for the payload, that will be sent to the request-channel.
For the Expression evaluation the full message is available as the <span class="emphasis"><em>root object</em></span>.
For instance the following SpEL expressions (among others) are possible:
<code class="literal">payload.foo</code>,
<code class="literal">headers.foobar</code>,
<code class="literal">new java.util.Date()</code>,
<code class="literal">'foo' + 'bar'</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO8-7"><span><img src="images/callouts/7.png" alt="7" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Channel where a reply Message is expected.
This is optional; typically the auto-generated temporary reply channel is sufficient.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO8-8"><span><img src="images/callouts/8.png" alt="8" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Channel to which an <code class="literal">ErrorMessage</code> will be sent if an <code class="literal">Exception</code> occurs downstream of the <code class="literal">request-channel</code>.
This enables you to return an alternative object to use for enrichment.
This is optional; if it is not set then <code class="literal">Exception</code> is thrown to the caller.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO8-9"><span><img src="images/callouts/9.png" alt="9" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Maximum amount of time in milliseconds to wait when sending a message to the channel, if such channel may block.
For example, a Queue Channel can block until space is available, if its maximum capacity has been reached.
Internally the send timeout is set on the <code class="literal">MessagingTemplate</code> and ultimately applied when invoking the send operation on the <code class="literal">MessageChannel</code>.
By default the send timeout is set to <span class="emphasis"><em>-1</em></span>, which may cause the send operation on the <code class="literal">MessageChannel</code>, depending on the implementation, to block indefinitely.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO8-10"><span><img src="images/callouts/10.png" alt="10" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Boolean value indicating whether any payload that implements <code class="literal">Cloneable</code> should be cloned prior to sending the Message to the request chanenl for acquiring the enriching data.
The cloned version would be used as the target payload for the ultimate reply.
Default is <code class="literal">false</code>.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO8-11"><span><img src="images/callouts/11.png" alt="11" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Allows you to configure a Message Poller if this endpoint is a Polling Consumer.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO8-12"><span><img src="images/callouts/12.png" alt="12" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Each <code class="literal">property</code> sub-element provides the name of a property (via the mandatory <code class="literal">name</code> attribute).
That property should be settable on the target payload instance.
Exactly one of the <code class="literal">value</code> or <code class="literal">expression</code> attributes must be provided as well.
The former for a literal value to set, and the latter for a SpEL expression to be evaluated.
The root object of the evaluation context is the Message that was returned from the flow initiated by this enricher, the input Message if there is no request channel, or the application context (using the <span class="emphasis"><em>@&lt;beanName&gt;.&lt;beanProperty&gt;</em></span> SpEL syntax).
Starting with <span class="emphasis"><em>4.0</em></span>, when specifying a <code class="literal">value</code> attribute, you can also specify an optional <code class="literal">type</code> attribute.
When the destination is a typed setter method, the framework will coerce the value appropriately (as long as a <code class="literal">PropertyEditor</code>) exists to handle the conversion.
If however, the target payload is a <code class="literal">Map</code> the entry will be populated with the value without conversion.
The <code class="literal">type</code> attribute allows you to, say, convert a String containing a number to an <code class="literal">Integer</code> value in the target payload.
Starting with <span class="emphasis"><em>4.1</em></span>, you can also specify an optional <code class="literal">null-result-expression</code> attribute.
When the <code class="literal">enricher</code> returns null, it will be evaluated and the output of the evaluation will be returned instead.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO8-13"><span><img src="images/callouts/13.png" alt="13" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Each <code class="literal">header</code> sub-element provides the name of a Message header (via the mandatory <code class="literal">name</code> attribute).
Exactly one of the <code class="literal">value</code> or <code class="literal">expression</code> attributes must be provided as well.
The former for a literal value to set, and the latter for a SpEL expression to be evaluated.
The root object of the evaluation context is the Message that was returned from the flow initiated by this enricher, the input Message if there is no request channel, or the application context (using the <span class="emphasis"><em>@&lt;beanName&gt;.&lt;beanProperty&gt;</em></span> SpEL syntax).
Note, similar to the <code class="literal">&lt;header-enricher&gt;</code>, the <code class="literal">&lt;enricher&gt;</code>'s <code class="literal">header</code> element has <code class="literal">type</code> and <code class="literal">overwrite</code> attributes.
However, a difference is that, with the <code class="literal">&lt;enricher&gt;</code>, the <code class="literal">overwrite</code> attribute is <code class="literal">true</code> by default, to be consistent with <code class="literal">&lt;enricher&gt;</code>'s <code class="literal">&lt;property&gt;</code> sub-element.
Starting with <span class="emphasis"><em>4.1</em></span>, you can also specify an optional <code class="literal">null-result-expression</code> attribute.
When the <code class="literal">enricher</code> returns null, it will be evaluated and the output of the evaluation will be returned instead.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="payload-enricher-examples" href="#payload-enricher-examples"></a>Examples</h4></div></div></div>

<p>Below, please find several examples of using a Payload Enricher in various situations.</p>
<p>In the following example, a <code class="literal">User</code> object is passed as the payload of the <code class="literal">Message</code>.
The <code class="literal">User</code> has several properties but only the <code class="literal">username</code> is set initially.
The Enricher&#8217;s <code class="literal">request-channel</code> attribute below is configured to pass the <code class="literal">User</code> on to the <code class="literal">findUserServiceChannel</code>.</p>
<p>Through the implicitly set <code class="literal">reply-channel</code> a <code class="literal">User</code> object is returned and using the <code class="literal">property</code> sub-element, properties from the reply are extracted and used to enrich the original payload.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:enricher</span> <span class="hl-attribute">id</span>=<span class="hl-value">"findUserEnricher"</span>
              <span class="hl-attribute">input-channel</span>=<span class="hl-value">"findUserEnricherChannel"</span>
              <span class="hl-attribute">request-channel</span>=<span class="hl-value">"findUserServiceChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"email"</span>    <span class="hl-attribute">expression</span>=<span class="hl-value">"payload.email"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int:property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"password"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"payload.password"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:enricher&gt;</span></pre>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The code samples shown here, are part of the <span class="emphasis"><em>Spring
              Integration Samples</em></span> project.
Please feel free to check it out at:null</p>
</td></tr></table></div>
<p><span class="emphasis"><em>How do I pass only a subset of data to the request channel?</em></span></p>
<p>Using a <code class="literal">request-payload-expression</code> attribute a single property of the payload can be passed on to the request channel instead of the full message.
In the example below on the username property is passed on to the request channel.
Keep in mind, that although only the username is passed on, the resulting message send to the request channel will contain the full set of <code class="literal">MessageHeaders</code>.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:enricher</span> <span class="hl-attribute">id</span>=<span class="hl-value">"findUserByUsernameEnricher"</span>
              <span class="hl-attribute">input-channel</span>=<span class="hl-value">"findUserByUsernameEnricherChannel"</span>
              <span class="hl-attribute">request-channel</span>=<span class="hl-value">"findUserByUsernameServiceChannel"</span>
              <span class="hl-attribute">request-payload-expression</span>=<span class="hl-value">"payload.username"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"email"</span>    <span class="hl-attribute">expression</span>=<span class="hl-value">"payload.email"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int:property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"password"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"payload.password"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:enricher&gt;</span></pre>
<p><span class="emphasis"><em>How can I enrich payloads that consist of Collection data?</em></span></p>
<p>In the following example, instead of a <code class="literal">User</code> object, a <code class="literal">Map</code> is passed in.
The <code class="literal">Map</code> contains the username under the map key <code class="literal">username</code>.
Only the <code class="literal">username</code> is passed on to the request channel.
The reply contains a full <code class="literal">User</code> object, which is ultimately added to the <code class="literal">Map</code> under the <code class="literal">user</code> key.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:enricher</span> <span class="hl-attribute">id</span>=<span class="hl-value">"findUserWithMapEnricher"</span>
              <span class="hl-attribute">input-channel</span>=<span class="hl-value">"findUserWithMapEnricherChannel"</span>
              <span class="hl-attribute">request-channel</span>=<span class="hl-value">"findUserByUsernameServiceChannel"</span>
              <span class="hl-attribute">request-payload-expression</span>=<span class="hl-value">"payload.username"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"user"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"payload"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:enricher&gt;</span></pre>
<p><span class="emphasis"><em>How can I enrich payloads with static information without using a request channel?</em></span></p>
<p>Here is an example that does not use a request channel at all, but solely enriches the message&#8217;s payload with static values.
But please be aware that the word <span class="emphasis"><em>static</em></span> is used loosely here.
You can still use SpEL expressions for setting those values.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:enricher</span> <span class="hl-attribute">id</span>=<span class="hl-value">"userEnricher"</span>
              <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"user.updateDate"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"new java.util.Date()"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int:property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"user.firstName"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"foo"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int:property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"user.lastName"</span>  <span class="hl-attribute">value</span>=<span class="hl-value">"bar"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int:property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"user.age"</span>       <span class="hl-attribute">value</span>=<span class="hl-value">"42"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:enricher&gt;</span></pre>
</div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="claim-check" href="#claim-check"></a>7.3&nbsp;Claim Check</h2></div></div></div>

<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="claim-check-introduction" href="#claim-check-introduction"></a>7.3.1&nbsp;Introduction</h3></div></div></div>

<p>In the earlier sections we&#8217;ve covered several Content Enricher type components that help you deal with situations where a message is missing a piece of data.
We also discussed Content Filtering which lets you remove data items from a message.
However there are times when we want to hide data temporarily.
For example, in a distributed system we may receive a Message with a very large payload.
Some intermittent message processing steps may not need access to this payload and some may only need to access certain headers, so carrying the large Message payload through each processing step may cause performance degradation, may produce a security risk, and may make debugging more difficult.</p>
<p>The <a class="ulink" href="http://www.eaipatterns.com/StoreInLibrary.html" target="_top">Claim Check</a> pattern describes a mechanism that allows you to store data in a well known place while only maintaining a pointer (Claim Check) to where that data is located.
You can pass that pointer around as a payload of a new Message thereby allowing any component within the message flow to get the actual data as soon as it needs it.
This approach is very similar to the Certified Mail process where you&#8217;ll get a Claim Check in your mailbox and would have to go to the Post Office to claim your actual package.
Of course it&#8217;s also the same idea as baggage-claim on a flight or in a hotel.</p>
<p>Spring Integration provides two types of Claim Check transformers:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="emphasis"><em>Incoming Claim Check Transformer</em></span>
</li><li class="listitem">
<span class="emphasis"><em>Outgoing Claim Check Transformer</em></span>
</li></ul></div>
<p>Convenient namespace-based mechanisms are available to configure them.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="claim-check-in" href="#claim-check-in"></a>7.3.2&nbsp;Incoming Claim Check Transformer</h3></div></div></div>

<p>An <span class="emphasis"><em>Incoming Claim Check Transformer</em></span> will transform an incoming Message by storing it in the Message Store identified by its <code class="literal">message-store</code> attribute.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:claim-check-in</span> <span class="hl-attribute">id</span>=<span class="hl-value">"checkin"</span>
        <span class="hl-attribute">input-channel</span>=<span class="hl-value">"checkinChannel"</span>
        <span class="hl-attribute">message-store</span>=<span class="hl-value">"testMessageStore"</span>
        <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span><span class="hl-tag">/&gt;</span></pre>
<p>In the above configuration the Message that is received on the <code class="literal">input-channel</code> will be persisted to the Message Store identified with the <code class="literal">message-store</code> attribute and indexed with generated ID.
That ID is the Claim Check for that Message.
The Claim Check will also become the payload of the new (transformed) Message that will be sent to the <code class="literal">output-channel</code>.</p>
<p>Now, lets assume that at some point you do need access to the actual Message.
You can of course access the Message Store manually and get the contents of the Message, or you can use the same approach as before except now you will be transforming the Claim Check to the actual Message by using an <span class="emphasis"><em>Outgoing Claim Check Transformer</em></span>.</p>
<p>Here is an overview of all available parameters of an Incoming Claim Check Transformer:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:claim-check-in</span> <span class="hl-attribute">auto-startup</span>=<span class="hl-value">"true"</span>  <a name="CO9-1" href="#CO9-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
                    id=""                           <a name="CO9-2" href="#CO9-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
                    input-channel=""                <a name="CO9-3" href="#CO9-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
                    message-store="messageStore"    <a name="CO9-4" href="#CO9-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
                    order=""                        <a name="CO9-5" href="#CO9-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
                    output-channel=""               <a name="CO9-6" href="#CO9-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>
                    send-timeout=""&gt;                <a name="CO9-7" href="#CO9-7"></a><span><img src="images/callouts/7.png" alt="7" border="0"></span>
    <span class="hl-tag">&lt;int:poller&gt;</span><span class="hl-tag">&lt;/int:poller&gt;</span>                       <a name="CO9-8" href="#CO9-8"></a><span><img src="images/callouts/8.png" alt="8" border="0"></span>
<span class="hl-tag">&lt;/int:claim-check-in&gt;</span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO9-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Lifecycle attribute signaling if this component should be started during Application Context startup.
Defaults to true.
Attribute is not available inside a <code class="literal">Chain</code> element.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO9-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Id identifying the underlying bean definition (<code class="literal">MessageTransformingHandler</code>).
Attribute is not available inside a <code class="literal">Chain</code> element.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO9-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The receiving Message channel of this endpoint.
Attribute is not available inside a <code class="literal">Chain</code> element.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO9-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Reference to the MessageStore to be used by this Claim Check transformer.
If not specified, the default reference will be to a bean named <span class="emphasis"><em>messageStore</em></span>.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO9-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Specifies the order for invocation when this endpoint is connected as a subscriber to a channel.
This is particularly relevant when that channel is using a <span class="emphasis"><em>failover</em></span> dispatching strategy.
It has no effect when this endpoint itself is a Polling Consumer for a channel with a queue.
Attribute is not available inside a <code class="literal">Chain</code> element.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO9-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Identifies the Message channel where Message will be sent after its being processed by this endpoint.
Attribute is not available inside a <code class="literal">Chain</code> element.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO9-7"><span><img src="images/callouts/7.png" alt="7" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Specify the maximum amount of time in milliseconds to wait when sending a reply Message to the output channel.
Defaults to <code class="literal">-1</code> - blocking indefinitely.
Attribute is not available inside a <code class="literal">Chain</code> element.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO9-8"><span><img src="images/callouts/8.png" alt="8" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Defines a poller.
Element is not available inside a <code class="literal">Chain</code> element.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="claim-check-out" href="#claim-check-out"></a>7.3.3&nbsp;Outgoing Claim Check Transformer</h3></div></div></div>

<p>An <span class="emphasis"><em>Outgoing Claim Check Transformer</em></span> allows you to transform a Message with a Claim Check payload into a Message with the original content as its payload.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:claim-check-out</span> <span class="hl-attribute">id</span>=<span class="hl-value">"checkout"</span>
        <span class="hl-attribute">input-channel</span>=<span class="hl-value">"checkoutChannel"</span>
        <span class="hl-attribute">message-store</span>=<span class="hl-value">"testMessageStore"</span>
        <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span><span class="hl-tag">/&gt;</span></pre>
<p>In the above configuration, the Message that is received on the <code class="literal">input-channel</code> should have a Claim Check as its payload and the <span class="emphasis"><em>Outgoing Claim Check Transformer</em></span> will transform it into a Message with the original payload by simply querying the Message store for a Message identified by the provided Claim Check.
It then sends the newly checked-out Message to the <code class="literal">output-channel</code>.</p>
<p>Here is an overview of all available parameters of an Outgoing Claim Check Transformer:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:claim-check-out</span> <span class="hl-attribute">auto-startup</span>=<span class="hl-value">"true"</span>  <a name="CO10-1" href="#CO10-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
                     id=""                           <a name="CO10-2" href="#CO10-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
                     input-channel=""                <a name="CO10-3" href="#CO10-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
                     message-store="messageStore"    <a name="CO10-4" href="#CO10-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
                     order=""                        <a name="CO10-5" href="#CO10-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
                     output-channel=""               <a name="CO10-6" href="#CO10-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>
                     remove-message="false"          <a name="CO10-7" href="#CO10-7"></a><span><img src="images/callouts/7.png" alt="7" border="0"></span>
                     send-timeout=""&gt;                <a name="CO10-8" href="#CO10-8"></a><span><img src="images/callouts/8.png" alt="8" border="0"></span>
    <span class="hl-tag">&lt;int:poller&gt;</span><span class="hl-tag">&lt;/int:poller&gt;</span>                        <a name="CO10-9" href="#CO10-9"></a><span><img src="images/callouts/9.png" alt="9" border="0"></span>
<span class="hl-tag">&lt;/int:claim-check-out&gt;</span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO10-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Lifecycle attribute signaling if this component should be started during Application Context startup.
Defaults to true.
Attribute is not available inside a <code class="literal">Chain</code> element.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO10-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Id identifying the underlying bean definition (<code class="literal">MessageTransformingHandler</code>).
Attribute is not available inside a <code class="literal">Chain</code> element.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO10-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The receiving Message channel of this endpoint.
Attribute is not available inside a <code class="literal">Chain</code> element.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO10-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Reference to the MessageStore to be used by this Claim Check transformer.
If not specified, the default reference will be to a bean named <span class="emphasis"><em>messageStore</em></span>.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO10-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Specifies the order for invocation when this endpoint is connected as a subscriber to a channel.
This is particularly relevant when that channel is using a <span class="emphasis"><em>failover</em></span> dispatching strategy.
It has no effect when this endpoint itself is a Polling Consumer for a channel with a queue.
Attribute is not available inside a <code class="literal">Chain</code> element.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO10-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Identifies the Message channel where Message will be sent after its being processed by this endpoint.
Attribute is not available inside a <code class="literal">Chain</code> element.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO10-7"><span><img src="images/callouts/7.png" alt="7" border="0"></span></a> </p></td><td valign="top" align="left">
<p>If set to <code class="literal">true</code> the Message will be removed from the MessageStore by this transformer.
Useful when Message can be "claimed" only once.
Defaults to <code class="literal">false</code>.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO10-8"><span><img src="images/callouts/8.png" alt="8" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Specify the maximum amount of time in milliseconds to wait when sending a reply Message to the output channel.
Defaults to <code class="literal">-1</code> - blocking indefinitely.
Attribute is not available inside a <code class="literal">Chain</code> element.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO10-9"><span><img src="images/callouts/9.png" alt="9" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Defines a poller.
Element is not available inside a <code class="literal">Chain</code> element.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr></table></div>
<p><span class="emphasis"><em>Claim Once</em></span></p>
<p>There are scenarios when a particular message must be claimed only once.
As an analogy, consider the airplane luggage check-in/out process.
Checking-in your luggage on departure and and then claiming it on arrival is a classic example of such a scenario.
Once the luggage has been claimed, it can not be claimed again without first checking it back in.
To accommodate such cases, we introduced a <code class="literal">remove-message</code> boolean attribute on the <code class="literal">claim-check-out</code> transformer.
This attribute is set to <code class="literal">false</code> by default.
However, if set to <code class="literal">true</code>, the claimed Message will be removed from the MessageStore, so that it can no longer be claimed again.</p>
<p>This is also something to consider in terms of storage space, especially in the case of the in-memory Map-based <code class="literal">SimpleMessageStore</code>, where failing to remove the Messages could ultimately lead to an <code class="literal">OutOfMemoryException</code>.
Therefore, if you don&#8217;t expect multiple claims to be made, it&#8217;s recommended that you set the <code class="literal">remove-message</code> attribute&#8217;s value to <code class="literal">true</code>.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:claim-check-out</span> <span class="hl-attribute">id</span>=<span class="hl-value">"checkout"</span>
        <span class="hl-attribute">input-channel</span>=<span class="hl-value">"checkoutChannel"</span>
        <span class="hl-attribute">message-store</span>=<span class="hl-value">"testMessageStore"</span>
        <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span>
        <span class="hl-attribute">remove-message</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_a_word_on_message_store" href="#_a_word_on_message_store"></a>7.3.4&nbsp;A word on Message Store</h3></div></div></div>

<p>Although we rarely care about the details of the claim checks as long as they work, it is still worth knowing that the current implementation of the actual Claim Check (the pointer) in Spring Integration is a UUID to ensure uniqueness.</p>
<p><code class="literal">org.springframework.integration.store.MessageStore</code> is a strategy interface for storing and retrieving messages.
Spring Integration provides two convenient implementations of it.
<code class="literal">SimpleMessageStore</code>: an in-memory, Map-based implementation (the default, good for testing) and <code class="literal">JdbcMessageStore</code>: an implementation that uses a relational database via JDBC.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="codec" href="#codec"></a>7.4&nbsp;Codec</h2></div></div></div>

<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_introduction_2" href="#_introduction_2"></a>7.4.1&nbsp;Introduction</h3></div></div></div>

<p>Spring Integration <span class="emphasis"><em>version 4.2</em></span> introduces the <code class="literal">Codec</code> abstraction.
Codecs are used to encode/decode objects to/from <code class="literal">byte[]</code>.
They are an alternative to Java Serialization.
One advantage is, typically, objects do not have to implement <code class="literal">Serializable</code>.
One implementation, using <a class="ulink" href="https://github.com/EsotericSoftware/kryo" target="_top">Kryo</a> for serialization, is provided but you
can provide your own implementation for use in any of these components:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">EncodingPayloadTransformer</code>
</li><li class="listitem">
<code class="literal">DecodingTransformer</code>
</li><li class="listitem">
<code class="literal">CodecMessageConverter</code>
</li></ul></div>
<p>See their JavaDocs for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_encodingpayloadtransformer" href="#_encodingpayloadtransformer"></a>7.4.2&nbsp;EncodingPayloadTransformer</h3></div></div></div>

<p>This transformer encodes the payload to a <code class="literal">byte[]</code> using the codec.
It does not affect message headers.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_decodingtransformer" href="#_decodingtransformer"></a>7.4.3&nbsp;DecodingTransformer</h3></div></div></div>

<p>This transformer decodes a <code class="literal">byte[]</code> using the codec; it needs to be configured with the Class to which the object
should be decoded (or an expression that resolves to a Class).
If the resulting object is a <code class="literal">Message&lt;?&gt;</code>, inbound headers will not be retained.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_codecmessageconverter" href="#_codecmessageconverter"></a>7.4.4&nbsp;CodecMessageConverter</h3></div></div></div>

<p>Certain endpoints (e.g. TCP, Redis) have no concept of message headers; they support the use of a
<code class="literal">MessageConverter</code> and the <code class="literal">CodecMessageConverter</code> can be used to convert a message to/from a <code class="literal">byte[]</code> for
transmission.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_kryo" href="#_kryo"></a>7.4.5&nbsp;Kryo</h3></div></div></div>

<p>Currently, this is the only implementation of <code class="literal">Codec</code>.
There are two <code class="literal">Codec</code> s - <code class="literal">PojoCodec</code> which can be used in the transformers and <code class="literal">MessageCodec</code> which can be used
in the <code class="literal">CodecMessageConverter</code>.</p>
<p>Several custom serializers are provided by the framework:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">FileSerializer</code>
</li><li class="listitem">
<code class="literal">MessageHeadersSerializer</code>
</li><li class="listitem">
<code class="literal">MutableMessageHeadersSerializer</code>
</li></ul></div>
<p>The first can be used with the <code class="literal">PojoCodec</code>, by initializing it with the <code class="literal">FileKryoRegistrar</code>.
The second and third are used with the <code class="literal">MessageCodec</code>, which is initialized with the <code class="literal">MessageKryoRegistrar</code>.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_customizing_kryo" href="#_customizing_kryo"></a>Customizing Kryo</h4></div></div></div>

<p>By default, Kryo delegates unknown Java types to its <code class="literal">FieldSerializer</code>.
Kryo also registers default serializers for each primitive type along with <code class="literal">String</code>, <code class="literal">Collection</code> and <code class="literal">Map</code> serializers.
<code class="literal">FieldSerializer</code> uses reflection to navigate the object graph. A more efficient approach is to implement a custom
serializer that is aware of the object&#8217;s structure and can directly serialize selected primitive fields:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> AddressSerializer <span class="hl-keyword">extends</span> Serializer&lt;Address&gt; {

    <em><span class="hl-annotation" style="color: gray">@Override</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> write(Kryo kryo, Output output, Address address) {
        output.writeString(address.getStreet());
        output.writeString(address.getCity());
        output.writeString(address.getCountry());
    }

    <em><span class="hl-annotation" style="color: gray">@Override</span></em>
    <span class="hl-keyword">public</span> Address read(Kryo kryo, Input input, Class&lt;Address&gt; type) {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> Address(input.readString(), input.readString(), input.readString());
    }
}</pre>
<p>The <code class="literal">Serializer</code> interface exposes <code class="literal">Kryo</code>, <code class="literal">Input</code>, and <code class="literal">Output</code> which provide
complete control over which fields are included and other internal settings as
described in the <a class="ulink" href="https://github.com/EsotericSoftware/kryo" target="_top">documentation</a>.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>When registering your custom serializer, you need a registration ID.
The registration IDs are arbitrary but in our case must be explicitly defined because each Kryo instance across the
distributed application must use the same IDs.
Kryo recommends small positive integers, and reserves a few ids (value &lt; 10).
Spring Integration currently defaults to using 40, 41 and 42 (for the file and message header serializers mentioned
above); we recommend you start at, say 60, to allow for expansion in the framework.
These framework defaults can be overridden by configuring the registrars mentioned above.</p>
</td></tr></table></div>
<div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="_using_a_custom_kryo_serializer" href="#_using_a_custom_kryo_serializer"></a>Using a Custom Kryo Serializer</h5></div></div></div>

<p>If custom serialization is indicated, please consult the <a class="ulink" href="https://github.com/EsotericSoftware/kryo" target="_top">Kryo</a> documentation
since you will be using the native API.
For an example, see the <code class="literal">MessageCodec</code>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="_implementing_kryoserializable" href="#_implementing_kryoserializable"></a>Implementing KryoSerializable</h5></div></div></div>

<p>If you have write access to the domain object source code it may implement <code class="literal">KryoSerializable</code> as described
<a class="ulink" href="https://github.com/EsotericSoftware/kryo#kryoserializable" target="_top">here</a>.
In this case
the class provides the serialization methods itself and no further configuration
is required. This has the advantage of being much simpler to use
with XD, however benchmarks have shown this is not quite as efficient as
registering a custom serializer explicitly:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> Address <span class="hl-keyword">implements</span> KryoSerializable {
    ...

    <em><span class="hl-annotation" style="color: gray">@Override</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> write(Kryo kryo, Output output) {
        output.writeString(<span class="hl-keyword">this</span>.street);
        output.writeString(<span class="hl-keyword">this</span>.city);
        output.writeString(<span class="hl-keyword">this</span>.country);
    }

    <em><span class="hl-annotation" style="color: gray">@Override</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> read(Kryo kryo, Input input) {
        <span class="hl-keyword">this</span>.street = input.readString();
        <span class="hl-keyword">this</span>.city = input.readString();
        <span class="hl-keyword">this</span>.country = input.readString();
    }
}</pre>
<p>Note that this technique can also be used to wrap a serialization library other than Kryo.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="_using_defaultserializer_annotation" href="#_using_defaultserializer_annotation"></a>Using DefaultSerializer Annotation</h5></div></div></div>

<p>Kryo also provides an annotation as described <a class="ulink" href="https://github.com/EsotericSoftware/kryo#default-serializers" target="_top">here</a>.</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@DefaultSerializer(SomeClassSerializer.class)</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> SomeClass {
       <span class="hl-comment">// ...</span>
}</pre>
<p>If you have write access to the domain object this may be a simpler alternative to specify a custom serializer.
Note this does not register the class with an ID, so your mileage may vary.</p>
</div>
</div>
</div>
</div>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="messaging-endpoints-chapter" href="#messaging-endpoints-chapter"></a>8.&nbsp;Messaging Endpoints</h2></div></div></div>

<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="endpoint" href="#endpoint"></a>8.1&nbsp;Message Endpoints</h2></div></div></div>

<p>The first part of this chapter covers some background theory and reveals quite a bit about the underlying API that drives Spring Integration&#8217;s various messaging components.
This information can be helpful if you want to really understand what&#8217;s going on behind the scenes.
However, if you want to get up and running with the simplified namespace-based configuration of the various elements, feel free to skip ahead to<a class="xref" href="#endpoint-namespace" title="8.1.4&nbsp;Namespace Support">Section&nbsp;8.1.4, &#8220;Namespace Support&#8221;</a> for now.</p>
<p>As mentioned in the overview, Message Endpoints are responsible for connecting the various messaging components to channels.
Over the next several chapters, you will see a number of different components that consume Messages.
Some of these are also capable of sending reply Messages.
Sending Messages is quite straightforward.
As shown above in <a class="xref" href="#channel" title="4.1&nbsp;Message Channels">Section&nbsp;4.1, &#8220;Message Channels&#8221;</a>, it&#8217;s easy to <span class="emphasis"><em>send</em></span> a Message to a Message Channel.
However, receiving is a bit more complicated.
The main reason is that there are two types of consumers: <a class="ulink" href="http://www.eaipatterns.com/PollingConsumer.html" target="_top">Polling Consumers</a> and <a class="ulink" href="http://www.eaipatterns.com/EventDrivenConsumer.html" target="_top">Event Driven Consumers</a>.</p>
<p>Of the two, Event Driven Consumers are much simpler.
Without any need to manage and schedule a separate poller thread, they are essentially just listeners with a callback method.
When connecting to one of Spring Integration&#8217;s subscribable Message Channels, this simple option works great.
However, when connecting to a buffering, pollable Message Channel, some component has to schedule and manage the polling thread(s).
Spring Integration provides two different endpoint implementations to accommodate these two types of consumers.
Therefore, the consumers themselves can simply implement the callback interface.
When polling is required, the endpoint acts as a <span class="emphasis"><em>container</em></span> for the consumer instance.
The benefit is similar to that of using a container for hosting Message Driven Beans, but since these consumers are simply Spring-managed Objects running within an ApplicationContext, it more closely resembles Spring&#8217;s own MessageListener containers.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="endpoint-handler" href="#endpoint-handler"></a>8.1.1&nbsp;Message Handler</h3></div></div></div>

<p>Spring Integration&#8217;s <code class="literal">MessageHandler</code> interface is implemented by many of the components within the framework.
In other words, this is not part of the public API, and a developer would not typically implement <code class="literal">MessageHandler</code> directly.
Nevertheless, it is used by a Message Consumer for actually handling the consumed Messages, and so being aware of this strategy interface does help in terms of understanding the overall role of a consumer.
The interface is defined as follows:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> MessageHandler {

    <span class="hl-keyword">void</span> handleMessage(Message&lt;?&gt; message);

}</pre>
<p>Despite its simplicity, this provides the foundation for most of the components that will be covered in the following chapters (Routers, Transformers, Splitters, Aggregators, Service Activators, etc).
Those components each perform very different functionality with the Messages they handle, but the requirements for actually receiving a Message are the same, and the choice between polling and event-driven behavior is also the same.
Spring Integration provides two endpoint implementations that <span class="emphasis"><em>host</em></span> these callback-based handlers and allow them to be connected to Message Channels.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="endpoint-eventdrivenconsumer" href="#endpoint-eventdrivenconsumer"></a>8.1.2&nbsp;Event Driven Consumer</h3></div></div></div>

<p>Because it is the simpler of the two, we will cover the Event Driven Consumer endpoint first.
You may recall that the <code class="literal">SubscribableChannel</code> interface provides a <code class="literal">subscribe()</code> method and that the method accepts a <code class="literal">MessageHandler</code> parameter (as shown in <a class="xref" href="#channel-interfaces-subscribablechannel" title="SubscribableChannel">the section called &#8220;SubscribableChannel&#8221;</a>):</p>
<pre class="programlisting">subscribableChannel.subscribe(messageHandler);</pre>
<p>Since a handler that is subscribed to a channel does not have to actively poll that channel, this is an Event Driven Consumer, and the implementation provided by Spring Integration accepts a a <code class="literal">SubscribableChannel</code> and a <code class="literal">MessageHandler</code>:</p>
<pre class="programlisting">SubscribableChannel channel = context.getBean(<span class="hl-string">"subscribableChannel"</span>, SubscribableChannel.<span class="hl-keyword">class</span>);

EventDrivenConsumer consumer = <span class="hl-keyword">new</span> EventDrivenConsumer(channel, exampleHandler);</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="endpoint-pollingconsumer" href="#endpoint-pollingconsumer"></a>8.1.3&nbsp;Polling Consumer</h3></div></div></div>

<p>Spring Integration also provides a <code class="literal">PollingConsumer</code>, and it can be instantiated in the same way except that the channel must implement <code class="literal">PollableChannel</code>:</p>
<pre class="programlisting">PollableChannel channel = context.getBean(<span class="hl-string">"pollableChannel"</span>, PollableChannel.<span class="hl-keyword">class</span>);

PollingConsumer consumer = <span class="hl-keyword">new</span> PollingConsumer(channel, exampleHandler);</pre>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>For more information regarding Polling Consumers, please also read <a class="xref" href="#polling-consumer" title="4.2&nbsp;Poller">Section&nbsp;4.2, &#8220;Poller&#8221;</a> as well as <a class="xref" href="#channel-adapter" title="4.3&nbsp;Channel Adapter">Section&nbsp;4.3, &#8220;Channel Adapter&#8221;</a>.</p>
</td></tr></table></div>
<p>There are many other configuration options for the Polling Consumer.
For example, the trigger is a required property:</p>
<pre class="programlisting">PollingConsumer consumer = <span class="hl-keyword">new</span> PollingConsumer(channel, handler);

consumer.setTrigger(<span class="hl-keyword">new</span> IntervalTrigger(<span class="hl-number">30</span>, TimeUnit.SECONDS));</pre>
<p>Spring Integration currently provides two implementations of the <code class="literal">Trigger</code> interface: <code class="literal">IntervalTrigger</code> and <code class="literal">CronTrigger</code>.
The <code class="literal">IntervalTrigger</code> is typically defined with a simple interval (in milliseconds), but also supports an <span class="emphasis"><em>initialDelay</em></span> property and a boolean <span class="emphasis"><em>fixedRate</em></span> property (the default is false, i.e.
fixed delay):</p>
<pre class="programlisting">IntervalTrigger trigger = <span class="hl-keyword">new</span> IntervalTrigger(<span class="hl-number">1000</span>);
trigger.setInitialDelay(<span class="hl-number">5000</span>);
trigger.setFixedRate(true);</pre>
<p>The <code class="literal">CronTrigger</code> simply requires a valid cron expression (see the Javadoc for details):</p>
<pre class="programlisting">CronTrigger trigger = <span class="hl-keyword">new</span> CronTrigger(<span class="hl-string">"*/10 * * * * MON-FRI"</span>);</pre>
<p>In addition to the trigger, several other polling-related configuration properties may be specified:</p>
<pre class="programlisting">PollingConsumer consumer = <span class="hl-keyword">new</span> PollingConsumer(channel, handler);

consumer.setMaxMessagesPerPoll(<span class="hl-number">10</span>);
consumer.setReceiveTimeout(<span class="hl-number">5000</span>);</pre>
<p>The <span class="emphasis"><em>maxMessagesPerPoll</em></span> property specifies the maximum number of messages to receive within a given poll operation.
This means that the poller will continue calling receive() <span class="emphasis"><em>without waiting</em></span> until either <code class="literal">null</code> is returned or that max is reached.
For example, if a poller has a 10 second interval trigger and a <span class="emphasis"><em>maxMessagesPerPoll</em></span> setting of 25, and it is polling a channel that has 100 messages in its queue, all 100 messages can be retrieved within 40 seconds.
It grabs 25, waits 10 seconds, grabs the next 25, and so on.</p>
<p>The <span class="emphasis"><em>receiveTimeout</em></span> property specifies the amount of time the poller should wait if no messages are available when it invokes the receive operation.
For example, consider two options that seem similar on the surface but are actually quite different: the first has an interval trigger of 5 seconds and a receive timeout of 50 milliseconds while the second has an interval trigger of 50 milliseconds and a receive timeout of 5 seconds.
The first one may receive a message up to 4950 milliseconds later than it arrived on the channel (if that message arrived immediately after one of its poll calls returned).
On the other hand, the second configuration will never miss a message by more than 50 milliseconds.
The difference is that the second option requires a thread to wait, but as a result it is able to respond much more quickly to arriving messages.
This technique, known as <span class="emphasis"><em>long polling</em></span>, can be used to emulate event-driven behavior on a polled source.</p>
<p>A Polling Consumer may also delegate to a Spring <code class="literal">TaskExecutor</code>, as illustrated in the following example:</p>
<pre class="programlisting">PollingConsumer consumer = <span class="hl-keyword">new</span> PollingConsumer(channel, handler);

TaskExecutor taskExecutor = context.getBean(<span class="hl-string">"exampleExecutor"</span>, TaskExecutor.<span class="hl-keyword">class</span>);
consumer.setTaskExecutor(taskExecutor);</pre>
<p>Furthermore, a <code class="literal">PollingConsumer</code> has a property called <span class="emphasis"><em>adviceChain</em></span>.
This property allows you to specify a <code class="literal">List</code> of AOP Advices for handling additional cross cutting concerns including transactions.
These advices are applied around the <code class="literal">doPoll()</code> method.
For more in-depth information, please see the sections <span class="emphasis"><em>AOP Advice chains</em></span> and <span class="emphasis"><em>Transaction Support</em></span> under <a class="xref" href="#endpoint-namespace" title="8.1.4&nbsp;Namespace Support">Section&nbsp;8.1.4, &#8220;Namespace Support&#8221;</a>.</p>
<p>The examples above show dependency lookups, but keep in mind that these consumers will most often be configured as Spring <span class="emphasis"><em>bean definitions</em></span>.
In fact, Spring Integration also provides a <code class="literal">FactoryBean</code> called <code class="literal">ConsumerEndpointFactoryBean</code> that creates the appropriate consumer type based on the type of channel, and there is full XML namespace support to even further hide those details.
The namespace-based configuration will be featured as each component type is introduced.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Many of the <code class="literal">MessageHandler</code> implementations are also capable of generating reply Messages.
As mentioned above, sending Messages is trivial when compared to the Message reception.
Nevertheless,<span class="emphasis"><em>when</em></span> and <span class="emphasis"><em>how many</em></span> reply Messages are sent depends on the handler type.
For example, an <span class="emphasis"><em>Aggregator</em></span> waits for a number of Messages to arrive and is often configured as a downstream consumer for a <span class="emphasis"><em>Splitter</em></span> which may generate multiple replies for each Message it handles.
When using the namespace configuration, you do not strictly need to know all of the details, but it still might be worth knowing that several of these components share a common base class, the <code class="literal">AbstractReplyProducingMessageHandler</code>, and it provides a <code class="literal">setOutputChannel(..)</code> method.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="endpoint-namespace" href="#endpoint-namespace"></a>8.1.4&nbsp;Namespace Support</h3></div></div></div>

<p>Throughout the reference manual, you will see specific configuration examples for endpoint elements, such as router, transformer, service-activator, and so on.
Most of these will support an <span class="emphasis"><em>input-channel</em></span> attribute and many will support an <span class="emphasis"><em>output-channel</em></span> attribute.
After being parsed, these endpoint elements produce an instance of either the <code class="literal">PollingConsumer</code> or the <code class="literal">EventDrivenConsumer</code> depending on the type of the <span class="emphasis"><em>input-channel</em></span> that is referenced: <code class="literal">PollableChannel</code> or <code class="literal">SubscribableChannel</code> respectively.
When the channel is pollable, then the polling behavior is determined based on the endpoint element&#8217;s <span class="emphasis"><em>poller</em></span> sub-element and its attributes.</p>
<p><span class="emphasis"><em>Configuration_Below you find a _poller</em></span> with all available configuration options:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">cron</span>=<span class="hl-value">""</span>                                  <a name="CO11-1" href="#CO11-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
            default="false"                          <a name="CO11-2" href="#CO11-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
            error-channel=""                         <a name="CO11-3" href="#CO11-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
            fixed-delay=""                           <a name="CO11-4" href="#CO11-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
            fixed-rate=""                            <a name="CO11-5" href="#CO11-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
            id=""                                    <a name="CO11-6" href="#CO11-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>
            max-messages-per-poll=""                 <a name="CO11-7" href="#CO11-7"></a><span><img src="images/callouts/7.png" alt="7" border="0"></span>
            receive-timeout=""                       <a name="CO11-8" href="#CO11-8"></a><span><img src="images/callouts/8.png" alt="8" border="0"></span>
            ref=""                                   <a name="CO11-9" href="#CO11-9"></a><span><img src="images/callouts/9.png" alt="9" border="0"></span>
            task-executor=""                         <a name="CO11-10" href="#CO11-10"></a><span><img src="images/callouts/10.png" alt="10" border="0"></span>
            time-unit="MILLISECONDS"                 <a name="CO11-11" href="#CO11-11"></a><span><img src="images/callouts/11.png" alt="11" border="0"></span>
            trigger=""&gt;                              <a name="CO11-12" href="#CO11-12"></a><span><img src="images/callouts/12.png" alt="12" border="0"></span>
            <span class="hl-tag">&lt;int:advice-chain /&gt;</span>                     <a name="CO11-13" href="#CO11-13"></a><span><img src="images/callouts/13.png" alt="13" border="0"></span>
            <span class="hl-tag">&lt;int:transactional /&gt;</span>                    <a name="CO11-14" href="#CO11-14"></a><span><img src="images/callouts/14.png" alt="14" border="0"></span>
<span class="hl-tag">&lt;/int:poller&gt;</span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO11-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Provides the ability to configure Pollers using Cron expressions.
The underlying implementation uses an <code class="literal">org.springframework.scheduling.support.CronTrigger</code>.
If this attribute is set, none of the following attributes must be specified: <code class="literal">fixed-delay</code>, <code class="literal">trigger</code>, <code class="literal">fixed-rate</code>, <code class="literal">ref</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO11-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>By setting this attribute to <span class="emphasis"><em>true</em></span>, it is possible to define exactly one (1) global default poller.
An exception is raised if more than one default poller is defined in the application context.
Any endpoints connected to a PollableChannel (PollingConsumer) or any SourcePollingChannelAdapter that does not have any explicitly configured poller will then use the global default Poller.
<span class="emphasis"><em>Optional</em></span>.
Defaults to <code class="literal">false</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO11-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Identifies the channel which error messages will be sent to if a failure occurs in this poller&#8217;s invocation.
To completely suppress Exceptions, provide a reference to the <code class="literal">nullChannel</code>.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO11-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The fixed delay trigger uses a <code class="literal">PeriodicTrigger</code> under the covers.
If the <code class="literal">time-unit</code> attribute is not used, the specified value is represented in milliseconds.
If this attribute is set, none of the following attributes must be specified: <code class="literal">fixed-rate</code>, <code class="literal">trigger</code>, <code class="literal">cron</code>, <code class="literal">ref</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO11-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The fixed rate trigger uses a <code class="literal">PeriodicTrigger</code> under the covers.
If the <code class="literal">time-unit</code> attribute is not used the specified value is represented in milliseconds.
If this attribute is set, none of the following attributes must be specified: <code class="literal">fixed-delay</code>, <code class="literal">trigger</code>, <code class="literal">cron</code>, <code class="literal">ref</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO11-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The Id referring to the Poller&#8217;s underlying bean-definition, which is of type <code class="literal">org.springframework.integration.scheduling.PollerMetadata</code>.
The <span class="emphasis"><em>id</em></span> attribute is required for a top-level poller element unless it is the default poller (<code class="literal">default="true"</code>).</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO11-7"><span><img src="images/callouts/7.png" alt="7" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Please see <a class="xref" href="#channel-adapter-namespace-inbound" title="4.3.1&nbsp;Configuring An Inbound Channel Adapter">Section&nbsp;4.3.1, &#8220;Configuring An Inbound Channel Adapter&#8221;</a> for more information.
<span class="emphasis"><em>Optional</em></span>.
If not specified the default values used depends on the context.
If a <code class="literal">PollingConsumer</code> is used, this atribute will default to <span class="emphasis"><em>-1</em></span>.
However, if a <code class="literal">SourcePollingChannelAdapter</code> is used, then the <code class="literal">max-messages-per-poll</code> attribute defaults to <span class="emphasis"><em>1</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO11-8"><span><img src="images/callouts/8.png" alt="8" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Value is set on the underlying class `PollerMetadata`<span class="emphasis"><em>Optional</em></span>.
If not specified it defaults to 1000 (milliseconds).</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO11-9"><span><img src="images/callouts/9.png" alt="9" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Bean reference to another top-level poller.
The <code class="literal">ref</code> attribute must not be present on the top-level <code class="literal">poller</code> element.
However, if this attribute is set, none of the following attributes must be specified: <code class="literal">fixed-rate</code>, <code class="literal">trigger</code>, <code class="literal">cron</code>, <code class="literal">fixed-delay</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO11-10"><span><img src="images/callouts/10.png" alt="10" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Provides the ability to reference a custom <span class="emphasis"><em>task executor</em></span>.
Please see the section below titled <span class="emphasis"><em>TaskExecutor Support</em></span> for further information.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO11-11"><span><img src="images/callouts/11.png" alt="11" border="0"></span></a> </p></td><td valign="top" align="left">
<p>This attribute specifies the <code class="literal">java.util.concurrent.TimeUnit</code> enum value on the underlying <code class="literal">org.springframework.scheduling.support.PeriodicTrigger</code>.
Therefore, this attribute can <span class="emphasis"><em>ONLY</em></span> be used in combination with the <code class="literal">fixed-delay</code> or <code class="literal">fixed-rate</code> attributes.
If combined with either <code class="literal">cron</code> or a <code class="literal">trigger</code> reference attribute, it will cause a failure.
The minimal supported granularity for a <code class="literal">PeriodicTrigger</code> is MILLISECONDS.
Therefore, the only available options are MILLISECONDS and SECONDS.
If this value is not provided, then any <code class="literal">fixed-delay</code> or <code class="literal">fixed-rate</code> value will be interpreted as MILLISECONDS by default.
Basically this enum provides a convenience for SECONDS-based interval trigger values.
For hourly, daily, and monthly settings, consider using a <code class="literal">cron</code> trigger instead.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO11-12"><span><img src="images/callouts/12.png" alt="12" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Reference to any spring configured bean which implements the <code class="literal">org.springframework.scheduling.Trigger</code> interface.
<span class="emphasis"><em>Optional</em></span>.
However, if this attribute is set, none of the following attributes must be specified:<code class="literal">fixed-delay</code>, <code class="literal">fixed-rate</code>, <code class="literal">cron</code>, <code class="literal">ref</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO11-13"><span><img src="images/callouts/13.png" alt="13" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Allows to specify extra AOP Advices to handle additional cross cutting concerns.
Please see the section below titled <span class="emphasis"><em>Transaction Support</em></span> for further information.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO11-14"><span><img src="images/callouts/14.png" alt="14" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Pollers can be made transactional.
Please see the section below titled <span class="emphasis"><em>AOP Advice chains</em></span> for further information.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr></table></div>
<p><span class="emphasis"><em>Examples</em></span></p>
<p>For example, a simple interval-based poller with a 1-second interval would be configured like this:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:transformer</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"pollable"</span>
    <span class="hl-attribute">ref</span>=<span class="hl-value">"transformer"</span>
    <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"1000"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:transformer&gt;</span></pre>
<p>As an alternative to <span class="emphasis"><em>fixed-rate</em></span> you can also use the <span class="emphasis"><em>fixed-delay</em></span> attribute.</p>
<p>For a poller based on a Cron expression, use the <span class="emphasis"><em>cron</em></span> attribute instead:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:transformer</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"pollable"</span>
    <span class="hl-attribute">ref</span>=<span class="hl-value">"transformer"</span>
    <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">cron</span>=<span class="hl-value">"*/10 * * * * MON-FRI"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:transformer&gt;</span></pre>
<p>If the input channel is a <code class="literal">PollableChannel</code>, then the poller configuration is required.
Specifically, as mentioned above, the <span class="emphasis"><em>trigger</em></span> is a required property of the PollingConsumer class.
Therefore, if you omit the <span class="emphasis"><em>poller</em></span> sub-element for a Polling Consumer endpoint&#8217;s configuration, an Exception may be thrown.
The exception will also be thrown if you attempt to configure a poller on the element that is connected to a non-pollable channel.</p>
<p>It is also possible to create top-level pollers in which case only a <span class="emphasis"><em>ref</em></span> is required:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">id</span>=<span class="hl-value">"weekdayPoller"</span> <span class="hl-attribute">cron</span>=<span class="hl-value">"*/10 * * * * MON-FRI"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int:transformer</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"pollable"</span>
    <span class="hl-attribute">ref</span>=<span class="hl-value">"transformer"</span>
    <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"weekdayPoller"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:transformer&gt;</span></pre>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The <span class="emphasis"><em>ref</em></span> attribute is only allowed on the inner-poller definitions.
Defining this attribute on a top-level poller will result in a configuration exception thrown during initialization of the Application Context.</p>
</td></tr></table></div>
<p><span class="emphasis"><em>Global Default Pollers</em></span></p>
<p>In fact, to simplify the configuration even further, you can define a global default poller.
A single top-level poller within an ApplicationContext may have the <code class="literal">default</code> attribute with a value of <span class="emphasis"><em>true</em></span>.
In that case, any endpoint with a PollableChannel for its input-channel that is defined within the same ApplicationContext and has no explicitly configured <span class="emphasis"><em>poller</em></span> sub-element will use that default.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">id</span>=<span class="hl-value">"defaultPoller"</span> <span class="hl-attribute">default</span>=<span class="hl-value">"true"</span> <span class="hl-attribute">max-messages-per-poll</span>=<span class="hl-value">"5"</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"3000"</span><span class="hl-tag">/&gt;</span>

<span class="hl-comment">&lt;!-- No &lt;poller/&gt; sub-element is necessary since there is a default --&gt;</span>
<span class="hl-tag">&lt;int:transformer</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"pollable"</span>
                 <span class="hl-attribute">ref</span>=<span class="hl-value">"transformer"</span>
                 <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span><span class="hl-tag">/&gt;</span></pre>
<p><span class="emphasis"><em>Transaction Support</em></span></p>
<p>Spring Integration also provides transaction support for the pollers so that each receive-and-forward operation can be performed as an atomic unit-of-work.
To configure transactions for a poller, simply add the_&lt;transactional/&gt;_ sub-element.
The attributes for this element should be familiar to anyone who has experience with Spring&#8217;s Transaction management:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">fixed-delay</span>=<span class="hl-value">"1000"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:transactional</span> <span class="hl-attribute">transaction-manager</span>=<span class="hl-value">"txManager"</span>
                       <span class="hl-attribute">propagation</span>=<span class="hl-value">"REQUIRED"</span>
                       <span class="hl-attribute">isolation</span>=<span class="hl-value">"REPEATABLE_READ"</span>
                       <span class="hl-attribute">timeout</span>=<span class="hl-value">"10000"</span>
                       <span class="hl-attribute">read-only</span>=<span class="hl-value">"false"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:poller&gt;</span></pre>
<p>For more information please refer to <a class="xref" href="#transaction-poller" title="C.1.1&nbsp;Poller Transaction Support">Section&nbsp;C.1.1, &#8220;Poller Transaction Support&#8221;</a>.</p>
<p><span class="emphasis"><em>AOP Advice chains</em></span></p>
<p>Since Spring transaction support depends on the Proxy mechanism &nbsp;with <code class="literal">TransactionInterceptor</code> (AOP Advice) handling transactional behavior of the message flow initiated by the poller, some times there is a need to provide extra Advice(s) to handle other cross cutting behavior associated with the poller.
For that poller defines an <span class="emphasis"><em>advice-chain</em></span>&nbsp;element allowing you to add more advices - class that &nbsp;implements <code class="literal">MethodInterceptor</code> interface&#8230;&#8203;</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:service-activator</span> <span class="hl-attribute">id</span>=<span class="hl-value">"advicedSa"</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"goodInputWithAdvice"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"testBean"</span>
		<span class="hl-attribute">method</span>=<span class="hl-value">"good"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span><span class="hl-tag">&gt;</span>
	<span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">max-messages-per-poll</span>=<span class="hl-value">"1"</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"10000"</span><span class="hl-tag">&gt;</span>
		 <span class="hl-tag">&lt;int:advice-chain&gt;</span>
			<span class="hl-tag">&lt;ref</span> <span class="hl-attribute">bean</span>=<span class="hl-value">"adviceA"</span><span class="hl-tag"> /&gt;</span>
			<span class="hl-tag">&lt;beans:bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.bar.SampleAdvice"</span><span class="hl-tag"> /&gt;</span>
			<span class="hl-tag">&lt;ref</span> <span class="hl-attribute">bean</span>=<span class="hl-value">"txAdvice"</span><span class="hl-tag"> /&gt;</span>
		<span class="hl-tag">&lt;/int:advice-chain&gt;</span>
	<span class="hl-tag">&lt;/int:poller&gt;</span>
<span class="hl-tag">&lt;/int:service-activator&gt;</span></pre>
<p>For more information on how to implement MethodInterceptor please refer to AOP sections of Spring reference manual (section 8 and 9).
Advice chain can also be applied on the poller that does not have any transaction configuration essentially allowing you to enhance the behavior of the message flow initiated by the poller.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>When using an advice chain, the <code class="literal">&lt;transactional/&gt;</code> child element cannot be specified; instead, declare a <code class="literal">&lt;tx:advice/&gt;</code> bean and add it to the <code class="literal">&lt;advice-chain/&gt;</code>.
See <a class="xref" href="#transaction-poller" title="C.1.1&nbsp;Poller Transaction Support">Section&nbsp;C.1.1, &#8220;Poller Transaction Support&#8221;</a> for complete configuration.</p>
</td></tr></table></div>
<p><span class="emphasis"><em>TaskExecutor Support</em></span></p>
<p>The polling threads may be executed by any instance of Spring&#8217;s <code class="literal">TaskExecutor</code> abstraction.
This enables concurrency for an endpoint or group of endpoints.
As of Spring 3.0, there is a <span class="emphasis"><em>task</em></span> namespace in the core Spring Framework, and its &lt;executor/&gt; element supports the creation of a simple thread pool executor.
That element accepts attributes for common concurrency settings such as pool-size and queue-capacity.
Configuring a thread-pooling executor can make a substantial difference in how the endpoint performs under load.
These settings are available per-endpoint since the performance of an endpoint is one of the major factors to consider (the other major factor being the expected volume on the channel to which the endpoint subscribes).
To enable concurrency for a polling endpoint that is configured with the XML namespace support, provide the <span class="emphasis"><em>task-executor</em></span> reference on its &lt;poller/&gt; element and then provide one or more of the properties shown below:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">task-executor</span>=<span class="hl-value">"pool"</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"1000"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;task:executor</span> <span class="hl-attribute">id</span>=<span class="hl-value">"pool"</span>
               <span class="hl-attribute">pool-size</span>=<span class="hl-value">"5-25"</span>
               <span class="hl-attribute">queue-capacity</span>=<span class="hl-value">"20"</span>
               <span class="hl-attribute">keep-alive</span>=<span class="hl-value">"120"</span><span class="hl-tag">/&gt;</span></pre>
<p>If no <span class="emphasis"><em>task-executor</em></span> is provided, the consumer&#8217;s handler will be invoked in the caller&#8217;s thread.
Note that the <span class="emphasis"><em>caller</em></span> is usually the default <code class="literal">TaskScheduler</code> (see <a class="xref" href="#namespace-taskscheduler" title="F.3&nbsp;Configuring the Task Scheduler">Section&nbsp;F.3, &#8220;Configuring the Task Scheduler&#8221;</a>).
Also, keep in mind that the <span class="emphasis"><em>task-executor</em></span> attribute can provide a reference to any implementation of Spring&#8217;s <code class="literal">TaskExecutor</code> interface by specifying the bean name.
The <span class="emphasis"><em>executor</em></span> element above is simply provided for convenience.</p>
<p>As mentioned in the background section for Polling Consumers above, you can also configure a Polling Consumer in such a way as to emulate event-driven behavior.
With a long receive-timeout and a short interval-trigger, you can ensure a very timely reaction to arriving messages even on a polled message source.
Note that this will only apply to sources that have a blocking wait call with a timeout.
For example, the File poller does not block, each receive() call returns immediately and either contains new files or not.
Therefore, even if a poller contains a long receive-timeout, that value would never be usable in such a scenario.
On the other hand when using Spring Integration&#8217;s own queue-based channels, the timeout value does have a chance to participate.
The following example demonstrates how a Polling Consumer will receive Messages nearly instantaneously.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:service-activator</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"someQueueChannel"</span>
    <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">receive-timeout</span>=<span class="hl-value">"30000"</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"10"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;/int:service-activator&gt;</span></pre>
<p>Using this approach does not carry much overhead since internally it is nothing more then a timed-wait thread which does not require nearly as much CPU resource usage as a thrashing, infinite while loop for example.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="polling-consumer-change-polling-rate" href="#polling-consumer-change-polling-rate"></a>8.1.5&nbsp;Change Polling Rate at Runtime</h3></div></div></div>

<p>When configuring Pollers with a <code class="literal">fixed-delay</code> or <code class="literal">fixed-rate</code> attribute, the default implementation will use a <code class="literal">PeriodicTrigger</code> instance.
The <code class="literal">PeriodicTrigger</code> is part of the Core Spring Framework and it accepts the <span class="emphasis"><em>interval</em></span> as a constructor argument, only.
Therefore it cannot be changed at runtime.</p>
<p>However, you can define your own implementation of the <code class="literal">org.springframework.scheduling.Trigger</code> interface.
You could even use the PeriodicTrigger as a starting point.
Then, you can add a setter for the interval (period), or you could even embed your own throttling logic within the trigger itself if desired.
The <span class="emphasis"><em>period</em></span> property will be used with each call to <span class="emphasis"><em>nextExecutionTime</em></span> to schedule the next poll.
To use this custom trigger within pollers, declare the bean definition of the custom Trigger in your application context and inject the dependency into your Poller configuration using the <code class="literal">trigger</code> attribute, which references the custom Trigger bean instance.
You can now obtain a reference to the Trigger bean and the polling interval can be changed between polls.</p>
<p>For an example, please see the Spring Integration Samples project.
It contains a sample called <span class="emphasis"><em>dynamic-poller</em></span>, which uses a custom Trigger and demonstrates the ability to change the polling interval at runtime.</p>
<p><a class="ulink" href="https://github.com/SpringSource/spring-integration-samples/tree/master/intermediate" target="_top">https://github.com/SpringSource/spring-integration-samples/tree/master/intermediate</a></p>
<p>The sample provides a custom Trigger which implements the <span class="emphasis"><em><a class="ulink" href="http://static.springsource.org/spring/docs/current/javadoc-api/org/springframework/scheduling/Trigger.html" target="_top">org.springframework.scheduling.Trigger</a></em></span> interface.
The sample&#8217;s Trigger is based on Spring&#8217;s <a class="ulink" href="http://static.springsource.org/spring/docs/current/javadoc-api/org/springframework/scheduling/support/PeriodicTrigger.html" target="_top">PeriodicTrigger</a> implementation.
However, the fields of the custom trigger are not final and the properties have explicit getters and setters, allowing to dynamically change the polling period at runtime.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>It is important to note, though, that because the Trigger method is <span class="emphasis"><em>nextExecutionTime()</em></span>, any changes to a dynamic trigger will not take effect until the next poll, based on the existing configuration.
It is not possible to force a trigger to fire before it&#8217;s currently configured next execution time.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="payload-type-conversion" href="#payload-type-conversion"></a>8.1.6&nbsp;Payload Type Conversion</h3></div></div></div>

<p>Throughout the reference manual, you will also see specific configuration and implementation examples of various endpoints which can accept a Message or&nbsp;any arbitrary Object as an input parameter.
In the case of an Object, such a parameter will be mapped to&nbsp;a Message payload or part of the payload or header (when using the Spring Expression Language).
However there are times when the type of input parameter of the endpoint method does not match the type of the payload or its part.
In this scenario we need to perform type conversion.
Spring Integration provides a convenient way for registering type converters (using the Spring 3.x ConversionService) within its own instance of a conversion service bean named <span class="emphasis"><em>integrationConversionService</em></span>.
That bean is automatically created as soon as the first converter is defined using the Spring Integration infrastructure.
To register a Converter all you need is to implement <code class="literal">org.springframework.core.convert.converter.Converter</code>, <code class="literal">org.springframework.core.convert.converter.GenericConverter</code> or <code class="literal">org.springframework.core.convert.converter.ConverterFactory</code>.</p>
<p>The <code class="literal">Converter</code> implementation is the simplest and converts from a single type to another.
For more sophistication, such as converting to a class hierarchy, you would implement a <code class="literal">GenericConverter</code> and possibly a <code class="literal">ConditionalConverter</code>.
These give you complete access to the <span class="emphasis"><em>from</em></span> and <span class="emphasis"><em>to</em></span> type descriptors enabling complex conversions.
For example, if you have an abstract class <code class="literal">Foo</code> that is the target of your conversion (parameter type, channel data type etc) and you have two concrete implementations <code class="literal">Bar</code> and <code class="literal">Baz</code> and you wish to convert to one or the other based on the input type, the <code class="literal">GenericConverter</code> would be a good fit.
Refer to the JavaDocs for these interfaces for more information.</p>
<p>When you have implemented your converter, you can register it with convenient namespace support:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:converter</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"sampleConverter"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"sampleConverter"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"foo.bar.TestConverter"</span><span class="hl-tag">/&gt;</span></pre>
<p>or as an inner bean:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:converter&gt;</span>
    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.config.xml.ConverterParserTests$TestConverter3"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:converter&gt;</span></pre>
<p>Starting with <span class="emphasis"><em>Spring Integration 4.0</em></span>, the above configuration is available using annotations:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Component</span></em>
<em><span class="hl-annotation" style="color: gray">@IntegrationConverter</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> TestConverter <span class="hl-keyword">implements</span> Converter&lt;Boolean, Number&gt; {

	<span class="hl-keyword">public</span> Number convert(Boolean source) {
		<span class="hl-keyword">return</span> source ? <span class="hl-number">1</span> : <span class="hl-number">0</span>;
	}

}</pre>
<p>or as a <code class="literal">@Configuration</code> part:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Configuration</span></em>
<em><span class="hl-annotation" style="color: gray">@EnableIntegration</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ContextConfiguration {

	<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
	<em><span class="hl-annotation" style="color: gray">@IntegrationConverter</span></em>
	<span class="hl-keyword">public</span> SerializingConverter serializingConverter() {
		<span class="hl-keyword">return</span> <span class="hl-keyword">new</span> SerializingConverter();
	}

}</pre>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>When configuring an <span class="emphasis"><em>Application Context</em></span>, the Spring Framework allows you to add a <span class="emphasis"><em>conversionService</em></span> bean (see <a class="ulink" href="http://static.springsource.org/spring/docs/current/spring-framework-reference/html/validation.html#core-convert-Spring-config" target="_top">Configuring a ConversionService</a> chapter).
This service is used, when needed, to perform appropriate conversions during bean creation and configuration.</p>
<p>In contrast, the <span class="emphasis"><em>integrationConversionService</em></span> is used for runtime conversions.
These uses are quite different; converters that are intended for use when wiring bean constructor-args and properties may produce unintended results if used at runtime for Spring Integration expression evaluation against Messages within Datatype Channels, Payload Type transformers etc.</p>
<p>However, if you do want to use the Spring <span class="emphasis"><em>conversionService</em></span> as the Spring Integration <span class="emphasis"><em>integrationConversionService</em></span>, you can configure an <span class="emphasis"><em>alias</em></span> in the Application Context:</p>
<pre class="programlisting"><span class="hl-tag">&lt;alias</span> <span class="hl-attribute">name</span>=<span class="hl-value">"conversionService"</span> <span class="hl-attribute">alias</span>=<span class="hl-value">"integrationConversionService"</span><span class="hl-tag">/&gt;</span></pre>
<p>In this case the <span class="emphasis"><em>conversionService</em></span>'s Converters will be available for Spring Integration runtime conversion.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="async-polling" href="#async-polling"></a>8.1.7&nbsp;Asynchronous polling</h3></div></div></div>

<p>If you want the polling to be asynchronous, a Poller can optionally specify a <span class="emphasis"><em>task-executor</em></span> attribute pointing to an existing instance of any <code class="literal">TaskExecutor</code> bean (Spring 3.0 provides a convenient namespace configuration via the <code class="literal">task</code> namespace).
However, there are certain things you must understand when configuring a Poller with a TaskExecutor.&nbsp;</p>
<p>The problem is that there are two configurations in place.
The <span class="emphasis"><em>Poller</em></span> and the <span class="emphasis"><em>TaskExecutor</em></span>, and they both have to be in tune&nbsp;with each other otherwise you might end up creating an artificial memory leak.</p>
<p>Let&#8217;s look at the following configuration provided by one of the users on the
<a class="ulink" href="http://forum.spring.io/forum/spring-projects/integration/87155-spring-integration-poller-configuration" target="_top">Spring Integration Forum</a>:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"publishChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:queue /&gt;</span>
<span class="hl-tag">&lt;/int:channel&gt;</span>

<span class="hl-tag">&lt;int:service-activator</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"publishChannel"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"myService"</span><span class="hl-tag">&gt;</span>
	<span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">receive-timeout</span>=<span class="hl-value">"5000"</span><span class="hl-attribute">&nbsp;task-executor</span>=<span class="hl-value">"taskExecutor"</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"50"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/int:service-activator&gt;</span>

<span class="hl-tag">&lt;task:executor</span> <span class="hl-attribute">id</span>=<span class="hl-value">"taskExecutor"</span> <span class="hl-attribute">pool-size</span>=<span class="hl-value">"20"</span><span class="hl-tag"> /&gt;</span></pre>
<p>The above configuration demonstrates one of those out of tune configurations.</p>
<p>By default, the task executor has an unbounded task queue.
The poller keeps scheduling new tasks even though all the threads are blocked waiting for either a new message to arrive, or the timeout to expire.
Given that there are 20 threads executing tasks with a 5 second timeout, they will be executed at a rate of 4 per second (5000/20 = 250ms).
But, new tasks are being scheduled at a rate of 20 per second, so the internal queue in the task executor will grow at a rate of 16 per second (while the process is idle), so we essentially have a memory leak.</p>
<p>One of the ways to handle this is to set the <code class="literal">queue-capacity</code> attribute of the Task Executor; and even 0 is a reasonable
value.
You can also manage it by specifying what to do with messages that can not be queued by setting the <code class="literal">rejection-policy</code> attribute of the Task Executor (e.g., DISCARD).
In other words, there are certain details you must understand with regard to configuring the TaskExecutor.
Please refer to <a class="ulink" href="http://docs.spring.io/spring/docs/current/spring-framework-reference/html/scheduling.html" target="_top">Task Execution and Scheduling</a> of the Spring reference manual for more detail on the subject.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="endpoint-inner" href="#endpoint-inner"></a>8.1.8&nbsp;Endpoint Inner Beans</h3></div></div></div>

<p>Many endpoints are composite beans; this includes all consumers and all polled inbound channel adapters.
Consumers (polled or event- driven) delegate to a <code class="literal">MessageHandler</code>; polled adapters obtain messages by delegating to a <code class="literal">MessageSource</code>.
Often, it is useful to obtain a reference to the delegate bean, perhaps to change configuration at runtime, or for testing.
These beans can be obtained from the <code class="literal">ApplicationContext</code> with well-known names.
<code class="literal">MessageHandler</code> s are registered with the application context with a bean id <code class="literal">someConsumer.handler</code> (where <span class="emphasis"><em>consumer</em></span> is the endpoint&#8217;s <code class="literal">id</code> attribute).
<code class="literal">MessageSource</code> s are registered with a bean id <code class="literal">somePolledAdapter.source</code>, again where <span class="emphasis"><em>somePolledAdapter</em></span> is the id of the adapter.</p>
<p>The above only applies to the framework component itself.
If you use an inner bean definition such as this:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:service-activator</span> <span class="hl-attribute">id</span>=<span class="hl-value">"exampleServiceActivator"</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"inChannel"</span>
            <span class="hl-attribute">output-channel</span> = <span class="hl-value">"outChannel"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"foo"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;beans:bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.foo.ExampleServiceActivator"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:service-activator&gt;</span></pre>
<p>the bean is treated like any inner bean declared that way and is not registered with the application context.
If you wish to access this bean in some other manner, declare it at the top level with an <code class="literal">id</code> and use the <code class="literal">ref</code> attribute instead.
See the <a class="ulink" href="http://docs.spring.io/spring-framework/docs/current/spring-framework-reference/html/beans.html#beans-inner-beans" target="_top">Spring Documentation</a> for more information.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="endpoint-roles" href="#endpoint-roles"></a>8.2&nbsp;Endpoint Roles</h2></div></div></div>

<p>Starting with <span class="emphasis"><em>version 4.2</em></span>, endpoints can be assigned to roles.
Roles allow endpoints to be started and stopped as a group; this is particularly useful when using leadership election
where a set of endpoints can be started or stopped when leadership is granted or revoked respectively.</p>
<p>You can assign endpoints to roles using XML, Java configuration, or programmatically:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"ica"</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"someChannel"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"'foo'"</span> <span class="hl-attribute">role</span>=<span class="hl-value">"cluster"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"60000"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/int:inbound-channel-adapter&gt;</span></pre>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "sendAsyncChannel")</span></em>
<em><span class="hl-annotation" style="color: gray">@Role("cluster")</span></em>
<span class="hl-keyword">public</span> MessageHandler sendAsyncHandler() {
    <span class="hl-keyword">return</span> <span class="hl-comment">// some MessageHandler</span>
}</pre>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Payload("#args[0].toLowerCase()")</span></em>
<em><span class="hl-annotation" style="color: gray">@Role("cluster")</span></em>
<span class="hl-keyword">public</span> String handle(String payload) {
    <span class="hl-keyword">return</span> payload.toUpperCase();
}</pre>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Autowired</span></em>
<span class="hl-keyword">private</span> SmartLifecycleRoleController roleController;

...

    <span class="hl-keyword">this</span>.roleController.addSmartLifeCycleToRole(<span class="hl-string">"cluster"</span>, someEndpoint);
...</pre>
<p>Each of these adds the endpoint to the role <code class="literal">cluster</code>.</p>
<p>Invoking <code class="literal">roleController.startLifecyclesInRole("cluster")</code> (and the corresponding <code class="literal">stop...</code> method) will start/stop
the endpoints.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Any object implementing <code class="literal">SmartLifecycle</code> can be programmatically added, not just endpoints.</p>
</td></tr></table></div>
<p>The <code class="literal">SmartLifecycleRoleController</code> implements <code class="literal">ApplicationListener&lt;AbstractLeaderEvent&gt;</code> and it will automatically
start/stop its configured <code class="literal">SmartLifecycle</code> objects when leadership is granted/revoked (when some bean publishes
<code class="literal">OnGrantedEvent</code> or <code class="literal">OnRevokedEvent</code> respectively).</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>When using leadership election to start/stop components, it is important to set the <code class="literal">auto-startup</code> XML attribute (<code class="literal">autoStartup</code> bean property) to <code class="literal">false</code> so the application context does not start the components during context intialization.</p>
</td></tr></table></div>
<p>Starting with _version 4.3.8, the <code class="literal">SmartLifecycleRoleController</code> provides several status methods:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> Collection&lt;String&gt; getRoles() <a name="CO12-1" href="#CO12-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>

<span class="hl-keyword">public</span> <span class="hl-keyword">boolean</span> allEndpointsRunning(String role) <a name="CO12-2" href="#CO12-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>

<span class="hl-keyword">public</span> <span class="hl-keyword">boolean</span> noEndpointsRunning(String role) <a name="CO12-3" href="#CO12-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>

<span class="hl-keyword">public</span> Map&lt;String, Boolean&gt; getEndpointsRunningStatus(String role) <a name="CO12-4" href="#CO12-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO12-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Returns a list of the roles being managed.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO12-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Returns true if all endpoints in the role are running.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO12-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Returns true if none of the endpoints in the role are running.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO12-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Returns a map of <code class="literal">component name : running status</code> - the component name is usually the bean name.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="leadership-event-handling" href="#leadership-event-handling"></a>8.3&nbsp;Leadership Event Handling</h2></div></div></div>

<p>Groups of endpoints can be started/stopped based on leadership being granted or revoked respectively.
This is useful in clustered scenarios where shared resources must only be consumed by a single instance.
An example of this is a file inbound channel adapter that is polling a shared directory.
(See <a class="xref" href="#file-reading" title="14.2&nbsp;Reading Files">Section&nbsp;14.2, &#8220;Reading Files&#8221;</a>).</p>
<p>To participate in a leader election and be notified when elected leader or when leadership is revoked, an application creates a component in the application context called a "leader initiator". Normally a leader initiator is a <code class="literal">SmartLifecycle</code> so it starts up (optionally) automatically when the context starts, and then publishes notifications when leadership changes. By convention the user provides a <code class="literal">Candidate</code> that receives the callbacks and also can revoke the leadership through a <code class="literal">Context</code> object provided by the framework. User code can also listen for <code class="literal">AbstractLeaderEvents</code>, and respond accordingly, for instance using a <code class="literal">SmartLifecycleRoleController</code>.</p>
<p>There is a basic implementation of a leader initiator based on the <code class="literal">LockRegistry</code> abstraction. To use it you just need to create an instance as a bean, for example:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> LockRegistryLeaderInitiator leaderInitiator(LockRegistry locks) {
    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> LockRegistryLeaderInitiator(locks);
}</pre>
<p>If the lock registry is implemented correctly, there will only ever be at most one leader. If the lock registry also provides locks which throw exceptions (ideally <code class="literal">InterruptedException</code>) when they expire or are broken, then the duration of the leaderless periods can be as short as is allowed by the inherent latency in the lock implementation. By default there is a <code class="literal">busyWaitMillis</code> property that adds some additional latency to prevent CPU starvation in the (more usual) case that the locks are imperfect and you only know they expired by trying to obtain one again.</p>
<p>See <a class="xref" href="#zk-leadership" title="37.4&nbsp;Zookeeper Leadership Event Handling">Section&nbsp;37.4, &#8220;Zookeeper Leadership Event Handling&#8221;</a> for more information about leadership election and events using Zookeeper.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="gateway" href="#gateway"></a>8.4&nbsp;Messaging Gateways</h2></div></div></div>

<p>The primary purpose of a Gateway is to hide the messaging API provided by Spring Integration.
It allows your application&#8217;s business logic to be completely unaware of the Spring Integration API and using a generic Gateway, your code interacts instead with a simple interface, only.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="gateway-proxy" href="#gateway-proxy"></a>8.4.1&nbsp;Enter the GatewayProxyFactoryBean</h3></div></div></div>

<p>As mentioned above, it would be great to have no dependency on the Spring Integration API at all - including the gateway class.
For that reason, Spring Integration provides the <code class="literal">GatewayProxyFactoryBean</code> that generates a proxy for any interface and internally invokes the gateway methods shown below.
Using dependency injection you can then expose the interface to your business methods.</p>
<p>Here is an example of an interface that can be used to interact with Spring Integration:</p>
<pre class="programlisting"><span class="hl-keyword">package</span> org.cafeteria;

<span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> Cafe {

    <span class="hl-keyword">void</span> placeOrder(Order order);

}</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="gateway-namespace" href="#gateway-namespace"></a>8.4.2&nbsp;Gateway XML Namespace Support</h3></div></div></div>

<p>Namespace support is also provided which allows you to configure such an interface as a service as demonstrated by the following example.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:gateway</span> <span class="hl-attribute">id</span>=<span class="hl-value">"cafeService"</span>
         <span class="hl-attribute">service-interface</span>=<span class="hl-value">"org.cafeteria.Cafe"</span>
         <span class="hl-attribute">default-request-channel</span>=<span class="hl-value">"requestChannel"</span>
         <span class="hl-attribute">default-reply-timeout</span>=<span class="hl-value">"10000"</span>
         <span class="hl-attribute">default-reply-channel</span>=<span class="hl-value">"replyChannel"</span><span class="hl-tag">/&gt;</span></pre>
<p>With this configuration defined, the "cafeService" can now be injected into other beans, and the code that invokes the methods on that proxied instance of the Cafe interface has no awareness of the Spring Integration API.
The general approach is similar to that of Spring Remoting (RMI, HttpInvoker, etc.).
See the "Samples" Appendix for an example that uses this "gateway" element (in the Cafe demo).</p>
<p>The defaults in the configuration above are applied to all methods on the gateway interface; if a reply timeout is not
specified, the calling thread will wait indefinitely for a reply.
See <a class="xref" href="#gateway-no-response" title="8.4.10&nbsp;Gateway behavior when no response arrives">Section&nbsp;8.4.10, &#8220;Gateway behavior when no response arrives&#8221;</a>.</p>
<p>The defaults can be overridden for individual methods; see <a class="xref" href="#gateway-configuration-annotations" title="8.4.4&nbsp;Gateway Configuration with Annotations and/or XML">Section&nbsp;8.4.4, &#8220;Gateway Configuration with Annotations and/or XML&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="gateway-default-reply-channel" href="#gateway-default-reply-channel"></a>8.4.3&nbsp;Setting the Default Reply Channel</h3></div></div></div>

<p>Typically you don&#8217;t have to specify the <code class="literal">default-reply-channel</code>, since a Gateway will auto-create a temporary, anonymous reply channel, where it will listen for the reply.
However, there are some cases which may prompt you to define a <code class="literal">default-reply-channel</code> (or <code class="literal">reply-channel</code> with adapter gateways such as HTTP, JMS, etc.).</p>
<p>For some background, we&#8217;ll quickly discuss some of the inner-workings of the Gateway.
A Gateway will create a temporary point-to-point reply channel which is anonymous and is added to the Message Headers with the name <code class="literal">replyChannel</code>.
When providing an explicit <code class="literal">default-reply-channel</code> (<code class="literal">reply-channel</code> with remote adapter gateways), you have the option to point to a publish-subscribe channel, which is so named because you can add more than one subscriber to it.
Internally Spring Integration will create a Bridge between the temporary <code class="literal">replyChannel</code> and the explicitly defined <code class="literal">default-reply-channel</code>.</p>
<p>So let&#8217;s say you want your reply to go not only to the gateway, but also to some other consumer.
In this case you would want two things: <span class="emphasis"><em>a) a named channel you can subscribe to and b) that channel is a publish-subscribe-channel.</em></span> The default strategy used by the gateway will not satisfy those needs, because the reply channel added to the header is anonymous and point-to-point.
This means that no other subscriber can get a handle to it and even if it could, the channel has point-to-point behavior such that only one subscriber would get the Message.
So by defining a <code class="literal">default-reply-channel</code> you can point to a channel of your choosing, which in this case would be a <code class="literal">publish-subscribe-channel</code>.
The Gateway would create a bridge from it to the temporary, anonymous reply channel that is stored in the header.</p>
<p>Another case where you might want to provide a reply channel explicitly is for monitoring or auditing via an interceptor (e.g., wiretap).
You need a named channel in order to configure a Channel Interceptor.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="gateway-configuration-annotations" href="#gateway-configuration-annotations"></a>8.4.4&nbsp;Gateway Configuration with Annotations and/or XML</h3></div></div></div>

<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> Cafe {

    <em><span class="hl-annotation" style="color: gray">@Gateway(requestChannel="orders")</span></em>
    <span class="hl-keyword">void</span> placeOrder(Order order);

}</pre>
<p>You may alternatively provide such content in <code class="literal">method</code> sub-elements if you prefer XML configuration (see the next paragraph).</p>
<p>It is also possible to pass values to be interpreted as Message headers on the Message that is created and sent to the
request channel by using the <code class="literal">@Header</code> annotation:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> FileWriter {

    <em><span class="hl-annotation" style="color: gray">@Gateway(requestChannel="filesOut")</span></em>
    <span class="hl-keyword">void</span> write(<span class="hl-keyword">byte</span>[] content, <em><span class="hl-annotation" style="color: gray">@Header(FileHeaders.FILENAME)</span></em> String filename);

}</pre>
<p>If you prefer the XML approach of configuring Gateway methods, you can provide <span class="emphasis"><em>method</em></span> sub-elements to the gateway configuration.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:gateway</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myGateway"</span> <span class="hl-attribute">service-interface</span>=<span class="hl-value">"org.foo.bar.TestGateway"</span>
      <span class="hl-attribute">default-request-channel</span>=<span class="hl-value">"inputC"</span><span class="hl-tag">&gt;</span>
  <span class="hl-tag">&lt;int:default-header</span> <span class="hl-attribute">name</span>=<span class="hl-value">"calledMethod"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"#gatewayMethod.name"</span><span class="hl-tag">/&gt;</span>
  <span class="hl-tag">&lt;int:method</span> <span class="hl-attribute">name</span>=<span class="hl-value">"echo"</span> <span class="hl-attribute">request-channel</span>=<span class="hl-value">"inputA"</span> <span class="hl-attribute">reply-timeout</span>=<span class="hl-value">"2"</span> <span class="hl-attribute">request-timeout</span>=<span class="hl-value">"200"</span><span class="hl-tag">/&gt;</span>
  <span class="hl-tag">&lt;int:method</span> <span class="hl-attribute">name</span>=<span class="hl-value">"echoUpperCase"</span> <span class="hl-attribute">request-channel</span>=<span class="hl-value">"inputB"</span><span class="hl-tag">/&gt;</span>
  <span class="hl-tag">&lt;int:method</span> <span class="hl-attribute">name</span>=<span class="hl-value">"echoViaDefault"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:gateway&gt;</span></pre>
<p>You can also provide individual headers per method invocation via XML.
This could be very useful if the headers you want to set are static in nature and you don&#8217;t want to embed them in the gateway&#8217;s method signature via <code class="literal">@Header</code> annotations.
For example, in the Loan Broker example we want to influence how aggregation of the Loan quotes will be done based on what type of request was initiated (single quote or all quotes).
Determining the type of the request by evaluating what gateway method was invoked, although possible, would violate the separation of concerns paradigm (the method is a java artifact), &nbsp;but expressing your intention (meta information) via Message headers is natural in a Messaging architecture.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:gateway</span> <span class="hl-attribute">id</span>=<span class="hl-value">"loanBrokerGateway"</span>
         <span class="hl-attribute">service-interface</span>=<span class="hl-value">"org.springframework.integration.loanbroker.LoanBrokerGateway"</span><span class="hl-tag">&gt;</span>
  <span class="hl-tag">&lt;int:method</span> <span class="hl-attribute">name</span>=<span class="hl-value">"getLoanQuote"</span> <span class="hl-attribute">request-channel</span>=<span class="hl-value">"loanBrokerPreProcessingChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:header</span> <span class="hl-attribute">name</span>=<span class="hl-value">"RESPONSE_TYPE"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"BEST"</span><span class="hl-tag">/&gt;</span>
  <span class="hl-tag">&lt;/int:method&gt;</span>
  <span class="hl-tag">&lt;int:method</span> <span class="hl-attribute">name</span>=<span class="hl-value">"getAllLoanQuotes"</span> <span class="hl-attribute">request-channel</span>=<span class="hl-value">"loanBrokerPreProcessingChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:header</span> <span class="hl-attribute">name</span>=<span class="hl-value">"RESPONSE_TYPE"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"ALL"</span><span class="hl-tag">/&gt;</span>
  <span class="hl-tag">&lt;/int:method&gt;</span>
<span class="hl-tag">&lt;/int:gateway&gt;</span></pre>
<p>In the above case you can clearly see how a different value will be set for the <span class="emphasis"><em>RESPONSE_TYPE</em></span> header based on the gateway&#8217;s method.</p>
<p><span class="strong"><strong>Expressions and "Global" Headers</strong></span></p>
<p>The <code class="literal">&lt;header/&gt;</code> element supports <code class="literal">expression</code> as an alternative to <code class="literal">value</code>.
The SpEL expression is evaluated to determine the value of the header.
There is no <code class="literal">#root</code> object but the following variables are available:</p>
<p>#args - an <code class="literal">Object[]</code> containing the method arguments</p>
<p>#gatewayMethod - the <code class="literal">java.reflect.Method</code> object representing the method in the <code class="literal">service-interface</code> that was invoked.
A header containing this variable can be used later in the flow, for example, for routing.
For example, if you wish to route on the simple method name, you might add a header, with expression <code class="literal">#gatewayMethod.name</code>.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The <code class="literal">java.reflect.Method</code> is not serializable; a header with expression <code class="literal">#gatewayMethod</code> will be lost if you later serialize the message.
So, you may wish to use <code class="literal">#gatewayMethod.name</code> or <code class="literal">#gatewayMethod.toString()</code> in those cases; the <code class="literal">toString()</code> method provides a String representation of the method, including parameter and return types.</p>
</td></tr></table></div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Prior to 3.0, the <code class="literal">#method</code> variable was available, representing the method name only.
This is still available, but deprecated; use <code class="literal">#gatewayMethod.name</code> instead.</p>
</td></tr></table></div>
<p>Since 3.0, <code class="literal">&lt;default-header/&gt;</code> s can be defined to add headers to all messages produced by the gateway, regardless of the method invoked.
Specific headers defined for a method take precedence over default headers.
Specific headers defined for a method here will override any <code class="literal">@Header</code> annotations in the service interface.
However, default headers will NOT override any <code class="literal">@Header</code> annotations in the service interface.</p>
<p>The gateway now also supports a <code class="literal">default-payload-expression</code> which will be applied for all methods (unless overridden).</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="gateway-mapping" href="#gateway-mapping"></a>8.4.5&nbsp;Mapping Method Arguments to a Message</h3></div></div></div>

<p>Using the configuration techniques in the previous section allows control of how method arguments are mapped to message elements (payload and header(s)).
When no explicit configuration is used, certain conventions are used to perform the mapping.
In some cases, these conventions cannot determine which argument is the payload and which should be mapped to headers.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> String send1(Object foo, Map bar);

<span class="hl-keyword">public</span> String send2(Map foo, Map bar);</pre>
<p>In the first case, the convention will map the first argument to the payload (as long as it is not a <code class="literal">Map</code>) and the contents of the second become headers.</p>
<p>In the second case (or the first when the argument for parameter <code class="literal">foo</code> is a <code class="literal">Map</code>), the framework cannot determine which argument should be the payload; mapping will fail.
This can generally be resolved using a <code class="literal">payload-expression</code>, a <code class="literal">@Payload</code> annotation and/or a <code class="literal">@Headers</code> annotation.</p>
<p>Alternatively, and whenever the conventions break down, you can take the entire responsibility for mapping the method calls to messages.
To do this, implement an`MethodArgsMessageMapper` and provide it to the <code class="literal">&lt;gateway/&gt;</code> using the <code class="literal">mapper</code> attribute.
The mapper maps a <code class="literal">MethodArgsHolder</code>, which is a simple class wrapping the <code class="literal">java.reflect.Method</code> instance and an <code class="literal">Object[]</code> containing the arguments.
When providing a custom mapper, the <code class="literal">default-payload-expression</code> attribute and <code class="literal">&lt;default-header/&gt;</code> elements are not allowed on the gateway; similarly, the <code class="literal">payload-expression</code> attribute and <code class="literal">&lt;header/&gt;</code> elements are not allowed on any <code class="literal">&lt;method/&gt;</code> elements.</p>
<p><span class="strong"><strong>Mapping Method Arguments</strong></span></p>
<p>Here are examples showing how method arguments can be mapped to the message (and some examples of invalid configuration):</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> MyGateway {

    <span class="hl-keyword">void</span> payloadAndHeaderMapWithoutAnnotations(String s, Map&lt;String, Object&gt; map);

    <span class="hl-keyword">void</span> payloadAndHeaderMapWithAnnotations(<em><span class="hl-annotation" style="color: gray">@Payload</span></em> String s, <em><span class="hl-annotation" style="color: gray">@Headers</span></em> Map&lt;String, Object&gt; map);

    <span class="hl-keyword">void</span> headerValuesAndPayloadWithAnnotations(<em><span class="hl-annotation" style="color: gray">@Header("k1")</span></em> String x, <em><span class="hl-annotation" style="color: gray">@Payload</span></em> String s, <em><span class="hl-annotation" style="color: gray">@Header("k2")</span></em> String y);

    <span class="hl-keyword">void</span> mapOnly(Map&lt;String, Object&gt; map); <span class="hl-comment">// the payload is the map and no custom headers are added</span>

    <span class="hl-keyword">void</span> twoMapsAndOneAnnotatedWithPayload(<em><span class="hl-annotation" style="color: gray">@Payload</span></em> Map&lt;String, Object&gt; payload, Map&lt;String, Object&gt; headers);

    <em><span class="hl-annotation" style="color: gray">@Payload("#args[0] + #args[1] + '!'")</span></em>
    <span class="hl-keyword">void</span> payloadAnnotationAtMethodLevel(String a, String b);

    <em><span class="hl-annotation" style="color: gray">@Payload("@someBean.exclaim(#args[0])")</span></em>
    <span class="hl-keyword">void</span> payloadAnnotationAtMethodLevelUsingBeanResolver(String s);

    <span class="hl-keyword">void</span> payloadAnnotationWithExpression(<em><span class="hl-annotation" style="color: gray">@Payload("toUpperCase()")</span></em> String s);

    <span class="hl-keyword">void</span> payloadAnnotationWithExpressionUsingBeanResolver(<em><span class="hl-annotation" style="color: gray">@Payload("@someBean.sum(#this)")</span></em> String s); <span class="hl-comment">//  </span><a name="CO13-1" href="#CO13-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>

    <span class="hl-comment">// invalid</span>
    <span class="hl-keyword">void</span> twoMapsWithoutAnnotations(Map&lt;String, Object&gt; m1, Map&lt;String, Object&gt; m2);

    <span class="hl-comment">// invalid</span>
    <span class="hl-keyword">void</span> twoPayloads(<em><span class="hl-annotation" style="color: gray">@Payload</span></em> String s1, <em><span class="hl-annotation" style="color: gray">@Payload</span></em> String s2);

    <span class="hl-comment">// invalid</span>
    <span class="hl-keyword">void</span> payloadAndHeaderAnnotationsOnSameParameter(<em><span class="hl-annotation" style="color: gray">@Payload</span></em> <em><span class="hl-annotation" style="color: gray">@Header("x")</span></em> String s);

    <span class="hl-comment">// invalid</span>
    <span class="hl-keyword">void</span> payloadAndHeadersAnnotationsOnSameParameter(<em><span class="hl-annotation" style="color: gray">@Payload</span></em> <em><span class="hl-annotation" style="color: gray">@Headers</span></em> Map&lt;String, Object&gt; map);

}</pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO13-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Note that in this example, the SpEL variable <code class="literal">#this</code> refers to the argument - in this case, the value of <code class="literal">'s'</code>.</p>
</td></tr></table></div>
<p>The XML equivalent looks a little different, since there is no <code class="literal">#this</code> context for the method argument, but expressions can refer to method arguments using the <code class="literal">#args</code> variable:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:gateway</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myGateway"</span> <span class="hl-attribute">service-interface</span>=<span class="hl-value">"org.foo.bar.MyGateway"</span><span class="hl-tag">&gt;</span>
  <span class="hl-tag">&lt;int:method</span> <span class="hl-attribute">name</span>=<span class="hl-value">"send1"</span> <span class="hl-attribute">payload-expression</span>=<span class="hl-value">"#args[0] + 'bar'"</span><span class="hl-tag">/&gt;</span>
  <span class="hl-tag">&lt;int:method</span> <span class="hl-attribute">name</span>=<span class="hl-value">"send2"</span> <span class="hl-attribute">payload-expression</span>=<span class="hl-value">"@someBean.sum(#args[0])"</span><span class="hl-tag">/&gt;</span>
  <span class="hl-tag">&lt;int:method</span> <span class="hl-attribute">name</span>=<span class="hl-value">"send3"</span> <span class="hl-attribute">payload-expression</span>=<span class="hl-value">"#method"</span><span class="hl-tag">/&gt;</span>
  <span class="hl-tag">&lt;int:method</span> <span class="hl-attribute">name</span>=<span class="hl-value">"send4"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:header</span> <span class="hl-attribute">name</span>=<span class="hl-value">"foo"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"#args[2].toUpperCase()"</span><span class="hl-tag">/&gt;</span>
  <span class="hl-tag">&lt;/int:method&gt;</span>
<span class="hl-tag">&lt;/int:gateway&gt;</span></pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="messaging-gateway-annotation" href="#messaging-gateway-annotation"></a>8.4.6&nbsp;@MessagingGateway Annotation</h3></div></div></div>

<p>Starting with <span class="emphasis"><em>version 4.0</em></span>, gateway service interfaces can be marked with a <code class="literal">@MessagingGateway</code> annotation instead of requiring the definition of a <code class="literal">&lt;gateway /&gt;</code> xml element for configuration.
The following compares the two approaches for configuring the same gateway:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:gateway</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myGateway"</span> <span class="hl-attribute">service-interface</span>=<span class="hl-value">"org.foo.bar.TestGateway"</span>
      <span class="hl-attribute">default-request-channel</span>=<span class="hl-value">"inputC"</span><span class="hl-tag">&gt;</span>
  <span class="hl-tag">&lt;int:default-header</span> <span class="hl-attribute">name</span>=<span class="hl-value">"calledMethod"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"#gatewayMethod.name"</span><span class="hl-tag">/&gt;</span>
  <span class="hl-tag">&lt;int:method</span> <span class="hl-attribute">name</span>=<span class="hl-value">"echo"</span> <span class="hl-attribute">request-channel</span>=<span class="hl-value">"inputA"</span> <span class="hl-attribute">reply-timeout</span>=<span class="hl-value">"2"</span> <span class="hl-attribute">request-timeout</span>=<span class="hl-value">"200"</span><span class="hl-tag">/&gt;</span>
  <span class="hl-tag">&lt;int:method</span> <span class="hl-attribute">name</span>=<span class="hl-value">"echoUpperCase"</span> <span class="hl-attribute">request-channel</span>=<span class="hl-value">"inputB"</span><span class="hl-tag">&gt;</span>
  		<span class="hl-tag">&lt;int:header</span> <span class="hl-attribute">name</span>=<span class="hl-value">"foo"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"bar"</span><span class="hl-tag">/&gt;</span>
  <span class="hl-tag">&lt;/int:method&gt;</span>
  <span class="hl-tag">&lt;int:method</span> <span class="hl-attribute">name</span>=<span class="hl-value">"echoViaDefault"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:gateway&gt;</span></pre>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@MessagingGateway(name = "myGateway", defaultRequestChannel = "inputC",
		  defaultHeaders = @GatewayHeader(name = "calledMethod",
		                           expression="#gatewayMethod.name"))</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> TestGateway {

   <em><span class="hl-annotation" style="color: gray">@Gateway(requestChannel = "inputA", replyTimeout = 2, requestTimeout = 200)</span></em>
   String echo(String payload);

   <em><span class="hl-annotation" style="color: gray">@Gateway(requestChannel = "inputB", headers = @GatewayHeader(name = "foo", value="bar"))</span></em>
   String echoUpperCase(String payload);

   String echoViaDefault(String payload);

}</pre>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>As with the XML version, Spring Integration creates the <code class="literal">proxy</code> implementation with its messaging infrastructure, when discovering these annotations during a component scan.
To perform this scan and register the <code class="literal">BeanDefinition</code> in the application context, add the <code class="literal">@IntegrationComponentScan</code> annotation to a <code class="literal">@Configuration</code> class.
The standard <code class="literal">@ComponentScan</code> infrastructure doesn&#8217;t deal with interfaces, therefore the custom <code class="literal">@IntegrationComponentScan</code> logic has been introduced
to determine <code class="literal">@MessagingGateway</code> annotation on the interfaces and register <code class="literal">GatewayProxyFactoryBean</code> s for them.
See also <a class="xref" href="#annotations" title="F.6&nbsp;Annotation Support">Section&nbsp;F.6, &#8220;Annotation Support&#8221;</a></p>
</td></tr></table></div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>If you have no XML configuration, the <code class="literal">@EnableIntegration</code> annotation is required on at least one <code class="literal">@Configuration</code>
class.
See <a class="xref" href="#configuration-enable-integration" title="3.5&nbsp;Configuration and @EnableIntegration">Section&nbsp;3.5, &#8220;Configuration and @EnableIntegration&#8221;</a> for more information.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="gateway-calling-no-argument-methods" href="#gateway-calling-no-argument-methods"></a>8.4.7&nbsp;Invoking No-Argument Methods</h3></div></div></div>

<p>When invoking methods on a Gateway interface that do not have any arguments, the default behavior is to <span class="emphasis"><em>receive</em></span> a <code class="literal">Message</code> from a <code class="literal">PollableChannel</code>.</p>
<p>At times however, you may want to trigger no-argument methods so that you can in fact interact with other components downstream that do not require user-provided parameters, e.g.
triggering no-argument SQL calls or Stored Procedures.</p>
<p>In order to achieve <span class="emphasis"><em>send-and-receive</em></span> semantics, you must provide a payload.
In order to generate a payload, method parameters on the interface are not necessary.
You can either use the <code class="literal">@Payload</code> annotation or the <code class="literal">payload-expression</code> attribute in XML on the <code class="literal">method</code> sub-element.
Below please find a few examples of what the payloads could be:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
a literal string
</li><li class="listitem">
#gatewayMethod.name
</li><li class="listitem">
new java.util.Date()
</li><li class="listitem">
@someBean.someMethod()'s return value
</li></ul></div>
<p>Here is an example using the <code class="literal">@Payload</code> annotation:</p>
<pre class="programlisting">public interface Cafe {

    @Payload("new java.util.Date()")
    List<span class="hl-tag">&lt;Order&gt;</span> retrieveOpenOrders();

}</pre>
<p>If a method has no argument and no return value, but does contain a payload expression, it will be treated as a <span class="emphasis"><em>send-only</em></span> operation.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="gateway-error-handling" href="#gateway-error-handling"></a>8.4.8&nbsp;Error Handling</h3></div></div></div>

<p>Of course, the Gateway invocation might result in errors.
By default any error that has occurred downstream will be re-thrown as a <code class="literal">MessagingException</code> (<code class="literal">RuntimeException</code>) upon the Gateway&#8217;s method invocation.
However there are times when you may want to simply log the error rather than propagating it, or you may want to treat an Exception as a valid reply, by mapping it to a Message that will conform to some "error message" contract that the caller understands.
To accomplish this, the Gateway provides support for a Message Channel dedicated to the errors via the <span class="emphasis"><em>error-channel</em></span> attribute.
In the example below, you can see that a <span class="emphasis"><em>transformer</em></span> is used to create a reply Message from the Exception.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:gateway</span> <span class="hl-attribute">id</span>=<span class="hl-value">"sampleGateway"</span>
    <span class="hl-attribute">default-request-channel</span>=<span class="hl-value">"gatewayChannel"</span>
    <span class="hl-attribute">service-interface</span>=<span class="hl-value">"foo.bar.SimpleGateway"</span>
    <span class="hl-attribute">error-channel</span>=<span class="hl-value">"exceptionTransformationChannel"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int:transformer</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"exceptionTransformationChannel"</span>
        <span class="hl-attribute">ref</span>=<span class="hl-value">"exceptionTransformer"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"createErrorResponse"</span><span class="hl-tag">/&gt;</span></pre>
<p>The <span class="emphasis"><em>exceptionTransformer</em></span> could be a simple POJO that knows how to create the expected error response objects.
That would then be the payload that is sent back to the caller.
Obviously, you could do many more elaborate things in such an "error flow" if necessary.
It might involve routers (including Spring Integration&#8217;s <code class="literal">ErrorMessageExceptionTypeRouter</code>), filters, and so on.
Most of the time, a simple <span class="emphasis"><em>transformer</em></span> should be sufficient, however.</p>
<p>Alternatively, you might want to only log the Exception (or send it somewhere asynchronously).
If you provide a one-way flow, then nothing would be sent back to the caller.
In the case that you want to completely suppress Exceptions, you can provide a reference to the global "nullChannel" (essentially a /dev/null approach).
Finally, as mentioned above, if no "error-channel" is defined at all, then the Exceptions will propagate as usual.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Exposing the messaging system via simple POJI Gateways obviously provides benefits, but "hiding" the reality of the underlying messaging system does come at a price so there are certain things you should consider.
We want our Java method to return as quickly as possible and not hang for an indefinite amount of time while the caller is waiting on it to return (void, return value, or a thrown Exception).
When regular methods are used as a proxies in front of the Messaging system, we have to take into account the potentially asynchronous nature of the underlying messaging.
This means that there might be a chance that a Message that was initiated by a Gateway could be dropped by a Filter, thus never reaching a component that is responsible for producing a reply.
Some Service Activator method might result in an Exception, thus providing no reply (as we don&#8217;t generate Null messages).
So as you can see there are multiple scenarios where a reply message might not be coming.
That is perfectly natural in messaging systems.
However think about the implication on the gateway method.&nbsp;The Gateway&#8217;s method input arguments &nbsp;were incorporated into a Message and sent downstream.
The reply Message would be converted to a return value of the Gateway&#8217;s method.
So you might want to ensure that for each Gateway call there will always be a reply Message.
Otherwise, your Gateway method might never return and will hang indefinitely.
One of the ways of handling this situation is via an Asynchronous Gateway (explained later in this section).
Another way of handling it is to explicitly set the reply-timeout attribute.
That way, the gateway will not hang any longer than the time specified by the reply-timeout and will return <span class="emphasis"><em>null</em></span> if that timeout does elapse.
Finally, you might want to consider setting downstream flags such as <span class="emphasis"><em>requires-reply</em></span> on a service-activator or <span class="emphasis"><em>throw-exceptions-on-rejection</em></span> on a filter.&nbsp;These options will be discussed in more detail in the final section of this chapter.</p>
</td></tr></table></div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>If the downstream flow returns an <code class="literal">ErrorMessage</code>, its <code class="literal">payload</code> (a <code class="literal">Throwable</code>) is treated as a regular downstream
error: if there is an <code class="literal">error-channel</code> configured, it will be sent there, to the error flow; otherwise the payload is
thrown to the caller of gateway.
Similarly, if the error flow on the <code class="literal">error-channel</code> returns an <code class="literal">ErrorMessage</code> its payload is thrown to the caller.
The same applies to any message with a <code class="literal">Throwable</code> payload.
This can be useful in async situations when when there is a need propagate an <code class="literal">Exception</code> directly to the caller.
To achieve this you can either return an <code class="literal">Exception</code> as the <code class="literal">reply</code> from some service, or simply throw it.
Generally, even with an async flow, the framework will take care of propagating an exception thrown by the
downstream flow back to the gateway.
The <a class="ulink" href="https://github.com/spring-projects/spring-integration-samples/tree/master/intermediate/tcp-client-server-multiplex" target="_top">TCP Client-Server Multiplex</a>
sample demonstrates both techniques to return the exception to the caller.
It emulates a Socket IO error to the waiting thread using an <code class="literal">aggregator</code> with <code class="literal">group-timeout</code> (see <a class="xref" href="#agg-and-group-to" title="Aggregator and Group Timeout">the section called &#8220;Aggregator and Group Timeout&#8221;</a>)
and <code class="literal">MessagingTimeoutException</code> reply on the discard flow.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="async-gateway" href="#async-gateway"></a>8.4.9&nbsp;Asynchronous Gateway</h3></div></div></div>

<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_introduction_3" href="#_introduction_3"></a>Introduction</h4></div></div></div>

<p>As a pattern, the Messaging Gateway is a very nice way to hide messaging-specific code while still exposing the full capabilities of the messaging system.
As you&#8217;ve seen, the <code class="literal">GatewayProxyFactoryBean</code> provides a convenient way to expose a Proxy over a service-interface thus giving you POJO-based access to a messaging system (based on objects in your own domain, or primitives/Strings, etc).
&nbsp;But when a gateway is exposed via simple POJO methods which return values it does imply that for each Request message (generated when the method is invoked) there must be a Reply message (generated when the method has returned).
Since Messaging systems naturally are asynchronous you may not always be able to guarantee the contract where <span class="emphasis"><em>"for each request there will always be be a reply"</em></span>.&nbsp; With Spring Integration 2.0 we introduced support for an <span class="emphasis"><em>Asynchronous Gateway</em></span> which is a convenient way to initiate flows where you may not know if a reply is expected or how long will it take for replies to arrive.</p>
<p>A natural way to handle these types of scenarios in Java would be relying upon <span class="emphasis"><em>java.util.concurrent.Future</em></span> instances, and that is exactly what Spring Integration uses to support an <span class="emphasis"><em>Asynchronous Gateway</em></span>.</p>
<p>From the XML configuration, there is nothing different and you still define <span class="emphasis"><em>Asynchronous Gateway</em></span> the same way as a regular Gateway.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:gateway</span> <span class="hl-attribute">id</span>=<span class="hl-value">"mathService"</span><span class="hl-attribute">&nbsp;</span>
     <span class="hl-attribute">service-interface</span>=<span class="hl-value">"org.springframework.integration.sample.gateway.futures.MathServiceGateway"</span>
     <span class="hl-attribute">default-request-channel</span>=<span class="hl-value">"requestChannel"</span><span class="hl-tag">/&gt;</span></pre>
<p>However the Gateway Interface (service-interface) is a little different:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> MathServiceGateway {

  Future&lt;Integer&gt; multiplyByTwo(<span class="hl-keyword">int</span> i);

}</pre>
<p>As you can see from the example above, the return type for the gateway method is a <code class="literal">Future</code>.
When <code class="literal">GatewayProxyFactoryBean</code> sees that the return type of the gateway method is a <code class="literal">Future</code>, it immediately switches to the async mode by utilizing an <code class="literal">AsyncTaskExecutor</code>.
That is all.
The call to such a method always returns immediately with a <code class="literal">Future</code> instance.
Then, you can interact with the <code class="literal">Future</code> at your own pace to get the result, cancel, etc.
And, as with any other use of Future instances, calling get() may reveal a timeout, an execution exception, and so on.</p>
<pre class="programlisting">MathServiceGateway mathService = ac.getBean(<span class="hl-string">"mathService"</span>, MathServiceGateway.<span class="hl-keyword">class</span>);
Future&lt;Integer&gt; result = mathService.multiplyByTwo(number);
<span class="hl-comment">// do something else here since the reply might take a moment</span>
<span class="hl-keyword">int</span> finalResult =&nbsp; result.get(<span class="hl-number">1000</span>, TimeUnit.SECONDS);</pre>
<p>For a more detailed example, please refer to the <a class="ulink" href="https://github.com/spring-projects/spring-integration-samples/tree/master/intermediate/async-gateway" target="_top"><span class="emphasis"><em>async-gateway</em></span></a> sample distributed within the Spring Integration samples.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_listenablefuture" href="#_listenablefuture"></a>ListenableFuture</h4></div></div></div>

<p>Starting with <span class="emphasis"><em>version 4.1</em></span>, async gateway methods can also return <code class="literal">ListenableFuture</code> (introduced in Spring Framework 4.0).
These return types allow you to provide a callback which is invoked when the result is available (or an exception occurs).
When the gateway detects this return type, and the task executor (see below) is an <code class="literal">AsyncListenableTaskExecutor</code>, the executor&#8217;s <code class="literal">submitListenable()</code> method is invoked.</p>
<pre class="programlisting">ListenableFuture&lt;String&gt; result = <span class="hl-keyword">this</span>.asyncGateway.async(<span class="hl-string">"foo"</span>);
result.addCallback(<span class="hl-keyword">new</span> ListenableFutureCallback&lt;String&gt;() {

    <em><span class="hl-annotation" style="color: gray">@Override</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> onSuccess(String result) {
        ...
    }

    <em><span class="hl-annotation" style="color: gray">@Override</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> onFailure(Throwable t) {
        ...
    }
});</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_asynctaskexecutor" href="#_asynctaskexecutor"></a>AsyncTaskExecutor</h4></div></div></div>

<p>By default, the <code class="literal">GatewayProxyFactoryBean</code> uses <code class="literal">org.springframework.core.task.SimpleAsyncTaskExecutor</code> when submitting internal <code class="literal">AsyncInvocationTask</code> instances for any gateway method whose return type is <code class="literal">Future</code>.
However the <code class="literal">async-executor</code> attribute in the <code class="literal">&lt;gateway/&gt;</code> element&#8217;s configuration allows you to provide a reference to any implementation of <code class="literal">java.util.concurrent.Executor</code> available within the Spring application context.</p>
<p>The (default) <code class="literal">SimpleAsyncTaskExecutor</code> supports both <code class="literal">Future</code> and <code class="literal">ListenableFuture</code> return types, returning <code class="literal">FutureTask</code> or <code class="literal">ListenableFutureTask</code> respectively. Also see <a class="xref" href="#gw-completable-future" title="CompletableFuture">the section called &#8220;CompletableFuture&#8221;</a> below.
Even though there is a default executor, it is often useful to provide an external one so that you can identify its threads in logs (when using XML, the thread name is based on the executor&#8217;s bean name):</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> AsyncTaskExecutor exec() {
    SimpleAsyncTaskExecutor simpleAsyncTaskExecutor = <span class="hl-keyword">new</span> SimpleAsyncTaskExecutor();
    simpleAsyncTaskExecutor.setThreadNamePrefix(<span class="hl-string">"exec-"</span>);
    <span class="hl-keyword">return</span> simpleAsyncTaskExecutor;
}

<em><span class="hl-annotation" style="color: gray">@MessagingGateway(asyncExecutor = "exec")</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> ExecGateway {

    <em><span class="hl-annotation" style="color: gray">@Gateway(requestChannel = "gatewayChannel")</span></em>
    Future&lt;?&gt; doAsync(String foo);

}</pre>
<p>If you wish to return a different <code class="literal">Future</code> implementation, you can provide a custom executor, or disable the executor altogether and return the <code class="literal">Future</code> in the reply message payload from the downstream flow.
To disable the executor, simply set it to <code class="literal">null</code> in the <code class="literal">GatewayProxyFactoryBean</code> (<code class="literal">setAsyncTaskExecutor(null)</code>).
When configuring the gateway with XML, use <code class="literal">async-executor=""</code>; when configuring using the <code class="literal">@MessagingGateway</code> annotation, use:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@MessagingGateway(asyncExecutor = AnnotationConstants.NULL)</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> NoExecGateway {

    <em><span class="hl-annotation" style="color: gray">@Gateway(requestChannel = "gatewayChannel")</span></em>
    Future&lt;?&gt; doAsync(String foo);

}</pre>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>If the return type is a specific concrete <code class="literal">Future</code> implementation or some other subinterface that is not supported by the configured executor, the flow will run on the caller&#8217;s thread and the flow must return the required type in the reply message payload.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="gw-completable-future" href="#gw-completable-future"></a>CompletableFuture</h4></div></div></div>

<p>Starting with <span class="emphasis"><em>version 4.2</em></span>, gateway methods can now return <code class="literal">CompletableFuture&lt;?&gt;</code>.
There are several modes of operation when returning this type:</p>
<p>When an async executor is provided <span class="strong"><strong>and</strong></span> the return type is exactly <code class="literal">CompletableFuture</code> (not a subclass), the framework
will run the task on the executor and immediately return a <code class="literal">CompletableFuture</code> to the caller.
<code class="literal">CompletableFuture.supplyAsync(Supplier&lt;U&gt; supplier, Executor executor)</code> is used to create the future.</p>
<p>When the async executor is explicitly set to <code class="literal">null</code> and the return type is <code class="literal">CompletableFuture</code> <span class="strong"><strong>or</strong></span> the return type
is a subclass of <code class="literal">CompletableFuture</code>, the flow is invoked on the caller&#8217;s thread.
In this scenario, it is expected that the downstream flow will return a <code class="literal">CompletableFuture</code> of the appropriate type.</p>
<p><span class="strong"><strong>Usage Scenarios</strong></span></p>
<pre class="programlisting">CompletableFuture&lt;Invoice&gt; order(Order order);</pre>
<pre class="programlisting"><span class="hl-tag">&lt;int:gateway</span> <span class="hl-attribute">service-interface</span>=<span class="hl-value">"foo.Service"</span> <span class="hl-attribute">default-request-channel</span>=<span class="hl-value">"orders"</span><span class="hl-tag"> /&gt;</span></pre>
<p>In this scenario, the caller thread returns immediately with a <code class="literal">CompletableFuture&lt;Invoice&gt;</code> which will be completed
when the downstream flow replies to the gateway (with an <code class="literal">Invoice</code> object).</p>
<pre class="programlisting">CompletableFuture&lt;Invoice&gt; order(Order order);</pre>
<pre class="programlisting"><span class="hl-tag">&lt;int:gateway</span> <span class="hl-attribute">service-interface</span>=<span class="hl-value">"foo.Service"</span> <span class="hl-attribute">default-request-channel</span>=<span class="hl-value">"orders"</span>
    <span class="hl-attribute">async-executor</span>=<span class="hl-value">""</span><span class="hl-tag"> /&gt;</span></pre>
<p>In this scenario, the caller thread will return with a CompletableFuture&lt;Invoice&gt; when the downstream flow provides
it as the payload of the reply to the gateway.
Some other process must complete the future when the invoice is ready.</p>
<pre class="programlisting">MyCompletableFuture&lt;Invoice&gt; order(Order order);</pre>
<pre class="programlisting"><span class="hl-tag">&lt;int:gateway</span> <span class="hl-attribute">service-interface</span>=<span class="hl-value">"foo.Service"</span> <span class="hl-attribute">default-request-channel</span>=<span class="hl-value">"orders"</span><span class="hl-tag"> /&gt;</span></pre>
<p>In this scenario, the caller thread will return with a CompletableFuture&lt;Invoice&gt; when the downstream flow provides
it as the payload of the reply to the gateway.
Some other process must complete the future when the invoice is ready.
If <code class="literal">DEBUG</code> logging is enabled, a log is emitted indicating that the async executor cannot be used for this scenario.</p>
<p><code class="literal">CompletableFuture</code> s can be used to perform additional manipulation on the reply, such as:</p>
<pre class="programlisting">CompletableFuture&lt;String&gt; process(String data);

...

CompletableFuture result = process(<span class="hl-string">"foo"</span>)
    .thenApply(t -&gt; t.toUpperCase());

...

String out = result.get(<span class="hl-number">10</span>, TimeUnit.SECONDS);</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_reactor_promise" href="#_reactor_promise"></a>Reactor Promise</h4></div></div></div>

<p>Starting with <span class="emphasis"><em>version 4.1</em></span>, the <code class="literal">GatewayProxyFactoryBean</code> allows the use of a <code class="literal">Reactor</code> with gateway interface methods, utilizing a <a class="ulink" href="https://github.com/reactor/reactor/wiki/Promises" target="_top"><code class="literal">Promise&lt;?&gt;</code></a> return type.
The internal <code class="literal">AsyncInvocationTask</code> is wrapped in a <code class="literal">reactor.function.Supplier</code>, using a default <code class="literal">RingBufferDispatcher</code> for the <code class="literal">Promise</code> consumption.
Only methods with the <code class="literal">Promise&lt;?&gt;</code> return type are run on the reactor&#8217;s dispatcher.</p>
<p>A <code class="literal">Promise</code> can be used to retrieve the result later (similar to a <code class="literal">Future&lt;?&gt;</code>) or you can consume from it with the dispatcher invoking your <code class="literal">Consumer</code> when the result is returned to the gateway.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>The <code class="literal">Promise</code> isn&#8217;t <span class="emphasis"><em>flushed</em></span> immediately by the framework.
Hence the underlying message flow won&#8217;t be started before the gateway method returns (as it is with <code class="literal">Future&lt;?&gt;</code> <code class="literal">Executor</code> task).
The flow will be started when the <code class="literal">Promise</code> is <span class="emphasis"><em>flushed</em></span> or via <code class="literal">Promise.await()</code>.
Alternatively, the <code class="literal">Promise</code> (being a <code class="literal">Composable</code>) might be a part of Reactor <code class="literal">Stream&lt;?&gt;</code>, when the <code class="literal">flush()</code> is related to the entire <code class="literal">Stream</code>.
For example:</p>
</td></tr></table></div>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@MessagingGateway</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">interface</span> TestGateway {

	<em><span class="hl-annotation" style="color: gray">@Gateway(requestChannel = "promiseChannel")</span></em>
	Promise&lt;Integer&gt; multiply(Integer value);

	}

	    ...

	<em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "promiseChannel")</span></em>
	<span class="hl-keyword">public</span> Integer multiply(Integer value) {
			<span class="hl-keyword">return</span> value * <span class="hl-number">2</span>;
	}

		...

	Streams.defer(Arrays.asList(<span class="hl-string">"1"</span>, <span class="hl-string">"2"</span>, <span class="hl-string">"3"</span>, <span class="hl-string">"4"</span>, <span class="hl-string">"5"</span>))
			.get()
			.map(Integer::parseInt)
			.mapMany(integer -&gt; testGateway.multiply(integer))
			.collect()
			.consume(integers -&gt; ...)
			.flush();</pre>
<p>Another example is a simple callback scenario:</p>
<pre class="programlisting">Promise&lt;Invoice&gt; promise = service.process(myOrder);

promise.consume(<span class="hl-keyword">new</span> Consumer&lt;Invoice&gt;() {
	<em><span class="hl-annotation" style="color: gray">@Override</span></em>
	<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> accept(Invoice invoice) {
		handleInvoice(invoice);
	}
})
.flush();</pre>
<p>The calling thread continues, with <code class="literal">handleInvoice()</code> being called when the flow completes.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="gateway-no-response" href="#gateway-no-response"></a>8.4.10&nbsp;Gateway behavior when no response arrives</h3></div></div></div>

<p>As it was explained earlier, the Gateway provides a convenient way of interacting with a Messaging system via POJO method invocations, but realizing that a typical method invocation, which is generally expected to always return (even with an Exception), might not always map one-to-one to message exchanges (e.g., a reply message might not arrive - which is equivalent to a method not returning).
It is important to go over several scenarios especially in the Sync Gateway case and understand the default behavior of the Gateway and how to deal with these scenarios to make the Sync Gateway behavior more predictable regardless of the outcome of the message flow that was initialed from such Gateway.</p>
<p>There are certain attributes that could be configured to make Sync Gateway behavior more predictable, but some of them might not always work as you might have expected.
One of them is <span class="emphasis"><em>reply-timeout</em></span> (at the method level or <span class="emphasis"><em>default-reply-timeout</em></span> at the gateway level).
So, lets look at the <span class="emphasis"><em>reply-timeout</em></span> attribute and see how it can/can&#8217;t influence the behavior of the Sync Gateway in various scenarios.
We will look at single-threaded scenario (all components downstream are connected via Direct Channel) and multi-threaded scenarios (e.g.,&nbsp;somewhere downstream you may have Pollable or Executor Channel which breaks single-thread boundary)</p>
<p><span class="emphasis"><em>Long running process downstream</em></span></p>
<p><span class="emphasis"><em>Sync Gateway - single-threaded</em></span>.
If a component downstream is still running (e.g., infinite loop or a very slow service), then setting a <span class="emphasis"><em>reply-timeout</em></span> has no effect and the Gateway method call will not return until such downstream service exits (via return or exception).
<span class="emphasis"><em>Sync&nbsp;Gateway - multi-threaded</em></span>.
If a component downstream is still running (e.g., infinite loop or a very slow service), in a multi-threaded message flow setting the <span class="emphasis"><em>reply-timeout</em></span> will have an effect by allowing gateway method invocation to return once the timeout has been reached, since the <code class="literal">GatewayProxyFactoryBean</code> &nbsp;will simply poll on the reply channel waiting for a message until the timeout expires.
However it could result in a <span class="emphasis"><em>null</em></span> return from the Gateway method if the timeout has been reached before the actual reply was produced.&nbsp;It is also important to understand that the reply message (if produced) will be sent to a reply channel after the Gateway method invocation might have returned, so you must be aware of that and design your flow with this in mind.</p>
<p><span class="emphasis"><em>Downstream component returns 'null'</em></span></p>
<p><span class="emphasis"><em>Sync Gateway - single-threaded</em></span>.
If a component downstream returns <span class="emphasis"><em>null</em></span> and no <span class="emphasis"><em>reply-timeout</em></span> has been configured, the Gateway method call will hang indefinitely unless: a) a <span class="emphasis"><em>reply-timeout</em></span> has been configured or b) the <span class="emphasis"><em>requires-reply</em></span> attribute has been set on the downstream component (e.g., service-activator) that might return <span class="emphasis"><em>null</em></span>.
In this case, an Exception would be thrown and propagated to the Gateway.<span class="emphasis"><em>Sync Gateway - multi-threaded</em></span>.
Behavior is the same as above.</p>
<p><span class="emphasis"><em>Downstream component return signature is <span class="emphasis"><em>void</em></span> while Gateway method signature is non-void</em></span></p>
<p><span class="emphasis"><em>Sync Gateway - single-threaded</em></span>.
If a component downstream returns <span class="emphasis"><em>void</em></span> and no <span class="emphasis"><em>reply-timeout</em></span> has been configured, the Gateway method call will hang indefinitely unless a <span class="emphasis"><em>reply-timeout</em></span> has been configured&nbsp; <span class="emphasis"><em>Sync Gateway - multi-threaded</em></span> Behavior is the same as above.</p>
<p><span class="emphasis"><em>Downstream component results in Runtime Exception (regardless of the method signature)</em></span></p>
<p><span class="emphasis"><em>Sync Gateway - single-threaded</em></span>.
If a component downstream throws a Runtime Exception, such exception will be propagated via an Error Message back to the gateway and re-thrown.
<span class="emphasis"><em>Sync Gateway - multi-threaded</em></span> Behavior is the same as above.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>It is also important to understand that by default <span class="emphasis"><em>reply-timeout</em></span> is unbounded* which means that if not explicitly set there are several scenarios (described above) where your Gateway method invocation might hang indefinitely.
So, make sure you analyze your flow and if there is even a remote possibility of one of these scenarios to occur, set the <span class="emphasis"><em>reply-timeout</em></span> attribute to a <span class="emphasis"><em>safe</em></span> value or, even better, set the <span class="emphasis"><em>requires-reply</em></span> attribute of the downstream component to <span class="emphasis"><em>true</em></span> to ensure a timely response as produced by the throwing of an Exception as soon as that downstream component does return null internally.
But also, realize that there are some scenarios (see the very first one) where <span class="emphasis"><em>reply-timeout</em></span> will not help.
That means it is also important to analyze your message flow and decide when to use a Sync Gateway vs an Async Gateway.
As you&#8217;ve seen the latter case is simply a matter of defining Gateway methods that return Future instances.
Then, you are guaranteed to receive that return value, and you will have more granular control over the results of the invocation.Also, when dealing with a Router you should remember that setting the <span class="emphasis"><em>resolution-required</em></span> attribute to <span class="emphasis"><em>true</em></span> will result in an Exception thrown by the router if it can not resolve a particular channel.
Likewise, when dealing with a Filter, you can set the <span class="emphasis"><em>throw-exception-on-rejection</em></span> attribute.
In both of these cases, the resulting flow will behave like that containing a service-activator with the <span class="emphasis"><em>requires-reply</em></span> attribute.
In other words, it will help to ensure a timely response from the Gateway method invocation.</p>
</td></tr></table></div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>* <span class="emphasis"><em>reply-timeout</em></span> is unbounded for <span class="emphasis"><em>&lt;gateway/&gt;</em></span> elements (created by the GatewayProxyFactoryBean).
Inbound gateways for external integration (ws, http, etc.) share many characteristics and attributes with these gateways.
However, for those inbound gateways, the default <span class="emphasis"><em>reply-timeout</em></span> is 1000 milliseconds (1 second).
If a downstream async handoff is made to another thread, you may need to increase this attribute to allow enough time for the flow to complete before the gateway times out.</p>
</td></tr></table></div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>It is important to understand that the timer starts when the thread returns to the gateway, i.e. when the
flow completes or a message is handed off to another thread.
At that time, the calling thread starts waiting for the reply.
If the flow was completely synchronous, the reply will be immediately available; for asynchronous flows, the thread
will wait for up to this time.</p>
</td></tr></table></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="service-activator" href="#service-activator"></a>8.5&nbsp;Service Activator</h2></div></div></div>

<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="service-activator-introduction" href="#service-activator-introduction"></a>8.5.1&nbsp;Introduction</h3></div></div></div>

<p>The Service Activator is the endpoint type for connecting any Spring-managed Object to an input channel so that it may play the role of a service.
If the service produces output, it may also be connected to an output channel.
Alternatively, an output producing service may be located at the end of a processing pipeline or message flow in which case, the inbound Message&#8217;s "replyChannel" header can be used.
This is the default behavior if no output channel is defined and, as with most of the configuration options you&#8217;ll see here, the same behavior actually applies for most of the other components we have seen.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="service-activator-namespace" href="#service-activator-namespace"></a>8.5.2&nbsp;Configuring Service Activator</h3></div></div></div>

<p>To create a Service Activator, use the <span class="emphasis"><em>service-activator</em></span> element with the <span class="emphasis"><em>input-channel</em></span> and <span class="emphasis"><em>ref</em></span> attributes:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:service-activator</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"exampleChannel"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"exampleHandler"</span><span class="hl-tag">/&gt;</span></pre>
<p>The configuration above assumes that "exampleHandler" either contains a single method annotated with the @ServiceActivator annotation or that it contains only one public method at all.
To delegate to an explicitly defined method of any object, simply add the "method" attribute.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:service-activator</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"exampleChannel"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"somePojo"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"someMethod"</span><span class="hl-tag">/&gt;</span></pre>
<p>In either case, when the service method returns a non-null value, the endpoint will attempt to send the reply message to an appropriate reply channel.
To determine the reply channel, it will first check if an "output-channel" was provided in the endpoint configuration:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:service-activator</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"exampleChannel"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"replyChannel"</span>
                       <span class="hl-attribute">ref</span>=<span class="hl-value">"somePojo"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"someMethod"</span><span class="hl-tag">/&gt;</span></pre>
<p>If the method returns a result and no "output-channel" is defined, the framework will then check the Message&#8217;s <code class="literal">replyChannel</code> header value.
If that value is available, it will then check its type.
If it is a`MessageChannel`, the reply message will be sent to that channel.
If it is a <code class="literal">String</code>, then the endpoint will attempt to resolve the channel name to a channel instance.
If the channel cannot be resolved, then a <code class="literal">DestinationResolutionException</code> will be thrown.
It it can be resolved, the Message will be sent there.
This is the technique used for Request Reply messaging in Spring Integration, and it is also an example of the Return Address pattern.</p>
<p>If your method returns a result, and you want to discard it and end the flow, you should configure the <code class="literal">output-channel</code> to send to a <code class="literal">NullChannel</code>.
For convenience, the framework registers one with the name <code class="literal">nullChannel</code>.
See <a class="xref" href="#channel-special-channels" title="4.1.6&nbsp;Special Channels">Section&nbsp;4.1.6, &#8220;Special Channels&#8221;</a> for more information.</p>
<p>The Service Activator is one of those components that is not required to produce a reply message.
If your method returns <code class="literal">null</code> or has a <code class="literal">void</code> return type, the Service Activator exits after the method invocation, without any signals.
This behavior can be controlled by the <code class="literal">AbstractReplyProducingMessageHandler.requiresReply</code> option, also exposed as <code class="literal">requires-reply</code> when configuring with the XML namespace.
If the flag is set to <code class="literal">true</code> and the method returns null, a <code class="literal">ReplyRequiredException</code> is thrown.</p>
<p>The argument in the service method could be either a Message or an arbitrary type.
If the latter, then it will be assumed that it is a Message payload, which will be extracted from the message and injected into such service method.
This is generally the recommended approach as it follows and promotes a POJO model when working with Spring Integration.
Arguments may also have @Header or @Headers annotations as described in <a class="xref" href="#annotations" title="F.6&nbsp;Annotation Support">Section&nbsp;F.6, &#8220;Annotation Support&#8221;</a></p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The service method is not required to have any arguments at all, which means you can implement event-style Service Activators, where all you care about is an invocation of the service method, not worrying about the contents of the message.
Think of it as a NULL JMS message.
An example use-case for such an implementation could be a simple counter/monitor of messages deposited on the input channel.</p>
</td></tr></table></div>
<p>Starting with <span class="emphasis"><em>version 4.1</em></span> the framework correct converts Message properties (<code class="literal">payload</code> and <code class="literal">headers</code>) to the Java 8 <code class="literal">Optional</code> POJO method parameters:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyBean {
    <span class="hl-keyword">public</span> String computeValue(Optional&lt;String&gt; payload,
               <em><span class="hl-annotation" style="color: gray">@Header(value="foo", required=false)</span></em> String foo1,
               <em><span class="hl-annotation" style="color: gray">@Header(value="foo")</span></em> Optional&lt;String&gt; foo2) {
        <span class="hl-keyword">if</span> (payload.isPresent()) {
            String value = payload.get();
            ...
        }
        <span class="hl-keyword">else</span> {
           ...
       }
    }

}</pre>
<p>Using a <code class="literal">ref</code> attribute is generally recommended if the custom Service Activator handler implementation can be reused in other <code class="literal">&lt;service-activator&gt;</code> definitions.
However if the custom Service Activator handler implementation is only used within a single definition of the <code class="literal">&lt;service-activator&gt;</code>, you can provide an inner bean definition:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:service-activator</span> <span class="hl-attribute">id</span>=<span class="hl-value">"exampleServiceActivator"</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"inChannel"</span>
            <span class="hl-attribute">output-channel</span> = <span class="hl-value">"outChannel"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"foo"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;beans:bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.foo.ExampleServiceActivator"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:service-activator&gt;</span></pre>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Using both the "ref" attribute and an inner handler definition in the same <code class="literal">&lt;service-activator&gt;</code> configuration is not allowed, as it creates an ambiguous condition and will result in an Exception being thrown.</p>
</td></tr></table></div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>If the "ref" attribute references a bean that extends <code class="literal">AbstractMessageProducingHandler</code> (such as handlers provided by the framework itself), the configuration is optimized by injecting the output channel into the handler directly.
In this case, each "ref" must be to a separate bean instance (or a <code class="literal">prototype</code>-scoped bean), or use the inner <code class="literal">&lt;bean/&gt;</code> configuration type.
If you inadvertently reference the same message handler from multiple beans, you will get a configuration exception.</p>
</td></tr></table></div>
<p><span class="emphasis"><em>Service Activators and the Spring Expression Language (SpEL)</em></span></p>
<p>Since Spring Integration 2.0, Service Activators can also benefit from SpEL (<a class="ulink" href="http://static.springsource.org/spring/docs/3.0.x/spring-framework-reference/html/expressions.html" target="_top">http://static.springsource.org/spring/docs/3.0.x/spring-framework-reference/html/expressions.html</a>).</p>
<p>For example, you may now invoke any bean method without pointing to the bean via a <code class="literal">ref</code> attribute or including it as an inner bean definition.
For example:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:service-activator</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"in"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"out"</span>
	<span class="hl-attribute">expression</span>=<span class="hl-value">"@accountService.processAccount(payload, headers.accountId)"</span><span class="hl-tag">/&gt;</span>

	<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"accountService"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"foo.bar.Account"</span><span class="hl-tag">/&gt;</span></pre>
<p>In the above configuration instead of injecting <span class="emphasis"><em>accountService</em></span> using a <code class="literal">ref</code> or as an inner bean, we are simply using SpEL&#8217;s <code class="literal">@beanId</code> notation and invoking a method which takes a type compatible with Message payload.
We are also passing a header value.
As you can see, any valid SpEL expression can be evaluated against any content in the Message.
For simple scenarios your <span class="emphasis"><em>Service Activators</em></span> do not even have to reference a bean if all logic can be encapsulated by such an expression.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:service-activator</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"in"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"out"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"payload * 2"</span><span class="hl-tag">/&gt;</span></pre>
<p>In the above configuration our service logic is to simply multiply the payload value by 2, and SpEL lets us handle it relatively easy.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="async-service-activator" href="#async-service-activator"></a>8.5.3&nbsp;Asynchronous Service Activator</h3></div></div></div>

<p>The service activator is invoked by the calling thread; this would be some upstream thread if the input channel is a
<code class="literal">SubscribableChannel</code>, or a poller thread for a <code class="literal">PollableChannel</code>.
If the service returns a <code class="literal">ListenableFuture&lt;?&gt;</code> the default action is to send that as the payload of the message sent
to the output (or reply) channel.
Starting with <span class="emphasis"><em>version 4.3</em></span>, you can now set the <code class="literal">async</code> attribute to true (<code class="literal">setAsync(true)</code> when using
Java configuration).
If the service returns a <code class="literal">ListenableFuture&lt;?&gt;</code> when this is true, the calling thread is released immediately, and the
reply message is sent on the thread (from within your service) that completes the future.
This is particularly advantageous for long-running services using a <code class="literal">PollableChannel</code> because the poller thread is
freed up to perform other services within the framework.</p>
<p>If the service completes the future with an <code class="literal">Exception</code>, normal error processing will occur - an <code class="literal">ErrorMessage</code> is
sent to the <code class="literal">errorChannel</code> message header, if present or otherwise to the default <code class="literal">errorChannel</code> (if available).</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="delayer" href="#delayer"></a>8.6&nbsp;Delayer</h2></div></div></div>

<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="delayer-introduction" href="#delayer-introduction"></a>8.6.1&nbsp;Introduction</h3></div></div></div>

<p>A Delayer is a simple endpoint that allows a Message flow to be delayed by a certain interval.
When a Message is delayed, the original sender will not block.
Instead, the delayed Messages will be scheduled with an instance of <code class="literal">org.springframework.scheduling.TaskScheduler</code> to be sent to the output channel after the delay has passed.
This approach is scalable even for rather long delays, since it does not result in a large number of blocked sender Threads.
On the contrary, in the typical case a thread pool will be used for the actual execution of releasing the Messages.
Below you will find several examples of configuring a Delayer.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="delayer-namespace" href="#delayer-namespace"></a>8.6.2&nbsp;Configuring Delayer</h3></div></div></div>

<p>The <code class="literal">&lt;delayer&gt;</code> element is used to delay the Message flow between two Message Channels.
As with the other endpoints, you can provide the <span class="emphasis"><em>input-channel</em></span> and <span class="emphasis"><em>output-channel</em></span> attributes, but the delayer also has <span class="emphasis"><em>default-delay</em></span> and <span class="emphasis"><em>expression</em></span> attributes (and <span class="emphasis"><em>expression</em></span> sub-element) that are used to determine the number of milliseconds that each Message should be delayed.
The following delays all messages by 3 seconds:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:delayer</span> <span class="hl-attribute">id</span>=<span class="hl-value">"delayer"</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span>
             <span class="hl-attribute">default-delay</span>=<span class="hl-value">"3000"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span><span class="hl-tag">/&gt;</span></pre>
<p>If you need per-Message determination of the delay, then you can also provide the SpEL expression using the <span class="emphasis"><em>expression</em></span> attribute:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:delayer</span> <span class="hl-attribute">id</span>=<span class="hl-value">"delayer"</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span>
             <span class="hl-attribute">default-delay</span>=<span class="hl-value">"3000"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"headers['delay']"</span><span class="hl-tag">/&gt;</span></pre>
<p>In the example above, the 3 second delay would only apply when the expression evaluates to <span class="emphasis"><em>null</em></span> for a given inbound Message.
If you only want to apply a delay to Messages that have a valid result of the expression evaluation, then you can use a <span class="emphasis"><em>default-delay</em></span> of 0 (the default).
For any Message that has a delay of 0 (or less), the Message will be sent immediately, on the calling Thread.</p>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>The delay handler supports expression evaluation results that represent an interval in milliseconds (any Object whose <code class="literal">toString()</code> method produces a value that can be parsed into a Long) as well as <code class="literal">java.util.Date</code> instances representing an absolute time.
In the first case, the milliseconds will be counted from the current time (e.g.
a value of 5000 would delay the Message for at least 5 seconds from the time it is received by the Delayer).
With a Date instance, the Message will not be released until the time represented by that Date object.
In either case, a value that equates to a non-positive delay, or a Date in the past, will not result in any delay.
Instead, it will be sent directly to the output channel on the original sender&#8217;s Thread.
If the expression evaluation result is not a Date, and can not be parsed as a Long, the default delay (if any) will be applied.</p>
</td></tr></table></div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>The expression evaluation may throw an evaluation Exception for various reasons, including an invalid expression, or other conditions.
By default, such exceptions are ignored (logged at DEBUG level) and the delayer falls back to the default delay (if any).
You can modify this behavior by setting the <code class="literal">ignore-expression-failures</code> attribute.
By default this attribute is set to <code class="literal">true</code> and the Delayer behavior is as described above.
However, if you wish to not ignore expression evaluation exceptions, and throw them to the delayer&#8217;s caller, set the <code class="literal">ignore-expression-failures</code> attribute to <code class="literal">false</code>.</p>
</td></tr></table></div>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>Notice in the example above that the delay expression is specified as <code class="literal">headers['delay']</code>.
This is the SpEL <code class="literal">Indexer</code> syntax to access a <code class="literal">Map</code> element (<code class="literal">MessageHeaders</code> implements <code class="literal">Map</code>), it invokes: <code class="literal">headers.get("delay")</code>.
For simple map element names (that do not contain <span class="emphasis"><em>.</em></span>) you can also use the SpEL <span class="emphasis"><em>dot accessor</em></span> syntax, where the above header expression can be specified as <code class="literal">headers.delay</code>.
But, different results are achieved if the header is missing.
In the first case, the expression will evaluate to <code class="literal">null</code>; the second will result in something like:</p>
<pre class="programlisting"> org.springframework.expression.spel.SpelEvaluationException: EL1<span class="hl-number">008E</span>:(pos <span class="hl-number">8</span>):
		   Field or property <span class="hl-string">'delay'</span> cannot be found on object of type <span class="hl-string">'org.springframework.messaging.MessageHeaders'</span></pre>
<p>So, if there is a possibility of the header being omitted, and you want to fall back to the default delay, it is generally more efficient (and recommended) to use the <span class="emphasis"><em>Indexer</em></span> syntax instead of <span class="emphasis"><em>dot property accessor</em></span> syntax, because detecting the null is faster than catching an exception.</p>
</td></tr></table></div>
<p>The delayer delegates to an instance of Spring&#8217;s <code class="literal">TaskScheduler</code> abstraction.
The default scheduler used by the delayer is the <code class="literal">ThreadPoolTaskScheduler</code> instance provided by Spring Integration on startup: <a class="xref" href="#namespace-taskscheduler" title="F.3&nbsp;Configuring the Task Scheduler">Section&nbsp;F.3, &#8220;Configuring the Task Scheduler&#8221;</a>.
If you want to delegate to a different scheduler, you can provide a reference through the delayer element&#8217;s <span class="emphasis"><em>scheduler</em></span> attribute:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:delayer</span> <span class="hl-attribute">id</span>=<span class="hl-value">"delayer"</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span>
    <span class="hl-attribute">expression</span>=<span class="hl-value">"headers.delay"</span>
    <span class="hl-attribute">scheduler</span>=<span class="hl-value">"exampleTaskScheduler"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;task:scheduler</span> <span class="hl-attribute">id</span>=<span class="hl-value">"exampleTaskScheduler"</span> <span class="hl-attribute">pool-size</span>=<span class="hl-value">"3"</span><span class="hl-tag">/&gt;</span></pre>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>If you configure an external <code class="literal">ThreadPoolTaskScheduler</code> you can set on this scheduler property <code class="literal">waitForTasksToCompleteOnShutdown = true</code>.
It allows successful completion of <span class="emphasis"><em>delay</em></span> tasks, which already in the execution state (releasing the Message), when the application is shutdown.
Before Spring Integration 2.2 this property was available on the <code class="literal">&lt;delayer&gt;</code> element, because <code class="literal">DelayHandler</code> could create its own scheduler on the background.
Since 2.2 delayer requires an external scheduler instance and <code class="literal">waitForTasksToCompleteOnShutdown</code> was deleted; you should use the scheduler&#8217;s own configuration.</p>
</td></tr></table></div>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>Also keep in mind <code class="literal">ThreadPoolTaskScheduler</code> has a property <code class="literal">errorHandler</code> which can be injected with some implementation of <code class="literal">org.springframework.util.ErrorHandler</code>.
This handler allows to process an <code class="literal">Exception</code> from the thread of the scheduled task sending the delayed message.
By default it uses an <code class="literal">org.springframework.scheduling.support.TaskUtils$LoggingErrorHandler</code> and you will see a stack trace in the logs.
You might want to consider using an <code class="literal">org.springframework.integration.channel.MessagePublishingErrorHandler</code>, which sends an <code class="literal">ErrorMessage</code> into an <code class="literal">error-channel</code>, either from the failed Message&#8217;s header or into the default <code class="literal">error-channel</code>.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="delayer-message-store" href="#delayer-message-store"></a>8.6.3&nbsp;Delayer and Message Store</h3></div></div></div>

<p>The <code class="literal">DelayHandler</code> persists delayed Messages into the Message Group in the provided <code class="literal">MessageStore</code>.
(The <span class="emphasis"><em>groupId</em></span> is based on required <span class="emphasis"><em>id</em></span> attribute of <code class="literal">&lt;delayer&gt;</code> element.) A delayed message is removed from the <code class="literal">MessageStore</code> by the scheduled task just before the <code class="literal">DelayHandler</code> sends the Message to the <code class="literal">output-channel</code>.
If the provided <code class="literal">MessageStore</code> is persistent (e.g.
<code class="literal">JdbcMessageStore</code>) it provides the ability to not lose Messages on the application shutdown.
After application startup, the <code class="literal">DelayHandler</code> reads Messages from its Message Group in the <code class="literal">MessageStore</code> and reschedules them with a delay based on the original arrival time of the Message (if the delay is numeric).
For messages where the delay header was a <code class="literal">Date</code>, that is used when rescheduling.
If a delayed Message remained in the <code class="literal">MessageStore</code> more than its <span class="emphasis"><em>delay</em></span>, it will be sent immediately after startup.</p>
<p>The <code class="literal">&lt;delayer&gt;</code> can be enriched with mutually exclusive sub-elements <code class="literal">&lt;transactional&gt;</code> or <code class="literal">&lt;advice-chain&gt;</code>.
The List of these AOP Advices is applied to the proxied internal <code class="literal">DelayHandler.ReleaseMessageHandler</code>, which has the responsibility to release the Message, after the delay, on a <code class="literal">Thread</code> of the scheduled task.
It might be used, for example, when the downstream message flow throws an Exception and the <code class="literal">ReleaseMessageHandler</code>'s transaction will be rolled back.
In this case the delayed Message will remain in the persistent <code class="literal">MessageStore</code>.
You can use any custom <code class="literal">org.aopalliance.aop.Advice</code> implementation within the <code class="literal">&lt;advice-chain&gt;</code>.
A sample configuration of the <code class="literal">&lt;delayer&gt;</code> may look like this:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:delayer</span> <span class="hl-attribute">id</span>=<span class="hl-value">"delayer"</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span>
    <span class="hl-attribute">expression</span>=<span class="hl-value">"headers.delay"</span>
    <span class="hl-attribute">message-store</span>=<span class="hl-value">"jdbcMessageStore"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:advice-chain&gt;</span>
        <span class="hl-tag">&lt;beans:ref</span> <span class="hl-attribute">bean</span>=<span class="hl-value">"customAdviceBean"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;tx:advice&gt;</span>
            <span class="hl-tag">&lt;tx:attributes&gt;</span>
                <span class="hl-tag">&lt;tx:method</span> <span class="hl-attribute">name</span>=<span class="hl-value">"*"</span> <span class="hl-attribute">read-only</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;/tx:attributes&gt;</span>
        <span class="hl-tag">&lt;/tx:advice&gt;</span>
    <span class="hl-tag">&lt;/int:advice-chain&gt;</span>
<span class="hl-tag">&lt;/int:delayer&gt;</span></pre>
<p>The <code class="literal">DelayHandler</code> can be exported as a JMX <code class="literal">MBean</code> with managed operations <code class="literal">getDelayedMessageCount</code> and <code class="literal">reschedulePersistedMessages</code>, which allows the rescheduling of delayed persisted Messages at runtime, for example, if the <code class="literal">TaskScheduler</code> has previously been stopped.
These operations can be invoked via a <code class="literal">Control Bus</code> command:</p>
<pre class="programlisting">Message&lt;String&gt; delayerReschedulingMessage =
    MessageBuilder.withPayload(<span class="hl-string">"@'delayer.handler'.reschedulePersistedMessages()"</span>).build();
    controlBusChannel.send(delayerReschedulingMessage);</pre>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>For more information regarding the Message Store, JMX and the Control Bus, please read <a class="xref" href="#system-management-chapter" title="9.&nbsp;System Management">Chapter&nbsp;9, <i>System Management</i></a>.</p>
</td></tr></table></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="scripting" href="#scripting"></a>8.7&nbsp;Scripting support</h2></div></div></div>

<p>With Spring Integration 2.1 we&#8217;ve added support for the <a class="ulink" href="http://jcp.org/aboutJava/communityprocess/pr/jsr223/" target="_top">JSR223 Scripting for Java specification</a>, introduced in Java version 6.
This allows you to use scripts written in any supported language including Ruby/JRuby, Javascript and Groovy to provide the logic for various integration components similar to the way the Spring Expression Language (SpEL) is used in Spring Integration.
For more information about JSR223 please refer to the <a class="ulink" href="http://java.sun.com/developer/technicalArticles/J2SE/Desktop/scripting/" target="_top">documentation</a></p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Note that this feature requires Java 6 or higher.
Sun developed a JSR223 reference implementation which works with Java 5 but it is not officially supported and we have not tested it with Spring Integration.</p>
</td></tr></table></div>
<p>In order to use a JVM scripting language, a JSR223 implementation for that language must be included in your class path.
Java 6 natively supports Javascript.
The <a class="ulink" href="http://www.groovy-lang.org/" target="_top">Groovy</a> and <a class="ulink" href="http://jruby.org/" target="_top">JRuby</a> projects provide JSR233 support in their standard distribution.
Other language implementations may be available or under development.
Please refer to the appropriate project website for more information.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Various JSR223 language implementations have been developed by third parties.
A particular implementation&#8217;s compatibility with Spring Integration depends on how well it conforms to the specification and/or the implementer&#8217;s interpretation of the specification.</p>
</td></tr></table></div>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>If you plan to use Groovy as your scripting language, we recommended you use <a class="link" href="#groovy" title="8.8&nbsp;Groovy support">Spring-Integration&#8217;s Groovy Support</a> as it offers additional features specific to Groovy.
<span class="emphasis"><em>However you will find this section relevant as well</em></span>.</p>
</td></tr></table></div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="scripting-config" href="#scripting-config"></a>8.7.1&nbsp;Script configuration</h3></div></div></div>

<p>Depending on the complexity of your integration requirements scripts may be provided inline as CDATA in XML configuration&nbsp;or as a reference to a Spring resource containing the script.
To enable scripting support Spring Integration defines a <code class="literal">ScriptExecutingMessageProcessor</code>&nbsp;which will bind the Message Payload to a variable named <code class="literal">payload</code> and the Message Headers to a <code class="literal">headers</code> variable, both accessible within the script execution context.
All that is left for you to do is write a script that uses these variables.
Below are a couple of sample configurations:</p>
<p><span class="emphasis"><em>Filter</em></span></p>
<pre class="programlisting"><span class="hl-tag">&lt;int:filter</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"referencedScriptInput"</span><span class="hl-tag">&gt;</span>
   <span class="hl-tag">&lt;int-script:script</span> <span class="hl-attribute">lang</span>=<span class="hl-value">"ruby"</span> <span class="hl-attribute">location</span>=<span class="hl-value">"some/path/to/ruby/script/RubyFilterTests.rb"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:filter&gt;</span>

<span class="hl-tag">&lt;int:filter</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"inlineScriptInput"</span><span class="hl-tag">&gt;</span>
     <span class="hl-tag">&lt;int-script:script</span> <span class="hl-attribute">lang</span>=<span class="hl-value">"groovy"</span><span class="hl-tag">&gt;</span>
     <span class="hl-tag">&lt;![CDATA[</span>
     return payload == 'good'
   <span class="hl-tag">]]&gt;</span>
  <span class="hl-tag">&lt;/int-script:script&gt;</span>
<span class="hl-tag">&lt;/int:filter&gt;</span></pre>
<p>Here, you see that the script can be included inline or can reference a resource location via the <code class="literal">location</code> attribute.
Additionally the <code class="literal">lang</code> attribute corresponds to the language name (or JSR223 alias)</p>
<p>Other Spring Integration endpoint elements which support scripting include <span class="emphasis"><em>router</em></span>, <span class="emphasis"><em>service-activator</em></span>, <span class="emphasis"><em>transformer</em></span>, and <span class="emphasis"><em>splitter</em></span>.
The scripting configuration in each case would be identical to the above (besides the endpoint element).</p>
<p>Another useful feature of Scripting support is the ability to update (reload) scripts without having to restart the Application Context.
To accomplish this, specify the <code class="literal">refresh-check-delay</code> attribute on the <span class="emphasis"><em>script</em></span> element:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-script:script&nbsp;location="..."</span> <span class="hl-attribute">refresh-check-delay</span>=<span class="hl-value">"5000"</span><span class="hl-tag">/&gt;</span></pre>
<p>In the above example, the script location will be checked for updates every 5 seconds.
If the script is updated, any invocation that occurs later than 5 seconds since the update will result in execution of the new script.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-script:script&nbsp;location="..."</span> <span class="hl-attribute">refresh-check-delay</span>=<span class="hl-value">"0"</span><span class="hl-tag">/&gt;</span></pre>
<p>In the above example the context will be updated with any script modifications as soon as such modification occurs, providing a simple mechanism for <span class="emphasis"><em>real-time</em></span> configuration.
Any negative number value means the script will not be reloaded after initialization of the application context.
This is the default behavior.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Inline scripts can not be reloaded.</p>
</td></tr></table></div>
<pre class="programlisting"><span class="hl-tag">&lt;int-script:script&nbsp;location="..."</span> <span class="hl-attribute">refresh-check-delay</span>=<span class="hl-value">"-1"</span><span class="hl-tag">/&gt;</span></pre>
<p><span class="emphasis"><em>Script variable bindings</em></span></p>
<p>Variable bindings are required to enable the script to reference variables externally provided to the script&#8217;s execution context.
As we have seen, <code class="literal">payload</code> and <code class="literal">headers</code> are used as binding variables by default.
You can bind additional variables to a script via <code class="literal">&lt;variable&gt;</code> sub-elements:</p>
<pre class="programlisting"><span class="hl-tag">&lt;script:script</span> <span class="hl-attribute">lang</span>=<span class="hl-value">"js"</span> <span class="hl-attribute">location</span>=<span class="hl-value">"foo/bar/MyScript.js"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;script:variable</span> <span class="hl-attribute">name</span>=<span class="hl-value">"foo"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"foo"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;script:variable</span> <span class="hl-attribute">name</span>=<span class="hl-value">"bar"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"bar"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;script:variable</span> <span class="hl-attribute">name</span>=<span class="hl-value">"date"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"date"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/script:script&gt;</span></pre>
<p>As shown in the above example, you can bind a script variable either to a scalar value or a Spring bean reference.
Note that <code class="literal">payload</code> and <code class="literal">headers</code> will still be included as binding variables.</p>
<p>With <span class="emphasis"><em>Spring Integration 3.0</em></span>, in addition to the <code class="literal">variable</code> sub-element, the <code class="literal">variables</code> attribute has been introduced.
This attribute and <code class="literal">variable</code> sub-elements aren&#8217;t mutually exclusive and you can combine them within one <code class="literal">script</code> component.
However variables must be unique, regardless of where they are defined.
Also, since <span class="emphasis"><em>Spring Integration 3.0</em></span>, variable bindings are allowed for inline scripts too:</p>
<pre class="programlisting"><span class="hl-tag">&lt;service-activator</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;script:script</span> <span class="hl-attribute">lang</span>=<span class="hl-value">"ruby"</span> <span class="hl-attribute">variables</span>=<span class="hl-value">"foo=FOO, date-ref=dateBean"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;script:variable</span> <span class="hl-attribute">name</span>=<span class="hl-value">"bar"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"barBean"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;script:variable</span> <span class="hl-attribute">name</span>=<span class="hl-value">"baz"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"bar"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;![CDATA[</span>
            payload.foo = foo
            payload.date = date
            payload.bar = bar
            payload.baz = baz
            payload
        <span class="hl-tag">]]&gt;</span>
    <span class="hl-tag">&lt;/script:script&gt;</span>
<span class="hl-tag">&lt;/service-activator&gt;</span></pre>
<p>The example above shows a combination of an inline script, a <code class="literal">variable</code> sub-element and a <code class="literal">variables</code> attribute.
The <code class="literal">variables</code> attribute is a comma-separated value, where each segment contains an <span class="emphasis"><em>=</em></span> separated pair of the variable and its value.
The variable name can be suffixed with <code class="literal">-ref</code>, as in the <code class="literal">date-ref</code> variable above.
That means that the binding variable will have the name <code class="literal">date</code>, but the value will be a reference to the <code class="literal">dateBean</code> bean from the application context.
This may be useful when using <span class="emphasis"><em>Property Placeholder Configuration</em></span> or command line arguments.</p>
<p>If you need more control over how variables are generated, you can implement your own Java class using the <code class="literal">ScriptVariableGenerator</code> strategy:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> ScriptVariableGenerator {

    Map&lt;String, Object&gt; generateScriptVariables(Message&lt;?&gt; message);

}</pre>
<p>This interface requires you to implement the method <code class="literal">generateScriptVariables(Message)</code>.
The Message argument allows you to access any data available in the Message payload and headers and the return value is the Map of bound variables.
This method will be called every time the script is executed for a Message.
All you need to do is provide an implementation of <code class="literal">ScriptVariableGenerator</code> and reference it with the <code class="literal">script-variable-generator</code> attribute:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-script:script</span> <span class="hl-attribute">location</span>=<span class="hl-value">"foo/bar/MyScript.groovy"</span>
        <span class="hl-attribute">script-variable-generator</span>=<span class="hl-value">"variableGenerator"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"variableGenerator"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"foo.bar.MyScriptVariableGenerator"</span><span class="hl-tag">/&gt;</span></pre>
<p>If a <code class="literal">script-variable-generator</code> is not provided, script components use <code class="literal">DefaultScriptVariableGenerator</code>, which merges any provided <code class="literal">&lt;variable&gt;</code> s with <span class="emphasis"><em>payload</em></span> and <span class="emphasis"><em>headers</em></span> variables from the <code class="literal">Message</code> in its <code class="literal">generateScriptVariables(Message)</code> method.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>You cannot provide both the <code class="literal">script-variable-generator</code> attribute and <code class="literal">&lt;variable&gt;</code> sub-element(s) as they are mutually exclusive.</p>
</td></tr></table></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="groovy" href="#groovy"></a>8.8&nbsp;Groovy support</h2></div></div></div>

<p>In Spring Integration 2.0 we added Groovy support allowing you to use the Groovy scripting language to provide the logic for various integration components similar to the way the Spring Expression Language (SpEL) is supported for routing, transformation and other integration concerns.
For more information about Groovy please refer to the Groovy documentation which you can find on the <a class="ulink" href="http://www.groovy-lang.org/" target="_top">project website</a>.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="groovy-config" href="#groovy-config"></a>8.8.1&nbsp;Groovy configuration</h3></div></div></div>

<p>With Spring Integration 2.1, Groovy Support&#8217;s configuration namespace is an extension of Spring Integration&#8217;s Scripting Support and shares the core configuration and behavior described in detail in the <a class="link" href="#scripting" title="8.7&nbsp;Scripting support">Scripting Support</a> section.
Even though Groovy scripts are well supported by generic Scripting Support, Groovy Support provides the <span class="emphasis"><em>Groovy</em></span> configuration namespace which is backed by the Spring Framework&#8217;s <code class="literal">org.springframework.scripting.groovy.GroovyScriptFactory</code> and related components, offering extended capabilities for using Groovy.
Below are a couple of sample configurations:</p>
<p><span class="emphasis"><em>Filter</em></span></p>
<pre class="programlisting"><span class="hl-tag">&lt;int:filter</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"referencedScriptInput"</span><span class="hl-tag">&gt;</span>
   <span class="hl-tag">&lt;int-groovy:script</span> <span class="hl-attribute">location</span>=<span class="hl-value">"some/path/to/groovy/file/GroovyFilterTests.groovy"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:filter&gt;</span>

<span class="hl-tag">&lt;int:filter</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"inlineScriptInput"</span><span class="hl-tag">&gt;</span>
     <span class="hl-tag">&lt;int-groovy:script&gt;</span><span class="hl-tag">&lt;![CDATA[</span>
     return payload == 'good'
   <span class="hl-tag">]]&gt;</span><span class="hl-tag">&lt;/int-groovy:script&gt;</span>
<span class="hl-tag">&lt;/int:filter&gt;</span></pre>
<p>As the above examples show, the configuration looks identical to the general Scripting Support configuration.
The only difference is the use of the Groovy namespace as indicated in the examples by the <span class="emphasis"><em>int-groovy</em></span> namespace prefix.
Also note that the <code class="literal">lang</code> attribute on the <code class="literal">&lt;script&gt;</code> tag is not valid in this namespace.</p>
<p><span class="emphasis"><em>Groovy object customization</em></span></p>
<p>If you need to customize the Groovy object itself, beyond setting variables, you can reference a bean that implements <code class="literal">GroovyObjectCustomizer</code> via the <code class="literal">customizer</code> attribute.
For example, this might be useful if you want to implement a domain-specific language (DSL) by modifying the <code class="literal">MetaClass</code> and registering functions to be available within the script:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:service-activator</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"groovyChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int-groovy:script</span> <span class="hl-attribute">location</span>=<span class="hl-value">"foo/SomeScript.groovy"</span> <span class="hl-attribute">customizer</span>=<span class="hl-value">"groovyCustomizer"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:service-activator&gt;</span>

<span class="hl-tag">&lt;beans:bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"groovyCustomizer"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.foo.MyGroovyObjectCustomizer"</span><span class="hl-tag">/&gt;</span></pre>
<p>Setting a custom <code class="literal">GroovyObjectCustomizer</code> is not mutually exclusive with <code class="literal">&lt;variable&gt;</code> sub-elements or the <code class="literal">script-variable-generator</code> attribute.
It can also be provided when defining an inline script.</p>
<p>With <span class="emphasis"><em>Spring Integration 3.0</em></span>, in addition to the <code class="literal">variable</code> sub-element, the <code class="literal">variables</code> attribute has been introduced.
Also, groovy scripts have the ability to resolve a variable to a bean in the <code class="literal">BeanFactory</code>, if a binding variable was not provided with the name:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-groovy:script&gt;</span>
    <span class="hl-tag">&lt;![CDATA[</span>
        entityManager.persist(payload)
        payload
    <span class="hl-tag">]]&gt;</span>
<span class="hl-tag">&lt;/int-groovy:script&gt;</span></pre>
<p>where variable <code class="literal">entityManager</code> is an appropriate bean in the application context.</p>
<p>For more information regarding <code class="literal">&lt;variable&gt;</code>, <code class="literal">variables</code>, and <code class="literal">script-variable-generator</code>, see the paragraph <span class="emphasis"><em><span class="emphasis"><em>Script variable bindings</em></span></em></span> of <a class="xref" href="#scripting-config" title="8.7.1&nbsp;Script configuration">Section&nbsp;8.7.1, &#8220;Script configuration&#8221;</a>.</p>
<p><span class="emphasis"><em>Groovy Script Compiler Customization</em></span></p>
<p>The <code class="literal">@CompileStatic</code> hint is the most popular Groovy compiler customization option,
which can be used on the class or method level.
See more information in the Groovy
<a class="ulink" href="http://docs.groovy-lang.org/latest/html/documentation/index.html#_static_compilation" target="_top">Reference Manual</a> and,
specifically, <a class="ulink" href="http://docs.groovy-lang.org/latest/html/documentation/index.html#compilestatic-annotation" target="_top">@CompileStatic</a>.
To utilize this feature for short scripts (in integration scenarios), we are forced to change a simple script like this
(a <code class="literal">&lt;filter&gt;</code> script):</p>
<pre class="programlisting">headers.type == <span class="hl-string">'good'</span></pre>
<p>to more Java-like code:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@groovy.transform.CompileStatic</span></em>
String filter(Map headers) {
	headers.type == <span class="hl-string">'good'</span>
}

filter(headers)</pre>
<p>With that, the <code class="literal">filter()</code> method will be transformed and compiled to static Java code, bypassing the Groovy
dynamic phases of invocation, like <code class="literal">getProperty()</code> factories and <code class="literal">CallSite</code> proxies.</p>
<p>Starting with <span class="emphasis"><em>version 4.3</em></span>, Spring Integration Groovy components can be configured with the <code class="literal">compile-static</code> <code class="literal">boolean</code>
option, specifying that <code class="literal">ASTTransformationCustomizer</code> for <code class="literal">@CompileStatic</code> should be added to the internal
<code class="literal">CompilerConfiguration</code>.
With that in place, we can omit the method declaration with <code class="literal">@CompileStatic</code> in our script code and still get compiled
plain Java code.
In this case our script can still be short but still needs to be a little more verbose than interpreted script:</p>
<pre class="programlisting">binding.variables.headers.type == <span class="hl-string">'good'</span></pre>
<p>Where we can access the <code class="literal">headers</code> and <code class="literal">payload</code> (or any other) variables only through the <code class="literal">groovy.lang.Script</code>
<code class="literal">binding</code> property since, with <code class="literal">@CompileStatic</code>, we don&#8217;t have the  dynamic <code class="literal">GroovyObject.getProperty()</code> capability.</p>
<p>In addition, the <code class="literal">compiler-configuration</code> bean reference has been introduced.
With this attribute, you can provide any other required Groovy compiler customizations, e.g. <code class="literal">ImportCustomizer</code>.
For more information about this feature, please, refer to the Groovy Documentation:
<a class="ulink" href="http://groovy.jmiguel.eu/groovy.codehaus.org/Advanced+compiler+configuration.html" target="_top">Advanced compiler configuration</a>.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Using <code class="literal">compilerConfiguration</code> does not automatically add a <code class="literal">ASTTransformationCustomizer</code> for <code class="literal">@CompileStatic</code>
and overrides the <code class="literal">compileStatic</code> option.
If <code class="literal">CompileStatic</code> is still requirement, a <code class="literal">new ASTTransformationCustomizer(CompileStatic.class)</code> should be manually
added into the <code class="literal">CompilationCustomizers</code> of that custom <code class="literal">compilerConfiguration</code>.</p>
</td></tr></table></div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The Groovy compiler customization does not have any effect to the <code class="literal">refresh-check-delay</code> option
and reloadable scripts can be statically compiled, too.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="groovy-control-bus" href="#groovy-control-bus"></a>8.8.2&nbsp;Control Bus</h3></div></div></div>

<p>As described in (<a class="ulink" href="http://www.eaipatterns.com/ControlBus.html" target="_top">EIP</a>), the idea behind the Control Bus is that the same messaging system can be used for monitoring and managing the components within the framework as is used for "application-level" messaging.
In Spring Integration we build upon the adapters described above so that it&#8217;s possible to send Messages as a means of invoking exposed operations.
One option for those operations is Groovy scripts.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-groovy:control-bus</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"operationChannel"</span><span class="hl-tag">/&gt;</span></pre>
<p>The Control Bus has an input channel that can be accessed for invoking operations on the beans in the application context.</p>
<p>The Groovy Control Bus executes messages on the input channel as Groovy scripts.
It takes a message, compiles the body to a Script, customizes it with a <code class="literal">GroovyObjectCustomizer</code>, and then executes it.
The Control Bus' <code class="literal">MessageProcessor</code> exposes all beans in the application context that are annotated with <code class="literal">@ManagedResource</code>, implement Spring&#8217;s <code class="literal">Lifecycle</code> interface or extend Spring&#8217;s <code class="literal">CustomizableThreadCreator</code> base class (e.g.
several of the <code class="literal">TaskExecutor</code> and <code class="literal">TaskScheduler</code> implementations).</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Be careful about using managed beans with custom scopes (e.g.
<span class="emphasis"><em>request</em></span>) in the Control Bus' command scripts, especially inside an <span class="emphasis"><em>async</em></span> message flow.
If The Control Bus' <code class="literal">MessageProcessor</code> can&#8217;t expose a bean from the application context, you may end up with some <code class="literal">BeansException</code> during <span class="emphasis"><em>command script&#8217;s</em></span> executing.
For example, if a custom scope&#8217;s context is not established, the attempt to get a bean within that scope will trigger a <code class="literal">BeanCreationException</code>.</p>
</td></tr></table></div>
<p>If you need to further customize the Groovy objects, you can also provide a reference to a bean that implements <code class="literal">GroovyObjectCustomizer</code> via the <code class="literal">customizer</code> attribute.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-groovy:control-bus</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span>
        <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span>
        <span class="hl-attribute">customizer</span>=<span class="hl-value">"groovyCustomizer"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;beans:bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"groovyCustomizer"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.foo.MyGroovyObjectCustomizer"</span><span class="hl-tag">/&gt;</span></pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="message-handler-advice-chain" href="#message-handler-advice-chain"></a>8.9&nbsp;Adding Behavior to Endpoints</h2></div></div></div>

<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="mhac-intro" href="#mhac-intro"></a>8.9.1&nbsp;Introduction</h3></div></div></div>

<p>Prior to Spring Integration <span class="emphasis"><em>2.2</em></span>, you could add behavior to an entire Integration flow by adding an AOP Advice to a poller&#8217;s <code class="literal">&lt;advice-chain/&gt;</code> element.
However, let&#8217;s say you want to retry, say, just a REST Web Service call, and not any downstream endpoints.</p>
<p>For example, consider the following flow:</p>
<p><span class="emphasis"><em>inbound-adapter&#8594;poller&#8594;http-gateway1&#8594;http-gateway2&#8594;jdbc-outbound-adapter</em></span></p>
<p>If you configure some retry-logic into an advice chain on the poller, and, the call to <span class="emphasis"><em>http-gateway2</em></span> failed because of a network glitch, the retry would cause both <span class="emphasis"><em>http-gateway1</em></span> and <span class="emphasis"><em>http-gateway2</em></span> to be called a second time.
Similarly, after a transient failure in the <span class="emphasis"><em>jdbc-outbound-adapter</em></span>, both http-gateways would be called a second time before again calling the <span class="emphasis"><em>jdbc-outbound-adapter</em></span>.</p>
<p>Spring Integration 2.2 adds the ability to add behavior to individual endpoints.
This is achieved by the addition of the <code class="literal">&lt;request-handler-advice-chain/&gt;</code> element to many endpoints.
For example:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-http:outbound-gateway</span> <span class="hl-attribute">id</span>=<span class="hl-value">"withAdvice"</span>
    <span class="hl-attribute">url-expression</span>=<span class="hl-value">"'http://localhost/test1'"</span>
    <span class="hl-attribute">request-channel</span>=<span class="hl-value">"requests"</span>
    <span class="hl-attribute">reply-channel</span>=<span class="hl-value">"nextChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:request-handler-advice-chain&gt;</span>
        <span class="hl-tag">&lt;ref</span> <span class="hl-attribute">bean</span>=<span class="hl-value">"myRetryAdvice"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;/request-handler-advice-chain&gt;</span>
<span class="hl-tag">&lt;/int-http:outbound-gateway&gt;</span></pre>
<p>In this case, <span class="emphasis"><em>myRetryAdvice</em></span> will only be applied locally to this gateway and will not apply to further actions taken downstream after the reply is sent to the <span class="emphasis"><em>nextChannel</em></span>.
The scope of the advice is limited to the endpoint itself.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>At this time, you cannot advise an entire <code class="literal">&lt;chain/&gt;</code> of endpoints.
The schema does not allow a <code class="literal">&lt;request-handler-advice-chain/&gt;</code> as a child element of the chain itself.</p>
<p>However, a <code class="literal">&lt;request-handler-advice-chain/&gt;</code> can be added to individual reply-producing endpoints <span class="emphasis"><em>within</em></span> a <code class="literal">&lt;chain/&gt;</code> element.
An exception is that, in a chain that produces no reply, because the last element in the chain is an <span class="emphasis"><em>outbound-channel-adapter</em></span>, that <span class="emphasis"><em>last</em></span> element cannot be advised.
If you need to advise such an element, it must be moved outside of the chain (with the <span class="emphasis"><em>output-channel</em></span> of the chain being the <span class="emphasis"><em>input-channel</em></span> of the adapter.
The adapter can then be advised as normal.
For chains that produce a reply, every child element can be advised.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="advice-classes" href="#advice-classes"></a>8.9.2&nbsp;Provided Advice Classes</h3></div></div></div>

<p>In addition to providing the general mechanism to apply AOP Advice classes in this way, three standard Advices are provided:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">RequestHandlerRetryAdvice</code>
</li><li class="listitem">
<code class="literal">RequestHandlerCircuitBreakerAdvice</code>
</li><li class="listitem">
<code class="literal">ExpressionEvaluatingRequestHandlerAdvice</code>
</li></ul></div>
<p>These are each described in detail in the following sections.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="retry-advice" href="#retry-advice"></a>Retry Advice</h4></div></div></div>

<p>The retry advice (<code class="literal">o.s.i.handler.advice.RequestHandlerRetryAdvice</code>) leverages the rich retry mechanisms provided by the <a class="ulink" href="https://github.com/spring-projects/spring-retry" target="_top">Spring Retry</a> project.
The core component of <code class="literal">spring-retry</code> is the <code class="literal">RetryTemplate</code>, which allows configuration of sophisticated retry scenarios, including <code class="literal">RetryPolicy</code> and <code class="literal">BackoffPolicy</code> strategies, with a number of implementations, as well as a <code class="literal">RecoveryCallback</code> strategy to determine the action to take when retries are exhausted.</p>
<p><span class="strong"><strong>Stateless Retry</strong></span></p>
<p>Stateless retry is the case where the retry activity is handled entirely within the advice, where the thread pauses (if so configured) and retries the action.</p>
<p><span class="strong"><strong>Stateful Retry</strong></span></p>
<p>Stateful retry is the case where the retry state is managed within the advice, but where an exception is thrown and the caller resubmits the request.
An example for stateful retry is when we want the message originator (e.g.
JMS) to be responsible for resubmitting, rather than performing it on the current thread.
Stateful retry needs some mechanism to detect a retried submission.</p>
<p><span class="strong"><strong>Further Information</strong></span></p>
<p>For more information on <code class="literal">spring-retry</code>, refer to the project&#8217;s javadocs, as well as the reference documentation for <a class="ulink" href="http://docs.spring.io/spring-batch/reference/html/retry.html" target="_top">Spring Batch</a>, where <code class="literal">spring-retry</code> originated.</p>
<div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Warning"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Warning]" src="images/warning.png"></td><th align="left">Warning</th></tr><tr><td align="left" valign="top">
<p>The default back off behavior is no back off - retries are attempted immediately.
Using a back off policy that causes threads to pause between attempts may cause performance issues, including excessive memory use and thread starvation.
In high volume environments, back off policies should be used with caution.</p>
</td></tr></table></div>
<div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="retry-config" href="#retry-config"></a>Configuring the Retry Advice</h5></div></div></div>

<p>The following examples use a simple <code class="literal">&lt;service-activator/&gt;</code> that always throws an exception:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> FailingService {

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> service(String message) {
        <span class="hl-keyword">throw</span> <span class="hl-keyword">new</span> RuntimeException(<span class="hl-string">"foo"</span>);
    }
}</pre>
<p><span class="strong"><strong>Simple Stateless Retry</strong></span></p>
<p>This example uses the default <code class="literal">RetryTemplate</code> which has a <code class="literal">SimpleRetryPolicy</code> which tries 3 times.
There is no <code class="literal">BackOffPolicy</code> so the 3 attempts are made back-to-back-to-back with no delay between attempts.
There is no <code class="literal">RecoveryCallback</code> so, the result is to throw the exception to the caller after the final failed retry occurs.
In a <span class="emphasis"><em>Spring Integration</em></span> environment, this final exception might be handled using an <code class="literal">error-channel</code> on the inbound endpoint.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:service-activator</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"failer"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"service"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:request-handler-advice-chain&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.handler.advice.RequestHandlerRetryAdvice"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/request-handler-advice-chain&gt;</span>
<span class="hl-tag">&lt;/int:service-activator&gt;</span>

DEBUG [task-scheduler-2]preSend on channel 'input', message: [Payload=...]
DEBUG [task-scheduler-2]Retry: count=0
DEBUG [task-scheduler-2]Checking for rethrow: count=1
DEBUG [task-scheduler-2]Retry: count=1
DEBUG [task-scheduler-2]Checking for rethrow: count=2
DEBUG [task-scheduler-2]Retry: count=2
DEBUG [task-scheduler-2]Checking for rethrow: count=3
DEBUG [task-scheduler-2]Retry failed last attempt: count=3</pre>
<p><span class="strong"><strong>Simple Stateless Retry with Recovery</strong></span></p>
<p>This example adds a <code class="literal">RecoveryCallback</code> to the above example; it uses a <code class="literal">ErrorMessageSendingRecoverer</code> to send an <code class="literal">ErrorMessage</code> to a channel.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:service-activator</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"failer"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"service"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:request-handler-advice-chain&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.handler.advice.RequestHandlerRetryAdvice"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"recoveryCallback"</span><span class="hl-tag">&gt;</span>
                <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.handler.advice.ErrorMessageSendingRecoverer"</span><span class="hl-tag">&gt;</span>
                    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"myErrorChannel"</span><span class="hl-tag"> /&gt;</span>
                <span class="hl-tag">&lt;/bean&gt;</span>
            <span class="hl-tag">&lt;/property&gt;</span>
        <span class="hl-tag">&lt;/bean&gt;</span>
    <span class="hl-tag">&lt;/request-handler-advice-chain&gt;</span>
<span class="hl-tag">&lt;/int:int:service-activator&gt;</span>

DEBUG [task-scheduler-2]preSend on channel 'input', message: [Payload=...]
DEBUG [task-scheduler-2]Retry: count=0
DEBUG [task-scheduler-2]Checking for rethrow: count=1
DEBUG [task-scheduler-2]Retry: count=1
DEBUG [task-scheduler-2]Checking for rethrow: count=2
DEBUG [task-scheduler-2]Retry: count=2
DEBUG [task-scheduler-2]Checking for rethrow: count=3
DEBUG [task-scheduler-2]Retry failed last attempt: count=3
DEBUG [task-scheduler-2]Sending ErrorMessage :failedMessage:[Payload=...]</pre>
<p><span class="strong"><strong>Stateless Retry with Customized Policies, and Recovery</strong></span></p>
<p>For more sophistication, we can provide the advice with a customized <code class="literal">RetryTemplate</code>.
This example continues to use the <code class="literal">SimpleRetryPolicy</code> but it increases the attempts to 4.
It also adds an <code class="literal">ExponentialBackoffPolicy</code> where the first retry waits 1 second, the second waits 5 seconds and the third waits 25 (for 4 attempts in all).</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:service-activator</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"failer"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"service"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:request-handler-advice-chain&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.handler.advice.RequestHandlerRetryAdvice"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"recoveryCallback"</span><span class="hl-tag">&gt;</span>
                <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.handler.advice.ErrorMessageSendingRecoverer"</span><span class="hl-tag">&gt;</span>
                    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"myErrorChannel"</span><span class="hl-tag"> /&gt;</span>
                <span class="hl-tag">&lt;/bean&gt;</span>
            <span class="hl-tag">&lt;/property&gt;</span>
            <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"retryTemplate"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"retryTemplate"</span><span class="hl-tag"> /&gt;</span>
        <span class="hl-tag">&lt;/bean&gt;</span>
    <span class="hl-tag">&lt;/request-handler-advice-chain&gt;</span>
<span class="hl-tag">&lt;/int:service-activator&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"retryTemplate"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.retry.support.RetryTemplate"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"retryPolicy"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.retry.policy.SimpleRetryPolicy"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"maxAttempts"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"4"</span><span class="hl-tag"> /&gt;</span>
        <span class="hl-tag">&lt;/bean&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"backOffPolicy"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.retry.backoff.ExponentialBackOffPolicy"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"initialInterval"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"1000"</span><span class="hl-tag"> /&gt;</span>
            <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"multiplier"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"5.0"</span><span class="hl-tag"> /&gt;</span>
            <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"maxInterval"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"60000"</span><span class="hl-tag"> /&gt;</span>
        <span class="hl-tag">&lt;/bean&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

27.058 DEBUG [task-scheduler-1]preSend on channel 'input', message: [Payload=...]
27.071 DEBUG [task-scheduler-1]Retry: count=0
27.080 DEBUG [task-scheduler-1]Sleeping for 1000
28.081 DEBUG [task-scheduler-1]Checking for rethrow: count=1
28.081 DEBUG [task-scheduler-1]Retry: count=1
28.081 DEBUG [task-scheduler-1]Sleeping for 5000
33.082 DEBUG [task-scheduler-1]Checking for rethrow: count=2
33.082 DEBUG [task-scheduler-1]Retry: count=2
33.083 DEBUG [task-scheduler-1]Sleeping for 25000
58.083 DEBUG [task-scheduler-1]Checking for rethrow: count=3
58.083 DEBUG [task-scheduler-1]Retry: count=3
58.084 DEBUG [task-scheduler-1]Checking for rethrow: count=4
58.084 DEBUG [task-scheduler-1]Retry failed last attempt: count=4
58.086 DEBUG [task-scheduler-1]Sending ErrorMessage :failedMessage:[Payload=...]</pre>
<p><span class="strong"><strong>Namespace Support for Stateless Retry</strong></span></p>
<p>Starting with <span class="emphasis"><em>version 4.0</em></span>, the above configuration can be greatly simplified with the namespace support for the retry advice:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:service-activator</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"failer"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"service"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:request-handler-advice-chain&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"retrier"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;/request-handler-advice-chain&gt;</span>
<span class="hl-tag">&lt;/int:service-activator&gt;</span>

<span class="hl-tag">&lt;int:handler-retry-advice</span> <span class="hl-attribute">id</span>=<span class="hl-value">"retrier"</span> <span class="hl-attribute">max-attempts</span>=<span class="hl-value">"4"</span> <span class="hl-attribute">recovery-channel</span>=<span class="hl-value">"myErrorChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:exponential-back-off</span> <span class="hl-attribute">initial</span>=<span class="hl-value">"1000"</span> <span class="hl-attribute">multiplier</span>=<span class="hl-value">"5.0"</span> <span class="hl-attribute">maximum</span>=<span class="hl-value">"60000"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/int:handler-retry-advice&gt;</span></pre>
<p>In this example, the advice is defined as a top level bean so it can be used in multiple <code class="literal">request-handler-advice-chain</code> s.
You can also define the advice directly within the chain:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:service-activator</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"failer"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"service"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:request-handler-advice-chain&gt;</span>
        <span class="hl-tag">&lt;int:retry-advice</span> <span class="hl-attribute">id</span>=<span class="hl-value">"retrier"</span> <span class="hl-attribute">max-attempts</span>=<span class="hl-value">"4"</span> <span class="hl-attribute">recovery-channel</span>=<span class="hl-value">"myErrorChannel"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;int:exponential-back-off</span> <span class="hl-attribute">initial</span>=<span class="hl-value">"1000"</span> <span class="hl-attribute">multiplier</span>=<span class="hl-value">"5.0"</span> <span class="hl-attribute">maximum</span>=<span class="hl-value">"60000"</span><span class="hl-tag"> /&gt;</span>
        <span class="hl-tag">&lt;/int:retry-advice&gt;</span>
    <span class="hl-tag">&lt;/request-handler-advice-chain&gt;</span>
<span class="hl-tag">&lt;/int:service-activator&gt;</span></pre>
<p>A <code class="literal">&lt;handler-retry-advice/&gt;</code> with no child element uses no back off; it can have a <code class="literal">fixed-back-off</code> or <code class="literal">exponential-back-off</code> child element.
If there is no <code class="literal">recovery-channel</code>, the exception is thrown when retries are exhausted.
The namespace can only be used with stateless retry.</p>
<p>For more complex environments (custom policies etc), use normal <code class="literal">&lt;bean/&gt;</code> definitions.</p>
<p><span class="strong"><strong>Simple Stateful Retry with Recovery</strong></span></p>
<p>To make retry stateful, we need to provide the Advice with a RetryStateGenerator implementation.
This class is used to identify a message as being a resubmission so that the <code class="literal">RetryTemplate</code> can determine the current state of retry for this message.
The framework provides a <code class="literal">SpelExpressionRetryStateGenerator</code> which determines the message identifier using a SpEL expression.
This is shown below; this example again uses the default policies (3 attempts with no back off); of course, as with stateless retry, these policies can be customized.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:service-activator</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"failer"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"service"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:request-handler-advice-chain&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.handler.advice.RequestHandlerRetryAdvice"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"retryStateGenerator"</span><span class="hl-tag">&gt;</span>
                <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.handler.advice.SpelExpressionRetryStateGenerator"</span><span class="hl-tag">&gt;</span>
                    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"headers['jms_messageId']"</span><span class="hl-tag"> /&gt;</span>
                <span class="hl-tag">&lt;/bean&gt;</span>
            <span class="hl-tag">&lt;/property&gt;</span>
            <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"recoveryCallback"</span><span class="hl-tag">&gt;</span>
                <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.handler.advice.ErrorMessageSendingRecoverer"</span><span class="hl-tag">&gt;</span>
                    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"myErrorChannel"</span><span class="hl-tag"> /&gt;</span>
                <span class="hl-tag">&lt;/bean&gt;</span>
            <span class="hl-tag">&lt;/property&gt;</span>
        <span class="hl-tag">&lt;/bean&gt;</span>
    <span class="hl-tag">&lt;/int:request-handler-advice-chain&gt;</span>
<span class="hl-tag">&lt;/int:service-activator&gt;</span>

24.351 DEBUG [Container#0-1]preSend on channel 'input', message: [Payload=...]
24.368 DEBUG [Container#0-1]Retry: count=0
24.387 DEBUG [Container#0-1]Checking for rethrow: count=1
24.387 DEBUG [Container#0-1]Rethrow in retry for policy: count=1
24.387 WARN  [Container#0-1]failure occurred in gateway sendAndReceive
org.springframework.integration.MessagingException: Failed to invoke handler
...
Caused by: java.lang.RuntimeException: foo
...
24.391 DEBUG [Container#0-1]Initiating transaction rollback on application exception
...
25.412 DEBUG [Container#0-1]preSend on channel 'input', message: [Payload=...]
25.412 DEBUG [Container#0-1]Retry: count=1
25.413 DEBUG [Container#0-1]Checking for rethrow: count=2
25.413 DEBUG [Container#0-1]Rethrow in retry for policy: count=2
25.413 WARN  [Container#0-1]failure occurred in gateway sendAndReceive
org.springframework.integration.MessagingException: Failed to invoke handler
...
Caused by: java.lang.RuntimeException: foo
...
25.414 DEBUG [Container#0-1]Initiating transaction rollback on application exception
...
26.418 DEBUG [Container#0-1]preSend on channel 'input', message: [Payload=...]
26.418 DEBUG [Container#0-1]Retry: count=2
26.419 DEBUG [Container#0-1]Checking for rethrow: count=3
26.419 DEBUG [Container#0-1]Rethrow in retry for policy: count=3
26.419 WARN  [Container#0-1]failure occurred in gateway sendAndReceive
org.springframework.integration.MessagingException: Failed to invoke handler
...
Caused by: java.lang.RuntimeException: foo
...
26.420 DEBUG [Container#0-1]Initiating transaction rollback on application exception
...
27.425 DEBUG [Container#0-1]preSend on channel 'input', message: [Payload=...]
27.426 DEBUG [Container#0-1]Retry failed last attempt: count=3
27.426 DEBUG [Container#0-1]Sending ErrorMessage :failedMessage:[Payload=...]</pre>
<p>Comparing with the stateless examples, you can see that with stateful retry, the exception is thrown to the caller on each failure.</p>
<p><span class="strong"><strong>Exception Classification for Retry</strong></span></p>
<p>Spring Retry has a great deal of flexibility for determining which exceptions can invoke retry.
The default configuration will retry for all exceptions and the exception classifier just looks at the top level exception.
If you configure it to, say, only retry on <code class="literal">BarException</code> and your application throws a <code class="literal">FooException</code> where the cause is a <code class="literal">BarException</code>, retry will not occur.</p>
<p>Since <span class="emphasis"><em>Spring Retry 1.0.3</em></span>, the <code class="literal">BinaryExceptionClassifier</code> has a property <code class="literal">traverseCauses</code> (default <code class="literal">false</code>).
When <code class="literal">true</code> it will traverse exception causes until it finds a match or there is no cause.</p>
<p>To use this classifier for retry, use a <code class="literal">SimpleRetryPolicy</code> created with the constructor that takes the max attempts, the <code class="literal">Map</code> of <code class="literal">Exception</code> s and the boolean (traverseCauses), and inject this policy into the <code class="literal">RetryTemplate</code>.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="circuit-breaker-advice" href="#circuit-breaker-advice"></a>Circuit Breaker Advice</h4></div></div></div>

<p>The general idea of the Circuit Breaker Pattern is that, if a service is not currently available, then don&#8217;t waste time (and resources) trying to use it.
The <code class="literal">o.s.i.handler.advice.RequestHandlerCircuitBreakerAdvice</code> implements this pattern.
When the circuit breaker is in the <span class="emphasis"><em>closed</em></span> state, the endpoint will attempt to invoke the service.
The circuit breaker goes to the <span class="emphasis"><em>open</em></span> state if a certain number of consecutive attempts fail; when it is in the <span class="emphasis"><em>open</em></span> state, new requests will "fail fast" and no attempt will be made to invoke the service until some time has expired.</p>
<p>When that time has expired, the circuit breaker is set to the <span class="emphasis"><em>half-open</em></span> state.
When in this state, if even a single attempt fails, the breaker will immediately go to the <span class="emphasis"><em>open</em></span> state; if the attempt succeeds, the breaker will go to the <span class="emphasis"><em>closed</em></span> state, in which case, it won&#8217;t go to the <span class="emphasis"><em>open</em></span> state again until the configured number of consecutive failures again occur.
Any successful attempt resets the state to zero failures for the purpose of determining when the breaker might go to the <span class="emphasis"><em>open</em></span> state again.</p>
<p>Typically, this Advice might be used for external services, where it might take some time to fail (such as a timeout attempting to make a network connection).</p>
<p>The <code class="literal">RequestHandlerCircuitBreakerAdvice</code> has two properties: <code class="literal">threshold</code> and <code class="literal">halfOpenAfter</code>.
The <span class="emphasis"><em>threshold</em></span> property represents the number of consecutive failures that need to occur before the breaker goes <span class="emphasis"><em>open</em></span>.
It defaults to 5.
The <span class="emphasis"><em>halfOpenAfter</em></span> property represents the time after the last failure that the breaker will wait before attempting another request.
Default is 1000 milliseconds.</p>
<p>Example:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:service-activator</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"failer"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"service"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:request-handler-advice-chain&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.handler.advice.RequestHandlerCircuitBreakerAdvice"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"threshold"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"2"</span><span class="hl-tag"> /&gt;</span>
            <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"halfOpenAfter"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"12000"</span><span class="hl-tag"> /&gt;</span>
        <span class="hl-tag">&lt;/bean&gt;</span>
    <span class="hl-tag">&lt;/int:request-handler-advice-chain&gt;</span>
<span class="hl-tag">&lt;/int:service-activator&gt;</span>

05.617 DEBUG [task-scheduler-1]preSend on channel 'input', message: [Payload=...]
05.638 ERROR [task-scheduler-1]org.springframework.messaging.MessageHandlingException: java.lang.RuntimeException: foo
...
10.598 DEBUG [task-scheduler-2]preSend on channel 'input', message: [Payload=...]
10.600 ERROR [task-scheduler-2]org.springframework.messaging.MessageHandlingException: java.lang.RuntimeException: foo
...
15.598 DEBUG [task-scheduler-3]preSend on channel 'input', message: [Payload=...]
15.599 ERROR [task-scheduler-3]org.springframework.messaging.MessagingException: Circuit Breaker is Open for ServiceActivator
...
20.598 DEBUG [task-scheduler-2]preSend on channel 'input', message: [Payload=...]
20.598 ERROR [task-scheduler-2]org.springframework.messaging.MessagingException: Circuit Breaker is Open for ServiceActivator
...
25.598 DEBUG [task-scheduler-5]preSend on channel 'input', message: [Payload=...]
25.601 ERROR [task-scheduler-5]org.springframework.messaging.MessageHandlingException: java.lang.RuntimeException: foo
...
30.598 DEBUG [task-scheduler-1]preSend on channel 'input', message: [Payload=foo...]
30.599 ERROR [task-scheduler-1]org.springframework.messaging.MessagingException: Circuit Breaker is Open for ServiceActivator</pre>
<p>In the above example, the threshold is set to 2 and halfOpenAfter is set to 12 seconds; a new request arrives every 5 seconds.
You can see that the first two attempts invoked the service; the third and fourth failed with an exception indicating the circuit breaker is open.
The fifth request was attempted because the request was 15 seconds after the last failure; the sixth attempt fails immediately because the breaker immediately went to <span class="emphasis"><em>open</em></span>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="expression-advice" href="#expression-advice"></a>Expression Evaluating Advice</h4></div></div></div>

<p>The final supplied advice class is the <code class="literal">o.s.i.handler.advice.ExpressionEvaluatingRequestHandlerAdvice</code>.
This advice is more general than the other two advices.
It provides a mechanism to evaluate an expression on the original inbound message sent to the endpoint.
Separate expressions are available to be evaluated, either after success, or failure.
Optionally, a message containing the evaluation result, together with the input message, can be sent to a message channel.</p>
<p>A typical use case for this advice might be with an <code class="literal">&lt;ftp:outbound-channel-adapter/&gt;</code>, perhaps to move the file to one directory if the transfer was successful, or to another directory if it fails:</p>
<p>The Advice has properties to set an expression when successful, an expression for failures, and corresponding channels for each.
For the successful case, the message sent to the <span class="emphasis"><em>successChannel</em></span> is an <code class="literal">AdviceMessage</code>, with the payload being the result of the expression evaluation, and an additional property <code class="literal">inputMessage</code> which contains the original message sent to the handler.
A message sent to the <span class="emphasis"><em>failureChannel</em></span> (when the handler throws an exception) is an <code class="literal">ErrorMessage</code> with a payload of <code class="literal">MessageHandlingExpressionEvaluatingAdviceException</code>.
Like all <code class="literal">MessagingException</code> s, this payload has <code class="literal">failedMessage</code> and <code class="literal">cause</code> properties, as well as an additional property <code class="literal">evaluationResult</code>, containing the result of the expression evaluation.</p>
<p>When an exception is thrown in the scope of the advice, by default, that exception is thrown to caller after any
<code class="literal">failureExpression</code> is evaluated.
If you wish to suppress throwing the exception, set the <code class="literal">trapException</code> property to <code class="literal">true</code>.</p>
<p>
<b>Example - Configuring the Advice with Java DSL.&nbsp;</b>

</p><pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@SpringBootApplication</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> EerhaApplication {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
        ConfigurableApplicationContext context = SpringApplication.run(EerhaApplication.<span class="hl-keyword">class</span>, args);
        MessageChannel in = context.getBean(<span class="hl-string">"advised.input"</span>, MessageChannel.<span class="hl-keyword">class</span>);
        in.send(<span class="hl-keyword">new</span> GenericMessage&lt;&gt;(<span class="hl-string">"good"</span>));
        in.send(<span class="hl-keyword">new</span> GenericMessage&lt;&gt;(<span class="hl-string">"bad"</span>));
        context.close();
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> IntegrationFlow advised() {
        <span class="hl-keyword">return</span> f -&gt; f.handle((GenericHandler&lt;String&gt;) (payload, headers) -&gt; {
            <span class="hl-keyword">if</span> (payload.equals(<span class="hl-string">"good"</span>)) {
                <span class="hl-keyword">return</span> null;
            }
            <span class="hl-keyword">else</span> {
                <span class="hl-keyword">throw</span> <span class="hl-keyword">new</span> RuntimeException(<span class="hl-string">"some failure"</span>);
            }
        }, c -&gt; c.advice(expressionAdvice()));
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> Advice expressionAdvice() {
        ExpressionEvaluatingRequestHandlerAdvice advice = <span class="hl-keyword">new</span> ExpressionEvaluatingRequestHandlerAdvice();
        advice.setSuccessChannelName(<span class="hl-string">"success.input"</span>);
        advice.setOnSuccessExpressionString(<span class="hl-string">"payload + ' was successful'"</span>);
        advice.setFailureChannelName(<span class="hl-string">"failure.input"</span>);
        advice.setOnFailureExpressionString(
                <span class="hl-string">"payload + ' was bad, with reason: ' + #exception.cause.message"</span>);
        advice.setTrapException(true);
        <span class="hl-keyword">return</span> advice;
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> IntegrationFlow success() {
        <span class="hl-keyword">return</span> f -&gt; f.handle(System.out::println);
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> IntegrationFlow failure() {
        <span class="hl-keyword">return</span> f -&gt; f.handle(System.out::println);
    }

}</pre><p>

</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="custom-advice" href="#custom-advice"></a>8.9.3&nbsp;Custom Advice Classes</h3></div></div></div>

<p>In addition to the provided Advice classes above, you can implement your own Advice classes.
While you can provide any implementation of <code class="literal">org.aopalliance.aop.Advice</code> (usually <code class="literal">org.aopalliance.intercept.MethodInterceptor</code>), it is generally recommended that you subclass <code class="literal">o.s.i.handler.advice.AbstractRequestHandlerAdvice</code>.
This has the benefit of avoiding writing low-level <span class="emphasis"><em>Aspect Oriented Programming</em></span> code as well as providing a starting point that is specifically tailored for use in this environment.</p>
<p>Subclasses need to implement the <code class="literal">doInvoke()`</code> method:</p>
<pre class="programlisting"><strong class="hl-tag" style="color: blue">/**
 * Subclasses implement this method to apply behavior to the {@link MessageHandler} callback.execute()
 * invokes the handler method and returns its result, or null).
 * @param callback Subclasses invoke the execute() method on this interface to invoke the handler method.
 * @param target The target handler.
 * @param message The message that will be sent to the handler.
 * @return the result after invoking the {@link MessageHandler}.
 * @throws Exception
 */</strong>
<span class="hl-keyword">protected</span> <span class="hl-keyword">abstract</span> Object doInvoke(ExecutionCallback callback, Object target, Message&lt;?&gt; message) <span class="hl-keyword">throws</span> Exception;</pre>
<p>The <span class="emphasis"><em>callback</em></span> parameter is simply a convenience to avoid subclasses dealing with AOP directly; invoking the <code class="literal">callback.execute()</code> method invokes the message handler.</p>
<p>The <span class="emphasis"><em>target</em></span> parameter is provided for those subclasses that need to maintain state for a specific handler, perhaps by maintaining that state in a <code class="literal">Map</code>, keyed by the target.
This allows the same advice to be applied to multiple handlers.
The <code class="literal">RequestHandlerCircuitBreakerAdvice</code> uses this to keep circuit breaker state for each handler.</p>
<p>The <span class="emphasis"><em>message</em></span> parameter is the message that will be sent to the handler.
While the advice cannot modify the message before invoking the handler, it can modify the payload (if it has mutable properties).
Typically, an advice would use the message for logging and/or to send a copy of the message somewhere before or after invoking the handler.</p>
<p>The return value would normally be the value returned by <code class="literal">callback.execute()</code>; but the advice does have the ability to modify the return value.
Note that only <code class="literal">AbstractReplyProducingMessageHandler</code> s return a value.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyAdvice <span class="hl-keyword">extends</span> AbstractRequestHandlerAdvice {

    <em><span class="hl-annotation" style="color: gray">@Override</span></em>
    <span class="hl-keyword">protected</span> Object doInvoke(ExecutionCallback callback, Object target, Message&lt;?&gt; message) <span class="hl-keyword">throws</span> Exception {
        <span class="hl-comment">// add code before the invocation</span>
        Object result = callback.execute();
        <span class="hl-comment">// add code after the invocation</span>
        <span class="hl-keyword">return</span> result;
    }
}</pre>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>In addition to the <code class="literal">execute()</code> method, the <code class="literal">ExecutionCallback</code> provides an additional method <code class="literal">cloneAndExecute()</code>.
This method must be used in cases where the invocation might be called multiple times within a single execution of <code class="literal">doInvoke()</code>, such as in the <code class="literal">RequestHandlerRetryAdvice</code>.
This is required because the Spring AOP <code class="literal">org.springframework.aop.framework.ReflectiveMethodInvocation</code> object maintains state of which advice in a chain was last invoked; this state must be reset for each call.</p>
<p>For more information, see the <a class="ulink" href="http://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/aop/framework/ReflectiveMethodInvocation.html" target="_top">ReflectiveMethodInvocation</a> JavaDocs.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="other-advice" href="#other-advice"></a>8.9.4&nbsp;Other Advice Chain Elements</h3></div></div></div>

<p>While the abstract class mentioned above is provided as a convenience, you can add any <code class="literal">Advice</code> to the chain, including a transaction advice.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="handle-message-advice" href="#handle-message-advice"></a>8.9.5&nbsp;Handle Message Advice</h3></div></div></div>

<p>As discussed in <a class="link" href="#mhac-intro" title="8.9.1&nbsp;Introduction">the introduction to this section</a>, advice objects in a request handler advice chain are applied to just the current endpoint, not the downstream flow (if any).
For <code class="literal">MessageHandler</code> s that produce a reply (<code class="literal">AbstractReplyProducingMessageHandler</code>), the advice is applied to an internal method
<code class="literal">handleRequestMessage()</code> (called from <code class="literal">MessageHandler.handleMessage()</code>).
For other message handlers, the advice is applied to <code class="literal">MessageHandler.handleMessage()</code>.</p>
<p>There are some circumstances where, even if a message handler is an <code class="literal">AbstractReplyProducingMessageHandler</code>, the advice must be applied to the <code class="literal">handleMessage</code> method - for example, the <a class="link" href="#idempotent-receiver" title="8.9.10&nbsp;Idempotent Receiver Enterprise Integration Pattern">Idempotent Receiver</a> might return <code class="literal">null</code> and this would cause an exception if the handler&#8217;s <code class="literal">replyRequired</code> property is true.</p>
<p>Starting with <span class="emphasis"><em>version 4.3.1</em></span>, a new <code class="literal">HandleMessageAdvice</code> and the <code class="literal">AbstractHandleMessageAdvice</code> base implementation have been introduced.
<code class="literal">Advice</code> s that implement <code class="literal">HandleMessageAdvice</code> will always be applied to the <code class="literal">handleMessage()</code> method, regardless of the handler type.</p>
<p>It is important to understand that <code class="literal">HandleMessageAdvice</code> implementations (such as <a class="link" href="#idempotent-receiver" title="8.9.10&nbsp;Idempotent Receiver Enterprise Integration Pattern">Idempotent Receiver</a>), when applied to a handler that returns a response, are dissociated from the <code class="literal">adviceChain</code> and properly applied to the <code class="literal">MessageHandler.handleMessage()</code> method.
Bear in mind, however, that this means the advice chain order is not complied with; and, with configuration such as:</p>
<pre class="programlisting"><span class="hl-tag">&lt;some-reply-producing-endpoint</span> <span class="hl-attribute">...</span><span class="hl-tag"> &gt;</span>
    <span class="hl-tag">&lt;int:request-handler-advice-chain&gt;</span>
        <span class="hl-tag">&lt;tx:advice</span> <span class="hl-attribute">...</span><span class="hl-tag"> /&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"myHandleMessageAdvice"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;/int:request-handler-advice-chain&gt;</span>
<span class="hl-tag">&lt;/some-reply-producing-endpoint&gt;</span></pre>
<p>The <code class="literal">&lt;tx:advice&gt;</code> is applied to the <code class="literal">AbstractReplyProducingMessageHandler.handleRequestMessage()</code>, but <code class="literal">myHandleMessageAdvice</code> is applied for to <code class="literal">MessageHandler.handleMessage()</code> and, therefore, invoked <span class="strong"><strong>before</strong></span> the <code class="literal">&lt;tx:advice&gt;</code>.
To retain the order, you should follow with standard <a class="ulink" href="http://docs.spring.io/spring/docs/current/spring-framework-reference/html/aop-api.html" target="_top">Spring AOP</a> configuration approach and use endpoint <code class="literal">id</code> together with the <code class="literal">.handler</code> suffix to obtain the target <code class="literal">MessageHandler</code> bean.
Note, however, that in that case, the entire downstream flow would be within the transaction scope.</p>
<p>In the case of a <code class="literal">MessageHandler</code> that does <span class="strong"><strong>not</strong></span> return a response, the advice chain order is retained.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="advising-filters" href="#advising-filters"></a>8.9.6&nbsp;Advising Filters</h3></div></div></div>

<p>There is an additional consideration when advising <code class="literal">Filter</code> s.
By default, any discard actions (when the filter returns false) are performed <span class="emphasis"><em>within</em></span> the scope of the advice chain.
This could include all the flow downstream of the <span class="emphasis"><em>discard channel</em></span>.
So, for example if an element downstream of the <span class="emphasis"><em>discard-channel</em></span> throws an exception, and there is a retry advice, the process will be retried.
This is also the case if <span class="emphasis"><em>throwExceptionOnRejection</em></span> is set to true (the exception is thrown within the scope of the advice).</p>
<p>Setting <span class="emphasis"><em>discard-within-advice</em></span> to "false" modifies this behavior and the discard (or exception) occurs after the advice chain is called.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="advising-with-annotations" href="#advising-with-annotations"></a>8.9.7&nbsp;Advising Endpoints Using Annotations</h3></div></div></div>

<p>When configuring certain endpoints using annotations (<code class="literal">@Filter</code>, <code class="literal">@ServiceActivator</code>, <code class="literal">@Splitter</code>, and <code class="literal">@Transformer</code>), you can supply a bean name for the advice chain in the <code class="literal">adviceChain</code> attribute.
In addition, the <code class="literal">@Filter</code> annotation also has the <code class="literal">discardWithinAdvice</code> attribute, which can be used to configure the discard behavior as discussed in <a class="xref" href="#advising-filters" title="8.9.6&nbsp;Advising Filters">Section&nbsp;8.9.6, &#8220;Advising Filters&#8221;</a>.
An example with the discard being performed after the advice is shown below.</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@MessageEndpoint</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyAdvisedFilter {

    <em><span class="hl-annotation" style="color: gray">@Filter(inputChannel="input", outputChannel="output",
            adviceChain="adviceChain", discardWithinAdvice="false")</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">boolean</span> filter(String s) {
        <span class="hl-keyword">return</span> s.contains(<span class="hl-string">"good"</span>);
    }
}</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="advice-order" href="#advice-order"></a>8.9.8&nbsp;Ordering Advices within an Advice Chain</h3></div></div></div>

<p>Advice classes are "around" advices and are applied in a nested fashion.
The first advice is the outermost, the last advice the innermost (closest to the handler being advised).
It is important to put the advice classes in the correct order to achieve the functionality you desire.</p>
<p>For example, let&#8217;s say you want to add a retry advice and a transaction advice.
You may want to place the retry advice advice first, followed by the transaction advice.
Then, each retry will be performed in a new transaction.
On the other hand, if you want all the attempts, and any recovery operations (in the retry <code class="literal">RecoveryCallback</code>), to be scoped within the transaction, you would put the transaction advice first.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="advised-handler-properties" href="#advised-handler-properties"></a>8.9.9&nbsp;Advised Handler Properties</h3></div></div></div>

<p>Sometimes, it is useful to access handler properties from within the advice.
For example, most handlers implement <code class="literal">NamedComponent</code> and you can access the component name.</p>
<p>The target object can be accessed via the <code class="literal">target</code> argument when subclassing <code class="literal">AbstractRequestHandlerAdvice</code> or
<code class="literal">invocation.getThis()</code> when implementing <code class="literal">org.aopalliance.intercept.MethodInterceptor</code>.</p>
<p>When the entire handler is advised (such as when the handler does not produce replies, or the advice implements <code class="literal">HandleMessageAdvice</code>), you can simply cast the target object to the desired implemented interface, such as <code class="literal">NamedComponent</code>.</p>
<pre class="programlisting">String componentName = ((NamedComponent) target).getComponentName();</pre>
<p>or</p>
<pre class="programlisting">String componentName = ((NamedComponent) invocation.getThis()).getComponentName();</pre>
<p>when implementing <code class="literal">MethodInterceptor</code> directly.</p>
<p>When only the <code class="literal">handleRequestMessage()</code> method is advised (in a reply-producing handler), you need to access the
full handler, which is an <code class="literal">AbstractReplyProducingMessageHandler</code>&#8230;&#8203;</p>
<pre class="programlisting">AbstractReplyProducingMessageHandler handler =
    ((AbstractReplyProducingMessageHandler.RequestHandler) target).getAdvisedHandler();

String componentName = handler.getComponentName();</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="idempotent-receiver" href="#idempotent-receiver"></a>8.9.10&nbsp;Idempotent Receiver Enterprise Integration Pattern</h3></div></div></div>

<p>Starting with <span class="emphasis"><em>version 4.1</em></span>, Spring Integration provides an implementation of the <a class="ulink" href="http://www.eaipatterns.com/IdempotentReceiver.html" target="_top">Idempotent Receiver</a> Enterprise Integration Pattern.
It is a <span class="emphasis"><em>functional</em></span> pattern and the whole <span class="emphasis"><em>idempotency</em></span> logic should be implemented in the application, however to simplify the decision-making, the <code class="literal">IdempotentReceiverInterceptor</code> component is provided.
This is an AOP <code class="literal">Advice</code>, which is applied to the <code class="literal">MessageHandler.handleMessage()</code> method and can <code class="literal">filter</code> a request message or mark it as a <code class="literal">duplicate</code>, according to its configuration.</p>
<p>Previously, users could have implemented this pattern, by using a custom MessageSelector in a <code class="literal">&lt;filter/&gt;</code> (<a class="xref" href="#filter" title="6.2&nbsp;Filter">Section&nbsp;6.2, &#8220;Filter&#8221;</a>), for example.
However, since this pattern is really behavior of an endpoint rather than being an endpoint itself, the Idempotent Receiver implementation doesn&#8217;t provide an <span class="emphasis"><em>endpoint</em></span> component; rather, it is applied to endpoints declared in the application.</p>
<p>The logic of the <code class="literal">IdempotentReceiverInterceptor</code> is based on the provided <code class="literal">MessageSelector</code> and, if the message isn&#8217;t accepted by that selector, it will be enriched with the <code class="literal">duplicateMessage</code> header set to <code class="literal">true</code>.
The target <code class="literal">MessageHandler</code> (or downstream flow) can consult this header to implement the correct <span class="emphasis"><em>idempotency</em></span> logic.
If the <code class="literal">IdempotentReceiverInterceptor</code> is configured with a <code class="literal">discardChannel</code> and/or <code class="literal">throwExceptionOnRejection = true</code>, the <span class="emphasis"><em>duplicate</em></span> Message won&#8217;t be sent to the target <code class="literal">MessageHandler.handleMessage()</code>, but discarded.
If you simply want to discard (do nothing with) the <span class="emphasis"><em>duplicate</em></span> Message, the <code class="literal">discardChannel</code> should be configured with a <code class="literal">NullChannel</code>, such as the default <code class="literal">nullChannel</code> bean.</p>
<p>To maintain <span class="emphasis"><em>state</em></span> between messages and provide the ability to compare messages for the idempotency, the <code class="literal">MetadataStoreSelector</code> is provided.
It accepts a <code class="literal">MessageProcessor</code> implementation (which creates a lookup key based on the <code class="literal">Message</code>) and an optional <code class="literal">ConcurrentMetadataStore</code> (<a class="xref" href="#metadata-store" title="9.5&nbsp;Metadata Store">Section&nbsp;9.5, &#8220;Metadata Store&#8221;</a>).
See the <code class="literal">MetadataStoreSelector</code> JavaDocs for more information.
The <code class="literal">value</code> for <code class="literal">ConcurrentMetadataStore</code> also can be customized using additional <code class="literal">MessageProcessor</code>.
By default <code class="literal">MetadataStoreSelector</code> uses <code class="literal">timestamp</code> message header.</p>
<p>For convenience, the <code class="literal">MetadataStoreSelector</code> options are configurable directly on the <code class="literal">&lt;idempotent-receiver&gt;</code> component:</p>
<pre class="programlisting"><span class="hl-tag">&lt;idempotent-receiver</span>
        <span class="hl-attribute">id</span>=<span class="hl-value">""</span>  <a name="CO14-1" href="#CO14-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
        endpoint=""  <a name="CO14-2" href="#CO14-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
        selector=""  <a name="CO14-3" href="#CO14-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
        discard-channel=""  <a name="CO14-4" href="#CO14-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
        metadata-store=""  <a name="CO14-5" href="#CO14-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
        key-strategy=""  <a name="CO14-6" href="#CO14-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>
        key-expression=""  <a name="CO14-7" href="#CO14-7"></a><span><img src="images/callouts/7.png" alt="7" border="0"></span>
        value-strategy=""  <a name="CO14-8" href="#CO14-8"></a><span><img src="images/callouts/8.png" alt="8" border="0"></span>
        value-expression=""  <a name="CO14-9" href="#CO14-9"></a><span><img src="images/callouts/9.png" alt="9" border="0"></span>
        throw-exception-on-rejection="" /&gt;  <a name="CO14-10" href="#CO14-10"></a><span><img src="images/callouts/10.png" alt="10" border="0"></span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO14-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The id of the <code class="literal">IdempotentReceiverInterceptor</code> bean.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO14-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Consumer Endpoint name(s) or pattern(s) to which this interceptor will be applied.
Separate names (patterns) with commas (<code class="literal">,</code>) e.g.
<code class="literal">endpoint="aaa, bbb*, *ccc, *ddd*, eee*fff"</code>.
Endpoint bean names matching these patterns are then used to retrieve the target endpoint&#8217;s <code class="literal">MessageHandler</code> bean (using its <code class="literal">.handler</code> suffix), and the <code class="literal">IdempotentReceiverInterceptor</code> will be applied to those beans.
<span class="emphasis"><em>Required</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO14-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A <code class="literal">MessageSelector</code> bean reference.
Mutually exclusive with <code class="literal">metadata-store</code> and <code class="literal">key-strategy (key-expression)</code>.
When <code class="literal">selector</code> is not provided, one of <code class="literal">key-strategy</code> or <code class="literal">key-strategy-expression</code> is required.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO14-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Identifies the channel to which to send a message when the <code class="literal">IdempotentReceiverInterceptor</code> doesn&#8217;t accept it.
When omitted, duplicate messages are forwarded to the handler with a <code class="literal">duplicateMessage</code> header.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO14-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A <code class="literal">ConcurrentMetadataStore</code> reference.
Used by the underlying <code class="literal">MetadataStoreSelector</code>.
Mutually exclusive with <code class="literal">selector</code>.
<span class="emphasis"><em>Optional</em></span>.
The default <code class="literal">MetadataStoreSelector</code> uses an internal <code class="literal">SimpleMetadataStore</code> which does not maintain state across application executions.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO14-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A <code class="literal">MessageProcessor</code> reference.
Used by the underlying <code class="literal">MetadataStoreSelector</code>.
Evaluates an <code class="literal">idempotentKey</code> from the request Message.
Mutually exclusive with <code class="literal">selector</code> and <code class="literal">key-expression</code>.
When a <code class="literal">selector</code> is not provided, one of <code class="literal">key-strategy</code> or <code class="literal">key-strategy-expression</code> is required.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO14-7"><span><img src="images/callouts/7.png" alt="7" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A SpEL expression to populate an <code class="literal">ExpressionEvaluatingMessageProcessor</code>.
Used by the underlying <code class="literal">MetadataStoreSelector</code>.
Evaluates an <code class="literal">idempotentKey</code> using the request Message as the evaluation context root object.
Mutually exclusive with <code class="literal">selector</code> and <code class="literal">key-strategy</code>.
When a <code class="literal">selector</code> is not provided, one of <code class="literal">key-strategy</code> or <code class="literal">key-strategy-expression</code> is required.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO14-8"><span><img src="images/callouts/8.png" alt="8" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A <code class="literal">MessageProcessor</code> reference.
Used by the underlying <code class="literal">MetadataStoreSelector</code>.
Evaluates a <code class="literal">value</code> for the <code class="literal">idempotentKey</code> from the request Message.
Mutually exclusive with <code class="literal">selector</code> and <code class="literal">value-expression</code>.
By default, the <span class="emphasis"><em>MetadataStoreSelector</em></span> uses the <span class="emphasis"><em>timestamp</em></span> message header as the Metadata <span class="emphasis"><em>value</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO14-9"><span><img src="images/callouts/9.png" alt="9" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A SpEL expression to populate an <code class="literal">ExpressionEvaluatingMessageProcessor</code>.
Used by the underlying <code class="literal">MetadataStoreSelector</code>.
Evaluates a <code class="literal">value</code> for the <code class="literal">idempotentKey</code> using the request Message as the evaluation context root object.
Mutually exclusive with <code class="literal">selector</code> and <code class="literal">value-strategy</code>.
By default, the <span class="emphasis"><em>MetadataStoreSelector</em></span> uses the <span class="emphasis"><em>timestamp</em></span> message header as the Metadata <span class="emphasis"><em>value</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO14-10"><span><img src="images/callouts/10.png" alt="10" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Throw an exception if the <code class="literal">IdempotentReceiverInterceptor</code> rejects the message defaults to <code class="literal">false</code>.
It is applied regardless of whether or not a <code class="literal">discard-channel</code> is provided.</p>
</td></tr></table></div>
<p>For Java configuration, the method level <code class="literal">IdempotentReceiver</code> annotation is provided.
It is used to mark a <code class="literal">method</code> that has a Messaging annotation (<code class="literal">@ServiceActivator</code>, <code class="literal">@Router</code> etc.) to specify which <code class="literal">IdempotentReceiverInterceptor</code> s will be applied to this endpoint:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> IdempotentReceiverInterceptor idempotentReceiverInterceptor() {
   <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> IdempotentReceiverInterceptor(<span class="hl-keyword">new</span> MetadataStoreSelector(m -&gt;
                                                    m.getHeaders().get(INVOICE_NBR_HEADER)));
}

<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "input", outputChannel = "output")</span></em>
<em><span class="hl-annotation" style="color: gray">@IdempotentReceiver("idempotentReceiverInterceptor")</span></em>
<span class="hl-keyword">public</span> MessageHandler myService() {
    ....
}</pre>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The <code class="literal">IdempotentReceiverInterceptor</code> is designed only for the <code class="literal">MessageHandler.handleMessage(Message&lt;?&gt;)</code> method and starting with <span class="emphasis"><em>version 4.3.1</em></span> it implements <code class="literal">HandleMessageAdvice</code>, with the <code class="literal">AbstractHandleMessageAdvice</code> as a base class, for better dissociation.
See <a class="xref" href="#handle-message-advice" title="8.9.5&nbsp;Handle Message Advice">Section&nbsp;8.9.5, &#8220;Handle Message Advice&#8221;</a> for more information.</p>
</td></tr></table></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="logging-channel-adapter" href="#logging-channel-adapter"></a>8.10&nbsp;Logging Channel Adapter</h2></div></div></div>

<p>The <code class="literal">&lt;logging-channel-adapter/&gt;</code> is often used in conjunction with a Wire Tap, as discussed in <a class="xref" href="#channel-wiretap" title="Wire Tap">the section called &#8220;Wire Tap&#8221;</a>.
However, it can also be used as the ultimate consumer of any flow.
For example, consider a flow that ends with a <code class="literal">&lt;service-activator/&gt;</code> that returns a result, but you wish to discard that result.
To do that, you could send the result to <code class="literal">NullChannel</code>.
Alternatively, you can route it to an <code class="literal">INFO</code> level <code class="literal">&lt;logging-channel-adapter/&gt;</code>; that way, you can see the discarded message when logging at <code class="literal">INFO</code> level, but not see it when logging at, say, <code class="literal">WARN</code> level.
With a <code class="literal">NullChannel</code>, you would only see the discarded message when logging at <code class="literal">DEBUG</code> level.</p>
<pre class="screen">&lt;int:logging-channel-adapter
    channel="" <a name="CO15-1" href="#CO15-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
    level="INFO" <a name="CO15-2" href="#CO15-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
    expression="" <a name="CO15-3" href="#CO15-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
    log-full-message="false" <a name="CO15-4" href="#CO15-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
    logger-name="" /&gt; <a name="CO15-5" href="#CO15-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO15-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The channel connecting the logging adapter to an upstream component.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO15-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The logging level at which messages sent to this adapter will be logged.
Default: <code class="literal">INFO</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO15-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A SpEL expression representing exactly what part(s) of the message will be logged.
Default: <code class="literal">payload</code> - just the payload will be logged.
This attribute cannot be specified if <code class="literal">log-full-message</code> is specified.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO15-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>When <code class="literal">true</code>, the entire message will be logged (including headers).
Default: <code class="literal">false</code> - just the payload will be logged.
This attribute cannot be specified if <code class="literal">expression</code> is specified.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO15-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Specifies the <span class="emphasis"><em>name</em></span> of the logger (known as <code class="literal">category</code> in <code class="literal">log4j</code>) used for log messages created by this adapter.
This enables setting the log name (in the logging subsystem) for individual adapters.
By default, all adapters will log under the name <code class="literal">org.springframework.integration.handler.LoggingHandler</code>.</p>
</td></tr></table></div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_with_java_configuration" href="#_configuring_with_java_configuration"></a>8.10.1&nbsp;Configuring with Java Configuration</h3></div></div></div>

<p>The following Spring Boot application provides an example of configuring the <code class="literal">LoggingHandler</code> using Java configuration:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@SpringBootApplication</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> LoggingJavaApplication {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
        ConfigurableApplicationContext context =
             <span class="hl-keyword">new</span> SpringApplicationBuilder(LoggingJavaApplication.<span class="hl-keyword">class</span>)
                    .web(false)
                    .run(args);
         MyGateway gateway = context.getBean(MyGateway.<span class="hl-keyword">class</span>);
         gateway.sendToLogger(<span class="hl-string">"foo"</span>);
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> MessageChannel logInputChannel() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> DirectChannel();
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "logChannel")</span></em>
    <span class="hl-keyword">public</span> LoggingHandler logging() {
        LoggingHandler adapter = <span class="hl-keyword">new</span> LoggingHandler(LoggingHandler.Level.DEBUG);
        adapter.setLoggerName(<span class="hl-string">"TEST_LOGGER"</span>);
        adapter.setLogExpressionString(<span class="hl-string">"headers.id + ': ' + payload"</span>);
        <span class="hl-keyword">return</span> adapter;
    }

    <em><span class="hl-annotation" style="color: gray">@MessagingGateway(defaultRequestChannel = "logChannel")</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> MyGateway {

        <span class="hl-keyword">void</span> sendToLogger(String data);

    }

}</pre>
</div>
</div>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="system-management-chapter" href="#system-management-chapter"></a>9.&nbsp;System Management</h2></div></div></div>

<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="metrics-management" href="#metrics-management"></a>9.1&nbsp;Metrics and Management</h2></div></div></div>

<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_metrics_capture" href="#_configuring_metrics_capture"></a>9.1.1&nbsp;Configuring Metrics Capture</h3></div></div></div>

<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Prior to <span class="emphasis"><em>version 4.2</em></span> metrics were only available when JMX was enabled.
See <a class="xref" href="#jmx" title="9.2&nbsp;JMX Support">Section&nbsp;9.2, &#8220;JMX Support&#8221;</a>.</p>
</td></tr></table></div>
<p>To enable <code class="literal">MessageSource</code>, <code class="literal">MessageChannel</code> and <code class="literal">MessageHandler</code> metrics, add an <code class="literal">&lt;int:management/&gt;</code> bean to the
application context, or annotate one of your <code class="literal">@Configuration</code> classes with <code class="literal">@EnableIntegrationManagement</code>.
<code class="literal">MessageSource</code> s only maintain counts, <code class="literal">MessageChannel</code> s and <code class="literal">MessageHandler</code> s maintain duration statistics in
addition to counts.
See <a class="xref" href="#mgmt-channel-features" title="9.1.2&nbsp;MessageChannel Metric Features">Section&nbsp;9.1.2, &#8220;MessageChannel Metric Features&#8221;</a> and <a class="xref" href="#mgmt-handler-features" title="9.1.3&nbsp;MessageHandler Metric Features">Section&nbsp;9.1.3, &#8220;MessageHandler Metric Features&#8221;</a> below.</p>
<p>This causes the automatic registration of the <code class="literal">IntegrationManagementConfigurer</code> bean in the application context.
Only one such bean can exist in the context and it must have the bean name <code class="literal">integrationManagementConfigurer</code>
if registered manually via a <code class="literal">&lt;bean/&gt;</code> definition.</p>
<p>In addition to metrics, you can control <span class="strong"><strong>debug</strong></span> logging in the main message flow.
It has been found that in very high volume applications, even calls to <code class="literal">isDebugEnabled()</code> can be quite expensive with
some logging subsystems.
You can disable all such logging to avoid this overhead; exception logging (debug or otherwise) are not affected
by this setting.</p>
<p>A number of options are available:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:management</span>
    <span class="hl-attribute">default-logging-enabled</span>=<span class="hl-value">"false"</span> <a name="CO16-1" href="#CO16-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
    default-counts-enabled="false" <a name="CO16-2" href="#CO16-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
    default-stats-enabled="false" <a name="CO16-3" href="#CO16-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
    counts-enabled-patterns="foo, !baz, ba*" <a name="CO16-4" href="#CO16-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
    stats-enabled-patterns="fiz, buz" <a name="CO16-5" href="#CO16-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
    metrics-factory="myMetricsFactory" /&gt; <a name="CO16-6" href="#CO16-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span></pre>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Configuration</span></em>
<em><span class="hl-annotation" style="color: gray">@EnableIntegration</span></em>
@EnableIntegrationManagement(
    defaultLoggingEnabled = <span class="hl-string">"false"</span>, <a name="CO16-7" href="#CO16-7"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
    defaultCountsEnabled = <span class="hl-string">"false"</span>, <a name="CO16-8" href="#CO16-8"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
    defaultStatsEnabled = <span class="hl-string">"false"</span>, <a name="CO16-9" href="#CO16-9"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
    countsEnabled = { <span class="hl-string">"foo"</span>, <span class="hl-string">"${count.patterns}"</span> }, <a name="CO16-10" href="#CO16-10"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
    statsEnabled = { <span class="hl-string">"qux"</span>, <span class="hl-string">"!*"</span> }, <a name="CO16-11" href="#CO16-11"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
    MetricsFactory = <span class="hl-string">"myMetricsFactory"</span>) <a name="CO16-12" href="#CO16-12"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>
<span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">class</span> ContextConfiguration {
...
}</pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO16-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> <a href="#CO16-7"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Set to <code class="literal">false</code> to disable all logging in the main message flow, regardless of the log system category settings.
Set to <span class="emphasis"><em>true</em></span> to enable debug logging (if also enabled by the logging subsystem).</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO16-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> <a href="#CO16-8"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Enable or disable count metrics for components not matching one of the patterns in &lt;4&gt;.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO16-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> <a href="#CO16-9"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Enable or disable statistical metrics for components not matching one of the patterns in &lt;5&gt;.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO16-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> <a href="#CO16-10"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A comma-delimited list of patterns for beans for which counts should be enabled; negate the pattern with <code class="literal">!</code>.
First match wins (positive or negative).
In the unlikely event that you have a bean name starting with <code class="literal">!</code>, escape the <code class="literal">!</code> in the pattern: <code class="literal">\!foo</code> positively
matches a bean named <code class="literal">!foo</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO16-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> <a href="#CO16-11"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A comma-delimited list of patterns for beans for which statistical metrics should be enabled; negate the pattern
with <code class="literal">!</code>.
First match wins (positive or negative).
In the unlikely event that you have a bean name starting with <code class="literal">!</code>, escape the <code class="literal">!</code> in the pattern: <code class="literal">\!foo</code> positively
matches a bean named <code class="literal">!foo</code>.
Stats implies counts.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO16-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> <a href="#CO16-12"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A reference to a <code class="literal">MetricsFactory</code>.
See <a class="xref" href="#mgmt-metrics-factory" title="9.1.5&nbsp;Metrics Factory">Section&nbsp;9.1.5, &#8220;Metrics Factory&#8221;</a>.</p>
</td></tr></table></div>
<p>At runtime, counts and statistics can be obtained by calling <code class="literal">IntegrationManagementConfigurer</code> <code class="literal">getChannelMetrics</code>,
<code class="literal">getHandlerMetrics</code> and <code class="literal">getSourceMetrics</code>, returning <code class="literal">MessageChannelMetrics</code>, <code class="literal">MessageHandlerMetrics</code> and
<code class="literal">MessageSourceMetrics</code> respectively.</p>
<p>See the javadocs for complete information about these classes.</p>
<p>When JMX is enabled (see <a class="xref" href="#jmx" title="9.2&nbsp;JMX Support">Section&nbsp;9.2, &#8220;JMX Support&#8221;</a>), these metrics are also exposed by the <code class="literal">IntegrationMBeanExporter</code>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="mgmt-channel-features" href="#mgmt-channel-features"></a>9.1.2&nbsp;MessageChannel Metric Features</h3></div></div></div>

<p>Message channels report metrics according to their concrete type.
If you are looking at a <code class="literal">DirectChannel</code>, you will see statistics for the send operation.
If it is a <code class="literal">QueueChannel</code>, you will also see statistics for the receive operation, as well as the count of messages that are currently buffered by this <code class="literal">QueueChannel</code>.
In both cases there are some metrics that are simple counters (message count and error count), and some that are estimates of averages of interesting quantities.
The algorithms used to calculate these estimates are described briefly in the section below.</p>
<div class="table"><a name="d5e7531" href="#d5e7531"></a><p class="title"><b>Table&nbsp;9.1.&nbsp;MessageChannel Metrics</b></p><div class="table-contents">

<table summary="MessageChannel Metrics" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Metric Type</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Example</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Algorithm</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Count</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Send Count</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Simple incrementer.
Increases by one when an event occurs.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Error Count</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Send Error Count</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Simple incrementer.
Increases by one when an send results in an error.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Duration</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Send Duration (method execution time in milliseconds)</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Exponential Moving Average with decay factor (10 by default).
Average of the method execution time over roughly the last 10 (default) measurements.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Rate</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Send Rate (number of operations per second)</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Inverse of Exponential Moving Average of the interval between events with decay in time (lapsing over 60 seconds by default) and per measurement (last 10 events by default).</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Error Rate</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Send Error Rate (number of errors per second)</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Inverse of Exponential Moving Average of the interval between error events with decay in time (lapsing over 60 seconds by default) and per measurement (last 10 events by default).</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>Ratio</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>Send Success Ratio (ratio of successful to total sends)</p></td><td style="" align="left" valign="top"><p>Estimate the success ratio as the Exponential Moving Average of the series composed of values 1 for success and 0 for failure (decaying as per the rate measurement over time and events by default).
Error ratio is 1 - success ratio.</p></td></tr></tbody></table>
</div></div><br class="table-break">
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="mgmt-handler-features" href="#mgmt-handler-features"></a>9.1.3&nbsp;MessageHandler Metric Features</h3></div></div></div>

<p>The following table shows the statistics maintained for message handlers.
Some metrics are simple counters (message count and error count), and one is an estimate of averages of send duration.
The algorithms used to calculate these estimates are described briefly in the table below:</p>
<div class="table"><a name="d5e7588" href="#d5e7588"></a><p class="title"><b>Table&nbsp;9.2.&nbsp;MessageHandlerMetrics</b></p><div class="table-contents">

<table summary="MessageHandlerMetrics" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Metric Type</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Example</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Algorithm</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Count</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Handle Count</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Simple incrementer.
Increases by one when an event occurs.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Error Count</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Handler Error Count</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Simple incrementer.
Increases by one when an invocation results in an error.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Active Count</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Handler Active Count</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Indicates the number of currently active threads currently invoking the handler (or any downstream synchronous flow).</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>Duration</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>Handle Duration (method execution time in milliseconds)</p></td><td style="" align="left" valign="top"><p>Exponential Moving Average with decay factor (10 by default).
Average of the method execution time over roughly the last 10 (default) measurements.</p></td></tr></tbody></table>
</div></div><br class="table-break">
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="mgmt-statistics" href="#mgmt-statistics"></a>9.1.4&nbsp;Time-Based Average Estimates</h3></div></div></div>

<p>A feature of the time-based average estimates is that they decay with time if no new measurements arrive.
To help interpret the behaviour over time, the time (in seconds) since the last measurement is also exposed as a metric.</p>
<p>There are two basic exponential models: decay per measurement (appropriate for duration and anything where the number of measurements is part of the metric), and decay per time unit (more suitable for rate measurements where the time in between measurements is part of the metric).
Both models depend on the fact that</p>
<p><code class="literal">S(n) = sum(i=0,i=n) w(i) x(i)</code> has a special form when <code class="literal">w(i) = r^i</code>, with <code class="literal">r=constant</code>:</p>
<p><code class="literal">S(n) = x(n) + r S(n-1)</code> (so you only have to store <code class="literal">S(n-1)</code>, not the whole series <code class="literal">x(i)</code>, to generate a new metric estimate from the last measurement).
The algorithms used in the duration metrics use <code class="literal">r=exp(-1/M)</code> with <code class="literal">M=10</code>.
The net effect is that the estimate <code class="literal">S(n)</code> is more heavily weighted to recent measurements and is composed roughly of the last <code class="literal">M</code> measurements.
So <code class="literal">M</code> is the "window" or lapse rate of the estimate In the case of the vanilla moving average, <code class="literal">i</code> is a counter over the number of measurements.
In the case of the rate we interpret <code class="literal">i</code> as the elapsed time, or a combination of elapsed time and a counter (so the metric estimate contains contributions roughly from the last <code class="literal">M</code> measurements and the last <code class="literal">T</code> seconds).</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="mgmt-metrics-factory" href="#mgmt-metrics-factory"></a>9.1.5&nbsp;Metrics Factory</h3></div></div></div>

<p>A new strategy interface <code class="literal">MetricsFactory</code> has been introduced allowing you to provide custom channel metrics for your
<code class="literal">MessageChannel</code> s and <code class="literal">MessageHandler</code> s.
By default, a <code class="literal">DefaultMetricsFactory</code> provides default implementation of <code class="literal">MessageChannelMetrics</code> and
<code class="literal">MessageHandlerMetrics</code> which are described in the next bullet.
To override the default <code class="literal">MetricsFactory</code> configure it as described above, by providing a reference to your
<code class="literal">MetricsFactory</code> bean instance.
You can either customize the default implementations as described in the next bullet, or provide completely different
implementations by extending <code class="literal">AbstractMessageChannelMetrics</code> and/or <code class="literal">AbstractMessageHandlerMetrics</code>.</p>
<p>In addition to the default metrics factory described above, the framework provides the <code class="literal">AggregatingMetricsFactory</code>.
This factory creates <code class="literal">AggregatingMessageChannelMetrics</code> and <code class="literal">AggregatingMessageHandlerMetrics</code>.
In very high volume scenarios, the cost of capturing statistics can be prohibitive (2 calls to the system time and
storing the data for each message).
The aggregating metrics aggregate the response time over a sample of messages.
This can save significant CPU time.</p>
<div class="caution" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Caution"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Caution]" src="images/caution.png"></td><th align="left">Caution</th></tr><tr><td align="left" valign="top">
<p>The statistics will be skewed if messages arrive in bursts.
These metrics are intended for use with high, constant-volume, message rates.</p>
</td></tr></table></div>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"aggregatingMetricsFactory"</span>
            <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.support.management.AggregatingMetricsFactory"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"1000"</span><span class="hl-tag"> /&gt;</span> <span class="hl-comment">&lt;!-- sample size --&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
<p>The above configuration aggregates the duration over 1000 messages.
Counts (send, error) are maintained per-message but the statistics are per 1000 messages.</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>Customizing the Default Channel/Handler Statistics</strong></span>
</li></ul></div>
<p>See <a class="xref" href="#mgmt-statistics" title="9.1.4&nbsp;Time-Based Average Estimates">Section&nbsp;9.1.4, &#8220;Time-Based Average Estimates&#8221;</a> and the Javadocs for the <code class="literal">ExponentialMovingAverage*</code> classes for more information about these
values.</p>
<p>By default, the <code class="literal">DefaultMessageChannelMetrics</code> and <code class="literal">DefaultMessageHandlerMetrics</code> use a <code class="literal">window</code> of 10 measurements,
a rate period of 1 second (rate per second) and a decay lapse period of 1 minute.</p>
<p>If you wish to override these defaults, you can provide a custom <code class="literal">MetricsFactory</code> that returns appropriately configured
metrics and provide a reference to it to the MBean exporter as described above.</p>
<p>Example:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">class</span> CustomMetrics <span class="hl-keyword">implements</span> MetricsFactory {

    <em><span class="hl-annotation" style="color: gray">@Override</span></em>
    <span class="hl-keyword">public</span> AbstractMessageChannelMetrics createChannelMetrics(String name) {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> DefaultMessageChannelMetrics(name,
                <span class="hl-keyword">new</span> ExponentialMovingAverage(<span class="hl-number">20</span>, <span class="hl-number">1000000.</span>),
                <span class="hl-keyword">new</span> ExponentialMovingAverageRate(<span class="hl-number">2000</span>, <span class="hl-number">120000</span>, <span class="hl-number">30</span>, true),
                <span class="hl-keyword">new</span> ExponentialMovingAverageRatio(<span class="hl-number">130000</span>, <span class="hl-number">40</span>, true),
                <span class="hl-keyword">new</span> ExponentialMovingAverageRate(<span class="hl-number">3000</span>, <span class="hl-number">140000</span>, <span class="hl-number">50</span>, true));
    }

    <em><span class="hl-annotation" style="color: gray">@Override</span></em>
    <span class="hl-keyword">public</span> AbstractMessageHandlerMetrics createHandlerMetrics(String name) {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> DefaultMessageHandlerMetrics(name, <span class="hl-keyword">new</span> ExponentialMovingAverage(<span class="hl-number">20</span>, <span class="hl-number">1000000.</span>));
    }

}</pre>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>Advanced Customization</strong></span>
</li></ul></div>
<p>The customizations described above are wholesale and will apply to all appropriate beans exported by the MBean exporter.
This is the extent of customization available using XML configuration.</p>
<p>Individual beans can be provided with different implementations using java <code class="literal">@Configuration</code> or programmatically at
runtime, after the application context has been refreshed, by invoking the <code class="literal">configureMetrics</code> methods on
<code class="literal">AbstractMessageChannel</code> and <code class="literal">AbstractMessageHandler</code>.</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>Performance Improvement</strong></span>
</li></ul></div>
<p>Previously, the time-based metrics (see <a class="xref" href="#mgmt-statistics" title="9.1.4&nbsp;Time-Based Average Estimates">Section&nbsp;9.1.4, &#8220;Time-Based Average Estimates&#8221;</a>) were calculated in real time.
The statistics are now calculated when retrieved instead.
This resulted in a significant performance improvement, at the expense of a small amount of additional memory for each statistic.
As discussed in the bullet above, the statistics can be disabled altogether, while retaining the MBean allowing the invocation of <code class="literal">Lifecycle</code> methods.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jmx" href="#jmx"></a>9.2&nbsp;JMX Support</h2></div></div></div>

<p>Spring Integration provides <span class="emphasis"><em>Channel Adapters</em></span> for receiving and publishing JMX Notifications.
There is also an_Inbound Channel Adapter_ for polling JMX MBean attribute values, and an <span class="emphasis"><em>Outbound Channel Adapter</em></span> for invoking JMX MBean operations.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jmx-notification-listening-channel-adapter" href="#jmx-notification-listening-channel-adapter"></a>9.2.1&nbsp;Notification Listening Channel Adapter</h3></div></div></div>

<p>The <span class="emphasis"><em>Notification-listening Channel Adapter</em></span> requires a JMX ObjectName for the MBean that publishes notifications to which this listener should be registered.
A very simple configuration might look like this:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-jmx:notification-listening-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"adapter"</span>
    <span class="hl-attribute">channel</span>=<span class="hl-value">"channel"</span>
    <span class="hl-attribute">object-name</span>=<span class="hl-value">"example.domain:name=publisher"</span><span class="hl-tag">/&gt;</span></pre>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>The <span class="emphasis"><em>notification-listening-channel-adapter</em></span> registers with an <code class="literal">MBeanServer</code> at startup, and the default bean name is <span class="emphasis"><em>mbeanServer</em></span> which happens to be the same bean name generated when using Spring&#8217;s <span class="emphasis"><em>&lt;context:mbean-server/&gt;</em></span> element.
If you need to use a different name, be sure to include the_mbean-server_ attribute.</p>
</td></tr></table></div>
<p>The adapter can also accept a reference to a <code class="literal">NotificationFilter</code> and a <span class="emphasis"><em>handback</em></span> Object to provide some context that is passed back with each Notification.
Both of those attributes are optional.
Extending the above example to include those attributes as well as an explicit <code class="literal">MBeanServer</code> bean name would produce the following:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-jmx:notification-listening-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"adapter"</span>
    <span class="hl-attribute">channel</span>=<span class="hl-value">"channel"</span>
    <span class="hl-attribute">mbean-server</span>=<span class="hl-value">"someServer"</span>
    <span class="hl-attribute">object-name</span>=<span class="hl-value">"example.domain:name=somePublisher"</span>
    <span class="hl-attribute">notification-filter</span>=<span class="hl-value">"notificationFilter"</span>
    <span class="hl-attribute">handback</span>=<span class="hl-value">"myHandback"</span><span class="hl-tag">/&gt;</span></pre>
<p>The <span class="emphasis"><em>Notification-listening Channel Adapter</em></span> is event-driven and registered with the <code class="literal">MBeanServer</code> directly.
It does not require any poller configuration.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>For this component only, the <span class="emphasis"><em>object-name</em></span> attribute can contain an ObjectName pattern (e.g.
"org.foo:type=Bar,name=*") and the adapter will receive notifications from all MBeans with ObjectNames that match the pattern.
In addition, the <span class="emphasis"><em>object-name</em></span> attribute can contain a SpEL reference to a &lt;util:list/&gt; of ObjectName patterns:</p>
<pre class="programlisting"><span class="hl-tag">&lt;jmx:notification-listening-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"manyNotificationsAdapter"</span>
    <span class="hl-attribute">channel</span>=<span class="hl-value">"manyNotificationsChannel"</span>
    <span class="hl-attribute">object-name</span>=<span class="hl-value">"#{patterns}"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;util:list</span> <span class="hl-attribute">id</span>=<span class="hl-value">"patterns"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;value&gt;</span>org.foo:type=Foo,name=*<span class="hl-tag">&lt;/value&gt;</span>
    <span class="hl-tag">&lt;value&gt;</span>org.foo:type=Bar,name=*<span class="hl-tag">&lt;/value&gt;</span>
<span class="hl-tag">&lt;/util:list&gt;</span></pre>
<p>The names of the located MBean(s) will be logged when DEBUG level logging is enabled.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jmx-notification-publishing-channel-adapter" href="#jmx-notification-publishing-channel-adapter"></a>9.2.2&nbsp;Notification Publishing Channel Adapter</h3></div></div></div>

<p>The <span class="emphasis"><em>Notification-publishing Channel Adapter</em></span> is relatively simple.
It only requires a JMX ObjectName in its configuration as shown below.</p>
<pre class="programlisting"><span class="hl-tag">&lt;context:mbean-export/&gt;</span>

<span class="hl-tag">&lt;int-jmx:notification-publishing-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"adapter"</span>
    <span class="hl-attribute">channel</span>=<span class="hl-value">"channel"</span>
    <span class="hl-attribute">object-name</span>=<span class="hl-value">"example.domain:name=publisher"</span><span class="hl-tag">/&gt;</span></pre>
<p>It does also require that an <code class="literal">MBeanExporter</code> be present in the context.
That is why the <span class="emphasis"><em>&lt;context:mbean-export/&gt;</em></span> element is shown above as well.</p>
<p>When Messages are sent to the channel for this adapter, the Notification is created from the Message content.
If the payload is a String it will be passed as the <span class="emphasis"><em>message</em></span> text for the Notification.
Any other payload type will be passed as the <span class="emphasis"><em>userData</em></span> of the Notification.</p>
<p>JMX Notifications also have a <span class="emphasis"><em>type</em></span>, and it should be a dot-delimited String.
There are two ways to provide the <span class="emphasis"><em>type</em></span>.
Precedence will always be given to a Message header value associated with the <code class="literal">JmxHeaders.NOTIFICATION_TYPE</code> key.
On the other hand, you can rely on a fallback <span class="emphasis"><em>default-notification-type</em></span> attribute provided in the configuration.</p>
<pre class="programlisting"><span class="hl-tag">&lt;context:mbean-export/&gt;</span>

<span class="hl-tag">&lt;int-jmx:notification-publishing-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"adapter"</span>
    <span class="hl-attribute">channel</span>=<span class="hl-value">"channel"</span>
    <span class="hl-attribute">object-name</span>=<span class="hl-value">"example.domain:name=publisher"</span>
    <span class="hl-attribute">default-notification-type</span>=<span class="hl-value">"some.default.type"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jmx-attribute-polling-channel-adapter" href="#jmx-attribute-polling-channel-adapter"></a>9.2.3&nbsp;Attribute Polling Channel Adapter</h3></div></div></div>

<p>The <span class="emphasis"><em>Attribute Polling Channel Adapter</em></span> is useful when you have a requirement, to periodically check on some value that is available through an MBean as a managed attribute.
The poller can be configured in the same way as any other polling adapter in Spring Integration (or it&#8217;s possible to rely on the default poller).
The <span class="emphasis"><em>object-name</em></span> and <span class="emphasis"><em>attribute-name</em></span> are required.
An MBeanServer reference is also required, but it will automatically check for a bean named <span class="emphasis"><em>mbeanServer</em></span> by default, just like the <span class="emphasis"><em>Notification-listening Channel Adapter</em></span> described above.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-jmx:attribute-polling-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"adapter"</span>
    <span class="hl-attribute">channel</span>=<span class="hl-value">"channel"</span>
    <span class="hl-attribute">object-name</span>=<span class="hl-value">"example.domain:name=someService"</span>
    <span class="hl-attribute">attribute-name</span>=<span class="hl-value">"InvocationCount"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">max-messages-per-poll</span>=<span class="hl-value">"1"</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"5000"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-jmx:attribute-polling-channel-adapter&gt;</span></pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="tree-polling-channel-adapter" href="#tree-polling-channel-adapter"></a>9.2.4&nbsp;Tree Polling Channel Adapter</h3></div></div></div>

<p>The <span class="emphasis"><em>Tree Polling Channel Adapter</em></span> queries the JMX MBean tree and sends a message with a payload that is the graph of objects that matches the query.
By default the MBeans are mapped to primitives and simple Objects like Map, List and arrays - permitting simple transformation, for example, to JSON.
An MBeanServer reference is also required, but it will automatically check for a bean named <span class="emphasis"><em>mbeanServer</em></span> by default, just like the <span class="emphasis"><em>Notification-listening Channel Adapter</em></span> described above.
A basic configuration would be:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-jmx:tree-polling-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"adapter"</span>
    <span class="hl-attribute">channel</span>=<span class="hl-value">"channel"</span>
    <span class="hl-attribute">query-name</span>=<span class="hl-value">"example.domain:type=*"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">max-messages-per-poll</span>=<span class="hl-value">"1"</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"5000"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-jmx:tree-polling-channel-adapter&gt;</span></pre>
<p>This will include all attributes on the MBeans selected.
You can filter the attributes by providing an <code class="literal">MBeanObjectConverter</code> that has an appropriate filter configured.
The converter can be provided as a reference to a bean definition using the <code class="literal">converter</code> attribute, or as an inner &lt;bean/&gt; definition.
A <code class="literal">DefaultMBeanObjectConverter</code> is provided which can take a <code class="literal">MBeanAttributeFilter</code> in its constructor argument.</p>
<p>Two standard filters are provided; the <code class="literal">NamedFieldsMBeanAttributeFilter</code> allows you to specify a list of attributes to include and the <code class="literal">NotNamedFieldsMBeanAttributeFilter</code> allows you to specify a list of attributes to exclude.
You can also implement your own filter</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jmx-operation-invoking-channel-adapter" href="#jmx-operation-invoking-channel-adapter"></a>9.2.5&nbsp;Operation Invoking Channel Adapter</h3></div></div></div>

<p>The <span class="emphasis"><em>operation-invoking-channel-adapter</em></span> enables Message-driven invocation of any managed operation exposed by an MBean.
Each invocation requires the operation name to be invoked and the ObjectName of the target MBean.
Both of these must be explicitly provided via adapter configuration:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-jmx:operation-invoking-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"adapter"</span>
    <span class="hl-attribute">object-name</span>=<span class="hl-value">"example.domain:name=TestBean"</span>
    <span class="hl-attribute">operation-name</span>=<span class="hl-value">"ping"</span><span class="hl-tag">/&gt;</span></pre>
<p>Then the adapter only needs to be able to discover the <span class="emphasis"><em>mbeanServer</em></span> bean.
If a different bean name is required, then provide the <span class="emphasis"><em>mbean-server</em></span> attribute with a reference.</p>
<p>The payload of the Message will be mapped to the parameters of the operation, if any.
A Map-typed payload with String keys is treated as name/value pairs, whereas a List or array would be passed as a simple argument list (with no explicit parameter names).
If the operation requires a single parameter value, then the payload can represent that single value, and if the operation requires no parameters, then the payload would be ignored.</p>
<p>If you want to expose a channel for a single common operation to be invoked by Messages that need not contain headers, then that option works well.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jmx-operation-invoking-outbound-gateway" href="#jmx-operation-invoking-outbound-gateway"></a>9.2.6&nbsp;Operation Invoking Outbound Gateway</h3></div></div></div>

<p>Similar to the <span class="emphasis"><em>operation-invoking-channel-adapter</em></span> Spring Integration also provides a <span class="emphasis"><em>operation-invoking-outbound-gateway</em></span>, which could be used when dealing with non-void operations and a return value is required.
Such return value will be sent as message payload to the <span class="emphasis"><em>reply-channel</em></span> specified by this Gateway.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-jmx:operation-invoking-outbound-gateway</span> <span class="hl-attribute">request-channel</span>=<span class="hl-value">"requestChannel"</span>
   <span class="hl-attribute">reply-channel</span>=<span class="hl-value">"replyChannel"</span>
   <span class="hl-attribute">object-name</span>=<span class="hl-value">"o.s.i.jmx.config:type=TestBean,name=testBeanGateway"</span>
   <span class="hl-attribute">operation-name</span>=<span class="hl-value">"testWithReturn"</span><span class="hl-tag">/&gt;</span></pre>
<p>If the <span class="emphasis"><em>reply-channel</em></span> attribute is not provided, the reply message will be sent to the channel that is identified by the <code class="literal">IntegrationMessageHeaderAccessor.REPLY_CHANNEL</code> header.
That header is typically auto-created by the entry point into a message flow, such as any <span class="emphasis"><em>Gateway</em></span> component.
However, if the message flow was started by manually creating a Spring Integration Message and sending it directly to a <span class="emphasis"><em>Channel</em></span>, then you must specify the message header explicitly or use the provided <span class="emphasis"><em>reply-channel</em></span> attribute.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jmx-mbean-exporter" href="#jmx-mbean-exporter"></a>9.2.7&nbsp;MBean Exporter</h3></div></div></div>

<p>Spring Integration components themselves may be exposed as MBeans when the <code class="literal">IntegrationMBeanExporter</code> is configured.
To create an instance of the <code class="literal">IntegrationMBeanExporter</code>, define a bean and provide a reference to an <code class="literal">MBeanServer</code> and a domain name (if desired).
The domain can be left out, in which case the default domain is <span class="emphasis"><em>org.springframework.integration</em></span>.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-jmx:mbean-export</span> <span class="hl-attribute">id</span>=<span class="hl-value">"integrationMBeanExporter"</span>
            <span class="hl-attribute">default-domain</span>=<span class="hl-value">"my.company.domain"</span> <span class="hl-attribute">server</span>=<span class="hl-value">"mbeanServer"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"mbeanServer"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jmx.support.MBeanServerFactoryBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"locateExistingServerIfPossible"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>The MBean exporter is orthogonal to the one provided in Spring core - it registers message channels and message handlers, but not itself.
You can expose the exporter itself, and certain other components in Spring Integration, using the standard <code class="literal">&lt;context:mbean-export/&gt;</code> tag.
The exporter has a some metrics attached to it, for instance a count of the number of active handlers and the number of queued messages.</p>
<p>It also has a useful operation, as discussed in <a class="xref" href="#jmx-mbean-shutdown" title="Orderly Shutdown Managed Operation">the section called &#8220;Orderly Shutdown Managed Operation&#8221;</a>.</p>
</td></tr></table></div>
<p>Starting with <span class="emphasis"><em>Spring Integration 4.0</em></span> the <code class="literal">@EnableIntegrationMBeanExport</code> annotation has been introduced for convenient configuration of a default (<code class="literal">integrationMbeanExporter</code>) bean of type <code class="literal">IntegrationMBeanExporter</code> with several useful options at the <code class="literal">@Configuration</code> class level.
For example:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Configuration</span></em>
<em><span class="hl-annotation" style="color: gray">@EnableIntegration</span></em>
<em><span class="hl-annotation" style="color: gray">@EnableIntegrationMBeanExport(server = "mbeanServer", managedComponents = "input")</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ContextConfiguration {

	<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
	<span class="hl-keyword">public</span> MBeanServerFactoryBean mbeanServer() {
		<span class="hl-keyword">return</span> <span class="hl-keyword">new</span> MBeanServerFactoryBean();
	}
}</pre>
<p>If there is a need to provide more options, or have several <code class="literal">IntegrationMBeanExporter</code> beans e.g.
for different MBean Servers, or to avoid conflicts with the standard Spring <code class="literal">MBeanExporter</code> (e.g.
via <code class="literal">@EnableMBeanExport</code>), you can simply configure an <code class="literal">IntegrationMBeanExporter</code> as a generic bean.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="jmx-mbean-features" href="#jmx-mbean-features"></a>MBean ObjectNames</h4></div></div></div>

<p>All the <code class="literal">MessageChannel</code>, <code class="literal">MessageHandler</code> and <code class="literal">MessageSource</code> instances in the application are wrapped by the MBean exporter to provide management and monitoring features.
The generated JMX object names for each component type are listed in the table below:</p>
<div class="table"><a name="d5e7827" href="#d5e7827"></a><p class="title"><b>Table&nbsp;9.3.&nbsp;MBean ObjectNames</b></p><div class="table-contents">

<table summary="MBean ObjectNames" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Component Type</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">ObjectName</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>MessageChannel</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><pre class="literallayout">o.s.i:type=MessageChannel,name=&lt;channelName&gt;</pre></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>MessageSource</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><pre class="literallayout">o.s.i:type=MessageSource,name=&lt;channelName&gt;,bean=&lt;source&gt;</pre></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>MessageHandler</p></td><td style="" align="left" valign="top"><pre class="literallayout">o.s.i:type=MessageSource,name=&lt;channelName&gt;,bean=&lt;source&gt;</pre></td></tr></tbody></table>
</div></div><br class="table-break">
<p>The <span class="emphasis"><em>bean</em></span> attribute in the object names for sources and handlers takes one of the values in the table below:</p>
<div class="table"><a name="d5e7854" href="#d5e7854"></a><p class="title"><b>Table&nbsp;9.4.&nbsp;bean ObjectName Part</b></p><div class="table-contents">

<table summary="bean ObjectName Part" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Bean Value</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Description</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>endpoint</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The bean name of the enclosing endpoint (e.g.
&lt;service-activator&gt;) if there is one</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>anonymous</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>An indication that the enclosing endpoint didn&#8217;t have a user-specified bean name, so the JMX name is the input channel name</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>internal</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>For well-known Spring Integration default  components</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>handler/source</p></td><td style="" align="left" valign="top"><p>None of the above: fallback to the <code class="literal">toString()</code> of the object being monitored (handler or source)</p></td></tr></tbody></table>
</div></div><br class="table-break">
<p>Custom elements can be appended to the object name by providing a reference to a <code class="literal">Properties</code> object in the <code class="literal">object-name-static-properties</code> attribute.</p>
<p>Also, since <span class="emphasis"><em>Spring Integration 3.0</em></span>, you can use a custom <a class="ulink" href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/jmx/export/naming/ObjectNamingStrategy.html" target="_top">ObjectNamingStrategy</a> using the <code class="literal">object-naming-strategy</code> attribute.
This permits greater control over the naming of the MBeans.
For example, to group all Integration MBeans under an <span class="emphasis"><em>Integration</em></span> type.
A simple custom naming strategy implementation might be:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> Namer <span class="hl-keyword">implements</span> ObjectNamingStrategy {

	<span class="hl-keyword">private</span> <span class="hl-keyword">final</span> ObjectNamingStrategy realNamer = <span class="hl-keyword">new</span> KeyNamingStrategy();
	<em><span class="hl-annotation" style="color: gray">@Override</span></em>
	<span class="hl-keyword">public</span> ObjectName getObjectName(Object managedBean, String beanKey) <span class="hl-keyword">throws</span> MalformedObjectNameException {
		String actualBeanKey = beanKey.replace(<span class="hl-string">"type="</span>, <span class="hl-string">"type=Integration,componentType="</span>);
		<span class="hl-keyword">return</span> realNamer.getObjectName(managedBean, actualBeanKey);
	}

}</pre>
<p>The <code class="literal">beanKey</code> argument is a String containing the standard object name beginning with the <code class="literal">default-domain</code> and including any additional static properties.
This example simply moves the standard <code class="literal">type</code> part to <code class="literal">componentType</code> and sets the <code class="literal">type</code> to <span class="emphasis"><em>Integration</em></span>, enabling selection of all Integration MBeans in one query:<code class="literal">"my.domain:type=Integration,*</code>.
This also groups the beans under one tree entry under the domain in tools like VisualVM.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The default naming strategy is a <a class="ulink" href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/jmx/export/naming/MetadataNamingStrategy.html" target="_top">MetadataNamingStrategy</a>.
The exporter propagates the <code class="literal">default-domain</code> to that object to allow it to generate a fallback object name if parsing of the bean key fails.
If your custom naming strategy is a <code class="literal">MetadataNamingStrategy</code> (or subclass), the exporter will <span class="strong"><strong>not</strong></span> propagate the <code class="literal">default-domain</code>; you will need to configure it on your strategy bean.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="jmx-42-improvements" href="#jmx-42-improvements"></a>JMX Improvements</h4></div></div></div>

<p><span class="emphasis"><em>Version 4.2</em></span> introduced some important improvements, representing a fairly major overhaul to the JMX support in the framework.
These resulted in a significant performance improvement of the JMX statistics collection and much more control thereof, but has some implications for user code in a few specific (uncommon) situations.
These changes are detailed below, with a <span class="strong"><strong>caution</strong></span> where necessary.</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>Metrics Capture</strong></span>
</li></ul></div>
<p>Previously, <code class="literal">MessageSource</code>, <code class="literal">MessageChannel</code> and <code class="literal">MessageHandler</code> metrics were captured by wrapping the object in a JDK dynamic proxy to intercept appropriate method calls and capture the statistics.
The proxy was added when an integration MBean exporter was declared in the context.</p>
<p>Now, the statistics are captured by the beans themselves; see <a class="xref" href="#metrics-management" title="9.1&nbsp;Metrics and Management">Section&nbsp;9.1, &#8220;Metrics and Management&#8221;</a> for more information.</p>
<div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Warning"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Warning]" src="images/warning.png"></td><th align="left">Warning</th></tr><tr><td align="left" valign="top">
<p>This change means that you no longer automatically get an MBean or statistics for custom <code class="literal">MessageHandler</code> implementations, unless those custom handlers extend <code class="literal">AbstractMessageHandler</code>.
The simplest way to resolve this is to extend <code class="literal">AbstractMessageHandler</code>.
If that&#8217;s not possible, or desired, another work-around is to implement the <code class="literal">MessageHandlerMetrics</code> interface.
For convenience, a <code class="literal">DefaultMessageHandlerMetrics</code> is provided to capture and report statistics.
Invoke the <code class="literal">beforeHandle</code> and <code class="literal">afterHandle</code> at the appropriate times.
Your <code class="literal">MessageHandlerMetrics</code> methods can then delegate to this object to obtain each statistic.
Similarly, <code class="literal">MessageSource</code> implementations must extend <code class="literal">AbstractMessageSource</code> or implement <code class="literal">MessageSourceMetrics</code>.
Message sources only capture a count so there is no provided convenience class; simply maintain the count in an <code class="literal">AtomicLong</code> field.</p>
</td></tr></table></div>
<p>The removal of the proxy has two additional benefits; 1) stack traces in exceptions are reduced (when JMX is enabled) because the proxy is not on the stack; 2) cases where 2 MBeans were exported for the same bean now only export a single MBean with consolidated attributes/operations (see the MBean consolidation bullet below).</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>Resolution</strong></span>
</li></ul></div>
<p><code class="literal">System.nanoTime()</code> is now used to capture times instead of <code class="literal">System.currentTimeMillis()</code>.
This may provide more accuracy on some JVMs, espcially when durations of less than 1 millisecond are expected</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>Setting Initial Statistics Collection State</strong></span>
</li></ul></div>
<p>Previously, when JMX was enabled, all sources, channels, handlers captured statistics.
It is now possible to control whether the statisics are enabled on an individual component.
Further, it is possible to capture simple counts on <code class="literal">MessageChannel</code> s and <code class="literal">MessageHandler</code> s instead of the complete time-based statistics.
This can have significant performance implications because you can selectively configure where you need detailed statistics, as well as enable/disable at runtime.</p>
<p>See <a class="xref" href="#metrics-management" title="9.1&nbsp;Metrics and Management">Section&nbsp;9.1, &#8220;Metrics and Management&#8221;</a>.</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>@IntegrationManagedResource</strong></span>
</li></ul></div>
<p>Similar to the <code class="literal">@ManagedResource</code> annotation, the <code class="literal">@IntegrationManagedResource</code> marks a class as eligible to be exported as an MBean; however, it will only be exported if there is an <code class="literal">IntegrationMBeanExporter</code> in the application context.</p>
<p>Certain Spring Integration classes (in the <code class="literal">org.springframework.integration</code>) package) that were previously annotated with`@ManagedResource` are now annotated with both <code class="literal">@ManagedResource</code> and <code class="literal">@IntegrationManagedResource</code>.
This is for backwards compatibility (see the next bullet).
Such MBeans will be exported by any context <code class="literal">MBeanServer</code><span class="strong"><strong>or</strong></span> an <code class="literal">IntegrationMBeanExporter</code> (but not both - if both exporters are present, the bean is exported by the integration exporter if the bean matches a <code class="literal">managed-components</code> pattern).</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>Consolidated MBeans</strong></span>
</li></ul></div>
<p>Certain classes within the framework (mapping routers for example) have additional attributes/operations over and above those provided by metrics and <code class="literal">Lifecycle</code>.
We will use a <code class="literal">Router</code> as an example here.</p>
<p>Previously, beans of these types were exported as two distinct MBeans:</p>
<p>1) the metrics MBean (with an objectName such as: <code class="literal">intDomain:type=MessageHandler,name=myRouter,bean=endpoint</code>).
This MBean had metrics attributes and metrics/Lifecycle operations.</p>
<p>2) a second MBean (with an objectName such as:
<code class="literal">ctxDomain:name=org.springframework.integration.config.RouterFactoryBean#0</code>
<code class="literal">,type=MethodInvokingRouter</code>)
was exported with the channel mappings attribute and operations.</p>
<p>Now, the attributes and operations are consolidated into a single MBean.
The objectName will depend on the exporter.
If exported by the integration MBean exporter, the objectName will be, for example: <code class="literal">intDomain:type=MessageHandler,name=myRouter,bean=endpoint</code>.
If exported by another exporter, the objectName will be, for example: <code class="literal">ctxDomain:name=org.springframework.integration.config.RouterFactoryBean#0</code>
<code class="literal">,type=MethodInvokingRouter</code>.
There is no difference between these MBeans (aside from the objectName), except that the statistics will <span class="strong"><strong>not</strong></span> be enabled (the attributes will be 0) by exporters other than the integration exporter; statistics can be enabled at runtime using the JMX operations.
When exported by the integration MBean exporter, the initial state can be managed as described above.</p>
<div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Warning"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Warning]" src="images/warning.png"></td><th align="left">Warning</th></tr><tr><td align="left" valign="top">
<p>If you are currently using the second MBean to change, for example, channel mappings, <span class="strong"><strong>and</strong></span> you are using the integration MBean exporter, note that the objectName has changed because of the MBean consolidation.
There is no change if you are not using the integration MBean exporter.</p>
</td></tr></table></div>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>MBean Exporter Bean Name Patterns</strong></span>
</li></ul></div>
<p>Previously, the <code class="literal">managed-components</code> patterns were inclusive only.
If a bean name matched one of the patterns it would be included.
Now, the pattern can be negated by prefixing it with <code class="literal">!</code>.
i.e.
<code class="literal">"!foo*, foox"</code> will match all beans that don&#8217;t start with <code class="literal">foo</code>, except <code class="literal">foox</code>.
Patterns are evaluated left to right and the first match (positive or negative) wins and no further patterns are applied.</p>
<div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Warning"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Warning]" src="images/warning.png"></td><th align="left">Warning</th></tr><tr><td align="left" valign="top">
<p>The addition of this syntax to the pattern causes one possible (although perhaps unlikey) problem.
If you have a bean <code class="literal">"!foo"</code><span class="strong"><strong>and</strong></span> you included a pattern <code class="literal">"!foo"</code> in your MBean exporter&#8217;s <code class="literal">managed-components</code> patterns; it will no long match; the pattern will now match all beans <span class="strong"><strong>not</strong></span> named <code class="literal">foo</code>.
In this case, you can escape the <code class="literal">!</code> in the pattern with <code class="literal">\</code>.
The pattern <code class="literal">"\!foo"</code> means match a bean named <code class="literal">"!foo"</code>.</p>
</td></tr></table></div>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>IntegrationMBeanExporter changes</strong></span>
</li></ul></div>
<p>The <code class="literal">IntegrationMBeanExporter</code> no longer implements <code class="literal">SmartLifecycle</code>; this means that <code class="literal">start()</code> and <code class="literal">stop()</code> operations
are no longer available to register/unregister MBeans.
The MBeans are now registered during context initialization and unregistered when the context is destroyed.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="jmx-mbean-shutdown" href="#jmx-mbean-shutdown"></a>Orderly Shutdown Managed Operation</h4></div></div></div>

<p>The MBean exporter provides a JMX operation to shut down the application in an orderly manner, intended for use before terminating the JVM.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">void</span> stopActiveComponents(<span class="hl-keyword">long</span> howLong)</pre>
<p>Its use and operation are described in <a class="xref" href="#jmx-shutdown" title="9.7&nbsp;Orderly Shutdown">Section&nbsp;9.7, &#8220;Orderly Shutdown&#8221;</a>.</p>
</div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="message-history" href="#message-history"></a>9.3&nbsp;Message History</h2></div></div></div>

<p>The key benefit of a messaging architecture is loose coupling where participating components do not maintain any awareness about one another.
This fact alone makes your application extremely flexible, allowing you to change components without affecting the rest of the flow, change messaging routes, &nbsp; message consuming styles (polling vs event driven), and so on.
However, this unassuming style of architecture could prove to be difficult when things go wrong.
When debugging, you would probably like to get as much information about the message as you can (its origin, channels it has traversed, etc.)</p>
<p>Message History is one of those patterns that helps by giving you an option to maintain some level of awareness of a message path either for debugging purposes or to maintain an audit trail.
Spring integration provides a simple way to configure your message flows to maintain the Message History by adding a header to the Message and updating that header every time a message passes through a tracked component.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="message-history-config" href="#message-history-config"></a>9.3.1&nbsp;Message History Configuration</h3></div></div></div>

<p>To enable Message History all you need is to define the <code class="literal">message-history</code> element in your configuration.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:message-history/&gt;</span></pre>
<p>Now every named component (component that has an <span class="emphasis"><em>id</em></span> defined) will be tracked.
The framework will set the <span class="emphasis"><em>history</em></span> header in your Message.
Its value is very simple - <code class="literal">List&lt;Properties&gt;</code>.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:gateway&nbsp;id="sampleGateway"&nbsp;</span>
    <span class="hl-attribute">service-interface</span>=<span class="hl-value">"org.springframework.integration.history.sample.SampleGateway"</span>
    <span class="hl-attribute">default-request-channel</span>=<span class="hl-value">"bridgeInChannel"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int:chain&nbsp;id="sampleChain"&nbsp;input-channel="chainChannel"&nbsp;output-channel="filterChannel"&gt;</span>
  <span class="hl-tag">&lt;int:header-enricher&gt;</span>
    <span class="hl-tag">&lt;int:header&nbsp;name="baz"&nbsp;value="baz"/&gt;</span>
  <span class="hl-tag">&lt;/int:header-enricher&gt;</span>
<span class="hl-tag">&lt;/int:chain&gt;</span></pre>
<p>The above configuration will produce a very simple Message History structure:</p>
<pre class="programlisting">[{name=sampleGateway, type=gateway, timestamp=<span class="hl-number">1283281668091</span>},
 {name=sampleChain, type=chain, timestamp=<span class="hl-number">1283281668094</span>}]</pre>
<p>To get access to Message History all you need is access the MessageHistory header.
For example:</p>
<pre class="programlisting">Iterator&lt;Properties&gt; historyIterator =
    message.getHeaders().get(MessageHistory.HEADER_NAME, MessageHistory.<span class="hl-keyword">class</span>).iterator();
assertTrue(historyIterator.hasNext());
Properties gatewayHistory = historyIterator.next();
assertEquals(<span class="hl-string">"sampleGateway"</span>, gatewayHistory.get(<span class="hl-string">"name"</span>));
assertTrue(historyIterator.hasNext());
Properties chainHistory = historyIterator.next();
assertEquals(<span class="hl-string">"sampleChain"</span>, chainHistory.get(<span class="hl-string">"name"</span>));</pre>
<p>You might not want to track all of the components.
To limit the history to certain components based on their names, all you need is provide the <code class="literal">tracked-components</code> attribute and specify a comma-delimited list of component names and/or patterns that match the components you want to track.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:message-history</span> <span class="hl-attribute">tracked-components</span>=<span class="hl-value">"*Gateway, sample*, foo"</span><span class="hl-tag">/&gt;</span></pre>
<p>In the above example, Message History will only be maintained for all of the components that end with <span class="emphasis"><em>Gateway</em></span>, start with <span class="emphasis"><em>sample</em></span>, or match the name <span class="emphasis"><em>foo</em></span> exactly.</p>
<p>Starting with <span class="emphasis"><em>version 4.0</em></span>, you can also use the <code class="literal">@EnableMessageHistory</code> annotation in a <code class="literal">@Configuration</code> class.
In addition, the <code class="literal">MessageHistoryConfigurer</code> bean is now exposed as a JMX MBean by the <code class="literal">IntegrationMBeanExporter</code> (see <a class="xref" href="#jmx-mbean-exporter" title="9.2.7&nbsp;MBean Exporter">Section&nbsp;9.2.7, &#8220;MBean Exporter&#8221;</a>), allowing the patterns to be changed at runtime.
Note, however, that the bean must be stopped (turning off message history) in order to change the patterns.
This feature might be useful to temporarily turn on history to analyze a system.
The MBean&#8217;s object name is <code class="literal">"&lt;domain&gt;:name=messageHistoryConfigurer,type=MessageHistoryConfigurer"</code>.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>If multiple beans (declared by <code class="literal">@EnableMessageHistory</code> and/or <code class="literal">&lt;message-history/&gt;</code>) they all must have identical component name patterns (when trimmed and sorted).
<span class="strong"><strong>Do not use a generic
	<code class="literal">&lt;bean/&gt;</code> definition for the <code class="literal">MessageHistoryConfigurer</code></strong></span>.</p>
</td></tr></table></div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Remember that by definition the Message History header is immutable (you can&#8217;t re-write history, although some try).
Therefore, when writing Message History values, the components are either creating brand new Messages (when the component is an origin), or they are copying the history from a request Message, modifying it and setting the new list on a reply Message.
In either case, the values can be appended even if the Message itself is crossing thread boundaries.
That means that the history values can greatly simplify debugging in an asynchronous message flow.</p>
</td></tr></table></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="message-store" href="#message-store"></a>9.4&nbsp;Message Store</h2></div></div></div>

<p>Enterprise Integration Patterns (EIP) identifies several patterns that have the capability to buffer messages.
For example, an <span class="emphasis"><em>Aggregator</em></span> buffers messages until they can be released and a <span class="emphasis"><em>QueueChannel</em></span> buffers messages until consumers explicitly receive those messages from that channel.
Because of the failures that can occur at any point within your message flow, EIP components that buffer messages also introduce a point where messages could be lost.</p>
<p>To mitigate the risk of losing Messages, EIP defines the <a class="ulink" href="http://eaipatterns.com/MessageStore.html" target="_top">Message Store</a> pattern which allows EIP components to store <span class="emphasis"><em>Messages</em></span> typically in some type of persistent store (e.g.
RDBMS).</p>
<p>Spring Integration provides support for the <span class="emphasis"><em>Message Store</em></span> pattern by a) defining a <code class="literal">org.springframework.integration.store.MessageStore</code> strategy interface, b) providing several implementations of this interface, and c) exposing a <code class="literal">message-store</code> attribute on all components that have the capability to buffer messages so that you can inject any instance that implements the <code class="literal">MessageStore</code> interface.</p>
<p>Details on how to configure a specific <span class="emphasis"><em>Message Store</em></span> implementation and/or how to inject a <code class="literal">MessageStore</code> implementation into a specific buffering component are described throughout the manual (see the specific component, such as <a class="link" href="#channel-configuration-queuechannel" title="QueueChannel Configuration"><span class="emphasis"><em>QueueChannel</em></span></a>, <a class="link" href="#aggregator" title="6.4&nbsp;Aggregator"><span class="emphasis"><em>Aggregator</em></span></a>, <a class="link" href="#delayer" title="8.6&nbsp;Delayer"><span class="emphasis"><em>Delayer</em></span></a> etc.), but here are a couple of samples to give you an idea:</p>
<p>QueueChannel</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myQueueChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:queue</span> <span class="hl-attribute">message-store</span>=<span class="hl-value">"refToMessageStore"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;int:channel&gt;</span></pre>
<p>Aggregator</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:aggregator</span> <span class="hl-attribute">&#8230;</span> <span class="hl-attribute">message-store</span>=<span class="hl-value">"refToMessageStore"</span><span class="hl-tag">/&gt;</span></pre>
<p>By default <span class="emphasis"><em>Messages</em></span> are stored in-memory using <code class="literal">org.springframework.integration.store.SimpleMessageStore</code>, an implementation of <code class="literal">MessageStore</code>.
That might be fine for development or simple low-volume environments where the potential loss of non-persistent messages is not a concern.
However, the typical production application will need a more robust option, not only to mitigate the risk of message loss but also to avoid potential out-of-memory errors.
Therefore, we also provide MessageStore implementations for a variety of data-stores.
Below is a complete list of supported implementations:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="xref" href="#jdbc-message-store" title="18.4&nbsp;JDBC Message Store">Section&nbsp;18.4, &#8220;JDBC Message Store&#8221;</a> - uses RDBMS to store Messages
</li><li class="listitem">
<a class="xref" href="#redis-message-store" title="24.4&nbsp;Redis Message Store">Section&nbsp;24.4, &#8220;Redis Message Store&#8221;</a> - uses Redis key/value datastore to store Messages
</li><li class="listitem">
<a class="xref" href="#mongodb-message-store" title="22.3&nbsp;MongoDB Message Store">Section&nbsp;22.3, &#8220;MongoDB Message Store&#8221;</a> - uses MongoDB document store to store Messages
</li><li class="listitem">
<a class="xref" href="#gemfire-message-store" title="16.5&nbsp;Gemfire Message Store">Section&nbsp;16.5, &#8220;Gemfire Message Store&#8221;</a> - uses Gemfire distributed cache to store Messages
</li></ul></div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>However be aware of some limitations while using persistent implementations of the <code class="literal">MessageStore</code>.</p>
<p>The Message data (payload and headers) is <span class="emphasis"><em>serialized</em></span> and <span class="emphasis"><em>deserialized</em></span> using different serialization strategies depending on the implementation of the <code class="literal">MessageStore</code>.
For example, when using <code class="literal">JdbcMessageStore</code>, only <code class="literal">Serializable</code> data is persisted by default.
In this case non-Serializable headers are removed before serialization occurs.
Also be aware of the protocol specific headers that are injected by transport adapters (e.g., FTP, HTTP, JMS etc.).
For example, <code class="literal">&lt;http:inbound-channel-adapter/&gt;</code> maps HTTP-headers into Message Headers and one of them is an <code class="literal">ArrayList</code> of non-Serializable <code class="literal">org.springframework.http.MediaType</code> instances.
However you are able to inject your own implementation of the <code class="literal">Serializer</code> and/or <code class="literal">Deserializer</code> strategy interfaces into some <code class="literal">MessageStore</code> implementations (such as JdbcMessageStore) to change the behaviour of serialization and deserialization.</p>
<p>Special attention must be paid to the headers that represent certain types of data.
For example, if one of the headers contains an instance of some <span class="emphasis"><em>Spring Bean</em></span>, upon deserialization you may end up with a different instance of that bean, which directly affects some of the implicit headers created by the framework (e.g., REPLY_CHANNEL or ERROR_CHANNEL).
Currently they are not serializable, but even if they were, the deserialized channel would not represent the expected instance.</p>
<p>Beginning with <span class="emphasis"><em>Spring Integration version 3.0</em></span>, this issue can be resolved with a header enricher, configured to replace these headers with a name after registering the channel with the <code class="literal">HeaderChannelRegistry</code>.</p>
<p>Also when configuring a message-flow like this: <span class="emphasis"><em>gateway &#8594; queue-channel (backed by a persistent Message Store) &#8594; service-activator</em></span> That gateway creates a <span class="emphasis"><em>Temporary Reply Channel</em></span>, and it will be lost by the time the service-activator&#8217;s poller reads from the queue.
Again, you can use the header enricher to replace the headers with a String representation.</p>
<p>For more information, refer to the <a class="xref" href="#header-enricher" title="7.2.2&nbsp;Header Enricher">Section&nbsp;7.2.2, &#8220;Header Enricher&#8221;</a>.</p>
</td></tr></table></div>
<p><span class="emphasis"><em>Spring Integration 4.0</em></span> introduced two new interfaces <code class="literal">ChannelMessageStore</code> - to implement operations specific for <code class="literal">QueueChannel</code> s, <code class="literal">PriorityCapableChannelMessageStore</code> - to mark <code class="literal">MessageStore</code> implementation to be used for <code class="literal">PriorityChannel</code> s and to provide <span class="emphasis"><em>priority</em></span> order for persisted Messages.
The real behaviour depends on implementation.
The Framework provides these implementations, which can be used as a persistent <code class="literal">MessageStore</code> for <code class="literal">QueueChannel</code> and <code class="literal">PriorityChannel</code>:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="xref" href="#redis-cms" title="24.4.1&nbsp;Redis Channel Message Stores">Section&nbsp;24.4.1, &#8220;Redis Channel Message Stores&#8221;</a>
</li><li class="listitem">
<a class="xref" href="#mongodb-priority-channel-message-store" title="22.3.1&nbsp;MongoDB Channel Message Store">Section&nbsp;22.3.1, &#8220;MongoDB Channel Message Store&#8221;</a>
</li><li class="listitem">
<a class="xref" href="#jdbc-message-store-channels" title="18.4.2&nbsp;Backing Message Channels">Section&nbsp;18.4.2, &#8220;Backing Message Channels&#8221;</a>
</li></ul></div>
<div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Warning: Caution with SimpleMessageStore"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Warning]" src="images/warning.png"></td><th align="left"><a name="sms-caution" href="#sms-caution"></a>Caution with SimpleMessageStore</th></tr><tr><td align="left" valign="top">

<p>Starting with <span class="emphasis"><em>version 4.1</em></span>, the <code class="literal">SimpleMessageStore</code> no longer copies the message group when calling <code class="literal">getMessageGroup()</code>.
For large message groups, this was a significant performance problem.
4.0.1 introduced a boolean <code class="literal">copyOnGet</code> allowing this to be controlled.
When used internally by the aggregator, this was set to false to improve performance.
It is now false by default.</p>
<p>Users accessing the group store outside of components such as aggregators, will now get a direct reference to the group being used by the aggregator, instead of a copy.
Manipulation of the group outside of the aggregator may cause unpredictable results.</p>
<p>For this reason, users should not perform such manipulation, or set the <code class="literal">copyOnGet</code> property to <code class="literal">true</code>.</p>
</td></tr></table></div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="message-group-factory" href="#message-group-factory"></a>9.4.1&nbsp;MessageGroupFactory</h3></div></div></div>

<p>Starting with <span class="emphasis"><em>version 4.3</em></span>, some <code class="literal">MessageGroupStore</code> implementations can be injected with a custom
<code class="literal">MessageGroupFactory</code> strategy to create/customize the <code class="literal">MessageGroup</code> instances used by the <code class="literal">MessageGroupStore</code>.
This defaults to a <code class="literal">SimpleMessageGroupFactory</code> which produces <code class="literal">SimpleMessageGroup</code> s based on the <code class="literal">GroupType.HASH_SET</code>
(<code class="literal">LinkedHashSet</code>) internal collection.
Other possible options are <code class="literal">SYNCHRONISED_SET</code> and <code class="literal">BLOCKING_QUEUE</code>, where the last one can be used to reinstate the
previous <code class="literal">SimpleMessageGroup</code> behavior.
Also the <code class="literal">PERSISTENT</code> option is available. See the next section for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="lazy-load-message-group" href="#lazy-load-message-group"></a>9.4.2&nbsp;Persistence MessageGroupStore and Lazy-Load</h3></div></div></div>

<p>Starting with <span class="emphasis"><em>version 4.3</em></span>, all persistence <code class="literal">MessageGroupStore</code> s retrieve <code class="literal">MessageGroup</code> s and their <code class="literal">messages</code>
from the store with the <span class="emphasis"><em>Lazy-Load</em></span> manner.
In most cases it is useful for the Correlation <code class="literal">MessageHandler</code> s (<a class="xref" href="#aggregator" title="6.4&nbsp;Aggregator">Section&nbsp;6.4, &#8220;Aggregator&#8221;</a> and <a class="xref" href="#resequencer" title="6.5&nbsp;Resequencer">Section&nbsp;6.5, &#8220;Resequencer&#8221;</a>),
when it would be an overhead to load entire <code class="literal">MessageGroup</code> from the store on each correlation operation.</p>
<p>To switch off the lazy-load behavior the <code class="literal">AbstractMessageGroupStore.setLazyLoadMessageGroups(false)</code> option
can be used from the configuration.</p>
<p>Our performance tests for <span class="emphasis"><em>lazy-load</em></span> on MongoDB <code class="literal">MessageStore</code> (<a class="xref" href="#mongodb-message-store" title="22.3&nbsp;MongoDB Message Store">Section&nbsp;22.3, &#8220;MongoDB Message Store&#8221;</a>) and
<code class="literal">&lt;aggregator&gt;</code> (<a class="xref" href="#aggregator" title="6.4&nbsp;Aggregator">Section&nbsp;6.4, &#8220;Aggregator&#8221;</a>)
with custom <code class="literal">release-strategy</code> like:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:aggregator</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"inputChannel"</span>
                <span class="hl-attribute">output-channel</span>=<span class="hl-value">"outputChannel"</span>
                <span class="hl-attribute">message-store</span>=<span class="hl-value">"mongoStore"</span>
                <span class="hl-attribute">release-strategy-expression</span>=<span class="hl-value">"size() == 1000"</span><span class="hl-tag">/&gt;</span></pre>
<p>demonstrate this results for 1000 simple messages:</p>
<pre class="literallayout">StopWatch 'Lazy-Load Performance': running time (millis) = 38918
-----------------------------------------
ms     %     Task name
-----------------------------------------
02652  007%  Lazy-Load
36266  093%  Eager</pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="metadata-store" href="#metadata-store"></a>9.5&nbsp;Metadata Store</h2></div></div></div>

<p>Many external systems, services or resources aren&#8217;t transactional (Twitter, RSS, file system etc.) and there is no any ability to mark the data as read.
Or there is just need to implement the Enterprise Integration Pattern <a class="ulink" href="http://eaipatterns.com/IdempotentReceiver.html" target="_top">Idempotent Receiver</a> in some integration solutions.
To achieve this goal and store some previous state of the Endpoint before the next interaction with external system, or deal with the next Message, Spring Integration provides the <span class="emphasis"><em>Metadata Store</em></span> component being an implementation of the <code class="literal">org.springframework.integration.metadata.MetadataStore</code> interface with a general <span class="emphasis"><em>key-value</em></span> contract.</p>
<p>The <span class="emphasis"><em>Metadata Store</em></span> is designed to store various types of generic meta-data (e.g., published date of the last feed entry that has been processed) to help components such as the Feed adapter deal with duplicates.
If a component is not directly provided with a reference to a <code class="literal">MetadataStore</code>, the algorithm for locating a metadata store is as follows: First, look for a bean with id <code class="literal">metadataStore</code> in the ApplicationContext.
If one is found then it will be used, otherwise it will create a new instance of <code class="literal">SimpleMetadataStore</code> which is an in-memory implementation that will only persist metadata within the lifecycle of the currently running Application Context.
This means that upon restart you may end up with duplicate entries.</p>
<p>If you need to persist metadata between Application Context restarts, these persistent <code class="literal">MetadataStores</code> are provided by
the framework:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">PropertiesPersistingMetadataStore</code>
</li><li class="listitem">
<a class="xref" href="#redis-metadata-store" title="24.5&nbsp;Redis Metadata Store">Section&nbsp;24.5, &#8220;Redis Metadata Store&#8221;</a>
</li><li class="listitem">
<a class="xref" href="#gemfire-metadata-store" title="16.7&nbsp;Gemfire Metadata Store">Section&nbsp;16.7, &#8220;Gemfire Metadata Store&#8221;</a>
</li><li class="listitem">
<a class="xref" href="#mongodb-metadata-store" title="22.3.2&nbsp;MongoDB Metadata Store">Section&nbsp;22.3.2, &#8220;MongoDB Metadata Store&#8221;</a>
</li><li class="listitem">
<a class="xref" href="#zk-metadata-store" title="37.2&nbsp;Zookeeper Metadata Store">Section&nbsp;37.2, &#8220;Zookeeper Metadata Store&#8221;</a>
</li></ul></div>
<p>The <code class="literal">PropertiesPersistingMetadataStore</code> is backed by a properties file and a <a class="ulink" href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/util/PropertiesPersister.html" target="_top">PropertiesPersister</a>.</p>
<p>By default, it only persists the state when the application context is closed normally. It implements <code class="literal">Flushable</code> so you
can persist the state at will, be invoking <code class="literal">flush()</code>.</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"metadataStore"</span>
    <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.store.PropertiesPersistingMetadataStore"</span><span class="hl-tag">/&gt;</span></pre>
<p>Alternatively, you can provide your own implementation of the <code class="literal">MetadataStore</code> interface (e.g.
JdbcMetadataStore) and configure it as a bean in the Application Context.</p>
<p>Starting with <span class="emphasis"><em>version 4.0</em></span>, <code class="literal">SimpleMetadataStore</code>, <code class="literal">PropertiesPersistingMetadataStore</code> and <code class="literal">RedisMetadataStore</code> implement <code class="literal">ConcurrentMetadataStore</code>.
These provide for atomic updates and can be used across multiple component or application instances.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="idempotent-receiver-pattern" href="#idempotent-receiver-pattern"></a>9.5.1&nbsp;Idempotent Receiver and Metadata Store</h3></div></div></div>

<p>The <span class="emphasis"><em>Metadata Store</em></span> is useful for implementing the EIP <a class="ulink" href="http://eaipatterns.com/IdempotentReceiver.html" target="_top">Idempotent Receiver</a> pattern, when there is need to <span class="emphasis"><em>filter</em></span> an incoming Message if it has already been processed, and just discard it or perform some other logic on discarding.
The following configuration is an example of how to do this:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:filter</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"serviceChannel"</span>
			<span class="hl-attribute">output-channel</span>=<span class="hl-value">"idempotentServiceChannel"</span>
			<span class="hl-attribute">discard-channel</span>=<span class="hl-value">"discardChannel"</span>
			<span class="hl-attribute">expression</span>=<span class="hl-value">"@metadataStore.get(headers.businessKey) == null"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int:publish-subscribe-channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"idempotentServiceChannel"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int:outbound-channel-adapter</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"idempotentServiceChannel"</span>
                              <span class="hl-attribute">expression</span>=<span class="hl-value">"@metadataStore.put(headers.businessKey, '')"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int:service-activator</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"idempotentServiceChannel"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"service"</span><span class="hl-tag">/&gt;</span></pre>
<p>The <code class="literal">value</code> of the idempotent entry may be some expiration date, after which that entry should be removed from <span class="emphasis"><em>Metadata Store</em></span> by some scheduled reaper.</p>
<p>Also see <a class="xref" href="#idempotent-receiver" title="8.9.10&nbsp;Idempotent Receiver Enterprise Integration Pattern">Section&nbsp;8.9.10, &#8220;Idempotent Receiver Enterprise Integration Pattern&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="metadatastore-listener" href="#metadatastore-listener"></a>9.5.2&nbsp;MetadataStoreListener</h3></div></div></div>

<p>Some metadata stores (currently only zookeeper) support registering a listener to receive events when items change.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> MetadataStoreListener {

	<span class="hl-keyword">void</span> onAdd(String key, String value);

	<span class="hl-keyword">void</span> onRemove(String key, String oldValue);

	<span class="hl-keyword">void</span> onUpdate(String key, String newValue);
}</pre>
<p>See the javadocs for more information.
The <code class="literal">MetadataStoreListenerAdapter</code> can be subclassed if you are only interested in a subset of events.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="control-bus" href="#control-bus"></a>9.6&nbsp;Control Bus</h2></div></div></div>

<p>As described in (EIP), the idea behind the Control Bus is that the same messaging system can be used for monitoring and managing the components within the framework as is used for "application-level" messaging.
In Spring Integration we build upon the adapters described above so that it&#8217;s possible to send Messages as a means of invoking exposed operations.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:control-bus</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"operationChannel"</span><span class="hl-tag">/&gt;</span></pre>
<p>The Control Bus has an input channel that can be accessed for invoking operations on the beans in the application context.
It also has all the common properties of a service activating endpoint, e.g.
you can specify an output channel if the result of the operation has a return value that you want to send on to a downstream channel.</p>
<p>The Control Bus executes messages on the input channel as Spring Expression Language expressions.
It takes a message, compiles the body to an expression, adds some context, and then executes it.
The default context supports any method that has been annotated with @ManagedAttribute or @ManagedOperation.
It also supports the methods on Spring&#8217;s Lifecycle interface, and it supports methods that are used to configure several of Spring&#8217;s TaskExecutor and TaskScheduler implementations.
The simplest way to ensure that your own methods are available to the Control Bus is to use the @ManagedAttribute and/or @ManagedOperation annotations.
Since those are also used for exposing methods to a JMX MBean registry, it&#8217;s a convenient by-product (often the same
types of operations you want to expose to the Control Bus would be reasonable for exposing via JMX).
Resolution of any particular instance within the application context is achieved in the typical SpEL syntax.
Simply provide the bean name with the SpEL prefix for beans (@).
For example, to execute a method on a Spring Bean a client could send a message to the operation channel as follows:</p>
<pre class="programlisting">Message operation = MessageBuilder.withPayload(<span class="hl-string">"@myServiceBean.shutdown()"</span>).build();
operationChannel.send(operation)</pre>
<p>The root of the context for the expression is the <code class="literal">Message</code> itself, so you also have access to the <span class="emphasis"><em>payload</em></span> and <span class="emphasis"><em>headers</em></span> as variables within your expression.
This is consistent with all the other expression support in Spring Integration endpoints.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jmx-shutdown" href="#jmx-shutdown"></a>9.7&nbsp;Orderly Shutdown</h2></div></div></div>

<p>As described in <a class="xref" href="#jmx-mbean-exporter" title="9.2.7&nbsp;MBean Exporter">Section&nbsp;9.2.7, &#8220;MBean Exporter&#8221;</a>, the MBean exporter provides a JMX operation <span class="emphasis"><em>stopActiveComponents</em></span>, which is used to stop the application in an orderly manner.
The operation has a single long parameter.
The parameter indicates how long (in milliseconds) the operation will wait to allow in-flight messages to complete.
The operation works as follows:</p>
<p>The first step calls <code class="literal">beforeShutdown()</code> on all beans that implement <code class="literal">OrderlyShutdownCapable</code>.
This allows such components to prepare for shutdown.
Examples of components that implement this interface, and what they do with this call include: JMS and AMQP message-driven adapters stop their listener containers; TCP server connection factories stop accepting new connections (while keeping existing connections open); TCP inbound endpoints drop (log) any new messages received; http inbound endpoints return <span class="emphasis"><em>503 - Service Unavailable</em></span> for any new requests.</p>
<p>The second step stops any active channels, such as JMS- or AMQP-backed channels.</p>
<p>The third step stops all <code class="literal">MessageSource</code> s.</p>
<p>The fourth step stops all inbound <code class="literal">MessageProducer</code> s (that are not <code class="literal">OrderlyShutdownCapable</code>).</p>
<p>The fifth step waits for any remaining time left, as defined by the value of the long parameter passed in to the operation.
This is intended to allow any in-flight messages to complete their journeys.
It is therefore important to select an appropriate timeout when invoking this operation.</p>
<p>The sixth step calls <code class="literal">afterShutdown()</code> on all OrderlyShutdownCapable components.
This allows such components to perform final shutdown tasks (closing all open sockets, for example).</p>
<p>As discussed in <a class="xref" href="#jmx-mbean-shutdown" title="Orderly Shutdown Managed Operation">the section called &#8220;Orderly Shutdown Managed Operation&#8221;</a> this operation can be invoked using JMX.
If you wish to programmatically invoke the method, you will need to inject, or otherwise get a reference to, the <code class="literal">IntegrationMBeanExporter</code>.
If no <code class="literal">id</code> attribute is provided on the <code class="literal">&lt;int-jmx:mbean-export/&gt;</code> definition, the bean will have a generated name.
This name contains a random component to avoid <code class="literal">ObjectName</code> collisions if multiple Spring Integration contexts exist in the same JVM (MBeanServer).</p>
<p>For this reason, if you wish to invoke the method programmatically, it is recommended that you provide the exporter with an <code class="literal">id</code> attribute so it can easily be accessed in the application context.</p>
<p>Finally, the operation can be invoked using the <code class="literal">&lt;control-bus&gt;</code>; see the <a class="ulink" href="https://github.com/spring-projects/spring-integration-samples/tree/master/intermediate/monitoring" target="_top">monitoring Spring Integration sample application</a> for details.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>The above algorithm was improved in <span class="emphasis"><em>version 4.1</em></span>.
Previously, all task executors and schedulers were stopped.
This could cause mid-flow messages in <code class="literal">QueueChannel</code> s to remain.
Now, the shutdown leaves pollers running in order to allow these messages to be drained and processed.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="integration-graph" href="#integration-graph"></a>9.8&nbsp;Integration Graph</h2></div></div></div>

<p>Starting with <span class="emphasis"><em>version 4.3</em></span>, Spring Integration provides access to an application&#8217;s runtime object model which can, optionally, include component metrics.
It is exposed as a graph, which may be used to visualize the current state of the integration application.
The <code class="literal">o.s.i.support.management.graph</code> package contains all the required classes to collect, build and render the runtime state of Spring Integration components as a single tree-like <code class="literal">Graph</code> object.
The <code class="literal">IntegrationGraphServer</code> should be declared as a bean to build, retrieve and refresh the <code class="literal">Graph</code> object.
The resulting <code class="literal">Graph</code> object can be serialized to any format, although JSON is flexible and convenient to parse and represent on the client side.
A simple Spring Integration application with only the default components would expose a graph as follows:</p>
<pre class="programlisting"><span class="hl-keyword">{</span>
  <span class="hl-string">"contentDescriptor"</span>: <span class="hl-keyword">{</span>
    <span class="hl-string">"providerVersion"</span>: <span class="hl-string">"4.3.0.RELEASE"</span><span class="hl-keyword">,</span>
    <span class="hl-string">"providerFormatVersion"</span>: <span class="hl-number">1.0</span><span class="hl-keyword">,</span>
    <span class="hl-string">"provider"</span>: <span class="hl-string">"spring-integration"</span><span class="hl-keyword">,</span>
    <span class="hl-string">"name"</span>: <span class="hl-string">"myApplication"</span>
  <span class="hl-keyword">},</span>
  <span class="hl-string">"nodes"</span>: <span class="hl-keyword">[</span>
    <span class="hl-keyword">{</span>
      <span class="hl-string">"nodeId"</span>: <span class="hl-number">1</span><span class="hl-keyword">,</span>
      <span class="hl-string">"name"</span>: <span class="hl-string">"nullChannel"</span><span class="hl-keyword">,</span>
      <span class="hl-string">"stats"</span>: null<span class="hl-keyword">,</span>
      <span class="hl-string">"componentType"</span>: <span class="hl-string">"channel"</span>
    <span class="hl-keyword">},</span>
    <span class="hl-keyword">{</span>
      <span class="hl-string">"nodeId"</span>: <span class="hl-number">2</span><span class="hl-keyword">,</span>
      <span class="hl-string">"name"</span>: <span class="hl-string">"errorChannel"</span><span class="hl-keyword">,</span>
      <span class="hl-string">"stats"</span>: null<span class="hl-keyword">,</span>
      <span class="hl-string">"componentType"</span>: <span class="hl-string">"publish-subscribe-channel"</span>
    <span class="hl-keyword">},</span>
    <span class="hl-keyword">{</span>
      <span class="hl-string">"nodeId"</span>: <span class="hl-number">3</span><span class="hl-keyword">,</span>
      <span class="hl-string">"name"</span>: <span class="hl-string">"_org.springframework.integration.errorLogger"</span><span class="hl-keyword">,</span>
      <span class="hl-string">"stats"</span>: <span class="hl-keyword">{</span>
        <span class="hl-string">"duration"</span>: <span class="hl-keyword">{</span>
          <span class="hl-string">"count"</span>: <span class="hl-number">0</span><span class="hl-keyword">,</span>
          <span class="hl-string">"min"</span>: <span class="hl-number">0.0</span><span class="hl-keyword">,</span>
          <span class="hl-string">"max"</span>: <span class="hl-number">0.0</span><span class="hl-keyword">,</span>
          <span class="hl-string">"mean"</span>: <span class="hl-number">0.0</span><span class="hl-keyword">,</span>
          <span class="hl-string">"standardDeviation"</span>: <span class="hl-number">0.0</span><span class="hl-keyword">,</span>
          <span class="hl-string">"countLong"</span>: <span class="hl-number">0</span>
        <span class="hl-keyword">},</span>
        <span class="hl-string">"errorCount"</span>: <span class="hl-number">0</span><span class="hl-keyword">,</span>
        <span class="hl-string">"standardDeviationDuration"</span>: <span class="hl-number">0.0</span><span class="hl-keyword">,</span>
        <span class="hl-string">"countsEnabled"</span>: <span class="hl-keyword">true</span><span class="hl-keyword">,</span>
        <span class="hl-string">"statsEnabled"</span>: <span class="hl-keyword">true</span><span class="hl-keyword">,</span>
        <span class="hl-string">"loggingEnabled"</span>: <span class="hl-keyword">false</span><span class="hl-keyword">,</span>
        <span class="hl-string">"handleCount"</span>: <span class="hl-number">0</span><span class="hl-keyword">,</span>
        <span class="hl-string">"meanDuration"</span>: <span class="hl-number">0.0</span><span class="hl-keyword">,</span>
        <span class="hl-string">"maxDuration"</span>: <span class="hl-number">0.0</span><span class="hl-keyword">,</span>
        <span class="hl-string">"minDuration"</span>: <span class="hl-number">0.0</span><span class="hl-keyword">,</span>
        <span class="hl-string">"activeCount"</span>: <span class="hl-number">0</span>
      <span class="hl-keyword">},</span>
      <span class="hl-string">"componentType"</span>: <span class="hl-string">"logging-channel-adapter"</span><span class="hl-keyword">,</span>
      <span class="hl-string">"output"</span>: null<span class="hl-keyword">,</span>
      <span class="hl-string">"input"</span>: <span class="hl-string">"errorChannel"</span>
    <span class="hl-keyword">}</span>
  ]<span class="hl-keyword">,</span>
  <span class="hl-string">"links"</span>: <span class="hl-keyword">[</span>
    <span class="hl-keyword">{</span>
      <span class="hl-string">"from"</span>: <span class="hl-number">2</span><span class="hl-keyword">,</span>
      <span class="hl-string">"to"</span>: <span class="hl-number">3</span><span class="hl-keyword">,</span>
      <span class="hl-string">"type"</span>: <span class="hl-string">"input"</span>
    <span class="hl-keyword">}</span>
  <span class="hl-keyword">]</span>
<span class="hl-keyword">}</span></pre>
<p>As you can see, the graph consists of three top-level elements.</p>
<p>The <code class="literal">contentDescriptor</code> graph element is pretty straightforward and contains general information about the application providing the data.
The <code class="literal">name</code> can be customized on the <code class="literal">IntegrationGraphServer</code> bean or via <code class="literal">spring.application.name</code> application context environment property.
Other properties are provided by the framework and allows you to distinguish a similar model from other sources.</p>
<p>The <code class="literal">links</code> graph element represents connections between nodes from the <code class="literal">nodes</code> graph element and, therefore, between integration components in the source Spring Integration application.
For example <span class="emphasis"><em>from</em></span> a <code class="literal">MessageChannel</code> <span class="emphasis"><em>to</em></span> an <code class="literal">EventDrivenConsumer</code> with some <code class="literal">MessageHandler</code>;
or <span class="emphasis"><em>from</em></span> an <code class="literal">AbstractReplyProducingMessageHandler</code> <span class="emphasis"><em>to</em></span> a <code class="literal">MessageChannel</code>.
For the convenience and to allow to determine a link purpose, the model is supplied with the <code class="literal">type</code> attribute.
The possible types are:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="emphasis"><em>input</em></span> - identify the direction from <code class="literal">MessageChannel</code> to the endpoint; <code class="literal">inputChannel</code> or <code class="literal">requestChannel</code> property;
</li><li class="listitem">
<span class="emphasis"><em>output</em></span> - the direction from <code class="literal">MessageHandler</code>, <code class="literal">MessageProducer</code> or <code class="literal">SourcePollingChannelAdapter</code> to the <code class="literal">MessageChannel</code> via an <code class="literal">outputChannel</code> or <code class="literal">replyChannel</code> property;
</li><li class="listitem">
<span class="emphasis"><em>error</em></span> - from <code class="literal">MessageHandler</code> on <code class="literal">PollingConsumer</code> or <code class="literal">MessageProducer</code> or <code class="literal">SourcePollingChannelAdapter</code> to the <code class="literal">MessageChannel</code> via an <code class="literal">errorChannel</code> property;
</li><li class="listitem">
<span class="emphasis"><em>discard</em></span> - from <code class="literal">DiscardingMessageHandler</code> (e.g. <code class="literal">MessageFilter</code>) to the <code class="literal">MessageChannel</code> via <code class="literal">errorChannel</code> property.
</li><li class="listitem">
<span class="emphasis"><em>route</em></span> - from <code class="literal">AbstractMappingMessageRouter</code> (e.g. <code class="literal">HeaderValueRouter</code>) to the <code class="literal">MessageChannel</code>.
Similar to <span class="emphasis"><em>output</em></span> but determined at run-time.
May be a configured channel mapping, or a dynamically resolved channel.
Routers will typically only retain up to 100 dynamic routes for this purpose, but this can be modified using the <code class="literal">dynamicChannelLimit</code> property.
</li></ul></div>
<p>The information from this element can be used by a visualizing tool to render connections between nodes from the <code class="literal">nodes</code> graph element, where the <code class="literal">from</code> and <code class="literal">to</code> numbers represent the value from the <code class="literal">nodeId</code> property of the linked nodes.
For example the link <code class="literal">type</code> can be used to determine the proper <span class="emphasis"><em>port</em></span> on the target node:</p>
<pre class="screen">              +---(discard)
              |
         +----o----+
         |         |
         |         |
         |         |
(input)--o         o---(output)
         |         |
         |         |
         |         |
         +----o----+
              |
              +---(error)</pre>
<p>The <code class="literal">nodes</code> graph element is perhaps the most interesting because its elements contain not only the runtime components with their <code class="literal">componentType</code> s and <code class="literal">name</code> s, but can also optionally contain metrics exposed by the component.
Node elements contain various properties which are generally self-explanatory.
For example, expression-based components include the <code class="literal">expression</code> property containing the primary expression string for the component.
To enable the metrics, add an <code class="literal">@EnableIntegrationManagement</code> to some <code class="literal">@Configuration</code> class or add an <code class="literal">&lt;int:management/&gt;</code> element to your XML configuration.
You can control exactly which components in the framework collect statistics.
See  <a class="xref" href="#metrics-management" title="9.1&nbsp;Metrics and Management">Section&nbsp;9.1, &#8220;Metrics and Management&#8221;</a> for complete information.
See the <code class="literal">stats</code> attribute from the <code class="literal">_org.springframework.integration.errorLogger</code> component in the JSON example above.
The <code class="literal">nullChannel</code> and <code class="literal">errorChannel</code> don&#8217;t provide statistics information in this case, because the configuration for this example was:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Configuration</span></em>
<em><span class="hl-annotation" style="color: gray">@EnableIntegration</span></em>
<em><span class="hl-annotation" style="color: gray">@EnableIntegrationManagement(statsEnabled = "_org.springframework.integration.errorLogger.handler",
      countsEnabled = "!*",
      defaultLoggingEnabled = "false")</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ManagementConfiguration {

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> IntegrationGraphServer integrationGraphServer() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> IntegrationGraphServer();
    }

}</pre>
<p>The <code class="literal">nodeId</code> represents a unique incremental identifier to distinguish one component from another.
It is also used in the <code class="literal">links</code> element to represent a relationship (connection) of this component to others, if any.
The <code class="literal">input</code> and <code class="literal">output</code> attributes are for the <code class="literal">inputChannel</code> and <code class="literal">outputChannel</code> properties of the <code class="literal">AbstractEndpoint</code>, <code class="literal">MessageHandler</code>, <code class="literal">SourcePollingChannelAdapter</code> or <code class="literal">MessageProducerSupport</code>.
See the next paragraph for more information.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_graph_runtime_model" href="#_graph_runtime_model"></a>9.8.1&nbsp;Graph Runtime Model</h3></div></div></div>

<p>Spring Integration components have various levels of complexity.
For example, any polled <code class="literal">MessageSource</code> also has a <code class="literal">SourcePollingChannelAdapter</code> and a <code class="literal">MessageChannel</code> to which to send messages from the source data periodically.
Other components might be middleware request-reply components, e.g. <code class="literal">JmsOutboundGateway</code>, with a consuming <code class="literal">AbstractEndpoint</code> to subscribe to (or poll) the <code class="literal">requestChannel</code> (<code class="literal">input</code>) for messages, and a <code class="literal">replyChannel</code> (<code class="literal">output</code>) to produce a reply message to send downstream.
Meanwhile, any <code class="literal">MessageProducerSupport</code> implementation (e.g. <code class="literal">ApplicationEventListeningMessageProducer</code>) simply wraps some source protocol listening logic and sends messages to the <code class="literal">outputChannel</code>.</p>
<p>Within the graph, Spring Integration components are represented using the <code class="literal">IntegrationNode</code> class hierarchy, which you can find in the <code class="literal">o.s.i.support.management.graph</code> package.
For example the <code class="literal">ErrorCapableDiscardingMessageHandlerNode</code> could be used for the <code class="literal">AggregatingMessageHandler</code> (because it has a <code class="literal">discardChannel</code> option) and can produce errors when consuming from a <code class="literal">PollableChannel</code> using a <code class="literal">PollingConsumer</code>.
Another sample is <code class="literal">CompositeMessageHandlerNode</code> - for a <code class="literal">MessageHandlerChain</code> when subscribed to a <code class="literal">SubscribableChannel</code>, using an <code class="literal">EventDrivenConsumer</code>.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The <code class="literal">@MessagingGateway</code> (see <a class="xref" href="#gateway" title="8.4&nbsp;Messaging Gateways">Section&nbsp;8.4, &#8220;Messaging Gateways&#8221;</a>) provides nodes for each its method, where the <code class="literal">name</code> attribute is based on the gateway&#8217;s bean name and the short method signature.
For example the gateway:</p>
</td></tr></table></div>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@MessagingGateway(defaultRequestChannel = "four")</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> Gate {

	<span class="hl-keyword">void</span> foo(String foo);

	<span class="hl-keyword">void</span> foo(Integer foo);

	<span class="hl-keyword">void</span> bar(String bar);

}</pre>
<p>produces nodes like:</p>
<pre class="programlisting"><span class="hl-keyword">{</span>
  <span class="hl-string">"nodeId"</span> : <span class="hl-number">10</span><span class="hl-keyword">,</span>
  <span class="hl-string">"name"</span> : <span class="hl-string">"gate.bar(class java.lang.String)"</span><span class="hl-keyword">,</span>
  <span class="hl-string">"stats"</span> : null<span class="hl-keyword">,</span>
  <span class="hl-string">"componentType"</span> : <span class="hl-string">"gateway"</span><span class="hl-keyword">,</span>
  <span class="hl-string">"output"</span> : <span class="hl-string">"four"</span><span class="hl-keyword">,</span>
  <span class="hl-string">"errors"</span> : null
<span class="hl-keyword">},</span>
<span class="hl-keyword">{</span>
  <span class="hl-string">"nodeId"</span> : <span class="hl-number">11</span><span class="hl-keyword">,</span>
  <span class="hl-string">"name"</span> : <span class="hl-string">"gate.foo(class java.lang.String)"</span><span class="hl-keyword">,</span>
  <span class="hl-string">"stats"</span> : null<span class="hl-keyword">,</span>
  <span class="hl-string">"componentType"</span> : <span class="hl-string">"gateway"</span><span class="hl-keyword">,</span>
  <span class="hl-string">"output"</span> : <span class="hl-string">"four"</span><span class="hl-keyword">,</span>
  <span class="hl-string">"errors"</span> : null
<span class="hl-keyword">},</span>
<span class="hl-keyword">{</span>
  <span class="hl-string">"nodeId"</span> : <span class="hl-number">12</span><span class="hl-keyword">,</span>
  <span class="hl-string">"name"</span> : <span class="hl-string">"gate.foo(class java.lang.Integer)"</span><span class="hl-keyword">,</span>
  <span class="hl-string">"stats"</span> : null<span class="hl-keyword">,</span>
  <span class="hl-string">"componentType"</span> : <span class="hl-string">"gateway"</span><span class="hl-keyword">,</span>
  <span class="hl-string">"output"</span> : <span class="hl-string">"four"</span><span class="hl-keyword">,</span>
  <span class="hl-string">"errors"</span> : null
<span class="hl-keyword">}</span></pre>
<p>This  <code class="literal">IntegrationNode</code> hierarchy can be used for parsing the graph model on the client side, as well as for the understanding the general Spring Integration runtime behavior.
See also <a class="xref" href="#programming-tips" title="3.8&nbsp;Programming Tips and Tricks">Section&nbsp;3.8, &#8220;Programming Tips and Tricks&#8221;</a> for more information.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_integration_graph_controller" href="#_integration_graph_controller"></a>9.9&nbsp;Integration Graph Controller</h2></div></div></div>

<p>If your application is WEB-based (or built on top of Spring Boot using an embedded web container) and the Spring Integration HTTP module (see <a class="xref" href="#http" title="17.&nbsp;HTTP Support">Chapter&nbsp;17, <i>HTTP Support</i></a>) is present on the classpath, you can use a <code class="literal">IntegrationGraphController</code> to expose the <code class="literal">IntegrationGraphServer</code> functionality as a REST service.
For this purpose, the <code class="literal">@EnableIntegrationGraphController</code> <code class="literal">@Configuration</code> class annotation and the <code class="literal">&lt;int-http:graph-controller/&gt;</code> XML element, are available in the HTTP module.
Together with the <code class="literal">@EnableWebMvc</code> annotation (or <code class="literal">&lt;mvc:annotation-driven/&gt;</code> for xml definitions), this configuration registers an <code class="literal">IntegrationGraphController</code> <code class="literal">@RestController</code> where its <code class="literal">@RequestMapping.path</code> can be configured on the <code class="literal">@EnableIntegrationGraphController</code> annotation or <code class="literal">&lt;int-http:graph-controller/&gt;</code> element.
The default path is <code class="literal">/integration</code>.</p>
<p>The <code class="literal">IntegrationGraphController</code> <code class="literal">@RestController</code> provides these services:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">@GetMapping(name = "getGraph")</code> - to retrieve the state of the Spring Integration components since the last <code class="literal">IntegrationGraphServer</code> refresh.
The <code class="literal">o.s.i.support.management.graph.Graph</code> is returned as a <code class="literal">@ResponseBody</code> of the REST service;
</li><li class="listitem">
<code class="literal">@GetMapping(path = "/refresh", name = "refreshGraph")</code> - to refresh the current <code class="literal">Graph</code> for the actual runtime state and return it as a REST response.
It is not necessary to refresh the graph for metrics, they are provided in real-time when the graph is retrieved.
Refresh can be called if the application context has been modified since the graph was last retrieved and the graph is completely rebuilt.
</li></ul></div>
<p>Any Security and Cross Origin restrictions for the <code class="literal">IntegrationGraphController</code> can be achieved with the standard configuration options and components provided by Spring Security and Spring MVC projects.
A simple example of that follows:</p>
<pre class="programlisting"><span class="hl-tag">&lt;mvc:annotation-driven /&gt;</span>

<span class="hl-tag">&lt;mvc:cors&gt;</span>
	<span class="hl-tag">&lt;mvc:mapping</span> <span class="hl-attribute">path</span>=<span class="hl-value">"/myIntegration/**"</span>
				 <span class="hl-attribute">allowed-origins</span>=<span class="hl-value">"http://localhost:9090"</span>
				 <span class="hl-attribute">allowed-methods</span>=<span class="hl-value">"GET"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/mvc:cors&gt;</span>

<span class="hl-tag">&lt;security:http&gt;</span>
    <span class="hl-tag">&lt;security:intercept-url</span> <span class="hl-attribute">pattern</span>=<span class="hl-value">"/myIntegration/**"</span> <span class="hl-attribute">access</span>=<span class="hl-value">"ROLE_ADMIN"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/security:http&gt;</span>


<span class="hl-tag">&lt;int-http:graph-controller</span> <span class="hl-attribute">path</span>=<span class="hl-value">"/myIntegration"</span><span class="hl-tag"> /&gt;</span></pre>
<p>The Java &amp; Annotation Configuration variant follows; note that, for convenience, the annotation provides an <code class="literal">allowedOrigins</code> attribute; this just provides <code class="literal">GET</code> access to the <code class="literal">path</code>.
For more sophistication, you can configure the CORS mappings using standard Spring MVC mechanisms.</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Configuration</span></em>
<em><span class="hl-annotation" style="color: gray">@EnableWebMvc</span></em>
<em><span class="hl-annotation" style="color: gray">@EnableWebSecurity</span></em>
<em><span class="hl-annotation" style="color: gray">@EnableIntegration</span></em>
<em><span class="hl-annotation" style="color: gray">@EnableIntegrationGraphController(path = "/testIntegration", allowedOrigins="http://localhost:9090")</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> IntegrationConfiguration <span class="hl-keyword">extends</span> WebSecurityConfigurerAdapter {

    <em><span class="hl-annotation" style="color: gray">@Override</span></em>
    <span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> configure(HttpSecurity http) <span class="hl-keyword">throws</span> Exception {
	    http
            .authorizeRequests()
               .antMatchers(<span class="hl-string">"/testIntegration/**"</span>).hasRole(<span class="hl-string">"ADMIN"</span>)
            <span class="hl-comment">// ...</span>
            .formLogin();
    }

    <span class="hl-comment">//...</span>

}</pre>
</div>
</div>
</div>
<div class="part"><div class="titlepage"><div><div><h1 class="title"><a name="spring-integration-endpoints" href="#spring-integration-endpoints"></a>Part&nbsp;V.&nbsp;Integration Endpoints</h1></div></div></div>

<div class="partintro"><div></div>
<p>This section covers the various Channel Adapters and Messaging Gateways provided by Spring Integration to support Message-based communication with external systems.</p>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="endpoint-summary" href="#endpoint-summary"></a>10.&nbsp;Endpoint Quick Reference Table</h2></div></div></div>

<p>As discussed in the sections above, Spring Integration provides a number of endpoints used to interface with external systems, file systems etc.
The following is a summary of the various endpoints with quick links to the appropriate chapter.</p>
<p>To recap, <span class="strong"><strong>Inbound Channel Adapters</strong></span> are used for one-way integration bringing data into the messaging application.
<span class="strong"><strong>Outbound Channel Adapters</strong></span> are used for one-way integration to send data out of the messaging application.
<span class="strong"><strong>Inbound Gateways</strong></span> are used for a bidirectional integration flow where some other system invokes the messaging application and receives a reply.<span class="strong"><strong>Outbound Gateways</strong></span> are used for a bidirectional integration flow where the messaging application invokes some external service or entity, expecting a result.</p>
<div class="table"><a name="d5e8509" href="#d5e8509"></a><p class="title"><b>Table&nbsp;10.1.&nbsp;Endpoint Quick Reference</b></p><div class="table-contents">

<table summary="Endpoint Quick Reference" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"><col class="col_4"><col class="col_5"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Module</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Inbound Adapter</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Outbound Adapter</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Inbound Gateway</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Outbound Gateway</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><span class="strong"><strong>AMQP</strong></span></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#amqp-inbound-channel-adapter" title="11.2&nbsp;Inbound Channel Adapter">Section&nbsp;11.2, &#8220;Inbound Channel Adapter&#8221;</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#amqp-outbound-channel-adapter" title="11.5&nbsp;Outbound Channel Adapter">Section&nbsp;11.5, &#8220;Outbound Channel Adapter&#8221;</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#amqp-inbound-gateway" title="11.3&nbsp;Inbound Gateway">Section&nbsp;11.3, &#8220;Inbound Gateway&#8221;</a></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#amqp-outbound-gateway" title="11.6&nbsp;Outbound Gateway">Section&nbsp;11.6, &#8220;Outbound Gateway&#8221;</a></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><span class="strong"><strong>Events</strong></span></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#appevent-inbound" title="12.1&nbsp;Receiving Spring Application Events">Section&nbsp;12.1, &#8220;Receiving Spring Application Events&#8221;</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#appevent-outbound" title="12.2&nbsp;Sending Spring Application Events">Section&nbsp;12.2, &#8220;Sending Spring Application Events&#8221;</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>N</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>N</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><span class="strong"><strong>Feed</strong></span></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#feed-inbound-channel-adapter" title="13.2&nbsp;Feed Inbound Channel Adapter">Section&nbsp;13.2, &#8220;Feed Inbound Channel Adapter&#8221;</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>N</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>N</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>N</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><span class="strong"><strong>File</strong></span></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#file-reading" title="14.2&nbsp;Reading Files">Section&nbsp;14.2, &#8220;Reading Files&#8221;</a> and <a class="xref" href="#file-tailing" title="14.2.6&nbsp;'Tail&#8217;ing Files">Section&nbsp;14.2.6, &#8220;'Tail&#8217;ing Files&#8221;</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#file-writing" title="14.3&nbsp;Writing files">Section&nbsp;14.3, &#8220;Writing files&#8221;</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>N</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#file-writing" title="14.3&nbsp;Writing files">Section&nbsp;14.3, &#8220;Writing files&#8221;</a></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><span class="strong"><strong>FTP(S)</strong></span></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#ftp-inbound" title="15.4&nbsp;FTP Inbound Channel Adapter">Section&nbsp;15.4, &#8220;FTP Inbound Channel Adapter&#8221;</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#ftp-outbound" title="15.6&nbsp;FTP Outbound Channel Adapter">Section&nbsp;15.6, &#8220;FTP Outbound Channel Adapter&#8221;</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>N</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#ftp-outbound-gateway" title="15.7&nbsp;FTP Outbound Gateway">Section&nbsp;15.7, &#8220;FTP Outbound Gateway&#8221;</a></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><span class="strong"><strong>Gemfire</strong></span></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#gemfire-inbound" title="16.2&nbsp;Inbound Channel Adapter">Section&nbsp;16.2, &#8220;Inbound Channel Adapter&#8221;</a> and <a class="xref" href="#gemfire-cq" title="16.3&nbsp;Continuous Query Inbound Channel Adapter">Section&nbsp;16.3, &#8220;Continuous Query Inbound Channel Adapter&#8221;</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#gemfire-outbound" title="16.4&nbsp;Outbound Channel Adapter">Section&nbsp;16.4, &#8220;Outbound Channel Adapter&#8221;</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>N</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>N</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><span class="strong"><strong>HTTP</strong></span></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#http-namespace" title="17.4&nbsp;HTTP Namespace Support">Section&nbsp;17.4, &#8220;HTTP Namespace Support&#8221;</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#http-namespace" title="17.4&nbsp;HTTP Namespace Support">Section&nbsp;17.4, &#8220;HTTP Namespace Support&#8221;</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#http-inbound" title="17.2&nbsp;Http Inbound Components">Section&nbsp;17.2, &#8220;Http Inbound Components&#8221;</a></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#http-outbound" title="17.3&nbsp;Http Outbound Components">Section&nbsp;17.3, &#8220;Http Outbound Components&#8221;</a></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><span class="strong"><strong>JDBC</strong></span></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#jdbc-inbound-channel-adapter" title="18.1&nbsp;Inbound Channel Adapter">Section&nbsp;18.1, &#8220;Inbound Channel Adapter&#8221;</a> and <a class="xref" href="#stored-procedure-inbound-channel-adapter" title="18.5.6&nbsp;Stored Procedure Inbound Channel Adapter">Section&nbsp;18.5.6, &#8220;Stored Procedure Inbound Channel Adapter&#8221;</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#jdbc-outbound-channel-adapter" title="18.2&nbsp;Outbound Channel Adapter">Section&nbsp;18.2, &#8220;Outbound Channel Adapter&#8221;</a> and <a class="xref" href="#stored-procedure-outbound-channel-adapter" title="18.5.7&nbsp;Stored Procedure Outbound Channel Adapter">Section&nbsp;18.5.7, &#8220;Stored Procedure Outbound Channel Adapter&#8221;</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>N</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#jdbc-outbound-gateway" title="18.3&nbsp;Outbound Gateway">Section&nbsp;18.3, &#8220;Outbound Gateway&#8221;</a> and <a class="xref" href="#stored-procedure-outbound-gateway" title="18.5.8&nbsp;Stored Procedure Outbound Gateway">Section&nbsp;18.5.8, &#8220;Stored Procedure Outbound Gateway&#8221;</a></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><span class="strong"><strong>JMS</strong></span></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#jms-inbound-channel-adapter" title="20.1&nbsp;Inbound Channel Adapter">Section&nbsp;20.1, &#8220;Inbound Channel Adapter&#8221;</a> and <a class="xref" href="#jms-message-driven-channel-adapter" title="20.2&nbsp;Message-Driven Channel Adapter">Section&nbsp;20.2, &#8220;Message-Driven Channel Adapter&#8221;</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#jms-outbound-channel-adapter" title="20.3&nbsp;Outbound Channel Adapter">Section&nbsp;20.3, &#8220;Outbound Channel Adapter&#8221;</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#jms-inbound-gateway" title="20.4&nbsp;Inbound Gateway">Section&nbsp;20.4, &#8220;Inbound Gateway&#8221;</a></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#jms-outbound-gateway" title="20.5&nbsp;Outbound Gateway">Section&nbsp;20.5, &#8220;Outbound Gateway&#8221;</a></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><span class="strong"><strong>JMX</strong></span></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#jmx-notification-listening-channel-adapter" title="9.2.1&nbsp;Notification Listening Channel Adapter">Section&nbsp;9.2.1, &#8220;Notification Listening Channel Adapter&#8221;</a> and <a class="xref" href="#jmx-attribute-polling-channel-adapter" title="9.2.3&nbsp;Attribute Polling Channel Adapter">Section&nbsp;9.2.3, &#8220;Attribute Polling Channel Adapter&#8221;</a> and <a class="xref" href="#tree-polling-channel-adapter" title="9.2.4&nbsp;Tree Polling Channel Adapter">Section&nbsp;9.2.4, &#8220;Tree Polling Channel Adapter&#8221;</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#jmx-notification-publishing-channel-adapter" title="9.2.2&nbsp;Notification Publishing Channel Adapter">Section&nbsp;9.2.2, &#8220;Notification Publishing Channel Adapter&#8221;</a> and <a class="xref" href="#jmx-operation-invoking-channel-adapter" title="9.2.5&nbsp;Operation Invoking Channel Adapter">Section&nbsp;9.2.5, &#8220;Operation Invoking Channel Adapter&#8221;</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>N</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#jmx-operation-invoking-outbound-gateway" title="9.2.6&nbsp;Operation Invoking Outbound Gateway">Section&nbsp;9.2.6, &#8220;Operation Invoking Outbound Gateway&#8221;</a></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><span class="strong"><strong>JPA</strong></span></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#jpa-inbound-channel-adapter" title="19.4&nbsp;Inbound Channel Adapter">Section&nbsp;19.4, &#8220;Inbound Channel Adapter&#8221;</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#jpa-outbound-channel-adapter" title="19.5&nbsp;Outbound Channel Adapter">Section&nbsp;19.5, &#8220;Outbound Channel Adapter&#8221;</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>N</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#jpa-updating-outbound-gateway" title="19.6.2&nbsp;Updating Outbound Gateway">Section&nbsp;19.6.2, &#8220;Updating Outbound Gateway&#8221;</a> and <a class="xref" href="#jpa-retrieving-outbound-gateway" title="19.6.3&nbsp;Retrieving Outbound Gateway">Section&nbsp;19.6.3, &#8220;Retrieving Outbound Gateway&#8221;</a></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><span class="strong"><strong>Mail</strong></span></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#mail-inbound" title="21.2&nbsp;Mail-Receiving Channel Adapter">Section&nbsp;21.2, &#8220;Mail-Receiving Channel Adapter&#8221;</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#mail-outbound" title="21.1&nbsp;Mail-Sending Channel Adapter">Section&nbsp;21.1, &#8220;Mail-Sending Channel Adapter&#8221;</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>N</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>N</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><span class="strong"><strong>MongoDB</strong></span></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#mongodb-inbound-channel-adapter" title="22.4&nbsp;MongoDB Inbound Channel Adapter">Section&nbsp;22.4, &#8220;MongoDB Inbound Channel Adapter&#8221;</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#mongodb-outbound-channel-adapter" title="22.5&nbsp;MongoDB Outbound Channel Adapter">Section&nbsp;22.5, &#8220;MongoDB Outbound Channel Adapter&#8221;</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>N</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>N</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><span class="strong"><strong>MQTT</strong></span></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#mqtt-inbound" title="23.2&nbsp;Inbound (message-driven) Channel Adapter">Section&nbsp;23.2, &#8220;Inbound (message-driven) Channel Adapter&#8221;</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#mqtt-outbound" title="23.3&nbsp;Outbound Channel Adapter">Section&nbsp;23.3, &#8220;Outbound Channel Adapter&#8221;</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>N</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>N</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><span class="strong"><strong>Redis</strong></span></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#redis-inbound-channel-adapter" title="24.3.2&nbsp;Redis Inbound Channel Adapter">Section&nbsp;24.3.2, &#8220;Redis Inbound Channel Adapter&#8221;</a> and <a class="xref" href="#redis-queue-inbound-channel-adapter" title="24.3.4&nbsp;Redis Queue Inbound Channel Adapter">Section&nbsp;24.3.4, &#8220;Redis Queue Inbound Channel Adapter&#8221;</a> and <a class="xref" href="#redis-store-inbound-channel-adapter" title="24.6&nbsp;RedisStore Inbound Channel Adapter">Section&nbsp;24.6, &#8220;RedisStore Inbound Channel Adapter&#8221;</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#redis-outbound-channel-adapter" title="24.3.3&nbsp;Redis Outbound Channel Adapter">Section&nbsp;24.3.3, &#8220;Redis Outbound Channel Adapter&#8221;</a> and <a class="xref" href="#redis-queue-outbound-channel-adapter" title="24.3.5&nbsp;Redis Queue Outbound Channel Adapter">Section&nbsp;24.3.5, &#8220;Redis Queue Outbound Channel Adapter&#8221;</a> and <a class="xref" href="#redis-store-outbound-channel-adapter" title="24.7&nbsp;RedisStore Outbound Channel Adapter">Section&nbsp;24.7, &#8220;RedisStore Outbound Channel Adapter&#8221;</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#redis-queue-inbound-gateway" title="24.10&nbsp;Redis Queue Inbound Gateway">Section&nbsp;24.10, &#8220;Redis Queue Inbound Gateway&#8221;</a></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#redis-outbound-gateway" title="24.8&nbsp;Redis Outbound Command Gateway">Section&nbsp;24.8, &#8220;Redis Outbound Command Gateway&#8221;</a> and <a class="xref" href="#redis-queue-outbound-gateway" title="24.9&nbsp;Redis Queue Outbound Gateway">Section&nbsp;24.9, &#8220;Redis Queue Outbound Gateway&#8221;</a></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><span class="strong"><strong>Resource</strong></span></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#resource-inbound-channel-adapter" title="25.2&nbsp;Resource Inbound Channel Adapter">Section&nbsp;25.2, &#8220;Resource Inbound Channel Adapter&#8221;</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>N</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>N</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>N</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><span class="strong"><strong>RMI</strong></span></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>N</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>N</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#rmi-inbound" title="26.3&nbsp;Inbound RMI">Section&nbsp;26.3, &#8220;Inbound RMI&#8221;</a></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#rmi-outbound" title="26.2&nbsp;Outbound RMI">Section&nbsp;26.2, &#8220;Outbound RMI&#8221;</a></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><span class="strong"><strong>SFTP</strong></span></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#sftp-inbound" title="27.7&nbsp;SFTP Inbound Channel Adapter">Section&nbsp;27.7, &#8220;SFTP Inbound Channel Adapter&#8221;</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#sftp-outbound" title="27.9&nbsp;SFTP Outbound Channel Adapter">Section&nbsp;27.9, &#8220;SFTP Outbound Channel Adapter&#8221;</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>N</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#sftp-outbound-gateway" title="27.10&nbsp;SFTP Outbound Gateway">Section&nbsp;27.10, &#8220;SFTP Outbound Gateway&#8221;</a></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><span class="strong"><strong>Stream</strong></span></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#stream-reading" title="29.2&nbsp;Reading from streams">Section&nbsp;29.2, &#8220;Reading from streams&#8221;</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#stream-writing" title="29.3&nbsp;Writing to streams">Section&nbsp;29.3, &#8220;Writing to streams&#8221;</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>N</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>N</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><span class="strong"><strong>Syslog</strong></span></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#syslog-inbound-adapter" title="30.2&nbsp;Syslog <inbound-channel-adapter&gt;">Section&nbsp;30.2, &#8220;Syslog &lt;inbound-channel-adapter&gt;&#8221;</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>N</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>N</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>N</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><span class="strong"><strong>TCP</strong></span></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#tcp-adapters" title="31.6&nbsp;TCP Adapters">Section&nbsp;31.6, &#8220;TCP Adapters&#8221;</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#tcp-adapters" title="31.6&nbsp;TCP Adapters">Section&nbsp;31.6, &#8220;TCP Adapters&#8221;</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#tcp-gateways" title="31.7&nbsp;TCP Gateways">Section&nbsp;31.7, &#8220;TCP Gateways&#8221;</a></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#tcp-gateways" title="31.7&nbsp;TCP Gateways">Section&nbsp;31.7, &#8220;TCP Gateways&#8221;</a></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><span class="strong"><strong>Twitter</strong></span></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#twitter-inbound" title="32.4&nbsp;Twitter Inbound Adapters">Section&nbsp;32.4, &#8220;Twitter Inbound Adapters&#8221;</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#twitter-outbound" title="32.5&nbsp;Twitter Outbound Adapter">Section&nbsp;32.5, &#8220;Twitter Outbound Adapter&#8221;</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>N</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#twitter-sog" title="32.6&nbsp;Twitter Search Outbound Gateway">Section&nbsp;32.6, &#8220;Twitter Search Outbound Gateway&#8221;</a></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><span class="strong"><strong>UDP</strong></span></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#udp-adapters" title="31.2&nbsp;UDP Adapters">Section&nbsp;31.2, &#8220;UDP Adapters&#8221;</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#udp-adapters" title="31.2&nbsp;UDP Adapters">Section&nbsp;31.2, &#8220;UDP Adapters&#8221;</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>N</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>N</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><span class="strong"><strong>Web Services</strong></span></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>N</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>N</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#webservices-inbound" title="34.2&nbsp;Inbound Web Service Gateways">Section&nbsp;34.2, &#8220;Inbound Web Service Gateways&#8221;</a></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#webservices-outbound" title="34.1&nbsp;Outbound Web Service Gateways">Section&nbsp;34.1, &#8220;Outbound Web Service Gateways&#8221;</a></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><span class="strong"><strong>Web Sockets</strong></span></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#web-socket-inbound-adapter" title="33.3&nbsp;WebSocket Inbound Channel Adapter">Section&nbsp;33.3, &#8220;WebSocket Inbound Channel Adapter&#8221;</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#web-socket-outbound-adapter" title="33.4&nbsp;WebSocket Outbound Channel Adapter">Section&nbsp;33.4, &#8220;WebSocket Outbound Channel Adapter&#8221;</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>N</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>N</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p><span class="strong"><strong>XMPP</strong></span></p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#xmpp-messages" title="36.3&nbsp;XMPP Messages">Section&nbsp;36.3, &#8220;XMPP Messages&#8221;</a> and <a class="xref" href="#xmpp-presence" title="36.4&nbsp;XMPP Presence">Section&nbsp;36.4, &#8220;XMPP Presence&#8221;</a></p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#xmpp-messages" title="36.3&nbsp;XMPP Messages">Section&nbsp;36.3, &#8220;XMPP Messages&#8221;</a> and <a class="xref" href="#xmpp-presence" title="36.4&nbsp;XMPP Presence">Section&nbsp;36.4, &#8220;XMPP Presence&#8221;</a></p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>N</p></td><td style="" align="left" valign="top"><p>N</p></td></tr></tbody></table>
</div></div><br class="table-break">
<p>In addition, as discussed in <a class="xref" href="#spring-integration-core-messaging" title="Part&nbsp;IV.&nbsp;Core Messaging">Part&nbsp;IV, &#8220;Core Messaging&#8221;</a>, endpoints are provided for interfacing with Plain Old Java Objects (POJOs).
As discussed in <a class="xref" href="#channel-adapter" title="4.3&nbsp;Channel Adapter">Section&nbsp;4.3, &#8220;Channel Adapter&#8221;</a>, the <code class="literal">&lt;int:inbound-channel-adapter&gt;</code> allows polling a java method for data; the <code class="literal">&lt;int:outbound-channel-adapter&gt;</code> allows sending data to a <code class="literal">void</code> method, and as discussed in <a class="xref" href="#gateway" title="8.4&nbsp;Messaging Gateways">Section&nbsp;8.4, &#8220;Messaging Gateways&#8221;</a>, the <code class="literal">&lt;int:gateway&gt;</code> allows any Java program to invoke a messaging flow.
Each of these without requiring any source level dependencies on Spring Integration.
The equivalent of an outbound gateway in this context would be to use a <a class="xref" href="#service-activator" title="8.5&nbsp;Service Activator">Section&nbsp;8.5, &#8220;Service Activator&#8221;</a> to invoke a method that returns an Object of some kind.</p>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="amqp" href="#amqp"></a>11.&nbsp;AMQP Support</h2></div></div></div>

<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="amqp-introduction" href="#amqp-introduction"></a>11.1&nbsp;Introduction</h2></div></div></div>

<p>Spring Integration provides Channel Adapters for receiving and sending messages using the Advanced Message Queuing Protocol (AMQP).
The following adapters are available:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="#amqp-inbound-channel-adapter" title="11.2&nbsp;Inbound Channel Adapter">Inbound Channel Adapter</a>
</li><li class="listitem">
<a class="link" href="#amqp-inbound-gateway" title="11.3&nbsp;Inbound Gateway">Inbound Gateway</a>
</li><li class="listitem">
<a class="link" href="#amqp-outbound-channel-adapter" title="11.5&nbsp;Outbound Channel Adapter">Outbound Channel Adapter</a>
</li><li class="listitem">
<a class="link" href="#amqp-outbound-gateway" title="11.6&nbsp;Outbound Gateway">Outbound Gateway</a>
</li><li class="listitem">
<a class="link" href="#amqp-async-outbound-gateway" title="11.7&nbsp;Async Outbound Gateway">Async Outbound Gateway</a>
</li></ul></div>
<p>Spring Integration also provides a point-to-point Message Channel as well as a publish/subscribe Message Channel backed by AMQP Exchanges and Queues.</p>
<p>In order to provide AMQP support, Spring Integration relies on (<a class="ulink" href="http://projects.spring.io/spring-amqp" target="_top">Spring AMQP</a>)
which "applies core Spring concepts to the development of AMQP-based messaging solutions".
Spring AMQP provides similar semantics to (<a class="ulink" href="http://docs.spring.io/spring/docs/current/spring-framework-reference/html/jms.html" target="_top">Spring JMS</a>).</p>
<p>Whereas the provided AMQP Channel Adapters are intended for unidirectional Messaging (send or receive) only, Spring Integration also provides inbound and outbound AMQP Gateways for request/reply operations.</p>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>Please familiarize yourself with the
<a class="ulink" href="http://docs.spring.io/spring-amqp/reference/html/" target="_top">reference documentation of the Spring AMQP project as well</a>.
It provides much more in-depth information regarding Spring&#8217;s integration with AMQP in general and RabbitMQ in particular.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="amqp-inbound-channel-adapter" href="#amqp-inbound-channel-adapter"></a>11.2&nbsp;Inbound Channel Adapter</h2></div></div></div>

<p>A configuration sample for an AMQP Inbound Channel Adapter is shown below.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-amqp:inbound-channel-adapter</span>
                                  <span class="hl-attribute">id</span>=<span class="hl-value">"inboundAmqp"</span> <a name="CO17-1" href="#CO17-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
                                  channel="inboundChannel" <a name="CO17-2" href="#CO17-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
                                  queue-names="si.test.queue" <a name="CO17-3" href="#CO17-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
                                  acknowledge-mode="AUTO" <a name="CO17-4" href="#CO17-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
                                  advice-chain="" <a name="CO17-5" href="#CO17-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
                                  channel-transacted="" <a name="CO17-6" href="#CO17-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>
                                  concurrent-consumers="" <a name="CO17-7" href="#CO17-7"></a><span><img src="images/callouts/7.png" alt="7" border="0"></span>
                                  connection-factory="" <a name="CO17-8" href="#CO17-8"></a><span><img src="images/callouts/8.png" alt="8" border="0"></span>
                                  error-channel="" <a name="CO17-9" href="#CO17-9"></a><span><img src="images/callouts/9.png" alt="9" border="0"></span>
                                  expose-listener-channel="" <a name="CO17-10" href="#CO17-10"></a><span><img src="images/callouts/10.png" alt="10" border="0"></span>
                                  header-mapper="" <a name="CO17-11" href="#CO17-11"></a><span><img src="images/callouts/11.png" alt="11" border="0"></span>
                                  mapped-request-headers="" <a name="CO17-12" href="#CO17-12"></a><span><img src="images/callouts/12.png" alt="12" border="0"></span>
                                  listener-container="" <a name="CO17-13" href="#CO17-13"></a><span><img src="images/callouts/13.png" alt="13" border="0"></span>
                                  message-converter="" <a name="CO17-14" href="#CO17-14"></a><span><img src="images/callouts/14.png" alt="14" border="0"></span>
                                  message-properties-converter="" <a name="CO17-15" href="#CO17-15"></a><span><img src="images/callouts/15.png" alt="15" border="0"></span>
                                  phase="" <a name="CO17-16" href="#CO17-16"></a>(16)
                                  prefetch-count="" <a name="CO17-17" href="#CO17-17"></a>(17)
                                  receive-timeout="" <a name="CO17-18" href="#CO17-18"></a>(18)
                                  recovery-interval="" <a name="CO17-19" href="#CO17-19"></a>(19)
                                  missing-queues-fatal="" <a name="CO17-20" href="#CO17-20"></a>(20)
                                  shutdown-timeout="" <a name="CO17-21" href="#CO17-21"></a>(21)
                                  task-executor="" <a name="CO17-22" href="#CO17-22"></a>(22)
                                  transaction-attribute="" <a name="CO17-23" href="#CO17-23"></a>(23)
                                  transaction-manager="" <a name="CO17-24" href="#CO17-24"></a>(24)
                                  tx-size="" /&gt; <a name="CO17-25" href="#CO17-25"></a>(25)</pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO17-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Unique ID for this adapter.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO17-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Message Channel to which converted Messages should be sent.
<span class="emphasis"><em>Required</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO17-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Names of the AMQP Queues from which Messages should be consumed (comma-separated list).<span class="emphasis"><em>Required</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO17-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Acknowledge Mode for the <code class="literal">MessageListenerContainer</code>.
When set to MANUAL, the delivery tag and channel are provided in message headers <code class="literal">amqp_deliveryTag</code> and <code class="literal">amqp_channel</code> respectively; the user application is responsible for acknowledgement.
NONE means no acknowledgements (autoAck); AUTO means the adapter&#8217;s container will acknowledge when the downstream flow completes.<span class="emphasis"><em>Optional (Defaults to AUTO)</em></span> see <a class="xref" href="#amqp-inbound-ack" title="11.4&nbsp;Inbound Endpoint Acknowledge Mode">Section&nbsp;11.4, &#8220;Inbound Endpoint Acknowledge Mode&#8221;</a>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO17-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Extra AOP Advice(s) to handle cross cutting behavior associated with this Inbound Channel Adapter.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO17-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Flag to indicate that channels created by this component will be transactional.
If true, tells the framework to use a transactional channel and to end all operations (send or receive) with a commit or rollback depending on the outcome, with an exception signalling a rollback.
<span class="emphasis"><em>Optional (Defaults to false)</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO17-7"><span><img src="images/callouts/7.png" alt="7" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Specify the number of concurrent consumers to create.
Default is 1.
Raising the number of concurrent consumers is recommended in order to scale the consumption of messages coming in from a queue.
However, note that any ordering guarantees are lost once multiple consumers are registered.
In general, stick with 1 consumer for low-volume queues.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO17-8"><span><img src="images/callouts/8.png" alt="8" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Bean reference to the RabbitMQ ConnectionFactory.
<span class="emphasis"><em>Optional (Defaults to <span class="emphasis"><em>connectionFactory</em></span>)</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO17-9"><span><img src="images/callouts/9.png" alt="9" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Message Channel to which error Messages should be sent.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO17-10"><span><img src="images/callouts/10.png" alt="10" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Shall the listener channel (com.rabbitmq.client.Channel) be exposed to a registered <code class="literal">ChannelAwareMessageListener</code>.
<span class="emphasis"><em>Optional (Defaults to true)</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO17-11"><span><img src="images/callouts/11.png" alt="11" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A reference to an <code class="literal">AmqpHeaderMapper</code> to use when receiving AMQP Messages.
<span class="emphasis"><em>Optional</em></span>.
By default only standard AMQP properties (e.g.
<code class="literal">contentType</code>) will be copied to Spring Integration <code class="literal">MessageHeaders</code>.
Any user-defined headers within the AMQP <code class="literal">MessageProperties</code> will NOT be copied to the Message by the default <code class="literal">DefaultAmqpHeaderMapper</code>.
Not allowed if <span class="emphasis"><em>request-header-names</em></span> is provided.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO17-12"><span><img src="images/callouts/12.png" alt="12" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Comma-separated list of names of AMQP Headers to be mapped from the AMQP request into the MessageHeaders.
This can only be provided if the <span class="emphasis"><em>header-mapper</em></span> reference is not provided.
The values in this list can also be simple patterns to be matched against the header names (e.g.
"*" or "foo*, bar" or "*foo").</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO17-13"><span><img src="images/callouts/13.png" alt="13" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Reference to the <code class="literal">SimpleMessageListenerContainer</code> to use for receiving AMQP Messages.
If this attribute is provided, then no other attribute related to the listener container configuration should be provided.
In other words, by setting this reference, you must take full responsibility of the listener container configuration.
The only exception is the MessageListener itself.
Since that is actually the core responsibility of this Channel Adapter implementation, the referenced listener container must NOT already have its own MessageListener configured.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO17-14"><span><img src="images/callouts/14.png" alt="14" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The MessageConverter to use when receiving AMQP Messages.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO17-15"><span><img src="images/callouts/15.png" alt="15" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The MessagePropertiesConverter to use when receiving AMQP Messages.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO17-16">(16)</a> </p></td><td valign="top" align="left">
<p>Specify the phase in which the underlying <code class="literal">SimpleMessageListenerContainer</code> should be started and stopped.
The startup order proceeds from lowest to highest, and the shutdown order is the reverse of that.
By default this value is Integer.MAX_VALUE meaning that this container starts as late as possible and stops as soon as possible.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO17-17">(17)</a> </p></td><td valign="top" align="left">
<p>Tells the AMQP broker how many messages to send to each consumer in a single request.
Often this can be set quite high to improve throughput.
It should be greater than or equal to the transaction size (see attribute "tx-size").
<span class="emphasis"><em>Optional (Defaults to 1)</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO17-18">(18)</a> </p></td><td valign="top" align="left">
<p>Receive timeout in milliseconds.
<span class="emphasis"><em>Optional (Defaults to 1000)</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO17-19">(19)</a> </p></td><td valign="top" align="left">
<p>Specifies the interval between recovery attempts of the underlying <code class="literal">SimpleMessageListenerContainer</code> (in milliseconds)
.<span class="emphasis"><em>Optional (Defaults to 5000)</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO17-20">(20)</a> </p></td><td valign="top" align="left">
<p>If <span class="emphasis"><em>true</em></span>, and none of the queues are available on the broker, the container will throw a fatal exception during startup and will stop if the queues are deleted when the container is running (after making 3 attempts to passively declare the queues).
If false, the container will not throw an exception and go into recovery mode, attempting to restart according to the <code class="literal">recovery-interval</code>.
<span class="emphasis"><em>Optional (Defaults to <code class="literal">true</code>)</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO17-21">(21)</a> </p></td><td valign="top" align="left">
<p>The time to wait for workers in milliseconds after the underlying <code class="literal">SimpleMessageListenerContainer</code> is stopped, and before the AMQP connection is forced closed.
If any workers are active when the shutdown signal comes they will be allowed to finish processing as long as they can finish within this timeout.
Otherwise the connection is closed and messages remain unacked (if the channel is transactional).
<span class="emphasis"><em>Optional (Defaults to 5000)</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO17-22">(22)</a> </p></td><td valign="top" align="left">
<p>By default, the underlying <code class="literal">SimpleMessageListenerContainer</code> uses a SimpleAsyncTaskExecutor implementation, that fires up a new Thread for each task, executing it asynchronously.
By default, the number of concurrent threads is unlimited.
<span class="strong"><strong>NOTE:</strong></span> This implementation does not reuse threads.
Consider a thread-pooling TaskExecutor implementation as an alternative.
<span class="emphasis"><em>Optional (Defaults to SimpleAsyncTaskExecutor)</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO17-23">(23)</a> </p></td><td valign="top" align="left">
<p>By default the underlying <code class="literal">SimpleMessageListenerContainer</code> creates a new instance of the DefaultTransactionAttribute (takes the EJB approach to rolling back on runtime, but not checked exceptions.
<span class="emphasis"><em>Optional (Defaults to DefaultTransactionAttribute)</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO17-24">(24)</a> </p></td><td valign="top" align="left">
<p>Sets a Bean reference to an external <code class="literal">PlatformTransactionManager</code> on the underlying SimpleMessageListenerContainer.
The transaction manager works in conjunction with the "channel-transacted" attribute.
If there is already a transaction in progress when the framework is sending or receiving a message, and the channelTransacted flag is true, then the commit or rollback of the messaging transaction will be deferred until the end of the current transaction.
If the channelTransacted flag is false, then no transaction semantics apply to the messaging operation (it is auto-acked).
For further information see
<a class="ulink" href="http://docs.spring.io/spring-amqp/reference/html/%5Freference.html#%5Ftransactions" target="_top">Transactions with Spring AMQP</a>.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO17-25">(25)</a> </p></td><td valign="top" align="left">
<p>Tells the <code class="literal">SimpleMessageListenerContainer</code> how many messages to process in a single transaction (if the channel is transactional).
For best results it should be less than or equal to the set "prefetch-count".
<span class="emphasis"><em>Optional (Defaults to 1)</em></span>.</p>
</td></tr></table></div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note: container"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">container</th></tr><tr><td align="left" valign="top">

<p>Note that when configuring an external container, you cannot use the <span class="strong"><strong>Spring AMQP</strong></span> namespace to define the container.
This is because the namespace requires at least one <code class="literal">&lt;listener/&gt;</code> element.
In this environment, the listener is internal to the adapter.
For this reason, you must define the container using a normal Spring <code class="literal">&lt;bean/&gt;</code> definition, such as:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"container"</span>
 <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.amqp.rabbit.listener.SimpleMessageListenerContainer"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"connectionFactory"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"connectionFactory"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"queueNames"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"foo.queue"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"defaultRequeueRejected"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"false"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
</td></tr></table></div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Even though the Spring Integration JMS and AMQP support is very similar, important differences exist.
The JMS Inbound Channel Adapter is using a <code class="literal">JmsDestinationPollingSource</code> under the covers and expects a configured Poller.
The AMQP Inbound Channel Adapter on the other side uses a`SimpleMessageListenerContainer` and is message driven.
In that regard it is more similar to the JMS Message Driven Channel Adapter.</p>
</td></tr></table></div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_with_java_configuration_2" href="#_configuring_with_java_configuration_2"></a>11.2.1&nbsp;Configuring with Java Configuration</h3></div></div></div>

<p>The following Spring Boot application provides an example of configuring the inbound adapter using Java configuration:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@SpringBootApplication</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> AmqpJavaApplication {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
        <span class="hl-keyword">new</span> SpringApplicationBuilder(AmqpJavaApplication.<span class="hl-keyword">class</span>)
            .web(false)
            .run(args);
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> MessageChannel amqpInputChannel() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> DirectChannel();
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> AmqpInboundChannelAdapter inbound(SimpleMessageListenerContainer listenerContainer,
            <em><span class="hl-annotation" style="color: gray">@Qualifier("amqpInputChannel")</span></em> MessageChannel channel) {
        AmqpInboundChannelAdapter adapter = <span class="hl-keyword">new</span> AmqpInboundChannelAdapter(listenerContainer);
        adapter.setOutputChannel(channel);
        <span class="hl-keyword">return</span> adapter;
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> SimpleMessageListenerContainer container(ConnectionFactory connectionFactory) {
        SimpleMessageListenerContainer container =
                                   <span class="hl-keyword">new</span> SimpleMessageListenerContainer(connectionFactory);
        container.setQueueNames(<span class="hl-string">"foo"</span>);
        container.setConcurrentConsumers(<span class="hl-number">2</span>);
        <span class="hl-comment">// ...</span>
        <span class="hl-keyword">return</span> container;
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "amqpInputChannel")</span></em>
    <span class="hl-keyword">public</span> MessageHandler handler() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> MessageHandler() {

            <em><span class="hl-annotation" style="color: gray">@Override</span></em>
            <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> handleMessage(Message&lt;?&gt; message) <span class="hl-keyword">throws</span> MessagingException {
                System.out.println(message.getPayload());
            }

        };
    }

}</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_with_the_java_dsl" href="#_configuring_with_the_java_dsl"></a>11.2.2&nbsp;Configuring with the Java DSL</h3></div></div></div>

<p>The following Spring Boot application provides an example of configuring the inbound adapter using the Java DSL:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@SpringBootApplication</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> AmqpJavaApplication {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
        <span class="hl-keyword">new</span> SpringApplicationBuilder(AmqpJavaApplication.<span class="hl-keyword">class</span>)
            .web(false)
            .run(args);
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> IntegrationFlow amqpInbound(ConnectionFactory connectionFactory) {
        <span class="hl-keyword">return</span> IntegrationFlows.from(Amqp.inboundAdapter(connectionFactory, <span class="hl-string">"foo"</span>))
                .handle(m -&gt; System.out.println(m.getPayload()))
                .get();
    }

}</pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="amqp-inbound-gateway" href="#amqp-inbound-gateway"></a>11.3&nbsp;Inbound Gateway</h2></div></div></div>

<p>The inbound gateway supports all the attributes on the inbound channel adapter (except <span class="emphasis"><em>channel</em></span> is replaced by <span class="emphasis"><em>request-channel</em></span>), plus some additional attributes:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-amqp:inbound-gateway</span>
                          <span class="hl-attribute">id</span>=<span class="hl-value">"inboundGateway"</span> <a name="CO18-1" href="#CO18-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
                          request-channel="myRequestChannel" <a name="CO18-2" href="#CO18-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
                          header-mapper="" <a name="CO18-3" href="#CO18-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
                          mapped-request-headers="" <a name="CO18-4" href="#CO18-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
                          mapped-reply-headers="" <a name="CO18-5" href="#CO18-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
                          reply-channel="myReplyChannel" <a name="CO18-6" href="#CO18-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>
                          reply-timeout="1000"  <a name="CO18-7" href="#CO18-7"></a><span><img src="images/callouts/7.png" alt="7" border="0"></span>
                          amqp-template="" <a name="CO18-8" href="#CO18-8"></a><span><img src="images/callouts/8.png" alt="8" border="0"></span>
                          default-reply-to="" /&gt; <a name="CO18-9" href="#CO18-9"></a><span><img src="images/callouts/9.png" alt="9" border="0"></span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO18-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Unique ID for this adapter.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO18-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Message Channel to which converted Messages should be sent.
<span class="emphasis"><em>Required</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO18-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A reference to an <code class="literal">AmqpHeaderMapper</code> to use when receiving AMQP Messages.
<span class="emphasis"><em>Optional</em></span>.
By default only standard AMQP properties (e.g.
<code class="literal">contentType</code>) will be copied to and from Spring Integration <code class="literal">MessageHeaders</code>.
Any user-defined headers within the AMQP`MessageProperties` will NOT be copied to or from an AMQP Message by the default <code class="literal">DefaultAmqpHeaderMapper</code>.
Not allowed if <span class="emphasis"><em>request-header-names</em></span> or <span class="emphasis"><em>reply-header-names</em></span> is provided.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO18-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Comma-separated list of names of AMQP Headers to be mapped from the AMQP request into the <code class="literal">MessageHeaders</code>.
This can only be provided if the <span class="emphasis"><em>header-mapper</em></span> reference is not provided.
The values in this list can also be simple patterns to be matched against the header names (e.g.
"*" or "foo*, bar" or "*foo").</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO18-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Comma-separated list of names of <code class="literal">MessageHeaders</code> to be mapped into the AMQP Message Properties of the AMQP reply message.
All standard Headers (e.g., <code class="literal">contentType</code>) will be mapped to AMQP Message Properties while user-defined headers will be mapped to the <span class="emphasis"><em>headers</em></span> property.
This can only be provided if the <span class="emphasis"><em>header-mapper</em></span> reference is not provided.
The values in this list can also be simple patterns to be matched against the header names (e.g.
"*" or "foo*, bar" or "*foo").</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO18-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Message Channel where reply Messages will be expected.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO18-7"><span><img src="images/callouts/7.png" alt="7" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Used to set the <code class="literal">receiveTimeout</code> on the underlying <code class="literal">org.springframework.integration.core.MessagingTemplate</code> for receiving messages from the reply channel.
If not specified this property will default to "1000" (1 second).
Only applies if the container thread hands off to another thread before the reply is sent.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO18-8"><span><img src="images/callouts/8.png" alt="8" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The customized <code class="literal">AmqpTemplate</code> bean reference to have more control for the reply messages to send or you can provide
an alternative implementation to the <code class="literal">RabbitTemplate</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO18-9"><span><img src="images/callouts/9.png" alt="9" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The <code class="literal">replyTo</code> <code class="literal">org.springframework.amqp.core.Address</code> to be used when the <code class="literal">requestMessage</code> doesn&#8217;t have <code class="literal">replyTo</code>
property.
If this option isn&#8217;t specified, no <code class="literal">amqp-template</code> is provided, and no <code class="literal">replyTo</code> property exists in the request message,
an <code class="literal">IllegalStateException</code> is thrown because the reply can&#8217;t be routed.
If this option isn&#8217;t specified, and an external <code class="literal">amqp-template</code> is provided, no exception will be thrown.
You <span class="emphasis"><em>must</em></span> either specify this option, or configure a default <code class="literal">exchange</code> and <code class="literal">routingKey</code> on that template,
if you anticipate cases when no <code class="literal">replyTo</code> property exists in the request message.</p>
</td></tr></table></div>
<p>See the note in <a class="xref" href="#amqp-inbound-channel-adapter" title="11.2&nbsp;Inbound Channel Adapter">Section&nbsp;11.2, &#8220;Inbound Channel Adapter&#8221;</a> about configuring the <code class="literal">listener-container</code> attribute.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_with_java_configuration_3" href="#_configuring_with_java_configuration_3"></a>11.3.1&nbsp;Configuring with Java Configuration</h3></div></div></div>

<p>The following Spring Boot application provides an example of configuring the inbound gateway using Java configuration:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@SpringBootApplication</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> AmqpJavaApplication {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
        <span class="hl-keyword">new</span> SpringApplicationBuilder(AmqpJavaApplication.<span class="hl-keyword">class</span>)
            .web(false)
            .run(args);
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> MessageChannel amqpInputChannel() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> DirectChannel();
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> AmqpInboundGateway inbound(SimpleMessageListenerContainer listenerContainer,
            <em><span class="hl-annotation" style="color: gray">@Qualifier("amqpInputChannel")</span></em> MessageChannel channel) {
        AmqpInboundGateway gateway = <span class="hl-keyword">new</span> AmqpInboundGateway(listenerContainer);
        gateway.setRequestChannel(channel);
        gateway.setDefaultReplyTo(<span class="hl-string">"bar"</span>);
        <span class="hl-keyword">return</span> gateway;
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> SimpleMessageListenerContainer container(ConnectionFactory connectionFactory) {
        SimpleMessageListenerContainer container =
                        <span class="hl-keyword">new</span> SimpleMessageListenerContainer(connectionFactory);
        container.setQueueNames(<span class="hl-string">"foo"</span>);
        container.setConcurrentConsumers(<span class="hl-number">2</span>);
        <span class="hl-comment">// ...</span>
        <span class="hl-keyword">return</span> container;
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "amqpInputChannel")</span></em>
    <span class="hl-keyword">public</span> MessageHandler handler() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> AbstractReplyProducingMessageHandler() {

            <em><span class="hl-annotation" style="color: gray">@Override</span></em>
            <span class="hl-keyword">protected</span> Object handleRequestMessage(Message&lt;?&gt; requestMessage) {
                <span class="hl-keyword">return</span> <span class="hl-string">"reply to "</span> + requestMessage.getPayload();
            }

        };
    }

}</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_with_the_java_dsl_2" href="#_configuring_with_the_java_dsl_2"></a>11.3.2&nbsp;Configuring with the Java DSL</h3></div></div></div>

<p>The following Spring Boot application provides an example of configuring the inbound gateway using the Java DSL:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@SpringBootApplication</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> AmqpJavaApplication {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
        <span class="hl-keyword">new</span> SpringApplicationBuilder(AmqpJavaApplication.<span class="hl-keyword">class</span>)
            .web(false)
            .run(args);
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em> <span class="hl-comment">// return the upper cased payload</span>
    <span class="hl-keyword">public</span> IntegrationFlow amqpInboundGateway(ConnectionFactory connectionFactory) {
        <span class="hl-keyword">return</span> IntegrationFlows.from(Amqp.inboundGateway(connectionFactory, <span class="hl-string">"foo"</span>))
                .transform(String.<span class="hl-keyword">class</span>, String::toUpperCase)
                .get();
    }

}</pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="amqp-inbound-ack" href="#amqp-inbound-ack"></a>11.4&nbsp;Inbound Endpoint Acknowledge Mode</h2></div></div></div>

<p>By default the inbound endpoints use acknowledge mode <code class="literal">AUTO</code>, which means the container automatically <span class="emphasis"><em>acks</em></span> the message when the downstream integration flow completes (or a message is handed off to another thread using a <code class="literal">QueueChannel</code> or <code class="literal">ExecutorChannel</code>).
Setting the mode to <code class="literal">NONE</code> configures the consumer such that acks are not used at all (the broker automatically acks the message as soon as it is sent).
Setting the mode to`MANUAL` allows user code to ack the message at some other point during processing.
To support this, with this mode, the endpoints provide the <code class="literal">Channel</code> and <code class="literal">deliveryTag</code> in the <code class="literal">amqp_channel</code> and <code class="literal">amqp_deliveryTag</code> headers respectively.</p>
<p>You can perform any valid rabbit command on the <code class="literal">Channel</code> but, generally, only <code class="literal">basicAck</code> and <code class="literal">basicNack</code> (or <code class="literal">basicReject</code>) would be used.
In order to not interfere with the operation of the container, you should not retain a reference to the channel and just use it in the context of the current message.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Since the <code class="literal">Channel</code> is a reference to a "live" object, it cannot be serialized and will be lost if a message is persisted.</p>
</td></tr></table></div>
<p>This is an example of how you might use <code class="literal">MANUAL</code> acknowledgement:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "foo", outputChannel = "bar")</span></em>
<span class="hl-keyword">public</span> Object handle(<em><span class="hl-annotation" style="color: gray">@Payload</span></em> String payload, <em><span class="hl-annotation" style="color: gray">@Header(AmqpHeaders.CHANNEL)</span></em> Channel channel,
        <em><span class="hl-annotation" style="color: gray">@Header(AmqpHeaders.DELIVERY_TAG)</span></em> Long deliveryTag) <span class="hl-keyword">throws</span> Exception {

    <span class="hl-comment">// Do some processing</span>

    <span class="hl-keyword">if</span> (allOK) {
        channel.basicAck(deliveryTag, false);

        <span class="hl-comment">// perhaps do some more processing</span>

    }
    <span class="hl-keyword">else</span> {
        channel.basicNack(deliveryTag, false, true);
    }
    <span class="hl-keyword">return</span> someResultForDownStreamProcessing;
}</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="amqp-outbound-channel-adapter" href="#amqp-outbound-channel-adapter"></a>11.5&nbsp;Outbound Channel Adapter</h2></div></div></div>

<p>A configuration sample for an AMQP Outbound Channel Adapter is shown below.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-amqp:outbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"outboundAmqp"</span> <a name="CO19-1" href="#CO19-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
                               channel="outboundChannel" <a name="CO19-2" href="#CO19-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
                               amqp-template="myAmqpTemplate" <a name="CO19-3" href="#CO19-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
                               exchange-name="" <a name="CO19-4" href="#CO19-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
                               exchange-name-expression="" <a name="CO19-5" href="#CO19-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
                               order="1" <a name="CO19-6" href="#CO19-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>
                               routing-key="" <a name="CO19-7" href="#CO19-7"></a><span><img src="images/callouts/7.png" alt="7" border="0"></span>
                               routing-key-expression="" <a name="CO19-8" href="#CO19-8"></a><span><img src="images/callouts/8.png" alt="8" border="0"></span>
                               default-delivery-mode"" <a name="CO19-9" href="#CO19-9"></a><span><img src="images/callouts/9.png" alt="9" border="0"></span>
                               confirm-correlation-expression="" <a name="CO19-10" href="#CO19-10"></a><span><img src="images/callouts/10.png" alt="10" border="0"></span>
                               confirm-ack-channel="" <a name="CO19-11" href="#CO19-11"></a><span><img src="images/callouts/11.png" alt="11" border="0"></span>
                               confirm-nack-channel="" <a name="CO19-12" href="#CO19-12"></a><span><img src="images/callouts/12.png" alt="12" border="0"></span>
                               return-channel="" <a name="CO19-13" href="#CO19-13"></a><span><img src="images/callouts/13.png" alt="13" border="0"></span>
                               error-message-strategy="" <a name="CO19-14" href="#CO19-14"></a><span><img src="images/callouts/14.png" alt="14" border="0"></span>
                               header-mapper="" <a name="CO19-15" href="#CO19-15"></a><span><img src="images/callouts/15.png" alt="15" border="0"></span>
                               mapped-request-headers="" <a name="CO19-16" href="#CO19-16"></a>(16)
                               lazy-connect="true" /&gt; <a name="CO19-17" href="#CO19-17"></a>(17)</pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO19-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Unique ID for this adapter.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO19-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Message Channel to which Messages should be sent in order to have them converted and published to an AMQP Exchange.
<span class="emphasis"><em>Required</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO19-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Bean Reference to the configured AMQP Template <span class="emphasis"><em>Optional (Defaults to "amqpTemplate")</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO19-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The name of the AMQP Exchange to which Messages should be sent.
If not provided, Messages will be sent to the default, no-name Exchange.
Mutually exclusive with <span class="emphasis"><em>exchange-name-expression</em></span>.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO19-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A SpEL expression that is evaluated to determine the name of the AMQP Exchange to which Messages should be sent, with the message as the root object.
If not provided, Messages will be sent to the default, no-name Exchange.
Mutually exclusive with <span class="emphasis"><em>exchange-name</em></span>.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO19-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The order for this consumer when multiple consumers are registered thereby enabling load-balancing and/or failover.
<span class="emphasis"><em>Optional (Defaults to Ordered.LOWEST_PRECEDENCE [=Integer.MAX_VALUE])</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO19-7"><span><img src="images/callouts/7.png" alt="7" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The fixed routing-key to use when sending Messages.
By default, this will be an empty String.
Mutually exclusive with <span class="emphasis"><em>routing-key-expression</em></span>.<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO19-8"><span><img src="images/callouts/8.png" alt="8" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A SpEL expression that is evaluated to determine the routing-key to use when sending Messages, with the message as the root object (e.g.
<span class="emphasis"><em>payload.key</em></span>).
By default, this will be an empty String.
Mutually exclusive with <span class="emphasis"><em>routing-key</em></span>.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO19-9"><span><img src="images/callouts/9.png" alt="9" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The default delivery mode for messages; <code class="literal">PERSISTENT</code> or <code class="literal">NON_PERSISTENT</code>.
Overridden if the <code class="literal">header-mapper</code> sets the delivery mode.
The <code class="literal">DefaultHeaderMapper</code> sets the value if the Spring Integration message header <code class="literal">amqp_deliveryMode</code> is present.
If this attribute is not supplied and the header mapper doesn&#8217;t set it, the default depends on the underlying
spring-amqp <code class="literal">MessagePropertiesConverter</code> used by the <code class="literal">RabbitTemplate</code>.
If that is not customized at all, the default is <code class="literal">PERSISTENT</code>.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO19-10"><span><img src="images/callouts/10.png" alt="10" border="0"></span></a> </p></td><td valign="top" align="left">
<p>An expression defining correlation data.
When provided, this configures the underlying amqp template to receive publisher confirms.
Requires a dedicated <code class="literal">RabbitTemplate</code> and a <code class="literal">CachingConnectionFactory</code> with the <code class="literal">publisherConfirms</code> property set to
<code class="literal">true</code>. When a publisher confirm is received, and correlation data is supplied, it is written to either the
confirm-ack-channel, or the confirm-nack-channel, depending on the confirmation type. The payload of the confirm is
the correlation data as defined by this expression and the message will have a header <span class="emphasis"><em>amqp_publishConfirm</em></span> set to true (ack) or false (nack).
Examples: "<code class="literal">headers['myCorrelationData']</code>", "<code class="literal">payload</code>".
Starting with <span class="emphasis"><em>version 4.1</em></span> the <code class="literal">amqp_publishConfirmNackCause</code> message header has been added.
It contains the <code class="literal">cause</code> of a <span class="emphasis"><em>nack</em></span> for publisher confirms.
Starting with <span class="emphasis"><em>version 4.2</em></span>, if the expression resolves to a <code class="literal">Message&lt;?&gt;</code> instance (such as "<code class="literal">#this</code>"), the message
emitted on the ack/nack channel is based on that message, with the additional header(s) added.
Previously, a new message was created with the correlation data as its payload, regardless of type.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO19-11"><span><img src="images/callouts/11.png" alt="11" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The channel to which positive (ack) publisher confirms are sent; payload is the correlation data defined by the <span class="emphasis"><em>confirm-correlation-expression</em></span>.
If the expression is <code class="literal">#root</code> or <code class="literal">#this</code>, the message is built from the original message, with the <code class="literal">amqp_publishConfirm</code> header set to <code class="literal">true</code>.
<span class="emphasis"><em>Optional, default=nullChannel</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO19-12"><span><img src="images/callouts/12.png" alt="12" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The channel to which negative (nack) publisher confirms are sent; payload is the correlation data defined by the <span class="emphasis"><em>confirm-correlation-expression</em></span> (if there is no <code class="literal">ErrorMessageStrategy</code> configured).
If the expression is <code class="literal">#root</code> or <code class="literal">#this</code>, the message is built from the original message, with the <code class="literal">amqp_publishConfirm</code> header set to <code class="literal">false</code>.
When there is an <code class="literal">ErrorMessageStrategy</code>, the message will be an <code class="literal">ErrorMessage</code> with a <code class="literal">NackedAmqpMessageException</code> payload.
<span class="emphasis"><em>Optional, default=nullChannel</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO19-13"><span><img src="images/callouts/13.png" alt="13" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The channel to which returned messages are sent.
When provided, the underlying amqp template is configured to return undeliverable messages to the adapter.
When there is no <code class="literal">ErrorMessageStrategy</code> configured, the message will be constructed from the data received from amqp, with the following additional headers: <span class="emphasis"><em>amqp_returnReplyCode, amqp_returnReplyText, amqp_returnExchange, amqp_returnRoutingKey</em></span>.
When there is an <code class="literal">ErrorMessageStrategy</code>, the message will be an <code class="literal">ErrorMessage</code> with a <code class="literal">ReturnedAmqpMessageException</code> payload.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO19-14"><span><img src="images/callouts/14.png" alt="14" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A reference to an <code class="literal">ErrorMessageStrategy</code> implementation used to build <code class="literal">ErrorMessage</code> s when sending returned or negatively acknowedged messages.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO19-15"><span><img src="images/callouts/15.png" alt="15" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A reference to an <code class="literal">AmqpHeaderMapper</code> to use when sending AMQP Messages.
By default only standard AMQP properties (e.g.
<code class="literal">contentType</code>) will be copied to the Spring Integration <code class="literal">MessageHeaders</code>.
Any user-defined headers will NOT be copied to the Message by the default`DefaultAmqpHeaderMapper`.
Not allowed if <span class="emphasis"><em>request-header-names</em></span> is provided.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO19-16">(16)</a> </p></td><td valign="top" align="left">
<p>Comma-separated list of names of AMQP Headers to be mapped from the <code class="literal">MessageHeaders</code> to the AMQP Message.
Not allowed if the <span class="emphasis"><em>header-mapper</em></span> reference is provided.
The values in this list can also be simple patterns to be matched against the header names (e.g.
"*" or "foo*, bar" or "*foo").</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO19-17">(17)</a> </p></td><td valign="top" align="left">
<p>When set to <code class="literal">false</code>, the endpoint will attempt to connect to the broker during application context initialization.
This allows "fail fast" detection of bad configuration, but will also cause initialization to fail if the broker is down.
When true (default), the connection is established (if it doesn&#8217;t already exist because some other component established it) when the first message is sent.</p>
</td></tr></table></div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important: return-channel"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">return-channel</th></tr><tr><td align="left" valign="top">

<p>Using a <code class="literal">return-channel</code> requires a <code class="literal">RabbitTemplate</code> with the <code class="literal">mandatory</code> property set to <code class="literal">true</code>, and a <code class="literal">CachingConnectionFactory</code> with the <code class="literal">publisherReturns</code> property set to <code class="literal">true</code>.
When using multiple outbound endpoints with returns, a separate <code class="literal">RabbitTemplate</code> is needed for each endpoint.</p>
</td></tr></table></div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_with_java_configuration_4" href="#_configuring_with_java_configuration_4"></a>11.5.1&nbsp;Configuring with Java Configuration</h3></div></div></div>

<p>The following Spring Boot application provides an example of configuring the outbound adapter using Java configuration:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@SpringBootApplication</span></em>
<em><span class="hl-annotation" style="color: gray">@IntegrationComponentScan</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> AmqpJavaApplication {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
         ConfigurableApplicationContext context =
              <span class="hl-keyword">new</span> SpringApplicationBuilder(AmqpJavaApplication.<span class="hl-keyword">class</span>)
                       .web(false)
                       .run(args);
         MyGateway gateway = context.getBean(MyGateway.<span class="hl-keyword">class</span>);
         gateway.sendToRabbit(<span class="hl-string">"foo"</span>);
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "amqpOutboundChannel")</span></em>
    <span class="hl-keyword">public</span> AmqpOutboundEndpoint amqpOutbound(AmqpTemplate amqpTemplate) {
        AmqpOutboundEndpoint outbound = <span class="hl-keyword">new</span> AmqpOutboundEndpoint(amqpTemplate);
        outbound.setRoutingKey(<span class="hl-string">"foo"</span>); <span class="hl-comment">// default exchange - route to queue 'foo'</span>
        <span class="hl-keyword">return</span> outbound;
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> MessageChannel amqpOutboundChannel() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> DirectChannel();
    }

    <em><span class="hl-annotation" style="color: gray">@MessagingGateway(defaultRequestChannel = "amqpOutboundChannel")</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> MyGateway {

        <span class="hl-keyword">void</span> sendToRabbit(String data);

    }

}</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_with_the_java_dsl_3" href="#_configuring_with_the_java_dsl_3"></a>11.5.2&nbsp;Configuring with the Java DSL</h3></div></div></div>

<p>The following Spring Boot application provides an example of configuring the outbound adapter using the Java DSL:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@SpringBootApplication</span></em>
<em><span class="hl-annotation" style="color: gray">@IntegrationComponentScan</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> AmqpJavaApplication {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
         ConfigurableApplicationContext context =
                  <span class="hl-keyword">new</span> SpringApplicationBuilder(AmqpJavaApplication.<span class="hl-keyword">class</span>)
                          .web(false)
                          .run(args);
         MyGateway gateway = context.getBean(MyGateway.<span class="hl-keyword">class</span>);
         gateway.sendToRabbit(<span class="hl-string">"foo"</span>);
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> IntegrationFlow amqpOutbound(AmqpTemplate amqpTemplate) {
        <span class="hl-keyword">return</span> IntegrationFlows.from(amqpOutboundChannel())
                .handle(Amqp.outboundAdapter(amqpTemplate)
                            .routingKey(<span class="hl-string">"foo"</span>)) <span class="hl-comment">// default exchange - route to queue 'foo'</span>
                .get();
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> MessageChannel amqpOutboundChannel() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> DirectChannel();
    }

    <em><span class="hl-annotation" style="color: gray">@MessagingGateway(defaultRequestChannel = "amqpOutboundChannel")</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> MyGateway {

        <span class="hl-keyword">void</span> sendToRabbit(String data);

    }
}</pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="amqp-outbound-gateway" href="#amqp-outbound-gateway"></a>11.6&nbsp;Outbound Gateway</h2></div></div></div>

<p>Configuration for an AMQP Outbound Gateway is shown below.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-amqp:outbound-gateway</span> <span class="hl-attribute">id</span>=<span class="hl-value">"inboundGateway"</span> <a name="CO20-1" href="#CO20-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
                           request-channel="myRequestChannel" <a name="CO20-2" href="#CO20-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
                           amqp-template="" <a name="CO20-3" href="#CO20-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
                           exchange-name="" <a name="CO20-4" href="#CO20-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
                           exchange-name-expression="" <a name="CO20-5" href="#CO20-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
                           order="1" <a name="CO20-6" href="#CO20-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>
                           reply-channel="" <a name="CO20-7" href="#CO20-7"></a><span><img src="images/callouts/7.png" alt="7" border="0"></span>
                           reply-timeout="" <a name="CO20-8" href="#CO20-8"></a><span><img src="images/callouts/8.png" alt="8" border="0"></span>
                           requires-reply="" <a name="CO20-9" href="#CO20-9"></a><span><img src="images/callouts/9.png" alt="9" border="0"></span>
                           routing-key="" <a name="CO20-10" href="#CO20-10"></a><span><img src="images/callouts/10.png" alt="10" border="0"></span>
                           routing-key-expression="" <a name="CO20-11" href="#CO20-11"></a><span><img src="images/callouts/11.png" alt="11" border="0"></span>
                           default-delivery-mode"" <a name="CO20-12" href="#CO20-12"></a><span><img src="images/callouts/12.png" alt="12" border="0"></span>
                           confirm-correlation-expression="" <a name="CO20-13" href="#CO20-13"></a><span><img src="images/callouts/13.png" alt="13" border="0"></span>
                           confirm-ack-channel="" <a name="CO20-14" href="#CO20-14"></a><span><img src="images/callouts/14.png" alt="14" border="0"></span>
                           confirm-nack-channel="" <a name="CO20-15" href="#CO20-15"></a><span><img src="images/callouts/15.png" alt="15" border="0"></span>
                           return-channel="" <a name="CO20-16" href="#CO20-16"></a>(16)
                           error-message-strategy="" <a name="CO20-17" href="#CO20-17"></a>(17)
                           lazy-connect="true" /&gt; <a name="CO20-18" href="#CO20-18"></a>(18)</pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO20-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Unique ID for this adapter.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO20-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Message Channel to which Messages should be sent in order to have them converted and published to an AMQP Exchange.
<span class="emphasis"><em>Required</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO20-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Bean Reference to the configured AMQP Template <span class="emphasis"><em>Optional (Defaults to "amqpTemplate")</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO20-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The name of the AMQP Exchange to which Messages should be sent.
If not provided, Messages will be sent to the default, no-name Exchange.
Mutually exclusive with <span class="emphasis"><em>exchange-name-expression</em></span>.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO20-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A SpEL expression that is evaluated to determine the name of the AMQP Exchange to which Messages should be sent, with the message as the root object.
If not provided, Messages will be sent to the default, no-name Exchange.
Mutually exclusive with <span class="emphasis"><em>exchange-name</em></span>.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO20-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The order for this consumer when multiple consumers are registered thereby enabling load-balancing and/or failover.
<span class="emphasis"><em>Optional (Defaults to Ordered.LOWEST_PRECEDENCE [=Integer.MAX_VALUE])</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO20-7"><span><img src="images/callouts/7.png" alt="7" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Message Channel to which replies should be sent after being received from an AMQP Queue and converted.<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO20-8"><span><img src="images/callouts/8.png" alt="8" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The time the gateway will wait when sending the reply message to the <code class="literal">reply-channel</code>.
This only applies if the <code class="literal">reply-channel</code> can block - such as a <code class="literal">QueueChannel</code> with a capacity limit that is currently full.
Default: infinity.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO20-9"><span><img src="images/callouts/9.png" alt="9" border="0"></span></a> </p></td><td valign="top" align="left">
<p>When <code class="literal">true</code>, the gateway will throw an exception if no reply message is received within the <code class="literal">AmqpTemplate</code>'s <code class="literal">replyTimeout</code> property.
Default: <code class="literal">true</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO20-10"><span><img src="images/callouts/10.png" alt="10" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The routing-key to use when sending Messages.
By default, this will be an empty String.
Mutually exclusive with <span class="emphasis"><em>routing-key-expression</em></span>.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO20-11"><span><img src="images/callouts/11.png" alt="11" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A SpEL expression that is evaluated to determine the routing-key to use when sending Messages, with the message as the root object (e.g.
<span class="emphasis"><em>payload.key</em></span>).
By default, this will be an empty String.
Mutually exclusive with <span class="emphasis"><em>routing-key</em></span>.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO20-12"><span><img src="images/callouts/12.png" alt="12" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The default delivery mode for messages; <code class="literal">PERSISTENT</code> or <code class="literal">NON_PERSISTENT</code>.
Overridden if the <code class="literal">header-mapper</code> sets the delivery mode.
The <code class="literal">DefaultHeaderMapper</code> sets the value if the Spring Integration message header <code class="literal">amqp_deliveryMode</code> is present.
If this attribute is not supplied and the header mapper doesn&#8217;t set it, the default depends on the underlying
spring-amqp <code class="literal">MessagePropertiesConverter</code> used by the <code class="literal">RabbitTemplate</code>.
If that is not customized at all, the default is <code class="literal">PERSISTENT</code>.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO20-13"><span><img src="images/callouts/13.png" alt="13" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Since <span class="emphasis"><em>version 4.2</em></span>. An expression defining correlation data.
When provided, this configures the underlying amqp template to receive publisher confirms.
Requires a dedicated <code class="literal">RabbitTemplate</code> and a <code class="literal">CachingConnectionFactory</code> with the <code class="literal">publisherConfirms</code> property set to
<code class="literal">true</code>. When a publisher confirm is received, and correlation data is supplied, it is written to either the
confirm-ack-channel, or the confirm-nack-channel, depending on the confirmation type. The payload of the confirm is
the correlation data as defined by this expression and the message will have a header <span class="emphasis"><em>amqp_publishConfirm</em></span> set to true (ack) or false (nack).
For nacks, an additional header <code class="literal">amqp_publishConfirmNackCause</code> is provided.
Examples: "headers[<span class="emphasis"><em>myCorrelationData</em></span>]", "payload".
If the expression resolves to a <code class="literal">Message&lt;?&gt;</code> instance (such as "<code class="literal">#this</code>"), the message
emitted on the ack/nack channel is based on that message, with the additional header(s) added.
Previously, a new message was created with the correlation data as its payload, regardless of type.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO20-14"><span><img src="images/callouts/14.png" alt="14" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The channel to which positive (ack) publisher confirms are sent; payload is the correlation data defined by the <span class="emphasis"><em>confirm-correlation-expression</em></span>.
If the expression is <code class="literal">#root</code> or <code class="literal">#this</code>, the message is built from the original message, with the <code class="literal">amqp_publishConfirm</code> header set to <code class="literal">true</code>.
<span class="emphasis"><em>Optional, default=nullChannel</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO20-15"><span><img src="images/callouts/15.png" alt="15" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The channel to which negative (nack) publisher confirms are sent; payload is the correlation data defined by the <span class="emphasis"><em>confirm-correlation-expression</em></span> (if there is no <code class="literal">ErrorMessageStrategy</code> configured).
If the expression is <code class="literal">#root</code> or <code class="literal">#this</code>, the message is built from the original message, with the <code class="literal">amqp_publishConfirm</code> header set to <code class="literal">false</code>.
When there is an <code class="literal">ErrorMessageStrategy</code>, the message will be an <code class="literal">ErrorMessage</code> with a <code class="literal">NackedAmqpMessageException</code> payload.
<span class="emphasis"><em>Optional, default=nullChannel</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO20-16">(16)</a> </p></td><td valign="top" align="left">
<p>The channel to which returned messages are sent.
When provided, the underlying amqp template is configured to return undeliverable messages to the adapter.
When there is no <code class="literal">ErrorMessageStrategy</code> configured, the message will be constructed from the data received from amqp, with the following additional headers: <span class="emphasis"><em>amqp_returnReplyCode, amqp_returnReplyText, amqp_returnExchange, amqp_returnRoutingKey</em></span>.
When there is an <code class="literal">ErrorMessageStrategy</code>, the message will be an <code class="literal">ErrorMessage</code> with a <code class="literal">ReturnedAmqpMessageException</code> payload.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO20-17">(17)</a> </p></td><td valign="top" align="left">
<p>A reference to an <code class="literal">ErrorMessageStrategy</code> implementation used to build <code class="literal">ErrorMessage</code> s when sending returned or negatively acknowedged messages.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO20-18">(18)</a> </p></td><td valign="top" align="left">
<p>When set to <code class="literal">false</code>, the endpoint will attempt to connect to the broker during application context initialization.
This allows "fail fast" detection of bad configuration, by logging an error message if the broker is down.
When true (default), the connection is established (if it doesn&#8217;t already exist because some other component established it) when the first message is sent.</p>
</td></tr></table></div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important: return-channel"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">return-channel</th></tr><tr><td align="left" valign="top">

<p>Using a <code class="literal">return-channel</code> requires a <code class="literal">RabbitTemplate</code> with the <code class="literal">mandatory</code> property set to <code class="literal">true</code>, and a <code class="literal">CachingConnectionFactory</code> with the <code class="literal">publisherReturns</code> property set to <code class="literal">true</code>.
When using multiple outbound endpoints with returns, a separate <code class="literal">RabbitTemplate</code> is needed for each endpoint.</p>
</td></tr></table></div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>The underlying <code class="literal">AmqpTemplate</code> has a default <code class="literal">replyTimeout</code> of 5 seconds.
If you require a longer timeout, it must be configured on the <code class="literal">template</code>.</p>
</td></tr></table></div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_with_java_configuration_5" href="#_configuring_with_java_configuration_5"></a>11.6.1&nbsp;Configuring with Java Configuration</h3></div></div></div>

<p>The following Spring Boot application provides an example of configuring the outbound gateway using Java configuration:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@SpringBootApplication</span></em>
<em><span class="hl-annotation" style="color: gray">@IntegrationComponentScan</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> AmqpJavaApplication {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
         ConfigurableApplicationContext context =
                <span class="hl-keyword">new</span> SpringApplicationBuilder(AmqpJavaApplication.<span class="hl-keyword">class</span>)
                       .web(false)
                       .run(args);
         MyGateway gateway = context.getBean(MyGateway.<span class="hl-keyword">class</span>);
         String reply = gateway.sendToRabbit(<span class="hl-string">"foo"</span>);
         System.out.println(reply);
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "amqpOutboundChannel")</span></em>
    <span class="hl-keyword">public</span> AmqpOutboundEndpoint amqpOutbound(AmqpTemplate amqpTemplate) {
        AmqpOutboundEndpoint outbound = <span class="hl-keyword">new</span> AmqpOutboundEndpoint(amqpTemplate);
        outbound.setExpectReply(true);
        outbound.setRoutingKey(<span class="hl-string">"foo"</span>); <span class="hl-comment">// default exchange - route to queue 'foo'</span>
        <span class="hl-keyword">return</span> outbound;
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> MessageChannel amqpOutboundChannel() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> DirectChannel();
    }

    <em><span class="hl-annotation" style="color: gray">@MessagingGateway(defaultRequestChannel = "amqpOutboundChannel")</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> MyGateway {

        String sendToRabbit(String data);

    }

}</pre>
<p>Notice that the only difference between the outbound adapter and outbound gateway configuration is the setting of the
<code class="literal">expectReply</code> property.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_with_the_java_dsl_4" href="#_configuring_with_the_java_dsl_4"></a>11.6.2&nbsp;Configuring with the Java DSL</h3></div></div></div>

<p>The following Spring Boot application provides an example of configuring the outbound adapter using the Java DSL:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@SpringBootApplication</span></em>
<em><span class="hl-annotation" style="color: gray">@IntegrationComponentScan</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> AmqpJavaApplication {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
         ConfigurableApplicationContext context =
                 <span class="hl-keyword">new</span> SpringApplicationBuilder(AmqpJavaApplication.<span class="hl-keyword">class</span>)
                      .web(false)
                      .run(args);
         RabbitTemplate template = context.getBean(RabbitTemplate.<span class="hl-keyword">class</span>);
         MyGateway gateway = context.getBean(MyGateway.<span class="hl-keyword">class</span>);
         String reply = gateway.sendToRabbit(<span class="hl-string">"foo"</span>);
         System.out.println(reply);
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> IntegrationFlow amqpOutbound(AmqpTemplate amqpTemplate) {
        <span class="hl-keyword">return</span> IntegrationFlows.from(amqpOutboundChannel())
                .handle(Amqp.outboundGateway(amqpTemplate)
                        .routingKey(<span class="hl-string">"foo"</span>)) <span class="hl-comment">// default exchange - route to queue 'foo'</span>
                .get();
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> MessageChannel amqpOutboundChannel() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> DirectChannel();
    }

    <em><span class="hl-annotation" style="color: gray">@MessagingGateway(defaultRequestChannel = "amqpOutboundChannel")</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> MyGateway {

        String sendToRabbit(String data);

    }
}</pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="amqp-async-outbound-gateway" href="#amqp-async-outbound-gateway"></a>11.7&nbsp;Async Outbound Gateway</h2></div></div></div>

<p>The gateway discussed in the previous section is synchronous, in that the sending thread is suspended until a
reply is received (or a timeout occurs).
Spring Integration <span class="emphasis"><em>version 4.3</em></span> added this asynchronous gateway, which uses the <code class="literal">AsyncRabbitTemplate</code> from Spring AMQP.
When a message is sent, the thread returns immediately after the send completes, and the reply is sent on the template&#8217;s
listener container thread when it is received.
This can be useful when the gateway is invoked on a poller thread; the thread is released and is available for other
tasks in the framework.</p>
<p>Configuration for an AMQP Async Outbound Gateway is shown below.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-amqp:outbound-gateway</span> <span class="hl-attribute">id</span>=<span class="hl-value">"inboundGateway"</span> <a name="CO21-1" href="#CO21-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
                           request-channel="myRequestChannel" <a name="CO21-2" href="#CO21-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
                           async-template="" <a name="CO21-3" href="#CO21-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
                           exchange-name="" <a name="CO21-4" href="#CO21-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
                           exchange-name-expression="" <a name="CO21-5" href="#CO21-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
                           order="1" <a name="CO21-6" href="#CO21-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>
                           reply-channel="" <a name="CO21-7" href="#CO21-7"></a><span><img src="images/callouts/7.png" alt="7" border="0"></span>
                           reply-timeout="" <a name="CO21-8" href="#CO21-8"></a><span><img src="images/callouts/8.png" alt="8" border="0"></span>
                           requires-reply="" <a name="CO21-9" href="#CO21-9"></a><span><img src="images/callouts/9.png" alt="9" border="0"></span>
                           routing-key="" <a name="CO21-10" href="#CO21-10"></a><span><img src="images/callouts/10.png" alt="10" border="0"></span>
                           routing-key-expression="" <a name="CO21-11" href="#CO21-11"></a><span><img src="images/callouts/11.png" alt="11" border="0"></span>
                           default-delivery-mode"" <a name="CO21-12" href="#CO21-12"></a><span><img src="images/callouts/12.png" alt="12" border="0"></span>
                           confirm-correlation-expression="" <a name="CO21-13" href="#CO21-13"></a><span><img src="images/callouts/13.png" alt="13" border="0"></span>
                           confirm-ack-channel="" <a name="CO21-14" href="#CO21-14"></a><span><img src="images/callouts/14.png" alt="14" border="0"></span>
                           confirm-nack-channel="" <a name="CO21-15" href="#CO21-15"></a><span><img src="images/callouts/15.png" alt="15" border="0"></span>
                           return-channel="" <a name="CO21-16" href="#CO21-16"></a>(16)
                           lazy-connect="true" /&gt; <a name="CO21-17" href="#CO21-17"></a>(17)</pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO21-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Unique ID for this adapter.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO21-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Message Channel to which Messages should be sent in order to have them converted and published to an AMQP Exchange.
<span class="emphasis"><em>Required</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO21-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Bean Reference to the configured <code class="literal">AsyncRabbitTemplate</code> <span class="emphasis"><em>Optional (Defaults to "asyncRabbitTemplate")</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO21-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The name of the AMQP Exchange to which Messages should be sent.
If not provided, Messages will be sent to the default, no-name Exchange.
Mutually exclusive with <span class="emphasis"><em>exchange-name-expression</em></span>.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO21-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A SpEL expression that is evaluated to determine the name of the AMQP Exchange to which Messages should be sent,
with the message as the root object.
If not provided, Messages will be sent to the default, no-name Exchange.
Mutually exclusive with <span class="emphasis"><em>exchange-name</em></span>.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO21-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The order for this consumer when multiple consumers are registered thereby enabling load-balancing and/or failover.
<span class="emphasis"><em>Optional (Defaults to Ordered.LOWEST_PRECEDENCE [=Integer.MAX_VALUE])</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO21-7"><span><img src="images/callouts/7.png" alt="7" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Message Channel to which replies should be sent after being received from an AMQP Queue and converted. <span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO21-8"><span><img src="images/callouts/8.png" alt="8" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The time the gateway will wait when sending the reply message to the <code class="literal">reply-channel</code>.
This only applies if the <code class="literal">reply-channel</code> can block - such as a <code class="literal">QueueChannel</code> with a capacity limit that is currently full.
Default: infinity.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO21-9"><span><img src="images/callouts/9.png" alt="9" border="0"></span></a> </p></td><td valign="top" align="left">
<p>When <code class="literal">true</code>, the gateway will send an error message to the inbound message&#8217;s <code class="literal">errorChannel</code> header,
if present or otherwise to the default <code class="literal">errorChannel</code> (if available), when no reply
message is received within the <code class="literal">AsyncRabbitTemplate</code>'s <code class="literal">receiveTimeout</code> property. Default: <code class="literal">true</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO21-10"><span><img src="images/callouts/10.png" alt="10" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The routing-key to use when sending Messages.
By default, this will be an empty String.
Mutually exclusive with <span class="emphasis"><em>routing-key-expression</em></span>.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO21-11"><span><img src="images/callouts/11.png" alt="11" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A SpEL expression that is evaluated to determine the routing-key to use when sending Messages,
with the message as the root object (e.g. <span class="emphasis"><em>payload.key</em></span>).
By default, this will be an empty String.
Mutually exclusive with <span class="emphasis"><em>routing-key</em></span>.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO21-12"><span><img src="images/callouts/12.png" alt="12" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The default delivery mode for messages; <code class="literal">PERSISTENT</code> or <code class="literal">NON_PERSISTENT</code>.
Overridden if the <code class="literal">header-mapper</code> sets the delivery mode.
The <code class="literal">DefaultHeaderMapper</code> sets the value if the Spring Integration message header <code class="literal">amqp_deliveryMode</code> is present.
If this attribute is not supplied and the header mapper doesn&#8217;t set it, the default depends on the underlying
spring-amqp <code class="literal">MessagePropertiesConverter</code> used by the <code class="literal">RabbitTemplate</code>.
If that is not customized at all, the default is <code class="literal">PERSISTENT</code>.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO21-13"><span><img src="images/callouts/13.png" alt="13" border="0"></span></a> </p></td><td valign="top" align="left">
<p>An expression defining correlation data.
When provided, this configures the underlying amqp template to receive publisher confirms.
Requires a dedicated <code class="literal">RabbitTemplate</code> and a <code class="literal">CachingConnectionFactory</code> with the <code class="literal">publisherConfirms</code> property set to
<code class="literal">true</code>. When a publisher confirm is received, and correlation data is supplied, it is written to either the
confirm-ack-channel, or the confirm-nack-channel, depending on the confirmation type. The payload of the confirm is
the correlation data as defined by this expression and the message will have a header <span class="emphasis"><em>amqp_publishConfirm</em></span> set to true
(ack) or false (nack).
For nacks, an additional header <code class="literal">amqp_publishConfirmNackCause</code> is provided.
Examples: "headers[<span class="emphasis"><em>myCorrelationData</em></span>]", "payload".
If the expression resolves to a <code class="literal">Message&lt;?&gt;</code> instance (such as "<code class="literal">#this</code>"), the message
emitted on the ack/nack channel is based on that message, with the additional header(s) added.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO21-14"><span><img src="images/callouts/14.png" alt="14" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The channel to which positive (ack) publisher confirms are sent; payload is the correlation
data defined by the <span class="emphasis"><em>confirm-correlation-expression</em></span>.
Requires the underlying <code class="literal">AsyncRabbitTemplate</code> to have its <code class="literal">enableConfirms</code> property set to true.
<span class="emphasis"><em>Optional, default=nullChannel</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO21-15"><span><img src="images/callouts/15.png" alt="15" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Since <span class="emphasis"><em>version 4.2</em></span>. The channel to which negative (nack) publisher confirms are sent; payload is the correlation
data defined by the <span class="emphasis"><em>confirm-correlation-expression</em></span>.
Requires the underlying <code class="literal">AsyncRabbitTemplate</code> to have its <code class="literal">enableConfirms</code> property set to true.
<span class="emphasis"><em>Optional, default=nullChannel</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO21-16">(16)</a> </p></td><td valign="top" align="left">
<p>The channel to which returned messages are sent.
When provided, the underlying amqp template is configured to return undeliverable messages to the gateway.
The message will be constructed from the data received from amqp, with the following additional headers:
<span class="emphasis"><em>amqp_returnReplyCode, amqp_returnReplyText, amqp_returnExchange, amqp_returnRoutingKey</em></span>.
Requires the underlying <code class="literal">AsyncRabbitTemplate</code> to have its <code class="literal">mandatory</code> property set to true.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO21-17">(17)</a> </p></td><td valign="top" align="left">
<p>When set to <code class="literal">false</code>, the endpoint will attempt to connect to the broker during application context initialization.
This allows "fail fast" detection of bad configuration, by logging an error message if the broker is down.
When true (default), the connection is established (if it doesn&#8217;t already exist because some other component established
it) when the first message is sent.</p>
</td></tr></table></div>
<p>Also see <a class="xref" href="#async-service-activator" title="8.5.3&nbsp;Asynchronous Service Activator">Section&nbsp;8.5.3, &#8220;Asynchronous Service Activator&#8221;</a> for more information.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important: RabbitTemplate"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">RabbitTemplate</th></tr><tr><td align="left" valign="top">

<p>When using confirms and returns, it is recommended that the <code class="literal">RabbitTemplate</code> wired into the <code class="literal">AsyncRabbitTemplate</code> be
dedicated.
Otherwise, unexpected side-effects may be encountered.</p>
</td></tr></table></div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_with_java_configuration_6" href="#_configuring_with_java_configuration_6"></a>11.7.1&nbsp;Configuring with Java Configuration</h3></div></div></div>

<p>The following configuration provides an example of configuring the outbound gateway using Java configuration:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Configuration</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> AmqpAsyncConfig {

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "amqpOutboundChannel")</span></em>
    <span class="hl-keyword">public</span> AsyncAmqpOutboundGateway amqpOutbound(AmqpTemplate asyncTemplate) {
        AsyncAmqpOutboundGateway outbound = <span class="hl-keyword">new</span> AsyncAmqpOutboundGateway(asyncTemplate);
        outbound.setRoutingKey(<span class="hl-string">"foo"</span>); <span class="hl-comment">// default exchange - route to queue 'foo'</span>
        <span class="hl-keyword">return</span> outbound;
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> AsyncRabbitTemplate asyncTemplate(RabbitTemplate rabbitTemplate,
                     SimpleMessageListenerContainer replyContainer) {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> AsyncRabbitTemplate(rabbitTemplate, replyContainer);
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> SimpleMessageListenerContainer replyContainer() {
        SimpleMessageListenerContainer container = <span class="hl-keyword">new</span> SimpleMessageListenerContainer(ccf);
        container.setQueueNames(<span class="hl-string">"asyncRQ1"</span>);
        <span class="hl-keyword">return</span> container;
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> MessageChannel amqpOutboundChannel() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> DirectChannel();
    }

}</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_with_the_java_dsl_5" href="#_configuring_with_the_java_dsl_5"></a>11.7.2&nbsp;Configuring with the Java DSL</h3></div></div></div>

<p>The following Spring Boot application provides an example of configuring the outbound adapter using the Java DSL:</p>
<pre class="programlisting"><span class="hl-comment">// To be supplied when the DSL Amqp factory class adds support for the async gateway.</span></pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="content-type-conversion-outbound" href="#content-type-conversion-outbound"></a>11.8&nbsp;Outbound Message Conversion</h2></div></div></div>

<p>Spring AMQP 1.4 introduced the <code class="literal">ContentTypeDelegatingMessageConverter</code> where the actual converter is selected based
on the incoming content type message property.
This could be used by inbound endpoints.</p>
<p>Spring Integration <span class="emphasis"><em>version 4.3</em></span> now allows the <code class="literal">ContentTypeDelegatingMessageConverter</code> to be used on outbound
endpoints as well - with the <code class="literal">contentType</code> header specifiying which converter will be used.</p>
<p>The following configures a <code class="literal">ContentTypeDelegatingMessageConverter</code> with the default converter being the
<code class="literal">SimpleMessageConverter</code> (which handles java serialization and plain text), together with a JSON converter:</p>
<pre class="programlisting"><span class="hl-tag">&lt;amqp:outbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"withContentTypeConverter"</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"ctRequestChannel"</span>
                               <span class="hl-attribute">exchange-name</span>=<span class="hl-value">"someExchange"</span>
                               <span class="hl-attribute">routing-key</span>=<span class="hl-value">"someKey"</span>
                               <span class="hl-attribute">amqp-template</span>=<span class="hl-value">"amqpTemplateContentTypeConverter"</span><span class="hl-tag"> /&gt;</span>

<span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"ctRequestChannel"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;rabbit:template</span> <span class="hl-attribute">id</span>=<span class="hl-value">"amqpTemplateContentTypeConverter"</span>
        <span class="hl-attribute">connection-factory</span>=<span class="hl-value">"connectionFactory"</span> <span class="hl-attribute">message-converter</span>=<span class="hl-value">"ctConverter"</span><span class="hl-tag"> /&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"ctConverter"</span>
        <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.amqp.support.converter.ContentTypeDelegatingMessageConverter"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"delegates"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;map&gt;</span>
            <span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"application/json"</span><span class="hl-tag">&gt;</span>
                <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.amqp.support.converter.Jackson2JsonMessageConverter"</span><span class="hl-tag"> /&gt;</span>
            <span class="hl-tag">&lt;/entry&gt;</span>
        <span class="hl-tag">&lt;/map&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
<p>Sending a message to <code class="literal">ctRequestChannel</code> with the <code class="literal">contentType</code> header set to <code class="literal">application/json</code> will cause the
JSON converter to be selected.</p>
<p>This applies to both the outbound channel adapter and gateway.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="amqp-user-id" href="#amqp-user-id"></a>11.9&nbsp;Outbound User Id</h2></div></div></div>

<p>Spring AMQP <span class="emphasis"><em>version 1.6</em></span> introduced a mechanism to allow the specification of a default user id for outbound messages.
It has always been possible to set the <code class="literal">AmqpHeaders.USER_ID</code> header which will now take precedence over the default.
This might be useful to message recipients; for inbound messages, if the message publisher sets the property, it is made available in the <code class="literal">AmqpHeaders.RECEIVED_USER_ID</code> header.
Note that RabbitMQ <a class="ulink" href="https://www.rabbitmq.com/validated-user-id.html" target="_top">validates that the user id is the actual user id for the connection or one for which impersonation is allowed</a>.</p>
<p>To configure a default user id for outbound messages, configure it on a <code class="literal">RabbitTemplate</code> and configure the outbound adapter or gateway to use that template.
Similarly, to set the user id property on replies, inject an appropriately configured template into the inbound gateway.
See the <a class="ulink" href="http://docs.spring.io/spring-amqp/reference/html/_reference.html#template-user-id" target="_top">Spring AMQP documentation</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="amqp-delay" href="#amqp-delay"></a>11.10&nbsp;Delayed Message Exchange</h2></div></div></div>

<p>Spring AMQP supports the <a class="ulink" href="http://docs.spring.io/spring-amqp/reference/html/_reference.html#delayed-message-exchange" target="_top">RabbitMQ Delayed Message Exchange Plugin</a>.
For inbound messages, the <code class="literal">x-delay</code> header is mapped to the <code class="literal">AmqpHeaders.RECEIVED_DELAY</code> header.
Setting the <code class="literal">AMQPHeaders.DELAY</code> header will cause the corresponding <code class="literal">x-delay</code> header to be set in outbound messages.
You can also specify the <code class="literal">delay</code> and <code class="literal">delayExpression</code> properties on outbound endpoints (<code class="literal">delay-expression</code> when using XML configuration).
This takes precedence over the <code class="literal">AmqpHeaders.DELAY</code> header.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="amqp-channels" href="#amqp-channels"></a>11.11&nbsp;AMQP Backed Message Channels</h2></div></div></div>

<p>There are two Message Channel implementations available.
One is point-to-point, and the other is publish/subscribe.
Both of these channels provide a wide range of configuration attributes for the underlying AmqpTemplate and
SimpleMessageListenerContainer as you have seen on the Channel Adapters and Gateways.
However, the examples we&#8217;ll show here are going to have minimal configuration.
Explore the XML schema to view the available attributes.</p>
<p>A point-to-point channel would look like this:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-amqp:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"p2pChannel"</span><span class="hl-tag">/&gt;</span></pre>
<p>Under the covers a Queue named "si.p2pChannel" would be declared, and this channel will send to that Queue (technically by sending to the no-name Direct Exchange with a routing key that matches this Queue&#8217;s name).
This channel will also register a consumer on that Queue.
If you want the channel to be "pollable" instead of message-driven, then simply provide the "message-driven" flag with
a value of <code class="literal">false</code>:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-amqp:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"p2pPollableChannel"</span>  <span class="hl-attribute">message-driven</span>=<span class="hl-value">"false"</span><span class="hl-tag">/&gt;</span></pre>
<p>A publish/subscribe channel would look like this:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-amqp:publish-subscribe-channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"pubSubChannel"</span><span class="hl-tag">/&gt;</span></pre>
<p>Under the covers a Fanout Exchange named "si.fanout.pubSubChannel" would be declared, and this channel will send to that
Fanout Exchange.
This channel will also declare a server-named exclusive, auto-delete, non-durable Queue and bind that to the Fanout
Exchange while registering a consumer on that Queue to receive Messages.
There is no "pollable" option for a publish-subscribe-channel; it must be message-driven.</p>
<p>Starting with <span class="emphasis"><em>version 4.1</em></span> AMQP Backed Message Channels, alongside with <code class="literal">channel-transacted</code>, support
<code class="literal">template-channel-transacted</code> to separate <code class="literal">transactional</code> configuration for the <code class="literal">AbstractMessageListenerContainer</code> and
for the <code class="literal">RabbitTemplate</code>.
Note, previously, the <code class="literal">channel-transacted</code> was <code class="literal">true</code> by default, now it changed to <code class="literal">false</code> as standard default value
for the <code class="literal">AbstractMessageListenerContainer</code>.</p>
<p>Prior to <span class="emphasis"><em>version 4.3</em></span>, AMQP-backed channels only supported messages with <code class="literal">Serializable</code> payloads and headers.
The entire message was converted (serialized) and sent to RabbitMQ.
Now, you can set the <code class="literal">extract-payload</code> attribute (or <code class="literal">setExtractPayload()</code> when using Java configuration) to true.
When this flag is <code class="literal">true</code>, the message payload is converted and the headers mapped, in a similar manner to when using
channel adapters.
This allows AMQP-backed channels to be used with non-serializable payloads (perhaps with another message converter
such as the <code class="literal">Jackson2JsonMessageConverter</code>).
The default mapped headers are discussed in <a class="xref" href="#amqp-message-headers" title="11.12&nbsp;AMQP Message Headers">Section&nbsp;11.12, &#8220;AMQP Message Headers&#8221;</a>.
You can modify the mapping by providing custom mappers using the <code class="literal">outbound-header-mapper</code> and <code class="literal">inbound-header-mapper</code>
attributes.
You can now also specify a <code class="literal">default-delivery-mode</code>, used to set the delivery mode when there is no
<code class="literal">amqp_deliveryMode</code> header.
By default, Spring AMQP <code class="literal">MessageProperties</code> uses <code class="literal">PERSISTENT</code> delivery mode.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Just as with other persistence-backed channels, AMQP-backed channels are intended to provide message
persistence to avoid message loss.
They are not intended to distribute work to other peer applications; for that purpose, use channel adapters instead.</p>
</td></tr></table></div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_with_java_configuration_7" href="#_configuring_with_java_configuration_7"></a>11.11.1&nbsp;Configuring with Java Configuration</h3></div></div></div>

<p>The following provides an example of configuring the channels using Java configuration:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> AmqpChannelFactoryBean pollable(ConnectionFactory connectionFactory) {
    AmqpChannelFactoryBean factoryBean = <span class="hl-keyword">new</span> AmqpChannelFactoryBean();
    factoryBean.setConnectionFactory(connectionFactory);
    factoryBean.setQueueName(<span class="hl-string">"foo"</span>);
    factoryBean.setPubSub(false);
    <span class="hl-keyword">return</span> factoryBean;
}

<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> AmqpChannelFactoryBean messageDriven(ConnectionFactory connectionFactory) {
    AmqpChannelFactoryBean factoryBean = <span class="hl-keyword">new</span> AmqpChannelFactoryBean(true);
    factoryBean.setConnectionFactory(connectionFactory);
    factoryBean.setQueueName(<span class="hl-string">"bar"</span>);
    factoryBean.setPubSub(false);
    <span class="hl-keyword">return</span> factoryBean;
}

<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> AmqpChannelFactoryBean pubSub(ConnectionFactory connectionFactory) {
    AmqpChannelFactoryBean factoryBean = <span class="hl-keyword">new</span> AmqpChannelFactoryBean(true);
    factoryBean.setConnectionFactory(connectionFactory);
    factoryBean.setQueueName(<span class="hl-string">"baz"</span>);
    factoryBean.setPubSub(false);
    <span class="hl-keyword">return</span> factoryBean;
}</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_with_the_java_dsl_6" href="#_configuring_with_the_java_dsl_6"></a>11.11.2&nbsp;Configuring with the Java DSL</h3></div></div></div>

<p>The following provides an example of configuring the channels using the Java DSL:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> IntegrationFlow pollableInFlow(ConnectionFactory connectionFactory) {
    <span class="hl-keyword">return</span> IntegrationFlows.from(...)
            ...
            .channel(Amqp.pollableChannel(connectionFactory)
                    .queueName(<span class="hl-string">"foo"</span>))
            ...
            .get();
}

<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> IntegrationFlow messageDrivenInFow(ConnectionFactory connectionFactory) {
    <span class="hl-keyword">return</span> IntegrationFlows.from(...)
            ...
            .channel(Amqp.channel(connectionFactory)
                    .queueName(<span class="hl-string">"bar"</span>))
            ...
            .get();
}

<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> IntegrationFlow pubSubInFlow(ConnectionFactory connectionFactory) {
    <span class="hl-keyword">return</span> IntegrationFlows.from(...)
            ...
            .channel(Amqp.publisSubscribeChannel(connectionFactory)
                    .queueName(<span class="hl-string">"baz"</span>))
            ...
            .get();
}</pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="amqp-message-headers" href="#amqp-message-headers"></a>11.12&nbsp;AMQP Message Headers</h2></div></div></div>

<p>The Spring Integration AMQP Adapters will map all AMQP properties and headers automatically.
(This is a change in 4.3 - previously, only standard headers were mapped).
These properties will be copied by default to and from Spring Integration <code class="literal">MessageHeaders</code> using the
<a class="ulink" href="http://docs.spring.io/spring-integration/api/org/springframework/integration/amqp/support/DefaultAmqpHeaderMapper.html" target="_top">DefaultAmqpHeaderMapper</a>.</p>
<p>Of course, you can pass in your own implementation of AMQP specific header mappers, as the adapters have respective
properties to support that.</p>
<p>Any user-defined headers within the AMQP <a class="ulink" href="http://docs.spring.io/spring-amqp/api/org/springframework/amqp/core/MessageProperties.html" target="_top">MessageProperties</a> WILL
be copied to or from an AMQP Message, unless explicitly negated by the <span class="emphasis"><em>requestHeaderNames</em></span> and/or
<span class="emphasis"><em>replyHeaderNames</em></span> properties of the <code class="literal">DefaultAmqpHeaderMapper</code>.
For an outbound mapper, no <code class="literal">x-*</code> headers are mapped by default; see the caution below for the reason why.</p>
<p>To override the default, and revert to the pre-4.3 behavior, use <code class="literal">STANDARD_REQUEST_HEADERS</code> and
<code class="literal">STANDARD_REPLY_HEADERS</code> in the properties.</p>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>When mapping user-defined headers, the values can also contain simple wildcard patterns (e.g. "foo*" or "*foo")
to be matched.
<code class="literal">*</code> matches all headers.</p>
</td></tr></table></div>
<p>Starting with <span class="emphasis"><em>version 4.1</em></span>, the <code class="literal">AbstractHeaderMapper</code> (a <code class="literal">DefaultAmqpHeaderMapper</code> superclass) allows the
<code class="literal">NON_STANDARD_HEADERS</code> token to be configured for the <span class="emphasis"><em>requestHeaderNames</em></span> and/or <span class="emphasis"><em>replyHeaderNames</em></span> properties
(in addition to the existing <code class="literal">STANDARD_REQUEST_HEADERS</code> and <code class="literal">STANDARD_REPLY_HEADERS</code>) to map all user-defined headers.</p>
<p>Class <code class="literal">org.springframework.amqp.support.AmqpHeaders</code> identifies the default headers that will be used by the
<code class="literal">DefaultAmqpHeaderMapper</code>:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
amqp_appId
</li><li class="listitem">
amqp_clusterId
</li><li class="listitem">
amqp_contentEncoding
</li><li class="listitem">
amqp_contentLength
</li><li class="listitem">
content-type
</li><li class="listitem">
amqp_correlationId
</li><li class="listitem">
amqp_delay
</li><li class="listitem">
amqp_deliveryMode
</li><li class="listitem">
amqp_deliveryTag
</li><li class="listitem">
amqp_expiration
</li><li class="listitem">
amqp_messageCount
</li><li class="listitem">
amqp_messageId
</li><li class="listitem">
amqp_receivedDelay
</li><li class="listitem">
amqp_receivedDeliveryMode
</li><li class="listitem">
amqp_receivedExchange
</li><li class="listitem">
amqp_receivedRoutingKey
</li><li class="listitem">
amqp_redelivered
</li><li class="listitem">
amqp_replyTo
</li><li class="listitem">
amqp_timestamp
</li><li class="listitem">
amqp_type
</li><li class="listitem">
amqp_userId
</li><li class="listitem">
amqp_publishConfirm
</li><li class="listitem">
amqp_publishConfirmNackCause
</li><li class="listitem">
amqp_returnReplyCode
</li><li class="listitem">
amqp_returnReplyText
</li><li class="listitem">
amqp_returnExchange
</li><li class="listitem">
amqp_returnRoutingKey
</li></ul></div>
<div class="caution" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Caution"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Caution]" src="images/caution.png"></td><th align="left">Caution</th></tr><tr><td align="left" valign="top">
<p>As mentioned above, using a header mapping pattern <code class="literal">*</code> is a common way to copy all headers.
However, this can have some unexpected side-effects because certain RabbitMQ proprietary properties/headers will be
copied as well.
For example, when you use <a class="ulink" href="https://www.rabbitmq.com/federated-exchanges.html" target="_top">Federation</a>, the received message may have
a property named <code class="literal">x-received-from</code> which contains the node that sent the message.
If you use the wildcard character <code class="literal">*</code> for the request and reply header mapping on the Inbound Gateway, this header will
be copied as well,
which may cause some issues with federation; this reply message may be federated back to the
sending broker, which will think that a message is looping and is thus silently dropped.
If you wish to use the convenience of wildcard header mapping, you may need to filter out some headers in the
downstream flow.
For example, to avoid copying the <code class="literal">x-received-from</code> header back to the reply you can use
<code class="literal">&lt;int:header-filter ... header-names="x-received-from"&gt;</code>
before sending the reply to the AMQP Inbound Gateway.
Alternatively, you could explicitly list those properties that you actually want mapped instead of using
wildcards.
For these reasons, for inbound messages, the mapper by default does not map any <code class="literal">x-*</code> headers; it also does not map
the <code class="literal">deliveryMode</code> to <code class="literal">amqp_deliveryMode</code> header, to avoid propagation of that header from an inbound message to an
outbound message.
Instead, this header is mapped to <code class="literal">amqp_receivedDeliveryMode</code>, which is not mapped on output.</p>
</td></tr></table></div>
<p>Starting with <span class="emphasis"><em>version 4.3</em></span>, patterns in the header mappings can be negated by preceding the pattern with <code class="literal">!</code>.
Negated patterns get priority, so a list such as
<code class="literal">STANDARD_REQUEST_HEADERS,foo,ba*,!bar,!baz,qux,!foo</code> will <span class="strong"><strong>NOT</strong></span> map <code class="literal">foo</code>
(nor <code class="literal">bar</code> nor <code class="literal">baz</code>); the standard headers plus <code class="literal">bad</code>, <code class="literal">qux</code> will be mapped.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>If you have a user defined header that begins with <code class="literal">!</code> that you <span class="strong"><strong>do</strong></span> wish to map, you need to escape it with
<code class="literal">\</code> thus: <code class="literal">STANDARD_REQUEST_HEADERS,\!myBangHeader</code> and it <span class="strong"><strong>WILL</strong></span> be mapped.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_amqp_samples" href="#_amqp_samples"></a>11.13&nbsp;AMQP Samples</h2></div></div></div>

<p>To experiment with the AMQP adapters, check out the samples available in the Spring Integration Samples Git repository at:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="ulink" href="https://github.com/SpringSource/spring-integration-samples" target="_top">https://github.com/SpringSource/spring-integration-samples</a>
</li></ul></div>
<p>Currently there is one sample available that demonstrates the basic functionality of the Spring Integration AMQP Adapter using an Outbound Channel Adapter and an Inbound Channel Adapter.
As AMQP Broker implementation the sample uses RabbitMQ (<a class="ulink" href="http://www.rabbitmq.com/" target="_top">http://www.rabbitmq.com/</a>).</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>In order to run the example you will need a running instance of RabbitMQ.
A local installation with just the basic defaults will be sufficient.
For detailed RabbitMQ installation procedures please visit: <a class="ulink" href="http://www.rabbitmq.com/install.html" target="_top">http://www.rabbitmq.com/install.html</a></p>
</td></tr></table></div>
<p>Once the sample application is started, you enter some text on the command prompt and a message containing that entered text is dispatched to the AMQP queue.
In return that message is retrieved via Spring Integration and then printed to the console.</p>
<p>The image belows illustrates the basic set of Spring Integration components used in this sample.</p>
<div class="figure"><a name="d5e9845" href="#d5e9845"></a><p class="title"><b>Figure&nbsp;11.1.&nbsp;The Spring Integration graph of the AMQP sample</b></p><div class="figure-contents">

<div class="mediaobject"><img src="images/spring-integration-amqp-sample-graph.png" alt="spring integration amqp sample graph"></div>
</div></div><br class="figure-break">
</div>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="applicationevent" href="#applicationevent"></a>12.&nbsp;Spring ApplicationEvent Support</h2></div></div></div>

<p>Spring Integration provides support for inbound and outbound <code class="literal">ApplicationEvents</code> as defined by the underlying Spring Framework.
For more information about Spring&#8217;s support for events and listeners, refer to the <a class="ulink" href="http://docs.spring.io/spring/docs/current/spring-framework-reference/html/beans.html#context-functionality-events" target="_top">Spring Reference Manual</a>.</p>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="appevent-inbound" href="#appevent-inbound"></a>12.1&nbsp;Receiving Spring Application Events</h2></div></div></div>

<p>To receive events and send them to a channel, simply define an instance of Spring Integration&#8217;s <code class="literal">ApplicationEventListeningMessageProducer</code>.
This class is an implementation of Spring&#8217;s <code class="literal">ApplicationListener</code> interface.
By default it will pass all received events as Spring Integration Messages.
To limit based on the type of event, configure the list of event types that you want to receive with the <span class="emphasis"><em>eventTypes</em></span> property.
If a received event has a Message instance as its <span class="emphasis"><em>source</em></span>, then that will be passed as-is.
Otherwise, if a SpEL-based "payloadExpression" has been provided, that will be evaluated against the ApplicationEvent instance.
If the event&#8217;s source is not a Message instance and no "payloadExpression" has been provided, then the ApplicationEvent itself will be passed as the payload.</p>
<p>Starting with <span class="emphasis"><em>version 4.2</em></span> the <code class="literal">ApplicationEventListeningMessageProducer</code> implements <code class="literal">GenericApplicationListener</code>
and can be configured to accept not only <code class="literal">ApplicationEvent</code> types, but any type for treating <span class="emphasis"><em>payload events</em></span>
which are supported since Spring Framework 4.2, too.
When the accepted event is an instance of <code class="literal">PayloadApplicationEvent</code>, its <code class="literal">payload</code> is used for the message to send.</p>
<p>For convenience namespace support is provided to configure&nbsp;an <code class="literal">ApplicationEventListeningMessageProducer</code> via the <span class="emphasis"><em>inbound-channel-adapter</em></span> element.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-event:inbound-channel-adapter</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"eventChannel"</span>
                                   <span class="hl-attribute">error-channel</span>=<span class="hl-value">"eventErrorChannel"</span>
                                   <span class="hl-attribute">event-types</span>=<span class="hl-value">"example.FooEvent, example.BarEvent, java.util.Date"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int:publish-subscribe-channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"eventChannel"</span><span class="hl-tag">/&gt;</span></pre>
<p>In the above example, all Application Context events that match one of the types specified by the <span class="emphasis"><em>event-types</em></span> (optional) attribute will be delivered as Spring Integration Messages to the Message Channel named <span class="emphasis"><em>eventChannel</em></span>.
If a downstream component throws an exception, a MessagingException containing the failed message and exception will be sent to the channel named <span class="emphasis"><em>eventErrorChannel</em></span>.
If no "error-channel" is specified and the downstream channels are synchronous, the Exception will be propagated to the caller.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="appevent-outbound" href="#appevent-outbound"></a>12.2&nbsp;Sending Spring Application Events</h2></div></div></div>

<p>To send Spring <code class="literal">ApplicationEvents</code>, create an instance of the <code class="literal">ApplicationEventPublishingMessageHandler</code> and register it within an endpoint.
This implementation of the <code class="literal">MessageHandler</code> interface also implements Spring&#8217;s <code class="literal">ApplicationEventPublisherAware</code> interface and thus acts as a bridge between Spring Integration Messages and <code class="literal">ApplicationEvents</code>.</p>
<p>For convenience namespace support is provided to configure&nbsp;an <code class="literal">ApplicationEventPublishingMessageHandler</code> via the <span class="emphasis"><em>outbound-channel-adapter</em></span> element.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"eventChannel"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int-event:outbound-channel-adapter</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"eventChannel"</span><span class="hl-tag">/&gt;</span></pre>
<p>If you are using a PollableChannel (e.g., Queue), you can also provide <span class="emphasis"><em>poller</em></span> as a sub-element of the <span class="emphasis"><em>outbound-channel-adapter</em></span> element.
You can also optionally provide a <span class="emphasis"><em>task-executor</em></span> reference for that poller.
The following example demonstrates both.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"eventChannel"</span><span class="hl-tag">&gt;</span>
  <span class="hl-tag">&lt;int:queue/&gt;</span>
<span class="hl-tag">&lt;/int:channel&gt;</span>

<span class="hl-tag">&lt;int-event:outbound-channel-adapter</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"eventChannel"</span><span class="hl-tag">&gt;</span>
  <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">max-messages-per-poll</span>=<span class="hl-value">"1"</span> <span class="hl-attribute">task-executor</span>=<span class="hl-value">"executor"</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"100"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-event:outbound-channel-adapter&gt;</span>

<span class="hl-tag">&lt;task:executor</span> <span class="hl-attribute">id</span>=<span class="hl-value">"executor"</span> <span class="hl-attribute">pool-size</span>=<span class="hl-value">"5"</span><span class="hl-tag">/&gt;</span></pre>
<p>In the above example, all messages sent to the <span class="emphasis"><em>eventChannel</em></span> channel will be published as ApplicationEvents to any relevant ApplicationListener instances that are registered within the same Spring ApplicationContext.
If the payload of the Message is an ApplicationEvent, it will be passed as-is.
Otherwise the Message itself will be wrapped in a <code class="literal">MessagingEvent</code> instance.</p>
<p>Starting with <span class="emphasis"><em>version 4.2</em></span> the <code class="literal">ApplicationEventPublishingMessageHandler</code> (<code class="literal">&lt;int-event:outbound-channel-adapter&gt;</code>)
can be configured with the <code class="literal">publish-payload</code> boolean attribute to publish to the application context <code class="literal">payload</code> as is,
instead of wrapping it to a <code class="literal">MessagingEvent</code> instance.</p>
</div>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="feed" href="#feed"></a>13.&nbsp;Feed Adapter</h2></div></div></div>

<p>Spring Integration provides support for Syndication via Feed Adapters</p>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="feed-intro" href="#feed-intro"></a>13.1&nbsp;Introduction</h2></div></div></div>

<p>Web syndication is a form of publishing material such as news stories, press releases, blog posts, and other items typically available on a website but also made available in a feed format such as RSS or ATOM.</p>
<p>Spring integration provides support for Web Syndication via its <span class="emphasis"><em>feed</em></span> adapter and provides convenient namespace-based configuration for it.
To configure the <span class="emphasis"><em>feed</em></span> namespace, include the following elements within the headers of your XML configuration file:</p>
<pre class="programlisting">xmlns:int-feed="http://www.springframework.org/schema/integration/feed"
xsi:schemaLocation="http://www.springframework.org/schema/integration/feed
	http://www.springframework.org/schema/integration/feed/spring-integration-feed.xsd"</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="feed-inbound-channel-adapter" href="#feed-inbound-channel-adapter"></a>13.2&nbsp;Feed Inbound Channel Adapter</h2></div></div></div>

<p>The only adapter that is really needed to provide support for retrieving feeds is an <span class="emphasis"><em>inbound channel adapter</em></span>.
This allows you to subscribe to a particular URL.
Below is an example configuration:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-feed:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"feedAdapter"</span>
		<span class="hl-attribute">channel</span>=<span class="hl-value">"feedChannel"</span>
		<span class="hl-attribute">url</span>=<span class="hl-value">"http://feeds.bbci.co.uk/news/rss.xml"</span><span class="hl-tag">&gt;</span>
	<span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"10000"</span> <span class="hl-attribute">max-messages-per-poll</span>=<span class="hl-value">"100"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/int-feed:inbound-channel-adapter&gt;</span></pre>
<p>In the above configuration, we are subscribing to a URL identified by the <code class="literal">url</code> attribute.</p>
<p>As news items are retrieved they will be converted to Messages and sent to a channel identified by the <code class="literal">channel</code> attribute.
The payload of each message will be a <code class="literal">com.sun.syndication.feed.synd.SyndEntry</code> instance.
That encapsulates various data about a news item (content, dates, authors, etc.).</p>
<p>You can also see that the <span class="emphasis"><em>Inbound Feed Channel Adapter</em></span> is a Polling Consumer.
That means you have to provide a poller configuration.
However, one important thing you must understand with regard to Feeds is that its inner-workings are slightly different then most other poling consumers.
When an Inbound Feed adapter is started, it does the first poll and receives a <code class="literal">com.sun.syndication.feed.synd.SyndEntryFeed</code> instance.
That is an object that contains multiple <code class="literal">SyndEntry</code> objects.
Each entry is stored in the local entry queue and is released based on the value in the <code class="literal">max-messages-per-poll</code> attribute such that each Message will contain a single entry.
If during retrieval of the entries from the entry queue the queue had become empty, the adapter will attempt to update the Feed thereby populating the queue with more entries (SyndEntry instances) if available.
Otherwise the next attempt to poll for a feed will be determined by the trigger of the poller (e.g., every 10 seconds in the above configuration).</p>
<p><span class="emphasis"><em>Duplicate Entries</em></span></p>
<p>Polling for a Feed might result in entries that have already been processed ("I already read that news item, why are you showing it to me again?").
Spring Integration provides a convenient mechanism to eliminate the need to worry about duplicate entries.
Each feed entry will have a <span class="emphasis"><em>published date</em></span> field.
Every time a new Message is generated and sent, Spring Integration will store the value of the latest <span class="emphasis"><em>published date</em></span> in an instance of the <code class="literal">MetadataStore</code> strategy (<a class="xref" href="#metadata-store" title="9.5&nbsp;Metadata Store">Section&nbsp;9.5, &#8220;Metadata Store&#8221;</a>).</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The key used to persist the latest <span class="emphasis"><em>published date</em></span> is the value of the (required) <code class="literal">id</code> attribute of the Feed Inbound Channel Adapter component plus the <code class="literal">feedUrl</code> from the adapter&#8217;s configuration.</p>
</td></tr></table></div>
</div>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="files" href="#files"></a>14.&nbsp;File Support</h2></div></div></div>

<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="file-intro" href="#file-intro"></a>14.1&nbsp;Introduction</h2></div></div></div>

<p>Spring Integration&#8217;s File support extends the Spring Integration Core with a dedicated vocabulary to deal with reading, writing, and transforming files.
It provides a namespace that enables elements defining Channel Adapters dedicated to files and support for Transformers that can read file contents into strings or byte arrays.</p>
<p>This section will explain the workings of <code class="literal">FileReadingMessageSource</code> and <code class="literal">FileWritingMessageHandler</code> and how to configure them as <span class="emphasis"><em>beans</em></span>.
Also the support for dealing with files through file specific implementations of <code class="literal">Transformer</code> will be discussed.
Finally the file specific namespace will be explained.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="file-reading" href="#file-reading"></a>14.2&nbsp;Reading Files</h2></div></div></div>

<p>A <code class="literal">FileReadingMessageSource</code> can be used to consume files from the filesystem.
This is an implementation of <code class="literal">MessageSource</code> that creates messages from a file system directory.</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"pollableFileSource"</span>
    <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.file.FileReadingMessageSource"</span>
    <span class="hl-attribute">p:directory</span>=<span class="hl-value">"${input.directory}"</span><span class="hl-tag">/&gt;</span></pre>
<p>To prevent creating messages for certain files, you may supply a <code class="literal">FileListFilter</code>. By default the following 2 filters are used:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">IgnoreHiddenFileListFilter</code>
</li><li class="listitem">
<code class="literal">AcceptOnceFileListFilter</code>
</li></ul></div>
<p>The <code class="literal">IgnoreHiddenFileListFilter</code> ensures that <span class="strong"><strong>hidden</strong></span> files are not being processed.
Please keep in mind that the exact definition of <span class="strong"><strong>hidden</strong></span> is system-dependent. For example,
on <span class="emphasis"><em>UNIX</em></span>-based systems, a file beginning with a period character is considered to be hidden.
<span class="emphasis"><em>Microsoft Windows</em></span>, on the other hand, has a dedicated file attribute to indicate
hidden files.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>The <code class="literal">IgnoreHiddenFileListFilter</code> was introduced with <span class="emphasis"><em>version 4.2</em></span>. In prior versions hidden files were included.
With the default configuration, the <code class="literal">IgnoreHiddenFileListFilter</code> will be triggered first, then the <code class="literal">AcceptOnceFileListFilter</code>.</p>
</td></tr></table></div>
<p>The <code class="literal">AcceptOnceFileListFilter</code> ensures files are picked up only once from the directory.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The <code class="literal">AcceptOnceFileListFilter</code> stores its state in memory.
If you wish the state to survive a system restart, consider using the <code class="literal">FileSystemPersistentAcceptOnceFileListFilter</code> instead.
This filter stores the accepted file names in a <code class="literal">MetadataStore</code> implementation (<a class="xref" href="#metadata-store" title="9.5&nbsp;Metadata Store">Section&nbsp;9.5, &#8220;Metadata Store&#8221;</a>).
This filter matches on the filename and modified time.</p>
<p>Since <span class="emphasis"><em>version 4.0</em></span>, this filter requires a <code class="literal">ConcurrentMetadataStore</code>.
When used with a shared data store (such as <code class="literal">Redis</code> with the <code class="literal">RedisMetadataStore</code>) this allows filter keys to be shared across multiple application instances, or when a network file share is being used by multiple servers.</p>
<p>Since <span class="emphasis"><em>version 4.1.5</em></span>, this filter has a new property <code class="literal">flushOnUpdate</code> which will cause it to flush the
metadata store on every update (if the store implements <code class="literal">Flushable</code>).</p>
</td></tr></table></div>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"pollableFileSource"</span>
    <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.file.FileReadingMessageSource"</span>
    <span class="hl-attribute">p:inputDirectory</span>=<span class="hl-value">"${input.directory}"</span>
    <span class="hl-attribute">p:filter-ref</span>=<span class="hl-value">"customFilterBean"</span><span class="hl-tag">/&gt;</span></pre>
<p>A common problem with reading files is that a file may be detected before it is ready.
The default <code class="literal">AcceptOnceFileListFilter</code> does not prevent this.
In most cases, this can be prevented if the file-writing process renames each file as soon as it is ready for reading.
A filename-pattern or filename-regex filter that accepts only files that are ready (e.g.
based on a known suffix), composed with the default <code class="literal">AcceptOnceFileListFilter</code> allows for this.
The <code class="literal">CompositeFileListFilter</code> enables the composition.</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"pollableFileSource"</span>
    <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.file.FileReadingMessageSource"</span>
    <span class="hl-attribute">p:inputDirectory</span>=<span class="hl-value">"${input.directory}"</span>
    <span class="hl-attribute">p:filter-ref</span>=<span class="hl-value">"compositeFilter"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"compositeFilter"</span>
    <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.file.filters.CompositeFileListFilter"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg&gt;</span>
        <span class="hl-tag">&lt;list&gt;</span>
            <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.file.filters.AcceptOnceFileListFilter"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.file.filters.RegexPatternFileListFilter"</span><span class="hl-tag">&gt;</span>
                <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"^test.*$"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;/bean&gt;</span>
        <span class="hl-tag">&lt;/list&gt;</span>
    <span class="hl-tag">&lt;/constructor-arg&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
<p>If it is not possible to create the file with a temporary name and rename to the final name, another alternative is
provided.
The <code class="literal">LastModifiedFileListFilter</code> was added in <span class="emphasis"><em>version 4.2</em></span>.
This filter can be configured with an <code class="literal">age</code> property and only files older than this will be passed by the filter.
The age defaults to 60 seconds, but you should choose an age that is large enough to avoid picking up a file early, due
to, say, network glitches.</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"filter"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.file.filters.LastModifiedFileListFilter"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"age"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"120"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
<p>Starting with <span class="emphasis"><em>version 4.3.7</em></span> a <code class="literal">ChainFileListFilter</code> (an extension of <code class="literal">CompositeFileListFilter</code>) has been introduced to allow scenarios when subsequent filters should only see the result of the previous filter.
(With the <code class="literal">CompositeFileListFilter</code>, all filters see all the files, but only files that pass all filters are passed by the <code class="literal">CompositeFileListFilter</code>).
An example of where the new behavior is required is a combination of <code class="literal">LastModifiedFileListFilter</code> and <code class="literal">AcceptOnceFileListFilter</code>, when we do not wish to accept the file until some amount of time has elapsed.
With the <code class="literal">CompositeFileListFilter</code>, since the <code class="literal">AcceptOnceFileListFilter</code> sees all the files on the first pass, it won&#8217;t pass it later when the other filter does.
The <code class="literal">CompositeFileListFilter</code> approach is useful when a pattern filter is combined with a custom filter that looks for a secondary indicating file transfer is complete.
The pattern filter might only pass the primary file (e.g. <code class="literal">foo.txt</code>) but the "done" filter needs to see if, say <code class="literal">foo.done</code> is present.</p>
<p>Say we have files <code class="literal">a.txt</code>, <code class="literal">a.done</code>, and <code class="literal">b.txt</code>.</p>
<p>The pattern filter only passes <code class="literal">a.txt</code> and <code class="literal">b.txt</code>, the "done" filter will see all three files and only pass <code class="literal">a.txt</code>.
The final result of the composite filter is only <code class="literal">a.txt</code> is released.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>With the <code class="literal">ChainFileListFilter</code>, if any filter in the chain returns an empty list, the remaining filters are not invoked.</p>
</td></tr></table></div>
<p><span class="strong"><strong>Directory scanning and polling</strong></span></p>
<p>The <code class="literal">FileReadingMessageSource</code> doesn&#8217;t produce messages for files from the directory immediately.
It uses an internal queue for <span class="emphasis"><em>eligible files</em></span> returned by the <code class="literal">scanner</code>.
The <code class="literal">scanEachPoll</code> option is used to ensure that the internal queue is refreshed with the latest input directory
content on each poll.
By default (<code class="literal">scanEachPoll = false</code>), the <code class="literal">FileReadingMessageSource</code> empties its queue before scanning the directory
again.
This default behavior is particularly useful to reduce scans of large numbers of files in a directory.
However, in cases where custom ordering is required, it is important to consider the effects of setting this flag to
<code class="literal">true</code>; the order in which files are processed may not be as expected.
By default, files in the queue are processed in their natural (<code class="literal">path</code>) order.
New files added by a scan, even when the queue already has files, are inserted in the appropriate position to maintain
that natural order.
To customize the order, the <code class="literal">FileReadingMessageSource</code> can accept a <code class="literal">Comparator&lt;File&gt;</code> as a constructor argument.
It is used by the internal (<code class="literal">PriorityBlockingQueue</code>) to reorder its content according to the business requirements.
Therefore, to process files in a specific order, you should provide a comparator to the <code class="literal">FileReadingMessageSource</code>,
rather than ordering the list produced by a custom <code class="literal">DirectoryScanner</code>.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="file-namespace-support" href="#file-namespace-support"></a>14.2.1&nbsp;Namespace Support</h3></div></div></div>

<p>The configuration for file reading can be simplified using the file specific namespace.
To do this use the following template.</p>
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
  <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
  <span class="hl-attribute">xmlns:int</span>=<span class="hl-value">"http://www.springframework.org/schema/integration"</span>
  <span class="hl-attribute">xmlns:int-file</span>=<span class="hl-value">"http://www.springframework.org/schema/integration/file"</span>
  <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"http://www.springframework.org/schema/beans
    http://www.springframework.org/schema/beans/spring-beans.xsd
    http://www.springframework.org/schema/integration
    http://www.springframework.org/schema/integration/spring-integration.xsd
    http://www.springframework.org/schema/integration/file
    http://www.springframework.org/schema/integration/file/spring-integration-file.xsd"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;/beans&gt;</span></pre>
<p>Within this namespace you can reduce the <code class="literal">FileReadingMessageSource</code> and wrap it in an inbound Channel Adapter like this:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-file:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"filesIn1"</span>
    <span class="hl-attribute">directory</span>=<span class="hl-value">"file:${input.directory}"</span> <span class="hl-attribute">prevent-duplicates</span>=<span class="hl-value">"true"</span> <span class="hl-attribute">ignore-hidden</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int-file:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"filesIn2"</span>
    <span class="hl-attribute">directory</span>=<span class="hl-value">"file:${input.directory}"</span>
    <span class="hl-attribute">filter</span>=<span class="hl-value">"customFilterBean"</span><span class="hl-tag"> /&gt;</span>

<span class="hl-tag">&lt;int-file:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"filesIn3"</span>
    <span class="hl-attribute">directory</span>=<span class="hl-value">"file:${input.directory}"</span>
    <span class="hl-attribute">filename-pattern</span>=<span class="hl-value">"test*"</span><span class="hl-tag"> /&gt;</span>

<span class="hl-tag">&lt;int-file:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"filesIn4"</span>
    <span class="hl-attribute">directory</span>=<span class="hl-value">"file:${input.directory}"</span>
    <span class="hl-attribute">filename-regex</span>=<span class="hl-value">"test[0-9]+\.txt"</span><span class="hl-tag"> /&gt;</span></pre>
<p>The first channel adapter example is relying on the default <code class="literal">FileListFilter</code> s:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">IgnoreHiddenFileListFilter</code> (Do not process hidden files)
</li><li class="listitem">
<code class="literal">AcceptOnceFileListFilter</code> (Prevents duplication)
</li></ul></div>
<p>Therefore, you can also leave off the 2 attributes <code class="literal">prevent-duplicates</code> and <code class="literal">ignore-hidden</code> as they are <code class="literal">true</code> by default.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>The <code class="literal">ignore-hidden</code> attribute was introduced with <span class="emphasis"><em>Spring Integration 4.2</em></span>. In prior versions hidden files were included.</p>
</td></tr></table></div>
<p>The second channel adapter example is using a custom filter, the third is using the <span class="emphasis"><em>filename-pattern</em></span> attribute to
add an <code class="literal">AntPathMatcher</code> based filter, and the fourth is using the <span class="emphasis"><em>filename-regex</em></span> attribute to add a regular expression Pattern based filter to the <code class="literal">FileReadingMessageSource</code>.
The <span class="emphasis"><em>filename-pattern</em></span> and <span class="emphasis"><em>filename-regex</em></span> attributes are each mutually exclusive with the regular <span class="emphasis"><em>filter</em></span> reference attribute.
However, you can use the <span class="emphasis"><em>filter</em></span> attribute to reference an instance of <code class="literal">CompositeFileListFilter</code> that combines any number of filters, including one or more pattern based filters to fit your particular needs.</p>
<p>When multiple processes are reading from the same directory it can be desirable to lock files to prevent them from being picked up concurrently.
To do this you can use a <code class="literal">FileLocker</code>.
There is a java.nio based implementation available out of the box, but it is also possible to implement your own locking scheme.
The nio locker can be injected as follows</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-file:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"filesIn"</span>
    <span class="hl-attribute">directory</span>=<span class="hl-value">"file:${input.directory}"</span> <span class="hl-attribute">prevent-duplicates</span>=<span class="hl-value">"true"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int-file:nio-locker/&gt;</span>
<span class="hl-tag">&lt;/int-file:inbound-channel-adapter&gt;</span></pre>
<p>A custom locker you can configure like this:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-file:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"filesIn"</span>
    <span class="hl-attribute">directory</span>=<span class="hl-value">"file:${input.directory}"</span> <span class="hl-attribute">prevent-duplicates</span>=<span class="hl-value">"true"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int-file:locker</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"customLocker"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-file:inbound-channel-adapter&gt;</span></pre>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>When a file inbound adapter is configured with a locker, it will take the responsibility to acquire a lock before the file is allowed to be received.
<span class="strong"><strong>It will not assume the responsibility to unlock the file.</strong></span> If you have processed the file and keeping the locks hanging around you have a memory leak.
If this is a problem in your case you should call <code class="literal">FileLocker.unlock(File file)</code> yourself at the appropriate time.</p>
</td></tr></table></div>
<p>When filtering and locking files is not enough it might be needed to control the way files are listed entirely.
To implement this type of requirement you can use an implementation of <code class="literal">DirectoryScanner</code>.
This scanner allows you to determine entirely what files are listed each poll.
This is also the interface that Spring Integration uses internally to wire <code class="literal">FileListFilter</code> s and <code class="literal">FileLocker</code> to the <code class="literal">FileReadingMessageSource</code>.
A custom <code class="literal">DirectoryScanner</code> can be injected into the <code class="literal">&lt;int-file:inbound-channel-adapter/&gt;</code> on the <code class="literal">scanner</code> attribute.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-file:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"filesIn"</span> <span class="hl-attribute">directory</span>=<span class="hl-value">"file:${input.directory}"</span>
     <span class="hl-attribute">scanner</span>=<span class="hl-value">"customDirectoryScanner"</span><span class="hl-tag">/&gt;</span></pre>
<p>This gives you full freedom to choose the ordering, listing and locking strategies.</p>
<p>It is also important to understand that filters (including <code class="literal">patterns</code>, <code class="literal">regex</code>, <code class="literal">prevent-duplicates</code> etc) and <code class="literal">locker</code> s,
are actually used by the <code class="literal">scanner</code>.
Any of these attributes set on the adapter are subsequently injected into the internal <code class="literal">scanner</code>.
For the case of an external <code class="literal">scanner</code>, all filter and locker attributes are prohibited on the
<code class="literal">FileReadingMessageSource</code>; they must be specified (if required) on that custom <code class="literal">DirectoryScanner</code>.
In other words, if you inject a <code class="literal">scanner</code> into the <code class="literal">FileReadingMessageSource</code>, you should supply <code class="literal">filter</code> and <code class="literal">locker</code>
on that <code class="literal">scanner</code> not on the <code class="literal">FileReadingMessageSource</code>.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The <code class="literal">DefaultDirectoryScanner</code> uses a <code class="literal">IgnoreHiddenFileListFilter</code> and <code class="literal">AcceptOnceFileListFilter</code> by default.
To prevent their use, you should configure your own filter (e.g. <code class="literal">AcceptAllFileListFilter</code>) or even set it to <code class="literal">null</code>.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="watch-service-directory-scanner" href="#watch-service-directory-scanner"></a>14.2.2&nbsp;WatchServiceDirectoryScanner</h3></div></div></div>

<p>This scanner was added in <span class="emphasis"><em>version 4.2</em></span>. It replaces the existing <code class="literal">RecursiveLeafOnlyDirectoryScanner</code> which is
inefficient for large directory trees.
The <code class="literal">FileReadingMessageSource.WatchServiceDirectoryScanner</code> requires Java 7 or above.</p>
<p>This scanner relies on file system events when new files are added to the directory.
During initialization, the directory is registered to generate events; the initial file list is also built.
While walking the directory tree, any subdirectories encountered are also registered to generate events.
On the first poll, the initial file list from walking the directory is returned.
On subsequent polls, files from new creation events are returned.
If a new subdirectory is added, its creation event is used to walk the new subtree to find existing files, as well
as registering any new subdirectories found.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>There is a case with <code class="literal">WatchKey</code>, when its internal events <code class="literal">queue</code> isn&#8217;t drained by the program as quickly as
the directory modification events occur.
If the queue size is exceeded, a <code class="literal">StandardWatchEventKinds.OVERFLOW</code> is emitted to indicate that
some file system events may be lost.
In this case, the root directory is re-scanned completely.
To avoid duplicates consider using an appropriate <code class="literal">FileListFilter</code> such as the <code class="literal">AcceptOnceFileListFilter</code> and/or
remove files when processing is completed.</p>
</td></tr></table></div>
<p>Since <span class="emphasis"><em>version 4.3</em></span>, the top level <code class="literal">WatchServiceDirectoryScanner</code> has been deprecated in favor of
<code class="literal">FileReadingMessageSource</code> internal logic for the <code class="literal">WatchService</code>.
Now this can be enable via <code class="literal">use-watch-service</code> option, which is mutually exclusive with the <code class="literal">scanner</code> option.
An internal <code class="literal">FileReadingMessageSource.WatchServiceDirectoryScanner</code> instance is populated for the provided <code class="literal">directory</code>.</p>
<p>In addition, now the <code class="literal">WatchService</code> polling logic can track the <code class="literal">StandardWatchEventKinds.ENTRY_MODIFY</code> and
<code class="literal">StandardWatchEventKinds.ENTRY_DELETE</code>, too.</p>
<p>The <code class="literal">ENTRY_MODIFY</code> events logic should be implemented properly in the <code class="literal">FileListFilter</code> to track not only new files but
also the modification, if that is requirement.
Otherwise the files from those events are treated the same way.</p>
<p>The <code class="literal">ENTRY_DELETE</code> events have effect for the <code class="literal">ResettableFileListFilter</code> implementations and, therefore, their files
are provided for the <code class="literal">remove()</code> operation.
This means that (when this event is enabled), filters such as the <code class="literal">AcceptOnceFileListFilter</code> will have the file removed,
meaning that, if a file with the same name appears, it will pass the filter and be sent as a message.</p>
<p>For this purpose the <code class="literal">watch-events</code>
(<code class="literal">FileReadingMessageSource.setWatchEvents(WatchEventType... watchEvents)</code>) has been introduced
(<code class="literal">WatchEventType</code> is a public inner enum in <code class="literal">FileReadingMessageSource</code>).
With such an option we can implement some scenarios, when we would like to do one downstream flow logic for new files,
and other for modified.
We can achieve that with different <code class="literal">&lt;int-file:inbound-channel-adapter&gt;</code> definitions, but for the same directory:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-file:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"newFiles"</span>
     <span class="hl-attribute">directory</span>=<span class="hl-value">"${input.directory}"</span>
     <span class="hl-attribute">use-watch-service</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int-file:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"modifiedFiles"</span>
     <span class="hl-attribute">directory</span>=<span class="hl-value">"${input.directory}"</span>
     <span class="hl-attribute">use-watch-service</span>=<span class="hl-value">"true"</span>
     <span class="hl-attribute">filter</span>=<span class="hl-value">"acceptAllFilter"</span>
     <span class="hl-attribute">watch-events</span>=<span class="hl-value">"MODIFY"</span><span class="hl-tag">/&gt;</span> <span class="hl-comment">&lt;!-- CREATE by default --&gt;</span></pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_limiting_memory_consumption" href="#_limiting_memory_consumption"></a>14.2.3&nbsp;Limiting Memory Consumption</h3></div></div></div>

<p>A <code class="literal">HeadDirectoryScanner</code> can be used to limit the number of files retained in memory.
This can be useful when scanning large directories.
With XML configuration, this is enabled using the <code class="literal">queue-size</code> property on the inbound channel adapter.</p>
<p>Prior to <span class="emphasis"><em>version 4.2</em></span>, this setting was incompatible with the use of any other filters.
Any other filters (including <code class="literal">prevent-duplicates="true"</code>) overwrote the filter used to limit the size.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The use of a <code class="literal">HeadDirectoryScanner</code> is incompatible with an <code class="literal">AcceptOnceFileListFilter</code>.
Since all filters are consulted during the poll decision, the <code class="literal">AcceptOnceFileListFilter</code> does not know
that other filters might be temporarily filtering files.
Even if files that were previously filtered by the <code class="literal">HeadDirectoryScanner.HeadFilter</code> are now available, the
<code class="literal">AcceptOnceFileListFilter</code> will filter them.</p>
<p>Generally, instead of using an <code class="literal">AcceptOnceFileListFilter</code> in this case, one would simply remove the processed
files so that the previously filtered files will be available on a future poll.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_with_java_configuration_8" href="#_configuring_with_java_configuration_8"></a>14.2.4&nbsp;Configuring with Java Configuration</h3></div></div></div>

<p>The following Spring Boot application provides an example of configuring the inbound adapter using Java configuration:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@SpringBootApplication</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> FileReadingJavaApplication {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
        <span class="hl-keyword">new</span> SpringApplicationBuilder(FileReadingJavaApplication.<span class="hl-keyword">class</span>)
            .web(false)
            .run(args);
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> MessageChannel fileInputChannel() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> DirectChannel();
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <em><span class="hl-annotation" style="color: gray">@InboundChannelAdapter(value = "fileInputChannel", poller = @Poller(fixedDelay = "1000"))</span></em>
    <span class="hl-keyword">public</span> MessageSource&lt;File&gt; fileReadingMessageSource() {
         FileReadingMessageSource source = <span class="hl-keyword">new</span> FileReadingMessageSource();
         source.setDirectory(<span class="hl-keyword">new</span> File(INBOUND_PATH));
         source.setFilter(<span class="hl-keyword">new</span> SimplePatternFileListFilter(<span class="hl-string">"*.txt"</span>));
         <span class="hl-keyword">return</span> source;
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <em><span class="hl-annotation" style="color: gray">@Transformer(inputChannel = "fileInputChannel", outputChannel = "processFileChannel")</span></em>
    <span class="hl-keyword">public</span> FileToStringTransformer fileToStringTransformer() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> FileToStringTransformer();
    }

}</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_with_the_java_dsl_7" href="#_configuring_with_the_java_dsl_7"></a>14.2.5&nbsp;Configuring with the Java DSL</h3></div></div></div>

<p>The following Spring Boot application provides an example of configuring the inbound adapter using the Java DSL:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@SpringBootApplication</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> FileReadingJavaApplication {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
        <span class="hl-keyword">new</span> SpringApplicationBuilder(FileReadingJavaApplication.<span class="hl-keyword">class</span>)
            .web(false)
            .run(args);
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> IntegrationFlow fileReadingFlow() {
         <span class="hl-keyword">return</span> IntegrationFlows
                  .from(s -&gt; s.file(<span class="hl-keyword">new</span> File(INBOUND_PATH))
                              .patternFilter(<span class="hl-string">"*.txt"</span>),
                          e -&gt; e.poller(Pollers.fixedDelay(<span class="hl-number">1000</span>)))
                  .transform(Transformers.fileToString())
                  .channel(<span class="hl-string">"processFileChannel"</span>)
                  .get();
        }

}</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="file-tailing" href="#file-tailing"></a>14.2.6&nbsp;'Tail&#8217;ing Files</h3></div></div></div>

<p>Another popular use case is to get <span class="emphasis"><em>lines</em></span> from the end (or tail) of a file, capturing new lines when they are added.
Two implementations are provided; the first, <code class="literal">OSDelegatingFileTailingMessageProducer</code>, uses the native <code class="literal">tail</code> command (on operating systems that have one).
This is likely the most efficient implementation on those platforms.
For operating systems that do not have a <code class="literal">tail</code> command, the second implementation <code class="literal">ApacheCommonsFileTailingMessageProducer</code>
which uses the Apache <code class="literal">commons-io</code> <code class="literal">Tailer</code> class.</p>
<p>In both cases, file system events, such as files being unavailable etc, are published as <code class="literal">ApplicationEvent</code> s using the normal Spring event publishing mechanism.
Examples of such events are:</p>
<p><code class="literal">[message=tail: cannot open `/tmp/foo' for reading:
               No such file or directory, file=/tmp/foo]</code></p>
<p><code class="literal">[message=tail: `/tmp/foo' has become accessible, file=/tmp/foo]</code></p>
<p><code class="literal">[message=tail: `/tmp/foo' has become inaccessible:
               No such file or directory, file=/tmp/foo]</code></p>
<p><code class="literal">[message=tail: `/tmp/foo' has appeared;
               following end of new file, file=/tmp/foo]</code></p>
<p>This sequence of events might occur, for example, when a file is rotated.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Not all platforms supporting a <code class="literal">tail</code> command provide these status messages.</p>
</td></tr></table></div>
<p>Example configurations:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-file:tail-inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"native"</span>
	<span class="hl-attribute">channel</span>=<span class="hl-value">"input"</span>
	<span class="hl-attribute">task-executor</span>=<span class="hl-value">"exec"</span>
	<span class="hl-attribute">file</span>=<span class="hl-value">"/tmp/foo"</span><span class="hl-tag">/&gt;</span></pre>
<p>This creates a native adapter with default <span class="emphasis"><em>-F -n 0</em></span> options (follow the file name from the current end).</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-file:tail-inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"native"</span>
	<span class="hl-attribute">channel</span>=<span class="hl-value">"input"</span>
	<span class="hl-attribute">native-options</span>=<span class="hl-value">"-F -n +0"</span>
	<span class="hl-attribute">task-executor</span>=<span class="hl-value">"exec"</span>
	<span class="hl-attribute">file-delay</span>=<span class="hl-value">10000</span>
	<span class="hl-attribute">file</span>=<span class="hl-value">"/tmp/foo"</span><span class="hl-tag">/&gt;</span></pre>
<p>This creates a native adapter with <span class="emphasis"><em>-F -n +0</em></span> options (follow the file name, emitting all existing lines).
If the tail command fails (on some platforms, a missing file causes the <code class="literal">tail</code> to fail, even with <code class="literal">-F</code> specified), the command will be retried every 10 seconds.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-file:tail-inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"native"</span>
	<span class="hl-attribute">channel</span>=<span class="hl-value">"input"</span>
	<span class="hl-attribute">enable-status-reader</span>=<span class="hl-value">"false"</span>
	<span class="hl-attribute">task-executor</span>=<span class="hl-value">"exec"</span>
	<span class="hl-attribute">file</span>=<span class="hl-value">"/tmp/foo"</span><span class="hl-tag">/&gt;</span></pre>
<p>By default native adapter capture from standard output and send them as messages and from standard error to raise events.
Starting with <span class="emphasis"><em>version 4.3.6</em></span>, you can discard the standard error events by setting the <code class="literal">enable-status-reader</code> to <code class="literal">false</code>.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-file:tail-inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"apache"</span>
	<span class="hl-attribute">channel</span>=<span class="hl-value">"input"</span>
	<span class="hl-attribute">task-executor</span>=<span class="hl-value">"exec"</span>
	<span class="hl-attribute">file</span>=<span class="hl-value">"/tmp/bar"</span>
	<span class="hl-attribute">delay</span>=<span class="hl-value">"2000"</span>
	<span class="hl-attribute">end</span>=<span class="hl-value">"false"</span>
	<span class="hl-attribute">reopen</span>=<span class="hl-value">"true"</span>
	<span class="hl-attribute">file-delay</span>=<span class="hl-value">"10000"</span><span class="hl-tag">/&gt;</span></pre>
<p>This creates an Apache commons-io <code class="literal">Tailer</code> adapter that examines the file for new lines every 2 seconds, and checks for existence of a missing file every 10 seconds.
The file will be tailed from the beginning (<code class="literal">end="false"</code>) instead of the end (which is the default).
The file will be reopened for each chunk (the default is to keep the file open).</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Specifying the <code class="literal">delay</code>, <code class="literal">end</code> or <code class="literal">reopen</code> attributes, forces the use of the Apache commons-io adapter and the <code class="literal">native-options</code> attribute is not allowed.</p>
</td></tr></table></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="file-writing" href="#file-writing"></a>14.3&nbsp;Writing files</h2></div></div></div>

<p>To write messages to the file system you can use a <a class="ulink" href="http://docs.spring.io/spring-integration/api/org/springframework/integration/file/FileWritingMessageHandler.html" target="_top">FileWritingMessageHandler</a>.
This class can deal with the following payload types:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="emphasis"><em>File</em></span>,
</li><li class="listitem">
<span class="emphasis"><em>String</em></span>
</li><li class="listitem">
<span class="emphasis"><em>byte array</em></span>
</li><li class="listitem">
<span class="emphasis"><em>InputStream</em></span> (since <span class="emphasis"><em>version 4.2</em></span>)
</li></ul></div>
<p>You can configure the encoding and the charset that will be used in case of a String payload.</p>
<p>To make things easier, you can configure the <code class="literal">FileWritingMessageHandler</code> as part of an <span class="emphasis"><em>Outbound Channel Adapter</em></span> or
<span class="emphasis"><em>Outbound Gateway</em></span> using the provided XML namespace support.</p>
<p>Starting with <span class="emphasis"><em>version 4.3</em></span>, you can specify the buffer size to use when writing files.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="file-writing-file-names" href="#file-writing-file-names"></a>14.3.1&nbsp;Generating File Names</h3></div></div></div>

<p>In its simplest form, the <code class="literal">FileWritingMessageHandler</code> only requires a destination directory for writing the files.
The name of the file to be written is determined by the handler&#8217;s <a class="ulink" href="http://docs.spring.io/spring-integration/api/org/springframework/integration/file/FileNameGenerator.html" target="_top">FileNameGenerator</a>.
The <a class="ulink" href="http://docs.spring.io/spring-integration/api/org/springframework/integration/file/DefaultFileNameGenerator.html" target="_top">default implementation</a> looks for a Message header whose key matches the constant defined as <a class="ulink" href="http://docs.spring.io/spring-integration/api/constant-values.html#org.springframework.integration.file.FileHeaders.FILENAME" target="_top">FileHeaders.FILENAME</a>.</p>
<p>Alternatively, you can specify an expression to be evaluated against the Message in order to generate a file name, e.g. <span class="emphasis"><em>headers[<span class="emphasis"><em>myCustomHeader</em></span>] + '.foo'</em></span>.
The expression must evaluate to a <code class="literal">String</code>.
For convenience, the <code class="literal">DefaultFileNameGenerator</code> also provides the <span class="emphasis"><em>setHeaderName</em></span> method, allowing you to explicitly specify the Message header whose value shall be used as the filename.</p>
<p>Once setup, the <code class="literal">DefaultFileNameGenerator</code> will employ the following resolution steps to determine the filename for a given Message payload:</p>
<div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
Evaluate the expression against the Message and, if the result is a non-empty <code class="literal">String</code>, use it as the filename.
</li><li class="listitem">
Otherwise, if the payload is a <code class="literal">java.io.File</code>, use the file&#8217;s filename.
</li><li class="listitem">
Otherwise, use the Message ID appended with .<code class="literal">msg</code> as the filename.
</li></ol></div>
<p>When using the XML namespace support, both, the <span class="emphasis"><em>File Outbound Channel Adapter</em></span> and the <span class="emphasis"><em>File Outbound Gateway</em></span> support the following two mutually exclusive configuration attributes:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">filename-generator</code> (a reference to a <code class="literal">FileNameGenerator</code> implementation)
</li><li class="listitem">
<code class="literal">filename-generator-expression</code> (an expression evaluating to a <code class="literal">String</code>)
</li></ul></div>
<p>While writing files, a temporary file suffix will be used (default: <code class="literal">.writing</code>).
It is appended to the filename while the file is being written.
To customize the suffix, you can set the <span class="emphasis"><em>temporary-file-suffix</em></span> attribute on both the <span class="emphasis"><em>File Outbound Channel Adapter</em></span> and the <span class="emphasis"><em>File Outbound Gateway</em></span>.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>When using the <span class="emphasis"><em>APPEND</em></span> file <span class="emphasis"><em>mode</em></span>, the <span class="emphasis"><em>temporary-file-suffix</em></span> attribute is ignored, since the data is appended to the file directly.</p>
</td></tr></table></div>
<p>Starting with <span class="emphasis"><em>version 4.2.5</em></span> the generated file name (as a result of <code class="literal">filename-generator</code>/<code class="literal">filename-generator-expression</code>
evaluation) can represent a <span class="emphasis"><em>sub-path</em></span> together with the target file name.
It is used as a second constructor argument for <code class="literal">File(File parent, String child)</code> as before, but in the past we didn&#8217;t
created (<code class="literal">mkdirs()</code>) directories for <span class="emphasis"><em>sub-path</em></span> assuming only the <span class="emphasis"><em>file name</em></span>.
This approach is useful for cases when we need to restore the file system tree according the source directory.
For example we unzipping the archive and want to save all file in the target directory at the same order.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="file-writing-output-directory" href="#file-writing-output-directory"></a>14.3.2&nbsp;Specifying the Output Directory</h3></div></div></div>

<p>Both, the <span class="emphasis"><em>File Outbound Channel Adapter</em></span> and the <span class="emphasis"><em>File Outbound Gateway</em></span> provide two configuration attributes for specifying the output directory:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="emphasis"><em>directory</em></span>
</li><li class="listitem">
<span class="emphasis"><em>directory-expression</em></span>
</li></ul></div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The <span class="emphasis"><em>directory-expression</em></span> attribute is available since Spring Integration 2.2.</p>
</td></tr></table></div>
<p><span class="strong"><strong>Using the directory attribute</strong></span></p>
<p>When using the <span class="emphasis"><em>directory</em></span> attribute, the output directory will be set to a fixed value, that is set at initialization time of the <code class="literal">FileWritingMessageHandler</code>.
If you don&#8217;t specify this attribute, then you must use the <span class="emphasis"><em>directory-expression</em></span> attribute.</p>
<p><span class="strong"><strong>Using the directory-expression attribute</strong></span></p>
<p>If you want to have full SpEL support you would choose the <span class="emphasis"><em>directory-expression</em></span> attribute.
This attribute accepts a SpEL expression that is evaluated for each message being processed.
Thus, you have full access to a Message&#8217;s payload and its headers to dynamically specify the output file directory.</p>
<p>The SpEL expression must resolve to either a <code class="literal">String</code> or to <code class="literal">java.io.File</code>.
Furthermore the resulting <code class="literal">String</code> or <code class="literal">File</code> must point to a directory.
If you don&#8217;t specify the <span class="emphasis"><em>directory-expression</em></span> attribute, then you must set the <span class="emphasis"><em>directory</em></span> attribute.</p>
<p><span class="strong"><strong>Using the auto-create-directory attribute</strong></span></p>
<p>If the destination directory does not exists, yet, by default the respective destination directory and any non-existing parent directories are being created automatically.
You can set the <span class="emphasis"><em>auto-create-directory</em></span> attribute to <span class="emphasis"><em>false</em></span> in order to prevent that.
This attribute applies to both, the <span class="emphasis"><em>directory</em></span> and the <span class="emphasis"><em>directory-expression</em></span> attribute.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>When using the <span class="emphasis"><em>directory</em></span> attribute and <span class="emphasis"><em>auto-create-directory</em></span> is <code class="literal">false</code>, the following change was made starting with Spring Integration 2.2:</p>
<p>Instead of checking for the existence of the destination directory at initialization time of the adapter, this check is now performed for each message being processed.</p>
<p>Furthermore, if <span class="emphasis"><em>auto-create-directory</em></span> is <code class="literal">true</code> and the directory was deleted between the processing of messages, the directory will be re-created for each message being processed.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="file-writing-destination-exists" href="#file-writing-destination-exists"></a>14.3.3&nbsp;Dealing with Existing Destination Files</h3></div></div></div>

<p>When writing files and the destination file already exists, the default behavior is to overwrite that target file.
This behavior, though, can be changed by setting the <span class="emphasis"><em>mode</em></span> attribute on the respective File Outbound components.
The following options exist:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
REPLACE (Default)
</li><li class="listitem">
APPEND
</li><li class="listitem">
APPEND_NO_FLUSH
</li><li class="listitem">
FAIL
</li><li class="listitem">
IGNORE
</li></ul></div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The <span class="emphasis"><em>mode</em></span> attribute and the options <span class="emphasis"><em>APPEND</em></span>, <span class="emphasis"><em>FAIL</em></span> and <span class="emphasis"><em>IGNORE</em></span>, are available since <span class="emphasis"><em>Spring Integration 2.2</em></span>.</p>
</td></tr></table></div>
<p><span class="emphasis"><em>REPLACE</em></span></p>
<p>If the target file already exists, it will be overwritten.
If the <span class="emphasis"><em>mode</em></span> attribute is not specified, then this is the default behavior when writing files.</p>
<p><span class="emphasis"><em>APPEND</em></span></p>
<p>This mode allows you to append Message content to the existing file instead of creating a new file each time.
Note that this attribute is mutually exclusive with <span class="emphasis"><em>temporary-file-suffix</em></span> attribute since when appending content to
the existing file, the adapter no longer uses a temporary file.
The file is closed after each message.</p>
<p><span class="emphasis"><em>APPEND_NO_FLUSH</em></span></p>
<p>This has the same semantics as <span class="strong"><strong>APPEND</strong></span> but the data is not flushed and the file is not closed after each message.
This can provide a significant performance at the risk of data loss in the case of a failure.
See <a class="xref" href="#file-flushing" title="14.3.4&nbsp;Flushing Files When using APPEND_NO_FLUSH">Section&nbsp;14.3.4, &#8220;Flushing Files When using APPEND_NO_FLUSH&#8221;</a> for more information.</p>
<p><span class="emphasis"><em>FAIL</em></span></p>
<p>If the target file exists, a <a class="ulink" href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/messaging/MessageHandlingException.html" target="_top">MessageHandlingException</a> is thrown.</p>
<p><span class="emphasis"><em>IGNORE</em></span></p>
<p>If the target file exists, the message payload is silently ignored.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>When using a temporary file suffix (default: <code class="literal">.writing</code>), the <span class="emphasis"><em>IGNORE</em></span> mode will apply if the final file name exists, or the temporary file name exists.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="file-flushing" href="#file-flushing"></a>14.3.4&nbsp;Flushing Files When using APPEND_NO_FLUSH</h3></div></div></div>

<p>The <span class="strong"><strong>APPEND_NO_FLUSH</strong></span> mode was added in <span class="emphasis"><em>version 4.3</em></span>.
This can improve performance because the file is not closed after each message.
However, this can cause data loss in the event of a failure.</p>
<p>Several flushing strategies, to mitigate this data loss, are provided:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">flushInterval</code> - if a file is not written to for this period of time, it is automatically flushed.
This is approximate and may be up to <code class="literal">1.33x</code> this time.
</li><li class="listitem">
Send a message to the message handler&#8217;s <code class="literal">trigger</code> method containing a regular expression.
Files with absolute path names matching the pattern will be flushed.
</li><li class="listitem">
Provide the handler with a custom <code class="literal">MessageFlushPredicate</code> implementation to modify the action taken when a message
is sent to the <code class="literal">trigger</code> method.
</li><li class="listitem">
Invoke one of the handler&#8217;s <code class="literal">flushIfNeeded</code> methods passing in a custom <code class="literal">FileWritingMessageHandler.FlushPredicate</code>
or <code class="literal">FileWritingMessageHandler.MessageFlushPredicate</code> implementation.
</li></ul></div>
<p>The predicates are called for each open file.
See the java docs for these interfaces for more information.</p>
<p>When using <code class="literal">flushInterval</code>, the interval starts at the last write - the file is flushed only if it is idle for the interval.
Starting with <span class="emphasis"><em>version 4.3.7</em></span>, and additional property <code class="literal">flushWhenIdle</code> can be set to <code class="literal">false</code>, meaning that the interval starts with the first write to a previously flushed (or new) file.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="file-timestamps" href="#file-timestamps"></a>14.3.5&nbsp;File Timestamps</h3></div></div></div>

<p>By default, the destination file <code class="literal">lastModified</code> timestamp will be the time the file was created (except a rename
in-place will retain the current timestamp).
Starting with <span class="emphasis"><em>version 4.3</em></span>, you can now configure <code class="literal">preserve-timestamp</code> (or <code class="literal">setPreserveTimestamp(true)</code> when using
Java configuration).
For <code class="literal">File</code> payloads, this will transfer the timestamp from the inbound file to the outbound (regardless of whether a
copy was required).
For other payloads, if the <code class="literal">FileHeaders.SET_MODIFIED</code> header (<code class="literal">file_setModified</code>) is present, it will be used to set
the destination file&#8217;s <code class="literal">lastModified</code> timestamp, as long as the header is a <code class="literal">Number</code>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="file-outbound-channel-adapter" href="#file-outbound-channel-adapter"></a>14.3.6&nbsp;File Outbound Channel Adapter</h3></div></div></div>

<pre class="programlisting"><span class="hl-tag">&lt;int-file:outbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"filesOut"</span> <span class="hl-attribute">directory</span>=<span class="hl-value">"${input.directory.property}"</span><span class="hl-tag">/&gt;</span></pre>
<p>The namespace based configuration also supports a <code class="literal">delete-source-files</code> attribute.
If set to <code class="literal">true</code>, it will trigger the deletion of the original source files after writing to a destination.
The default value for that flag is <code class="literal">false</code>.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-file:outbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"filesOut"</span>
    <span class="hl-attribute">directory</span>=<span class="hl-value">"${output.directory}"</span>
    <span class="hl-attribute">delete-source-files</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span></pre>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The <code class="literal">delete-source-files</code> attribute will only have an effect if the inbound Message has a File payload or if the <code class="literal">FileHeaders.ORIGINAL_FILE</code> header value contains either the source File instance or a String representing the original file path.</p>
</td></tr></table></div>
<p>Starting with <span class="emphasis"><em>version 4.2</em></span> The <code class="literal">FileWritingMessageHandler</code> supports an <code class="literal">append-new-line</code> option.
If set to <code class="literal">true</code>, a new line is appended to the file after a message is written.
The default attribute value is <code class="literal">false</code>.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-file:outbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"newlineAdapter"</span>
	<span class="hl-attribute">append-new-line</span>=<span class="hl-value">"true"</span>
    <span class="hl-attribute">directory</span>=<span class="hl-value">"${output.directory}"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="file-writing-output-gateway" href="#file-writing-output-gateway"></a>14.3.7&nbsp;Outbound Gateway</h3></div></div></div>

<p>In cases where you want to continue processing messages based on the written file, you can use the <code class="literal">outbound-gateway</code> instead.
It plays a very similar role as the <code class="literal">outbound-channel-adapter</code>.
However, after writing the file, it will also send it to the reply channel as the payload of a Message.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-file:outbound-gateway</span> <span class="hl-attribute">id</span>=<span class="hl-value">"mover"</span> <span class="hl-attribute">request-channel</span>=<span class="hl-value">"moveInput"</span>
    <span class="hl-attribute">reply-channel</span>=<span class="hl-value">"output"</span>
    <span class="hl-attribute">directory</span>=<span class="hl-value">"${output.directory}"</span>
    <span class="hl-attribute">mode</span>=<span class="hl-value">"REPLACE"</span> <span class="hl-attribute">delete-source-files</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span></pre>
<p>As mentioned earlier, you can also specify the <span class="emphasis"><em>mode</em></span> attribute, which defines the behavior of how to deal with situations where the destination file already exists.
Please see <a class="xref" href="#file-writing-destination-exists" title="14.3.3&nbsp;Dealing with Existing Destination Files">Section&nbsp;14.3.3, &#8220;Dealing with Existing Destination Files&#8221;</a> for further details.
Generally, when using the <span class="emphasis"><em>File Outbound Gateway</em></span>, the result file is returned as the Message payload on the reply channel.</p>
<p>This also applies when specifying the <span class="emphasis"><em>IGNORE</em></span> mode.
In that case the pre-existing destination file is returned.
If the payload of the request message was a file, you still have access to that original file through the Message Header <a class="ulink" href="http://docs.spring.io/spring-integration/api/org/springframework/integration/file/FileHeaders.html" target="_top">FileHeaders.ORIGINAL_FILE</a>.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The <span class="emphasis"><em>outbound-gateway</em></span> works well in cases where you want to first move a file and then send it through a processing pipeline.
In such cases, you may connect the file namespace&#8217;s <code class="literal">inbound-channel-adapter</code> element to the <code class="literal">outbound-gateway</code> and then connect that gateway&#8217;s <code class="literal">reply-channel</code> to the beginning of the pipeline.</p>
</td></tr></table></div>
<p>If you have more elaborate requirements or need to support additional payload types as input to be converted to file content you could extend the <code class="literal">FileWritingMessageHandler</code>, but a much better option is to rely on a <code class="literal">Transformer</code>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_with_java_configuration_9" href="#_configuring_with_java_configuration_9"></a>14.3.8&nbsp;Configuring with Java Configuration</h3></div></div></div>

<p>The following Spring Boot application provides an example of configuring the inbound adapter using Java configuration:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@SpringBootApplication</span></em>
<em><span class="hl-annotation" style="color: gray">@IntegrationComponentScan</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> FileWritingJavaApplication {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
        ConfigurableApplicationContext context =
                      <span class="hl-keyword">new</span> SpringApplicationBuilder(FileWritingJavaApplication.<span class="hl-keyword">class</span>)
                              .web(false)
                              .run(args);
             MyGateway gateway = context.getBean(MyGateway.<span class="hl-keyword">class</span>);
             gateway.writeToFile(<span class="hl-string">"foo.txt"</span>, <span class="hl-keyword">new</span> File(tmpDir.getRoot(), <span class="hl-string">"fileWritingFlow"</span>), <span class="hl-string">"foo"</span>);
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "writeToFileChannel")</span></em>
    <span class="hl-keyword">public</span> MessageHandler fileWritingMessageHandler() {
         Expression directoryExpression = <span class="hl-keyword">new</span> SpelExpressionParser().parseExpression(<span class="hl-string">"headers.directory"</span>);
         FileWritingMessageHandler handler = <span class="hl-keyword">new</span> FileWritingMessageHandler(directoryExpression);
         handler.setFileExistsMode(FileExistsMode.APPEND);
         <span class="hl-keyword">return</span> handler;
    }

    <em><span class="hl-annotation" style="color: gray">@MessagingGateway(defaultRequestChannel = "writeToFileChannel")</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> MyGateway {

        <span class="hl-keyword">void</span> writeToFile(<em><span class="hl-annotation" style="color: gray">@Header(FileHeaders.FILENAME)</span></em> String fileName,
                       <em><span class="hl-annotation" style="color: gray">@Header(FileHeaders.FILENAME)</span></em> File directory, String data);

    }
}</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_with_the_java_dsl_8" href="#_configuring_with_the_java_dsl_8"></a>14.3.9&nbsp;Configuring with the Java DSL</h3></div></div></div>

<p>The following Spring Boot application provides an example of configuring the inbound adapter using the Java DSL:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@SpringBootApplication</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> FileWritingJavaApplication {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
        ConfigurableApplicationContext context =
                 <span class="hl-keyword">new</span> SpringApplicationBuilder(FileWritingJavaApplication.<span class="hl-keyword">class</span>)
                         .web(false)
                         .run(args);
        MessageChannel fileWritingInput = context.getBean(<span class="hl-string">"fileWritingInput"</span>, MessageChannel.<span class="hl-keyword">class</span>);
        fileWritingInput.send(<span class="hl-keyword">new</span> GenericMessage&lt;&gt;(<span class="hl-string">"foo"</span>));
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
   	<span class="hl-keyword">public</span> IntegrationFlow fileWritingFlow() {
   	    <span class="hl-keyword">return</span> IntegrationFlows.from(<span class="hl-string">"fileWritingInput"</span>)
   		        .enrichHeaders(h -&gt; h.header(FileHeaders.FILENAME, <span class="hl-string">"foo.txt"</span>)
   		                  .header(<span class="hl-string">"directory"</span>, <span class="hl-keyword">new</span> File(tmpDir.getRoot(), <span class="hl-string">"fileWritingFlow"</span>)))
   	            .handleWithAdapter(a -&gt; a.fileGateway(m -&gt; m.getHeaders().get(<span class="hl-string">"directory"</span>)))
   	            .channel(MessageChannels.queue(<span class="hl-string">"fileWritingResultChannel"</span>))
   	            .get();
    }

}</pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="file-transforming" href="#file-transforming"></a>14.4&nbsp;File Transformers</h2></div></div></div>

<p>To transform data read from the file system to objects and the other way around you need to do some work.
Contrary to <code class="literal">FileReadingMessageSource</code> and to a lesser extent <code class="literal">FileWritingMessageHandler</code>, it is very likely that you will need your own mechanism to get the job done.
For this you can implement the <code class="literal">Transformer</code> interface.
Or extend the <code class="literal">AbstractFilePayloadTransformer</code> for inbound messages.
Some obvious implementations have been provided.</p>
<p><code class="literal">FileToByteArrayTransformer</code> transforms Files into <code class="literal">byte[]</code> using Spring&#8217;s <code class="literal">FileCopyUtils</code>.
It is often better to use a sequence of transformers than to put all transformations in a single class.
In that case the <code class="literal">File</code> to <code class="literal">byte[]</code> conversion might be a logical first step.</p>
<p><code class="literal">FileToStringTransformer</code> will convert Files to Strings as the name suggests.
If nothing else, this can be useful for debugging (consider using with a Wire Tap).</p>
<p>To configure File specific transformers you can use the appropriate elements from the file namespace.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-file:file-to-bytes-transformer</span>  <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span>
    <span class="hl-attribute">delete-files</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int-file:file-to-string-transformer</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span>
    <span class="hl-attribute">delete-files</span>=<span class="hl-value">"true"</span> <span class="hl-attribute">charset</span>=<span class="hl-value">"UTF-8"</span><span class="hl-tag">/&gt;</span></pre>
<p>The <span class="emphasis"><em>delete-files</em></span> option signals to the transformer that it should delete the inbound File after the transformation is complete.
This is in no way a replacement for using the <code class="literal">AcceptOnceFileListFilter</code> when the <code class="literal">FileReadingMessageSource</code> is being used in a multi-threaded environment (e.g.
Spring Integration in general).</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="file-splitter" href="#file-splitter"></a>14.5&nbsp;File Splitter</h2></div></div></div>

<p>The <code class="literal">FileSplitter</code> was added in <span class="emphasis"><em>version 4.1.2</em></span> and namespace support was added in <span class="emphasis"><em>version 4.2</em></span>.
The <code class="literal">FileSplitter</code> splits text files into individual lines, based on <code class="literal">BufferedReader.readLine()</code>.
By default, the splitter uses an <code class="literal">Iterator</code> to emit lines one-at-a-time as they are read from the file.
Setting the <code class="literal">iterator</code> property to <code class="literal">false</code> causes it to read all the lines into memory before emitting them as messages.
One use case for this might be if you want to detect I/O errors on the file before sending any messages containing
lines.
However, it is only practical for relatively short files.</p>
<p>Inbound payloads can be <code class="literal">File</code>, <code class="literal">String</code> (a <code class="literal">File</code> path), <code class="literal">InputStream</code>, or <code class="literal">Reader</code>.
Other payload types will be emitted unchanged.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-file:splitter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"splitter"</span> <a name="CO22-1" href="#CO22-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
    iterator="" <a name="CO22-2" href="#CO22-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
    markers="" <a name="CO22-3" href="#CO22-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
    markers-json="" <a name="CO22-4" href="#CO22-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
    apply-sequence="" <a name="CO22-5" href="#CO22-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
    requires-reply="" <a name="CO22-6" href="#CO22-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>
    charset="" <a name="CO22-7" href="#CO22-7"></a><span><img src="images/callouts/7.png" alt="7" border="0"></span>
    input-channel="" <a name="CO22-8" href="#CO22-8"></a><span><img src="images/callouts/8.png" alt="8" border="0"></span>
    output-channel="" <a name="CO22-9" href="#CO22-9"></a><span><img src="images/callouts/9.png" alt="9" border="0"></span>
    send-timeout="" <a name="CO22-10" href="#CO22-10"></a><span><img src="images/callouts/10.png" alt="10" border="0"></span>
    auto-startup="" <a name="CO22-11" href="#CO22-11"></a><span><img src="images/callouts/11.png" alt="11" border="0"></span>
    order="" <a name="CO22-12" href="#CO22-12"></a><span><img src="images/callouts/12.png" alt="12" border="0"></span>
    phase="" /&gt; <a name="CO22-13" href="#CO22-13"></a><span><img src="images/callouts/13.png" alt="13" border="0"></span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO22-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The bean name of the splitter.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO22-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Set to <code class="literal">true</code> to use an iterator (default); <code class="literal">false</code> to load the file into memory before sending lines.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO22-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Set to <code class="literal">true</code> to emit start/end of file marker messages before and after the file data.
Markers are messages with <code class="literal">FileSplitter.FileMarker</code> payloads (with <code class="literal">START</code> and <code class="literal">END</code> values in the <code class="literal">mark</code> property).
Markers might be used when sequentially processing files in a downstream flow where some lines are filtered.
They enable the downstream processing to know when a file has been completely processed.
In addition, a header <code class="literal">file_marker</code> containing <code class="literal">START</code> or <code class="literal">END</code> are added to these messages.
The <code class="literal">END</code> marker includes a line count.
If the file is empty, only <code class="literal">START</code> and <code class="literal">END</code> markers are emitted with <code class="literal">0</code> as the <code class="literal">lineCount</code>.
Default: <code class="literal">false</code>.
When <code class="literal">true</code>, <code class="literal">apply-sequence</code> is <code class="literal">false</code> by default.
Also see <code class="literal">markers-json</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO22-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>When <code class="literal">markers</code> is true, set this to <code class="literal">true</code> and the <code class="literal">FileMarker</code> objects will be converted to a JSON String.
Requires a supported JSON processor library on the classpath (Jackson, Boon).</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO22-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Set to <code class="literal">false</code> to disable the inclusion of <code class="literal">sequenceSize</code> and <code class="literal">sequenceNumber</code> headers in messages.
Default: <code class="literal">true</code>, unless <code class="literal">markers</code> is <code class="literal">true</code>.
When <code class="literal">true</code> and <code class="literal">markers</code> is <code class="literal">true</code>, the markers are included in the sequencing.
When <code class="literal">true</code> and <code class="literal">iterator</code> is <code class="literal">true</code>, the <code class="literal">sequenceSize</code> header is set to <code class="literal">0</code> because the size is unknown.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO22-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Set to <code class="literal">true</code> to cause a <code class="literal">RequiresReplyException</code> to be thrown if there are no lines in the file.
Default: <code class="literal">false</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO22-7"><span><img src="images/callouts/7.png" alt="7" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Set the charset name to be used when reading the text data into <code class="literal">String</code> payloads.
Default: platform charset.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO22-8"><span><img src="images/callouts/8.png" alt="8" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Set the input channel used to send messages to the splitter.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO22-9"><span><img src="images/callouts/9.png" alt="9" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Set the output channel to which messages will be sent.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO22-10"><span><img src="images/callouts/10.png" alt="10" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Set the send timeout - only applies if the <code class="literal">output-channel</code> can block - such as a full <code class="literal">QueueChannel</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO22-11"><span><img src="images/callouts/11.png" alt="11" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Set to <code class="literal">false</code> to disable automatically starting the splitter when the context is refreshed.
Default: <code class="literal">true</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO22-12"><span><img src="images/callouts/12.png" alt="12" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Set the order of this endpoint if the <code class="literal">input-channel</code> is a <code class="literal">&lt;publish-subscribe-channel/&gt;</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO22-13"><span><img src="images/callouts/13.png" alt="13" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Set the startup phase for the splitter (used when <code class="literal">auto-startup</code> is <code class="literal">true</code>).</p>
</td></tr></table></div>
<p><span class="strong"><strong>Java Configuration</strong></span></p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Splitter(inputChannel="toSplitter")</span></em>
<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> MessageHandler fileSplitter() {
    FileSplitter splitter = <span class="hl-keyword">new</span> FileSplitter(true, true);
    splitter.setApplySequence(true);
    splitter.setOutputChannel(outputChannel);
    <span class="hl-keyword">return</span> splitter;
}</pre>
<p>The <code class="literal">FileSplitter</code> will also split any text-based <code class="literal">InputStream</code> into lines.
When used in conjunction with an FTP or SFTP streaming inbound channel adapter, or an FTP or SFTP outbound gateway
using the <code class="literal">stream</code> option to retrieve a file, starting with <span class="emphasis"><em>version 4.3</em></span>, the splitter will automatically close
the session supporting the stream, when the file is completely consumed.
See <a class="xref" href="#ftp-streaming" title="15.5&nbsp;FTP Streaming Inbound Channel Adapter">Section&nbsp;15.5, &#8220;FTP Streaming Inbound Channel Adapter&#8221;</a> and <a class="xref" href="#sftp-streaming" title="27.8&nbsp;SFTP Streaming Inbound Channel Adapter">Section&nbsp;27.8, &#8220;SFTP Streaming Inbound Channel Adapter&#8221;</a> as well as <a class="xref" href="#ftp-outbound-gateway" title="15.7&nbsp;FTP Outbound Gateway">Section&nbsp;15.7, &#8220;FTP Outbound Gateway&#8221;</a> and <a class="xref" href="#sftp-outbound-gateway" title="27.10&nbsp;SFTP Outbound Gateway">Section&nbsp;27.10, &#8220;SFTP Outbound Gateway&#8221;</a> for more
information about these facilities.</p>
<p>When using Java configuration, an additional constructor is available:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> FileSplitter(<span class="hl-keyword">boolean</span> iterator, <span class="hl-keyword">boolean</span> markers, <span class="hl-keyword">boolean</span> markersJson)</pre>
<p>When <code class="literal">markersJson</code> is true, the markers will be represented as a JSON string, as long as a suitable JSON processor library, such as Jackson or Boon, is on the classpath.</p>
</div>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="ftp" href="#ftp"></a>15.&nbsp;FTP/FTPS Adapters</h2></div></div></div>

<p>Spring Integration provides support for file transfer operations via FTP and FTPS.</p>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="ftp-intro" href="#ftp-intro"></a>15.1&nbsp;Introduction</h2></div></div></div>

<p>The File Transfer Protocol (FTP) is a simple network protocol which allows you to transfer files between two computers on the Internet.</p>
<p>There are two actors when it comes to FTP communication: <span class="emphasis"><em>client</em></span> and <span class="emphasis"><em>server</em></span>.
To transfer files with FTP/FTPS, you use a <span class="emphasis"><em>client</em></span> which initiates a connection to a remote computer that is running an FTP <span class="emphasis"><em>server</em></span>.
After the connection is established, the <span class="emphasis"><em>client</em></span> can choose to send and/or receive copies of files.</p>
<p>Spring Integration supports sending and receiving files over FTP/FTPS by providing three <span class="emphasis"><em>client</em></span> side endpoints: <span class="emphasis"><em>Inbound Channel Adapter</em></span>, <span class="emphasis"><em>Outbound Channel Adapter</em></span>, and <span class="emphasis"><em>Outbound Gateway</em></span>.
It also provides convenient namespace-based configuration options for defining these <span class="emphasis"><em>client</em></span> components.</p>
<p>To use the <span class="emphasis"><em>FTP</em></span> namespace, add the following to the header of your XML file:</p>
<pre class="programlisting">xmlns:int-ftp="http://www.springframework.org/schema/integration/ftp"
xsi:schemaLocation="http://www.springframework.org/schema/integration/ftp
    http://www.springframework.org/schema/integration/ftp/spring-integration-ftp.xsd"</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="ftp-session-factory" href="#ftp-session-factory"></a>15.2&nbsp;FTP Session Factory</h2></div></div></div>

<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Starting with version 3.0, sessions are no longer cached by default.
See <a class="xref" href="#ftp-session-caching" title="15.8&nbsp;FTP Session Caching">Section&nbsp;15.8, &#8220;FTP Session Caching&#8221;</a>.</p>
</td></tr></table></div>
<p>Before configuring FTP adapters you must configure an <span class="emphasis"><em>FTP Session Factory</em></span>.
You can configure the <span class="emphasis"><em>FTP Session Factory</em></span> with a regular bean definition where the implementation class is <code class="literal">org.springframework.integration.ftp.session.DefaultFtpSessionFactory</code>: Below is a basic configuration:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"ftpClientFactory"</span>
    <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.ftp.session.DefaultFtpSessionFactory"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"host"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"localhost"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"port"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"22"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"username"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"kermit"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"password"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"frog"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"clientMode"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"0"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"fileType"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"2"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"bufferSize"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"100000"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
<p>For FTPS connections all you need to do is use <code class="literal">org.springframework.integration.ftp.session.DefaultFtpsSessionFactory</code> instead.
Below is the complete configuration sample:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"ftpClientFactory"</span>
    <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.ftp.client.DefaultFtpsClientFactory"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"host"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"localhost"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"port"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"22"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"username"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"oleg"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"password"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"password"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"clientMode"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"1"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"fileType"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"2"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"useClientMode"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"cipherSuites"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"a,b.c"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"keyManager"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"keyManager"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"protocol"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"SSL"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"trustManager"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"trustManager"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"prot"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"P"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"needClientAuth"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"authValue"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"oleg"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"sessionCreation"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"protocols"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"SSL, TLS"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"implicit"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
<p>Every time an adapter requests a session object from its <code class="literal">SessionFactory</code> the session is returned from a session pool maintained by a caching wrapper around the factory.
A Session in the session pool might go stale (if it has been disconnected by the server due to inactivity) so the <code class="literal">SessionFactory</code> will perform validation to make sure that it never returns a stale session to the adapter.
If a stale session was encountered, it will be removed from the pool, and a new one will be created.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>If you experience connectivity problems and would like to trace Session creation as well as see which Sessions are polled you may enable it by setting the logger to TRACE level (e.g., log4j.category.org.springframework.integration.file=TRACE)</p>
</td></tr></table></div>
<p>Now all you need to do is inject these session factories into your adapters.
Obviously the protocol (FTP or FTPS) that an adapter will use depends on the type of session factory that has been injected into the adapter.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>A more practical way to provide values for <span class="emphasis"><em>FTP/FTPS Session Factories</em></span> is by using Spring&#8217;s property placeholder support (See: <a class="ulink" href="http://docs.spring.io/spring/docs/current/spring-framework-reference/html/beans.html#beans-factory-placeholderconfigurer" target="_top">http://docs.spring.io/spring/docs/current/spring-framework-reference/html/beans.html#beans-factory-placeholderconfigurer</a>).</p>
</td></tr></table></div>
<p><span class="strong"><strong>Advanced Configuration</strong></span></p>
<p><code class="literal">DefaultFtpSessionFactory</code> provides an abstraction over the underlying client API which, since <span class="emphasis"><em>Spring Integration 2.0</em></span>, is <a class="ulink" href="http://commons.apache.org/net/" target="_top">Apache Commons Net</a>.
This spares you from the low level configuration details of the <code class="literal">org.apache.commons.net.ftp.FTPClient</code>.
Several common properties are exposed on the session factory (since <span class="emphasis"><em>version 4.0</em></span>, this now includes <code class="literal">connectTimeout</code>, <code class="literal">defaultTimeout</code> and <code class="literal">dataTimeout</code>).
However there are times when access to lower level <code class="literal">FTPClient</code> configuration is necessary to achieve more advanced configuration (e.g., setting the port range for active mode etc.).
For that purpose, <code class="literal">AbstractFtpSessionFactory</code> (the base class for all FTP Session Factories) exposes hooks, in the form of the two post-processing methods below.</p>
<pre class="programlisting"><strong class="hl-tag" style="color: blue">/**
 * Will handle additional initialization after client.connect() method was invoked,
 * but before any action on the client has been taken
 */</strong>
<span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> postProcessClientAfterConnect(T t) <span class="hl-keyword">throws</span> IOException {
    <span class="hl-comment">// NOOP</span>
}
<strong class="hl-tag" style="color: blue">/**
 * Will handle additional initialization before client.connect() method was invoked.
 */</strong>
<span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> postProcessClientBeforeConnect(T client) <span class="hl-keyword">throws</span> IOException {
    <span class="hl-comment">// NOOP</span>
}</pre>
<p>As you can see, there is no default implementation for these two methods.
However, by extending <code class="literal">DefaultFtpSessionFactory</code> you can override these methods to provide more advanced configuration of the <code class="literal">FTPClient</code>.
For example:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> AdvancedFtpSessionFactory <span class="hl-keyword">extends</span> DefaultFtpSessionFactory {

    <span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> postProcessClientBeforeConnect(FTPClient ftpClient) <span class="hl-keyword">throws</span> IOException {
       ftpClient.setActivePortRange(<span class="hl-number">4000</span>, <span class="hl-number">5000</span>);
    }
}</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="ftp-dsf" href="#ftp-dsf"></a>15.3&nbsp;Delegating Session Factory</h2></div></div></div>

<p><span class="emphasis"><em>Version 4.2</em></span> introduced the <code class="literal">DelegatingSessionFactory</code> which allows the selection of the actual session factory at
runtime.
Prior to invoking the ftp endpoint, call <code class="literal">setThreadKey()</code> on the factory to associate a key with the current thread.
That key is then used to lookup the actual session factory to be used.
The key can be cleared by calling <code class="literal">clearThreadKey()</code> after use.</p>
<p>Convenience methods have been added so this can easily be done from a message flow:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"dsf"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.file.remote.session.DelegatingSessionFactory"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.file.remote.session.DefaultSessionFactoryLocator"</span><span class="hl-tag">&gt;</span>
            <span class="hl-comment">&lt;!-- delegate factories here --&gt;</span>
        <span class="hl-tag">&lt;/bean&gt;</span>
    <span class="hl-tag">&lt;/constructor-arg&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;int:service-activator</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"in"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"c1"</span>
        <span class="hl-attribute">expression</span>=<span class="hl-value">"@dsf.setThreadKey(#root, headers['factoryToUse'])"</span><span class="hl-tag"> /&gt;</span>

<span class="hl-tag">&lt;int-ftp:outbound-gateway</span> <span class="hl-attribute">request-channel</span>=<span class="hl-value">"c1"</span> <span class="hl-attribute">reply-channel</span>=<span class="hl-value">"c2"</span> <span class="hl-attribute">...</span><span class="hl-tag"> /&gt;</span>

<span class="hl-tag">&lt;int:service-activator</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"c2"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"out"</span>
        <span class="hl-attribute">expression</span>=<span class="hl-value">"@dsf.clearThreadKey(#root)"</span><span class="hl-tag"> /&gt;</span></pre>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>When using session caching (see <a class="xref" href="#ftp-session-caching" title="15.8&nbsp;FTP Session Caching">Section&nbsp;15.8, &#8220;FTP Session Caching&#8221;</a>), each of the delegates should be cached; you
cannot cache the <code class="literal">DelegatingSessionFactory</code> itself.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="ftp-inbound" href="#ftp-inbound"></a>15.4&nbsp;FTP Inbound Channel Adapter</h2></div></div></div>

<p>The <span class="emphasis"><em>FTP Inbound Channel Adapter</em></span> is a special listener that will connect to the FTP server and will listen for the remote directory events (e.g., new file created) at which point it will initiate a file transfer.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-ftp:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"ftpInbound"</span>
    <span class="hl-attribute">channel</span>=<span class="hl-value">"ftpChannel"</span>
    <span class="hl-attribute">session-factory</span>=<span class="hl-value">"ftpSessionFactory"</span>
    <span class="hl-attribute">auto-create-local-directory</span>=<span class="hl-value">"true"</span>
    <span class="hl-attribute">delete-remote-files</span>=<span class="hl-value">"true"</span>
    <span class="hl-attribute">filename-pattern</span>=<span class="hl-value">"*.txt"</span>
    <span class="hl-attribute">remote-directory</span>=<span class="hl-value">"some/remote/path"</span>
    <span class="hl-attribute">remote-file-separator</span>=<span class="hl-value">"/"</span>
    <span class="hl-attribute">preserve-timestamp</span>=<span class="hl-value">"true"</span>
    <span class="hl-attribute">local-filename-generator-expression</span>=<span class="hl-value">"#this.toUpperCase() + '.a'"</span>
    <span class="hl-attribute">local-filter</span>=<span class="hl-value">"myFilter"</span>
    <span class="hl-attribute">temporary-file-suffix</span>=<span class="hl-value">".writing"</span>
    <span class="hl-attribute">local-directory</span>=<span class="hl-value">"."</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"1000"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-ftp:inbound-channel-adapter&gt;</span></pre>
<p>As you can see from the configuration above you can configure an <span class="emphasis"><em>FTP Inbound Channel Adapter</em></span> via the <code class="literal">inbound-channel-adapter</code> element while also providing values for various attributes such as <code class="literal">local-directory</code>, <code class="literal">filename-pattern</code> (which is based on simple pattern matching, not regular expressions), and of course the reference to a <code class="literal">session-factory</code>.</p>
<p>By default the transferred file will carry the same name as the original file.
If you want to override this behavior you can set the <code class="literal">local-filename-generator-expression</code> attribute which allows you to provide a SpEL Expression to generate the name of the local file.
Unlike outbound gateways and adapters where the root object of the SpEL Evaluation Context is a <code class="literal">Message</code>, this inbound adapter does not yet have the Message at the time of evaluation since that&#8217;s what it ultimately generates with the transferred file as its payload.
So, the root object of the SpEL Evaluation Context is the original name of the remote file (String).</p>
<p>Starting with <span class="emphasis"><em>Spring Integration 3.0</em></span>, you can specify the <code class="literal">preserve-timestamp</code> attribute (default <code class="literal">false</code>); when <code class="literal">true</code>, the local file&#8217;s modified timestamp will be set to the value retrieved from the server; otherwise it will be set to the current time.</p>
<p>Starting with <span class="emphasis"><em>version 4.2</em></span>, you can specify <code class="literal">remote-directory-expression</code> instead of <code class="literal">remote-directory</code>, allowing
you to dynamically determine the directory on each poll.
e.g <code class="literal">remote-directory-expression="@myBean.determineRemoteDir()"</code>.</p>
<p>Starting with <span class="emphasis"><em>version 4.3</em></span>, the <code class="literal">remote-directory</code>/<code class="literal">remote-directory-expression</code> attributes can be omitted assuming <code class="literal">null</code>.
In this case, according to the FTP protocol, the Client working directory is used as a default remote directory.</p>
<p>Sometimes file filtering based on the simple pattern specified via <code class="literal">filename-pattern</code> attribute might not be sufficient.
If this is the case, you can use the <code class="literal">filename-regex</code> attribute to specify a Regular Expression (e.g. <code class="literal">filename-regex=".*\.test$"</code>).
And of course if you need complete control you can use <code class="literal">filter</code> attribute and provide a reference to any custom implementation of the <code class="literal">org.springframework.integration.file.filters.FileListFilter</code>, a strategy interface for filtering a list of files.
This filter determines which remote files are retrieved.
You can also combine a pattern based filter with other filters, such as an <code class="literal">AcceptOnceFileListFilter</code> to avoid synchronizing files that have previously been fetched, by using a <code class="literal">CompositeFileListFilter</code>.</p>
<p>The <code class="literal">AcceptOnceFileListFilter</code> stores its state in memory.
If you wish the state to survive a system restart, consider using the <code class="literal">FtpPersistentAcceptOnceFileListFilter</code> instead.
This filter stores the accepted file names in an instance of the <code class="literal">MetadataStore</code> strategy (<a class="xref" href="#metadata-store" title="9.5&nbsp;Metadata Store">Section&nbsp;9.5, &#8220;Metadata Store&#8221;</a>).
This filter matches on the filename and the remote modified time.</p>
<p>Since <span class="emphasis"><em>version 4.0</em></span>, this filter requires a <code class="literal">ConcurrentMetadataStore</code>.
When used with a shared data store (such as <code class="literal">Redis</code> with the <code class="literal">RedisMetadataStore</code>) this allows filter keys to be shared across multiple application or server instances.</p>
<p>The above discussion refers to filtering the files before retrieving them.
Once the files have been retrieved, an additional filter is applied to the files on the file system.
By default, this is an`AcceptOnceFileListFilter` which, as discussed, retains state in memory and does not consider the file&#8217;s modified time.
Unless your application removes files after processing, the adapter will re-process the files on disk by default after an application restart.</p>
<p>Also, if you configure the <code class="literal">filter</code> to use a <code class="literal">FtpPersistentAcceptOnceFileListFilter</code>, and the remote file timestamp changes (causing it to be re-fetched), the default local filter will not allow this new file to be processed.</p>
<p>Use the <code class="literal">local-filter</code> attribute to configure the behavior of the local file system filter.
Starting with <span class="emphasis"><em>verion 4.3.8</em></span>, a <code class="literal">FileSystemPersistentAcceptOnceFileListFilter</code> is configured by default.
This filter stores the accepted file names and modified timestamp in an instance of the <code class="literal">MetadataStore</code> strategy (<a class="xref" href="#metadata-store" title="9.5&nbsp;Metadata Store">Section&nbsp;9.5, &#8220;Metadata Store&#8221;</a>), and will detect changes to the local file modified time.
The default <code class="literal">MetadataStore</code> is a <code class="literal">SimpleMetadataStore</code> which stores state in memory.</p>
<p>Since <span class="emphasis"><em>version 4.1.5</em></span>, these filters have a new property <code class="literal">flushOnUpdate</code> which will cause them to flush the
metadata store on every update (if the store implements <code class="literal">Flushable</code>).</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Further, if you use a distributed <code class="literal">MetadataStore</code> (such as <a class="xref" href="#redis-metadata-store" title="24.5&nbsp;Redis Metadata Store">Section&nbsp;24.5, &#8220;Redis Metadata Store&#8221;</a> or <a class="xref" href="#gemfire-metadata-store" title="16.7&nbsp;Gemfire Metadata Store">Section&nbsp;16.7, &#8220;Gemfire Metadata Store&#8221;</a>) you can have multiple instances of the same adapter/application and be sure that one and only one will process a file.</p>
</td></tr></table></div>
<p>The actual local filter is a <code class="literal">CompositeFileListFilter</code> containing the supplied filter and a pattern filter that prevents processing files that are in the process of being downloaded (based on the <code class="literal">temporary-file-suffix</code>); files are downloaded with this suffix (default: <code class="literal">.writing</code>) and the file is renamed to its final name when the transfer is complete, making it <span class="emphasis"><em>visible</em></span> to the filter.</p>
<p>The <code class="literal">remote-file-separator</code> attribute allows you to configure a file separator character to use if the default <span class="emphasis"><em>/</em></span> is not applicable for your particular environment.</p>
<p>Please refer to the schema for more details on these attributes.</p>
<p>It is also important to understand that the <span class="emphasis"><em>FTP Inbound Channel Adapter</em></span> is a <span class="emphasis"><em>Polling Consumer</em></span> and therefore you must configure a poller (either via a global default or a local sub-element).
Once a file has been transferred, a Message with a <code class="literal">java.io.File</code> as its payload will be generated and sent to the channel identified by the <code class="literal">channel</code> attribute.</p>
<p><span class="emphasis"><em>More on File Filtering and Large Files</em></span></p>
<p>Sometimes the file that just appeared in the monitored (remote) directory is not complete.
Typically such a file will be written with temporary extension (e.g., foo.txt.writing) and then renamed after the writing process finished.
As a user in most cases you are only interested in files that are complete and would like to filter only files that are complete.
To handle these scenarios you can use the filtering support provided by the <code class="literal">filename-pattern</code>, <code class="literal">filename-regex</code> and <code class="literal">filter</code> attributes.
Here is an example that uses a custom Filter implementation.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-ftp:inbound-channel-adapter</span>
    <span class="hl-attribute">channel</span>=<span class="hl-value">"ftpChannel"</span>
    <span class="hl-attribute">session-factory</span>=<span class="hl-value">"ftpSessionFactory"</span>
    <span class="hl-attribute">filter</span>=<span class="hl-value">"customFilter"</span>
    <span class="hl-attribute">local-directory</span>=<span class="hl-value">"file:/my_transfers"</span><span class="hl-tag">&gt;</span>
    remote-directory="some/remote/path"
    <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"1000"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-ftp:inbound-channel-adapter&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"customFilter"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.example.CustomFilter"</span><span class="hl-tag">/&gt;</span></pre>
<p><span class="emphasis"><em>Poller configuration notes for the inbound FTP adapter</em></span></p>
<p>The job of the inbound FTP adapter consists of two tasks:
<span class="emphasis"><em>1) Communicate with a remote server in order to transfer files from a remote directory to a local directory.</em></span>
<span class="emphasis"><em>2) For each transferred file, generate a Message with that file as a payload and send it to the channel identified by the <span class="emphasis"><em>channel</em></span> attribute.</em></span>
That is why they are called <span class="emphasis"><em>channel-adapters</em></span> rather than just <span class="emphasis"><em>adapters</em></span>.
The main job of such an adapter is to generate a Message to be sent to a Message Channel.
Essentially, the second task mentioned above takes precedence in such a way that <span class="strong"><strong>IF</strong></span> your local directory already has one or more files it will first generate Messages from those, and <span class="strong"><strong>ONLY</strong></span> when all local files have been processed, will it initiate the remote communication to retrieve more files.</p>
<p>Also, when configuring a trigger on the poller you should pay close attention to the <code class="literal">max-messages-per-poll</code> attribute.
Its default value is 1 for all <code class="literal">SourcePollingChannelAdapter</code> instances (including FTP).
This means that as soon as one file is processed, it will wait for the next execution time as determined by your trigger configuration.
If you happened to have one or more files sitting in the <code class="literal">local-directory</code>, it would process those files before it would initiate communication with the remote FTP server.
And, if the <code class="literal">max-messages-per-poll</code> were set to 1 (default), then it would be processing only one file at a time with intervals as defined by your trigger, essentially working as <span class="emphasis"><em>one-poll === one-file</em></span>.</p>
<p>For typical file-transfer use cases, you most likely want the opposite behavior: to process all the files you can for each poll and only then wait for the next poll.
If that is the case, set <code class="literal">max-messages-per-poll</code> to -1.
Then, on each poll, the adapter will attempt to generate as many Messages as it possibly can.
In other words, it will process everything in the local directory, and then it will connect to the remote directory to transfer everything that is available there to be processed locally.
Only then is the poll operation considered complete, and the poller will wait for the next execution time.</p>
<p>You can alternatively set the <span class="emphasis"><em>max-messages-per-poll</em></span> value to a positive value indicating the upward limit of Messages to be created from files with each poll.
For example, a value of 10 means that on each poll it will attempt to process no more than 10 files.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_recovering_from_failures" href="#_recovering_from_failures"></a>15.4.1&nbsp;Recovering from Failures</h3></div></div></div>

<p>It is important to understand the architecture of the adapter.
There is a file synchronizer which fetches the files, and a <code class="literal">FileReadingMessageSource</code> to emit a message for each
synchronized file.
As discussed above, there are two filters involved.
The <code class="literal">filter</code> attribute (and patterns) refers to the remote (FTP) file list - to avoid fetching files that have already
been fetched.
The <code class="literal">local-filter</code> is used by the <code class="literal">FileReadingMessageSource</code> to determine which files are to be sent as messages.</p>
<p>The synchronizer lists the remote files and consults its filter; the files are then transferred.
If an IO error occurs during file transfer, any files that have already been added to the filter are removed so they
are eligible to be re-fetched on the next poll.
This only applies if the filter implements <code class="literal">ReversibleFileListFilter</code> (such as the <code class="literal">AcceptOnceFileListFilter</code>).</p>
<p>If, after synchronizing the files, an error occurs on the downstream flow processing a file, there is <span class="emphasis"><em>no</em></span> automatic
rollback of the filter so the failed file will <span class="emphasis"><em>not</em></span> be reprocessed by default.</p>
<p>If you wish to reprocess such files after a failure, you can use configuration similar to the following to facilitate
the removal of the failed file from the filter.
This will work for any <code class="literal">ResettableFileListFilter</code>.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-ftp:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"ftpAdapter"</span>
        <span class="hl-attribute">session-factory</span>=<span class="hl-value">"ftpSessionFactory"</span>
        <span class="hl-attribute">channel</span>=<span class="hl-value">"requestChannel"</span>
        <span class="hl-attribute">remote-directory-expression</span>=<span class="hl-value">"'/sftpSource'"</span>
        <span class="hl-attribute">local-directory</span>=<span class="hl-value">"file:myLocalDir"</span>
        <span class="hl-attribute">auto-create-local-directory</span>=<span class="hl-value">"true"</span>
        <span class="hl-attribute">filename-pattern</span>=<span class="hl-value">"*.txt"</span>
        <span class="hl-attribute">local-filter</span>=<span class="hl-value">"acceptOnceFilter"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"1000"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;int:transactional</span> <span class="hl-attribute">synchronization-factory</span>=<span class="hl-value">"syncFactory"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;/int:poller&gt;</span>
<span class="hl-tag">&lt;/int-ftp:inbound-channel-adapter&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"acceptOnceFilter"</span>
    <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.file.filters.AcceptOnceFileListFilter"</span><span class="hl-tag"> /&gt;</span>

<span class="hl-tag">&lt;int:transaction-synchronization-factory</span> <span class="hl-attribute">id</span>=<span class="hl-value">"syncFactory"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:after-rollback</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"@acceptOnceFilter.remove(payload)"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/int:transaction-synchronization-factory&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"transactionManager"</span>
    <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.transaction.PseudoTransactionManager"</span><span class="hl-tag"> /&gt;</span></pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_with_java_configuration_10" href="#_configuring_with_java_configuration_10"></a>15.4.2&nbsp;Configuring with Java Configuration</h3></div></div></div>

<p>The following Spring Boot application provides an example of configuring the inbound adapter using Java configuration:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@SpringBootApplication</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> FtpJavaApplication {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
        <span class="hl-keyword">new</span> SpringApplicationBuilder(FtpJavaApplication.<span class="hl-keyword">class</span>)
            .web(false)
            .run(args);
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> SessionFactory&lt;FTPFile&gt; ftpSessionFactory() {
        DefaultFtpSessionFactory sf = <span class="hl-keyword">new</span> DefaultFtpSessionFactory();
        sf.setHost(<span class="hl-string">"localhost"</span>);
        sf.setPort(port);
        sf.setUsername(<span class="hl-string">"foo"</span>);
        sf.setPassword(<span class="hl-string">"foo"</span>);
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> CachingSessionFactory&lt;FTPFile&gt;(sf);
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> FtpInboundFileSynchronizer ftpInboundFileSynchronizer() {
        FtpInboundFileSynchronizer fileSynchronizer = <span class="hl-keyword">new</span> FtpInboundFileSynchronizer(ftpSessionFactory());
        fileSynchronizer.setDeleteRemoteFiles(false);
        fileSynchronizer.setRemoteDirectory(<span class="hl-string">"foo"</span>);
        fileSynchronizer.setFilter(<span class="hl-keyword">new</span> FtpSimplePatternFileListFilter(<span class="hl-string">"*.xml"</span>));
        <span class="hl-keyword">return</span> fileSynchronizer;
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <em><span class="hl-annotation" style="color: gray">@InboundChannelAdapter(channel = "ftpChannel", poller = @Poller(fixedDelay = "5000"))</span></em>
    <span class="hl-keyword">public</span> MessageSource&lt;File&gt; ftpMessageSource() {
        FtpInboundFileSynchronizingMessageSource source =
                <span class="hl-keyword">new</span> FtpInboundFileSynchronizingMessageSource(ftpInboundFileSynchronizer());
        source.setLocalDirectory(<span class="hl-keyword">new</span> File(<span class="hl-string">"ftp-inbound"</span>));
        source.setAutoCreateLocalDirectory(true);
        source.setLocalFilter(<span class="hl-keyword">new</span> AcceptOnceFileListFilter&lt;File&gt;());
        <span class="hl-keyword">return</span> source;
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "ftpChannel")</span></em>
    <span class="hl-keyword">public</span> MessageHandler handler() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> MessageHandler() {

            <em><span class="hl-annotation" style="color: gray">@Override</span></em>
            <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> handleMessage(Message&lt;?&gt; message) <span class="hl-keyword">throws</span> MessagingException {
                System.out.println(message.getPayload());
            }

        };
    }

}</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_with_the_java_dsl_9" href="#_configuring_with_the_java_dsl_9"></a>15.4.3&nbsp;Configuring with the Java DSL</h3></div></div></div>

<p>The following Spring Boot application provides an example of configuring the inbound adapter using the Java DSL:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@SpringBootApplication</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> FtpJavaApplication {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
        <span class="hl-keyword">new</span> SpringApplicationBuilder(FtpJavaApplication.<span class="hl-keyword">class</span>)
            .web(false)
            .run(args);
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> IntegrationFlow ftpInboundFlow() {
        <span class="hl-keyword">return</span> IntegrationFlows
            .from(s -&gt; s.ftp(<span class="hl-keyword">this</span>.ftpSessionFactory)
                    .preserveTimestamp(true)
                    .remoteDirectory(<span class="hl-string">"foo"</span>)
                    .regexFilter(<span class="hl-string">".*\\.txt$"</span>)
                    .localFilename(f -&gt; f.toUpperCase() + <span class="hl-string">".a"</span>)
                    .localDirectory(<span class="hl-keyword">new</span> File(<span class="hl-string">"d:\\ftp_files"</span>)),
                e -&gt; e.id(<span class="hl-string">"ftpInboundAdapter"</span>)
                    .autoStartup(true)
                    .poller(Pollers.fixedDelay(<span class="hl-number">5000</span>)))
            .handle(m -&gt; System.out.println(m.getPayload()))
            .get();
    }
}</pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="ftp-streaming" href="#ftp-streaming"></a>15.5&nbsp;FTP Streaming Inbound Channel Adapter</h2></div></div></div>

<p>The streaming inbound channel adapter was introduced in <span class="emphasis"><em>version 4.3</em></span>.
This adapter produces message with payloads of type <code class="literal">InputStream</code>, allowing files to be fetched without writing to the
local file system.
Since the session remains open, the consuming application is responsible for closing the session when the file has been
consumed.
The session is provided in the <code class="literal">IntegrationMessageHeaderAccessor.CLOSEABLE_RESOURCE</code> header.
Standard framework components, such as the <code class="literal">FileSplitter</code> and <code class="literal">StreamTransformer</code> will automatically close the session.
See <a class="xref" href="#file-splitter" title="14.5&nbsp;File Splitter">Section&nbsp;14.5, &#8220;File Splitter&#8221;</a> and <a class="xref" href="#stream-transformer" title="Stream Transformer">the section called &#8220;Stream Transformer&#8221;</a> for more information about these components.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-ftp:inbound-streaming-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"ftpInbound"</span>
            <span class="hl-attribute">channel</span>=<span class="hl-value">"ftpChannel"</span>
            <span class="hl-attribute">session-factory</span>=<span class="hl-value">"sessionFactory"</span>
            <span class="hl-attribute">filename-pattern</span>=<span class="hl-value">"*.txt"</span>
            <span class="hl-attribute">filename-regex</span>=<span class="hl-value">".*\.txt"</span>
            <span class="hl-attribute">filter</span>=<span class="hl-value">"filter"</span>
            <span class="hl-attribute">remote-file-separator</span>=<span class="hl-value">"/"</span>
            <span class="hl-attribute">comparator</span>=<span class="hl-value">"comparator"</span>
            <span class="hl-attribute">remote-directory-expression</span>=<span class="hl-value">"'foo/bar'"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"1000"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/int-ftp:inbound-streaming-channel-adapter&gt;</span></pre>
<p>Only one of <code class="literal">filename-pattern</code>, <code class="literal">filename-regex</code> or <code class="literal">filter</code> is allowed.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Unlike the non-streaming inbound channel adapter, this adapter does not prevent duplicates by default.
If you do not delete the remote file (e.g. using an outbound gateway with an rm command) and you wish to prevent the
file being processed again, you can configure an <code class="literal">FtpPersistentFileListFilter</code> in the <code class="literal">filter</code> attribute.
If you don&#8217;t actually want to persist the state, an in-memory <code class="literal">SimpleMetadataStore</code> can be used with the filter.
If you wish to use a filename pattern (or regex) as well, use a <code class="literal">CompositeFileListFilter</code>.</p>
</td></tr></table></div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_with_java_configuration_11" href="#_configuring_with_java_configuration_11"></a>15.5.1&nbsp;Configuring with Java Configuration</h3></div></div></div>

<p>The following Spring Boot application provides an example of configuring the inbound adapter using Java configuration:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@SpringBootApplication</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> FtpJavaApplication {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
        <span class="hl-keyword">new</span> SpringApplicationBuilder(FtpJavaApplication.<span class="hl-keyword">class</span>)
            .web(false)
            .run(args);
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <em><span class="hl-annotation" style="color: gray">@InboundChannelAdapter(channel = "stream")</span></em>
    <span class="hl-keyword">public</span> MessageSource&lt;InputStream&gt; ftpMessageSource() {
        FtpStreamingMessageSource messageSource = <span class="hl-keyword">new</span> FtpStreamingMessageSource(template(), null);
        messageSource.setRemoteDirectory(<span class="hl-string">"ftpSource/"</span>);
        messageSource.setFilter(<span class="hl-keyword">new</span> FtpPersistentAcceptOnceFileListFilter(<span class="hl-keyword">new</span> SimpleMetadataStore(),
                           <span class="hl-string">"streaming"</span>));
        <span class="hl-keyword">return</span> messageSource;
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <em><span class="hl-annotation" style="color: gray">@Transformer(inputChannel = "stream", outputChannel = "data")</span></em>
    <span class="hl-keyword">public</span> org.springframework.integration.transformer.Transformer transformer() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> StreamTransformer();
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> FtpRemoteFileTemplate template() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> FtpRemoteFileTemplate(ftpSessionFactory());
    }

}</pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="ftp-outbound" href="#ftp-outbound"></a>15.6&nbsp;FTP Outbound Channel Adapter</h2></div></div></div>

<p>The <span class="emphasis"><em>FTP Outbound Channel Adapter</em></span> relies upon a <code class="literal">MessageHandler</code> implementation that will connect to the FTP server and initiate an FTP transfer for every file it receives in the payload of incoming Messages.
It also supports several representations of the <span class="emphasis"><em>File</em></span> so you are not limited only to java.io.File typed payloads.
The <span class="emphasis"><em>FTP Outbound Channel Adapter</em></span> supports the following payloads: 1) <code class="literal">java.io.File</code> - the actual file object; 2) <code class="literal">byte[]</code> - a byte array that represents the file contents; and 3) <code class="literal">java.lang.String</code> - text that represents the file contents.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-ftp:outbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"ftpOutbound"</span>
    <span class="hl-attribute">channel</span>=<span class="hl-value">"ftpChannel"</span>
    <span class="hl-attribute">session-factory</span>=<span class="hl-value">"ftpSessionFactory"</span>
    <span class="hl-attribute">charset</span>=<span class="hl-value">"UTF-8"</span>
    <span class="hl-attribute">remote-file-separator</span>=<span class="hl-value">"/"</span>
    <span class="hl-attribute">auto-create-directory</span>=<span class="hl-value">"true"</span>
    <span class="hl-attribute">remote-directory-expression</span>=<span class="hl-value">"headers.['remote_dir']"</span>
    <span class="hl-attribute">temporary-remote-directory-expression</span>=<span class="hl-value">"headers.['temp_remote_dir']"</span>
    <span class="hl-attribute">filename-generator</span>=<span class="hl-value">"fileNameGenerator"</span>
    <span class="hl-attribute">use-temporary-filename</span>=<span class="hl-value">"true"</span>
    <span class="hl-attribute">mode</span>=<span class="hl-value">"REPLACE"</span><span class="hl-tag">/&gt;</span></pre>
<p>As you can see from the configuration above you can configure an <span class="emphasis"><em>FTP Outbound Channel Adapter</em></span> via the <code class="literal">outbound-channel-adapter</code> element while also providing values for various attributes such as <code class="literal">filename-generator</code> (an implementation of the <code class="literal">org.springframework.integration.file.FileNameGenerator</code> strategy interface), a reference to a <code class="literal">session-factory</code>, as well as other attributes.
You can also see some examples of <code class="literal">*expression</code> attributes which allow you to use SpEL to configure things like <code class="literal">remote-directory-expression</code>, <code class="literal">temporary-remote-directory-expression</code> and <code class="literal">remote-filename-generator-expression</code> (a SpEL alternative to <code class="literal">filename-generator</code> shown above).
As with any component that allows the usage of SpEL, access to Payload and Message Headers is available via <span class="emphasis"><em>payload</em></span> and <span class="emphasis"><em>headers</em></span> variables.
Please refer to the schema for more details on the available attributes.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>By default Spring Integration will use <code class="literal">o.s.i.file.DefaultFileNameGenerator</code> if none is specified.
<code class="literal">DefaultFileNameGenerator</code> will determine the file name based on the value of the <code class="literal">file_name</code> header (if it exists) in the MessageHeaders, or if the payload of the Message is already a <code class="literal">java.io.File</code>, then it will use the original name of that file.</p>
</td></tr></table></div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Defining certain values (e.g., remote-directory) might be platform/ftp server dependent.
For example as it was reported on this forum <a class="ulink" href="http://forum.springsource.org/showthread.php?p=333478&amp;posted=1#post333478" target="_top">http://forum.springsource.org/showthread.php?p=333478&amp;posted=1#post333478</a> on some platforms you must add slash to the end of the directory definition (e.g., remote-directory="/foo/bar/" instead of remote-directory="/foo/bar")</p>
</td></tr></table></div>
<p>Starting with <span class="emphasis"><em>version 4.1</em></span>, you can specify the <code class="literal">mode</code> when transferring the file.
By default, an existing file will be overwritten; the modes are defined on <code class="literal">enum</code> <code class="literal">FileExistsMode</code>, having values <code class="literal">REPLACE</code> (default), <code class="literal">APPEND</code>, <code class="literal">IGNORE</code>, and <code class="literal">FAIL</code>.
With <code class="literal">IGNORE</code> and <code class="literal">FAIL</code>, the file is not transferred; <code class="literal">FAIL</code> causes an exception to be thrown whereas <code class="literal">IGNORE</code> silently ignores the transfer (although a <code class="literal">DEBUG</code> log entry is produced).</p>
<p><span class="emphasis"><em>Avoiding Partially Written Files</em></span></p>
<p>One of the common problems, when dealing with file transfers, is the possibility of processing a <span class="emphasis"><em>partial file</em></span> - a file might appear in the file system before its transfer is actually complete.</p>
<p>To deal with this issue, Spring Integration FTP adapters use a very common algorithm where files are transferred under a temporary name and then renamed once they are fully transferred.</p>
<p>By default, every file that is in the process of being transferred will appear in the file system with an additional suffix which, by default, is <code class="literal">.writing</code>; this can be changed using the <code class="literal">temporary-file-suffix</code> attribute.</p>
<p>However, there may be situations where you don&#8217;t want to use this technique (for example, if the server does not permit renaming files).
For situations like this, you can disable this feature by setting <code class="literal">use-temporary-file-name</code> to <code class="literal">false</code> (default is <code class="literal">true</code>).
When this attribute is <code class="literal">false</code>, the file is written with its final name and the consuming application will need some other mechanism to detect that the file is completely uploaded before accessing it.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_with_java_configuration_12" href="#_configuring_with_java_configuration_12"></a>15.6.1&nbsp;Configuring with Java Configuration</h3></div></div></div>

<p>The following Spring Boot application provides an example of configuring the Outbound Adapter using Java configuration:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@SpringBootApplication</span></em>
<em><span class="hl-annotation" style="color: gray">@IntegrationComponentScan</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> FtpJavaApplication {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
        ConfigurableApplicationContext context =
                    <span class="hl-keyword">new</span> SpringApplicationBuilder(FtpJavaApplication.<span class="hl-keyword">class</span>)
                        .web(false)
                        .run(args);
        MyGateway gateway = context.getBean(MyGateway.<span class="hl-keyword">class</span>);
        gateway.sendToFtp(<span class="hl-keyword">new</span> File(<span class="hl-string">"/foo/bar.txt"</span>));
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> SessionFactory&lt;FTPFile&gt; ftpSessionFactory() {
        DefaultFtpSessionFactory sf = <span class="hl-keyword">new</span> DefaultFtpSessionFactory();
        sf.setHost(<span class="hl-string">"localhost"</span>);
        sf.setPort(port);
        sf.setUsername(<span class="hl-string">"foo"</span>);
        sf.setPassword(<span class="hl-string">"foo"</span>);
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> CachingSessionFactory&lt;FTPFile&gt;(sf);
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "ftpChannel")</span></em>
    <span class="hl-keyword">public</span> MessageHandler handler() {
        FtpMessageHandler handler = <span class="hl-keyword">new</span> FtpMessageHandler(ftpSessionFactory());
        handler.setRemoteDirectoryExpressionString(<span class="hl-string">"headers['remote-target-dir']"</span>);
        handler.setFileNameGenerator(<span class="hl-keyword">new</span> FileNameGenerator() {

            <em><span class="hl-annotation" style="color: gray">@Override</span></em>
            <span class="hl-keyword">public</span> String generateFileName(Message&lt;?&gt; message) {
                 <span class="hl-keyword">return</span> <span class="hl-string">"handlerContent.test"</span>;
            }

        });
        <span class="hl-keyword">return</span> handler;
    }

    <em><span class="hl-annotation" style="color: gray">@MessagingGateway</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> MyGateway {

         <em><span class="hl-annotation" style="color: gray">@Gateway(requestChannel = "toFtpChannel")</span></em>
         <span class="hl-keyword">void</span> sendToFtp(File file);

    }
}</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_with_the_java_dsl_10" href="#_configuring_with_the_java_dsl_10"></a>15.6.2&nbsp;Configuring with the Java DSL</h3></div></div></div>

<p>The following Spring Boot application provides an example of configuring the Outbound Adapter using the Java DSL:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@SpringBootApplication</span></em>
<em><span class="hl-annotation" style="color: gray">@IntegrationComponentScan</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> FtpJavaApplication {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
        ConfigurableApplicationContext context =
            <span class="hl-keyword">new</span> SpringApplicationBuilder(FtpJavaApplication.<span class="hl-keyword">class</span>)
                .web(false)
                .run(args);
        MyGateway gateway = context.getBean(MyGateway.<span class="hl-keyword">class</span>);
        gateway.sendToFtp(<span class="hl-keyword">new</span> File(<span class="hl-string">"/foo/bar.txt"</span>));
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> SessionFactory&lt;FTPFile&gt; ftpSessionFactory() {
        DefaultFtpSessionFactory sf = <span class="hl-keyword">new</span> DefaultFtpSessionFactory();
        sf.setHost(<span class="hl-string">"localhost"</span>);
        sf.setPort(port);
        sf.setUsername(<span class="hl-string">"foo"</span>);
        sf.setPassword(<span class="hl-string">"foo"</span>);
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> CachingSessionFactory&lt;FTPFile&gt;(sf);
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> IntegrationFlow ftpOutboundFlow() {
        <span class="hl-keyword">return</span> IntegrationFlows.from(<span class="hl-string">"toFtpChannel"</span>)
                .handle(Ftp.outboundAdapter(ftpSessionFactory(), FileExistsMode.FAIL)
                        .useTemporaryFileName(false)
                        .fileNameExpression(<span class="hl-string">"headers['"</span> + FileHeaders.FILENAME + <span class="hl-string">"']"</span>)
                        .remoteDirectory(<span class="hl-keyword">this</span>.ftpServer.getTargetFtpDirectory().getName())
                ).get();
    }

    <em><span class="hl-annotation" style="color: gray">@MessagingGateway</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> MyGateway {

         <em><span class="hl-annotation" style="color: gray">@Gateway(requestChannel = "toFtpChannel")</span></em>
         <span class="hl-keyword">void</span> sendToFtp(File file);

    }

}</pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="ftp-outbound-gateway" href="#ftp-outbound-gateway"></a>15.7&nbsp;FTP Outbound Gateway</h2></div></div></div>

<p>The <span class="emphasis"><em>FTP Outbound Gateway</em></span> provides a limited set of commands to interact with a remote FTP/FTPS server.
Commands supported are:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
ls (list files)
</li><li class="listitem">
get (retrieve file)
</li><li class="listitem">
mget (retrieve file(s))
</li><li class="listitem">
rm (remove file(s))
</li><li class="listitem">
mv (move/rename file)
</li><li class="listitem">
put (send file)
</li><li class="listitem">
mput (send multiple files)
</li></ul></div>
<p><span class="strong"><strong>ls</strong></span></p>
<p>ls lists remote file(s) and supports the following options:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
-1 - just retrieve a list of file names, default is to retrieve a list of <code class="literal">FileInfo</code> objects.
</li><li class="listitem">
-a - include all files (including those starting with <span class="emphasis"><em>.</em></span>)
</li><li class="listitem">
-f - do not sort the list
</li><li class="listitem">
-dirs - include directories (excluded by default)
</li><li class="listitem">
-links - include symbolic links (excluded by default)
</li><li class="listitem">
-R - list the remote directory recursively
</li></ul></div>
<p>In addition, filename filtering is provided, in the same manner as the <code class="literal">inbound-channel-adapter</code>.</p>
<p>The message payload resulting from an <span class="emphasis"><em>ls</em></span> operation is a list of file names, or a list of <code class="literal">FileInfo</code> objects.
These objects provide information such as modified time, permissions etc.</p>
<p>The remote directory that the <span class="emphasis"><em>ls</em></span> command acted on is provided in the <code class="literal">file_remoteDirectory</code> header.</p>
<p>When using the recursive option (<code class="literal">-R</code>), the <code class="literal">fileName</code> includes any subdirectory elements, representing a relative path to the file (relative to the remote directory).
If the <code class="literal">-dirs</code> option is included, each recursive directory is also returned as an element in the list.
In this case, it is recommended that the <code class="literal">-1</code> is not used because you would not be able to determine files Vs.
directories, which is achievable using the <code class="literal">FileInfo</code> objects.</p>
<p>Starting with <span class="emphasis"><em>version 4.3</em></span>, the <code class="literal">FtpSession</code> supports <code class="literal">null</code> for the <code class="literal">list()</code> and <code class="literal">listNames()</code> methods,
therefore the <code class="literal">expression</code> attribute can be omitted.
For Java configuration, there are two constructors without an <code class="literal">expression</code> argument for convenience.
<code class="literal">null</code> for <code class="literal">LS</code>, <code class="literal">PUT</code> and <code class="literal">MPUT</code> commands is treated as the Client working directory according to the FTP protocol.
All other commands must be supplied with the <code class="literal">expression</code> to evaluate remote path against request message.
The working directory can be set via the <code class="literal">FTPClient.changeWorkingDirectory()</code> function when you extend the <code class="literal">DefaultFtpSessionFactory</code> and implement <code class="literal">postProcessClientAfterConnect()</code> callback.</p>
<p><span class="strong"><strong>get</strong></span></p>
<p><span class="emphasis"><em>get</em></span> retrieves a remote file and supports the following option:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
-P - preserve the timestamp of the remote file
</li><li class="listitem">
-stream - retrieve the remote file as a stream.
</li></ul></div>
<p>The remote directory is provided in the <code class="literal">file_remoteDirectory</code> header, and the filename is provided in the <code class="literal">file_remoteFile</code> header.</p>
<p>The message payload resulting from a <span class="emphasis"><em>get</em></span> operation is a <code class="literal">File</code> object representing the retrieved file, or
an <code class="literal">InputStream</code> when the <code class="literal">-stream</code> option is provided.
This option allows retrieving the file as a stream.
For text files, a common use case is to combine this operation with a <a class="link" href="#file-splitter" title="14.5&nbsp;File Splitter">File Splitter</a> or
<a class="link" href="#stream-transformer" title="Stream Transformer">Stream Transformer</a>.
When consuming remote files as streams, the user is responsible for closing the <code class="literal">Session</code> after the stream is
consumed.
For convenience, the <code class="literal">Session</code> is provided in the <code class="literal">IntegrationMessageHeaderAccessor.CLOSEABLE_RESOURCE</code> header, a convenience method is provided on the
<code class="literal">IntegrationMessageHeaderAccessor</code>:</p>
<pre class="programlisting">Closeable closeable = <span class="hl-keyword">new</span> IntegrationMessageHeaderAccessor(message).getCloseableResource();
<span class="hl-keyword">if</span> (closeable != null) {
    closeable.close();
}</pre>
<p>Note: In previous releases the session was in the <code class="literal">file_remoteSession</code> header, but this is deprecated - use
<code class="literal">IntegrationMessageHeaderAccessor.CLOSEABLE_RESOURCE</code> instead.</p>
<p>Framework components such as the <a class="link" href="#file-splitter" title="14.5&nbsp;File Splitter">File Splitter</a> and <a class="link" href="#stream-transformer" title="Stream Transformer">Stream Transformer</a> will
automatically close the session after the data is transferred.</p>
<p>The following shows an example of consuming a file as a stream:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-ftp:outbound-gateway</span> <span class="hl-attribute">session-factory</span>=<span class="hl-value">"ftpSessionFactory"</span>
                            <span class="hl-attribute">request-channel</span>=<span class="hl-value">"inboundGetStream"</span>
                            <span class="hl-attribute">command</span>=<span class="hl-value">"get"</span>
                            <span class="hl-attribute">command-options</span>=<span class="hl-value">"-stream"</span>
                            <span class="hl-attribute">expression</span>=<span class="hl-value">"payload"</span>
                            <span class="hl-attribute">remote-directory</span>=<span class="hl-value">"ftpTarget"</span>
                            <span class="hl-attribute">reply-channel</span>=<span class="hl-value">"stream"</span><span class="hl-tag"> /&gt;</span>

<span class="hl-tag">&lt;int-file:splitter</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"stream"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"lines"</span><span class="hl-tag"> /&gt;</span></pre>
<p>Note: if you consume the input stream in a custom component, you <span class="strong"><strong>must</strong></span> close the <code class="literal">Session</code>.
You can either do that in your custom code, or route a copy of the message to a <code class="literal">service-activator</code> and use SpEL:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:service-activator</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"closeSession"</span>
    <span class="hl-attribute">expression</span>=<span class="hl-value">"headers[T(org.springframework.integration.IntegrationMessageHeaderAccessor).CLOSEABLE_RESOURCE].close()"</span><span class="hl-tag"> /&gt;</span></pre>
<p><span class="strong"><strong>mget</strong></span></p>
<p><span class="emphasis"><em>mget</em></span> retrieves multiple remote files based on a pattern and supports the following option:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
-P - preserve the timestamps of the remote files
</li><li class="listitem">
-x - Throw an exception if no files match the pattern (otherwise an empty list is returned)
</li></ul></div>
<p>The message payload resulting from an <span class="emphasis"><em>mget</em></span> operation is a <code class="literal">List&lt;File&gt;</code> object - a List of File objects, each representing a retrieved file.</p>
<p>The remote directory is provided in the <code class="literal">file_remoteDirectory</code> header, and the pattern for the file names is provided in the <code class="literal">file_remoteFile</code> header.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note: Notes for when using recursion (-R)"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Notes for when using recursion (<code class="literal">-R</code>)</th></tr><tr><td align="left" valign="top">

<p>The pattern is ignored, and <code class="literal">*</code> is assumed.
By default, the entire remote tree is retrieved.
However, files in the tree can be filtered, by providing a`FileListFilter`; directories in the tree can also be filtered this way.
A <code class="literal">FileListFilter</code> can be provided by reference or by <code class="literal">filename-pattern</code> or <code class="literal">filename-regex</code> attributes.
For example, <code class="literal">filename-regex="(subDir|.*1.txt)"</code> will retrieve all files ending with <code class="literal">1.txt</code> in the remote directory and the subdirectory <code class="literal">subDir</code>.
If a subdirectory is filtered, no additional traversal of that subdirectory is performed.</p>
<p>The <code class="literal">-dirs</code> option is not allowed (the recursive mget uses the recursive <code class="literal">ls</code> to obtain the directory tree and the directories themselves cannot be included in the list).</p>
<p>Typically, you would use the <code class="literal">#remoteDirectory</code> variable in the <code class="literal">local-directory-expression</code> so that the remote directory structure is retained locally.</p>
</td></tr></table></div>
<p>See also <a class="xref" href="#ftp-partial" title="15.7.3&nbsp;Outbound Gateway Partial Success (mget and mput)">Section&nbsp;15.7.3, &#8220;Outbound Gateway Partial Success (mget and mput)&#8221;</a>.</p>
<p><span class="strong"><strong>put</strong></span></p>
<p><span class="emphasis"><em>put</em></span> sends a file to the remote server; the payload of the message can be a <code class="literal">java.io.File</code>, a <code class="literal">byte[]</code> or a <code class="literal">String</code>.
A <code class="literal">remote-filename-generator</code> (or expression) is used to name the remote file.
Other available attributes include <code class="literal">remote-directory</code>, <code class="literal">temporary-remote-directory</code> (and their <code class="literal">*-expression</code>) equivalents, <code class="literal">use-temporary-file-name</code>, and <code class="literal">auto-create-directory</code>.
Refer to the schema documentation for more information.</p>
<p>The message payload resulting from a <span class="emphasis"><em>put</em></span> operation is a <code class="literal">String</code> representing the full path of the file on the server after transfer.</p>
<p><span class="strong"><strong>mput</strong></span></p>
<p><span class="emphasis"><em>mput</em></span> sends multiple files to the server and supports the following option:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
-R - Recursive - send all files (possibly filtered) in the directory and subdirectories
</li></ul></div>
<p>The message payload must be a <code class="literal">java.io.File</code> representing a local directory.</p>
<p>The same attributes as the <code class="literal">put</code> command are supported.
In addition, files in the local directory can be filtered with one of <code class="literal">mput-pattern</code>, <code class="literal">mput-regex</code> or <code class="literal">mput-filter</code>.
The filter works with recursion, as long as the subdirectories themselves pass the filter.
Subdirectories that do not pass the filter are not recursed.</p>
<p>The message payload resulting from an <span class="emphasis"><em>mget</em></span> operation is a <code class="literal">List&lt;String&gt;</code> object - a List of remote file paths resulting from the transfer.</p>
<p>See also <a class="xref" href="#ftp-partial" title="15.7.3&nbsp;Outbound Gateway Partial Success (mget and mput)">Section&nbsp;15.7.3, &#8220;Outbound Gateway Partial Success (mget and mput)&#8221;</a>.</p>
<p><span class="strong"><strong>rm</strong></span></p>
<p>The <span class="emphasis"><em>rm</em></span> command has no options.</p>
<p>The message payload resulting from an <span class="emphasis"><em>rm</em></span> operation is Boolean.TRUE if the remove was successful, Boolean.FALSE otherwise.
The remote directory is provided in the <code class="literal">file_remoteDirectory</code> header, and the filename is provided in the <code class="literal">file_remoteFile</code> header.</p>
<p><span class="strong"><strong>mv</strong></span></p>
<p>The <span class="emphasis"><em>mv</em></span> command has no options.</p>
<p>The <span class="emphasis"><em>expression</em></span> attribute defines the "from" path and the <span class="emphasis"><em>rename-expression</em></span> attribute defines the "to" path.
By default, the <span class="emphasis"><em>rename-expression</em></span> is <code class="literal">headers['file_renameTo']</code>.
This expression must not evaluate to null, or an empty <code class="literal">String</code>.
If necessary, any remote directories needed will be created.
The payload of the result message is <code class="literal">Boolean.TRUE</code>.
The original remote directory is provided in the <code class="literal">file_remoteDirectory</code> header, and the filename is provided in the <code class="literal">file_remoteFile</code> header.
The new path is in the <code class="literal">file_renameTo</code> header.</p>
<p><span class="strong"><strong>Additional Information</strong></span></p>
<p>The <span class="emphasis"><em>get</em></span> and <span class="emphasis"><em>mget</em></span> commands support the <span class="emphasis"><em>local-filename-generator-expression</em></span> attribute.
It defines a SpEL expression to generate the name of local file(s) during the transfer.
The root object of the evaluation context is the request Message but, in addition, the <code class="literal">remoteFileName</code> variable is also available, which is particularly useful for <span class="emphasis"><em>mget</em></span>, for example: <code class="literal">local-filename-generator-expression="#remoteFileName.toUpperCase() + headers.foo"</code>.</p>
<p>The <span class="emphasis"><em>get</em></span> and <span class="emphasis"><em>mget</em></span> commands support the <span class="emphasis"><em>local-directory-expression</em></span> attribute.
It defines a SpEL expression to generate the name of local directory(ies) during the transfer.
The root object of the evaluation context is the request Message but, in addition, the <code class="literal">remoteDirectory</code> variable is also available, which is particularly useful for <span class="emphasis"><em>mget</em></span>, for example: <code class="literal">local-directory-expression="'/tmp/local/' + #remoteDirectory.toUpperCase() + headers.foo"</code>.
This attribute is mutually exclusive with <span class="emphasis"><em>local-directory</em></span> attribute.</p>
<p>For all commands, the PATH that the command acts on is provided by the <span class="emphasis"><em>expression</em></span> property of the gateway.
For the mget command, the expression might evaluate to <span class="emphasis"><em><span class="strong"><strong></strong></span>, meaning retrieve all files, or <span class="emphasis"><em>somedirectory/</em></span></em></span> etc.</p>
<p>Here is an example of a gateway configured for an ls command&#8230;&#8203;</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-ftp:outbound-gateway</span> <span class="hl-attribute">id</span>=<span class="hl-value">"gateway1"</span>
    <span class="hl-attribute">session-factory</span>=<span class="hl-value">"ftpSessionFactory"</span>
    <span class="hl-attribute">request-channel</span>=<span class="hl-value">"inbound1"</span>
    <span class="hl-attribute">command</span>=<span class="hl-value">"ls"</span>
    <span class="hl-attribute">command-options</span>=<span class="hl-value">"-1"</span>
    <span class="hl-attribute">expression</span>=<span class="hl-value">"payload"</span>
    <span class="hl-attribute">reply-channel</span>=<span class="hl-value">"toSplitter"</span><span class="hl-tag">/&gt;</span></pre>
<p>The payload of the message sent to the toSplitter channel is a list of String objects containing the filename of each
file.
If the <code class="literal">command-options</code> was omitted, it would be a list of <code class="literal">FileInfo</code> objects.
Options are provided space-delimited, e.g.
<code class="literal">command-options="-1 -dirs -links"</code>.</p>
<p>Starting with <span class="emphasis"><em>version 4.2</em></span>, the <code class="literal">GET</code>, <code class="literal">MGET</code>, <code class="literal">PUT</code> and <code class="literal">MPUT</code> commands support a <code class="literal">FileExistsMode</code> property (<code class="literal">mode</code>
when using the namespace support). This affects the behavior when the local file exists (<code class="literal">GET</code> and <code class="literal">MGET</code>) or the remote
file exists (<code class="literal">PUT</code> and <code class="literal">MPUT</code>). Supported modes are <code class="literal">REPLACE</code>, <code class="literal">APPEND</code>, <code class="literal">FAIL</code> and <code class="literal">IGNORE</code>.
For backwards compatibility, the default mode for <code class="literal">PUT</code> and <code class="literal">MPUT</code> operations is <code class="literal">REPLACE</code> and for <code class="literal">GET</code> and <code class="literal">MGET</code>
operations, the default is <code class="literal">FAIL</code>.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_with_java_configuration_13" href="#_configuring_with_java_configuration_13"></a>15.7.1&nbsp;Configuring with Java Configuration</h3></div></div></div>

<p>The following Spring Boot application provides an example of configuring the Outbound Gateway using Java configuration:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@SpringBootApplication</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> FtpJavaApplication {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
        <span class="hl-keyword">new</span> SpringApplicationBuilder(FtpJavaApplication.<span class="hl-keyword">class</span>)
            .web(false)
            .run(args);
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> SessionFactory&lt;FTPFile&gt; ftpSessionFactory() {
        DefaultFtpSessionFactory sf = <span class="hl-keyword">new</span> DefaultFtpSessionFactory();
        sf.setHost(<span class="hl-string">"localhost"</span>);
        sf.setPort(port);
        sf.setUsername(<span class="hl-string">"foo"</span>);
        sf.setPassword(<span class="hl-string">"foo"</span>);
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> CachingSessionFactory&lt;FTPFile&gt;(sf);
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "ftpChannel")</span></em>
    <span class="hl-keyword">public</span> MessageHandler handler() {
        FtpOutboundGateway ftpOutboundGateway = <span class="hl-keyword">new</span> FtpOutboundGateway(ftpSessionFactory(), <span class="hl-string">"ls"</span>);
        ftpOutboundGateway.setOutputChannelName(<span class="hl-string">"lsReplyChannel"</span>);
        <span class="hl-keyword">return</span> ftpOutboundGateway;
    }

}</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_with_the_java_dsl_11" href="#_configuring_with_the_java_dsl_11"></a>15.7.2&nbsp;Configuring with the Java DSL</h3></div></div></div>

<p>The following Spring Boot application provides an example of configuring the Outbound Gateway using the Java DSL:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@SpringBootApplication</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> FtpJavaApplication {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
        <span class="hl-keyword">new</span> SpringApplicationBuilder(FtpJavaApplication.<span class="hl-keyword">class</span>)
            .web(false)
            .run(args);
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> SessionFactory&lt;FTPFile&gt; ftpSessionFactory() {
        DefaultFtpSessionFactory sf = <span class="hl-keyword">new</span> DefaultFtpSessionFactory();
        sf.setHost(<span class="hl-string">"localhost"</span>);
        sf.setPort(port);
        sf.setUsername(<span class="hl-string">"foo"</span>);
        sf.setPassword(<span class="hl-string">"foo"</span>);
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> CachingSessionFactory&lt;FTPFile&gt;(sf);
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> FtpOutboundGatewaySpec ftpOutboundGateway() {
        <span class="hl-keyword">return</span> Ftp.outboundGateway(ftpSessionFactory(),
            AbstractRemoteFileOutboundGateway.Command.MGET, <span class="hl-string">"payload"</span>)
            .options(AbstractRemoteFileOutboundGateway.Option.RECURSIVE)
            .regexFileNameFilter(<span class="hl-string">"(subFtpSource|.*1.txt)"</span>)
            .localDirectoryExpression(<span class="hl-string">"'localDirectory/' + #remoteDirectory"</span>)
            .localFilenameExpression(<span class="hl-string">"#remoteFileName.replaceFirst('ftpSource', 'localTarget')"</span>);
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> IntegrationFlow ftpMGetFlow(AbstractRemoteFileOutboundGateway&lt;FTPFile&gt; ftpOutboundGateway) {
        <span class="hl-keyword">return</span> f -&gt; f
            .handle(ftpOutboundGateway)
            .channel(c -&gt; c.queue(<span class="hl-string">"remoteFileOutputChannel"</span>));
    }

}</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="ftp-partial" href="#ftp-partial"></a>15.7.3&nbsp;Outbound Gateway Partial Success (mget and mput)</h3></div></div></div>

<p>When performing operations on multiple files (<code class="literal">mget</code> and <code class="literal">mput</code>) it is possible that an exception occurs some time after
one or more files have been transferred.
In this case (starting with <span class="emphasis"><em>version 4.2</em></span>), a <code class="literal">PartialSuccessException</code> is thrown.
As well as the usual <code class="literal">MessagingException</code> properties (<code class="literal">failedMessage</code> and <code class="literal">cause</code>), this exception has two additional
properties:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">partialResults</code> - the successful transfer results.
</li><li class="listitem">
<code class="literal">derivedInput</code> - the list of files generated from the request message (e.g. local files to transfer for an <code class="literal">mput</code>).
</li></ul></div>
<p>This will enable you to determine which files were successfully transferred, and which were not.</p>
<p>In the case of a recursive <code class="literal">mput</code>, the <code class="literal">PartialSuccessException</code> may have nested <code class="literal">PartialSuccessException</code> s.</p>
<p>Consider:</p>
<pre class="screen">root/
|- file1.txt
|- subdir/
   | - file2.txt
   | - file3.txt
|- zoo.txt</pre>
<p>If the exception occurs on <code class="literal">file3.txt</code>, the <code class="literal">PartialSuccessException</code> thrown by the gateway will have <code class="literal">derivedInput</code>
of <code class="literal">file1.txt</code>, <code class="literal">subdir</code>, <code class="literal">zoo.txt</code> and <code class="literal">partialResults</code> of <code class="literal">file1.txt</code>.
It&#8217;s <code class="literal">cause</code> will be another <code class="literal">PartialSuccessException</code> with <code class="literal">derivedInput</code> of <code class="literal">file2.txt</code>, <code class="literal">file3.txt</code> and
<code class="literal">partialResults</code> of <code class="literal">file2.txt</code>.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="ftp-session-caching" href="#ftp-session-caching"></a>15.8&nbsp;FTP Session Caching</h2></div></div></div>

<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Starting with <span class="emphasis"><em>Spring Integration version 3.0</em></span>, sessions are no longer cached by default; the <code class="literal">cache-sessions</code> attribute is no longer supported on endpoints.
You must use a <code class="literal">CachingSessionFactory</code> (see below) if you wish to cache sessions.</p>
</td></tr></table></div>
<p>In versions prior to 3.0, the sessions were cached automatically by default.
A <code class="literal">cache-sessions</code> attribute was available for disabling the auto caching, but that solution did not provide a way to configure other session caching attributes.
For example, you could not limit on the number of sessions created.
To support that requirement and other configuration options, a <code class="literal">CachingSessionFactory</code> was provided.
It provides <code class="literal">sessionCacheSize</code> and <code class="literal">sessionWaitTimeout</code> properties.
As its name suggests, the <code class="literal">sessionCacheSize</code> property controls how many active sessions the factory will maintain in its cache (the DEFAULT is unbounded).
If the <code class="literal">sessionCacheSize</code> threshold has been reached, any attempt to acquire another session will block until either one of the cached sessions becomes available or until the wait time for a Session expires (the DEFAULT wait time is Integer.MAX_VALUE).
The <code class="literal">sessionWaitTimeout</code> property enables configuration of that value.</p>
<p>If you want your Sessions to be cached, simply configure your default Session Factory as described above and then wrap it in an instance of <code class="literal">CachingSessionFactory</code> where you may provide those additional properties.</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"ftpSessionFactory"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.ftp.session.DefaultFtpSessionFactory"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"host"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"localhost"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"cachingSessionFactory"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.file.remote.session.CachingSessionFactory"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"ftpSessionFactory"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"10"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"sessionWaitTimeout"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"1000"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
<p>In the above example you see a <code class="literal">CachingSessionFactory</code> created with the <code class="literal">sessionCacheSize</code> set to 10 and the
<code class="literal">sessionWaitTimeout</code> set to 1 second (its value is in milliseconds).</p>
<p>Starting with <span class="emphasis"><em>Spring Integration version 3.0</em></span>, the <code class="literal">CachingConnectionFactory</code> provides a <code class="literal">resetCache()</code> method.
When invoked, all idle sessions are immediately closed and in-use sessions are closed when they are returned to the cache.
New requests for sessions will establish new sessions as necessary.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="ftp-rft" href="#ftp-rft"></a>15.9&nbsp;RemoteFileTemplate</h2></div></div></div>

<p>Starting with <span class="emphasis"><em>Spring Integration version 3.0</em></span> a new abstraction is provided over the <code class="literal">FtpSession</code> object.
The template provides methods to send, retrieve (as an <code class="literal">InputStream</code>), remove, and rename files.
In addition an <code class="literal">execute</code> method is provided allowing the caller to execute multiple operations on the session.
In all cases, the template takes care of reliably closing the session.
For more information, refer to the
<a class="ulink" href="http://docs.spring.io/spring-integration/api/org/springframework/integration/file/remote/RemoteFileTemplate.html" target="_top">JavaDocs for <code class="literal">RemoteFileTemplate</code></a>.
There is a subclass for FTP: <code class="literal">FtpRemoteFileTemplate</code>.</p>
<p>Additional methods were added in <span class="emphasis"><em>version 4.1</em></span> including <code class="literal">getClientInstance()</code> which provides access to the underlying <code class="literal">FTPClient</code> enabling access to low-level APIs.</p>
<p>Not all FTP servers properly implement <code class="literal">STAT &lt;path&gt;</code> command, in that it can return a positive result for a non-existent path.
The <code class="literal">NLST</code> command reliably returns the name, when the path is a file and it exists.
However, this does not support checking that an empty directory exists since <code class="literal">NLST</code> always returns an empty list in this case, when the path is a directory.
Since the template doesn&#8217;t know if the path represents a directory or not, it has to perform additional checks when the path does not appear to exist, when using <code class="literal">NLST</code>.
This adds overhead, requiring several requests to the server.
Starting with <span class="emphasis"><em>version 4.1.9</em></span> the <code class="literal">FtpRemoteFileTemplate</code> provides <code class="literal">FtpRemoteFileTemplate.ExistsMode</code> property with the following options:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">STAT</code> - Perform the <code class="literal">STAT</code> FTP command (<code class="literal">FTPClient.getStatus(path)</code>) to check the path existence; this is the default and requires that your FTP server properly supports the <code class="literal">STAT</code> command (with a path).
</li><li class="listitem">
<code class="literal">NLST</code> - Perform the <code class="literal">NLST</code> FTP command - <code class="literal">FTPClient.listName(path)</code>; use this if you are testing for a path that is a full path to a file; it won&#8217;t work for empty directories.
</li><li class="listitem">
<code class="literal">NLST_AND_DIRS</code> -  Perform the <code class="literal">NLST</code> command first and if it returns no files, fall back to a technique which temporarily switches the working directory using <code class="literal">FTPClient.changeWorkingDirectory(path)</code>.
See <code class="literal">FtpSession.exists()</code> for more information.
</li></ul></div>
<p>Since we know that the <code class="literal">FileExistsMode.FAIL</code> case is always only looking for a file (and not a directory), we safely use <code class="literal">NLST</code> mode for the <code class="literal">FtpMessageHandler</code> and <code class="literal">FtpOutboundGateway</code> components.</p>
<p>For any other cases the <code class="literal">FtpRemoteFileTemplate</code> can be extended for implementing a custom logic in the overridden <code class="literal">exist()</code> method.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="ftp-session-callback" href="#ftp-session-callback"></a>15.10&nbsp;MessageSessionCallback</h2></div></div></div>

<p>Starting with <span class="emphasis"><em>Spring Integration version 4.2</em></span>, a <code class="literal">MessageSessionCallback&lt;F, T&gt;</code> implementation can be used with the
<code class="literal">&lt;int-ftp:outbound-gateway/&gt;</code> (<code class="literal">FtpOutboundGateway</code>) to perform any operation(s) on the <code class="literal">Session&lt;FTPFile&gt;</code> with
the <code class="literal">requestMessage</code> context.
It can be used for any non-standard or low-level FTP operation (or several); for example, allowing access
from an integration flow definition, and <span class="emphasis"><em>functional</em></span> interface (Lambda) implementation injection:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "ftpChannel")</span></em>
<span class="hl-keyword">public</span> MessageHandler ftpOutboundGateway(SessionFactory&lt;FTPFile&gt; sessionFactory) {
    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> FtpOutboundGateway(sessionFactory,
         (session, requestMessage) -&gt; session.list(requestMessage.getPayload()));
}</pre>
<p>Another example might be to pre- or post- process the file data being sent/retrieved.</p>
<p>When using XML configuration, the <code class="literal">&lt;int-ftp:outbound-gateway/&gt;</code> provides a <code class="literal">session-callback</code> attribute to allow you to
specify the <code class="literal">MessageSessionCallback</code> bean name.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The <code class="literal">session-callback</code> is mutually exclusive with the <code class="literal">command</code> and <code class="literal">expression</code> attributes.
When configuring with Java, different constructors are available in the <code class="literal">FtpOutboundGateway</code> class.</p>
</td></tr></table></div>
</div>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="gemfire" href="#gemfire"></a>16.&nbsp;GemFire Support</h2></div></div></div>

<p>Spring Integration provides support for VMWare vFabric GemFire</p>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="gemfire-intro" href="#gemfire-intro"></a>16.1&nbsp;Introduction</h2></div></div></div>

<p>VMWare vFabric GemFire (GemFire) is a distributed data management platform providing a key-value data grid along with advanced distributed system features such as event processing, continuous querying, and remote function execution.
This guide assumes some familiarity with <a class="ulink" href="http://www.vmware.com/support/pubs/vfabric-gemfire.html" target="_top">GemFire</a> and its <a class="ulink" href="http://www.vmware.com/support/developer/vfabric-gemfire/662-api/index.html" target="_top">API</a>.</p>
<p>Spring integration provides support for GemFire by providing inbound adapters for entry and continuous query events, an outbound adapter to write entries to the cache, and <code class="literal">MessageStore</code> and <code class="literal">MessageGroupStore</code> implementations.
Spring integration leverages thehttp://www.springsource.org/spring-gemfire[Spring Gemfire] project, providing a thin wrapper over its components.</p>
<p>To configure the <span class="emphasis"><em>int-gfe</em></span> namespace, include the following elements within the headers of your XML configuration file:</p>
<pre class="programlisting">xmlns:int-gfe="http://www.springframework.org/schema/integration/gemfire"
xsi:schemaLocation="http://www.springframework.org/schema/integration/gemfire
	http://www.springframework.org/schema/integration/gemfire/spring-integration-gemfire.xsd"</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="gemfire-inbound" href="#gemfire-inbound"></a>16.2&nbsp;Inbound Channel Adapter</h2></div></div></div>

<p>The <span class="emphasis"><em>inbound-channel-adapter</em></span> produces messages on a channel triggered by a GemFire <code class="literal">EntryEvent</code>.
GemFire generates events whenever an entry is CREATED, UPDATED, DESTROYED, or INVALIDATED in the associated region.
The inbound channel adapter allows you to filter on a subset of these events.
For example, you may want to only produce messages in response to an entry being CREATED.
In addition, the inbound channel adapter can evaluate a SpEL expression if, for example, you want your message payload to contain an event property such as the new entry value.</p>
<pre class="programlisting"><span class="hl-tag">&lt;gfe:cache/&gt;</span>
<span class="hl-tag">&lt;gfe:replicated-region</span> <span class="hl-attribute">id</span>=<span class="hl-value">"region"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;int-gfe:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"inputChannel"</span> <span class="hl-attribute">region</span>=<span class="hl-value">"region"</span>
    <span class="hl-attribute">cache-events</span>=<span class="hl-value">"CREATED"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"newValue"</span><span class="hl-tag">/&gt;</span></pre>
<p>In the above configuration, we are creating a GemFire <code class="literal">Cache</code> and <code class="literal">Region</code> using Spring GemFire&#8217;s <span class="emphasis"><em>gfe</em></span> namespace.
The inbound-channel-adapter requires a reference to the GemFire region for which the adapter will be listening for events.
Optional attributes include <code class="literal">cache-events</code> which can contain a comma separated list of event types for which a message will be produced on the input channel.
By default CREATED and UPDATED are enabled.
Note that this adapter conforms to Spring integration conventions.
If no <code class="literal">channel</code> attribute is provided, the channel will be created from the <code class="literal">id</code> attribute.
This adapter also supports an <code class="literal">error-channel</code>.
The GemFire <a class="ulink" href="http://www.gemstone.com/docs/current/product/docs/japi/com/gemstone/gemfire/cache/EntryEvent.html" target="_top">EntryEvent</a> is the <code class="literal">#root</code> object of the <code class="literal">expression</code> evaluation.
Example:</p>
<pre class="screen">expression="new foo.MyEvent(key, oldValue, newValue)"</pre>
<p>If the <code class="literal">expression</code> attribute is not provided, the message payload will be the GemFire <code class="literal">EntryEvent</code> itself.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="gemfire-cq" href="#gemfire-cq"></a>16.3&nbsp;Continuous Query Inbound Channel Adapter</h2></div></div></div>

<p>The <span class="emphasis"><em>cq-inbound-channel-adapter</em></span> produces messages a channel triggered by a GemFire continuous query or <code class="literal">CqEvent</code> event.
Spring GemFire introduced continuous query support in release 1.1, including a <code class="literal">ContinuousQueryListenerContainer</code> which provides a nice abstraction over the GemFire native API.
This adapter requires a reference to a ContinuousQueryListenerContainer, and creates a listener for a given <code class="literal">query</code> and executes the query.
The continuous query acts as an event source that will fire whenever its result set changes state.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>GemFire queries are written in OQL and are scoped to the entire cache (not just one region).
Additionally, continuous queries require a remote (i.e., running in a separate process or remote host) cache server.
Please consult the <a class="ulink" href="http://www.gemstone.com/docs/6.6.RC/product/docs/html/user_guide/UserGuide_GemFire.html#Continuous%20Querying" target="_top">GemFire documentation</a> for more information on implementing continuous queries.</p>
</td></tr></table></div>
<pre class="programlisting"><span class="hl-tag">&lt;gfe:client-cache</span> <span class="hl-attribute">id</span>=<span class="hl-value">"client-cache"</span> <span class="hl-attribute">pool-name</span>=<span class="hl-value">"client-pool"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;gfe:pool</span> <span class="hl-attribute">id</span>=<span class="hl-value">"client-pool"</span> <span class="hl-attribute">subscription-enabled</span>=<span class="hl-value">"true"</span><span class="hl-tag"> &gt;</span>
    <span class="hl-comment">&lt;!--configure server or locator here required to address the cache server --&gt;</span>
<span class="hl-tag">&lt;/gfe:pool&gt;</span>

<span class="hl-tag">&lt;gfe:client-region</span> <span class="hl-attribute">id</span>=<span class="hl-value">"test"</span> <span class="hl-attribute">cache-ref</span>=<span class="hl-value">"client-cache"</span> <span class="hl-attribute">pool-name</span>=<span class="hl-value">"client-pool"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;gfe:cq-listener-container</span> <span class="hl-attribute">id</span>=<span class="hl-value">"queryListenerContainer"</span> <span class="hl-attribute">cache</span>=<span class="hl-value">"client-cache"</span>
    <span class="hl-attribute">pool-name</span>=<span class="hl-value">"client-pool"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int-gfe:cq-inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"inputChannel"</span>
    <span class="hl-attribute">cq-listener-container</span>=<span class="hl-value">"queryListenerContainer"</span>
    <span class="hl-attribute">query</span>=<span class="hl-value">"select * from /test"</span><span class="hl-tag">/&gt;</span></pre>
<p>In the above configuration, we are creating a GemFire client cache (recall a remote cache server is required for this implementation and its address is configured as a sub-element of the pool), a client region and a <code class="literal">ContinuousQueryListenerContainer</code> using Spring GemFire.
The continuous query inbound channel adapter requires a <code class="literal">cq-listener-container</code> attribute which contains a reference to the <code class="literal">ContinuousQueryListenerContainer</code>.
Optionally, it accepts an <code class="literal">expression</code> attribute which uses SpEL to transform the <code class="literal">CqEvent</code> or extract an individual property as needed.
The cq-inbound-channel-adapter provides a <code class="literal">query-events</code> attribute, containing a comma separated list of event types for which a message will be produced on the input channel.
Available event types are CREATED, UPDATED, DESTROYED, REGION_DESTROYED, REGION_INVALIDATED.
CREATED and UPDATED are enabled by default.
Additional optional attributes include, <code class="literal">query-name</code> which provides an optional query name, and <code class="literal">expression</code> which works as described in the above section, and <code class="literal">durable</code> - a boolean value indicating if the query is durable (false by default).
Note that this adapter conforms to Spring integration conventions.
If no <code class="literal">channel</code> attribute is provided, the channel will be created from the <code class="literal">id</code> attribute.
This adapter also supports an <code class="literal">error-channel</code></p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="gemfire-outbound" href="#gemfire-outbound"></a>16.4&nbsp;Outbound Channel Adapter</h2></div></div></div>

<p>The <span class="emphasis"><em>outbound-channel-adapter</em></span> writes cache entries mapped from the message payload.
In its simplest form, it expects a payload of type <code class="literal">java.util.Map</code> and puts the map entries into its configured region.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-gfe:outbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"cacheChannel"</span> <span class="hl-attribute">region</span>=<span class="hl-value">"region"</span><span class="hl-tag">/&gt;</span></pre>
<p>Given the above configuration, an exception will be thrown if the payload is not a Map.
Additionally, the outbound channel adapter can be configured to create a map of cache entries using SpEL of course.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-gfe:outbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"cacheChannel"</span> <span class="hl-attribute">region</span>=<span class="hl-value">"region"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int-gfe:cache-entries&gt;</span>
        <span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"payload.toUpperCase()"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"payload.toLowerCase()"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"'foo'"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"'bar'"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/int-gfe:cache-entries&gt;</span>
<span class="hl-tag">&lt;/int-gfe:outbound-channel-adapter&gt;</span></pre>
<p>In the above configuration, the inner element <code class="literal">cache-entries</code> is semantically equivalent to Spring <span class="emphasis"><em>map</em></span> element.
The adapter interprets the <code class="literal">key</code> and <code class="literal">value</code> attributes as SpEL expressions with the message as the evaluation context.
Note that this contain arbitrary cache entries (not only those derived from the message) and that literal values must be enclosed in single quotes.
In the above example, if the message sent to <code class="literal">cacheChannel</code> has a String payload with a value "Hello", two entries <code class="literal">[HELLO:hello, foo:bar]</code> will be written (created or updated) in the cache region.
This adapter also supports the <code class="literal">order</code> attribute which may be useful if it is bound to a PublishSubscribeChannel.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="gemfire-message-store" href="#gemfire-message-store"></a>16.5&nbsp;Gemfire Message Store</h2></div></div></div>

<p>As described in EIP, a <a class="ulink" href="http://www.eaipatterns.com/MessageStore.html" target="_top">Message Store</a> allows you to persist Messages.
This can be very useful when dealing with components that have a capability to buffer messages (<span class="emphasis"><em>QueueChannel, Aggregator, Resequencer</em></span>, etc.) if reliability is a concern.
In Spring Integration, the MessageStore strategy also provides the foundation for thehttp://www.eaipatterns.com/StoreInLibrary.html[ClaimCheck] pattern, which is described in EIP as well.</p>
<p>Spring Integration&#8217;s Gemfire module provides the <code class="literal">GemfireMessageStore</code> which is an implementation of both the the <code class="literal">MessageStore</code> strategy (mainly used by the <span class="emphasis"><em>QueueChannel</em></span> and <span class="emphasis"><em>ClaimCheck</em></span> patterns) and the <code class="literal">MessageGroupStore</code> strategy (mainly used by the <span class="emphasis"><em>Aggregator</em></span> and <span class="emphasis"><em>Resequencer</em></span> patterns).</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"gemfireMessageStore"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.gemfire.store.GemfireMessageStore"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"myRegion"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;gfe:cache/&gt;</span>

<span class="hl-tag">&lt;gfe:replicated-region</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myRegion"</span><span class="hl-tag">/&gt;</span>


<span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"somePersistentQueueChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:queue</span> <span class="hl-attribute">message-store</span>=<span class="hl-value">"gemfireMessageStore"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;int:channel&gt;</span>

<span class="hl-tag">&lt;int:aggregator</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"inputChannel"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"outputChannel"</span>
    <span class="hl-attribute">message-store</span>=<span class="hl-value">"gemfireMessageStore"</span><span class="hl-tag">/&gt;</span></pre>
<p>In the above example, the cache and region are configured using the spring-gemfire namespace (not to be confused with the spring-integration-gemfire namespace).
Often it is desirable for the message store to be maintained in one or more remote cache servers in a client-server configuration (See the <a class="ulink" href="http://www.vmware.com/support/pubs/vfabric-gemfire.html" target="_top">GemFire product documentation</a> for more details).
In this case, you configure a client cache, client region, and client pool and inject the region into the MessageStore.
Here is an example:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"gemfireMessageStore"</span>
    <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.gemfire.store.GemfireMessageStore"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"myRegion"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;gfe:client-cache/&gt;</span>

<span class="hl-tag">&lt;gfe:client-region</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myRegion"</span> <span class="hl-attribute">shortcut</span>=<span class="hl-value">"PROXY"</span> <span class="hl-attribute">pool-name</span>=<span class="hl-value">"messageStorePool"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;gfe:pool</span> <span class="hl-attribute">id</span>=<span class="hl-value">"messageStorePool"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;gfe:server</span> <span class="hl-attribute">host</span>=<span class="hl-value">"localhost"</span> <span class="hl-attribute">port</span>=<span class="hl-value">"40404"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/gfe:pool&gt;</span></pre>
<p>Note the <span class="emphasis"><em>pool</em></span> element is configured with the address of a cache server (a locator may be substituted here).
The region is configured as a <span class="emphasis"><em>PROXY</em></span> so that no data will be stored locally.
The region&#8217;s id corresponds to a region with the same name configured in the cache server.</p>
<p>Starting with version <span class="emphasis"><em>4.3.12</em></span>, the <code class="literal">GemfireMessageStore</code> supports the key <code class="literal">prefix</code> option to allow distinguishing between instances of the store on the same Gemfire region.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="gemfire-lock-registry" href="#gemfire-lock-registry"></a>16.6&nbsp;Gemfire Lock Registry</h2></div></div></div>

<p>Starting with <span class="emphasis"><em>version 4.0</em></span>, the <code class="literal">GemfireLockRegistry</code> is available.
Certain components (for example aggregator and resequencer) use a lock obtained from a <code class="literal">LockRegistry</code> instance to ensure that only one thread is manipulating a group at a time.
The <code class="literal">DefaultLockRegistry</code> performs this function within a single component; you can now configure an external lock registry on these components.
When used with a shared <code class="literal">MessageGroupStore</code>, the <code class="literal">GemfireLockRegistry</code> can be use to provide this functionality across multiple application instances, such that only one instance can manipulate the group at a time.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>One of the <code class="literal">GemfireLockRegistry</code> constructors requires a <code class="literal">Region</code> as an argument; it is used to obtain a <code class="literal">Lock</code> via the <code class="literal">getDistributedLock()</code> method.
This operation requires <code class="literal">GLOBAL</code> scope for the <code class="literal">Region</code>.
Another constructor requires <code class="literal">Cache</code> and the <code class="literal">Region</code> will be created with <code class="literal">GLOBAL</code> scope and with the name <code class="literal">LockRegistry</code>.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="gemfire-metadata-store" href="#gemfire-metadata-store"></a>16.7&nbsp;Gemfire Metadata Store</h2></div></div></div>

<p>As of <span class="emphasis"><em>Spring Integration 4.0</em></span>, a new Gemfire-based <code class="literal">MetadataStore</code> (<a class="xref" href="#metadata-store" title="9.5&nbsp;Metadata Store">Section&nbsp;9.5, &#8220;Metadata Store&#8221;</a>) implementation is available.
The <code class="literal">GemfireMetadataStore</code> can be used to maintain metadata state across application restarts.
This new <code class="literal">MetadataStore</code> implementation can be used with adapters such as:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="xref" href="#twitter-inbound" title="32.4&nbsp;Twitter Inbound Adapters">Section&nbsp;32.4, &#8220;Twitter Inbound Adapters&#8221;</a>
</li><li class="listitem">
<a class="xref" href="#feed-inbound-channel-adapter" title="13.2&nbsp;Feed Inbound Channel Adapter">Section&nbsp;13.2, &#8220;Feed Inbound Channel Adapter&#8221;</a>
</li><li class="listitem">
<a class="xref" href="#file-reading" title="14.2&nbsp;Reading Files">Section&nbsp;14.2, &#8220;Reading Files&#8221;</a>
</li><li class="listitem">
<a class="xref" href="#ftp-inbound" title="15.4&nbsp;FTP Inbound Channel Adapter">Section&nbsp;15.4, &#8220;FTP Inbound Channel Adapter&#8221;</a>
</li><li class="listitem">
<a class="xref" href="#sftp-inbound" title="27.7&nbsp;SFTP Inbound Channel Adapter">Section&nbsp;27.7, &#8220;SFTP Inbound Channel Adapter&#8221;</a>
</li></ul></div>
<p>In order to instruct these adapters to use the new <code class="literal">GemfireMetadataStore</code>, simply declare a Spring bean using the bean name <span class="strong"><strong>metadataStore</strong></span>.
The <span class="emphasis"><em>Twitter Inbound Channel Adapter</em></span> and the <span class="emphasis"><em>Feed Inbound Channel Adapter</em></span> will both automatically pick up and use the declared <code class="literal">GemfireMetadataStore</code>.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The <code class="literal">GemfireMetadataStore</code> also implements <code class="literal">ConcurrentMetadataStore</code>, allowing it to be reliably shared across multiple application instances where only one instance will be allowed to store or modify a key&#8217;s value.
These methods give various levels of concurrency guarantees based on the scope and data policy of the region.
They are implemented in the peer cache and client/server cache but are disallowed in peer Regions having NORMAL or EMPTY data policies.</p>
</td></tr></table></div>
</div>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="http" href="#http"></a>17.&nbsp;HTTP Support</h2></div></div></div>

<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="http-intro" href="#http-intro"></a>17.1&nbsp;Introduction</h2></div></div></div>

<p>The HTTP support allows for the execution of HTTP requests and the processing of inbound HTTP requests.
Because interaction over HTTP is always synchronous, even if all that is returned is a 200 status code, the HTTP support consists of two gateway implementations: <code class="literal">HttpInboundEndpoint</code> and <code class="literal">HttpRequestExecutingMessageHandler</code>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="http-inbound" href="#http-inbound"></a>17.2&nbsp;Http Inbound Components</h2></div></div></div>

<p>To receive messages over HTTP, you need to use an <span class="emphasis"><em>HTTP Inbound
		Channel Adapter</em></span> or <span class="emphasis"><em>Gateway</em></span>.
To support the <span class="emphasis"><em>HTTP Inbound Adapters</em></span>, they need to be deployed within a servlet container such as <a class="ulink" href="http://tomcat.apache.org/" target="_top">Apache Tomcat</a> or <a class="ulink" href="http://www.eclipse.org/jetty/" target="_top">Jetty</a>.
The easiest way to do this is to use Spring&#8217;s
<a class="ulink" href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/web/context/support/HttpRequestHandlerServlet.html" target="_top">HttpRequestHandlerServlet</a>,
 by providing the following servlet definition in the <span class="emphasis"><em>web.xml</em></span> file:</p>
<pre class="programlisting"><span class="hl-tag">&lt;servlet&gt;</span>
    <span class="hl-tag">&lt;servlet-name&gt;</span>inboundGateway<span class="hl-tag">&lt;/servlet-name&gt;</span>
    <span class="hl-tag">&lt;servlet-class&gt;</span>o.s.web.context.support.HttpRequestHandlerServlet<span class="hl-tag">&lt;/servlet-class&gt;</span>
<span class="hl-tag">&lt;/servlet&gt;</span></pre>
<p>Notice that the servlet name matches the bean name.
For more information on using the <code class="literal">HttpRequestHandlerServlet</code>, see chapter
<a class="ulink" href="http://docs.spring.io/spring/docs/current/spring-framework-reference/html/remoting.html" target="_top">Remoting and web services using Spring</a>,
which is part of the Spring Framework Reference documentation.</p>
<p>If you are running within a Spring MVC application, then the aforementioned explicit servlet definition is not necessary.
In that case, the bean name for your gateway can be matched against the URL path just like a Spring MVC Controller bean.
For more information, please see the chapter
<a class="ulink" href="http://docs.spring.io/spring/docs/current/spring-framework-reference/html/mvc.html" target="_top">Web MVC framework</a>, which is part of the Spring Framework Reference documentation.</p>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>For a sample application and the corresponding configuration, please see the <a class="ulink" href="https://github.com/spring-projects/spring-integration-samples" target="_top">Spring Integration Samples</a> repository.
It contains the <a class="ulink" href="https://github.com/spring-projects/spring-integration-samples/tree/master/basic/http" target="_top">Http Sample</a> application demonstrating Spring Integration&#8217;s HTTP support.</p>
</td></tr></table></div>
<p>Below is an example bean definition for a simple HTTP inbound endpoint.</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"httpInbound"</span>
  <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.http.inbound.HttpRequestHandlingMessagingGateway"</span><span class="hl-tag">&gt;</span>
  <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"requestChannel"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"httpRequestChannel"</span><span class="hl-tag"> /&gt;</span>
  <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"replyChannel"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"httpReplyChannel"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
<p>The <code class="literal">HttpRequestHandlingMessagingGateway</code> accepts a list of <code class="literal">HttpMessageConverter</code> instances or else relies on a default list.
The converters allow customization of the mapping from <code class="literal">HttpServletRequest</code> to <code class="literal">Message</code>.
The default converters encapsulate simple strategies, which for example will create a String message for a <span class="emphasis"><em>POST</em></span> request where the content type starts with "text", see the Javadoc for full details.
An additional flag (<code class="literal">mergeWithDefaultConverters</code>) can be set along with the list of custom <code class="literal">HttpMessageConverter</code> to add the default converters after the custom converters.
By default this flag is set to false, meaning that the custom converters replace the default list.</p>
<p>The message conversion process uses the (optional) <code class="literal">requestPayloadType</code> property and the incoming <code class="literal">Content-Type</code> header.
Starting with <span class="emphasis"><em>version 4.3</em></span>, if a request has no content type header, <code class="literal">application/octet-stream</code> is assumed, as
recommended by <code class="literal">RFC 2616</code>.
Previously, the body of such messages was ignored.</p>
<p>Starting with <span class="emphasis"><em>Spring Integration 2.0</em></span>, MultiPart File support is implemented.
If the request has been wrapped as a <code class="literal">MultipartHttpServletRequest</code>, when using the default converters, that request will be converted to a Message payload that is a <code class="literal">MultiValueMap</code> containing values that may be byte arrays, Strings, or instances of Spring&#8217;s <code class="literal">MultipartFile</code> depending on the content type of the individual parts.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The HTTP inbound Endpoint will locate a <code class="literal">MultipartResolver</code> in the context if one exists with the bean name "multipartResolver" (the same name expected by Spring&#8217;s <code class="literal">DispatcherServlet</code>).
If it does in fact locate that bean, then the support for MultipartFiles will be enabled on the inbound request mapper.
Otherwise, it will fail when trying to map a multipart-file request to a Spring Integration Message.
For more on Spring&#8217;s support for <code class="literal">MultipartResolver</code>, refer to the
<a class="ulink" href="http://docs.spring.io/spring/docs/current/spring-framework-reference/html/mvc.html#mvc-multipart" target="_top">Spring Reference Manual</a>.</p>
</td></tr></table></div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>If you wish to proxy a <code class="literal">multipart/form-data</code> to another server, it may be better to keep it in raw form.
To handle this situation, do not add the <code class="literal">multipartResolver</code> bean to the context; configure the endpoint to expect
a <code class="literal">byte[]</code> request; customize the message converters to include a <code class="literal">ByteArrayHttpMessageConverter</code>, and
disable the default multipart converter.
You may need some other converter(s) for the replies:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-http:inbound-gateway</span>
                  <span class="hl-attribute">channel</span>=<span class="hl-value">"receiveChannel"</span>
                  <span class="hl-attribute">path</span>=<span class="hl-value">"/inboundAdapter.htm"</span>
                  <span class="hl-attribute">request-payload-type</span>=<span class="hl-value">"byte[]"</span>
                  <span class="hl-attribute">message-converters</span>=<span class="hl-value">"converters"</span>
                  <span class="hl-attribute">merge-with-default-converters</span>=<span class="hl-value">"false"</span>
                  <span class="hl-attribute">supported-methods</span>=<span class="hl-value">"POST"</span><span class="hl-tag"> /&gt;</span>

<span class="hl-tag">&lt;util:list</span> <span class="hl-attribute">id</span>=<span class="hl-value">"converters"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;beans:bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.http.converter.ByteArrayHttpMessageConverter"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;beans:bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.http.converter.StringHttpMessageConverter"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;beans:bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.http.converter.json.MappingJackson2HttpMessageConverter"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/util:list&gt;</span></pre>
</td></tr></table></div>
<p>In sending a response to the client there are a number of ways to customize the behavior of the gateway.
By default the gateway will simply acknowledge that the request was received by sending a 200 status code back.
It is possible to customize this response by providing a <span class="emphasis"><em>viewName</em></span> to be resolved by the Spring MVC <code class="literal">ViewResolver</code>.
In the case that the gateway should expect a reply to the <code class="literal">Message</code> then setting the <code class="literal">expectReply</code> flag (constructor argument) will cause the gateway to wait for a reply <code class="literal">Message</code> before creating an HTTP response.
Below is an example of a gateway configured to serve as a Spring MVC Controller with a view name.
Because of the constructor arg value of TRUE, it wait for a reply.
This also shows how to customize the HTTP methods accepted by the gateway, which are <span class="emphasis"><em>POST</em></span> and <span class="emphasis"><em>GET</em></span> by default.</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"httpInbound"</span>
  <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.http.inbound.HttpRequestHandlingController"</span><span class="hl-tag">&gt;</span>
  <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"true"</span><span class="hl-tag"> /&gt;</span> <span class="hl-comment">&lt;!-- indicates that a reply is expected --&gt;</span>
  <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"requestChannel"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"httpRequestChannel"</span><span class="hl-tag"> /&gt;</span>
  <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"replyChannel"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"httpReplyChannel"</span><span class="hl-tag"> /&gt;</span>
  <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"viewName"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"jsonView"</span><span class="hl-tag"> /&gt;</span>
  <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"supportedMethodNames"</span><span class="hl-tag"> &gt;</span>
    <span class="hl-tag">&lt;list&gt;</span>
      <span class="hl-tag">&lt;value&gt;</span>GET<span class="hl-tag">&lt;/value&gt;</span>
      <span class="hl-tag">&lt;value&gt;</span>DELETE<span class="hl-tag">&lt;/value&gt;</span>
    <span class="hl-tag">&lt;/list&gt;</span>
  <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
<p>The reply message will be available in the Model map.
The key that is used for that map entry by default is <span class="emphasis"><em>reply</em></span>, but this can be overridden by setting the <span class="emphasis"><em>replyKey</em></span> property on the endpoint&#8217;s configuration.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="http-outbound" href="#http-outbound"></a>17.3&nbsp;Http Outbound Components</h2></div></div></div>

<p>To configure the <code class="literal">HttpRequestExecutingMessageHandler</code> write a bean definition like this:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"httpOutbound"</span>
  <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.http.outbound.HttpRequestExecutingMessageHandler"</span><span class="hl-tag">&gt;</span>
  <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"http://localhost:8080/example"</span><span class="hl-tag"> /&gt;</span>
  <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"outputChannel"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"responseChannel"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
<p>This bean definition will execute HTTP requests by delegating to a <code class="literal">RestTemplate</code>.
That template in turn delegates to a list of HttpMessageConverters to generate the HTTP request body from the Message payload.
You can configure those converters as well as the ClientHttpRequestFactory instance to use:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"httpOutbound"</span>
  <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.http.outbound.HttpRequestExecutingMessageHandler"</span><span class="hl-tag">&gt;</span>
  <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"http://localhost:8080/example"</span><span class="hl-tag"> /&gt;</span>
  <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"outputChannel"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"responseChannel"</span><span class="hl-tag"> /&gt;</span>
  <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"messageConverters"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"messageConverterList"</span><span class="hl-tag"> /&gt;</span>
  <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"requestFactory"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"customRequestFactory"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
<p>By default the HTTP request will be generated using an instance of <code class="literal">SimpleClientHttpRequestFactory</code> which uses the JDK <code class="literal">HttpURLConnection</code>.
Use of the Apache Commons HTTP Client is also supported through the provided <code class="literal">CommonsClientHttpRequestFactory</code> which can be injected as shown above.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>In the case of the Outbound Gateway, the reply message produced by the gateway will contain all Message Headers present in the request message.</p>
</td></tr></table></div>
<p><span class="emphasis"><em>Cookies</em></span></p>
<p>Basic cookie support is provided by the <span class="emphasis"><em>transfer-cookies</em></span> attribute on the outbound gateway.
When set to true (default is false), a <span class="emphasis"><em>Set-Cookie</em></span> header received from the server in a response will be converted to <span class="emphasis"><em>Cookie</em></span> in the reply message.
This header will then be used on subsequent sends.
This enables simple stateful interactions, such as&#8230;&#8203;</p>
<p><code class="literal">...-&gt;logonGateway-&gt;...-&gt;doWorkGateway-&gt;...-&gt;logoffGateway-&gt;...</code></p>
<p>If <span class="emphasis"><em>transfer-cookies</em></span> is false, any <span class="emphasis"><em>Set-Cookie</em></span> header received will remain as <span class="emphasis"><em>Set-Cookie</em></span> in the reply message, and will be dropped on subsequent sends.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note: Note: Empty Response Bodies"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note: Empty Response Bodies</th></tr><tr><td align="left" valign="top">

<p>HTTP is a request/response protocol.
However the response may not have a body, just headers.
In this case, the <code class="literal">HttpRequestExecutingMessageHandler</code> produces a reply <code class="literal">Message</code> with the payload being an <code class="literal">org.springframework.http.ResponseEntity</code>, regardless of any provided <code class="literal">expected-response-type</code>.
According to the <a class="ulink" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html" target="_top">HTTP RFC Status Code Definitions</a>, there are many statuses which identify that a response MUST NOT contain a message-body (e.g.
204 No Content).
There are also cases where calls to the same URL might, or might not, return a response body; for example, the first request to an HTTP resource returns content, but the second does not (e.g.
304 Not Modified).
In all cases, however, the <code class="literal">http_statusCode</code> message header is populated.
This can be used in some routing logic after the Http Outbound Gateway.
You could also use a`&lt;payload-type-router/&gt;` to route messages with an <code class="literal">ResponseEntity</code> to a different flow than that used for responses with a body.</p>
</td></tr></table></div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note: Note: expected-response-type"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note: expected-response-type</th></tr><tr><td align="left" valign="top">

<p>Further to the note above regarding <span class="strong"><strong>empty response bodies</strong></span>, if a response <span class="strong"><strong>does</strong></span> contain a body, you must provide an appropriate <code class="literal">expected-response-type</code> attribute or, again, you will simply receive a <code class="literal">ResponseEntity</code> with no body.
The <code class="literal">expected-response-type</code> must be compatible with the (configured or default) <code class="literal">HttpMessageConverter</code> s and the <code class="literal">Content-Type</code> header in the response.
Of course, this can be an abstract class, or even an interface (such as <code class="literal">java.io.Serializable</code> when using java serialization and <code class="literal">Content-Type: application/x-java-serialized-object</code>).</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="http-namespace" href="#http-namespace"></a>17.4&nbsp;HTTP Namespace Support</h2></div></div></div>

<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_introduction_4" href="#_introduction_4"></a>17.4.1&nbsp;Introduction</h3></div></div></div>

<p>Spring Integration provides an <span class="emphasis"><em>http</em></span> namespace and the corresponding schema definition.
To include it in your configuration, simply provide the following namespace declaration in your application context configuration file:</p>
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
  <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
  <span class="hl-attribute">xmlns:int</span>=<span class="hl-value">"http://www.springframework.org/schema/integration"</span>
  <span class="hl-attribute">xmlns:int-http</span>=<span class="hl-value">"http://www.springframework.org/schema/integration/http"</span>
  <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"
    http://www.springframework.org/schema/beans
    http://www.springframework.org/schema/beans/spring-beans.xsd
    http://www.springframework.org/schema/integration
    http://www.springframework.org/schema/integration/spring-integration.xsd
    http://www.springframework.org/schema/integration/http
    http://www.springframework.org/schema/integration/http/spring-integration-http.xsd"</span><span class="hl-tag">&gt;</span>
    ...
<span class="hl-tag">&lt;/beans&gt;</span></pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_inbound" href="#_inbound"></a>17.4.2&nbsp;Inbound</h3></div></div></div>

<p>The XML Namespace provides two components for handling HTTP Inbound requests.
In order to process requests without returning a dedicated response, use the <span class="emphasis"><em>inbound-channel-adapter</em></span>:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-http:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"httpChannelAdapter"</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"requests"</span>
    <span class="hl-attribute">supported-methods</span>=<span class="hl-value">"PUT, DELETE"</span><span class="hl-tag">/&gt;</span></pre>
<p>To process requests that do expect a response, use an <span class="emphasis"><em>inbound-gateway</em></span>:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-http:inbound-gateway</span> <span class="hl-attribute">id</span>=<span class="hl-value">"inboundGateway"</span>
    <span class="hl-attribute">request-channel</span>=<span class="hl-value">"requests"</span>
    <span class="hl-attribute">reply-channel</span>=<span class="hl-value">"responses"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_request_mapping_support" href="#_request_mapping_support"></a>17.4.3&nbsp;Request Mapping Support</h3></div></div></div>

<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p><span class="emphasis"><em>Spring Integration 3.0</em></span> is improving the REST support by introducing the <a class="ulink" href="http://static.springsource.org/spring-integration/api/org/springframework/integration/http/inbound/IntegrationRequestMappingHandlerMapping.html" target="_top">IntegrationRequestMappingHandlerMapping</a>.
The implementation relies on the enhanced REST support provided by Spring Framework 3.1 or higher.</p>
</td></tr></table></div>
<p>The parsing of the <span class="emphasis"><em>HTTP Inbound Gateway</em></span> or the <span class="emphasis"><em>HTTP Inbound Channel Adapter</em></span> registers an <code class="literal">integrationRequestMappingHandlerMapping</code> bean of type <a class="ulink" href="http://static.springsource.org/spring-integration/api/org/springframework/integration/http/inbound/IntegrationRequestMappingHandlerMapping.html" target="_top">IntegrationRequestMappingHandlerMapping</a>, in case there is none registered, yet.
This particular implementation of the <a class="ulink" href="http://static.springsource.org/spring/docs/current/javadoc-api/org/springframework/web/servlet/HandlerMapping.html" target="_top"><code class="literal">HandlerMapping</code></a> delegates its logic to the <a class="ulink" href="http://static.springsource.org/spring/docs/current/javadoc-api/org/springframework/web/servlet/mvc/method/RequestMappingInfoHandlerMapping.html" target="_top"><code class="literal">RequestMappingInfoHandlerMapping</code></a>.
The implementation provides similar functionality as the one provided by the <a class="ulink" href="http://static.springsource.org/spring/docs/current/javadoc-api/org/springframework/web/bind/annotation/RequestMapping.html" target="_top"><code class="literal">org.springframework.web.bind.annotation.RequestMapping</code></a> annotation in Spring MVC.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>For more information, please see <a class="ulink" href="http://static.springsource.org/spring/docs/current/spring-framework-reference/html/mvc.html#mvc-ann-requestmapping" target="_top">Mapping Requests With <code class="literal">@RequestMapping</code></a>.</p>
</td></tr></table></div>
<p>For this purpose, <span class="emphasis"><em>Spring Integration 3.0</em></span> introduces the <code class="literal">&lt;request-mapping&gt;</code> sub-element.
This optional sub-element can be added to the <code class="literal">&lt;http:inbound-channel-adapter&gt;</code> and the <code class="literal">&lt;http:inbound-gateway&gt;</code>.
It works in conjunction with the <code class="literal">path</code> and <code class="literal">supported-methods</code> attributes:</p>
<pre class="programlisting"><span class="hl-tag">&lt;inbound-gateway</span> <span class="hl-attribute">id</span>=<span class="hl-value">"inboundController"</span>
    <span class="hl-attribute">request-channel</span>=<span class="hl-value">"requests"</span>
    <span class="hl-attribute">reply-channel</span>=<span class="hl-value">"responses"</span>
    <span class="hl-attribute">path</span>=<span class="hl-value">"/foo/{fooId}"</span>
    <span class="hl-attribute">supported-methods</span>=<span class="hl-value">"GET"</span>
    <span class="hl-attribute">view-name</span>=<span class="hl-value">"foo"</span>
    <span class="hl-attribute">error-code</span>=<span class="hl-value">"oops"</span><span class="hl-tag">&gt;</span>
   <span class="hl-tag">&lt;request-mapping</span> <span class="hl-attribute">headers</span>=<span class="hl-value">"User-Agent"</span>
     <span class="hl-attribute">params</span>=<span class="hl-value">"myParam=myValue"</span>
     <span class="hl-attribute">consumes</span>=<span class="hl-value">"application/json"</span>
     <span class="hl-attribute">produces</span>=<span class="hl-value">"!text/plain"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/inbound-gateway&gt;</span></pre>
<p>Based on this configuration, the namespace parser creates an instance of the <code class="literal">IntegrationRequestMappingHandlerMapping</code> (if none exists, yet), a <code class="literal">HttpRequestHandlingController</code> bean and associated with it an instance of <a class="ulink" href="http://static.springsource.org/spring-integration/api/org/springframework/integration/http/inbound/RequestMapping.html" target="_top"><code class="literal">RequestMapping</code></a>, which in turn, is converted to the Spring MVC <a class="ulink" href="http://static.springsource.org/spring/docs/current/javadoc-api/org/springframework/web/servlet/mvc/method/RequestMappingInfo.html" target="_top"><code class="literal">RequestMappingInfo</code></a>.</p>
<p>The <code class="literal">&lt;request-mapping&gt;</code> sub-element provides the following attributes:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
headers
</li><li class="listitem">
params
</li><li class="listitem">
consumes
</li><li class="listitem">
produces
</li></ul></div>
<p>With the <code class="literal">path</code> and <code class="literal">supported-methods</code> attributes of the <code class="literal">&lt;http:inbound-channel-adapter&gt;</code> or the <code class="literal">&lt;http:inbound-gateway&gt;</code>, <code class="literal">&lt;request-mapping&gt;</code> attributes translate directly into the respective options provided by the <code class="literal">org.springframework.web.bind.annotation.RequestMapping</code> annotation in Spring MVC.</p>
<p>The <code class="literal">&lt;request-mapping&gt;</code> sub-element allows you to configure several <span class="emphasis"><em>Spring Integration</em></span> HTTP Inbound Endpoints to the same <code class="literal">path</code> (or even the same <code class="literal">supported-methods</code>) and to provide different downstream message flows based on incoming HTTP requests.</p>
<p>Alternatively, you can also declare just one HTTP Inbound Endpoint and apply routing and filtering logic within the <span class="emphasis"><em>Spring Integration</em></span> flow to achieve the same result.
This allows you to get the <code class="literal">Message</code> into the flow as early as possibly, e.g.:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-http:inbound-gateway</span> <span class="hl-attribute">request-channel</span>=<span class="hl-value">"httpMethodRouter"</span>
    <span class="hl-attribute">supported-methods</span>=<span class="hl-value">"GET,DELETE"</span>
    <span class="hl-attribute">path</span>=<span class="hl-value">"/process/{entId}"</span>
    <span class="hl-attribute">payload-expression</span>=<span class="hl-value">"#pathVariables.entId"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int:router</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"httpMethodRouter"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"headers.http_requestMethod"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:mapping</span> <span class="hl-attribute">value</span>=<span class="hl-value">"GET"</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"in1"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int:mapping</span> <span class="hl-attribute">value</span>=<span class="hl-value">"DELETE"</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"in2"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:router&gt;</span>

<span class="hl-tag">&lt;int:service-activator</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"in1"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"service"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"getEntity"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int:service-activator</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"in2"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"service"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"delete"</span><span class="hl-tag">/&gt;</span></pre>
<p>For more information regarding <span class="emphasis"><em>Handler Mappings</em></span>, please see: <a class="ulink" href="http://static.springsource.org/spring/docs/current/spring-framework-reference/html/mvc.html#mvc-handlermapping" target="_top">Handler Mappings</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="http-cors" href="#http-cors"></a>17.4.4&nbsp;Cross-Origin Resource Sharing (CORS) Support</h3></div></div></div>

<p>Starting with <span class="emphasis"><em>version 4.2</em></span> the <code class="literal">&lt;http:inbound-channel-adapter&gt;</code> and <code class="literal">&lt;http:inbound-gateway&gt;</code> can be configured with
a <code class="literal">&lt;cross-origin&gt;</code> sub-element.
It represents the same options as Spring MVC&#8217;s <code class="literal">@CrossOrigin</code> for <code class="literal">@Controller</code> methods
and allows the configuration of Cross-origin resource sharing (CORS) for Spring Integration HTTP endpoints:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">origin</code> - List of allowed origins.
<code class="literal">*</code> means that all origins are allowed.
These values are placed in the <code class="literal">Access-Control-Allow-Origin</code> header of both the pre-flight
and actual responses.
Default value is <code class="literal">*</code>.
</li><li class="listitem">
<code class="literal">allowed-headers</code> - Indicates which request headers can be used during the actual request.
<code class="literal">*</code> means that all headers asked by the client are allowed.
This property controls the value of the pre-flight response&#8217;s <code class="literal">Access-Control-Allow-Headers</code> header.
Default value is <code class="literal">*</code>.
</li><li class="listitem">
<code class="literal">exposed-headers</code> - List of response headers that the user-agent will allow the client to access.
This property controls the value of the actual response&#8217;s <code class="literal">Access-Control-Expose-Headers</code> header.
</li><li class="listitem">
<code class="literal">method</code> - The HTTP request methods to allow: GET, POST, HEAD, OPTIONS, PUT, PATCH, DELETE, TRACE.
Methods specified here overrides those in <code class="literal">supported-methods</code>.
</li><li class="listitem">
<code class="literal">allow-credentials</code> - Set to <code class="literal">true</code> if the the browser should include any cookies associated to the domain
of the request, or <code class="literal">false</code> if it should not.
Empty string "" means undefined.
If <code class="literal">true</code>, the pre-flight response will include the header <code class="literal">Access-Control-Allow-Credentials=true</code>.
Default value is <code class="literal">true</code>.
</li><li class="listitem">
<code class="literal">max-age</code> - Controls the cache duration for pre-flight responses.
Setting this to a reasonable value can reduce the number of pre-flight request/response interactions required by
the browser.
This property controls the value of the <code class="literal">Access-Control-Max-Age</code> header in the pre-flight response.
A value of <code class="literal">-1</code> means undefined.
Default value is 1800 seconds, or 30 minutes.
</li></ul></div>
<p>The CORS Java Configuration is represented by the <code class="literal">org.springframework.integration.http.inbound.CrossOrigin</code> class,
instances of which can be injected to the <code class="literal">HttpRequestHandlingEndpointSupport</code> beans.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="http-response-statuscode" href="#http-response-statuscode"></a>17.4.5&nbsp;Response StatusCode</h3></div></div></div>

<p>Starting with <span class="emphasis"><em>version 4.1</em></span> the <code class="literal">&lt;http:inbound-channel-adapter&gt;</code> can be configured with a <code class="literal">status-code-expression</code> to override the default <code class="literal">200 OK</code> status.
The expression must return an object which can be converted to an <code class="literal">org.springframework.http.HttpStatus</code> enum value.
The <code class="literal">evaluationContext</code> has a <code class="literal">BeanResolver</code> but no variables, so the usage of this attribute is somewhat limited.
An example might be to resolve, at runtime, some scoped Bean that returns a status code value but, most likely, it will be set to a fixed value such as <code class="literal">status-code=expression="204"</code> (No Content), or <code class="literal">status-code-expression="T(org.springframework.http.HttpStatus).NO_CONTENT"</code>.
By default, <code class="literal">status-code-expression</code> is null meaning that the normal <span class="emphasis"><em>200 OK</em></span> response status will be returned.</p>
<pre class="programlisting"><span class="hl-tag">&lt;http:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"inboundController"</span>
       <span class="hl-attribute">channel</span>=<span class="hl-value">"requests"</span> <span class="hl-attribute">view-name</span>=<span class="hl-value">"foo"</span> <span class="hl-attribute">error-code</span>=<span class="hl-value">"oops"</span>
       <span class="hl-attribute">status-code-expression</span>=<span class="hl-value">"T(org.springframework.http.HttpStatus).ACCEPTED"</span><span class="hl-tag">&gt;</span>
   <span class="hl-tag">&lt;request-mapping</span> <span class="hl-attribute">headers</span>=<span class="hl-value">"BAR"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/http:inbound-channel-adapter&gt;</span></pre>
<p>The <code class="literal">&lt;http:inbound-gateway&gt;</code> resolves the <span class="emphasis"><em>status code</em></span> from the <code class="literal">http_statusCode</code> header of the reply Message.
Starting with <span class="emphasis"><em>version 4.2</em></span>, the default response status code when no reply is received within the <code class="literal">reply-timeout</code>
is <code class="literal">500 Internal Server Error</code>.
There are two ways to modify this behavior:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
add a <code class="literal">reply-timeout-status-code-expression</code> - this has the same semantics as the <code class="literal">status-code-expression</code> on the
inbound adapter.
</li><li class="listitem">
Add an <code class="literal">error-channel</code> and return an appropriate message with an http status code header, such as&#8230;&#8203;
</li></ul></div>
<pre class="programlisting"><span class="hl-tag">&lt;int:chain</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"errors"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:header-enricher&gt;</span>
        <span class="hl-tag">&lt;int:header</span> <span class="hl-attribute">name</span>=<span class="hl-value">"http_statusCode"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"504"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;/int:header-enricher&gt;</span>
    <span class="hl-tag">&lt;int:transformer</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"payload.failedMessage"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/int:chain&gt;</span></pre>
<p>The payload of the <code class="literal">ErrorMessage</code> is a <code class="literal">MessageTimeoutException</code>; it must be transformed to something that can be
converted by the gateway, such as a <code class="literal">String</code>; a good candidate is the exception&#8217;s message property, which is the
value used when using the expression technique.</p>
<p>If the error flow times out after a main flow timeout, <code class="literal">500 Internal Server Error</code> is returned, or the
<code class="literal">reply-timeout-status-code-expression</code> is evaluated, if present.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>previously, the default status code for a timeout was <code class="literal">200 OK</code>; to restore that behavior, set
<code class="literal">reply-timeout-status-code-expression="200"</code>.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_uri_template_variables_and_expressions" href="#_uri_template_variables_and_expressions"></a>17.4.6&nbsp;URI Template Variables and Expressions</h3></div></div></div>

<p>By Using the <span class="emphasis"><em>path</em></span> attribute in conjunction with the <span class="emphasis"><em>payload-expression</em></span> attribute as well as the <span class="emphasis"><em>header</em></span> sub-element, you have a high degree of flexibility for mapping inbound request data.</p>
<p>In the following example configuration, an Inbound Channel Adapter is configured to accept requests using the following URI: <code class="literal">/first-name/{firstName}/last-name/{lastName}</code></p>
<p>Using the <span class="emphasis"><em>payload-expression</em></span> attribute, the URI template variable <span class="emphasis"><em>{firstName}</em></span> is mapped to be the Message payload, while the <span class="emphasis"><em>{lastName}</em></span> URI template variable will map to the <span class="emphasis"><em>lname</em></span> Message header.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-http:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"inboundAdapterWithExpressions"</span>
    <span class="hl-attribute">path</span>=<span class="hl-value">"/first-name/{firstName}/last-name/{lastName}"</span>
    <span class="hl-attribute">channel</span>=<span class="hl-value">"requests"</span>
    <span class="hl-attribute">payload-expression</span>=<span class="hl-value">"#pathVariables.firstName"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int-http:header</span> <span class="hl-attribute">name</span>=<span class="hl-value">"lname"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"#pathVariables.lastName"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-http:inbound-channel-adapter&gt;</span></pre>
<p>For more information about <span class="emphasis"><em>URI template variables</em></span>, please see the Spring Reference Manual: <a class="ulink" href="http://static.springsource.org/spring/docs/current/spring-framework-reference/html/mvc.html#mvc-ann-requestmapping-uri-templates" target="_top">uri template patterns</a>.</p>
<p>Since <span class="emphasis"><em>Spring Integration 3.0</em></span>, in addition to the existing <code class="literal">#pathVariables</code> and <code class="literal">#requestParams</code> variables being available in payload and header expressions, other useful variables have been added.</p>
<p>The entire list of available expression variables:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="emphasis"><em>#requestParams</em></span> - the <code class="literal">MultiValueMap</code> from the <code class="literal">ServletRequest</code> <code class="literal">parameterMap</code>.
</li><li class="listitem">
<span class="emphasis"><em>#pathVariables</em></span> - the <code class="literal">Map</code> from URI Template placeholders and their values;
</li><li class="listitem">
<span class="emphasis"><em>#matrixVariables</em></span> - the <code class="literal">Map</code> of <code class="literal">MultiValueMap</code> according to <a class="ulink" href="http://docs.spring.io/spring/docs/current/spring-framework-reference/html/mvc.html#mvc-ann-matrix-variables" target="_top">Spring MVC Specification</a>.
Note, <span class="emphasis"><em>#matrixVariables</em></span> require Spring MVC 3.2 or higher;
</li><li class="listitem">
<span class="emphasis"><em>#requestAttributes</em></span> - the <code class="literal">org.springframework.web.context.request.RequestAttributes</code> associated with the current Request;
</li><li class="listitem">
<span class="emphasis"><em>#requestHeaders</em></span> - the <code class="literal">org.springframework.http.HttpHeaders</code> object from the current Request;
</li><li class="listitem">
<span class="emphasis"><em>#cookies</em></span> - the <code class="literal">Map&lt;String, Cookie&gt;</code> of <code class="literal">javax.servlet.http.Cookie</code> s from the current Request.
</li></ul></div>
<p>Note, all these values (and others) can be accessed within expressions in the downstream message flow via the <code class="literal">ThreadLocal</code> <code class="literal">org.springframework.web.context.request.RequestAttributes</code> variable, if that message flow is single-threaded and lives within the request thread:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-:transformer</span>
	<span class="hl-attribute">expression</span>=<span class="hl-value">"T(org.springframework.web.context.request.RequestContextHolder).
	              requestAttributes.request.queryString"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_outbound" href="#_outbound"></a>17.4.7&nbsp;Outbound</h3></div></div></div>

<p>To configure the outbound gateway you can use the namespace support as well.
The following code snippet shows the different configuration options for an outbound Http gateway.
Most importantly, notice that the <span class="emphasis"><em>http-method</em></span> and <span class="emphasis"><em>expected-response-type</em></span> are provided.
Those are two of the most commonly configured values.
The default http-method is POST, and the default response type is <span class="emphasis"><em>null</em></span>.
With a null response type, the payload of the reply Message would contain the ResponseEntity as long as it&#8217;s http status is a success (non-successful status codes will throw Exceptions).
If you are expecting a different type, such as a <code class="literal">String</code>, then provide that fully-qualified class name as shown below.
See also the note about empty response bodies in <a class="xref" href="#http-outbound" title="17.3&nbsp;Http Outbound Components">Section&nbsp;17.3, &#8220;Http Outbound Components&#8221;</a>.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Beginning with Spring Integration 2.1 the <span class="emphasis"><em>request-timeout</em></span> attribute of the HTTP Outbound Gateway was renamed to <span class="emphasis"><em>reply-timeout</em></span> to better reflect the intent.</p>
</td></tr></table></div>
<pre class="programlisting"><span class="hl-tag">&lt;int-http:outbound-gateway</span> <span class="hl-attribute">id</span>=<span class="hl-value">"example"</span>
    <span class="hl-attribute">request-channel</span>=<span class="hl-value">"requests"</span>
    <span class="hl-attribute">url</span>=<span class="hl-value">"http://localhost/test"</span>
    <span class="hl-attribute">http-method</span>=<span class="hl-value">"POST"</span>
    <span class="hl-attribute">extract-request-payload</span>=<span class="hl-value">"false"</span>
    <span class="hl-attribute">expected-response-type</span>=<span class="hl-value">"java.lang.String"</span>
    <span class="hl-attribute">charset</span>=<span class="hl-value">"UTF-8"</span>
    <span class="hl-attribute">request-factory</span>=<span class="hl-value">"requestFactory"</span>
    <span class="hl-attribute">reply-timeout</span>=<span class="hl-value">"1234"</span>
    <span class="hl-attribute">reply-channel</span>=<span class="hl-value">"replies"</span><span class="hl-tag">/&gt;</span></pre>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Since <span class="emphasis"><em>Spring Integration 2.2</em></span>, Java serialization over HTTP is no longer enabled by default.
Previously, when setting the <code class="literal">expected-response-type</code> attribute to a <code class="literal">Serializable</code> object, the <code class="literal">Accept</code> header was not properly set up.
Since <span class="emphasis"><em>Spring Integration 2.2</em></span>, the <code class="literal">SerializingHttpMessageConverter</code> has now been updated to set the <code class="literal">Accept</code> header to <code class="literal">application/x-java-serialized-object</code>.</p>
<p>However, because this could cause incompatibility with existing applications, it was decided to no longer automatically add this converter to the HTTP endpoints.
If you wish to use Java serialization, you will need to add the <code class="literal">SerializingHttpMessageConverter</code> to the appropriate endpoints, using the <code class="literal">message-converters</code> attribute, when using XML configuration, or using the <code class="literal">setMessageConverters()</code> method.
Alternatively, you may wish to consider using JSON instead which is enabled by simply having <code class="literal">Jackson</code> on the classpath.</p>
</td></tr></table></div>
<p>Beginning with Spring Integration 2.2 you can also determine the HTTP Method dynamically using SpEL and the <span class="emphasis"><em>http-method-expression</em></span> attribute.
Note that this attribute is obviously murually exclusive with <span class="emphasis"><em>http-method</em></span> You can also use <code class="literal">expected-response-type-expression</code> attribute instead of <code class="literal">expected-response-type</code> and provide any valid SpEL expression that determines the type of the response.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-http:outbound-gateway</span> <span class="hl-attribute">id</span>=<span class="hl-value">"example"</span>
    <span class="hl-attribute">request-channel</span>=<span class="hl-value">"requests"</span>
    <span class="hl-attribute">url</span>=<span class="hl-value">"http://localhost/test"</span>
    <span class="hl-attribute">http-method-expression</span>=<span class="hl-value">"headers.httpMethod"</span>
    <span class="hl-attribute">extract-request-payload</span>=<span class="hl-value">"false"</span>
    <span class="hl-attribute">expected-response-type-expression</span>=<span class="hl-value">"payload"</span>
    <span class="hl-attribute">charset</span>=<span class="hl-value">"UTF-8"</span>
    <span class="hl-attribute">request-factory</span>=<span class="hl-value">"requestFactory"</span>
    <span class="hl-attribute">reply-timeout</span>=<span class="hl-value">"1234"</span>
    <span class="hl-attribute">reply-channel</span>=<span class="hl-value">"replies"</span><span class="hl-tag">/&gt;</span></pre>
<p>If your outbound adapter is to be used in a unidirectional way, then you can use an outbound-channel-adapter instead.
This means that a successful response will simply execute without sending any Messages to a reply channel.
In the case of any non-successful response status code, it will throw an exception.
The configuration looks very similar to the gateway:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-http:outbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"example"</span>
    <span class="hl-attribute">url</span>=<span class="hl-value">"http://localhost/example"</span>
    <span class="hl-attribute">http-method</span>=<span class="hl-value">"GET"</span>
    <span class="hl-attribute">channel</span>=<span class="hl-value">"requests"</span>
    <span class="hl-attribute">charset</span>=<span class="hl-value">"UTF-8"</span>
    <span class="hl-attribute">extract-payload</span>=<span class="hl-value">"false"</span>
    <span class="hl-attribute">expected-response-type</span>=<span class="hl-value">"java.lang.String"</span>
    <span class="hl-attribute">request-factory</span>=<span class="hl-value">"someRequestFactory"</span>
    <span class="hl-attribute">order</span>=<span class="hl-value">"3"</span>
    <span class="hl-attribute">auto-startup</span>=<span class="hl-value">"false"</span><span class="hl-tag">/&gt;</span></pre>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>To specify the URL; you can use either the <span class="emphasis"><em>url</em></span> attribute or the <span class="emphasis"><em>url-expression</em></span> attribute.
The <span class="emphasis"><em>url</em></span> is a simple string (with placedholders for URI variables, as described below); the <span class="emphasis"><em>url-expression</em></span> is a SpEL expression, with the Message as the root object, enabling dynamic urls.
The url resulting from the expression evaluation can still have placeholders for URI variables.</p>
<p>In previous releases, some users used the place holders to replace the entire URL with a URI variable.
Changes in Spring 3.1 can cause some issues with escaped characters, such as <span class="emphasis"><em>?</em></span>.
For this reason, it is recommended that if you wish to generate the URL entirely at runtime, you use the <span class="emphasis"><em>url-expression</em></span> attribute.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="mapping-uri-variables" href="#mapping-uri-variables"></a>17.4.8&nbsp;Mapping URI Variables</h3></div></div></div>

<p>If your URL contains URI variables, you can map them using the <code class="literal">uri-variable</code> sub-element.
This sub-element is available for the <span class="emphasis"><em>Http Outbound Gateway</em></span> and the <span class="emphasis"><em>Http Outbound Channel Adapter</em></span>.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-http:outbound-gateway</span> <span class="hl-attribute">id</span>=<span class="hl-value">"trafficGateway"</span>
    <span class="hl-attribute">url</span>=<span class="hl-value">"http://local.yahooapis.com/trafficData?appid=YdnDemo&amp;amp;zip={zipCode}"</span>
    <span class="hl-attribute">request-channel</span>=<span class="hl-value">"trafficChannel"</span>
    <span class="hl-attribute">http-method</span>=<span class="hl-value">"GET"</span>
    <span class="hl-attribute">expected-response-type</span>=<span class="hl-value">"java.lang.String"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int-http:uri-variable</span> <span class="hl-attribute">name</span>=<span class="hl-value">"zipCode"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"payload.getZip()"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-http:outbound-gateway&gt;</span></pre>
<p>The <code class="literal">uri-variable</code> sub-element defines two attributes: <code class="literal">name</code> and <code class="literal">expression</code>.
The <code class="literal">name</code> attribute identifies the name of the URI variable, while the <code class="literal">expression</code> attribute is used to set the actual value.
Using the <code class="literal">expression</code> attribute, you can leverage the full power of the Spring Expression Language (SpEL) which gives you full dynamic access to the message payload and the message headers.
For example, in the above configuration the <code class="literal">getZip()</code> method will be invoked on the payload object of the Message and the result of that method will be used as the value for the URI variable named <span class="emphasis"><em>zipCode</em></span>.</p>
<p>Since <span class="emphasis"><em>Spring Integration 3.0</em></span>, HTTP Outbound Endpoints support the <code class="literal">uri-variables-expression</code> attribute to specify an <code class="literal">Expression</code> which should be evaluated, resulting in a <code class="literal">Map</code> for all URI variable placeholders within the URL template.
It provides a mechanism whereby different variable expressions can be used, based on the outbound message.
This attribute is mutually exclusive with the <code class="literal">&lt;uri-variable/&gt;</code> sub-element:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-http:outbound-gateway</span>
     <span class="hl-attribute">url</span>=<span class="hl-value">"http://foo.host/{foo}/bars/{bar}"</span>
     <span class="hl-attribute">request-channel</span>=<span class="hl-value">"trafficChannel"</span>
     <span class="hl-attribute">http-method</span>=<span class="hl-value">"GET"</span>
     <span class="hl-attribute">uri-variables-expression</span>=<span class="hl-value">"@uriVariablesBean.populate(payload)"</span>
     <span class="hl-attribute">expected-response-type</span>=<span class="hl-value">"java.lang.String"</span><span class="hl-tag">/&gt;</span></pre>
<p>where <code class="literal">uriVariablesBean</code> might be:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> UriVariablesBean {
	<span class="hl-keyword">private</span> <span class="hl-keyword">static</span> <span class="hl-keyword">final</span> ExpressionParser EXPRESSION_PARSER = <span class="hl-keyword">new</span> SpelExpressionParser();

	<span class="hl-keyword">public</span> Map&lt;String, ?&gt; populate(Object payload) {
		Map&lt;String, Object&gt; variables = <span class="hl-keyword">new</span> HashMap&lt;String, Object&gt;();
		<span class="hl-keyword">if</span> (payload instanceOf String.<span class="hl-keyword">class</span>)) {
			variables.put(<span class="hl-string">"foo"</span>, <span class="hl-string">"foo"</span>));
		}
		<span class="hl-keyword">else</span> {
			variables.put(<span class="hl-string">"foo"</span>, EXPRESSION_PARSER.parseExpression(<span class="hl-string">"headers.bar"</span>));
		}
		<span class="hl-keyword">return</span> variables;
	}

}</pre>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The <code class="literal">uri-variables-expression</code> must evaluate to a <code class="literal">Map</code>.
The values of the Map must be instances of <code class="literal">String</code> or <code class="literal">Expression</code>.
This Map is provided to an <code class="literal">ExpressionEvalMap</code> for further resolution of URI variable placeholders using those expressions in the context of the outbound <code class="literal">Message</code>.</p>
</td></tr></table></div>
<p>IMPORTANT</p>
<div class="informalexample">
<p>The <code class="literal">uriVariablesExpression</code> property provides a very powerful mechanism for evaluating URI variables.
It is anticipated that simple expressions like the example above will be used.
However, you could also configure something like this <code class="literal">"@uriVariablesBean.populate(#root)"</code> with an expression in the returned map being <code class="literal">variables.put("foo", EXPRESSION_PARSER.parseExpression(message.getHeaders().get("bar", String.class)));</code>, where the expression is dynamically provided in the message header <code class="literal">bar</code>.
Since the header may come from an untrusted source, the HTTP outbound endpoints use a <code class="literal">SimpleEvaluationContext</code> when evaluating these expressions; allowing only a subset of SpEL features to be used.
If you trust your message sources and wish to use the restricted SpEL constructs, set the <code class="literal">trustedSpel</code> property of the outbound endpoint to <code class="literal">true</code>.</p>
</div>
<p>Scenarios when we need to supply a dynamic set of URI variables on per message basis can be achieved with the custom <code class="literal">url-expression</code> and some utilities for building and encoding URL parameters:</p>
<pre class="programlisting">url-expression="T(org.springframework.web.util.UriComponentsBuilder)
                           .fromHttpUrl('http://HOST:PORT/PATH')
                           .queryParams(payload)
                           .build()
                           .toUri()"</pre>
<p>where <code class="literal">queryParams()</code> expects a <code class="literal">MultiValueMap&lt;String, String&gt;</code> as an argument, so a real set of URL query parameters can be build in advance, before performing request.</p>
<p>The whole <code class="literal">queryString</code> can also be presented as an uri variable:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-http:outbound-gateway</span> <span class="hl-attribute">id</span>=<span class="hl-value">"proxyGateway"</span> <span class="hl-attribute">request-channel</span>=<span class="hl-value">"testChannel"</span>
              <span class="hl-attribute">url</span>=<span class="hl-value">"http://testServer/test?{queryString}"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int-http:uri-variable</span> <span class="hl-attribute">name</span>=<span class="hl-value">"queryString"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"'a=A&amp;amp;b=B'"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-http:outbound-gateway&gt;</span></pre>
<p>In this case the URL encoding must be provided manually.
For example the <code class="literal">org.apache.http.client.utils.URLEncodedUtils#format()</code> can be used for this purpose.
A mentioned, manually built, <code class="literal">MultiValueMap&lt;String, String&gt;</code> can be converted to the the <code class="literal">List&lt;NameValuePair&gt;</code> <code class="literal">format()</code> method argument using this Java Streams snippet:</p>
<pre class="programlisting">List&lt;NameValuePair&gt; nameValuePairs =
    params.entrySet()
            .stream()
            .flatMap(e -&gt; e
                    .getValue()
                    .stream()
                    .map(v -&gt; <span class="hl-keyword">new</span> BasicNameValuePair(e.getKey(), v)))
            .collect(Collectors.toList());</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_controlling_uri_encoding" href="#_controlling_uri_encoding"></a>17.4.9&nbsp;Controlling URI Encoding</h3></div></div></div>

<p>By default, the URL string is encoded (see <a class="ulink" href="http://static.springsource.org/spring/docs/current/javadoc-api/org/springframework/web/util/UriComponentsBuilder.html" target="_top">UriComponentsBuilder</a>) to the URI object before sending the request.
In some scenarios with a non-standard URI (e.g.
the RabbitMQ Rest API) it is undesirable to perform the encoding.
The <code class="literal">&lt;http:outbound-gateway/&gt;</code> and <code class="literal">&lt;http:outbound-channel-adapter/&gt;</code> provide an <code class="literal">encode-uri</code> attribute.
To disable encoding the URL, this attribute should be set to <code class="literal">false</code> (by default it is <code class="literal">true</code>).
If you wish to partially encode some of the URL, this can be achieved using an <code class="literal">expression</code> within a <code class="literal">&lt;uri-variable/&gt;</code>:</p>
<pre class="programlisting"><span class="hl-tag">&lt;http:outbound-gateway</span> <span class="hl-attribute">url</span>=<span class="hl-value">"http://somehost/%2f/fooApps?bar={param}"</span> <span class="hl-attribute">encode-uri</span>=<span class="hl-value">"false"</span><span class="hl-tag">&gt;</span>
          <span class="hl-tag">&lt;http:uri-variable</span> <span class="hl-attribute">name</span>=<span class="hl-value">"param"</span>
            <span class="hl-attribute">expression</span>=<span class="hl-value">"T(org.apache.commons.httpclient.util.URIUtil)
                                             .encodeWithinQuery('Hello World!')"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/http:outbound-gateway&gt;</span></pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="http-timeout" href="#http-timeout"></a>17.5&nbsp;Timeout Handling</h2></div></div></div>

<p>In the context of HTTP components, there are two timing areas that have to be considered.</p>
<p>Timeouts when interacting with Spring Integration Channels</p>
<p>Timeouts when interacting with a remote HTTP server</p>
<p>First, the components interact with Message Channels, for which timeouts can be specified.
For example, an HTTP Inbound Gateway will forward messages received from connected HTTP Clients to a Message Channel (Request Timeout) and consequently the HTTP Inbound Gateway will receive a reply Message from the Reply Channel (Reply Timeout) that will be used to generate the HTTP Response.
Please see the figure below for an illustration.</p>
<div class="figure"><a name="d5e11964" href="#d5e11964"></a><p class="title"><b>Figure&nbsp;17.1.&nbsp;How timeout settings apply to an HTTP Inbound Gateway</b></p><div class="figure-contents">

<div class="mediaobject" align="center"><img src="images/http-inbound-gateway.png" align="middle" alt="http inbound gateway"></div>
</div></div><br class="figure-break">
<p>For outbound endpoints, the second thing to consider is timing while interacting with the remote server.</p>
<div class="figure"><a name="d5e11972" href="#d5e11972"></a><p class="title"><b>Figure&nbsp;17.2.&nbsp;How timeout settings apply to an HTTP Outbound Gateway</b></p><div class="figure-contents">

<div class="mediaobject" align="center"><img src="images/http-outbound-gateway.png" align="middle" alt="http outbound gateway"></div>
</div></div><br class="figure-break">
<p>You may want to configure the HTTP related timeout behavior, when making active HTTP requests using the <span class="emphasis"><em>HTTP Outbound Gateway</em></span> or the <span class="emphasis"><em>HTTP Outbound Channel Adapter</em></span>.
In those instances, these two components use Spring&#8217;s
<a class="ulink" href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/web/client/RestTemplate.html" target="_top">RestTemplate</a> support to execute HTTP requests.</p>
<p>In order to configure timeouts for the <span class="emphasis"><em>HTTP Outbound Gateway</em></span> and the <span class="emphasis"><em>HTTP Outbound Channel Adapter</em></span>, you can either reference a <code class="literal">RestTemplate</code> bean directly, using the <span class="emphasis"><em>rest-template</em></span> attribute, or you can provide a reference to a <a class="ulink" href="http://static.springsource.org/spring/docs/current/javadoc-api/org/springframework/http/client/ClientHttpRequestFactory.html" target="_top">ClientHttpRequestFactory</a> bean using the <span class="emphasis"><em>request-factory</em></span> attribute.
Spring provides the following implementations of the <code class="literal">ClientHttpRequestFactory</code> interface:</p>
<p><a class="ulink" href="http://static.springsource.org/spring/docs/current/javadoc-api/org/springframework/http/client/SimpleClientHttpRequestFactory.html" target="_top">SimpleClientHttpRequestFactory</a> - Uses standard J2SE facilities for making HTTP Requests</p>
<p><a class="ulink" href="http://static.springsource.org/spring/docs/current/javadoc-api/org/springframework/http/client/HttpComponentsClientHttpRequestFactory.html" target="_top">HttpComponentsClientHttpRequestFactory</a> - Uses <a class="ulink" href="http://hc.apache.org/httpcomponents-client-ga/" target="_top">Apache HttpComponents HttpClient</a> (Since Spring 3.1)</p>
<p><a class="ulink" href="http://static.springsource.org/spring/docs/current/javadoc-api/org/springframework/http/client/CommonsClientHttpRequestFactory.html" target="_top">ClientHttpRequestFactory</a> - Uses <a class="ulink" href="http://hc.apache.org/httpclient-3.x/" target="_top">Jakarta Commons HttpClient</a> (Deprecated as of Spring 3.1)</p>
<p>If you don&#8217;t explicitly configure the <span class="emphasis"><em>request-factory</em></span> or <span class="emphasis"><em>rest-template</em></span> attribute respectively, then a default RestTemplate which uses a <code class="literal">SimpleClientHttpRequestFactory</code> will be instantiated.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>With some JVM implementations, the handling of timeouts using the <span class="emphasis"><em>URLConnection</em></span> class may not be consistent.</p>
<p>E.g.
from the <span class="emphasis"><em>Java&#8482; Platform, Standard Edition 6 API Specification</em></span> on <span class="emphasis"><em>setConnectTimeout</em></span>: [quote]
Some non-standard implementation of this method may ignore the specified timeout.
To see the connect timeout set, please call getConnectTimeout().</p>
<p>Please test your timeouts if you have specific needs.
Consider using the <code class="literal">HttpComponentsClientHttpRequestFactory</code> which, in turn, uses <a class="ulink" href="http://hc.apache.org/httpcomponents-client-ga/" target="_top">Apache HttpComponents HttpClient</a> instead.</p>
</td></tr></table></div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>When using the <span class="emphasis"><em>Apache HttpComponents HttpClient</em></span> with a Pooling Connection Manager, be aware that, by default, the connection manager will create no more than 2 concurrent connections per given route and no more than 20 connections in total.
For many real-world applications these limits may prove too constraining.
Refer to the Apache documentation (link above) for information about configuring this important component.</p>
</td></tr></table></div>
<p>Here is an example of how to configure an <span class="emphasis"><em>HTTP Outbound Gateway</em></span> using a <code class="literal">SimpleClientHttpRequestFactory</code>, configured with connect and read timeouts of 5 seconds respectively:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-http:outbound-gateway</span> <span class="hl-attribute">url</span>=<span class="hl-value">"http://www.google.com/ig/api?weather={city}"</span>
                           <span class="hl-attribute">http-method</span>=<span class="hl-value">"GET"</span>
                           <span class="hl-attribute">expected-response-type</span>=<span class="hl-value">"java.lang.String"</span>
                           <span class="hl-attribute">request-factory</span>=<span class="hl-value">"requestFactory"</span>
                           <span class="hl-attribute">request-channel</span>=<span class="hl-value">"requestChannel"</span>
                           <span class="hl-attribute">reply-channel</span>=<span class="hl-value">"replyChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int-http:uri-variable</span> <span class="hl-attribute">name</span>=<span class="hl-value">"city"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"payload"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-http:outbound-gateway&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"requestFactory"</span>
      <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.http.client.SimpleClientHttpRequestFactory"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"connectTimeout"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"5000"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"readTimeout"</span>    <span class="hl-attribute">value</span>=<span class="hl-value">"5000"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
<p><span class="emphasis"><em>HTTP Outbound Gateway</em></span></p>
<p>For the <span class="emphasis"><em>HTTP Outbound Gateway</em></span>, the XML Schema defines only the <span class="emphasis"><em>reply-timeout</em></span>.
The <span class="emphasis"><em>reply-timeout</em></span> maps to the <span class="emphasis"><em>sendTimeout</em></span> property of the <span class="emphasis"><em>org.springframework.integration.http.outbound.HttpRequestExecutingMessageHandler</em></span> class.
More precisely, the property is set on the extended <code class="literal">AbstractReplyProducingMessageHandler</code> class, which ultimately sets the property on the <code class="literal">MessagingTemplate</code>.</p>
<p>The value of the <span class="emphasis"><em>sendTimeout</em></span> property defaults to "-1" and will be applied to the connected <code class="literal">MessageChannel</code>.
This means, that depending on the implementation, the Message Channel&#8217;s <span class="emphasis"><em>send</em></span> method may block indefinitely.
Furthermore, the <span class="emphasis"><em>sendTimeout</em></span> property is only used, when the actual MessageChannel implementation has a blocking send (such as <span class="emphasis"><em>full</em></span> bounded QueueChannel).</p>
<p><span class="emphasis"><em>HTTP Inbound Gateway</em></span></p>
<p>For the <span class="emphasis"><em>HTTP Inbound Gateway</em></span>, the XML Schema defines the <span class="emphasis"><em>request-timeout</em></span> attribute, which will be used to set the <span class="emphasis"><em>requestTimeout</em></span> property on the <code class="literal">HttpRequestHandlingMessagingGateway</code> class (on the extended MessagingGatewaySupport class).
Secondly, the_reply-timeout_ attribute exists and it maps to the <span class="emphasis"><em>replyTimeout</em></span> property on the same class.</p>
<p>The default for both timeout properties is "1000ms".
Ultimately, the <span class="emphasis"><em>request-timeout</em></span> property will be used to set the <span class="emphasis"><em>sendTimeout</em></span> on the used <code class="literal">MessagingTemplate</code> instance.
The <span class="emphasis"><em>replyTimeout</em></span> property on the other hand, will be used to set the <span class="emphasis"><em>receiveTimeout</em></span> property on the used <code class="literal">MessagingTemplate</code> instance.</p>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>In order to simulate connection timeouts, connect to a non-routable IP address, for example 10.255.255.10.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="http-proxy" href="#http-proxy"></a>17.6&nbsp;HTTP Proxy configuration</h2></div></div></div>

<p>If you are behind a proxy and need to configure proxy settings for HTTP outbound adapters and/or gateways, you can apply one of two approaches.
In most cases, you can rely on the standard Java System Properties that control the proxy settings.
Otherwise, you can explicitly configure a Spring bean for the HTTP client request factory instance.</p>
<p><span class="emphasis"><em>Standard Java Proxy configuration</em></span></p>
<p>There are 3 System Properties you can set to configure the proxy settings that will be used by the HTTP protocol handler:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="emphasis"><em>http.proxyHost</em></span> - the host name of the proxy server.
</li><li class="listitem">
<span class="emphasis"><em>http.proxyPort</em></span> - the port number, the default value being 80.
</li><li class="listitem">
<span class="emphasis"><em>http.nonProxyHosts</em></span> - a list of hosts that should be reached directly, bypassing the proxy.
This is a list of patterns separated by <span class="emphasis"><em>|</em></span>.
The patterns may start or end with a <span class="emphasis"><em>*</em></span> for wildcards.
Any host matching one of these patterns will be reached through a direct connection instead of through a proxy.
</li></ul></div>
<p>And for HTTPS:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="emphasis"><em>https.proxyHost</em></span> - the host name of the proxy server.
</li><li class="listitem">
<span class="emphasis"><em>https.proxyPort</em></span> - the port number, the default value being 80.
</li></ul></div>
<p>For more information please refer to this document: <a class="ulink" href="http://download.oracle.com/javase/6/docs/technotes/guides/net/proxies.html" target="_top">http://download.oracle.com/javase/6/docs/technotes/guides/net/proxies.html</a></p>
<p><span class="emphasis"><em>Spring&#8217;s SimpleClientHttpRequestFactory</em></span></p>
<p>If for any reason, you need more explicit control over the proxy configuration, you can use Spring&#8217;s <code class="literal">SimpleClientHttpRequestFactory</code> and configure its <span class="emphasis"><em>proxy</em></span> property as such:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"requestFactory"</span>
    <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.http.client.SimpleClientHttpRequestFactory"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"proxy"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"proxy"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"java.net.Proxy"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;constructor-arg&gt;</span>
                <span class="hl-tag">&lt;util:constant</span> <span class="hl-attribute">static-field</span>=<span class="hl-value">"java.net.Proxy.Type.HTTP"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;/constructor-arg&gt;</span>
            <span class="hl-tag">&lt;constructor-arg&gt;</span>
                <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"java.net.InetSocketAddress"</span><span class="hl-tag">&gt;</span>
                    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"123.0.0.1"</span><span class="hl-tag">/&gt;</span>
                    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"8080"</span><span class="hl-tag">/&gt;</span>
                <span class="hl-tag">&lt;/bean&gt;</span>
            <span class="hl-tag">&lt;/constructor-arg&gt;</span>
        <span class="hl-tag">&lt;/bean&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="http-header-mapping" href="#http-header-mapping"></a>17.7&nbsp;HTTP Header Mappings</h2></div></div></div>

<p>Spring Integration provides support for Http Header mapping for both HTTP Request and HTTP Responses.</p>
<p>By default all standard Http Headers as defined here <a class="ulink" href="http://en.wikipedia.org/wiki/List_of_HTTP_header_fields" target="_top">http://en.wikipedia.org/wiki/List_of_HTTP_header_fields</a> will be mapped from the message to HTTP request/response headers without further configuration.
However if you do need further customization you may provide additional configuration via convenient namespace support.
You can provide a comma-separated list of header names, and you can also include simple patterns with the <span class="emphasis"><em>*</em></span> character acting as a wildcard.
If you do provide such values, it will override the default behavior.
Basically, it assumes you are in complete control at that point.
However, if you do want to include all of the standard HTTP headers, you can use the shortcut patterns: <code class="literal">HTTP_REQUEST_HEADERS</code> and <code class="literal">HTTP_RESPONSE_HEADERS</code>.
Here are some examples:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-http:outbound-gateway</span> <span class="hl-attribute">id</span>=<span class="hl-value">"httpGateway"</span>
    <span class="hl-attribute">url</span>=<span class="hl-value">"http://localhost/test2"</span>
    <span class="hl-attribute">mapped-request-headers</span>=<span class="hl-value">"foo, bar"</span>
    <span class="hl-attribute">mapped-response-headers</span>=<span class="hl-value">"X-*, HTTP_RESPONSE_HEADERS"</span>
    <span class="hl-attribute">channel</span>=<span class="hl-value">"someChannel"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int-http:outbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"httpAdapter"</span>
    <span class="hl-attribute">url</span>=<span class="hl-value">"http://localhost/test2"</span>
    <span class="hl-attribute">mapped-request-headers</span>=<span class="hl-value">"foo, bar, HTTP_REQUEST_HEADERS"</span>
    <span class="hl-attribute">channel</span>=<span class="hl-value">"someChannel"</span><span class="hl-tag">/&gt;</span></pre>
<p>The adapters and gateways will use the <code class="literal">DefaultHttpHeaderMapper</code> which now provides two static factory methods for "inbound" and "outbound" adapters so that the proper direction can be applied (mapping HTTP requests/responses IN/OUT as appropriate).</p>
<p>If further customization is required you can also configure a <code class="literal">DefaultHttpHeaderMapper</code> independently and inject it into the adapter via the <code class="literal">header-mapper</code> attribute.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-http:outbound-gateway</span> <span class="hl-attribute">id</span>=<span class="hl-value">"httpGateway"</span>
    <span class="hl-attribute">url</span>=<span class="hl-value">"http://localhost/test2"</span>
    <span class="hl-attribute">header-mapper</span>=<span class="hl-value">"headerMapper"</span>
    <span class="hl-attribute">channel</span>=<span class="hl-value">"someChannel"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"headerMapper"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.http.support.DefaultHttpHeaderMapper"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"inboundHeaderNames"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"foo*, *bar, baz"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"outboundHeaderNames"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"a*b, d"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
<p>Of course, you can even implement the HeaderMapper strategy interface directly and provide a reference to that if you need to do something other than what the <code class="literal">DefaultHttpHeaderMapper</code> supports.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="int-graph-controller" href="#int-graph-controller"></a>17.8&nbsp;Integration Graph Controller</h2></div></div></div>

<p>Starting with <span class="emphasis"><em>version 4.3</em></span>, the HTTP module provides an <code class="literal">@EnableIntegrationGraphController</code> <code class="literal">@Configuration</code> class annotation and <code class="literal">&lt;int-http:graph-controller/&gt;</code> XML element to expose the <code class="literal">IntegrationGraphServer</code> as a REST service.
See <a class="xref" href="#integration-graph" title="9.8&nbsp;Integration Graph">Section&nbsp;9.8, &#8220;Integration Graph&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="http-samples" href="#http-samples"></a>17.9&nbsp;HTTP Samples</h2></div></div></div>

<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="multipart-rest-inbound" href="#multipart-rest-inbound"></a>17.9.1&nbsp;Multipart HTTP request - RestTemplate (client) and Http Inbound Gateway (server)</h3></div></div></div>

<p>This example demonstrates how simple it is to send a Multipart HTTP request via Spring&#8217;s RestTemplate and receive it with a Spring Integration HTTP Inbound Adapter.
All we are doing is creating a <code class="literal">MultiValueMap</code> and populating it with multi-part data.
The <code class="literal">RestTemplate</code> will take care of the rest (no pun intended) by converting it to&nbsp;a <code class="literal">MultipartHttpServletRequest</code> .&nbsp;This particular client will send a multipart HTTP Request which contains the name of the company as well as an image file with the company logo.</p>
<pre class="programlisting">RestTemplate template =&nbsp;<span class="hl-keyword">new</span>&nbsp;RestTemplate();
String uri =&nbsp;<span class="hl-string">"http://localhost:8080/multipart-http/inboundAdapter.htm"</span>;
Resource s2logo =&nbsp;
   <span class="hl-keyword">new</span>&nbsp;ClassPathResource(<span class="hl-string">"org/springframework/samples/multipart/spring09_logo.png"</span>);
MultiValueMap map =&nbsp;<span class="hl-keyword">new</span>&nbsp;LinkedMultiValueMap();
map.add(<span class="hl-string">"company"</span>,&nbsp;<span class="hl-string">"SpringSource"</span>);
map.add(<span class="hl-string">"company-logo"</span>, s2logo);
HttpHeaders headers =&nbsp;<span class="hl-keyword">new</span>&nbsp;HttpHeaders();
headers.setContentType(<span class="hl-keyword">new</span>&nbsp;MediaType(<span class="hl-string">"multipart"</span>,&nbsp;<span class="hl-string">"form-data"</span>));
HttpEntity request =&nbsp;<span class="hl-keyword">new</span>&nbsp;HttpEntity(map, headers);
ResponseEntity&lt;?&gt; httpResponse = template.exchange(uri, HttpMethod.POST, request,&nbsp;null);</pre>
<p>That is all for the client.</p>
<p>On the server side we have the following configuration:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-http:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"httpInboundAdapter"</span>
    <span class="hl-attribute">channel</span>=<span class="hl-value">"receiveChannel"</span>
    <span class="hl-attribute">path</span>=<span class="hl-value">"/inboundAdapter.htm"</span>
    <span class="hl-attribute">supported-methods</span>=<span class="hl-value">"GET, POST"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"receiveChannel"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int:service-activator</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"receiveChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.samples.multipart.MultipartReceiver"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:service-activator&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"multipartResolver"</span>
    <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.web.multipart.commons.CommonsMultipartResolver"</span><span class="hl-tag">/&gt;</span></pre>
<p>The <span class="emphasis"><em>httpInboundAdapter</em></span> will receive the request, convert it to a <code class="literal">Message</code> with a payload that is a&nbsp;<code class="literal">LinkedMultiValueMap</code>.
We then are parsing that in the <span class="emphasis"><em>multipartReceiver</em></span> service-activator;</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">void</span> receive(LinkedMultiValueMap&lt;String, Object&gt; multipartRequest){
    System.out.println(<span class="hl-string">"### Successfully received multipart request ###"</span>);
    <span class="hl-keyword">for</span> (String elementName : multipartRequest.keySet()) {
        <span class="hl-keyword">if</span> (elementName.equals(<span class="hl-string">"company"</span>)){
            System.out.println(<span class="hl-string">"\t"</span> + elementName + <span class="hl-string">" - "</span> +
                ((String[]) multipartRequest.getFirst(<span class="hl-string">"company"</span>))[<span class="hl-number">0</span>]);
        }
        <span class="hl-keyword">else</span> <span class="hl-keyword">if</span> (elementName.equals(<span class="hl-string">"company-logo"</span>)){
            System.out.println(<span class="hl-string">"\t"</span> + elementName + <span class="hl-string">" - as UploadedMultipartFile: "</span> +
                ((UploadedMultipartFile) multipartRequest
                    .getFirst(<span class="hl-string">"company-logo"</span>)).getOriginalFilename());
        }
    }
}</pre>
<p>You should see the following output:</p>
<pre class="programlisting">### Successfully received multipart request ###
   company - SpringSource
   company-logo - as UploadedMultipartFile: spring09_logo.png</pre>
</div>
</div>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="jdbc" href="#jdbc"></a>18.&nbsp;JDBC Support</h2></div></div></div>

<p>Spring Integration provides Channel Adapters for receiving and sending messages via database queries.
Through those adapters Spring Integration supports not only plain JDBC SQL Queries, but also Stored Procedure and Stored Function calls.</p>
<p>The following JDBC components are available by default:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="emphasis"><em><a class="link" href="#jdbc-inbound-channel-adapter" title="18.1&nbsp;Inbound Channel Adapter">Inbound Channel Adapter</a></em></span>
</li><li class="listitem">
<span class="emphasis"><em><a class="link" href="#jdbc-outbound-channel-adapter" title="18.2&nbsp;Outbound Channel Adapter">Outbound Channel Adapter</a></em></span>
</li><li class="listitem">
<span class="emphasis"><em><a class="link" href="#jdbc-outbound-gateway" title="18.3&nbsp;Outbound Gateway">Outbound Gateway</a></em></span>
</li><li class="listitem">
<span class="emphasis"><em><a class="link" href="#stored-procedure-inbound-channel-adapter" title="18.5.6&nbsp;Stored Procedure Inbound Channel Adapter">Stored Procedure Inbound Channel Adapter</a></em></span>
</li><li class="listitem">
<span class="emphasis"><em><a class="link" href="#stored-procedure-outbound-channel-adapter" title="18.5.7&nbsp;Stored Procedure Outbound Channel Adapter">Stored Procedure Outbound Channel Adapter</a></em></span>
</li><li class="listitem">
<span class="emphasis"><em><a class="link" href="#stored-procedure-outbound-gateway" title="18.5.8&nbsp;Stored Procedure Outbound Gateway">Stored Procedure Outbound Gateway</a></em></span>
</li></ul></div>
<p>Furthermore, the Spring Integration JDBC Module also provides a <span class="emphasis"><em><a class="link" href="#jdbc-message-store" title="18.4&nbsp;JDBC Message Store">JDBC Message Store</a></em></span></p>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jdbc-inbound-channel-adapter" href="#jdbc-inbound-channel-adapter"></a>18.1&nbsp;Inbound Channel Adapter</h2></div></div></div>

<p>The main function of an inbound Channel Adapter is to execute a SQL <code class="literal">SELECT</code> query and turn the result set as a message.
The message payload is the whole result set, expressed as a <code class="literal">List</code>, and the types of the items in the list depend on the row-mapping strategy that is used.
The default strategy is a generic mapper that just returns a <code class="literal">Map</code> for each row in the query result.
Optionally, this can be changed by adding a reference to a <code class="literal">RowMapper</code> instance (see the <a class="ulink" href="https://docs.spring.io/spring/docs/current/spring-framework-reference/html/jdbc.html" target="_top">Spring JDBC</a> documentation for more detailed information about row mapping).</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>If you want to convert rows in the SELECT query result to individual messages you can use a downstream splitter.</p>
</td></tr></table></div>
<p>The inbound adapter also requires a reference to either a <code class="literal">JdbcTemplate</code> instance or a <code class="literal">DataSource</code>.</p>
<p>As well as the <code class="literal">SELECT</code> statement to generate the messages, the adapter above also has an <code class="literal">UPDATE</code> statement that is being used to mark the records as processed so that they don&#8217;t show up in the next poll.
The update can be parameterized by the list of ids from the original select.
This is done through a naming convention by default (a column in the input result set called "id" is translated into a list in the parameter map for the update called "id").
The following example defines an inbound Channel Adapter with an update query and a <code class="literal">DataSource</code> reference.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-jdbc:inbound-channel-adapter</span> <span class="hl-attribute">query</span>=<span class="hl-value">"select * from item where status=2"</span>
    <span class="hl-attribute">channel</span>=<span class="hl-value">"target"</span> <span class="hl-attribute">data-source</span>=<span class="hl-value">"dataSource"</span>
    <span class="hl-attribute">update</span>=<span class="hl-value">"update item set status=10 where id in (:id)"</span><span class="hl-tag"> /&gt;</span></pre>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The parameters in the update query are specified with a colon (:) prefix to the name of a parameter (which in this case is an expression to be applied to each of the rows in the polled result set).
This is a standard feature of the named parameter JDBC support in Spring JDBC combined with a convention (projection onto the polled result list) adopted in Spring Integration.
The underlying Spring JDBC features limit the available expressions (e.g.
most special characters other than period are disallowed), but since the target is usually a list of or an individual object addressable by simple bean paths this isn&#8217;t unduly restrictive.</p>
</td></tr></table></div>
<p>To change the parameter generation strategy you can inject a <code class="literal">SqlParameterSourceFactory</code> into the adapter to override the default behavior (the adapter has a <code class="literal">sql-parameter-source-factory</code> attribute).
Spring Integration provides a <code class="literal">ExpressionEvaluatingSqlParameterSourceFactory</code> which will create a SpEL-based parameter source, with the results of the query as the <code class="literal">#root</code> object.
(If <code class="literal">update-per-row</code> is true, the root object is the row).
If the same parameter name appears multiple times in the update query, it is evaluated only one time, and its result is cached.</p>
<p>You can also use a parameter source for the select query.
In this case, since there is no "result" object to evaluate against, a single parameter source is used each time (rather than using a parameter source factory).
Starting with <span class="emphasis"><em>version 4.0</em></span>, you can use Spring to create a SpEL based parameter source as follows:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-jdbc:inbound-channel-adapter</span> <span class="hl-attribute">query</span>=<span class="hl-value">"select * from item where status=:status"</span>
	<span class="hl-attribute">channel</span>=<span class="hl-value">"target"</span> <span class="hl-attribute">data-source</span>=<span class="hl-value">"dataSource"</span>
	<span class="hl-attribute">select-sql-parameter-source</span>=<span class="hl-value">"parameterSource"</span><span class="hl-tag"> /&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"parameterSource"</span> <span class="hl-attribute">factory-bean</span>=<span class="hl-value">"parameterSourceFactory"</span>
			<span class="hl-attribute">factory-method</span>=<span class="hl-value">"createParameterSourceNoCache"</span><span class="hl-tag">&gt;</span>
	<span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">""</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"parameterSourceFactory"</span>
		<span class="hl-attribute">class</span>=<span class="hl-value">"o.s.integration.jdbc.ExpressionEvaluatingSqlParameterSourceFactory"</span><span class="hl-tag">&gt;</span>
	<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"parameterExpressions"</span><span class="hl-tag">&gt;</span>
		<span class="hl-tag">&lt;map&gt;</span>
			<span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"status"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"@statusBean.which()"</span><span class="hl-tag"> /&gt;</span>
		<span class="hl-tag">&lt;/map&gt;</span>
	<span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"statusBean"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"foo.StatusDetermination"</span><span class="hl-tag"> /&gt;</span></pre>
<p>The <code class="literal">value</code> in each parameter expression can be any valid SpEL expression.
The <code class="literal">#root</code> object for the expression evaluation is the constructor argument defined on the <code class="literal">parameterSource</code> bean.
It is static for all evaluations (in this case, an empty String).</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Use the <code class="literal">createParameterSourceNoCache</code> factory method; otherwise the parameter source will cache the result of the evaluation.
Also note that, because caching is disabled, if the same parameter name appears in the select query multiple times, it will be re-evaluated for each occurrence.</p>
</td></tr></table></div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_polling_and_transactions" href="#_polling_and_transactions"></a>18.1.1&nbsp;Polling and Transactions</h3></div></div></div>

<p>The inbound adapter accepts a regular Spring Integration poller as a sub element, so for instance the frequency of the polling can be controlled.
A very important feature of the poller for JDBC usage is the option to wrap the poll operation in a transaction, for example:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-jdbc:inbound-channel-adapter</span> <span class="hl-attribute">query</span>=<span class="hl-value">"..."</span>
        <span class="hl-attribute">channel</span>=<span class="hl-value">"target"</span> <span class="hl-attribute">data-source</span>=<span class="hl-value">"dataSource"</span> <span class="hl-attribute">update</span>=<span class="hl-value">"..."</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"1000"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;int:transactional/&gt;</span>
    <span class="hl-tag">&lt;/int:poller&gt;</span>
<span class="hl-tag">&lt;/int-jdbc:inbound-channel-adapter&gt;</span></pre>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>If a poller is not explicitly specified, a default value will be used (and as per normal with Spring Integration can be defined as a top level bean).</p>
</td></tr></table></div>
<p>In this example the database is polled every 1000 milliseconds, and the update and select queries are both executed in the same transaction.
The transaction manager configuration is not shown, but as long as it is aware of the data source then the poll is transactional.
A common use case is for the downstream channels to be direct channels (the default), so that the endpoints are invoked in the same thread, and hence the same transaction.
Then if any of them fail, the transaction rolls back and the input data is reverted to its original state.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jdbc-max-rows-per-poll-versus-max-messages-per-poll" href="#jdbc-max-rows-per-poll-versus-max-messages-per-poll"></a>18.1.2&nbsp;Max-rows-per-poll versus Max-messages-per-poll</h3></div></div></div>

<p>The <span class="emphasis"><em>JDBC Inbound Channel Adapter</em></span> defines an attribute <code class="literal">max-rows-per-poll</code>.
When you specify the adapter&#8217;s <span class="emphasis"><em>Poller</em></span>, you can also define a property called <code class="literal">max-messages-per-poll</code>.
While these two attributes look similar, their meaning is quite different.</p>
<p><code class="literal">max-messages-per-poll</code> specifies the number of times the query is executed per polling interval, whereas <code class="literal">max-rows-per-poll</code> specifies the number of rows returned for each execution.</p>
<p>Under normal circumstances, you would likely not want to set the Poller&#8217;s <code class="literal">max-messages-per-poll</code> property when using the <span class="emphasis"><em>JDBC Inbound Channel Adapter</em></span>.
Its default value is <span class="emphasis"><em>1</em></span>, which means that the <span class="emphasis"><em>JDBC Inbound Channel Adapter</em></span>'s <a class="ulink" href="https://docs.spring.io/spring-integration/api/org/springframework/integration/jdbc/JdbcPollingChannelAdapter.html#receive()" target="_top"><code class="literal">receive()</code></a> method is executed exactly once for each poll interval.</p>
<p>Setting the <code class="literal">max-messages-per-poll</code> attribute to a larger value means that the query is executed that many times back to back.
For more information regarding the <code class="literal">max-messages-per-poll</code> attribute, please see <a class="xref" href="#channel-adapter-namespace-inbound" title="4.3.1&nbsp;Configuring An Inbound Channel Adapter">Section&nbsp;4.3.1, &#8220;Configuring An Inbound Channel Adapter&#8221;</a>.</p>
<p>In contrast, the <code class="literal">max-rows-per-poll</code> attribute, if greater than <span class="emphasis"><em>0</em></span>, specifies the maximum number of rows that will be used from the query result set, per execution of the <code class="literal">receive()</code> method.
If the attribute is set to <span class="emphasis"><em>0</em></span>, then all rows will be included in the resulting message.
If not explicitly set, the attribute defaults to <span class="emphasis"><em>0</em></span>.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jdbc-outbound-channel-adapter" href="#jdbc-outbound-channel-adapter"></a>18.2&nbsp;Outbound Channel Adapter</h2></div></div></div>

<p>The outbound Channel Adapter is the inverse of the inbound: its role is to handle a message and use it to execute a SQL query.
The message payload and headers are available by default as input parameters to the query, for instance:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-jdbc:outbound-channel-adapter</span>
    <span class="hl-attribute">query</span>=<span class="hl-value">"insert into foos (id, status, name) values (:headers[id], 0, :payload[foo])"</span>
    <span class="hl-attribute">data-source</span>=<span class="hl-value">"dataSource"</span>
    <span class="hl-attribute">channel</span>=<span class="hl-value">"input"</span><span class="hl-tag">/&gt;</span></pre>
<p>In the example above, messages arriving on the channel labelled <span class="emphasis"><em>input</em></span> have a payload of a map with key <span class="emphasis"><em>foo</em></span>, so the <code class="literal">[]</code> operator dereferences that value from the map.
The headers are also accessed as a map.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The parameters in the query above are bean property expressions on the incoming message (not Spring EL expressions).
This behavior is part of the <code class="literal">SqlParameterSource</code> which is the default source created by the outbound adapter.
Other behavior is possible in the adapter, and requires the user to inject a different <code class="literal">SqlParameterSourceFactory</code>.</p>
</td></tr></table></div>
<p>The outbound adapter requires a reference to either a <code class="literal">DataSource</code> or a <code class="literal">JdbcTemplate</code>.
It can also have a <code class="literal">SqlParameterSourceFactory</code> injected to control the binding of each incoming message to a query.</p>
<p>If the input channel is a direct channel, then the outbound adapter runs its query in the same thread, and therefore the same transaction (if there is one) as the sender of the message.</p>
<p><span class="emphasis"><em>Passing Parameters using SpEL Expressions</em></span></p>
<p>A common requirement for most JDBC Channel Adapters is to pass parameters as part of Sql queries or Stored Procedures/Functions.
As mentioned above, these parameters are by default bean property expressions, not SpEL expressions.
However, if you need to pass SpEL expression as parameters, you must inject a <code class="literal">SqlParameterSourceFactory</code> explicitly.</p>
<p>The following example uses a <code class="literal">ExpressionEvaluatingSqlParameterSourceFactory</code> to achieve that requirement.</p>
<pre class="programlisting"><span class="hl-tag">&lt;jdbc:outbound-channel-adapter</span> <span class="hl-attribute">data-source</span>=<span class="hl-value">"dataSource"</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"input"</span>
    <span class="hl-attribute">query</span>=<span class="hl-value">"insert into MESSAGES (MESSAGE_ID,PAYLOAD,CREATED_DATE)     \
    values (:id, :payload, :createdDate)"</span>
    <span class="hl-attribute">sql-parameter-source-factory</span>=<span class="hl-value">"spelSource"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"spelSource"</span>
      <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.integration.jdbc.ExpressionEvaluatingSqlParameterSourceFactory"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"parameterExpressions"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;map&gt;</span>
            <span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"id"</span>          <span class="hl-attribute">value</span>=<span class="hl-value">"headers['id'].toString()"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"createdDate"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"new java.util.Date()"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"payload"</span>     <span class="hl-attribute">value</span>=<span class="hl-value">"payload"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/map&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
<p>For further information, please also see <a class="xref" href="#sp-defining-parameter-sources" title="18.5.5&nbsp;Defining Parameter Sources">Section&nbsp;18.5.5, &#8220;Defining Parameter Sources&#8221;</a></p>
<p><span class="emphasis"><em>PreparedStatement Callback</em></span></p>
<p>There are some cases when the flexibility and loose-coupling of <code class="literal">SqlParameterSourceFactory</code> isn&#8217;t enough for the target
<code class="literal">PreparedStatement</code> or we need to do some low-level JDBC work.
The Spring JDBC module provides APIs to configure the execution environment (e.g. <code class="literal">ConnectionCallback</code>
or <code class="literal">PreparedStatementCreator</code>) and manipulation of parameter values (e.g. <code class="literal">SqlParameterSource</code>).
Or even APIs for low level operations, for example <code class="literal">StatementCallback</code>.</p>
<p>Starting with <span class="emphasis"><em>Spring Integration 4.2</em></span>, the <code class="literal">MessagePreparedStatementSetter</code> is available to allow
the specification of parameters on the <code class="literal">PreparedStatement</code> manually, in the <code class="literal">requestMessage</code> context.
This class plays exactly the same role as <code class="literal">PreparedStatementSetter</code> in the standard Spring JDBC API.
Actually it is invoked directly from an inline <code class="literal">PreparedStatementSetter</code> implementation, when the <code class="literal">JdbcMessageHandler</code>
invokes <code class="literal">execute</code> on the <code class="literal">JdbcTemplate</code>.</p>
<p>This functional interface option is mutually exclusive with <code class="literal">sqlParameterSourceFactory</code> and can be used as a more
powerful alternative to populate parameters of the <code class="literal">PreparedStatement</code> from the <code class="literal">requestMessage</code>.
For example it is useful when we need to store <code class="literal">File</code> data to the DataBase <code class="literal">BLOB</code> column in a stream manner:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "storeFileChannel")</span></em>
<span class="hl-keyword">public</span> MessageHandler jdbcMessageHandler(DataSource dataSource) {
    JdbcMessageHandler jdbcMessageHandler = <span class="hl-keyword">new</span> JdbcMessageHandler(dataSource,
            <span class="hl-string">"INSERT INTO imagedb (image_name, content, description) VALUES (?, ?, ?)"</span>);
    jdbcMessageHandler.setPreparedStatementSetter((ps, m) -&gt; {
        ps.setString(<span class="hl-number">1</span>, m.getHeaders().get(FileHeaders.FILENAME));
        <span class="hl-keyword">try</span> (FileInputStream inputStream = <span class="hl-keyword">new</span> FileInputStream((File) m.getPayload())) {
            ps.setBlob(<span class="hl-number">2</span>, inputStream);
        }
        <span class="hl-keyword">catch</span> (Exception e) {
            <span class="hl-keyword">throw</span> <span class="hl-keyword">new</span> MessageHandlingException(m, e);
        }
        ps.setClob(<span class="hl-number">3</span>, <span class="hl-keyword">new</span> StringReader(m.getHeaders().get(<span class="hl-string">"description"</span>, String.<span class="hl-keyword">class</span>)));
    });
    <span class="hl-keyword">return</span> jdbcMessageHandler;
}</pre>
<p>From the XML configuration perspective, the <code class="literal">prepared-statement-setter</code> attribute is available on the
<code class="literal">&lt;int-jdbc:outbound-channel-adapter&gt;</code> component, to specify a  <code class="literal">MessagePreparedStatementSetter</code>
bean reference.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jdbc-outbound-gateway" href="#jdbc-outbound-gateway"></a>18.3&nbsp;Outbound Gateway</h2></div></div></div>

<p>The outbound Gateway is like a combination of the outbound and inbound adapters: its role is to handle a message and use it to execute a SQL query and then respond with the result sending it to a reply channel.
The message payload and headers are available by default as input parameters to the query, for instance:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-jdbc:outbound-gateway</span>
    <span class="hl-attribute">update</span>=<span class="hl-value">"insert into foos (id, status, name) values (:headers[id], 0, :payload[foo])"</span>
    <span class="hl-attribute">request-channel</span>=<span class="hl-value">"input"</span> <span class="hl-attribute">reply-channel</span>=<span class="hl-value">"output"</span> <span class="hl-attribute">data-source</span>=<span class="hl-value">"dataSource"</span><span class="hl-tag"> /&gt;</span></pre>
<p>The result of the above would be to insert a record into the "foos" table and return a message to the output channel indicating the number of rows affected (the payload is a map: <code class="literal">{UPDATED=1}</code>).</p>
<p>If the update query is an insert with auto-generated keys, the reply message can be populated with the generated keys by adding <code class="literal">keys-generated="true"</code> to the above example (this is not the default because it is not supported by some database platforms).
For example:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-jdbc:outbound-gateway</span>
    <span class="hl-attribute">update</span>=<span class="hl-value">"insert into foos (status, name) values (0, :payload[foo])"</span>
    <span class="hl-attribute">request-channel</span>=<span class="hl-value">"input"</span> <span class="hl-attribute">reply-channel</span>=<span class="hl-value">"output"</span> <span class="hl-attribute">data-source</span>=<span class="hl-value">"dataSource"</span>
    <span class="hl-attribute">keys-generated</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span></pre>
<p>Instead of the update count or the generated keys, you can also provide a select query to execute and generate a reply message from the result (like the inbound adapter), e.g:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-jdbc:outbound-gateway</span>
    <span class="hl-attribute">update</span>=<span class="hl-value">"insert into foos (id, status, name) values (:headers[id], 0, :payload[foo])"</span>
    <span class="hl-attribute">query</span>=<span class="hl-value">"select * from foos where id=:headers[$id]"</span>
    <span class="hl-attribute">request-channel</span>=<span class="hl-value">"input"</span> <span class="hl-attribute">reply-channel</span>=<span class="hl-value">"output"</span> <span class="hl-attribute">data-source</span>=<span class="hl-value">"dataSource"</span><span class="hl-tag">/&gt;</span></pre>
<p>Since <span class="emphasis"><em>Spring Integration 2.2</em></span> the update SQL query is no longer mandatory.
You can now solely provide a select query, using either the <span class="emphasis"><em>query attribute</em></span> or the <span class="emphasis"><em>query sub-element</em></span>.
This is extremely useful if you need to actively retrieve data using e.g.
a generic Gateway or a Payload Enricher.
The reply message is then generated from the result, like the inbound adapter, and passed to the reply channel.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-jdbc:outbound-gateway</span>
    <span class="hl-attribute">query</span>=<span class="hl-value">"select * from foos where id=:headers[id]"</span>
    <span class="hl-attribute">request-channel</span>=<span class="hl-value">"input"</span>
    <span class="hl-attribute">reply-channel</span>=<span class="hl-value">"output"</span>
    <span class="hl-attribute">data-source</span>=<span class="hl-value">"dataSource"</span><span class="hl-tag">/&gt;</span></pre>
<p>As with the channel adapters, there is also the option to provide <code class="literal">SqlParameterSourceFactory</code> instances for request and reply.
The default is the same as for the outbound adapter, so the request message is available as the root of an expression.
If <code class="literal">keys-generated="true"</code> then the root of the expression is the generated keys (a map if there is only one or a list of maps if multi-valued).</p>
<p>The outbound gateway requires a reference to either a DataSource or a JdbcTemplate.
It can also have a <code class="literal">SqlParameterSourceFactory</code> injected to control the binding of the incoming message to the query.</p>
<p>Starting with the <span class="emphasis"><em>version 4.2</em></span> the <code class="literal">request-prepared-statement-setter</code> attribute is available on the
<code class="literal">&lt;int-jdbc:outbound-gateway&gt;</code> as an alternative to the <code class="literal">request-sql-parameter-source-factory</code>.
It allows you to specify a <code class="literal">MessagePreparedStatementSetter</code> bean reference, which implements more sophisticated
<code class="literal">PreparedStatement</code> preparation before its execution.</p>
<p>See <a class="xref" href="#jdbc-outbound-channel-adapter" title="18.2&nbsp;Outbound Channel Adapter">Section&nbsp;18.2, &#8220;Outbound Channel Adapter&#8221;</a> for more information about <code class="literal">MessagePreparedStatementSetter</code>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jdbc-message-store" href="#jdbc-message-store"></a>18.4&nbsp;JDBC Message Store</h2></div></div></div>

<p>Spring Integration provides 2 JDBC specific Message Store implementations.
The first one, is the <code class="literal">JdbcMessageStore</code> which is suitable to be used in conjunction with <span class="emphasis"><em>Aggregators</em></span> and the
<span class="emphasis"><em>Claim-Check</em></span> pattern.
While it can be used for backing <span class="emphasis"><em>Message Channels</em></span> as well, you may want to consider using the <code class="literal">JdbcChannelMessageStore</code> implementation instead, as it provides a more targeted and scalable implementation.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jdbc-message-store-generic" href="#jdbc-message-store-generic"></a>18.4.1&nbsp;The Generic JDBC Message Store</h3></div></div></div>

<p>The JDBC module provides an implementation of the Spring Integration <code class="literal">MessageStore</code> (important in the Claim Check pattern) and <code class="literal">MessageGroupStore</code> (important in stateful patterns like Aggregator) backed by a database.
Both interfaces are implemented by the <code class="literal">JdbcMessageStore</code>, and there is also support for configuring store instances in XML.
For example:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-jdbc:message-store</span> <span class="hl-attribute">id</span>=<span class="hl-value">"messageStore"</span> <span class="hl-attribute">data-source</span>=<span class="hl-value">"dataSource"</span><span class="hl-tag">/&gt;</span></pre>
<p>A <code class="literal">JdbcTemplate</code> can be specified instead of a <code class="literal">DataSource</code>.</p>
<p>Other optional attributes are show in the next example:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-jdbc:message-store</span> <span class="hl-attribute">id</span>=<span class="hl-value">"messageStore"</span> <span class="hl-attribute">data-source</span>=<span class="hl-value">"dataSource"</span>
    <span class="hl-attribute">lob-handler</span>=<span class="hl-value">"lobHandler"</span> <span class="hl-attribute">table-prefix</span>=<span class="hl-value">"MY_INT_"</span><span class="hl-tag">/&gt;</span></pre>
<p>Here we have specified a <code class="literal">LobHandler</code> for dealing with messages as large objects (e.g.
often necessary if using Oracle) and a prefix for the table names in the queries generated by the store.
The table name prefix defaults to <code class="literal">INT_</code>.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>If you plan on using <span class="strong"><strong>MySQL</strong></span>, please use MySQL version <span class="emphasis"><em>5.6.4</em></span> or higher, if possible.
Prior versions do not support <span class="emphasis"><em>fractional seconds</em></span> for temporal data types.
Because of that, messages may not arrive in the precise FIFO order when polling from such a MySQL Message Store.</p>
<p>Therefore, starting with <span class="emphasis"><em>Spring Integration 3.0</em></span>, we provide an additional set of DDL scripts for MySQL version <span class="emphasis"><em>5.6.4</em></span> or higher:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
schema-drop-mysql-5_6_4.sql
</li><li class="listitem">
schema-mysql-5_6_4.sql
</li></ul></div>
<p>For more information, please see: <a class="ulink" href="https://dev.mysql.com/doc/refman/5.6/en/fractional-seconds.html" target="_top">Fractional Seconds in Time Values</a>.</p>
<p>Also important, please ensure that you use an up-to-date version of the JDBC driver for MySQL (Connector/J), e.g.
version <span class="emphasis"><em>5.1.24</em></span> or higher.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jdbc-message-store-channels" href="#jdbc-message-store-channels"></a>18.4.2&nbsp;Backing Message Channels</h3></div></div></div>

<p>If you intend backing <span class="emphasis"><em>Message Channels</em></span> using JDBC, it is recommended to use the provided <code class="literal">JdbcChannelMessageStore</code> implementation instead.
It can only be used in conjunction with <span class="emphasis"><em>Message Channels</em></span>.</p>
<p><span class="strong"><strong>Supported Databases</strong></span></p>
<p>The <code class="literal">JdbcChannelMessageStore</code> uses database specific SQL queries to retrieve messages from the database.
Therefore, users must set the <code class="literal">ChannelMessageStoreQueryProvider</code> property on the <code class="literal">JdbcChannelMessageStore</code>.
This <code class="literal">channelMessageStoreQueryProvider</code> provides the SQL queries and Spring Integration provides support for the following relational databases:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
PostgreSQL
</li><li class="listitem">
HSQLDB
</li><li class="listitem">
MySQL
</li><li class="listitem">
Oracle
</li><li class="listitem">
Derby
</li><li class="listitem">
H2
</li></ul></div>
<p>If your database is not listed, you can easily extend the <code class="literal">AbstractChannelMessageStoreQueryProvider</code> class and provide your own custom queries.</p>
<p>Since <span class="emphasis"><em>version 4.0</em></span>, the <code class="literal">MESSAGE_SEQUENCE</code> column has been added to the table to ensure first-in-first-out (FIFO) queueing even when messages are stored in the same millisecond.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Generally it is not recommended to use a relational database for the purpose of queuing.
Instead, if possible, consider using either JMS or AMQP backed channels instead.
For further reference please see the following resources:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="ulink" href="https://www.engineyard.com/blog/2011/5-subtle-ways-youre-using-mysql-as-a-queue-and-why-itll-bite-you/" target="_top">5 subtle ways you&#8217;re using MySQL as a queue, and why it&#8217;ll bite you</a>.
</li><li class="listitem">
<a class="ulink" href="https://mikehadlow.blogspot.com/2012/04/database-as-queue-anti-pattern.html" target="_top">The Database As Queue Anti-Pattern</a>.
</li></ul></div>
</td></tr></table></div>
<p><span class="strong"><strong>Concurrent Polling</strong></span></p>
<p>When polling a <span class="emphasis"><em>Message Channel</em></span>, you have the option to configure the associated <code class="literal">Poller</code> with a <code class="literal">TaskExecutor</code> reference.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Keep in mind, though, that if you use a JDBC backed <span class="emphasis"><em>Message Channel</em></span> and you are planning on polling the channel and consequently the message store transactionally with multiple threads, you should ensure that you use a relational database that supports <a class="ulink" href="https://en.wikipedia.org/wiki/Multiversion_concurrency_control" target="_top">Multiversion Concurrency Control</a> (MVCC).
Otherwise, locking may be an issue and the performance, when using multiple threads, may not materialize as expected.
For example Apache Derby is problematic in that regard.</p>
<p>To achieve better JDBC queue throughput, and avoid issues when different threads may poll the same <code class="literal">Message</code> from the queue, it is <span class="strong"><strong>important</strong></span> to set the <code class="literal">usingIdCache</code> property of <code class="literal">JdbcChannelMessageStore</code> to <code class="literal">true</code> when using databases that do not support MVCC:</p>
</td></tr></table></div>
<pre class="programlisting">&#8230;
<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"queryProvider"</span>
    <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.jdbc.store.channel.PostgresChannelMessageStoreQueryProvider"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int:transaction-synchronization-factory</span> <span class="hl-attribute">id</span>=<span class="hl-value">"syncFactory"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:after-commit</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"@store.removeFromIdCache(headers.id.toString())"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;int:after-rollback</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"@store.removeFromIdCache(headers.id.toString())"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:transaction-synchronization-factory&gt;</span>

<span class="hl-tag">&lt;task:executor</span> <span class="hl-attribute">id</span>=<span class="hl-value">"pool"</span> <span class="hl-attribute">pool-size</span>=<span class="hl-value">"10"</span>
    <span class="hl-attribute">queue-capacity</span>=<span class="hl-value">"10"</span> <span class="hl-attribute">rejection-policy</span>=<span class="hl-value">"CALLER_RUNS"</span><span class="hl-tag"> /&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"store"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.jdbc.store.JdbcChannelMessageStore"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"dataSource"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"dataSource"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"channelMessageStoreQueryProvider"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"queryProvider"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"region"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"TX_TIMEOUT"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"usingIdCache"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"inputChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:queue</span> <span class="hl-attribute">message-store</span>=<span class="hl-value">"store"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:channel&gt;</span>

<span class="hl-tag">&lt;int:bridge</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"inputChannel"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"outputChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">fixed-delay</span>=<span class="hl-value">"500"</span> <span class="hl-attribute">receive-timeout</span>=<span class="hl-value">"500"</span>
        <span class="hl-attribute">max-messages-per-poll</span>=<span class="hl-value">"1"</span> <span class="hl-attribute">task-executor</span>=<span class="hl-value">"pool"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;int:transactional</span> <span class="hl-attribute">propagation</span>=<span class="hl-value">"REQUIRED"</span> <span class="hl-attribute">synchronization-factory</span>=<span class="hl-value">"syncFactory"</span>
        <span class="hl-attribute">isolation</span>=<span class="hl-value">"READ_COMMITTED"</span> <span class="hl-attribute">transaction-manager</span>=<span class="hl-value">"transactionManager"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;/int:poller&gt;</span>
<span class="hl-tag">&lt;/int:bridge&gt;</span>

<span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"outputChannel"</span><span class="hl-tag"> /&gt;</span>
&#8230;</pre>
<p><span class="strong"><strong>Priority Channel</strong></span></p>
<p>Starting with <span class="emphasis"><em>version 4.0</em></span>, the <code class="literal">JdbcChannelMessageStore</code> implements <code class="literal">PriorityCapableChannelMessageStore</code> and provides the <code class="literal">priorityEnabled</code> option allowing it to be used as a <code class="literal">message-store</code> reference for <code class="literal">priority-queue</code> s.
For this purpose, the <code class="literal">INT_CHANNEL_MESSAGE</code> has a <code class="literal">MESSAGE_PRIORITY</code> column to store the value of <code class="literal">PRIORITY</code> Message header.
In addition, a new <code class="literal">MESSAGE_SEQUENCE</code> column is also provided to achieve a robust first-in-first-out (FIFO) polling mechanism, even when multiple messages are stored with the same priority in the same millisecond.
Messages are polled (selected) from the database with <code class="literal">order by MESSAGE_PRIORITY DESC NULLS LAST, CREATED_DATE, MESSAGE_SEQUENCE</code>.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>It&#8217;s not recommended to use the same <code class="literal">JdbcChannelMessageStore</code> bean for priority and non-priority queue channel, because <code class="literal">priorityEnabled</code> option applies to the entire store and proper FIFO queue semantics will not be retained for the queue channel.
However the same <code class="literal">INT_CHANNEL_MESSAGE</code> table, and even <code class="literal">region</code>, can be used for both <code class="literal">JdbcChannelMessageStore</code> types.
To configure that scenario, simply extend one message store bean from the other:</p>
</td></tr></table></div>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"channelStore"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.jdbc.store.JdbcChannelMessageStore"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"dataSource"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"dataSource"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"channelMessageStoreQueryProvider"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"queryProvider"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"queueChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:queue</span> <span class="hl-attribute">message-store</span>=<span class="hl-value">"channelStore"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:channel&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"priorityStore"</span> <span class="hl-attribute">parent</span>=<span class="hl-value">"channelStore"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"priorityEnabled"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"priorityChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:priority-queue</span> <span class="hl-attribute">message-store</span>=<span class="hl-value">"priorityStore"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:channel&gt;</span></pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_initializing_the_database" href="#_initializing_the_database"></a>18.4.3&nbsp;Initializing the Database</h3></div></div></div>

<p>Spring Integration ships with some sample scripts that can be used to initialize a database.
In the spring-integration-jdbc JAR file you will find scripts in the <code class="literal">org.springframework.integration.jdbc</code> and in the <code class="literal">org.springframework.integration.jdbc.store.channel</code> package: there is a create and a drop script example for a range of common database platforms.
A common way to use these scripts is to reference them in a <a class="ulink" href="https://docs.spring.io/spring/docs/current/spring-framework-reference/html/jdbc.html#jdbc-intializing-datasource" target="_top">Spring JDBC data source initializer</a>.
Note that the scripts are provided as samples or specifications of the the required table and column names.
You may find that you need to enhance them for production use (e.g.
with index declarations).</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_partitioning_a_message_store" href="#_partitioning_a_message_store"></a>18.4.4&nbsp;Partitioning a Message Store</h3></div></div></div>

<p>It is common to use a <code class="literal">JdbcMessageStore</code> as a global store for a group of applications, or nodes in the same application.
To provide some protection against name clashes, and to give control over the database meta-data configuration, the message store allows the tables to be partitioned in two ways.
One is to use separate table names, by changing the prefix as described above, and the other is to specify a "region" name for partitioning data within a single table.
An important use case for this is when the MessageStore is managing persistent queues backing a Spring Integration Message Channel.
The message data for a persistent channel is keyed in the store on the channel name, so if the channel names are not globally unique then there is the danger of channels picking up data that was not intended for them.
To avoid this, the message store <span class="emphasis"><em>region</em></span> can be used to keep data separate for different physical channels that happen to have the same logical name.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="stored-procedures" href="#stored-procedures"></a>18.5&nbsp;Stored Procedures</h2></div></div></div>

<p>In certain situations plain JDBC support is not sufficient.
Maybe you deal with legacy relational database schemas or you have complex data processing needs, but ultimately you have to use <a class="ulink" href="https://en.wikipedia.org/wiki/Stored_procedure" target="_top">Stored Procedures</a> or Stored Functions.
Since Spring Integration 2.1, we provide three components in order to execute Stored Procedures or Stored Functions:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Stored Procedures Inbound Channel Adapter
</li><li class="listitem">
Stored Procedures Outbound Channel Adapter
</li><li class="listitem">
Stored Procedures Outbound Gateway
</li></ul></div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="sp-supported-databases" href="#sp-supported-databases"></a>18.5.1&nbsp;Supported Databases</h3></div></div></div>

<p>In order to enable calls to <span class="emphasis"><em>Stored Procedures</em></span> and <span class="emphasis"><em>Stored Functions</em></span>, the Stored Procedure components use the <a class="ulink" href="https://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/jdbc/core/simple/SimpleJdbcCall.html" target="_top"><code class="literal">org.springframework.jdbc.core.simple.SimpleJdbcCall</code></a> class.
Consequently, the following databases are fully supported for executing Stored Procedures:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Apache Derby
</li><li class="listitem">
DB2
</li><li class="listitem">
MySQL
</li><li class="listitem">
Microsoft SQL Server
</li><li class="listitem">
Oracle
</li><li class="listitem">
PostgreSQL
</li><li class="listitem">
Sybase
</li></ul></div>
<p>If you want to execute Stored Functions instead, the following databases are fully supported:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
MySQL
</li><li class="listitem">
Microsoft SQL Server
</li><li class="listitem">
Oracle
</li><li class="listitem">
PostgreSQL
</li></ul></div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Even though your particular database may not be fully supported, chances are, that you can use the Stored Procedure Spring Integration components quite successfully anyway, provided your RDBMS supports Stored Procedures or Functions.</p>
<p>As a matter of fact, some of the provided integration tests use the <a class="ulink" href="http://www.h2database.com/" target="_top">H2 database</a>.
Nevertheless, it is very important to thoroughly test those usage scenarios.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="sp-configuration" href="#sp-configuration"></a>18.5.2&nbsp;Configuration</h3></div></div></div>

<p>The Stored Procedure components provide full XML Namespace support and configuring the components is similar as for the general purpose JDBC components discussed earlier.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="sp-common-config-params" href="#sp-common-config-params"></a>18.5.3&nbsp;Common Configuration Attributes</h3></div></div></div>

<p>Certain configuration parameters are shared among all Stored Procedure components and are described below:</p>
<p><span class="strong"><strong>auto-startup</strong></span></p>
<p>Lifecycle attribute signaling if this component should be started during Application Context startup.
Defaults to <code class="literal">true</code>.
<span class="emphasis"><em>Optional</em></span>.</p>
<p><span class="strong"><strong>data-source</strong></span></p>
<p>Reference to a <code class="literal">javax.sql.DataSource</code>, which is used to access the database. <span class="emphasis"><em>Required</em></span>.</p>
<p><span class="strong"><strong>id</strong></span></p>
<p>Identifies the underlying Spring bean definition, which is an instance of either <code class="literal">EventDrivenConsumer</code> or <code class="literal">PollingConsumer</code>, depending on whether the Outbound Channel Adapter&#8217;s <code class="literal">channel</code> attribute references a <code class="literal">SubscribableChannel</code> or a <code class="literal">PollableChannel</code>.
<span class="emphasis"><em>Optional</em></span>.</p>
<p><span class="strong"><strong>ignore-column-meta-data</strong></span></p>
<p>For fully supported databases, the underlying <a class="ulink" href="https://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/jdbc/core/simple/SimpleJdbcCall.html" target="_top"><code class="literal">SimpleJdbcCall</code></a> class can automatically retrieve the parameter information for the to be invoked Stored Procedure or Function from the JDBC Meta-data.</p>
<p>However, if the used database does not support meta data lookups or if you like to provide customized parameter definitions, this flag can be set to <code class="literal">true</code>.
It defaults to <code class="literal">false</code>.
<span class="emphasis"><em>Optional</em></span>.</p>
<p><span class="strong"><strong>is-function</strong></span></p>
<p>If <code class="literal">true</code>, a SQL Function is called.
In that case the <code class="literal">stored-procedure-name</code> or <code class="literal">stored-procedure-name-expression</code> attributes define the name of the called function.
Defaults to <code class="literal">false</code>.
<span class="emphasis"><em>Optional</em></span>.</p>
<p><span class="strong"><strong>stored-procedure-name</strong></span></p>
<p>The attribute specifies the name of the stored procedure.
If the <code class="literal">is-function</code> attribute is set to <code class="literal">true</code>, this attribute specifies the function name instead.
Either this property or <code class="literal">stored-procedure-name-expression</code> must be specified.</p>
<p><span class="strong"><strong>stored-procedure-name-expression</strong></span></p>
<p>This attribute specifies the name of the stored procedure using a SpEL expression.
Using SpEL you have access to the full message (if available), including its headers and payload.
You can use this attribute to invoke different Stored Procedures at runtime.
For example, you can provide Stored Procedure names that you would like to execute as a Message Header.
The expression must resolve to a String.</p>
<p>If the <code class="literal">is-function</code> attribute is set to <code class="literal">true</code>, this attribute specifies a Stored Function.
Either this property or <span class="emphasis"><em>stored-procedure-name</em></span> must be specified.</p>
<p><span class="strong"><strong>jdbc-call-operations-cache-size</strong></span></p>
<p>Defines the maximum number of cached <code class="literal">SimpleJdbcCallOperations</code> instances.
Basically, for each Stored Procedure Name a new <a class="ulink" href="https://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/jdbc/core/simple/SimpleJdbcCallOperations.html" target="_top"><code class="literal">SimpleJdbcCallOperations</code></a> instance is created that in return is being cached.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The <code class="literal">stored-procedure-name-expression</code> attribute and the <code class="literal">jdbc-call-operations-cache-size</code> were added with Spring Integration 2.2.</p>
</td></tr></table></div>
<p>The default cache size is <span class="emphasis"><em>10</em></span>.
A value of <span class="emphasis"><em>0</em></span> disables caching.
Negative values are not permitted.</p>
<p>If you enable JMX, statistical information about the <code class="literal">jdbc-call-operations-cache</code> is exposed as MBean.
Please see <a class="xref" href="#jmx-mbean-exporter" title="9.2.7&nbsp;MBean Exporter">Section&nbsp;9.2.7, &#8220;MBean Exporter&#8221;</a> for more information.</p>
<p><span class="strong"><strong>sql-parameter-source-factory</strong></span> (Not available for the Stored Procedure Inbound Channel Adapter.)</p>
<p>Reference to a <code class="literal">SqlParameterSourceFactory</code>.
By default bean properties of the passed in <code class="literal">Message</code> payload will be used as a source for the Stored Procedure&#8217;s input parameters using a <code class="literal">BeanPropertySqlParameterSourceFactory</code>.</p>
<p>This may be sufficient for basic use cases.
For more sophisticated options, consider passing in one or more <code class="literal">ProcedureParameter</code>.
Please also refer to <a class="xref" href="#sp-defining-parameter-sources" title="18.5.5&nbsp;Defining Parameter Sources">Section&nbsp;18.5.5, &#8220;Defining Parameter Sources&#8221;</a>.
<span class="emphasis"><em>Optional</em></span>.</p>
<p><span class="strong"><strong>use-payload-as-parameter-source</strong></span> (Not available for the Stored Procedure Inbound Channel Adapter.)</p>
<p>If set to <code class="literal">true</code>, the payload of the Message will be used as a source for providing parameters.
If false, however, the entire Message will be available as a source for parameters.</p>
<p>If no Procedure Parameters are passed in, this property will default to <code class="literal">true</code>.
This means that using a default <code class="literal">BeanPropertySqlParameterSourceFactory</code> the bean properties of the payload will be used as a source for parameter values for the to-be-executed Stored Procedure or Stored Function.</p>
<p>However, if Procedure Parameters are passed in, then this property will by default evaluate to <code class="literal">false</code>.
<code class="literal">ProcedureParameter</code> allow for SpEL Expressions to be provided and therefore it is highly beneficial to have access to the entire Message.
The property is set on the underlying <code class="literal">StoredProcExecutor</code>.
<span class="emphasis"><em>Optional</em></span>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="sp-common-config-subelements" href="#sp-common-config-subelements"></a>18.5.4&nbsp;Common Configuration Sub-Elements</h3></div></div></div>

<p>The Stored Procedure components share a common set of sub-elements to define and pass parameters to Stored Procedures or Functions.
The following elements are available:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">parameter</code>
</li><li class="listitem">
<code class="literal">returning-resultset</code>
</li><li class="listitem">
<code class="literal">sql-parameter-definition</code>
</li><li class="listitem">
<code class="literal">poller</code>
</li></ul></div>
<p><span class="strong"><strong>parameter</strong></span></p>
<p>Provides a mechanism to provide Stored Procedure parameters.
Parameters can be either static or provided using a SpEL Expressions. <span class="emphasis"><em>Optional</em></span>.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-jdbc:parameter</span> <span class="hl-attribute">name</span>=<span class="hl-value">""</span>     <a name="CO23-1" href="#CO23-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
                    type=""     <a name="CO23-2" href="#CO23-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
                    value=""/&gt;  <a name="CO23-3" href="#CO23-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>

<span class="hl-tag">&lt;int-jdbc:parameter</span> <span class="hl-attribute">name</span>=<span class="hl-value">""</span>
                    <span class="hl-attribute">expression</span>=<span class="hl-value">""</span><span class="hl-tag">/&gt;</span> <a name="CO23-4" href="#CO23-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO23-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The name of the parameter to be passed into the Stored Procedure or Stored Function. <span class="emphasis"><em>Required</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO23-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>This attribute specifies the type of the value.
If nothing is provided this attribute will default to <code class="literal">java.lang.String</code>.
This attribute is only used when the <code class="literal">value</code> attribute is used. <span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO23-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The value of the parameter.
You have to provider either this attribute or the <code class="literal">expression</code> attribute must be provided instead. <span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO23-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Instead of the <code class="literal">value</code> attribute, you can also specify a SpEL expression for passing the value of the parameter.
If you specify the <code class="literal">expression</code> the <code class="literal">value</code> attribute is not allowed.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr></table></div>
<p><span class="strong"><strong>returning-resultset</strong></span></p>
<p>Stored Procedures may return multiple result sets.
By setting one or more <code class="literal">returning-resultset</code> elements, you can specify <code class="literal">RowMappers</code> in order to convert each returned <code class="literal">ResultSet</code> to meaningful objects.
<span class="emphasis"><em>Optional</em></span>.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-jdbc:returning-resultset</span> <span class="hl-attribute">name</span>=<span class="hl-value">""</span> <span class="hl-attribute">row-mapper</span>=<span class="hl-value">""</span><span class="hl-tag"> /&gt;</span></pre>
<p><span class="strong"><strong>sql-parameter-definition</strong></span></p>
<p>If you are using a database that is fully supported, you typically don&#8217;t have to specify the Stored Procedure parameter definitions.
Instead, those parameters can be automatically derived from the JDBC Meta-data.
However, if you are using databases that are not fully supported, you must set those parameters explicitly using the <code class="literal">sql-parameter-definition</code> sub-element.</p>
<p>You can also choose to turn off any processing of parameter meta data information obtained via JDBC using the <code class="literal">ignore-column-meta-data</code> attribute.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-jdbc:sql-parameter-definition</span>
                                   <span class="hl-attribute">name</span>=<span class="hl-value">""</span>                           <a name="CO24-1" href="#CO24-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
                                   direction="IN"                    <a name="CO24-2" href="#CO24-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
                                   type="STRING"                     <a name="CO24-3" href="#CO24-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
                                   scale="5"                         <a name="CO24-4" href="#CO24-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
                                   type-name="FOO_STRUCT"            <a name="CO24-5" href="#CO24-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
                                   return-type="fooSqlReturnType"/&gt;  <a name="CO24-6" href="#CO24-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO24-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Specifies the name of the SQL parameter.
<span class="emphasis"><em>Required</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO24-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Specifies the direction of the SQL parameter definition.
Defaults to <code class="literal">IN</code>.
Valid values are: <code class="literal">IN</code>, <code class="literal">OUT</code> and <code class="literal">INOUT</code>.
If your procedure is returning ResultSets, please use the <code class="literal">returning-resultset</code> element.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO24-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The SQL type used for this SQL parameter definition.
Will translate into the integer value as defined by java.sql.Types.
Alternatively you can provide the integer value as well.
If this attribute is not explicitly set, then it will default to <span class="emphasis"><em>VARCHAR</em></span>. <span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO24-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The scale of the SQL parameter.
Only used for numeric and decimal parameters. <span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO24-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The typeName for types that are user-named like: <code class="literal">STRUCT</code>, <code class="literal">DISTINCT</code>, <code class="literal">JAVA_OBJECT</code>, named array types.
This attribute is mutually exclusive with the <span class="emphasis"><em>scale</em></span> attribute.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO24-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The reference to a custom value handler for complex types.
An implementation of <a class="ulink" href="https://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/jdbc/core/SqlReturnType.html" target="_top">SqlReturnType</a>.
This attribute is mutually exclusive with the <span class="emphasis"><em>scale</em></span> attribute and is applicable for OUT(INOUT)-parameters only. <span class="emphasis"><em>Optional</em></span>.</p>
</td></tr></table></div>
<p><span class="strong"><strong>poller</strong></span></p>
<p>Allows you to configure a Message Poller if this endpoint is a <code class="literal">PollingConsumer</code>.
<span class="emphasis"><em>Optional</em></span>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="sp-defining-parameter-sources" href="#sp-defining-parameter-sources"></a>18.5.5&nbsp;Defining Parameter Sources</h3></div></div></div>

<p>Parameter Sources govern the techniques of retrieving and mapping the Spring Integration Message properties to the relevant Stored Procedure input parameters.
The Stored Procedure components follow certain rules.</p>
<p>By default bean properties of the passed in <code class="literal">Message</code> payload will be used as a source for the Stored Procedure&#8217;s input parameters.
In that case a <code class="literal">BeanPropertySqlParameterSourceFactory</code> will be used.
This may be sufficient for basic use cases.
The following example illustrates that default behavior.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Please be aware that for the "automatic" lookup of bean properties using the <code class="literal">BeanPropertySqlParameterSourceFactory</code> to work, your bean properties must be defined in lower case.
This is due to the fact that in <code class="literal">org.springframework.jdbc.core.metadata.CallMetaDataContext</code> (method <code class="literal">matchInParameterValuesWithCallParameters()</code>), the retrieved Stored Procedure parameter declarations are converted to lower case.
As a result, if you have camel-case bean properties such as "lastName", the lookup will fail.
In that case, please provide an explicit <code class="literal">ProcedureParameter</code>.</p>
</td></tr></table></div>
<p>Let&#8217;s assume we have a payload that consists of a simple bean with the following three properties: <span class="emphasis"><em>id</em></span>, <span class="emphasis"><em>name</em></span> and <span class="emphasis"><em>description</em></span>.
Furthermore, we have a simplistic Stored Procedure called <span class="emphasis"><em>INSERT_COFFEE</em></span> that accepts three input parameters: <span class="emphasis"><em>id</em></span>, <span class="emphasis"><em>name</em></span> and <span class="emphasis"><em>description</em></span>.
We also use a fully supported database.
In that case the following configuration for a Stored Procedure Outbound Adapter will be sufficient:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-jdbc:stored-proc-outbound-channel-adapter</span> <span class="hl-attribute">data-source</span>=<span class="hl-value">"dataSource"</span>
    <span class="hl-attribute">channel</span>=<span class="hl-value">"insertCoffeeProcedureRequestChannel"</span>
    <span class="hl-attribute">stored-procedure-name</span>=<span class="hl-value">"INSERT_COFFEE"</span><span class="hl-tag">/&gt;</span></pre>
<p>For more sophisticated options consider passing in one or more <code class="literal">ProcedureParameter</code>.</p>
<p>If you do provide <code class="literal">ProcedureParameter</code> explicitly, then as default an <code class="literal">ExpressionEvaluatingSqlParameterSourceFactory</code> will be used for parameter processing in order to enable the full power of SpEL expressions.</p>
<p>Furthermore, if you need even more control over how parameters are retrieved, consider passing in a custom implementation of a <code class="literal">SqlParameterSourceFactory</code> using the <code class="literal">sql-parameter-source-factory</code> attribute.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="stored-procedure-inbound-channel-adapter" href="#stored-procedure-inbound-channel-adapter"></a>18.5.6&nbsp;Stored Procedure Inbound Channel Adapter</h3></div></div></div>

<pre class="programlisting"><span class="hl-tag">&lt;int-jdbc:stored-proc-inbound-channel-adapter</span>
                                   <span class="hl-attribute">channel</span>=<span class="hl-value">""</span>                                    <a name="CO25-1" href="#CO25-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
                                   stored-procedure-name=""
                                   data-source=""
                                   auto-startup="true"
                                   id=""
                                   ignore-column-meta-data="false"
                                   is-function="false"
                                   max-rows-per-poll=""                          <a name="CO25-2" href="#CO25-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
                                   skip-undeclared-results=""                    <a name="CO25-3" href="#CO25-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
                                   return-value-required="false"                 <a name="CO25-4" href="#CO25-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
    <span class="hl-tag">&lt;int:poller/&gt;</span>
    <span class="hl-tag">&lt;int-jdbc:sql-parameter-definition</span> <span class="hl-attribute">name</span>=<span class="hl-value">""</span> <span class="hl-attribute">direction</span>=<span class="hl-value">"IN"</span>
                                               <span class="hl-attribute">type</span>=<span class="hl-value">"STRING"</span>
                                               <span class="hl-attribute">scale</span>=<span class="hl-value">""</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int-jdbc:parameter</span> <span class="hl-attribute">name</span>=<span class="hl-value">""</span> <span class="hl-attribute">type</span>=<span class="hl-value">""</span> <span class="hl-attribute">value</span>=<span class="hl-value">""</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int-jdbc:parameter</span> <span class="hl-attribute">name</span>=<span class="hl-value">""</span> <span class="hl-attribute">expression</span>=<span class="hl-value">""</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int-jdbc:returning-resultset</span> <span class="hl-attribute">name</span>=<span class="hl-value">""</span> <span class="hl-attribute">row-mapper</span>=<span class="hl-value">""</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/int-jdbc:stored-proc-inbound-channel-adapter&gt;</span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO25-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Channel to which polled messages will be sent.
If the stored procedure or function does not return any data, the payload of the Message will be Null.
<span class="emphasis"><em>Required</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO25-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Limits the number of rows extracted per query.
Otherwise all rows are extracted into the outgoing message. <span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO25-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>If this attribute is set to <code class="literal">true</code>, then all results from a stored procedure call that don&#8217;t have a corresponding <code class="literal">SqlOutParameter</code> declaration will be bypassed.
E.g. Stored Procedures may return an update count value, even though your Stored Procedure only declared a single result parameter.
The exact behavior depends on the used database.
The value is set on the underlying <code class="literal">JdbcTemplate</code>.
Few developers will probably ever want to process update counts, thus the value defaults to <code class="literal">true</code>.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO25-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Indicates whether this procedure&#8217;s return value should be included.
Since <span class="emphasis"><em>Spring Integration 3.0</em></span>. <span class="emphasis"><em>Optional</em></span>.</p>
</td></tr></table></div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>When you declare a Poller, you may notice the Poller&#8217;s <code class="literal">max-messages-per-poll</code> attribute.
For information about how it relates to the <code class="literal">max-rows-per-poll</code> attribute of the <span class="emphasis"><em>Stored Procedure Inbound Channel Adapter</em></span>, please see <a class="xref" href="#jdbc-max-rows-per-poll-versus-max-messages-per-poll" title="18.1.2&nbsp;Max-rows-per-poll versus Max-messages-per-poll">Section&nbsp;18.1.2, &#8220;Max-rows-per-poll versus Max-messages-per-poll&#8221;</a> for a thorough discussion.
The meaning of the attributes is the same as for the <span class="emphasis"><em>JDBC Inbound Channel Adapter</em></span>.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="stored-procedure-outbound-channel-adapter" href="#stored-procedure-outbound-channel-adapter"></a>18.5.7&nbsp;Stored Procedure Outbound Channel Adapter</h3></div></div></div>

<pre class="programlisting"><span class="hl-tag">&lt;int-jdbc:stored-proc-outbound-channel-adapter</span> <span class="hl-attribute">channel</span>=<span class="hl-value">""</span>                        <a name="CO26-1" href="#CO26-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
                                               stored-procedure-name=""
                                               data-source=""
                                               auto-startup="true"
                                               id=""
                                               ignore-column-meta-data="false"
                                               order=""                          <a name="CO26-2" href="#CO26-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
                                               sql-parameter-source-factory=""
                                               use-payload-as-parameter-source=""&gt;
    <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">""</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int-jdbc:sql-parameter-definition</span> <span class="hl-attribute">name</span>=<span class="hl-value">""</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int-jdbc:parameter</span> <span class="hl-attribute">name</span>=<span class="hl-value">""</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;/int-jdbc:stored-proc-outbound-channel-adapter&gt;</span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO26-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The receiving Message Channel of this endpoint.
<span class="emphasis"><em>Required</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO26-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Specifies the order for invocation when this endpoint is connected as a subscriber to a channel.
This is particularly relevant when that channel is using a <span class="emphasis"><em>failover</em></span> dispatching strategy.
It has no effect when this endpoint itself is a Polling Consumer for a channel with a queue.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="stored-procedure-outbound-gateway" href="#stored-procedure-outbound-gateway"></a>18.5.8&nbsp;Stored Procedure Outbound Gateway</h3></div></div></div>

<pre class="programlisting"><span class="hl-tag">&lt;int-jdbc:stored-proc-outbound-gateway</span> <span class="hl-attribute">request-channel</span>=<span class="hl-value">""</span>                        <a name="CO27-1" href="#CO27-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
                                       stored-procedure-name=""
                                       data-source=""
                                   auto-startup="true"
                                   id=""
                                   ignore-column-meta-data="false"
                                   is-function="false"
                                   order=""
                                   reply-channel=""                              <a name="CO27-2" href="#CO27-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
                                   reply-timeout=""                              <a name="CO27-3" href="#CO27-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
                                   return-value-required="false"                 <a name="CO27-4" href="#CO27-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
                                   skip-undeclared-results=""                    <a name="CO27-5" href="#CO27-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
                                   sql-parameter-source-factory=""
                                   use-payload-as-parameter-source=""&gt;
<span class="hl-tag">&lt;int-jdbc:sql-parameter-definition</span> <span class="hl-attribute">name</span>=<span class="hl-value">""</span> <span class="hl-attribute">direction</span>=<span class="hl-value">"IN"</span>
                                   <span class="hl-attribute">type</span>=<span class="hl-value">""</span>
                                   <span class="hl-attribute">scale</span>=<span class="hl-value">"10"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;int-jdbc:sql-parameter-definition</span> <span class="hl-attribute">name</span>=<span class="hl-value">""</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;int-jdbc:parameter</span> <span class="hl-attribute">name</span>=<span class="hl-value">""</span> <span class="hl-attribute">type</span>=<span class="hl-value">""</span> <span class="hl-attribute">value</span>=<span class="hl-value">""</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;int-jdbc:parameter</span> <span class="hl-attribute">name</span>=<span class="hl-value">""</span> <span class="hl-attribute">expression</span>=<span class="hl-value">""</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;int-jdbc:returning-resultset</span> <span class="hl-attribute">name</span>=<span class="hl-value">""</span> <span class="hl-attribute">row-mapper</span>=<span class="hl-value">""</span><span class="hl-tag"> /&gt;</span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO27-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The receiving Message Channel of this endpoint.
<span class="emphasis"><em>Required</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO27-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Message Channel to which replies should be sent, after receiving the database response. <span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO27-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Allows you to specify how long this gateway will wait for the reply message to be sent successfully before throwing an exception.
Keep in mind that when sending to a <code class="literal">DirectChannel</code>, the invocation will occur in the sender&#8217;s thread so the failing of the send operation may be caused by other components further downstream.
By default the Gateway will wait indefinitely.
The value is specified in milliseconds. <span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO27-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Indicates whether this procedure&#8217;s return value should be included. <span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO27-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>If the <code class="literal">skip-undeclared-results</code> attribute is set to <code class="literal">true</code>, then all results from a stored procedure call that don&#8217;t have a corresponding <code class="literal">SqlOutParameter</code> declaration will be bypassed.
E.g. Stored Procedures may return an update count value, even though your Stored Procedure only declared a single result parameter.
The exact behavior depends on the used database.
The value is set on the underlying <code class="literal">JdbcTemplate</code>.
Few developers will probably ever want to process update counts, thus the value defaults to <code class="literal">true</code>.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="sp-examples" href="#sp-examples"></a>18.5.9&nbsp;Examples</h3></div></div></div>

<p>In the following two examples we call <a class="ulink" href="https://db.apache.org/derby/" target="_top">Apache Derby</a> Stored Procedures.
The first procedure will call a Stored Procedure that returns a <code class="literal">ResultSet</code>, and using a <code class="literal">RowMapper</code> the data is converted into a domain object, which then becomes the Spring Integration message payload.</p>
<p>In the second sample we call a Stored Procedure that uses Output Parameters instead, in order to return data.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Please have a look at the <span class="emphasis"><em>Spring Integration Samples</em></span> project, located at null</p>
<p>The project contains the Apache Derby example referenced here, as well as instruction on how to run it.
The <span class="emphasis"><em>Spring Integration Samples</em></span> project also provides an <a class="ulink" href="https://github.com/spring-projects/spring-integration-samples/tree/master/intermediate/stored-procedures-oracle" target="_top">example</a> using Oracle Stored Procedures.</p>
</td></tr></table></div>
<p>In the first example, we call a Stored Procedure named <span class="emphasis"><em>FIND_ALL_COFFEE_BEVERAGES</em></span> that does not define any input parameters but which returns a <code class="literal">ResultSet</code>.</p>
<p>In Apache Derby, Stored Procedures are implemented using Java.
Here is the method signature followed by the corresponding Sql:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> findAllCoffeeBeverages(ResultSet[] coffeeBeverages)
            <span class="hl-keyword">throws</span> SQLException {
    ...
}</pre>
<pre class="programlisting">CREATE PROCEDURE FIND_ALL_COFFEE_BEVERAGES() \
PARAMETER STYLE JAVA LANGUAGE JAVA MODIFIES SQL DATA DYNAMIC RESULT SETS 1 \
EXTERNAL NAME 'org.springframework.integration.jdbc.storedproc.derby.DerbyStoredProcedures.findAllCoffeeBeverages';</pre>
<p>In Spring Integration, you can now call this Stored Procedure using e.g.
a <code class="literal">stored-proc-outbound-gateway</code></p>
<pre class="programlisting"><span class="hl-tag">&lt;int-jdbc:stored-proc-outbound-gateway</span> <span class="hl-attribute">id</span>=<span class="hl-value">"outbound-gateway-storedproc-find-all"</span>
                                       <span class="hl-attribute">data-source</span>=<span class="hl-value">"dataSource"</span>
                                       <span class="hl-attribute">request-channel</span>=<span class="hl-value">"findAllProcedureRequestChannel"</span>
                                       <span class="hl-attribute">expect-single-result</span>=<span class="hl-value">"true"</span>
                                       <span class="hl-attribute">stored-procedure-name</span>=<span class="hl-value">"FIND_ALL_COFFEE_BEVERAGES"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;int-jdbc:returning-resultset</span> <span class="hl-attribute">name</span>=<span class="hl-value">"coffeeBeverages"</span>
    <span class="hl-attribute">row-mapper</span>=<span class="hl-value">"org.springframework.integration.support.CoffeBeverageMapper"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-jdbc:stored-proc-outbound-gateway&gt;</span></pre>
<p>In the second example, we call a Stored Procedure named <span class="emphasis"><em>FIND_COFFEE</em></span> that has one input parameter.
Instead of returning a ResultSet, an output parameter is used:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> findCoffee(<span class="hl-keyword">int</span> coffeeId, String[] coffeeDescription)
            <span class="hl-keyword">throws</span> SQLException {
    ...
}</pre>
<pre class="programlisting"><span class="hl-keyword">CREATE</span> <span class="hl-keyword">PROCEDURE</span> FIND_COFFEE(<span class="hl-keyword">IN</span> ID <span class="hl-keyword">INTEGER</span>, <span class="hl-keyword">OUT</span> COFFEE_DESCRIPTION <span class="hl-keyword">VARCHAR</span>(<span class="hl-number">200</span>)) \
<span class="hl-keyword">PARAMETER</span> <span class="hl-keyword">STYLE</span> JAVA <span class="hl-keyword">LANGUAGE</span> JAVA <span class="hl-keyword">EXTERNAL</span> <span class="hl-keyword">NAME</span> \
<span class="hl-string">'org.springframework.integration.jdbc.storedproc.derby.DerbyStoredProcedures.findCoffee'</span>;</pre>
<p>In Spring Integration, you can now call this Stored Procedure using e.g.
a <code class="literal">stored-proc-outbound-gateway</code></p>
<pre class="programlisting"><span class="hl-tag">&lt;int-jdbc:stored-proc-outbound-gateway</span> <span class="hl-attribute">id</span>=<span class="hl-value">"outbound-gateway-storedproc-find-coffee"</span>
                                       <span class="hl-attribute">data-source</span>=<span class="hl-value">"dataSource"</span>
                                       <span class="hl-attribute">request-channel</span>=<span class="hl-value">"findCoffeeProcedureRequestChannel"</span>
                                       <span class="hl-attribute">skip-undeclared-results</span>=<span class="hl-value">"true"</span>
                                       <span class="hl-attribute">stored-procedure-name</span>=<span class="hl-value">"FIND_COFFEE"</span>
                                       <span class="hl-attribute">expect-single-result</span>=<span class="hl-value">"true"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int-jdbc:parameter</span> <span class="hl-attribute">name</span>=<span class="hl-value">"ID"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"payload"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/int-jdbc:stored-proc-outbound-gateway&gt;</span></pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jdbc-lock-registry" href="#jdbc-lock-registry"></a>18.6&nbsp;JDBC Lock Registry</h2></div></div></div>

<p>Starting with <span class="emphasis"><em>version 4.3</em></span>, the <code class="literal">JdbcLockRegistry</code> is available.
Certain components (for example aggregator and resequencer) use a lock obtained from a <code class="literal">LockRegistry</code> instance to ensure that only one thread is manipulating a group at a time.
The <code class="literal">DefaultLockRegistry</code> performs this function within a single component; you can now configure an external lock registry on these components.
When used with a shared <code class="literal">MessageGroupStore</code>, the <code class="literal">JdbcLockRegistry</code> can be use to provide this functionality across multiple application instances, such that only one instance can manipulate the group at a time.</p>
<p>When a lock is released by a local thread, another local thread will generally be able to acquire the lock immediately.
If a lock is released by a thread using a different registry instance, it can take up to 100ms to acquire the lock.</p>
<p>The <code class="literal">JdbcLockRegistry</code> is based on the <code class="literal">LockRepository</code> abstraction, where a <code class="literal">DefaultLockRepository</code> implementation is present.
The data base schema scripts are located in the <code class="literal">org.springframework.integration.jdbc</code> package divided to the particular RDBMS vendors.
For example the H2 DDL for lock table looks like:</p>
<pre class="programlisting"><span class="hl-keyword">CREATE</span> <span class="hl-keyword">TABLE</span> INT_LOCK  (
    LOCK_KEY <span class="hl-keyword">CHAR</span>(<span class="hl-number">36</span>),
    REGION <span class="hl-keyword">VARCHAR</span>(<span class="hl-number">100</span>),
    CLIENT_ID <span class="hl-keyword">CHAR</span>(<span class="hl-number">36</span>),
    CREATED_DATE <span class="hl-keyword">TIMESTAMP</span> <span class="hl-keyword">NOT</span> <span class="hl-keyword">NULL</span>,
    <span class="hl-keyword">constraint</span> LOCK_PK <span class="hl-keyword">primary</span> <span class="hl-keyword">key</span> (LOCK_KEY, REGION)
);</pre>
<p>The <code class="literal">INT_</code> can be changed according to the target data base design requirements.
Therefore <code class="literal">prefix</code> property must be used on the <code class="literal">DefaultLockRepository</code> bean definition.</p>
<p>Sometimes it happens that one application has moved to the state when it can&#8217;t release distributed lock - remove the particular record in the data base.
For this purpose such dead locks can be expired by the other application on the next locking invocation.
The <code class="literal">timeToLive</code> (TTL) option on the <code class="literal">DefaultLockRepository</code> is provided for this purpose.
The user may also want to specify <code class="literal">CLIENT_ID</code> for the locks stored for a given <code class="literal">DefaultLockRepository</code> instance.
In this case you can specify the <code class="literal">id</code> to be associated with the <code class="literal">DefaultLockRepository</code> as a constructor parameter.</p>
</div>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="jpa" href="#jpa"></a>19.&nbsp;JPA Support</h2></div></div></div>

<p>Spring Integration&#8217;s JPA (Java Persistence API) module provides components for performing various database operations using JPA.
The following components are provided:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="emphasis"><em><a class="link" href="#jpa-inbound-channel-adapter" title="19.4&nbsp;Inbound Channel Adapter">Inbound Channel Adapter</a></em></span>
</li><li class="listitem">
<span class="emphasis"><em><a class="link" href="#jpa-outbound-channel-adapter" title="19.5&nbsp;Outbound Channel Adapter">Outbound Channel Adapter</a></em></span>
</li><li class="listitem">
<span class="emphasis"><em><a class="link" href="#jpa-updating-outbound-gateway" title="19.6.2&nbsp;Updating Outbound Gateway">Updating Outbound Gateway</a></em></span>
</li><li class="listitem">
<span class="emphasis"><em><a class="link" href="#jpa-retrieving-outbound-gateway" title="19.6.3&nbsp;Retrieving Outbound Gateway">Retrieving Outbound Gateway</a></em></span>
</li></ul></div>
<p>These components can be used to perform <span class="emphasis"><em>select</em></span>, <span class="emphasis"><em>create</em></span>, <span class="emphasis"><em>update</em></span> and <span class="emphasis"><em>delete</em></span> operations on the targeted databases by sending/receiving messages to them.</p>
<p>The JPA <span class="emphasis"><em>Inbound Channel Adapter</em></span> lets you poll and retrieve (select) data from the database using JPA whereas the JPA_Outbound Channel Adapter_ lets you create, update and delete entities.</p>
<p>Outbound Gateways for JPA can be used to persist entities to the database, yet allowing you to continue with the flow and execute further components downstream.
Similarly, you can use an Outbound Gateway to retrieve entities from the database.</p>
<p>For example, you may use the Outbound Gateway, which receives a Message with a user Id as payload on its request channel, to query the database and retrieve the User entity and pass it downstream for further processing.</p>
<p>Recognizing these semantic differences, Spring Integration provides 2 separate JPA Outbound Gateways:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="emphasis"><em>Retrieving Outbound Gateway</em></span>
</li><li class="listitem">
<span class="emphasis"><em>Updating Outbound Gateway</em></span>
</li></ul></div>
<p><span class="emphasis"><em>Functionality</em></span></p>
<p>All JPA components perform their respective JPA operations by using either one of the following:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="emphasis"><em>Entity classes</em></span>
</li><li class="listitem">
<span class="emphasis"><em>Java Persistence Query Language (JPQL) for update, select and delete (inserts are not supported by JPQL)</em></span>
</li><li class="listitem">
<span class="emphasis"><em>Native Query</em></span>
</li><li class="listitem">
<span class="emphasis"><em>Named Query</em></span>
</li></ul></div>
<p>In the following sections we will describe each of these components in more detail.</p>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jpa-supported-persistence-providers" href="#jpa-supported-persistence-providers"></a>19.1&nbsp;Supported Persistence Providers</h2></div></div></div>

<p>The Spring Integration JPA support has been tested using the following persistence providers:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="emphasis"><em>Hibernate</em></span>
</li><li class="listitem">
<span class="emphasis"><em>OpenJPA</em></span>
</li><li class="listitem">
<span class="emphasis"><em>EclipseLink</em></span>
</li></ul></div>
<p>When using a persistence provider, please ensure that the provider is compatible with JPA 2.0.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jpa-java-implementation" href="#jpa-java-implementation"></a>19.2&nbsp;Java Implementation</h2></div></div></div>

<p>Each of the provided components will use the <code class="literal">o.s.i.jpa.core.JpaExecutor</code> class which in turn will use an implementation of the <code class="literal">o.s.i.jpa.core.JpaOperations</code> interface.
<code class="literal">JpaOperations</code> operates like a typical Data Access Object (DAO) and provides methods such as <span class="emphasis"><em>find</em></span>, <span class="emphasis"><em>persist</em></span>, <span class="emphasis"><em>executeUpdate</em></span> etc.
For most use cases the provided default implementation <code class="literal">o.s.i.jpa.core.DefaultJpaOperations</code> should be sufficient.
Nevertheless, you have the option to optionally specify your own implementation in case you require custom behavior.</p>
<p>For initializing a <code class="literal">JpaExecutor</code> you have to use one of 3 available constructors that accept one of:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="emphasis"><em>EntityManagerFactory</em></span>
</li><li class="listitem">
<span class="emphasis"><em>EntityManager</em></span> or
</li><li class="listitem">
<span class="emphasis"><em>JpaOperations</em></span>
</li></ul></div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The XML Namespace Support described further below is also very flexible and provides configuration attributes for each JPA component to pass in an <span class="emphasis"><em>EntityManagerFactory</em></span>, <span class="emphasis"><em>EntityManager</em></span> or <span class="emphasis"><em>JpaOperations</em></span> reference.</p>
</td></tr></table></div>
<p><span class="emphasis"><em>Java Configuration Example</em></span></p>
<p>The following example of a JPA <span class="emphasis"><em>Retrieving Outbound Gateway</em></span> is configured purely through Java.
In typical usage scenarios you will most likely prefer the XML Namespace Support described further below.
However, the example illustrates how the classes are wired up.
Understanding the inner workings can also be very helpful for debugging or customizing the individual JPA components.</p>
<p>First, we instantiate a <code class="literal">JpaExecutor</code> using an <code class="literal">EntityManager</code> as constructor argument.
The <code class="literal">JpaExecutor</code> is then in return used as constructor argument for the <code class="literal">o.s.i.jpa.outbound.JpaOutboundGateway</code> and the <code class="literal">JpaOutboundGateway</code> will be passed as constructor argument into the <code class="literal">EventDrivenConsumer</code>.</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"jpaExecutor"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.jpa.core.JpaExecutor"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">name</span>=<span class="hl-value">"entityManager"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"entityManager"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"entityClass"</span>        <span class="hl-attribute">value</span>=<span class="hl-value">"o.s.i.jpa.test.entity.StudentDomain"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"jpaQuery"</span>           <span class="hl-attribute">value</span>=<span class="hl-value">"select s from Student s where s.id = :id"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"expectSingleResult"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"jpaParameters"</span><span class="hl-tag"> &gt;</span>
        <span class="hl-tag">&lt;util:list&gt;</span>
            <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.jpa.support.JpaParameter"</span><span class="hl-tag">&gt;</span>
                <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"name"</span>       <span class="hl-attribute">value</span>=<span class="hl-value">"id"</span><span class="hl-tag">/&gt;</span>
                <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"expression"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"payload"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;/bean&gt;</span>
        <span class="hl-tag">&lt;/util:list&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"jpaOutboundGateway"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.jpa.outbound.JpaOutboundGateway"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"jpaExecutor"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span>        <span class="hl-attribute">name</span>=<span class="hl-value">"gatewayType"</span>   <span class="hl-attribute">value</span>=<span class="hl-value">"RETRIEVING"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span>        <span class="hl-attribute">name</span>=<span class="hl-value">"outputChannel"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"studentReplyChannel"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"getStudentEndpoint"</span>
      <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.endpoint.EventDrivenConsumer"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">name</span>=<span class="hl-value">"inputChannel"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"getStudentChannel"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">name</span>=<span class="hl-value">"handler"</span>      <span class="hl-attribute">ref</span>=<span class="hl-value">"jpaOutboundGateway"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>For more examples of constructing JPA components purely through Java, see the JUnit test-cases for the JPA Adapters.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jpa-namespace-support" href="#jpa-namespace-support"></a>19.3&nbsp;Namespace Support</h2></div></div></div>

<p>When using XML namespace support, the underlying parser classes will instantiate the relevant Java classes for you.
Thus, you typically don&#8217;t have to deal with the inner workings of the JPA adapter.
This section will document the XML Namespace Support provided by the Spring Integration and will show you how to use the XML Namespace Support to configure the Jpa components.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jpa-namespace-support-common-attributes" href="#jpa-namespace-support-common-attributes"></a>19.3.1&nbsp;Common XML Namespace Configuration Attributes</h3></div></div></div>

<p>Certain configuration parameters are shared amongst all JPA components and are described below:</p>
<p><span class="strong"><strong>auto-startup</strong></span></p>
<p>Lifecycle attribute signaling if this component should be started during Application Context startup.
Defaults to <code class="literal">true</code>.
<span class="emphasis"><em>Optional</em></span>.</p>
<p><span class="strong"><strong>id</strong></span></p>
<p>Identifies the underlying Spring bean definition, which is an instance of either <code class="literal">EventDrivenConsumer</code> or <code class="literal">PollingConsumer</code>.
<span class="emphasis"><em>Optional</em></span>.</p>
<p><span class="strong"><strong>entity-manager-factory</strong></span></p>
<p>The reference to the JPA Entity Manager Factory that will be used by the adapter to create the <code class="literal">EntityManager</code>.
Either this attribute or the <span class="emphasis"><em>entity-manager</em></span> attribute or the <span class="emphasis"><em>jpa-operations</em></span> attribute must be provided.</p>
<p><span class="strong"><strong>entity-manager</strong></span></p>
<p>The reference to the JPA Entity Manager that will be used by the component.
Either this attribute or the <span class="emphasis"><em>enity-manager-factory</em></span> attribute or the <span class="emphasis"><em>jpa-operations</em></span> attribute must be provided.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Usually your Spring Application Context only defines a JPA Entity Manager Factory and the EntityManager is injected using the @PersistenceContext annotation.
This, however, is not applicable for the Spring Integration JPA components.
Usually, injecting the JPA Entity Manager Factory will be best but in case you want to inject an EntityManager explicitly, you have to define a <code class="literal">SharedEntityManagerBean</code>.
For more information, please see the relevanthttp://static.springsource.org/spring/docs/current/javadoc-api/org/springframework/orm/jpa/support/SharedEntityManagerBean.html[JavaDoc].</p>
</td></tr></table></div>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"entityManager"</span>
      <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.orm.jpa.support.SharedEntityManagerBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"entityManagerFactory"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"entityManagerFactoryBean"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
<p><span class="strong"><strong>jpa-operations</strong></span></p>
<p>Reference to a bean implementing the <code class="literal">JpaOperations</code> interface.
In rare cases it might be advisable to provide your own implementation of the <code class="literal">JpaOperations</code> interface, instead of relying on the default implementation <code class="literal">org.springframework.integration.jpa.core.DefaultJpaOperations</code>.
As <code class="literal">JpaOperations</code> wraps the necessary datasource; the JPA Entity Manager or JPA Entity Manager Factory must not be provided, if the <span class="emphasis"><em>jpa-operations</em></span> attribute is used.</p>
<p><span class="strong"><strong>entity-class</strong></span></p>
<p>The fully qualified name of the entity class.
The exact semantics of this attribute vary, depending on whether we are performing a persist/update operation or whether we are retrieving objects from the database.</p>
<p>When retrieving data, you can specify the <span class="emphasis"><em>entity-class</em></span> attribute to indicate that you would like to retrieve objects of this type from the database.
In that case you must not define any of the query attributes ( <span class="emphasis"><em>jpa-query</em></span>, <span class="emphasis"><em>native-query</em></span> or <span class="emphasis"><em>named-query</em></span> )</p>
<p>When persisting data, the <span class="emphasis"><em>entity-class</em></span> attribute will indicate the type of object to persist.
If not specified (for persist operations) the entity class will be automatically retrieved from the Message&#8217;s payload.</p>
<p><span class="strong"><strong>jpa-query</strong></span></p>
<p>Defines the JPA query (Java Persistence Query Language) to be used.</p>
<p><span class="strong"><strong>native-query</strong></span></p>
<p>Defines the native SQL query to be used.</p>
<p><span class="strong"><strong>named-query</strong></span></p>
<p>This attribute refers to a named query.
A named query can either be defined in Native SQL or JPAQL but the underlying JPA persistence provider handles that distinction internally.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jpa-parameters" href="#jpa-parameters"></a>19.3.2&nbsp;Providing JPA Query Parameters</h3></div></div></div>

<p>For providing parameters, the <span class="emphasis"><em>parameter</em></span> XML sub-element can be used.
It provides a mechanism to provide parameters for the queries that are either based on the Java Persistence Query Language (JPQL) or native SQL queries.
Parameters can also be provided for Named Queries.</p>
<p><span class="emphasis"><em>Expression based Parameters</em></span></p>
<pre class="programlisting"><span class="hl-tag">&lt;int-jpa:parameter</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"payload.name"</span> <span class="hl-attribute">name</span>=<span class="hl-value">"firstName"</span><span class="hl-tag">/&gt;</span></pre>
<p><span class="emphasis"><em>Value based Parameters</em></span></p>
<pre class="programlisting"><span class="hl-tag">&lt;int-jpa:parameter</span> <span class="hl-attribute">name</span>=<span class="hl-value">"name"</span> <span class="hl-attribute">type</span>=<span class="hl-value">"java.lang.String"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"myName"</span><span class="hl-tag">/&gt;</span></pre>
<p><span class="emphasis"><em>Positional Parameters</em></span></p>
<pre class="programlisting"><span class="hl-tag">&lt;int-jpa:parameter</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"payload.name"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;int-jpa:parameter</span> <span class="hl-attribute">type</span>=<span class="hl-value">"java.lang.Integer"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"21"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jpa-transactions" href="#jpa-transactions"></a>19.3.3&nbsp;Transaction Handling</h3></div></div></div>

<p>All JPA operations like Insert, Update and Delete require a transaction to be active whenever they are performed.
For Inbound Channel Adapters there is nothing special to be done, it is similar to the way we configure transaction managers with pollers used with other inbound channel adapters.The xml snippet below shows a sample where a transaction manager is configured with the poller used with an <span class="emphasis"><em>Inbound Channel Adapter</em></span>.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-jpa:inbound-channel-adapter</span>
    <span class="hl-attribute">channel</span>=<span class="hl-value">"inboundChannelAdapterOne"</span>
    <span class="hl-attribute">entity-manager</span>=<span class="hl-value">"em"</span>
    <span class="hl-attribute">auto-startup</span>=<span class="hl-value">"true"</span>
    <span class="hl-attribute">jpa-query</span>=<span class="hl-value">"select s from Student s"</span>
    <span class="hl-attribute">expect-single-result</span>=<span class="hl-value">"true"</span>
    <span class="hl-attribute">delete-after-poll</span>=<span class="hl-value">"true"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"2000"</span><span class="hl-tag"> &gt;</span>
        <span class="hl-tag">&lt;int:transactional</span> <span class="hl-attribute">propagation</span>=<span class="hl-value">"REQUIRED"</span>
            <span class="hl-attribute">transaction-manager</span>=<span class="hl-value">"transactionManager"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/int:poller&gt;</span>
<span class="hl-tag">&lt;/int-jpa:inbound-channel-adapter&gt;</span></pre>
<p>However, it may be necessary to specifically start a transaction when using an <span class="emphasis"><em>Outbound Channel Adapter</em></span>/<span class="emphasis"><em>Gateway</em></span>.
If a <span class="emphasis"><em>DirectChannel</em></span> is an input channel for the outbound adapter/gateway, and if transaction is active in the current thread of execution, the JPA operation will be performed in the same transaction context.
We can also configure to execute this JPA operation in a new transaction as below.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-jpa:outbound-gateway</span>
    <span class="hl-attribute">request-channel</span>=<span class="hl-value">"namedQueryRequestChannel"</span>
    <span class="hl-attribute">reply-channel</span>=<span class="hl-value">"namedQueryResponseChannel"</span>
    <span class="hl-attribute">named-query</span>=<span class="hl-value">"updateStudentByRollNumber"</span>
    <span class="hl-attribute">entity-manager</span>=<span class="hl-value">"em"</span>
    <span class="hl-attribute">gateway-type</span>=<span class="hl-value">"UPDATING"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int-jpa:parameter</span> <span class="hl-attribute">name</span>=<span class="hl-value">"lastName"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"payload"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int-jpa:parameter</span> <span class="hl-attribute">name</span>=<span class="hl-value">"rollNumber"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"headers['rollNumber']"</span><span class="hl-tag">/&gt;</span>
		<span class="hl-tag">&lt;int-jpa:transactional</span> <span class="hl-attribute">propagation</span>=<span class="hl-value">"REQUIRES_NEW"</span>
        <span class="hl-attribute">transaction-manager</span>=<span class="hl-value">"transactionManager"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-jpa:outbound-gateway&gt;</span></pre>
<p>As we can see above, the <span class="emphasis"><em>transactional</em></span> sub element of the outbound gateway/adapter will be used to specify the transaction attributes.
It is optional to define this child element if you have <span class="emphasis"><em>DirectChannel</em></span> as an input channel to the adapter and you want the adapter to execute the operations in the same transaction context as the caller.
If, however, you are using an <span class="emphasis"><em>ExecutorChannel</em></span>, it is required to have the <span class="emphasis"><em>transactional</em></span> sub element as the invoking client&#8217;s transaction context is not propagated.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Unlike the <span class="emphasis"><em>transactional</em></span> sub element of the poller which is defined in the spring integration&#8217;s namespace, the <span class="emphasis"><em>transactional</em></span> sub element for the outbound gateway/adapter is defined in the jpa namespace.</p>
</td></tr></table></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jpa-inbound-channel-adapter" href="#jpa-inbound-channel-adapter"></a>19.4&nbsp;Inbound Channel Adapter</h2></div></div></div>

<p>An <span class="emphasis"><em>Inbound Channel Adapter</em></span> is used to execute a <span class="emphasis"><em>select</em></span> query over the database using JPA QL and return the result.
The message payload will be either a single entity or a <code class="literal">List</code> of entities.
Below is a sample xml snippet that shows a sample usage of <span class="emphasis"><em>inbound-channel-adapter</em></span>.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-jpa:inbound-channel-adapter</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"inboundChannelAdapterOne"</span>  <a name="CO28-1" href="#CO28-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
                    entity-manager="em"  <a name="CO28-2" href="#CO28-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
                    auto-startup="true"  <a name="CO28-3" href="#CO28-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
                    query="select s from Student s"  <a name="CO28-4" href="#CO28-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
                    expect-single-result="true"  <a name="CO28-5" href="#CO28-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
                    max-results=""  <a name="CO28-6" href="#CO28-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>
                    max-results-expression=""  <a name="CO28-7" href="#CO28-7"></a><span><img src="images/callouts/7.png" alt="7" border="0"></span>
                    delete-after-poll="true"  <a name="CO28-8" href="#CO28-8"></a><span><img src="images/callouts/8.png" alt="8" border="0"></span>
                    flush-after-delete="true"&gt;  <a name="CO28-9" href="#CO28-9"></a><span><img src="images/callouts/9.png" alt="9" border="0"></span>
    <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"2000"</span><span class="hl-tag"> &gt;</span>
      <span class="hl-tag">&lt;int:transactional</span> <span class="hl-attribute">propagation</span>=<span class="hl-value">"REQUIRED"</span> <span class="hl-attribute">transaction-manager</span>=<span class="hl-value">"transactionManager"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/int:poller&gt;</span>
<span class="hl-tag">&lt;/int-jpa:inbound-channel-adapter&gt;</span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO28-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The channel over which the <span class="emphasis"><em>inbound-channel-adapter</em></span> will put the messages with the payload received after executing the provided JPA QL in the <span class="emphasis"><em>query</em></span> attribute.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO28-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The <code class="literal">EntityManager</code> instance that will be used to perform the required JPA operations.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO28-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Attribute signalling if the component should be automatically started on startup of the Application Context.
The value defaults to <code class="literal">true</code></p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO28-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The JPA QL that needs to be executed and whose result needs to be sent out as the payload of the message</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO28-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The attribute that tells if the executed JPQL query gives a single entity in the result or a <code class="literal">List</code> of entities.
If the value is set to <code class="literal">true</code>, the single entity retrieved is sent as the payload of the message.
If, however, multiple results are returned after setting this to <code class="literal">true</code>, a <code class="literal">MessagingException</code> is thrown.
The value defaults to <code class="literal">false</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO28-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>This non zero, non negative integer value tells the adapter not to select more than given number of rows on execution of the select operation.
By default, if this attribute is not set, all the possible records are selected by given query.
This attribute is mutually exclusive with <code class="literal">max-results-expression</code>.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO28-7"><span><img src="images/callouts/7.png" alt="7" border="0"></span></a> </p></td><td valign="top" align="left">
<p>An expression, mutually exclusive with <code class="literal">max-results</code>, that can be used to provide an expression that will be evaluated to find the maximum number of results in a result set.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO28-8"><span><img src="images/callouts/8.png" alt="8" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Set this value to <code class="literal">true</code> if you want to delete the rows received after execution of the query.
Please ensure that the component is operating as part of a transaction.
Otherwise, you may encounter an Exception such as: <span class="emphasis"><em>java.lang.IllegalArgumentException: Removing
                         a detached instance &#8230;&#8203;</em></span></p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO28-9"><span><img src="images/callouts/9.png" alt="9" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Set this value to <code class="literal">true</code> if you want to the persistence context immediately after deleting received entities and if you don&#8217;t want rely on the <code class="literal">EntityManager</code>'s flushMode.
The default value is set to <code class="literal">false</code>.</p>
</td></tr></table></div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jpaInboundChannelAdapterParameters" href="#jpaInboundChannelAdapterParameters"></a>19.4.1&nbsp;Configuration Parameter Reference</h3></div></div></div>

<pre class="programlisting"><span class="hl-tag">&lt;int-jpa:inbound-channel-adapter</span>
  <span class="hl-attribute">auto-startup</span>=<span class="hl-value">"true"</span>  <a name="CO29-1" href="#CO29-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
  channel=""  <a name="CO29-2" href="#CO29-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
  delete-after-poll="false"   <a name="CO29-3" href="#CO29-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
  delete-per-row="false"   <a name="CO29-4" href="#CO29-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
  entity-class=""   <a name="CO29-5" href="#CO29-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
  entity-manager=""  <a name="CO29-6" href="#CO29-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>
  entity-manager-factory=""  <a name="CO29-7" href="#CO29-7"></a><span><img src="images/callouts/7.png" alt="7" border="0"></span>
  expect-single-result="false"  <a name="CO29-8" href="#CO29-8"></a><span><img src="images/callouts/8.png" alt="8" border="0"></span>
  id=""
  jpa-operations=""  <a name="CO29-9" href="#CO29-9"></a><span><img src="images/callouts/9.png" alt="9" border="0"></span>
  jpa-query=""  <a name="CO29-10" href="#CO29-10"></a><span><img src="images/callouts/10.png" alt="10" border="0"></span>
  named-query=""  <a name="CO29-11" href="#CO29-11"></a><span><img src="images/callouts/11.png" alt="11" border="0"></span>
  native-query=""  <a name="CO29-12" href="#CO29-12"></a><span><img src="images/callouts/12.png" alt="12" border="0"></span>
  parameter-source=""  <a name="CO29-13" href="#CO29-13"></a><span><img src="images/callouts/13.png" alt="13" border="0"></span>
  send-timeout=""&gt;  <a name="CO29-14" href="#CO29-14"></a><span><img src="images/callouts/14.png" alt="14" border="0"></span>
  <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"myPoller"</span><span class="hl-tag">/&gt;</span>
 <span class="hl-tag">&lt;/int-jpa:inbound-channel-adapter&gt;</span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO29-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>This <span class="emphasis"><em>Lifecycle</em></span> attribute signaled if this component should be started during startup of the Application Context.
This attribute defaults to true.<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO29-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The channel to which the adapter will send a message with the payload that was received after performing the desired JPA operation.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO29-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A boolean flag that indicates whether the records selected are to be deleted after they are being polled by the adapter.
By default the value is <code class="literal">false</code>, that is, the records will not be deleted.
Please ensure that the component is operating as part of a transaction.
Otherwise, you may encounter an Exception such as: <span class="emphasis"><em>java.lang.IllegalArgumentException: Removing a detached instance &#8230;&#8203;</em></span>.<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO29-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A boolean flag that indicates whether the records can be deleted in bulk or are deleted one record at a time.
By default the value is <code class="literal">false</code>, that is, the records are bulk deleted.<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO29-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The fully qualified name of the entity class that would be queried from the database.
The adapter will automatically build a JPA Query to be executed based on the entity class name provided.<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO29-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>An instance of <code class="literal">javax.persistence.EntityManager</code> that will be used to perform the JPA operations.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO29-7"><span><img src="images/callouts/7.png" alt="7" border="0"></span></a> </p></td><td valign="top" align="left">
<p>An instance of <code class="literal">javax.persistence.EntityManagerFactory</code> that will be used to obtain an instance of <code class="literal">javax.persistence.EntityManager</code> that will perform the JPA operations.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO29-8"><span><img src="images/callouts/8.png" alt="8" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A boolean flag indicating whether the select operation is expected to return a single result or a <code class="literal">List</code> of results.
If this flag is set to <code class="literal">true</code>, the single entity selected is sent as the payload of the message.
If multiple entities are returned, an exception is thrown.
If <code class="literal">false</code>, the <code class="literal">List</code> of entities is being sent as the payload of the message.
By default the value is <code class="literal">false</code>.<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO29-9"><span><img src="images/callouts/9.png" alt="9" border="0"></span></a> </p></td><td valign="top" align="left">
<p>An implementation of <code class="literal">org.springframework.integration.jpa.core.JpaOperations</code> that would be used to perform the JPA operations.
It is recommended not to provide an implementation of your own but use the default <code class="literal">org.springframework.integration.jpa.core.DefaultJpaOperations</code> implementation.
Either of the <span class="emphasis"><em>entity-manager</em></span>, <span class="emphasis"><em>entity-manager-factory</em></span> or <span class="emphasis"><em>jpa-operations</em></span> attributes is to be used.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO29-10"><span><img src="images/callouts/10.png" alt="10" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The JPA QL that needs to be executed by this adapter.<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO29-11"><span><img src="images/callouts/11.png" alt="11" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The named query that needs to be executed by this adapter.<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO29-12"><span><img src="images/callouts/12.png" alt="12" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The native query that will be executed by this adapter.
Either of the <span class="emphasis"><em>jpa-query</em></span>, <span class="emphasis"><em>named-query</em></span>,<span class="emphasis"><em>entity-class</em></span> or <span class="emphasis"><em>native-query</em></span> attributes are to be used.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO29-13"><span><img src="images/callouts/13.png" alt="13" border="0"></span></a> </p></td><td valign="top" align="left">
<p>An implementation of <code class="literal">o.s.i.jpa.support.parametersource.ParameterSource</code> which will be used to resolve the values of the parameters provided in the query.
Ignored if <span class="emphasis"><em>entity-class</em></span> attribute is provided.<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO29-14"><span><img src="images/callouts/14.png" alt="14" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Maximum amount of time in milliseconds to wait when sending a message to the channel.<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr></table></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jpa-outbound-channel-adapter" href="#jpa-outbound-channel-adapter"></a>19.5&nbsp;Outbound Channel Adapter</h2></div></div></div>

<p>The JPA Outbound channel adapter allows you to accept messages over a request channel.
The payload can either be used as the entity to be persisted, or used along with the headers in parameter expressions for a defined JPQL query to be executed.
In the following sub sections we shall see what those possible ways of performing these operations are.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_using_an_entity_class" href="#_using_an_entity_class"></a>19.5.1&nbsp;Using an Entity Class</h3></div></div></div>

<p>The XML snippet below shows how we can use the Outbound Channel Adapter to persist an entity to the database.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-jpa:outbound-channel-adapter</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"entityTypeChannel"</span>  <a name="CO30-1" href="#CO30-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
    entity-class="org.springframework.integration.jpa.test.entity.Student"  <a name="CO30-2" href="#CO30-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
    persist-mode="PERSIST"  <a name="CO30-3" href="#CO30-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
    entity-manager="em"/ &gt; <a name="CO30-4" href="#CO30-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO30-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The channel over which a valid JPA entity will be sent to the JPA Outbound Channel Adapter.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO30-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The fully qualified name of the entity class that would be accepted by the adapter to be persisted in the database.
You can actually leave off this attribute in most cases as the adapter can determine the entity class automatically from the Spring Integration Message payload.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO30-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The operation that needs to be done by the adapter, valid values are <span class="emphasis"><em>PERSIST</em></span>, <span class="emphasis"><em>MERGE</em></span> and <span class="emphasis"><em>DELETE</em></span>.
The default value is <span class="emphasis"><em>MERGE</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO30-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The JPA entity manager to be used.</p>
</td></tr></table></div>
<p>As we can see above these 4 attributes of the <span class="emphasis"><em>outbound-channel-adapter</em></span> are all we need to configure it to accept entities over the input channel and process them to <span class="emphasis"><em>PERSIST</em></span>,<span class="emphasis"><em>MERGE</em></span> or <span class="emphasis"><em>DELETE</em></span> it from the underlying data source.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>As of <span class="emphasis"><em>Spring Integration 3.0</em></span>, payloads to <span class="emphasis"><em>persist</em></span> or <span class="emphasis"><em>merge</em></span> can also be of type <code class="literal">http://docs.oracle.com/javase/7/docs/api/java/lang/Iterable.html[java.lang.Iterable]</code>.
In that case, each object returned by the <code class="literal">Iterable</code> is treated as an entity and persisted or merged using the underlying <code class="literal">EntityManager</code>.
<span class="emphasis"><em>NULL</em></span> values returned by the iterator are ignored.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_using_jpa_query_language_jpa_ql" href="#_using_jpa_query_language_jpa_ql"></a>19.5.2&nbsp;Using JPA Query Language (JPA QL)</h3></div></div></div>

<p>We have seen in the above sub section how to perform a <span class="emphasis"><em>PERSIST</em></span> action using an entity We will now see how to use the outbound channel adapter which uses JPA QL (Java Persistence API Query Language)</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-jpa:outbound-channel-adapter</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"jpaQlChannel"</span>  <a name="CO31-1" href="#CO31-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
  jpa-query="update Student s set s.firstName = :firstName where s.rollNumber = :rollNumber"  <a name="CO31-2" href="#CO31-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
  entity-manager="em"&gt;  <a name="CO31-3" href="#CO31-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
    <span class="hl-tag">&lt;int-jpa:parameter</span> <span class="hl-attribute">name</span>=<span class="hl-value">"firstName"</span>  <span class="hl-attribute">expression</span>=<span class="hl-value">"payload['firstName']"</span><span class="hl-tag">/&gt;</span>  <a name="CO31-4" href="#CO31-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
    <span class="hl-tag">&lt;int-jpa:parameter</span> <span class="hl-attribute">name</span>=<span class="hl-value">"rollNumber"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"payload['rollNumber']"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-jpa:outbound-channel-adapter&gt;</span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO31-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The input channel over which the message is being sent to the outbound channel adapter</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO31-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The JPA QL that needs to be executed.This query may contain parameters that will be evaluated using the <span class="emphasis"><em>parameter</em></span> child tag.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO31-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The entity manager used by the adapter to perform the JPA operations</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO31-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>This sub element, one for each parameter will be used to evaluate the value of the parameter names specified in the JPA QL specified in the <span class="emphasis"><em>query</em></span> attribute</p>
</td></tr></table></div>
<p>The <span class="emphasis"><em>parameter</em></span> sub element accepts an attribute <span class="emphasis"><em>name</em></span> which corresponds to the named parameter specified in the provided JPA QL (point 2 in the above mentioned sample).
The value of the parameter can either be static or can be derived using an expression.
The static value and the expression to derive the value is specified using the <span class="emphasis"><em>value</em></span> and the <span class="emphasis"><em>expression</em></span> attributes respectively.
These attributes are mutually exclusive.</p>
<p>If the <span class="emphasis"><em>value</em></span> attribute is specified we can provide an optional <span class="emphasis"><em>type</em></span> attribute.
The value of this attribute is the fully qualified name of the class whose value is represented by the <span class="emphasis"><em>value</em></span> attribute.
By default the type is assumed to be a <code class="literal">java.lang.String</code>.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-jpa:outbound-channel-adapter</span> <span class="hl-attribute">...</span><span class="hl-tag">
&gt;</span>
    <span class="hl-tag">&lt;int-jpa:parameter</span> <span class="hl-attribute">name</span>=<span class="hl-value">"level"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"2"</span> <span class="hl-attribute">type</span>=<span class="hl-value">"java.lang.Integer"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int-jpa:parameter</span> <span class="hl-attribute">name</span>=<span class="hl-value">"name"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"payload['name']"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-jpa:outbound-channel-adapter&gt;</span></pre>
<p>As seen in the above snippet, it is perfectly valid to use multiple <span class="emphasis"><em>parameter</em></span> sub elements within an outbound channel adapter tag and derive some parameters using expressions and some with static value.
However, care should be taken not to specify the same parameter name multiple times, and, provide one <span class="emphasis"><em>parameter</em></span> sub element for each named parameter specified in the JPA query.
For example, we are specifying two parameters <span class="emphasis"><em>level</em></span> and <span class="emphasis"><em>name</em></span> where <span class="emphasis"><em>level</em></span> attribute is a static value of type <code class="literal">java.lang.Integer</code>, where as the <span class="emphasis"><em>name</em></span> attribute is derived from the payload of the message</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Though specifying <span class="emphasis"><em>select</em></span> is valid for JPA QL, it makes no sense as outbound channel adapters will not be returning any result.
If you want to select some values, consider using the outbound gateway instead.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_using_native_queries" href="#_using_native_queries"></a>19.5.3&nbsp;Using Native Queries</h3></div></div></div>

<p>In this section we will see how to use native queries to perform the operations using JPA outbound channel adapter.
Using native queries is similar to using JPA QL, except that the query specified here is a native database query.
By choosing native queries we lose the database vendor independence which we get using JPA QL.</p>
<p>One of the things we can achieve using native queries is to perform database inserts, which is not possible using JPA QL (To perform inserts we send JPA entities to the channel adapter as we have seen earlier).
Below is a small xml fragment that demonstrates the use of native query to insert values in a table.
Please note that we have only mentioned the important attributes below.
All other attributes like <span class="emphasis"><em>channel</em></span>, <span class="emphasis"><em>entity-manager</em></span> and the <span class="emphasis"><em>parameter</em></span> sub element has the same semantics as when we use JPA QL.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Please be aware that named parameters may not be supported by your JPA provider in conjunction with native SQL queries.
While they work fine using Hibernate, OpenJPA and EclipseLink do NOT support them: <a class="ulink" href="https://issues.apache.org/jira/browse/OPENJPA-111" target="_top">https://issues.apache.org/jira/browse/OPENJPA-111</a> Section 3.8.12 of the JPA 2.0 spec states: "Only positional parameter binding and positional access to result items may be portably used for native queries."</p>
</td></tr></table></div>
<pre class="programlisting"><span class="hl-tag">&lt;int-jpa:outbound-channel-adapter</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"nativeQlChannel"</span>
  <span class="hl-attribute">native-query</span>=<span class="hl-value">"insert into STUDENT_TABLE(FIRST_NAME,LAST_UPDATED) values (:lastName,:lastUpdated)"</span>  <a name="CO32-1" href="#CO32-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
  entity-manager="em"&gt;
    <span class="hl-tag">&lt;int-jpa:parameter</span> <span class="hl-attribute">name</span>=<span class="hl-value">"lastName"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"payload['updatedLastName']"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int-jpa:parameter</span> <span class="hl-attribute">name</span>=<span class="hl-value">"lastUpdated"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"new java.util.Date()"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-jpa:outbound-channel-adapter&gt;</span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO32-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The native query that will be executed by this outbound channel adapter</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_using_named_queries" href="#_using_named_queries"></a>19.5.4&nbsp;Using Named Queries</h3></div></div></div>

<p>We will now see how to use named queries after seeing using entity, JPA QL and native query in previous sub sections.
Using named query is also very similar to using JPA QL or a native query, except that we specify a named query instead of a query.
Before we go further and see the xml fragment for the declaration of the <span class="emphasis"><em>outbound-channel-adapter</em></span>, we will see how named JPA named queries are defined.</p>
<p>In our case, if we have an entity called <code class="literal">Student</code>, then we have the following in the class to define two named queries <span class="emphasis"><em>selectStudent</em></span> and <span class="emphasis"><em>updateStudent</em></span>.
Below is a way to define named queries using annotations</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Entity</span></em>
<em><span class="hl-annotation" style="color: gray">@Table(name="Student")</span></em>
<em><span class="hl-annotation" style="color: gray">@NamedQueries({
    @NamedQuery(name="selectStudent",
        query="select s from Student s where s.lastName = 'Last One'"),
    @NamedQuery(name="updateStudent",
        query="update Student s set s.lastName = :lastName,
               lastUpdated = :lastUpdated where s.id in (select max(a.id) from Student a)")
})</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> Student {

...</pre>
<p>You can alternatively use the <span class="emphasis"><em>orm.xml</em></span> to define named queries as seen below</p>
<pre class="programlisting"><span class="hl-tag">&lt;entity-mappings</span> <span class="hl-attribute">...&gt;</span>
    <span class="hl-attribute">...</span>
    <span class="hl-attribute">&lt;named-query</span> <span class="hl-attribute">name</span>=<span class="hl-value">"selectStudent"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;query&gt;</span>select s from Student s where s.lastName = 'Last One'<span class="hl-tag">&lt;/query&gt;</span>
    <span class="hl-tag">&lt;/named-query&gt;</span>
<span class="hl-tag">&lt;/entity-mappings&gt;</span></pre>
<p>Now that we have seen how we can define named queries using annotations or using <span class="emphasis"><em>orm.xml</em></span>, we will now see a small xml fragment for defining an <span class="emphasis"><em>outbound-channel-adapter</em></span> using named query</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-jpa:outbound-channel-adapter</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"namedQueryChannel"</span>
            <span class="hl-attribute">named-query</span>=<span class="hl-value">"updateStudent"</span>	 <a name="CO33-1" href="#CO33-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
            entity-manager="em"&gt;
        <span class="hl-tag">&lt;int-jpa:parameter</span> <span class="hl-attribute">name</span>=<span class="hl-value">"lastName"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"payload['updatedLastName']"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;int-jpa:parameter</span> <span class="hl-attribute">name</span>=<span class="hl-value">"lastUpdated"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"new java.util.Date()"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-jpa:outbound-channel-adapter&gt;</span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO33-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The named query that we want the adapter to execute when it receives a message over the channel</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jpaOutboundChannelAdapterParameters" href="#jpaOutboundChannelAdapterParameters"></a>19.5.5&nbsp;Configuration Parameter Reference</h3></div></div></div>

<pre class="programlisting"><span class="hl-tag">&lt;int-jpa:outbound-channel-adapter</span>
  <span class="hl-attribute">auto-startup</span>=<span class="hl-value">"true"</span>  <a name="CO34-1" href="#CO34-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
  channel=""  <a name="CO34-2" href="#CO34-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
  entity-class=""  <a name="CO34-3" href="#CO34-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
  entity-manager=""  <a name="CO34-4" href="#CO34-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
  entity-manager-factory=""  <a name="CO34-5" href="#CO34-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
  id=""
  jpa-operations=""  <a name="CO34-6" href="#CO34-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>
  jpa-query=""  <a name="CO34-7" href="#CO34-7"></a><span><img src="images/callouts/7.png" alt="7" border="0"></span>
  named-query=""  <a name="CO34-8" href="#CO34-8"></a><span><img src="images/callouts/8.png" alt="8" border="0"></span>
  native-query=""  <a name="CO34-9" href="#CO34-9"></a><span><img src="images/callouts/9.png" alt="9" border="0"></span>
  order=""  <a name="CO34-10" href="#CO34-10"></a><span><img src="images/callouts/10.png" alt="10" border="0"></span>
  parameter-source-factory=""   <a name="CO34-11" href="#CO34-11"></a><span><img src="images/callouts/11.png" alt="11" border="0"></span>
  persist-mode="MERGE"   <a name="CO34-12" href="#CO34-12"></a><span><img src="images/callouts/12.png" alt="12" border="0"></span>
  flush="true"   <a name="CO34-13" href="#CO34-13"></a><span><img src="images/callouts/13.png" alt="13" border="0"></span>
  flush-size="10"   <a name="CO34-14" href="#CO34-14"></a><span><img src="images/callouts/14.png" alt="14" border="0"></span>
  clear-on-flush="true"   <a name="CO34-15" href="#CO34-15"></a><span><img src="images/callouts/15.png" alt="15" border="0"></span>
  use-payload-as-parameter-source="true"   <a name="CO34-16" href="#CO34-16"></a>(16)
	<span class="hl-tag">&lt;int:poller/&gt;</span>
	<span class="hl-tag">&lt;int-jpa:transactional/&gt;</span>    <a name="CO34-17" href="#CO34-17"></a>(17)
	<span class="hl-tag">&lt;int-jpa:parameter/&gt;</span>    <a name="CO34-18" href="#CO34-18"></a>(18)
<span class="hl-tag">&lt;/int-jpa:outbound-channel-adapter&gt;</span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO34-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Lifecycle attribute signaling if this component should be started during Application Context startup.
Defaults to <code class="literal">true</code>.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO34-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The channel from which the outbound adapter will receive messages for performing the desired operation.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO34-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The fully qualified name of the entity class for the JPA Operation.
The attributes <span class="emphasis"><em>entity-class</em></span>, <span class="emphasis"><em>query</em></span> and <span class="emphasis"><em>named-query</em></span> are mutually exclusive.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO34-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>An instance of <code class="literal">javax.persistence.EntityManager</code> that will be used to perform the JPA operations.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO34-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>An instance of <code class="literal">javax.persistence.EntityManagerFactory</code> that will be used to obtain an instance of <code class="literal">javax.persistence.EntityManager</code> that will perform the JPA operations.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO34-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>An implementation of <code class="literal">org.springframework.integration.jpa.core.JpaOperations</code> that would be used to perform the JPA operations.
It is recommended not to provide an implementation of your own but use the default <code class="literal">org.springframework.integration.jpa.core.DefaultJpaOperations</code> implementation.
Either of the <span class="emphasis"><em>entity-manager</em></span>, <span class="emphasis"><em>entity-manager-factory</em></span> or <span class="emphasis"><em>jpa-operations</em></span> attributes is to be used.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO34-7"><span><img src="images/callouts/7.png" alt="7" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The JPA QL that needs to be executed by this adapter.<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO34-8"><span><img src="images/callouts/8.png" alt="8" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The named query that needs to be executed by this adapter.<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO34-9"><span><img src="images/callouts/9.png" alt="9" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The native query that will be executed by this adapter.
Either of the <span class="emphasis"><em>jpa-query</em></span>, <span class="emphasis"><em>named-query</em></span> or <span class="emphasis"><em>native-query</em></span> attributes are to be used.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO34-10"><span><img src="images/callouts/10.png" alt="10" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The order for this consumer when multiple consumers are registered thereby managing load- balancing and/or failover.
Optional (Defaults to <span class="emphasis"><em>Ordered.LOWEST_PRECEDENCE</em></span>).</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO34-11"><span><img src="images/callouts/11.png" alt="11" border="0"></span></a> </p></td><td valign="top" align="left">
<p>An instance of <code class="literal">o.s.i.jpa.support.parametersource.ParameterSourceFactory</code> that will be used to get an instance of <code class="literal">o.s.i.jpa.support.parametersource.ParameterSource</code> which will be used to resolve the values of the parameters provided in the query.
Ignored if operations are performed using a JPA entity.
If a parameter sub element is used, the factory must be of type <code class="literal">ExpressionEvaluatingParameterSourceFactory</code> located in package <code class="literal">o.s.i.jpa.support.parametersource</code>.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO34-12"><span><img src="images/callouts/12.png" alt="12" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Accepts one of the following: <span class="emphasis"><em>PERSIST</em></span>, <span class="emphasis"><em>MERGE</em></span> or <span class="emphasis"><em>DELETE</em></span>.
Indicates the operation that the adapter needs to perform.
Relevant only if an entity is being used for JPA operations.
Ignored if JPA QL, named query or native query is provided.
Defaults to <span class="emphasis"><em>MERGE</em></span>.
<span class="emphasis"><em>Optional</em></span>.
As of <span class="strong"><strong>Spring Integration 3.0</strong></span>, payloads to <span class="emphasis"><em>persist</em></span> or <span class="emphasis"><em>merge</em></span> can also be of type <code class="literal">http://docs.oracle.com/javase/7/docs/api/java/lang/Iterable.html[java.lang.Iterable]</code>.
In that case, each object returned by the <code class="literal">Iterable</code> is treated as an entity and persisted or merged using the underlying <code class="literal">EntityManager</code>.
<span class="emphasis"><em>NULL</em></span> values returned by the iterator are ignored.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO34-13"><span><img src="images/callouts/13.png" alt="13" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Set this value to <code class="literal">true</code> if you want to flush the persistence context immediately after persist, merge or delete operations and don&#8217;t want to rely on the <code class="literal">EntityManager</code>'s flushMode.
The default value is set to <code class="literal">false</code>.
Applies only if the <code class="literal">flush-size</code> attribute isn&#8217;t specified.
If this attribute is set to <code class="literal">true</code>, then <code class="literal">flush-size</code> will be implicitly set to <code class="literal">1</code>, if it wasn&#8217;t configured to any other value.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO34-14"><span><img src="images/callouts/14.png" alt="14" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Set this attribute to a value greater than <span class="emphasis"><em>0</em></span> if you want to flush the persistence context immediately after persist, merge or delete operations and don&#8217;t want to rely on the <code class="literal">EntityManager</code><span class="emphasis"><em>s flushMode.
The default value is set to <code class="literal">0</code> which means 'no flush</em></span>.
This attribute is geared towards messages with <code class="literal">Iterable</code> payloads.
For instance, if <code class="literal">flush-size</code> is set to <code class="literal">3</code>, then <code class="literal">entityManager.flush()</code> is called after every third entity.
Furthermore, <code class="literal">entityManager.flush()</code> will be called once more after the entire loop.
There is no reason to configure the <code class="literal">flush</code> attribute, if the <span class="emphasis"><em>flush-size</em></span> attribute is specified with a value greater than <span class="emphasis"><em>0</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO34-15"><span><img src="images/callouts/15.png" alt="15" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Set this value to <span class="emphasis"><em>true</em></span> if you want to clear persistence context immediately after each flush operation.
The attribute&#8217;s value is applied only if the <code class="literal">flush</code> attribute is set to <code class="literal">true</code> or if the <code class="literal">flush-size</code> attribute is set to a value greater than <code class="literal">0</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO34-16">(16)</a> </p></td><td valign="top" align="left">
<p>If set to true, the payload of the Message will be used as a source for providing parameters.
If false, however, the entire Message will be available as a source for parameters.<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO34-17">(17)</a> </p></td><td valign="top" align="left">
<p>Defines the transaction management attributes and the reference to transaction manager to be used by the JPA adapter.<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO34-18">(18)</a> </p></td><td valign="top" align="left">
<p>One or more <span class="emphasis"><em>parameter</em></span> attributes, one for each parameter used in the query.
The value or expression provided will be evaluated to compute the value of the parameter.<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr></table></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jpa-outbound-gateways" href="#jpa-outbound-gateways"></a>19.6&nbsp;Outbound Gateways</h2></div></div></div>

<p>The JPA <span class="emphasis"><em>Inbound Channel Adapter</em></span> allows you to poll a database in order to retrieve one or more JPA entities and the retrieved data is consequently used to start a Spring Integration flow using the retrieved data as message payload.</p>
<p>Additionally, you may use JPA <span class="emphasis"><em>Outbound Channel Adapters</em></span> at the end of your flow in order to persist data, essentially terminating the flow at the end of the persistence operation.</p>
<p>However, how can you execute JPA persistence operation in the middle of a flow? For example, you may have business data that you are processing in your Spring Integration message flow, that you would like to persist, yet you still need to execute other components further downstream.
Or instead of polling the database using a poller, you rather have the need to execute JPQL queries and retrieve data actively which then is used to being processed in subsequent components within your flow.</p>
<p>This is where JPA Outbound Gateways come into play.
They give you the ability to persist data as well as retrieving data.
To facilitate these uses, Spring Integration provides two types of JPA Outbound Gateways:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="emphasis"><em>Updating Outbound Gateway</em></span>
</li><li class="listitem">
<span class="emphasis"><em>Retrieving Outbound Gateway</em></span>
</li></ul></div>
<p>Whenever the Outbound Gateway is used to perform an action that saves, updates or soley deletes some records in the database, you need to use an <span class="emphasis"><em>Updating Outbound Gateway</em></span> gateway.
If for example an <span class="emphasis"><em>entity</em></span> is used to persist it, then a merged/persisted entity is returned as a result.
In other cases the number of records affected (updated or deleted) is returned instead.</p>
<p>When retrieving (selecting) data from the database, we use a <span class="emphasis"><em>Retrieving Outbound Gateway</em></span>.
With a <span class="emphasis"><em>Retrieving Outbound Gateway</em></span> gateway, we can use either JPQL, Named Queries (native or JPQL-based) or Native Queries (SQL) for selecting the data and retrieving the results.</p>
<p>An <span class="emphasis"><em>Updating Outbound Gateway</em></span> is functionally very similar to an <span class="emphasis"><em>Outbound Channel Adapter</em></span>, except that an <span class="emphasis"><em>Updating Outbound Gateway</em></span> is used to send a result to the Gateway&#8217;s <span class="emphasis"><em>reply channel</em></span> after performing the given JPA operation.</p>
<p>A <span class="emphasis"><em>Retrieving Outbound Gateway</em></span> is quite similar to an <span class="emphasis"><em>Inbound Channel Adapter</em></span>.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>We recommend you to first refer to the JPA Outbound Channel Adapter section and the JPA Inbound Channel Adapter sections above, as most of the common concepts are being explained there.</p>
</td></tr></table></div>
<p>This similarity was the main factor to use the central <code class="literal">JpaExecutor</code> class to unify common functionality as much as possible.</p>
<p>Common for all JPA Outbound Gateways and simlar to the <span class="emphasis"><em>outbound-channel-adapter</em></span>, we can use</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="emphasis"><em>Entity classes</em></span>
</li><li class="listitem">
<span class="emphasis"><em>JPA Query Language (JPQL)</em></span>
</li><li class="listitem">
<span class="emphasis"><em>Native query</em></span>
</li><li class="listitem">
<span class="emphasis"><em>Named query</em></span>
</li></ul></div>
<p>for performing various JPA operations.
For configuration examples please see <a class="xref" href="#outboundGatewaySamples" title="19.6.4&nbsp;JPA Outbound Gateway Samples">Section&nbsp;19.6.4, &#8220;JPA Outbound Gateway Samples&#8221;</a>.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jpa-outbound-gateway-common-parameters" href="#jpa-outbound-gateway-common-parameters"></a>19.6.1&nbsp;Common Configuration Parameters</h3></div></div></div>

<p>JPA Outbound Gateways always have access to the Spring Integration Message as input.
As such the following parameters are available:</p>
<p><span class="emphasis"><em>parameter-source-factory</em></span></p>
<p>An instance of <code class="literal">o.s.i.jpa.support.parametersource.ParameterSourceFactory</code> that will be used to get an instance of <code class="literal">o.s.i.jpa.support.parametersource.ParameterSource</code>.
The <span class="emphasis"><em>ParameterSource</em></span> is used to resolve the values of the parameters provided in the query.
The_parameter-source-factory_ attribute is ignored, if operations are performed using a JPA entity.
If a <span class="emphasis"><em>parameter</em></span> sub-element is used, the factory must be of type <code class="literal">ExpressionEvaluatingParameterSourceFactory</code>, located in package <span class="emphasis"><em>o.s.i.jpa.support.parametersource</em></span>.
<span class="emphasis"><em>Optional</em></span>.</p>
<p><span class="emphasis"><em>use-payload-as-parameter-source</em></span></p>
<p>If set to <span class="emphasis"><em>true</em></span>, the payload of the Message will be used as a source for providing parameters.
If set to <span class="emphasis"><em>false</em></span>, the entire Message will be available as a source for parameters.
If no JPA Parameters are passed in, this property will default to <span class="emphasis"><em>true</em></span>.
This means that using a default <code class="literal">BeanPropertyParameterSourceFactory</code>, the bean properties of the payload will be used as a source for parameter values for the to-be-executed JPA query.
However, if JPA Parameters are passed in, then this property will by default evaluate to <span class="emphasis"><em>false</em></span>.
The reason is that JPA Parameters allow for SpEL Expressions to be provided and therefore it is highly beneficial to have access to the entire Message, including the Headers.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jpa-updating-outbound-gateway" href="#jpa-updating-outbound-gateway"></a>19.6.2&nbsp;Updating Outbound Gateway</h3></div></div></div>

<pre class="programlisting"><span class="hl-tag">&lt;int-jpa:updating-outbound-gateway</span> <span class="hl-attribute">request-channel</span>=<span class="hl-value">""</span>  <a name="CO35-1" href="#CO35-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
    auto-startup="true"
    entity-class=""
    entity-manager=""
    entity-manager-factory=""
    id=""
    jpa-operations=""
    jpa-query=""
    named-query=""
    native-query=""
    order=""
    parameter-source-factory=""
    persist-mode="MERGE"
    reply-channel=""  <a name="CO35-2" href="#CO35-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
    reply-timeout=""  <a name="CO35-3" href="#CO35-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
    use-payload-as-parameter-source="true"&gt;

    <span class="hl-tag">&lt;int:poller/&gt;</span>
    <span class="hl-tag">&lt;int-jpa:transactional/&gt;</span>

    <span class="hl-tag">&lt;int-jpa:parameter</span> <span class="hl-attribute">name</span>=<span class="hl-value">""</span> <span class="hl-attribute">type</span>=<span class="hl-value">""</span> <span class="hl-attribute">value</span>=<span class="hl-value">""</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int-jpa:parameter</span> <span class="hl-attribute">name</span>=<span class="hl-value">""</span> <span class="hl-attribute">expression</span>=<span class="hl-value">""</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-jpa:updating-outbound-gateway&gt;</span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO35-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The channel from which the outbound gateway will receive messages for performing the desired operation.
This attribute is similar to <span class="emphasis"><em>channel</em></span> attribute of the outbound-channel-adapter.<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO35-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The channel to which the gateway will send the response after performing the required JPA operation.
If this attribute is not defined, the request message must have a replyChannel header.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO35-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Specifies the time the gateway will wait to send the result to the reply channel.
Only applies when the reply channel itself might block the send (for example a bounded QueueChannel that is currently full).
By default the Gateway will wait indefinitely.
The value is specified in milliseconds.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jpa-retrieving-outbound-gateway" href="#jpa-retrieving-outbound-gateway"></a>19.6.3&nbsp;Retrieving Outbound Gateway</h3></div></div></div>

<pre class="programlisting"><span class="hl-tag">&lt;int-jpa:retrieving-outbound-gateway</span> <span class="hl-attribute">request-channel</span>=<span class="hl-value">""</span>
    <span class="hl-attribute">auto-startup</span>=<span class="hl-value">"true"</span>
    <span class="hl-attribute">delete-after-poll</span>=<span class="hl-value">"false"</span>
    <span class="hl-attribute">delete-in-batch</span>=<span class="hl-value">"false"</span>
    <span class="hl-attribute">entity-class</span>=<span class="hl-value">""</span>
    <span class="hl-attribute">id-expression</span>=<span class="hl-value">""</span>  <a name="CO36-1" href="#CO36-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
    entity-manager=""
    entity-manager-factory=""
    expect-single-result="false"  <a name="CO36-2" href="#CO36-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
    id=""
    jpa-operations=""
    jpa-query=""
    max-results=""  <a name="CO36-3" href="#CO36-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
    max-results-expression=""  <a name="CO36-4" href="#CO36-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
    first-result=""  <a name="CO36-5" href="#CO36-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
    first-result-expression=""  <a name="CO36-6" href="#CO36-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>
    named-query=""
    native-query=""
    order=""
    parameter-source-factory=""
    reply-channel=""
    reply-timeout=""
    use-payload-as-parameter-source="true"&gt;
    <span class="hl-tag">&lt;int:poller&gt;</span><span class="hl-tag">&lt;/int:poller&gt;</span>
    <span class="hl-tag">&lt;int-jpa:transactional/&gt;</span>

    <span class="hl-tag">&lt;int-jpa:parameter</span> <span class="hl-attribute">name</span>=<span class="hl-value">""</span> <span class="hl-attribute">type</span>=<span class="hl-value">""</span> <span class="hl-attribute">value</span>=<span class="hl-value">""</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int-jpa:parameter</span> <span class="hl-attribute">name</span>=<span class="hl-value">""</span> <span class="hl-attribute">expression</span>=<span class="hl-value">""</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-jpa:retrieving-outbound-gateway&gt;</span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO36-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>(Since <span class="emphasis"><em>Spring Integration 4.0</em></span>) The SpEL expression to determine the <code class="literal">primaryKey</code> value for <code class="literal">EntityManager.find(Class entityClass, Object primaryKey)</code> method against the <code class="literal">requestMessage</code> as root object of evaluation context.
The <code class="literal">entityClass</code> argument is determined from <code class="literal">entity-class</code> attribute, if presented, otherwise from <code class="literal">payload</code> class.
All other attributed are disallowed in case of <code class="literal">id-expression</code>.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO36-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A boolean flag indicating whether the select operation is expected to return a single result or a <code class="literal">List</code> of results.
If this flag is set to <code class="literal">true</code>, the single entity selected is sent as the payload of the message.
If multiple entities are returned, an exception is thrown.
If <code class="literal">false</code>, the <code class="literal">List</code> of entities is being sent as the payload of the message.
By default the value is <code class="literal">false</code>.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO36-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>This non zero, non negative integer value tells the adapter not to select more than given number of rows on execution of the select operation.
By default, if this attribute is not set, all the possible records are selected by given query.
This attribute is mutually exclusive with <code class="literal">max-results-expression</code>.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO36-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>An expression, mutually exclusive with <code class="literal">max-results</code>, that can be used to provide an expression that will be evaluated to find the maximum number of results in a result set.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO36-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>This non zero, non negative integer value tells the adapter the first record from which the results are to be retrieved This attribute is mutually exclusive to <code class="literal">first-result-expression</code>.
This attribute is introduced since version 3.0.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO36-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>This expression is evaluated against the message to find the position of first record in the result set to be retrieved This attribute is mutually exclusive to <code class="literal">first-result</code>.
This attribute is introduced since version 3.0.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr></table></div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>When choosing to delete entities upon retrieval and you have retrieved a collection of entities, please be aware that by default entities are deleted on a per entity basis.
This may cause performance issues.</p>
<p>Alternatively, you can set attribute <span class="emphasis"><em>deleteInBatch</em></span> to <span class="emphasis"><em>true</em></span>, which will perform a batch delete.
However, please be aware of the limitation that in that case cascading deletes are not supported.</p>
<p><span class="emphasis"><em>JSR 317: Java&#8482; Persistence 2.0</em></span> states in chapter Chapter 4.10, Bulk Update and Delete Operations that:</p>
<p>"A delete operation only applies to entities of the specified class and its subclasses.
It does not cascade to related entities."</p>
<p>For more information please see <a class="ulink" href="http://jcp.org/en/jsr/detail?id=317" target="_top">JSR 317: Java&#8482; Persistence 2.0</a></p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="outboundGatewaySamples" href="#outboundGatewaySamples"></a>19.6.4&nbsp;JPA Outbound Gateway Samples</h3></div></div></div>

<p>This section contains various examples of the <span class="emphasis"><em>Updating Outbound Gateway</em></span> and <span class="emphasis"><em>Retrieving Outbound Gateway</em></span></p>
<p><span class="emphasis"><em>Update using an Entity Class</em></span></p>
<p>In this example an <span class="emphasis"><em>Updating Outbound Gateway</em></span> is persisted using solely the entity class <code class="literal">org.springframework.integration.jpa.test.entity.Student</code> as JPA defining parameter.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-jpa:updating-outbound-gateway</span> <span class="hl-attribute">request-channel</span>=<span class="hl-value">"entityRequestChannel"</span>  <a name="CO37-1" href="#CO37-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
    reply-channel="entityResponseChannel"  <a name="CO37-2" href="#CO37-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
    entity-class="org.springframework.integration.jpa.test.entity.Student"
    entity-manager="em"/&gt;</pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO37-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>This is the request channel for the outbound gateway, this is similar to the <span class="emphasis"><em>channel</em></span> attribute of the <span class="emphasis"><em>outbound-channel-adapter</em></span></p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO37-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>This is where a gateway differs from an outbound adapter, this is the channel over which the reply of the performed JPA operation is received.
If,however, you are not interested in the reply received and just want to perform the operation, then using a JPA <span class="emphasis"><em>outbound-channel-adapter</em></span> is the appropriate choice.
In above case, where we are using entity class, the reply will be the entity object that was created/merged as a result of the JPA operation.</p>
</td></tr></table></div>
<p><span class="emphasis"><em>Update using JPQL</em></span></p>
<p>In this example, we will see how we can update an entity using the Java Persistence Query Language (JPQL).
For this we use an_Updating Outbound Gateway_.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-jpa:updating-outbound-gateway</span> <span class="hl-attribute">request-channel</span>=<span class="hl-value">"jpaqlRequestChannel"</span>
  <span class="hl-attribute">reply-channel</span>=<span class="hl-value">"jpaqlResponseChannel"</span>
  <span class="hl-attribute">jpa-query</span>=<span class="hl-value">"update Student s set s.lastName = :lastName where s.rollNumber = :rollNumber"</span>  <a name="CO38-1" href="#CO38-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
  entity-manager="em"&gt;
    <span class="hl-tag">&lt;int-jpa:parameter</span> <span class="hl-attribute">name</span>=<span class="hl-value">"lastName"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"payload"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int-jpa:parameter</span> <span class="hl-attribute">name</span>=<span class="hl-value">"rollNumber"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"headers['rollNumber']"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-jpa:updating-outbound-gateway&gt;</span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO38-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The JPQL query that will be executed by the gateway.
Since an <span class="emphasis"><em>Updating Outbound Gateway</em></span> is used, only <span class="emphasis"><em>update</em></span> and <span class="emphasis"><em>delete</em></span> JPQL queries would be sensible choices.</p>
</td></tr></table></div>
<p>When sending a message with a String payload and containing a header <span class="emphasis"><em>rollNumber</em></span> with a <span class="emphasis"><em>long</em></span> value, the last name of the student with the provided roll number is updated to the value provided in the message payload.
When using an <span class="emphasis"><em>UPDATING</em></span> gateway, the return value is <span class="emphasis"><em>always</em></span> an integer value which denotes the number of records affected by execution of the JPA QL.</p>
<p><span class="emphasis"><em>Retrieving an Entity using JPQL</em></span></p>
<p>The following examples uses a <span class="emphasis"><em>Retrieving Outbound Gateway</em></span> together with JPQL to retrieve (select) one or more entities from the database.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-jpa:retrieving-outbound-gateway</span> <span class="hl-attribute">request-channel</span>=<span class="hl-value">"retrievingGatewayReqChannel"</span>
    <span class="hl-attribute">reply-channel</span>=<span class="hl-value">"retrievingGatewayReplyChannel"</span>
    <span class="hl-attribute">jpa-query</span>=<span class="hl-value">"select s from Student s where s.firstName = :firstName and s.lastName = :lastName"</span>
    <span class="hl-attribute">entity-manager</span>=<span class="hl-value">"em"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int-jpa:parameter</span> <span class="hl-attribute">name</span>=<span class="hl-value">"firstName"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"payload"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int-jpa:parameter</span> <span class="hl-attribute">name</span>=<span class="hl-value">"lastName"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"headers['lastName']"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-jpa:outbound-gateway&gt;</span></pre>
<p><span class="emphasis"><em>Retrieving an Entity using id-expression</em></span></p>
<p>The following examples uses a <span class="emphasis"><em>Retrieving Outbound Gateway</em></span> together with <code class="literal">id-expression</code> to retrieve (find) one and only one entity from the database.
The <code class="literal">primaryKey</code> is the result of <code class="literal">id-expression</code> evaluation.
The <code class="literal">entityClass</code> is a class of Message <code class="literal">payload</code>.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-jpa:retrieving-outbound-gateway</span>
	<span class="hl-attribute">request-channel</span>=<span class="hl-value">"retrievingGatewayReqChannel"</span>
    <span class="hl-attribute">reply-channel</span>=<span class="hl-value">"retrievingGatewayReplyChannel"</span>
    <span class="hl-attribute">id-expression</span>=<span class="hl-value">"payload.id"</span>
    <span class="hl-attribute">entity-manager</span>=<span class="hl-value">"em"</span><span class="hl-tag">/&gt;</span></pre>
<p><span class="emphasis"><em>Update using a Named Query</em></span></p>
<p>Using a Named Query is basically the same as using a JPQL query directly.
The difference is that the <span class="emphasis"><em>named-query</em></span> attribute is used instead, as seen in the xml snippet below.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-jpa:updating-outbound-gateway</span> <span class="hl-attribute">request-channel</span>=<span class="hl-value">"namedQueryRequestChannel"</span>
    <span class="hl-attribute">reply-channel</span>=<span class="hl-value">"namedQueryResponseChannel"</span>
    <span class="hl-attribute">named-query</span>=<span class="hl-value">"updateStudentByRollNumber"</span>
    <span class="hl-attribute">entity-manager</span>=<span class="hl-value">"em"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int-jpa:parameter</span> <span class="hl-attribute">name</span>=<span class="hl-value">"lastName"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"payload"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int-jpa:parameter</span> <span class="hl-attribute">name</span>=<span class="hl-value">"rollNumber"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"headers['rollNumber']"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-jpa:outbound-gateway&gt;</span></pre>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>You can find a complete Sample application for using Spring Integration&#8217;s JPA adapter at <a class="ulink" href="https://github.com/spring-projects/spring-integration-samples/tree/master/basic/jpa" target="_top">jpa sample</a>.</p>
</td></tr></table></div>
</div>
</div>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="jms" href="#jms"></a>20.&nbsp;JMS Support</h2></div></div></div>

<p>Spring Integration provides Channel Adapters for receiving and sending JMS messages.
There are actually two JMS-based inbound Channel Adapters.
The first uses Spring&#8217;s <code class="literal">JmsTemplate</code> to receive based on a polling period.
The second is "message-driven" and relies upon a Spring MessageListener container.
There is also an outbound Channel Adapter which uses the <code class="literal">JmsTemplate</code> to convert and send a JMS Message on demand.</p>
<p>As you can see from above by using <code class="literal">JmsTemplate</code> and <code class="literal">MessageListener</code> container Spring Integration relies on Spring&#8217;s JMS support.
This is important to understand since most of the attributes exposed on these adapters will configure the underlying Spring&#8217;s <code class="literal">JmsTemplate</code> and/or <code class="literal">MessageListener</code> container.
For more details about <code class="literal">JmsTemplate</code> and <code class="literal">MessageListener</code> container please refer to <a class="ulink" href="http://docs.spring.io/spring/docs/current/spring-framework-reference/html/jms.html" target="_top">Spring JMS documentation</a>.</p>
<p>Whereas the JMS Channel Adapters are intended for unidirectional Messaging (send-only or receive-only), Spring Integration also provides inbound and outbound JMS Gateways for request/reply operations.
The inbound gateway relies on one of Spring&#8217;s <code class="literal">MessageListener</code> container implementations for Message-driven reception that is also capable of sending a return value to the <code class="literal">reply-to</code> Destination as provided by the received Message.
The outbound Gateway sends a JMS Message to a <code class="literal">request-destination</code> (or <code class="literal">request-destination-name</code> or <code class="literal">request-destination-expression</code>) and then receives a reply Message.
The <code class="literal">reply-destination</code> reference (or <code class="literal">reply-destination-name</code> or <code class="literal">reply-destination-expression</code>) can be configured explicitly or else the outbound gateway will use a JMS <a class="ulink" href="http://docs.oracle.com/javaee/6/api/javax/jms/TemporaryQueue.html" target="_top">TemporaryQueue</a>.</p>
<p>Prior to <span class="emphasis"><em>Spring Integration 2.2</em></span>, if necessary, a <code class="literal">TemporaryQueue</code> was created (and removed) for each request/reply.
Beginning with <span class="emphasis"><em>Spring Integration 2.2</em></span>, the outbound gateway can be configured to use a <code class="literal">MessageListener</code> container to receive replies instead of directly using a new (or cached) <code class="literal">Consumer</code> to receive the reply for each request.
When so configured, and no explicit reply destination is provided, a single <code class="literal">TemporaryQueue</code> is used for each gateway instead of one for each request.</p>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jms-inbound-channel-adapter" href="#jms-inbound-channel-adapter"></a>20.1&nbsp;Inbound Channel Adapter</h2></div></div></div>

<p>The inbound Channel Adapter requires a reference to either a single <code class="literal">JmsTemplate</code> instance or both <code class="literal">ConnectionFactory</code> and <code class="literal">Destination</code> (a <span class="emphasis"><em>destinationName</em></span> can be provided in place of the <span class="emphasis"><em>destination</em></span> reference).
The following example defines an inbound Channel Adapter with a <code class="literal">Destination</code> reference.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-jms:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"jmsIn"</span> <span class="hl-attribute">destination</span>=<span class="hl-value">"inQueue"</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"exampleChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"30000"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-jms:inbound-channel-adapter&gt;</span></pre>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>Notice from the configuration that the inbound-channel-adapter is a Polling Consumer.
That means that it invokes <code class="literal">receive()</code> when triggered.
This should only be used in situations where polling is done relatively infrequently and timeliness is not important.
For all other situations (a vast majority of JMS-based use-cases), the <span class="emphasis"><em>message-driven-channel-adapter</em></span> described below is a better option.</p>
</td></tr></table></div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>All of the JMS adapters that require a reference to the <code class="literal">ConnectionFactory</code> will automatically look for a bean named "connectionFactory" by default.
That is why you don&#8217;t see a "connection-factory" attribute in many of the examples.
However, if your JMS <code class="literal">ConnectionFactory</code> has a different bean name, then you will need to provide that attribute.</p>
</td></tr></table></div>
<p>If <code class="literal">extract-payload</code> is set to true (which is the default), the received JMS Message will be passed through the <code class="literal">MessageConverter</code>.
When relying on the default <code class="literal">SimpleMessageConverter</code>, this means that the resulting Spring Integration Message will have the JMS Message&#8217;s body as its payload.
A JMS <code class="literal">TextMessage</code> will produce a String-based payload, a JMS <code class="literal">BytesMessage</code> will produce a byte array payload, and a JMS <code class="literal">ObjectMessage</code> 's Serializable instance will become the Spring Integration Message&#8217;s payload.
If instead you prefer to have the raw JMS Message as the Spring Integration Message&#8217;s payload, then set <code class="literal">extract-payload</code> to <code class="literal">false</code>.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-jms:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"jmsIn"</span>
    <span class="hl-attribute">destination</span>=<span class="hl-value">"inQueue"</span>
    <span class="hl-attribute">channel</span>=<span class="hl-value">"exampleChannel"</span>
    <span class="hl-attribute">extract-payload</span>=<span class="hl-value">"false"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"30000"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-jms:inbound-channel-adapter&gt;</span></pre>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jms-ib-transactions" href="#jms-ib-transactions"></a>20.1.1&nbsp;Transactions</h3></div></div></div>

<p>Starting with <span class="emphasis"><em>version 4.0</em></span>, the inbound channel adapter supports the <code class="literal">session-transacted</code> attribute.
In earlier versions, you had to inject a <code class="literal">JmsTemplate</code> with <code class="literal">sessionTransacted</code> set to <code class="literal">true</code>.
(The adapter did allow the <code class="literal">acknowledge</code> attribute to be set to <code class="literal">transacted</code> but this was incorrect and did not work).</p>
<p>Note, however, that setting <code class="literal">session-transacted</code> to <code class="literal">true</code> has little value because the transaction is committed
immediately after the <code class="literal">receive()</code> and before the message is sent to the <code class="literal">channel</code>.</p>
<p>If you want the entire flow to be transactional (for example if there is a downstream outbound channel adapter), you must use a <code class="literal">transactional</code> poller, with a <code class="literal">JmsTransactionManager</code>.
Or, consider using a <code class="literal">jms-message-driven-channel-adapter</code> with <code class="literal">acknowledge</code> set to <code class="literal">transacted</code> (the default).</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jms-message-driven-channel-adapter" href="#jms-message-driven-channel-adapter"></a>20.2&nbsp;Message-Driven Channel Adapter</h2></div></div></div>

<p>The "message-driven-channel-adapter" requires a reference to either an instance of a Spring MessageListener container (any subclass of <code class="literal">AbstractMessageListenerContainer</code>) or both <code class="literal">ConnectionFactory</code> and <code class="literal">Destination</code> (a <span class="emphasis"><em>destinationName</em></span> can be provided in place of the <span class="emphasis"><em>destination</em></span> reference).
The following example defines a message-driven Channel Adapter with a <code class="literal">Destination</code> reference.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-jms:message-driven-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"jmsIn"</span> <span class="hl-attribute">destination</span>=<span class="hl-value">"inQueue"</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"exampleChannel"</span><span class="hl-tag">/&gt;</span></pre>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The Message-Driven adapter also accepts several properties that pertain to the MessageListener container.
These values are only considered if you do not provide a <code class="literal">container</code> reference.
In that case, an instance of DefaultMessageListenerContainer will be created and configured based on these properties.
For example, you can specify the "transaction-manager" reference, the "concurrent-consumers" value, and several other property references and values.
Refer to the JavaDoc and Spring Integration&#8217;s JMS Schema (<span class="emphasis"><em>spring-integration-jms.xsd</em></span>) for more details.</p>
<p>If you have a custom listener container implementation (usually a subclass of <code class="literal">DefaultMessageListenerContainer</code>), you can either provide a reference to an instance of it using the <code class="literal">container</code> attribute, or simply provide its fully qualified class name using the <code class="literal">container-class</code> attribute.
In that case, the attributes on the adapter are transferred to an instance of your custom container.</p>
</td></tr></table></div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Starting with <span class="emphasis"><em>version 4.2</em></span>, the default <code class="literal">acknowledge</code> mode is <code class="literal">transacted</code>, unless an external
container is provided, in which case the container should be configured as needed.
It is recommended to use <code class="literal">transacted</code> with the <code class="literal">DefaultMessageListenerContainer</code> to avoid message loss.</p>
</td></tr></table></div>
<p>The <span class="emphasis"><em>extract-payload</em></span> property has the same effect as described above, and once again its default value is <span class="emphasis"><em>true</em></span>.
The poller sub-element is not applicable for a message-driven Channel Adapter, as it will be actively invoked.
For most usage scenarios, the message-driven approach is better since the Messages will be passed along to the <code class="literal">MessageChannel</code> as soon as they are received from the underlying JMS consumer.</p>
<p>Finally, the <code class="literal">&lt;message-driven-channel-adapter&gt;</code> also accepts the <span class="emphasis"><em>error-channel</em></span> attribute.
This provides the same basic functionality as described in <a class="xref" href="#gateway-proxy" title="8.4.1&nbsp;Enter the GatewayProxyFactoryBean">Section&nbsp;8.4.1, &#8220;Enter the GatewayProxyFactoryBean&#8221;</a>.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-jms:message-driven-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"jmsIn"</span> <span class="hl-attribute">destination</span>=<span class="hl-value">"inQueue"</span>
    <span class="hl-attribute">channel</span>=<span class="hl-value">"exampleChannel"</span>
    <span class="hl-attribute">error-channel</span>=<span class="hl-value">"exampleErrorChannel"</span><span class="hl-tag">/&gt;</span></pre>
<p>When comparing this to the generic gateway configuration, or the JMS <span class="emphasis"><em>inbound-gateway</em></span> that will be discussed below, the key difference here is that we are in a one-way flow since this is a <span class="emphasis"><em>channel-adapter</em></span>, not a gateway.
Therefore, the flow downstream from the <span class="emphasis"><em>error-channel</em></span> should also be one-way.
For example, it could simply send to a logging handler, or it could be connected to a different JMS <code class="literal">&lt;outbound-channel-adapter&gt;</code> element.</p>
<p>When consuming from topics, set the <code class="literal">pub-sub-domain</code> attribute to true; set <code class="literal">subscription-durable</code> to true
for a durable subscription, <code class="literal">subscription-shared</code> for a shared subscription (requires a JMS 2.0 broker and
has been available since <span class="emphasis"><em>version 4.2</em></span>).
Use <code class="literal">subscription-name</code> to name the subscription.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jms-md-conversion-errors" href="#jms-md-conversion-errors"></a>20.2.1&nbsp;Inbound Conversion Errors</h3></div></div></div>

<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Starting with <span class="emphasis"><em>version 4.2</em></span> the <span class="emphasis"><em>error-channel</em></span> is used for the conversion errors, too.
Previously, if a JMS <code class="literal">&lt;message-driven-channel-adapter/&gt;</code> or <code class="literal">&lt;inbound-gateway/&gt;</code> could not deliver a message due to a conversion error, an exception would be thrown back to the container.
If the container was configured to use transactions, the message would be rolled back and redelivered repeatedly.
The conversion process occurs before and during message construction so such errors were not sent to the <span class="emphasis"><em>error-channel</em></span>.
Now such conversion exceptions result in an <code class="literal">ErrorMessage</code> being sent to the <span class="emphasis"><em>error-channel</em></span>, with the exception as the <code class="literal">payload</code>.
If you wish the transaction to be rolled back, and you have an <span class="emphasis"><em>error-channel</em></span> defined, the integration flow on the <span class="emphasis"><em>error-channel</em></span> must re-throw the exception (or another).
If the error flow does not throw an exception, the transaction will be committed and the message removed.
If no <span class="emphasis"><em>error-channel</em></span> is defined, the exception is thrown back to the container, as before.</p>
</td></tr></table></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jms-outbound-channel-adapter" href="#jms-outbound-channel-adapter"></a>20.3&nbsp;Outbound Channel Adapter</h2></div></div></div>

<p>The <code class="literal">JmsSendingMessageHandler</code> implements the <code class="literal">MessageHandler</code> interface and is capable of converting Spring Integration <code class="literal">Messages</code> to JMS messages and then sending to a JMS destination.
It requires either a <span class="emphasis"><em>jmsTemplate</em></span> reference or both <span class="emphasis"><em>connectionFactory</em></span> and <span class="emphasis"><em>destination</em></span> references (again, the <span class="emphasis"><em>destinationName</em></span> may be provided in place of the <span class="emphasis"><em>destination</em></span>).
As with the inbound Channel Adapter, the easiest way to configure this adapter is with the namespace support.
The following configuration will produce an adapter that receives Spring Integration Messages from the "exampleChannel" and then converts those into JMS Messages and sends them to the JMS Destination reference whose bean name is "outQueue".</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-jms:outbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"jmsOut"</span> <span class="hl-attribute">destination</span>=<span class="hl-value">"outQueue"</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"exampleChannel"</span><span class="hl-tag">/&gt;</span></pre>
<p>As with the inbound Channel Adapters, there is an <span class="emphasis"><em>extract-payload</em></span> property.
However, the meaning is reversed for the outbound adapter.
Rather than applying to the JMS Message, the boolean property applies to the Spring Integration Message payload.
In other words, the decision is whether to pass the Spring Integration Message <span class="emphasis"><em>itself</em></span> as the JMS Message body or whether to pass the Spring Integration Message&#8217;s payload as the JMS Message body.
The default value is once again <span class="emphasis"><em>true</em></span>.
Therefore, if you pass a Spring Integration Message whose payload is a String, a JMS TextMessage will be created.
If on the other hand you want to send the actual Spring Integration Message to another system via JMS, then simply set this to <span class="emphasis"><em>false</em></span>.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Regardless of the boolean value for payload extraction, the Spring Integration MessageHeaders will map to JMS properties as long as you are relying on the default converter or provide a reference to another instance of HeaderMappingMessageConverter (the same holds true for <span class="emphasis"><em>inbound</em></span> adapters except that in those cases, it&#8217;s the JMS properties mapping <span class="emphasis"><em>to</em></span> Spring Integration MessageHeaders).</p>
</td></tr></table></div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jms-ob-transactions" href="#jms-ob-transactions"></a>20.3.1&nbsp;Transactions</h3></div></div></div>

<p>Starting with <span class="emphasis"><em>version 4.0</em></span>, the outbound channel adapter supports the <code class="literal">session-transacted</code> attribute.
In earlier versions, you had to inject a <code class="literal">JmsTemplate</code> with <code class="literal">sessionTransacted</code> set to <code class="literal">true</code>.
The attribute now sets the property on the built-in default <code class="literal">JmsTemplate</code>.
If a transaction exists (perhaps from an upstream <code class="literal">message-driven-channel-adapter</code>) the send will be performed within the same transaction.
Otherwise a new transaction will be started.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jms-inbound-gateway" href="#jms-inbound-gateway"></a>20.4&nbsp;Inbound Gateway</h2></div></div></div>

<p>Spring Integration&#8217;s message-driven JMS inbound-gateway delegates to a <code class="literal">MessageListener</code> container, supports dynamically adjusting concurrent consumers, and can also handle replies.
The inbound gateway requires references to a <code class="literal">ConnectionFactory</code>, and a request <code class="literal">Destination</code> (or <span class="emphasis"><em>requestDestinationName</em></span>).
The following example defines a JMS "inbound-gateway" that receives from the JMS queue referenced by the bean id "inQueue" and sends to the Spring Integration channel named "exampleChannel".</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-jms:inbound-gateway</span> <span class="hl-attribute">id</span>=<span class="hl-value">"jmsInGateway"</span>
    <span class="hl-attribute">request-destination</span>=<span class="hl-value">"inQueue"</span>
    <span class="hl-attribute">request-channel</span>=<span class="hl-value">"exampleChannel"</span><span class="hl-tag">/&gt;</span></pre>
<p>Since the gateways provide request/reply behavior instead of unidirectional send <span class="emphasis"><em>or</em></span> receive, they also have two distinct properties for the "payload extraction" (as discussed above for the Channel Adapters' <span class="emphasis"><em>extract-payload</em></span> setting).
For an inbound-gateway, the <span class="emphasis"><em>extract-request-payload</em></span> property determines whether the received JMS Message body will be extracted.
If <span class="emphasis"><em>false</em></span>, the JMS Message itself will become the Spring Integration Message payload.
The default is <span class="emphasis"><em>true</em></span>.</p>
<p>Similarly, for an inbound-gateway the <span class="emphasis"><em>extract-reply-payload</em></span> property applies to the Spring Integration Message that is going to be converted into a reply JMS Message.
If you want to pass the whole Spring Integration Message (as the body of a JMS ObjectMessage) then set this to <span class="emphasis"><em>false</em></span>.
By default, it is also <span class="emphasis"><em>true</em></span> such that the Spring Integration Message <span class="emphasis"><em>payload</em></span> will be converted into a JMS Message (e.g.
String payload becomes a JMS TextMessage).</p>
<p>As with anything else, Gateway invocation might result in error.
By default Producer will not be notified of the errors that might have occurred on the consumer side and will time out waiting for the reply.
However there might be times when you want to communicate an error condition back to the consumer, in other words treat the Exception as a valid reply by mapping it to a Message.
To accomplish this JMS Inbound Gateway provides support for a Message Channel to which errors can be sent for processing, potentially resulting in a reply Message payload that conforms to some contract defining what a caller may expect as an "error" reply.
Such a channel can be configured via the <span class="emphasis"><em>error-channel</em></span> attribute.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-jms:inbound-gateway</span> <span class="hl-attribute">request-destination</span>=<span class="hl-value">"requestQueue"</span>
          <span class="hl-attribute">request-channel</span>=<span class="hl-value">"jmsinputchannel"</span>
          <span class="hl-attribute">error-channel</span>=<span class="hl-value">"errorTransformationChannel"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int:transformer</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"exceptionTransformationChannel"</span>
        <span class="hl-attribute">ref</span>=<span class="hl-value">"exceptionTransformer"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"createErrorResponse"</span><span class="hl-tag">/&gt;</span></pre>
<p>You might notice that this example looks very similar to that included within <a class="xref" href="#gateway-proxy" title="8.4.1&nbsp;Enter the GatewayProxyFactoryBean">Section&nbsp;8.4.1, &#8220;Enter the GatewayProxyFactoryBean&#8221;</a>.
The same idea applies here: The <span class="emphasis"><em>exceptionTransformer</em></span> could be a simple POJO that creates error response objects, you could reference the "nullChannel" to suppress the errors, or you could leave <span class="emphasis"><em>error-channel</em></span> out to let the Exception propagate.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>See <a class="xref" href="#jms-md-conversion-errors" title="20.2.1&nbsp;Inbound Conversion Errors">Section&nbsp;20.2.1, &#8220;Inbound Conversion Errors&#8221;</a>.</p>
</td></tr></table></div>
<p>When consuming from topics, set the <code class="literal">pub-sub-domain</code> attribute to true; set <code class="literal">subscription-durable</code> to true
for a durable subscription, <code class="literal">subscription-shared</code> for a shared subscription (requires a JMS 2.0 broker and
has been available since <span class="emphasis"><em>version 4.2</em></span>).
Use <code class="literal">subscription-name</code> to name the subscription.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Starting with <span class="emphasis"><em>version 4.2</em></span>, the default <code class="literal">acknowledge</code> mode is <code class="literal">transacted</code>, unless an external
container is provided, in which case the container should be configured as needed.
It is recommended to use <code class="literal">transacted</code> with the <code class="literal">DefaultMessageListenerContainer</code> to avoid message loss.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jms-outbound-gateway" href="#jms-outbound-gateway"></a>20.5&nbsp;Outbound Gateway</h2></div></div></div>

<p>The outbound Gateway creates JMS Messages from Spring Integration Messages and then sends to a <span class="emphasis"><em>request-destination</em></span>.
It will then handle the JMS reply Message either by using a selector to receive from the <span class="emphasis"><em>reply-destination</em></span> that you configure, or if no <span class="emphasis"><em>reply-destination</em></span> is provided, it will create JMS <code class="literal">TemporaryQueue</code> s.</p>
<div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Warning"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Warning]" src="images/warning.png"></td><th align="left">Warning</th></tr><tr><td align="left" valign="top">
<p>Using a reply-destination (or reply-destination-name), together with a <code class="literal">CachingConnectionFactory</code> with <span class="emphasis"><em>cacheConsumers</em></span> set to <span class="emphasis"><em>true</em></span>, can cause Out of Memory conditions.
This is because each request gets a new consumer with a new selector (selecting on the correlation-key value, or on the sent JMSMessageID when there is no correlation-key).
Given that these selectors are unique, they will remain in the cache unused after the current request completes.</p>
<p>If you specify a reply destination, you are advised to NOT use cached consumers.
Alternatively, consider using a <code class="literal">&lt;reply-listener/&gt;</code> as described below.</p>
</td></tr></table></div>
<pre class="programlisting"><span class="hl-tag">&lt;int-jms:outbound-gateway</span> <span class="hl-attribute">id</span>=<span class="hl-value">"jmsOutGateway"</span>
    <span class="hl-attribute">request-destination</span>=<span class="hl-value">"outQueue"</span>
    <span class="hl-attribute">request-channel</span>=<span class="hl-value">"outboundJmsRequests"</span>
    <span class="hl-attribute">reply-channel</span>=<span class="hl-value">"jmsReplies"</span><span class="hl-tag">/&gt;</span></pre>
<p>The <span class="emphasis"><em>outbound-gateway</em></span> payload extraction properties are inversely related to those of the <span class="emphasis"><em>inbound-gateway</em></span> (see the discussion above).
That means that the <span class="emphasis"><em>extract-request-payload</em></span> property value applies to the Spring Integration Message that is being converted into a JMS Message to be <span class="emphasis"><em>sent as a request</em></span>, and the <span class="emphasis"><em>extract-reply-payload</em></span> property value applies to the JMS Message that is <span class="emphasis"><em>received as a reply</em></span> and then converted into a Spring Integration Message to be subsequently sent to the <span class="emphasis"><em>reply-channel</em></span> as shown in the example configuration above.</p>
<p><span class="strong"><strong>&lt;reply-listener/&gt;</strong></span></p>
<p><span class="emphasis"><em>Spring Integration 2.2</em></span> introduced an alternative technique for handling replies.
If you add a <code class="literal">&lt;reply-listener/&gt;</code> child element to the gateway, instead of creating a consumer for each reply, a <code class="literal">MessageListener</code> container is used to receive the replies and hand them over to the requesting thread.
This provides a number of performance benefits as well as alleviating the cached consumer memory utilization problem described in the caution above.</p>
<p>When using a <code class="literal">&lt;reply-listener/&gt;</code> with an outbound gateway with no <code class="literal">reply-destination</code>, instead of creating a <code class="literal">TemporaryQueue</code> for each request, a single <code class="literal">TemporaryQueue</code> is used (the gateway will create an additional <code class="literal">TemporaryQueue</code>, as necessary, if the connection to the broker is lost and recovered).</p>
<p>When using a <code class="literal">correlation-key</code>, multiple gateways can share the same reply destination because the listener container uses a selector that is unique to each gateway.</p>
<div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Warning"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Warning]" src="images/warning.png"></td><th align="left">Warning</th></tr><tr><td align="left" valign="top">
<p>If you specify a reply listener, and specify a reply destination (or reply destination name), but provide NO correlation key, the gateway will log a warning and fall back to pre-2.2 behavior.
This is because there is no way to configure a selector in this case, thus there is no way to avoid a reply going to a different gateway that might be configured with the same reply destination.</p>
<p>Note that, in this situation, a new consumer is used for each request, and consumers can build up in memory as described in the caution above; therefore cached consumers should not be used in this case.</p>
</td></tr></table></div>
<pre class="programlisting"><span class="hl-tag">&lt;int-jms:outbound-gateway</span> <span class="hl-attribute">id</span>=<span class="hl-value">"jmsOutGateway"</span>
        <span class="hl-attribute">request-destination</span>=<span class="hl-value">"outQueue"</span>
        <span class="hl-attribute">request-channel</span>=<span class="hl-value">"outboundJmsRequests"</span>
        <span class="hl-attribute">reply-channel</span>=<span class="hl-value">"jmsReplies"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int-jms:reply-listener /&gt;</span>
<span class="hl-tag">&lt;/int-jms-outbound-gateway&gt;</span></pre>
<p>In the above example, a reply listener with default attributes is used.
The listener is very lightweight and it is anticipated that, in most cases, only a single consumer will be needed.
However, attributes such as <span class="emphasis"><em>concurrent-consumers</em></span>, <span class="emphasis"><em>max-concurrent-consumers</em></span> etc., can be added.
Refer to the schema for a complete list of supported attributes, together with the <a class="ulink" href="http://docs.spring.io/spring/docs/current/spring-framework-reference/html/jms.html" target="_top">Spring JMS documentation</a> for their meanings.</p>
<p><span class="strong"><strong>Idle Reply Listeners</strong></span></p>
<p>Starting with <span class="emphasis"><em>version 4.2</em></span>, the reply listener can be started as needed (and stopped after an idle time) instead
of running for the duration of the gateway&#8217;s lifecycle.
This might be useful if you have many gateways in the application context where they are mostly idle.
One such situation is a context with many (inactive) partitioned <a class="ulink" href="http://projects.spring.io/spring-batch/" target="_top">Spring Batch</a>
jobs using Spring Integration and JMS for partition distribution.
If all the reply listeners were active, the JMS broker would have an active consumer for each gateway.
By enabling the idle timeout, each consumer would exist only while the corresponding batch job is running (and
for a short time after it finishes).</p>
<p>See <code class="literal">idle-reply-listener-timeout</code> in <a class="xref" href="#jms-og-attributes" title="20.5.3&nbsp;Attribute Reference">Section&nbsp;20.5.3, &#8220;Attribute Reference&#8221;</a>.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_gateway_reply_correlation" href="#_gateway_reply_correlation"></a>20.5.1&nbsp;Gateway Reply Correlation</h3></div></div></div>

<p>The following describes the mechanisms used for reply correlation (ensuring the originating gateway receives replies
to only its requests), depending on how the gateway is configured.
See the next section for complete description of the attributes discussed here.</p>
<p><span class="strong"><strong>1. No <code class="literal">reply-destination*</code> properties; no <code class="literal">&lt;reply-listener&gt;</code></strong></span></p>
<p>A <code class="literal">TemporaryQueue</code> is created for each request, and deleted when the request is complete (successfully or otherwise).
<code class="literal">correlation-key</code> is irrelevant.</p>
<p><span class="strong"><strong>2. A <code class="literal">reply-destination*</code> property is provided; no <code class="literal">&lt;reply-listener/&gt;</code>; no <code class="literal">correlation-key</code></strong></span></p>
<p>The <code class="literal">JMSCorrelationID</code> equal to the outgoing message id is used as a message selector for the consumer:</p>
<pre class="literallayout">messageSelector = "JMSCorrelationID = '" + messageId + "'"</pre>
<p>The responding system is expected to return the inbound <code class="literal">JMSMessageID</code> in the reply <code class="literal">JMSCorrelationID</code> - this is a
common pattern and is implemented by the Spring Integration inbound gateway as well as Spring&#8217;s
<code class="literal">MessageListenerAdapter</code> for message-driven POJOs.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>When using this configuration, you should not use a topic for replies; the reply may be lost.</p>
</td></tr></table></div>
<p><span class="strong"><strong>3. A <code class="literal">reply-destination*</code> property is provided; no <code class="literal">&lt;reply-listener/&gt;</code>; <code class="literal">correlation-key="JMSCorrelationID"</code></strong></span></p>
<p>The gateway generates a unique correlation id and inserts it in the <code class="literal">JMSCorrelationID</code> header.
The message selector is:</p>
<pre class="literallayout">messageSelector = "JMSCorrelationID = '" + uniqueId + "'"</pre>
<p>The responding system is expected to return the inbound <code class="literal">JMSCorrelationID</code> in the reply <code class="literal">JMSCorrelationID</code> - this is a
common pattern and is implemented by the Spring Integration inbound gateway as well as Spring&#8217;s
<code class="literal">MessageListenerAdapter</code> for message-driven POJOs.</p>
<p><span class="strong"><strong>4. A <code class="literal">reply-destination*</code> property is provided; no <code class="literal">&lt;reply-listener/&gt;</code>; <code class="literal">correlation-key="myCorrelationHeader"</code></strong></span></p>
<p>The gateway generates a unique correlation id and inserts it in the <code class="literal">myCorrelationHeader</code> message property.
The <code class="literal">correlation-key</code> can be any user-defined value; the message selector is:</p>
<pre class="literallayout">messageSelector = "myCorrelationHeader = '" + uniqueId + "'"</pre>
<p>The responding system is expected to return the inbound <code class="literal">myCorrelationHeader</code> in the reply <code class="literal">myCorrelationHeader</code>.</p>
<p><span class="strong"><strong>5. A <code class="literal">reply-destination*</code> property is provided; no <code class="literal">&lt;reply-listener/&gt;</code>; <code class="literal">correlation-key="JMSCorrelationID*"</code></strong></span></p>
<p>(Note the <code class="literal">*</code> in the correlation key)</p>
<p>The gateway uses the value in the <code class="literal">jms_correlationId</code> header (if present) from the request message, and inserts it in
the <code class="literal">JMSCorrelationID</code> header.
The message selector is:</p>
<pre class="literallayout">messageSelector = "JMSCorrelationID = '" + headers['jms_correlationId'] + "'"</pre>
<p>The user must ensure this value is unique.</p>
<p>If the header does not exist, the gateway behaves as in <code class="literal">3.</code> above.</p>
<p>The responding system is expected to return the inbound <code class="literal">JMSCorrelationID</code> in the reply <code class="literal">JMSCorrelationID</code> - this is a
common pattern and is implemented by the Spring Integration inbound gateway as well as Spring&#8217;s
<code class="literal">MessageListenerAdapter</code> for message-driven POJOs.</p>
<p><span class="strong"><strong>6. No <code class="literal">reply-destination*</code> properties; with <code class="literal">&lt;reply-listener&gt;</code></strong></span></p>
<p>A temporary queue is created and used for all replies from this gateway instance.
No correlation data is needed in the message but the outgoing <code class="literal">JMSMessageID</code> is used internally in the gateway to
direct the reply to the correct requesting thread.</p>
<p><span class="strong"><strong>7. A <code class="literal">reply-destination*</code> property is provided; with <code class="literal">&lt;reply-listener&gt;</code>, no <code class="literal">correlation-key</code></strong></span></p>
<p><span class="emphasis"><em>NOT ALLOWED</em></span></p>
<p>The <code class="literal">&lt;reply-listener/&gt;</code> configuration is ignored and the gateway behaves as in <code class="literal">2.</code> above.
A warning log message is written indicating this situation.</p>
<p><span class="strong"><strong>8. A <code class="literal">reply-destination*</code> property is provided; with <code class="literal">&lt;reply-listener&gt;</code>, <code class="literal">correlation-key="JMSCorrelationID"</code></strong></span></p>
<p>The gateway has a unique correlation id and inserts it, together with an incrementing value in the <code class="literal">JMSCorrelationID</code>
header (<code class="literal">gatewayId + "_" + ++seq</code>).
The message selector is:</p>
<pre class="literallayout">messageSelector = "JMSCorrelationID LIKE '" + gatewayId%'"</pre>
<p>The responding system is expected to return the inbound <code class="literal">JMSCorrelationID</code> in the reply <code class="literal">JMSCorrelationID</code> - this is a
common pattern and is implemented by the Spring Integration inbound gateway as well as Spring&#8217;s
<code class="literal">MessageListenerAdapter</code> for message-driven POJOs.
Since each gateway has a unique id, each instance only gets its own replies; the complete correlation data is used
to route the reply to the correct requesting thread.</p>
<p><span class="strong"><strong>9. A <code class="literal">reply-destination*</code> property is provided; with <code class="literal">&lt;reply-listener/&gt;</code>; <code class="literal">correlation-key="myCorrelationHeader"</code></strong></span></p>
<p>The gateway has a unique correlation id and inserts it, together with an incrementing value in the <code class="literal">myCorrelationHeader</code>
property (<code class="literal">gatewayId + "_" + ++seq</code>).
The <code class="literal">correlation-key</code> can be any user-defined value; and the message selector is:</p>
<pre class="literallayout">messageSelector = "myCorrelationHeader LIKE '" + gatewayId%'"</pre>
<p>The responding system is expected to return the inbound <code class="literal">myCorrelationHeader</code> in the reply <code class="literal">myCorrelationHeader</code>.
Since each gateway has a unique id, each instance only gets its own replies; the complete correlation data is used
to route the reply to the correct requesting thread.</p>
<p><span class="strong"><strong>10. A <code class="literal">reply-destination*</code> property is provided; with <code class="literal">&lt;reply-listener/&gt;</code>; <code class="literal">correlation-key="JMSCorrelationID*"</code></strong></span></p>
<p>(Note the <code class="literal">*</code> in the correlation key)</p>
<p><span class="emphasis"><em>NOT ALLOWED</em></span></p>
<p>User-supplied correlation ids are not permitted with a reply listener; the gateway will not initialize with this
configuration.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jms-async-gateway" href="#jms-async-gateway"></a>20.5.2&nbsp;Async Gateway</h3></div></div></div>

<p>Starting with <span class="emphasis"><em>version 4.3</em></span>, you can now specify <code class="literal">async="true"</code> (or <code class="literal">setAsync(true)</code>) when configuring the outbound
gateway.</p>
<p>By default, when a request is sent to the gateway, the requesting thread is suspended until the reply is received and
the flow then continues on that thread.
If <code class="literal">async</code> is true, the requesting thread is released immediately after the send completes, and the reply is returned
(and the flow continues) on the listener container thread.
This can be useful when the gateway is invoked on a poller thread; the thread is released and is available for other
tasks within the framework.</p>
<p><code class="literal">async</code> requires a <code class="literal">&lt;reply-listener/&gt;</code> (or <code class="literal">setUseReplyContainer(true)</code> when using Java configuration); it also
requires a <code class="literal">correlationKey</code> (usually <code class="literal">JMSCorrelationID</code>) to be specified.
If either of these conditions are not met, <code class="literal">async</code> is ignored.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jms-og-attributes" href="#jms-og-attributes"></a>20.5.3&nbsp;Attribute Reference</h3></div></div></div>

<pre class="programlisting"><span class="hl-tag">&lt;int-jms:outbound-gateway</span>
    <span class="hl-attribute">connection-factory</span>=<span class="hl-value">"connectionFactory"</span> <a name="CO39-1" href="#CO39-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
    correlation-key="" <a name="CO39-2" href="#CO39-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
    delivery-persistent="" <a name="CO39-3" href="#CO39-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
    destination-resolver="" <a name="CO39-4" href="#CO39-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
    explicit-qos-enabled="" <a name="CO39-5" href="#CO39-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
    extract-reply-payload="true" <a name="CO39-6" href="#CO39-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>
    extract-request-payload="true" <a name="CO39-7" href="#CO39-7"></a><span><img src="images/callouts/7.png" alt="7" border="0"></span>
    header-mapper="" <a name="CO39-8" href="#CO39-8"></a><span><img src="images/callouts/8.png" alt="8" border="0"></span>
    message-converter="" <a name="CO39-9" href="#CO39-9"></a><span><img src="images/callouts/9.png" alt="9" border="0"></span>
    priority="" <a name="CO39-10" href="#CO39-10"></a><span><img src="images/callouts/10.png" alt="10" border="0"></span>
    receive-timeout="" <a name="CO39-11" href="#CO39-11"></a><span><img src="images/callouts/11.png" alt="11" border="0"></span>
    reply-channel="" <a name="CO39-12" href="#CO39-12"></a><span><img src="images/callouts/12.png" alt="12" border="0"></span>
    reply-destination="" <a name="CO39-13" href="#CO39-13"></a><span><img src="images/callouts/13.png" alt="13" border="0"></span>
    reply-destination-expression="" <a name="CO39-14" href="#CO39-14"></a><span><img src="images/callouts/14.png" alt="14" border="0"></span>
    reply-destination-name="" <a name="CO39-15" href="#CO39-15"></a><span><img src="images/callouts/15.png" alt="15" border="0"></span>
    reply-pub-sub-domain="" <a name="CO39-16" href="#CO39-16"></a>(16)
    reply-timeout="" <a name="CO39-17" href="#CO39-17"></a>(17)
    request-channel="" <a name="CO39-18" href="#CO39-18"></a>(18)
    request-destination="" <a name="CO39-19" href="#CO39-19"></a>(19)
    request-destination-expression="" <a name="CO39-20" href="#CO39-20"></a>(20)
    request-destination-name="" <a name="CO39-21" href="#CO39-21"></a>(21)
    request-pub-sub-domain="" <a name="CO39-22" href="#CO39-22"></a>(22)
    time-to-live="" <a name="CO39-23" href="#CO39-23"></a>(23)
    requires-reply="" <a name="CO39-24" href="#CO39-24"></a>(24)
    idle-reply-listener-timeout="" <a name="CO39-25" href="#CO39-25"></a>(25)
    async=""&gt; <a name="CO39-26" href="#CO39-26"></a>(26)
  <span class="hl-tag">&lt;int-jms:reply-listener /&gt;</span> <a name="CO39-27" href="#CO39-27"></a>(27)
<span class="hl-tag">&lt;/int-jms:outbound-gateway&gt;</span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO39-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Reference to a <code class="literal">javax.jms.ConnectionFactory</code>; default <code class="literal">connectionFactory</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO39-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The name of a property that will contain correlation data to correlate responses with replies.
If omitted, the gateway will expect the responding system to return the value of the outbound JMSMessageID header in the JMSCorrelationID header.
If specified, the gateway will generate a correlation id and populate the specified property with it; the responding system must echo back that value in the same property.
Can be set to <code class="literal">JMSCorrelationID</code>, in which case the standard header is used instead of a simple String property to hold the correlation data.
When a <code class="literal">&lt;reply-container/&gt;</code> is used, the correlation-key MUST be specified if an explicit <code class="literal">reply-destination</code> is provided.
Starting with <span class="emphasis"><em>version 4.0.1</em></span> this attribute also supports the value <code class="literal">JMSCorrelationID*</code>, which means that if the outbound message already has a <code class="literal">JMSCorrelationID</code> (mapped from the <code class="literal">jms_correlationId</code>) header, it will be used, instead of generating a new one.
Note, the <code class="literal">JMSCorrelationID*</code> key is not allowed when using a <code class="literal">&lt;reply-container/&gt;</code> because the container needs to set up a message selector during initialization.IMPORTANT: You should understand that the gateway has no means to ensure uniqueness and unexpected side effects can occur if the provided correlation id is not unique.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO39-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A boolean value indicating whether the delivery mode should be DeliveryMode.PERSISTENT (true) or DeliveryMode.NON_PERSISTENT (false).
This setting will only take effect if <code class="literal">explicit-qos-enabled</code> is <code class="literal">true</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO39-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A <code class="literal">DestinationResolver</code>; default is a <code class="literal">DynamicDestinationResolver</code> which simply maps the destination name to a queue or topic of that name.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO39-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>When set to <code class="literal">true</code>, enables the use of quality of service attributes - <code class="literal">priority</code>, <code class="literal">delivery-mode</code>, <code class="literal">time-to-live</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO39-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>When set to <code class="literal">true</code> (default), the payload of the Spring Integration reply Message will be created from the JMS Reply Message&#8217;s body (using the <code class="literal">MessageConverter</code>).
When set to <code class="literal">false</code>, the entire JMS Message will become the payload of the Spring Integration Message.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO39-7"><span><img src="images/callouts/7.png" alt="7" border="0"></span></a> </p></td><td valign="top" align="left">
<p>When set to <code class="literal">true</code> (default), the payload of the Spring Integration Message will be converted to a JMSMessage (using the <code class="literal">MessageConverter</code>).
When set to <code class="literal">false</code>, the entire Spring Integration Message will be converted to the the JMSMessage.
In both cases, the Spring Integration Message Headers are mapped to JMS headers and properties using the HeaderMapper.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO39-8"><span><img src="images/callouts/8.png" alt="8" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A <code class="literal">HeaderMapper</code> used to map Spring Integration Message Headers to/from JMS Message Headers/Properties.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO39-9"><span><img src="images/callouts/9.png" alt="9" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A reference to a <code class="literal">MessageConverter</code> for converting between JMS Messages and the Spring Integration Message payloads (or messages if <code class="literal">extract-request-payload</code> is <code class="literal">false</code>).
Default is a <code class="literal">SimpleMessageConverter</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO39-10"><span><img src="images/callouts/10.png" alt="10" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The default priority of request messages.
Overridden by the message priority header, if present; range 0-9.
This setting will only take effect if <code class="literal">explicit-qos-enabled</code> is <code class="literal">true</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO39-11"><span><img src="images/callouts/11.png" alt="11" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The time (in millseconds) to wait for a reply.
Default 5 seconds.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO39-12"><span><img src="images/callouts/12.png" alt="12" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The channel to which the reply message will be sent.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO39-13"><span><img src="images/callouts/13.png" alt="13" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A reference to a <code class="literal">Destination</code> which will be set as the JMSReplyTo header.
At most, only one of <code class="literal">reply-destination</code>, <code class="literal">reply-destination-expression</code>, or <code class="literal">reply-destination-name</code> is allowed.
If none is provided, a <code class="literal">TemporaryQueue</code> is used for replies to this gateway.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO39-14"><span><img src="images/callouts/14.png" alt="14" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A SpEL expression evaluating to a <code class="literal">Destination</code> which will be set as the JMSReplyTo header.
The expression can result in a <code class="literal">Destination</code> object, or a <code class="literal">String</code>, which will be used by the <code class="literal">DestinationResolver</code> to resolve the actual <code class="literal">Destination</code>.
At most, only one of <code class="literal">reply-destination</code>, <code class="literal">reply-destination-expression</code>, or <code class="literal">reply-destination-name</code> is allowed.
If none is provided, a <code class="literal">TemporaryQueue</code> is used for replies to this gateway.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO39-15"><span><img src="images/callouts/15.png" alt="15" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The name of the destination which will be set as the JMSReplyTo header; used by the <code class="literal">DestinationResolver</code> to resolve the actual <code class="literal">Destination</code>.
At most, only one of <code class="literal">reply-destination</code>, <code class="literal">reply-destination-expression</code>, or <code class="literal">reply-destination-name</code> is allowed.
If none is provided, a <code class="literal">TemporaryQueue</code> is used for replies to this gateway.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO39-16">(16)</a> </p></td><td valign="top" align="left">
<p>When set to <code class="literal">true</code>, indicates that any reply <code class="literal">Destination</code> resolved by the <code class="literal">DestinationResolver</code> should be a <code class="literal">Topic</code> rather then a <code class="literal">Queue</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO39-17">(17)</a> </p></td><td valign="top" align="left">
<p>The time the gateway will wait when sending the reply message to the <code class="literal">reply-channel</code>.
This only has an effect if the <code class="literal">reply-channel</code> can block - such as a <code class="literal">QueueChannel</code> with a capacity limit that is currently full.
Default: infinity.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO39-18">(18)</a> </p></td><td valign="top" align="left">
<p>The channel on which this gateway receives request messages.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO39-19">(19)</a> </p></td><td valign="top" align="left">
<p>A reference to a <code class="literal">Destination</code> to which request messages will be sent.
One, and only one, of <code class="literal">reply-destination</code>, <code class="literal">reply-destination-expression</code>, or <code class="literal">reply-destination-name</code> is required.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO39-20">(20)</a> </p></td><td valign="top" align="left">
<p>A SpEL expression evaluating to a <code class="literal">Destination</code> to which request messages will be sent.
The expression can result in a <code class="literal">Destination</code> object, or a <code class="literal">String</code>, which will be used by the <code class="literal">DestinationResolver</code> to resolve the actual <code class="literal">Destination</code>.
One, and only one, of <code class="literal">reply-destination</code>, <code class="literal">reply-destination-expression</code>, or <code class="literal">reply-destination-name</code> is required.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO39-21">(21)</a> </p></td><td valign="top" align="left">
<p>The name of the destination to which request messages will be sent; used by the <code class="literal">DestinationResolver</code> to resolve the actual <code class="literal">Destination</code>.
One, and only one, of <code class="literal">reply-destination</code>, <code class="literal">reply-destination-expression</code>, or <code class="literal">reply-destination-name</code> is required.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO39-22">(22)</a> </p></td><td valign="top" align="left">
<p>When set to <code class="literal">true</code>, indicates that any request <code class="literal">Destination</code> resolved by the <code class="literal">DestinationResolver</code> should be a <code class="literal">Topic</code> rather then a <code class="literal">Queue</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO39-23">(23)</a> </p></td><td valign="top" align="left">
<p>Specify the message time to live.
This setting will only take effect if <code class="literal">explicit-qos-enabled</code> is <code class="literal">true</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO39-24">(24)</a> </p></td><td valign="top" align="left">
<p>Specify whether this outbound gateway must return a non-null value.
This value is <code class="literal">true</code> by default, and a <code class="literal">MessageTimeoutException</code> will be thrown when the underlying service does not return a value after the <code class="literal">receive-timeout</code>.
Note, it is important to keep in mind that, if the service is never expected to return a reply, it would be better to use a <code class="literal">&lt;int-jms:outbound-channel-adapter/&gt;</code> instead of a <code class="literal">&lt;int-jms:outbound-gateway/&gt;</code> with <code class="literal">requires-reply="false"</code>.
With the latter, the sending thread is blocked, waiting for a reply for the <code class="literal">receive-timeout</code> period.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO39-25">(25)</a> </p></td><td valign="top" align="left">
<p>When a <code class="literal">&lt;reply-listener /&gt;</code> is used, it&#8217;s lifecycle (start/stop) matches that of the gateway by default.
When this value is greater than <code class="literal">0</code>, the container is started on demand (when a request is sent).
The container continues to run until at least this time elapses with no requests being received (and no replies
are outstanding).
The container will be started again on the next request.
The stop time is a minimum and may actually be up to 1.5x this value.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO39-26">(26)</a> </p></td><td valign="top" align="left">
<p>See <a class="xref" href="#jms-async-gateway" title="20.5.2&nbsp;Async Gateway">Section&nbsp;20.5.2, &#8220;Async Gateway&#8221;</a>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO39-27">(27)</a> </p></td><td valign="top" align="left">
<p>When this element is included, replies are received by an asynchronous <code class="literal">MessageListenerContainer</code> rather than
creating a consumer for each reply.
This can be more efficient in many cases.</p>
</td></tr></table></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jms-header-mapping" href="#jms-header-mapping"></a>20.6&nbsp;Mapping Message Headers to/from JMS Message</h2></div></div></div>

<p>JMS Message can contain meta-information such as JMS API headers as well as simple properties.
You can map those to/from Spring Integration Message Headers using <code class="literal">JmsHeaderMapper</code>.
The JMS API headers are passed to the appropriate setter methods (e.g.
setJMSReplyTo) whereas other headers will be copied to the general properties of the JMS Message.
JMS Outbound Gateway is bootstrapped with the default implementation of <code class="literal">JmsHeaderMapper</code> which will map standard JMS API Headers as well as primitive/String Message Headers.
Custom header mapper could also be provided via <code class="literal">header-mapper</code> attribute of inbound and outbound gateways.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Since <span class="emphasis"><em>version 4.0</em></span>, the <code class="literal">JMSPriority</code> header is mapped to the standard <code class="literal">priority</code> header for inbound messages (previously, the <code class="literal">priority</code> header was only used for outbound messages).
To revert to the previous behavior (do not map inbound priority), use the <code class="literal">mapInboundPriority</code> property of <code class="literal">DefaultJmsHeaderMapper</code> with argument set to <code class="literal">false</code>.</p>
</td></tr></table></div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Since <span class="emphasis"><em>version 4.3</em></span>, the <code class="literal">DefaultJmsHeaderMapper</code> now maps the standard <code class="literal">correlationId</code> header as a message
property by invoking its <code class="literal">toString()</code> method (<code class="literal">correlationId</code> is often a <code class="literal">UUID</code>, which is not a type that is supported
by JMS).
On the inbound side, it is mapped as a <code class="literal">String</code>.
This is independent of the <code class="literal">jms_correlationId</code> header which is mapped to/from the <code class="literal">JMSCorrelationID</code> header.
The <code class="literal">JMSCorrelationID</code> is generally used to correlate requests and replies whereas the <code class="literal">correlationId</code> is often used
to combine related messages into a group (such as with an aggregator or resequencer).</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jms-conversion-and-marshalling" href="#jms-conversion-and-marshalling"></a>20.7&nbsp;Message Conversion, Marshalling and Unmarshalling</h2></div></div></div>

<p>If you need to convert the message, all JMS adapters and gateways, allow you to provide a <code class="literal">MessageConverter</code> via <span class="emphasis"><em>message-converter</em></span> attribute.
Simply provide the bean name of an instance of <code class="literal">MessageConverter</code> that is available within the same ApplicationContext.
Also, to provide some consistency with Marshaller and Unmarshaller interfaces Spring provides <code class="literal">MarshallingMessageConverter</code> which you can configure with your own custom Marshallers and Unmarshallers</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-jms:inbound-gateway</span> <span class="hl-attribute">request-destination</span>=<span class="hl-value">"requestQueue"</span>
    <span class="hl-attribute">request-channel</span>=<span class="hl-value">"inbound-gateway-channel"</span>
    <span class="hl-attribute">message-converter</span>=<span class="hl-value">"marshallingMessageConverter"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"marshallingMessageConverter"</span>
    <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jms.support.converter.MarshallingMessageConverter"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.bar.SampleMarshaller"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/constructor-arg&gt;</span>
    <span class="hl-tag">&lt;constructor-arg&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.bar.SampleUnmarshaller"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/constructor-arg&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Note, however, that when you provide your own MessageConverter instance, it will still be wrapped within the HeaderMappingMessageConverter.
This means that the <span class="emphasis"><em>extract-request-payload</em></span> and <span class="emphasis"><em>extract-reply-payload</em></span> properties may affect what actual objects are passed to your converter.
The HeaderMappingMessageConverter itself simply delegates to a target MessageConverter while also mapping the Spring Integration MessageHeaders to JMS Message properties and vice-versa.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jms-channel" href="#jms-channel"></a>20.8&nbsp;JMS Backed Message Channels</h2></div></div></div>

<p>The Channel Adapters and Gateways featured above are all intended for applications that are integrating with other external systems.
The inbound options assume that some other system is sending JMS Messages to the JMS Destination and the outbound options assume that some other system is receiving from the Destination.
The other system may or may not be a Spring Integration application.
Of course, when sending the Spring Integration Message instance as the body of the JMS Message itself (with the <span class="emphasis"><em>extract-payload</em></span> value set to false), it is assumed that the other system is based on Spring Integration.
However, that is by no means a requirement.
That flexibility is one of the benefits of using a Message-based integration option with the abstraction of "channels" or Destinations in the case of JMS.</p>
<p>There are cases where both the producer and consumer for a given JMS Destination are intended to be part of the same application, running within the same process.
This could be accomplished by using a pair of inbound and outbound Channel Adapters.
The problem with that approach is that two adapters are required even though conceptually the goal is to have a single Message Channel.
A better option is supported as of Spring Integration version 2.0.
Now it is possible to define a single "channel" when using the JMS namespace.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-jms:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"jmsChannel"</span> <span class="hl-attribute">queue</span>=<span class="hl-value">"exampleQueue"</span><span class="hl-tag">/&gt;</span></pre>
<p>The channel in the above example will behave much like a normal &lt;channel/&gt; element from the main Spring Integration namespace.
It can be referenced by both "input-channel" and "output-channel" attributes of any endpoint.
The difference is that this channel is backed by a JMS Queue instance named "exampleQueue".
This means that asynchronous messaging is possible between the producing and consuming endpoints, but unlike the simpler asynchronous Message Channels created by adding a &lt;queue/&gt; sub-element within a non-JMS &lt;channel/&gt; element, the Messages are not just stored in an in-memory queue.
Instead those Messages are passed within a JMS Message body, and the full power of the underlying JMS provider is then available for that channel.
Probably the most common rationale for using this alternative would be to take advantage of the persistence made available by the <span class="emphasis"><em>store and forward</em></span> approach of JMS messaging.
If configured properly, the JMS-backed Message Channel also supports transactions.
In other words, a producer would not actually write to a transactional JMS-backed channel if its send operation is part of a transaction that rolls back.
Likewise, a consumer would not physically remove a JMS Message from the channel if the reception of that Message is part of a transaction that rolls back.
Note that the producer and consumer transactions are separate in such a scenario.
This is significantly different than the propagation of a transactional context across the simple, synchronous &lt;channel/&gt; element that has no &lt;queue/&gt; sub-element.</p>
<p>Since the example above is referencing a JMS Queue instance, it will act as a point-to-point channel.
If on the other hand, publish/subscribe behavior is needed, then a separate element can be used, and a JMS Topic can be referenced instead.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-jms:publish-subscribe-channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"jmsChannel"</span> <span class="hl-attribute">topic</span>=<span class="hl-value">"exampleTopic"</span><span class="hl-tag">/&gt;</span></pre>
<p>For either type of JMS-backed channel, the name of the destination may be provided instead of a reference.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-jms:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"jmsQueueChannel"</span> <span class="hl-attribute">queue-name</span>=<span class="hl-value">"exampleQueueName"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;jms:publish-subscribe-channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"jmsTopicChannel"</span> <span class="hl-attribute">topic-name</span>=<span class="hl-value">"exampleTopicName"</span><span class="hl-tag">/&gt;</span></pre>
<p>In the examples above, the Destination names would be resolved by Spring&#8217;s default <code class="literal">DynamicDestinationResolver</code> implementation, but any implementation of the <code class="literal">DestinationResolver</code> interface could be provided.
Also, the JMS <code class="literal">ConnectionFactory</code> is a required property of the channel, but by default the expected bean name would be "connectionFactory".
The example below provides both a custom instance for resolution of the JMS Destination names and a different name for the ConnectionFactory.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-jms:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"jmsChannel"</span> <span class="hl-attribute">queue-name</span>=<span class="hl-value">"exampleQueueName"</span>
    <span class="hl-attribute">destination-resolver</span>=<span class="hl-value">"customDestinationResolver"</span>
    <span class="hl-attribute">connection-factory</span>=<span class="hl-value">"customConnectionFactory"</span><span class="hl-tag">/&gt;</span></pre>
<p>For the <code class="literal">&lt;publish-subscribe-channel /&gt;</code>; set the <code class="literal">durable</code> attribute to true
for a durable subscription, <code class="literal">subscription-shared</code> for a shared subscription (requires a JMS 2.0 broker and
has been available since <span class="emphasis"><em>version 4.2</em></span>).
Use <code class="literal">subscription</code> to name the subscription.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jms-selectors" href="#jms-selectors"></a>20.9&nbsp;Using JMS Message Selectors</h2></div></div></div>

<p>With JMS message selectors you can filter <a class="ulink" href="http://docs.oracle.com/javaee/6/api/javax/jms/Message.html" target="_top">JMS Messages</a> based on JMS headers as well as JMS properties.
For example, if you want to listen to messages whose custom JMS header property <span class="emphasis"><em>fooHeaderProperty</em></span> equals <span class="emphasis"><em>bar</em></span>, you can specify the following expression:</p>
<pre class="programlisting">fooHeaderProperty = 'bar'</pre>
<p>Message selector expressions are a subset of the <a class="ulink" href="http://en.wikipedia.org/wiki/SQL-92" target="_top">SQL-92</a> conditional expression syntax, and are defined as part of the <span class="emphasis"><em><a class="ulink" href="http://download.oracle.com/otn-pub/jcp/7195-jms-1.1-fr-spec-oth-JSpec/jms-1_1-fr-spec.pdf" target="_top">Java Message Service</a></em></span> specification (Version 1.1 April 12, 2002).
Specifically, please see chapter "3.8 Message Selection".
It contains a detailed explanation of the expressions syntax.</p>
<p>You can specify the JMS message <span class="emphasis"><em>selector</em></span> attribute using XML Namespace configuration for the following Spring Integration JMS components:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
JMS Channel
</li><li class="listitem">
JMS Publish Subscribe Channel
</li><li class="listitem">
JMS Inbound Channel Adapter
</li><li class="listitem">
JMS Inbound Gateway
</li><li class="listitem">
JMS Message-driven Channel Adapter
</li></ul></div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>It is important to remember that you cannot reference message body values using JMS Message selectors.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jms-samples" href="#jms-samples"></a>20.10&nbsp;JMS Samples</h2></div></div></div>

<p>To experiment with these JMS adapters, check out the JMS samples available in the <span class="emphasis"><em>Spring Integration Samples</em></span> Git repository:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="ulink" href="https://github.com/SpringSource/spring-integration-samples/tree/master/basic/jms" target="_top">https://github.com/SpringSource/spring-integration-samples/tree/master/basic/jms</a>
</li></ul></div>
<p>There are two samples included.
One provides <span class="emphasis"><em>Inbound</em></span> and <span class="emphasis"><em>Outbound Channel Adapters</em></span>, and the other provides <span class="emphasis"><em>Inbound</em></span> and <span class="emphasis"><em>Outbound Gateways</em></span>.
They are configured to run with an embedded_http://activemq.apache.org/[ActiveMQ]_ process, but the samples' <span class="emphasis"><em><a class="ulink" href="https://github.com/SpringSource/spring-integration-samples/blob/master/basic/jms/src/main/resources/META-INF/spring/integration/common.xml" target="_top">common.xml</a>__Spring Application Context</em></span> file can easily be modified to support either a different JMS provider or a standalone <span class="emphasis"><em>ActiveMQ</em></span> process.</p>
<p>In other words, you can split the configuration, so that the Inbound and Outbound Adapters are running in separate JVMs.
If you have <span class="emphasis"><em>ActiveMQ</em></span> installed, simply modify the <span class="emphasis"><em>brokerURL</em></span> property within the <span class="emphasis"><em>common.xml</em></span> file to use <span class="emphasis"><em>tcp://localhost:61616</em></span> (instead of <span class="emphasis"><em>vm://localhost</em></span>).
Both of the samples accept input via stdin and then echo back to stdout.
Look at the configuration to see how these messages are routed over JMS.</p>
</div>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="mail" href="#mail"></a>21.&nbsp;Mail Support</h2></div></div></div>

<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="mail-outbound" href="#mail-outbound"></a>21.1&nbsp;Mail-Sending Channel Adapter</h2></div></div></div>

<p>Spring Integration provides support for outbound email with the <code class="literal">MailSendingMessageHandler</code>.
It delegates to a configured instance of Spring&#8217;s <code class="literal">JavaMailSender</code>:</p>
<pre class="programlisting"> JavaMailSender mailSender = context.getBean(<span class="hl-string">"mailSender"</span>, JavaMailSender.<span class="hl-keyword">class</span>);

 MailSendingMessageHandler mailSendingHandler = <span class="hl-keyword">new</span> MailSendingMessageHandler(mailSender);</pre>
<p><code class="literal">MailSendingMessageHandler</code> has various mapping strategies that use Spring&#8217;s <code class="literal">MailMessage</code> abstraction.
If the received Message&#8217;s payload is already a <code class="literal">MailMessage</code> instance, it will be sent directly.
Therefore, it is generally recommended to precede this consumer with a Transformer for non-trivial <code class="literal">MailMessage</code> construction requirements.
However, a few simple Message mapping strategies are supported out-of-the-box.
For example, if the message payload is a byte array, then that will be mapped to an attachment.
For simple text-based emails, you can provide a String-based Message payload.
In that case, a MailMessage will be created with that String as the text content.
If you are working with a Message payload type whose <code class="literal">toString()</code> method returns appropriate mail text content, then consider adding Spring Integration&#8217;s <span class="emphasis"><em>ObjectToStringTransformer</em></span> prior to the outbound Mail adapter (see the example within <a class="xref" href="#transformer-namespace" title="Configuring Transformer with XML">the section called &#8220;Configuring Transformer with XML&#8221;</a> for more detail).</p>
<p>The outbound MailMessage may also be configured with certain values from the <code class="literal">MessageHeaders</code>.
If available, values will be mapped to the outbound mail&#8217;s properties, such as the recipients (TO, CC, and BCC), the from/reply-to, and the subject.
The header names are defined by the following constants:</p>
<pre class="programlisting"> MailHeaders.SUBJECT
 MailHeaders.TO
 MailHeaders.CC
 MailHeaders.BCC
 MailHeaders.FROM
 MailHeaders.REPLY_TO</pre>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p><code class="literal">MailHeaders</code> also allows you to override corresponding <code class="literal">MailMessage</code> values.
For example: If <code class="literal">MailMessage.to</code> is set to <span class="emphasis"><em>foo@bar.com</em></span> and <code class="literal">MailHeaders.TO</code> Message header is provided it will take precedence and override the corresponding value in <code class="literal">MailMessage</code>.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="mail-inbound" href="#mail-inbound"></a>21.2&nbsp;Mail-Receiving Channel Adapter</h2></div></div></div>

<p>Spring Integration also provides support for inbound email with the <code class="literal">MailReceivingMessageSource</code>.
It delegates to a configured instance of Spring Integration&#8217;s own <code class="literal">MailReceiver</code> interface, and there are two implementations: <code class="literal">Pop3MailReceiver</code> and <code class="literal">ImapMailReceiver</code>.
The easiest way to instantiate either of these is by passing the <span class="emphasis"><em>uri</em></span> for a Mail store to the receiver&#8217;s constructor.
For example:</p>
<pre class="programlisting">MailReceiver receiver = <span class="hl-keyword">new</span> Pop3MailReceiver(<span class="hl-string">"pop3://usr:pwd@localhost/INBOX"</span>);</pre>
<p>Another option for receiving mail is the IMAP "idle" command (if supported by the mail server you are using).
Spring Integration provides the <code class="literal">ImapIdleChannelAdapter</code> which is itself a Message-producing endpoint.
It delegates to an instance of the <code class="literal">ImapMailReceiver</code> but enables asynchronous reception of Mail Messages.
There are examples in the next section of configuring both types of inbound Channel Adapter with Spring Integration&#8217;s namespace support in the <span class="emphasis"><em>mail</em></span> schema.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="mail-mapping" href="#mail-mapping"></a>21.3&nbsp;Inbound Mail Message Mapping</h2></div></div></div>

<p>By default, the payload of messages produced by the inbound adapters is the raw <code class="literal">MimeMessage</code>; you can interrogate
the headers and content using that object.
Starting with <span class="emphasis"><em>version 4.3</em></span>, you can provide a <code class="literal">HeaderMapper&lt;MimeMessage&gt;</code> to map the headers to <code class="literal">MessageHeaders</code>; for
convenience, a <code class="literal">DefaultMailHeaderMapper</code> is provided for this purpose.
This maps the following headers:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">mail_from</code> - A String representation of the <code class="literal">from</code> address.
</li><li class="listitem">
<code class="literal">mail_bcc</code> - A String array containing the <code class="literal">bcc</code> addresses.
</li><li class="listitem">
<code class="literal">mail_cc</code> - A String array containing the <code class="literal">cc</code> addresses.
</li><li class="listitem">
<code class="literal">mail_to</code> - A String array containing the <code class="literal">to</code> addresses.
</li><li class="listitem">
<code class="literal">mail_replyTo</code> - A String representation of the <code class="literal">replyTo</code> address.
</li><li class="listitem">
<code class="literal">mail_subject</code> - The mail subject.
</li><li class="listitem">
<code class="literal">mail_lineCount</code> - A line count (if available).
</li><li class="listitem">
<code class="literal">mail_receivedDate</code> - The received date (if available).
</li><li class="listitem">
<code class="literal">mail_size</code> - The mail size (if available).
</li><li class="listitem">
<code class="literal">mail_expunged</code> - A boolen indicating if the message is expunged.
</li><li class="listitem">
<code class="literal">mail_raw</code> - A <code class="literal">MultiValueMap</code> containing all the mail headers and their values.
</li><li class="listitem">
<code class="literal">mail_contentType</code> - The content type of the original mail message.
</li><li class="listitem">
<code class="literal">contentType</code> - The payload content type (see below).
</li></ul></div>
<p>When message mapping is enabled, the payload depends on the mail message and its implementation.
Email contents are usually rendered by a <code class="literal">DataHandler</code> within the <code class="literal">MimeMessage</code>.</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
For a simple <code class="literal">text/*</code> email, the payload will be a String and the <code class="literal">contentType</code> header will be the same as
<code class="literal">mail_contentType</code>.
</li><li class="listitem">
For a messages with embedded <code class="literal">javax.mail.Part</code> s, the <code class="literal">DataHandler</code> usually renders a <code class="literal">Part</code> object - these objects
are not <code class="literal">Serializable</code>, and are not suitable for serialization using alternative technologies such as <code class="literal">Kryo</code>.
For this reason, by default, when mapping is enabled, such payloads are rendered as a raw <code class="literal">byte[]</code> containing the
<code class="literal">Part</code> data.
Examples of <code class="literal">Part</code> are <code class="literal">Message</code> and <code class="literal">Multipart</code>.
The <code class="literal">contentType</code> header is <code class="literal">application/octet-stream</code> in this case.
To change this behavior, and receive a <code class="literal">Multipart</code> object payload, set <code class="literal">embeddedPartsAsBytes</code> to <code class="literal">false</code> on the
<code class="literal">MailReceiver</code>.
For content types that are unknown to the <code class="literal">DataHandler</code>, the contents are rendered as a <code class="literal">byte[]</code> with a <code class="literal">contentType</code>
header of <code class="literal">application/octet-stream</code>.
</li></ul></div>
<p>When you do not provide a header mapper, the message payload is the <code class="literal">MimeMessage</code> presented by <code class="literal">javax.mail</code>.
The framework provides a <code class="literal">MailToStringTransformer</code> which can be used to convert the message using a simple strategy
to convert the mail contents to a String.
This is also available using the XML namespace:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-mail:mail-to-string-transformer</span> <span class="hl-attribute">...</span><span class="hl-tag"> &gt;</span></pre>
<p>and with Java configuration:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<em><span class="hl-annotation" style="color: gray">@Transformer(inputChannel="...", outputChannel="...")</span></em>
<span class="hl-keyword">public</span> Transformer transformer() {
    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> MailToStringTransformer();
}</pre>
<p>and with the Java DSL:</p>
<pre class="programlisting">   ...
   .transform(Transformers.fromMail())
   ...</pre>
<p>Starting with <span class="emphasis"><em>version 4.3</em></span>, the transformer will handle embedded <code class="literal">Part</code> as well as <code class="literal">Multipart</code> which was handled
previously.
The transformer is a subclass of <code class="literal">AbstractMailTransformer</code> which maps the address and subject headers from the list
above.
If you wish to perform some other transformation on the message, consider subclassing <code class="literal">AbstractMailTransformer</code>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="mail-namespace" href="#mail-namespace"></a>21.4&nbsp;Mail Namespace Support</h2></div></div></div>

<p>Spring Integration provides a namespace for mail-related configuration.
To use it, configure the following schema locations.</p>
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/schema/beans"</span>
  <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
  <span class="hl-attribute">xmlns:int-mail</span>=<span class="hl-value">"http://www.springframework.org/schema/integration/mail"</span>
  <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"http://www.springframework.org/schema/beans
    http://www.springframework.org/schema/beans/spring-beans.xsd
    http://www.springframework.org/schema/integration/mail
    http://www.springframework.org/schema/integration/mail/spring-integration-mail.xsd"</span><span class="hl-tag">&gt;</span></pre>
<p>To configure an outbound Channel Adapter, provide the channel to receive from, and the MailSender:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-mail:outbound-channel-adapter</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"outboundMail"</span>
    <span class="hl-attribute">mail-sender</span>=<span class="hl-value">"mailSender"</span><span class="hl-tag">/&gt;</span></pre>
<p>Alternatively, provide the host, username, and password:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-mail:outbound-channel-adapter</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"outboundMail"</span>
    <span class="hl-attribute">host</span>=<span class="hl-value">"somehost"</span> <span class="hl-attribute">username</span>=<span class="hl-value">"someuser"</span> <span class="hl-attribute">password</span>=<span class="hl-value">"somepassword"</span><span class="hl-tag">/&gt;</span></pre>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Keep in mind, as with any outbound Channel Adapter, if the referenced channel is a <code class="literal">PollableChannel</code>,
a <code class="literal">&lt;poller&gt;</code> sub-element should be provided (see ).</p>
</td></tr></table></div>
<p>When using the namespace support, a <span class="emphasis"><em>header-enricher</em></span> Message Transformer is also available.
This simplifies the application of the headers mentioned above to any Message prior to sending to the Mail Outbound Channel Adapter.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-mail:header-enricher</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"expressionsInput"</span> <span class="hl-attribute">default-overwrite</span>=<span class="hl-value">"false"</span><span class="hl-tag">&gt;</span>
	<span class="hl-tag">&lt;int-mail:to</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"payload.to"</span><span class="hl-tag">/&gt;</span>
	<span class="hl-tag">&lt;int-mail:cc</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"payload.cc"</span><span class="hl-tag">/&gt;</span>
	<span class="hl-tag">&lt;int-mail:bcc</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"payload.bcc"</span><span class="hl-tag">/&gt;</span>
	<span class="hl-tag">&lt;int-mail:from</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"payload.from"</span><span class="hl-tag">/&gt;</span>
	<span class="hl-tag">&lt;int-mail:reply-to</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"payload.replyTo"</span><span class="hl-tag">/&gt;</span>
	<span class="hl-tag">&lt;int-mail:subject</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"payload.subject"</span> <span class="hl-attribute">overwrite</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-mail:header-enricher&gt;</span></pre>
<p>This example assumes the payload is a JavaBean with appropriate getters for the specified properties, but any SpEL expression can be used.
Alternatively, use the <code class="literal">value</code> attribute to specify a literal.
Notice also that you can specify <code class="literal">default-overwrite</code> and individual <code class="literal">overwrite</code> attributes to control the behavior with existing headers.</p>
<p>To configure an Inbound Channel Adapter, you have the choice between polling or event-driven (assuming your mail server supports IMAP IDLE - if not, then polling is the only option).
A polling Channel Adapter simply requires the store URI and the channel to send inbound Messages to.
The URI may begin with "pop3" or "imap":</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-mail:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"imapAdapter"</span>
      <span class="hl-attribute">store-uri</span>=<span class="hl-value">"imaps://[username]:[password]@imap.gmail.com/INBOX"</span>
      <span class="hl-attribute">java-mail-properties</span>=<span class="hl-value">"javaMailProperties"</span>
      <span class="hl-attribute">channel</span>=<span class="hl-value">"receiveChannel"</span>
      <span class="hl-attribute">should-delete-messages</span>=<span class="hl-value">"true"</span>
      <span class="hl-attribute">should-mark-messages-as-read</span>=<span class="hl-value">"true"</span>
      <span class="hl-attribute">auto-startup</span>=<span class="hl-value">"true"</span><span class="hl-tag">&gt;</span>
      <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">max-messages-per-poll</span>=<span class="hl-value">"1"</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"5000"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-mail:inbound-channel-adapter&gt;</span></pre>
<p>If you do have IMAP idle support, then you may want to configure the "imap-idle-channel-adapter" element instead.
Since the "idle" command enables event-driven notifications, no poller is necessary for this adapter.
It will send a Message to the specified channel as soon as it receives the notification that new mail is available:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-mail:imap-idle-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"customAdapter"</span>
      <span class="hl-attribute">store-uri</span>=<span class="hl-value">"imaps://[username]:[password]@imap.gmail.com/INBOX"</span>
      <span class="hl-attribute">channel</span>=<span class="hl-value">"receiveChannel"</span>
      <span class="hl-attribute">auto-startup</span>=<span class="hl-value">"true"</span>
      <span class="hl-attribute">should-delete-messages</span>=<span class="hl-value">"false"</span>
      <span class="hl-attribute">should-mark-messages-as-read</span>=<span class="hl-value">"true"</span>
      <span class="hl-attribute">java-mail-properties</span>=<span class="hl-value">"javaMailProperties"</span><span class="hl-tag">/&gt;</span></pre>
<p>...where <span class="emphasis"><em>javaMailProperties</em></span> could be provided by creating and populating a regular <code class="literal">java.utils.Properties</code> object.
For example via <span class="emphasis"><em>util</em></span> namespace provided by Spring.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>If your username contains the <span class="emphasis"><em>@</em></span> character use <span class="emphasis"><em>%40</em></span> instead of <span class="emphasis"><em>@</em></span> to avoid parsing errors from the underlying JavaMail API.</p>
</td></tr></table></div>
<pre class="programlisting"><span class="hl-tag">&lt;util:properties</span> <span class="hl-attribute">id</span>=<span class="hl-value">"javaMailProperties"</span><span class="hl-tag">&gt;</span>
  <span class="hl-tag">&lt;prop</span> <span class="hl-attribute">key</span>=<span class="hl-value">"mail.imap.socketFactory.class"</span><span class="hl-tag">&gt;</span>javax.net.ssl.SSLSocketFactory<span class="hl-tag">&lt;/prop&gt;</span>
  <span class="hl-tag">&lt;prop</span> <span class="hl-attribute">key</span>=<span class="hl-value">"mail.imap.socketFactory.fallback"</span><span class="hl-tag">&gt;</span>false<span class="hl-tag">&lt;/prop&gt;</span>
  <span class="hl-tag">&lt;prop</span> <span class="hl-attribute">key</span>=<span class="hl-value">"mail.store.protocol"</span><span class="hl-tag">&gt;</span>imaps<span class="hl-tag">&lt;/prop&gt;</span>
  <span class="hl-tag">&lt;prop</span> <span class="hl-attribute">key</span>=<span class="hl-value">"mail.debug"</span><span class="hl-tag">&gt;</span>false<span class="hl-tag">&lt;/prop&gt;</span>
<span class="hl-tag">&lt;/util:properties&gt;</span></pre>
<p><a name="search-term" href="#search-term"></a>By default, the <code class="literal">ImapMailReceiver</code> will search for Messages based on the default <code class="literal">SearchTerm</code> which is <span class="emphasis"><em>All mails that
are RECENT (if supported), that are NOT ANSWERED, that are NOT DELETED, that are NOT SEEN and have not
been processed by this mail receiver (enabled by the use of the custom USER flag or simply NOT FLAGGED if not
supported)</em></span>.
The custom user flag is <code class="literal">spring-integration-mail-adapter</code> but can be configured.
Since version 2.2, the <code class="literal">SearchTerm</code> used by the <code class="literal">ImapMailReceiver</code> is fully configurable via the <code class="literal">SearchTermStrategy</code>
which you can inject via the <code class="literal">search-term-strategy</code> attribute.
<code class="literal">SearchTermStrategy</code> is a simple strategy interface with a single method that allows you to create an instance of the
<code class="literal">SearchTerm</code> that will be used by the <code class="literal">ImapMailReceiver</code>.</p>
<p>See <a class="xref" href="#imap-seen" title="21.5&nbsp;Marking IMAP Messages When \Recent is Not Supported">Section&nbsp;21.5, &#8220;Marking IMAP Messages When \Recent is Not Supported&#8221;</a> regarding message flagging.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> SearchTermStrategy {

    SearchTerm generateSearchTerm(Flags supportedFlags, Folder folder);

}</pre>
<p>For example:</p>
<pre class="programlisting"><span class="hl-tag">&lt;mail:imap-idle-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"customAdapter"</span>
			<span class="hl-attribute">store-uri</span>=<span class="hl-value">"imap:foo"</span>
			<span class="hl-attribute">&#8230;</span>
			<span class="hl-attribute">search-term-strategy</span>=<span class="hl-value">"searchTermStrategy"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"searchTermStrategy"</span>
  <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.mail.config.ImapIdleChannelAdapterParserTests.TestSearchTermStrategy"</span><span class="hl-tag">/&gt;</span></pre>
<p>In the above example instead of relying on the default <code class="literal">SearchTermStrategy</code> the <code class="literal">TestSearchTermStrategy</code> will be used instead</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important: Important: IMAP PEEK"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left"><a name="imap-peek" href="#imap-peek"></a>Important: IMAP PEEK</th></tr><tr><td align="left" valign="top">

<p>Starting with <span class="emphasis"><em>version 4.1.1</em></span>, the IMAP mail receiver will use the <code class="literal">mail.imap.peek</code> or <code class="literal">mail.imaps.peek</code> javamail property, if specified.
Previously, the receiver ignored the property and always set the PEEK flag.
Now, if you explicitly set this property to <code class="literal">false</code>, the message will be marked as <code class="literal">\Seen</code> regardless of the setting of <code class="literal">shouldMarkMessagesRead</code>.
If not specified, the previous behavior is retained (peek is <code class="literal">true</code>).</p>
</td></tr></table></div>
<p><span class="strong"><strong>IMAP IDLE and lost connection</strong></span></p>
<p>When using IMAP IDLE channel adapter there might be situations where connection to the server may be lost (e.g., network failure) and since Java Mail documentation explicitly states that the actual IMAP API is EXPERIMENTAL it is important to understand the differences in the API and how to deal with them when configuring IMAP IDLE adapters.
Currently Spring Integration Mail adapters was tested with Java Mail 1.4.1 and Java Mail 1.4.3 and depending on which one is used special attention must be payed to some of the java mail properties that needs to be set with regard to auto-reconnect.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The following behavior was observed with GMAIL but should provide you with some tips on how to solve re-connect
issue with other providers, however feedback is always welcome.
Again, below notes are based on GMAIL.</p>
</td></tr></table></div>
<p>With Java Mail 1.4.1 if <code class="literal">mail.imaps.timeout</code> property is set for a relatively short period of time (e.g., ~ 5 min) then <code class="literal">IMAPFolder.idle()</code> will throw <code class="literal">FolderClosedException</code> after this timeout.
However if this property is not set (should be indefinite) the behavior that was observed is that <code class="literal">IMAPFolder.idle()</code> method never returns nor it throws an exception.
It will however reconnect automatically if connection was lost for a short period of time (e.g., under 10 min), but if connection was lost for a long period of time (e.g., over 10 min), then`IMAPFolder.idle()` will not throw <code class="literal">FolderClosedException</code> nor it will re-establish connection and will remain in the blocked state indefinitely, thus leaving you no possibility to reconnect without restarting the adapter.
So the only way to make re-connect to work with Java Mail 1.4.1 is to set <code class="literal">mail.imaps.timeout</code> property explicitly to some value, but it also means that such value should be relatively short (under 10 min) and the connection should be re-established relatively quickly.
Again, it may be different with other providers.
With Java Mail 1.4.3 there was significant improvements to the API ensuring that there will always be a condition which will force <code class="literal">IMAPFolder.idle()</code> method to return via <code class="literal">StoreClosedException</code> or <code class="literal">FolderClosedException</code> or simply return, thus allowing us to proceed with auto-reconnect.
Currently auto-reconnect will run infinitely making attempts to reconnect every 10 sec.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>In both configurations <code class="literal">channel</code> and <code class="literal">should-delete-messages</code> are the <span class="emphasis"><em>REQUIRED</em></span> attributes.
The important thing to understand is why <code class="literal">should-delete-messages</code> is required.
The issue is with the POP3 protocol, which does NOT have any knowledge of messages that were READ.
It can only know what&#8217;s been read within a single session.
This means that when your POP3 mail adapter is running, emails are successfully consumed as as they become available during each poll
and no single email message will be delivered more then once.
However, as soon as you restart your adapter and begin a new session all the email messages that might have been retrieved in the previous session will be retrieved again.
That is the nature of POP3.
Some might argue that <code class="literal">should-delete-messages</code> should be TRUE by default.
In other words, there are two valid and mutually exclusive use cases&nbsp;which make it very hard to pick a single "best" default.
You may want to configure your adapter as the only email receiver in which case you want to be able to restart such adapter without fear that messages that were delivered before will not be redelivered again.
In this case setting <code class="literal">should-delete-messages</code> to TRUE would make most sense.
However, you may have another use case where you may want to have multiple adapters that simply monitor email servers and their content.
In other words you just want to <span class="emphasis"><em>peek but not touch</em></span>.
Then setting <code class="literal">should-delete-messages</code> to FALSE would be much more appropriate.
So since it is hard to choose what should be the right default value for the <code class="literal">should-delete-messages</code> attribute, we simply made it a required attribute, to be set by the user.
Leaving it up to the user also means, you will be less likely to end up with unintended behavior.</p>
</td></tr></table></div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>When configuring a polling email adapter&#8217;s <span class="emphasis"><em>should-mark-messages-as-read</em></span> attribute, be aware of the protocol you are configuring to retrieve messages.
For example POP3 does not support this flag which means setting it to either value will have no effect as messages will NOT be marked as read.</p>
</td></tr></table></div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>It is important to understand that that these actions (marking messages read, and deleting messages) are performed after the messages are received, but before they are processed.
This can cause messages to be lost.</p>
<p>You may wish to consider using transaction synchronization instead - see <a class="xref" href="#mail-tx-sync" title="21.7&nbsp;Transaction Synchronization">Section&nbsp;21.7, &#8220;Transaction Synchronization&#8221;</a></p>
</td></tr></table></div>
<p>The <code class="literal">&lt;imap-idle-channel-adapter/&gt;</code> also accepts the <span class="emphasis"><em>error-channel</em></span> attribute.
If a downstream exception is thrown and an <span class="emphasis"><em>error-channel</em></span> is specified, a MessagingException message containing the failed message and original exception, will be sent to this channel.
Otherwise, if the downstream channels are synchronous, any such exception will simply be logged as a warning by the channel adapter.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Beginning with the 3.0 release, the IMAP idle adapter emits application events (specifically <code class="literal">ImapIdleExceptionEvent</code> s) when exceptions occur.
This allows applications to detect and act on those exceptions.
The events can be obtained using an <code class="literal">&lt;int-event:inbound-channel-adapter&gt;</code> or any <code class="literal">ApplicationListener</code> configured to receive an <code class="literal">ImapIdleExceptionEvent</code> or one of its super classes.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="imap-seen" href="#imap-seen"></a>21.5&nbsp;Marking IMAP Messages When \Recent is Not Supported</h2></div></div></div>

<p>If <code class="literal">shouldMarkMessagesAsRead</code> is true, the IMAP adapters set the <code class="literal">\Seen</code> flag.</p>
<p>In addition, when an email server does not support the <code class="literal">\Recent</code> flag, the IMAP adapters mark messages with a user
flag (<code class="literal">spring-integration-mail-adapter</code> by default) as long as the server supports user flags.
If not, <code class="literal">Flag.FLAGGED</code> is set to <code class="literal">true</code>.
These flags are applied regardless of the <code class="literal">shouldMarkMessagesRead</code> setting.</p>
<p>As discussed in <a class="xref" href="#search-term">Section&nbsp;21.4, &#8220;Mail Namespace Support&#8221;</a>, the default <code class="literal">SearchTermStrategy</code> will ignore messages so flagged.</p>
<p>Starting with <span class="emphasis"><em>version 4.2.2</em></span>, the name of the user flag can be set using <code class="literal">setUserFlag</code> on the <code class="literal">MailReceiver</code> - this
allows multiple receivers to use a different flag (as long as the mail server supports user flags).
The attribute <code class="literal">user-flag</code> is available when configuring the adapter with the namespace.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="mail-filtering" href="#mail-filtering"></a>21.6&nbsp;Email Message Filtering</h2></div></div></div>

<p>Very often you may encounter a requirement to filter incoming messages (e.g., You want to only read emails that have <span class="emphasis"><em>Spring Integration</em></span> in the <span class="emphasis"><em>Subject</em></span> line).
This could be easily accomplished by connecting Inbound Mail adapter with an expression-based <span class="emphasis"><em>Filter</em></span>.
Although it would work, there is a downside to this approach.
Since messages would be filtered after going through inbound mail adapter all such messages would be marked as read (SEEN) or Un-read (depending on the value of <code class="literal">should-mark-messages-as-read</code> attribute).
However in reality what would be more useful is to mark messages as SEEN only if they passed the filtering criteria.
This is very similar to looking at your email client while scrolling through all the messages in the preview pane, but only flagging messages as SEEN that were actually opened and read.</p>
<p>In Spring Integration 2.0.4 we&#8217;ve introduced <code class="literal">mail-filter-expression</code> attribute on <code class="literal">inbound-channel-adapter</code> and <code class="literal">imap-idle-channel-adapter</code>.
This attribute allows you to provide an expression which is a combination of SpEL and Regular Expression.
For example if you would like to read only emails that contain <span class="emphasis"><em>Spring Integration</em></span> in the Subject line, you would configure <code class="literal">mail-filter-expression</code> attribute like this this: <code class="literal">mail-filter-expression="subject matches '(?i).*Spring Integration.*"</code></p>
<p>Since <code class="literal">javax.mail.internet.MimeMessage</code> is the root context of SpEL Evaluation Context, you can filter on any value available through MimeMessage including the actual body of the message.
This one is particularly important since reading the body of the message would typically result in such message to be marked as SEEN by default, but since we now setting PEAK flag of every incomming message to <span class="emphasis"><em>true</em></span>, only messages that were explicitly marked as SEEN will be seen as read.</p>
<p>So in the below example only messages that match the filter expression will be output by this adapter and only those messages will be marked as SEEN.
In this case based on the <code class="literal">mail-filter-expression</code> only messages that contain <span class="emphasis"><em>Spring Integration</em></span> in the subject line will be produced by this adapter.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-mail:imap-idle-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"customAdapter"</span>
	<span class="hl-attribute">store-uri</span>=<span class="hl-value">"imaps://some_google_address:${password}@imap.gmail.com/INBOX"</span>
	<span class="hl-attribute">channel</span>=<span class="hl-value">"receiveChannel"</span>
	<span class="hl-attribute">should-mark-messages-as-read</span>=<span class="hl-value">"true"</span>
	<span class="hl-attribute">java-mail-properties</span>=<span class="hl-value">"javaMailProperties"</span>
	<span class="hl-attribute">mail-filter-expression</span>=<span class="hl-value">"subject matches '(?i).*Spring Integration.*'"</span><span class="hl-tag">/&gt;</span></pre>
<p>Another reasonable question is what happens on the next poll, or idle event, or what happens when such adapter is restarted.
Will there be a potential duplication of massages to be filtered? In other words if on the last retrieval where you had 5 new messages and only 1 passed the filter what would happen with the other 4.
Would they go through the filtering logic again on the next poll or idle? After all they were not marked as SEEN.
The actual answer is no.
They would not be subject of duplicate processing due to another flag (RECENT) that is set by the Email server and is used by Spring Integration mail search filter.
Folder implementations set this flag to indicate that this message is new to this folder, that is, it has arrived since the last time this folder was opened.
In other while our adapter may peek at the email it also lets the email server know that such email was touched and therefore will be marked as RECENT by the email server.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="mail-tx-sync" href="#mail-tx-sync"></a>21.7&nbsp;Transaction Synchronization</h2></div></div></div>

<p>Transaction synchronization for inbound adapters allows you to take different actions after a transaction commits, or rolls back.
Transaction synchronization is enabled by adding a <code class="literal">&lt;transactional/&gt;</code> element to the poller for the polled <code class="literal">&lt;inbound-adapter/&gt;</code>, or to the <code class="literal">&lt;imap-idle-inbound-adapter/&gt;</code>.
Even if there is no <span class="emphasis"><em>real</em></span> transaction involved, you can still enable this feature by using a <code class="literal">PseudoTransactionManager</code> with the <code class="literal">&lt;transactional/&gt;</code> element.
For more information, see <a class="xref" href="#transaction-synchronization" title="C.3&nbsp;Transaction Synchronization">Section&nbsp;C.3, &#8220;Transaction Synchronization&#8221;</a>.</p>
<p>Because of the many different mail servers, and specifically the limitations that some have, at this time we only provide a strategy for these transaction synchronizations.
You can send the messages to some other Spring Integration components, or invoke a custom bean to perform some action.
For example, to move an IMAP message to a different folder after the transaction commits, you might use something similar to the following:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-mail:imap-idle-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"customAdapter"</span>
    <span class="hl-attribute">store-uri</span>=<span class="hl-value">"imaps://foo.com:password@imap.foo.com/INBOX"</span>
    <span class="hl-attribute">channel</span>=<span class="hl-value">"receiveChannel"</span>
    <span class="hl-attribute">auto-startup</span>=<span class="hl-value">"true"</span>
    <span class="hl-attribute">should-delete-messages</span>=<span class="hl-value">"false"</span>
    <span class="hl-attribute">java-mail-properties</span>=<span class="hl-value">"javaMailProperties"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:transactional</span> <span class="hl-attribute">synchronization-factory</span>=<span class="hl-value">"syncFactory"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-mail:imap-idle-channel-adapter&gt;</span>

<span class="hl-tag">&lt;int:transaction-synchronization-factory</span> <span class="hl-attribute">id</span>=<span class="hl-value">"syncFactory"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:after-commit</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"@syncProcessor.process(payload)"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:transaction-synchronization-factory&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"syncProcessor"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"foo.bar.Mover"</span><span class="hl-tag">/&gt;</span></pre>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> Mover {

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> process(MimeMessage message) <span class="hl-keyword">throws</span> Exception{
        Folder folder = message.getFolder();
        folder.open(Folder.READ_WRITE);
        String messageId = message.getMessageID();
        Message[] messages = folder.getMessages();
        FetchProfile contentsProfile = <span class="hl-keyword">new</span> FetchProfile();
        contentsProfile.add(FetchProfile.Item.ENVELOPE);
        contentsProfile.add(FetchProfile.Item.CONTENT_INFO);
        contentsProfile.add(FetchProfile.Item.FLAGS);
        folder.fetch(messages, contentsProfile);
        <span class="hl-comment">// find this message and mark for deletion</span>
        <span class="hl-keyword">for</span> (<span class="hl-keyword">int</span> i = <span class="hl-number">0</span>; i &lt; messages.length; i++) {
            <span class="hl-keyword">if</span> (((MimeMessage) messages[i]).getMessageID().equals(messageId)) {
                messages[i].setFlag(Flags.Flag.DELETED, true);
                <span class="hl-keyword">break</span>;
            }
        }

        Folder fooFolder = store.getFolder(<span class="hl-string">"FOO"</span>));
        fooFolder.appendMessages(<span class="hl-keyword">new</span> MimeMessage[]{message});
        folder.expunge();
        folder.close(true);
        fooFolder.close(false);
    }
}</pre>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>For the message to be still available for manipulation after the transaction, <span class="emphasis"><em>should-delete-messages</em></span> must be set to <span class="emphasis"><em>false</em></span>.</p>
</td></tr></table></div>
</div>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="mongodb" href="#mongodb"></a>22.&nbsp;MongoDb Support</h2></div></div></div>

<p>As of version 2.1 Spring Integration introduces support for <a class="ulink" href="http://www.mongodb.org/" target="_top">MongoDB</a>: a <span class="emphasis"><em>"high-performance, open source, document-oriented database"</em></span>.
This support comes in the form of a MongoDB-based MessageStore.</p>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="mongodb-intro" href="#mongodb-intro"></a>22.1&nbsp;Introduction</h2></div></div></div>

<p>To download, install, and run MongoDB please refer to the <a class="ulink" href="http://www.mongodb.org/downloads" target="_top">MongoDB documentation</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="mongodb-connection" href="#mongodb-connection"></a>22.2&nbsp;Connecting to MongoDb</h2></div></div></div>

<p>To begin interacting with MongoDB you first need to connect to it.
Spring Integration builds on the support provided by another Spring project, <a class="ulink" href="http://projects.spring.io/spring-data-mongodb/" target="_top">Spring Data MongoDB</a>, which provides a factory class called <code class="literal">MongoDbFactory</code> that simplifies integration with the MongoDB Client API.</p>
<p><span class="emphasis"><em>MongoDbFactory</em></span></p>
<p>To connect to MongoDB you can use an implementation of the <code class="literal">MongoDbFactory</code> interface:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> MongoDbFactory {

	<strong class="hl-tag" style="color: blue">/**
	 * Creates a default {@link DB} instance.
	 *
	 * @return the DB instance
	 * @throws DataAccessException
	 */</strong>
	DB getDb() <span class="hl-keyword">throws</span> DataAccessException;

	<strong class="hl-tag" style="color: blue">/**
	 * Creates a {@link DB} instance to access the database with the given name.
	 *
	 * @param dbName must not be {@literal null} or empty.
	 *
	 * @return the DB instance
	 * @throws DataAccessException
	 */</strong>
	DB getDb(String dbName) <span class="hl-keyword">throws</span> DataAccessException;
}</pre>
<p>The example below shows <code class="literal">SimpleMongoDbFactory</code>, the out-of-the-box implementation:</p>
<p>In Java:</p>
<pre class="programlisting">MongoDbFactory mongoDbFactory = <span class="hl-keyword">new</span> SimpleMongoDbFactory(<span class="hl-keyword">new</span> Mongo(), <span class="hl-string">"test"</span>);</pre>
<p>Or in Spring&#8217;s XML configuration:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"mongoDbFactory"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.data.mongodb.core.SimpleMongoDbFactory"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.mongodb.Mongo"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/constructor-arg&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"test"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
<p>As you can see <code class="literal">SimpleMongoDbFactory</code> takes two arguments: 1) a <code class="literal">Mongo</code> instance and 2) a String specifying the name of the database.
If you need to configure properties such as <code class="literal">host</code>, <code class="literal">port</code>, etc, you can pass those using one of the constructors provided by the underlying <code class="literal">Mongo</code> class.
For more information on how to configure MongoDB, please refer to the <a class="ulink" href="http://docs.spring.io/spring-data/data-mongo/docs/current/reference/html/" target="_top">Spring-Data-MongoDB</a> reference.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="mongodb-message-store" href="#mongodb-message-store"></a>22.3&nbsp;MongoDB Message Store</h2></div></div></div>

<p>As described in EIP, a <a class="ulink" href="http://www.eaipatterns.com/MessageStore.html" target="_top">Message Store</a> allows you to persist Messages.
This can be very useful when dealing with components that have a capability to buffer messages (<span class="emphasis"><em>QueueChannel, Aggregator, Resequencer</em></span>, etc.) if reliability is a concern.
In Spring Integration, the <code class="literal">MessageStore</code> strategy also provides the foundation for the <a class="ulink" href="http://www.eaipatterns.com/StoreInLibrary.html" target="_top">ClaimCheck</a> pattern, which is described in EIP as well.</p>
<p>Spring Integration&#8217;s MongoDB module provides the <code class="literal">MongoDbMessageStore</code> which is an implementation of both the <code class="literal">MessageStore</code> strategy (mainly used by the <span class="emphasis"><em>ClaimCheck</em></span> pattern) and the <code class="literal">MessageGroupStore</code> strategy (mainly used by the <span class="emphasis"><em>Aggregator</em></span> and <span class="emphasis"><em>Resequencer</em></span> patterns).</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"mongoDbMessageStore"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.mongodb.store.MongoDbMessageStore"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"mongoDbFactory"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"somePersistentQueueChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:queue</span> <span class="hl-attribute">message-store</span>=<span class="hl-value">"mongoDbMessageStore"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;int:channel&gt;</span>

<span class="hl-tag">&lt;int:aggregator</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"inputChannel"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"outputChannel"</span>
         <span class="hl-attribute">message-store</span>=<span class="hl-value">"mongoDbMessageStore"</span><span class="hl-tag">/&gt;</span></pre>
<p>Above is a sample <code class="literal">MongoDbMessageStore</code> configuration that shows its usage by a <span class="emphasis"><em>QueueChannel</em></span> and an <span class="emphasis"><em>Aggregator</em></span>.
As you can see it is a simple bean configuration, and it expects a <code class="literal">MongoDbFactory</code> as a constructor argument.</p>
<p>The <code class="literal">MongoDbMessageStore</code> expands the <code class="literal">Message</code> as a Mongo document with all nested properties using the Spring Data Mongo Mapping mechanism.
It is useful when you need to have access to the <code class="literal">payload</code> or <code class="literal">headers</code> for auditing or analytics, for example, against stored messages.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>The <code class="literal">MongoDbMessageStore</code> uses a custom <code class="literal">MappingMongoConverter</code> implementation to store <code class="literal">Message</code> s as MongoDB documents and there are some limitations for the properties (<code class="literal">payload</code> and <code class="literal">header</code> values) of the <code class="literal">Message</code>.
For example, there is no ability to configure custom converters for complex domain <code class="literal">payload</code> s or <code class="literal">header</code> values.
Or to provide a custom <code class="literal">MongoTemplate</code> (or <code class="literal">MappingMongoConverter</code>).
To achieve these capabilities, an alternative MongoDB <code class="literal">MessageStore</code> implementation has been introduced; see next paragraph.</p>
</td></tr></table></div>
<p><span class="emphasis"><em>Spring Integration 3.0</em></span> introduced the <code class="literal">ConfigurableMongoDbMessageStore</code> - <code class="literal">MessageStore</code> and <code class="literal">MessageGroupStore</code> implementation.
This class can receive, as a constructor argument, a <code class="literal">MongoTemplate</code>, with which you can configure with a custom <code class="literal">WriteConcern</code>, for example.
Another constructor requires a <code class="literal">MappingMongoConverter</code>, and a <code class="literal">MongoDbFactory</code>, which allows you to provide some custom conversions for <code class="literal">Message</code> s and their properties.
Note, by default, the <code class="literal">ConfigurableMongoDbMessageStore</code> uses standard Java serialization to write/read <code class="literal">Message</code> s to/from MongoDB (see <code class="literal">MongoDbMessageBytesConverter</code>) and relies on default values for other properties from <code class="literal">MongoTemplate</code>, which is built from the provided <code class="literal">MongoDbFactory</code> and <code class="literal">MappingMongoConverter</code>.
The default name for the collection stored by the <code class="literal">ConfigurableMongoDbMessageStore</code> is <code class="literal">configurableStoreMessages</code>.
It is recommended to use this implementation for robust and flexible solutions when messages contain complex data types.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="mongodb-priority-channel-message-store" href="#mongodb-priority-channel-message-store"></a>22.3.1&nbsp;MongoDB Channel Message Store</h3></div></div></div>

<p>Starting with <span class="emphasis"><em>version 4.0</em></span>, the new <code class="literal">MongoDbChannelMessageStore</code> has been introduced; it is an optimized <code class="literal">MessageGroupStore</code> for use in <code class="literal">QueueChannel</code> s.
With <code class="literal">priorityEnabled = true</code>, it can be used in <code class="literal">&lt;int:priority-queue&gt;</code> s to achieve <span class="emphasis"><em>priority</em></span> order polling for persisted messages.
The <span class="emphasis"><em>priority</em></span> MongoDB document field is populated from the <code class="literal">IntegrationMessageHeaderAccessor.PRIORITY</code> (<code class="literal">priority</code>) message header.</p>
<p>In addition, all MongoDB <code class="literal">MessageStore</code> s now have a <code class="literal">sequence</code> field for MessageGroup documents.
The <code class="literal">sequence</code> value is the result of an <code class="literal">$inc</code> operation for a simple <code class="literal">sequence</code> document from the same collection, which is created on demand.
The <code class="literal">sequence</code> field is used in <code class="literal">poll</code> operations to provide first-in-first-out (FIFO) message order (within priority if configured) when messages are stored within the same millisecond.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>It is not recommended to use the same <code class="literal">MongoDbChannelMessageStore</code> bean for priority and non-priority, because the <code class="literal">priorityEnabled</code> option applies to the entire store.
However, the same <code class="literal">collection</code> can be used for both <code class="literal">MongoDbChannelMessageStore</code> types, because message polling from the store is sorted and uses indexes.
To configure that scenario, simply extend one message store bean from the other:</p>
</td></tr></table></div>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"channelStore"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.mongodb.store.MongoDbChannelMessageStore"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">name</span>=<span class="hl-value">"mongoDbFactory"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"mongoDbFactory"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"queueChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:queue</span> <span class="hl-attribute">message-store</span>=<span class="hl-value">"store"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:channel&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"priorityStore"</span> <span class="hl-attribute">parent</span>=<span class="hl-value">"channelStore"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"priorityEnabled"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"priorityChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:priority-queue</span> <span class="hl-attribute">message-store</span>=<span class="hl-value">"priorityStore"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:channel&gt;</span></pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="mongodb-metadata-store" href="#mongodb-metadata-store"></a>22.3.2&nbsp;MongoDB Metadata Store</h3></div></div></div>

<p>As of <span class="emphasis"><em>Spring Integration 4.2</em></span>, a new MongoDB-based <code class="literal">MetadataStore</code> (<a class="xref" href="#metadata-store" title="9.5&nbsp;Metadata Store">Section&nbsp;9.5, &#8220;Metadata Store&#8221;</a>) implementation is available.
The <code class="literal">MongoDbMetadataStore</code> can be used to maintain metadata state across application restarts.
This new <code class="literal">MetadataStore</code> implementation can be used with adapters such as:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="xref" href="#twitter-inbound" title="32.4&nbsp;Twitter Inbound Adapters">Section&nbsp;32.4, &#8220;Twitter Inbound Adapters&#8221;</a>
</li><li class="listitem">
<a class="xref" href="#feed-inbound-channel-adapter" title="13.2&nbsp;Feed Inbound Channel Adapter">Section&nbsp;13.2, &#8220;Feed Inbound Channel Adapter&#8221;</a>
</li><li class="listitem">
<a class="xref" href="#file-reading" title="14.2&nbsp;Reading Files">Section&nbsp;14.2, &#8220;Reading Files&#8221;</a>
</li><li class="listitem">
<a class="xref" href="#ftp-inbound" title="15.4&nbsp;FTP Inbound Channel Adapter">Section&nbsp;15.4, &#8220;FTP Inbound Channel Adapter&#8221;</a>
</li><li class="listitem">
<a class="xref" href="#sftp-inbound" title="27.7&nbsp;SFTP Inbound Channel Adapter">Section&nbsp;27.7, &#8220;SFTP Inbound Channel Adapter&#8221;</a>
</li></ul></div>
<p>In order to instruct these adapters to use the new <code class="literal">MongoDbMetadataStore</code>, simply declare a Spring bean using the
bean name <span class="strong"><strong>metadataStore</strong></span>. The <span class="emphasis"><em>Twitter Inbound Channel Adapter</em></span> and the <span class="emphasis"><em>Feed Inbound Channel Adapter</em></span> will both
automatically pick up and use the declared <code class="literal">MongoDbMetadataStore</code>:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> MetadataStore metadataStore(MongoDbFactory factory) {
    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> MongoDbMetadataStore(factory, <span class="hl-string">"integrationMetadataStore"</span>);
}</pre>
<p>The <code class="literal">MongoDbMetadataStore</code> also implements <code class="literal">ConcurrentMetadataStore</code>, allowing it to be reliably shared across multiple
application instances where only one instance will be allowed to store or modify a key&#8217;s value.
All these operations are <span class="emphasis"><em>atomic</em></span> via MongoDB guarantees. For this purpose the <code class="literal">putIfAbsent</code> operation is implemented
as a <span class="emphasis"><em>stored</em></span> JavaScript function. Fom more information see
<a class="ulink" href="http://docs.spring.io/spring-data/data-mongo/docs/current/reference/html/#mongo.server-side-scripts" target="_top">Script Operations</a>
and <code class="literal">MongoDbMetadataStore</code> JavaDocs.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="mongodb-inbound-channel-adapter" href="#mongodb-inbound-channel-adapter"></a>22.4&nbsp;MongoDB Inbound Channel Adapter</h2></div></div></div>

<p>The <span class="emphasis"><em>MongoDb Inbound Channel Adapter</em></span> is a polling consumer that reads data from MongoDb and sends it as a Message payload.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-mongodb:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"mongoInboundAdapter"</span>
       <span class="hl-attribute">channel</span>=<span class="hl-value">"replyChannel"</span>
       <span class="hl-attribute">query</span>=<span class="hl-value">"{'name' : 'Bob'}"</span>
       <span class="hl-attribute">entity-class</span>=<span class="hl-value">"java.lang.Object"</span>
       <span class="hl-attribute">auto-startup</span>=<span class="hl-value">"false"</span><span class="hl-tag">&gt;</span>
		<span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"100"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-mongodb:inbound-channel-adapter&gt;</span></pre>
<p>As you can see from the configuration above, you configure a <span class="emphasis"><em>MongoDb Inbound Channel Adapter</em></span> using the <code class="literal">inbound-channel-adapter</code> element, providing values for various attributes such as:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">query</code> - a JSON query (see <a class="ulink" href="http://www.mongodb.org/display/DOCS/Querying" target="_top">MongoDb Querying</a>)
</li><li class="listitem">
<code class="literal">query-expression</code> - A SpEL expression that is evaluated to a JSON query String (as the <code class="literal">query</code> attribute above), or to an instance of <code class="literal">o.s.data.mongodb.core.query.Query</code>. Mutually exclusive with <code class="literal">query</code> attribute.
</li><li class="listitem">
<code class="literal">entity-class</code> - the type of the payload object; if not supplied, a <code class="literal">com.mongodb.DBObject</code> will be returned.
</li><li class="listitem">
<code class="literal">collection-name</code> or <code class="literal">collection-name-expression</code> - Identifies the name of the MongoDb collection to use.
</li><li class="listitem">
<code class="literal">mongodb-factory</code> - reference to an instance of <code class="literal">o.s.data.mongodb.MongoDbFactory</code>
</li><li class="listitem">
<p class="simpara"><code class="literal">mongo-template</code> - reference to an instance of <code class="literal">o.s.data.mongodb.core.MongoTemplate</code></p>
<pre class="literallayout">and other attributes that are common across all other inbound adapters (e.g., 'channel').</pre>
</li></ul></div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>You cannot set both <code class="literal">mongo-template</code> and <code class="literal">mongodb-factory</code>.</p>
</td></tr></table></div>
<p>The example above is relatively simple and static since it has a literal value for the <code class="literal">query</code> and uses the default name for a <code class="literal">collection</code>.
Sometimes you may need to change those values at runtime, based on some condition.
To do that, simply use their <code class="literal">-expression</code> equivalents (<code class="literal">query-expression</code> and <code class="literal">collection-name-expression</code>) where the provided expression can be any valid SpEL expression.</p>
<p>Also, you may wish to do some post-processing to the successfully processed data that was read from the MongoDb.
For example; you may want to move or remove a document after its been processed.
You can do this using Transaction Synchronization feature that was added with Spring Integration 2.2.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-mongodb:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"mongoInboundAdapter"</span>
    <span class="hl-attribute">channel</span>=<span class="hl-value">"replyChannel"</span>
    <span class="hl-attribute">query-expression</span>=<span class="hl-value">"new BasicQuery('{''name'' : ''Bob''}').limit(100)"</span>
    <span class="hl-attribute">entity-class</span>=<span class="hl-value">"java.lang.Object"</span>
    <span class="hl-attribute">auto-startup</span>=<span class="hl-value">"false"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"200"</span> <span class="hl-attribute">max-messages-per-poll</span>=<span class="hl-value">"1"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;int:transactional</span> <span class="hl-attribute">synchronization-factory</span>=<span class="hl-value">"syncFactory"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/int:poller&gt;</span>
<span class="hl-tag">&lt;/int-mongodb:inbound-channel-adapter&gt;</span>

<span class="hl-tag">&lt;int:transaction-synchronization-factory</span> <span class="hl-attribute">id</span>=<span class="hl-value">"syncFactory"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:after-commit</span>
        <span class="hl-attribute">expression</span>=<span class="hl-value">"@documentCleaner.remove(#mongoTemplate, payload, headers.mongo_collectionName)"</span>
        <span class="hl-attribute">channe</span>=<span class="hl-value">"someChannel"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:transaction-synchronization-factory&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"documentCleaner"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"foo.bar.DocumentCleaner"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"transactionManager"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.transaction.PseudoTransactionManager"</span><span class="hl-tag">/&gt;</span></pre>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> DocumentCleaner {
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> remove(MongoOperations mongoOperations, Object target, String collectionName) {
        <span class="hl-keyword">if</span> (target <span class="hl-keyword">instanceof</span> List&lt;?&gt;){
            List&lt;?&gt; documents = (List&lt;?&gt;) target;
            <span class="hl-keyword">for</span> (Object document : documents) {
                mongoOperations.remove(<span class="hl-keyword">new</span> BasicQuery(JSON.serialize(document)), collectionName);
            }
        }
    }
}</pre>
<p>As you can see from the above, all you need to do is declare your poller to be transactional with a <code class="literal">transactional</code> element.
This element can reference a real transaction manager (for example if some other part of your flow invokes JDBC).
If you don&#8217;t have a <span class="emphasis"><em>real</em></span> transaction, you can use a <code class="literal">org.springframework.integration.transaction.PseudoTransactionManager</code> which is an implementation of Spring&#8217;s <code class="literal">PlatformTransactionManager</code> and enables the use of the transaction synchronization features of the mongo adapter when there is no actual transaction.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>This does NOT make MongoDB itself transactional, it simply allows the synchronization of actions to be taken before/after success (commit) or after failure (rollback).</p>
</td></tr></table></div>
<p>Once your poller is transactional all you need to do is set an instance of the <code class="literal">o.s.i.transaction.TransactionSynchronizationFactory</code> on the <code class="literal">transactional</code> element.
<code class="literal">TransactionSynchronizationFactory</code> will create an instance of the <code class="literal">TransactionSynchronization</code>.
For your convenience, we&#8217;ve exposed a default SpEL-based <code class="literal">TransactionSynchronizationFactory</code> which allows you to configure SpEL expressions, with their execution being coordinated (synchronized) with a transaction.
Expressions for before-commit, after-commit, and after-rollback are supported, together with a channel for each where the evaluation result (if any) will be sent.
For each sub-element you can specify <code class="literal">expression</code> and/or <code class="literal">channel</code> attributes.
If only the <code class="literal">channel</code> attribute is present the received Message will be sent there as part of the particular synchronization scenario.
If only the <code class="literal">expression</code> attribute is present and the result of an expression is a non-Null value, a Message with the result as the payload will be generated and sent to a default channel (NullChannel) and will appear in the logs (DEBUG).
If you want the evaluation result to go to a specific channel add a <code class="literal">channel</code> attribute.
If the result of an expression is null or void, no Message will be generated.</p>
<p>For more information about transaction synchronization, see <a class="xref" href="#transaction-synchronization" title="C.3&nbsp;Transaction Synchronization">Section&nbsp;C.3, &#8220;Transaction Synchronization&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="mongodb-outbound-channel-adapter" href="#mongodb-outbound-channel-adapter"></a>22.5&nbsp;MongoDB Outbound Channel Adapter</h2></div></div></div>

<p>The <span class="emphasis"><em>MongoDb Outbound Channel Adapter</em></span> allows you to write the Message payload to a MongoDb document store</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-mongodb:outbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"fullConfigWithCollectionExpression"</span>
	<span class="hl-attribute">collection-name</span>=<span class="hl-value">"myCollection"</span>
	<span class="hl-attribute">mongo-converter</span>=<span class="hl-value">"mongoConverter"</span>
	<span class="hl-attribute">mongodb-factory</span>=<span class="hl-value">"mongoDbFactory"</span><span class="hl-tag"> /&gt;</span></pre>
<p>As you can see from the configuration above, you configure a <span class="emphasis"><em>MongoDb Outbound Channel Adapter</em></span> using the <code class="literal">outbound-channel-adapter</code> element, providing values for various attributes such as:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">collection-name</code> or <code class="literal">collection-name-expression</code> - Identifies the name of the MongoDb collection to use.
</li><li class="listitem">
<code class="literal">mongo-converter</code> - reference to an instance of <code class="literal">o.s.data.mongodb.core.convert.MongoConverter</code> to assist with converting a raw java object to a JSON document representation
</li><li class="listitem">
<code class="literal">mongodb-factory</code> - reference to an instance of <code class="literal">o.s.data.mongodb.MongoDbFactory</code>
</li><li class="listitem">
<code class="literal">mongo-template</code> - reference to an instance of <code class="literal">o.s.data.mongodb.core.MongoTemplate</code> (NOTE: you can not have both mongo-template and mongodb-factory set)
</li></ul></div>
<p>and other attributes that are common across all other inbound adapters (e.g., <span class="emphasis"><em>channel</em></span>).</p>
<p>The example above is relatively simple and static since it has a literal value for the <code class="literal">collection-name</code>.
Sometimes you may need to change this value at runtime based on some condition.
To do that, simply use <code class="literal">collection-name-expression</code> where the provided expression can be any valid SpEL expression.</p>
</div>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="mqtt" href="#mqtt"></a>23.&nbsp;MQTT Support</h2></div></div></div>

<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="mqtt-intro" href="#mqtt-intro"></a>23.1&nbsp;Introduction</h2></div></div></div>

<p>Spring Integration provides inbound and outbound channel adapters supporting the MQ Telemetry Transport (MQTT) protocol.
The current implementation uses the <a class="ulink" href="http://www.eclipse.org/paho/" target="_top">Eclipse Paho MQTT Client</a> library.</p>
<p>Configuration of both adapters is achieved using the <code class="literal">DefaultMqttPahoClientFactory</code>.
Refer to the Paho documentation for more information about configuration options.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>It is preferred to configure an <code class="literal">MqttConnectOptions</code> object and inject it into the factory, instead of setting the (deprecated) options on the factory itself.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="mqtt-inbound" href="#mqtt-inbound"></a>23.2&nbsp;Inbound (message-driven) Channel Adapter</h2></div></div></div>

<p>The inbound channel adapter is implemented by the <code class="literal">MqttPahoMessageDrivenChannelAdapter</code>.
For convenience, it can be configured using the namespace.
A minimal configuration might be:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"clientFactory"</span>
        <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.mqtt.core.DefaultMqttPahoClientFactory"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"connectionOptions"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.eclipse.paho.client.mqttv3.MqttConnectOptions"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"userName"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"${mqtt.username}"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"password"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"${mqtt.password}"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/bean&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;int-mqtt:message-driven-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"mqttInbound"</span>
	<span class="hl-attribute">client-id</span>=<span class="hl-value">"${mqtt.default.client.id}.src"</span>
	<span class="hl-attribute">url</span>=<span class="hl-value">"${mqtt.url}"</span>
	<span class="hl-attribute">topics</span>=<span class="hl-value">"sometopic"</span>
	<span class="hl-attribute">client-factory</span>=<span class="hl-value">"clientFactory"</span>
	<span class="hl-attribute">channel</span>=<span class="hl-value">"output"</span><span class="hl-tag">/&gt;</span></pre>
<p>Attributes:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-mqtt:message-driven-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"oneTopicAdapter"</span>
	<span class="hl-attribute">client-id</span>=<span class="hl-value">"foo"</span>  <a name="CO40-1" href="#CO40-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
	url="tcp://localhost:1883"  <a name="CO40-2" href="#CO40-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
	topics="bar,baz"  <a name="CO40-3" href="#CO40-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
	qos="1,2"  <a name="CO40-4" href="#CO40-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
	converter="myConverter"  <a name="CO40-5" href="#CO40-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
	client-factory="clientFactory"  <a name="CO40-6" href="#CO40-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>
	send-timeout="123"  <a name="CO40-7" href="#CO40-7"></a><span><img src="images/callouts/7.png" alt="7" border="0"></span>
	error-channel="errors"  <a name="CO40-8" href="#CO40-8"></a><span><img src="images/callouts/8.png" alt="8" border="0"></span>
	recovery-interval="10000"  <a name="CO40-9" href="#CO40-9"></a><span><img src="images/callouts/9.png" alt="9" border="0"></span>
	channel="out" /&gt;</pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO40-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The client id.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO40-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The broker URL.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO40-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A comma delimited list of topics from which this adapter will receive messages.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO40-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A comma delimited list of QoS values.
Can be a single value that is applied to all topics, or a value for each topic (in which case the lists must the same length).</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO40-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>An <code class="literal">MqttMessageConverter</code> (optional).
The default <code class="literal">DefaultPahoMessageConverter</code> produces a message with a <code class="literal">String</code> payload (by default) with the following headers:
<code class="literal">mqtt_topic</code> - the topic from which the message was received
<code class="literal">mqtt_duplicate</code> - true if the message is a duplicate
<code class="literal">mqtt_qos</code> - the quality of service
The <code class="literal">DefaultPahoMessageConverter</code> can be configured to return the raw <code class="literal">byte[]</code> in the payload by declaring it as a <code class="literal">&lt;bean/&gt;</code> and setting the <code class="literal">payloadAsBytes</code> property.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO40-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The client factory.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO40-7"><span><img src="images/callouts/7.png" alt="7" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The send timeout - only applies if the channel might block (such as a bounded <code class="literal">QueueChannel</code> that is currently full).</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO40-8"><span><img src="images/callouts/8.png" alt="8" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The error channel - downstream exceptions will be sent to this channel, if supplied, in an <code class="literal">ErrorMessage</code>; the payload is a <code class="literal">MessagingException</code> containing the failed message and cause.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO40-9"><span><img src="images/callouts/9.png" alt="9" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The recovery interval - controls the interval at which the adapter will attempt to reconnect after
a failure; it defaults to <code class="literal">10000ms</code> (ten seconds).</p>
</td></tr></table></div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Starting with <span class="emphasis"><em>version 4.1</em></span> the url can be omitted and, instead, the server URIs can be provided in the <code class="literal">serverURIs</code> property of the <code class="literal">DefaultMqttPahoClientFactory</code>.
This enables, for example, connection to a highly available (HA) cluster.</p>
</td></tr></table></div>
<p>Starting with <span class="emphasis"><em>version 4.2.2</em></span>, an <code class="literal">MqttSubscribedEvent</code> is published when the adapter successfully subscribes to the
topic(s).
<code class="literal">MqttConnectionFailedEvent</code> s are published when the connection/subscription fails.
These events can be received by a bean that implements <code class="literal">ApplicationListener</code>.</p>
<p>Also, a new property <code class="literal">recoveryInterval</code> controls the interval at which the adapter will attempt to reconnect after
a failure; it defaults to <code class="literal">10000ms</code> (ten seconds).</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Prior to <span class="emphasis"><em>version 4.2.3</em></span>, the client always unsubscribed when the adapter was stopped.
This was incorrect because if the client QOS is &gt; 0, we need to keep the subscription active so that messages arriving
while the adapter is stopped will be delivered on the next start.
This also requires setting the <code class="literal">cleanSession</code> property on the client factory to <code class="literal">false</code> - it defaults to <code class="literal">true</code>.</p>
<p>Starting with <span class="emphasis"><em>version 4.2.3</em></span>, the adapter will not unsubscribe (by default) if the <code class="literal">cleanSession</code> property is <code class="literal">false</code>.</p>
<p>This behavior can be overridden by setting the <code class="literal">consumerCloseAction</code> property on the factory.
It can have values: <code class="literal">UNSUBSCRIBE_ALWAYS</code>, <code class="literal">UNSUBSCRIBE_NEVER</code>, and <code class="literal">UNSUBSCRIBE_CLEAN</code>.
The latter (the default) will unsubscribe only if the <code class="literal">cleanSession</code> property is <code class="literal">true</code>.</p>
<p>To revert to the pre-4.2.3 behavior, use <code class="literal">UNSUBSCRIBE_ALWAYS</code>.</p>
</td></tr></table></div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_adding_removing_topics_at_runtime" href="#_adding_removing_topics_at_runtime"></a>23.2.1&nbsp;Adding/Removing Topics at Runtime</h3></div></div></div>

<p>Starting with <span class="emphasis"><em>version 4.1</em></span>, it is possible to programmatically change the topics to which the adapter is subscribed.
Methods <code class="literal">addTopic()</code> and <code class="literal">removeTopic()</code> are provided.
When adding topics, you can optionally specify the <code class="literal">QoS</code> (default: 1).
You can also modify the topics by sending an appropriate message to a <code class="literal">&lt;control-bus/&gt;</code> with an appropriate payload: <code class="literal">"myMqttAdapter.addTopic('foo', 1)"</code>.</p>
<p>Stopping/starting the adapter has no effect on the topic list (it does <span class="strong"><strong>not</strong></span> revert to the original settings in the configuration).
The changes are not retained beyond the life cycle of the application context; a new application context will revert to the configured settings.</p>
<p>Changing the topics while the adapter is stopped (or disconnected from the broker) will take effect the next time a connection is established.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_with_java_configuration_14" href="#_configuring_with_java_configuration_14"></a>23.2.2&nbsp;Configuring with Java Configuration</h3></div></div></div>

<p>The following Spring Boot application provides an example of configuring the inbound adapter using Java configuration:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@SpringBootApplication</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MqttJavaApplication {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
    	<span class="hl-keyword">new</span> SpringApplicationBuilder(MqttJavaApplication.<span class="hl-keyword">class</span>)
    			.web(false)
    			.run(args);
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> MessageChannel mqttInputChannel() {
    	<span class="hl-keyword">return</span> <span class="hl-keyword">new</span> DirectChannel();
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> MessageProducer inbound() {
    	MqttPahoMessageDrivenChannelAdapter adapter =
    			<span class="hl-keyword">new</span> MqttPahoMessageDrivenChannelAdapter(<span class="hl-string">"tcp://localhost:1883"</span>, <span class="hl-string">"testClient"</span>,
    			                                 <span class="hl-string">"topic1"</span>, <span class="hl-string">"topic2"</span>);
    	adapter.setCompletionTimeout(<span class="hl-number">5000</span>);
    	adapter.setConverter(<span class="hl-keyword">new</span> DefaultPahoMessageConverter());
    	adapter.setQos(<span class="hl-number">1</span>);
    	adapter.setOutputChannel(mqttInputChannel());
    	<span class="hl-keyword">return</span> adapter;
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "mqttInputChannel")</span></em>
    <span class="hl-keyword">public</span> MessageHandler handler() {
    	<span class="hl-keyword">return</span> <span class="hl-keyword">new</span> MessageHandler() {

    		<em><span class="hl-annotation" style="color: gray">@Override</span></em>
    		<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> handleMessage(Message&lt;?&gt; message) <span class="hl-keyword">throws</span> MessagingException {
    			System.out.println(message.getPayload());
    		}

    	};
    }

}</pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="mqtt-outbound" href="#mqtt-outbound"></a>23.3&nbsp;Outbound Channel Adapter</h2></div></div></div>

<p>The outbound channel adapter is implemented by the <code class="literal">MqttPahoMessageHandler</code> which is wrapped in a <code class="literal">ConsumerEndpoint</code>.
For convenience, it can be configured using the namespace.</p>
<p>Starting with <span class="emphasis"><em>version 4.1</em></span>, the adapter supports asynchronous sends, avoiding blocking until the delivery is confirmed; application events can be emitted to enable applications to confirm delivery if desired.</p>
<p>Attributes:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-mqtt:outbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"withConverter"</span>
	<span class="hl-attribute">client-id</span>=<span class="hl-value">"foo"</span>  <a name="CO41-1" href="#CO41-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
	url="tcp://localhost:1883"  <a name="CO41-2" href="#CO41-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
	converter="myConverter"  <a name="CO41-3" href="#CO41-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
	client-factory="clientFactory"  <a name="CO41-4" href="#CO41-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
	default-qos="1"  <a name="CO41-5" href="#CO41-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
	default-retained="true"  <a name="CO41-6" href="#CO41-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>
	default-topic="bar"  <a name="CO41-7" href="#CO41-7"></a><span><img src="images/callouts/7.png" alt="7" border="0"></span>
	async="false"  <a name="CO41-8" href="#CO41-8"></a><span><img src="images/callouts/8.png" alt="8" border="0"></span>
	async-events="false"  <a name="CO41-9" href="#CO41-9"></a><span><img src="images/callouts/9.png" alt="9" border="0"></span>
	channel="target" /&gt;</pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO41-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The client id.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO41-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The broker URL.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO41-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>An <code class="literal">MqttMessageConverter</code> (optional).
The default <code class="literal">DefaultPahoMessageConverter</code> recognizes the following headers:
<code class="literal">mqtt_topic</code> - the topic to which the message will be sent
<code class="literal">mqtt_retained</code> - true if the message is to be retained
<code class="literal">mqtt_qos</code> - the quality of service</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO41-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The client factory.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO41-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The default quality of service (used if no <code class="literal">mqtt_qos</code> header is found).
Not allowed if a custom <code class="literal">converter</code> is supplied.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO41-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The default value of the retained flag (used if no <code class="literal">mqtt_retained</code> header is found).
Not allowed if a custom <code class="literal">converter</code> is supplied.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO41-7"><span><img src="images/callouts/7.png" alt="7" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The default topic to which the message will be sent (used if no <code class="literal">mqtt_topic</code> header is found).</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO41-8"><span><img src="images/callouts/8.png" alt="8" border="0"></span></a> </p></td><td valign="top" align="left">
<p>When <code class="literal">true</code>, the caller will not block waiting for delivery confirmation when a message is sent.
Default:false (the send blocks until delivery is confirmed).</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO41-9"><span><img src="images/callouts/9.png" alt="9" border="0"></span></a> </p></td><td valign="top" align="left">
<p>When <code class="literal">async</code> and <code class="literal">async-events</code> are both <code class="literal">true</code>, an <code class="literal">MqttMessageSentEvent</code> is emitted, containing the message, the topic, the <code class="literal">messageId</code> generated by the client library, the <code class="literal">clientId</code> and the <code class="literal">clientInstance</code> (incremented each time the client is connected).
When the delivery is confirmed by the client library, an <code class="literal">MqttMessageDeliveredEvent</code> is emitted, containing the the <code class="literal">messageId</code>, <code class="literal">clientId</code> and the <code class="literal">clientInstance</code>, enabling delivery to be correlated with the send.
These events can be received by any <code class="literal">ApplicationListener</code>, or by an event inbound channel adapter.
Note that it is possible that the <code class="literal">MqttMessageDeliveredEvent</code> might be received before the <code class="literal">MqttMessageSentEvent</code>.
Default: <code class="literal">false</code>.</p>
</td></tr></table></div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Starting with <span class="emphasis"><em>version 4.1</em></span> the url can be omitted and, instead, the server URIs can be provided in the <code class="literal">serverURIs</code> property of the <code class="literal">DefaultMqttPahoClientFactory</code>.
This enables, for example, connection to a highly available (HA) cluster.</p>
</td></tr></table></div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_with_java_configuration_15" href="#_configuring_with_java_configuration_15"></a>23.3.1&nbsp;Configuring with Java Configuration</h3></div></div></div>

<p>The following Spring Boot application provides an example of configuring the outbound adapter using Java configuration:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@SpringBootApplication</span></em>
<em><span class="hl-annotation" style="color: gray">@IntegrationComponentScan</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MqttJavaApplication {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
        ConfigurableApplicationContext context =
        		<span class="hl-keyword">new</span> SpringApplicationBuilder(MqttJavaApplication.<span class="hl-keyword">class</span>)
        				.web(false)
        				.run(args);
        MyGateway gateway = context.getBean(MyGateway.<span class="hl-keyword">class</span>);
        gateway.sendToMqtt(<span class="hl-string">"foo"</span>);
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> MqttPahoClientFactory mqttClientFactory() {
        DefaultMqttPahoClientFactory factory = <span class="hl-keyword">new</span> DefaultMqttPahoClientFactory();
        MqttConnectOptions options = <span class="hl-keyword">new</span> MqttConnectOptions();
        options.setServerURIs(<span class="hl-keyword">new</span> String[] { <span class="hl-string">"tcp://host1:1883"</span>, <span class="hl-string">"tcp://host2:1883"</span> });
        options.setUserName(<span class="hl-string">"username"</span>);
        options.setPassword(<span class="hl-string">"password"</span>.toCharArray());
        factory.setConnectionOptions(options);
        <span class="hl-keyword">return</span> factory;
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "mqttOutboundChannel")</span></em>
    <span class="hl-keyword">public</span> MessageHandler mqttOutbound() {
        MqttPahoMessageHandler messageHandler =
                       <span class="hl-keyword">new</span> MqttPahoMessageHandler(<span class="hl-string">"testClient"</span>, mqttClientFactory());
        messageHandler.setAsync(true);
        messageHandler.setDefaultTopic(<span class="hl-string">"testTopic"</span>);
        <span class="hl-keyword">return</span> messageHandler;
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> MessageChannel mqttOutboundChannel() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> DirectChannel();
    }

    <em><span class="hl-annotation" style="color: gray">@MessagingGateway(defaultRequestChannel = "mqttOutboundChannel")</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> MyGateway {

        <span class="hl-keyword">void</span> sendToMqtt(String data);

    }

}</pre>
</div>
</div>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="redis" href="#redis"></a>24.&nbsp;Redis Support</h2></div></div></div>

<p>Since version 2.1 Spring Integration introduces support for <a class="ulink" href="http://redis.io/" target="_top">Redis</a>: _"an open source advanced key-value store".
_ This support comes in the form of a Redis-based MessageStore as well as Publish-Subscribe Messaging adapters that are supported by Redis via its <a class="ulink" href="http://redis.io/topics/pubsub" target="_top">PUBLISH, SUBSCRIBE and UNSUBSCRIBE</a> commands.</p>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="redis-intro" href="#redis-intro"></a>24.1&nbsp;Introduction</h2></div></div></div>

<p>To download, install and run Redis please refer to the <a class="ulink" href="http://redis.io/download" target="_top">Redis documentation</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="redis-connection" href="#redis-connection"></a>24.2&nbsp;Connecting to Redis</h2></div></div></div>

<p>To begin interacting with Redis you first need to connect to it.
Spring Integration uses support provided by another Spring project, <a class="ulink" href="https://github.com/SpringSource/spring-data-redis" target="_top">Spring Data Redis</a>, which provides typical Spring constructs: <code class="literal">ConnectionFactory</code> and <code class="literal">Template</code>.
Those abstractions simplify integration with several Redis-client Java APIs.
Currently Spring-Data-Redis supportshttps://github.com/xetorthio/jedis[jedis], <a class="ulink" href="http://code.google.com/p/jredis/" target="_top">jredis</a> and <a class="ulink" href="https://github.com/e-mzungu/rjc" target="_top">rjc</a></p>
<p><span class="emphasis"><em>RedisConnectionFactory</em></span></p>
<p>To connect to Redis you would use one of the implementations of the <code class="literal">RedisConnectionFactory</code> interface:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> RedisConnectionFactory <span class="hl-keyword">extends</span> PersistenceExceptionTranslator {

    <strong class="hl-tag" style="color: blue">/**
     * Provides a suitable connection for interacting with Redis.
     *
     * @return connection for interacting with Redis.
     */</strong>
    RedisConnection getConnection();
}</pre>
<p>The example below shows how to create a <code class="literal">JedisConnectionFactory</code>.</p>
<p>In Java:</p>
<pre class="programlisting">JedisConnectionFactory jcf = <span class="hl-keyword">new</span> JedisConnectionFactory();
jcf.afterPropertiesSet();</pre>
<p>Or in Spring&#8217;s XML configuration:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"redisConnectionFactory"</span>
    <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.data.redis.connection.jedis.JedisConnectionFactory"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"port"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"7379"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
<p>The implementations of RedisConnectionFactory provide a set of properties such as port and host that can be set if needed.
Once an instance of RedisConnectionFactory is created, you can create an instance of RedisTemplate and inject it with the RedisConnectionFactory.</p>
<p><span class="emphasis"><em>RedisTemplate</em></span></p>
<p>As with other template classes in Spring (e.g., <code class="literal">JdbcTemplate</code>, <code class="literal">JmsTemplate</code>) <code class="literal">RedisTemplate</code> is a helper class that simplifies Redis data access code.
For more information about <code class="literal">RedisTemplate</code> and its variations (e.g., <code class="literal">StringRedisTemplate</code>) please refer to the <a class="ulink" href="http://static.springsource.org/spring-data/data-redis/docs/current/reference/" target="_top">Spring-Data-Redis documentation</a></p>
<p>The code below shows how to create an instance of <code class="literal">RedisTemplate</code>:</p>
<p>In Java:</p>
<pre class="programlisting">RedisTemplate rt = <span class="hl-keyword">new</span> RedisTemplate&lt;String, Object&gt;();
rt.setConnectionFactory(redisConnectionFactory);</pre>
<div class="variablelist"><dl class="variablelist"><dt><span class="term">Or in Spring&#8217;s XML configuration</span></dt><dd>
</dd></dl></div>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"redisTemplate"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.data.redis.core.RedisTemplate"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"connectionFactory"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"redisConnectionFactory"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="redis-messages" href="#redis-messages"></a>24.3&nbsp;Messaging with Redis</h2></div></div></div>

<p>As mentioned in the introduction Redis provides support for Publish-Subscribe messaging via its PUBLISH, SUBSCRIBE and UNSUBSCRIBE commands.
As with JMS and AMQP, Spring Integration provides Message Channels and adapters for sending and receiving messages via Redis.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="redis-pub-sub-channel" href="#redis-pub-sub-channel"></a>24.3.1&nbsp;Redis Publish/Subscribe channel</h3></div></div></div>

<p>Similar to the JMS there are cases where both the producer and consumer are intended to be part of the same application, running within the same process.
This could be accomplished by using a pair of inbound and outbound Channel Adapters, however just like with Spring Integration&#8217;s JMS support, there is a simpler approach to address this use case.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-redis:publish-subscribe-channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"redisChannel"</span> <span class="hl-attribute">topic-name</span>=<span class="hl-value">"si.test.topic"</span><span class="hl-tag">/&gt;</span></pre>
<p>The publish-subscribe-channel (above) will behave much like a normal <code class="literal">&lt;publish-subscribe-channel/&gt;</code> element from the main Spring Integration namespace.
It can be referenced by both <code class="literal">input-channel</code> and <code class="literal">output-channel</code> attributes of any endpoint.
The difference is that this channel is backed by a Redis topic name - a String value specified by the <code class="literal">topic-name</code> attribute.
However unlike JMS this topic doesn&#8217;t have to be created in advance or even auto-created by Redis.
In Redis topics are simple String values that play the role of an address, and all the producer and consumer need to do to communicate is use the same String value as their topic name.
A simple subscription to this channel means that asynchronous pub-sub messaging is possible between the producing and consuming endpoints, but unlike the asynchronous Message Channels created by adding a <code class="literal">&lt;queue/&gt;</code> sub-element within a simple Spring Integration <code class="literal">&lt;channel/&gt;</code> element, the Messages are not just stored in an in-memory queue.
Instead those Messages are passed through Redis allowing you to rely on its support for persistence and clustering as well as its interoperability with other non-java platforms.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="redis-inbound-channel-adapter" href="#redis-inbound-channel-adapter"></a>24.3.2&nbsp;Redis Inbound Channel Adapter</h3></div></div></div>

<p>The Redis-based Inbound Channel Adapter adapts incoming Redis messages into Spring Integration Messages in the same way as other inbound adapters.
It receives platform-specific messages (Redis in this case) and converts them to Spring Integration Messages using a <code class="literal">MessageConverter</code> strategy.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-redis:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"redisAdapter"</span>
       <span class="hl-attribute">topics</span>=<span class="hl-value">"foo, bar"</span>
       <span class="hl-attribute">channel</span>=<span class="hl-value">"receiveChannel"</span>
       <span class="hl-attribute">error-channel</span>=<span class="hl-value">"testErrorChannel"</span>
       <span class="hl-attribute">message-converter</span>=<span class="hl-value">"testConverter"</span><span class="hl-tag"> /&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"redisConnectionFactory"</span>
    <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.data.redis.connection.jedis.JedisConnectionFactory"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"port"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"7379"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"testConverter"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"foo.bar.SampleMessageConverter"</span><span class="hl-tag"> /&gt;</span></pre>
<p>Above is a simple but complete configuration of a Redis Inbound Channel Adapter.
Note that the above configuration relies on the familiar Spring paradigm of auto-discovering certain beans.
In this case the <code class="literal">redisConnectionFactory</code> is implicitly injected into the adapter.
You can of course specify it explicitly using the <code class="literal">connection-factory</code> attribute instead.</p>
<p>Also, note that the above configuration injects the adapter with a custom <code class="literal">MessageConverter</code>.
The approach is similar to JMS where <code class="literal">MessageConverters</code> are used to convert between Redis Messages and the Spring Integration Message payloads.
The default is a <code class="literal">SimpleMessageConverter</code>.</p>
<p>Inbound adapters can subscribe to multiple topic names hence the comma-delimited set of values in the <code class="literal">topics</code> attribute.</p>
<p>Since <span class="emphasis"><em>Spring Integration 3.0</em></span>, the Inbound Adapter, in addition to the existing <code class="literal">topics</code> attribute, now has the <code class="literal">topic-patterns</code> attribute.
This attribute contains a comma-delimited set of Redis topic patterns.
For more information regarding Redis publish/subscribe, see <a class="ulink" href="http://redis.io/topics/pubsub" target="_top">Redis Pub/Sub</a>.</p>
<p>Inbound adapters can use a <code class="literal">RedisSerializer</code> to deserialize the body of Redis Messages.
The <code class="literal">serializer</code> attribute of the <code class="literal">&lt;int-redis:inbound-channel-adapter&gt;</code> can be set to an empty string, which results in a <code class="literal">null</code> value for the <code class="literal">RedisSerializer</code> property.
In this case the raw <code class="literal">byte[]</code> bodies of Redis Messages are provided as the message payloads.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="redis-outbound-channel-adapter" href="#redis-outbound-channel-adapter"></a>24.3.3&nbsp;Redis Outbound Channel Adapter</h3></div></div></div>

<p>The Redis-based Outbound Channel Adapter adapts outgoing Spring Integration messages into Redis messages in the same way as other outbound adapters.
It receives Spring Integration messages and converts them to platform-specific messages (Redis in this case) using a <code class="literal">MessageConverter</code> strategy.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-redis:outbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"outboundAdapter"</span>
    <span class="hl-attribute">channel</span>=<span class="hl-value">"sendChannel"</span>
    <span class="hl-attribute">topic</span>=<span class="hl-value">"foo"</span>
    <span class="hl-attribute">message-converter</span>=<span class="hl-value">"testConverter"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"redisConnectionFactory"</span>
    <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.data.redis.connection.jedis.JedisConnectionFactory"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"port"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"7379"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"testConverter"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"foo.bar.SampleMessageConverter"</span><span class="hl-tag"> /&gt;</span></pre>
<p>As you can see the configuration is similar to the Redis Inbound Channel Adapter.
The adapter is implicitly injected with a <code class="literal">RedisConnectionFactory</code> which was defined with <span class="emphasis"><em><code class="literal">redisConnectionFactory</code></em></span> as its bean name.
This example also includes the optional, custom <code class="literal">MessageConverter</code> (the <span class="emphasis"><em><code class="literal">testConverter</code></em></span> bean).</p>
<p>Since <span class="emphasis"><em>Spring Integration 3.0</em></span>, the <code class="literal">&lt;int-redis:outbound-channel-adapter&gt;</code>, as an alternative to the <code class="literal">topic</code> attribute, has the <code class="literal">topic-expression</code> attribute to determine the Redis topic against the Message at runtime.
These attributes are mutually exclusive.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="redis-queue-inbound-channel-adapter" href="#redis-queue-inbound-channel-adapter"></a>24.3.4&nbsp;Redis Queue Inbound Channel Adapter</h3></div></div></div>

<p>Since <span class="emphasis"><em>Spring Integration 3.0</em></span>, a Queue Inbound Channel Adapter is available to <span class="emphasis"><em>pop</em></span> messages from a Redis List. By default it uses <span class="emphasis"><em>right pop</em></span>, but
it can be configured to use <span class="emphasis"><em>left pop</em></span> instead.
The adapter is message-driven using an internal listener thread and does not use a poller.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-redis:queue-inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">""</span>  <a name="CO42-1" href="#CO42-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
                    channel=""  <a name="CO42-2" href="#CO42-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
                    auto-startup=""  <a name="CO42-3" href="#CO42-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
                    phase=""  <a name="CO42-4" href="#CO42-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
                    connection-factory=""  <a name="CO42-5" href="#CO42-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
                    queue=""  <a name="CO42-6" href="#CO42-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>
                    error-channel=""  <a name="CO42-7" href="#CO42-7"></a><span><img src="images/callouts/7.png" alt="7" border="0"></span>
                    serializer=""  <a name="CO42-8" href="#CO42-8"></a><span><img src="images/callouts/8.png" alt="8" border="0"></span>
                    receive-timeout=""  <a name="CO42-9" href="#CO42-9"></a><span><img src="images/callouts/9.png" alt="9" border="0"></span>
                    recovery-interval=""  <a name="CO42-10" href="#CO42-10"></a><span><img src="images/callouts/10.png" alt="10" border="0"></span>
                    expect-message=""  <a name="CO42-11" href="#CO42-11"></a><span><img src="images/callouts/11.png" alt="11" border="0"></span>
                    task-executor=""  <a name="CO42-12" href="#CO42-12"></a><span><img src="images/callouts/12.png" alt="12" border="0"></span>
                    right-pop=""/&gt;  <a name="CO42-13" href="#CO42-13"></a><span><img src="images/callouts/13.png" alt="13" border="0"></span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO42-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The component bean name.
If the <code class="literal">channel</code> attribute isn&#8217;t provided a <code class="literal">DirectChannel</code> is created and registered with application context with this <code class="literal">id</code> attribute as the bean name.
In this case, the endpoint itself is registered with the bean name <code class="literal">id + '.adapter'</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO42-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The <code class="literal">MessageChannel</code> to which to send <code class="literal">Message</code> s from this Endpoint.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO42-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A <code class="literal">SmartLifecycle</code> attribute to specify whether this Endpoint should start automatically after the application context start or not.
Default is <code class="literal">true</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO42-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A <code class="literal">SmartLifecycle</code> attribute to specify the <span class="emphasis"><em>phase</em></span> in which this Endpoint will be started.
Default is <code class="literal">0</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO42-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A reference to a <code class="literal">RedisConnectionFactory</code> bean.
Defaults to <code class="literal">redisConnectionFactory</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO42-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The name of the Redis List on which the queue-based <span class="emphasis"><em>pop</em></span> operation is performed to get Redis messages.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO42-7"><span><img src="images/callouts/7.png" alt="7" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The <code class="literal">MessageChannel</code> to which to send <code class="literal">ErrorMessage</code> s with <code class="literal">Exception</code> s from the listening task of the Endpoint.
By default the underlying <code class="literal">MessagePublishingErrorHandler</code> uses the default <code class="literal">errorChannel</code> from the application context.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO42-8"><span><img src="images/callouts/8.png" alt="8" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The <code class="literal">RedisSerializer</code> bean reference.
Can be an empty string, which means <span class="emphasis"><em>no serializer</em></span>.
In this case the raw <code class="literal">byte[]</code> from the inbound Redis message is sent to the <code class="literal">channel</code> as the <code class="literal">Message</code> payload.
By default it is a <code class="literal">JdkSerializationRedisSerializer</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO42-9"><span><img src="images/callouts/9.png" alt="9" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The timeout in milliseconds for <span class="emphasis"><em>pop</em></span> operation to wait for a Redis message from the queue.
Default is 1 second.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO42-10"><span><img src="images/callouts/10.png" alt="10" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The time in milliseconds for which the listener task should sleep after exceptions on the <span class="emphasis"><em>pop</em></span> operation, before restarting the listener task.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO42-11"><span><img src="images/callouts/11.png" alt="11" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Specify if this Endpoint expects data from the Redis queue to contain entire <code class="literal">Message</code> s.
If this attribute is set to <code class="literal">true</code>, the <code class="literal">serializer</code> can&#8217;t be an empty string because messages require some form of deserialization (JDK serialization by default).
Default is <code class="literal">false</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO42-12"><span><img src="images/callouts/12.png" alt="12" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A reference to a Spring <code class="literal">TaskExecutor</code> (or standard JDK 1.5+ <code class="literal">Executor</code>) bean.
It is used for the underlying listening task.
By default a <code class="literal">SimpleAsyncTaskExecutor</code> is used.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO42-13"><span><img src="images/callouts/13.png" alt="13" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Specify whether this Endpoint should use <span class="emphasis"><em>right pop</em></span> (when <code class="literal">true</code>) or <span class="emphasis"><em>left pop</em></span> (when <code class="literal">false</code>) to read messages from the Redis List.
If <code class="literal">true</code>, the Redis List acts as a <code class="literal">FIFO</code> queue when used with a default <span class="emphasis"><em>Redis Queue Outbound Channel Adapter</em></span>. Set to <code class="literal">false</code> to use with software
that writes to the list with <span class="emphasis"><em>right push</em></span>, or to achieve a stack-like message order.
Default is <code class="literal">true</code>.
Since <span class="emphasis"><em>version 4.3</em></span>.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="redis-queue-outbound-channel-adapter" href="#redis-queue-outbound-channel-adapter"></a>24.3.5&nbsp;Redis Queue Outbound Channel Adapter</h3></div></div></div>

<p>Since <span class="emphasis"><em>Spring Integration 3.0</em></span>, a Queue Outbound Channel Adapter is available to <span class="emphasis"><em>push</em></span> to a Redis List from Spring Integration messages. By default,
it uses <span class="emphasis"><em>left push</em></span>, but it can be configured to use <span class="emphasis"><em>right push</em></span> instead.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-redis:queue-outbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">""</span>  <a name="CO43-1" href="#CO43-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
                    channel=""  <a name="CO43-2" href="#CO43-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
                    connection-factory=""  <a name="CO43-3" href="#CO43-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
                    queue=""  <a name="CO43-4" href="#CO43-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
                    queue-expression=""  <a name="CO43-5" href="#CO43-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
                    serializer=""  <a name="CO43-6" href="#CO43-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>
                    extract-payload=""  <a name="CO43-7" href="#CO43-7"></a><span><img src="images/callouts/7.png" alt="7" border="0"></span>
                    left-push=""/&gt;  <a name="CO43-8" href="#CO43-8"></a><span><img src="images/callouts/8.png" alt="8" border="0"></span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO43-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The component bean name.
If the <code class="literal">channel</code> attribute isn&#8217;t provided, a <code class="literal">DirectChannel</code> is created and registered with the application context with this <code class="literal">id</code> attribute as the bean name.
In this case, the endpoint is registered with the bean name <code class="literal">id + '.adapter'</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO43-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The <code class="literal">MessageChannel</code> from which this Endpoint receives <code class="literal">Message</code> s.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO43-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A reference to a <code class="literal">RedisConnectionFactory</code> bean.
Defaults to <code class="literal">redisConnectionFactory</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO43-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The name of the Redis List on which the queue-based <span class="emphasis"><em>push</em></span> operation is performed to send Redis messages.
This attribute is mutually exclusive with <code class="literal">queue-expression</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO43-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A SpEL <code class="literal">Expression</code> to determine the name of the Redis List using the incoming <code class="literal">Message</code> at runtime as the <code class="literal">#root</code> variable.
This attribute is mutually exclusive with <code class="literal">queue</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO43-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A <code class="literal">RedisSerializer</code> bean reference.
By default it is a <code class="literal">JdkSerializationRedisSerializer</code>.
However, for <code class="literal">String</code> payloads, a <code class="literal">StringRedisSerializer</code> is used, if a <code class="literal">serializer</code> reference isn&#8217;t provided.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO43-7"><span><img src="images/callouts/7.png" alt="7" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Specify if this Endpoint should send just the <span class="emphasis"><em>payload</em></span> to the Redis queue, or the entire <code class="literal">Message</code>.
Default is <code class="literal">true</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO43-8"><span><img src="images/callouts/8.png" alt="8" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Specify whether this Endpoint should use <span class="emphasis"><em>left push</em></span> (when <code class="literal">true</code>) or <span class="emphasis"><em>right push</em></span> (when <code class="literal">false</code>) to write messages to the Redis List.
If <code class="literal">true</code>, the Redis List acts as a <code class="literal">FIFO</code> queue when used with a default <span class="emphasis"><em>Redis Queue Inbound Channel Adapter</em></span>. Set to <code class="literal">false</code> to use with software
that reads from the list with <span class="emphasis"><em>left pop</em></span>, or to achieve a stack-like message order.
Default is <code class="literal">true</code>.
Since <span class="emphasis"><em>version 4.3</em></span>.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="redis-application-events" href="#redis-application-events"></a>24.3.6&nbsp;Redis Application Events</h3></div></div></div>

<p>Since <span class="emphasis"><em>Spring Integration 3.0</em></span>, the Redis module provides an implementation of <code class="literal">IntegrationEvent</code> - which, in turn, is a <code class="literal">org.springframework.context.ApplicationEvent</code>.
The <code class="literal">RedisExceptionEvent</code> encapsulates an <code class="literal">Exception</code> s from Redis operations (with the Endpoint being the <code class="literal">source</code> of the event).
For example, the <code class="literal">&lt;int-redis:queue-inbound-channel-adapter/&gt;</code> emits those events after catching <code class="literal">Exception</code> s from the <code class="literal">BoundListOperations.rightPop</code> operation.
The exception may be any generic <code class="literal">org.springframework.data.redis.RedisSystemException</code> or a <code class="literal">org.springframework.data.redis.RedisConnectionFailureException</code>.
Handling these events using an <code class="literal">&lt;int-event:inbound-channel-adapter/&gt;</code> can be useful to determine problems with background Redis tasks and to take administrative actions.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="redis-message-store" href="#redis-message-store"></a>24.4&nbsp;Redis Message Store</h2></div></div></div>

<p>As described in EIP, a <a class="ulink" href="http://www.eaipatterns.com/MessageStore.html" target="_top">Message Store</a> allows you to persist Messages.
This can be very useful when dealing with components that have a capability to buffer messages (<span class="emphasis"><em>Aggregator, Resequencer</em></span>, etc.) if reliability is a concern.
In Spring Integration, the MessageStore strategy also provides the foundation for the <a class="ulink" href="http://www.eaipatterns.com/StoreInLibrary.html" target="_top">ClaimCheck</a> pattern, which is described in EIP as well.</p>
<p>Spring Integration&#8217;s Redis module provides the <code class="literal">RedisMessageStore</code>.</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"redisMessageStore"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.redis.store.RedisMessageStore"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"redisConnectionFactory"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;int:aggregator</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"inputChannel"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"outputChannel"</span>
         <span class="hl-attribute">message-store</span>=<span class="hl-value">"redisMessageStore"</span><span class="hl-tag">/&gt;</span></pre>
<p>Above is a sample <code class="literal">RedisMessageStore</code> configuration that shows its usage by an <span class="emphasis"><em>Aggregator</em></span>.
As you can see it is a simple bean configuration, and it expects a <code class="literal">RedisConnectionFactory</code> as a constructor argument.</p>
<p>By default the <code class="literal">RedisMessageStore</code> will use Java serialization to serialize the Message.
However if you want to use a different serialization technique (e.g., JSON), you can provide your own serializer via the <code class="literal">valueSerializer</code> property of the <code class="literal">RedisMessageStore</code>.</p>
<p>Starting with <span class="emphasis"><em>version 4.3.10</em></span>, the Framework provides Jackson Serializer and Deserializer implementations for <code class="literal">Message`s and `MessageHeaders</code> - <code class="literal">MessageHeadersJacksonSerializer</code> and <code class="literal">MessageJacksonDeserializer</code>, respectively.
They have to be configured via the <code class="literal">SimpleModule</code> options for the <code class="literal">ObjectMapper</code>.
In addition, <code class="literal">enableDefaultTyping</code> should be configured on the <code class="literal">ObjectMapper</code> to add type information for each serialized complex object.
That type information is then used during deserialization.
The Framework provides a utility method <code class="literal">JacksonJsonUtils.messagingAwareMapper()</code>, which is already supplied with all the above-mentioned properties and serializers.
To manage JSON serialization in the <code class="literal">RedisMessageStore</code>, it must be configured like so:</p>
<pre class="programlisting">RedisMessageStore store = <span class="hl-keyword">new</span> RedisMessageStore(jedisConnectionFactory);
ObjectMapper mapper = JacksonJsonUtils.messagingAwareMapper();
RedisSerializer&lt;Object&gt; serializer = <span class="hl-keyword">new</span> GenericJackson2JsonRedisSerializer(mapper);
store.setValueSerializer(serializer);</pre>
<p>Starting with version <span class="emphasis"><em>4.3.12</em></span>, the <code class="literal">RedisMessageStore</code> supports the key <code class="literal">prefix</code> option to allow distinguishing between instances of the store on the same Redis server.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="redis-cms" href="#redis-cms"></a>24.4.1&nbsp;Redis Channel Message Stores</h3></div></div></div>

<p>The <code class="literal">RedisMessageStore</code> above maintains each group as a value under a single key (the group id).
While this can be used to back a <code class="literal">QueueChannel</code> for persistence, a specialized <code class="literal">RedisChannelMessageStore</code> is provided for that purpose (since <span class="emphasis"><em>version 4.0</em></span>).
This store uses a <code class="literal">LIST</code> for each channel and <code class="literal">LPUSH</code> when sending and <code class="literal">RPOP</code> when receiving messages.
This store also uses JDK serialization by default, but the value serializer can be modified as described above.</p>
<p>It is recommended that this store is used for backing channels, instead of the general <code class="literal">RedisMessageStore</code>.</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"redisMessageStore"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.redis.store.RedisChannelMessageStore"</span><span class="hl-tag">&gt;</span>
	<span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"redisConnectionFactory"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"somePersistentQueueChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:queue</span> <span class="hl-attribute">message-store</span>=<span class="hl-value">"redisMessageStore"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;int:channel&gt;</span></pre>
<p>The keys that are used to store the data have the form <code class="literal">&lt;storeBeanName&gt;:&lt;channelId&gt;</code> (in the above example, <code class="literal">redisMessageStore:somePersistentQueueChannel</code>).</p>
<p>In addition, a subclass <code class="literal">RedisChannelPriorityMessageStore</code> is also provided.
When this is used with a <code class="literal">QueueChannel</code>, the messages are received in (FIFO within) priority order.
It uses the standard <code class="literal">IntegrationMessageHeaderAccessor.PRIORITY</code> header and supports priority values <code class="literal">0 - 9</code>; messages with other priorities (and messages with no priority) are retrieved in FIFO order after any messages with priority.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>These stores implement only <code class="literal">BasicMessageGroupStore</code> and do not implement <code class="literal">MessageGroupStore</code>; they can only be used for situations such as backing a <code class="literal">QueueChannel</code>.</p>
</td></tr></table></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="redis-metadata-store" href="#redis-metadata-store"></a>24.5&nbsp;Redis Metadata Store</h2></div></div></div>

<p>As of <span class="emphasis"><em>Spring Integration 3.0</em></span> a new Redis-based <a class="ulink" href="http://docs.spring.io/spring-integration/docs/latest-ga/api/org/springframework/integration/metadata/MetadataStore.html" target="_top">MetadataStore</a> (<a class="xref" href="#metadata-store" title="9.5&nbsp;Metadata Store">Section&nbsp;9.5, &#8220;Metadata Store&#8221;</a>) implementation is available.
The <code class="literal">RedisMetadataStore</code> can be used to maintain state of a <code class="literal">MetadataStore</code> across application restarts.
This new <code class="literal">MetadataStore</code> implementation can be used with adapters such as:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="xref" href="#twitter-inbound" title="32.4&nbsp;Twitter Inbound Adapters">Section&nbsp;32.4, &#8220;Twitter Inbound Adapters&#8221;</a>
</li><li class="listitem">
<a class="xref" href="#feed-inbound-channel-adapter" title="13.2&nbsp;Feed Inbound Channel Adapter">Section&nbsp;13.2, &#8220;Feed Inbound Channel Adapter&#8221;</a>
</li><li class="listitem">
<a class="xref" href="#file-reading" title="14.2&nbsp;Reading Files">Section&nbsp;14.2, &#8220;Reading Files&#8221;</a>
</li><li class="listitem">
<a class="xref" href="#ftp-inbound" title="15.4&nbsp;FTP Inbound Channel Adapter">Section&nbsp;15.4, &#8220;FTP Inbound Channel Adapter&#8221;</a>
</li><li class="listitem">
<a class="xref" href="#sftp-inbound" title="27.7&nbsp;SFTP Inbound Channel Adapter">Section&nbsp;27.7, &#8220;SFTP Inbound Channel Adapter&#8221;</a>
</li></ul></div>
<p>In order to instruct these adapters to use the new <code class="literal">RedisMetadataStore</code> simply declare a Spring bean using the bean name <span class="strong"><strong>metadataStore</strong></span>.
The <span class="emphasis"><em>Twitter Inbound Channel Adapter</em></span> and the <span class="emphasis"><em>Feed Inbound Channel Adapter</em></span> will both automatically pick up and use the declared <code class="literal">RedisMetadataStore</code>.</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">name</span>=<span class="hl-value">"metadataStore"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.redis.store.metadata.RedisMetadataStore"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">name</span>=<span class="hl-value">"connectionFactory"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"redisConnectionFactory"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
<p>The <code class="literal">RedisMetadataStore</code> is backed by <a class="ulink" href="http://docs.spring.io/spring-data/data-redis/docs/current/api/org/springframework/data/redis/support/collections/RedisProperties.html" target="_top"><code class="literal">RedisProperties</code></a> and interaction with it uses <a class="ulink" href="http://docs.spring.io/spring-data/data-redis/docs/current/api/org/springframework/data/redis/core/BoundHashOperations.html" target="_top"><code class="literal">BoundHashOperations</code></a>, which, in turn, requires a <code class="literal">key</code> for the entire <code class="literal">Properties</code> store.
In the case of the <code class="literal">MetadataStore</code>, this <code class="literal">key</code> plays the role of a <span class="emphasis"><em>region</em></span>, which is useful in distributed environment, when several applications use the same Redis server.
By default this <code class="literal">key</code> has the value <code class="literal">MetaData</code>.</p>
<p>Starting with <span class="emphasis"><em>version 4.0</em></span>, this store now implements <code class="literal">ConcurrentMetadataStore</code>, allowing it to be reliably shared across multiple application instances where only one instance will be allowed to store or modify a key&#8217;s value.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="redis-store-inbound-channel-adapter" href="#redis-store-inbound-channel-adapter"></a>24.6&nbsp;RedisStore Inbound Channel Adapter</h2></div></div></div>

<p>The <span class="emphasis"><em>RedisStore Inbound Channel Adapter</em></span> is a polling consumer that reads data from a Redis collection and sends it as a Message payload.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-redis:store-inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"listAdapter"</span>
    <span class="hl-attribute">connection-factory</span>=<span class="hl-value">"redisConnectionFactory"</span>
    <span class="hl-attribute">key</span>=<span class="hl-value">"myCollection"</span>
    <span class="hl-attribute">channel</span>=<span class="hl-value">"redisChannel"</span>
    <span class="hl-attribute">collection-type</span>=<span class="hl-value">"LIST"</span><span class="hl-tag"> &gt;</span>
    <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"2000"</span> <span class="hl-attribute">max-messages-per-poll</span>=<span class="hl-value">"10"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-redis:store-inbound-channel-adapter&gt;</span></pre>
<p>As you can see from the configuration above you configure a <span class="emphasis"><em>Redis Store Inbound Channel Adapter</em></span> using the <code class="literal">store-inbound-channel-adapter</code> element, providing values for various attributes such as:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">key</code> or <code class="literal">key-expression</code> - The name of the key for the collection being used.
</li><li class="listitem">
<code class="literal">collection-type</code> - enumeration of the Collection types supported by this adapter.
Supported Collections are: LIST, SET, ZSET, PROPERTIES, MAP
</li><li class="listitem">
<code class="literal">connection-factory</code> - reference to an instance of <code class="literal">o.s.data.redis.connection.RedisConnectionFactory</code>
</li><li class="listitem">
<code class="literal">redis-template</code> - reference to an instance of <code class="literal">o.s.data.redis.core.RedisTemplate</code>
</li></ul></div>
<p>and other attributes that are common across all other inbound adapters (e.g., <span class="emphasis"><em>channel</em></span>).</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>You cannot set both <code class="literal">redis-template</code> and <code class="literal">connection-factory</code>.</p>
</td></tr></table></div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>By default, the adapter uses a <code class="literal">StringRedisTemplate</code>; this uses <code class="literal">StringRedisSerializer</code> s for keys, values, hash keys and hash values.
If your Redis store contains objects that are serialized with other techniques, you must supply a <code class="literal">RedisTemplate</code> configured with appropriate serializers.
For example, if the store is written to using a RedisStore Outbound Adapter that has its <code class="literal">extract-payload-elements</code> set to false, you must provide a <code class="literal">RedisTemplate</code> configured thus:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"redisTemplate"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.data.redis.core.RedisTemplate"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"connectionFactory"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"redisConnectionFactory"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"keySerializer"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.data.redis.serializer.StringRedisSerializer"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"hashKeySerializer"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.data.redis.serializer.StringRedisSerializer"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
<p>This uses String serializers for keys and hash keys and the default JDK Serialization serializers for values and hash values.</p>
</td></tr></table></div>
<p>The example above is relatively simple and static since it has a literal value for the <code class="literal">key</code>.
Sometimes, you may need to change the value of the key at runtime based on some condition.
To do that, simply use <code class="literal">key-expression</code> instead, where the provided expression can be any valid SpEL expression.</p>
<p>Also, you may wish to perform some post-processing to the successfully processed data that was read from the Redis collection.
For example; you may want to move or remove the value after its been processed.
You can do this using the Transaction Synchronization feature that was added with Spring Integration 2.2.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-redis:store-inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"zsetAdapterWithSingleScoreAndSynchronization"</span>
        <span class="hl-attribute">connection-factory</span>=<span class="hl-value">"redisConnectionFactory"</span>
        <span class="hl-attribute">key-expression</span>=<span class="hl-value">"'presidents'"</span>
        <span class="hl-attribute">channel</span>=<span class="hl-value">"otherRedisChannel"</span>
        <span class="hl-attribute">auto-startup</span>=<span class="hl-value">"false"</span>
        <span class="hl-attribute">collection-type</span>=<span class="hl-value">"ZSET"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"1000"</span> <span class="hl-attribute">max-messages-per-poll</span>=<span class="hl-value">"2"</span><span class="hl-tag">&gt;</span>
                <span class="hl-tag">&lt;int:transactional</span> <span class="hl-attribute">synchronization-factory</span>=<span class="hl-value">"syncFactory"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;/int:poller&gt;</span>
<span class="hl-tag">&lt;/int-redis:store-inbound-channel-adapter&gt;</span>

<span class="hl-tag">&lt;int:transaction-synchronization-factory</span> <span class="hl-attribute">id</span>=<span class="hl-value">"syncFactory"</span><span class="hl-tag">&gt;</span>
	<span class="hl-tag">&lt;int:after-commit</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"payload.removeByScore(18, 18)"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:transaction-synchronization-factory&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"transactionManager"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.transaction.PseudoTransactionManager"</span><span class="hl-tag">/&gt;</span></pre>
<p>As you can see from the above all, you need to do is declare your poller to be transactional with a <code class="literal">transactional</code> element.
This element can reference a real transaction manager (for example if some other part of your flow invokes JDBC).
If you don&#8217;t have a <span class="emphasis"><em>real</em></span> transaction, you can use a <code class="literal">o.s.i.transaction.PseudoTransactionManager</code> which is an implementation of Spring&#8217;s <code class="literal">PlatformTransactionManager</code> and enables the use of the transaction synchronization features of the redis adapter when there is no actual transaction.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>This does NOT make the Redis activities themselves transactional, it simply allows the synchronization of actions to be taken before/after success (commit) or after failure (rollback).</p>
</td></tr></table></div>
<p>Once your poller is transactional all you need to do is set an instance of the <code class="literal">o.s.i.transaction.TransactionSynchronizationFactory</code> on the <code class="literal">transactional</code> element.
<code class="literal">TransactionSynchronizationFactory</code> will create an instance of the <code class="literal">TransactionSynchronization</code>.
For your convenience we&#8217;ve exposed a default SpEL-based <code class="literal">TransactionSynchronizationFactory</code> which allows you to configure SpEL expressions, with their execution being coordinated (synchronized) with a transaction.
Expressions for before-commit, after-commit, and after-rollback are supported, together with a channel for each where the evaluation result (if any) will be sent.
For each sub-element you can specify <code class="literal">expression</code> and/or <code class="literal">channel</code> attributes.
If only the <code class="literal">channel</code> attribute is present the received Message will be sent there as part of the particular synchronization scenario.
If only the <code class="literal">expression</code> attribute is present and the result of an expression is a non-Null value, a Message with the result as the payload will be generated and sent to a default channel (NullChannel) and will appear in the logs (DEBUG).
If you want the evaluation result to go to a specific channel add a <code class="literal">channel</code> attribute.
If the result of an expression is null or void, no Message will be generated.</p>
<p>For more information about transaction synchronization, see <a class="xref" href="#transaction-synchronization" title="C.3&nbsp;Transaction Synchronization">Section&nbsp;C.3, &#8220;Transaction Synchronization&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="redis-store-outbound-channel-adapter" href="#redis-store-outbound-channel-adapter"></a>24.7&nbsp;RedisStore Outbound Channel Adapter</h2></div></div></div>

<p>The <span class="emphasis"><em>RedisStore Outbound Channel Adapter</em></span> allows you to write a Message payload to a Redis collection</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-redis:store-outbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"redisListAdapter"</span>
          <span class="hl-attribute">collection-type</span>=<span class="hl-value">"LIST"</span>
          <span class="hl-attribute">channel</span>=<span class="hl-value">"requestChannel"</span>
          <span class="hl-attribute">key</span>=<span class="hl-value">"myCollection"</span><span class="hl-tag"> /&gt;</span></pre>
<p>As you can see from the configuration above, you configure a <span class="emphasis"><em>Redis Store Outbound Channel Adapter</em></span> using the <code class="literal">store-inbound-channel-adapter</code> element, providing values for various attributes such as:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">key</code> or <code class="literal">key-expression</code> - The name of the key for the collection being used.
</li><li class="listitem">
<code class="literal">extract-payload-elements</code> - If set to <code class="literal">true</code> (Default) and the payload is an instance of a "multi- value" object (i.e., Collection or Map) it will be stored using addAll/ putAll semantics.
Otherwise, if set to <code class="literal">false</code> the payload will be stored as a single entry regardless of its type.
If the payload is not an instance of a "multi-value" object, the value of this attribute is ignored and the payload will always be stored as a single entry.
</li><li class="listitem">
<code class="literal">collection-type</code> - enumeration of the Collection types supported by this adapter.
Supported Collections are: LIST, SET, ZSET, PROPERTIES, MAP
</li><li class="listitem">
<code class="literal">map-key-expression</code> - SpEL expression that returns the name of the key for entry being stored.
Only applies if the <code class="literal">collection-type</code> is MAP or PROPERTIES and <span class="emphasis"><em>extract-payload-elements</em></span> is false.
</li><li class="listitem">
<code class="literal">connection-factory</code> - reference to an instance of <code class="literal">o.s.data.redis.connection.RedisConnectionFactory</code>
</li><li class="listitem">
<code class="literal">redis-template</code> - reference to an instance of <code class="literal">o.s.data.redis.core.RedisTemplate</code>
</li></ul></div>
<p>and other attributes that are common across all other inbound adapters (e.g., <span class="emphasis"><em>channel</em></span>).</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>You cannot set both <code class="literal">redis-template</code> and <code class="literal">connection-factory</code>.</p>
</td></tr></table></div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>By default, the adapter uses a <code class="literal">StringRedisTemplate</code>; this uses <code class="literal">StringRedisSerializer</code> s for keys, values, hash keys and hash values.
However, if <code class="literal">extract-payload-elements</code> is set to false, a <code class="literal">RedisTemplate</code> using <code class="literal">StringRedisSerializer</code> s for keys and hash keys, and <code class="literal">JdkSerializationRedisSerializer</code> s for values and hash values will be used.
With the JDK serializer, it is important to understand that java serialization is used for all values, regardless of whether the value is actually a collection or not.
If you need more control over the serialization of values, you may want to consider providing your own <code class="literal">RedisTemplate</code> rather than relying upon these defaults.</p>
</td></tr></table></div>
<p>The example above is relatively simple and static since it has a literal values for the <code class="literal">key</code> and other attributes.
Sometimes you may need to change the values dynamically at runtime based on some condition.
To do that simply use their <code class="literal">-expression</code> equivalents (<code class="literal">key-expression</code>, <code class="literal">map-key-expression</code> etc.) where the provided expression can be any valid SpEL expression.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="redis-outbound-gateway" href="#redis-outbound-gateway"></a>24.8&nbsp;Redis Outbound Command Gateway</h2></div></div></div>

<p>Since <span class="emphasis"><em>Spring Integration 4.0</em></span>, the Redis Command Gateway is available to perform any standard Redis command using generic <code class="literal">RedisConnection#execute</code> method:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-redis:outbound-gateway</span>
        <span class="hl-attribute">request-channel</span>=<span class="hl-value">""</span>  <a name="CO44-1" href="#CO44-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
        reply-channel=""  <a name="CO44-2" href="#CO44-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
        requires-reply=""  <a name="CO44-3" href="#CO44-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
        reply-timeout=""  <a name="CO44-4" href="#CO44-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
        connection-factory=""  <a name="CO44-5" href="#CO44-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
        redis-template=""  <a name="CO44-6" href="#CO44-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>
        arguments-serializer=""  <a name="CO44-7" href="#CO44-7"></a><span><img src="images/callouts/7.png" alt="7" border="0"></span>
        command-expression=""  <a name="CO44-8" href="#CO44-8"></a><span><img src="images/callouts/8.png" alt="8" border="0"></span>
        argument-expressions=""  <a name="CO44-9" href="#CO44-9"></a><span><img src="images/callouts/9.png" alt="9" border="0"></span>
        use-command-variable=""  <a name="CO44-10" href="#CO44-10"></a><span><img src="images/callouts/10.png" alt="10" border="0"></span>
        arguments-strategy="" /&gt; <a name="CO44-11" href="#CO44-11"></a><span><img src="images/callouts/11.png" alt="11" border="0"></span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO44-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The <code class="literal">MessageChannel</code> from which this Endpoint receives <code class="literal">Message</code> s.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO44-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The <code class="literal">MessageChannel</code> where this Endpoint sends reply <code class="literal">Message</code> s.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO44-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Specify whether this outbound gateway must return a non-null value.
This value is <code class="literal">true</code> by default.
A ReplyRequiredException will be thrown when the Redis returns a <code class="literal">null</code> value.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO44-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The timeout in milliseconds to wait until the reply message will be sent or not.
Typically is applied for queue-based limited reply-channels.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO44-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A reference to a <code class="literal">RedisConnectionFactory</code> bean.
Defaults to <code class="literal">redisConnectionFactory</code>.
Mutually exclusive with <span class="emphasis"><em>redis-template</em></span> attribute.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO44-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A reference to a <code class="literal">RedisTemplate</code> bean.
Mutually exclusive with <span class="emphasis"><em>connection-factory</em></span> attribute.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO44-7"><span><img src="images/callouts/7.png" alt="7" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Reference to an instance of <code class="literal">org.springframework.data.redis.serializer.RedisSerializer</code>.
Used to serialize each command argument to byte[] if necessary.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO44-8"><span><img src="images/callouts/8.png" alt="8" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The SpEL expression that returns the command key.
Default is the <code class="literal">redis_command</code> message header.
Must not evaluate to <code class="literal">null</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO44-9"><span><img src="images/callouts/9.png" alt="9" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Comma-separate SpEL expressions that will be evaluated as command arguments.
Mutually exclusive with the <code class="literal">arguments-strategy</code> attribute.
If neither of them is provided the <code class="literal">payload</code> is used as the command argument(s).
Argument expressions may evaluate to <span class="emphasis"><em>null</em></span>, to support a variable number of arguments.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO44-10"><span><img src="images/callouts/10.png" alt="10" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A <code class="literal">boolean</code> flag to specify if the evaluated Redis command string will be made available as the <code class="literal">#cmd</code> variable in the expression evaluation context in the <code class="literal">o.s.i.redis.outbound.ExpressionArgumentsStrategy</code> when <code class="literal">argument-expressions</code> is configured, otherwise this attribute is ignored.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO44-11"><span><img src="images/callouts/11.png" alt="11" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Reference to an instance of <code class="literal">o.s.i.redis.outbound.ArgumentsStrategy</code>.
Mutually exclusive with <code class="literal">argument-expressions</code> attribute.
If neither of them is provided the <code class="literal">payload</code> is used as the command argument(s).</p>
</td></tr></table></div>
<p>The <code class="literal">&lt;int-redis:outbound-gateway&gt;</code> can be used as a common component to perform any desired Redis operation.
For example to get incremented value from Redis Atomic Number:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-redis:outbound-gateway</span> <span class="hl-attribute">request-channel</span>=<span class="hl-value">"requestChannel"</span>
    <span class="hl-attribute">reply-channel</span>=<span class="hl-value">"replyChannel"</span>
    <span class="hl-attribute">command-expression</span>=<span class="hl-value">"'INCR'"</span><span class="hl-tag">/&gt;</span></pre>
<p>where the Message <code class="literal">payload</code> should be a name of <code class="literal">redisCounter</code>, which may be provided by <code class="literal">org.springframework.data.redis.support.atomic.RedisAtomicInteger</code> bean definition.</p>
<p>The <code class="literal">RedisConnection#execute</code> has a generic <code class="literal">Object</code> as return type and real result depends on command type, for example <code class="literal">MGET</code> returns a <code class="literal">List&lt;byte[]&gt;</code>.
For more information about commands, their arguments and result type seehttp://redis.io/commands[Redis Specification].</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="redis-queue-outbound-gateway" href="#redis-queue-outbound-gateway"></a>24.9&nbsp;Redis Queue Outbound Gateway</h2></div></div></div>

<p>Since <span class="emphasis"><em>Spring Integration 4.1</em></span>, the Redis Queue Outbound Gateway is available to perform request and reply scenarios.
It pushes a <span class="emphasis"><em>conversation</em></span>`UUID` to the provided <code class="literal">queue</code>, then pushes the value to a Redis List with that <code class="literal">UUID</code> as its key and waits for the reply from a Redis List with a key of <code class="literal">UUID + '.reply'</code>.
A different UUID is used for each interaction.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-redis:queue-outbound-gateway</span>
        <span class="hl-attribute">request-channel</span>=<span class="hl-value">""</span>  <a name="CO45-1" href="#CO45-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
        reply-channel=""  <a name="CO45-2" href="#CO45-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
        requires-reply=""  <a name="CO45-3" href="#CO45-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
        reply-timeout=""  <a name="CO45-4" href="#CO45-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
        connection-factory=""  <a name="CO45-5" href="#CO45-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
        queue=""  <a name="CO45-6" href="#CO45-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>
        order=""  <a name="CO45-7" href="#CO45-7"></a><span><img src="images/callouts/7.png" alt="7" border="0"></span>
        serializer=""  <a name="CO45-8" href="#CO45-8"></a><span><img src="images/callouts/8.png" alt="8" border="0"></span>
        extract-payload=""/&gt;  <a name="CO45-9" href="#CO45-9"></a><span><img src="images/callouts/9.png" alt="9" border="0"></span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO45-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The <code class="literal">MessageChannel</code> from which this Endpoint receives <code class="literal">Message</code> s.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO45-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The <code class="literal">MessageChannel</code> where this Endpoint sends reply <code class="literal">Message</code> s.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO45-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Specify whether this outbound gateway must return a non-null value.
This value is <code class="literal">false</code> by default, otherwise a ReplyRequiredException will be thrown when the Redis returns a <code class="literal">null</code> value.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO45-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The timeout in milliseconds to wait until the reply message will be sent or not.
Typically is applied for queue-based limited reply-channels.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO45-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A reference to a <code class="literal">RedisConnectionFactory</code> bean.
Defaults to <code class="literal">redisConnectionFactory</code>.
Mutually exclusive with <span class="emphasis"><em>redis-template</em></span> attribute.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO45-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The name of the Redis List to which outbound gateway will send a <span class="emphasis"><em>conversation</em></span>`UUID`.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO45-7"><span><img src="images/callouts/7.png" alt="7" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The order for this outbound gateway when multiple gateway are registered thereby</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO45-8"><span><img src="images/callouts/8.png" alt="8" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The <code class="literal">RedisSerializer</code> bean reference.
Can be an empty string, which means <span class="emphasis"><em>no serializer</em></span>.
In this case the raw <code class="literal">byte[]</code> from the inbound Redis message is sent to the <code class="literal">channel</code> as the <code class="literal">Message</code> payload.
By default it is a <code class="literal">JdkSerializationRedisSerializer</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO45-9"><span><img src="images/callouts/9.png" alt="9" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Specify if this Endpoint expects data from the Redis queue to contain entire <code class="literal">Message</code> s.
If this attribute is set to <code class="literal">true</code>, the <code class="literal">serializer</code> can&#8217;t be an empty string because messages require some form of deserialization (JDK serialization by default).</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="redis-queue-inbound-gateway" href="#redis-queue-inbound-gateway"></a>24.10&nbsp;Redis Queue Inbound Gateway</h2></div></div></div>

<p>Since <span class="emphasis"><em>Spring Integration 4.1</em></span>, the Redis Queue Inbound Gateway is available to perform request and reply scenarios.
It pops a <span class="emphasis"><em>conversation</em></span> <code class="literal">UUID</code> from the provided <code class="literal">queue</code>, then pops the value from the Redis List with that <code class="literal">UUID</code> as its key and pushes the reply to the Redis List with a key of <code class="literal">UUID + '.reply'</code>:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-redis:queue-inbound-gateway</span>
        <span class="hl-attribute">request-channel</span>=<span class="hl-value">""</span>  <a name="CO46-1" href="#CO46-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
        reply-channel=""  <a name="CO46-2" href="#CO46-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
        executor=""  <a name="CO46-3" href="#CO46-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
        reply-timeout=""  <a name="CO46-4" href="#CO46-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
        connection-factory=""  <a name="CO46-5" href="#CO46-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
        queue=""  <a name="CO46-6" href="#CO46-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>
        order=""  <a name="CO46-7" href="#CO46-7"></a><span><img src="images/callouts/7.png" alt="7" border="0"></span>
        serializer=""  <a name="CO46-8" href="#CO46-8"></a><span><img src="images/callouts/8.png" alt="8" border="0"></span>
        receive-timeout=""  <a name="CO46-9" href="#CO46-9"></a><span><img src="images/callouts/9.png" alt="9" border="0"></span>
        expect-message=""  <a name="CO46-10" href="#CO46-10"></a><span><img src="images/callouts/10.png" alt="10" border="0"></span>
        recovery-interval=""/&gt;  <a name="CO46-11" href="#CO46-11"></a><span><img src="images/callouts/11.png" alt="11" border="0"></span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO46-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The <code class="literal">MessageChannel</code> from which this Endpoint receives <code class="literal">Message</code> s.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO46-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The <code class="literal">MessageChannel</code> where this Endpoint sends reply <code class="literal">Message</code> s.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO46-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A reference to a Spring <code class="literal">TaskExecutor</code> (or standard JDK 1.5+ <code class="literal">Executor</code>) bean.
It is used for the underlying listening task.
By default a <code class="literal">SimpleAsyncTaskExecutor</code> is used.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO46-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The timeout in milliseconds to wait until the reply message will be sent or not.
Typically is applied for queue-based limited reply-channels.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO46-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A reference to a <code class="literal">RedisConnectionFactory</code> bean.
Defaults to <code class="literal">redisConnectionFactory</code>.
Mutually exclusive with <span class="emphasis"><em>redis-template</em></span> attribute.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO46-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The name of the Redis List for the <span class="emphasis"><em>conversation</em></span> <code class="literal">UUID</code> s.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO46-7"><span><img src="images/callouts/7.png" alt="7" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The order for this inbound gateway when multiple gateway are registered thereby</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO46-8"><span><img src="images/callouts/8.png" alt="8" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The <code class="literal">RedisSerializer</code> bean reference.
Can be an empty string, which means <span class="emphasis"><em>no serializer</em></span>.
In this case the raw <code class="literal">byte[]</code> from the inbound Redis message is sent to the <code class="literal">channel</code> as the <code class="literal">Message</code> payload.
By default it is a <code class="literal">JdkSerializationRedisSerializer</code>. (Note that in releases before <span class="emphasis"><em>version 4.3</em></span>, it was a
<code class="literal">StringRedisSerializer</code> by default; to restore that behavior provide a reference to a <code class="literal">StringRedisSerializer</code>).</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO46-9"><span><img src="images/callouts/9.png" alt="9" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The timeout in milliseconds to wait until the receive message will be get or not.
Typically is applied for queue-based limited request-channels.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO46-10"><span><img src="images/callouts/10.png" alt="10" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Specify if this Endpoint expects data from the Redis queue to contain entire <code class="literal">Message</code> s.
If this attribute is set to <code class="literal">true</code>, the <code class="literal">serializer</code> can&#8217;t be an empty string because messages require some form of deserialization (JDK serialization by default).</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO46-11"><span><img src="images/callouts/11.png" alt="11" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The time in milliseconds for which the listener task should sleep after exceptions on the <span class="emphasis"><em>right pop</em></span> operation,
before restarting the listener task.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="redis-lock-registry" href="#redis-lock-registry"></a>24.11&nbsp;Redis Lock Registry</h2></div></div></div>

<p>Starting with <span class="emphasis"><em>version 4.0</em></span>, the <code class="literal">RedisLockRegistry</code> is available.
Certain components (for example aggregator and resequencer) use a lock obtained from a <code class="literal">LockRegistry</code> instance to ensure that only one thread is manipulating a group at a time.
The <code class="literal">DefaultLockRegistry</code> performs this function within a single component; you can now configure an external lock registry on these components.
When used with a shared <code class="literal">MessageGroupStore</code>, the <code class="literal">RedisLockRegistry</code> can be use to provide this functionality across multiple application instances, such that only one instance can manipulate the group at a time.</p>
<p>When a lock is released by a local thread, another local thread will generally be able to acquire the lock immediately.
If a lock is released by a thread using a different registry instance, it can take up to 100ms to acquire the lock.</p>
<p>To avoid "hung" locks (when a server fails), the locks in this registry are expired after a default 60 seconds, but this can be configured on the registry.
Locks are normally held for a much smaller time.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Because the keys can expire, an attempt to unlock an expired lock will result in an exception being thrown.
However, be aware that the resources protected by such a lock may have been compromised so such exceptions should be considered severe.
The expiry should be set at a large enough value to prevent this condition, while small enough that the lock can be recovered after a server failure in a reasonable amount of time.</p>
</td></tr></table></div>
</div>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="resource" href="#resource"></a>25.&nbsp;Resource Support</h2></div></div></div>

<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="resource-intro" href="#resource-intro"></a>25.1&nbsp;Introduction</h2></div></div></div>

<p>The <span class="emphasis"><em>Resource Inbound Channel Adapter</em></span> builds upon Spring&#8217;s <code class="literal">Resource</code> abstraction to support greater flexibility across a variety of actual types of underlying resources, such as a file, a URL,  or a class path resource.
Therefore, it&#8217;s similar to but more generic than the <span class="emphasis"><em>File Inbound Channel Adapter</em></span>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="resource-inbound-channel-adapter" href="#resource-inbound-channel-adapter"></a>25.2&nbsp;Resource Inbound Channel Adapter</h2></div></div></div>

<p>The <span class="emphasis"><em>Resource Inbound Channel Adapter</em></span> is a polling adapter that creates a <code class="literal">Message</code> whose payload is a collection of <code class="literal">Resource</code> objects.</p>
<p><code class="literal">Resource</code> objects are resolved based on the pattern specified using the <code class="literal">pattern</code> attribute.
The collection of resolved <code class="literal">Resource</code> objects is then sent as a payload within a <code class="literal">Message</code> to the adapter&#8217;s channel.
That is one major difference between <span class="emphasis"><em>Resource Inbound Channel Adapter</em></span> and <span class="emphasis"><em>File Inbound Channel Adapter</em></span>; the latter buffers File objects and sends a single <code class="literal">File</code> object per <code class="literal">Message</code>.</p>
<p>Below is an example of a very simple configuration which will find all files ending with the <span class="emphasis"><em>properties</em></span> extension in the <code class="literal">foo.bar</code> package available on the classpath and will send them as the payload of a Message to the channel named <span class="emphasis"><em><code class="literal">resultChannel</code></em></span>:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:resource-inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"resourceAdapter"</span>
               <span class="hl-attribute">channel</span>=<span class="hl-value">"resultChannel"</span>
               <span class="hl-attribute">pattern</span>=<span class="hl-value">"classpath:foo/bar/*.properties"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"1000"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:resource-inbound-channel-adapter&gt;</span></pre>
<p>The <span class="emphasis"><em>Resource Inbound Channel Adapter</em></span> relies on the <code class="literal">org.springframework.core.io.support.ResourcePatternResolver</code> strategy interface to resolve the provided pattern.
It defaults to an instance of the current <code class="literal">ApplicationContext</code>.
However you may provide a reference to an instance of your own implementation of <code class="literal">ResourcePatternResolver</code> using the <code class="literal">pattern-resolver</code> attribute:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:resource-inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"resourceAdapter"</span>
               <span class="hl-attribute">channel</span>=<span class="hl-value">"resultChannel"</span>
               <span class="hl-attribute">pattern</span>=<span class="hl-value">"classpath:foo/bar/*.properties"</span>
               <span class="hl-attribute">pattern-resolver</span>=<span class="hl-value">"myPatternResolver"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"1000"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:resource-inbound-channel-adapter&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myPatternResolver"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.example.MyPatternResolver"</span><span class="hl-tag">/&gt;</span></pre>
<p>You may have a use case where you need to further filter the collection of resources resolved by the <code class="literal">ResourcePatternResolver</code>.
For example, you may want to prevent resources that were resolved already from appearing in a collection of resolved resources ever again.
On the other hand  your resources might be updated rather often and you <span class="emphasis"><em>do</em></span> want them to be picked up again.
In other words there is a valid use case for defining an additional filter as well as disabling filtering altogether.
You can provide your own implementation of the <code class="literal">org.springframework.integration.util.CollectionFilter</code> strategy interface:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> CollectionFilter&lt;T&gt; {

    Collection&lt;T&gt; filter(Collection&lt;T&gt; unfilteredElements);

}</pre>
<p>As you can see the <code class="literal">CollectionFilter</code> receives a collection of un-filtered elements (which would be <code class="literal">Resource</code> objects in this case), and it returns a collection of filtered elements of that same type.</p>
<p>If you are defining the adapter via XML but you do not specify a filter reference, a default implementation of <code class="literal">CollectionFilter</code> will be used by the <span class="emphasis"><em>Resource Inbound Channel Adapter</em></span>.
The implementation class of that default filter is <code class="literal">org.springframework.integration.util.AcceptOnceCollectionFilter</code>.
It remembers the elements passed in the previous invocation in order to avoid returning those elements more than once.</p>
<p>To inject your own implementation of <code class="literal">CollectionFilter</code> instead, use the <code class="literal">filter</code> attribute.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:resource-inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"resourceAdapter"</span>
               <span class="hl-attribute">channel</span>=<span class="hl-value">"resultChannel"</span>
               <span class="hl-attribute">pattern</span>=<span class="hl-value">"classpath:foo/bar/*.properties"</span>
               <span class="hl-attribute">filter</span>=<span class="hl-value">"myFilter"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"1000"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:resource-inbound-channel-adapter&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myFilter"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.example.MyFilter"</span><span class="hl-tag">/&gt;</span></pre>
<p>If you don&#8217;t need any filtering and want to disable even the default <code class="literal">CollectionFilter</code> strategy, simply provide an empty value for the filter attribute (e.g., <code class="literal">filter=""</code>)</p>
</div>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="rmi" href="#rmi"></a>26.&nbsp;RMI Support</h2></div></div></div>

<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="rmi-intro" href="#rmi-intro"></a>26.1&nbsp;Introduction</h2></div></div></div>

<p>This Chapter explains how to use RMI specific channel adapters to distribute a system over multiple JVMs.
The first section will deal with sending messages over RMI.
The second section shows how to receive messages over RMI.
The last section shows how to define rmi channel adapters through the namespace support.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="rmi-outbound" href="#rmi-outbound"></a>26.2&nbsp;Outbound RMI</h2></div></div></div>

<p>To send messages from a channel over RMI, simply define an <code class="literal">RmiOutboundGateway</code>.
This gateway will use Spring&#8217;s RmiProxyFactoryBean internally to create a proxy for a remote gateway.
Note that to invoke a remote interface that doesn&#8217;t use Spring Integration you should use a service activator in combination with Spring&#8217;s RmiProxyFactoryBean.</p>
<p>To configure the outbound gateway write a bean definition like this:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"rmiOutGateway"</span> <span class="hl-attribute">class</span>=<span class="hl-value">org.spf.integration.rmi.RmiOutboundGateway</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"rmi://host"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"replyChannel"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"replies"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="rmi-inbound" href="#rmi-inbound"></a>26.3&nbsp;Inbound RMI</h2></div></div></div>

<p>To receive messages over RMI you need to use a <code class="literal">RmiInboundGateway</code>.
This gateway can be configured like this</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"rmiOutGateway"</span> <span class="hl-attribute">class</span>=<span class="hl-value">org.spf.integration.rmi.RmiInboundGateway</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"requestChannel"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"requests"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>If you use an <code class="literal">errorChannel</code> on an inbound gateway, it would be normal for the error flow to return a result (or throw an exception).
This is because it is likely that there is a corresponding outbound gateway waiting for a response of some kind.
Consuming a message on the error flow, and not replying, will result in no reply at the inbound gateway.
Exceptions (on the main flow when there is no errorChannel, or on the error flow) will be propagated to the corresponding inbound gateway.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="rmi-namespace" href="#rmi-namespace"></a>26.4&nbsp;RMI namespace support</h2></div></div></div>

<p>To configure the inbound gateway you can choose to use the namespace support for it.
The following code snippet shows the different configuration options that are supported.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-rmi:inbound-gateway</span> <span class="hl-attribute">id</span>=<span class="hl-value">"gatewayWithDefaults"</span> <span class="hl-attribute">request-channel</span>=<span class="hl-value">"testChannel"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int-rmi:inbound-gateway</span> <span class="hl-attribute">id</span>=<span class="hl-value">"gatewayWithCustomProperties"</span> <span class="hl-attribute">request-channel</span>=<span class="hl-value">"testChannel"</span>
    <span class="hl-attribute">expect-reply</span>=<span class="hl-value">"false"</span> <span class="hl-attribute">request-timeout</span>=<span class="hl-value">"123"</span> <span class="hl-attribute">reply-timeout</span>=<span class="hl-value">"456"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int-rmi:inbound-gateway</span> <span class="hl-attribute">id</span>=<span class="hl-value">"gatewayWithHost"</span> <span class="hl-attribute">request-channel</span>=<span class="hl-value">"testChannel"</span>
    <span class="hl-attribute">registry-host</span>=<span class="hl-value">"localhost"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int-rmi:inbound-gateway</span> <span class="hl-attribute">id</span>=<span class="hl-value">"gatewayWithPort"</span> <span class="hl-attribute">request-channel</span>=<span class="hl-value">"testChannel"</span>
    <span class="hl-attribute">registry-port</span>=<span class="hl-value">"1234"</span> <span class="hl-attribute">error-channel</span>=<span class="hl-value">"rmiErrorChannel"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int-rmi:inbound-gateway</span> <span class="hl-attribute">id</span>=<span class="hl-value">"gatewayWithExecutorRef"</span> <span class="hl-attribute">request-channel</span>=<span class="hl-value">"testChannel"</span>
    <span class="hl-attribute">remote-invocation-executor</span>=<span class="hl-value">"invocationExecutor"</span><span class="hl-tag">/&gt;</span></pre>
<p>To configure the outbound gateway you can use the namespace support as well.
The following code snippet shows the different configuration for an outbound rmi gateway.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-rmi:outbound-gateway</span> <span class="hl-attribute">id</span>=<span class="hl-value">"gateway"</span>
    <span class="hl-attribute">request-channel</span>=<span class="hl-value">"localChannel"</span>
    <span class="hl-attribute">remote-channel</span>=<span class="hl-value">"testChannel"</span>
    <span class="hl-attribute">host</span>=<span class="hl-value">"localhost"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_configuring_with_java_configuration_16" href="#_configuring_with_java_configuration_16"></a>26.5&nbsp;Configuring with Java Configuration</h2></div></div></div>

<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> RmiInboundGateway inbound() {
    RmiInboundGateway gateway = <span class="hl-keyword">new</span> RmiInboundGateway();
    gateway.setRequestChannel(requestChannel());
    gateway.setRegistryHost(<span class="hl-string">"host"</span>);
    gateway.setRegistryPort(port);
    <span class="hl-keyword">return</span> gateway;
}

<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel="inChannel")</span></em>
<span class="hl-keyword">public</span> RmiOutboundGateway outbound() {
    RmiOutboundGateway gateway = <span class="hl-keyword">new</span> RmiOutboundGateway(<span class="hl-string">"rmi://host:port/"</span>
        + RmiInboundGateway.SERVICE_NAME_PREFIX + <span class="hl-string">"remoteChannelName"</span>);
    <span class="hl-keyword">return</span> gateway;
}</pre>
<p>Starting with <span class="emphasis"><em>version 4.3</em></span>, the outbound gateway has a second constructor that takes a RmiProxyFactoryBeanConfigurer instance along with the service url argument.
This allows further configuration before the proxy is created; for example, to inject a Spring Security <code class="literal">ContextPropagatingRemoteInvocationFactory</code>:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel="inChannel")</span></em>
<span class="hl-keyword">public</span> RmiOutboundGateway outbound() {
    RmiOutboundGateway gateway = <span class="hl-keyword">new</span> RmiOutboundGateway(<span class="hl-string">"rmi://host:port/"</span>
                + RmiInboundGateway.SERVICE_NAME_PREFIX + <span class="hl-string">"remoteChannelName"</span>,
        pfb -&gt; {
            pfb.setRemoteInvocationFactory(<span class="hl-keyword">new</span> ContextPropagatingRemoteInvocationFactory());
        });
    <span class="hl-keyword">return</span> gateway;
}</pre>
</div>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="sftp" href="#sftp"></a>27.&nbsp;SFTP Adapters</h2></div></div></div>

<p>Spring Integration provides support for file transfer operations via SFTP.</p>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="sftp-intro" href="#sftp-intro"></a>27.1&nbsp;Introduction</h2></div></div></div>

<p>The Secure File Transfer Protocol (SFTP) is a network protocol which allows you to transfer files between two computers on the Internet over any reliable stream.</p>
<p>The SFTP protocol requires a secure channel, such as SSH, as well as visibility to a client&#8217;s identity throughout the SFTP session.</p>
<p>Spring Integration supports sending and receiving files over SFTP by providing three <span class="emphasis"><em>client</em></span> side endpoints: <span class="emphasis"><em>Inbound Channel Adapter</em></span>, <span class="emphasis"><em>Outbound Channel Adapter</em></span>, and <span class="emphasis"><em>Outbound Gateway</em></span> It also provides convenient namespace configuration to define these <span class="emphasis"><em>client</em></span> components.</p>
<pre class="programlisting">xmlns:int-sftp="http://www.springframework.org/schema/integration/sftp"
xsi:schemaLocation="http://www.springframework.org/schema/integration/sftp
    http://www.springframework.org/schema/integration/sftp/spring-integration-sftp.xsd"</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="sftp-session-factory" href="#sftp-session-factory"></a>27.2&nbsp;SFTP Session Factory</h2></div></div></div>

<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Starting with version 3.0, sessions are no longer cached by default.
See <a class="xref" href="#sftp-session-caching" title="27.5&nbsp;SFTP Session Caching">Section&nbsp;27.5, &#8220;SFTP Session Caching&#8221;</a>.</p>
</td></tr></table></div>
<p>Before configuring SFTP adapters, you must configure an <span class="emphasis"><em>SFTP Session Factory</em></span>.
You can configure the <span class="emphasis"><em>SFTP Session Factory</em></span> via a regular bean definition:</p>
<pre class="programlisting"><span class="hl-tag">&lt;beans:bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"sftpSessionFactory"</span>
    <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.sftp.session.DefaultSftpSessionFactory"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;beans:property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"host"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"localhost"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;beans:property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"privateKey"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"classpath:META-INF/keys/sftpTest"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;beans:property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"privateKeyPassphrase"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"springIntegration"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;beans:property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"port"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"22"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;beans:property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"user"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"kermit"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/beans:bean&gt;</span></pre>
<p>Every time an adapter requests a session object from its <code class="literal">SessionFactory</code>, a new SFTP session is being created.
Under the covers, the SFTP Session Factory relies on the <a class="ulink" href="http://www.jcraft.com/jsch/" target="_top">JSch</a> library to provide the SFTP capabilities.</p>
<p>However, Spring Integration also supports the caching of SFTP sessions, please see <a class="xref" href="#sftp-session-caching" title="27.5&nbsp;SFTP Session Caching">Section&nbsp;27.5, &#8220;SFTP Session Caching&#8221;</a> for more information.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>JSch supports multiple channels (operations) over a connection to the server.
By default, the Spring Integration session factory uses a separate physical connection for each channel.
Since <span class="emphasis"><em>Spring Integration 3.0</em></span>, you can configure the session factory (using a boolean constructor arg - default <code class="literal">false</code>) to use a single connection to the server and create multiple <code class="literal">JSch</code> channels on that single connection.</p>
<p>When using this feature, you must wrap the session factory in a caching session factory, as described below, so that the connection is not physically closed when an operation completes.</p>
<p>If the cache is reset, the session is disconnected only when the last channel is closed.</p>
<p>The connection will be refreshed if it is found to be disconnected when a new operation obtains a session.</p>
</td></tr></table></div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>If you experience connectivity problems and would like to trace Session creation as well as see which Sessions are polled you may enable it by setting the logger to TRACE level (e.g., log4j.category.org.springframework.integration.file=TRACE).
Please also see <a class="xref" href="#sftp-jsch-logging" title="27.11&nbsp;SFTP/JSCH Logging">Section&nbsp;27.11, &#8220;SFTP/JSCH Logging&#8221;</a>.</p>
</td></tr></table></div>
<p>Now all you need to do is inject this <span class="emphasis"><em>SFTP Session Factory</em></span> into your adapters.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>A more practical way to provide values for the <span class="emphasis"><em>SFTP Session Factory</em></span> would be via Spring&#8217;s <a class="ulink" href="http://static.springsource.org/spring/docs/current/spring-framework-reference/html/beans.html#beans-factory-placeholderconfigurer" target="_top">property placeholder support</a>.</p>
</td></tr></table></div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="sftp-session-factory-properties" href="#sftp-session-factory-properties"></a>27.2.1&nbsp;Configuration Properties</h3></div></div></div>

<p>Below you will find all properties that are exposed by the <a class="ulink" href="http://static.springsource.org/spring-integration/api/org/springframework/integration/sftp/session/DefaultSftpSessionFactory.html" target="_top">DefaultSftpSessionFactory</a>.</p>
<p><span class="strong"><strong>isSharedSession (constructor argument)</strong></span></p>
<p>When true, a single connection will be used and <code class="literal">JSch Channels</code> will be multiplexed.
Defaults to false.</p>
<p><span class="strong"><strong>clientVersion</strong></span></p>
<p>Allows you to set the client version property.
It&#8217;s default depends on the underlying JSch version but it will look like:_SSH-2.0-JSCH-0.1.45_</p>
<p><span class="strong"><strong>enableDaemonThread</strong></span></p>
<p>If <code class="literal">true</code>, all threads will be daemon threads.
If set to <code class="literal">false</code>, normal non-daemon threads will be used instead.
This property will be set on the underlying <a class="ulink" href="http://epaul.github.io/jsch-documentation/javadoc/com/jcraft/jsch/Session.html" target="_top">Session</a>.
There, this property will default to <code class="literal">false</code>, if not explicitly set.</p>
<p><span class="strong"><strong>host</strong></span></p>
<p>The url of the host you want connect to.
<span class="emphasis"><em>Mandatory</em></span>.</p>
<p><span class="strong"><strong>hostKeyAlias</strong></span></p>
<p>Sets the host key alias, used when comparing the host key to the known hosts list.</p>
<p><span class="strong"><strong>knownHosts</strong></span></p>
<p>Specifies the filename that will be used for a host key repository.
The file has the same format as OpenSSH&#8217;s <span class="emphasis"><em>known_hosts</em></span> file and is required and must be pre-populated if
<code class="literal">allowUnknownKeys</code> is false.</p>
<p><span class="strong"><strong>password</strong></span></p>
<p>The password to authenticate against the remote host.
If a <span class="emphasis"><em>password</em></span> is not provided, then the <span class="emphasis"><em>privateKey</em></span> property is mandatory.
Not allowed if <code class="literal">userInfo</code> is set; the password is obtained from that object.</p>
<p><span class="strong"><strong>port</strong></span></p>
<p>The port over which the SFTP connection shall be established.
If not specified, this value defaults to <code class="literal">22</code>.
If specified, this properties must be a positive number.</p>
<p><span class="strong"><strong>privateKey</strong></span></p>
<p>Allows you to set a <a class="ulink" href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/core/io/Resource.html" target="_top">Resource</a>,
which represents the location of the private key used for authenticating against the remote host.
If the <span class="emphasis"><em>privateKey</em></span> is not provided, then the <span class="emphasis"><em>password</em></span> property is mandatory.</p>
<p><span class="strong"><strong>privateKeyPassphrase</strong></span></p>
<p>The password for the private key.
Not allowed if <code class="literal">userInfo</code> is set; the passphrase is obtained from that object.
Optional.</p>
<p><span class="strong"><strong>proxy</strong></span></p>
<p>Allows for specifying a JSch-based <a class="ulink" href="http://epaul.github.com/jsch-documentation/javadoc/com/jcraft/jsch/Proxy.html" target="_top">Proxy</a>.
If set, then the proxy object is used to create the connection to the remote host via the proxy.
See <a class="xref" href="#sftp-proxy-factory-bean" title="27.3&nbsp;Proxy Factory Bean">Section&nbsp;27.3, &#8220;Proxy Factory Bean&#8221;</a> for a convenient way to configure the proxy.</p>
<p><span class="strong"><strong>serverAliveCountMax</strong></span></p>
<p>Specifies the number of server-alive messages, which will be sent without any reply from the server before disconnecting.
If not set, this property defaults to <code class="literal">1</code>.</p>
<p><span class="strong"><strong>serverAliveInterval</strong></span></p>
<p>Sets the timeout interval (milliseconds) before a server alive message is sent, in case no message is received from the server.</p>
<p><span class="strong"><strong>sessionConfig</strong></span></p>
<p>Using <code class="literal">Properties</code>, you can set additional configuration setting on the underlying JSch Session.</p>
<p><span class="strong"><strong>socketFactory</strong></span></p>
<p>Allows you to pass in a <a class="ulink" href="http://epaul.github.com/jsch-documentation/javadoc/com/jcraft/jsch/SocketFactory.html" target="_top">SocketFactory</a>.
The socket factory is used to create a socket to the target host.
When a proxy is used, the socket factory is passed to the proxy.
By default plain TCP sockets are used.</p>
<p><span class="strong"><strong>timeout</strong></span></p>
<p>The timeout property is used as the socket timeout parameter, as well as the default connection timeout.
Defaults to <code class="literal">0</code>, which means, that no timeout will occur.</p>
<p><span class="strong"><strong>user</strong></span></p>
<p>The remote user to use.
<span class="emphasis"><em>Mandatory</em></span>.</p>
<p><a name="sftp-unk-hosts" href="#sftp-unk-hosts"></a><span class="strong"><strong>allowUnknownKeys</strong></span></p>
<p>Set to <code class="literal">true</code> to allow connections to hosts with unknown (or changed) keys.
Default <span class="emphasis"><em>false</em></span> (since 4.2 - defaults to <code class="literal">true</code> in 4.1.7 and was not configurable before that version).
Only applied if no <code class="literal">userInfo</code> is provided.
If false, a pre-populated knownHosts file is required.</p>
<p><span class="strong"><strong>userInfo</strong></span></p>
<p>Set a custom <code class="literal">UserInfo</code> used during authentication.
In particular, be aware that <code class="literal">promptYesNo()</code> is invoked when an unknown (or changed) host key is received.
Also see <code class="literal">allowUnknownHosts</code>.
When a <code class="literal">UserInfo</code> is provided, the <code class="literal">password</code> and private key <code class="literal">passphrase</code> is obtained from it, and discrete
<code class="literal">password</code> and <code class="literal">privateKeyPassprase</code> properties cannot be set.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="sftp-proxy-factory-bean" href="#sftp-proxy-factory-bean"></a>27.3&nbsp;Proxy Factory Bean</h2></div></div></div>

<p><code class="literal">Jsch</code> provides a mechanism to connect to the server via an HTTP or SOCKS proxy.
To use this feature, configure the <code class="literal">Proxy</code> and provide a reference to the <code class="literal">DefaultSftpSessionFactory</code> as discussed
above.
Three implementations are provided by <code class="literal">Jsch</code>, <code class="literal">HTTP</code>, <code class="literal">SOCKS4</code> and <code class="literal">SOCKS5</code>.
<span class="emphasis"><em>Spring Integration 4.3</em></span> provides a <code class="literal">FactoryBean</code> making configuration of these proxies easier, allowing property
injection:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"proxySocks5"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.sftp.session.JschProxyFactoryBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"SOCKS5"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"${sftp.proxy.address}"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"${sftp.proxy.port}"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"${sftp.proxy.user}"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"${sftp.proxy.pw}"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"sessionFactory"</span>
          <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.sftp.session.DefaultSftpSessionFactory"</span><span class="hl-tag"> &gt;</span>
    ...
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"proxy"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"proxySocks5"</span><span class="hl-tag"> /&gt;</span>
    ...
<span class="hl-tag">&lt;/bean&gt;</span></pre>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="sftp-dsf" href="#sftp-dsf"></a>27.4&nbsp;Delegating Session Factory</h2></div></div></div>

<p><span class="emphasis"><em>Version 4.2</em></span> introduced the <code class="literal">DelegatingSessionFactory</code> which allows the selection of the actual session factory at
runtime.
Prior to invoking the ftp endpoint, call <code class="literal">setThreadKey()</code> on the factory to associate a key with the current thread.
That key is then used to lookup the actual session factory to be used.
The key can be cleared by calling <code class="literal">clearThreadKey()</code> after use.</p>
<p>Convenience methods have been added so this can easily be done from a message flow:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"dsf"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.file.remote.session.DelegatingSessionFactory"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.file.remote.session.DefaultSessionFactoryLocator"</span><span class="hl-tag">&gt;</span>
            <span class="hl-comment">&lt;!-- delegate factories here --&gt;</span>
        <span class="hl-tag">&lt;/bean&gt;</span>
    <span class="hl-tag">&lt;/constructor-arg&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;int:service-activator</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"in"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"c1"</span>
        <span class="hl-attribute">expression</span>=<span class="hl-value">"@dsf.setThreadKey(#root, headers['factoryToUse'])"</span><span class="hl-tag"> /&gt;</span>

<span class="hl-tag">&lt;int-sftp:outbound-gateway</span> <span class="hl-attribute">request-channel</span>=<span class="hl-value">"c1"</span> <span class="hl-attribute">reply-channel</span>=<span class="hl-value">"c2"</span> <span class="hl-attribute">...</span><span class="hl-tag"> /&gt;</span>

<span class="hl-tag">&lt;int:service-activator</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"c2"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"out"</span>
        <span class="hl-attribute">expression</span>=<span class="hl-value">"@dsf.clearThreadKey(#root)"</span><span class="hl-tag"> /&gt;</span></pre>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>When using session caching (see <a class="xref" href="#sftp-session-caching" title="27.5&nbsp;SFTP Session Caching">Section&nbsp;27.5, &#8220;SFTP Session Caching&#8221;</a>), each of the delegates should be cached; you
cannot cache the <code class="literal">DelegatingSessionFactory</code> itself.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="sftp-session-caching" href="#sftp-session-caching"></a>27.5&nbsp;SFTP Session Caching</h2></div></div></div>

<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Starting with <span class="emphasis"><em>Spring Integration version 3.0</em></span>, sessions are no longer cached by default; the <code class="literal">cache-sessions</code> attribute is no longer supported on endpoints.
You must use a <code class="literal">CachingSessionFactory</code> (see below) if you wish to cache sessions.</p>
</td></tr></table></div>
<p>In versions prior to 3.0, the sessions were cached automatically by default.
A <code class="literal">cache-sessions</code> attribute was available for disabling the auto caching, but that solution did not provide a way to configure other session caching attributes.
For example, you could not limit on the number of sessions created.
To support that requirement and other configuration options, a <code class="literal">CachingSessionFactory</code> was provided.
It provides <code class="literal">sessionCacheSize</code> and <code class="literal">sessionWaitTimeout</code> properties.
As its name suggests, the <code class="literal">sessionCacheSize</code> property controls how many active sessions the factory will maintain in its cache (the DEFAULT is unbounded).
If the <code class="literal">sessionCacheSize</code> threshold has been reached, any attempt to acquire another session will block until either one of the cached sessions becomes available or until the wait time for a Session expires (the DEFAULT wait time is Integer.MAX_VALUE).
The <code class="literal">sessionWaitTimeout</code> property enables configuration of that value.</p>
<p>If you want your Sessions to be cached, simply configure your default Session Factory as described above and then wrap it in an instance of <code class="literal">CachingSessionFactory</code> where you may provide those additional properties.</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"sftpSessionFactory"</span>
    <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.sftp.session.DefaultSftpSessionFactory"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"host"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"localhost"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"cachingSessionFactory"</span>
    <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.file.remote.session.CachingSessionFactory"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"sftpSessionFactory"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"10"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"sessionWaitTimeout"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"1000"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
<p>In the above example you see a <code class="literal">CachingSessionFactory</code> created with the <code class="literal">sessionCacheSize</code> set to 10 and the <code class="literal">sessionWaitTimeout</code> set to 1 second (its value is in milliseconds).</p>
<p>Starting with <span class="emphasis"><em>Spring Integration version 3.0</em></span>, the <code class="literal">CachingConnectionFactory</code> provides a <code class="literal">resetCache()</code> method.
When invoked, all idle sessions are immediately closed and in-use sessions are closed when they are returned to the cache.
When using <code class="literal">isSharedSession=true</code>, the channel is closed, and the shared session is closed only when the last channel is closed.
New requests for sessions will establish new sessions as necessary.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="sftp-rft" href="#sftp-rft"></a>27.6&nbsp;RemoteFileTemplate</h2></div></div></div>

<p>Starting with <span class="emphasis"><em>Spring Integration version 3.0</em></span>, a new abstraction is provided over the <code class="literal">SftpSession</code> object.
The template provides methods to send, retrieve (as an <code class="literal">InputStream</code>), remove, and rename files.
In addition an <code class="literal">execute</code> method is provided allowing the caller to execute multiple operations on the session.
In all cases, the template takes care of reliably closing the session.
For more information, refer to the <a class="ulink" href="http://docs.spring.io/spring-integration/api/org/springframework/integration/file/remote/RemoteFileTemplate.html" target="_top">javadocs for <code class="literal">RemoteFileTemplate</code></a> There is a subclass for SFTP: <code class="literal">SftpRemoteFileTemplate</code>.</p>
<p>Additional methods were added in <span class="emphasis"><em>version 4.1</em></span> including <code class="literal">getClientInstance()</code> which provides access to the underlying <code class="literal">ChannelSftp</code> enabling access to low-level APIs.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="sftp-inbound" href="#sftp-inbound"></a>27.7&nbsp;SFTP Inbound Channel Adapter</h2></div></div></div>

<p>The <span class="emphasis"><em>SFTP Inbound Channel Adapter</em></span> is a special listener that will connect to the server and listen for the remote directory events (e.g., new file created) at which point it will initiate a file transfer.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-sftp:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"sftpAdapterAutoCreate"</span>
              <span class="hl-attribute">session-factory</span>=<span class="hl-value">"sftpSessionFactory"</span>
            <span class="hl-attribute">channel</span>=<span class="hl-value">"requestChannel"</span>
            <span class="hl-attribute">filename-pattern</span>=<span class="hl-value">"*.txt"</span>
            <span class="hl-attribute">remote-directory</span>=<span class="hl-value">"/foo/bar"</span>
            <span class="hl-attribute">preserve-timestamp</span>=<span class="hl-value">"true"</span>
            <span class="hl-attribute">local-directory</span>=<span class="hl-value">"file:target/foo"</span>
            <span class="hl-attribute">auto-create-local-directory</span>=<span class="hl-value">"true"</span>
            <span class="hl-attribute">local-filename-generator-expression</span>=<span class="hl-value">"#this.toUpperCase() + '.a'"</span>
            <span class="hl-attribute">local-filter</span>=<span class="hl-value">"myFilter"</span>
            <span class="hl-attribute">temporary-file-suffix</span>=<span class="hl-value">".writing"</span>
            <span class="hl-attribute">delete-remote-files</span>=<span class="hl-value">"false"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"1000"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-sftp:inbound-channel-adapter&gt;</span></pre>
<p>As you can see from the configuration above you can configure the <span class="emphasis"><em>SFTP Inbound Channel Adapter</em></span> via the <code class="literal">inbound-channel-adapter</code> element while also providing values for various attributes such as <code class="literal">local-directory</code> - where files are going to be transferred TO and <code class="literal">remote-directory</code> - the remote source directory where files are going to be transferred FROM - as well as other attributes including a <code class="literal">session-factory</code> reference to the bean we configured earlier.</p>
<p>By default the transferred file will carry the same name as the original file.
If you want to override this behavior you can set the <code class="literal">local-filename-generator-expression</code> attribute which allows you to provide a SpEL Expression to generate the name of the local file.
Unlike outbound gateways and adapters where the root object of the SpEL Evaluation Context is a <code class="literal">Message</code>, this inbound adapter does not yet have the Message at the time of evaluation since that&#8217;s what it ultimately generates with the transferred file as its payload.
So, the root object of the SpEL Evaluation Context is the original name of the remote file (String).</p>
<p>Starting with <span class="emphasis"><em>Spring Integration 3.0</em></span>, you can specify the <code class="literal">preserve-timestamp</code> attribute (default <code class="literal">false</code>); when <code class="literal">true</code>, the local file&#8217;s modified timestamp will be set to the value retrieved from the server; otherwise it will be set to the current time.</p>
<p>Starting with <span class="emphasis"><em>version 4.2</em></span>, you can specify <code class="literal">remote-directory-expression</code> instead of <code class="literal">remote-directory</code>, allowing
you to dynamically determine the directory on each poll.
e.g <code class="literal">remote-directory-expression="@myBean.determineRemoteDir()"</code>.</p>
<p>Sometimes file filtering based on the simple pattern specified via <code class="literal">filename-pattern</code> attribute might not be sufficient.
If this is the case, you can use the <code class="literal">filename-regex</code> attribute to specify a Regular Expression (e.g.
<code class="literal">filename-regex=".*\.test$"</code>).
And of course if you need complete control you can use the <code class="literal">filter</code> attribute to provide a reference to a custom implementation of the <code class="literal">org.springframework.integration.file.filters.FileListFilter</code> - a strategy interface for filtering a list of files.
This filter determines which remote files are retrieved.
You can also combine a pattern based filter with other filters, such as an <code class="literal">AcceptOnceFileListFilter</code> to avoid synchronizing files that have previously been fetched, by using a <code class="literal">CompositeFileListFilter</code>.</p>
<p>The <code class="literal">AcceptOnceFileListFilter</code> stores its state in memory.
If you wish the state to survive a system restart, consider using the <code class="literal">SftpPersistentAcceptOnceFileListFilter</code> instead.
This filter stores the accepted file names in an instance of the <code class="literal">MetadataStore</code> strategy (<a class="xref" href="#metadata-store" title="9.5&nbsp;Metadata Store">Section&nbsp;9.5, &#8220;Metadata Store&#8221;</a>).
This filter matches on the filename and the remote modified time.</p>
<p>Since <span class="emphasis"><em>version 4.0</em></span>, this filter requires a <code class="literal">ConcurrentMetadataStore</code>.
When used with a shared data store (such as <code class="literal">Redis</code> with the <code class="literal">RedisMetadataStore</code>) this allows filter keys to be shared across multiple application or server instances.</p>
<p>The above discussion refers to filtering the files before retrieving them.
Once the files have been retrieved, an additional filter is applied to the files on the file system.
By default, this is an`AcceptOnceFileListFilter` which, as discussed, retains state in memory and does not consider the file&#8217;s modified time.
Unless your application removes files after processing, the adapter will re-process the files on disk by default after an application restart.</p>
<p>Also, if you configure the <code class="literal">filter</code> to use a <code class="literal">FtpPersistentAcceptOnceFileListFilter</code>, and the remote file timestamp changes (causing it to be re-fetched), the default local filter will not allow this new file to be processed.</p>
<p>Use the <code class="literal">local-filter</code> attribute to configure the behavior of the local file system filter.
Starting with <span class="emphasis"><em>verion 4.3.8</em></span>, a <code class="literal">FileSystemPersistentAcceptOnceFileListFilter</code> is configured by default.
This filter stores the accepted file names and modified timestamp in an instance of the <code class="literal">MetadataStore</code> strategy (<a class="xref" href="#metadata-store" title="9.5&nbsp;Metadata Store">Section&nbsp;9.5, &#8220;Metadata Store&#8221;</a>), and will detect changes to the local file modified time.
The default <code class="literal">MetadataStore</code> is a <code class="literal">SimpleMetadataStore</code> which stores state in memory.</p>
<p>Since <span class="emphasis"><em>version 4.1.5</em></span>, these filters have a new property <code class="literal">flushOnUpdate</code> which will cause them to flush the
metadata store on every update (if the store implements <code class="literal">Flushable</code>).</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Further, if you use a distributed <code class="literal">MetadataStore</code> (such as <a class="xref" href="#redis-metadata-store" title="24.5&nbsp;Redis Metadata Store">Section&nbsp;24.5, &#8220;Redis Metadata Store&#8221;</a> or <a class="xref" href="#gemfire-metadata-store" title="16.7&nbsp;Gemfire Metadata Store">Section&nbsp;16.7, &#8220;Gemfire Metadata Store&#8221;</a>) you can have multiple instances of the same adapter/application and be sure that one and only one will process a file.</p>
</td></tr></table></div>
<p>The actual local filter is a <code class="literal">CompositeFileListFilter</code> containing the supplied filter and a pattern filter that prevents processing files that are in the process of being downloaded (based on the <code class="literal">temporary-file-suffix</code>); files are downloaded with this suffix (default: <code class="literal">.writing</code>) and the file is renamed to its final name when the transfer is complete, making it <span class="emphasis"><em>visible</em></span> to the filter.</p>
<p>Please refer to the schema for more detail on these attributes.</p>
<p>It is also important to understand that <span class="emphasis"><em>SFTP Inbound Channel Adapter</em></span> is a Polling Consumer and therefore you must configure a poller (either a global default or a local sub-element).
Once the file has been transferred to a local directory, a Message with <code class="literal">java.io.File</code> as its payload type will be generated and sent to the channel identified by the <code class="literal">channel</code> attribute.</p>
<p><span class="emphasis"><em>More on File Filtering and Large Files</em></span></p>
<p>Sometimes a file that just appeared in the monitored (remote) directory is not complete.
Typically such a file will be written with some temporary extension (e.g., foo.txt.writing) and then renamed after the writing process completes.
As a user in most cases you are only interested in files that are complete and would like to filter only those files.
To handle these scenarios, use filtering support provided via the <code class="literal">filename-pattern</code>, <code class="literal">filename-regex</code> and <code class="literal">filter</code> attributes.
If you need a custom filter implementation simply include a reference in your adapter via the <code class="literal">filter</code> attribute.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-sftp:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"sftpInbondAdapter"</span>
            <span class="hl-attribute">channel</span>=<span class="hl-value">"receiveChannel"</span>
            <span class="hl-attribute">session-factory</span>=<span class="hl-value">"sftpSessionFactory"</span>
            <span class="hl-attribute">filter</span>=<span class="hl-value">"customFilter"</span>
            <span class="hl-attribute">local-directory</span>=<span class="hl-value">"file:/local-test-dir"</span>
            <span class="hl-attribute">remote-directory</span>=<span class="hl-value">"/remote-test-dir"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"1000"</span> <span class="hl-attribute">max-messages-per-poll</span>=<span class="hl-value">"10"</span> <span class="hl-attribute">task-executor</span>=<span class="hl-value">"executor"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-sftp:inbound-channel-adapter&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"customFilter"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.foo.CustomFilter"</span><span class="hl-tag">/&gt;</span></pre>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_recovering_from_failures_2" href="#_recovering_from_failures_2"></a>27.7.1&nbsp;Recovering from Failures</h3></div></div></div>

<p>It is important to understand the architecture of the adapter.
There is a file synchronizer which fetches the files, and a <code class="literal">FileReadingMessageSource</code> to emit a message for each
synchronized file.
As discussed above, there are two filters involved.
The <code class="literal">filter</code> attribute (and patterns) refers to the remote (SFTP) file list - to avoid fetching files that have already
been fetched.
The <code class="literal">local-filter</code> is used by the <code class="literal">FileReadingMessageSource</code> to determine which files are to be sent as messages.</p>
<p>The synchronizer lists the remote files and consults its filter; the files are then transferred.
If an IO error occurs during file transfer, any files that have already been added to the filter are removed so they
are eligible to be re-fetched on the next poll.
This only applies if the filter implements <code class="literal">ReversibleFileListFilter</code> (such as the <code class="literal">AcceptOnceFileListFilter</code>).</p>
<p>If, after synchronizing the files, an error occurs on the downstream flow processing a file, there is <span class="emphasis"><em>no</em></span> automatic
rollback of the filter so the failed file will <span class="emphasis"><em>not</em></span> be reprocessed by default.</p>
<p>If you wish to reprocess such files after a failure, you can use configuration similar to the following to facilitate
the removal of the failed file from the filter.
This will work for any <code class="literal">ResettableFileListFilter</code>.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-sftp:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"sftpAdapter"</span>
        <span class="hl-attribute">session-factory</span>=<span class="hl-value">"sftpSessionFactory"</span>
        <span class="hl-attribute">channel</span>=<span class="hl-value">"requestChannel"</span>
        <span class="hl-attribute">remote-directory-expression</span>=<span class="hl-value">"'/sftpSource'"</span>
        <span class="hl-attribute">local-directory</span>=<span class="hl-value">"file:myLocalDir"</span>
        <span class="hl-attribute">auto-create-local-directory</span>=<span class="hl-value">"true"</span>
        <span class="hl-attribute">filename-pattern</span>=<span class="hl-value">"*.txt"</span>
        <span class="hl-attribute">local-filter</span>=<span class="hl-value">"acceptOnceFilter"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"1000"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;int:transactional</span> <span class="hl-attribute">synchronization-factory</span>=<span class="hl-value">"syncFactory"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;/int:poller&gt;</span>
<span class="hl-tag">&lt;/int-sftp:inbound-channel-adapter&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"acceptOnceFilter"</span>
    <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.file.filters.AcceptOnceFileListFilter"</span><span class="hl-tag"> /&gt;</span>

<span class="hl-tag">&lt;int:transaction-synchronization-factory</span> <span class="hl-attribute">id</span>=<span class="hl-value">"syncFactory"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:after-rollback</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"@acceptOnceFilter.remove(payload)"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/int:transaction-synchronization-factory&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"transactionManager"</span>
    <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.transaction.PseudoTransactionManager"</span><span class="hl-tag"> /&gt;</span></pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_with_java_configuration_17" href="#_configuring_with_java_configuration_17"></a>27.7.2&nbsp;Configuring with Java Configuration</h3></div></div></div>

<p>The following Spring Boot application provides an example of configuring the inbound adapter using Java configuration:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@SpringBootApplication</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> SftpJavaApplication {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
        <span class="hl-keyword">new</span> SpringApplicationBuilder(SftpJavaApplication.<span class="hl-keyword">class</span>)
            .web(false)
            .run(args);
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> SessionFactory&lt;LsEntry&gt; sftpSessionFactory() {
        DefaultSftpSessionFactory factory = <span class="hl-keyword">new</span> DefaultSftpSessionFactory(true);
        factory.setHost(<span class="hl-string">"localhost"</span>);
        factory.setPort(port);
        factory.setUser(<span class="hl-string">"foo"</span>);
        factory.setPassword(<span class="hl-string">"foo"</span>);
        factory.setAllowUnknownKeys(true);
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> CachingSessionFactory&lt;LsEntry&gt;(factory);
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> SftpInboundFileSynchronizer sftpInboundFileSynchronizer() {
        SftpInboundFileSynchronizer fileSynchronizer = <span class="hl-keyword">new</span> SftpInboundFileSynchronizer(sftpSessionFactory());
        fileSynchronizer.setDeleteRemoteFiles(false);
        fileSynchronizer.setRemoteDirectory(<span class="hl-string">"foo"</span>);
        fileSynchronizer.setFilter(<span class="hl-keyword">new</span> SftpSimplePatternFileListFilter(<span class="hl-string">"*.xml"</span>));
        <span class="hl-keyword">return</span> fileSynchronizer;
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <em><span class="hl-annotation" style="color: gray">@InboundChannelAdapter(channel = "sftpChannel", poller = @Poller(fixedDelay = "5000"))</span></em>
    <span class="hl-keyword">public</span> MessageSource&lt;File&gt; sftpMessageSource() {
        SftpInboundFileSynchronizingMessageSource source =
                <span class="hl-keyword">new</span> SftpInboundFileSynchronizingMessageSource(sftpInboundFileSynchronizer());
        source.setLocalDirectory(<span class="hl-keyword">new</span> File(<span class="hl-string">"sftp-inbound"</span>));
        source.setAutoCreateLocalDirectory(true);
        source.setLocalFilter(<span class="hl-keyword">new</span> AcceptOnceFileListFilter&lt;File&gt;());
        <span class="hl-keyword">return</span> source;
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "sftpChannel")</span></em>
    <span class="hl-keyword">public</span> MessageHandler handler() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> MessageHandler() {

            <em><span class="hl-annotation" style="color: gray">@Override</span></em>
            <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> handleMessage(Message&lt;?&gt; message) <span class="hl-keyword">throws</span> MessagingException {
                System.out.println(message.getPayload());
            }

        };
    }

}</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_with_the_java_dsl_12" href="#_configuring_with_the_java_dsl_12"></a>27.7.3&nbsp;Configuring with the Java DSL</h3></div></div></div>

<p>The following Spring Boot application provides an example of configuring the inbound adapter using the Java DSL:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@SpringBootApplication</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> SftpJavaApplication {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
        <span class="hl-keyword">new</span> SpringApplicationBuilder(SftpJavaApplication.<span class="hl-keyword">class</span>)
            .web(false)
            .run(args);
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> IntegrationFlow sftpInboundFlow() {
        <span class="hl-keyword">return</span> IntegrationFlows
            .from(s -&gt; s.sftp(<span class="hl-keyword">this</span>.sftpSessionFactory)
                    .preserveTimestamp(true)
                    .remoteDirectory(<span class="hl-string">"foo"</span>)
                    .regexFilter(<span class="hl-string">".*\\.txt$"</span>)
                    .localFilenameExpression(<span class="hl-string">"#this.toUpperCase() + '.a'"</span>)
                    .localDirectory(<span class="hl-keyword">new</span> File(<span class="hl-string">"sftp-inbound"</span>)),
                 e -&gt; e.id(<span class="hl-string">"sftpInboundAdapter"</span>)
                    .autoStartup(true)
                    .poller(Pollers.fixedDelay(<span class="hl-number">5000</span>)))
            .handle(m -&gt; System.out.println(m.getPayload()))
            .get();
    }
}</pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="sftp-streaming" href="#sftp-streaming"></a>27.8&nbsp;SFTP Streaming Inbound Channel Adapter</h2></div></div></div>

<p>The streaming inbound channel adapter was introduced in <span class="emphasis"><em>version 4.3</em></span>.
This adapter produces message with payloads of type <code class="literal">InputStream</code>, allowing files to be fetched without writing to the
local file system.
Since the session remains open, the consuming application is responsible for closing the session when the file has been
consumed.
The session is provided in the <code class="literal">IntegrationMessageHeaderAccessor.CLOSEABLE_RESOURCE</code> header.
Standard framework components, such as the <code class="literal">FileSplitter</code> and <code class="literal">StreamTransformer</code> will automatically close the session.
See <a class="xref" href="#file-splitter" title="14.5&nbsp;File Splitter">Section&nbsp;14.5, &#8220;File Splitter&#8221;</a> and <a class="xref" href="#stream-transformer" title="Stream Transformer">the section called &#8220;Stream Transformer&#8221;</a> for more information about these components.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-sftp:inbound-streaming-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"ftpInbound"</span>
            <span class="hl-attribute">channel</span>=<span class="hl-value">"ftpChannel"</span>
            <span class="hl-attribute">session-factory</span>=<span class="hl-value">"sessionFactory"</span>
            <span class="hl-attribute">filename-pattern</span>=<span class="hl-value">"*.txt"</span>
            <span class="hl-attribute">filename-regex</span>=<span class="hl-value">".*\.txt"</span>
            <span class="hl-attribute">filter</span>=<span class="hl-value">"filter"</span>
            <span class="hl-attribute">remote-file-separator</span>=<span class="hl-value">"/"</span>
            <span class="hl-attribute">comparator</span>=<span class="hl-value">"comparator"</span>
            <span class="hl-attribute">remote-directory-expression</span>=<span class="hl-value">"'foo/bar'"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"1000"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/int-sftp:inbound-streaming-channel-adapter&gt;</span></pre>
<p>Only one of <code class="literal">filename-pattern</code>, <code class="literal">filename-regex</code> or <code class="literal">filter</code> is allowed.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Unlike the non-streaming inbound channel adapter, this adapter does not prevent duplicates by default.
If you do not delete the remote file (e.g. using an outbound gateway with an rm command) and you wish to prevent the
file being processed again, you can configure an <code class="literal">SftpPersistentFileListFilter</code> in the <code class="literal">filter</code> attribute.
If you don&#8217;t actually want to persist the state, an in-memory <code class="literal">SimpleMetadataStore</code> can be used with the filter.
If you wish to use a filename pattern (or regex) as well, use a <code class="literal">CompositeFileListFilter</code>.</p>
</td></tr></table></div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_with_java_configuration_18" href="#_configuring_with_java_configuration_18"></a>27.8.1&nbsp;Configuring with Java Configuration</h3></div></div></div>

<p>The following Spring Boot application provides an example of configuring the inbound adapter using Java configuration:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@SpringBootApplication</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> SftpJavaApplication {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
        <span class="hl-keyword">new</span> SpringApplicationBuilder(SftpJavaApplication.<span class="hl-keyword">class</span>)
            .web(false)
            .run(args);
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <em><span class="hl-annotation" style="color: gray">@InboundChannelAdapter(channel = "stream")</span></em>
    <span class="hl-keyword">public</span> MessageSource&lt;InputStream&gt; ftpMessageSource() {
        SftpStreamingMessageSource messageSource = <span class="hl-keyword">new</span> SftpStreamingMessageSource(template(), null);
        messageSource.setRemoteDirectory(<span class="hl-string">"sftpSource/"</span>);
        messageSource.setFilter(<span class="hl-keyword">new</span> SftpPersistentAcceptOnceFileListFilter(<span class="hl-keyword">new</span> SimpleMetadataStore(),
                           <span class="hl-string">"streaming"</span>));
        <span class="hl-keyword">return</span> messageSource;
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <em><span class="hl-annotation" style="color: gray">@Transformer(inputChannel = "stream", outputChannel = "data")</span></em>
    <span class="hl-keyword">public</span> org.springframework.integration.transformer.Transformer transformer() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> StreamTransformer();
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> SftpRemoteFileTemplate template() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> SftpRemoteFileTemplate(sftpSessionFactory());
    }

}</pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="sftp-outbound" href="#sftp-outbound"></a>27.9&nbsp;SFTP Outbound Channel Adapter</h2></div></div></div>

<p>The <span class="emphasis"><em>SFTP Outbound Channel Adapter</em></span> is a special <code class="literal">MessageHandler</code> that will connect to the remote directory and will
initiate a file transfer for every file it will receive as the payload of an incoming <code class="literal">Message</code>.
It also supports several representations of the File so you are not limited to the File object.
Similar to the FTP outbound adapter, the <span class="emphasis"><em>SFTP Outbound Channel Adapter</em></span> supports the following payloads:
1) <code class="literal">java.io.File</code> - the actual file object;
2) <code class="literal">byte[]</code> - byte array that represents the file contents;
3) <code class="literal">java.lang.String</code> - text that represents the file contents.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-sftp:outbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"sftpOutboundAdapter"</span>
    <span class="hl-attribute">session-factory</span>=<span class="hl-value">"sftpSessionFactory"</span>
    <span class="hl-attribute">channel</span>=<span class="hl-value">"inputChannel"</span>
    <span class="hl-attribute">charset</span>=<span class="hl-value">"UTF-8"</span>
    <span class="hl-attribute">remote-file-separator</span>=<span class="hl-value">"/"</span>
    <span class="hl-attribute">remote-directory</span>=<span class="hl-value">"foo/bar"</span>
    <span class="hl-attribute">remote-filename-generator-expression</span>=<span class="hl-value">"payload.getName() + '-foo'"</span>
    <span class="hl-attribute">filename-generator</span>=<span class="hl-value">"fileNameGenerator"</span>
    <span class="hl-attribute">use-temporary-filename</span>=<span class="hl-value">"true"</span>
    <span class="hl-attribute">chmod</span>=<span class="hl-value">"600"</span>
    <span class="hl-attribute">mode</span>=<span class="hl-value">"REPLACE"</span><span class="hl-tag">/&gt;</span></pre>
<p>As you can see from the configuration above you can configure the <span class="emphasis"><em>SFTP Outbound Channel Adapter</em></span> via the <code class="literal">outbound-channel-adapter</code> element.
Please refer to the schema for more detail on these attributes.</p>
<p><span class="emphasis"><em>SpEL and the SFTP Outbound Adapter</em></span></p>
<p>As with many other components in Spring Integration, you can benefit from the Spring Expression Language (SpEL) support when configuring an <span class="emphasis"><em>SFTP Outbound Channel Adapter</em></span>, by specifying two attributes <code class="literal">remote-directory-expression</code> and <code class="literal">remote-filename-generator-expression</code> (see above).
The expression evaluation context will have the Message as its root object, thus allowing you to provide expressions which can dynamically compute the <span class="emphasis"><em>file name</em></span> or the existing <span class="emphasis"><em>directory path</em></span> based on the data in the Message (either from <span class="emphasis"><em>payload</em></span> or <span class="emphasis"><em>headers</em></span>).
In the example above we are defining the <code class="literal">remote-filename-generator-expression</code> attribute with an expression value that computes the <span class="emphasis"><em>file name</em></span> based on its original name while also appending a suffix: <span class="emphasis"><em>-foo</em></span>.</p>
<p>Starting with <span class="emphasis"><em>version 4.1</em></span>, you can specify the <code class="literal">mode</code> when transferring the file.
By default, an existing file will be overwritten; the modes are defined on <code class="literal">enum</code> <code class="literal">FileExistsMode</code>, having values <code class="literal">REPLACE</code> (default), <code class="literal">APPEND</code>, <code class="literal">IGNORE</code>, and <code class="literal">FAIL</code>.
With <code class="literal">IGNORE</code> and <code class="literal">FAIL</code>, the file is not transferred; <code class="literal">FAIL</code> causes an exception to be thrown whereas <code class="literal">IGNORE</code> silently ignores the transfer (although a <code class="literal">DEBUG</code> log entry is produced).</p>
<p><span class="emphasis"><em>Avoiding Partially Written Files</em></span></p>
<p>One of the common problems, when dealing with file transfers, is the possibility of processing a <span class="emphasis"><em>partial file</em></span> - a file might appear in the file system before its transfer is actually complete.</p>
<p>To deal with this issue, Spring Integration SFTP adapters use a very common algorithm where files are transferred under a temporary name and than renamed once they are fully transferred.</p>
<p>By default, every file that is in the process of being transferred will appear in the file system with an additional suffix which, by default, is <code class="literal">.writing</code>; this can be changed using the <code class="literal">temporary-file-suffix</code> attribute.</p>
<p>However, there may be situations where you don&#8217;t want to use this technique (for example, if the server does not permit renaming files).
For situations like this, you can disable this feature by setting <code class="literal">use-temporary-file-name</code> to <code class="literal">false</code> (default is <code class="literal">true</code>).
When this attribute is <code class="literal">false</code>, the file is written with its final name and the consuming application will need some other mechanism to detect that the file is completely uploaded before accessing it.</p>
<p><span class="emphasis"><em>Version 4.3</em></span> introduced the <code class="literal">chmod</code> attribute which changes the remote file permissions after upload.
Use the conventional Unix octal format, e.g. <code class="literal">600</code> allows read-write for the file owner only.
When configuring the adapter using java, you can use <code class="literal">setChmodOctal("600")</code> or <code class="literal">setChmodDecimal(384)</code>.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_with_java_configuration_19" href="#_configuring_with_java_configuration_19"></a>27.9.1&nbsp;Configuring with Java Configuration</h3></div></div></div>

<p>The following Spring Boot application provides an example of configuring the Outbound Adapter using Java configuration:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@SpringBootApplication</span></em>
<em><span class="hl-annotation" style="color: gray">@IntegrationComponentScan</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> SftpJavaApplication {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
        ConfigurableApplicationContext context =
                    <span class="hl-keyword">new</span> SpringApplicationBuilder(SftpJavaApplication.<span class="hl-keyword">class</span>)
                        .web(false)
                        .run(args);
        MyGateway gateway = context.getBean(MyGateway.<span class="hl-keyword">class</span>);
        gateway.sendToSftp(<span class="hl-keyword">new</span> File(<span class="hl-string">"/foo/bar.txt"</span>));
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> SessionFactory&lt;LsEntry&gt; sftpSessionFactory() {
        DefaultSftpSessionFactory factory = <span class="hl-keyword">new</span> DefaultSftpSessionFactory(true);
        factory.setHost(<span class="hl-string">"localhost"</span>);
        factory.setPort(port);
        factory.setUser(<span class="hl-string">"foo"</span>);
        factory.setPassword(<span class="hl-string">"foo"</span>);
        factory.setAllowUnknownKeys(true);
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> CachingSessionFactory&lt;LsEntry&gt;(factory);
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "toSftpChannel")</span></em>
    <span class="hl-keyword">public</span> MessageHandler handler() {
        SftpMessageHandler handler = <span class="hl-keyword">new</span> SftpMessageHandler(sftpSessionFactory());
        handler.setRemoteDirectoryExpressionString(<span class="hl-string">"headers['remote-target-dir']"</span>);
        handler.setFileNameGenerator(<span class="hl-keyword">new</span> FileNameGenerator() {

            <em><span class="hl-annotation" style="color: gray">@Override</span></em>
            <span class="hl-keyword">public</span> String generateFileName(Message&lt;?&gt; message) {
                 <span class="hl-keyword">return</span> <span class="hl-string">"handlerContent.test"</span>;
            }

        });
        <span class="hl-keyword">return</span> handler;
    }

    <em><span class="hl-annotation" style="color: gray">@MessagingGateway</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> MyGateway {

         <em><span class="hl-annotation" style="color: gray">@Gateway(requestChannel = "toSftpChannel")</span></em>
         <span class="hl-keyword">void</span> sendToSftp(File file);

    }
}</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_with_the_java_dsl_13" href="#_configuring_with_the_java_dsl_13"></a>27.9.2&nbsp;Configuring with the Java DSL</h3></div></div></div>

<p>The following Spring Boot application provides an example of configuring the Outbound Adapter using the Java DSL:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@SpringBootApplication</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> SftpJavaApplication {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
        <span class="hl-keyword">new</span> SpringApplicationBuilder(SftpJavaApplication.<span class="hl-keyword">class</span>)
            .web(false)
            .run(args);
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> IntegrationFlow sftpOutboundFlow() {
        <span class="hl-keyword">return</span> IntegrationFlows.from(<span class="hl-string">"toSftpChannel"</span>)
            .handle(Sftp.outboundAdapter(<span class="hl-keyword">this</span>.sftpSessionFactory, FileExistsMode.FAIL)
                         .useTemporaryFileName(false)
                         .remoteDirectory(<span class="hl-string">"/foo"</span>)
            ).get();
    }

}</pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="sftp-outbound-gateway" href="#sftp-outbound-gateway"></a>27.10&nbsp;SFTP Outbound Gateway</h2></div></div></div>

<p>The <span class="emphasis"><em>SFTP Outbound Gateway</em></span> provides a limited set of commands to interact with a remote SFTP server.
Commands supported are:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
ls (list files)
</li><li class="listitem">
get (retrieve file)
</li><li class="listitem">
mget (retrieve file(s))
</li><li class="listitem">
rm (remove file(s))
</li><li class="listitem">
mv (move/rename file)
</li><li class="listitem">
put (send file)
</li><li class="listitem">
mput (send multiple files)
</li></ul></div>
<p><span class="strong"><strong>ls</strong></span></p>
<p>ls lists remote file(s) and supports the following options:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
-1 - just retrieve a list of filenames, default is to retrieve a list of <code class="literal">FileInfo</code> objects.
</li><li class="listitem">
-a - include all files (including those starting with <span class="emphasis"><em>.</em></span>)
</li><li class="listitem">
-f - do not sort the list
</li><li class="listitem">
-dirs - include directories (excluded by default)
</li><li class="listitem">
-links - include symbolic links (excluded by default)
</li><li class="listitem">
-R - list the remote directory recursively
</li></ul></div>
<p>In addition, filename filtering is provided, in the same manner as the <code class="literal">inbound-channel-adapter</code>.</p>
<p>The message payload resulting from an <span class="emphasis"><em>ls</em></span> operation is a list of file names, or a list of <code class="literal">FileInfo</code> objects.
These objects provide information such as modified time, permissions etc.</p>
<p>The remote directory that the <span class="emphasis"><em>ls</em></span> command acted on is provided in the <code class="literal">file_remoteDirectory</code> header.</p>
<p>When using the recursive option (<code class="literal">-R</code>), the <code class="literal">fileName</code> includes any subdirectory elements, representing a relative path to the file (relative to the remote directory).
If the <code class="literal">-dirs</code> option is included, each recursive directory is also returned as an element in the list.
In this case, it is recommended that the <code class="literal">-1</code> is not used because you would not be able to determine files Vs.
directories, which is achievable using the <code class="literal">FileInfo</code> objects.</p>
<p><span class="strong"><strong>get</strong></span></p>
<p><span class="emphasis"><em>get</em></span> retrieves a remote file and supports the following option:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
-P - preserve the timestamp of the remote file
</li><li class="listitem">
-stream - retrieve the remote file as a stream.
</li></ul></div>
<p>The remote directory is provided in the <code class="literal">file_remoteDirectory</code> header, and the filename is provided in the <code class="literal">file_remoteFile</code> header.</p>
<p>The message payload resulting from a <span class="emphasis"><em>get</em></span> operation is a <code class="literal">File</code> object representing the retrieved file, or
an <code class="literal">InputStream</code> when the <code class="literal">-stream</code> option is provided.
This option allows retrieving the file as a stream.
For text files, a common use case is to combine this operation with a <a class="link" href="#file-splitter" title="14.5&nbsp;File Splitter">File Splitter</a> or
<a class="link" href="#stream-transformer" title="Stream Transformer">Stream Transformer</a>.
When consuming remote files as streams, the user is responsible for closing the <code class="literal">Session</code> after the stream is
consumed.
For convenience, the <code class="literal">Session</code> is provided in the <code class="literal">IntegrationMessageHeaderAccessor.CLOSEABLE_RESOURCE</code> header, a convenience method is provided on the
<code class="literal">IntegrationMessageHeaderAccessor</code>:</p>
<pre class="programlisting">Closeable closeable = <span class="hl-keyword">new</span> IntegrationMessageHeaderAccessor(message).getCloseableResource();
<span class="hl-keyword">if</span> (closeable != null) {
    closeable.close();
}</pre>
<p>Note: In previous releases the session was in the <code class="literal">file_remoteSession</code> header, but this is deprecated - use
<code class="literal">IntegrationMessageHeaderAccessor.CLOSEABLE_RESOURCE</code> instead.</p>
<p>Framework components such as the <a class="link" href="#file-splitter" title="14.5&nbsp;File Splitter">File Splitter</a> and <a class="link" href="#stream-transformer" title="Stream Transformer">Stream Transformer</a> will
automatically close the session after the data is transferred.</p>
<p>The following shows an example of consuming a file as a stream:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-sftp:outbound-gateway</span> <span class="hl-attribute">session-factory</span>=<span class="hl-value">"ftpSessionFactory"</span>
                            <span class="hl-attribute">request-channel</span>=<span class="hl-value">"inboundGetStream"</span>
                            <span class="hl-attribute">command</span>=<span class="hl-value">"get"</span>
                            <span class="hl-attribute">command-options</span>=<span class="hl-value">"-stream"</span>
                            <span class="hl-attribute">expression</span>=<span class="hl-value">"payload"</span>
                            <span class="hl-attribute">remote-directory</span>=<span class="hl-value">"ftpTarget"</span>
                            <span class="hl-attribute">reply-channel</span>=<span class="hl-value">"stream"</span><span class="hl-tag"> /&gt;</span>

<span class="hl-tag">&lt;int-file:splitter</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"stream"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"lines"</span><span class="hl-tag"> /&gt;</span></pre>
<p>Note: if you consume the input stream in a custom component, you <span class="strong"><strong>must</strong></span> close the <code class="literal">Session</code>.
You can either do that in your custom code, or route a copy of the message to a <code class="literal">service-activator</code> and use SpEL:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:service-activator</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"closeSession"</span>
    <span class="hl-attribute">expression</span>=<span class="hl-value">"headers[T(org.springframework.integration.IntegrationMessageHeaderAccessor).CLOSEABLE_RESOURCE].close()"</span><span class="hl-tag"> /&gt;</span></pre>
<p><span class="strong"><strong>mget</strong></span></p>
<p><span class="emphasis"><em>mget</em></span> retrieves multiple remote files based on a pattern and supports the following option:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
-P - preserve the timestamps of the remote files
</li><li class="listitem">
-x - Throw an exception if no files match the pattern (otherwise an empty list is returned)
</li></ul></div>
<p>The message payload resulting from an <span class="emphasis"><em>mget</em></span> operation is a <code class="literal">List&lt;File&gt;</code> object - a List of File objects, each representing a retrieved file.</p>
<p>The remote directory is provided in the <code class="literal">file_remoteDirectory</code> header, and the pattern for the filenames is provided in the <code class="literal">file_remoteFile</code> header.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note: Notes for when using recursion (-R)"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Notes for when using recursion (<code class="literal">-R</code>)</th></tr><tr><td align="left" valign="top">

<p>The pattern is ignored, and <code class="literal">*</code> is assumed.
By default, the entire remote tree is retrieved.
However, files in the tree can be filtered, by providing a`FileListFilter`; directories in the tree can also be filtered this way.
A <code class="literal">FileListFilter</code> can be provided by reference or by <code class="literal">filename-pattern</code> or <code class="literal">filename-regex</code> attributes.
For example, <code class="literal">filename-regex="(subDir|.*1.txt)"</code> will retrieve all files ending with <code class="literal">1.txt</code> in the remote directory and the subdirectory <code class="literal">subDir</code>.
If a subdirectory is filtered, no additional traversal of that subdirectory is performed.</p>
<p>The <code class="literal">-dirs</code> option is not allowed (the recursive mget uses the recursive <code class="literal">ls</code> to obtain the directory tree and the directories themselves cannot be included in the list).</p>
<p>Typically, you would use the <code class="literal">#remoteDirectory</code> variable in the <code class="literal">local-directory-expression</code> so that the remote directory structure is retained locally.</p>
</td></tr></table></div>
<p>See also <a class="xref" href="#sftp-partial" title="27.10.3&nbsp;Outbound Gateway Partial Success (mget and mput)">Section&nbsp;27.10.3, &#8220;Outbound Gateway Partial Success (mget and mput)&#8221;</a></p>
<p><span class="strong"><strong>put</strong></span></p>
<p><span class="emphasis"><em>put</em></span> sends a file to the remote server; the payload of the message can be a <code class="literal">java.io.File</code>, a <code class="literal">byte[]</code> or a <code class="literal">String</code>.
A <code class="literal">remote-filename-generator</code> (or expression) is used to name the remote file.
Other available attributes include <code class="literal">remote-directory</code>, <code class="literal">temporary-remote-directory</code> (and their <code class="literal">*-expression</code>) equivalents, <code class="literal">use-temporary-file-name</code>, and <code class="literal">auto-create-directory</code>.
Refer to the schema documentation for more information.</p>
<p>The message payload resulting from a <span class="emphasis"><em>put</em></span> operation is a <code class="literal">String</code> representing the full path of the file on the server after transfer.</p>
<p><span class="emphasis"><em>Version 4.3</em></span> introduced the <code class="literal">chmod</code> attribute which changes the remote file permissions after upload.
Use the conventional Unix octal format, e.g. <code class="literal">600</code> allows read-write for the file owner only.
When configuring the adapter using java, you can use <code class="literal">setChmod(0600)</code>.</p>
<p><span class="strong"><strong>mput</strong></span></p>
<p><span class="emphasis"><em>mput</em></span> sends multiple files to the server and supports the following option:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
-R - Recursive - send all files (possibly filtered) in the directory and subdirectories
</li></ul></div>
<p>The message payload must be a <code class="literal">java.io.File</code> representing a local directory.</p>
<p>The same attributes as the <code class="literal">put</code> command are supported.
In addition, files in the local directory can be filtered with one of <code class="literal">mput-pattern</code>, <code class="literal">mput-regex</code> or <code class="literal">mput-filter</code>.
The filter works with recursion, as long as the subdirectories themselves pass the filter.
Subdirectories that do not pass the filter are not recursed.</p>
<p>The message payload resulting from an <span class="emphasis"><em>mget</em></span> operation is a <code class="literal">List&lt;String&gt;</code> object - a List of remote file paths resulting from the transfer.</p>
<p>See also <a class="xref" href="#sftp-partial" title="27.10.3&nbsp;Outbound Gateway Partial Success (mget and mput)">Section&nbsp;27.10.3, &#8220;Outbound Gateway Partial Success (mget and mput)&#8221;</a></p>
<p><span class="emphasis"><em>Version 4.3</em></span> introduced the <code class="literal">chmod</code> attribute which changes the remote file permissions after upload.
Use the conventional Unix octal format, e.g. <code class="literal">600</code> allows read-write for the file owner only.
When configuring the adapter using java, you can use <code class="literal">setChmodOctal("600")</code> or <code class="literal">setChmodDecimal(384)</code>.</p>
<p><span class="strong"><strong>rm</strong></span></p>
<p>The <span class="emphasis"><em>rm</em></span> command has no options.</p>
<p>The message payload resulting from an <span class="emphasis"><em>rm</em></span> operation is Boolean.TRUE if the remove was successful, Boolean.FALSE otherwise.
The remote directory is provided in the <code class="literal">file_remoteDirectory</code> header, and the filename is provided in the <code class="literal">file_remoteFile</code> header.</p>
<p><span class="strong"><strong>mv</strong></span></p>
<p>The <span class="emphasis"><em>mv</em></span> command has no options.</p>
<p>The <span class="emphasis"><em>expression</em></span> attribute defines the "from" path and the <span class="emphasis"><em>rename-expression</em></span> attribute defines the "to" path.
By default, the <span class="emphasis"><em>rename-expression</em></span> is <code class="literal">headers['file_renameTo']</code>.
This expression must not evaluate to null, or an empty <code class="literal">String</code>.
If necessary, any remote directories needed will be created.
The payload of the result message is <code class="literal">Boolean.TRUE</code>.
The original remote directory is provided in the <code class="literal">file_remoteDirectory</code> header, and the filename is provided in the <code class="literal">file_remoteFile</code> header.
The new path is in the <code class="literal">file_renameTo</code> header.</p>
<p><span class="strong"><strong>Additional Information</strong></span></p>
<p>The <span class="emphasis"><em>get</em></span> and <span class="emphasis"><em>mget</em></span> commands support the <span class="emphasis"><em>local-filename-generator-expression</em></span> attribute.
It defines a SpEL expression to generate the name of local file(s) during the transfer.
The root object of the evaluation context is the request Message but, in addition, the <code class="literal">remoteFileName</code> variable is also available, which is particularly useful for <span class="emphasis"><em>mget</em></span>, for example: <code class="literal">local-filename-generator-expression="#remoteFileName.toUpperCase() + headers.foo"</code></p>
<p>The <span class="emphasis"><em>get</em></span> and <span class="emphasis"><em>mget</em></span> commands support the <span class="emphasis"><em>local-directory-expression</em></span> attribute.
It defines a SpEL expression to generate the name of local directory(ies) during the transfer.
The root object of the evaluation context is the request Message but, in addition, the <code class="literal">remoteDirectory</code> variable is also available, which is particularly useful for <span class="emphasis"><em>mget</em></span>, for example: <code class="literal">local-directory-expression="'/tmp/local/' + #remoteDirectory.toUpperCase() + headers.foo"</code>.
This attribute is mutually exclusive with <span class="emphasis"><em>local-directory</em></span> attribute.</p>
<p>For all commands, the PATH that the command acts on is provided by the <span class="emphasis"><em>expression</em></span> property of the gateway.
For the mget command, the expression might evaluate to <span class="emphasis"><em><span class="strong"><strong></strong></span>, meaning retrieve all files, or <span class="emphasis"><em>somedirectory/</em></span></em></span> etc.</p>
<p>Here is an example of a gateway configured for an ls command&#8230;&#8203;</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-ftp:outbound-gateway</span> <span class="hl-attribute">id</span>=<span class="hl-value">"gateway1"</span>
        <span class="hl-attribute">session-factory</span>=<span class="hl-value">"ftpSessionFactory"</span>
        <span class="hl-attribute">request-channel</span>=<span class="hl-value">"inbound1"</span>
        <span class="hl-attribute">command</span>=<span class="hl-value">"ls"</span>
        <span class="hl-attribute">command-options</span>=<span class="hl-value">"-1"</span>
        <span class="hl-attribute">expression</span>=<span class="hl-value">"payload"</span>
        <span class="hl-attribute">reply-channel</span>=<span class="hl-value">"toSplitter"</span><span class="hl-tag">/&gt;</span></pre>
<p>The payload of the message sent to the toSplitter channel is a list of String objects containing the filename of each file.
If the <code class="literal">command-options</code> was omitted, it would be a list of <code class="literal">FileInfo</code> objects.
Options are provided space-delimited, e.g.
<code class="literal">command-options="-1 -dirs -links"</code>.</p>
<p>Starting with <span class="emphasis"><em>version 4.2</em></span>, the <code class="literal">GET</code>, <code class="literal">MGET</code>, <code class="literal">PUT</code> and <code class="literal">MPUT</code> commands support a <code class="literal">FileExistsMode</code> property (<code class="literal">mode</code>
when using the namespace support). This affects the behavior when the local file exists (<code class="literal">GET</code> and <code class="literal">MGET</code>) or the remote
file exists (<code class="literal">PUT</code> and <code class="literal">MPUT</code>). Supported modes are <code class="literal">REPLACE</code>, <code class="literal">APPEND</code>, <code class="literal">FAIL</code> and <code class="literal">IGNORE</code>.
For backwards compatibility, the default mode for <code class="literal">PUT</code> and <code class="literal">MPUT</code> operations is <code class="literal">REPLACE</code> and for <code class="literal">GET</code> and <code class="literal">MGET</code>
operations, the default is <code class="literal">FAIL</code>.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_with_java_configuration_20" href="#_configuring_with_java_configuration_20"></a>27.10.1&nbsp;Configuring with Java Configuration</h3></div></div></div>

<p>The following Spring Boot application provides an example of configuring the Outbound Gateway using Java configuration:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@SpringBootApplication</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> SftpJavaApplication {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
        <span class="hl-keyword">new</span> SpringApplicationBuilder(SftpJavaApplication.<span class="hl-keyword">class</span>)
            .web(false)
            .run(args);
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "sftpChannel")</span></em>
    <span class="hl-keyword">public</span> MessageHandler handler() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> SftpOutboundGateway(ftpSessionFactory(), <span class="hl-string">"ls"</span>);
    }

}</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_with_the_java_dsl_14" href="#_configuring_with_the_java_dsl_14"></a>27.10.2&nbsp;Configuring with the Java DSL</h3></div></div></div>

<p>The following Spring Boot application provides an example of configuring the Outbound Gateway using the Java DSL:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@SpringBootApplication</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> SftpJavaApplication {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
        <span class="hl-keyword">new</span> SpringApplicationBuilder(SftpJavaApplication.<span class="hl-keyword">class</span>)
            .web(false)
            .run(args);
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> SessionFactory&lt;FTPFile&gt; ftpSessionFactory() {
        DefaultFtpSessionFactory sf = <span class="hl-keyword">new</span> DefaultFtpSessionFactory();
        sf.setHost(<span class="hl-string">"localhost"</span>);
        sf.setPort(port);
        sf.setUsername(<span class="hl-string">"foo"</span>);
        sf.setPassword(<span class="hl-string">"foo"</span>);
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> CachingSessionFactory&lt;FTPFile&gt;(sf);
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> QueueChannelSpec remoteFileOutputChannel() {
        <span class="hl-keyword">return</span> MessageChannels.queue();
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> IntegrationFlow sftpMGetFlow() {
        <span class="hl-keyword">return</span> IntegrationFlows.from(<span class="hl-string">"sftpMgetInputChannel"</span>)
            .handleWithAdapter(h -&gt;
                h.sftpGateway(<span class="hl-keyword">this</span>.sftpSessionFactory, AbstractRemoteFileOutboundGateway.Command.MGET,
                    <span class="hl-string">"payload"</span>)
                    .options(AbstractRemoteFileOutboundGateway.Option.RECURSIVE)
                    .regexFileNameFilter(<span class="hl-string">"(subSftpSource|.*1.txt)"</span>)
                    .localDirectoryExpression(<span class="hl-string">"'myDir/' + #remoteDirectory"</span>)
                    .localFilenameExpression(<span class="hl-string">"#remoteFileName.replaceFirst('sftpSource', 'localTarget')"</span>))
            .channel(<span class="hl-string">"remoteFileOutputChannel"</span>)
            .get();
    }

}</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="sftp-partial" href="#sftp-partial"></a>27.10.3&nbsp;Outbound Gateway Partial Success (mget and mput)</h3></div></div></div>

<p>When performing operations on multiple files (<code class="literal">mget</code> and <code class="literal">mput</code>) it is possible that an exception occurs some time after
one or more files have been transferred.
In this case (starting with <span class="emphasis"><em>version 4.2</em></span>), a <code class="literal">PartialSuccessException</code> is thrown.
As well as the usual <code class="literal">MessagingException</code> properties (<code class="literal">failedMessage</code> and <code class="literal">cause</code>), this exception has two additional
properties:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">partialResults</code> - the successful transfer results.
</li><li class="listitem">
<code class="literal">derivedInput</code> - the list of files generated from the request message (e.g. local files to transfer for an <code class="literal">mput</code>).
</li></ul></div>
<p>This will enable you to determine which files were successfully transferred, and which were not.</p>
<p>In the case of a recursive <code class="literal">mput</code>, the <code class="literal">PartialSuccessException</code> may have nested <code class="literal">PartialSuccessException</code> s.</p>
<p>Consider:</p>
<pre class="screen">root/
|- file1.txt
|- subdir/
   | - file2.txt
   | - file3.txt
|- zoo.txt</pre>
<p>If the exception occurs on <code class="literal">file3.txt</code>, the <code class="literal">PartialSuccessException</code> thrown by the gateway will have <code class="literal">derivedInput</code>
of <code class="literal">file1.txt</code>, <code class="literal">subdir</code>, <code class="literal">zoo.txt</code> and <code class="literal">partialResults</code> of <code class="literal">file1.txt</code>.
It&#8217;s <code class="literal">cause</code> will be another <code class="literal">PartialSuccessException</code> with <code class="literal">derivedInput</code> of <code class="literal">file2.txt</code>, <code class="literal">file3.txt</code> and
<code class="literal">partialResults</code> of <code class="literal">file2.txt</code>.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="sftp-jsch-logging" href="#sftp-jsch-logging"></a>27.11&nbsp;SFTP/JSCH Logging</h2></div></div></div>

<p>Since we use JSch libraries (<a class="ulink" href="http://www.jcraft.com/jsch/" target="_top">http://www.jcraft.com/jsch/</a>) to provide SFTP support, at times you may require more information from the JSch API itself, especially if something is not working properly (e.g., Authentication exceptions).
Unfortunately JSch does not use commons-logging but instead relies on custom implementations of their <code class="literal">com.jcraft.jsch.Logger</code> interface.
As of Spring Integration 2.0.1, we have implemented this interface.
So, now all you need to do to enable JSch logging is to configure your logger the way you usually do.
For example, here is valid configuration of a logger using Log4J.</p>
<pre class="programlisting">log4j.category.com.jcraft.jsch=DEBUG</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="sftp-session-callback" href="#sftp-session-callback"></a>27.12&nbsp;MessageSessionCallback</h2></div></div></div>

<p>Starting with <span class="emphasis"><em>Spring Integration version 4.2</em></span>, a <code class="literal">MessageSessionCallback&lt;F, T&gt;</code> implementation can be used with the
<code class="literal">&lt;int-ftp:outbound-gateway/&gt;</code> (<code class="literal">FtpOutboundGateway</code>) to perform any operation(s) on the <code class="literal">Session&lt;FTPFile&gt;</code> with
the <code class="literal">requestMessage</code> context.
It can be used for any non-standard or low-level FTP operation (or several); for example, allowing access
from an integration flow definition, and <span class="emphasis"><em>functional</em></span> interface (Lambda) implementation injection:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "sftpChannel")</span></em>
<span class="hl-keyword">public</span> MessageHandler sftpOutboundGateway(SessionFactory&lt;ChannelSftp.LsEntry&gt; sessionFactory) {
    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> SftpOutboundGateway(sessionFactory,
         (session, requestMessage) -&gt; session.list(requestMessage.getPayload()));
}</pre>
<p>Another example might be to pre- or post- process the file data being sent/retrieved.</p>
<p>When using XML configuration, the <code class="literal">&lt;int-sftp:outbound-gateway/&gt;</code> provides a <code class="literal">session-callback</code> attribute to allow you
to specify the <code class="literal">MessageSessionCallback</code> bean name.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The <code class="literal">session-callback</code> is mutually exclusive with the <code class="literal">command</code> and <code class="literal">expression</code> attributes.
When configuring with Java, different constructors are available in the <code class="literal">SftpOutboundGateway</code> class.</p>
</td></tr></table></div>
</div>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="stomp" href="#stomp"></a>28.&nbsp;STOMP Support</h2></div></div></div>

<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="stomp-introduction" href="#stomp-introduction"></a>28.1&nbsp;Introduction</h2></div></div></div>

<p>Spring Integration <span class="emphasis"><em>version 4.2</em></span> introduced <span class="emphasis"><em>STOMP Client</em></span> support.
It is based on the architecture, infrastructure and API from the Spring Framework&#8217;s <span class="emphasis"><em>messaging</em></span> module, <span class="emphasis"><em>stomp</em></span> package.
Many of Spring STOMP components (e.g. <code class="literal">StompSession</code> or <code class="literal">StompClientSupport</code>)
are used within Spring Integration.
For more information, please, refer to the <a class="ulink" href="http://docs.spring.io/spring/docs/current/spring-framework-reference/html/websocket.html#websocket-stomp-client" target="_top">Spring Framework STOMP Support</a>
chapter in the Spring Framework reference manual.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="stomp-overview" href="#stomp-overview"></a>28.2&nbsp;Overview</h2></div></div></div>

<p>To configure STOMP (Simple [or Streaming] Text Orientated Messaging Protocol) let&#8217;s start with the <span class="emphasis"><em>STOMP Client</em></span> object.
The Spring Framework provides these implementations:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">WebSocketStompClient</code> - built on the Spring WebSocket API with support for standard JSR-356 WebSocket, Jetty 9,
as well as SockJS for HTTP-based WebSocket emulation with SockJS Client.
</li><li class="listitem">
<code class="literal">Reactor2TcpStompClient</code> - built on <code class="literal">NettyTcpClient</code> from the <code class="literal">reactor-net</code> project.
</li></ul></div>
<p>Any other <code class="literal">StompClientSupport</code> implementation can be provided.
See the JavaDocs of those classes for more information.</p>
<p>The <code class="literal">StompClientSupport</code> class is designed as a <span class="emphasis"><em>factory</em></span> to produce a <code class="literal">StompSession</code> for the provided
<code class="literal">StompSessionHandler</code> and all the remaining work is done through the <span class="emphasis"><em>callbacks</em></span> to that <code class="literal">StompSessionHandler</code>
and <code class="literal">StompSession</code> abstraction.
With the Spring Integration <span class="emphasis"><em>adapter</em></span> abstraction, we
need to provide some managed shared object to represent our application as a STOMP client with its unique session.
For this purpose, Spring Integration provides the <code class="literal">StompSessionManager</code> abstraction to manage the <span class="emphasis"><em>single</em></span>
<code class="literal">StompSession</code> between any provided <code class="literal">StompSessionHandler</code>.
This allows the use of <span class="emphasis"><em>inbound</em></span> or <span class="emphasis"><em>outbound</em></span> channel adapters (or both) for the particular STOMP Broker.
See <code class="literal">StompSessionManager</code> (and its implementations) JavaDocs for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="stomp-inbound-adapter" href="#stomp-inbound-adapter"></a>28.3&nbsp;STOMP Inbound Channel Adapter</h2></div></div></div>

<p>The <code class="literal">StompInboundChannelAdapter</code> is a one-stop <code class="literal">MessageProducer</code> component to subscribe our Spring Integration
application to the provided STOMP destinations and receive messages from them, converted from the STOMP
frames using the provided <code class="literal">MessageConverter</code> on the connected <code class="literal">StompSession</code>.
The destinations (and therefore STOMP subscriptions) can be changed at runtime using appropriate <code class="literal">@ManagedOperation</code> s
on the <code class="literal">StompInboundChannelAdapter</code>.</p>
<p>For more configuration options see <a class="xref" href="#stomp-namespace" title="28.8&nbsp;STOMP Namespace Support">Section&nbsp;28.8, &#8220;STOMP Namespace Support&#8221;</a> and the <code class="literal">StompInboundChannelAdapter</code> JavaDocs.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="stomp-outbound-adapter" href="#stomp-outbound-adapter"></a>28.4&nbsp;STOMP Outbound Channel Adapter</h2></div></div></div>

<p>The <code class="literal">StompMessageHandler</code> is the <code class="literal">MessageHandler</code> for the <code class="literal">&lt;int-stomp:outbound-channel-adapter&gt;</code>
to send the outgoing <code class="literal">Message&lt;?&gt;</code> s to the STOMP <code class="literal">destination</code> (pre-configured or determined at runtime via a SpEL expression) STOMP through the <code class="literal">StompSession</code>, provided by the shared <code class="literal">StompSessionManager</code>.</p>
<p>For more configuration option see <a class="xref" href="#stomp-namespace" title="28.8&nbsp;STOMP Namespace Support">Section&nbsp;28.8, &#8220;STOMP Namespace Support&#8221;</a> and the <code class="literal">StompMessageHandler</code> JavaDocs.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="stomp-headers" href="#stomp-headers"></a>28.5&nbsp;STOMP Headers Mapping</h2></div></div></div>

<p>The STOMP protocol provides <span class="emphasis"><em>headers</em></span> as part of frame; the entire structure of the STOMP frame
has this format:</p>
<pre class="literallayout">COMMAND
header1:value1
header2:value2

Body^@</pre>
<p>Spring Framework provides <code class="literal">StompHeaders</code>, to represent these headers.
See the JavaDocs for more details.
STOMP frames are converted to/from <code class="literal">Message&lt;?&gt;</code> and these headers are mapped to/from <code class="literal">MessageHeaders</code>.
Spring Integration provides a default <code class="literal">HeaderMapper</code> implementation for the STOMP adapters.
The implementation is <code class="literal">StompHeaderMapper</code> which provides <code class="literal">fromHeaders()</code> and <code class="literal">toHeaders()</code> operations for the
<span class="emphasis"><em>inbound</em></span> and <span class="emphasis"><em>outbound</em></span> adapters respectively.</p>
<p>As with many other Spring Integration modules, the <code class="literal">IntegrationStompHeaders</code> class has been
introduced to map standard STOMP headers to <code class="literal">MessageHeaders</code> with <code class="literal">stomp_</code> as the header name prefix.
In addition, all <code class="literal">MessageHeaders</code> with that prefix are mapped to the <code class="literal">StompHeaders</code> when sending to a destination.</p>
<p>For more information, see the JavaDocs of those classes and the <code class="literal">mapped-headers</code> attribute description in the
<a class="xref" href="#stomp-namespace" title="28.8&nbsp;STOMP Namespace Support">Section&nbsp;28.8, &#8220;STOMP Namespace Support&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="stomp-events" href="#stomp-events"></a>28.6&nbsp;STOMP Integration Events</h2></div></div></div>

<p>Many STOMP operations are asynchronous, including error handling.
For example, STOMP has a <code class="literal">RECEIPT</code> server frame that is returned when a client frame has requested one by adding
the <code class="literal">RECEIPT</code> header.
To provide access to these asynchronous events, Spring Integration emits <code class="literal">StompIntegrationEvent</code> s which can be
obtained by implementing an <code class="literal">ApplicationListener</code> or using an <code class="literal">&lt;int-event:inbound-channel-adapter&gt;</code> (see <a class="xref" href="#appevent-inbound" title="12.1&nbsp;Receiving Spring Application Events">Section&nbsp;12.1, &#8220;Receiving Spring Application Events&#8221;</a>).</p>
<p>Specifically, a <code class="literal">StompExceptionEvent</code> is emitted from the <code class="literal">AbstractStompSessionManager</code>, when a
<code class="literal">stompSessionListenableFuture</code> receives <code class="literal">onFailure()</code> in case of failure to connect to STOMP Broker.
Another example is the <code class="literal">StompMessageHandler</code> which processes
<code class="literal">ERROR</code> STOMP frames, which are server responses to improper, unaccepted, messages sent by this <code class="literal">StompMessageHandler</code>.</p>
<p>The <code class="literal">StompReceiptEvent</code> s are emitted from the <code class="literal">StompMessageHandler</code> as a part of <code class="literal">StompSession.Receiptable</code>
callbacks in the asynchronous answers for the sent messages to the <code class="literal">StompSession</code>.
The <code class="literal">StompReceiptEvent</code> can be positive and negative depending on whether or not the <code class="literal">RECEIPT</code> frame was received
from the server within the <code class="literal">receiptTimeLimit</code> period, which can be configured on the <code class="literal">StompClientSupport</code> instance.
Defaults to <code class="literal">15 * 1000</code>.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The <code class="literal">StompSession.Receiptable</code> callbacks are added only if the <code class="literal">RECEIPT</code> STOMP header of the message to send
is not <code class="literal">null</code>.
Automatic <code class="literal">RECEIPT</code> header generation can be enabled on the <code class="literal">StompSession</code> through its <code class="literal">autoReceipt</code> option and
on the <code class="literal">StompSessionManager</code> respectively.</p>
</td></tr></table></div>
<p>See the next paragraph for more information how to configure Spring Integration to accept those <code class="literal">ApplicationEvent</code> s.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="stomp-java-config" href="#stomp-java-config"></a>28.7&nbsp;STOMP Adapters Java Configuration</h2></div></div></div>

<p>A comprehensive Java &amp; Annotation Configuration for STOMP Adapters may look like this:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Configuration</span></em>
<em><span class="hl-annotation" style="color: gray">@EnableIntegration</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> StompConfiguration {

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> Reactor2TcpStompClient stompClient() {
        Reactor2TcpStompClient stompClient = <span class="hl-keyword">new</span> Reactor2TcpStompClient(<span class="hl-string">"127.0.0.1"</span>, <span class="hl-number">61613</span>);
        stompClient.setMessageConverter(<span class="hl-keyword">new</span> PassThruMessageConverter());
        ThreadPoolTaskScheduler taskScheduler = <span class="hl-keyword">new</span> ThreadPoolTaskScheduler();
        taskScheduler.afterPropertiesSet();
        stompClient.setTaskScheduler(taskScheduler);
        stompClient.setReceiptTimeLimit(<span class="hl-number">5000</span>);
        <span class="hl-keyword">return</span> stompClient;
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> StompSessionManager stompSessionManager() {
        Reactor2TcpStompSessionManager stompSessionManager = <span class="hl-keyword">new</span> Reactor2TcpStompSessionManager(stompClient());
        stompSessionManager.setAutoReceipt(true);
        <span class="hl-keyword">return</span> stompSessionManager;
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> PollableChannel stompInputChannel() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> QueueChannel();
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> StompInboundChannelAdapter stompInboundChannelAdapter() {
        StompInboundChannelAdapter adapter =
        		<span class="hl-keyword">new</span> StompInboundChannelAdapter(stompSessionManager(), <span class="hl-string">"/topic/myTopic"</span>);
        adapter.setOutputChannel(stompInputChannel());
        <span class="hl-keyword">return</span> adapter;
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "stompOutputChannel")</span></em>
    <span class="hl-keyword">public</span> MessageHandler stompMessageHandler() {
        StompMessageHandler handler = <span class="hl-keyword">new</span> StompMessageHandler(stompSessionManager());
        handler.setDestination(<span class="hl-string">"/topic/myTopic"</span>);
        <span class="hl-keyword">return</span> handler;
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> PollableChannel stompEvents() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> QueueChannel();
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> ApplicationListener&lt;ApplicationEvent&gt; stompEventListener() {
        ApplicationEventListeningMessageProducer producer = <span class="hl-keyword">new</span> ApplicationEventListeningMessageProducer();
        producer.setEventTypes(StompIntegrationEvent.<span class="hl-keyword">class</span>);
        producer.setOutputChannel(stompEvents());
        <span class="hl-keyword">return</span> producer;
    }

}</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="stomp-namespace" href="#stomp-namespace"></a>28.8&nbsp;STOMP Namespace Support</h2></div></div></div>

<p>Spring Integration <span class="emphasis"><em>STOMP</em></span> namespace implements the <span class="emphasis"><em>inbound</em></span> and <span class="emphasis"><em>outbound</em></span> channel adapter components described below.
To include it in your configuration, simply provide the following namespace declaration in your application context
configuration file:</p>
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
  <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
  <span class="hl-attribute">xmlns:int</span>=<span class="hl-value">"http://www.springframework.org/schema/integration"</span>
  <span class="hl-attribute">xmlns:int-stomp</span>=<span class="hl-value">"http://www.springframework.org/schema/integration/stomp"</span>
  <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"
    http://www.springframework.org/schema/beans
    http://www.springframework.org/schema/beans/spring-beans.xsd
    http://www.springframework.org/schema/integration
    http://www.springframework.org/schema/integration/spring-integration.xsd
    http://www.springframework.org/schema/integration/stomp
    http://www.springframework.org/schema/integration/stomp/spring-integration-stomp.xsd"</span><span class="hl-tag">&gt;</span>
    ...
<span class="hl-tag">&lt;/beans&gt;</span></pre>
<p><span class="strong"><strong>&lt;int-stomp:outbound-channel-adapter&gt;</strong></span></p>
<pre class="programlisting"><span class="hl-tag">&lt;int-stomp:outbound-channel-adapter</span>
                           <span class="hl-attribute">id</span>=<span class="hl-value">""</span>  <a name="CO47-1" href="#CO47-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
                           channel=""  <a name="CO47-2" href="#CO47-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
                           stomp-session-manager=""  <a name="CO47-3" href="#CO47-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
                           header-mapper=""  <a name="CO47-4" href="#CO47-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
                           mapped-headers=""  <a name="CO47-5" href="#CO47-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
                           destination=""  <a name="CO47-6" href="#CO47-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>
                           destination-expression=""  <a name="CO47-7" href="#CO47-7"></a><span><img src="images/callouts/7.png" alt="7" border="0"></span>
                           auto-startup=""  <a name="CO47-8" href="#CO47-8"></a><span><img src="images/callouts/8.png" alt="8" border="0"></span>
                           phase=""/&gt;  <a name="CO47-9" href="#CO47-9"></a><span><img src="images/callouts/9.png" alt="9" border="0"></span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO47-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The component bean name.
The <code class="literal">MessageHandler</code> is registered with the bean alias <code class="literal">id + '.handler'</code>.
If the <code class="literal">channel</code> attribute isn&#8217;t provided, a <code class="literal">DirectChannel</code> is created and registered with the application context
with this <code class="literal">id</code> attribute as the bean name.
In this case, the endpoint is registered with the bean name <code class="literal">id + '.adapter'</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO47-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Identifies the channel attached to this adapter.
<span class="emphasis"><em>Optional</em></span> - if <code class="literal">id</code> is present - see <code class="literal">id</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO47-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Reference to a <code class="literal">StompSessionManager</code> bean, which encapsulates the low-level connection and <code class="literal">StompSession</code>
handling operations.
<span class="emphasis"><em>Required</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO47-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Reference to a bean implementing <code class="literal">HeaderMapper&lt;StompHeaders&gt;</code> that maps Spring Integration MessageHeaders to/from
STOMP frame headers.
This is mutually exclusive with <code class="literal">mapped-headers</code>.
Defaults to <code class="literal">StompHeaderMapper</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO47-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Comma-separated list of names of STOMP Headers to be mapped to the STOMP frame headers.
This can only be provided if the <code class="literal">header-mapper</code> reference is not set.
The values in this list can also be simple patterns to be matched against the header names (e.g. "foo*" or "*foo").
A special token <code class="literal">STOMP_OUTBOUND_HEADERS</code> represents all the standard STOMP headers
(content-length, receipt, heart-beat etc); they are included by default.
If you wish to add your own headers, you must also include this token if you wish the standard headers to also be
mapped or provide your own <code class="literal">HeaderMapper</code> implementation using <code class="literal">header-mapper</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO47-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Name of the destination to which STOMP Messages will be sent.
Mutually exclusive with the <code class="literal">destination-expression</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO47-7"><span><img src="images/callouts/7.png" alt="7" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A SpEL expression to be evaluated at runtime against each Spring Integration <code class="literal">Message</code> as the root object.
Mutually exclusive with the <code class="literal">destination</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO47-8"><span><img src="images/callouts/8.png" alt="8" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Boolean value indicating whether this endpoint should start automatically.
Default to <code class="literal">true</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO47-9"><span><img src="images/callouts/9.png" alt="9" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The lifecycle phase within which this endpoint should start and stop.
The lower the value the earlier this endpoint will start and the later it will stop.
The default is <code class="literal">Integer.MIN_VALUE</code>.
Values can be negative.
See <code class="literal">SmartLifeCycle</code>.</p>
</td></tr></table></div>
<p><span class="strong"><strong>&lt;int-stomp:inbound-channel-adapter&gt;</strong></span></p>
<pre class="programlisting"><span class="hl-tag">&lt;int-stomp:inbound-channel-adapter</span>
                           <span class="hl-attribute">id</span>=<span class="hl-value">""</span>  <a name="CO48-1" href="#CO48-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
                           channel=""  <a name="CO48-2" href="#CO48-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
                           error-channel=""  <a name="CO48-3" href="#CO48-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
                           stomp-session-manager=""  <a name="CO48-4" href="#CO48-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
                           header-mapper=""  <a name="CO48-5" href="#CO48-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
                           mapped-headers=""  <a name="CO48-6" href="#CO48-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>
                           destinations=""  <a name="CO48-7" href="#CO48-7"></a><span><img src="images/callouts/7.png" alt="7" border="0"></span>
                           send-timeout=""  <a name="CO48-8" href="#CO48-8"></a><span><img src="images/callouts/8.png" alt="8" border="0"></span>
                           payload-type=""  <a name="CO48-9" href="#CO48-9"></a><span><img src="images/callouts/9.png" alt="9" border="0"></span>
                           auto-startup=""  <a name="CO48-10" href="#CO48-10"></a><span><img src="images/callouts/10.png" alt="10" border="0"></span>
                           phase=""/&gt;  <a name="CO48-11" href="#CO48-11"></a><span><img src="images/callouts/11.png" alt="11" border="0"></span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO48-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The component bean name.
If the <code class="literal">channel</code> attribute isn&#8217;t provided, a <code class="literal">DirectChannel</code> is created and registered with the application context
with this <code class="literal">id</code> attribute as the bean name.
In this case, the endpoint is registered with the bean name <code class="literal">id + '.adapter'</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO48-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Identifies the channel attached to this adapter.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO48-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The <code class="literal">MessageChannel</code> bean reference to which the <code class="literal">ErrorMessages</code> should be sent.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO48-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>See the same option on the <code class="literal">&lt;int-stomp:outbound-channel-adapter&gt;</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO48-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Comma-separated list of names of STOMP Headers to be mapped from the STOMP frame headers.
This can only be provided if the <code class="literal">header-mapper</code> reference is not set.
The values in this list can also be simple patterns to be matched against the header names (e.g. "foo*" or "*foo").
A special token <code class="literal">STOMP_INBOUND_HEADERS</code> represents all the standard STOMP headers
(content-length, receipt, heart-beat etc); they are included by default.
If you wish to add your own headers, you must also include this token if you wish the standard headers to also be
mapped or provide your own <code class="literal">HeaderMapper</code> implementation using <code class="literal">header-mapper</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO48-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>See the same option on the <code class="literal">&lt;int-stomp:outbound-channel-adapter&gt;</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO48-7"><span><img src="images/callouts/7.png" alt="7" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Comma-separated list of STOMP destination names to subscribe.
The list of destinations (and therefore subscriptions) can be modified at runtime
through the <code class="literal">addDestination()</code> and <code class="literal">removeDestination()</code> <code class="literal">@ManagedOperation</code> s.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO48-8"><span><img src="images/callouts/8.png" alt="8" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Maximum amount of time in milliseconds to wait when sending a message to the channel if the channel may block.
For example, a <code class="literal">QueueChannel</code> can block until space is available if its maximum capacity has been reached.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO48-9"><span><img src="images/callouts/9.png" alt="9" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Fully qualified name of the java type for the target <code class="literal">payload</code> to convert from the incoming STOMP Frame.
Default to <code class="literal">String.class</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO48-10"><span><img src="images/callouts/10.png" alt="10" border="0"></span></a> </p></td><td valign="top" align="left">
<p>See the same option on the <code class="literal">&lt;int-stomp:outbound-channel-adapter&gt;</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO48-11"><span><img src="images/callouts/11.png" alt="11" border="0"></span></a> </p></td><td valign="top" align="left">
<p>See the same option on the <code class="literal">&lt;int-stomp:outbound-channel-adapter&gt;</code>.</p>
</td></tr></table></div>
</div>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="stream" href="#stream"></a>29.&nbsp;Stream Support</h2></div></div></div>

<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="stream-intro" href="#stream-intro"></a>29.1&nbsp;Introduction</h2></div></div></div>

<p>In many cases application data is obtained from a stream.
It is <span class="emphasis"><em>not</em></span> recommended to send a reference to a Stream as a message payload to a consumer.
Instead messages are created from data that is read from an input stream and message payloads are written to an output stream one by one.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="stream-reading" href="#stream-reading"></a>29.2&nbsp;Reading from streams</h2></div></div></div>

<p>Spring Integration provides two adapters for streams.
Both <code class="literal">ByteStreamReadingMessageSource</code> and <code class="literal">CharacterStreamReadingMessageSource</code> implement <code class="literal">MessageSource</code>.
By configuring one of these within a channel-adapter element, the polling period can be configured, and the Message Bus can automatically detect and schedule them.
The byte stream version requires an <code class="literal">InputStream</code>, and the character stream version requires a <code class="literal">Reader</code> as the single constructor argument.
The <code class="literal">ByteStreamReadingMessageSource</code> also accepts the <span class="emphasis"><em>bytesPerMessage</em></span> property to determine how many bytes it will attempt to read into each <code class="literal">Message</code>.
The default value is 1024</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.stream.ByteStreamReadingMessageSource"</span><span class="hl-tag">&gt;</span>
  <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"someInputStream"</span><span class="hl-tag">/&gt;</span>
  <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"bytesPerMessage"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"2048"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.stream.CharacterStreamReadingMessageSource"</span><span class="hl-tag">&gt;</span>
  <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"someReader"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="stream-writing" href="#stream-writing"></a>29.3&nbsp;Writing to streams</h2></div></div></div>

<p>For target streams, there are also two implementations: <code class="literal">ByteStreamWritingMessageHandler</code> and <code class="literal">CharacterStreamWritingMessageHandler</code>.
Each requires a single constructor argument - <code class="literal">OutputStream</code> for byte streams or <code class="literal">Writer</code> for character streams, and each provides a second constructor that adds the optional <span class="emphasis"><em>bufferSize</em></span>.
Since both of these ultimately implement the <code class="literal">MessageHandler</code> interface, they can be referenced from a <span class="emphasis"><em>channel-adapter</em></span> configuration as described in more detail in <a class="xref" href="#channel-adapter" title="4.3&nbsp;Channel Adapter">Section&nbsp;4.3, &#8220;Channel Adapter&#8221;</a>.</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.stream.ByteStreamWritingMessageHandler"</span><span class="hl-tag">&gt;</span>
  <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"someOutputStream"</span><span class="hl-tag">/&gt;</span>
  <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"1024"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.stream.CharacterStreamWritingMessageHandler"</span><span class="hl-tag">&gt;</span>
  <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"someWriter"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="stream-namespace" href="#stream-namespace"></a>29.4&nbsp;Stream namespace support</h2></div></div></div>

<p>To reduce the configuration needed for stream related channel adapters there is a namespace defined.
The following schema locations are needed to use it.</p>
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans:beans</span> <span class="hl-attribute">xmlns:int-stream</span>=<span class="hl-value">"http://www.springframework.org/schema/integration/stream"</span>
  <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
  <span class="hl-attribute">xmlns:beans</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
  <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"http://www.springframework.org/schema/beans
      http://www.springframework.org/schema/beans/spring-beans.xsd
      http://www.springframework.org/schema/integration/stream
      http://www.springframework.org/schema/integration/stream/spring-integration-stream.xsd"</span><span class="hl-tag">&gt;</span></pre>
<p>To configure the inbound channel adapter the following code snippet shows the different configuration options that are supported.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-stream:stdin-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"adapterWithDefaultCharset"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int-stream:stdin-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"adapterWithProvidedCharset"</span> <span class="hl-attribute">charset</span>=<span class="hl-value">"UTF-8"</span><span class="hl-tag">/&gt;</span></pre>
<p>To configure the outbound channel adapter you can use the namespace support as well.
The following code snippet shows the different configuration for an outbound channel adapters.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-stream:stdout-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"stdoutAdapterWithDefaultCharset"</span>
    <span class="hl-attribute">channel</span>=<span class="hl-value">"testChannel"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int-stream:stdout-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"stdoutAdapterWithProvidedCharset"</span> <span class="hl-attribute">charset</span>=<span class="hl-value">"UTF-8"</span>
    <span class="hl-attribute">channel</span>=<span class="hl-value">"testChannel"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int-stream:stderr-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"stderrAdapter"</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"testChannel"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int-stream:stdout-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"newlineAdapter"</span> <span class="hl-attribute">append-newline</span>=<span class="hl-value">"true"</span>
    <span class="hl-attribute">channel</span>=<span class="hl-value">"testChannel"</span><span class="hl-tag">/&gt;</span></pre>
</div>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="syslog" href="#syslog"></a>30.&nbsp;Syslog Support</h2></div></div></div>

<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="syslog-intro" href="#syslog-intro"></a>30.1&nbsp;Introduction</h2></div></div></div>

<p>Spring Integration 2.2 introduced the Syslog transformer <code class="literal">SyslogToMapTransformer</code>.
This transformer, together with a <code class="literal">UDP</code> or <code class="literal">TCP</code> inbound adapter could be used to receive and analyze syslog records from other hosts.
The transformer creates a message payload containing a map of the elements from the syslog message.</p>
<p>Spring Integration 3.0 introduced convenient namespace support for configuring a Syslog inbound adapter in a single element.</p>
<p>Starting with <span class="emphasis"><em>version 4.1.1</em></span>, the framework now supports the extended Syslog format, as specified in <a class="ulink" href="https://tools.ietf.org/html/rfc5424" target="_top">RFC 5424&gt;</a>.
In addition, when using TCP and RFC5424, both <code class="literal">octet counting</code> and <code class="literal">non-transparent framing</code> described in <a class="ulink" href="https://tools.ietf.org/html/rfc6587" target="_top">RFC 6587</a> are supported.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="syslog-inbound-adapter" href="#syslog-inbound-adapter"></a>30.2&nbsp;Syslog &lt;inbound-channel-adapter&gt;</h2></div></div></div>

<p>This element encompasses a <code class="literal">UDP</code> or <code class="literal">TCP</code> inbound channel adapter and a <code class="literal">MessageConverter</code> to convert the Syslog message to a Spring Integration message.
The <code class="literal">DefaultMessageConverter</code> delegates to the <code class="literal">SyslogToMapTransformer</code>, creating a message with its payload being the <code class="literal">Map</code> of Syslog fields.
In addition, all fields except the message are also made available as headers in the message, prefixed with <code class="literal">syslog_</code>.
In this mode, only <a class="ulink" href="https://tools.ietf.org/html/rfc3164" target="_top">RFC 3164</a> (BSD) syslogs are supported.</p>
<p>Since <span class="emphasis"><em>version 4.1</em></span>, the <code class="literal">DefaultMessageConverter</code> has a property <code class="literal">asMap</code> (default <code class="literal">true</code>); when it is <code class="literal">false</code>, the converter will leave the message payload as the original complete syslog message, in a <code class="literal">byte[]</code>, while still setting the headers.</p>
<p>Since <span class="emphasis"><em>version 4.1.1</em></span>, RFC 5424 is also supported, using the <code class="literal">RFC5424MessageConverter</code>; in this case the fields are not copied as headers, unless <code class="literal">asMap</code> is set to <code class="literal">false</code>, in which case the original message is the payload and the decoded fields are headers.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>To use RFC 5424 with a TCP transport, additional configuration is required, to enable the different framing techniques described in RFC 6587.
The adapter needs a TCP connection factory configured with a <code class="literal">RFC6587SyslogDeserializer</code>.
By default, this deserializer will handle <code class="literal">octet counting</code> and <code class="literal">non-transparent framing</code>, using a linefeed (LF) to delimit syslog messages; it uses a <code class="literal">ByteArrayLfSerializer</code> when <code class="literal">octet counting</code> is not detected.
To use different <code class="literal">non-transparent</code> framing, you can provide it with some other deserializer.
While the deserializer can support both <code class="literal">octet counting</code> and <code class="literal">non-transparent framing</code>, only one form of the latter is supported.
If <code class="literal">asMap</code> is <code class="literal">false</code> on the converter, you must set the <code class="literal">retainOriginal</code> constructor argument in the <code class="literal">RFC6587SyslogDeserializer</code>.</p>
</td></tr></table></div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="syslog-inbound-examplers" href="#syslog-inbound-examplers"></a>30.2.1&nbsp;Example Configuration</h3></div></div></div>

<pre class="programlisting"><span class="hl-tag">&lt;int-syslog:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"syslogIn"</span> <span class="hl-attribute">port</span>=<span class="hl-value">"1514"</span><span class="hl-tag"> /&gt;</span></pre>
<p>A <code class="literal">UDP</code> adapter that sends messages to channel <code class="literal">syslogIn</code> (the adapter bean name is <code class="literal">syslogIn.adapter</code>).
The adapter listens on port <code class="literal">1514</code>.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-syslog:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"syslogIn"</span>
	<span class="hl-attribute">channel</span>=<span class="hl-value">"fromSyslog"</span> <span class="hl-attribute">port</span>=<span class="hl-value">"1514"</span><span class="hl-tag"> /&gt;</span></pre>
<p>A <code class="literal">UDP</code> adapter that sends message to channel <code class="literal">fromSyslog</code> (the adapter bean name is <code class="literal">syslogIn</code>).
The adapter listens on port <code class="literal">1514</code>.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-syslog:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"bar"</span> <span class="hl-attribute">protocol</span>=<span class="hl-value">"tcp"</span> <span class="hl-attribute">port</span>=<span class="hl-value">"1514"</span><span class="hl-tag"> /&gt;</span></pre>
<p>A <code class="literal">TCP</code> adapter that sends messages to channel <code class="literal">syslogIn</code> (the adapter bean name is <code class="literal">syslogIn.adapter</code>).
The adapter listens on port <code class="literal">1514</code>.</p>
<p>Note the addition of the <code class="literal">protocol</code> attribute.
This attribute can contain <code class="literal">udp</code> or <code class="literal">tcp</code>; it defaults to <code class="literal">udp</code>.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-syslog:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"udpSyslog"</span>
	<span class="hl-attribute">channel</span>=<span class="hl-value">"fromSyslog"</span>
	<span class="hl-attribute">auto-startup</span>=<span class="hl-value">"false"</span>
	<span class="hl-attribute">phase</span>=<span class="hl-value">"10000"</span>
	<span class="hl-attribute">converter</span>=<span class="hl-value">"converter"</span>
	<span class="hl-attribute">send-timeout</span>=<span class="hl-value">"1000"</span>
	<span class="hl-attribute">error-channel</span>=<span class="hl-value">"errors"</span><span class="hl-tag">&gt;</span>
		<span class="hl-tag">&lt;int-syslog:udp-attributes</span> <span class="hl-attribute">port</span>=<span class="hl-value">"1514"</span> <span class="hl-attribute">lookup-host</span>=<span class="hl-value">"false"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/int-syslog:inbound-channel-adapter&gt;</span></pre>
<p>A <code class="literal">UDP</code> adapter that sends messages to channel <code class="literal">fromSyslog</code>.
It also shows the <code class="literal">SmartLifecycle</code> attributes <code class="literal">auto-startup</code> and <code class="literal">phase</code>.
It has a reference to a custom <code class="literal">org.springframework.integration.syslog.MessageConverter</code> with id <code class="literal">converter</code> and an <code class="literal">error-channel</code>.
Also notice the <code class="literal">udp-attributes</code> child element.
You can set various UDP attributes here, as defined in <a class="xref" href="#ip-udp-ib-atts" title="Table&nbsp;31.2.&nbsp;UDP Inbound Channel Adapter Attributes">Table&nbsp;31.2, &#8220;UDP Inbound Channel Adapter Attributes&#8221;</a>.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>When using the <code class="literal">udp-attributes</code> element, the <code class="literal">port</code> attribute must be provided there rather than on the <code class="literal">inbound-channel-adapter</code> element itself.</p>
</td></tr></table></div>
<pre class="programlisting"><span class="hl-tag">&lt;int-syslog:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"TcpSyslog"</span>
	<span class="hl-attribute">protocol</span>=<span class="hl-value">"tcp"</span>
	<span class="hl-attribute">channel</span>=<span class="hl-value">"fromSyslog"</span>
	<span class="hl-attribute">connection-factory</span>=<span class="hl-value">"cf"</span><span class="hl-tag"> /&gt;</span>

<span class="hl-tag">&lt;int-ip:tcp-connection-factory</span> <span class="hl-attribute">id</span>=<span class="hl-value">"cf"</span> <span class="hl-attribute">type</span>=<span class="hl-value">"server"</span> <span class="hl-attribute">port</span>=<span class="hl-value">"1514"</span><span class="hl-tag"> /&gt;</span></pre>
<p>A <code class="literal">TCP</code> adapter that sends messages to channel <code class="literal">fromSyslog</code>.
It also shows how to reference an externally defined connection factory, which can be used for advanced configuration (socket keep alive etc).
For more information, see <a class="xref" href="#connection-factories" title="31.3&nbsp;TCP Connection Factories">Section&nbsp;31.3, &#8220;TCP Connection Factories&#8221;</a>.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The externally configured <code class="literal">connection-factory</code> must be of type <code class="literal">server</code> and, the port is defined there rather than on the <code class="literal">inbound-channel-adapter</code> element itself.</p>
</td></tr></table></div>
<pre class="programlisting"><span class="hl-tag">&lt;int-syslog:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"rfc5424Tcp"</span>
	<span class="hl-attribute">protocol</span>=<span class="hl-value">"tcp"</span>
	<span class="hl-attribute">channel</span>=<span class="hl-value">"fromSyslog"</span>
	<span class="hl-attribute">connection-factory</span>=<span class="hl-value">"cf"</span>
	<span class="hl-attribute">converter</span>=<span class="hl-value">"rfc5424"</span><span class="hl-tag"> /&gt;</span>

<span class="hl-tag">&lt;int-ip:tcp-connection-factory</span> <span class="hl-attribute">id</span>=<span class="hl-value">"cf"</span>
	<span class="hl-attribute">using-nio</span>=<span class="hl-value">"true"</span>
	<span class="hl-attribute">type</span>=<span class="hl-value">"server"</span>
	<span class="hl-attribute">port</span>=<span class="hl-value">"1514"</span>
	<span class="hl-attribute">deserializer</span>=<span class="hl-value">"rfc6587"</span><span class="hl-tag"> /&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"rfc5424"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.syslog.RFC5424MessageConverter"</span><span class="hl-tag"> /&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"rfc6587"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.syslog.inbound.RFC6587SyslogDeserializer"</span><span class="hl-tag"> /&gt;</span></pre>
<p>A <code class="literal">TCP</code> adapter that sends messages to channel <code class="literal">fromSyslog</code>.
It is configured to use the <code class="literal">RFC 5424</code> converter and is configured with a reference to an externally defined connection factory with the <code class="literal">RFC 6587</code> deserializer (required for RFC 5424).</p>
</div>
</div>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="ip" href="#ip"></a>31.&nbsp;TCP and UDP Support</h2></div></div></div>

<p>Spring Integration provides Channel Adapters for receiving and sending messages over internet protocols.
Both UDP (User Datagram Protocol) and TCP (Transmission Control Protocol) adapters are provided.
Each adapter provides for one-way communication over the underlying protocol.
In addition, simple inbound and outbound tcp gateways are provided.
These are used when two-way communication is needed.</p>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="ip-intro" href="#ip-intro"></a>31.1&nbsp;Introduction</h2></div></div></div>

<p>Two flavors each of UDP inbound and outbound channel adapters are provided <code class="literal">UnicastSendingMessageHandler</code> sends a datagram packet to a single destination.
<code class="literal">UnicastReceivingChannelAdapter</code> receives incoming datagram packets.
<code class="literal">MulticastSendingMessageHandler</code> sends (broadcasts) datagram packets to a multicast address.
<code class="literal">MulticastReceivingChannelAdapter</code> receives incoming datagram packets by joining to a multicast address.</p>
<p>TCP inbound and outbound channel adapters are provided <code class="literal">TcpSendingMessageHandler</code> sends messages over TCP.
<code class="literal">TcpReceivingChannelAdapter</code> receives messages over TCP.</p>
<p>An inbound TCP gateway is provided; this allows for simple request/response processing.
While the gateway can support any number of connections, each connection can only process serially.
The thread that reads from the socket waits for, and sends, the response before reading again.
If the connection factory is configured for single use connections, the connection is closed after the socket times out.</p>
<p>An outbound TCP gateway is provided; this allows for simple request/response processing.
If the associated connection factory is configured for single use connections, a new connection is immediately created for each new request.
Otherwise, if the connection is in use, the calling thread blocks on the connection until either a response is received or a timeout or I/O error occurs.</p>
<p>The TCP and UDP inbound channel adapters, and the TCP inbound gateway, support the "error-channel" attribute.
This provides the same basic functionality as described in <a class="xref" href="#gateway-proxy" title="8.4.1&nbsp;Enter the GatewayProxyFactoryBean">Section&nbsp;8.4.1, &#8220;Enter the GatewayProxyFactoryBean&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="udp-adapters" href="#udp-adapters"></a>31.2&nbsp;UDP Adapters</h2></div></div></div>

<pre class="programlisting"><span class="hl-tag">&lt;int-ip:udp-outbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"udpOut"</span>
    <span class="hl-attribute">host</span>=<span class="hl-value">"somehost"</span>
    <span class="hl-attribute">port</span>=<span class="hl-value">"11111"</span>
    <span class="hl-attribute">multicast</span>=<span class="hl-value">"false"</span>
    <span class="hl-attribute">channel</span>=<span class="hl-value">"exampleChannel"</span><span class="hl-tag">/&gt;</span></pre>
<p>A simple UDP outbound channel adapter.</p>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>When setting multicast to true, provide the multicast address in the host attribute.</p>
</td></tr></table></div>
<p>UDP is an efficient, but unreliable protocol.
Two attributes are added to improve reliability.
When check-length is set to true, the adapter precedes the message data with a length field (4 bytes in network byte order).
This enables the receiving side to verify the length of the packet received.
If a receiving system uses a buffer that is too short the contain the packet, the packet can be truncated.
The length header provides a mechanism to detect this.</p>
<p>Starting with <span class="emphasis"><em>version 4.3</em></span>, the <code class="literal">port</code> can be set to <code class="literal">0</code>, in which case the Operating System chooses the port; the
chosen port can be discovered by invoking <code class="literal">getPort()</code> after the adapter is started and <code class="literal">isListening()</code> returns <code class="literal">true</code>.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-ip:udp-outbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"udpOut"</span>
    <span class="hl-attribute">host</span>=<span class="hl-value">"somehost"</span>
    <span class="hl-attribute">port</span>=<span class="hl-value">"11111"</span>
    <span class="hl-attribute">multicast</span>=<span class="hl-value">"false"</span>
    <span class="hl-attribute">check-length</span>=<span class="hl-value">"true"</span>
    <span class="hl-attribute">channel</span>=<span class="hl-value">"exampleChannel"</span><span class="hl-tag">/&gt;</span></pre>
<p>An outbound channel adapter that adds length checking to the datagram packets.</p>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>The recipient of the packet must also be configured to expect a length to precede the actual data.
For a Spring Integration UDP inbound channel adapter, set its <code class="literal">check-length</code> attribute.</p>
</td></tr></table></div>
<p>The second reliability improvement allows an application-level acknowledgment protocol to be used.
The receiver must send an acknowledgment to the sender within a specified time.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-ip:udp-outbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"udpOut"</span>
    <span class="hl-attribute">host</span>=<span class="hl-value">"somehost"</span>
    <span class="hl-attribute">port</span>=<span class="hl-value">"11111"</span>
    <span class="hl-attribute">multicast</span>=<span class="hl-value">"false"</span>
    <span class="hl-attribute">check-length</span>=<span class="hl-value">"true"</span>
    <span class="hl-attribute">acknowledge</span>=<span class="hl-value">"true"</span>
    <span class="hl-attribute">ack-host</span>=<span class="hl-value">"thishost"</span>
    <span class="hl-attribute">ack-port</span>=<span class="hl-value">"22222"</span>
    <span class="hl-attribute">ack-timeout</span>=<span class="hl-value">"10000"</span>
    <span class="hl-attribute">channel</span>=<span class="hl-value">"exampleChannel"</span><span class="hl-tag">/&gt;</span></pre>
<p>An outbound channel adapter that adds length checking to the datagram packets and waits for an acknowledgment.</p>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>Setting acknowledge to true implies the recipient of the packet can interpret the header added to the packet containing acknowledgment data (host and port).
Most likely, the recipient will be a Spring Integration inbound channel adapter.</p>
</td></tr></table></div>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>When multicast is true, an additional attribute min-acks-for-success specifies how many acknowledgments must be received within the ack-timeout.</p>
</td></tr></table></div>
<p>For even more reliable networking, TCP can be used.</p>
<p>Starting with <span class="emphasis"><em>version 4.3</em></span>, the <code class="literal">ackPort</code> can be set to <code class="literal">0</code>, in which case the Operating System chooses the port.</p>
<p>Also starting with <span class="emphasis"><em>version 4.3</em></span>, the <code class="literal">destination-expression</code> and <code class="literal">socket-expression</code> options are available
for the <code class="literal">&lt;int-ip:udp-outbound-channel-adapter&gt;</code> (<code class="literal">UnicastSendingMessageHandler</code>).</p>
<p>The <code class="literal">destination-expression</code> can be used as a runtime alternative to the hardcoded <code class="literal">host</code>/<code class="literal">port</code> pair to determine
the destination address for the outgoing datagram packet against <code class="literal">requestMessage</code> as a root object for evaluation context.
The expression must evaluate to <code class="literal">URI</code>, or <code class="literal">String</code> in the URI style (see <a class="ulink" href="http://www.ietf.org/rfc/rfc2396.txt" target="_top">RFC-2396</a>)
or <code class="literal">SocketAddress</code>.
The new <code class="literal">IpHeaders.PACKET_ADDRESS</code> header can be used for this expression as well.
In the Framework this header is populated by the <code class="literal">DatagramPacketMessageMapper</code>, when we receive datagrams in the
<code class="literal">UnicastReceivingChannelAdapter</code> and convert them to messages.
The header value is exactly the result of <code class="literal">DatagramPacket.getSocketAddress()</code> of incoming datagram.</p>
<p>With the <code class="literal">socket-expression</code> help the Outbound Channel Adapter can use e.g. Inbound Channel Adapter socket
to send datagrams through same port which they were received.
It&#8217;s useful in a scenario when our application works as a UDP server and clients operate behind the NAT.
This expression must evaluate to the <code class="literal">DatagramSocket</code>.
The <code class="literal">requestMessage</code> is used as a root object for evaluation context.
The <code class="literal">socket-expression</code> parameter cannot be used with parameters like <code class="literal">multicast</code> and <code class="literal">acknowledge</code>.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-ip:udp-inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"inbound"</span> <span class="hl-attribute">port</span>=<span class="hl-value">"0"</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"in"</span><span class="hl-tag"> /&gt;</span>

<span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"in"</span><span class="hl-tag"> /&gt;</span>

<span class="hl-tag">&lt;int:transformer</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"new String(payload).toUpperCase()"</span>
                       <span class="hl-attribute">input-channel</span>=<span class="hl-value">"in"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"out"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"out"</span><span class="hl-tag"> /&gt;</span>

<span class="hl-tag">&lt;int-ip:udp-outbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"outbound"</span>
                        <span class="hl-attribute">socket-expression</span>=<span class="hl-value">"@inbound.socket"</span>
                        <span class="hl-attribute">destination-expression</span>=<span class="hl-value">"headers['ip_packetAddress']"</span>
                        <span class="hl-attribute">channel</span>=<span class="hl-value">"out"</span><span class="hl-tag"> /&gt;</span></pre>
<pre class="programlisting"><span class="hl-tag">&lt;int-ip:udp-inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"udpReceiver"</span>
    <span class="hl-attribute">channel</span>=<span class="hl-value">"udpOutChannel"</span>
    <span class="hl-attribute">port</span>=<span class="hl-value">"11111"</span>
    <span class="hl-attribute">receive-buffer-size</span>=<span class="hl-value">"500"</span>
    <span class="hl-attribute">multicast</span>=<span class="hl-value">"false"</span>
    <span class="hl-attribute">check-length</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span></pre>
<p>A basic unicast inbound udp channel adapter.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-ip:udp-inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"udpReceiver"</span>
    <span class="hl-attribute">channel</span>=<span class="hl-value">"udpOutChannel"</span>
    <span class="hl-attribute">port</span>=<span class="hl-value">"11111"</span>
    <span class="hl-attribute">receive-buffer-size</span>=<span class="hl-value">"500"</span>
    <span class="hl-attribute">multicast</span>=<span class="hl-value">"true"</span>
    <span class="hl-attribute">multicast-address</span>=<span class="hl-value">"225.6.7.8"</span>
    <span class="hl-attribute">check-length</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span></pre>
<p>A basic multicast inbound udp channel adapter.</p>
<p>By default, reverse DNS lookups are done on inbound packets to convert IP addresses to hostnames for use in message headers.
In environments where DNS is not configured, this can cause delays.
This default behavior can be overridden by setting the <code class="literal">lookup-host</code> attribute to "false".</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="connection-factories" href="#connection-factories"></a>31.3&nbsp;TCP Connection Factories</h2></div></div></div>

<p>For TCP, the configuration of the underlying connection is provided using a Connection Factory.
Two types of connection factory are provided; a client connection factory and a server connection factory.
Client connection factories are used to establish outgoing connections; Server connection factories listen for incoming connections.</p>
<p>A client connection factory is used by an outbound channel adapter but a reference to a client connection factory can also be provided to an inbound channel adapter and that adapter will receive any incoming messages received on connections created by the outbound adapter.</p>
<p>A server connection factory is used by an inbound channel adapter or gateway (in fact the connection factory will not function without one).
A reference to a server connection factory can also be provided to an outbound adapter; that adapter can then be used to send replies to incoming messages to the same connection.</p>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>Reply messages will only be routed to the connection if the reply contains the header <code class="literal">ip_connectionId</code> that was inserted into the original message by the connection factory.</p>
</td></tr></table></div>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>This is the extent of message correlation performed when sharing connection factories between inbound and outbound adapters.
Such sharing allows for asynchronous two-way communication over TCP.
By default, only payload information is transferred using TCP; therefore any message correlation must be performed by downstream components such as aggregators or other endpoints.
Support for transferring selected headers was introduced in version 3.0.
For more information refer to <a class="xref" href="#ip-correlation" title="31.8&nbsp;TCP Message Correlation">Section&nbsp;31.8, &#8220;TCP Message Correlation&#8221;</a>.</p>
</td></tr></table></div>
<p>A maximum of one adapter of each type may be given a reference to a connection factory.</p>
<p>Connection factories using <code class="literal">java.net.Socket</code> and <code class="literal">java.nio.channel.SocketChannel</code> are provided.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-ip:tcp-connection-factory</span> <span class="hl-attribute">id</span>=<span class="hl-value">"server"</span>
    <span class="hl-attribute">type</span>=<span class="hl-value">"server"</span>
    <span class="hl-attribute">port</span>=<span class="hl-value">"1234"</span><span class="hl-tag">/&gt;</span></pre>
<p>A simple server connection factory that uses <code class="literal">java.net.Socket</code> connections.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-ip:tcp-connection-factory</span> <span class="hl-attribute">id</span>=<span class="hl-value">"server"</span>
    <span class="hl-attribute">type</span>=<span class="hl-value">"server"</span>
    <span class="hl-attribute">port</span>=<span class="hl-value">"1234"</span>
    <span class="hl-attribute">using-nio</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span></pre>
<p>A simple server connection factory that uses <code class="literal">java.nio.channel.SocketChannel</code> connections.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Starting with Spring Integration <span class="emphasis"><em>version 4.2</em></span>, if the server is configured to listen on a random port (0),
the actual port chosen by the OS can be obtained using <code class="literal">getPort()</code>.
Also, <code class="literal">getServerSocketAddress()</code> is available to get the complete <code class="literal">SocketAddress</code>.
See the javadocs for the <code class="literal">TcpServerConnectionFactory</code> interface for more information.</p>
</td></tr></table></div>
<pre class="programlisting"><span class="hl-tag">&lt;int-ip:tcp-connection-factory</span> <span class="hl-attribute">id</span>=<span class="hl-value">"client"</span>
    <span class="hl-attribute">type</span>=<span class="hl-value">"client"</span>
    <span class="hl-attribute">host</span>=<span class="hl-value">"localhost"</span>
    <span class="hl-attribute">port</span>=<span class="hl-value">"1234"</span>
    <span class="hl-attribute">single-use</span>=<span class="hl-value">"true"</span>
    <span class="hl-attribute">so-timeout</span>=<span class="hl-value">"10000"</span><span class="hl-tag">/&gt;</span></pre>
<p>A client connection factory that uses <code class="literal">java.net.Socket</code> connections and creates a new connection for each message.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-ip:tcp-connection-factory</span> <span class="hl-attribute">id</span>=<span class="hl-value">"client"</span>
    <span class="hl-attribute">type</span>=<span class="hl-value">"client"</span>
    <span class="hl-attribute">host</span>=<span class="hl-value">"localhost"</span>
    <span class="hl-attribute">port</span>=<span class="hl-value">"1234"</span>
    <span class="hl-attribute">single-use</span>=<span class="hl-value">"true"</span>
    <span class="hl-attribute">so-timeout</span>=<span class="hl-value">"10000"</span>
    <span class="hl-attribute">using-nio</span>=<span class="hl-value">true</span><span class="hl-tag">/&gt;</span></pre>
<p>A client connection factory that uses <code class="literal">java.nio.channel.Socket</code> connections and creates a new connection for each message.</p>
<p>TCP is a streaming protocol; this means that some structure has to be provided to data transported over TCP, so the receiver can demarcate the data into discrete messages.
Connection factories are configured to use (de)serializers to convert between the message payload and the bits that are sent over TCP.
This is accomplished by providing a deserializer and serializer for inbound and outbound messages respectively.
A number of standard (de)serializers are provided.</p>
<p>The <code class="literal">ByteArrayCrlfSerializer</code><sup>*</sup>, converts a byte array to a stream of bytes followed by carriage return and linefeed characters (\r\n).
This is the default (de)serializer and can be used with telnet as a client, for example.</p>
<p>The <code class="literal">ByteArraySingleTerminatorSerializer</code><sup>*</sup>, converts a byte array to a stream of bytes followed by a single termination character (default 0x00).</p>
<p>The <code class="literal">ByteArrayLfSerializer</code><sup>*</sup>, converts a byte array to a stream of bytes followed by a single linefeed character (0x0a).</p>
<p>The <code class="literal">ByteArrayStxEtxSerializer</code><sup>*</sup>, converts a byte array to a stream of bytes preceded by an STX (0x02) and followed by an ETX (0x03).</p>
<p>The <code class="literal">ByteArrayLengthHeaderSerializer</code>, converts a byte array to a stream of bytes preceded by a binary length in network byte order (big endian).
This a very efficient deserializer because it does not have to parse every byte looking for a termination character sequence.
It can also be used for payloads containing binary data; the above serializers only support text in the payload.
The default size of the length header is 4 bytes (Integer), allowing for messages up to (2^31 - 1) bytes.
However, the length header can be a single byte (unsigned) for messages up to 255 bytes, or an unsigned short (2 bytes) for messages up to (2^16 - 1) bytes.
If you need any other format for the header, you can subclass this class and provide implementations for the readHeader and writeHeader methods.
The absolute maximum data size supported is (2^31 - 1) bytes.</p>
<p>The <code class="literal">ByteArrayRawSerializer</code><sup>*</sup>, converts a byte array to a stream of bytes and adds no additional message demarcation data; with this (de)serializer, the end of a message is indicated by the client closing the socket in an orderly fashion.
When using this serializer, message reception will hang until the client closes the socket, or a timeout occurs; a timeout will NOT result in a message.
When this serializer is being used, and the client is a Spring Integration application, the client must use a connection factory that is configured with single-use=true - this causes the adapter to close the socket after sending the message; the serializer will not, itself, close the connection.
This serializer should only be used with connection factories used by channel adapters (not gateways), and the connection factories should be used by either an inbound or outbound adapter, and not both.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Before version 4.2.2, when using NIO, this serializer treated a timeout (during read) as an end of file and the
data read so far was emitted as a message.
This is unreliable and should not be used to delimit messages; it now treats such conditions as an exception.
In the unlikely event you are using it this way, the previous behavior can be restored by setting the
<code class="literal">treatTimeoutAsEndOfMessage</code> constructor argument to <code class="literal">true</code>.</p>
</td></tr></table></div>
<p>Each of these is a subclass of <code class="literal">AbstractByteArraySerializer</code> which implements both <code class="literal">org.springframework.core.serializer.Serializer</code> and <code class="literal">org.springframework.core.serializer.Deserializer</code>.
For backwards compatibility, connections using any subclass of <code class="literal">AbstractByteArraySerializer</code> for serialization will also accept a String which will be converted to a byte array first.
Each of these (de)serializers converts an input stream containing the corresponding format to a byte array payload.</p>
<p>To avoid memory exhaustion due to a badly behaved client (one that does not adhere to the protocol of the configured serializer), these serializers impose a maximum message size.
If the size is exceeded by an incoming message, an exception will be thrown.
The default maximum message size is 2048 bytes, and can be increased by setting the <code class="literal">maxMessageSize</code> property.
If you are using the default (de)serializer and wish to increase the maximum message size, you must declare it as an explicit bean with the property set and configure the connection factory to use that bean.</p>
<p>The classes marked with <sup>*</sup> above use an intermediate buffer and copy the decoded data to a final buffer of the correct
size.
Starting with <span class="emphasis"><em>version 4.3</em></span>, these can be configured with a <code class="literal">poolSize</code> property to allow these raw buffers to be reused
instead of being allocated and discarded for each message, which is the default behavior.
Setting the property to a negative value will create a pool that has no bounds.
If the pool is bounded, you can also set the <code class="literal">poolWaitTimeout</code> property (milliseconds) after which an exception is
thrown if no buffer becomes available; it defaults to infinity.
Such an exception will cause the socket to be closed.</p>
<p>If you wish to use the same mechanism in custom deserializers, subclass <code class="literal">AbstractPooledBufferByteArraySerializer</code>
instead of its super class <code class="literal">AbstractByteArraySerializer</code>, and implement <code class="literal">doDeserialize()</code> instead of <code class="literal">deserialize()</code>.
The buffer will be returned to the pool automatically.
<code class="literal">AbstractPooledBufferByteArraySerializer</code> also provides a convenient utility method <code class="literal">copyToSizedArray()</code>.</p>
<p>The <code class="literal">MapJsonSerializer</code> uses a Jackson <code class="literal">ObjectMapper</code> to convert between a <code class="literal">Map</code> and JSON.
This can be used in conjunction with a <code class="literal">MessageConvertingTcpMessageMapper</code> and a <code class="literal">MapMessageConverter</code> to transfer selected headers and the payload in a JSON format.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The Jackson <code class="literal">ObjectMapper</code> cannot demarcate messages in the stream.
Therefore, the <code class="literal">MapJsonSerializer</code> needs to delegate to another (de)serializer to handle message demarcation.
By default, a <code class="literal">ByteArrayLfSerializer</code> is used, resulting in messages with the format <code class="literal">&lt;json&gt;&lt;LF&gt;</code> on the wire, but you can configure it to use others instead.</p>
</td></tr></table></div>
<p>The final standard serializer is <code class="literal">org.springframework.core.serializer.DefaultSerializer</code> which can be used to convert Serializable objects using java serialization.<code class="literal">org.springframework.core.serializer.DefaultDeserializer</code> is provided for inbound deserialization of streams containing Serializable objects.</p>
<p>To implement a custom (de)serializer pair, implement the <code class="literal">org.springframework.core.serializer.Deserializer</code> and <code class="literal">org.springframework.core.serializer.Serializer</code> interfaces.</p>
<p>If you do not wish to use the default (de)serializer (<code class="literal">ByteArrayCrLfSerializer</code>), you must supply <code class="literal">serializer</code> and <code class="literal">deserializer</code> attributes on the connection factory (example below).</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"javaSerializer"</span>
      <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.core.serializer.DefaultSerializer"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"javaDeserializer"</span>
      <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.core.serializer.DefaultDeserializer"</span><span class="hl-tag"> /&gt;</span>

<span class="hl-tag">&lt;int-ip:tcp-connection-factory</span> <span class="hl-attribute">id</span>=<span class="hl-value">"server"</span>
    <span class="hl-attribute">type</span>=<span class="hl-value">"server"</span>
    <span class="hl-attribute">port</span>=<span class="hl-value">"1234"</span>
    <span class="hl-attribute">deserializer</span>=<span class="hl-value">"javaDeserializer"</span>
    <span class="hl-attribute">serializer</span>=<span class="hl-value">"javaSerializer"</span><span class="hl-tag">/&gt;</span></pre>
<p>A server connection factory that uses <code class="literal">java.net.Socket</code> connections and uses Java serialization on the wire.</p>
<p>For full details of the attributes available on connection factories, see the reference at the end of this section.</p>
<p>By default, reverse DNS lookups are done on inbound packets to convert IP addresses to hostnames for use in message headers.
In environments where DNS is not configured, this can cause connection delays.
This default behavior can be overridden by setting the <code class="literal">lookup-host</code> attribute to "false".</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>It is possible to modify the creation of and/or attributes of sockets - see <a class="xref" href="#ssl-tls" title="31.10&nbsp;SSL/TLS Support">Section&nbsp;31.10, &#8220;SSL/TLS Support&#8221;</a>.
As is noted there, such modifications are possible whether or not SSL is being used.</p>
</td></tr></table></div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="caching-cf" href="#caching-cf"></a>31.3.1&nbsp;TCP Caching Client Connection Factory</h3></div></div></div>

<p>As noted above, TCP sockets can be <span class="emphasis"><em>single-use</em></span> (one request/response) or shared.
Shared sockets do not perform well with outbound gateways, in high-volume environments, because the socket can only process one request/response at a time.</p>
<p>To improve performance, users could use collaborating channel adapters instead of gateways, but that requires application-level message correlation.
See <a class="xref" href="#ip-correlation" title="31.8&nbsp;TCP Message Correlation">Section&nbsp;31.8, &#8220;TCP Message Correlation&#8221;</a> for more information.</p>
<p>Spring Integration 2.2 introduced a caching client connection factory, where a pool of shared sockets is used, allowing a gateway to process multiple concurrent requests with a pool of shared connections.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="failover-cf" href="#failover-cf"></a>31.3.2&nbsp;TCP Failover Client Connection Factory</h3></div></div></div>

<p>It is now possible to configure a TCP connection factory that supports failover to one or more other servers.
When sending a message, the factory will iterate over all its configured factories until either the message can be sent, or no connection can be found.
Initially, the first factory in the configured list is used; if a connection subsequently fails the next factory will become the current factory.</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"failCF"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.ip.tcp.connection.FailoverClientConnectionFactory"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg&gt;</span>
        <span class="hl-tag">&lt;list&gt;</span>
            <span class="hl-tag">&lt;ref</span> <span class="hl-attribute">bean</span>=<span class="hl-value">"clientFactory1"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;ref</span> <span class="hl-attribute">bean</span>=<span class="hl-value">"clientFactory2"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/list&gt;</span>
    <span class="hl-tag">&lt;/constructor-arg&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>When using the failover connection factory, the singleUse property must be consistent between the factory itself and the list of factories it is configured to use.</p>
</td></tr></table></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="ip-interceptors" href="#ip-interceptors"></a>31.4&nbsp;TCP Connection Interceptors</h2></div></div></div>

<p>Connection factories can be configured with a reference to a <code class="literal">TcpConnectionInterceptorFactoryChain</code>.
Interceptors can be used to add behavior to connections, such as negotiation, security, and other setup.
No interceptors are currently provided by the framework but, for an example, see the <code class="literal">InterceptedSharedConnectionTests</code> in the source repository.</p>
<p>The <code class="literal">HelloWorldInterceptor</code> used in the test case works as follows:</p>
<p>When configured with a client connection factory, when the first message is sent over a connection that is intercepted, the interceptor sends <span class="emphasis"><em>Hello</em></span> over the connection, and expects to receive <span class="emphasis"><em>world!</em></span>.
When that occurs, the negotiation is complete and the original message is sent; further messages that use the same connection are sent without any additional negotiation.</p>
<p>When configured with a server connection factory, the interceptor requires the first message to be <span class="emphasis"><em>Hello</em></span> and, if it is, returns <span class="emphasis"><em>world!</em></span>.
Otherwise it throws an exception causing the connection to be closed.</p>
<p>All <code class="literal">TcpConnection</code> methods are intercepted.
Interceptor instances are created for each connection by an interceptor factory.
If an interceptor is stateful, the factory should create a new instance for each connection; if there is no state, the same interceptor can wrap each connection.
Interceptor factories are added to the configuration of an interceptor factory chain, which is provided to a connection factory using the <code class="literal">interceptor-factory</code> attribute.
Interceptors must extend <code class="literal">TcpConnectionInterceptorSupport</code>; factories must implement the <code class="literal">TcpConnectionInterceptorFactory</code> interface.
<code class="literal">TcpConnectionInterceptorSupport</code> is provided with passthrough methods; by extending this class, you only need to implement those methods you wish to intercept.</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"helloWorldInterceptorFactory"</span>
    <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.ip.tcp.connection.TcpConnectionInterceptorFactoryChain"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"interceptors"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;array&gt;</span>
            <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.ip.tcp.connection.HelloWorldInterceptorFactory"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/array&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;int-ip:tcp-connection-factory</span> <span class="hl-attribute">id</span>=<span class="hl-value">"server"</span>
    <span class="hl-attribute">type</span>=<span class="hl-value">"server"</span>
    <span class="hl-attribute">port</span>=<span class="hl-value">"12345"</span>
    <span class="hl-attribute">using-nio</span>=<span class="hl-value">"true"</span>
    <span class="hl-attribute">single-use</span>=<span class="hl-value">"true"</span>
    <span class="hl-attribute">interceptor-factory-chain</span>=<span class="hl-value">"helloWorldInterceptorFactory"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int-ip:tcp-connection-factory</span> <span class="hl-attribute">id</span>=<span class="hl-value">"client"</span>
    <span class="hl-attribute">type</span>=<span class="hl-value">"client"</span>
    <span class="hl-attribute">host</span>=<span class="hl-value">"localhost"</span>
    <span class="hl-attribute">port</span>=<span class="hl-value">"12345"</span>
    <span class="hl-attribute">single-use</span>=<span class="hl-value">"true"</span>
    <span class="hl-attribute">so-timeout</span>=<span class="hl-value">"100000"</span>
    <span class="hl-attribute">using-nio</span>=<span class="hl-value">"true"</span>
    <span class="hl-attribute">interceptor-factory-chain</span>=<span class="hl-value">"helloWorldInterceptorFactory"</span><span class="hl-tag">/&gt;</span></pre>
<p>Configuring a connection interceptor factory chain.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="tcp-events" href="#tcp-events"></a>31.5&nbsp;TCP Connection Events</h2></div></div></div>

<p>Beginning with version 3.0, changes to <code class="literal">TcpConnection</code> s are reported by <code class="literal">TcpConnectionEvent</code> s.
<code class="literal">TcpConnectionEvent</code> is a subclass of <code class="literal">ApplicationEvent</code> and thus can be received by any <code class="literal">ApplicationListener</code> defined in the <code class="literal">ApplicationContext</code>.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The following is deprecated as of <span class="emphasis"><em>version 4.2</em></span>; use the generic Event Inbound Channel Adapter instead.
See <a class="xref" href="#appevent-inbound" title="12.1&nbsp;Receiving Spring Application Events">Section&nbsp;12.1, &#8220;Receiving Spring Application Events&#8221;</a>.</p>
<p>For convenience, a <code class="literal">&lt;int-ip:tcp-connection-event-inbound-channel-adapter/&gt;</code> is provided.
This adapter will receive all <code class="literal">TcpConnectionEvent</code> s (by default), and send them to its <code class="literal">channel</code>.
The adapter accepts an <code class="literal">event-type</code> attribute, which is a list of class names for events that should be sent.
This can be used if an application subclasses <code class="literal">TcpConnectionEvent</code> for some reason, and wishes to only receive those events.
Omitting this attribute will mean that all <code class="literal">TcpConnectionEvent</code> s will be sent.
You can also use this to limit which <code class="literal">TcpConnectionEvent</code> s you are interested in ( <code class="literal">TcpConnectionOpenEvent</code>, <code class="literal">TcpConnectionCloseEvent</code>, or <code class="literal">TcpConnectionExceptionEvent</code>).</p>
</td></tr></table></div>
<p><code class="literal">TcpConnectionEvents</code> have the following properties:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">connectionId</code> - the connection identifier which can be used in a message header to send data to the connection
</li><li class="listitem">
<code class="literal">connectionFactoryName</code> - the bean name of the connection factory the connection belongs to
</li><li class="listitem">
<code class="literal">throwable</code> - the <code class="literal">Throwable</code> (for <code class="literal">TcpConnectionExceptionEvent</code> events only)
</li><li class="listitem">
<code class="literal">source</code> - the <code class="literal">TcpConnection</code>; this can be used, for example, to determine the remote IP Address with <code class="literal">getHostAddress()</code> (cast required)
</li></ul></div>
<p>In addition, since <span class="emphasis"><em>version 4.0</em></span> the standard deserializers discussed in <a class="xref" href="#connection-factories" title="31.3&nbsp;TCP Connection Factories">Section&nbsp;31.3, &#8220;TCP Connection Factories&#8221;</a> now emit <code class="literal">TcpDeserializationExceptionEvent</code> s when problems are encountered decoding the data stream.
These events contain the exception, the buffer that was in the process of being built, and an offset into the buffer (if available) at the point the exception occurred.
Applications can use a normal <code class="literal">ApplicationListener</code>, or see <a class="xref" href="#appevent-inbound" title="12.1&nbsp;Receiving Spring Application Events">Section&nbsp;12.1, &#8220;Receiving Spring Application Events&#8221;</a>, to capture these events, allowing analysis of the problem.</p>
<p>Starting with <span class="emphasis"><em>versions 4.0.7, 4.1.3</em></span>, <code class="literal">TcpConnectionServerExceptionEvent</code> s are published whenever an unexpected exception occurs on a server socket (such as a <code class="literal">BindException</code> when the server socket is in use).
These events have a reference to the connection factory and the cause.</p>
<p>Starting with <span class="emphasis"><em>version 4.2</em></span>, <code class="literal">TcpConnectionFailedCorrelationEvent</code> s are published whenever an endpoint (inbound gateway or
collaborating outbound channel adapter) receives a message that cannot be routed to a connection because the
<code class="literal">ip_connectionId</code> header is invalid.
Outbound gateways also publish this event when a late reply is received (the sender thread has timed out).
The event contains the connection id as well as an exception in the <code class="literal">cause</code> property that contains the failed message.</p>
<p>Starting with <span class="emphasis"><em>version 4.3</em></span>, a <code class="literal">TcpConnectionServerListeningEvent</code> is emitted when a server connection factory is started.
This is useful when the factory is configured to listen on port 0, meaning that the operating system chooses the port.
It can also be used instead of polling <code class="literal">isListening()</code>, if you need to wait before starting some other process that will
connect to the socket.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>To avoid delaying the listening thread from accepting connections, the event is published on a separate
thread.</p>
</td></tr></table></div>
<p>Starting with <span class="emphasis"><em>version 4.3.2</em></span>, a <code class="literal">TcpConnectionFailedEvent</code> is emitted whenever a client connection can&#8217;t be created.
The source of the event is the connection factory which can be used to determine the host and port to which the connection could not be established.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="tcp-adapters" href="#tcp-adapters"></a>31.6&nbsp;TCP Adapters</h2></div></div></div>

<p>TCP inbound and outbound channel adapters that utilize the above connection factories are provided.
These adapters have attributes <code class="literal">connection-factory</code> and <code class="literal">channel</code>.
The channel attribute specifies the channel on which messages arrive at an outbound adapter and on which messages are placed by an inbound adapter.
The connection-factory attribute indicates which connection factory is to be used to manage connections for the adapter.
While both inbound and outbound adapters can share a connection factory, server connection factories are always <span class="emphasis"><em>owned</em></span> by an inbound adapter; client connection factories are always <span class="emphasis"><em>owned</em></span> by an outbound adapter.
One, and only one, adapter of each type may get a reference to a connection factory.</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"javaSerializer"</span>
      <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.core.serializer.DefaultSerializer"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"javaDeserializer"</span>
      <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.core.serializer.DefaultDeserializer"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int-ip:tcp-connection-factory</span> <span class="hl-attribute">id</span>=<span class="hl-value">"server"</span>
    <span class="hl-attribute">type</span>=<span class="hl-value">"server"</span>
    <span class="hl-attribute">port</span>=<span class="hl-value">"1234"</span>
    <span class="hl-attribute">deserializer</span>=<span class="hl-value">"javaDeserializer"</span>
    <span class="hl-attribute">serializer</span>=<span class="hl-value">"javaSerializer"</span>
    <span class="hl-attribute">using-nio</span>=<span class="hl-value">"true"</span>
    <span class="hl-attribute">single-use</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int-ip:tcp-connection-factory</span> <span class="hl-attribute">id</span>=<span class="hl-value">"client"</span>
    <span class="hl-attribute">type</span>=<span class="hl-value">"client"</span>
    <span class="hl-attribute">host</span>=<span class="hl-value">"localhost"</span>
    <span class="hl-attribute">port</span>=<span class="hl-value">"#{server.port}"</span>
    <span class="hl-attribute">single-use</span>=<span class="hl-value">"true"</span>
    <span class="hl-attribute">so-timeout</span>=<span class="hl-value">"10000"</span>
    <span class="hl-attribute">deserializer</span>=<span class="hl-value">"javaDeserializer"</span>
    <span class="hl-attribute">serializer</span>=<span class="hl-value">"javaSerializer"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"input"</span><span class="hl-tag"> /&gt;</span>

<span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"replies"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:queue/&gt;</span>
<span class="hl-tag">&lt;/int:channel&gt;</span>

<span class="hl-tag">&lt;int-ip:tcp-outbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"outboundClient"</span>
    <span class="hl-attribute">channel</span>=<span class="hl-value">"input"</span>
    <span class="hl-attribute">connection-factory</span>=<span class="hl-value">"client"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int-ip:tcp-inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"inboundClient"</span>
    <span class="hl-attribute">channel</span>=<span class="hl-value">"replies"</span>
    <span class="hl-attribute">connection-factory</span>=<span class="hl-value">"client"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int-ip:tcp-inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"inboundServer"</span>
    <span class="hl-attribute">channel</span>=<span class="hl-value">"loop"</span>
    <span class="hl-attribute">connection-factory</span>=<span class="hl-value">"server"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int-ip:tcp-outbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"outboundServer"</span>
    <span class="hl-attribute">channel</span>=<span class="hl-value">"loop"</span>
    <span class="hl-attribute">connection-factory</span>=<span class="hl-value">"server"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"loop"</span><span class="hl-tag">/&gt;</span></pre>
<p>In this configuration, messages arriving in channel <span class="emphasis"><em>input</em></span> are serialized over connections created by <span class="emphasis"><em>client</em></span> received at the server and placed on channel <span class="emphasis"><em>loop</em></span>.
Since <span class="emphasis"><em>loop</em></span> is the input channel for <span class="emphasis"><em>outboundServer</em></span> the message is simply looped back over the same connection and received by <span class="emphasis"><em>inboundClient</em></span> and deposited in channel <span class="emphasis"><em>replies</em></span>.
Java serialization is used on the wire.</p>
<p>Normally, inbound adapters use a type="server" connection factory, which listens for incoming connection requests.
In some cases, it is desirable to establish the connection in reverse, whereby the inbound adapter connects to an external server and then waits for inbound messages on that connection.</p>
<p>This topology is supported by using <span class="emphasis"><em>client-mode="true"</em></span> on the inbound adapter.
In this case, the connection factory must be of type <span class="emphasis"><em>client</em></span> and must have <span class="emphasis"><em>single-use</em></span> set to false.</p>
<p>Two additional attributes are used to support this mechanism: <span class="emphasis"><em>retry-interval</em></span> specifies (in milliseconds) how often the framework will attempt to reconnect after a connection failure.
<span class="emphasis"><em>scheduler</em></span> is used to supply a <code class="literal">TaskScheduler</code> used to schedule the connection attempts, and to test that the connection is still active.</p>
<p>For an outbound adapter, the connection is normally established when the first message is sent.
<span class="emphasis"><em>client-mode="true"</em></span> on an outbound adapter will cause the connection to be established when the adapter is started.
Adapters are automatically started by default.
Again, the connection factory must be of type client and have <span class="emphasis"><em>single-use</em></span> set to false and <span class="emphasis"><em>retry-interval</em></span> and <span class="emphasis"><em>scheduler</em></span> are also supported.
If a connection fails, it will be re-established either by the scheduler or when the next message is sent.</p>
<p>For both inbound and outbound, if the adapter is started, you may force the adapter to establish a connection by sending a &lt;control-bus /&gt; command: <code class="literal">@adapter_id.retryConnection()</code> and examine the current state with <code class="literal">@adapter_id.isClientModeConnected()</code>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="tcp-gateways" href="#tcp-gateways"></a>31.7&nbsp;TCP Gateways</h2></div></div></div>

<p>The inbound TCP gateway <code class="literal">TcpInboundGateway</code> and outbound TCP gateway <code class="literal">TcpOutboundGateway</code> use a server and client connection factory respectively.
Each connection can process a single request/response at a time.</p>
<p>The inbound gateway, after constructing a message with the incoming payload and sending it to the requestChannel, waits for a response and sends the payload from the response message by writing it to the connection.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>For the inbound gateway, care must be taken to retain, or populate, the <span class="emphasis"><em>ip_connectionId</em></span> header because it is used to correlate the message to a connection.
Messages that originate at the gateway will automatically have the header set.
If the reply is constructed as a new message, you will need to set the header.
The header value can be captured from the incoming message.</p>
</td></tr></table></div>
<p>As with inbound adapters, inbound gateways normally use a type="server" connection factory, which listens for incoming connection requests.
In some cases, it is desirable to establish the connection in reverse, whereby the inbound gateway connects to an external server and then waits for, and replies to, inbound messages on that connection.</p>
<p>This topology is supported by using <span class="emphasis"><em>client-mode="true"</em></span> on the inbound gateway.
In this case, the connection factory must be of type <span class="emphasis"><em>client</em></span> and must have <span class="emphasis"><em>single-use</em></span> set to false.</p>
<p>Two additional attributes are used to support this mechanism: <span class="emphasis"><em>retry-interval</em></span> specifies (in milliseconds) how often the framework will attempt to reconnect after a connection failure.
<span class="emphasis"><em>scheduler</em></span> is used to supply a <code class="literal">TaskScheduler</code> used to schedule the connection attempts, and to test that the connection is still active.</p>
<p>If the gateway is started, you may force the gateway to establish a connection by sending a &lt;control-bus /&gt; command: <code class="literal">@adapter_id.retryConnection()</code> and examine the current state with <code class="literal">@adapter_id.isClientModeConnected()</code>.</p>
<p>The outbound gateway, after sending a message over the connection, waits for a response and constructs a response message and puts in on the reply channel.
Communications over the connections are single-threaded.
Users should be aware that only one message can be handled at a time and, if another thread attempts to send a message before the current response has been received, it will block until any previous requests are complete (or time out).
If, however, the client connection factory is configured for single-use connections each new request gets its own connection and is processed immediately.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-ip:tcp-inbound-gateway</span> <span class="hl-attribute">id</span>=<span class="hl-value">"inGateway"</span>
    <span class="hl-attribute">request-channel</span>=<span class="hl-value">"tcpChannel"</span>
    <span class="hl-attribute">reply-channel</span>=<span class="hl-value">"replyChannel"</span>
    <span class="hl-attribute">connection-factory</span>=<span class="hl-value">"cfServer"</span>
    <span class="hl-attribute">reply-timeout</span>=<span class="hl-value">"10000"</span><span class="hl-tag">/&gt;</span></pre>
<p>A simple inbound TCP gateway; if a connection factory configured with the default (de)serializer is used, messages will be \r\n delimited data and the gateway can be used by a simple client such as telnet.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-ip:tcp-outbound-gateway</span> <span class="hl-attribute">id</span>=<span class="hl-value">"outGateway"</span>
    <span class="hl-attribute">request-channel</span>=<span class="hl-value">"tcpChannel"</span>
    <span class="hl-attribute">reply-channel</span>=<span class="hl-value">"replyChannel"</span>
    <span class="hl-attribute">connection-factory</span>=<span class="hl-value">"cfClient"</span>
    <span class="hl-attribute">request-timeout</span>=<span class="hl-value">"10000"</span>
    <span class="hl-attribute">remote-timeout</span>=<span class="hl-value">"10000"</span><span class="hl-tag">/&gt;</span> <span class="hl-comment">&lt;!-- or e.g.
remote-timeout-expression="headers['timeout']" --&gt;</span></pre>
<p>A simple outbound TCP gateway.</p>
<p><code class="literal">client-mode</code> is not currently available with the outbound gateway.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="ip-correlation" href="#ip-correlation"></a>31.8&nbsp;TCP Message Correlation</h2></div></div></div>

<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_overview" href="#_overview"></a>31.8.1&nbsp;Overview</h3></div></div></div>

<p>One goal of the IP Endpoints is to provide communication with systems other than another Spring Integration application.
For this reason, only message payloads are sent and received, by default.
Since 3.0, headers can be transferred, using JSON, Java serialization, or with custom <code class="literal">Serializer</code> s and <code class="literal">Deserializer</code> s; see <a class="xref" href="#ip-headers" title="31.8.4&nbsp;Transferring Headers">Section&nbsp;31.8.4, &#8220;Transferring Headers&#8221;</a> for more information.
No message correlation is provided by the framework, except when using the gateways, or collaborating channel adapters on the server side.
In the paragraphs below we discuss the various correlation techniques available to applications.
In most cases, this requires specific application-level correlation of messages, even when message payloads contain some natural correlation data (such as an order number).</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_gateways" href="#_gateways"></a>31.8.2&nbsp;Gateways</h3></div></div></div>

<p>The gateways will automatically correlate messages.
However, an outbound gateway should only be used for relatively low-volume use.
When the connection factory is configured for a single shared connection to be used for all message pairs (<span class="emphasis"><em>single-use="false"</em></span>), only one message can be processed at a time.
A new message will have to wait until the reply to the previous message has been received.
When a connection factory is configured for each new message to use a new connection (<span class="emphasis"><em>single-use="true"</em></span>), the above restriction does not apply.
While this may give higher throughput than a shared connection environment, it comes with the overhead of opening and closing a new connection for each message pair.</p>
<p>Therefore, for high-volume messages, consider using a collaborating pair of channel adapters.
However, you will need to provide collaboration logic.</p>
<p>Another solution, introduced in Spring Integration 2.2, is to use a <code class="literal">CachingClientConnectionFactory</code>, which allows the use of a pool of shared connections.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_collaborating_outbound_and_inbound_channel_adapters" href="#_collaborating_outbound_and_inbound_channel_adapters"></a>31.8.3&nbsp;Collaborating Outbound and Inbound Channel Adapters</h3></div></div></div>

<p>To achieve high-volume throughput (avoiding the pitfalls of using gateways as mentioned above) you may consider configuring a pair of collaborating outbound and inbound channel adapters.
Collaborating adapters can also be used (server-side or client-side) for totally asynchronous communication (rather than with request/reply semantics).
On the server side, message correlation is automatically handled by the adapters because the inbound adapter adds a header allowing the outbound adapter to determine which connection to use to send the reply message.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>On the server side, care must be taken to populate the <span class="emphasis"><em>ip_connectionId</em></span> header because it is used to correlate the message to a connection.
Messages that originate at the inbound adapter will automatically have the header set.
If you wish to construct other messages to send, you will need to set the header.
The header value can be captured from an incoming message.</p>
</td></tr></table></div>
<p>On the client side, the application will have to provide its own correlation logic, if needed.
This can be done in a number of ways.</p>
<p>If the message payload has some natural correlation data, such as a transaction id or an order number, AND there is no need to retain any information (such as a reply channel header) from the original outbound message, the correlation is simple and would done at the application level in any case.</p>
<p>If the message payload has some natural correlation data, such as a transaction id or an order number, but there is a need to retain some information (such as a reply channel header) from the original outbound message, you may need to retain a copy of the original outbound message (perhaps by using a publish-subscribe channel) and use an aggregator to recombine the necessary data.</p>
<p>For either of the previous two paragraphs, if the payload has no natural correlation data, you may need to provide a transformer upstream of the outbound channel adapter to enhance the payload with such data.
Such a transformer may transform the original payload to a new object containing both the original payload and some subset of the message headers.
Of course, live objects (such as reply channels) from the headers can not be included in the transformed payload.</p>
<p>If such a strategy is chosen you will need to ensure the connection factory has an appropriate serializer/deserializer pair to handle such a payload, such as the <code class="literal">DefaultSerializer/Deserializer</code> which use java serialization, or a custom serializer and deserializer.
The <code class="literal">ByteArray*Serializer</code> options mentioned in <a class="xref" href="#connection-factories" title="31.3&nbsp;TCP Connection Factories">Section&nbsp;31.3, &#8220;TCP Connection Factories&#8221;</a>, including the default <code class="literal">ByteArrayCrLfSerializer</code>, do not support such payloads, unless the transformed payload is a <code class="literal">String</code> or <code class="literal">byte[]</code>,</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Before the 2.2 release, when a <span class="emphasis"><em>client</em></span> connection factory was used by collaborating channel adapters, the <span class="emphasis"><em>so-timeout</em></span> attribute defaulted to the default reply timeout (10 seconds).
This meant that if no data were received by the inbound adapter for this period of time, the socket was closed.</p>
<p>This default behavior was not appropriate in a truly asynchronous environment, so it now defaults to an infinite timeout.
You can reinstate the previous default behavior by setting the <span class="emphasis"><em>so-timeout</em></span> attribute on the client connection factory to 10000 milliseconds.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="ip-headers" href="#ip-headers"></a>31.8.4&nbsp;Transferring Headers</h3></div></div></div>

<p>TCP is a streaming protocol; <code class="literal">Serializers</code> and <code class="literal">Deserializers</code> are used to demarcate messages within the stream.
Prior to 3.0, only message payloads (String or byte[]) could be transferred over TCP.
Beginning with 3.0, you can now transfer selected headers as well as the payload.
It is important to understand, though, that "live" objects, such as the <code class="literal">replyChannel</code> header cannot be serialized.</p>
<p>Sending header information over TCP requires some additional configuration.</p>
<p>The first step is to provide the <code class="literal">ConnectionFactory</code> with a <code class="literal">MessageConvertingTcpMessageMapper</code> using the <code class="literal">mapper</code> attribute.
This mapper delegates to any <code class="literal">MessageConverter</code> implementation to convert the message to/from some object that can be (de)serialized by the configured <code class="literal">serializer</code> and <code class="literal">deserializer</code>.</p>
<p>A <code class="literal">MapMessageConverter</code> is provided, which allows the specification of a list of headers that will be added to a <code class="literal">Map</code> object, along with the payload.
The generated Map has two entries: <code class="literal">payload</code> and <code class="literal">headers</code>.
The <code class="literal">headers</code> entry is itself a <code class="literal">Map</code> containing the selected headers.</p>
<p>The second step is to provide a (de)serializer that can convert between a <code class="literal">Map</code> and some wire format.
This can be a custom <code class="literal">(de)Serializer</code>, which would typically be needed if the peer system is not a Spring Integration application.</p>
<p>A <code class="literal">MapJsonSerializer</code> is provided that will convert a Map to/from JSON.
This uses a Spring Integration <code class="literal">JsonObjectMapper</code> to perform this function.
You can provide a custom <code class="literal">JsonObjectMapper</code> if needed.
By default, the serializer inserts a linefeed`0x0a` character between objects.
See the JavaDocs for more information.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>At the time of writing, the <code class="literal">JsonObjectMapper</code> uses whichever version of <code class="literal">Jackson</code> is on the classpath.</p>
</td></tr></table></div>
<p>You can also use standard Java serialization of the Map, using the <code class="literal">DefaultSerializer</code> and <code class="literal">DefaultDeserializer</code>.</p>
<p>The following example shows the configuration of a connection factory that transfers the <code class="literal">correlationId</code>, <code class="literal">sequenceNumber</code>, and <code class="literal">sequenceSize</code> headers using JSON.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-ip:tcp-connection-factory</span> <span class="hl-attribute">id</span>=<span class="hl-value">"client"</span>
    <span class="hl-attribute">type</span>=<span class="hl-value">"client"</span>
    <span class="hl-attribute">host</span>=<span class="hl-value">"localhost"</span>
    <span class="hl-attribute">port</span>=<span class="hl-value">"12345"</span>
    <span class="hl-attribute">mapper</span>=<span class="hl-value">"mapper"</span>
    <span class="hl-attribute">serializer</span>=<span class="hl-value">"jsonSerializer"</span>
    <span class="hl-attribute">deserializer</span>=<span class="hl-value">"jsonSerializer"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"mapper"</span>
      <span class="hl-attribute">class</span>=<span class="hl-value">"o.sf.integration.ip.tcp.connection.MessageConvertingTcpMessageMapper"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">name</span>=<span class="hl-value">"messageConverter"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.sf.integration.support.converter.MapMessageConverter"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"headerNames"</span><span class="hl-tag">&gt;</span>
                <span class="hl-tag">&lt;list&gt;</span>
                    <span class="hl-tag">&lt;value&gt;</span>correlationId<span class="hl-tag">&lt;/value&gt;</span>
                    <span class="hl-tag">&lt;value&gt;</span>sequenceNumber<span class="hl-tag">&lt;/value&gt;</span>
                    <span class="hl-tag">&lt;value&gt;</span>sequenceSize<span class="hl-tag">&lt;/value&gt;</span>
                <span class="hl-tag">&lt;/list&gt;</span>
            <span class="hl-tag">&lt;/property&gt;</span>
        <span class="hl-tag">&lt;/bean&gt;</span>
    <span class="hl-tag">&lt;/constructor-arg&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"jsonSerializer"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.sf.integration.ip.tcp.serializer.MapJsonSerializer"</span><span class="hl-tag"> /&gt;</span></pre>
<p>A message sent with the above configuration, with payload <span class="emphasis"><em>foo</em></span> would appear on the wire like so:</p>
<pre class="programlisting">{"headers":{"correlationId":"bar","sequenceSize":5,"sequenceNumber":1},"payload":"foo"}</pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="note_nio" href="#note_nio"></a>31.9&nbsp;A Note About NIO</h2></div></div></div>

<p>Using NIO (see <code class="literal">using-nio</code> in <a class="xref" href="#ip-endpoint-reference" title="31.12&nbsp;IP Configuration Attributes">Section&nbsp;31.12, &#8220;IP Configuration Attributes&#8221;</a>) avoids dedicating a thread to read from each socket.
For a small number of sockets, you will likely find that <span class="emphasis"><em>not</em></span> using NIO, together with an async handoff (e.g.
to a <code class="literal">QueueChannel</code>), will perform as well as, or better than, using NIO.</p>
<p>Consider using NIO when handling a large number of connections.
However, the use of NIO has some other ramifications.
A pool of threads (in the task executor) is shared across all the sockets; each incoming message is assembled and sent to the configured channel as a separate unit of work on a thread selected from that pool.
Two sequential messages arriving on the <span class="emphasis"><em>same</em></span> socket <span class="emphasis"><em>might</em></span> be processed by different threads.
This means that the order in which the messages are sent to the channel is indeterminate; the strict ordering of the messages arriving on the socket is not maintained.</p>
<p>For some applications, this is not an issue; for others it is.
If strict ordering is required, consider setting <code class="literal">using-nio</code> to false and using async handoff.</p>
<p>Alternatively, you may choose to insert a resequencer downstream of the inbound endpoint to return the messages to their proper sequence.
Set <span class="emphasis"><em>apply-sequence</em></span> to true on the connection factory, and messages arriving on a TCP connection will have <span class="emphasis"><em>sequenceNumber</em></span> and <span class="emphasis"><em>correlationId</em></span> headers set.
The resequencer uses these headers to return the messages to their proper sequence.</p>
<p><span class="emphasis"><em>Pool Size</em></span></p>
<p>The pool size attribute is no longer used; previously, it specified the size of the default thread pool when a task-executor was not specified.
It was also used to set the connection backlog on server sockets.
The first function is no longer needed (see below); the second function is replaced by the <span class="emphasis"><em>backlog</em></span> attribute.</p>
<p>Previously, when using a fixed thread pool task executor (which was the default), with NIO, it was possible to get a deadlock and processing would stop.
The problem occurred when a buffer was full, a thread reading from the socket was trying to add more data to the buffer, and there were no threads available to make space in the buffer.
This only occurred with a very small pool size, but it could be possible under extreme conditions.
Since 2.2, two changes have eliminated this problem.
First, the default task executor is a cached thread pool executor.
Second, deadlock detection logic has been added such that if thread starvation occurs, instead of deadlocking, an exception is thrown, thus releasing the deadlocked resources.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Now that the default task executor is unbounded, it is possible that an out of memory condition might occur with high rates of incoming messages, if message processing takes extended time.
If your application exhibits this type of behavior, you are advised to use a pooled task executor with an appropriate pool size, but see the next section.</p>
</td></tr></table></div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_thread_pool_task_executor_with_caller_runs_policy" href="#_thread_pool_task_executor_with_caller_runs_policy"></a>31.9.1&nbsp;Thread Pool Task Executor with CALLER_RUNS Policy</h3></div></div></div>

<p>There are some important considerations when using a fixed thread pool with the <code class="literal">CallerRunsPolicy</code> (<code class="literal">CALLER_RUNS</code> when using the <code class="literal">&lt;task/&gt;</code> namespace) and the queue capacity is small.</p>
<p>The following does not apply if you are not using a fixed thread pool.</p>
<p>With NIO connections there are 3 distinct task types; the IO Selector processing is performed on one dedicated thread - detecting events, accepting new connections, and dispatching the IO read operations to other threads, using the task executor.
When an IO reader thread (to which the read operation is dispatched) reads data, it hands off to another thread to assemble the incoming message; large messages may take several reads to complete.
These "assembler" threads can block waiting for data.
When a new read event occurs, the reader determines if this socket already has an assembler and runs a new one if not.
When the assembly process is complete, the assembler thread is returned to the pool.</p>
<p>This can cause a deadlock when the pool is exhausted and the CALLER_RUNS rejection policy is in use, and the task queue is full.
When the pool is empty and there is no room in the queue, the IO selector thread receives an <code class="literal">OP_READ</code> event and dispatches the read using the executor; the queue is full, so the selector thread itself starts the read process; now, it detects that there is not an assembler for this socket and, before it does the read, fires off an assembler; again, the queue is full, and the selector thread becomes the assembler.
The assembler is now blocked awaiting the data to be read, which will never happen.
The connection factory is now deadlocked because the selector thread can&#8217;t handle new events.</p>
<p>We must avoid the selector (or reader) threads performing the assembly task to avoid this deadlock.
It is desirable to use seperate pools for the IO and assembly operations.</p>
<p>The framework provides a <code class="literal">CompositeExecutor</code>, which allows the configuration of two distinct executors; one for performing IO operations, and one for message assembly.
In this environment, an IO thread can never become an assembler thread, and the deadlock cannot occur.</p>
<p>In addition, the task executors should be configured to use a <code class="literal">AbortPolicy</code> (ABORT when using <code class="literal">&lt;task&gt;</code>).
When an IO cannot be completed, it is deferred for a short time and retried continually until it can be completed and an assembler allocated.
By default, the delay is 100ms but it can be changed using the <code class="literal">readDelay</code> property on the connection factory (<code class="literal">read-delay</code> when configuring with the XML namespace).</p>
<p>Example configuration of the composite executor is shown below.</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">private</span> CompositeExecutor compositeExecutor() {
    ThreadPoolTaskExecutor ioExec = <span class="hl-keyword">new</span> ThreadPoolTaskExecutor();
    ioExec.setCorePoolSize(<span class="hl-number">4</span>);
    ioExec.setMaxPoolSize(<span class="hl-number">10</span>);
    ioExec.setQueueCapacity(<span class="hl-number">0</span>);
    ioExec.setThreadNamePrefix(<span class="hl-string">"io-"</span>);
    ioExec.setRejectedExecutionHandler(<span class="hl-keyword">new</span> AbortPolicy());
    ioExec.initialize();
    ThreadPoolTaskExecutor assemblerExec = <span class="hl-keyword">new</span> ThreadPoolTaskExecutor();
    assemblerExec.setCorePoolSize(<span class="hl-number">4</span>);
    assemblerExec.setMaxPoolSize(<span class="hl-number">10</span>);
    assemblerExec.setQueueCapacity(<span class="hl-number">0</span>);
    assemblerExec.setThreadNamePrefix(<span class="hl-string">"assembler-"</span>);
    assemblerExec.setRejectedExecutionHandler(<span class="hl-keyword">new</span> AbortPolicy());
    assemblerExec.initialize();
    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> CompositeExecutor(ioExec, assemblerExec);
}</pre>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myTaskExecutor"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.util.CompositeExecutor"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"io"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"assembler"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;task:executor</span> <span class="hl-attribute">id</span>=<span class="hl-value">"io"</span> <span class="hl-attribute">pool-size</span>=<span class="hl-value">"4-10"</span> <span class="hl-attribute">queue-capacity</span>=<span class="hl-value">"0"</span> <span class="hl-attribute">rejection-policy</span>=<span class="hl-value">"ABORT"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;task:executor</span> <span class="hl-attribute">id</span>=<span class="hl-value">"assembler"</span> <span class="hl-attribute">pool-size</span>=<span class="hl-value">"4-10"</span> <span class="hl-attribute">queue-capacity</span>=<span class="hl-value">"0"</span> <span class="hl-attribute">rejection-policy</span>=<span class="hl-value">"ABORT"</span><span class="hl-tag"> /&gt;</span></pre>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myTaskExecutor"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.util.CompositeExecutor"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.scheduling.concurrent.ThreadPoolTaskExecutor"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"threadNamePrefix"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"io-"</span><span class="hl-tag"> /&gt;</span>
            <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"corePoolSize"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"4"</span><span class="hl-tag"> /&gt;</span>
            <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"maxPoolSize"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"8"</span><span class="hl-tag"> /&gt;</span>
            <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"queueCapacity"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"0"</span><span class="hl-tag"> /&gt;</span>
            <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"rejectedExecutionHandler"</span><span class="hl-tag">&gt;</span>
                <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"java.util.concurrent.ThreadPoolExecutor.AbortPolicy"</span><span class="hl-tag"> /&gt;</span>
            <span class="hl-tag">&lt;/property&gt;</span>
        <span class="hl-tag">&lt;/bean&gt;</span>
    <span class="hl-tag">&lt;/constructor-arg&gt;</span>
    <span class="hl-tag">&lt;constructor-arg&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.scheduling.concurrent.ThreadPoolTaskExecutor"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"threadNamePrefix"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"assembler-"</span><span class="hl-tag"> /&gt;</span>
            <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"corePoolSize"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"4"</span><span class="hl-tag"> /&gt;</span>
            <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"maxPoolSize"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"10"</span><span class="hl-tag"> /&gt;</span>
            <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"queueCapacity"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"0"</span><span class="hl-tag"> /&gt;</span>
            <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"rejectedExecutionHandler"</span><span class="hl-tag">&gt;</span>
                <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"java.util.concurrent.ThreadPoolExecutor.AbortPolicy"</span><span class="hl-tag"> /&gt;</span>
            <span class="hl-tag">&lt;/property&gt;</span>
        <span class="hl-tag">&lt;/bean&gt;</span>
    <span class="hl-tag">&lt;/constructor-arg&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="ssl-tls" href="#ssl-tls"></a>31.10&nbsp;SSL/TLS Support</h2></div></div></div>

<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_overview_2" href="#_overview_2"></a>31.10.1&nbsp;Overview</h3></div></div></div>

<p>Secure Sockets Layer/Transport Layer Security is supported.
When using NIO, the JDK 5+ <code class="literal">SSLEngine</code> feature is used to handle handshaking after the connection is established.
When not using NIO, standard <code class="literal">SSLSocketFactory</code> and <code class="literal">SSLServerSocketFactory</code> objects are used to create connections.
A number of strategy interfaces are provided to allow significant customization; default implementations of these interfaces provide for the simplest way to get started with secure communications.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_getting_started" href="#_getting_started"></a>31.10.2&nbsp;Getting Started</h3></div></div></div>

<p>Regardless of whether NIO is being used, you need to configure the <code class="literal">ssl-context-support</code> attribute on the connection factory.
This attribute references a &lt;bean/&gt; definition that describes the location and passwords for the required key stores.</p>
<p>SSL/TLS peers require two keystores each; a keystore containing private/public key pairs identifying the peer; a truststore, containing the public keys for peers that are trusted.
See the documentation for the <code class="literal">keytool</code> utility provided with the JDK.
The essential steps are</p>
<div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
Create a new key pair and store in a keystore.
</li><li class="listitem">
Export the public key.
</li><li class="listitem">
Import the public key into the peer&#8217;s truststore.
</li></ol></div>
<p>Repeat for the other peer.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>It is common in test cases to use the same key stores on both peers, but this should be avoided for production.</p>
</td></tr></table></div>
<p>After establishing the key stores, the next step is to indicate their locations to the <code class="literal">TcpSSLContextSupport</code> bean, and provide a reference to that bean to the connection factory.</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"sslContextSupport"</span>
    <span class="hl-attribute">class</span>=<span class="hl-value">"o.sf.integration.ip.tcp.connection.support.DefaultTcpSSLContextSupport"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"client.ks"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"client.truststore.ks"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"secret"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"secret"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;ip:tcp-connection-factory</span> <span class="hl-attribute">id</span>=<span class="hl-value">"clientFactory"</span>
    <span class="hl-attribute">type</span>=<span class="hl-value">"client"</span>
    <span class="hl-attribute">host</span>=<span class="hl-value">"localhost"</span>
    <span class="hl-attribute">port</span>=<span class="hl-value">"1234"</span>
    <span class="hl-attribute">ssl-context-support</span>=<span class="hl-value">"sslContextSupport"</span><span class="hl-tag"> /&gt;</span></pre>
<p>The <code class="literal">DefaulTcpSSLContextSupport</code> class also has an optional <code class="literal">protocol</code> property, which can be <code class="literal">SSL</code> or <code class="literal">TLS</code> (default).</p>
<p>The keystore file names (first two constructor arguments) use the Spring <code class="literal">Resource</code> abstraction; by default the files will be located on the classpath, but this can be overridden by using the <code class="literal">file:</code> prefix, to find the files on the filesystem instead.</p>
<p>Starting with <span class="emphasis"><em>version 4.3.6</em></span>, when using NIO, you can specify an <code class="literal">ssl-handshake-timeout</code> (seconds) on the connection factory.
This timeout (default 30) is used during SSL handshake when waiting for data; if the timeout is exceeded, the process is aborted and the socket closed.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="advanced-techniques" href="#advanced-techniques"></a>31.11&nbsp;Advanced Techniques</h2></div></div></div>

<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_strategy_interfaces" href="#_strategy_interfaces"></a>31.11.1&nbsp;Strategy Interfaces</h3></div></div></div>

<p>In many cases, the configuration described above is all that is needed to enable secure communication over TCP/IP.
However, a number of strategy interfaces are provided to allow customization and modification of socket factories and sockets.</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">TcpSSLContextSupport</code>
</li><li class="listitem">
<code class="literal">TcpSocketFactorySupport</code>
</li><li class="listitem">
<code class="literal">TcpSocketSupport</code>
</li><li class="listitem">
<code class="literal">TcpNioConnectionSupport</code>
</li></ul></div>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> TcpSSLContextSupport {

    SSLContext getSSLContext() <span class="hl-keyword">throws</span> Exception;

}</pre>
<p>Implementations of this interface are responsible for creating an SSLContext.
The implementation provided by the framework is the <code class="literal">DefaultTcpSSLContextSupport</code> described above.
If you require different behavior, implement this interface and provide the connection factory with a reference to a bean of your class' implementation.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> TcpSocketFactorySupport {

    ServerSocketFactory getServerSocketFactory();

    SocketFactory getSocketFactory();

}</pre>
<p>Implementations of this interface are responsible for obtaining references to <code class="literal">ServerSocketFactory</code> and <code class="literal">SocketFactory</code>.
Two implementations are provided; the first is <code class="literal">DefaultTcpNetSocketFactorySupport</code> for non-SSL sockets (when no <code class="literal">ssl-context-support</code> attribute is defined); this simply uses the JDK&#8217;s default factories.
The second implementation is <code class="literal">DefaultTcpNetSSLSocketFactorySupport</code>; this is used, by default, when an <code class="literal">ssl-context-support</code> attribute is defined; it uses the <code class="literal">SSLContext</code> created by that bean to create the socket factories.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>This interface only applies if <code class="literal">using-nio</code> is "false"; socket factories are not used by NIO.</p>
</td></tr></table></div>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> TcpSocketSupport {

    <span class="hl-keyword">void</span> postProcessServerSocket(ServerSocket serverSocket);

    <span class="hl-keyword">void</span> postProcessSocket(Socket socket);

}</pre>
<p>Implementations of this interface can modify sockets after they are created, and after all configured attributes have been applied, but before the sockets are used.
This applies whether or not NIO is being used.
For example, you could use an implementation of this interface to modify the supported cipher suites on an SSL socket, or you could add a listener that gets notified after SSL handshaking is complete.
The sole implementation provided by the framework is the <code class="literal">DefaultTcpSocketSupport</code> which does not modify the sockets in any way</p>
<p>To supply your own implementation of <code class="literal">TcpSocketFactorySupport</code> or <code class="literal">TcpSocketSupport</code>, provide the connection factory with references to beans of your custom type using the <code class="literal">socket-factory-support</code> and <code class="literal">socket-support</code> attributes, respectively.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> TcpNioConnectionSupport {

    TcpNioConnection createNewConnection(SocketChannel socketChannel,
            <span class="hl-keyword">boolean</span> server, <span class="hl-keyword">boolean</span> lookupHost,
            ApplicationEventPublisher applicationEventPublisher,
            String connectionFactoryName) <span class="hl-keyword">throws</span> Exception;

}</pre>
<p>This interface is invoked to create <code class="literal">TcpNioConnection</code> objects (or subclasses).
Two implementations are provided <code class="literal">DefaultTcpNioSSLConnectionSupport</code> and <code class="literal">DefaultTcpNioConnectionSupport</code> which are used depending on whether SSL is in use or not.
A common use case would be to subclass <code class="literal">DefaultTcpNioSSLConnectionSupport</code> and override <code class="literal">postProcessSSLEngine</code>; see the example below.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_example_enabling_ssl_client_authentication" href="#_example_enabling_ssl_client_authentication"></a>31.11.2&nbsp;Example: Enabling SSL Client Authentication</h3></div></div></div>

<p>To enable client certificate authentication when using SSL, the technique depends on whether NIO is in use or not.
When NIO is not being used, provide a custom <code class="literal">TcpSocketSupport</code> implementation to post-process the server socket:</p>
<pre class="programlisting">serverFactory.setTcpSocketSupport(<span class="hl-keyword">new</span> DefaultTcpSocketSupport() {

    <em><span class="hl-annotation" style="color: gray">@Override</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> postProcessServerSocket(ServerSocket serverSocket) {
        ((SSLServerSocket) serverSocket).setNeedClientAuth(true);
    }

});</pre>
<p>(When using XML configuration, provide a reference to your bean using the <code class="literal">socket-support</code> attribute).</p>
<p>When using NIO, provide a custom <code class="literal">TcpNioSslConnectionSupport</code> implementation to post-process the <code class="literal">SSLEngine</code>.</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> DefaultTcpNioSSLConnectionSupport tcpNioConnectionSupport() {
    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> DefaultTcpNioSSLConnectionSupport(serverSslContextSupport) {

            <em><span class="hl-annotation" style="color: gray">@Override</span></em>
            <span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> postProcessSSLEngine(SSLEngine sslEngine) {
                sslEngine.setNeedClientAuth(true);
            }

    }
}

<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> TcpNioServerConnectionFactory server() {
    ...
    serverFactory.setTcpNioConnectionSupport(tcpNioConnectionSupport());
    ...
}</pre>
<p>(When using XML configuration, since <span class="emphasis"><em>version 4.3.7</em></span>, provide a reference to your bean using the <code class="literal">nio-connection-support</code> attribute).</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="ip-endpoint-reference" href="#ip-endpoint-reference"></a>31.12&nbsp;IP Configuration Attributes</h2></div></div></div>

<div class="table"><a name="d5e17567" href="#d5e17567"></a><p class="title"><b>Table&nbsp;31.1.&nbsp;Connection Factory Attributes</b></p><div class="table-contents">

<table summary="Connection Factory Attributes" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"><col class="col_4"><col class="col_5"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Attribute Name</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">Client?</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">Server?</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Allowed Values</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Attribute Description</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>type</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>client, server</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Determines whether the connection factory is a client or server.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>host</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>N</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The host name or ip address of the destination.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>port</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The port.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>serializer</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>An implementation of <code class="literal">Serializer</code> used to serialize the payload.
Defaults to <code class="literal">ByteArrayCrLfSerializer</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>deserializer</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>An implementation of <code class="literal">Deserializer</code> used to deserialize the payload.
Defaults to <code class="literal">ByteArrayCrLfSerializer</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>using-nio</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true, false</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Whether or not connection uses NIO.
Refer to the java.nio package for more information.
See <a class="xref" href="#note_nio" title="31.9&nbsp;A Note About NIO">Section&nbsp;31.9, &#8220;A Note About NIO&#8221;</a>.
Default false.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>using-direct-buffers</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>N</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true, false</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>When using NIO, whether or not the connection uses direct buffers.
Refer to <code class="literal">java.nio.ByteBuffer</code> documentation for more information.
Must be false if using-nio is false.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>apply-sequence</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true, false</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>When using NIO, it may be necessary to resequence messages.
When this attribute is set to true, <span class="emphasis"><em>correlationId</em></span> and <span class="emphasis"><em>sequenceNumber</em></span> headers will be added to received messages.
See <a class="xref" href="#note_nio" title="31.9&nbsp;A Note About NIO">Section&nbsp;31.9, &#8220;A Note About NIO&#8221;</a>.
Default false.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>so-timeout</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Defaults to 0 (infinity), except for server connection factories with single-use="true".
In that case, it defaults to the default reply timeout (10 seconds).</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>so-send-buffer-size</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>See <code class="literal">java.net.Socket.
setSendBufferSize()</code>.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>so-receive-buffer- size</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>See <code class="literal">java.net.Socket.
setReceiveBufferSize()</code>.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>so-keep-alive</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true, false</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>See <code class="literal">java.net.Socket.
setKeepAlive()</code>.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>so-linger</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Sets linger to true with supplied value.
See <code class="literal">java.net.Socket.
setSoLinger()</code>.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>so-tcp-no-delay</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true, false</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>See <code class="literal">java.net.Socket.
setTcpNoDelay()</code>.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>so-traffic-class</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>See <code class="literal">java.net.Socket.
setTrafficClass()</code>.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>local-address</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>N</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>On a multi-homed system, specifies an IP address for the interface to which the socket will be bound.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>task-executor</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Specifies a specific Executor to be used for socket handling.
If not supplied, an internal cached thread executor will be used.
Needed on some platforms that require the use of specific task executors such as a WorkManagerTaskExecutor.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>single-use</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true, false</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Specifies whether a connection can be used for multiple messages.
If true, a new connection will be used for each message.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>pool-size</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>N</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>N</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>This attribute is no longer used.
For backward compatibility, it sets the backlog but users should use backlog to specify the connection backlog in server factories</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>backlog</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>N</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Sets the connection backlog for server factories.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>lookup-host</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>true, false</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Specifies whether reverse lookups are done on IP addresses to convert to host names for use in message headers.
If false, the IP address is used instead.
Defaults to true.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>interceptor-factory-chain</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>See <a class="xref" href="#ip-interceptors" title="31.4&nbsp;TCP Connection Interceptors">Section&nbsp;31.4, &#8220;TCP Connection Interceptors&#8221;</a></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>ssl-context-support</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>See <a class="xref" href="#ssl-tls" title="31.10&nbsp;SSL/TLS Support">Section&nbsp;31.10, &#8220;SSL/TLS Support&#8221;</a></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>socket-factory-support</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>See <a class="xref" href="#ssl-tls" title="31.10&nbsp;SSL/TLS Support">Section&nbsp;31.10, &#8220;SSL/TLS Support&#8221;</a></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>socket-support</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>See <a class="xref" href="#ssl-tls" title="31.10&nbsp;SSL/TLS Support">Section&nbsp;31.10, &#8220;SSL/TLS Support&#8221;</a></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>nio-connection-support</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>See <a class="xref" href="#advanced-techniques" title="31.11&nbsp;Advanced Techniques">Section&nbsp;31.11, &#8220;Advanced Techniques&#8221;</a></p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>read-delay</p></td><td style="border-right: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>long &gt; 0</p></td><td style="" align="left" valign="top"><p>The delay (in milliseconds) before retrying a read after the previous attempt failed due to insufficient threads.
Default 100.
Only applies if <code class="literal">using-nio</code> is <code class="literal">true</code>.</p></td></tr></tbody></table>
</div></div><br class="table-break">
<div class="table"><a name="ip-udp-ib-atts" href="#ip-udp-ib-atts"></a><p class="title"><b>Table&nbsp;31.2.&nbsp;UDP Inbound Channel Adapter Attributes</b></p><div class="table-contents">

<table summary="UDP Inbound Channel Adapter Attributes" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Attribute Name</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">Allowed Values</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Attribute Description</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>port</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The port on which the adapter listens.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>multicast</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>true, false</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Whether or not the udp adapter uses multicast.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>multicast-address</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>When multicast is true, the multicast address to which the adapter joins.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>pool-size</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Specifies the concurrency.
Specifies how many packets can be handled concurrently.
It only applies if task-executor is not configured.
Defaults to 5.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>task-executor</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Specifies a specific Executor to be used for socket handling.
If not supplied, an internal pooled executor will be used.
Needed on some platforms that require the use of specific task executors such as a WorkManagerTaskExecutor.
See pool-size for thread requirements.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>receive-buffer-size</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The size of the buffer used to receive DatagramPackets.
Usually set to the MTU size.
If a smaller buffer is used than the size of the sent packet, truncation can occur.
This can be detected by means of the check-length attribute..</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>check-length</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>true, false</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Whether or not a udp adapter expects a data length field in the packet received.
Used to detect packet truncation.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>so-timeout</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>See <code class="literal">java.net.DatagramSocket</code> setSoTimeout() methods for more information.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>so-send-buffer-size</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Used for udp acknowledgment packets.
See <code class="literal">java.net.DatagramSocket</code> setSendBufferSize() methods for more information.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>so-receive-buffer- size</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>See <code class="literal">java.net.DatagramSocket</code> setReceiveBufferSize() for more information.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>local-address</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>On a multi-homed system, specifies an IP address for the interface to which the socket will be bound.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>error-channel</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>If an Exception is thrown by a downstream component, the MessagingException message containing the exception and failed message is sent to this channel.</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>lookup-host</p></td><td style="border-right: 0.5pt solid ; " align="center" valign="top"><p>true, false</p></td><td style="" align="left" valign="top"><p>Specifies whether reverse lookups are done on IP addresses to convert to host names for use in message headers.
If false, the IP address is used instead.
Defaults to true.</p></td></tr></tbody></table>
</div></div><br class="table-break">
<div class="table"><a name="d5e17980" href="#d5e17980"></a><p class="title"><b>Table&nbsp;31.3.&nbsp;UDP Outbound Channel Adapter Attributes</b></p><div class="table-contents">

<table summary="UDP Outbound Channel Adapter Attributes" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Attribute Name</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">Allowed Values</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Attribute Description</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>host</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The host name or ip address of the destination.
For multicast udp adapters, the multicast address.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>port</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The port on the destination.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>multicast</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>true, false</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Whether or not the udp adapter uses multicast.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>acknowledge</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>true, false</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Whether or not a udp adapter requires an acknowledgment from the destination.
when enabled, requires setting the following 4 attributes.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>ack-host</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>When acknowledge is true, indicates the host or ip address to which the acknowledgment should be sent.
Usually the current host, but may be different, for example when Network Address Transaction (NAT) is being used.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>ack-port</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>When acknowledge is true, indicates the port to which the acknowledgment should be sent.
The adapter listens on this port for acknowledgments.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>ack-timeout</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>When acknowledge is true, indicates the time in milliseconds that the adapter will wait for an acknowledgment.
If an acknowledgment is not received in time, the adapter will throw an exception.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>min-acks-for- success</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Defaults to 1.
For multicast adapters, you can set this to a larger value, requiring acknowledgments from multiple destinations.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>check-length</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>true, false</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Whether or not a udp adapter includes a data length field in the packet sent to the destination.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>time-to-live</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>For multicast adapters, specifies the time to live attribute for the <code class="literal">MulticastSocket</code>; controls the scope of the multicasts.
Refer to the Java API documentation for more information.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>so-timeout</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>See <code class="literal">java.net.DatagramSocket</code> setSoTimeout() methods for more information.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>so-send-buffer-size</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>See <code class="literal">java.net.DatagramSocket</code> setSendBufferSize() methods for more information.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>so-receive-buffer- size</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Used for udp acknowledgment packets.
See <code class="literal">java.net.DatagramSocket</code> setReceiveBufferSize() methods for more information.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>local-address</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>On a multi-homed system, for the UDP adapter, specifies an IP address for the interface to which the socket will be bound for reply messages.
For a multicast adapter it is also used to determine which interface the multicast packets will be sent over.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>task-executor</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Specifies a specific Executor to be used for acknowledgment handling.
If not supplied, an internal single threaded executor will be used.
Needed on some platforms that require the use of specific task executors such as a WorkManagerTaskExecutor.
One thread will be dedicated to handling acknowledgments (if the acknowledge option is true).</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>destination-expression</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>SpEL expression</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>A SpEL expression to be evaluated to determine which <code class="literal">SocketAddress</code> to use as a destination address for the
outgoing UDP packets.</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>socket-expression</p></td><td style="border-right: 0.5pt solid ; " align="center" valign="top"><p>SpEL expression</p></td><td style="" align="left" valign="top"><p>A SpEL expression to be evaluated to determine which datagram socket use for sending outgoing UDP packets.</p></td></tr></tbody></table>
</div></div><br class="table-break">
<div class="table"><a name="d5e18104" href="#d5e18104"></a><p class="title"><b>Table&nbsp;31.4.&nbsp;TCP Inbound Channel Adapter Attributes</b></p><div class="table-contents">

<table summary="TCP Inbound Channel Adapter Attributes" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Attribute Name</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">Allowed Values</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Attribute Description</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>channel</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The channel to which inbound messages will be sent.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>connection-factory</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>If the connection factory has a type <span class="emphasis"><em>server</em></span>, the factory is <span class="emphasis"><em>owned</em></span> by this adapter.
If it has a type <span class="emphasis"><em>client</em></span>, it is <span class="emphasis"><em>owned</em></span> by an outbound channel adapter and this adapter will receive any incoming messages on the connection created by the outbound adapter.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>error-channel</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>If an Exception is thrown by a downstream component, the MessagingException message containing the exception and failed message is sent to this channel.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>client-mode</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>true, false</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>When true, the inbound adapter will act as a client, with respect to establishing the connection and then receive incoming messages on that connection.
Default = false.
Also see <span class="emphasis"><em>retry-interval</em></span> and <span class="emphasis"><em>scheduler</em></span>.
The connection factory must be of type <span class="emphasis"><em>client</em></span> and have <span class="emphasis"><em>single-use</em></span> set to false.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>retry-interval</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>When in <span class="emphasis"><em>client-mode</em></span>, specifies the number of milliseconds to wait between connection attempts, or after a connection failure.
Default 60,000 (60 seconds).</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>scheduler</p></td><td style="border-right: 0.5pt solid ; " align="center" valign="top"><p>true, false</p></td><td style="" align="left" valign="top"><p>Specifies a <code class="literal">TaskScheduler</code> to use for managing the <span class="emphasis"><em>client-mode</em></span> connection.
Defaults to a <code class="literal">ThreadPoolTaskScheduler</code> with a pool size of `.</p></td></tr></tbody></table>
</div></div><br class="table-break">
<div class="table"><a name="d5e18166" href="#d5e18166"></a><p class="title"><b>Table&nbsp;31.5.&nbsp;TCP Outbound Channel Adapter Attributes</b></p><div class="table-contents">

<table summary="TCP Outbound Channel Adapter Attributes" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Attribute Name</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">Allowed Values</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Attribute Description</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>channel</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The channel on which outbound messages arrive.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>connection-factory</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>If the connection factory has a type <span class="emphasis"><em>client</em></span>, the factory is <span class="emphasis"><em>owned</em></span> by this adapter.
If it has a type <span class="emphasis"><em>server</em></span>, it is <span class="emphasis"><em>owned</em></span> by an inbound channel adapter and this adapter will attempt to correlate messages to the connection on which an original inbound message was received.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>client-mode</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>true, false</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>When true, the outbound adapter will attempt to establish the connection as soon as it is started.
When false, the connection is established when the first message is sent.
Default = false.
Also see <span class="emphasis"><em>retry-interval</em></span> and <span class="emphasis"><em>scheduler</em></span>.
The connection factory must be of type <span class="emphasis"><em>client</em></span> and have <span class="emphasis"><em>single-use</em></span> set to false.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>retry-interval</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>When in <span class="emphasis"><em>client-mode</em></span>, specifies the number of milliseconds to wait between connection attempts, or after a connection failure.
Default 60,000 (60 seconds).</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>scheduler</p></td><td style="border-right: 0.5pt solid ; " align="center" valign="top"><p>true, false</p></td><td style="" align="left" valign="top"><p>Specifies a <code class="literal">TaskScheduler</code> to use for managing the <span class="emphasis"><em>client-mode</em></span> connection.
Defaults to a <code class="literal">ThreadPoolTaskScheduler</code> with a pool size of `.</p></td></tr></tbody></table>
</div></div><br class="table-break">
<div class="table"><a name="d5e18222" href="#d5e18222"></a><p class="title"><b>Table&nbsp;31.6.&nbsp;TCP Inbound Gateway Attributes</b></p><div class="table-contents">

<table summary="TCP Inbound Gateway Attributes" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Attribute Name</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">Allowed Values</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Attribute Description</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>connection-factory</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The connection factory must be of type server.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>request-channel</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The channel to which incoming messages will be sent.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>reply-channel</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The channel on which reply messages may arrive.
Usually replies will arrive on a temporary reply channel added to the inbound message header</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>reply-timeout</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The time in milliseconds for which the gateway will wait for a reply.
Default 1000 (1 second).</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>error-channel</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>If an Exception is thrown by a downstream component, the MessagingException message containing the exception and failed message is sent to this channel; any reply from that flow will then be returned as a response by the gateway.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>client-mode</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>true, false</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>When true, the inbound gateway will act as a client, with respect to establishing the connection and then receive (and reply to) incoming messages on that connection.
Default = false.
Also see <span class="emphasis"><em>retry-interval</em></span> and <span class="emphasis"><em>scheduler</em></span>.
The connection factory must be of type <span class="emphasis"><em>client</em></span> and have <span class="emphasis"><em>single-use</em></span> set to false.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>retry-interval</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>When in <span class="emphasis"><em>client-mode</em></span>, specifies the number of milliseconds to wait between connection attempts, or after a connection failure.
Default 60,000 (60 seconds).</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>scheduler</p></td><td style="border-right: 0.5pt solid ; " align="center" valign="top"><p>true, false</p></td><td style="" align="left" valign="top"><p>Specifies a <code class="literal">TaskScheduler</code> to use for managing the <span class="emphasis"><em>client-mode</em></span> connection.
Defaults to a <code class="literal">ThreadPoolTaskScheduler</code> with a pool size of `.</p></td></tr></tbody></table>
</div></div><br class="table-break">
<div class="table"><a name="tcp-ob-gateway-attributes" href="#tcp-ob-gateway-attributes"></a><p class="title"><b>Table&nbsp;31.7.&nbsp;TCP Outbound Gateway Attributes</b></p><div class="table-contents">

<table summary="TCP Outbound Gateway Attributes" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Attribute Name</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">Allowed Values</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Attribute Description</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>connection-factory</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The connection factory must be of type client.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>request-channel</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The channel on which outgoing messages will arrive.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>reply-channel</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Optional.
The channel to which reply messages may be sent.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>remote-timeout</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The time in milliseconds for which the gateway will wait for a reply from the remote system.
Mutually exclusive with <code class="literal">remote-timeout-expression</code>.
Default: 10000 (10 seconds).
Note: in versions prior to <span class="emphasis"><em>4.2</em></span> this value defaulted to <code class="literal">reply-timeout</code> (if set).</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>remote-timeout-expression</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>A SpEL expression, evaluated against the message to determine the time in milliseconds for which the gateway will wait for a reply from the remote system.
Mutually exclusive with <code class="literal">remote-timeout</code>.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>request-timeout</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>If a single-use connection factory is not being used, The time in milliseconds for which the gateway will wait to get access to the shared connection.</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>reply-timeout</p></td><td style="border-right: 0.5pt solid ; " align="center" valign="top">&nbsp;</td><td style="" align="left" valign="top"><p>The time in milliseconds for which the gateway will wait when sending the reply to the reply-channel.
Only applies if the reply-channel might block, such as a bounded QueueChannel that is currently full.</p></td></tr></tbody></table>
</div></div><br class="table-break">
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="ip-msg-headers" href="#ip-msg-headers"></a>31.13&nbsp;IP Message Headers</h2></div></div></div>

<p>
<b>IP Message Headers.&nbsp;</b>
The following <code class="literal">MessageHeader</code> s are used by this module:
</p>
<div class="informaltable">
<table style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Header Name</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">IpHeaders Constant</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Description</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>ip_hostname</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>HOSTNAME</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The host name from which a TCP message or UDP packet was received.
If <code class="literal">lookupHost</code> is <code class="literal">false</code>, this will contain the ip address.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>ip_address</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>IP_ADDRESS</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The ip address from which a TCP message or UDP packet was received.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>ip_port</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PORT</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The remote port for a UDP packet.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>ip_localInetAddress</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>IP_LOCAL_ADDRESS</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The local <code class="literal">InetAddress</code> to which the socket is connected (since <span class="emphasis"><em>version 4.2.5</em></span>).</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>ip_ackTo</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>ACKADDRESS</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The remote ip address to which UDP application-level acks will be sent.
The framework includes acknowledgment information in the data packet.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>ip_ackId</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>ACK_ID</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>A correlation id for UDP application-level acks.
The framework includes acknowledgment information in the data packet.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>ip_tcp_remotePort</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>REMOTE_PORT</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The remote port for a TCP connection.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>ip_connectionId</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>CONNECTION_ID</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>A unique identifier for a TCP connection; set by the framework for inbound messages; when sending to a server-side inbound channel adapter, or replying to an inbound gateway, this header is required so the endpoint can determine which connection to send the message to.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>ip_actualConnectionId</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>ACTUAL_ CONNECTION_ID</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>For information only - when using a cached or failover client connection factory, contains the actual underlying connection id.</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>contentType</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>MessageHeaders. CONTENT_TYPE</p></td><td style="" align="left" valign="top"><p>An optional content type for inbound messages; see below.
Note that, unlike the other header constants, this constant is in the class <code class="literal">MessageHeaders</code> not <code class="literal">IpHeaders</code>.</p></td></tr></tbody></table>
</div>
<p>For inbound messages, <code class="literal">ip_hostname</code>, <code class="literal">ip_address</code>, <code class="literal">ip_tcp_remotePort</code> and <code class="literal">ip_connectionId</code> are mapped by the default
<code class="literal">TcpHeaderMapper</code>.
Set the mapper&#8217;s <code class="literal">addContentTypeHeader</code> property to <code class="literal">true</code> and the mapper will set the <code class="literal">contentType</code> header (<code class="literal">application/octet-stream;charset="UTF-8"</code>) by default.
You can change the default by setting the <code class="literal">contentType</code> property.
Users can add additional headers by subclassing <code class="literal">TcpHeaderMapper</code> and overriding the method <code class="literal">supplyCustomHeaders</code>.
For example, when using SSL, properties of the <code class="literal">SSLSession</code> can be added by obtaining the session object from the
<code class="literal">TcpConnection</code> object which is provided as an argument to the <code class="literal">supplyCustomHeaders</code> method.</p>
<p>For outbound messages, <code class="literal">String</code> payloads are converted to <code class="literal">byte[]</code> using the default (<code class="literal">UTF-8</code>) charset.
Set the <code class="literal">charset</code> property to change the default.</p>
<p>When customizing the mapper properties, or subclassing, declare the mapper as a bean and provide an instance to the connection factory using the <code class="literal">mapper</code> property</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="ip-annotation" href="#ip-annotation"></a>31.14&nbsp;Annotation-Based Configuration</h2></div></div></div>

<p>The following example from the samples repository is used to illustrate some of the configuration options when using
annotations instead of XML.</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@EnableIntegration</span></em> <a name="CO49-1" href="#CO49-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
<em><span class="hl-annotation" style="color: gray">@IntegrationComponentScan</span></em> <a name="CO49-2" href="#CO49-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
<em><span class="hl-annotation" style="color: gray">@Configuration</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">class</span> Config {

    <em><span class="hl-annotation" style="color: gray">@Value(${some.port})</span></em>
    <span class="hl-keyword">private</span> <span class="hl-keyword">int</span> port;

    <em><span class="hl-annotation" style="color: gray">@MessagingGateway(defaultRequestChannel="toTcp")</span></em> <a name="CO49-3" href="#CO49-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
    <span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> Gateway {

        String viaTcp(String in);

    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel="toTcp")</span></em> <a name="CO49-4" href="#CO49-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
    <span class="hl-keyword">public</span> MessageHandler tcpOutGate(AbstractClientConnectionFactory connectionFactory) {
        TcpOutboundGateway gate = <span class="hl-keyword">new</span> TcpOutboundGateway();
        gate.setConnectionFactory(connectionFactory);
        gate.setOutputChannelName(<span class="hl-string">"resultToString"</span>);
        <span class="hl-keyword">return</span> gate;
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em> <a name="CO49-5" href="#CO49-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
    <span class="hl-keyword">public</span> TcpInboundGateway tcpInGate(AbstractServerConnectionFactory connectionFactory)  {
        TcpInboundGateway inGate = <span class="hl-keyword">new</span> TcpInboundGateway();
        inGate.setConnectionFactory(connectionFactory);
        inGate.setRequestChannel(fromTcp());
        <span class="hl-keyword">return</span> inGate;
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> MessageChannel fromTcp() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> DirectChannel();
    }

    <em><span class="hl-annotation" style="color: gray">@MessageEndpoint</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">class</span> Echo { <a name="CO49-6" href="#CO49-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>

        <em><span class="hl-annotation" style="color: gray">@Transformer(inputChannel="fromTcp", outputChannel="toEcho")</span></em>
        <span class="hl-keyword">public</span> String convert(<span class="hl-keyword">byte</span>[] bytes) {
            <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> String(bytes);
        }

        <em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel="toEcho")</span></em>
        <span class="hl-keyword">public</span> String upCase(String in) {
            <span class="hl-keyword">return</span> in.toUpperCase();
        }

        <em><span class="hl-annotation" style="color: gray">@Transformer(inputChannel="resultToString")</span></em>
        <span class="hl-keyword">public</span> String convertResult(<span class="hl-keyword">byte</span>[] bytes) {
            <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> String(bytes);
        }

    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> AbstractClientConnectionFactory clientCF() { <a name="CO49-7" href="#CO49-7"></a><span><img src="images/callouts/7.png" alt="7" border="0"></span>
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> TcpNetClientConnectionFactory(<span class="hl-string">"localhost"</span>, <span class="hl-keyword">this</span>.port);
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> AbstractServerConnectionFactory serverCF() { <a name="CO49-8" href="#CO49-8"></a><span><img src="images/callouts/8.png" alt="8" border="0"></span>
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> TcpNetServerConnectionFactory(<span class="hl-keyword">this</span>.port);
    }

}</pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO49-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Standard Spring Integration annotation enabling the infrastructure for an integration application.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO49-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Searches for <code class="literal">@MessagingGateway</code> interfaces.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO49-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The entry point to the client-side of the flow. The calling application can <code class="literal">@Autowired</code> this <code class="literal">Gateway</code> bean
and invoke its method.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO49-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Outbound endpoints consist of a <code class="literal">MessageHandler</code> and a consumer that wraps it. In this scenario, the
<code class="literal">@ServiceActivator</code> configures the endpoint according to the channel type.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO49-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Inbound endpoints (in the TCP/UDP module) are all message-driven so just need to be declared as simple <code class="literal">@Bean</code> s.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO49-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>This class provides a number of POJO methods for use in this sample flow (a <code class="literal">@Transformer</code> and <code class="literal">@ServiceActivator</code>
on the server side, and a <code class="literal">@Transformer</code> on the client side).</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO49-7"><span><img src="images/callouts/7.png" alt="7" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The client-side connection factory.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO49-8"><span><img src="images/callouts/8.png" alt="8" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The server-side connection factory.</p>
</td></tr></table></div>
</div>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="twitter" href="#twitter"></a>32.&nbsp;Twitter Support</h2></div></div></div>

<p>Spring Integration provides support for interacting with Twitter.
With the Twitter adapters you can both receive and send Twitter messages.
You can also perform a Twitter search based on a schedule and publish the search results within Messages.
Since <span class="emphasis"><em>version 4.0</em></span>, a search outbound gateway is provided to perform dynamic searches.</p>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="twitter-intro" href="#twitter-intro"></a>32.1&nbsp;Introduction</h2></div></div></div>

<p>Twitter is a social networking and micro-blogging service that enables its users to send and read messages known as tweets.
Tweets are text-based posts of up to 140 characters displayed on the author&#8217;s profile page and delivered to the author&#8217;s subscribers who are known as followers.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Versions of Spring Integration prior to 2.1 were dependent upon the <a class="ulink" href="http://twitter4j.org" target="_top">Twitter4J API</a>, but with the release of <a class="ulink" href="http://projects.spring.io/spring-social" target="_top">Spring Social 1.0 GA</a>, Spring Integration, as of version 2.1, now builds directly upon Spring Social&#8217;s Twitter support, instead of Twitter4J.
All Twitter endpoints require the configuration of a <code class="literal">TwitterTemplate</code> because even search operations require an authenticated template.</p>
</td></tr></table></div>
<p>Spring Integration provides a convenient namespace configuration to define Twitter artifacts.
You can enable it by adding the following within your XML header.</p>
<pre class="programlisting">xmlns:int-twitter="http://www.springframework.org/schema/integration/twitter"
xsi:schemaLocation="http://www.springframework.org/schema/integration/twitter
http://www.springframework.org/schema/integration/twitter/spring-integration-twitter.xsd"</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="twitter-oauth" href="#twitter-oauth"></a>32.2&nbsp;Twitter OAuth Configuration</h2></div></div></div>

<p>For authenticated operations, Twitter uses OAuth - an authentication protocol that allows users to approve an application to act on their behalf without sharing their password.
More information can be found at <a class="ulink" href="http://oauth.net" target="_top">http://oauth.net</a> or in this article <a class="ulink" href="http://hueniverse.com/oauth" target="_top">http://hueniverse.com/oauth</a> from Hueniverse.
Please also see <a class="ulink" href="http://dev.twitter.com/pages/oauth_faq" target="_top">OAuth FAQ</a> for more information about OAuth and Twitter.</p>
<p>In order to use OAuth authentication/authorization with Twitter you must create a new Application on the Twitter Developers site.
Follow the directions below to create a new application and obtain consumer keys and an access token:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Go to <a class="ulink" href="http://dev.twitter.com" target="_top">http://dev.twitter.com</a>
</li><li class="listitem">
Click on the <code class="literal">Register an app</code> link and fill out all required fields on the form provided; set <code class="literal">Application Type</code> to <code class="literal">Client</code> and depending on the nature of your application select <code class="literal">Default Access Type</code> as <span class="emphasis"><em>Read &amp; Write</em></span> or <span class="emphasis"><em>Read-only</em></span> and Submit the form.
If everything is successful you&#8217;ll be presented with the <code class="literal">Consumer Key</code> and <code class="literal">Consumer Secret</code>.
Copy both values in a safe place.
</li><li class="listitem">
On the same page you should see a <code class="literal">My Access Token</code> button on the side bar (right).
Click on it and you&#8217;ll be presented with two more values: <code class="literal">Access Token</code> and <code class="literal">Access Token Secret</code>.
Copy these values in a safe place as well.
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_twitter_template" href="#_twitter_template"></a>32.3&nbsp;Twitter Template</h2></div></div></div>

<p>As mentioned above, Spring Integration relies upon Spring Social, and that library provides an implementation of the template pattern, <code class="literal">o.s.social.twitter.api.impl.TwitterTemplate</code> to interact with Twitter.
For anonymous operations (e.g., search), you don&#8217;t have to define an instance of <code class="literal">TwitterTemplate</code> explicitly, since a default instance will be created and injected into the endpoint.
However, for authenticated operations (update status, send direct message, etc.), you must configure a <code class="literal">TwitterTemplate</code> as a bean and inject it explicitly into the endpoint, because the authentication configuration is required.
Below is a sample configuration of TwitterTemplate:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"twitterTemplate"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.social.twitter.api.impl.TwitterTemplate"</span><span class="hl-tag">&gt;</span>
	<span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"4XzBPacJQxyBzzzH"</span><span class="hl-tag">/&gt;</span>
	<span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"AbRxUAvyCtqQtvxFK8w5ZMtMj20KFhB6o"</span><span class="hl-tag">/&gt;</span>
	<span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"21691649-4YZY5iJEOfz2A9qCFd9SjBRGb3HLmIm4HNE"</span><span class="hl-tag">/&gt;</span>
	<span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"AbRxUAvyNCtqQtxFK8w5ZMtMj20KFhB6o"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The values above are not real.</p>
</td></tr></table></div>
<pre class="literallayout"> As you can see from the configuration above, all we need to do is to provide OAuth `attributes` as constructor arguments.
The values would be those you obtained in the previous step.
The order of constructor arguments is: 1) `consumerKey`, 2) `consumerSecret`, 3) `accessToken`, and 4) `accessTokenSecret`.</pre>
<p>A more practical way to manage OAuth connection attributes would be via Spring&#8217;s property placeholder support by simply creating a property file (e.g., oauth.properties):</p>
<pre class="programlisting">twitter.oauth.consumerKey=4XzBPacJQxyBzzzH
twitter.oauth.consumerSecret=AbRxUAvyCtqQtvxFK8w5ZMtMj20KFhB6o
twitter.oauth.accessToken=<span class="hl-number">21691649</span>-4YZY5iJEOfz2A9qCFd9SjBRGb3HLmIm4HNE
twitter.oauth.accessTokenSecret=AbRxUAvyNCtqQtxFK8w5ZMtMj20KFhB6o</pre>
<p>Then, you can configure a <code class="literal">property-placeholder</code> to point to the above property file:</p>
<pre class="programlisting"><span class="hl-tag">&lt;context:property-placeholder</span> <span class="hl-attribute">location</span>=<span class="hl-value">"classpath:oauth.properties"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"twitterTemplate"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.social.twitter.api.impl.TwitterTemplate"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"${twitter.oauth.consumerKey}"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"${twitter.oauth.consumerSecret}"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"${twitter.oauth.accessToken}"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"${twitter.oauth.accessTokenSecret}"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="twitter-inbound" href="#twitter-inbound"></a>32.4&nbsp;Twitter Inbound Adapters</h2></div></div></div>

<p>Twitter inbound adapters allow you to receive Twitter Messages.
There are several types of <a class="ulink" href="http://support.twitter.com/articles/119138-types-of-tweets-and-where-they-appear" target="_top">twitter messages, or tweets</a></p>
<p><span class="emphasis"><em>Spring Integration version 2.0 and above</em></span> provides support for receiving tweets as <span class="emphasis"><em>Timeline Updates</em></span>, <span class="emphasis"><em>Direct Messages</em></span>, <span class="emphasis"><em>Mention Messages</em></span> as well as Search Results.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Every Inbound Twitter Channel Adapter is a <span class="emphasis"><em>Polling Consumer</em></span> which means you have to provide a poller configuration.
Twitter defines a concept of Rate Limiting.
You can read more about it here: <a class="ulink" href="https://dev.twitter.com/docs/rate-limiting/1.1" target="_top">Rate Limiting</a>.
In a nutshell, Rate Limiting is a mechanism that Twitter uses to manage how often an application can poll for updates.
You should consider this when setting your poller intervals so that the adapter polls in compliance with the Twitter policies.</p>
<p>With Spring Integration prior to <span class="emphasis"><em>version 3.0</em></span>, a hard-coded limit within the adapters was used to ensure the polling interval could not be less than 15 seconds.
This is no longer the case and the poller configuration is applied directly.</p>
</td></tr></table></div>
<p>Another issue that we need to worry about is handling duplicate Tweets.
The same adapter (e.g., Search or Timeline Update) while polling on Twitter may receive the same values more than once.
For example if you keep searching on Twitter with the same search criteria you&#8217;ll end up with the same set of tweets unless some other new tweet that matches your search criteria was posted in between your searches.
In that situation you&#8217;ll get all the tweets you had before plus the new one.
But what you really want is only the new tweet(s).
Spring Integration provides an elegant mechanism for handling these situations.
The latest Tweet id will be stored in an instance of the <code class="literal">org.springframework.integration.metadata.MetadataStore</code> strategy (e.g.
last retrieved tweet in this case).
For more information see <a class="xref" href="#metadata-store" title="9.5&nbsp;Metadata Store">Section&nbsp;9.5, &#8220;Metadata Store&#8221;</a>.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The key used to persist the latest <span class="emphasis"><em>twitter id</em></span> is the value of the (required) <code class="literal">id</code> attribute of the Twitter Inbound Channel Adapter component plus the <code class="literal">profileId</code> of the Twitter user.</p>
</td></tr></table></div>
<p>Prior to <span class="emphasis"><em>version 4.0</em></span>, the page size was hard-coded to 20.
This is now configurable using the <code class="literal">page-size</code> attribute (defaults to 20).</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="inbound-twitter-update" href="#inbound-twitter-update"></a>32.4.1&nbsp;Inbound Message Channel Adapter</h3></div></div></div>

<p>This adapter allows you to receive updates from everyone you follow.
It&#8217;s essentially the "Timeline Update" adapter.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-twitter:inbound-channel-adapter</span>
  		<span class="hl-attribute">twitter-template</span>=<span class="hl-value">"twitterTemplate"</span>
  		<span class="hl-attribute">channel</span>=<span class="hl-value">"inChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"5000"</span> <span class="hl-attribute">max-messages-per-poll</span>=<span class="hl-value">"3"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-twitter:inbound-channel-adapter&gt;</span></pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="inbound-twitter-direct" href="#inbound-twitter-direct"></a>32.4.2&nbsp;Direct Inbound Message Channel Adapter</h3></div></div></div>

<p>This adapter allows you to receive Direct Messages that were sent to you from other Twitter users.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-twitter:dm-inbound-channel-adapter</span>
  		<span class="hl-attribute">twitter-template</span>=<span class="hl-value">"twiterTemplate"</span>
  		<span class="hl-attribute">channel</span>=<span class="hl-value">"inboundDmChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int-poller</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"5000"</span> <span class="hl-attribute">max-messages-per-poll</span>=<span class="hl-value">"3"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-twitter:dm-inbound-channel-adapter&gt;</span></pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="inbound-twitter-mention" href="#inbound-twitter-mention"></a>32.4.3&nbsp;Mentions Inbound Message Channel Adapter</h3></div></div></div>

<p>This adapter allows you to receive Twitter Messages that Mention you via @user syntax.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-twitter:mentions-inbound-channel-adapter</span>
  		<span class="hl-attribute">twitter-template</span>=<span class="hl-value">"twiterTemplate"</span>
		<span class="hl-attribute">channel</span>=<span class="hl-value">"inboundMentionsChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"5000"</span> <span class="hl-attribute">max-messages-per-poll</span>=<span class="hl-value">"3"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-twitter:mentions-inbound-channel-adapter&gt;</span></pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="inbound-twitter-search" href="#inbound-twitter-search"></a>32.4.4&nbsp;Search Inbound Message Channel Adapter</h3></div></div></div>

<p>This adapter allows you to perform searches.
As you can see it is not necessary to define twitter-template since a search can be performed anonymously, however you must define a search query.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-twitter:search-inbound-channel-adapter</span>
  		<span class="hl-attribute">query</span>=<span class="hl-value">"#springintegration"</span>
		<span class="hl-attribute">channel</span>=<span class="hl-value">"inboundMentionsChannel"</span><span class="hl-tag">&gt;</span>
     <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"5000"</span> <span class="hl-attribute">max-messages-per-poll</span>=<span class="hl-value">"3"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-twitter:search-inbound-channel-adapter&gt;</span></pre>
<p>Refer to <a class="ulink" href="https://dev.twitter.com/docs/using-search" target="_top">https://dev.twitter.com/docs/using-search</a> to learn more about Twitter queries.</p>
<p>As you can see the configuration of all of these adapters is very similar to other inbound adapters with one exception.
Some may need to be injected with the <code class="literal">twitter-template</code>.
Once received each Twitter Message would be encapsulated in a Spring Integration Message and sent to the channel specified by the <code class="literal">channel</code> attribute.
Currently the Payload type of any Message is <code class="literal">org.springframework.integration.twitter.core.Tweet</code> which is very similar to the object with the same name in Spring Social.
As we migrate to Spring Social we&#8217;ll be depending on their API and some of the artifacts that are currently in use will be obsolete, however we&#8217;ve already made sure that the impact of such migration is minimal by aligning our API with the current state (at the time of writing) of Spring Social.</p>
<p>To get the text from the <code class="literal">org.springframework.social.twitter.api.Tweet</code> simply invoke the <code class="literal">getText()</code> method.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="twitter-outbound" href="#twitter-outbound"></a>32.5&nbsp;Twitter Outbound Adapter</h2></div></div></div>

<p>Twitter outbound channel adapters allow you to send Twitter Messages, or tweets.</p>
<p><span class="emphasis"><em>Spring Integration version 2.0 and above</em></span> supports sending <span class="emphasis"><em>Status Update Messages</em></span> and <span class="emphasis"><em>Direct Messages</em></span>.
Twitter outbound channel adapters will take the Message payload and send it as a Twitter message.
Currently the only supported payload type is`String`, so consider adding a <span class="emphasis"><em>transformer</em></span> if the payload of the incoming message is not a String.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="outbound-twitter-update" href="#outbound-twitter-update"></a>32.5.1&nbsp;Twitter Outbound Update Channel Adapter</h3></div></div></div>

<p>This adapter allows you to send regular status updates by simply sending a Message to the channel identified by the <code class="literal">channel</code> attribute.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-twitter:outbound-channel-adapter</span>
  		<span class="hl-attribute">twitter-template</span>=<span class="hl-value">"twitterTemplate"</span>
  		<span class="hl-attribute">channel</span>=<span class="hl-value">"twitterChannel"</span><span class="hl-tag">/&gt;</span></pre>
<pre class="literallayout">The only extra configuration that is required for this adapter is the `twitter-template` reference.</pre>
<p>Starting with <span class="emphasis"><em>version 4.0</em></span> the <code class="literal">&lt;int-twitter:outbound-channel-adapter&gt;</code> supports a <code class="literal">tweet-data-expression</code> to populate the <code class="literal">TweetData</code> argument (<a class="ulink" href="http://projects.spring.io/spring-social-twitter/" target="_top">Spring Social Twitter</a>) using the message as the root object of the expression evaluation context.
The result can be a <code class="literal">String</code>, which will be used for the <code class="literal">TweetData</code> message; a <code class="literal">Tweet</code> object, the <code class="literal">text</code> of which will be used for the <code class="literal">TweetData</code> message; or an entire <code class="literal">TweetData</code> object.
For convenience, the <code class="literal">TweetData</code> can be built from the expression directly without needing a fully qualified class name:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-twitter:outbound-channel-adapter</span>
    <span class="hl-attribute">twitter-template</span>=<span class="hl-value">"twitterTemplate"</span>
    <span class="hl-attribute">channel</span>=<span class="hl-value">"twitterChannel"</span>
    <span class="hl-attribute">tweet-data-expression</span>=<span class="hl-value">"new TweetData(payload).withMedia(headers.media).displayCoordinates(true)/&gt;</span></pre>
<p>This allows, for example, attaching an image to the tweet.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="outbound-twitter-direct" href="#outbound-twitter-direct"></a>32.5.2&nbsp;Twitter Outbound Direct Message Channel Adapter</h3></div></div></div>

<p>This adapter allows you to send Direct Twitter Messages (i.e., @user) by simply sending a Message to the channel identified by the <code class="literal">channel</code> attribute.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-twitter:dm-outbound-channel-adapter</span>
  		<span class="hl-attribute">twitter-template</span>=<span class="hl-value">"twitterTemplate"</span>
  		<span class="hl-attribute">channel</span>=<span class="hl-value">"twitterChannel"</span><span class="hl-tag">/&gt;</span></pre>
<pre class="literallayout">The only extra configuration that is required for this adapter is the `twitter-template` reference.</pre>
<p>When it comes to Twitter Direct Messages, you must specify who you are sending the message to - the <span class="emphasis"><em>target userid</em></span>.
The Twitter Outbound Direct Message Channel Adapter will look for a target userid in the Message headers under the name <code class="literal">twitter_dmTargetUserId</code> which is also identified by the following constant: <code class="literal">TwitterHeaders.DM_TARGET_USER_ID</code>.
So when creating a Message all you need to do is add a value for that header.</p>
<pre class="programlisting">Message message = MessageBuilder.withPayload(<span class="hl-string">"hello"</span>)
        .setHeader(TwitterHeaders.DM_TARGET_USER_ID, <span class="hl-string">"z_oleg"</span>).build();</pre>
<p>The above approach works well if you are creating the Message programmatically.
However it&#8217;s more common to provide the header value within a messaging flow.
The value can be provided by an upstream &lt;header-enricher&gt;.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:header-enricher</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"in"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"out"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:header</span> <span class="hl-attribute">name</span>=<span class="hl-value">"twitter_dmTargetUserId"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"z_oleg"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:header-enricher&gt;</span></pre>
<p>It&#8217;s quite common that the value must be determined dynamically.
For those cases you can take advantage of SpEL support within the &lt;header-enricher&gt;.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:header-enricher</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"in"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"out"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:header</span> <span class="hl-attribute">name</span>=<span class="hl-value">"twitter_dmTargetUserId"</span>
        <span class="hl-attribute">expression</span>=<span class="hl-value">"@twitterIdService.lookup(headers.username)"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:header-enricher&gt;</span></pre>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Twitter does not allow you to post duplicate Messages.
This is a common problem during testing when the same code works the first time but does not work the second time.
So, make sure to change the content of the Message each time.
Another thing that works well for testing is to append a timestamp to the end of each message.</p>
</td></tr></table></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="twitter-sog" href="#twitter-sog"></a>32.6&nbsp;Twitter Search Outbound Gateway</h2></div></div></div>

<p>In Spring Integration, an outbound gateway is used for two-way request/response communication with an external service.
The Twitter Search Outbound Gateway allows you to issue dynamic twitter searches.
The reply message payload is a collection of <code class="literal">Tweet</code> objects.
If the search returns no results, the payload is an empty collection.
You can limit the number of tweets and you can page through a larger set of tweets by making multiple calls.
To facilitate this, search reply messages contain a header <code class="literal">twitter_searchMetadata</code> with its value being a <code class="literal">SearchMetadata</code> object.
For more information on the <code class="literal">Tweet</code>, <code class="literal">SearchParameters</code> and <code class="literal">SearchMetadata</code> classes, refer to the <a class="ulink" href="http://projects.spring.io/spring-social-twitter/" target="_top">Spring Social Twitter</a> documentation.</p>
<p><span class="strong"><strong>Configuring the Outbound Gateway</strong></span></p>
<pre class="programlisting"><span class="hl-tag">&lt;int-twitter:search-outbound-gateway</span> <span class="hl-attribute">id</span>=<span class="hl-value">"twitter"</span>
	<span class="hl-attribute">request-channel</span>=<span class="hl-value">"in"</span>  <a name="CO50-1" href="#CO50-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
	twitter-template="twitterTemplate"  <a name="CO50-2" href="#CO50-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
	search-args-expression="payload"  <a name="CO50-3" href="#CO50-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
	reply-channel="out"  <a name="CO50-4" href="#CO50-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
	reply-timeout="123"  <a name="CO50-5" href="#CO50-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
	order="1"  <a name="CO50-6" href="#CO50-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>
	auto-startup="false"  <a name="CO50-7" href="#CO50-7"></a><span><img src="images/callouts/7.png" alt="7" border="0"></span>
	phase="100" /&gt; <a name="CO50-8" href="#CO50-8"></a><span><img src="images/callouts/8.png" alt="8" border="0"></span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO50-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The channel used to send search requests to this gateway.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO50-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A reference to a <code class="literal">TwitterTemplate</code> with authentication configuration.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO50-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A SpEL expression that evaluates to argument(s) for the search.
Default: <span class="strong"><strong>"payload"</strong></span> - in which case the payload can be a <code class="literal">String</code> (e.g "#springintegration") and the gateway limits the query to 20 tweets, or the payload can be a <code class="literal">SearchParameters</code> object.
The expression can also be specified as a <a class="ulink" href="http://docs.spring.io/spring/docs/current/spring-framework-reference/html/expressions.html#expressions-inline-lists" target="_top">SpEL List</a>.
The first element (String) is the query, the remaining elements (Numbers) are <code class="literal">pageSize, sinceId, maxId</code> respectively - refer to the Spring Social Twitter documentation for more information about these parameters.
When specifying a <code class="literal">SearchParameters</code> object directly in the SpEL expression, you do not have to fully qualify the class name.
Some examples:
<code class="literal">new SearchParameters(payload).count(5).sinceId(headers.sinceId)</code>
<code class="literal">{payload, 30}</code>
<code class="literal">{payload, headers.pageSize, headers.sinceId, headers.maxId}</code></p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO50-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The channel to which to send the reply; if omitted, the <code class="literal">replyChannel</code> header is used.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO50-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The timeout when sending the reply message to the reply channel; only applies if the reply channel can block, for example a bounded queue channel that is full.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO50-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>When subscribed to a publish/subscribe channel, the order in which this endpoint will be invoked.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO50-7"><span><img src="images/callouts/7.png" alt="7" border="0"></span></a> </p></td><td valign="top" align="left">
<p><code class="literal">SmartLifecycle</code> method.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO50-8"><span><img src="images/callouts/8.png" alt="8" border="0"></span></a> </p></td><td valign="top" align="left">
<p><code class="literal">SmartLifecycle</code> method.</p>
</td></tr></table></div>
</div>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="web-sockets" href="#web-sockets"></a>33.&nbsp;WebSockets Support</h2></div></div></div>

<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="web-socket-introduction" href="#web-socket-introduction"></a>33.1&nbsp;Introduction</h2></div></div></div>

<p>Starting with <span class="emphasis"><em>version 4.1</em></span> Spring Integration has introduced <span class="emphasis"><em>WebSocket</em></span> support.
It is based on architecture, infrastructure and API from the Spring Framework&#8217;s <span class="emphasis"><em>web-socket</em></span> module.
Therefore, many of Spring WebSocket&#8217;s components (e.g.
<code class="literal">SubProtocolHandler</code> or <code class="literal">WebSocketClient</code>) and configuration options (e.g.
<code class="literal">@EnableWebSocketMessageBroker</code>) can be reused within Spring Integration.
For more information, please, refer to the <a class="ulink" href="http://docs.spring.io/spring/docs/current/spring-framework-reference/html/#websocket" target="_top">Spring Framework WebSocket Support</a> chapter in the Spring Framework reference manual.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Since the Spring Framework WebSocket infrastructure is based on the <span class="emphasis"><em>Spring Messaging</em></span> foundation and provides a basic Messaging framework based on the same <code class="literal">MessageChannel</code> s, <code class="literal">MessageHandler</code> s that Spring Integration uses, and some POJO-method annotation mappings, Spring Integration can be directly involved in a WebSocket flow, even without WebSocket adapters.
For this purpose you can simply configure a Spring Integration <code class="literal">@MessagingGateway</code> with appropriate annotations:</p>
</td></tr></table></div>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@MessagingGateway</span></em>
<em><span class="hl-annotation" style="color: gray">@Controller</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> WebSocketGateway {

    <em><span class="hl-annotation" style="color: gray">@MessageMapping("/greeting")</span></em>
    <em><span class="hl-annotation" style="color: gray">@SendToUser("/queue/answer")</span></em>
    <em><span class="hl-annotation" style="color: gray">@Gateway(requestChannel = "greetingChannel")</span></em>
    String greeting(String payload);

}</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="web-socket-overview" href="#web-socket-overview"></a>33.2&nbsp;Overview</h2></div></div></div>

<p>Since the WebSocket protocol is <span class="emphasis"><em>streaming</em></span> by definition and we can <span class="emphasis"><em>send</em></span> and <span class="emphasis"><em>receive</em></span> messages to/from a WebSocket at the same time, we can simply deal with an appropriate <code class="literal">WebSocketSession</code>, regardless of being on the client or server side.
To encapsulate the connection management and <code class="literal">WebSocketSession</code> registry, the <code class="literal">IntegrationWebSocketContainer</code> is provided with <code class="literal">ClientWebSocketContainer</code> and <code class="literal">ServerWebSocketContainer</code> implementations.
Thanks to the <a class="ulink" href="https://www.jcp.org/en/jsr/detail?id=356" target="_top">WebSocket API</a> and its implementation in the Spring Framework, with many extensions, the same classes are used on the server side as well as the client side (from a Java perspective, of course).
Hence most connection and <code class="literal">WebSocketSession</code> registry options are the same on both sides.
That allows us to reuse many configuration items and infrastructure hooks to build WebSocket applications on the server side as well as on the client side:</p>
<pre class="programlisting"><span class="hl-comment">//Client side</span>
<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> WebSocketClient webSocketClient() {
    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> SockJsClient(Collections.singletonList(<span class="hl-keyword">new</span> WebSocketTransport(<span class="hl-keyword">new</span> JettyWebSocketClient())));
}

<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> IntegrationWebSocketContainer clientWebSocketContainer() {
    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> ClientWebSocketContainer(webSocketClient(), <span class="hl-string">"ws://my.server.com/endpoint"</span>);
}

<span class="hl-comment">//Server side</span>
<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> IntegrationWebSocketContainer serverWebSocketContainer() {
    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> ServerWebSocketContainer(<span class="hl-string">"/endpoint"</span>).withSockJs();
}</pre>
<p>The <code class="literal">IntegrationWebSocketContainer</code> is designed to achieve <span class="emphasis"><em>bidirectional</em></span> messaging and can be shared between Inbound and Outbound Channel Adapters (see below), can be referenced only from one of them (when using one-way - sending or receiving - WebSocket messaging).
It can be used without any Channel Adapter, but in this case, <code class="literal">IntegrationWebSocketContainer</code> only plays a role as the <code class="literal">WebSocketSession</code> registry.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The <code class="literal">ServerWebSocketContainer</code> implements <code class="literal">WebSocketConfigurer</code> to register an internal <code class="literal">IntegrationWebSocketContainer.IntegrationWebSocketHandler</code> as an <code class="literal">Endpoint</code> under the provided <code class="literal">paths</code> and other server WebSocket options (such as <code class="literal">HandshakeHandler</code> or <code class="literal">SockJS fallback</code>) within the <code class="literal">ServletWebSocketHandlerRegistry</code> for the target vendor WebSocket Container.
This registration is achieved with an infrastructural <code class="literal">WebSocketIntegrationConfigurationInitializer</code> component, which does the same as the <code class="literal">@EnableWebSocket</code> annotation.
This means that using just <code class="literal">@EnableIntegration</code> (or any Spring Integration Namespace in the application context) you can omit the <code class="literal">@EnableWebSocket</code> declaration, because all WebSocket Endpoints are detected by the Spring Integration infrastructure.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="web-socket-inbound-adapter" href="#web-socket-inbound-adapter"></a>33.3&nbsp;WebSocket Inbound Channel Adapter</h2></div></div></div>

<p>The <code class="literal">WebSocketInboundChannelAdapter</code> implements the receiving part of <code class="literal">WebSocketSession</code> interaction.
It must be supplied with a <code class="literal">IntegrationWebSocketContainer</code>, and the adapter registers itself as a <code class="literal">WebSocketListener</code> to handle incoming messages and <code class="literal">WebSocketSession</code> events.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Only one <code class="literal">WebSocketListener</code> can be registered in the <code class="literal">IntegrationWebSocketContainer</code>.</p>
</td></tr></table></div>
<p>For WebSocket _sub-protocol_s, the <code class="literal">WebSocketInboundChannelAdapter</code> can be configured with <code class="literal">SubProtocolHandlerRegistry</code> as the second constructor argument.
The adapter delegates to the <code class="literal">SubProtocolHandlerRegistry</code> to determine the appropriate <code class="literal">SubProtocolHandler</code> for the accepted <code class="literal">WebSocketSession</code> and to convert <code class="literal">WebSocketMessage</code> to a <code class="literal">Message</code> according to the sub-protocol implementation.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>By default, the <code class="literal">WebSocketInboundChannelAdapter</code> relies just only on the raw <code class="literal">PassThruSubProtocolHandler</code> implementation, which simply converts the <code class="literal">WebSocketMessage</code> to a <code class="literal">Message</code>.</p>
</td></tr></table></div>
<p>The <code class="literal">WebSocketInboundChannelAdapter</code> accepts and sends to the underlying integration flow only <code class="literal">Message</code> s with <code class="literal">SimpMessageType.MESSAGE</code> or an empty <code class="literal">simpMessageType</code> header.
All other <code class="literal">Message</code> types are handled through the <code class="literal">ApplicationEvent</code> s emitted from a <code class="literal">SubProtocolHandler</code> implementation (e.g.
<code class="literal">StompSubProtocolHandler</code>).</p>
<p>On the server side <code class="literal">WebSocketInboundChannelAdapter</code> can be configured with the <code class="literal">useBroker = true</code> option, if the <code class="literal">@EnableWebSocketMessageBroker</code> configuration is present.
In this case all <code class="literal">non-MESSAGE</code> <code class="literal">Message</code> types are delegated to the provided <code class="literal">AbstractBrokerMessageHandler</code>.
In addition, if the Broker Relay is configured with destination prefixes, those Messages, which match to the Broker destinations, are routed to the <code class="literal">AbstractBrokerMessageHandler</code>, instead of to the <code class="literal">outputChannel</code> of the <code class="literal">WebSocketInboundChannelAdapter</code>.</p>
<p>If <code class="literal">useBroker = false</code> and received message is of <code class="literal">SimpMessageType.CONNECT</code> type, the <code class="literal">WebSocketInboundChannelAdapter</code> sends <code class="literal">SimpMessageType.CONNECT_ACK</code> message to the <code class="literal">WebSocketSession</code> immediately without sending it to the channel.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Spring&#8217;s WebSocket Support allows the configuration of only one Broker Relay, hence we don&#8217;t require an <code class="literal">AbstractBrokerMessageHandler</code> reference, it is detected in the Application Context.</p>
</td></tr></table></div>
<p>For more configuration options see <a class="xref" href="#web-sockets-namespace" title="33.5&nbsp;WebSockets Namespace Support">Section&nbsp;33.5, &#8220;WebSockets Namespace Support&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="web-socket-outbound-adapter" href="#web-socket-outbound-adapter"></a>33.4&nbsp;WebSocket Outbound Channel Adapter</h2></div></div></div>

<p>The <code class="literal">WebSocketOutboundChannelAdapter</code> accepts Spring Integration messages from its <code class="literal">MessageChannel</code>, determines the <code class="literal">WebSocketSession</code> <code class="literal">id</code> from the <code class="literal">MessageHeaders</code>, retrieves the <code class="literal">WebSocketSession</code> from the provided <code class="literal">IntegrationWebSocketContainer</code> and delegates the conversion and sending <code class="literal">WebSocketMessage</code> work to the appropriate <code class="literal">SubProtocolHandler</code> from the provided <code class="literal">SubProtocolHandlerRegistry</code>.</p>
<p>On the client side, the <code class="literal">WebSocketSession</code> <code class="literal">id</code> message header isn&#8217;t required, because <code class="literal">ClientWebSocketContainer</code> deals only with a single connection and its <code class="literal">WebSocketSession</code> respectively.</p>
<p>To use the STOMP sub-protocol, this adapter should be configured with a <code class="literal">StompSubProtocolHandler</code>.
Then you can send any STOMP message type to this adapter, using <code class="literal">StompHeaderAccessor.create(StompCommand...)</code> and a <code class="literal">MessageBuilder</code>, or just using a <code class="literal">HeaderEnricher</code> (see <a class="xref" href="#header-enricher" title="7.2.2&nbsp;Header Enricher">Section&nbsp;7.2.2, &#8220;Header Enricher&#8221;</a>).</p>
<p>For more configuration options see below.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="web-sockets-namespace" href="#web-sockets-namespace"></a>33.5&nbsp;WebSockets Namespace Support</h2></div></div></div>

<p>Spring Integration <span class="emphasis"><em>WebSocket</em></span> namespace includes several components described below.
To include it in your configuration, simply provide the following namespace declaration in your application context configuration file:</p>
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
  <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
  <span class="hl-attribute">xmlns:int</span>=<span class="hl-value">"http://www.springframework.org/schema/integration"</span>
  <span class="hl-attribute">xmlns:int-websocket</span>=<span class="hl-value">"http://www.springframework.org/schema/integration/websocket"</span>
  <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"
    http://www.springframework.org/schema/beans
    http://www.springframework.org/schema/beans/spring-beans.xsd
    http://www.springframework.org/schema/integration
    http://www.springframework.org/schema/integration/spring-integration.xsd
    http://www.springframework.org/schema/integration/websocket
    http://www.springframework.org/schema/integration/websocket/spring-integration-websocket.xsd"</span><span class="hl-tag">&gt;</span>
    ...
<span class="hl-tag">&lt;/beans&gt;</span></pre>
<p><span class="strong"><strong>&lt;int-websocket:client-container&gt;</strong></span></p>
<pre class="programlisting"><span class="hl-tag">&lt;int-websocket:client-container</span>
                	<span class="hl-attribute">id</span>=<span class="hl-value">""</span>  <a name="CO51-1" href="#CO51-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
                	client=""  <a name="CO51-2" href="#CO51-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
                	uri=""  <a name="CO51-3" href="#CO51-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
                	uri-variables=""  <a name="CO51-4" href="#CO51-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
                	origin=""  <a name="CO51-5" href="#CO51-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
                	send-time-limit=""  <a name="CO51-6" href="#CO51-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>
                	send-buffer-size-limit=""  <a name="CO51-7" href="#CO51-7"></a><span><img src="images/callouts/7.png" alt="7" border="0"></span>
                	auto-startup=""  <a name="CO51-8" href="#CO51-8"></a><span><img src="images/callouts/8.png" alt="8" border="0"></span>
                	phase=""&gt;  <a name="CO51-9" href="#CO51-9"></a><span><img src="images/callouts/9.png" alt="9" border="0"></span>
                <span class="hl-tag">&lt;int-websocket:http-headers&gt;</span>
                	<span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">""</span> <span class="hl-attribute">value</span>=<span class="hl-value">""</span><span class="hl-tag">/&gt;</span>
                <span class="hl-tag">&lt;/int-websocket:http-headers&gt;</span>  <a name="CO51-10" href="#CO51-10"></a><span><img src="images/callouts/10.png" alt="10" border="0"></span>
<span class="hl-tag">&lt;/int-websocket:client-container&gt;</span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO51-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The component bean name.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO51-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The <code class="literal">WebSocketClient</code> bean reference.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO51-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The <code class="literal">uri</code> or <code class="literal">uriTemplate</code> to the target WebSocket service.
If it is used as a <code class="literal">uriTemplate</code> with URI variable placeholders, the <code class="literal">uri-variables</code> attribute is required.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO51-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Comma-separated values for the URI variable placeholders within the <code class="literal">uri</code> attribute value.
The values are replaced into the placeholders according to the order in the <code class="literal">uri</code>.
See <code class="literal">UriComponents.expand(Object...
uriVariableValues)</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO51-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The <code class="literal">Origin</code> Handshake HTTP header value.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO51-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The WebSocket session <span class="emphasis"><em>send</em></span> timeout limit.
Defaults to <code class="literal">10000</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO51-7"><span><img src="images/callouts/7.png" alt="7" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The WebSocket session <span class="emphasis"><em>send</em></span> message size limit.
Defaults to <code class="literal">524288</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO51-8"><span><img src="images/callouts/8.png" alt="8" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Boolean value indicating whether this endpoint should start automatically.
Defaults to <code class="literal">false</code>, assuming that this container will be started from the <a class="xref" href="#web-socket-inbound-adapter" title="33.3&nbsp;WebSocket Inbound Channel Adapter">Section&nbsp;33.3, &#8220;WebSocket Inbound Channel Adapter&#8221;</a>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO51-9"><span><img src="images/callouts/9.png" alt="9" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The lifecycle phase within which this endpoint should start and stop.
The lower the value the earlier this endpoint will start and the later it will stop.
The default is <code class="literal">Integer.MAX_VALUE</code>.
Values can be negative.
See <code class="literal">SmartLifeCycle</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO51-10"><span><img src="images/callouts/10.png" alt="10" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A <code class="literal">Map</code> of <code class="literal">HttpHeaders</code> to be used with the Handshake request.</p>
</td></tr></table></div>
<p><span class="strong"><strong>&lt;int-websocket:server-container&gt;</strong></span></p>
<pre class="programlisting"><span class="hl-tag">&lt;int-websocket:server-container</span>
					<span class="hl-attribute">id</span>=<span class="hl-value">""</span>  <a name="CO52-1" href="#CO52-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
					path=""  <a name="CO52-2" href="#CO52-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
					handshake-handler=""  <a name="CO52-3" href="#CO52-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
					handshake-interceptors=""  <a name="CO52-4" href="#CO52-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
					decorator-factories=""  <a name="CO52-5" href="#CO52-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
					send-time-limit=""  <a name="CO52-6" href="#CO52-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>
					send-buffer-size-limit=""  <a name="CO52-7" href="#CO52-7"></a><span><img src="images/callouts/7.png" alt="7" border="0"></span>
					allowed-origins=""&gt;  <a name="CO52-8" href="#CO52-8"></a><span><img src="images/callouts/8.png" alt="8" border="0"></span>
				  <span class="hl-tag">&lt;int-websocket:sockjs</span>
						<span class="hl-attribute">client-library-url</span>=<span class="hl-value">""</span>   <a name="CO52-9" href="#CO52-9"></a><span><img src="images/callouts/9.png" alt="9" border="0"></span>
						stream-bytes-limit=""   <a name="CO52-10" href="#CO52-10"></a><span><img src="images/callouts/10.png" alt="10" border="0"></span>
						session-cookie-needed=""   <a name="CO52-11" href="#CO52-11"></a><span><img src="images/callouts/11.png" alt="11" border="0"></span>
						heartbeat-time=""   <a name="CO52-12" href="#CO52-12"></a><span><img src="images/callouts/12.png" alt="12" border="0"></span>
						disconnect-delay=""   <a name="CO52-13" href="#CO52-13"></a><span><img src="images/callouts/13.png" alt="13" border="0"></span>
						message-cache-size=""   <a name="CO52-14" href="#CO52-14"></a><span><img src="images/callouts/14.png" alt="14" border="0"></span>
						websocket-enabled=""   <a name="CO52-15" href="#CO52-15"></a><span><img src="images/callouts/15.png" alt="15" border="0"></span>
						scheduler=""   <a name="CO52-16" href="#CO52-16"></a>(16)
						message-codec=""   <a name="CO52-17" href="#CO52-17"></a>(17)
						transport-handlers=""  <a name="CO52-18" href="#CO52-18"></a>(18)
						suppress-cors="true"="" /&gt;  <a name="CO52-19" href="#CO52-19"></a>(19)
<span class="hl-tag">&lt;/int-websocket:server-container&gt;</span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO52-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The component bean name.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO52-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A path (or comma-separated paths) that maps a particular request to a <code class="literal">WebSocketHandler</code>.
Exact path mapping URIs (such as <code class="literal">"/myPath"</code>) are supported as well as ant-style path patterns (such as <code class="literal">/myPath/**</code>).</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO52-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The <code class="literal">HandshakeHandler</code> bean reference.
Default to <code class="literal">DefaultHandshakeHandler</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO52-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>List of <code class="literal">HandshakeInterceptor</code> bean references.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO52-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Configure one or more factories (<code class="literal">WebSocketHandlerDecoratorFactory</code>) to decorate the handler
used to process WebSocket messages.
This may be useful for some advanced use cases, for example to allow Spring Security to forcibly close
the WebSocket session when the corresponding HTTP session expires.
See <a class="ulink" href="http://docs.spring.io/spring-session/docs/current/reference/html5/#websocket" target="_top">Spring Session Project</a>
for more information.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO52-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>See the same option on the <code class="literal">&lt;int-websocket:client-container&gt;</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO52-7"><span><img src="images/callouts/7.png" alt="7" border="0"></span></a> </p></td><td valign="top" align="left">
<p>See the same option on the <code class="literal">&lt;int-websocket:client-container&gt;</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO52-8"><span><img src="images/callouts/8.png" alt="8" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Configure allowed Origin header values. Multiple origins may be specified as a comma-separated list.
This check is mostly designed for browser clients.
There is noting preventing other types of client to modify the Origin header value.
When SockJS is enabled and allowed origins are restricted, transport types that do not use Origin headers for cross origin requests (jsonp-polling, iframe-xhr-polling, iframe-eventsource and iframe-htmlfile) are disabled.
As a consequence, IE6/IE7 are not supported and IE8/IE9 will only be supported without cookies.
By default, all origins are allowed.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO52-9"><span><img src="images/callouts/9.png" alt="9" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Transports with no native cross-domain communication (e.g.
"eventsource", "htmlfile") must get a simple page from the "foreign" domain in an invisible iframe so that code in the iframe can run from a domain local to the SockJS server.
Since the iframe needs to load the SockJS javascript client library, this property allows specifying where to load it from.
By default this is set to point to <code class="literal">https://d1fxtkz8shb9d2.cloudfront.net/sockjs-0.3.4.min.js</code>.
However it can also be set to point to a URL served by the application.
Note that it&#8217;s possible to specify a relative URL in which case the URL must be relative to the iframe URL.
For example assuming a SockJS endpoint mapped to "/sockjs", and resulting iframe URL "/sockjs/iframe.html", then the The relative URL must start with "../../" to traverse up to the location above the SockJS mapping.
In case of a prefix-based Servlet mapping one more traversal may be needed.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO52-10"><span><img src="images/callouts/10.png" alt="10" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Minimum number of bytes that can be send over a single HTTP streaming request before it will be closed.
Defaults to <code class="literal">128K</code> (i.e.
128*1024 bytes).</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO52-11"><span><img src="images/callouts/11.png" alt="11" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The "cookie_needed" value in the response from the SockJs <code class="literal">"/info"</code> endpoint.
This property indicates whether the use of a JSESSIONID cookie is required for the application to function correctly, e.g.
for load balancing or in Java Servlet containers for the use of an HTTP session.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO52-12"><span><img src="images/callouts/12.png" alt="12" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The amount of time in milliseconds when the server has not sent any messages and after which the server should
send a heartbeat frame to the client in order to keep the connection from breaking.
The default value is <code class="literal">25,000</code> (25 seconds).</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO52-13"><span><img src="images/callouts/13.png" alt="13" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The amount of time in milliseconds before a client is considered disconnected after not having a receiving
connection, i.e.
an active connection over which the server can send data to the client.
The default value is <code class="literal">5000</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO52-14"><span><img src="images/callouts/14.png" alt="14" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The number of server-to-client messages that a session can cache while waiting for the next HTTP polling request
 from the client.
The default size is <code class="literal">100</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO52-15"><span><img src="images/callouts/15.png" alt="15" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Some load balancers don&#8217;t support websockets.
Set this option to <code class="literal">false</code> to disable the WebSocket transport on the server side.
The default value is <code class="literal">true</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO52-16">(16)</a> </p></td><td valign="top" align="left">
<p>The <code class="literal">TaskScheduler</code> bean reference; a new <code class="literal">ThreadPoolTaskScheduler</code> instance will be created if no value is
provided.
This scheduler instance will be used for scheduling heart-beat messages.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO52-17">(17)</a> </p></td><td valign="top" align="left">
<p>The <code class="literal">SockJsMessageCodec</code> bean reference to use for encoding and decoding SockJS messages.
By default <code class="literal">Jackson2SockJsMessageCodec</code> is used requiring the Jackson library to be present on the classpath.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO52-18">(18)</a> </p></td><td valign="top" align="left">
<p>List of <code class="literal">TransportHandler</code> bean references.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO52-19">(19)</a> </p></td><td valign="top" align="left">
<p>The option to disable automatic addition of CORS headers for SockJS requests.
The default value is <code class="literal">false</code>.</p>
</td></tr></table></div>
<p><span class="strong"><strong>&lt;int-websocket:outbound-channel-adapter&gt;</strong></span></p>
<pre class="programlisting"><span class="hl-tag">&lt;int-websocket:outbound-channel-adapter</span>
                          <span class="hl-attribute">id</span>=<span class="hl-value">""</span>  <a name="CO53-1" href="#CO53-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
                          channel=""  <a name="CO53-2" href="#CO53-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
                          container=""  <a name="CO53-3" href="#CO53-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
                          default-protocol-handler=""  <a name="CO53-4" href="#CO53-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
                          protocol-handlers=""  <a name="CO53-5" href="#CO53-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
                          message-converters=""  <a name="CO53-6" href="#CO53-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>
                          merge-with-default-converters=""  <a name="CO53-7" href="#CO53-7"></a><span><img src="images/callouts/7.png" alt="7" border="0"></span>
                          auto-startup=""  <a name="CO53-8" href="#CO53-8"></a><span><img src="images/callouts/8.png" alt="8" border="0"></span>
                          phase=""/&gt;  <a name="CO53-9" href="#CO53-9"></a><span><img src="images/callouts/9.png" alt="9" border="0"></span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO53-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The component bean name.
If the <code class="literal">channel</code> attribute isn&#8217;t provided, a <code class="literal">DirectChannel</code> is created and registered with the application context
with this <code class="literal">id</code> attribute as the bean name.
In this case, the endpoint is registered with the bean name <code class="literal">id + '.adapter'</code>.
And the <code class="literal">MessageHandler</code> is registered with the bean alias <code class="literal">id + '.handler'</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO53-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Identifies the channel attached to this adapter.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO53-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The reference to the <code class="literal">IntegrationWebSocketContainer</code> bean, which encapsulates the low-level connection and WebSocketSession handling operations.
Required.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO53-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Optional reference to a <code class="literal">SubProtocolHandler</code> instance.
It is used when the client did not request a sub-protocol or it is a single protocol-handler.
If this reference or <code class="literal">protocol-handlers</code> list aren&#8217;t provided the <code class="literal">PassThruSubProtocolHandler</code> is used by default.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO53-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>List of <code class="literal">SubProtocolHandler</code> bean references for this Channel Adapter.
If only a single bean reference is provided and a <code class="literal">default-protocol-handler</code> isn&#8217;t provided, that single <code class="literal">SubProtocolHandler</code> will be used as the <code class="literal">default-protocol-handler</code>.
If this attribute or <code class="literal">default-protocol-handler</code> aren&#8217;t provided, the <code class="literal">PassThruSubProtocolHandler</code> is used by default.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO53-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>List of <code class="literal">MessageConverter</code> bean references for this Channel Adapter.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO53-7"><span><img src="images/callouts/7.png" alt="7" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Flag to indicate if the default converters should be registered after any custom converters.
This flag is used only if <code class="literal">message-converters</code> are provided, otherwise all default converters will be registered.
Defaults to <code class="literal">false</code>.
The default converters are (in the order): <code class="literal">StringMessageConverter</code>, <code class="literal">ByteArrayMessageConverter</code> and <code class="literal">MappingJackson2MessageConverter</code> if the Jackson library is present on the classpath.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO53-8"><span><img src="images/callouts/8.png" alt="8" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Boolean value indicating whether this endpoint should start automatically.
Default to <code class="literal">true</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO53-9"><span><img src="images/callouts/9.png" alt="9" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The lifecycle phase within which this endpoint should start and stop.
The lower the value the earlier this endpoint will start and the later it will stop.
The default is <code class="literal">Integer.MIN_VALUE</code>.
Values can be negative.
See <code class="literal">SmartLifeCycle</code>.</p>
</td></tr></table></div>
<p><span class="strong"><strong>&lt;int-websocket:inbound-channel-adapter&gt;</strong></span></p>
<pre class="programlisting"><span class="hl-tag">&lt;int-websocket:inbound-channel-adapter</span>
                            <span class="hl-attribute">id</span>=<span class="hl-value">""</span>  <a name="CO54-1" href="#CO54-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
                            channel=""  <a name="CO54-2" href="#CO54-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
                            error-channel=""  <a name="CO54-3" href="#CO54-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
                            container=""  <a name="CO54-4" href="#CO54-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
                            default-protocol-handler=""  <a name="CO54-5" href="#CO54-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
                            protocol-handlers=""  <a name="CO54-6" href="#CO54-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>
                            message-converters=""  <a name="CO54-7" href="#CO54-7"></a><span><img src="images/callouts/7.png" alt="7" border="0"></span>
                            merge-with-default-converters=""  <a name="CO54-8" href="#CO54-8"></a><span><img src="images/callouts/8.png" alt="8" border="0"></span>
                            send-timeout=""  <a name="CO54-9" href="#CO54-9"></a><span><img src="images/callouts/9.png" alt="9" border="0"></span>
                            payload-type=""  <a name="CO54-10" href="#CO54-10"></a><span><img src="images/callouts/10.png" alt="10" border="0"></span>
                            use-broker=""  <a name="CO54-11" href="#CO54-11"></a><span><img src="images/callouts/11.png" alt="11" border="0"></span>
                            auto-startup=""  <a name="CO54-12" href="#CO54-12"></a><span><img src="images/callouts/12.png" alt="12" border="0"></span>
                            phase=""/&gt;  <a name="CO54-13" href="#CO54-13"></a><span><img src="images/callouts/13.png" alt="13" border="0"></span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO54-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The component bean name.
If the <code class="literal">channel</code> attribute isn&#8217;t provided, a <code class="literal">DirectChannel</code> is created and registered with the application context with this <code class="literal">id</code> attribute as the bean name.
In this case, the endpoint is registered with the bean name <code class="literal">id + '.adapter'</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO54-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Identifies the channel attached to this adapter.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO54-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The <code class="literal">MessageChannel</code> bean reference to which the <code class="literal">ErrorMessages</code> should be sent.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO54-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>See the same option on the <code class="literal">&lt;int-websocket:outbound-channel-adapter&gt;</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO54-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>See the same option on the <code class="literal">&lt;int-websocket:outbound-channel-adapter&gt;</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO54-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>See the same option on the <code class="literal">&lt;int-websocket:outbound-channel-adapter&gt;</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO54-7"><span><img src="images/callouts/7.png" alt="7" border="0"></span></a> </p></td><td valign="top" align="left">
<p>See the same option on the <code class="literal">&lt;int-websocket:outbound-channel-adapter&gt;</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO54-8"><span><img src="images/callouts/8.png" alt="8" border="0"></span></a> </p></td><td valign="top" align="left">
<p>See the same option on the <code class="literal">&lt;int-websocket:outbound-channel-adapter&gt;</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO54-9"><span><img src="images/callouts/9.png" alt="9" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Maximum amount of time in milliseconds to wait when sending a message to the channel if the channel may block.
For example, a <code class="literal">QueueChannel</code> can block until space is available if its maximum capacity has been reached.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO54-10"><span><img src="images/callouts/10.png" alt="10" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Fully qualified name of the java type for the target <code class="literal">payload</code> to convert from the incoming <code class="literal">WebSocketMessage</code>.
Default to <code class="literal">String</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO54-11"><span><img src="images/callouts/11.png" alt="11" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Flag to indicate if this adapter will send <code class="literal">non-MESSAGE</code> <code class="literal">WebSocketMessage</code> s and messages with broker destinations to the <code class="literal">AbstractBrokerMessageHandler</code> from the application context.
The <code class="literal">Broker Relay</code> configuration is required when this attribute is <code class="literal">true</code>.
This attribute is used only on the server side.
On the client side, it is ignored.
Defaults to <code class="literal">false</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO54-12"><span><img src="images/callouts/12.png" alt="12" border="0"></span></a> </p></td><td valign="top" align="left">
<p>See the same option on the <code class="literal">&lt;int-websocket:outbound-channel-adapter&gt;</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO54-13"><span><img src="images/callouts/13.png" alt="13" border="0"></span></a> </p></td><td valign="top" align="left">
<p>See the same option on the <code class="literal">&lt;int-websocket:outbound-channel-adapter&gt;</code>.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="client-stomp-encoder" href="#client-stomp-encoder"></a>33.6&nbsp;ClientStompEncoder</h2></div></div></div>

<p>Starting with <span class="emphasis"><em>version 4.3.13</em></span>, the <code class="literal">ClientStompEncoder</code> is provided as an extension of standard <code class="literal">StompEncoder</code> for using on client side of the WebSocket Channel Adapters.
An instance of the <code class="literal">ClientStompEncoder</code> must be injected into the <code class="literal">StompSubProtocolHandler</code> for proper client side message preparation.
One of the problem of the default <code class="literal">StompSubProtocolHandler</code> that it was designed for the server side, so it updates the <code class="literal">SEND</code> <code class="literal">stompCommand</code> header into <code class="literal">MESSAGE</code> as it must be by the STOMP protocol from server side.
If client doesn&#8217;t send its messages in the proper <code class="literal">SEND</code> web socket frame, some STOMP brokers won&#8217;t accept them.
The purpose of the <code class="literal">ClientStompEncoder</code>, in this case, is to override <code class="literal">stompCommand</code> header to the <code class="literal">SEND</code> value before encoding the message to the <code class="literal">byte[]</code>.</p>
</div>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="ws" href="#ws"></a>34.&nbsp;Web Services Support</h2></div></div></div>

<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="webservices-outbound" href="#webservices-outbound"></a>34.1&nbsp;Outbound Web Service Gateways</h2></div></div></div>

<p>To invoke a Web Service upon sending a message to a channel, there are two options - both of which build upon the <a class="ulink" href="http://projects.spring.io/spring-ws/" target="_top">Spring Web Services</a> project: <code class="literal">SimpleWebServiceOutboundGateway</code> and <code class="literal">MarshallingWebServiceOutboundGateway</code>.
The former will accept either a <code class="literal">String</code> or <code class="literal">javax.xml.transform.Source</code> as the message payload.
The latter provides support for any implementation of the <code class="literal">Marshaller</code> and <code class="literal">Unmarshaller</code> interfaces.
Both require a Spring Web Services <code class="literal">DestinationProvider</code> for determining the URI of the Web Service to be called.</p>
<pre class="programlisting"> simpleGateway = <span class="hl-keyword">new</span> SimpleWebServiceOutboundGateway(destinationProvider);

 marshallingGateway = <span class="hl-keyword">new</span> MarshallingWebServiceOutboundGateway(destinationProvider, marshaller);</pre>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>When using the namespace support described below, you will only need to set a URI.
Internally, the parser will configure a fixed URI <code class="literal">DestinationProvider</code> implementation.
If you do need dynamic resolution of the URI at runtime, however, then the <code class="literal">DestinationProvider</code> can provide such behavior as looking up the URI from a registry.
See the Spring Web Services <a class="ulink" href="http://docs.spring.io/spring-ws/docs/current/api/org/springframework/ws/client/support/destination/DestinationProvider.html" target="_top">DestinationProvider</a> JavaDoc for more information about this strategy.</p>
</td></tr></table></div>
<p>For more detail on the inner workings, see the Spring Web Services reference guide&#8217;s chapter covering <a class="ulink" href="http://docs.spring.io/spring-ws/docs/current/reference/html/client.html" target="_top">client access</a> as well as the chapter covering <a class="ulink" href="http://static.springframework.org/spring-ws/site/reference/html/oxm.html" target="_top">Object/XML mapping</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="webservices-inbound" href="#webservices-inbound"></a>34.2&nbsp;Inbound Web Service Gateways</h2></div></div></div>

<p>To send a message to a channel upon receiving a Web Service invocation, there are two options again: <code class="literal">SimpleWebServiceInboundGateway</code> and <code class="literal">MarshallingWebServiceInboundGateway</code>.
The former will extract a <code class="literal">javax.xml.transform.Source</code> from the <code class="literal">WebServiceMessage</code> and set it as the message payload.
The latter provides support for implementation of the <code class="literal">Marshaller</code> and <code class="literal">Unmarshaller</code> interfaces.
If the incoming web service message is a SOAP message the SOAP Action header will be added to the headers of the`Message` that is forwarded onto the request channel.</p>
<pre class="programlisting"> simpleGateway = <span class="hl-keyword">new</span> SimpleWebServiceInboundGateway();
 simpleGateway.setRequestChannel(forwardOntoThisChannel);
 simpleGateway.setReplyChannel(listenForResponseHere); <span class="hl-comment">//Optional</span>

 marshallingGateway = <span class="hl-keyword">new</span> MarshallingWebServiceInboundGateway(marshaller);
 <span class="hl-comment">//set request and optionally reply channel</span></pre>
<p>Both gateways implement the Spring Web Services <code class="literal">MessageEndpoint</code> interface, so they can be configured with a <code class="literal">MessageDispatcherServlet</code> as per standard Spring Web Services configuration.</p>
<p>For more detail on how to use these components, see the Spring Web Services reference guide&#8217;s chapter covering <a class="ulink" href="http://docs.spring.io/spring-ws/docs/current/reference/html/server.html" target="_top">creating a Web Service</a>.
The chapter covering <a class="ulink" href="http://docs.spring.io/spring/docs/current/spring-framework-reference/html/oxm.html" target="_top">Object/XML mapping</a> is also applicable again.</p>
<p>To include the <code class="literal">SimpleWebServiceInboundGateway</code> and <code class="literal">MarshallingWebServiceInboundGateway</code> configurations to the Spring WS
infrastructure you should add the <code class="literal">EndpointMapping</code> definition between <code class="literal">MessageDispatcherServlet</code> and the target
<code class="literal">MessageEndpoint</code> implementations like you do that with normal Spring WS application.
For this purpose (from Spring Integration perspective), the Spring WS provides these convenient <code class="literal">EndpointMapping</code>
implementations:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">o.s.ws.server.endpoint.mapping.UriEndpointMapping</code>
</li><li class="listitem">
<code class="literal">o.s.ws.server.endpoint.mapping.PayloadRootQNameEndpointMapping</code>
</li><li class="listitem">
<code class="literal">o.s.ws.soap.server.endpoint.mapping.SoapActionEndpointMapping</code>
</li><li class="listitem">
<code class="literal">o.s.ws.server.endpoint.mapping.XPathPayloadEndpointMapping</code>
</li></ul></div>
<p>The beans for these classes must be specified in the application context referencing to the
<code class="literal">SimpleWebServiceInboundGateway</code> and/or <code class="literal">MarshallingWebServiceInboundGateway</code> bean definitions according to the WS
mapping algorithm.</p>
<p>Please, refer to the <a class="ulink" href="http://docs.spring.io/spring-ws/docs/current/reference/html/server.html#server-endpoint-mapping" target="_top">Endpoint mappings</a>
for the more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="webservices-namespace" href="#webservices-namespace"></a>34.3&nbsp;Web Service Namespace Support</h2></div></div></div>

<p>To configure an outbound Web Service Gateway, use the "outbound-gateway" element from the "ws" namespace:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-ws:outbound-gateway</span> <span class="hl-attribute">id</span>=<span class="hl-value">"simpleGateway"</span>
                     <span class="hl-attribute">request-channel</span>=<span class="hl-value">"inputChannel"</span>
                     <span class="hl-attribute">uri</span>=<span class="hl-value">"http://example.org"</span><span class="hl-tag">/&gt;</span></pre>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Notice that this example does not provide a <span class="emphasis"><em>reply-channel</em></span>.
If the Web Service were to return a non-empty response, the Message containing that response would be sent to the reply
channel provided in the request Message&#8217;s <code class="literal">REPLY_CHANNEL</code> header, and if that were not available a channel resolution Exception would be thrown.
If you want to send the reply to another channel instead, then provide a <span class="emphasis"><em>reply-channel</em></span> attribute on the <span class="emphasis"><em>outbound-gateway</em></span> element.</p>
</td></tr></table></div>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>When invoking a Web Service that returns an empty response after using a String payload for the request Message, <span class="emphasis"><em>no reply Message will be sent by default</em></span>.
Therefore you don&#8217;t need to set a <span class="emphasis"><em>reply-channel</em></span> or have a REPLY_CHANNEL header in the request Message.
If for any reason you actually <span class="emphasis"><em>do</em></span> want to receive the empty response as a Message, then provide the <span class="emphasis"><em>ignore-empty-responses</em></span> attribute with a value of <span class="emphasis"><em>false</em></span> (this only applies for Strings, because using a Source or Document object simply leads to a NULL response and will therefore <span class="emphasis"><em>never</em></span> generate a reply Message).</p>
</td></tr></table></div>
<p>To set up an inbound Web Service Gateway, use the "inbound-gateway":</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-ws:inbound-gateway</span> <span class="hl-attribute">id</span>=<span class="hl-value">"simpleGateway"</span>
                    <span class="hl-attribute">request-channel</span>=<span class="hl-value">"inputChannel"</span><span class="hl-tag">/&gt;</span></pre>
<p>To use Spring OXM Marshallers and/or Unmarshallers, provide bean references.
For outbound:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-ws:outbound-gateway</span> <span class="hl-attribute">id</span>=<span class="hl-value">"marshallingGateway"</span>
                     <span class="hl-attribute">request-channel</span>=<span class="hl-value">"requestChannel"</span>
                     <span class="hl-attribute">uri</span>=<span class="hl-value">"http://example.org"</span>
                     <span class="hl-attribute">marshaller</span>=<span class="hl-value">"someMarshaller"</span>
                     <span class="hl-attribute">unmarshaller</span>=<span class="hl-value">"someUnmarshaller"</span><span class="hl-tag">/&gt;</span></pre>
<p>And for inbound:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-ws:inbound-gateway</span> <span class="hl-attribute">id</span>=<span class="hl-value">"marshallingGateway"</span>
                    <span class="hl-attribute">request-channel</span>=<span class="hl-value">"requestChannel"</span>
                    <span class="hl-attribute">marshaller</span>=<span class="hl-value">"someMarshaller"</span>
                    <span class="hl-attribute">unmarshaller</span>=<span class="hl-value">"someUnmarshaller"</span><span class="hl-tag">/&gt;</span></pre>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Most <code class="literal">Marshaller</code> implementations also implement the <code class="literal">Unmarshaller</code> interface.
When using such a <code class="literal">Marshaller</code>, only the "marshaller" attribute is necessary.
Even when using a <code class="literal">Marshaller</code>, you may also provide a reference for the "request-callback" on the outbound gateways.</p>
</td></tr></table></div>
<p>For either outbound gateway type, a "destination-provider" attribute can be specified instead of the "uri" (exactly one of them is required).
You can then reference any Spring Web Services DestinationProvider implementation (e.g.
to lookup the URI at runtime from a registry).</p>
<p>For either outbound gateway type, the "message-factory" attribute can also be configured with a reference to any Spring Web Services <code class="literal">WebServiceMessageFactory</code> implementation.</p>
<p>For the simple inbound gateway type, the "extract-payload" attribute can be set to false to forward the entire <code class="literal">WebServiceMessage</code> instead of just its payload as a <code class="literal">Message</code> to the request channel.
This might be useful, for example, when a custom Transformer works against the <code class="literal">WebServiceMessage</code> directly.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="outbound-uri" href="#outbound-uri"></a>34.4&nbsp;Outbound URI Configuration</h2></div></div></div>

<p>For all URI-schemes supported by Spring Web Services (<a class="ulink" href="http://docs.spring.io/spring-ws/docs/current/reference/html/client.html#client-transports" target="_top">URIs and Transports</a>) <code class="literal">&lt;uri-variable/&gt;</code> substitution is provided:</p>
<pre class="programlisting"><span class="hl-tag">&lt;ws:outbound-gateway</span> <span class="hl-attribute">id</span>=<span class="hl-value">"gateway"</span> <span class="hl-attribute">request-channel</span>=<span class="hl-value">"input"</span>
        <span class="hl-attribute">uri</span>=<span class="hl-value">"http://springsource.org/{foo}-{bar}"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;ws:uri-variable</span> <span class="hl-attribute">name</span>=<span class="hl-value">"foo"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"payload.substring(1,7)"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;ws:uri-variable</span> <span class="hl-attribute">name</span>=<span class="hl-value">"bar"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"headers.x"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/ws:outbound-gateway&gt;</span>

<span class="hl-tag">&lt;ws:outbound-gateway</span> <span class="hl-attribute">request-channel</span>=<span class="hl-value">"inputJms"</span>
        <span class="hl-attribute">uri</span>=<span class="hl-value">"jms:{destination}?deliveryMode={deliveryMode}&amp;amp;priority={priority}"</span>
        <span class="hl-attribute">message-sender</span>=<span class="hl-value">"jmsMessageSender"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;ws:uri-variable</span> <span class="hl-attribute">name</span>=<span class="hl-value">"destination"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"headers.jmsQueue"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;ws:uri-variable</span> <span class="hl-attribute">name</span>=<span class="hl-value">"deliveryMode"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"headers.deliveryMode"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;ws:uri-variable</span> <span class="hl-attribute">name</span>=<span class="hl-value">"priority"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"headers.jms_priority"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/ws:outbound-gateway&gt;</span></pre>
<p>If a <code class="literal">DestinationProvider</code> is supplied, variable substitution is not supported and a configuration error will result if variables are provided.</p>
<p><span class="emphasis"><em>Controlling URI Encoding</em></span></p>
<p>By default, the URL string is encoded (see <a class="ulink" href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/web/util/UriComponentsBuilder.html" target="_top">UriComponentsBuilder</a>) to the URI object before sending the request.
In some scenarios with a non-standard URI it is undesirable to perform the encoding.
Since <span class="emphasis"><em>version 4.1</em></span> the <code class="literal">&lt;ws:outbound-gateway/&gt;</code> provides an <code class="literal">encode-uri</code> attribute.
To disable encoding the URL, this attribute should be set to <code class="literal">false</code> (by default it is <code class="literal">true</code>).
If you wish to partially encode some of the URL, this can be achieved using an <code class="literal">expression</code> within a <code class="literal">&lt;uri-variable/&gt;</code>:</p>
<pre class="programlisting"><span class="hl-tag">&lt;ws:outbound-gateway</span> <span class="hl-attribute">url</span>=<span class="hl-value">"http://somehost/%2f/fooApps?bar={param}"</span> <span class="hl-attribute">encode-uri</span>=<span class="hl-value">"false"</span><span class="hl-tag">&gt;</span>
          <span class="hl-tag">&lt;http:uri-variable</span> <span class="hl-attribute">name</span>=<span class="hl-value">"param"</span>
            <span class="hl-attribute">expression</span>=<span class="hl-value">"T(org.apache.commons.httpclient.util.URIUtil)
                                             .encodeWithinQuery('Hello World!')"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/ws:outbound-gateway&gt;</span></pre>
<p>Note, <code class="literal">encode-uri</code> is ignored, if <code class="literal">DestinationProvider</code> is supplied.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="ws-message-headers" href="#ws-message-headers"></a>34.5&nbsp;WS Message Headers</h2></div></div></div>

<p>The Spring Integration WebService Gateways will map the SOAP Action header automatically.
It will be copied by default to and from Spring Integration <code class="literal">MessageHeaders</code> using the
<a class="ulink" href="http://docs.spring.io/spring-integration/api/org/springframework/integration/ws/DefaultSoapHeaderMapper.html" target="_top">DefaultSoapHeaderMapper</a>.</p>
<p>Of course, you can pass in your own implementation of SOAP specific header mappers, as the gateways have respective
properties to support that.</p>
<p>Any user-defined SOAP headers will NOT
be copied to or from a SOAP Message, unless explicitly specified by the <span class="emphasis"><em>requestHeaderNames</em></span> and/or
<span class="emphasis"><em>replyHeaderNames</em></span> properties of the <code class="literal">DefaultSoapHeaderMapper</code>.</p>
<p>When using the XML namespace for configuration, these properties can be set using the <code class="literal">mapped-request-headers</code> and
<code class="literal">mapped-reply-headers</code>, or a custom mapper can be provided using the <code class="literal">header-mapper</code> attribute.</p>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>When mapping user-defined headers, the values can also contain simple wildcard patterns (e.g. "foo*" or "*foo") to be matched.
For example, if you need to copy all user-defined headers simply use the wildcard character <code class="literal">*</code>.</p>
</td></tr></table></div>
<p>Starting with <span class="emphasis"><em>version 4.1</em></span>, the <code class="literal">AbstractHeaderMapper</code> (a <code class="literal">DefaultSoapHeaderMapper</code> superclass) allows the
<code class="literal">NON_STANDARD_HEADERS</code> token to be configured for the <span class="emphasis"><em>requestHeaderNames</em></span> and/or <span class="emphasis"><em>replyHeaderNames</em></span>
properties (in addition to existing <code class="literal">STANDARD_REQUEST_HEADERS</code> and <code class="literal">STANDARD_REPLY_HEADERS</code>) to map all
user-defined headers.
Note, it is recommended to use the combination like this <code class="literal">STANDARD_REPLY_HEADERS, NON_STANDARD_HEADERS</code> instead of a
<code class="literal">*</code>, to avoid mapping of <span class="emphasis"><em>request</em></span> headers to the reply.</p>
<p>Starting with <span class="emphasis"><em>version 4.3</em></span>, patterns in the header mappings can be negated by preceding the pattern with <code class="literal">!</code>.
Negated patterns get priority, so a list such as
<code class="literal">STANDARD_REQUEST_HEADERS,foo,ba*,!bar,!baz,qux,!foo</code> will <span class="strong"><strong>NOT</strong></span> map <code class="literal">foo</code>
(nor <code class="literal">bar</code> nor <code class="literal">baz</code>); the standard headers plus <code class="literal">bad</code>, <code class="literal">qux</code> will be mapped.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>If you have a user defined header that begins with <code class="literal">!</code> that you <span class="strong"><strong>do</strong></span> wish to map, you need to escape it with
<code class="literal">\</code> thus: <code class="literal">STANDARD_REQUEST_HEADERS,\!myBangHeader</code> and it <span class="strong"><strong>WILL</strong></span> be mapped.</p>
</td></tr></table></div>
<p>Inbound SOAP headers (request headers for the inbound gateway, reply-headers for the outbound gateway) are mapped as
<code class="literal">SoapHeaderElement</code> objects.
The contents can be explored by accessing the <code class="literal">Source</code>:</p>
<pre class="programlisting"><span class="hl-tag">&lt;soapenv:Envelope</span> <span class="hl-attribute">xmlns:soapenv</span>=<span class="hl-value">"http://schemas.xmlsoap.org/soap/envelope/"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;soapenv:Header&gt;</span>
        <span class="hl-tag">&lt;auth&gt;</span>
            <span class="hl-tag">&lt;username&gt;</span>user<span class="hl-tag">&lt;/username&gt;</span>
            <span class="hl-tag">&lt;password&gt;</span>pass<span class="hl-tag">&lt;/password&gt;</span>
        <span class="hl-tag">&lt;/auth&gt;</span>
        <span class="hl-tag">&lt;bar&gt;</span>BAR<span class="hl-tag">&lt;/bar&gt;</span>
        <span class="hl-tag">&lt;baz&gt;</span>BAZ<span class="hl-tag">&lt;/baz&gt;</span>
        <span class="hl-tag">&lt;qux&gt;</span>qux<span class="hl-tag">&lt;/qux&gt;</span>
    <span class="hl-tag">&lt;/soapenv:Header&gt;</span>
    <span class="hl-tag">&lt;soapenv:Body&gt;</span>
        ...
    <span class="hl-tag">&lt;/soapenv:Body&gt;</span>
<span class="hl-tag">&lt;/soapenv:Envelope&gt;</span></pre>
<p>If <code class="literal">mapped-request-headers</code> is <code class="literal">"auth, ba*"</code>, the <code class="literal">auth</code>, <code class="literal">bar</code> and <code class="literal">baz</code> headers are mapped but <code class="literal">qux</code> is not.</p>
<pre class="programlisting">...
SoapHeaderElement header = (SoapHeaderElement) headers.get(<span class="hl-string">"auth"</span>);
DOMSource source = (DOMSource) header.getSource();
NodeList nodeList = source.getNode().getChildNodes();
assertEquals(<span class="hl-string">"username"</span>, nodeList.item(<span class="hl-number">0</span>).getNodeName());
assertEquals(<span class="hl-string">"user"</span>, nodeList.item(<span class="hl-number">0</span>).getFirstChild().getNodeValue());
...</pre>
</div>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="xml" href="#xml"></a>35.&nbsp;XML Support - Dealing with XML Payloads</h2></div></div></div>

<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xml-intro" href="#xml-intro"></a>35.1&nbsp;Introduction</h2></div></div></div>

<p>Spring Integration&#8217;s XML support extends the core of Spring Integration with the following components:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="emphasis"><em><a class="link" href="#xml-transformation" title="35.3&nbsp;Transforming XML Payloads">Marshalling Transformer</a></em></span>
</li><li class="listitem">
<span class="emphasis"><em><a class="link" href="#xml-transformation" title="35.3&nbsp;Transforming XML Payloads">Unmarshalling Transformer</a></em></span>
</li><li class="listitem">
<span class="emphasis"><em><a class="link" href="#xml-transformation" title="35.3&nbsp;Transforming XML Payloads">Xslt Transformer</a></em></span>
</li><li class="listitem">
<span class="emphasis"><em><a class="link" href="#xml-xpath-transformer" title="35.4&nbsp;Transforming XML Messages Using XPath">XPath Transformer</a></em></span>
</li><li class="listitem">
<span class="emphasis"><em><a class="link" href="#xml-xpath-splitting" title="35.5&nbsp;Splitting XML Messages">XPath Splitter</a></em></span>
</li><li class="listitem">
<span class="emphasis"><em><a class="link" href="#xml-xpath-routing" title="35.6&nbsp;Routing XML Messages Using XPath">XPath Router</a></em></span>
</li><li class="listitem">
<span class="emphasis"><em><a class="link" href="#xml-xpath-header-enricher" title="35.7&nbsp;XPath Header Enricher">XPath Header Enricher</a></em></span>
</li><li class="listitem">
<span class="emphasis"><em><a class="link" href="#xml-xpath-filter" title="35.8&nbsp;Using the XPath Filter">XPath Filter</a></em></span>
</li><li class="listitem">
<span class="emphasis"><em><a class="link" href="#xpath-spel-function" title="35.9&nbsp;#xpath SpEL Function">#xpath SpEL Function</a></em></span>
</li><li class="listitem">
<span class="emphasis"><em><a class="link" href="#xml-validating-filter" title="35.10&nbsp;XML Validating Filter">Validating Filter</a></em></span>
</li></ul></div>
<p>These components are designed to make working with XML messages in Spring Integration simple.
The provided messaging components are designed to work with XML represented in a range of formats including instances of <code class="literal">java.lang.String</code>, <code class="literal">org.w3c.dom.Document</code> and <code class="literal">javax.xml.transform.Source</code>.
It should be noted however that where a DOM representation is required, for example in order to evaluate an XPath expression, the <code class="literal">String</code> payload will be converted into the required type and then converted back again to <code class="literal">String</code>.
Components that require an instance of <code class="literal">DocumentBuilder</code> will create a namespace-aware instance if one is not provided.
In cases where you require greater control over document creation, you can provide an appropriately configured instance of <code class="literal">DocumentBuilder</code>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xpath-namespace-support" href="#xpath-namespace-support"></a>35.2&nbsp;Namespace Support</h2></div></div></div>

<p>All components within the Spring Integration XML module provide namespace support.
In order to enable namespace support, you need to import the respective schema for the Spring Integration XML Module.
A typical setup is shown below:</p>
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
  <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
  <span class="hl-attribute">xmlns:int</span>=<span class="hl-value">"http://www.springframework.org/schema/integration"</span>
  <span class="hl-attribute">xmlns:int-xml</span>=<span class="hl-value">"http://www.springframework.org/schema/integration/xml"</span>
  <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"http://www.springframework.org/schema/beans
    http://www.springframework.org/schema/beans/spring-beans.xsd
    http://www.springframework.org/schema/integration
    http://www.springframework.org/schema/integration/spring-integration.xsd
    http://www.springframework.org/schema/integration/xml
    http://www.springframework.org/schema/integration/xml/spring-integration-xml.xsd"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;/beans&gt;</span></pre>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="xml-xpath-expressions" href="#xml-xpath-expressions"></a>35.2.1&nbsp;XPath Expressions</h3></div></div></div>

<p>Many of the components within the Spring Integration XML module work with XPath Expressions.
Each of those components will either reference an XPath Expression that has been defined as top-level element or via a nested <code class="literal">&lt;xpath-expression/&gt;</code> element.</p>
<p>All forms of XPath expressions result in the creation of an <code class="literal">XPathExpression</code> using the Spring <code class="literal">org.springframework.xml.xpath.XPathExpressionFactory</code>.
When creating XPath expressions, the best XPath implementation that is available on the classpath is being used, either JAXP 1.3+ or Jaxen, whereby JAXP is preferred.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Spring Integration under the covers uses the XPath functionality as provided by the <span class="emphasis"><em>Spring Web Services</em></span> project (<a class="ulink" href="http://www.spring.io/spring-ws" target="_top">http://www.spring.io/spring-ws</a>).
Specifically, Spring Web Services' XML module (spring-xml-x.x.x.jar) is being used.
Therefore, for a deeper understanding, please refer to the respective documentation as well at: <a class="ulink" href="http://docs.spring.io/spring-ws/docs/current/reference/html/common.html#xpath" target="_top">http://docs.spring.io/spring-ws/docs/current/reference/html/common.html#xpath</a></p>
</td></tr></table></div>
<p>Here is an overview of all available configuration parameters of the <code class="literal">xpath-expression</code> element:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-xml:xpath-expression</span> <span class="hl-attribute">expression</span>=<span class="hl-value">""</span> <a name="CO55-1" href="#CO55-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
          id=""              <a name="CO55-2" href="#CO55-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
          namespace-map=""   <a name="CO55-3" href="#CO55-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
          ns-prefix=""       <a name="CO55-4" href="#CO55-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
          ns-uri=""&gt;         <a name="CO55-5" href="#CO55-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
    <span class="hl-tag">&lt;map&gt;</span><span class="hl-tag">&lt;/map&gt;</span>              <a name="CO55-6" href="#CO55-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>
<span class="hl-tag">&lt;/int-xml:xpath-expression&gt;</span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO55-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Defines an XPath xpression.
<span class="emphasis"><em>Required</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO55-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The Identifier of the underlying bean definition.
Will be an instance of `org.springframework.xml.xpath.XPathExpression`<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO55-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Reference to a map containing namespaces.
The key of the map defines the namespace prefix and the value of the map sets the namespace URI.
It is not valid to specify both this attribute and the <code class="literal">map</code> sub element, or setting the <code class="literal">ns-prefix</code> and <code class="literal">ns-uri</code> attribute.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO55-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Allows you to set the namspace prefix directly as and attribute on the XPath expression element.
If you set <code class="literal">ns-prefix</code>, you must also set the <code class="literal">ns-uri</code> attribute.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO55-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Allows you to set the namspace URI directly as an attribute on the XPath expression element.
If you set <code class="literal">ns-uri</code>, you must also set the <code class="literal">ns-prefix</code> attribute.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO55-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Defines a map containing namespaces.
Only one map child element is allowed.
The key of the map defines the namespace prefix and the value of the map sets the namespace URI.</p>
</td></tr></table></div>
<p>It is not valid to specify both this sub-element and the <code class="literal">map</code> attribute, or setting the <code class="literal">ns-prefix</code> and <code class="literal">ns-uri</code> attributes.
<span class="emphasis"><em>Optional</em></span>.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_providing_namespaces_optional_to_xpath_expressions" href="#_providing_namespaces_optional_to_xpath_expressions"></a>Providing Namespaces (Optional) to XPath Expressions</h4></div></div></div>

<p>For the XPath Expression Element, namespace information can be optionally provided as configuration parameters.
As such, namespaces can be defined using one of the following 3 choices:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Reference a map using the <code class="literal">namespace-map</code> attribute
</li><li class="listitem">
Provide a map of namespaces using the <code class="literal">map</code> sub-element
</li><li class="listitem">
Specifying the <code class="literal">ns-prefix</code> and the <code class="literal">ns-uri</code> attribute
</li></ul></div>
<p>All three options are mutually exclusive.
Only one option can be set.</p>
<p>Below, please find several different usage examples on how to use XPath expressions using the XML namespace support including the various option for setting the XML namespaces as discussed above.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-xml:xpath-filter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"filterReferencingXPathExpression"</span>
                      <span class="hl-attribute">xpath-expression-ref</span>=<span class="hl-value">"refToXpathExpression"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int-xml:xpath-expression</span> <span class="hl-attribute">id</span>=<span class="hl-value">"refToXpathExpression"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"/name"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int-xml:xpath-filter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"filterWithoutNamespace"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int-xml:xpath-expression</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"/name"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-xml:xpath-filter&gt;</span>

<span class="hl-tag">&lt;int-xml:xpath-filter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"filterWithOneNamespace"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int-xml:xpath-expression</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"/ns1:name"</span>
                              <span class="hl-attribute">ns-prefix</span>=<span class="hl-value">"ns1"</span> <span class="hl-attribute">ns-uri</span>=<span class="hl-value">"www.example.org"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-xml:xpath-filter&gt;</span>

<span class="hl-tag">&lt;int-xml:xpath-filter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"filterWithTwoNamespaces"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int-xml:xpath-expression</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"/ns1:name/ns2:type"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;map&gt;</span>
            <span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"ns1"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"www.example.org/one"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"ns2"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"www.example.org/two"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/map&gt;</span>
    <span class="hl-tag">&lt;/int-xml:xpath-expression&gt;</span>
<span class="hl-tag">&lt;/int-xml:xpath-filter&gt;</span>

<span class="hl-tag">&lt;int-xml:xpath-filter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"filterWithNamespaceMapReference"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int-xml:xpath-expression</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"/ns1:name/ns2:type"</span>
                              <span class="hl-attribute">namespace-map</span>=<span class="hl-value">"defaultNamespaces"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-xml:xpath-filter&gt;</span>

<span class="hl-tag">&lt;util:map</span> <span class="hl-attribute">id</span>=<span class="hl-value">"defaultNamespaces"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;util:entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"ns1"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"www.example.org/one"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;util:entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"ns2"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"www.example.org/two"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/util:map&gt;</span></pre>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_using_xpath_expressions_with_default_namespaces" href="#_using_xpath_expressions_with_default_namespaces"></a>Using XPath Expressions with Default Namespaces</h4></div></div></div>

<p>When working with default namespaces, you may run into situations that behave differently than originally expected.
Let&#8217;s assume we have the following XML document:</p>
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;order&gt;</span>
    <span class="hl-tag">&lt;orderItem&gt;</span>
        <span class="hl-tag">&lt;isbn&gt;</span>0321200683<span class="hl-tag">&lt;/isbn&gt;</span>
        <span class="hl-tag">&lt;quantity&gt;</span>2<span class="hl-tag">&lt;/quantity&gt;</span>
    <span class="hl-tag">&lt;/orderItem&gt;</span>
    <span class="hl-tag">&lt;orderItem&gt;</span>
        <span class="hl-tag">&lt;isbn&gt;</span>1590596439<span class="hl-tag">&lt;/isbn&gt;</span>
        <span class="hl-tag">&lt;quantity&gt;</span>1<span class="hl-tag">&lt;/quantity&gt;</span>
    <span class="hl-tag">&lt;/orderItem&gt;</span>
<span class="hl-tag">&lt;/order&gt;</span></pre>
<p>This document is not declaring any namespace.
Therefore, applying the following XPath Expression will work as expected:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-xml:xpath-expression</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"/order/orderItem"</span><span class="hl-tag"> /&gt;</span></pre>
<p>You might expect that the same expression will also work for the following XML file.
It looks exactly the same as the previous example but in addition it also declares a default namespace:</p>
<p><span class="emphasis"><em><a class="ulink" href="http://www.example.org/orders" target="_top">http://www.example.org/orders</a></em></span></p>
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;order</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.example.org/orders"</span><span class="hl-tag">&gt;</span>
	<span class="hl-tag">&lt;orderItem&gt;</span>
		<span class="hl-tag">&lt;isbn&gt;</span>0321200683<span class="hl-tag">&lt;/isbn&gt;</span>
		<span class="hl-tag">&lt;quantity&gt;</span>2<span class="hl-tag">&lt;/quantity&gt;</span>
	<span class="hl-tag">&lt;/orderItem&gt;</span>
	<span class="hl-tag">&lt;orderItem&gt;</span>
		<span class="hl-tag">&lt;isbn&gt;</span>1590596439<span class="hl-tag">&lt;/isbn&gt;</span>
		<span class="hl-tag">&lt;quantity&gt;</span>1<span class="hl-tag">&lt;/quantity&gt;</span>
	<span class="hl-tag">&lt;/orderItem&gt;</span>
<span class="hl-tag">&lt;/order&gt;</span></pre>
<p>However, the XPath Expression used previously will fail in this case.</p>
<p>In order to solve this issue, you must provide a namespace prefix and a namespace URI using either the <span class="emphasis"><em>ns-prefix</em></span> and <span class="emphasis"><em>ns-uri</em></span> attribute or by providing a <span class="emphasis"><em>namespace-map</em></span> attribute instead.
The namespace URI must match the namespace declared in your XML document, which in this example is <span class="emphasis"><em><a class="ulink" href="http://www.example.org/orders" target="_top">http://www.example.org/orders</a></em></span>.</p>
<p>The namespace prefix, however, can be arbitrarily chosen.
In fact, just providing an empty String will actually work (Null is not allowed).
In the case of a namespace prefix consisting of an empty String, your Xpath Expression will use a colon (":") to indicate the default namespace.
If you leave the colon off, the XPath expression will not match.
The following XPath Expression will match against the XML document above:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-xml:xpath-expression</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"/:order/:orderItem"</span>
    <span class="hl-attribute">ns-prefix</span>=<span class="hl-value">""</span> <span class="hl-attribute">ns-uri</span>=<span class="hl-value">"http://www.example.org/prodcuts"</span><span class="hl-tag">/&gt;</span></pre>
<p>Of course you can also provide any other arbitrarily chosen namespace prefix.
The following XPath expression using the <span class="emphasis"><em>myorder</em></span> namespace prefix will match also:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-xml:xpath-expression</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"/myorder:order/myorder:orderItem"</span>
    <span class="hl-attribute">ns-prefix</span>=<span class="hl-value">"myorder"</span> <span class="hl-attribute">ns-uri</span>=<span class="hl-value">"http://www.example.org/prodcuts"</span><span class="hl-tag">/&gt;</span></pre>
<p>It is important to remember that the namespace URI is the really important piece of information to declare, not the prefix itself.
The <a class="ulink" href="http://jaxen.codehaus.org/faq.html" target="_top">Jaxen FAQ</a> summarizes the point very well:</p>
<div class="blockquote"><blockquote class="blockquote">
<p>In XPath 1.0, all unprefixed names are unqualified.
There is no requirement that the prefixes used in the XPath expression are the same as the prefixes used in the document being queried.
Only the namespace URIs need to match, not the prefixes.</p>
</blockquote></div>
</div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xml-transformation" href="#xml-transformation"></a>35.3&nbsp;Transforming XML Payloads</h2></div></div></div>

<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="xml-transformation-beans" href="#xml-transformation-beans"></a>35.3.1&nbsp;Configuring Transformers as Beans</h3></div></div></div>

<p>This section will explain the workings of the following transformers and how to configure them as <span class="emphasis"><em>beans</em></span>:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="ulink" href="#xml-unmarshalling-transformer" target="_top">UnmarshallingTransformer</a>
</li><li class="listitem">
<a class="ulink" href="#xml-marshalling-transformer" target="_top">MarshallingTransformer</a>
</li><li class="listitem">
<a class="ulink" href="#xml-xslt-payload-transformers" target="_top">XsltPayloadTransformer</a>
</li></ul></div>
<p>All of the provided XML transformers extend <a class="ulink" href="http://docs.spring.io/spring-integration/api/org/springframework/integration/transformer/AbstractTransformer.html" target="_top">AbstractTransformer</a> or  <a class="ulink" href="http://docs.spring.io/spring-integration/api/org/springframework/integration/transformer/AbstractPayloadTransformer.html" target="_top">AbstractPayloadTransformer</a> and therefore implement  <a class="ulink" href="http://docs.spring.io/spring-integration/api/org/springframework/integration/transformer/Transformer.html" target="_top">Transformer</a>.
When configuring XML transformers as beans in Spring Integration, you would normally configure the <span class="emphasis"><em>Transformer</em></span> in conjunction with a  <a class="ulink" href="http://docs.spring.io/spring-integration/api/org/springframework/integration/transformer/MessageTransformingHandler.html" target="_top">MessageTransformingHandler</a>.
This allows the transformer to be used as an <span class="emphasis"><em>Endpoint</em></span>.
Finally, the namespace support will be discussed, which allows for the simple configuration of the transformers as elements in XML.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="xml-unmarshalling-transformer" href="#xml-unmarshalling-transformer"></a>UnmarshallingTransformer</h4></div></div></div>

<p>An <a class="ulink" href="http://docs.spring.io/spring-integration/api/org/springframework/integration/xml/transformer/UnmarshallingTransformer.html" target="_top">UnmarshallingTransformer</a> allows an XML <code class="literal">Source</code> to be unmarshalled using implementations of the <a class="ulink" href="http://docs.spring.io/spring/docs/current/spring-framework-reference/html/oxm.html" target="_top">Spring OXM</a> <code class="literal">Unmarshaller</code>.
Spring&#8217;s Object/XML Mapping support provides several implementations supporting marshalling and unmarshalling using <a class="ulink" href="http://en.wikipedia.org/wiki/Java_Architecture_for_XML_Binding" target="_top">JAXB</a>, <a class="ulink" href="http://www.castor.org/" target="_top">Castor</a> and <a class="ulink" href="http://jibx.sourceforge.net/" target="_top">JiBX</a> amongst others.
The unmarshaller requires an instance of <code class="literal">Source</code>.
If the message payload is not an instance of <code class="literal">Source</code>, conversion will be attempted.
Currently <code class="literal">String</code>, <code class="literal">File</code> and <code class="literal">org.w3c.dom.Document</code> payloads are supported.
Custom conversion to a <code class="literal">Source</code> is also supported by injecting an implementation of a <a class="ulink" href="http://docs.spring.io/spring-integration/api/org/springframework/integration/xml/source/SourceFactory.html" target="_top">SourceFactory</a>.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>If a <code class="literal">SourceFactory</code> is not set explicitly, the property on the <code class="literal">UnmarshallingTransformer</code> will by default be set to a <a class="ulink" href="http://docs.spring.io/spring-integration/api/org/springframework/integration/xml/source/DomSourceFactory.html" target="_top">DomSourceFactory</a>.</p>
</td></tr></table></div>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"unmarshallingTransformer"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.xml.transformer.UnmarshallingTransformer"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.oxm.jaxb.Jaxb2Marshaller"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"contextPath"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"org.example"</span><span class="hl-tag"> /&gt;</span>
        <span class="hl-tag">&lt;/bean&gt;</span>
    <span class="hl-tag">&lt;/constructor-arg&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="xml-marshalling-transformer" href="#xml-marshalling-transformer"></a>MarshallingTransformer</h4></div></div></div>

<p>The <a class="ulink" href="http://docs.spring.io/spring-integration/api/org/springframework/integration/xml/transformer/MarshallingTransformer.html" target="_top">MarshallingTransformer</a> allows an object graph to be converted into XML using a Spring OXM <code class="literal">Marshaller</code>.
By default the <code class="literal">MarshallingTransformer</code> will return a <code class="literal">DomResult</code>.
However, the type of result can be controlled by configuring an alternative <code class="literal">ResultFactory</code> such as <code class="literal">StringResultFactory</code>.
In many cases it will be more convenient to transform the payload into an alternative XML format.
To achieve this, configure a <code class="literal">ResultTransformer</code>.
Two implementations are provided, one which converts to <code class="literal">String</code> and another which converts to <code class="literal">Document</code>.</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"marshallingTransformer"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.xml.transformer.MarshallingTransformer"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.oxm.jaxb.Jaxb2Marshaller"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"contextPath"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"org.example"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/bean&gt;</span>
    <span class="hl-tag">&lt;/constructor-arg&gt;</span>
    <span class="hl-tag">&lt;constructor-arg&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.xml.transformer.ResultToDocumentTransformer"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/constructor-arg&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
<p>By default, the <code class="literal">MarshallingTransformer</code> will pass the payload Object to the <code class="literal">Marshaller</code>, but if its boolean <code class="literal">extractPayload</code> property is set to <code class="literal">false</code>, the entire <code class="literal">Message</code> instance will be passed to the <code class="literal">Marshaller</code> instead.
That may be useful for certain custom implementations of the <code class="literal">Marshaller</code> interface, but typically the payload is the appropriate source Object for marshalling when delegating to any of the various out-of-the-box <code class="literal">Marshaller</code> implementations.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="xml-xslt-payload-transformers" href="#xml-xslt-payload-transformers"></a>XsltPayloadTransformer</h4></div></div></div>

<p><a class="ulink" href="http://docs.spring.io/spring-integration/api/org/springframework/integration/xml/transformer/XsltPayloadTransformer.html" target="_top">XsltPayloadTransformer</a> transforms XML payloads using <a class="ulink" href="http://en.wikipedia.org/wiki/XSL_Transformations" target="_top">Extensible Stylesheet Language Transformations</a> (XSLT).
The transformer&#8217;s constructor requires an instance of either <a class="ulink" href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/core/io/Resource.html" target="_top">Resource</a> or <a class="ulink" href="http://docs.oracle.com/javase/6/docs/api/javax/xml/transform/Templates.html" target="_top">Templates</a> to be passed in.
Passing in a <code class="literal">Templates</code> instance allows for greater configuration of the <code class="literal">TransformerFactory</code> used to create the template instance.</p>
<p>As with the <a class="ulink" href="#xml-unmarshalling-transformer" target="_top">UnmarshallingTransformer</a>, the <code class="literal">XsltPayloadTransformer</code> will do the actual XSLT transformation using instances of <code class="literal">Source</code>.
Therefore, if the message payload is not an instance of <code class="literal">Source</code>, conversion will be attempted.
<code class="literal">String</code> and <code class="literal">Document</code> payloads are supported directly.</p>
<p>Custom conversion to a <code class="literal">Source</code> is also supported by injecting an implementation of a <a class="ulink" href="http://docs.spring.io/spring-integration/api/org/springframework/integration/xml/source/SourceFactory.html" target="_top">SourceFactory</a>.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>If a <code class="literal">SourceFactory</code> is not set explicitly, the property on the <code class="literal">XsltPayloadTransformer</code> will by default be set to a  <a class="ulink" href="http://docs.spring.io/spring-integration/api/org/springframework/integration/xml/source/DomSourceFactory.html" target="_top">DomSourceFactory</a>.</p>
</td></tr></table></div>
<p>By default, the <code class="literal">XsltPayloadTransformer</code> will create a message with a <a class="ulink" href="http://docs.oracle.com/javase/6/docs/api/javax/xml/transform/Result.html" target="_top">Result</a> payload, similar to the <code class="literal">XmlPayloadMarshallingTransformer</code>.
This can be customised by providing a <a class="ulink" href="http://docs.spring.io/spring-integration/api/org/springframework/integration/xml/result/ResultFactory.html" target="_top">ResultFactory</a> and/or a  <a class="ulink" href="http://docs.spring.io/spring-integration/api/org/springframework/integration/xml/transformer/ResultTransformer.html" target="_top">ResultTransformer</a>.</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"xsltPayloadTransformer"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.xml.transformer.XsltPayloadTransformer"</span><span class="hl-tag">&gt;</span>
  <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"classpath:org/example/xsl/transform.xsl"</span><span class="hl-tag">/&gt;</span>
  <span class="hl-tag">&lt;constructor-arg&gt;</span>
    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.xml.transformer.ResultToDocumentTransformer"</span><span class="hl-tag">/&gt;</span>
  <span class="hl-tag">&lt;/constructor-arg&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
<p>Starting with Spring Integration 3.0, you can now specify the transformer factory class name using a constructor argument.
This is configured using the <code class="literal">transformer-factory-class</code> attribute when using the namespace.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="xml-using-result-transformers" href="#xml-using-result-transformers"></a>ResultTransformers</h4></div></div></div>

<p>Both the <code class="literal">MarshallingTransformer</code> and the <code class="literal">XsltPayloadTransformer</code> allow you to specify a <a class="ulink" href="http://docs.spring.io/spring-integration/api/org/springframework/integration/xml/transformer/ResultTransformer.html" target="_top">ResultTransformer</a>.
Thus, if the Marshalling or XSLT transformation returns a <a class="ulink" href="http://docs.oracle.com/javase/6/docs/api/javax/xml/transform/Result.html" target="_top">Result</a>, than you have the option to also use a <code class="literal">ResultTransformer</code> to transform the <code class="literal">Result</code> into another format.
Spring Integration provides 2 concrete`ResultTransformer` implementations:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="ulink" href="http://docs.spring.io/spring-integration/api/org/springframework/integration/xml/transformer/ResultToDocumentTransformer.html" target="_top">ResultToDocumentTransformer</a>
</li><li class="listitem">
<a class="ulink" href="http://docs.spring.io/spring-integration/api/org/springframework/integration/xml/transformer/ResultToStringTransformer.html" target="_top">ResultToStringTransformer</a>
</li></ul></div>
<p><span class="emphasis"><em>Using ResultTransformers with the MarshallingTransformer</em></span></p>
<p>By default, the <span class="emphasis"><em>MarshallingTransformer</em></span> will always return a <a class="ulink" href="http://docs.oracle.com/javase/6/docs/api/javax/xml/transform/Result.html" target="_top">Result</a>.
By specifying a <code class="literal">ResultTransformer</code>, you can customize the type of payload returned.</p>
<p><span class="emphasis"><em>Using ResultTransformers with the XsltPayloadTransformer</em></span></p>
<p>The behavior is slighly more complex for the <span class="emphasis"><em>XsltPayloadTransformer</em></span>.
By default, if the input payload is an instance of <code class="literal">String</code> or <a class="ulink" href="http://docs.oracle.com/javase/6/docs/api/org/w3c/dom/Document.html" target="_top">Document</a> the <span class="emphasis"><em>resultTransformer</em></span> property is ignored.</p>
<p>However, if the input payload is a <a class="ulink" href="http://docs.oracle.com/javase/6/docs/api/javax/xml/transform/Source.html" target="_top">Source</a> or any other type, then the <span class="emphasis"><em>resultTransformer</em></span> property is applied.
Additionally, you can set the property <span class="emphasis"><em>alwaysUseResultFactory</em></span> to <code class="literal">true</code>, which will also cause the specified <span class="emphasis"><em>resultTransformer</em></span> to being used.</p>
<p>For more information and examples, please see <a class="xref" href="#xml-using-result-transformers-namespace" title="35.3.3&nbsp;Namespace Configuration and ResultTransformers">Section&nbsp;35.3.3, &#8220;Namespace Configuration and ResultTransformers&#8221;</a></p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="xml-transformer-namespace" href="#xml-transformer-namespace"></a>35.3.2&nbsp;Namespace Support for XML Transformers</h3></div></div></div>

<p>Namespace support for all XML transformers is provided in the Spring Integration XML namespace, a template for which can be seen below.
The namespace support for transformers creates an instance of either`EventDrivenConsumer` or <code class="literal">PollingConsumer</code> according to the type of the provided input channel.
The namespace support is designed to reduce the amount of XML configuration by allowing the creation of an endpoint and transformer using one element.</p>
<p><span class="emphasis"><em>UnmarshallingTransformer</em></span></p>
<p>The namespace support for the <code class="literal">UnmarshallingTransformer</code> is shown below.
Since the namespace is now creating an endpoint instance rather than a transformer, a poller can also be nested within the element to control the polling of the input channel.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-xml:unmarshalling-transformer</span> <span class="hl-attribute">id</span>=<span class="hl-value">"defaultUnmarshaller"</span>
    <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span>
    <span class="hl-attribute">unmarshaller</span>=<span class="hl-value">"unmarshaller"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int-xml:unmarshalling-transformer</span> <span class="hl-attribute">id</span>=<span class="hl-value">"unmarshallerWithPoller"</span>
    <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span>
    <span class="hl-attribute">unmarshaller</span>=<span class="hl-value">"unmarshaller"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"2000"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;int-xml:unmarshalling-transformer/&gt;</span></pre>
<p><span class="emphasis"><em>MarshallingTransformer</em></span></p>
<p>The namespace support for the marshalling transformer requires an <code class="literal">input-channel</code>, <code class="literal">output-channel</code> and a reference to a <code class="literal">marshaller</code>.
The optional <code class="literal">result-type</code> attribute can be used to control the type of result created.
Valid values are <code class="literal">StringResult</code> or <code class="literal">DomResult</code> (the default).</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-xml:marshalling-transformer</span>
     <span class="hl-attribute">input-channel</span>=<span class="hl-value">"marshallingTransformerStringResultFactory"</span>
     <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span>
     <span class="hl-attribute">marshaller</span>=<span class="hl-value">"marshaller"</span>
     <span class="hl-attribute">result-type</span>=<span class="hl-value">"StringResult"</span><span class="hl-tag"> /&gt;</span>

<span class="hl-tag">&lt;int-xml:marshalling-transformer</span>
    <span class="hl-attribute">input-channel</span>=<span class="hl-value">"marshallingTransformerWithResultTransformer"</span>
    <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span>
    <span class="hl-attribute">marshaller</span>=<span class="hl-value">"marshaller"</span>
    <span class="hl-attribute">result-transformer</span>=<span class="hl-value">"resultTransformer"</span><span class="hl-tag"> /&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"resultTransformer"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.xml.transformer.ResultToStringTransformer"</span><span class="hl-tag">/&gt;</span></pre>
<p>Where the provided result types are not sufficient, a reference to a custom implementation of <code class="literal">ResultFactory</code> can be provided as an alternative to setting the <code class="literal">result-type</code> attribute, using the <code class="literal">result-factory</code> attribute.
The attributes <span class="emphasis"><em>result-type</em></span> and <span class="emphasis"><em>result-factory</em></span> are mutually exclusive.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Internally, the result types <code class="literal">StringResult</code> and <code class="literal">DomResult</code> are represented by the <code class="literal">ResultFactory</code> s  <a class="ulink" href="http://docs.spring.io/spring-integration/api/org/springframework/integration/xml/result/StringResultFactory.html" target="_top">StringResultFactory</a> and  <a class="ulink" href="http://docs.spring.io/spring-integration/api/org/springframework/integration/xml/result/DomResultFactory.html" target="_top">DomResultFactory</a> respectively.</p>
</td></tr></table></div>
<p><span class="emphasis"><em>XsltPayloadTransformer</em></span></p>
<p>Namespace support for the <code class="literal">XsltPayloadTransformer</code> allows you to either pass in a <code class="literal">Resource</code>, in order to create the <a class="ulink" href="http://docs.oracle.com/javase/6/docs/api/javax/xml/transform/Templates.html" target="_top">Templates</a> instance, or alternatively, you can pass in a precreated <code class="literal">Templates</code> instance as a reference.
In common with the marshalling transformer, the type of the result output can be controlled by specifying either the <code class="literal">result-factory</code> or <code class="literal">result-type</code> attribute.
A <code class="literal">result-transformer</code> attribute can also be used to reference an implementation of <code class="literal">ResultTransformer</code> where conversion of the result is required before sending.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>If you specify the <code class="literal">result-factory</code> or the <code class="literal">result-type</code> attribute, then the <code class="literal">alwaysUseResultFactory</code> property on the underlying <a class="ulink" href="http://docs.spring.io/spring-integration/api/org/springframework/integration/xml/transformer/XsltPayloadTransformer.html" target="_top">XsltPayloadTransformer</a> will be set to <code class="literal">true</code> by the <a class="ulink" href="http://docs.spring.io/spring-integration/api/org/springframework/integration/xml/config/XsltPayloadTransformerParser.html" target="_top">XsltPayloadTransformerParser</a>.</p>
</td></tr></table></div>
<pre class="programlisting"><span class="hl-tag">&lt;int-xml:xslt-transformer</span> <span class="hl-attribute">id</span>=<span class="hl-value">"xsltTransformerWithResource"</span>
    <span class="hl-attribute">input-channel</span>=<span class="hl-value">"withResourceIn"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span>
    <span class="hl-attribute">xsl-resource</span>=<span class="hl-value">"org/springframework/integration/xml/config/test.xsl"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int-xml:xslt-transformer</span> <span class="hl-attribute">id</span>=<span class="hl-value">"xsltTransformerWithTemplatesAndResultTransformer"</span>
    <span class="hl-attribute">input-channel</span>=<span class="hl-value">"withTemplatesAndResultTransformerIn"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span>
    <span class="hl-attribute">xsl-templates</span>=<span class="hl-value">"templates"</span>
    <span class="hl-attribute">result-transformer</span>=<span class="hl-value">"resultTransformer"</span><span class="hl-tag">/&gt;</span></pre>
<p>Often you may need to have access to Message data, such as the Message Headers, in order to assist with transformation.
For example, you may need to get access to certain Message Headers and pass them on as parameters to a transformer (e.g., <code class="literal">transformer.setParameter(..)</code>).
Spring Integration provides two convenient ways to accomplish this, as illustrated in following example:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-xml:xslt-transformer</span> <span class="hl-attribute">id</span>=<span class="hl-value">"paramHeadersCombo"</span>
    <span class="hl-attribute">input-channel</span>=<span class="hl-value">"paramHeadersComboChannel"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span>
    <span class="hl-attribute">xsl-resource</span>=<span class="hl-value">"classpath:transformer.xslt"</span>
    <span class="hl-attribute">xslt-param-headers</span>=<span class="hl-value">"testP*, *foo, bar, baz"</span><span class="hl-tag">&gt;</span>

    <span class="hl-tag">&lt;int-xml:xslt-param</span> <span class="hl-attribute">name</span>=<span class="hl-value">"helloParameter"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"hello"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int-xml:xslt-param</span> <span class="hl-attribute">name</span>=<span class="hl-value">"firstName"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"headers.fname"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-xml:xslt-transformer&gt;</span></pre>
<p>If message header names match 1:1 to parameter names, you can simply use <code class="literal">xslt-param-headers</code>&nbsp;attribute.
There you can also use wildcards for simple pattern matching, which supports the following simple pattern styles: "xxx*", "<span class="strong"><strong>xxx", "*xxx</strong></span>" and "xxx*yyy".</p>
<p>You can also configure individual Xslt parameters via&nbsp;the <span class="emphasis"><em>&lt;xslt-param/&gt;</em></span> sub element.
There you can use&nbsp;either the <code class="literal">expression</code>&nbsp;or <code class="literal">value</code> attribute.
The <code class="literal">expression</code> attribute should be any valid SpEL expression with Message being the root object of the expression evaluation context.
The <code class="literal">value</code> attribute, just like any <code class="literal">value</code> in Spring beans, allows you to specify simple scalar values.
You can also use property placeholders (e.g., ${some.value}).
So as you can see, with the <code class="literal">expression</code> and <code class="literal">value</code> attribute, Xslt parameters could now be mapped to any accessible part of the Message as well as any literal value.</p>
<p>Starting with Spring Integration 3.0, you can now specify the transformer factory class name using the <code class="literal">transformer-factory-class</code> attribute.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="xml-using-result-transformers-namespace" href="#xml-using-result-transformers-namespace"></a>35.3.3&nbsp;Namespace Configuration and ResultTransformers</h3></div></div></div>

<p>The usage of <code class="literal">ResultTransformers</code> was previously introduced in <a class="xref" href="#xml-using-result-transformers" title="ResultTransformers">the section called &#8220;ResultTransformers&#8221;</a>.
The following example illustrates several special use-cases using XML namespace configuration.
First, we define the <code class="literal">ResultTransformer</code>:</p>
<pre class="programlisting"><span class="hl-tag">&lt;beans:bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"resultToDoc"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.xml.transformer.ResultToDocumentTransformer"</span><span class="hl-tag">/&gt;</span></pre>
<p>This <code class="literal">ResultTransformer</code> will accept either a <code class="literal">StringResult</code> or a <code class="literal">DOMResult</code> as input and converts the input into a <code class="literal">Document</code>.</p>
<p>Now, let&#8217;s declare the transformer:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-xml:xslt-transformer</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"in"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"fahrenheitChannel"</span>
    <span class="hl-attribute">xsl-resource</span>=<span class="hl-value">"classpath:noop.xslt"</span> <span class="hl-attribute">result-transformer</span>=<span class="hl-value">"resultToDoc"</span><span class="hl-tag">/&gt;</span></pre>
<p>If the incoming message&#8217;s payload is of type <code class="literal">Source</code>, then as first step the <code class="literal">Result</code> is determined using the <code class="literal">ResultFactory</code>.
As we did not specify a <code class="literal">ResultFactory</code>, the default <code class="literal">DomResultFactory</code> is used, meaning that the transformation will yield a <code class="literal">DomResult</code>.</p>
<p>However, as we specified a <span class="emphasis"><em>ResultTransformer</em></span>, it will be used and the resulting Message payload will be of type`Document`.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>If the incoming message&#8217;s payload is of type <code class="literal">String</code>, the payload after the Xslt transformation will be a String.
Similarly, if the incoming message&#8217;s payload is of type <code class="literal">Document</code>, the payload after the Xslt transformation will be a`Document`.
The specified <span class="emphasis"><em>ResultTransformer</em></span> will be ignored with <code class="literal">String</code> or <code class="literal">Document</code> payloads.</p>
</td></tr></table></div>
<p>If the message payload is neither a <code class="literal">Source</code>, <code class="literal">String</code> or <code class="literal">Document</code>, as a fallback option, it is attempted to create a`Source` using the default  <a class="ulink" href="http://docs.spring.io/spring-integration/api/org/springframework/integration/xml/source/SourceFactory.html" target="_top">SourceFactory</a>.
As we did not specify a <code class="literal">SourceFactory</code> explicitly using the <span class="emphasis"><em>source-factory</em></span> attribute, the default  <a class="ulink" href="http://docs.spring.io/spring-integration/api/org/springframework/integration/xml/source/DomSourceFactory.html" target="_top">DomSourceFactory</a> is used.
If successful, the XSLT transformation is executed as if the payload was of type <code class="literal">Source</code>, which we described in the previous paragraphs.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The <code class="literal">DomSourceFactory</code> supports the creation of a <code class="literal">DOMSource</code> from a either <code class="literal">Document</code>, <code class="literal">File</code> or <code class="literal">String</code> payloads.</p>
</td></tr></table></div>
<p>The next transformer declaration adds a <span class="emphasis"><em>result-type</em></span> attribute using <code class="literal">StringResult</code> as its value.
First, the <span class="emphasis"><em>result-type</em></span> is internally represented by the <code class="literal">StringResultFactory</code>.
Thus, you could have also added a reference to a <code class="literal">StringResultFactory</code>, using the <span class="emphasis"><em>result-factory</em></span> attribute, which would haven been the same.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-xml:xslt-transformer</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"in"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"fahrenheitChannel"</span>
		<span class="hl-attribute">xsl-resource</span>=<span class="hl-value">"classpath:noop.xslt"</span> <span class="hl-attribute">result-transformer</span>=<span class="hl-value">"resultToDoc"</span>
		<span class="hl-attribute">result-type</span>=<span class="hl-value">"StringResult"</span><span class="hl-tag">/&gt;</span></pre>
<p>Because we are using a <code class="literal">ResultFactory</code>, the <span class="emphasis"><em>alwaysUseResultFactory</em></span> property of the <code class="literal">XsltPayloadTransformer</code> class will be implicitly set to <code class="literal">true</code>.
Consequently, the referenced <code class="literal">ResultToDocumentTransformer</code> will be used.</p>
<p>Therefore, if you transform a payload of type <code class="literal">String</code>, the resulting payload will be of type <a class="ulink" href="http://docs.oracle.com/javase/6/docs/api/org/w3c/dom/Document.html" target="_top">Document</a>.</p>
<p><span class="emphasis"><em>XsltPayloadTransformer and &lt;xsl:output method="text"/&gt;</em></span></p>
<p><code class="literal">&lt;xsl:output method="text"/&gt;</code> tells the XSLT template to only produce text content from the input source.
In this particular case there is no reason to have a <code class="literal">DomResult</code>.
Therefore, the <a class="ulink" href="http://docs.spring.io/spring-integration/api/org/springframework/integration/xml/transformer/XsltPayloadTransformer.html" target="_top">XsltPayloadTransformer</a> defaults to <code class="literal">StringResult</code> if the <a class="ulink" href="http://docs.oracle.com/javase/7/docs/api/javax/xml/transform/Transformer.html#getOutputProperties()" target="_top">output property</a> called <code class="literal">method</code> of the underlying <code class="literal">javax.xml.transform.Transformer</code> returns <code class="literal">"text"</code>.
This coercion is performed independent from the inbound payload type.
Keep in mind that this [quote]
smart behavior is only available, if the <code class="literal">result-type</code> or <code class="literal">result-factory</code> attributes aren&#8217;t provided for the respective <code class="literal">&lt;int-xml:xslt-transformer&gt;</code> component.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xml-xpath-transformer" href="#xml-xpath-transformer"></a>35.4&nbsp;Transforming XML Messages Using XPath</h2></div></div></div>

<p>When it comes to message transformation XPath is a great way to transform Messages that have XML payloads by defining XPath transformers via &lt;xpath-transformer/&gt; element.</p>
<p><span class="emphasis"><em>Simple XPath transformation</em></span></p>
<p>Let&#8217;s look at the following transformer configuration:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-xml:xpath-transformer</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"inputChannel"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"outputChannel"</span>
      <span class="hl-attribute">xpath-expression</span>=<span class="hl-value">"/person/@name"</span><span class="hl-tag"> /&gt;</span></pre>
<p>...and Message</p>
<pre class="programlisting">Message&lt;?&gt; message =
  MessageBuilder.withPayload(<span class="hl-string">"&lt;person name='John Doe' age='42' married='true'/&gt;"</span>).build();</pre>
<p>After sending this message to the <span class="emphasis"><em>inputChannel</em></span> the XPath transformer configured above will transform this XML Message to a simple Message with payload of <span class="emphasis"><em>John Doe</em></span> all based on the simple XPath Expression specified in the <code class="literal">xpath-expression</code> attribute.</p>
<p>XPath also has the capability to perform simple conversion of extracted elements to a desired type.
Valid return types are defined in <code class="literal">javax.xml.xpath.XPathConstants</code> and follows the conversion rules specified by the <code class="literal">javax.xml.xpath.XPath</code> interface.</p>
<p>The following constants are defined by the <code class="literal">XPathConstants</code> class: <span class="emphasis"><em>BOOLEAN, DOM_OBJECT_MODEL, NODE, NODESET, NUMBER, STRING</em></span></p>
<p>You can configure the desired type by simply using the <code class="literal">evaluation-type</code> attribute of the <code class="literal">&lt;xpath-transformer/&gt;</code> element.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-xml:xpath-transformer</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"numberInput"</span> <span class="hl-attribute">xpath-expression</span>=<span class="hl-value">"/person/@age"</span>
                           <span class="hl-attribute">evaluation-type</span>=<span class="hl-value">"NUMBER_RESULT"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int-xml:xpath-transformer</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"booleanInput"</span>
                           <span class="hl-attribute">xpath-expression</span>=<span class="hl-value">"/person/@married = 'true'"</span>
                           <span class="hl-attribute">evaluation-type</span>=<span class="hl-value">"BOOLEAN_RESULT"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span><span class="hl-tag">/&gt;</span></pre>
<p><span class="emphasis"><em>Node Mappers</em></span></p>
<p>If you need to provide custom mapping for the node extracted by the XPath expression simply provide a reference to the implementation of the <code class="literal">org.springframework.xml.xpath.NodeMapper</code> - an interface used by <code class="literal">XPathOperations</code> implementations for mapping Node objects on a per-node basis.
To provide a reference to a <code class="literal">NodeMapper</code> simply use <code class="literal">node-mapper</code> attribute:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-xml:xpath-transformer</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"nodeMapperInput"</span> <span class="hl-attribute">xpath-expression</span>=<span class="hl-value">"/person/@age"</span>
                           <span class="hl-attribute">node-mapper</span>=<span class="hl-value">"testNodeMapper"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span><span class="hl-tag">/&gt;</span></pre>
<p>...and Sample NodeMapper implementation:</p>
<pre class="programlisting"><span class="hl-keyword">class</span> TestNodeMapper <span class="hl-keyword">implements</span> NodeMapper {
  <span class="hl-keyword">public</span> Object mapNode(Node node, <span class="hl-keyword">int</span> nodeNum) <span class="hl-keyword">throws</span> DOMException {
    <span class="hl-keyword">return</span> node.getTextContent() + <span class="hl-string">"-mapped"</span>;
  }
}</pre>
<p><span class="emphasis"><em>XML Payload Converter</em></span></p>
<p>You can also use an implementation of the <code class="literal">org.springframework.integration.xml.XmlPayloadConverter</code> to provide more granular transformation:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-xml:xpath-transformer</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"customConverterInput"</span>
                           <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span> <span class="hl-attribute">xpath-expression</span>=<span class="hl-value">"/test/@type"</span>
                           <span class="hl-attribute">converter</span>=<span class="hl-value">"testXmlPayloadConverter"</span><span class="hl-tag"> /&gt;</span></pre>
<p>...and Sample XmlPayloadConverter implementation:</p>
<pre class="programlisting"><span class="hl-keyword">class</span> TestXmlPayloadConverter <span class="hl-keyword">implements</span> XmlPayloadConverter {
  <span class="hl-keyword">public</span> Source convertToSource(Object object) {
    <span class="hl-keyword">throw</span> <span class="hl-keyword">new</span> UnsupportedOperationException();
  }
  <span class="hl-comment">//</span>
  <span class="hl-keyword">public</span> Node convertToNode(Object object) {
    <span class="hl-keyword">try</span> {
      <span class="hl-keyword">return</span> DocumentBuilderFactory.newInstance().newDocumentBuilder().parse(
          <span class="hl-keyword">new</span> InputSource(<span class="hl-keyword">new</span> StringReader(<span class="hl-string">"&lt;test type='custom'/&gt;"</span>)));
    }
    <span class="hl-keyword">catch</span> (Exception e) {
      <span class="hl-keyword">throw</span> <span class="hl-keyword">new</span> IllegalStateException(e);
    }
  }
  <span class="hl-comment">//</span>
  <span class="hl-keyword">public</span> Document convertToDocument(Object object) {
    <span class="hl-keyword">throw</span> <span class="hl-keyword">new</span> UnsupportedOperationException();
  }
}</pre>
<p>The <code class="literal">DefaultXmlPayloadConverter</code> is used if this reference is not provided, and it should be sufficient in most cases since it can convert from <code class="literal">Node</code>, <code class="literal">Document</code>, <code class="literal">Source</code>, <code class="literal">File</code>, <code class="literal">String</code>, <code class="literal">InputStream</code> and <code class="literal">byte[]</code> typed payloads.
If you need to extend beyond the capabilities of that default implementation, then an upstream <code class="literal">Transformer</code> is probably a better option than providing a reference to a custom implementation of this strategy here.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xml-xpath-splitting" href="#xml-xpath-splitting"></a>35.5&nbsp;Splitting XML Messages</h2></div></div></div>

<p><code class="literal">XPathMessageSplitter</code> supports messages with either <code class="literal">String</code> or <code class="literal">Document</code> payloads.
The splitter uses the provided XPath expression to split the payload into a number of nodes.
By default this will result in each <code class="literal">Node</code> instance becoming the payload of a new message.
Where it is preferred that each message be a Document the <code class="literal">createDocuments</code> flag can be set.
Where a <code class="literal">String</code> payload is passed in the payload will be converted then split before being converted back to a number of String messages.
The XPath splitter implements <code class="literal">MessageHandler</code> and should therefore be configured in conjunction with an appropriate endpoint (see the namespace support below for a simpler configuration alternative).</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"splittingEndpoint"</span>
      <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.endpoint.EventDrivenConsumer"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"orderChannel"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;constructor-arg&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.xml.splitter.XPathMessageSplitter"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"/order/items"</span><span class="hl-tag"> /&gt;</span>
            <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"documentBuilder"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"customisedDocumentBuilder"</span><span class="hl-tag"> /&gt;</span>
            <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"outputChannel"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"orderItemsChannel"</span><span class="hl-tag"> /&gt;</span>
        <span class="hl-tag">&lt;/bean&gt;</span>
    <span class="hl-tag">&lt;/constructor-arg&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
<p>XPath splitter namespace support allows the creation of a Message Endpoint with an input channel and output channel.</p>
<pre class="programlisting"><span class="hl-comment">&lt;!-- Split the order into items creating a new message for each item node --&gt;</span>
<span class="hl-tag">&lt;int-xml:xpath-splitter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"orderItemSplitter"</span>
                       <span class="hl-attribute">input-channel</span>=<span class="hl-value">"orderChannel"</span>
                       <span class="hl-attribute">output-channel</span>=<span class="hl-value">"orderItemsChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int-xml:xpath-expression</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"/order/items"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-xml:xpath-splitter&gt;</span>

<span class="hl-comment">&lt;!-- Split the order into items creating a new document for each item--&gt;</span>
<span class="hl-tag">&lt;int-xml:xpath-splitter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"orderItemDocumentSplitter"</span>
                       <span class="hl-attribute">input-channel</span>=<span class="hl-value">"orderChannel"</span>
                       <span class="hl-attribute">output-channel</span>=<span class="hl-value">"orderItemsChannel"</span>
                       <span class="hl-attribute">create-documents</span>=<span class="hl-value">"true"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int-xml:xpath-expression</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"/order/items"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"2000"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-xml:xpath-splitter&gt;</span></pre>
<p>Starting with <code class="literal">version 4.2</code>, the <code class="literal">XPathMessageSplitter</code> exposes <code class="literal">outputProperties</code>
(such as <code class="literal">OutputKeys.OMIT_XML_DECLARATION</code>) property for the <code class="literal">javax.xml.transform.Transformer</code> instances when a
request <code class="literal">payload</code> isn&#8217;t of <code class="literal">org.w3c.dom.Node</code> type:</p>
<pre class="programlisting"><span class="hl-tag">&lt;util:properties</span> <span class="hl-attribute">id</span>=<span class="hl-value">"outputProperties"</span><span class="hl-tag">&gt;</span>
	<span class="hl-tag">&lt;beans:prop</span> <span class="hl-attribute">key</span>=<span class="hl-value">"#{T (javax.xml.transform.OutputKeys).OMIT_XML_DECLARATION}"</span><span class="hl-tag">&gt;</span>yes<span class="hl-tag">&lt;/beans:prop&gt;</span>
<span class="hl-tag">&lt;/util:properties&gt;</span>

<span class="hl-tag">&lt;xpath-splitter</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span>
             <span class="hl-attribute">output-properties</span>=<span class="hl-value">"outputProperties"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;xpath-expression</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"/orders/order"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/xpath-splitter&gt;</span></pre>
<p>Starting with <code class="literal">version 4.2</code>, the <code class="literal">XPathMessageSplitter</code> exposes an <code class="literal">iterator</code> option as a <code class="literal">boolean</code> flag (defaults to <code class="literal">true</code>).
This allows the "streaming" of split nodes in the downstream flow.
With the <code class="literal">iterator</code> mode, each node is transformed while iterating. When false, all entries are transformed first,
before the split nodes start being sent to the output channel (transform, send, transform, send Vs. transform,
transform, send, send).
See <a class="xref" href="#splitter" title="6.3&nbsp;Splitter">Section&nbsp;6.3, &#8220;Splitter&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xml-xpath-routing" href="#xml-xpath-routing"></a>35.6&nbsp;Routing XML Messages Using XPath</h2></div></div></div>

<p>Similar to SpEL-based routers, Spring Integration provides support for routing messages based on XPath expressions, allowing you to create a Message Endpoint with an input channel but no output channel.
Instead, one or more output channels are determined dynamically.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-xml:xpath-router</span> <span class="hl-attribute">id</span>=<span class="hl-value">"orderTypeRouter"</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"orderChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int-xml:xpath-expression</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"/order/type"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-xml:xpath-router&gt;</span></pre>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>For an overview of attributes that are common among Routers, please see chapter: <span class="emphasis"><em><a class="xref" href="#router-common-parameters" title="6.1.2&nbsp;Common Router Parameters">Section&nbsp;6.1.2, &#8220;Common Router Parameters&#8221;</a></em></span></p>
</td></tr></table></div>
<p>Internally XPath expressions will be evaluated as <span class="emphasis"><em>NODESET</em></span> type and converted to a <code class="literal">List&lt;String&gt;</code> representing channel names.
Typically such a list will contain a single channel name.
However, based on the results of an XPath Expression, the XPath router can also take on the characteristics of a <span class="emphasis"><em>Recipient List Router</em></span> if the XPath Expression returns more then one value.
In that case, the <code class="literal">List&lt;String&gt;</code> will contain more then one channel name and consequently Messages will be sent to all channels in the list.</p>
<p>Thus, assuming that the XML file passed to the router configured below contains many <code class="literal">responder</code> sub-elements representing channel names, the message will be sent to all of those channels.</p>
<pre class="programlisting"><span class="hl-comment">&lt;!-- route the order to all responders--&gt;</span>
<span class="hl-tag">&lt;int-xml:xpath-router</span> <span class="hl-attribute">id</span>=<span class="hl-value">"responderRouter"</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"orderChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int-xml:xpath-expression</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"/request/responders"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-xml:xpath-router&gt;</span></pre>
<p>If the returned values do not represent the channel names directly, additional mapping parameters can be specified, in order to map those returned values to actual channel names.
For example if the <code class="literal">/request/responders</code> expression results in two values <code class="literal">responderA</code> and <code class="literal">responderB</code> but you don&#8217;t want to couple the responder names to channel names, you may provide additional mapping configuration such as the following:</p>
<pre class="programlisting"><span class="hl-comment">&lt;!-- route the order to all responders--&gt;</span>
<span class="hl-tag">&lt;int-xml:xpath-router</span> <span class="hl-attribute">id</span>=<span class="hl-value">"responderRouter"</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"orderChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int-xml:xpath-expression</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"/request/responders"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int-xml:mapping</span> <span class="hl-attribute">value</span>=<span class="hl-value">"responderA"</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"channelA"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int-xml:mapping</span> <span class="hl-attribute">value</span>=<span class="hl-value">"responderB"</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"channelB"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-xml:xpath-router&gt;</span></pre>
<p>As already mentioned, the default evaluation type for XPath expressions is <span class="emphasis"><em>NODESET</em></span>, which is converted to a <code class="literal">List&lt;String&gt;</code> of channel names, therefore handling single channel scenarios as well as multiple ones.</p>
<p>Nonetheless, certain XPath expressions may evaluate as String type from the very beginning.
Take for example the following XPath Expression:</p>
<pre class="programlisting">name(./node())</pre>
<p>This expression will return the name of the root node.
It will resulting in an exception, if the default evaluation type <span class="emphasis"><em>NODESET</em></span> is being used.</p>
<p>For these scenarious, you may use the <code class="literal">evaluate-as-string</code> attribute, which will allow you to manage the evaluation type.
It is <code class="literal">FALSE</code> by default, however if set to <code class="literal">TRUE</code>, the String evaluation type will be used.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>To provide some background information: XPath 1.0 specifies 4 data types:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Node-sets
</li><li class="listitem">
Strings
</li><li class="listitem">
Number
</li><li class="listitem">
Boolean
</li></ul></div>
<p>When the XPath Router evaluates expressions using the optional <code class="literal">evaluate-as-string</code> attribute, the return value is determined per the <code class="literal">string()</code> function as defined in the XPath specification.
This means that if the expression selects multiple nodes, it will return the string value of the first node.</p>
<p>For further information, please see:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="ulink" href="http://www.w3.org/TR/xpath/" target="_top">Specification: XML Path Language (XPath) Version 1.0</a>
</li><li class="listitem">
<a class="ulink" href="http://www.w3.org/TR/xpath/#function-string" target="_top">XPath specification - string() function</a>
</li></ul></div>
</td></tr></table></div>
<p>For example if we want to route based on the name of the root node, we can use the following configuration:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-xml:xpath-router</span> <span class="hl-attribute">id</span>=<span class="hl-value">"xpathRouterAsString"</span>
        <span class="hl-attribute">input-channel</span>=<span class="hl-value">"xpathStringChannel"</span>
        <span class="hl-attribute">evaluate-as-string</span>=<span class="hl-value">"true"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int-xml:xpath-expression</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"name(./node())"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-xml:xpath-router&gt;</span></pre>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="xpath-routing-converter" href="#xpath-routing-converter"></a>35.6.1&nbsp;XML Payload Converter</h3></div></div></div>

<p>For XPath Routers, you can also specify the Converter to use when converting payloads prior to XPath evaluation.
As such, the XPath Router supports custom implementations of the <code class="literal">XmlPayloadConverter</code> strategy, and when configuring an <code class="literal">xpath-router</code> element in XML, a reference to such an implementation may be provided via the <code class="literal">converter</code> attribute.</p>
<p>If this reference is not explicitly provided, the <code class="literal">DefaultXmlPayloadConverter</code> is used.
It should be sufficient in most cases, since it can convert from Node, Document, Source, File, and String typed payloads.
If you need to extend beyond the capabilities of that default implementation, then an upstream Transformer is generally a better option in most cases, rather than providing a reference to a custom implementation of this strategy here.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xml-xpath-header-enricher" href="#xml-xpath-header-enricher"></a>35.7&nbsp;XPath Header Enricher</h2></div></div></div>

<p>The XPath Header Enricher defines a Header Enricher Message Transformer that evaluates XPath expressions against the message payload and inserts the result of the evaluation into a messsage header.</p>
<p>Please see below for an overview of all available configuration parameters:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-xml:xpath-header-enricher</span> <span class="hl-attribute">default-overwrite</span>=<span class="hl-value">"true"</span>    <a name="CO56-1" href="#CO56-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
                               id=""                       <a name="CO56-2" href="#CO56-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
                               input-channel=""            <a name="CO56-3" href="#CO56-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
                               output-channel=""           <a name="CO56-4" href="#CO56-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
                               should-skip-nulls="true"&gt;   <a name="CO56-5" href="#CO56-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
    <span class="hl-tag">&lt;int:poller&gt;</span><span class="hl-tag">&lt;/int:poller&gt;</span>                              <a name="CO56-6" href="#CO56-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>
    <span class="hl-tag">&lt;int-xml:header</span> <span class="hl-attribute">name</span>=<span class="hl-value">""</span>                                <a name="CO56-7" href="#CO56-7"></a><span><img src="images/callouts/7.png" alt="7" border="0"></span>
                    evaluation-type="STRING_RESULT"        <a name="CO56-8" href="#CO56-8"></a><span><img src="images/callouts/8.png" alt="8" border="0"></span>
                    header-type="int"                      <a name="CO56-9" href="#CO56-9"></a><span><img src="images/callouts/9.png" alt="9" border="0"></span>
                    overwrite="true"                       <a name="CO56-10" href="#CO56-10"></a><span><img src="images/callouts/10.png" alt="10" border="0"></span>
                    xpath-expression=""                    <a name="CO56-11" href="#CO56-11"></a><span><img src="images/callouts/11.png" alt="11" border="0"></span>
                    xpath-expression-ref=""/&gt;              <a name="CO56-12" href="#CO56-12"></a><span><img src="images/callouts/12.png" alt="12" border="0"></span>
<span class="hl-tag">&lt;/int-xml:xpath-header-enricher&gt;</span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO56-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Specify the default boolean value for whether to overwrite existing header values.
This will only take effect for sub-elements that do not provide their own <span class="emphasis"><em>overwrite</em></span> attribute.
If the <span class="emphasis"><em>default- overwrite</em></span> attribute is not provided, then the specified header values will NOT overwrite any existing ones with the same header names.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO56-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Id for the underlying bean definition.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO56-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The receiving Message channel of this endpoint.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO56-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Channel to which enriched messages shall be send to.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO56-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Specify whether null values, such as might be returned from an expression evaluation, should be skipped.
The default value is true.
Set this to false if a null value should trigger removal of the corresponding header instead.<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO56-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p><span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO56-7"><span><img src="images/callouts/7.png" alt="7" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The name of the header to be enriched.
<span class="emphasis"><em>Mandatory</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO56-8"><span><img src="images/callouts/8.png" alt="8" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The result type expected from the XPath evaluation.
This will be the type of the header value, if there is no <code class="literal">header-type</code> attribute provided.
The following values are allowed: <code class="literal">BOOLEAN_RESULT</code>, <code class="literal">STRING_RESULT</code>, <code class="literal">NUMBER_RESULT</code>, <code class="literal">NODE_RESULT</code> and <code class="literal">NODE_LIST_RESULT</code>.
Defaults internally to <code class="literal">XPathEvaluationType.STRING_RESULT</code> if not set.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO56-9"><span><img src="images/callouts/9.png" alt="9" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The fully qualified class name for the header value type.
The result of XPath evaluation will be converted to this type using the <code class="literal">ConversionService</code>.
This allows, for example, a <code class="literal">NUMBER_RESULT</code> (a double) to be converted to an <code class="literal">Integer</code>.
The type can be declared as a primitive (e.g. <code class="literal">int</code>) but the result will always be the equivalent wrapper class (e.g. <code class="literal">Integer</code>).
The same integration <code class="literal">ConversionService</code> discussed in <a class="xref" href="#payload-type-conversion" title="8.1.6&nbsp;Payload Type Conversion">Section&nbsp;8.1.6, &#8220;Payload Type Conversion&#8221;</a> is used for the conversion, so conversion to custom types is supported, by adding a custom converter to the service.<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO56-10"><span><img src="images/callouts/10.png" alt="10" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Boolean value to indicate whether this header value should overwrite an existing header value for the same name if already present on the input Message.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO56-11"><span><img src="images/callouts/11.png" alt="11" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The XPath Expression as a String.
Either this attribute or <code class="literal">xpath-expression-ref</code> must be provided, but not both.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO56-12"><span><img src="images/callouts/12.png" alt="12" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The XPath Expression reference.
Either this attribute or <code class="literal">xpath-expression</code> must be provided, but not both.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xml-xpath-filter" href="#xml-xpath-filter"></a>35.8&nbsp;Using the XPath Filter</h2></div></div></div>

<p>This component defines an XPath-based Message Filter.
Under the covers this components uses a <code class="literal">MessageFilter</code> that wraps an instance of <code class="literal">AbstractXPathMessageSelector</code>.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Please also refer to the chapter on <a class="link" href="#filter" title="6.2&nbsp;Filter">Message Filters</a> for further details.</p>
</td></tr></table></div>
<p>In order to use the XPath Filter you must as a minimum provide an XPath Expression either by declaring the <code class="literal">xpath-expression</code> sub-element or by referencing an XPath Expression using the <code class="literal">xpath-expression-ref</code> attribute.</p>
<p>If the provided XPath expression will evaluate to a <code class="literal">boolean</code> value, no further configuration parameters are necessary.
However, if the XPath expression will evaluate to a String, the <code class="literal">match-value</code> attribute should be specified against which the evaluation result will be matched.</p>
<p>There are three options for the <code class="literal">match-type</code>:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>exact</strong></span> - correspond to <code class="literal">equals</code> on <code class="literal">java.lang.String</code>.
The underlying implementation uses a <code class="literal">StringValueTestXPathMessageSelector</code>
</li><li class="listitem">
<span class="strong"><strong>case-insensitive</strong></span> - correspond to <code class="literal">equals-ignore-case</code> on <code class="literal">java.lang.String</code>.
The underlying implementation uses a <code class="literal">StringValueTestXPathMessageSelector</code>
</li><li class="listitem">
<span class="strong"><strong>regex</strong></span> - matches operations one <code class="literal">java.lang.String</code>.
The underlying implementation uses a <code class="literal">RegexTestXPathMessageSelector</code>
</li></ul></div>
<p>When providing a <span class="emphasis"><em>match-type</em></span> value of <span class="emphasis"><em>regex</em></span>, the value provided with the <code class="literal">match-value</code> attribute must be a valid Regular Expression.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-xml:xpath-filter</span> <span class="hl-attribute">discard-channel</span>=<span class="hl-value">""</span>                      <a name="CO57-1" href="#CO57-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
                      id=""                                   <a name="CO57-2" href="#CO57-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
                      input-channel=""                        <a name="CO57-3" href="#CO57-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
                      match-type="exact"                      <a name="CO57-4" href="#CO57-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
                      match-value=""                          <a name="CO57-5" href="#CO57-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
                      output-channel=""                       <a name="CO57-6" href="#CO57-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>
                      throw-exception-on-rejection="false"    <a name="CO57-7" href="#CO57-7"></a><span><img src="images/callouts/7.png" alt="7" border="0"></span>
                      xpath-expression-ref=""&gt;                <a name="CO57-8" href="#CO57-8"></a><span><img src="images/callouts/8.png" alt="8" border="0"></span>
    <span class="hl-tag">&lt;int-xml:xpath-expression</span> <span class="hl-attribute">...</span><span class="hl-tag"> /&gt;</span>                          <a name="CO57-9" href="#CO57-9"></a><span><img src="images/callouts/9.png" alt="9" border="0"></span>
    <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">...</span><span class="hl-tag"> /&gt;</span>                                        <a name="CO57-10" href="#CO57-10"></a><span><img src="images/callouts/10.png" alt="10" border="0"></span>
<span class="hl-tag">&lt;/int-xml:xpath-filter&gt;</span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO57-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Message Channel where you want rejected messages to be sent.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO57-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Id for the underlying bean definition.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO57-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The receiving Message channel of this endpoint.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO57-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Type of match to apply between the XPath evaluation result and the <span class="emphasis"><em>match-value</em></span>.
Default is <span class="emphasis"><em>exact</em></span>.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO57-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>String value to be matched against the XPath evaluation result.
If this attribute is not provided, then the XPath evaluation MUST produce a boolean result directly.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO57-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The channel to which Messages that matched the filter criterias shall be dispatched to.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO57-7"><span><img src="images/callouts/7.png" alt="7" border="0"></span></a> </p></td><td valign="top" align="left">
<p>By default, this property is set to <span class="emphasis"><em>false</em></span> and rejected Messages (Messages that did not match the filter criteria) will be silently dropped.
However, if set to <span class="emphasis"><em>true</em></span> message rejection will result in an error condition and the exception will be propagated upstream to the caller.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO57-8"><span><img src="images/callouts/8.png" alt="8" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Reference to an XPath expression instance to evaluate.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO57-9"><span><img src="images/callouts/9.png" alt="9" border="0"></span></a> </p></td><td valign="top" align="left">
<p>This sub-element sets the XPath expression to be evaluated.
If this is not defined you MUST define the <code class="literal">xpath-expression-ref</code> attribute.
Also, only one <code class="literal">xpath-expression</code> element can be set.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO57-10"><span><img src="images/callouts/10.png" alt="10" border="0"></span></a> </p></td><td valign="top" align="left">
<p><span class="emphasis"><em>Optional</em></span>.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xpath-spel-function" href="#xpath-spel-function"></a>35.9&nbsp;#xpath SpEL Function</h2></div></div></div>

<p>Spring Integration, since version <span class="emphasis"><em>3.0</em></span>, provides the <code class="literal">#xpath</code> built-in SpEL function, which invokes the static method <code class="literal">XPathUtils.evaluate(...)</code>.
This method delegates to an <code class="literal">org.springframework.xml.xpath.XPathExpression</code>.
The following shows some usage examples:</p>
<pre class="programlisting"><span class="hl-tag">&lt;transformer</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"#xpath(payload, '/name')"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;filter</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"#xpath(payload, headers.xpath, 'boolean')"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;splitter</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"#xpath(payload, '//book', 'document_list')"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;router</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"#xpath(payload, '/person/@age', 'number')"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;mapping</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"output1"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"16"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;mapping</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"output2"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"45"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/router&gt;</span></pre>
<p><code class="literal">#xpath</code> also supports a third optional parameter for converting the result of the xpath evaluation.
It can be one of the String constants <code class="literal">'string'</code>, <code class="literal">'boolean'</code>, <code class="literal">'number'</code>, <code class="literal">'node'</code>, <code class="literal">'node_list'</code> and <code class="literal">'document_list'</code> or an <code class="literal">org.springframework.xml.xpath.NodeMapper</code> instance.
By default the <code class="literal">#xpath</code> SpEL function returns a String representation of the xpath evaluation.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>To enable the <code class="literal">#xpath</code> SpEL function, simply add the <code class="literal">spring-integration-xml.jar</code> to the CLASSPATH; there is no need to declare any component(s) from the Spring Integration Xml Namespace.</p>
</td></tr></table></div>
<p>For more information see <a class="xref" href="#spel" title="Appendix&nbsp;A.&nbsp;Spring Expression Language (SpEL)">Appendix&nbsp;A, <i>Spring Expression Language (SpEL)</i></a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xml-validating-filter" href="#xml-validating-filter"></a>35.10&nbsp;XML Validating Filter</h2></div></div></div>

<p>The XML Validating Filter allows you to validate incoming messages against provided schema instances.
The following schema types are supported:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
xml-schema (<a class="ulink" href="http://www.w3.org/2001/XMLSchema" target="_top">http://www.w3.org/2001/XMLSchema</a>)
</li><li class="listitem">
relax-ng (<a class="ulink" href="http://relaxng.org/ns/structure/1.0" target="_top">http://relaxng.org/ns/structure/1.0</a>)
</li></ul></div>
<p>Messages that fail validation can either be silently dropped or they can be forwarded to a definable <code class="literal">discard-channel</code>.
Furthermore you can configure this filter to throw an <code class="literal">Exception</code> in case validation fails.</p>
<p>Please see below for an overview of all available configuration parameters:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-xml:validating-filter</span> <span class="hl-attribute">discard-channel</span>=<span class="hl-value">""</span>                    <a name="CO58-1" href="#CO58-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
                           id=""                                 <a name="CO58-2" href="#CO58-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
                           input-channel=""                      <a name="CO58-3" href="#CO58-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
                           output-channel=""                     <a name="CO58-4" href="#CO58-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
                           schema-location=""                    <a name="CO58-5" href="#CO58-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
                           schema-type="xml-schema"              <a name="CO58-6" href="#CO58-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>
                           throw-exception-on-rejection="false"  <a name="CO58-7" href="#CO58-7"></a><span><img src="images/callouts/7.png" alt="7" border="0"></span>
                           xml-validator=""&gt;                     <a name="CO58-8" href="#CO58-8"></a><span><img src="images/callouts/8.png" alt="8" border="0"></span>
    <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">.../&gt;</span>                                            <a name="CO58-9" href="#CO58-9"></a><span><img src="images/callouts/9.png" alt="9" border="0"></span>
<span class="hl-tag">&lt;/int-xml:validating-filter&gt;</span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO58-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Message Channel where you want rejected messages to be sent.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO58-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Id for the underlying bean definition.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO58-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The receiving Message channel of this endpoint.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO58-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Message Channel where you want accepted messages to be sent.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO58-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Sets the location of the schema to validate the Message&#8217;s payload against.
Internally uses the <code class="literal">org.springframework.core.io.Resource</code> interface.
You can set this attribute or the <code class="literal">xml-validator</code> attribute but not both.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO58-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Sets the schema type.
Can be either <code class="literal">xml-schema</code> or <code class="literal">relax-ng</code>.
<span class="emphasis"><em>Optional</em></span>.
If not set it defaults to <code class="literal">xml-schema</code> which internally translates to <code class="literal">org.springframework.xml.validation.XmlValidatorFactory#SCHEMA_W3C_XML</code></p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO58-7"><span><img src="images/callouts/7.png" alt="7" border="0"></span></a> </p></td><td valign="top" align="left">
<p>If <code class="literal">true</code> a <code class="literal">MessageRejectedException</code> is thrown in case validation fails for the provided Message&#8217;s payload.<span class="emphasis"><em>Optional</em></span>.
Defaults to <code class="literal">false</code> if not set.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO58-8"><span><img src="images/callouts/8.png" alt="8" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Reference to a custom <code class="literal">sorg.springframework.xml.validation.XmlValidator</code> strategy.
You can set this attribute or the <code class="literal">schema-location</code> attribute but not both.
<span class="emphasis"><em>Optional</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO58-9"><span><img src="images/callouts/9.png" alt="9" border="0"></span></a> </p></td><td valign="top" align="left">
<p><span class="emphasis"><em>Optional</em></span>.</p>
</td></tr></table></div>
</div>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="xmpp" href="#xmpp"></a>36.&nbsp;XMPP Support</h2></div></div></div>

<p>Spring Integration provides Channel Adapters for <a class="ulink" href="http://www.xmpp.org" target="_top">XMPP</a>.</p>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xmpp-intro" href="#xmpp-intro"></a>36.1&nbsp;Introduction</h2></div></div></div>

<p>XMPP describes a way for multiple agents to communicate with each other in a distributed system.
The canonical use case is to send and receive chat messages, though XMPP can be, and is, used for far more applications.
XMPP is used to describe a network of actors.
Within that network, actors may address each other directly, as well as broadcast status changes (e.g.
"presence").</p>
<p>XMPP provides the messaging fabric that underlies some of the biggest Instant Messaging networks in the world, including Google Talk (GTalk) - which is also available from within GMail - and Facebook Chat.
There are many good open-source XMPP servers available.
Two popular implementations are <a class="ulink" href="http://www.igniterealtime.org/projects/openfire/" target="_top"><span class="emphasis"><em>Openfire</em></span></a> and <a class="ulink" href="http://www.ejabberd.im" target="_top"><span class="emphasis"><em>ejabberd</em></span></a></p>
<p>Spring integration provides support for XMPP via XMPP adapters which support sending and receiving both XMPP chat messages and presence changes from other entries in your roster.
As with other adapters, the XMPP adapters come with support for a convenient namespace-based configuration.
To configure the XMPP namespace, include the following elements in the headers of your XML configuration file:</p>
<pre class="programlisting">xmlns:int-xmpp="http://www.springframework.org/schema/integration/xmpp"
xsi:schemaLocation="http://www.springframework.org/schema/integration/xmpp
	http://www.springframework.org/schema/integration/xmpp/spring-integration-xmpp.xsd"</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xmpp-connection" href="#xmpp-connection"></a>36.2&nbsp;XMPP Connection</h2></div></div></div>

<p>Before using inbound or outbound XMPP adapters to participate in the XMPP network, an actor must establish its XMPP connection.
This connection object could be shared by all XMPP adapters connected to a particular account.
Typically this requires - at a minimum -<code class="literal">user</code>, <code class="literal">password</code>, and <code class="literal">host</code>.
To create a basic XMPP connection, you can utilize the convenience of the namespace.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-xmpp:xmpp-connection</span>
    <span class="hl-attribute">id</span>=<span class="hl-value">"myConnection"</span>
    <span class="hl-attribute">user</span>=<span class="hl-value">"user"</span>
    <span class="hl-attribute">password</span>=<span class="hl-value">"password"</span>
    <span class="hl-attribute">host</span>=<span class="hl-value">"host"</span>
    <span class="hl-attribute">port</span>=<span class="hl-value">"port"</span>
    <span class="hl-attribute">resource</span>=<span class="hl-value">"theNameOfTheResource"</span>
    <span class="hl-attribute">subscription-mode</span>=<span class="hl-value">"accept_all"</span><span class="hl-tag">/&gt;</span></pre>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>For added convenience you can rely on the default naming convention and omit the <code class="literal">id</code> attribute.
The default name <span class="emphasis"><em>xmppConnection</em></span> will be used for this connection bean.</p>
</td></tr></table></div>
<p>If the XMPP Connection goes stale, reconnection attempts will be made with an automatic login as long as the previous connection state was logged (authenticated).
We also register a <code class="literal">ConnectionListener</code> which will log connection events if the DEBUG logging level is enabled.</p>
<p>The <code class="literal">subscription-mode</code> initiates the Roster listener to deal with incoming subscriptions from other users.
This functionality isn&#8217;t always available for the target XMPP servers.
For example GCM/FCM fully disables it.
To switch off the Roster listener for subscriptions you should configure it with an empty string when using XML configuration: <code class="literal">subscription-mode=""</code>, or with <code class="literal">XmppConnectionFactoryBean.setSubscriptionMode(null)</code> when using Java Configuration. Doing so will disable Roster at the login phase as well.
See <code class="literal">Roster.setRosterLoadedAtLogin(Boolean)</code> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xmpp-messages" href="#xmpp-messages"></a>36.3&nbsp;XMPP Messages</h2></div></div></div>

<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="xmpp-message-inbound-channel-adapter" href="#xmpp-message-inbound-channel-adapter"></a>36.3.1&nbsp;Inbound Message Channel Adapter</h3></div></div></div>

<p>The Spring Integration adapters support receiving chat messages from other users in the system.
To do this, the <span class="emphasis"><em>Inbound Message Channel Adapter</em></span> "logs in" as a user on your behalf and receives the messages sent to that user.
Those messages are then forwarded to your Spring Integration client.
Configuration support for the XMPP <span class="emphasis"><em>Inbound Message Channel Adapter</em></span> is provided via the <code class="literal">inbound-channel-adapter</code> element.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-xmpp:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"xmppInboundAdapter"</span>
	<span class="hl-attribute">channel</span>=<span class="hl-value">"xmppInbound"</span>
	<span class="hl-attribute">xmpp-connection</span>=<span class="hl-value">"testConnection"</span>
	<span class="hl-attribute">payload-expression</span>=<span class="hl-value">"getExtension('google:mobile:data').json"</span>
	<span class="hl-attribute">stanza-filter</span>=<span class="hl-value">"stanzaFilter"</span>
	<span class="hl-attribute">auto-startup</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span></pre>
<p>As you can see amongst the usual attributes this adapter also requires a reference to an XMPP Connection.</p>
<p>It is also important to mention that the XMPP inbound adapter is an <span class="emphasis"><em>event driven adapter</em></span> and a <code class="literal">Lifecycle</code> implementation.
When started it will register a <code class="literal">PacketListener</code> that will listen for incoming XMPP Chat Messages.
It forwards any received messages to the underlying adapter which will convert them to Spring Integration Messages and send them to the specified <code class="literal">channel</code>.
It will unregister the <code class="literal">PacketListener</code> when it is stopped.</p>
<p>Starting with <span class="emphasis"><em>version 4.3</em></span> the <code class="literal">ChatMessageListeningEndpoint</code> (and its <code class="literal">&lt;int-xmpp:inbound-channel-adapter&gt;</code>)
supports a <code class="literal">org.jivesoftware.smack.filter.StanzaFilter</code> injection to be registered on the provided <code class="literal">XMPPConnection</code>
together with an internal <code class="literal">StanzaListener</code> implementation.
See their <a class="ulink" href="https://www.igniterealtime.org/builds/smack/docs/latest/javadoc/org/jivesoftware/smack/XMPPConnection.html#addAsyncStanzaListener%28org.jivesoftware.smack.StanzaListener,%20org.jivesoftware.smack.filter.StanzaFilter%29" target="_top">JavaDocs</a> for more information.</p>
<p>Also with the <span class="emphasis"><em>version 4.3</em></span> the <code class="literal">payload-expression</code> has been introduced for the <code class="literal">ChatMessageListeningEndpoint</code>.
The incoming <code class="literal">org.jivesoftware.smack.packet.Message</code> represents a root object of evaluation context.
This option is useful in case of <a class="xref" href="#xmpp-extensions" title="36.7&nbsp;XMPP Extensions">Section&nbsp;36.7, &#8220;XMPP Extensions&#8221;</a>.
For example, for the GCM protocol we can extract the body using expression:</p>
<pre class="programlisting">payload-expression="getExtension('google:mobile:data').json"</pre>
<p>for the XHTML protocol:</p>
<pre class="programlisting">payload-expression="getExtension(T(org.jivesoftware.smackx.xhtmlim.packet.XHTMLExtension).NAMESPACE).bodies[0]"</pre>
<p>To simplify the access to the Extension in the XMPP Message, the <code class="literal">extension</code> variable is added into the
<code class="literal">EvaluationContext</code>.
Note, it is done only when one and only one Extension is present in the Message.
The samples above with the <code class="literal">namespace</code> manipulations can be simplified to something like:</p>
<pre class="programlisting"> ----
 payload-expression="#extension.json"
 payload-expression="#extension.bodies[0]"
 ----</pre>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The <code class="literal">extract-payload</code> option has been deprecated in favor of the new <code class="literal">payload-expression</code> one.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="xmpp-message-outbound-channel-adapter" href="#xmpp-message-outbound-channel-adapter"></a>36.3.2&nbsp;Outbound Message Channel Adapter</h3></div></div></div>

<p>You may also send chat messages to other users on XMPP using the <span class="emphasis"><em>Outbound Message Channel Adapter</em></span>.
Configuration support for the XMPP <span class="emphasis"><em>Outbound Message Channel Adapter</em></span> is provided via the <code class="literal">outbound-channel-adapter</code> element.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-xmpp:outbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"outboundEventAdapter"</span>
						<span class="hl-attribute">channel</span>=<span class="hl-value">"outboundEventChannel"</span>
						<span class="hl-attribute">xmpp-connection</span>=<span class="hl-value">"testConnection"</span><span class="hl-tag">/&gt;</span></pre>
<p>The adapter expects as its input - at a minimum - a payload of type <code class="literal">java.lang.String</code>, and a header value for
<code class="literal">XmppHeaders.CHAT_TO</code> that specifies to which user the Message should be sent.
To create a message you might use the following Java code:</p>
<pre class="programlisting">Message&lt;String&gt; xmppOutboundMsg = MessageBuilder.withPayload(<span class="hl-string">"Hello, XMPP!"</span> )
						.setHeader(XmppHeaders.CHAT_TO, <span class="hl-string">"userhandle"</span>)
						.build();</pre>
<p>Another mechanism of setting the header is by using the XMPP header-enricher support.
Here is an example.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-xmpp:header-enricher</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span><span class="hl-tag">&gt;</span>
	<span class="hl-tag">&lt;int-xmpp:chat-to</span> <span class="hl-attribute">value</span>=<span class="hl-value">"test1@example.org"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-xmpp:header-enricher&gt;</span></pre>
<p>Starting with <span class="emphasis"><em>version 4.3</em></span> the packet extension support has been added to the <code class="literal">ChatMessageSendingMessageHandler</code>
(<code class="literal">&lt;int-xmpp:outbound-channel-adapter&gt;</code>).
Alongside with the regular <code class="literal">String</code> and <code class="literal">org.jivesoftware.smack.packet.Message</code> <code class="literal">payload</code>, now you can send a message
with a <code class="literal">payload</code> as a <code class="literal">org.jivesoftware.smack.packet.ExtensionElement</code> which is populated to the
<code class="literal">org.jivesoftware.smack.packet.Message.addExtension()</code> instead of <code class="literal">setBody()</code>.
For the convenience an <code class="literal">extension-provider</code> option has been added for the <code class="literal">ChatMessageSendingMessageHandler</code>
to allow to inject <code class="literal">org.jivesoftware.smack.provider.ExtensionElementProvider</code>, which builds an <code class="literal">ExtensionElement</code>
against the <code class="literal">payload</code> at runtime.
For this case the payload must be <code class="literal">String</code> in JSON or XML format depending of the XEP protocol.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xmpp-presence" href="#xmpp-presence"></a>36.4&nbsp;XMPP Presence</h2></div></div></div>

<p>XMPP also supports broadcasting state.
You can use this capability to let people who have you on their roster see your state changes.
This happens all the time with your IM clients; you change your away status, and then set an away message, and everybody who has you on their roster sees your icon or username change to reflect this new state, and additionally might see your new "away" message.
If you would like to receive notification, or notify others, of state changes, you can use Spring Integration&#8217;s "presence" adapters.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="xmpp-roster-inbound-channel-adapter" href="#xmpp-roster-inbound-channel-adapter"></a>36.4.1&nbsp;Inbound Presence Message Channel Adapter</h3></div></div></div>

<p>Spring Integration provides an <span class="emphasis"><em>Inbound Presence Message Channel Adapter</em></span> which supports receiving Presence events from other users in the system who happen to be on your Roster.
To do this, the adapter "logs in" as a user on your behalf, registers a <code class="literal">RosterListener</code> and forwards received Presence update events as Messages to the channel identified by the <code class="literal">channel</code> attribute.
The payload of the Message will be a <code class="literal">org.jivesoftware.smack.packet.Presence</code> object (see <a class="ulink" href="https://www.igniterealtime.org/builds/smack/docs/latest/javadoc/org/jivesoftware/smack/packet/Presence.html" target="_top">https://www.igniterealtime.org/builds/smack/docs/latest/javadoc/org/jivesoftware/smack/packet/Presence.html</a>).</p>
<p>Configuration support for the XMPP <span class="emphasis"><em>Inbound Presence Message Channel Adapter</em></span> is provided via the <code class="literal">presence-inbound-channel-adapter</code> element.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-xmpp:presence-inbound-channel-adapter</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"outChannel"</span>
		<span class="hl-attribute">xmpp-connection</span>=<span class="hl-value">"testConnection"</span> <span class="hl-attribute">auto-startup</span>=<span class="hl-value">"false"</span><span class="hl-tag">/&gt;</span></pre>
<p>As you can see amongst the usual attributes this adapter also requires a reference to an XMPP Connection.
It is also important to mention that this adapter is an event driven adapter and a <code class="literal">Lifecycle</code> implementation.
It will register a <code class="literal">RosterListener</code> when started and will unregister that <code class="literal">RosterListener</code> when stopped.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="xmpp-roster-outbound-channel-adapter" href="#xmpp-roster-outbound-channel-adapter"></a>36.4.2&nbsp;Outbound Presence Message Channel Adapter</h3></div></div></div>

<p>Spring Integration also supports sending Presence events to be seen by other users in the network who happen to have you on their Roster.
When you send a Message to the <span class="emphasis"><em>Outbound Presence Message Channel Adapter</em></span> it extracts the payload, which is expected to be of type <code class="literal">org.jivesoftware.smack.packet.Presence</code> and sends it to the XMPP Connection, thus advertising your presence events to the rest of the network.</p>
<p>Configuration support for the XMPP <span class="emphasis"><em>Outbound Presence Message Channel Adapter</em></span> is provided via the <code class="literal">presence-outbound-channel-adapter</code> element.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-xmpp:presence-outbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"eventOutboundPresenceChannel"</span>
	<span class="hl-attribute">xmpp-connection</span>=<span class="hl-value">"testConnection"</span><span class="hl-tag">/&gt;</span></pre>
<p>It can also be a <span class="emphasis"><em>Polling Consumer</em></span> (if it receives Messages from a Pollable Channel) in which case you would need to register a Poller.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-xmpp:presence-outbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"pollingOutboundPresenceAdapter"</span>
		<span class="hl-attribute">xmpp-connection</span>=<span class="hl-value">"testConnection"</span>
		<span class="hl-attribute">channel</span>=<span class="hl-value">"pollingChannel"</span><span class="hl-tag">&gt;</span>
	<span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"1000"</span> <span class="hl-attribute">max-messages-per-poll</span>=<span class="hl-value">"1"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-xmpp:presence-outbound-channel-adapter&gt;</span></pre>
<p>Like its inbound counterpart, it requires a reference to an XMPP Connection.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>If you are relying on the default naming convention for an XMPP Connection bean (described earlier), and you have only one XMPP Connection bean configured in your Application Context, you may omit the <code class="literal">xmpp-connection</code> attribute.
In that case, the bean with the name <span class="emphasis"><em>xmppConnection</em></span> will be located and injected into the adapter.</p>
</td></tr></table></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xmpp-advanced" href="#xmpp-advanced"></a>36.5&nbsp;Advanced Configuration</h2></div></div></div>

<p>Since Spring Integration XMPP support is based on the Smack 4.0 API (<a class="ulink" href="http://www.igniterealtime.org/projects/smack/" target="_top">http://www.igniterealtime.org/projects/smack/</a>), it is important to know a few details related to more complex configuration of the XMPP Connection object.</p>
<p>As stated earlier the <code class="literal">xmpp-connection</code> namespace support is designed to simplify basic connection configuration and only supports a few common configuration attributes.
However, the <code class="literal">org.jivesoftware.smack.ConnectionConfiguration</code> object defines about 20 attributes, and there is no real value of adding namespace support for all of them.
So, for more complex connection configurations, simply configure an instance of our <code class="literal">XmppConnectionFactoryBean</code> as a regular bean, and inject a <code class="literal">org.jivesoftware.smack.ConnectionConfiguration</code> as a constructor argument to that FactoryBean.
Every property you need, can be specified directly on that ConnectionConfiguration instance (a bean definition with the <span class="emphasis"><em>p</em></span> namespace would work well).
This way SSL, or any other attributes, could be set directly.
Here&#8217;s an example:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"xmppConnection"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.xmpp.XmppConnectionFactoryBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.jivesoftware.smack.ConnectionConfiguration"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"myServiceName"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"socketFactory"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"..."</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/bean&gt;</span>
    <span class="hl-tag">&lt;/constructor-arg&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"outboundEventChannel"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int-xmpp:outbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"outboundEventAdapter"</span>
    <span class="hl-attribute">channel</span>=<span class="hl-value">"outboundEventChannel"</span>
    <span class="hl-attribute">xmpp-connection</span>=<span class="hl-value">"xmppConnection"</span><span class="hl-tag">/&gt;</span></pre>
<p>Another important aspect of the Smack API is static initializers.
For more complex cases (e.g., registering a SASL Mechanism), you may need to execute certain static initializers.
One of those static initializers is <code class="literal">SASLAuthentication</code>, which allows you to register supported SASL mechanisms.
For that level of complexity, we would recommend Spring JavaConfig-style of the XMPP Connection configuration.
Then, you can configure the entire component through Java code and execute all other necessary Java code including static initializers at the appropriate time.</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Configuration</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> CustomConnectionConfiguration {
  <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
  <span class="hl-keyword">public</span> XMPPConnection xmppConnection() {
	SASLAuthentication.supportSASLMechanism(<span class="hl-string">"EXTERNAL"</span>, <span class="hl-number">0</span>); <span class="hl-comment">// static initializer</span>

	ConnectionConfiguration config = <span class="hl-keyword">new</span> ConnectionConfiguration(<span class="hl-string">"localhost"</span>, <span class="hl-number">5223</span>);
	config.setTrustorePath(<span class="hl-string">"path_to_truststore.jks"</span>);
	config.setSecurityEnabled(true);
	config.setSocketFactory(SSLSocketFactory.getDefault());
	<span class="hl-keyword">return</span> <span class="hl-keyword">new</span> XMPPConnection(config);
  }
}</pre>
<p>For more information on the JavaConfig style of Application Context configuration, refer to the following section
in the <a class="ulink" href="http://docs.spring.io/spring/docs/current/spring-framework-reference/html/beans.html#beans-java" target="_top">Spring Reference Manual</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xmpp-message-headers" href="#xmpp-message-headers"></a>36.6&nbsp;XMPP Message Headers</h2></div></div></div>

<p>The Spring Integration XMPP Adapters will map standard XMPP properties automatically.
These properties will be copied by default to and from Spring Integration <code class="literal">MessageHeaders</code> using the
<a class="ulink" href="http://docs.spring.io/spring-integration/api/org/springframework/integration/xmpp/support/DefaultXmppHeaderMapper.html" target="_top">DefaultXmppHeaderMapper</a>.</p>
<p>Any user-defined headers will NOT be copied to or from an XMPP Message, unless explicitly specified by the
<span class="emphasis"><em>requestHeaderNames</em></span> and/or <span class="emphasis"><em>replyHeaderNames</em></span> properties of the <code class="literal">DefaultXmppHeaderMapper</code>.</p>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>When mapping user-defined headers, the values can also contain simple wildcard patterns (e.g. "foo*" or "*foo") to
be matched.</p>
</td></tr></table></div>
<p>Starting with <span class="emphasis"><em>version 4.1</em></span>, the <code class="literal">AbstractHeaderMapper</code> (a <code class="literal">DefaultXmppHeaderMapper</code> superclass) allows the
<code class="literal">NON_STANDARD_HEADERS</code> token to be configured for the <span class="emphasis"><em>requestHeaderNames</em></span> property (in addition to existing
<code class="literal">STANDARD_REQUEST_HEADERS</code>) to map all user-defined headers.</p>
<p>Class <code class="literal">org.springframework.xmpp.XmppHeaders</code> identifies the default headers that will be used by the <code class="literal">DefaultXmppHeaderMapper</code>:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
xmpp_from
</li><li class="listitem">
xmpp_subject
</li><li class="listitem">
xmpp_thread
</li><li class="listitem">
xmpp_to
</li><li class="listitem">
xmpp_type
</li></ul></div>
<p>Starting with <span class="emphasis"><em>version 4.3</em></span>, patterns in the header mappings can be negated by preceding the pattern with <code class="literal">!</code>.
Negated patterns get priority, so a list such as
<code class="literal">STANDARD_REQUEST_HEADERS,foo,ba*,!bar,!baz,qux,!foo</code> will <span class="strong"><strong>NOT</strong></span> map <code class="literal">foo</code>
(nor <code class="literal">bar</code> nor <code class="literal">baz</code>); the standard headers plus <code class="literal">bad</code>, <code class="literal">qux</code> will be mapped.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>If you have a user defined header that begins with <code class="literal">!</code> that you <span class="strong"><strong>do</strong></span> wish to map, you need to escape it with
<code class="literal">\</code> thus: <code class="literal">STANDARD_REQUEST_HEADERS,\!myBangHeader</code> and it <span class="strong"><strong>WILL</strong></span> be mapped.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xmpp-extensions" href="#xmpp-extensions"></a>36.7&nbsp;XMPP Extensions</h2></div></div></div>

<p>The XMPP protocol stands for <span class="strong"><strong>eXstensible Messaging and Presence Protocol</strong></span>.
The "extensible" part is important.
XMPP is based around XML, a data format that supports a concept known as <span class="emphasis"><em>namespacing</em></span>.</p>
<p>Through namespacing, you can add bits to XMPP that are not defined in the original specifications.
This is important because the XMPP specification deliberately describes only a set of core things like:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
How a client connects to a server
</li><li class="listitem">
Encryption (SSL/TLS)
</li><li class="listitem">
Authentication
</li><li class="listitem">
How servers can communicate with each other to relay messages
</li><li class="listitem">
and a few other basic building blocks.
</li></ul></div>
<p>Once you have implemented this, you have an XMPP client and can send any kind of data you like.
But that&#8217;s not the end.</p>
<p>For example, perhaps you decide that you want to include formatting in a message (bold, italic, etc.) which is not
defined in the core XMPP specification.
Well, you can make up a way to do that, but unless everyone else does it the same way as you,
no other software will be able interpret it (they will just ignore namespaces they don&#8217;t understand).</p>
<p>So the XMPP Standards Foundation (XSF) publishes a series of extra documents, known as
<a class="ulink" href="http://xmpp.org/extensions/xep-0001.html" target="_top">XMPP Enhancement Proposals</a> (XEPs).
In general each XEP describes a particular activity (from message formatting, to file transfers, multi-user
chats and many more), and they provide a standard format for everyone to use for that activity.</p>
<p>The Smack API provides many XEP implementations with its <code class="literal">extensions</code> and <code class="literal">experimental</code>
<a class="ulink" href="http://www.igniterealtime.org/builds/smack/docs/latest/documentation/extensions/index.html" target="_top">projects</a>.
And starting with Spring Integration <span class="emphasis"><em>version 4.3</em></span> any XEP can be use with the existing XMPP channel adapters.</p>
<p>To be able to process XEPs or any other custom XMPP extensions, the Smack&#8217;s <code class="literal">ProviderManager</code> pre-configuration
must be provided.
It can be done via direct usage from the <code class="literal">static</code> Java code:</p>
<pre class="programlisting">ProviderManager.addIQProvider(<span class="hl-string">"element"</span>, <span class="hl-string">"namespace"</span>, <span class="hl-keyword">new</span> MyIQProvider());
ProviderManager.addExtensionProvider(<span class="hl-string">"element"</span>, <span class="hl-string">"namespace"</span>, <span class="hl-keyword">new</span> MyExtProvider());</pre>
<p>or via <code class="literal">.providers</code> configuration file in the specific instance and JVM argument:</p>
<pre class="programlisting">-Dsmack.provider.file=file:///c:/my/provider/mycustom.providers</pre>
<p>where <code class="literal">mycustom.providers</code> might be like this:</p>
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0"?&gt;</span>
<span class="hl-tag">&lt;smackProviders&gt;</span>
<span class="hl-tag">&lt;iqProvider&gt;</span>
    <span class="hl-tag">&lt;elementName&gt;</span>query<span class="hl-tag">&lt;/elementName&gt;</span>
    <span class="hl-tag">&lt;namespace&gt;</span>jabber:iq:time<span class="hl-tag">&lt;/namespace&gt;</span>
    <span class="hl-tag">&lt;className&gt;</span>org.jivesoftware.smack.packet.Time<span class="hl-tag">&lt;/className&gt;</span>
<span class="hl-tag">&lt;/iqProvider&gt;</span>

<span class="hl-tag">&lt;iqProvider&gt;</span>
    <span class="hl-tag">&lt;elementName&gt;</span>query<span class="hl-tag">&lt;/elementName&gt;</span>
    <span class="hl-tag">&lt;namespace&gt;</span>http://jabber.org/protocol/disco#items<span class="hl-tag">&lt;/namespace&gt;</span>
    <span class="hl-tag">&lt;className&gt;</span>org.jivesoftware.smackx.provider.DiscoverItemsProvider<span class="hl-tag">&lt;/className&gt;</span>
<span class="hl-tag">&lt;/iqProvider&gt;</span>

<span class="hl-tag">&lt;extensionProvider&gt;</span>
    <span class="hl-tag">&lt;elementName&gt;</span>subscription<span class="hl-tag">&lt;/elementName&gt;</span>
    <span class="hl-tag">&lt;namespace&gt;</span>http://jabber.org/protocol/pubsub<span class="hl-tag">&lt;/namespace&gt;</span>
    <span class="hl-tag">&lt;className&gt;</span>org.jivesoftware.smackx.pubsub.provider.SubscriptionProvider<span class="hl-tag">&lt;/className&gt;</span>
<span class="hl-tag">&lt;/extensionProvider&gt;</span>
<span class="hl-tag">&lt;/smackProviders&gt;</span></pre>
<p>For example the most popular XMPP messaging extension is
<a class="ulink" href="https://developers.google.com/cloud-messaging/" target="_top">Google Cloud Messaging</a> (GCM).
The Smack provides the particular <code class="literal">org.jivesoftware.smackx.gcm.provider.GcmExtensionProvider</code> for that and
registers that by default with the <code class="literal">smack-experimental</code> jar in the classpath using <code class="literal">experimental.providers</code> resource:</p>
<pre class="programlisting"><span class="hl-comment">&lt;!-- GCM JSON payload --&gt;</span>
<span class="hl-tag">&lt;extensionProvider&gt;</span>
    <span class="hl-tag">&lt;elementName&gt;</span>gcm<span class="hl-tag">&lt;/elementName&gt;</span>
    <span class="hl-tag">&lt;namespace&gt;</span>google:mobile:data<span class="hl-tag">&lt;/namespace&gt;</span>
    <span class="hl-tag">&lt;className&gt;</span>org.jivesoftware.smackx.gcm.provider.GcmExtensionProvider<span class="hl-tag">&lt;/className&gt;</span>
<span class="hl-tag">&lt;/extensionProvider&gt;</span></pre>
<p>Also the <code class="literal">GcmPacketExtension</code> is present for the target messaging protocol to parse incoming packets and build outgoing:</p>
<pre class="programlisting">GcmPacketExtension gcmExtension = (GcmPacketExtension) xmppMessage.getExtension(GcmPacketExtension.NAMESPACE);
String message = gcmExtension.getJson());</pre>
<pre class="programlisting">GcmPacketExtension packetExtension = <span class="hl-keyword">new</span> GcmPacketExtension(gcmJson);
Message smackMessage = <span class="hl-keyword">new</span> Message();
smackMessage.addExtension(packetExtension);</pre>
<p>See <a class="xref" href="#xmpp-message-inbound-channel-adapter" title="36.3.1&nbsp;Inbound Message Channel Adapter">Section&nbsp;36.3.1, &#8220;Inbound Message Channel Adapter&#8221;</a> and <a class="xref" href="#xmpp-message-outbound-channel-adapter" title="36.3.2&nbsp;Outbound Message Channel Adapter">Section&nbsp;36.3.2, &#8220;Outbound Message Channel Adapter&#8221;</a> above for more information.</p>
</div>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="zookeeper" href="#zookeeper"></a>37.&nbsp;Zookeeper Support</h2></div></div></div>

<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_introduction_5" href="#_introduction_5"></a>37.1&nbsp;Introduction</h2></div></div></div>

<p><a class="ulink" href="https://zookeeper.apache.org/" target="_top">Zookeeper</a> support was added to the framework in <span class="emphasis"><em>version 4.2</em></span>, comprised of:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
MetadataStore
</li><li class="listitem">
LockRegistry
</li><li class="listitem">
Leadership Event Handling
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="zk-metadata-store" href="#zk-metadata-store"></a>37.2&nbsp;Zookeeper Metadata Store</h2></div></div></div>

<p>The <code class="literal">ZookeeperMetadataStore</code> can be used where any <code class="literal">MetadataStore</code> is needed, such as peristent file list filters,
etc.
See <a class="xref" href="#metadata-store" title="9.5&nbsp;Metadata Store">Section&nbsp;9.5, &#8220;Metadata Store&#8221;</a> for more information.</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"client"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.zookeeper.config.CuratorFrameworkFactoryBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"${connect.string}"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"meta"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.zookeeper.metadata.ZookeeperMetadataStore"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"client"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> MetadataStore zkStore(CuratorFramework client) {
    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> ZookeeperMetadataStore(client);
}</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="zk-lock-registry" href="#zk-lock-registry"></a>37.3&nbsp;Zookeeper Lock Registry</h2></div></div></div>

<p>The <code class="literal">ZookeeperLockRegistry</code> can be used where any <code class="literal">LockRegistry</code> is needed, such as when using an <code class="literal">Aggregator</code> in a
clustered environment, with a shared <code class="literal">MessageStore</code>.</p>
<p>A <code class="literal">LocRegistry</code> is used to "look up" a lock based on a key (the aggregator uses the <code class="literal">correlationId</code>).
By default, locks in the <code class="literal">ZookeeperLockRegistry</code> are maintained in zookeeper under the path
<code class="literal">/SpringIntegration-LockRegistry/</code>.
You can customize the path by providing an implementation of <code class="literal">ZookeeperLockRegistry.KeyToPathStrategy</code>.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> KeyToPathStrategy {

    String pathFor(String key);

    <span class="hl-keyword">boolean</span> bounded();

}</pre>
<p>If the strategy returns <code class="literal">true</code> from <code class="literal">isBounded</code>, unused locks do not need to be harvested.
For unbounded strategies (such as the default) you will need to invoke <code class="literal">expireUnusedOlderThan(long age)</code> from time
to time, to remove old unused locks from memory.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="zk-leadership" href="#zk-leadership"></a>37.4&nbsp;Zookeeper Leadership Event Handling</h2></div></div></div>

<p>To configure an application for leader election using Zookeeper in XML:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-zk:leader-listener</span> <span class="hl-attribute">client</span>=<span class="hl-value">"client"</span> <span class="hl-attribute">path</span>=<span class="hl-value">"/siNamespace"</span> <span class="hl-attribute">role</span>=<span class="hl-value">"cluster"</span><span class="hl-tag"> /&gt;</span></pre>
<p><code class="literal">client</code> is a reference to a <code class="literal">CuratorFramework</code> bean; a <code class="literal">CuratorFrameworkFactoryBean</code> is available.
When a leader is elected, an <code class="literal">OnGrantedEvent</code> will be published for the role <code class="literal">cluster</code>; any endpoints in that role
will be started.
When leadership is revoked, an <code class="literal">OnRevokedEvent</code> will be published for the role <code class="literal">cluster</code>; any endpoints in that role
will be stopped.
See <a class="xref" href="#endpoint-roles" title="8.2&nbsp;Endpoint Roles">Section&nbsp;8.2, &#8220;Endpoint Roles&#8221;</a> for more information.</p>
<p>In Java configuration you can create an instance of the leader initiator like this:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> LeaderInitiatorFactoryBean leaderInitiator(CuratorFramework client) {
    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> LeaderInitiatorFactoryBean(client, <span class="hl-string">"/siTest/"</span>, <span class="hl-string">"cluster"</span>);
}</pre>
</div>
</div>
</div>
<div class="part"><div class="titlepage"><div><div><h1 class="title"><a name="spring-integration-appendices" href="#spring-integration-appendices"></a>Part&nbsp;VI.&nbsp;Appendices</h1></div></div></div>

<div class="partintro"><div></div>
<p>Advanced Topics and Additional Resources</p>
</div>
<div class="appendix"><div class="titlepage"><div><div><h2 class="title"><a name="spel" href="#spel"></a>Appendix&nbsp;A.&nbsp;Spring Expression Language (SpEL)</h2></div></div></div>

<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="spel-intro" href="#spel-intro"></a>A.1&nbsp;Introduction</h2></div></div></div>

<p>Many Spring Integration components can be configured using expressions.
These expressions are written in the <a class="ulink" href="http://static.springsource.org/spring-framework/docs/current/spring-framework-reference/html/expressions.html" target="_top">Spring Expression Language</a>.</p>
<p>In most cases, the <span class="emphasis"><em>#root</em></span> object is the <code class="literal">Message</code> which, of course, has two properties - <code class="literal">headers</code> and <code class="literal">payload</code> - allowing such expressions as <code class="literal">payload</code>, <code class="literal">payload.foo</code>, <code class="literal">headers['my.header']</code> etc.</p>
<p>In some cases, additional variables are provided, for example the <code class="literal">&lt;int-http:inbound-gateway/&gt;</code> provides <code class="literal">#requestParams</code> (parameters from the HTTP request) and <code class="literal">#pathVariables</code> (values from path placeholders in the URI).</p>
<p>For all SpEL expressions, a <code class="literal">BeanResolver</code> is available, enabling references to any bean in the application context.
For example <code class="literal">@myBean.foo(payload)</code>.
In addition, two <code class="literal">PropertyAccessors</code> are available; a <code class="literal">MapAccessor</code> enables accessing values in a <code class="literal">Map</code> using a key, and a <code class="literal">ReflectivePropertyAccessor</code> which allows access to fields and or JavaBean compliant properties (using getters and setters).
This is how the <code class="literal">Message</code> headers and payload properties are accessible.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="spel-customization" href="#spel-customization"></a>A.2&nbsp;SpEL Evaluation Context Customization</h2></div></div></div>

<p>Starting with Spring Integration 3.0, it is possible to add additional <code class="literal">PropertyAccessor</code> s to the SpEL evaluation contexts used by the framework.
The framework provides the <code class="literal">JsonPropertyAccessor</code> which can be used (read-only) to access fields from a <code class="literal">JsonNode</code>, or JSON in a <code class="literal">String</code>.
Or you can create your own <code class="literal">PropertyAccessor</code> if you have specific needs.</p>
<p>In addition, custom functions can be added.
Custom functions are <code class="literal">static</code> methods declared on a class.
Functions and property accessors are available in any SpEL expression used throughout the framework.</p>
<p>The following configuration shows how to directly configure the <code class="literal">IntegrationEvaluationContextFactoryBean</code> with custom property accessors and functions.
However, for convenience, namespace support is provided for both, as described in the following sections, and the framework will automatically configure the factory bean on your behalf.</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"integrationEvaluationContext"</span>
			<span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.config.IntegrationEvaluationContextFactoryBean"</span><span class="hl-tag">&gt;</span>
	<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"propertyAccessors"</span><span class="hl-tag">&gt;</span>
		<span class="hl-tag">&lt;util:map&gt;</span>
			<span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"foo"</span><span class="hl-tag">&gt;</span>
				<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"foo.MyCustomPropertyAccessor"</span><span class="hl-tag">/&gt;</span>
			<span class="hl-tag">&lt;/entry&gt;</span>
		<span class="hl-tag">&lt;/util:map&gt;</span>
	<span class="hl-tag">&lt;/property&gt;</span>
	<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"functions"</span><span class="hl-tag">&gt;</span>
		<span class="hl-tag">&lt;map&gt;</span>
			<span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"barcalc"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"#{T(foo.MyFunctions).getMethod('calc', T(foo.MyBar))}"</span><span class="hl-tag">/&gt;</span>
		<span class="hl-tag">&lt;/map&gt;</span>
	<span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
<p>This factory bean definition will override the default <code class="literal">integrationEvaluationContext</code> bean definition, adding the custom accessor to the list (which also includes the standard accessors mentioned above), and one custom function.</p>
<p>Note that custom functions are static methods.
In the above example, the custom function is a static method <code class="literal">calc</code> on class <code class="literal">MyFunctions</code> and takes a single parameter of type <code class="literal">MyBar</code>.</p>
<p>Say you have a <code class="literal">Message</code> with a payload that has a type <code class="literal">MyFoo</code> on which you need to perform some action to create a <code class="literal">MyBar</code> object from it, and you then want to invoke a custom function <code class="literal">calc</code> on that object.</p>
<p>The standard property accessors wouldn&#8217;t know how to get a <code class="literal">MyBar</code> from a <code class="literal">MyFoo</code> so you could write and configure a custom property accessor to do so.
So, your final expression might be <code class="literal">"#barcalc(payload.myBar)"</code>.</p>
<p>The factory bean has another property <code class="literal">typeLocator</code> which allows you to customize the <code class="literal">TypeLocator</code> used during SpEL evaluation.
This might be necessary when running in some environments that use a non-standard <code class="literal">ClassLoader</code>.
In the following example, SpEL expressions will always use the bean factory&#8217;s class loader:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"integrationEvaluationContext"</span>
		<span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.config.IntegrationEvaluationContextFactoryBean"</span><span class="hl-tag">&gt;</span>
	<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"typeLocator"</span><span class="hl-tag">&gt;</span>
		<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.expression.spel.support.StandardTypeLocator"</span><span class="hl-tag">&gt;</span>
			<span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"#{beanFactory.beanClassLoader}"</span><span class="hl-tag">/&gt;</span>
		<span class="hl-tag">&lt;/bean&gt;</span>
	<span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="spel-functions" href="#spel-functions"></a>A.3&nbsp;SpEL Functions</h2></div></div></div>

<p>Namespace support is provided for easy addition of SpEL custom functions.
You can specify <code class="literal">&lt;spel-function/&gt;</code> components to provide <a class="ulink" href="http://static.springsource.org/spring-framework/docs/current/spring-framework-reference/html/expressions.html#expressions-ref-functions" target="_top">custom SpEL functions</a> to the <code class="literal">EvaluationContext</code> used throughout the framework.
Instead of configuring the factory bean above, simply add one or more of these components and the framework will automatically add them to the default <span class="emphasis"><em>integrationEvaluationContext</em></span> factory bean.</p>
<p>For example, assuming we have a useful static method to evaluate XPath:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:spel-function</span> <span class="hl-attribute">id</span>=<span class="hl-value">"xpath"</span>
	<span class="hl-attribute">class</span>=<span class="hl-value">"com.foo.test.XPathUtils"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"evaluate(java.lang.String, java.lang.Object)"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int:transformer</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"in"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"out"</span>
		 <span class="hl-attribute">expression</span>=<span class="hl-value">"#xpath('//foo/@bar', payload)"</span><span class="hl-tag"> /&gt;</span></pre>
<p>With this sample:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
The default <code class="literal">IntegrationEvaluationContextFactoryBean</code> bean with id <span class="emphasis"><em>integrationEvaluationContext</em></span> is registered with the application context.
</li><li class="listitem">
The <code class="literal">&lt;spel-function/&gt;</code> is parsed and added to the <code class="literal">functions</code> Map of <span class="emphasis"><em>integrationEvaluationContext</em></span> as map entry with <code class="literal">id</code> as the key and the static <code class="literal">Method</code> as the value.
</li><li class="listitem">
The <span class="emphasis"><em>integrationEvaluationContext</em></span> factory bean creates a new <code class="literal">StandardEvaluationContext</code> instance, and it is configured with the default <code class="literal">PropertyAccessor</code> s, <code class="literal">BeanResolver</code> and the custom functions.
</li><li class="listitem">
That <code class="literal">EvaluationContext</code> instance is injected into the <code class="literal">ExpressionEvaluatingTransformer</code> bean.
</li></ul></div>
<p>To provide a SpEL Function via Java Configuration you should declare a <code class="literal">SpelFunctionFactoryBean</code> bean for each function.
The sample above can be configured as follows:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> SpelFunctionFactoryBean xpath() {
    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> SpelFunctionFactoryBean(XPathUtils.<span class="hl-keyword">class</span>, <span class="hl-string">"evaluate"</span>);
}</pre>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>SpEL functions declared in a parent context are also made available in any child context(s).
Each context has its own instance of the <span class="emphasis"><em>integrationEvaluationContext</em></span> factory bean because each needs a different <code class="literal">BeanResolver</code>, but the function declarations are inherited and can be overridden if needed by declaring a SpEL function with the same name.</p>
</td></tr></table></div>
<p><span class="strong"><strong>Built-in SpEL Functions</strong></span></p>
<p>Spring Integration provides some standard functions, which are registered with the application context automatically on start up:</p>
<p><span class="strong"><strong>#jsonPath</strong></span> - to evaluate a <span class="emphasis"><em>jsonPath</em></span> on some provided object.
This function invokes <code class="literal">JsonPathUtils.evaluate(...)</code>.
This static method delegates to the <a class="ulink" href="http://code.google.com/p/json-path" target="_top">Jayway JsonPath library</a>.
The following shows some usage examples:</p>
<pre class="programlisting"><span class="hl-tag">&lt;transformer</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"#jsonPath(payload, '$.store.book[0].author')"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;filter</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"#jsonPath(payload,'$..book[2].isbn') matches '\d-\d{3}-\d{5}-\d'"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;splitter</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"#jsonPath(payload, '$.store.book')"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;router</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"#jsonPath(payload, headers.jsonPath)"</span><span class="hl-tag">&gt;</span>
	<span class="hl-tag">&lt;mapping</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"output1"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"reference"</span><span class="hl-tag">/&gt;</span>
	<span class="hl-tag">&lt;mapping</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"output2"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"fiction"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/router&gt;</span></pre>
<p>#jsonPath also supports the third optional parameter - an array of <a class="ulink" href="https://github.com/jayway/JsonPath/blob/master/json-path/src/main/java/com/jayway/jsonpath/Filter.java" target="_top"><code class="literal">com.jayway.jsonpath.Filter</code></a>, which could be provided by a reference to a bean or bean method, for example.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Using this function requires the Jayway JsonPath library (json-path.jar) to be on the classpath; otherwise the <span class="emphasis"><em>#jsonPath</em></span> SpEL function won&#8217;t be registered.</p>
</td></tr></table></div>
<p>For more information regarding JSON see <span class="emphasis"><em>JSON Transformers</em></span> in <a class="xref" href="#transformer" title="7.1&nbsp;Transformer">Section&nbsp;7.1, &#8220;Transformer&#8221;</a>.</p>
<p><span class="strong"><strong>#xpath</strong></span> - to evaluate an <span class="emphasis"><em>xpath</em></span> on some provided object.
For more information regarding xml and xpath see <a class="xref" href="#xml" title="35.&nbsp;XML Support - Dealing with XML Payloads">Chapter&nbsp;35, <i>XML Support - Dealing with XML Payloads</i></a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="spel-property-accessors" href="#spel-property-accessors"></a>A.4&nbsp;PropertyAccessors</h2></div></div></div>

<p>Namespace support is provided for the easy addition of SpEL custom <a class="ulink" href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/expression/PropertyAccessor.html" target="_top"><code class="literal">PropertyAccessor</code></a> implementations.
You can specify the <code class="literal">&lt;spel-property-accessors/&gt;</code> component to provide a list of custom <code class="literal">PropertyAccessor</code> s to the <code class="literal">EvaluationContext</code> used throughout the framework.
Instead of configuring the factory bean above, simply add one or more of these components, and the framework will automatically add the accessors to the default <span class="emphasis"><em>integrationEvaluationContext</em></span> factory bean:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:spel-property-accessors&gt;</span>
	<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"jsonPA"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.json.JsonPropertyAccessor"</span><span class="hl-tag">/&gt;</span>
	<span class="hl-tag">&lt;ref</span> <span class="hl-attribute">bean</span>=<span class="hl-value">"fooPropertyAccessor"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:spel-property-accessors&gt;</span></pre>
<p>With this sample, two custom <code class="literal">PropertyAccessor</code> s will be injected to the <code class="literal">EvaluationContext</code> in the order that they are declared.</p>
<p>To provide <code class="literal">PropertyAccessor</code> s via Java Configuration you should declare <code class="literal">SpelPropertyAccessorRegistrar</code> bean with the <code class="literal">spelPropertyAccessorRegistrar</code> (the <code class="literal">IntegrationContextUtils.SPEL_PROPERTY_ACCESSOR_REGISTRAR_BEAN_NAME</code> constant) name.
The sample above can be configured like:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> SpelPropertyAccessorRegistrar spelPropertyAccessorRegistrar() {
    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> SpelPropertyAccessorRegistrar(<span class="hl-keyword">new</span> JsonPropertyAccessor())
                    .add(fooPropertyAccessor());
}</pre>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Custom <code class="literal">PropertyAccessor</code> s declared in a parent context are also made available in any child context(s).
They are placed at the end of result list (but before the default <code class="literal">org.springframework.context.expression.MapAccessor</code> and <code class="literal">o.s.expression.spel.support.ReflectivePropertyAccessor</code>).
If a <code class="literal">PropertyAccessor</code> with the same bean id is declared in a child context(s), it will override the parent accessor.
Beans declared within a <code class="literal">&lt;spel-property-accessors/&gt;</code> must have an <span class="emphasis"><em>id</em></span> attribute.
The final order of usage is: the accessors in the current context, in the order in which they are declared, followed by any from parent contexts, in order, followed by the <code class="literal">MapAccessor</code> and finally the <code class="literal">ReflectivePropertyAccessor</code>.</p>
</td></tr></table></div>
</div>
</div>
<div class="appendix"><div class="titlepage"><div><div><h2 class="title"><a name="message-publishing" href="#message-publishing"></a>Appendix&nbsp;B.&nbsp;Message Publishing</h2></div></div></div>

<p>The AOP Message Publishing feature allows you to construct and send a message as a by-product of a method invocation.
For example, imagine you have a component and every time the state of this component changes you would like to be notified via a Message.
The easiest way to send such notifications would be to send a message to a dedicated channel, but how would you connect the method invocation that changes the state of the object to a message sending process, and how should the notification Message be structured?
The AOP Message Publishing feature handles these responsibilities with a configuration-driven approach.</p>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="message-publishing-config" href="#message-publishing-config"></a>B.1&nbsp;Message Publishing Configuration</h2></div></div></div>

<p>Spring Integration provides two approaches: XML and Annotation-driven.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="publisher-annotation" href="#publisher-annotation"></a>B.1.1&nbsp;Annotation-driven approach via @Publisher annotation</h3></div></div></div>

<p>The annotation-driven approach allows you to annotate any method with the <code class="literal">@Publisher</code> annotation, specifying a <span class="emphasis"><em>channel</em></span> attribute.
The Message will be constructed from the return value of the method invocation and sent to a channel specified by the <span class="emphasis"><em>channel</em></span> attribute.
To further manage message structure, you can also use a combination of both <code class="literal">@Payload</code> and <code class="literal">@Header</code> annotations.</p>
<p>Internally this message publishing feature of Spring Integration uses both Spring AOP by defining <code class="literal">PublisherAnnotationAdvisor</code> and Spring 3.0&#8217;s Expression Language (SpEL) support, giving you considerable flexibility and control over the structure of the <span class="emphasis"><em>Message</em></span> it will publish.</p>
<p>The <code class="literal">PublisherAnnotationAdvisor</code> defines and binds the following variables:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="emphasis"><em>#return</em></span> - will bind to a return value allowing you to reference it or its attributes (e.g., <span class="emphasis"><em>#return.foo</em></span> where <span class="emphasis"><em>foo</em></span> is an attribute of the object bound to <span class="emphasis"><em>#return</em></span>)
</li><li class="listitem">
<span class="emphasis"><em>#exception</em></span> - will bind to an exception if one is thrown by the method invocation.
</li><li class="listitem">
<span class="emphasis"><em>#args</em></span> - will bind to method arguments, so individual arguments could be extracted by name (e.g., <span class="emphasis"><em>#args.fname</em></span> as in the above method)
</li></ul></div>
<p>Let&#8217;s look at a couple of examples:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Publisher</span></em>
<span class="hl-keyword">public</span> String defaultPayload(String fname, String lname) {
  <span class="hl-keyword">return</span> fname + <span class="hl-string">" "</span> + lname;
}</pre>
<p>In the above example the Message will be constructed with the following structure:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Message payload - will be the return type and value of the method.
This is the default.
</li><li class="listitem">
A newly constructed message will be sent to a default publisher channel configured with an annotation post processor (see the end of this section).
</li></ul></div>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Publisher(channel="testChannel")</span></em>
<span class="hl-keyword">public</span> String defaultPayload(String fname, <em><span class="hl-annotation" style="color: gray">@Header("last")</span></em> String lname) {
  <span class="hl-keyword">return</span> fname + <span class="hl-string">" "</span> + lname;
}</pre>
<p>In this example everything is the same as above, except that we are not using a default publishing channel.
Instead we are specifying the publishing channel via the <span class="emphasis"><em>channel</em></span> attribute of the <code class="literal">@Publisher</code> annotation.
We are also adding a <code class="literal">@Header</code> annotation which results in the Message header named <span class="emphasis"><em>last</em></span> having the same value as the <span class="emphasis"><em>lname</em></span> method parameter.
That header will be added to the newly constructed Message.</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Publisher(channel="testChannel")</span></em>
<em><span class="hl-annotation" style="color: gray">@Payload</span></em>
<span class="hl-keyword">public</span> String defaultPayloadButExplicitAnnotation(String fname, <em><span class="hl-annotation" style="color: gray">@Header</span></em> String lname) {
  <span class="hl-keyword">return</span> fname + <span class="hl-string">" "</span> + lname;
}</pre>
<p>The above example is almost identical to the previous one.
The only difference here is that we are using a <code class="literal">@Payload</code> annotation on the method, thus explicitly specifying that the return value of the method should be used as the payload of the Message.</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Publisher(channel="testChannel")</span></em>
<em><span class="hl-annotation" style="color: gray">@Payload("#return + #args.lname")</span></em>
<span class="hl-keyword">public</span> String setName(String fname, String lname, <em><span class="hl-annotation" style="color: gray">@Header("x")</span></em> <span class="hl-keyword">int</span> num) {
  <span class="hl-keyword">return</span> fname + <span class="hl-string">" "</span> + lname;
}</pre>
<p>Here we are expanding on the previous configuration by using the Spring Expression Language in the <code class="literal">@Payload</code> annotation to further instruct the framework how the message should be constructed.
In this particular case the message will be a concatenation of the return value of the method invocation and the <span class="emphasis"><em>lname</em></span> input argument.
The Message header named <span class="emphasis"><em>x</em></span> will have its value determined by the <span class="emphasis"><em>num</em></span> input argument.
That header will be added to the newly constructed Message.</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Publisher(channel="testChannel")</span></em>
<span class="hl-keyword">public</span> String argumentAsPayload(<em><span class="hl-annotation" style="color: gray">@Payload</span></em> String fname, <em><span class="hl-annotation" style="color: gray">@Header</span></em> String lname) {
  <span class="hl-keyword">return</span> fname + <span class="hl-string">" "</span> + lname;
}</pre>
<p>In the above example you see another usage of the <code class="literal">@Payload</code> annotation.
Here we are annotating a method argument which will become the payload of the newly constructed message.</p>
<p>As with most other annotation-driven features in Spring, you will need to register a post-processor (<code class="literal">PublisherAnnotationBeanPostProcessor</code>).</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.aop.PublisherAnnotationBeanPostProcessor"</span><span class="hl-tag">/&gt;</span></pre>
<p>You can instead use namespace support for a more concise configuration:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:annotation-config</span> <span class="hl-attribute">default-publisher-channel</span>=<span class="hl-value">"defaultChannel"</span><span class="hl-tag">/&gt;</span></pre>
<p>Similar to other Spring annotations (@Component, @Scheduled, etc.), <code class="literal">@Publisher</code> can also be used as a meta-annotation.
That means you can define your own annotations that will be treated in the same way as the <code class="literal">@Publisher</code> itself.</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Target({ElementType.METHOD, ElementType.TYPE})</span></em>
<em><span class="hl-annotation" style="color: gray">@Retention(RetentionPolicy.RUNTIME)</span></em>
<em><span class="hl-annotation" style="color: gray">@Publisher(channel="auditChannel")</span></em>
<span class="hl-keyword">public</span> <em><span class="hl-annotation" style="color: gray">@interface</span></em> Audit {
}</pre>
<p>Here we defined the <code class="literal">@Audit</code> annotation which itself is annotated with <code class="literal">@Publisher</code>.
Also note that you can define a <code class="literal">channel</code> attribute on the meta-annotation thus encapsulating the behavior of where messages will be sent inside of this annotation.
Now you can annotate any method:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Audit</span></em>
<span class="hl-keyword">public</span> String test() {
&nbsp;&nbsp; &nbsp;<span class="hl-keyword">return</span> <span class="hl-string">"foo"</span>;
}</pre>
<p>In the above example every invocation of the <code class="literal">test()</code> method will result in a Message with a payload created from its return value.
Each Message will be sent to&nbsp;the channel named <span class="emphasis"><em>auditChannel</em></span>.
One of the benefits of this technique is that you can avoid the duplication of the same channel name across multiple annotations.
You also can provide a level of indirection between your own, potentially domain-specific annotations and those provided by the framework.</p>
<p>You can also annotate the class which would mean that the properties of this annotation will be applied on every public method of that class.</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Audit</span></em>
<span class="hl-keyword">static</span> <span class="hl-keyword">class</span> BankingOperationsImpl&nbsp;<span class="hl-keyword">implements</span>&nbsp;BankingOperations&nbsp;{

&nbsp;&nbsp;<span class="hl-keyword">public</span> String debit(String amount) {
&nbsp;&nbsp; &nbsp; . . .

&nbsp;&nbsp;}

&nbsp;&nbsp;<span class="hl-keyword">public</span>&nbsp;String credit(String amount) {
&nbsp;&nbsp; &nbsp; . . .
&nbsp;&nbsp;}

}</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="aop-based-interceptor" href="#aop-based-interceptor"></a>B.1.2&nbsp;XML-based approach via the &lt;publishing-interceptor&gt; element</h3></div></div></div>

<p>The XML-based approach allows you to configure the same AOP-based Message Publishing functionality with simple namespace-based configuration of a <code class="literal">MessagePublishingInterceptor</code>.
It certainly has some benefits over the annotation-driven approach since it allows you to use AOP pointcut expressions, thus possibly intercepting multiple methods at once or intercepting and publishing methods to which you don&#8217;t have the source code.</p>
<p>To configure Message Publishing via XML, you only need to do the following two things:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Provide configuration for <code class="literal">MessagePublishingInterceptor</code> via the <code class="literal">&lt;publishing-interceptor&gt;</code> XML element.
</li><li class="listitem">
Provide AOP configuration to apply the <code class="literal">MessagePublishingInterceptor</code> to managed objects.
</li></ul></div>
<pre class="programlisting"><span class="hl-tag">&lt;aop:config&gt;</span>
  <span class="hl-tag">&lt;aop:advisor</span> <span class="hl-attribute">advice-ref</span>=<span class="hl-value">"interceptor"</span> <span class="hl-attribute">pointcut</span>=<span class="hl-value">"bean(testBean)"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/aop:config&gt;</span>
<span class="hl-tag">&lt;publishing-interceptor</span> <span class="hl-attribute">id</span>=<span class="hl-value">"interceptor"</span> <span class="hl-attribute">default-channel</span>=<span class="hl-value">"defaultChannel"</span><span class="hl-tag">&gt;</span>
  <span class="hl-tag">&lt;method</span> <span class="hl-attribute">pattern</span>=<span class="hl-value">"echo"</span> <span class="hl-attribute">payload</span>=<span class="hl-value">"'Echoing: ' + #return"</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"echoChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;header</span> <span class="hl-attribute">name</span>=<span class="hl-value">"foo"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"bar"</span><span class="hl-tag">/&gt;</span>
  <span class="hl-tag">&lt;/method&gt;</span>
  <span class="hl-tag">&lt;method</span> <span class="hl-attribute">pattern</span>=<span class="hl-value">"repl*"</span> <span class="hl-attribute">payload</span>=<span class="hl-value">"'Echoing: ' + #return"</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"echoChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;header</span> <span class="hl-attribute">name</span>=<span class="hl-value">"foo"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"'bar'.toUpperCase()"</span><span class="hl-tag">/&gt;</span>
  <span class="hl-tag">&lt;/method&gt;</span>
  <span class="hl-tag">&lt;method</span> <span class="hl-attribute">pattern</span>=<span class="hl-value">"echoDef*"</span> <span class="hl-attribute">payload</span>=<span class="hl-value">"#return"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/publishing-interceptor&gt;</span></pre>
<p>As you can see the <code class="literal">&lt;publishing-interceptor&gt;</code> configuration looks rather similar to the Annotation-based approach, and it also utilizes the power of the Spring 3.0 Expression Language.</p>
<p>In the above example the execution of the <code class="literal">echo</code> method of a <code class="literal">testBean</code> will render a <span class="emphasis"><em>Message</em></span> with the following structure:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
The Message payload will be of type String with the content "Echoing: [value]" where <code class="literal">value</code> is the value returned by an executed method.
</li><li class="listitem">
The Message will have a header with the name "foo" and value "bar".
</li><li class="listitem">
The Message will be sent to <code class="literal">echoChannel</code>.
</li></ul></div>
<p>The second method is very similar to the first.
Here every method that begins with <span class="emphasis"><em>repl</em></span> will render a Message with the following structure:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
The Message payload will be the same as in the above sample
</li><li class="listitem">
The Message will have a header named "foo" whose value is the result of the SpEL expression <code class="literal">'bar'.toUpperCase()</code> .
</li><li class="listitem">
The Message will be sent to <code class="literal">echoChannel</code>.
</li></ul></div>
<p>The second method, mapping the execution of any method that begins with <code class="literal">echoDef</code> of <code class="literal">testBean</code>, will produce a Message with the following structure.</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
The Message payload will be the value returned by an executed method.
</li><li class="listitem">
Since the <code class="literal">channel</code> attribute is not provided explicitly, the Message will be sent to the <code class="literal">defaultChannel</code> defined by the <span class="emphasis"><em>publisher</em></span>.
</li></ul></div>
<p>For simple mapping rules you can rely on the <span class="emphasis"><em>publisher</em></span> defaults.
For example:</p>
<pre class="programlisting"><span class="hl-tag">&lt;publishing-interceptor</span> <span class="hl-attribute">id</span>=<span class="hl-value">"anotherInterceptor"</span><span class="hl-tag">/&gt;</span></pre>
<p>This will map the return value of every method that matches the pointcut expression to a payload and will be sent to a <span class="emphasis"><em>default-channel</em></span>.
If the <span class="emphasis"><em>defaultChannel_is not specified (as above) the messages will be sent to the global _nullChannel</em></span>.</p>
<p><span class="emphasis"><em>Async Publishing</em></span></p>
<p>One important thing to understand is that publishing occurs in the same thread as your component&#8217;s execution.
So by default in is synchronous.
This means that the entire message flow would have to wait until the publisher&#8217;s flow completes.&nbsp; However, quite often you want the complete opposite and that is to use this Message publishing feature to initiate asynchronous sub-flows.
For example, you might host a service (HTTP, WS etc.) which receives a remote request.You may want to send this request internally into a process that might take a while.
However you may also want to reply to the user right away.
So, instead of sending inbound requests for processing via the output channel (the conventional way), you can simply use <span class="emphasis"><em>output-channel</em></span> or a <span class="emphasis"><em>replyChannel</em></span> header to send a simple&nbsp;acknowledgment-like reply back to the caller while using the Message publisher feature to initiate a complex flow.</p>
<p>EXAMPLE: Here is the simple service that receives a complex payload, which needs to be sent further for processing, but it also needs to reply to the caller with a simple acknowledgment.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> String echo(Object complexPayload) {
&nbsp;&nbsp; &nbsp;&nbsp;<span class="hl-keyword">return</span> <span class="hl-string">"ACK"</span>;&nbsp;
}</pre>
<p>So instead of hooking up the complex flow to the output channel we use the Message publishing feature instead.
We configure it to create a new Message using the input argument of the service method (above) and send that to the <span class="emphasis"><em>localProcessChannel</em></span>.
And to make sure this sub-flow is asynchronous all we need to do is send it to any type of asynchronous channel (ExecutorChannel in this example).</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:service-activator</span> <span class="hl-attribute">&nbsp;input-channel</span>=<span class="hl-value">"inputChannel"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"outputChannel"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"sampleservice"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"sampleservice"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"test.SampleService"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;aop:config&gt;</span>
  <span class="hl-tag">&lt;aop:advisor</span> <span class="hl-attribute">advice-ref</span>=<span class="hl-value">"interceptor"</span> <span class="hl-attribute">pointcut</span>=<span class="hl-value">"bean(sampleservice)"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/aop:config&gt;</span>

<span class="hl-tag">&lt;int:publishing-interceptor</span> <span class="hl-attribute">id</span>=<span class="hl-value">"interceptor"</span><span class="hl-tag"> &gt;</span>
  <span class="hl-tag">&lt;int:method</span> <span class="hl-attribute">pattern</span>=<span class="hl-value">"echo"</span> <span class="hl-attribute">payload</span>=<span class="hl-value">"#args[0]"</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"localProcessChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:header</span> <span class="hl-attribute">name</span>=<span class="hl-value">"sample_header"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"'some sample value'"</span><span class="hl-tag">/&gt;</span>
  <span class="hl-tag">&lt;/int:method&gt;</span>
<span class="hl-tag">&lt;/int:publishing-interceptor&gt;</span>

<span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"localProcessChannel"</span><span class="hl-tag">&gt;</span>
  <span class="hl-tag">&lt;int:dispatcher</span> <span class="hl-attribute">task-executor</span>=<span class="hl-value">"executor"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:channel&gt;</span>

<span class="hl-tag">&lt;task:executor</span> <span class="hl-attribute">id</span>=<span class="hl-value">"executor"</span> <span class="hl-attribute">pool-size</span>=<span class="hl-value">"5"</span><span class="hl-tag">/&gt;</span></pre>
<p>Another way of handling this type of scenario is with a wire-tap.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="scheduled-producer" href="#scheduled-producer"></a>B.1.3&nbsp;Producing and publishing messages based on a scheduled trigger</h3></div></div></div>

<p>In the above sections we looked at the Message publishing feature of Spring Integration which constructs and publishes messages as by-products of Method invocations.
However in those cases, you are still responsible for invoking the method.
In Spring Integration 2.0 we&#8217;ve added another related useful feature: support for scheduled Message producers/publishers via the new "expression" attribute on the <span class="emphasis"><em>inbound-channel-adapter</em></span> element.
Scheduling could be based on several triggers, any one of which may be configured on the <span class="emphasis"><em>poller</em></span> sub-element.
Currently we support <code class="literal">cron</code>, <code class="literal">fixed-rate</code>, <code class="literal">fixed-delay</code> as well as any custom trigger implemented by you and referenced by the <span class="emphasis"><em>trigger</em></span> attribute value.</p>
<p>As mentioned above, support for scheduled producers/publishers is provided via the <span class="emphasis"><em>&lt;inbound-channel-adapter&gt;</em></span> xml element.
Let&#8217;s look at couple of examples:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"fixedDelayProducer"</span>
       <span class="hl-attribute">expression</span>=<span class="hl-value">"'fixedDelayTest'"</span>
       <span class="hl-attribute">channel</span>=<span class="hl-value">"fixedDelayChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">fixed-delay</span>=<span class="hl-value">"1000"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:inbound-channel-adapter&gt;</span></pre>
<p>In the above example an inbound Channel Adapter will be created which will construct a Message with its payload being the result of the expression&nbsp; defined in the <code class="literal">expression</code> attribute.
Such messages will be created and sent every time the delay specified by the <code class="literal">fixed-delay</code> attribute occurs.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"fixedRateProducer"</span>
       <span class="hl-attribute">expression</span>=<span class="hl-value">"'fixedRateTest'"</span>
       <span class="hl-attribute">channel</span>=<span class="hl-value">"fixedRateChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"1000"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:inbound-channel-adapter&gt;</span></pre>
<p>This example is very similar to the previous one, except that we are using the <code class="literal">fixed-rate</code> attribute which will allow us to send messages at a fixed rate (measuring from the start time of each task).</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"cronProducer"</span>
       <span class="hl-attribute">expression</span>=<span class="hl-value">"'cronTest'"</span>
       <span class="hl-attribute">channel</span>=<span class="hl-value">"cronChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">cron</span>=<span class="hl-value">"7 6 5 4 3 ?"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:inbound-channel-adapter&gt;</span></pre>
<p>This example demonstrates how you can apply a Cron trigger with a value specified in the <code class="literal">cron</code> attribute.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"headerExpressionsProducer"</span>
       <span class="hl-attribute">expression</span>=<span class="hl-value">"'headerExpressionsTest'"</span>
       <span class="hl-attribute">channel</span>=<span class="hl-value">"headerExpressionsChannel"</span>
       <span class="hl-attribute">auto-startup</span>=<span class="hl-value">"false"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">fixed-delay</span>=<span class="hl-value">"5000"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int:header</span> <span class="hl-attribute">name</span>=<span class="hl-value">"foo"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"6 * 7"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int:header</span> <span class="hl-attribute">name</span>=<span class="hl-value">"bar"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"x"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:inbound-channel-adapter&gt;</span></pre>
<p>Here you can see that in a way very similar to the Message publishing feature we are enriching a newly constructed Message with extra Message headers which can take scalar values or the results of evaluating Spring expressions.</p>
<p>If you need to implement your own custom trigger you can use the <code class="literal">trigger</code> attribute to provide a reference to any spring configured bean which implements&nbsp;the <code class="literal">org.springframework.scheduling.Trigger</code> interface.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"triggerRefProducer"</span>
       <span class="hl-attribute">expression</span>=<span class="hl-value">"'triggerRefTest'"</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"triggerRefChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">trigger</span>=<span class="hl-value">"customTrigger"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:inbound-channel-adapter&gt;</span>

<span class="hl-tag">&lt;beans:bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"customTrigger"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.scheduling.support.PeriodicTrigger"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;beans:constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"9999"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/beans:bean&gt;</span></pre>
</div>
</div>
</div>
<div class="appendix"><div class="titlepage"><div><div><h2 class="title"><a name="transactions" href="#transactions"></a>Appendix&nbsp;C.&nbsp;Transaction Support</h2></div></div></div>

<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="transaction-support" href="#transaction-support"></a>C.1&nbsp;Understanding Transactions in Message flows</h2></div></div></div>

<p>Spring Integration exposes several hooks to address transactional needs of you message flows.
But to better understand these hooks and how you can benefit from them we must first revisit the 6 mechanisms that could be used to initiate Message flows and see how transactional needs of these flows could be addressed within each of these mechanisms.</p>
<p>Here are the 6 mechanisms to initiate a Message flow and their short summary (details for each are provided throughout this manual):</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="emphasis"><em>Gateway Proxy</em></span> - Your basic Messaging Gateway
</li><li class="listitem">
<span class="emphasis"><em>MessageChannel</em></span> - Direct interactions with MessageChannel methods (e.g., channel.send(message))
</li><li class="listitem">
<span class="emphasis"><em>Message Publisher</em></span> - the way to initiate message flow as the by-product of method invocations on Spring beans
</li><li class="listitem">
<span class="emphasis"><em>Inbound Channel Adapters/Gateways</em></span> - the way to initiate message flow based on connecting third-party system with Spring Integration messaging system(e.g., [JmsMessage] &#8594; Jms Inbound Adapter[SI Message] &#8594; SI Channel)
</li><li class="listitem">
<span class="emphasis"><em>Scheduler</em></span> - the way to initiate message flow based on scheduling events distributed by a pre-configured Scheduler
</li><li class="listitem">
<span class="emphasis"><em>Poller</em></span> - similar to the Scheduler and is the way to initiate message flow based on scheduling or interval-based events distributed by a pre-configured Poller
</li></ul></div>
<p>These 6 could be split in 2 general categories:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="emphasis"><em>Message flows initiated by a USER process</em></span> - Example scenarios in this category would be invoking a Gateway method or explicitly sending a Message to a MessageChannel.
In other words, these message flows depend on a third party process (e.g., some code that we wrote) to be initiated.
</li><li class="listitem">
<span class="emphasis"><em>Message flows initiated by a DAEMON process</em></span> - Example scenarios in this category would be a Poller polling a Message queue to initiate a new Message flow with the polled Message or a Scheduler scheduling the process by creating a new Message and initiating a message flow at a predefined time.
</li></ul></div>
<p>Clearly the&nbsp;<span class="emphasis"><em>Gateway Proxy</em></span>, <span class="emphasis"><em>MessageChannel.send(..)</em></span> and <span class="emphasis"><em>MessagePublisher</em></span> all belong to the 1st category and <span class="emphasis"><em>Inbound Adapters/Gateways</em></span>, <span class="emphasis"><em>Scheduler</em></span> and <span class="emphasis"><em>Poller</em></span> belong to the 2nd.</p>
<p>So, how do we address transactional needs in various scenarios within each category and is there a need for Spring Integration to provide something explicitly with regard to transactions for a particular scenario? Or, can Spring&#8217;s Transaction Support be leveraged instead?.</p>
<p>The first and most obvious goal is NOT to re-invent something that has already been invented unless you can provide a better solution.
In our case Spring itself provides first class support for transaction management.
So our goal here is not to provide something new but rather delegate/use Spring to benefit from the existing support for transactions.
In other words as a framework we must expose hooks to the Transaction management functionality provided by Spring.
But since Spring Integration configuration is based on Spring Configuration it is not always necessary to expose these hooks as they are already exposed via Spring natively.
Remember every Spring Integration component is a Spring Bean after all.</p>
<p>With this goal in mind let&#8217;s look at the two scenarios.&nbsp;</p>
<p>If you think about it, Message flows that are initiated by the <span class="emphasis"><em>USER process</em></span> (Category 1) and obviously configured in a Spring Application Context, are subject to transactional configuration of such processes and therefore don&#8217;t need to be explicitly configured by Spring Integration to support transactions.
The transaction could and should be initiated through standard Transaction support provided by Spring.
The Spring Integration message flow will honor the transactional semantics of the components naturally because it is Spring configured.
For example, a Gateway or ServiceActivator method could be annotated with <code class="literal">@Transactional</code> or <code class="literal">TransactionInterceptor</code> could be defined in an XML configuration with a point-cut expression pointing to specific methods that should be transactional.
The bottom line is that you have full control over transaction configuration and boundaries in these scenarios.</p>
<p>However, things are a bit different when it comes to Message flows initiated by the <span class="emphasis"><em>DAEMON process</em></span> (Category 2).
Although configured by the developer these flows do not directly involve a human or some other process to be initiated.
These are trigger-based flows that are initiated by a trigger process (DAEMON process) based on the configuration of such process.
For example, we could have a Scheduler initiating a message flow every Friday night of every week.
We can also configure a trigger that initiates a Message flow every second, etc.
So, we obviously need a way to let these trigger-based processes know of our intention to make the resulting Message flows transactional so that a Transaction context could be created whenever a new Message flow is initiated.
In other words we need to expose some Transaction configuration, but ONLY enough to delegate to Transaction support already provided by Spring (as we do in other scenarios).</p>
<p>Spring Integration provides transactional support for Pollers.
Pollers are a special type of component because we can call receive() within that poller task against a resource that is itself transactional thus including <span class="emphasis"><em>receive()</em></span> call in the the boundaries of the Transaction allowing it to be rolled back in case of a task failure.
If we were to add the same support for channels, the added transactions would affect all downstream components starting with that <span class="emphasis"><em>send()</em></span> call.
That is providing a rather wide scope for transaction demarcation without any strong reason especially when Spring already provides several ways to address the transactional needs of any component downstream.
However the <span class="emphasis"><em>receive()</em></span> method being&nbsp;included&nbsp;in a transaction boundary is the "strong reason" for pollers.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="transaction-poller" href="#transaction-poller"></a>C.1.1&nbsp;Poller Transaction Support</h3></div></div></div>

<p>Any time you configure a Poller you can provide transactional configuration via the <span class="emphasis"><em>transactional</em></span> sub-element and its attributes:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">max-messages-per-poll</span>=<span class="hl-value">"1"</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"1000"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;transactional</span> <span class="hl-attribute">transaction-manager</span>=<span class="hl-value">"txManager"</span><span class="hl-attribute">&nbsp;</span>
                   <span class="hl-attribute">isolation</span>=<span class="hl-value">"DEFAULT"</span>
                   <span class="hl-attribute">propagation</span>=<span class="hl-value">"REQUIRED"</span><span class="hl-attribute">&nbsp;</span>
                   <span class="hl-attribute">read-only</span>=<span class="hl-value">"true"</span><span class="hl-attribute">&nbsp;</span>
                   <span class="hl-attribute">timeout</span>=<span class="hl-value">"1000"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/poller&gt;</span></pre>
<p>As you can see this configuration looks very similar to native Spring transaction configuration.
You must still provide a reference to a Transaction manager and specify transaction attributes or rely on defaults (e.g., if the <span class="emphasis"><em>transaction-manager</em></span> attribute is not specified, it will default to the bean with the name <span class="emphasis"><em>transactionManager</em></span>).
Internally the process would be wrapped in Spring&#8217;s native Transaction where <code class="literal">TransactionInterceptor</code> is responsible for handling transactions.
For more information on how to configure a Transaction Manager, the types of Transaction Managers (e.g., JTA, Datasource etc.) and other details related to transaction configuration please refer to Spring&#8217;s Reference manual (Chapter 10 - Transaction Management).</p>
<p>With the above configuration all Message flows initiated by this poller will be transactional.
For more information and details on a Poller&#8217;s transactional configuration please refer to section - <span class="emphasis"><em>21.1.1.
Polling and Transactions</em></span>.</p>
<p>Along with transactions, several more cross cutting concerns might need to be addressed when running a Poller.
To help with that, the Poller element accepts an <span class="emphasis"><em>&lt;advice-chain&gt; _ sub-element which allows you to define a custom chain of Advice instances to be applied on the Poller.
(see section 4.4 for more details) In Spring Integration 2.0, the Poller went through the a refactoring effort and is now using a proxy mechanism to address transactional concerns as well as other cross cutting concerns.
One of the significant changes evolving from this effort is that we made _&lt;transactional&gt;</em></span> and <span class="emphasis"><em>&lt;advice-chain&gt;</em></span> elements mutually exclusive.
The rationale behind this is that if you need more than one advice, and one of them is Transaction advice, then you can simply include it in the <span class="emphasis"><em>&lt;advice-chain&gt;</em></span> with the same convenience as before but with much more control since you now have an option to position any advice in the desired order.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">max-messages-per-poll</span>=<span class="hl-value">"1"</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"10000"</span><span class="hl-tag">&gt;</span>
  <span class="hl-tag">&lt;advice-chain&gt;</span>
    <span class="hl-tag">&lt;ref</span> <span class="hl-attribute">bean</span>=<span class="hl-value">"txAdvice"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;ref</span> <span class="hl-attribute">bean</span>=<span class="hl-value">"someAotherAdviceBean"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;beans:bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"foo.bar.SampleAdvice"</span><span class="hl-tag">/&gt;</span>
  <span class="hl-tag">&lt;/advice-chain&gt;</span>
<span class="hl-tag">&lt;/poller&gt;</span>

<span class="hl-tag">&lt;tx:advice</span> <span class="hl-attribute">id</span>=<span class="hl-value">"txAdvice"</span> <span class="hl-attribute">transaction-manager</span>=<span class="hl-value">"txManager"</span><span class="hl-tag">&gt;</span>
  <span class="hl-tag">&lt;tx:attributes&gt;</span>
    <span class="hl-tag">&lt;tx:method</span> <span class="hl-attribute">name</span>=<span class="hl-value">"get*"</span> <span class="hl-attribute">read-only</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;tx:method</span> <span class="hl-attribute">name</span>=<span class="hl-value">"*"</span><span class="hl-tag">/&gt;</span>
  <span class="hl-tag">&lt;/tx:attributes&gt;</span>
<span class="hl-tag">&lt;/tx:advice&gt;</span></pre>
<p>As you can see from the example above, we have provided a very basic XML-based configuration of Spring Transaction advice &nbsp;- "txAdvice" and included it within the <span class="emphasis"><em>&lt;advice-chain&gt;</em></span> defined by the Poller.
If you only need to address transactional concerns of the Poller, then you can still use the <span class="emphasis"><em>&lt;transactional&gt;</em></span> element as a convenience.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="transaction-boundaries" href="#transaction-boundaries"></a>C.2&nbsp;Transaction Boundaries</h2></div></div></div>

<p>Another important factor is the boundaries of Transactions within a Message flow.
When a transaction is started, the transaction context is bound to the current thread.
So regardless of how many endpoints and channels you have in your Message flow your transaction context will be preserved as long as you are ensuring that the flow continues on the same thread.
As soon as you break it by introducing a <span class="emphasis"><em>Pollable Channel</em></span> or <span class="emphasis"><em>Executor Channel</em></span> or initiate a new thread manually in some service, the Transactional boundary will be broken as well.
Essentially the Transaction will END right there, and if a successful handoff has transpired between the threads, the flow would be considered a success and a COMMIT signal would be sent even though the flow will continue and might still result in an Exception somewhere downstream.
If such a flow were synchronous, that Exception could be thrown back to the initiator of the Message flow who is also the initiator of the transactional context and the transaction would result in a ROLLBACK.
The middle ground is to use transactional channels at any point where a thread boundary is being broken.
For example, you can use a Queue-backed Channel that delegates to a transactional MessageStore strategy, or you could use a JMS-backed channel.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="transaction-synchronization" href="#transaction-synchronization"></a>C.3&nbsp;Transaction Synchronization</h2></div></div></div>

<p>In some environments, it is advantageous to synchronize operations with a transaction that encompasses the entire flow.
For example, consider a &lt;file:inbound-channel-adapter/&gt; at the start of a flow, that performs a number of database updates.
If the transaction commits, we might want to move the file to a <span class="emphasis"><em>success</em></span> directory, while we might want to move it to a <span class="emphasis"><em>failures</em></span> directory if the transaction rolls back.</p>
<p>Spring Integration 2.2 introduces the capability of synchronizing these operations with a transaction.
In addition, you can configure a <code class="literal">PseudoTransactionManager</code> if you don&#8217;t have a <span class="emphasis"><em>real</em></span> transaction, but still want to perform different actions on success, or failure.
For more information, see <a class="xref" href="#pseudo-transactions" title="C.4&nbsp;Pseudo Transactions">Section&nbsp;C.4, &#8220;Pseudo Transactions&#8221;</a>.</p>
<p>Key strategy interfaces for this feature are</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> TransactionSynchronizationFactory {

    TransactionSynchronization create(Object key);
}

<span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> TransactionSynchronizationProcessor {

    <span class="hl-keyword">void</span> processBeforeCommit(IntegrationResourceHolder holder);

    <span class="hl-keyword">void</span> processAfterCommit(IntegrationResourceHolder holder);

    <span class="hl-keyword">void</span> processAfterRollback(IntegrationResourceHolder holder);

}</pre>
<p>The factory is responsible for creating a <a class="ulink" href="http://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/transaction/support/TransactionSynchronization.html" target="_top">TransactionSynchronization</a> object.
You can implement your own, or use the one provided by the framework: <code class="literal">DefaultTransactionSynchronizationFactory</code>.
This implementation returns a <code class="literal">TransactionSynchronization</code> that delegates to a default implementation of <code class="literal">TransactionSynchronizationProcessor</code>, the <code class="literal">ExpressionEvaluatingTransactionSynchronizationProcessor</code>.
This processor supports three SpEL expressions, <span class="emphasis"><em>beforeCommitExpression</em></span>, <span class="emphasis"><em>afterCommitExpression</em></span>, and <span class="emphasis"><em>afterRollbackExpression</em></span>.</p>
<p>These actions should be self-explanatory to those familiar with transactions.
In each case, the <span class="emphasis"><em>#root</em></span> variable is the original <code class="literal">Message</code>; in some cases, other SpEL variables are made available, depending on the <code class="literal">MessageSource</code> being polled by the poller.
For example, the <code class="literal">MongoDbMessageSource</code> provides the <span class="emphasis"><em>#mongoTemplate</em></span> variable which references the message source&#8217;s <code class="literal">MongoTemplate</code>; the <code class="literal">RedisStoreMessageSource</code> provides the <span class="emphasis"><em>#store</em></span> variable which references the <code class="literal">RedisStore</code> created by the poll.</p>
<p>To enable the feature for a particular poller, you provide a reference to the <code class="literal">TransactionSynchronizationFactory</code> on the poller&#8217;s &lt;transactional/&gt; element using the <span class="emphasis"><em>synchronization-factory</em></span> attribute.</p>
<p>To simplify configuration of these components, namespace support for the default factory has been provided.
Configuration is best described using an example:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-file:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"inputDirPoller"</span>
    <span class="hl-attribute">channel</span>=<span class="hl-value">"someChannel"</span>
    <span class="hl-attribute">directory</span>=<span class="hl-value">"/foo/bar"</span>
    <span class="hl-attribute">filter</span>=<span class="hl-value">"filter"</span>
    <span class="hl-attribute">comparator</span>=<span class="hl-value">"testComparator"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"5000"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;int:transactional</span> <span class="hl-attribute">transaction-manager</span>=<span class="hl-value">"transactionManager"</span> <span class="hl-attribute">synchronization-factory</span>=<span class="hl-value">"syncFactory"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;/int:poller&gt;</span>
<span class="hl-tag">&lt;/int-file:inbound-channel-adapter&gt;</span>

<span class="hl-tag">&lt;int:transaction-synchronization-factory</span> <span class="hl-attribute">id</span>=<span class="hl-value">"syncFactory"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:after-commit</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"payload.renameTo('/success/' + payload.name)"</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"committedChannel"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;int:after-rollback</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"payload.renameTo('/failed/' + payload.name)"</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"rolledBackChannel"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/int:transaction-synchronization-factory&gt;</span></pre>
<p>The result of the SpEL evaluation is sent as the payload to either the <span class="emphasis"><em>committedChannel</em></span> or <span class="emphasis"><em>rolledBackChannel</em></span> (in this case, this would be <code class="literal">Boolean.TRUE</code> or <code class="literal">Boolean.FALSE</code> - the result of the <code class="literal">java.io.File.renameTo()</code> method call).</p>
<p>If you wish to send the entire payload for further Spring Integration processing, simply use the expression <span class="emphasis"><em>payload</em></span>.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>It is important to understand that this is simply synchronizing the actions with a transaction, it does not make a resource that is not inherently transactional actually transactional.
Instead, the transaction (be it JDBC or otherwise) is started before the poll, and committed/rolled back when the flow completes, followed by the synchronized action.</p>
<p>It is also important to understand that if you provide a custom <code class="literal">TransactionSynchronizationFactory</code>, it is responsible for creating a resource synchronization that will cause the bound resource to be unbound automatically, when the transaction completes.
The default <code class="literal">TransactionSynchronizationFactory</code> does this by returning a subclass of <code class="literal">ResourceHolderSynchronization</code>, with the default <span class="emphasis"><em>shouldUnbindAtCompletion()</em></span> returning <code class="literal">true</code>.</p>
</td></tr></table></div>
<p>In addition to the <span class="emphasis"><em>after-commit</em></span> and <span class="emphasis"><em>after-rollback</em></span> expressions, <span class="emphasis"><em>before-commit</em></span> is also supported.
In that case, if the evaluation (or downstream processing) throws an exception, the transaction will be rolled back instead of being committed.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="pseudo-transactions" href="#pseudo-transactions"></a>C.4&nbsp;Pseudo Transactions</h2></div></div></div>

<p>Referring to the above section, you may be thinking it would be useful to take these <span class="emphasis"><em>success</em></span> or <span class="emphasis"><em>failure</em></span> actions when a flow completes, even if there is no <span class="emphasis"><em>real</em></span> transactional resources (such as JDBC) downstream of the poller.
For example, consider a &lt;file:inbound-channel-adapter/&gt; followed by an &lt;ftp:outbout-channel-adapter/&gt;.
Neither of these components is transactional but we might want to move the input file to different directories, based on the success or failure of the ftp transfer.</p>
<p>To provide this functionality, the framework provides a <code class="literal">PseudoTransactionManager</code>, enabling the above configuration even when there is no real transactional resource involved.
If the flow completes normally, the <span class="emphasis"><em>beforeCommit</em></span> and <span class="emphasis"><em>afterCommit</em></span> synchronizations will be called, on failure the <span class="emphasis"><em>afterRollback</em></span> will be called.
Of course, because it is not a real transaction there will be no actual commit or rollback.
The pseudo transaction is simply a vehicle used to enable the synchronization features.</p>
<p>To use a <code class="literal">PseudoTransactionManager</code>, simply define it as a &lt;bean/&gt;, in the same way you would configure a real transaction manager:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"transactionManager"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.transaction.PseudoTransactionManager"</span><span class="hl-tag"> /&gt;</span></pre>
</div>
</div>
<div class="appendix"><div class="titlepage"><div><div><h2 class="title"><a name="security" href="#security"></a>Appendix&nbsp;D.&nbsp;Security in Spring Integration</h2></div></div></div>

<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="security-intro" href="#security-intro"></a>D.1&nbsp;Introduction</h2></div></div></div>

<p>Security is one of the important functions in any modern enterprise (or cloud) application,
moreover it is critical for distributed systems, such as those built using Enterprise
Integration Patterns.
Messaging independence and loosely-coupling allow target systems to communicate with each other
with any type of data in the message&#8217;s <code class="literal">payload</code>.
We can either trust all those messages or <span class="emphasis"><em>secure</em></span> our service against "infecting" messages.</p>
<p>Spring Integration together with
<a class="ulink" href="http://projects.spring.io/spring-security/" target="_top">Spring Security</a> provide a simple and comprehensive way to
secure message channels, as well as other part of the integration solution.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="securing-channels" href="#securing-channels"></a>D.2&nbsp;Securing channels</h2></div></div></div>

<p>Spring Integration provides the interceptor <code class="literal">ChannelSecurityInterceptor</code>, which extends <code class="literal">AbstractSecurityInterceptor</code> and intercepts send and receive calls on the channel.
Access decisions are then made with reference to a <code class="literal">ChannelSecurityMetadataSource</code> which provides the metadata describing the send and receive access policies for certain channels.
The interceptor requires that a valid <code class="literal">SecurityContext</code> has been established by authenticating with Spring Security.
See the Spring Security reference documentation for details.</p>
<p>Namespace support is provided to allow easy configuration of security constraints.
This consists of the secured channels tag which allows definition of one or more channel name patterns in conjunction with a definition of the security configuration for send and receive.
The pattern is a <code class="literal">java.util.regexp.Pattern</code>.</p>
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans:beans</span> <span class="hl-attribute">xmlns:int</span>=<span class="hl-value">"http://www.springframework.org/schema/integration"</span>
   <span class="hl-attribute">xmlns:int-security</span>=<span class="hl-value">"http://www.springframework.org/schema/integration/security"</span>
  <span class="hl-attribute">xmlns:beans</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
  <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
  <span class="hl-attribute">xmlns:security</span>=<span class="hl-value">"http://www.springframework.org/schema/security"</span>
  <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"http://www.springframework.org/schema/beans
      http://www.springframework.org/schema/beans/spring-beans.xsd
      http://www.springframework.org/schema/security
      http://www.springframework.org/schema/security/spring-security.xsd
      http://www.springframework.org/schema/integration
      http://www.springframework.org/schema/integration/spring-integration.xsd
      http://www.springframework.org/schema/integration/security
      http://www.springframework.org/schema/integration/security/spring-integration-security.xsd"</span><span class="hl-tag">&gt;</span>

<span class="hl-tag">&lt;int-security:secured-channels&gt;</span>
    <span class="hl-tag">&lt;int-security:access-policy</span> <span class="hl-attribute">pattern</span>=<span class="hl-value">"admin.*"</span> <span class="hl-attribute">send-access</span>=<span class="hl-value">"ROLE_ADMIN"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int-security:access-policy</span> <span class="hl-attribute">pattern</span>=<span class="hl-value">"user.*"</span> <span class="hl-attribute">receive-access</span>=<span class="hl-value">"ROLE_USER"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-security:secured-channels&gt;</span></pre>
<p>By default the secured-channels namespace element expects a bean named <span class="emphasis"><em>authenticationManager</em></span> which implements <code class="literal">AuthenticationManager</code> and a bean named <span class="emphasis"><em>accessDecisionManager</em></span> which implements <code class="literal">AccessDecisionManager</code>.
Where this is not the case references to the appropriate beans can be configured as attributes of the <span class="emphasis"><em>secured-channels</em></span> element as below.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-security:secured-channels</span> <span class="hl-attribute">access-decision-manager</span>=<span class="hl-value">"customAccessDecisionManager"</span>
                              <span class="hl-attribute">authentication-manager</span>=<span class="hl-value">"customAuthenticationManager"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int-security:access-policy</span> <span class="hl-attribute">pattern</span>=<span class="hl-value">"admin.*"</span> <span class="hl-attribute">send-access</span>=<span class="hl-value">"ROLE_ADMIN"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int-security:access-policy</span> <span class="hl-attribute">pattern</span>=<span class="hl-value">"user.*"</span> <span class="hl-attribute">receive-access</span>=<span class="hl-value">"ROLE_USER"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-security:secured-channels&gt;</span></pre>
<p>Starting with <span class="emphasis"><em>version 4.2</em></span>, the <code class="literal">@SecuredChannel</code> annotation is available for Java &amp; Annotation
configuration in <code class="literal">@Configuration</code> classes.</p>
<p>With the <code class="literal">@SecuredChannel</code> annotation, the Java configuration variant of the XML configuration above is:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Configuration</span></em>
<em><span class="hl-annotation" style="color: gray">@EnableIntegration</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ContextConfiguration {

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <em><span class="hl-annotation" style="color: gray">@SecuredChannel(interceptor = "channelSecurityInterceptor", sendAccess = "ROLE_ADMIN")</span></em>
    <span class="hl-keyword">public</span> SubscribableChannel adminChannel() {
    	<span class="hl-keyword">return</span> <span class="hl-keyword">new</span> DirectChannel();
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <em><span class="hl-annotation" style="color: gray">@SecuredChannel(interceptor = "channelSecurityInterceptor", receiveAccess = "ROLE_USER")</span></em>
    <span class="hl-keyword">public</span> SubscribableChannel userChannel() {
    	<span class="hl-keyword">return</span> <span class="hl-keyword">new</span> DirectChannel();
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> ChannelSecurityInterceptor channelSecurityInterceptor(AuthenticationManager authenticationManager,
    		AccessDecisionManager accessDecisionManager) {
    	ChannelSecurityInterceptor channelSecurityInterceptor = <span class="hl-keyword">new</span> ChannelSecurityInterceptor();
    	channelSecurityInterceptor.setAuthenticationManager(authenticationManager);
    	channelSecurityInterceptor.setAccessDecisionManager(accessDecisionManager);
    	<span class="hl-keyword">return</span> channelSecurityInterceptor;
    }

}</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="security-context-propagation" href="#security-context-propagation"></a>D.3&nbsp;SecurityContext Propagation</h2></div></div></div>

<p>To be sure that our interaction with the application is secure, according to its security system rules, we should supply
some <span class="emphasis"><em>security context</em></span> with an <span class="emphasis"><em>authentication</em></span> (principal) object.
The Spring Security project provides a flexible, canonical mechanism to authenticate our application clients
over HTTP, WebSocket or SOAP protocols (as can be done for any other integration protocol
with a simple Spring Security extension) and it provides a <code class="literal">SecurityContext</code> for further authorization checks on the
application objects, such as message channels.
By default, the <code class="literal">SecurityContext</code> is tied with the current <code class="literal">Thread</code> 's execution state using the
(<code class="literal">ThreadLocalSecurityContextHolderStrategy</code>).
It is accessed by an AOP interceptor on secured methods to check if that <code class="literal">principal</code> of the invocation has
sufficent permissions to call that method, for example.
This works well with the current thread, but often, processing logic can be performed on another thread or even
on several threads, or on to some external system(s).</p>
<p>Standard thread-bound behavior is easy to configure if our application is built on the Spring Integration components
and its message channels.
In this case, the secured objects may be any service activator or transformer, secured with a
<code class="literal">MethodSecurityInterceptor</code> in their <code class="literal">&lt;request-handler-advice-chain&gt;</code> (see <a class="xref" href="#message-handler-advice-chain" title="8.9&nbsp;Adding Behavior to Endpoints">Section&nbsp;8.9, &#8220;Adding Behavior to Endpoints&#8221;</a>)
or even <code class="literal">MessageChannel</code> (see <a class="xref" href="#securing-channels" title="D.2&nbsp;Securing channels">Section&nbsp;D.2, &#8220;Securing channels&#8221;</a> above).
When using <code class="literal">DirectChannel</code> communication, the <code class="literal">SecurityContext</code> is available
automatically, because the downstream flow runs on the current thread.
But in case of the <code class="literal">QueueChannel</code>, <code class="literal">ExecutorChannel</code> and <code class="literal">PublishSubscribeChannel</code> with an <code class="literal">Executor</code>, messages are
transferred from one thread to another (or several) by the nature of those channels.
In order to support such scenarios,
we can either transfer an <code class="literal">Authentication</code> object within the message headers and extract and authenticate it on the
other side before secured object access.
Or, we can <span class="emphasis"><em>propagate</em></span>  the <code class="literal">SecurityContext</code> to the thread receiving the transferred message.</p>
<p>Starting with <span class="emphasis"><em>version 4.2</em></span> <code class="literal">SecurityContext</code> propagation has been introduced.
It is implemented as a <code class="literal">SecurityContextPropagationChannelInterceptor</code>, which can simply be added to any <code class="literal">MessageChannel</code>
or configured as a <code class="literal">@GlobalChannelInterceptor</code>.
The logic of this interceptor is based on the <code class="literal">SecurityContext</code> extraction from the current thread from the <code class="literal">preSend()</code>
method, and its populating to another thread from the <code class="literal">postReceive()</code> (<code class="literal">beforeHandle()</code>) method.
Actually, this interceptor is an extension of the more generic <code class="literal">ThreadStatePropagationChannelInterceptor</code>, which wraps
the message-to-send together with the state-to-propagate in an internal <code class="literal">Message&lt;?&gt;</code> extension -
<code class="literal">MessageWithThreadState&lt;S&gt;</code>, -  on one side and extracts the original message back and state-to-propagate on another.
The <code class="literal">ThreadStatePropagationChannelInterceptor</code> can be extended for any context propagation use-case and
<code class="literal">SecurityContextPropagationChannelInterceptor</code> is a good sample on the matter.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Since the logic of the <code class="literal">ThreadStatePropagationChannelInterceptor</code> is based on message modification
(it returns an internal <code class="literal">MessageWithThreadState</code> object to send), you should be careful when combining this
interceptor with any other which is intended to modify messages too, e.g. through the
<code class="literal">MessageBuilder.withPayload(...)...build()</code> - the state-to-propagate may be lost.
In most cases to overcome the issue, it&#8217;s sufficient to order interceptors for the channel and ensure the
 <code class="literal">ThreadStatePropagationChannelInterceptor</code> is the last one in the stack.</p>
</td></tr></table></div>
<p>Propagation and population of <code class="literal">SecurityContext</code> is just one half of the work.
Since the message isn&#8217;t an owner of the threads in the message flow and we should be sure that we are secure against
any incoming messages, we have to <span class="emphasis"><em>clean up</em></span> the <code class="literal">SecurityContext</code> from <code class="literal">ThreadLocal</code>.
The <code class="literal">SecurityContextPropagationChannelInterceptor</code> provides <code class="literal">afterMessageHandled()</code> interceptor&#8217;s method
implementation to do the clean up operation to free the Thread in the end of invocation from that propagated principal.
This means that, when the thread that processes the handed-off message, completes the processing of the message
(successfully or otherwise), the context is cleared so that it can&#8217;t be inadvertently be used when processing another
message.</p>
</div>
</div>
<div class="appendix"><div class="titlepage"><div><div><h2 class="title"><a name="samples" href="#samples"></a>Appendix&nbsp;E.&nbsp;Spring Integration Samples</h2></div></div></div>

<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="samples-introduction" href="#samples-introduction"></a>E.1&nbsp;Introduction</h2></div></div></div>

<p>As of Spring Integration 2.0, the <span class="emphasis"><em>samples</em></span> are no&nbsp;longer included with the Spring Integration distribution.
Instead we have switched to a much simpler collaborative model that should promote better community participation and, ideally, more contributions.
Samples now have a dedicated Git repository and a dedicated JIRA Issue Tracking system.
Sample development will also have its own lifecycle which is not dependent on the lifecycle of the framework releases, although the repository will still be tagged with each major release for compatibility reasons.</p>
<p>The great benefit to the community is that we can now add more samples and make them available to you right away without waiting for the next release.
Having its own JIRA that is not tied to the the actual framework is also a great benefit.
You now have a dedicated place to suggest samples as well as report issues with existing samples.
Or, _ you may want to submit a sample to us_ as an attachment through the JIRA or, better, through the collaborative model that Git promotes.
If we believe your sample adds value, we would be more then glad to add it to the <span class="emphasis"><em>samples</em></span> repository, properly crediting you as the author.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="samples-get" href="#samples-get"></a>E.2&nbsp;Where to get Samples</h2></div></div></div>

<p>The Spring Integration Samples project is hosted on <a class="ulink" href="https://github.com/SpringSource/spring-integration-samples/" target="_top">GitHub</a>.
You can find the repository at:</p>
<p><a class="ulink" href="https://github.com/SpringSource/spring-integration-samples" target="_top">https://github.com/SpringSource/spring-integration-samples</a></p>
<p>In order to check out or <span class="emphasis"><em>clone</em></span> (Git parlance) the samples, please make sure you have a Git client installed on your system.
There are several GUI-based products available for many platforms, e.g.
<a class="ulink" href="http://eclipse.org/egit/" target="_top">EGit</a> for the Eclipse IDE.
A simple Google search will help you find them.
Of course you can also just use the command line interface for &lt;<a class="ulink" href="http://git-scm.com/,Git&gt;" target="_top">http://git-scm.com/,Git&gt;</a>.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>If you need more information on how to install and/or use Git, please visit: <a class="ulink" href="http://git-scm.com/" target="_top">http://git-scm.com/</a>.</p>
</td></tr></table></div>
<p>In order to checkout (clone in Git terms) the Spring Integration samples repository using the Git command line tool, issue the following commands:</p>
<pre class="programlisting">$ git clone&nbsp;https://github.com/SpringSource/spring-integration-samples.git</pre>
<p>That is all you need to do in order to clone the entire samples repository into a directory named <span class="emphasis"><em>spring-integration-samples</em></span> within the working directory where you issued that <span class="emphasis"><em>git</em></span> command.
Since the samples repository is a live repository, you might want to perform periodic <span class="emphasis"><em>pulls</em></span> (updates) to get new samples, as well as updates to the existing samples.
In order to do so issue the following git <span class="emphasis"><em>pull</em></span> command:</p>
<pre class="programlisting">$ git pull</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_submitting_samples_or_sample_requests" href="#_submitting_samples_or_sample_requests"></a>E.3&nbsp;Submitting Samples or Sample Requests</h2></div></div></div>

<p><span class="emphasis"><em>How can I contribute my own Samples?</em></span></p>
<p>Github is for social coding: if you want to submit your own code examples to the Spring Integration Samples project, we encourage contributions through <a class="ulink" href="http://help.github.com/send-pull-requests/" target="_top"><span class="emphasis"><em>pull
	       requests</em></span></a> from <a class="ulink" href="http://help.github.com/fork-a-repo/" target="_top"><span class="emphasis"><em>forks</em></span></a> of this repository.
If you want to contribute code this way, please reference, if possible, ahttps://jira.springframework.org/browse/INTSAMPLES[<span class="emphasis"><em>JIRA Ticket</em></span>] that provides some details regarding the provided sample.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important: Sign the contributor license agreement"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Sign the contributor license agreement</th></tr><tr><td align="left" valign="top">

<p>Very important: before we can accept your Spring Integration sample, we will need you to sign the SpringSource contributor license agreement (CLA).
Signing the contributor&#8217;s agreement does not grant anyone commit rights to the main repository, but it does mean that we can accept your contributions, and you will get an author credit if we do.
In order to read and sign the CLA, please go to:</p>
<p><a class="ulink" href="https://support.springsource.com/spring_committer_signup" target="_top">https://support.springsource.com/spring_committer_signup</a></p>
<p>From the Project drop down, please select <span class="emphasis"><em>Spring Integration</em></span>.
The Project Lead is <span class="emphasis"><em>Gary Russell</em></span>.</p>
</td></tr></table></div>
<p><span class="emphasis"><em>Code Contribution Process</em></span></p>
<p>For the actual code contribution process, please read the the <span class="emphasis"><em>Contributor Guidelines</em></span> for Spring Integration, they apply for this project as well:</p>
<p><a class="ulink" href="https://github.com/spring-projects/spring-integration/blob/master/CONTRIBUTING.md" target="_top">https://github.com/spring-projects/spring-integration/blob/master/CONTRIBUTING.md</a></p>
<p>This process ensures that every commit gets peer-reviewed.
As a matter of fact, the core committers follow the exact same rules.
We are gratefully looking forward to your Spring Integration Samples!</p>
<p><span class="emphasis"><em>Sample Requests</em></span></p>
<p>As mentioned earlier, the <span class="emphasis"><em>Spring Integration Samples</em></span> project has a dedicated JIRA Issue tracking system.
To submit new sample requests, please visit our JIRA Issue Tracking system:</p>
<p><a class="ulink" href="https://jira.springframework.org/browse/INTSAMPLES" target="_top">https://jira.springframework.org/browse/INTSAMPLES</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="samples-structure" href="#samples-structure"></a>E.4&nbsp;Samples Structure</h2></div></div></div>

<p>Starting with Spring Integration 2.0, the structure of the <span class="emphasis"><em>samples</em></span> changed as well.
With plans for more samples we realized that some samples have different goals than others.
While they all share the common goal of showing you how to apply and work with the Spring Integration framework, they also differ in areas where some samples are meant to concentrate on a technical use case while others focus on a business use case, and some samples are all about showcasing various techniques that could be applied to address certain scenarios (both technical and business).
The new categorization of samples will allow us to better organize them based on the problem each sample addresses while giving you a simpler way of finding the right sample for your needs.</p>
<p>Currently there are 4 categories.
Within the samples repository each category has its own directory which is named after the category name:</p>
<p><span class="emphasis"><em>BASIC (samples/basic)</em></span></p>
<p>This is a good place to get started.
The samples here are technically motivated and demonstrate the bare minimum with regard to configuration and code.
These should help you to get started quickly by introducing you to the basic concepts, API and configuration of Spring Integration as well as Enterprise Integration Patterns (EIP).
For example, if you are looking for an answer on how to implement and wire a <span class="emphasis"><em>Service Activator</em></span> to a <span class="emphasis"><em>Message Channel</em></span> or how to use a <span class="emphasis"><em>Messaging Gateway</em></span> as a facade to your message exchange, or how to get started with using MAIL or TCP/UDP modules etc., this would be the right place to find a good sample.
The bottom line is this is a good place to get started.</p>
<p><span class="emphasis"><em>INTERMEDIATE (samples/intermediate)</em></span></p>
<p>This category targets developers who are already familiar with the Spring Integration framework (past getting started), but need some more guidance while resolving the&nbsp;more advanced technical problems one might deal with after switching to a Messaging architecture.
For example, if you are looking for an answer on how to handle errors in various message exchange scenarios or how to properly configure the <span class="emphasis"><em>Aggregator</em></span> for the situations where some messages might not ever arrive for aggregation, or any other issue that goes beyond a basic implementation and configuration of a particular component and addresses <span class="emphasis"><em>what else</em></span> types of problems, this would be the right place to find these type of samples.</p>
<p><span class="emphasis"><em>ADVANCED (samples/advanced)</em></span></p>
<p>This category targets developers who are very familiar with the Spring Integration framework but are looking to extend it to address a specific custom need by using Spring Integration&#8217;s public API.
For example, if you are looking for samples showing you how to implement a custom <span class="emphasis"><em>Channel</em></span> or <span class="emphasis"><em>Consumer</em></span> (event-based or polling-based), or you are trying to figure out what is the most appropriate way to implement a custom Bean parser on top of the Spring Integration&nbsp;Bean parser&nbsp;hierarchy when implementing your own namespace and schema for a custom component, this would be the right place to look.
Here you can also find samples that will help you with <span class="emphasis"><em>Adapter</em></span> development.
Spring Integration comes with an extensive library of adapters to allow you to connect remote systems with the Spring Integration messaging framework.
However you might have a need to integrate with a system for which the core framework does not provide an adapter.
So, you may decide to implement your own (and potentially contribute it).
This category would include samples showing you how.</p>
<p><span class="emphasis"><em>APPLICATIONS (samples/applications)</em></span></p>
<p>This category targets developers and architects who have a good understanding of Message-driven architecture and EIP, and an above average understanding of Spring and Spring Integration who are looking for samples that address a particular <span class="emphasis"><em>business problem</em></span>.
In other words the emphasis of samples in this category is <span class="emphasis"><em>business use cases</em></span> and how they can be solved with a Message-Driven Architecture and Spring Integration in particular.
For example, if you are interested to see how a <span class="emphasis"><em>Loan Broker</em></span> or <span class="emphasis"><em>Travel Agent</em></span> process could be implemented and automated via Spring Integration, this would be the right place to find these types of samples.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Remember: Spring Integration is a community driven framework, therefore community participation is IMPORTANT.
That includes Samples; so, if you can&#8217;t find what you are looking for, let us know!</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="samples-impl" href="#samples-impl"></a>E.5&nbsp;Samples</h2></div></div></div>

<p>Currently Spring Integration comes with quite a few samples and you can only expect more.
To help you better navigate through them, each sample comes with its own <code class="literal">readme.txt</code> file which covers several details about the sample (e.g., what EIP patterns it addresses, what problem it is trying to solve, how to run sample etc.).
However, certain samples require a more detailed and sometimes graphical explanation.
In this section you&#8217;ll find details on samples that we believe require special attention.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="samples-loan-broker" href="#samples-loan-broker"></a>E.5.1&nbsp;Loan Broker</h3></div></div></div>

<p>In this section, we will review the <span class="emphasis"><em>Loan Broker</em></span> sample application that is included in the Spring Integration samples.&nbsp;This sample is inspired by one of the samples featured in Gregor Hohpe and Bobby Woolf&#8217;s&nbsp;book, <a class="ulink" href="http://www.eaipatterns.com" target="_top">Enterprise Integration Patterns</a>.</p>
<p>The diagram below represents the entire process</p>
<div class="figure"><a name="d5e21093" href="#d5e21093"></a><p class="title"><b>Figure&nbsp;E.1.&nbsp;Loan Broker Sample</b></p><div class="figure-contents">

<div class="mediaobject" align="center"><img src="images/loan-broker-eip.png" align="middle" alt="loan broker eip"></div>
</div></div><br class="figure-break">
<p>Now lets look at this process in more detail</p>
<p>At the core of an EIP architecture are the very simple yet powerful concepts of Pipes and Filters, and of course: Messages.
Endpoints (Filters) are connected with one another via Channels (Pipes).
The producing endpoint sends Message to the Channel, and the Message is retrieved by the Consuming endpoint.
This architecture is meant to define various mechanisms that describe HOW information is exchanged between the endpoints, without any awareness of WHAT those endpoints are or what information they are exchanging.
Thus, it provides for a very loosely coupled and flexible collaboration model while also decoupling Integration concerns from Business concerns.
EIP extends this architecture by further defining:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
The types of pipes (Point-to-Point Channel, Publish-Subscribe Channel, Channel Adapter, etc.)
</li><li class="listitem">
The core filters and patterns around how filters collaborate with pipes (Message Router, Splitters and Aggregators, various Message Transformation patterns, etc.)
</li></ul></div>
<p>The details and variations of this use case are very nicely described in Chapter 9 of the EIP Book, but here is the brief summary; A Consumer while shopping for the best Loan Quote(s) subscribes to the services of a Loan Broker, which handles details such as:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Consumer pre-screening (e.g., obtain and review the consumer&#8217;s Credit history)
</li><li class="listitem">
Determine the most appropriate Banks (e.g., based on consumer&#8217;s credit history/score)
</li><li class="listitem">
Send a Loan quote request to each selected Bank
</li><li class="listitem">
Collect responses from each Bank
</li><li class="listitem">
Filter responses and determine the best quote(s), based on consumer&#8217;s requirements.
</li><li class="listitem">
Pass the Loan quote(s) back to the consumer.
</li></ul></div>
<p>Obviously the real process of obtaining a loan quote is a bit more complex, but since our goal here is to demonstrate how Enterprise Integration Patterns are realized and implemented within SI, the use case has been simplified to concentrate only on the Integration aspects of the process.
It is not an attempt to give you an advice in consumer finances.</p>
<p>As you can see, by hiring a Loan Broker, the consumer is isolated from the details of the Loan Broker&#8217;s operations, and each Loan Broker&#8217;s operations may defer from one another to maintain competitive advantage, so whatever we assemble/implement must be flexible so any changes could be introduced quickly and painlessly.
Speaking of change, the Loan Broker sample does not actually talk to any <span class="emphasis"><em>imaginary</em></span> Banks or Credit bureaus.
Those services are stubbed out.
Our goal here is to assemble, orchestrate and test the integration aspect of the process as a whole.
Only then can we start thinking about wiring such process to the real services.
At that time the assembled process and its configuration will not change regardless of the number of Banks a particular Loan Broker is dealing with, or the type of communication media (or protocols) used (JMS, WS, TCP, etc.) to communicate with these Banks.</p>
<p><span class="emphasis"><em>DESIGN</em></span></p>
<p>As you analyze the 6 requirements above you&#8217;ll quickly see that they all fall into the category of Integration concerns.
For example, in the consumer pre-screening step we need to gather additional information about the consumer and the consumer&#8217;s desires and enrich the loan request with additional meta information.
We then have to filter such information to select the most appropriate list of Banks, and so on.
Enrich, filter, select &#8211; these are all integration concerns for which EIP defines a solution in the form of patterns.
SI provides an implementation of these patterns.</p>
<div class="figure"><a name="d5e21127" href="#d5e21127"></a><p class="title"><b>Figure&nbsp;E.2.&nbsp;Messaging Gateway</b></p><div class="figure-contents">

<div class="mediaobject" align="center"><img src="images/gateway.jpg" align="middle" alt="gateway"></div>
</div></div><br class="figure-break">
<p>The <span class="emphasis"><em>Messaging Gateway</em></span> pattern provides a simple mechanism to access messaging systems, including our Loan Broker.
In SI you define the <span class="emphasis"><em>Gateway</em></span> as a Plain Old Java Interface (no need to provide an implementation), configure it via the XML <span class="emphasis"><em>&lt;gateway&gt;</em></span> element or via annotation and use it as any other Spring bean.
SI will take care of delegating and mapping method invocations to the Messaging infrastructure by generating a <span class="emphasis"><em>Message</em></span> (payload is mapped to an input parameter of the method) and sending it to the designated channel.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:gateway</span> <span class="hl-attribute">id</span>=<span class="hl-value">"loanBrokerGateway"</span>
  <span class="hl-attribute">default-request-channel</span>=<span class="hl-value">"loanBrokerPreProcessingChannel"</span>
  <span class="hl-attribute">service-interface</span>=<span class="hl-value">"org.springframework.integration.samples.loanbroker.LoanBrokerGateway"</span><span class="hl-tag">&gt;</span>
  <span class="hl-tag">&lt;int:method</span> <span class="hl-attribute">name</span>=<span class="hl-value">"getBestLoanQuote"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:header</span> <span class="hl-attribute">name</span>=<span class="hl-value">"RESPONSE_TYPE"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"BEST"</span><span class="hl-tag">/&gt;</span>
  <span class="hl-tag">&lt;/int:method&gt;</span>
<span class="hl-tag">&lt;/int:gateway&gt;</span></pre>
<p>Our current <span class="emphasis"><em>Gateway</em></span> provides two methods that could be invoked.
One that will return the best single quote and another one that will return all quotes.
Somehow downstream we need to know what type of reply the caller is looking for.
The best way to achieve this in Messaging architecture is to enrich the content of the message with some meta-data describing your intentions.
<span class="emphasis"><em>Content Enricher</em></span> is one of the patterns that addresses this and although Spring Integration does provide a separate configuration element to enrich Message Headers with arbitrary data (we&#8217;ll see it later), as a convenience, since_Gateway_ element is responsible to construct the initial <span class="emphasis"><em>Message</em></span> it provides embedded capability to enrich the newly created <span class="emphasis"><em>Message</em></span> with arbitrary <span class="emphasis"><em>Message Headers</em></span>.
In our example we are adding header RESPONSE_TYPE with value <span class="emphasis"><em>BEST</em></span>' whenever the getBestQuote() method is invoked.
For other method we are not adding any header.
Now we can check downstream for an existence of this header and based on its presence and its value we can determine what type of reply the caller is looking for.</p>
<p>Based on the use case we also know there are some pre-screening steps that needs to be performed such as getting and evaluating the consumer&#8217;s credit score, simply because some premiere Banks will only typically accept quote requests from consumers that meet a minimum credit score requirement.
So it would be nice if the <span class="emphasis"><em>Message</em></span> would be enriched with such information before it is forwarded to the Banks.
It would also be nice if when several processes needs to be completed to provide such meta-information, those processes could be grouped in a single unit.
In our use case we need to determine credit score and based on the credit score and some rule select a list of <span class="emphasis"><em>Message Channels</em></span> (Bank Channels) we will sent quote request to.</p>
<p><span class="emphasis"><em>Composed Message Processor</em></span></p>
<p>The <span class="emphasis"><em>Composed Message Processor</em></span> pattern describes rules around building endpoints that maintain control over message flow which consists of multiple message processors.
In Spring Integration <span class="emphasis"><em>Composed Message Processor</em></span> pattern is implemented via <span class="emphasis"><em>&lt;chain&gt;</em></span> element.</p>
<div class="figure"><a name="d5e21156" href="#d5e21156"></a><p class="title"><b>Figure&nbsp;E.3.&nbsp;Chain</b></p><div class="figure-contents">

<div class="mediaobject" align="center"><img src="images/chain.png" align="middle" alt="chain"></div>
</div></div><br class="figure-break">
<p>As you can see from the above configuration we have a chain with inner header-enricher element which will further enrich the content of the <span class="emphasis"><em>Message</em></span> with the header CREDIT_SCORE and value that will be determined by the call to a credit service (simple POJO spring bean identified by <span class="emphasis"><em>creditBureau</em></span> name) and then it will delegate to the <span class="emphasis"><em>Message Router</em></span></p>
<div class="figure"><a name="d5e21167" href="#d5e21167"></a><p class="title"><b>Figure&nbsp;E.4.&nbsp;Message Router</b></p><div class="figure-contents">

<div class="mediaobject" align="center"><img src="images/bank-router.jpg" align="middle" alt="bank router"></div>
</div></div><br class="figure-break">
<p>There are several implementations of the <span class="emphasis"><em>Message Routing</em></span> pattern available in Spring Integration.
Here we are using a router that will determine a list of channels based on evaluating an expression (Spring Expression Language) which will look at the credit score that was determined is the previous step and will select the list of channels from the Map bean with id <span class="emphasis"><em>banks</em></span> whose values are <span class="emphasis"><em>premier</em></span> or <span class="emphasis"><em>secondary</em></span> based o the value of credit score.
Once the list of <span class="emphasis"><em>Channels</em></span> is selected, the <span class="emphasis"><em>Message</em></span> will be routed to those <span class="emphasis"><em>Channels</em></span>.</p>
<p>Now, one last thing the Loan Broker needs to to is to receive the loan quotes form the banks, aggregate them by consumer (we don&#8217;t want to show quotes from one consumer to another), assemble the response based on the consumer&#8217;s selection criteria (single best quote or all quotes) and reply back to the consumer.</p>
<div class="figure"><a name="d5e21183" href="#d5e21183"></a><p class="title"><b>Figure&nbsp;E.5.&nbsp;Message Aggregator</b></p><div class="figure-contents">

<div class="mediaobject" align="center"><img src="images/quotes-aggregator.jpg" align="middle" alt="quotes aggregator"></div>
</div></div><br class="figure-break">
<p>An <span class="emphasis"><em>Aggregator</em></span> pattern describes an endpoint which groups related <span class="emphasis"><em>Messages</em></span> into a single <span class="emphasis"><em>Message</em></span>.
Criteria and rules can be provided to determine an aggregation and correlation strategy.
SI provides several implementations of the <span class="emphasis"><em>Aggregator</em></span> pattern as well as a convenient name-space based configuration.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:aggregator</span> <span class="hl-attribute">id</span>=<span class="hl-value">"quotesAggregator"</span>
      <span class="hl-attribute">input-channel</span>=<span class="hl-value">"quotesAggregationChannel"</span>
      <span class="hl-attribute">method</span>=<span class="hl-value">"aggregateQuotes"</span><span class="hl-tag">&gt;</span>
  <span class="hl-tag">&lt;beans:bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.samples.loanbroker.LoanQuoteAggregator"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:aggregator&gt;</span></pre>
<p>Our Loan Broker defines a <span class="emphasis"><em>quotesAggregator</em></span> bean via the <span class="emphasis"><em>&lt;aggregator&gt;</em></span> element which provides a default aggregation and correlation strategy.
The default correlation strategy correlates messages based on the <code class="literal">correlationId</code> header (see <span class="emphasis"><em>Correlation Identifier</em></span> pattern).
What&#8217;s interesting is that we never provided the value for this header.
It was set earlier by the router automatically, when it generated a separate <span class="emphasis"><em>Message</em></span> for each Bank channel.</p>
<p>Once the <span class="emphasis"><em>Messages</em></span> are correlated they are released to the actual <span class="emphasis"><em>Aggregator</em></span> implementation.
Although default <span class="emphasis"><em>Aggregator</em></span> is provided by SI, its strategy (gather the list of payloads from all <span class="emphasis"><em>Messages</em></span> and construct a new <span class="emphasis"><em>Message</em></span> with this List as payload) does not satisfy our requirement.
The reason is that our consumer might require a single best quote or all quotes.
To communicate the consumer&#8217;s intention, earlier in the process we set the RESPONSE_TYPE header.
Now we have to evaluate this header and return either all the quotes (the default aggregation strategy would work) or the best quote (the default aggregation strategy will not work because we have to determine which loan quote is the best).</p>
<p>Obviously selecting the best quote could be based on complex criteria and would influence the complexity of the aggregator implementation and configuration, but for now we are making it simple.
If consumer wants the best quote we will select a quote with the lowest interest rate.
To accomplish that the LoanQuoteAggregator.java will sort all the quotes and return the first one.
The <code class="literal">LoanQuote.java</code> implements <code class="literal">Comparable</code> which compares quotes based on the rate attribute.
Once the response <span class="emphasis"><em>Message</em></span> is created it is sent to the default-reply-channel of the <span class="emphasis"><em>Messaging Gateway</em></span> (thus the consumer) which started the process.
Our consumer got the Loan Quote!</p>
<p>Conclusion</p>
<p>As you can see a rather complex process was assembled based on POJO (read existing, legacy), light weight, embeddable messaging framework (Spring Integration) with a loosely coupled programming model intended to simplify integration of heterogeneous systems without requiring a heavy-weight ESB-like engine or proprietary development and deployment environment, because as a developer you should not be porting your Swing or console-based application to an ESB-like server or implementing proprietary interfaces just because you have an integration concern.</p>
<p>This and other samples in this section are built on top of Enterprise Integration Patterns and can be considered "building blocks" for YOUR solution; they are not intended to be complete solutions.
Integration concerns exist in all types of application (whether server based or not).
It should not require change in design, testing and deployment strategy if such applications need to be integrated.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="samples-cafe" href="#samples-cafe"></a>E.5.2&nbsp;The Cafe Sample</h3></div></div></div>

<p>In this section, we will review a <span class="emphasis"><em>Cafe</em></span> sample application that is included in the Spring Integration samples.&nbsp;This sample is inspired by another sample featured in Gregor Hohpe&#8217;s&nbsp;http://www.eaipatterns.com/ramblings.html[Ramblings].</p>
<p>The domain is that of a Cafe, and the basic flow is depicted in the following diagram:</p>
<div class="figure"><a name="d5e21221" href="#d5e21221"></a><p class="title"><b>Figure&nbsp;E.6.&nbsp;Cafe Sample</b></p><div class="figure-contents">

<div class="mediaobject" align="center"><img src="images/cafe-eip.png" align="middle" alt="cafe eip"></div>
</div></div><br class="figure-break">
<p>The <code class="literal">Order</code> object may contain multiple <code class="literal">OrderItems</code>.
Once the order is placed, a <span class="emphasis"><em>Splitter</em></span> will break the composite order message into a single message per drink.
Each of these is then processed by a <span class="emphasis"><em>Router</em></span> that determines whether the drink is hot or cold (checking the <code class="literal">OrderItem</code> object&#8217;s <span class="emphasis"><em>isIced</em></span> property).
The <code class="literal">Barista</code> prepares each drink, but hot and cold drink preparation are handled by two distinct methods: <span class="emphasis"><em>prepareHotDrink</em></span> and <span class="emphasis"><em>prepareColdDrink</em></span>.
The prepared drinks are then sent to the Waiter where they are aggregated into a <code class="literal">Delivery</code> object.</p>
<p>Here is the XML configuration:</p>
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans:beans</span> <span class="hl-attribute">xmlns:int</span>=<span class="hl-value">"http://www.springframework.org/schema/integration"</span>
 <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
 <span class="hl-attribute">xmlns:beans</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
 <span class="hl-attribute">xmlns:int-stream</span>=<span class="hl-value">"http://www.springframework.org/schema/integration/stream"</span>
 <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"http://www.springframework.org/schema/beans
  http://www.springframework.org/schema/beans/spring-beans.xsd
  http://www.springframework.org/schema/integration
  http://www.springframework.org/schema/integration/spring-integration.xsd
  http://www.springframework.org/schema/integration/stream
  http://www.springframework.org/schema/integration/stream/spring-integration-stream.xsd"</span><span class="hl-tag">&gt;</span>

    <span class="hl-tag">&lt;int:gateway</span> <span class="hl-attribute">id</span>=<span class="hl-value">"cafe"</span> <span class="hl-attribute">service-interface</span>=<span class="hl-value">"o.s.i.samples.cafe.Cafe"</span><span class="hl-tag">/&gt;</span>

    <span class="hl-tag">&lt;int:channel</span>  <span class="hl-attribute">id</span>=<span class="hl-value">"orders"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int:splitter</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"orders"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"orderSplitter"</span>
                  <span class="hl-attribute">method</span>=<span class="hl-value">"split"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"drinks"</span><span class="hl-tag">/&gt;</span>

    <span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"drinks"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int:router</span>  <span class="hl-attribute">input-channel</span>=<span class="hl-value">"drinks"</span>
                 <span class="hl-attribute">ref</span>=<span class="hl-value">"drinkRouter"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"resolveOrderItemChannel"</span><span class="hl-tag">/&gt;</span>

    <span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"coldDrinks"</span><span class="hl-tag">&gt;</span><span class="hl-tag">&lt;int:queue</span> <span class="hl-attribute">capacity</span>=<span class="hl-value">"10"</span><span class="hl-tag">/&gt;</span><span class="hl-tag">&lt;/int:channel&gt;</span>
    <span class="hl-tag">&lt;int:service-activator</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"coldDrinks"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"barista"</span>
                           <span class="hl-attribute">method</span>=<span class="hl-value">"prepareColdDrink"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"preparedDrinks"</span><span class="hl-tag">/&gt;</span>

    <span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"hotDrinks"</span><span class="hl-tag">&gt;</span><span class="hl-tag">&lt;int:queue</span> <span class="hl-attribute">capacity</span>=<span class="hl-value">"10"</span><span class="hl-tag">/&gt;</span><span class="hl-tag">&lt;/int:channel&gt;</span>
    <span class="hl-tag">&lt;int:service-activator</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"hotDrinks"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"barista"</span>
                           <span class="hl-attribute">method</span>=<span class="hl-value">"prepareHotDrink"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"preparedDrinks"</span><span class="hl-tag">/&gt;</span>

    <span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"preparedDrinks"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int:aggregator</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"preparedDrinks"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"waiter"</span>
                    <span class="hl-attribute">method</span>=<span class="hl-value">"prepareDelivery"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"deliveries"</span><span class="hl-tag">/&gt;</span>

    <span class="hl-tag">&lt;int-stream:stdout-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"deliveries"</span><span class="hl-tag">/&gt;</span>

    <span class="hl-tag">&lt;beans:bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"orderSplitter"</span>
                <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.samples.cafe.xml.OrderSplitter"</span><span class="hl-tag">/&gt;</span>

    <span class="hl-tag">&lt;beans:bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"drinkRouter"</span>
                <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.samples.cafe.xml.DrinkRouter"</span><span class="hl-tag">/&gt;</span>

    <span class="hl-tag">&lt;beans:bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"barista"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.samples.cafe.xml.Barista"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;beans:bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"waiter"</span>  <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.samples.cafe.xml.Waiter"</span><span class="hl-tag">/&gt;</span>

    <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">id</span>=<span class="hl-value">"poller"</span> <span class="hl-attribute">default</span>=<span class="hl-value">"true"</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"1000"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;/beans:beans&gt;</span></pre>
<p>As you can see, each Message Endpoint is connected to input and/or output channels.
Each endpoint will manage its own Lifecycle (by default endpoints start automatically upon initialization - to prevent that add the "auto-startup" attribute with a value of "false").
Most importantly, notice that the objects are simple POJOs with strongly typed method arguments.
For example, here is the Splitter:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> OrderSplitter {
    <span class="hl-keyword">public</span> List&lt;OrderItem&gt; split(Order order) {
        <span class="hl-keyword">return</span> order.getItems();
    }
}</pre>
<p>In the case of the Router, the return value does not have to be a <code class="literal">MessageChannel</code> instance (although it can be).
As you see in this example, a String-value representing the channel name is returned instead.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> DrinkRouter {
    <span class="hl-keyword">public</span> String resolveOrderItemChannel(OrderItem orderItem) {
        <span class="hl-keyword">return</span> (orderItem.isIced()) ? <span class="hl-string">"coldDrinks"</span> : <span class="hl-string">"hotDrinks"</span>;
    }
}</pre>
<p>Now turning back to the XML, you see that there are two &lt;service-activator&gt; elements.
Each of these is delegating to the same <code class="literal">Barista</code> instance but different methods: <span class="emphasis"><em>prepareHotDrink</em></span> or <span class="emphasis"><em>prepareColdDrink</em></span> corresponding to the two channels where order items have been routed.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> Barista {

    <span class="hl-keyword">private</span> <span class="hl-keyword">long</span> hotDrinkDelay = <span class="hl-number">5000</span>;
    <span class="hl-keyword">private</span> <span class="hl-keyword">long</span> coldDrinkDelay = <span class="hl-number">1000</span>;

    <span class="hl-keyword">private</span> AtomicInteger hotDrinkCounter = <span class="hl-keyword">new</span> AtomicInteger();
    <span class="hl-keyword">private</span> AtomicInteger coldDrinkCounter = <span class="hl-keyword">new</span> AtomicInteger();

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setHotDrinkDelay(<span class="hl-keyword">long</span> hotDrinkDelay) {
        <span class="hl-keyword">this</span>.hotDrinkDelay = hotDrinkDelay;
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setColdDrinkDelay(<span class="hl-keyword">long</span> coldDrinkDelay) {
        <span class="hl-keyword">this</span>.coldDrinkDelay = coldDrinkDelay;
    }

    <span class="hl-keyword">public</span> Drink prepareHotDrink(OrderItem orderItem) {
        <span class="hl-keyword">try</span> {
            Thread.sleep(<span class="hl-keyword">this</span>.hotDrinkDelay);
            System.out.println(Thread.currentThread().getName()
                    + <span class="hl-string">" prepared hot drink #"</span> + hotDrinkCounter.incrementAndGet()
                    + <span class="hl-string">" for order #"</span> + orderItem.getOrder().getNumber()
                    + <span class="hl-string">": "</span> + orderItem);
            <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> Drink(orderItem.getOrder().getNumber(), orderItem.getDrinkType(),
                    orderItem.isIced(), orderItem.getShots());
        }
        <span class="hl-keyword">catch</span> (InterruptedException e) {
            Thread.currentThread().interrupt();
            <span class="hl-keyword">return</span> null;
        }
    }

    <span class="hl-keyword">public</span> Drink prepareColdDrink(OrderItem orderItem) {
        <span class="hl-keyword">try</span> {
            Thread.sleep(<span class="hl-keyword">this</span>.coldDrinkDelay);
            System.out.println(Thread.currentThread().getName()
                    + <span class="hl-string">" prepared cold drink #"</span> + coldDrinkCounter.incrementAndGet()
                    + <span class="hl-string">" for order #"</span> + orderItem.getOrder().getNumber() + <span class="hl-string">": "</span>
                    + orderItem);
            <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> Drink(orderItem.getOrder().getNumber(), orderItem.getDrinkType(),
                    orderItem.isIced(), orderItem.getShots());
        }
        <span class="hl-keyword">catch</span> (InterruptedException e) {
            Thread.currentThread().interrupt();
            <span class="hl-keyword">return</span> null;
        }
    }
}</pre>
<p>As you can see from the code excerpt above, the barista methods have different delays (the hot drinks take 5 times as long to prepare).
This simulates work being completed at different rates.
When the`CafeDemo` <span class="emphasis"><em>main</em></span> method runs, it will loop 100 times sending a single hot drink and a single cold drink each time.
It actually sends the messages by invoking the <span class="emphasis"><em>placeOrder</em></span> method on the Cafe interface.
Above, you will see that the &lt;gateway&gt; element is specified in the configuration file.
This triggers the creation of a proxy that implements the given <span class="emphasis"><em>service-interface</em></span> and connects it to a channel.
The channel name is provided on the @Gateway annotation of the <code class="literal">Cafe</code> interface.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> Cafe {

    <em><span class="hl-annotation" style="color: gray">@Gateway(requestChannel="orders")</span></em>
    <span class="hl-keyword">void</span> placeOrder(Order order);

}</pre>
<p>Finally, have a look at the <code class="literal">main()</code> method of the <code class="literal">CafeDemo</code> itself.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
    AbstractApplicationContext context = null;
    <span class="hl-keyword">if</span> (args.length &gt; <span class="hl-number">0</span>) {
        context = <span class="hl-keyword">new</span> FileSystemXmlApplicationContext(args);
    }
    <span class="hl-keyword">else</span> {
        context = <span class="hl-keyword">new</span> ClassPathXmlApplicationContext(<span class="hl-string">"cafeDemo.xml"</span>, CafeDemo.<span class="hl-keyword">class</span>);
    }
    Cafe cafe = context.getBean(<span class="hl-string">"cafe"</span>, Cafe.<span class="hl-keyword">class</span>);
    <span class="hl-keyword">for</span> (<span class="hl-keyword">int</span> i = <span class="hl-number">1</span>; i &lt;= <span class="hl-number">100</span>; i++) {
        Order order = <span class="hl-keyword">new</span> Order(i);
        order.addItem(DrinkType.LATTE, <span class="hl-number">2</span>, false);
        order.addItem(DrinkType.MOCHA, <span class="hl-number">3</span>, true);
        cafe.placeOrder(order);
    }
}</pre>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>To run this sample as well as 8 others, refer to the <code class="literal">README.txt</code> within the "samples" directory of the main distribution as described at the beginning of this chapter.</p>
</td></tr></table></div>
<p>When you run cafeDemo, you will see that the cold drinks are initially prepared more quickly than the hot drinks.
Because there is an aggregator, the cold drinks are effectively limited by the rate of the hot drink preparation.
This is to be expected based on their respective delays of 1000 and 5000 milliseconds.
However, by configuring a poller with a concurrent task executor, you can dramatically change the results.
For example, you could use a thread pool executor with 5 workers for the hot drink barista while keeping the cold drink barista as it is:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:service-activator</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"hotDrinks"</span>
                     <span class="hl-attribute">ref</span>=<span class="hl-value">"barista"</span>
                     <span class="hl-attribute">method</span>=<span class="hl-value">"prepareHotDrink"</span>
                     <span class="hl-attribute">output-channel</span>=<span class="hl-value">"preparedDrinks"</span><span class="hl-tag">/&gt;</span>

  <span class="hl-tag">&lt;int:service-activator</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"hotDrinks"</span>
                     <span class="hl-attribute">ref</span>=<span class="hl-value">"barista"</span>
                     <span class="hl-attribute">method</span>=<span class="hl-value">"prepareHotDrink"</span>
                     <span class="hl-attribute">output-channel</span>=<span class="hl-value">"preparedDrinks"</span><span class="hl-tag">&gt;</span>
      <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">task-executor</span>=<span class="hl-value">"pool"</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"1000"</span><span class="hl-tag">/&gt;</span>
  <span class="hl-tag">&lt;/int:service-activator&gt;</span>

  <span class="hl-tag">&lt;task:executor</span> <span class="hl-attribute">id</span>=<span class="hl-value">"pool"</span> <span class="hl-attribute">pool-size</span>=<span class="hl-value">"5"</span><span class="hl-tag">/&gt;</span></pre>
<p>Also, notice that the worker thread name is displayed with each invocation.
You will see that the hot drinks are prepared by the task-executor threads.
If you provide a much shorter poller interval (such as 100 milliseconds), then you will notice that occasionally it throttles the input by forcing the task-scheduler (the caller) to invoke the operation.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>In addition to experimenting with the poller&#8217;s concurrency settings, you can also add the <span class="emphasis"><em>transactional</em></span> sub-element and then refer to any PlatformTransactionManager instance within the context.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="samples-xml-messaging" href="#samples-xml-messaging"></a>E.5.3&nbsp;The XML Messaging Sample</h3></div></div></div>

<p>The xml messaging sample in <code class="literal">basic/xml</code> illustrates how to use some of the provided components which deal with xml payloads.
The sample uses the idea of processing an order for books represented as xml.</p>
<p>NOTE:This sample shows that the namespace prefix can be whatever you want; while we usually use, <code class="literal">int-xml</code> for
integration XML components, the sample uses <code class="literal">si-xml</code>.</p>
<p>First the order is split into a number of messages, each one representing a single order item using the XPath splitter component.</p>
<pre class="programlisting"><span class="hl-tag">&lt;si-xml:xpath-splitter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"orderItemSplitter"</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"ordersChannel"</span>
              <span class="hl-attribute">output-channel</span>=<span class="hl-value">"stockCheckerChannel"</span> <span class="hl-attribute">create-documents</span>=<span class="hl-value">"true"</span><span class="hl-tag">&gt;</span>
      <span class="hl-tag">&lt;si-xml:xpath-expression</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"/orderNs:order/orderNs:orderItem"</span>
                                <span class="hl-attribute">namespace-map</span>=<span class="hl-value">"orderNamespaceMap"</span><span class="hl-tag"> /&gt;</span>
  <span class="hl-tag">&lt;/si-xml:xpath-splitter&gt;</span></pre>
<p>A service activator is then used to pass the message into a stock checker POJO.
The order item document is enriched with information from the stock checker about order item stock level.
This enriched order item message is then used to route the message.
In the case where the order item is in stock the message is routed to the warehouse.</p>
<pre class="programlisting"><span class="hl-tag">&lt;si-xml:xpath-router</span> <span class="hl-attribute">id</span>=<span class="hl-value">"instockRouter"</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"orderRoutingChannel"</span> <span class="hl-attribute">resolution-required</span>=<span class="hl-value">"true"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;si-xml:xpath-expression</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"/orderNs:orderItem/@in-stock"</span> <span class="hl-attribute">namespace-map</span>=<span class="hl-value">"orderNamespaceMap"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;si-xml:mapping</span> <span class="hl-attribute">value</span>=<span class="hl-value">"true"</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"warehouseDispatchChannel"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;si-xml:mapping</span> <span class="hl-attribute">value</span>=<span class="hl-value">"false"</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"outOfStockChannel"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/si-xml:xpath-router&gt;</span></pre>
<p>Where the order item is not in stock the message is transformed using xslt into a format suitable for sending to the supplier.</p>
<pre class="programlisting"><span class="hl-tag">&lt;si-xml:xslt-transformer</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"outOfStockChannel"</span>
  <span class="hl-attribute">output-channel</span>=<span class="hl-value">"resupplyOrderChannel"</span>
  <span class="hl-attribute">xsl-resource</span>=<span class="hl-value">"classpath:org/springframework/integration/samples/xml/bigBooksSupplierTransformer.xsl"</span><span class="hl-tag">/&gt;</span></pre>
</div>
</div>
</div>
<div class="appendix"><div class="titlepage"><div><div><h2 class="title"><a name="configuration" href="#configuration"></a>Appendix&nbsp;F.&nbsp;Configuration</h2></div></div></div>

<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="configuration-introduction" href="#configuration-introduction"></a>F.1&nbsp;Introduction</h2></div></div></div>

<p>Spring Integration offers a number of configuration options.
Which option you choose depends upon your particular needs and at what level you prefer to work.
As with the Spring framework in general, it is also possible to mix and match the various techniques according to the particular problem at hand.
For example, you may choose the XSD-based namespace for the majority of configuration combined with a handful of objects that are configured with annotations.
As much as possible, the two provide consistent naming.
XML elements defined by the XSD schema will match the names of annotations, and the attributes of those XML elements will match the names of annotation properties.
Direct usage of the API is of course always an option, but we expect that most users will choose one of the higher-level options, or a combination of the namespace-based and annotation-driven configuration.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="configuration-namespace" href="#configuration-namespace"></a>F.2&nbsp;Namespace Support</h2></div></div></div>

<p>Spring Integration components can be configured with XML elements that map directly to the terminology and concepts of enterprise integration.
In many cases, the element names match those of the <a class="ulink" href="http://www.eaipatterns.com" target="_top">Enterprise Integration Patterns</a>.</p>
<p>To enable Spring Integration&#8217;s core namespace support within your Spring configuration files, add the following namespace reference and schema mapping in your top-level <span class="emphasis"><em>beans</em></span> element:</p>
<pre class="screen">&lt;beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       <span class="strong"><strong>xmlns:int="http://www.springframework.org/schema/integration"</strong></span>
       xsi:schemaLocation="http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans.xsd
           <span class="strong"><strong>http://www.springframework.org/schema/integration</strong></span>
           <span class="strong"><strong>http://www.springframework.org/schema/integration/spring-integration.xsd</strong></span>"&gt;</pre>
<p>You can choose any name after "xmlns:"; <span class="emphasis"><em>int</em></span> is used here for clarity, but you might prefer a shorter abbreviation.
Of course if you are using an XML-editor or IDE support, then the availability of auto-completion may convince you to keep the longer name for clarity.
Alternatively, you can create configuration files that use the Spring Integration schema as the primary namespace:</p>
<pre class="screen"><span class="strong"><strong>&lt;beans:beans xmlns="http://www.springframework.org/schema/integration"</strong></span>
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:beans="http://www.springframework.org/schema/beans"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans.xsd
           <span class="strong"><strong>http://www.springframework.org/schema/integration</strong></span>
           <span class="strong"><strong>http://www.springframework.org/schema/integration/spring-integration.xsd</strong></span>"&gt;</pre>
<p>When using this alternative, no prefix is necessary for the Spring Integration elements.
On the other hand, if you want to define a generic Spring "bean" within the same configuration file, then a prefix would be required for the bean element (<code class="literal">&lt;beans:bean .../&gt;</code>).
Since it is generally a good idea to modularize the configuration files themselves based on responsibility and/or architectural layer, you may find it appropriate to use the latter approach in the integration-focused configuration files, since generic beans are seldom necessary within those same files.
For purposes of this documentation, we will assume the "integration" namespace is primary.</p>
<p>Many other namespaces are provided within the Spring Integration distribution.
In fact, each adapter type (JMS, File, etc.) that provides namespace support defines its elements within a separate schema.
In order to use these elements, simply add the necessary namespaces with an "xmlns" entry and the corresponding "schemaLocation" mapping.
For example, the following root element shows several of these namespace declarations:</p>
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
  <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
  <span class="hl-attribute">xmlns:int</span>=<span class="hl-value">"http://www.springframework.org/schema/integration"</span>
  <span class="hl-attribute">xmlns:int-file</span>=<span class="hl-value">"http://www.springframework.org/schema/integration/file"</span>
  <span class="hl-attribute">xmlns:int-jms</span>=<span class="hl-value">"http://www.springframework.org/schema/integration/jms"</span>
  <span class="hl-attribute">xmlns:int-mail</span>=<span class="hl-value">"http://www.springframework.org/schema/integration/mail"</span>
  <span class="hl-attribute">xmlns:int-rmi</span>=<span class="hl-value">"http://www.springframework.org/schema/integration/rmi"</span>
  <span class="hl-attribute">xmlns:int-ws</span>=<span class="hl-value">"http://www.springframework.org/schema/integration/ws"</span>
  <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"http://www.springframework.org/schema/beans
    http://www.springframework.org/schema/beans/spring-beans.xsd
    http://www.springframework.org/schema/integration
    http://www.springframework.org/schema/integration/spring-integration.xsd
    http://www.springframework.org/schema/integration/file
    http://www.springframework.org/schema/integration/file/spring-integration-file.xsd
    http://www.springframework.org/schema/integration/jms
    http://www.springframework.org/schema/integration/jms/spring-integration-jms.xsd
    http://www.springframework.org/schema/integration/mail
    http://www.springframework.org/schema/integration/mail/spring-integration-mail.xsd
    http://www.springframework.org/schema/integration/rmi
    http://www.springframework.org/schema/integration/rmi/spring-integration-rmi.xsd
    http://www.springframework.org/schema/integration/ws
    http://www.springframework.org/schema/integration/ws/spring-integration-ws.xsd"</span><span class="hl-tag">&gt;</span>
 ...
<span class="hl-tag">&lt;/beans&gt;</span></pre>
<p>The reference manual provides specific examples of the various elements in their corresponding chapters.
Here, the main thing to recognize is the consistency of the naming for each namespace URI and schema location.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="namespace-taskscheduler" href="#namespace-taskscheduler"></a>F.3&nbsp;Configuring the Task Scheduler</h2></div></div></div>

<p>In Spring Integration, the ApplicationContext plays the central role of a Message Bus, and there are only a couple configuration options to consider.
First, you may want to control the central TaskScheduler instance.
You can do so by providing a single bean with the name "taskScheduler".
This is also defined as a constant:</p>
<pre class="programlisting">IntegrationContextUtils.TASK_SCHEDULER_BEAN_NAME</pre>
<p>By default Spring Integration relies on an instance of ThreadPoolTaskScheduler as described in the <a class="ulink" href="http://docs.spring.io/spring/docs/current/spring-framework-reference/html/scheduling.html" target="_top">Task Execution and Scheduling</a> section of the Spring Framework reference manual.
That default TaskScheduler will startup automatically with a pool of 10 threads, but see <a class="xref" href="#global-properties" title="F.5&nbsp;Global Properties">Section&nbsp;F.5, &#8220;Global Properties&#8221;</a>.
If you provide your own TaskScheduler instance instead, you can set the <span class="emphasis"><em>autoStartup</em></span> property to <span class="emphasis"><em>false</em></span>, and/or you can provide your own pool size value.</p>
<p>When Polling Consumers provide an explicit task-executor reference in their configuration, the invocation of the handler methods will happen within that executor&#8217;s thread pool and not the main scheduler pool.
However, when no task-executor is provided for an endpoint&#8217;s poller, it will be invoked by one of the main scheduler&#8217;s threads.</p>
<div class="caution" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Caution"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Caution]" src="images/caution.png"></td><th align="left">Caution</th></tr><tr><td align="left" valign="top">
<p>Do not run long-running tasks on poller threads; use a task executor instead.
If you have a lot of polling endpoints, you can cause thread starvation, unless you increase the pool size.
Also, polling consumers have a default <code class="literal">receiveTimeout</code> of 1 second; since the poller thread blocks for this time,
it is recommended that a task executor be used when many such endpoints exist, again to avoid starvation.
Alternatively, reduce the <code class="literal">receiveTimeout</code>.</p>
</td></tr></table></div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>An endpoint is a <span class="emphasis"><em>Polling Consumer</em></span> if its input channel is one of the queue-based (i.e. pollable) channels.
<span class="emphasis"><em>Event Driven Consumers</em></span> are those having input channels that have dispatchers instead of queues (i.e. they are subscribable).
Such endpoints have no poller configuration since their handlers will be invoked directly.</p>
</td></tr></table></div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>When running in a JEE container, you may need to use Spring&#8217;s <code class="literal">TimerManagerTaskScheduler</code> as described
<a class="ulink" href="http://docs.spring.io/spring/docs/current/spring-framework-reference/html/scheduling.html#scheduling-task-scheduler-implementations" target="_top">here</a>,
instead of the default <span class="emphasis"><em>taskScheduler</em></span>.
To do that, simply define a bean with the appropriate JNDI name for your environment, for example:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"taskScheduler"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.scheduling.commonj.TimerManagerTaskScheduler"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"timerManagerName"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"tm/MyTimerManager"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"resourceRef"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"true"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
</td></tr></table></div>
<p>The next section will describe what happens if Exceptions occur within the asynchronous invocations.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="namespace-errorhandler" href="#namespace-errorhandler"></a>F.4&nbsp;Error Handling</h2></div></div></div>

<p>As described in the overview at the very beginning of this manual, one of the main motivations behind a Message-oriented
framework like Spring Integration is to promote loose-coupling between components.
The Message Channel plays an important role in that producers and consumers do not have to know about each other.
However, the advantages also have some drawbacks.
Some things become more complicated in a very loosely coupled environment, and one example is error handling.</p>
<p>When sending a Message to a channel, the component that ultimately handles that Message may or may not be operating within the same thread as the sender.
If using a simple default <code class="literal">DirectChannel</code> (with the <code class="literal">&lt;channel&gt;</code> element that has no <code class="literal">&lt;queue&gt;</code> sub-element and no <span class="emphasis"><em>task-executor</em></span> attribute),
the Message-handling will occur in the same thread as the Message-sending.
In that case, if an <code class="literal">Exception</code> is thrown, it can be caught by the sender (or it may propagate past the sender if it is an uncaught <code class="literal">RuntimeException</code>).
So far, everything is fine.
This is the same behavior as an Exception-throwing operation in a normal call stack.
However, when adding the asynchronous aspect, things become much more complicated.
For instance, if the <span class="emphasis"><em>channel</em></span> element <span class="emphasis"><em>does</em></span> provide a <span class="emphasis"><em>queue</em></span> sub-element, then the component that handles the Message <span class="emphasis"><em>will</em></span> be operating in a different thread than the sender.
The sender may have dropped the <code class="literal">Message</code> into the channel and moved on to other things.
There is no way for the <code class="literal">Exception</code> to be thrown directly back to that sender using standard <code class="literal">Exception</code> throwing techniques.
Instead, to handle errors for asynchronous processes requires an asynchronous error-handling mechanism as well.</p>
<p>Spring Integration supports error handling for its components by publishing errors to a Message Channel.
Specifically, the <code class="literal">Exception</code> will become the payload of a Spring Integration Message.
That <code class="literal">Message</code> will then be sent to a Message Channel that is resolved in a way that is similar to the <span class="emphasis"><em>replyChannel</em></span> resolution.
First, if the request <code class="literal">Message</code> being handled at the time the <code class="literal">Exception</code> occurred contains an <span class="emphasis"><em>errorChannel</em></span> header (the
header name is defined in the constant: <code class="literal">MessageHeaders.ERROR_CHANNEL</code>), the <code class="literal">ErrorMessage</code> will be sent to that channel.
Otherwise, the error handler will send to a "global" channel whose bean name is "errorChannel"
(this is also defined as a constant: <code class="literal">IntegrationContextUtils.ERROR_CHANNEL_BEAN_NAME</code>).</p>
<p>A default "errorChannel" bean is created behind the scenes by the Framework.
However, you can just as easily define your own if you want to control the settings.</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"errorChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:queue</span> <span class="hl-attribute">capacity</span>=<span class="hl-value">"500"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:channel&gt;</span></pre>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The default "errorChannel" is a <code class="literal">PublishSubscribeChannel</code>.</p>
</td></tr></table></div>
<p>The most important thing to understand here is that the messaging-based error handling will only apply to Exceptions
that are thrown by a Spring Integration task that is executing within a <code class="literal">TaskExecutor</code>.
This does <span class="emphasis"><em>not</em></span> apply to Exceptions thrown by a handler that is operating within the same thread as the sender (e.g.
through a <code class="literal">DirectChannel</code> as described above).</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>When Exceptions occur in a scheduled poller task&#8217;s execution, those exceptions will be wrapped in <code class="literal">ErrorMessages</code> and sent to the <span class="emphasis"><em>errorChannel</em></span> as well.</p>
</td></tr></table></div>
<p>To enable global error handling, simply register a handler on that channel.
For example, you can configure Spring Integration&#8217;s <code class="literal">ErrorMessageExceptionTypeRouter</code> as the handler of an endpoint that is subscribed to the <span class="emphasis"><em>errorChannel</em></span>.
That router can then spread the error messages across multiple channels based on <code class="literal">Exception</code> type.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="global-properties" href="#global-properties"></a>F.5&nbsp;Global Properties</h2></div></div></div>

<p>Certain global framework properties can be overridden by providing a properties file on the classpath.</p>
<p>The default properties can be found in <code class="literal">/META-INF/spring.integration.default.properties</code> in the <code class="literal">spring-integration-core</code>
jar.
You can see them on GitHub <a class="ulink" href="https://github.com/spring-projects/spring-integration/blob/master/spring-integration-core/src/main/resources/META-INF/spring.integration.default.properties" target="_top">here</a>,
but here are the current default values:</p>
<pre class="screen">spring.integration.channels.autoCreate=true <a name="CO59-1" href="#CO59-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
spring.integration.channels.maxUnicastSubscribers=0x7fffffff <a name="CO59-2" href="#CO59-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
spring.integration.channels.maxBroadcastSubscribers=0x7fffffff <a name="CO59-3" href="#CO59-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
spring.integration.taskScheduler.poolSize=10 <a name="CO59-4" href="#CO59-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
spring.integration.messagingTemplate.throwExceptionOnLateReply=false <a name="CO59-5" href="#CO59-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
spring.integration.messagingAnnotations.require.componentAnnotation=false <a name="CO59-6" href="#CO59-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>
spring.integration.readOnly.headers= <a name="CO59-7" href="#CO59-7"></a><span><img src="images/callouts/7.png" alt="7" border="0"></span>
spring.integration.endpoints.noAutoStartup= <a name="CO59-8" href="#CO59-8"></a><span><img src="images/callouts/8.png" alt="8" border="0"></span>
spring.integration.postProcessDynamicBeans=false <a name="CO59-9" href="#CO59-9"></a><span><img src="images/callouts/9.png" alt="9" border="0"></span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO59-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>When true, <code class="literal">input-channel</code> s will be automatically declared as <code class="literal">DirectChannel</code> s when not explicitly found in the
application context.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO59-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>This property provides the default number of subscribers allowed on, say, a <code class="literal">DirectChannel</code>.
It can be used to avoid inadvertently subscribing multiple endpoints to the same channel.
This can be overridden on individual channels with the <code class="literal">max-subscribers</code> attribute.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO59-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>This property provides the default number of subscribers allowed on, say, a <code class="literal">PublishSubscribeChannel</code>.
It can be used to avoid inadvertently subscribing more than the expected number of endpoints to the same channel.
This can be overridden on individual channels with the <code class="literal">max-subscribers</code> attribute.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO59-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The number of threads available in the default <code class="literal">taskScheduler</code> bean; see <a class="xref" href="#namespace-taskscheduler" title="F.3&nbsp;Configuring the Task Scheduler">Section&nbsp;F.3, &#8220;Configuring the Task Scheduler&#8221;</a>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO59-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>When <code class="literal">true</code>, messages that arrive at a gateway reply channel will throw an exception, when the gateway is not
expecting a reply - because the sending thread has timed out, or already received a reply.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO59-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>When <code class="literal">true</code>, Messaging Annotation Support (<a class="xref" href="#annotations" title="F.6&nbsp;Annotation Support">Section&nbsp;F.6, &#8220;Annotation Support&#8221;</a>) requires a declaration of the
<code class="literal">@MessageEndpoint</code> (or any other <code class="literal">@Component</code>) annotation on the class level.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO59-7"><span><img src="images/callouts/7.png" alt="7" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A comma-separated list of message header names which should not be populated into <code class="literal">Message</code> s during a header copying operation.
The list is used by the <code class="literal">DefaultMessageBuilderFactory</code> bean and propagated to the <code class="literal">IntegrationMessageHeaderAccessor</code> instances (see <a class="xref" href="#message-header-accessor" title="MessageHeaderAccessor API">the section called &#8220;MessageHeaderAccessor API&#8221;</a>), used to build messages via <code class="literal">MessageBuilder</code> (see <a class="xref" href="#message-builder" title="5.1.4&nbsp;The MessageBuilder Helper Class">Section&nbsp;5.1.4, &#8220;The MessageBuilder Helper Class&#8221;</a>).
By default only <code class="literal">MessageHeaders.ID</code> and <code class="literal">MessageHeaders.TIMESTAMP</code> are not copied during message building.
<span class="emphasis"><em>Since version 4.3.2</em></span></p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO59-8"><span><img src="images/callouts/8.png" alt="8" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A comma-separated list of <code class="literal">AbstractEndpoint</code> bean names patterns (<code class="literal">xxx*</code>, <code class="literal">*xxx</code>, <code class="literal">*xxx*</code> or <code class="literal">xxx*yyy</code>) which should not be started automatically during application startup.
These endpoints can be started later manually by their bean name via <code class="literal">Control Bus</code> (see <a class="xref" href="#control-bus" title="9.6&nbsp;Control Bus">Section&nbsp;9.6, &#8220;Control Bus&#8221;</a>), by their role using the <code class="literal">SmartLifecycleRoleController</code> (see <a class="xref" href="#endpoint-roles" title="8.2&nbsp;Endpoint Roles">Section&nbsp;8.2, &#8220;Endpoint Roles&#8221;</a>) or via simple <code class="literal">Lifecycle</code> bean injection.
The effect of this global property can be explicitly overridden by specifying <code class="literal">auto-startup</code> XML or <code class="literal">autoStartup</code> annotation attribute, or via call to the <code class="literal">AbstractEndpoint.setAutoStartup()</code> in bean definition.
<span class="emphasis"><em>Since version 4.3.12</em></span></p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO59-9"><span><img src="images/callouts/9.png" alt="9" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A boolean flag to indicate that <code class="literal">BeanPostProcessor</code> s should post-process beans registered at runtime, e.g. message channels created via <code class="literal">IntegrationFlowContext</code> can be supplied with global channel interceptors.
<span class="emphasis"><em>Since version 4.3.15</em></span></p>
</td></tr></table></div>
<p>These properties can be overridden by adding a file <code class="literal">/META-INF/spring.integration.properties</code> to the classpath.
It is not necessary to provide all the properties, just those that you want to override.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>In versions prior to <span class="emphasis"><em>4.3</em></span>, these property names had a typographical error (<code class="literal">...integraton...</code>); they have now been
corrected (<code class="literal">...integration...</code>).</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="annotations" href="#annotations"></a>F.6&nbsp;Annotation Support</h2></div></div></div>

<p>In addition to the XML namespace support for configuring Message Endpoints, it is also possible to use annotations.
First, Spring Integration provides the class-level <code class="literal">@MessageEndpoint</code> as a <span class="emphasis"><em>stereotype</em></span> annotation, meaning that it is itself annotated with Spring&#8217;s <code class="literal">@Component</code> annotation and is therefore recognized automatically as a bean definition when using Spring component-scanning.</p>
<p>Even more important are the various method-level annotations that indicate the annotated method is capable of handling a message.
The following example demonstrates both:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@MessageEndpoint</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> FooService {

    <em><span class="hl-annotation" style="color: gray">@ServiceActivator</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> processMessage(Message message) {
        ...
    }
}</pre>
<p>Exactly what it means for the method to "handle" the Message depends on the particular annotation.
Annotations available in Spring Integration include:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
@Aggregator
</li><li class="listitem">
@Filter
</li><li class="listitem">
@Router
</li><li class="listitem">
@ServiceActivator
</li><li class="listitem">
@Splitter
</li><li class="listitem">
@Transformer
</li><li class="listitem">
@InboundChannelAdapter
</li><li class="listitem">
@BridgeFrom
</li><li class="listitem">
@BridgeTo
</li><li class="listitem">
@MessagingGateway
</li><li class="listitem">
@IntegrationComponentScan
</li></ul></div>
<p>The behavior of each is described in its own chapter or section within this reference.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>If you are using XML configuration in combination with annotations, the <code class="literal">@MessageEndpoint</code> annotation is not required.
If you want to configure a POJO reference from the "ref" attribute of a <code class="literal">&lt;service-activator/&gt;</code> element,
it is sufficient to provide the method-level annotations.
In that case, the annotation prevents ambiguity even when no "method" attribute exists on the <code class="literal">&lt;service-activator/&gt;</code> element.</p>
</td></tr></table></div>
<p>In most cases, the annotated handler method should not require the <code class="literal">Message</code> type as its parameter.
Instead, the method parameter type can match the message&#8217;s payload type.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> FooService {

    <em><span class="hl-annotation" style="color: gray">@ServiceActivator</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> bar(Foo foo) {
        ...
    }

}</pre>
<p>When the method parameter should be mapped from a value in the <code class="literal">MessageHeaders</code>, another option is to use the parameter-level <code class="literal">@Header</code> annotation.
In general, methods annotated with the Spring Integration annotations can either accept the <code class="literal">Message</code> itself, the message payload, or a header value (with @Header) as the parameter.
In fact, the method can accept a combination, such as:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> FooService {

    <em><span class="hl-annotation" style="color: gray">@ServiceActivator</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> bar(String payload, <em><span class="hl-annotation" style="color: gray">@Header("x")</span></em> <span class="hl-keyword">int</span> valueX, <em><span class="hl-annotation" style="color: gray">@Header("y")</span></em> <span class="hl-keyword">int</span> valueY) {
        ...
    }

}</pre>
<p>There is also a @Headers annotation that provides all of the Message headers as a Map:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> FooService {

    <em><span class="hl-annotation" style="color: gray">@ServiceActivator</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> bar(String payload, <em><span class="hl-annotation" style="color: gray">@Headers</span></em> Map&lt;String, Object&gt; headerMap) {
        ...
    }

}</pre>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The value of the annotation can also be a SpEL expression (e.g., <code class="literal">someHeader.toUpperCase()</code>) which is useful
when you wish to manipulate the header value before injecting it.
It also provides an optional <span class="emphasis"><em>required</em></span> property which specifies whether the attribute value must be available within
the headers.
The default value for <span class="emphasis"><em>required</em></span> is <code class="literal">true</code>.</p>
</td></tr></table></div>
<p>For several of these annotations, when a Message-handling method returns a non-null value, the endpoint will attempt to send a reply.
This is consistent across both configuration options (namespace and annotations) in that such an endpoint&#8217;s output channel will be used if available, and the REPLY_CHANNEL message header value will be used as a fallback.</p>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>The combination of output channels on endpoints and the reply channel message header enables a pipeline approach where multiple components have an output channel, and the final component simply allows the reply message to be forwarded to the reply channel as specified in the original request message.
In other words, the final component depends on the information provided by the original sender and can dynamically support any number of clients as a result.
This is an example of <a class="ulink" href="http://eaipatterns.com/ReturnAddress.html" target="_top">Return Address</a>.</p>
</td></tr></table></div>
<p>In addition to the examples shown here, these annotations also support inputChannel and outputChannel properties.</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Service</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> FooService {

    <em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel="input", outputChannel="output")</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> bar(String payload, <em><span class="hl-annotation" style="color: gray">@Headers</span></em> Map&lt;String, Object&gt; headerMap) {
        ...
    }

}</pre>
<p>The processing of these annotations creates the same beans (<code class="literal">AbstractEndpoint</code> s and <code class="literal">MessageHandler</code> s (or <code class="literal">MessageSource</code> s for the inbound channel adapter - see below) as with similar xml components.
The bean names are generated with this pattern: <code class="literal">[componentName].[methodName].[decapitalizedAnnotationClassShortName]</code>
(e.g for the sample above - <code class="literal">fooService.bar.serviceActivator</code>)
for the <code class="literal">AbstractEndpoint</code> and the same name with an additional <code class="literal">.handler</code> (<code class="literal">.source</code>) suffix for the <code class="literal">MessageHandler</code> (<code class="literal">MessageSource</code>) bean.
The <code class="literal">MessageHandler</code> s (<code class="literal">MessageSource</code> s) are also eligible to be tracked by <a class="xref" href="#message-history" title="9.3&nbsp;Message History">Section&nbsp;9.3, &#8220;Message History&#8221;</a>.</p>
<p>Starting with <span class="emphasis"><em>version 4.0</em></span>, all Messaging Annotations provide <code class="literal">SmartLifecycle</code> options - <code class="literal">autoStartup</code> and <code class="literal">phase</code> to allow endpoint lifecycle control on application context initialization.
They default to <code class="literal">true</code> and <code class="literal">0</code> respectively.
To change the state of an endpoint (e.g` start()/stop()<code class="literal">) obtain a reference to the endpoint bean using the `BeanFactory</code> (or autowiring) and invoke the method(s), or send a <span class="emphasis"><em>command message</em></span> to the <code class="literal">Control Bus</code> (<a class="xref" href="#control-bus" title="9.6&nbsp;Control Bus">Section&nbsp;9.6, &#8220;Control Bus&#8221;</a>).
For these purposes you should use the <code class="literal">beanName</code> mentioned above.</p>
<p><span class="strong"><strong>@Poller</strong></span></p>
<p>Before <span class="emphasis"><em>Spring Integration 4.0</em></span>, the above Messaging Annotations required that the <code class="literal">inputChannel</code> was a reference to a <code class="literal">SubscribableChannel</code>.
For <code class="literal">PollableChannel</code> s there was need to use a <code class="literal">&lt;int:bridge/&gt;</code>, to configure a <code class="literal">&lt;int:poller/&gt;</code> to make the composite endpoint - a <code class="literal">PollingConsumer</code>.
Starting with <span class="emphasis"><em>version 4.0</em></span>, the <code class="literal">@Poller</code> annotation has been introduced to allow the configuration of <code class="literal">poller</code> attributes directly on the above Messaging Annotations:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> AnnotationService {

	<em><span class="hl-annotation" style="color: gray">@Transformer(inputChannel = "input", outputChannel = "output",
		poller = @Poller(maxMessagesPerPoll = "${poller.maxMessagesPerPoll}", fixedDelay = "${poller.fixedDelay}"))</span></em>
	<span class="hl-keyword">public</span> String handle(String payload) {
		...
	}
}</pre>
<p>This annotation provides only simple <code class="literal">PollerMetadata</code> options.
The <code class="literal">@Poller</code>'s attributes <code class="literal">maxMessagesPerPoll</code>, <code class="literal">fixedDelay</code>, <code class="literal">fixedRate</code> and <code class="literal">cron</code> can be configured with _property-placeholder_s.
If it is necessary to provide more polling options (e.g.
transaction, advice-chain, error-handler), the`PollerMetadata` should be configured as a generic bean with its bean name used for <code class="literal">@Poller</code>'s <code class="literal">value</code> attribute.
In this case, no other attributes are allowed (they would be specified on the <code class="literal">PollerMetadata</code> bean).
Note, if <code class="literal">inputChannel</code> is <code class="literal">PollableChannel</code> and no <code class="literal">@Poller</code> is configured, the default <code class="literal">PollerMetadata</code> will be used, if it is present in the application context.
To declare the default poller using <code class="literal">@Configuration</code>, use:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean(name = PollerMetadata.DEFAULT_POLLER)</span></em>
<span class="hl-keyword">public</span> PollerMetadata defaultPoller() {
	PollerMetadata pollerMetadata = <span class="hl-keyword">new</span> PollerMetadata();
	pollerMetadata.setTrigger(<span class="hl-keyword">new</span> PeriodicTrigger(<span class="hl-number">10</span>));
	<span class="hl-keyword">return</span> pollerMetadata;
}</pre>
<p>With this endpoint using the default poller:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> AnnotationService {

	<em><span class="hl-annotation" style="color: gray">@Transformer(inputChannel = "aPollableChannel", outputChannel = "output")</span></em>
	<span class="hl-keyword">public</span> String handle(String payload) {
		...
	}
}</pre>
<p>To use a named poller, use:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> PollerMetadata myPoller() {
	PollerMetadata pollerMetadata = <span class="hl-keyword">new</span> PollerMetadata();
	pollerMetadata.setTrigger(<span class="hl-keyword">new</span> PeriodicTrigger(<span class="hl-number">1000</span>));
	<span class="hl-keyword">return</span> pollerMetadata;
}</pre>
<p>With this endpoint using the default poller:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> AnnotationService {

	<em><span class="hl-annotation" style="color: gray">@Transformer(inputChannel = "aPollableChannel", outputChannel = "output"
						poller = @Poller("myPoller"))</span></em>
	<span class="hl-keyword">public</span> String handle(String payload) {
		...
	}
}</pre>
<p><span class="strong"><strong>@InboundChannelAdapter</strong></span></p>
<p>Starting with <span class="emphasis"><em>version 4.0</em></span>, the <code class="literal">@InboundChannelAdapter</code> method annotation is available.
This produces a <code class="literal">SourcePollingChannelAdapter</code> integration component based on a <code class="literal">MethodInvokingMessageSource</code> for the annotated method.
This annotation is an analogue of <code class="literal">&lt;int:inbound-channel-adapter&gt;</code> XML component and has the same restrictions: the method cannot have parameters, and the return type must not be <code class="literal">void</code>.
It has two attributes: <code class="literal">value</code> - the required <code class="literal">MessageChannel</code> bean name and <code class="literal">poller</code> - an optional <code class="literal">@Poller</code> annotation, as described above.
If there is need to provide some <code class="literal">MessageHeaders</code>, use a <code class="literal">Message&lt;?&gt;</code> return type and build the <code class="literal">Message&lt;?&gt;</code> within the method using a <code class="literal">MessageBuilder</code> to configure its <code class="literal">MessageHeaders</code>.</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@InboundChannelAdapter("counterChannel")</span></em>
<span class="hl-keyword">public</span> Integer count() {
	<span class="hl-keyword">return</span> <span class="hl-keyword">this</span>.counter.incrementAndGet();
}

<em><span class="hl-annotation" style="color: gray">@InboundChannelAdapter(value = "fooChannel", poller = @Poller(fixed-rate = "5000"))</span></em>
<span class="hl-keyword">public</span> String foo() {
	<span class="hl-keyword">return</span> <span class="hl-string">"foo"</span>;
}</pre>
<p>Starting with <span class="emphasis"><em>version 4.3</em></span> the <code class="literal">channel</code> alias for the <code class="literal">value</code> annotation attribute has been introduced for better
source code readability.
Also the target <code class="literal">MessageChannel</code> bean is resolved in the <code class="literal">SourcePollingChannelAdapter</code> by the provided name
(<code class="literal">outputChannelName</code> options) on the first <code class="literal">receive()</code> call, not during
initialization phase.
It allows the <span class="emphasis"><em>late binding</em></span> logic, when the target <code class="literal">MessageChannel</code> bean from the consumer perspective
is created and registered a bit later than the <code class="literal">@InboundChannelAdapter</code> parsing phase.</p>
<p>The first example requires that the default poller has been declared elsewhere in the application context.</p>
<p><span class="strong"><strong>@MessagingGateway</strong></span></p>
<p>See <a class="xref" href="#messaging-gateway-annotation" title="8.4.6&nbsp;@MessagingGateway Annotation">Section&nbsp;8.4.6, &#8220;@MessagingGateway Annotation&#8221;</a>.</p>
<p><span class="strong"><strong>@IntegrationComponentScan</strong></span></p>
<p>The standard Spring Framework <code class="literal">@ComponentScan</code> annotation doesn&#8217;t scan interfaces for stereotype <code class="literal">@Component</code>
annotations.
To overcome this limitation and allow the configuration of <code class="literal">@MessagingGateway</code> (see <a class="xref" href="#messaging-gateway-annotation" title="8.4.6&nbsp;@MessagingGateway Annotation">Section&nbsp;8.4.6, &#8220;@MessagingGateway Annotation&#8221;</a>),
the <code class="literal">@IntegrationComponentScan</code> mechanism has been introduced.
This annotation must be placed along with a <code class="literal">@Configuration</code> annotation, and customized for the scanning options,
such as <code class="literal">basePackages</code> and <code class="literal">basePackageClasses</code>.
In this case all discovered interfaces annotated with <code class="literal">@MessagingGateway</code> will be parsed and registered
as a <code class="literal">GatewayProxyFactoryBean</code> s.
All other class-based components are parsed by the standard <code class="literal">@ComponentScan</code>.
In future, more scanning logic may be added to the <code class="literal">@IntegrationComponentScan</code>.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="meta-annotations" href="#meta-annotations"></a>F.6.1&nbsp;Messaging Meta-Annotations</h3></div></div></div>

<p>Starting with <span class="emphasis"><em>version 4.0</em></span>, all Messaging Annotations can be configured as meta-annotations and all user-defined Messaging Annotations can define the same attributes to override their default values.
In addition, meta-annotations can be configured hierarchically:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Target({ElementType.METHOD, ElementType.ANNOTATION_TYPE})</span></em>
<em><span class="hl-annotation" style="color: gray">@Retention(RetentionPolicy.RUNTIME)</span></em>
<em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "annInput", outputChannel = "annOutput")</span></em>
<span class="hl-keyword">public</span> <em><span class="hl-annotation" style="color: gray">@interface</span></em> MyServiceActivator {

	String[] adviceChain = { <span class="hl-string">"annAdvice"</span> };
}

<em><span class="hl-annotation" style="color: gray">@Target({ElementType.METHOD, ElementType.ANNOTATION_TYPE})</span></em>
<em><span class="hl-annotation" style="color: gray">@Retention(RetentionPolicy.RUNTIME)</span></em>
<em><span class="hl-annotation" style="color: gray">@MyServiceActivator</span></em>
<span class="hl-keyword">public</span> <em><span class="hl-annotation" style="color: gray">@interface</span></em> MyServiceActivator1 {

	String inputChannel();

	String outputChannel();
}
...

<em><span class="hl-annotation" style="color: gray">@MyServiceActivator1(inputChannel = "inputChannel", outputChannel = "outputChannel")</span></em>
<span class="hl-keyword">public</span> Object service(Object payload) {
   ...
}</pre>
<p>This allows users to set defaults for various attributes and enables isolation of framework Java dependencies to user annotations, avoiding their use in user classes.
If the framework finds a method with a user annotation that has a framework meta-annotation, it is treated as if the method was annotated directly with the framework annotation.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="annotations_on_beans" href="#annotations_on_beans"></a>F.6.2&nbsp;Annotations on @Beans</h3></div></div></div>

<p>Starting with <span class="emphasis"><em>version 4.0</em></span>, Messaging Annotations can be configured on <code class="literal">@Bean</code> method definitions in <code class="literal">@Configuration</code> classes, to produce Message Endpoints based on the beans, not methods.
It is useful when <code class="literal">@Bean</code> definitions are "out of the box" <code class="literal">MessageHandler</code> s (<code class="literal">AggregatingMessageHandler</code>, <code class="literal">DefaultMessageSplitter</code> etc.), <code class="literal">Transformer</code> s (<code class="literal">JsonToObjectTransformer</code>, <code class="literal">ClaimCheckOutTransformer</code> etc.), <code class="literal">MessageSource</code> s (<code class="literal">FileReadingMessageSource</code>, <code class="literal">RedisStoreMessageSource</code> etc.):</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Configuration</span></em>
<em><span class="hl-annotation" style="color: gray">@EnableIntegration</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyFlowConfiguration {

	<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
	<em><span class="hl-annotation" style="color: gray">@InboundChannelAdapter(value = "inputChannel", poller = @Poller(fixedDelay = "1000"))</span></em>
	<span class="hl-keyword">public</span> MessageSource&lt;String&gt; consoleSource() {
		<span class="hl-keyword">return</span> CharacterStreamReadingMessageSource.stdin();
	}

	<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
	<em><span class="hl-annotation" style="color: gray">@Transformer(inputChannel = "inputChannel", outputChannel = "httpChannel")</span></em>
	<span class="hl-keyword">public</span> ObjectToMapTransformer toMapTransformer() {
		<span class="hl-keyword">return</span> <span class="hl-keyword">new</span> ObjectToMapTransformer();
	}

	<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
	<em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "httpChannel")</span></em>
	<span class="hl-keyword">public</span> MessageHandler httpHandler() {
		HttpRequestExecutingMessageHandler handler = <span class="hl-keyword">new</span> HttpRequestExecutingMessageHandler(<span class="hl-string">"http://foo/service"</span>);
		handler.setExpectedResponseType(String.<span class="hl-keyword">class</span>);
		handler.setOutputChannelName(<span class="hl-string">"outputChannel"</span>);
		<span class="hl-keyword">return</span> handler;
	}

	<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
	<em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "outputChannel")</span></em>
	<span class="hl-keyword">public</span> LoggingHandler loggingHandler() {
		<span class="hl-keyword">return</span> <span class="hl-keyword">new</span> LoggingHandler(<span class="hl-string">"info"</span>);
	}

}</pre>
<p>The meta-annotation rules work on <code class="literal">@Bean</code> methods as well (<code class="literal">@MyServiceActivator</code> above can be applied to a <code class="literal">@Bean</code> definition).</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>When using these annotations on consumer <code class="literal">@Bean</code> definitions, if the bean definition returns an appropriate
<code class="literal">MessageHandler</code> (depending on the annotation type), attributes such as <code class="literal">outputChannel</code>, <code class="literal">requiresReply</code> etc,
must be set on the <code class="literal">MessageHandler</code> <code class="literal">@Bean</code> definition itself.
The only annotation attributes used are <code class="literal">adviceChain</code>, <code class="literal">autoStartup</code>, <code class="literal">inputChannel</code>, <code class="literal">phase</code>, <code class="literal">poller</code>,
all other attributes are for the handler.</p>
</td></tr></table></div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The bean names are generated with this algorithm:
* The <code class="literal">MessageHandler</code> (<code class="literal">MessageSource</code>) <code class="literal">@Bean</code> gets its own standard name from the method name or <code class="literal">name</code> attribute on
the <code class="literal">@Bean</code>.
This works like there is no Messaging Annotation on the <code class="literal">@Bean</code> method.
* The <code class="literal">AbstractEndpoint</code> bean name is generated with the pattern:
<code class="literal">[configurationComponentName].[methodName].[decapitalizedAnnotationClassShortName]</code>.
For example the endpoint (<code class="literal">SourcePollingChannelAdapter</code>) for the <code class="literal">consoleSource()</code> definition above gets a bean name like:
<code class="literal">myFlowConfiguration.consoleSource.inboundChannelAdapter</code>.</p>
</td></tr></table></div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>When using these annotations on <code class="literal">@Bean</code> definitions, the <code class="literal">inputChannel</code> must reference a declared bean; channels are not automatically declared in this case.</p>
</td></tr></table></div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>With Java &amp; Annotation configuration we can use any <code class="literal">@Conditional</code> (e.g. <code class="literal">@Profile</code>) definition on the <code class="literal">@Bean</code>
method level, meaning to skip the bean registration by some condition reason:</p>
</td></tr></table></div>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "skippedChannel")</span></em>
<em><span class="hl-annotation" style="color: gray">@Profile("foo")</span></em>
<span class="hl-keyword">public</span> MessageHandler skipped() {
	<span class="hl-keyword">return</span> System.out::println;
}</pre>
<p>Together with the existing Spring Container logic, the Messaging Endpoint bean, based on the <code class="literal">@ServiceActivator</code>
 annotation, won&#8217;t be registered as well.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_creating_a_bridge_with_annotations" href="#_creating_a_bridge_with_annotations"></a>F.6.3&nbsp;Creating a Bridge with Annotations</h3></div></div></div>

<p>Starting with <span class="emphasis"><em>version 4.0</em></span>, the Messaging Annotation and Java configuration provides <code class="literal">@BridgeFrom</code> and <code class="literal">@BridgeTo</code> <code class="literal">@Bean</code> method annotations to mark <code class="literal">MessageChannel</code> beans in <code class="literal">@Configuration</code> classes.
This is just for completeness, providing a convenient mechanism to declare a`BridgeHandler` and its Message Endpoint configuration:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> PollableChannel bridgeFromInput() {
	<span class="hl-keyword">return</span> <span class="hl-keyword">new</span> QueueChannel();
}

<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<em><span class="hl-annotation" style="color: gray">@BridgeFrom(value = "bridgeFromInput", poller = @Poller(fixedDelay = "1000"))</span></em>
<span class="hl-keyword">public</span> MessageChannel bridgeFromOutput() {
	<span class="hl-keyword">return</span> <span class="hl-keyword">new</span> DirectChannel();
}
<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> QueueChannel bridgeToOutput() {
	<span class="hl-keyword">return</span> <span class="hl-keyword">new</span> QueueChannel();
}

<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<em><span class="hl-annotation" style="color: gray">@BridgeTo("bridgeToOutput")</span></em>
<span class="hl-keyword">public</span> MessageChannel bridgeToInput() {
	<span class="hl-keyword">return</span> <span class="hl-keyword">new</span> DirectChannel();
}</pre>
<p>These annotations can be used as meta-annotations as well.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_advising_annotated_endpoints" href="#_advising_annotated_endpoints"></a>F.6.4&nbsp;Advising Annotated Endpoints</h3></div></div></div>

<p>See <a class="xref" href="#advising-with-annotations" title="8.9.7&nbsp;Advising Endpoints Using Annotations">Section&nbsp;8.9.7, &#8220;Advising Endpoints Using Annotations&#8221;</a>.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="message-mapping-rules" href="#message-mapping-rules"></a>F.7&nbsp;Message Mapping rules and conventions</h2></div></div></div>

<p>Spring Integration implements a flexible facility to map Messages to Methods and their arguments without providing extra configuration by relying on some default rules as well as defining certain conventions.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="sample-scenarios" href="#sample-scenarios"></a>F.7.1&nbsp;Simple Scenarios</h3></div></div></div>

<p><span class="emphasis"><em>Single un-annotated parameter (object or primitive) which is not a Map/Properties with non-void return type;</em></span></p>
<pre class="programlisting"><span class="hl-keyword">public</span> String foo(Object o);</pre>
<p>Details:</p>
<p>Input parameter is&nbsp;Message Payload.
If parameter type is not compatible with&nbsp;Message Payload&nbsp;an attempt will be made to convert it using Conversion Service provided by Spring 3.0.
The return value will be incorporated as a Payload of the returned Message</p>
<p><span class="emphasis"><em>Single un-annotated parameter&nbsp;(object or primitive)&nbsp;which is not a Map/Properties with Message return type;</em></span></p>
<pre class="programlisting"><span class="hl-keyword">public</span> Message&nbsp; foo(Object o);</pre>
<p>Details:</p>
<p>Input parameter is&nbsp;Message Payload.
If parameter type is not compatible with&nbsp;Message Payload&nbsp;an attempt will be made to convert it using Conversion Service provided by Spring 3.0.
The return value is a newly constructed Message that will be sent to the next destination.</p>
<p>_Single parameter which is a Message or its subclass with arbitrary object/primitive return type;  _</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">int</span> foo(Message&nbsp; msg);</pre>
<p>Details:</p>
<p>Input parameter is&nbsp;Message&nbsp;itself.&nbsp;The return value will become a payload of the Message that will be sent to the next destination.</p>
<p><span class="emphasis"><em>Single parameter which is a Message or its subclass with Message or its subclass as a return type;</em></span></p>
<pre class="programlisting"><span class="hl-keyword">public</span> Message foo(Message&nbsp;msg);</pre>
<p>Details:</p>
<p>Input parameter is&nbsp;Message&nbsp;itself.&nbsp;The return value is a newly constructed Message that will be sent to the next destination.</p>
<p><span class="emphasis"><em>Single parameter which is of type Map or Properties with Message as a return type;</em></span></p>
<pre class="programlisting"><span class="hl-keyword">public</span> Message foo(Map m);</pre>
<p>Details:</p>
<p>This one is a bit interesting.
Although at first it might seem like an easy mapping straight to Message Headers, the preference is always given to a Message Payload.
This means that if Message Payload is of type Map, this input argument will represent Message Payload.
However if Message Payload is not of type Map, then no conversion via Conversion Service will be attempted and the input argument will be mapped to Message Headers.</p>
<p><span class="emphasis"><em>Two parameters where one of them is arbitrary non-Map/Properties type object/primitive and another is Map/Properties type object (regardless of the return)</em></span></p>
<pre class="programlisting"><span class="hl-keyword">public</span> Message foo(Map h, &lt;T&gt; t);</pre>
<p>Details:</p>
<p>This combination contains two input parameters where one of them is of type Map.
Naturally the non-Map parameters (regardless of the order) will be mapped to a Message Payload and the Map/Properties (regardless of the order) will be mapped to &nbsp;Message Headers giving you a nice POJO way of interacting with Message structure.</p>
<p><span class="emphasis"><em>No parameters (regardless of the return)</em></span></p>
<pre class="programlisting"><span class="hl-keyword">public</span> String foo();</pre>
<p>Details:</p>
<p>This Message Handler method will be invoked based on the Message sent to the input channel this handler is hooked up to, however no Message data will be mapped, thus making Message act as event/trigger to invoke such handlerThe output will be mapped according to the rules above</p>
<p><span class="emphasis"><em>No parameters, void return</em></span></p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">void</span> foo();</pre>
<p>Details:</p>
<p>Same as above, but no output&nbsp;</p>
<p><span class="emphasis"><em>Annotation based mappings</em></span></p>
<p>Annotation based mapping is the safest and least ambiguous approach to map Messages to Methods.
There wil be many pointers to annotation based mapping throughout this manual, however here are couple of examples:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> String foo(<em><span class="hl-annotation" style="color: gray">@Payload</span></em> String s,&nbsp;<em><span class="hl-annotation" style="color: gray">@Header("foo")</span></em> String b)&nbsp;</pre>
<p>Very simple and explicit way of mapping Messages to method.
As you&#8217;ll see later on, without an annotation this signature would result in an ambiguous condition.
However by explicitly mapping the first argument to a Message Payload and the second argument to a value of the <span class="emphasis"><em>foo</em></span> Message Header, we have avoided any ambiguity.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> String foo(<em><span class="hl-annotation" style="color: gray">@Payload</span></em> String s, <em><span class="hl-annotation" style="color: gray">@RequestParam("foo")</span></em> String b)&nbsp;</pre>
<p>Looks almost identical to the previous example, however @RequestMapping or any other non-Spring Integration mapping annotation is irrelevant&nbsp;and therefore will be ignored leaving the second parameter unmapped.
Although the second parameter could easily be mapped to a Payload, there can only be one Payload.
Therefore this method mapping is ambiguous.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> String foo(String s, <em><span class="hl-annotation" style="color: gray">@Header("foo")</span></em> String b)&nbsp;</pre>
<p>The same as above.
The only difference is that the first argument will be mapped to the Message Payload implicitly.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> String foo(<em><span class="hl-annotation" style="color: gray">@Headers</span></em> Map m, <em><span class="hl-annotation" style="color: gray">@Header("foo")</span></em> Map f, <em><span class="hl-annotation" style="color: gray">@Header("bar")</span></em> String bar)</pre>
<p>Yet another signature that would definitely be treated as ambiguous without annotations because it has more than 2 arguments.
Furthermore, two of them are Maps.
However, with annotation-based mapping, the ambiguity is easily avoided.
In this example the first argument is mapped to all the Message Headers, while the second and third argument map to the values of Message Headers <span class="emphasis"><em>foo</em></span> and <span class="emphasis"><em>bar</em></span>.
The payload is not being mapped to any argument.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="complex-scenarios" href="#complex-scenarios"></a>F.7.2&nbsp;Complex Scenarios</h3></div></div></div>

<p><span class="emphasis"><em>Multiple parameters:</em></span></p>
<p>Multiple parameters could create a lot of ambiguity with regards to determining the appropriate mappings.
The general advice is to annotate your method parameters with @Payload and/or @Header/@Headers Below are some of the examples of ambiguous conditions which result in an Exception being raised.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> String foo(String s, <span class="hl-keyword">int</span> i)</pre>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
the two parameters are equal in weight, therefore there is no way to determine which one is a payload.
</li></ul></div>
<pre class="programlisting"><span class="hl-keyword">public</span> String foo(String s, Map m, String b)</pre>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
almost the same as above.
Although the Map could be easily mapped to Message Headers, there is no way to determine what to do with the two Strings.
</li></ul></div>
<pre class="programlisting"><span class="hl-keyword">public</span> String foo(Map m, Map f)</pre>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
although one might argue that one Map could be mapped to Message Payload and another one to Message Headers, it would be unreasonable to rely on the order (e.g., first is Payload, second Headers)
</li></ul></div>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>Basically any method signature with more than one method argument which is not (Map, &lt;T&gt;), and those parameters are not annotated, will result in an ambiguous condition thus triggering an Exception.</p>
</td></tr></table></div>
<p><span class="emphasis"><em>Multiple methods:</em></span></p>
<p>Message Handlers with multiple methods are mapped based on the same rules that are described above, however some scenarios might still look confusing.</p>
<p><span class="emphasis"><em>Multiple methods (same or different name) with legal (mappable) signatures:</em></span></p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> Foo {
  <span class="hl-keyword">public</span> String foo(String str, Map m);

  <span class="hl-keyword">public</span> String foo(Map m);
}</pre>
<p>As you can see, the Message could be mapped to either method.
The first method would be invoked where Message Payload could be mapped to <span class="emphasis"><em>str</em></span> &nbsp;and Message Headers could be mapped to <span class="emphasis"><em>m</em></span>.
The second method could easily also be a candidate where only Message Headers are mapped to <span class="emphasis"><em>m</em></span>.
To make meters worse both methods have the same name which at first might look very ambiguous considering the following configuration:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:service-activator&nbsp;input-channel="input"&nbsp;output-channel="output"&nbsp;method="foo"&gt;</span>
  <span class="hl-tag">&lt;bean&nbsp;class="org.bar.Foo"/&gt;</span>
<span class="hl-tag">&lt;/int:service-activator&gt;</span></pre>
<p>At this point it would be important to understand Spring Integration mapping Conventions where at the very core, mappings are based on Payload first and everything else next.
In other words the method whose argument could be mapped to a Payload will take precedence over all other methods.</p>
<p>On the other hand let&#8217;s look at slightly different example:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> Foo {
  <span class="hl-keyword">public</span> String foo(String str, Map m);

  <span class="hl-keyword">public</span> String foo(String str);
}</pre>
<p>If you look at it you can probably see a truly ambiguous condition.
In this example since both methods have signatures that could be mapped to a Message Payload.
They also have the same name.
Such handler methods will trigger an Exception.
However if the method names were different you could influence the mapping with a <span class="emphasis"><em>method</em></span> attribute (see below):</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> Foo {
  <span class="hl-keyword">public</span> String foo(String str, Map m);

  <span class="hl-keyword">public</span> String bar(String str);
}</pre>
<pre class="programlisting"><span class="hl-tag">&lt;int:service-activator&nbsp;input-channel="input"&nbsp;output-channel="output"&nbsp;method="bar"&gt;</span>
  <span class="hl-tag">&lt;bean&nbsp;class="org.bar.Foo"/&gt;</span>
<span class="hl-tag">&lt;/int:service-activator&gt;</span></pre>
<p>Now there is no ambiguity since the configuration explicitly maps to the <span class="emphasis"><em>bar</em></span> method which has no name conflicts.</p>
</div>
</div>
</div>
<div class="appendix"><div class="titlepage"><div><div><h2 class="title"><a name="resources" href="#resources"></a>Appendix&nbsp;G.&nbsp;Additional Resources</h2></div></div></div>

<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="resources-home" href="#resources-home"></a>G.1&nbsp;Spring Integration Home</h2></div></div></div>

<p>The definitive source of information about Spring Integration is the <a class="ulink" href="http://projects.spring.io/spring-integration/" target="_top">Spring Integration Home</a> at <a class="ulink" href="http://spring.io" target="_top">http://spring.io</a>.
That site serves as a hub of information and is the best place to find up-to-date announcements about the project as well as links to articles, blogs, and new sample applications.</p>
</div>
</div>
<div class="appendix"><div class="titlepage"><div><div><h2 class="title"><a name="history" href="#history"></a>Appendix&nbsp;H.&nbsp;Change History</h2></div></div></div>

<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="migration-4.1-4.2" href="#migration-4.1-4.2"></a>H.1&nbsp;Changes between 4.1 and 4.2</h2></div></div></div>

<p>Please be sure to also see the <a class="ulink" href="https://github.com/spring-projects/spring-integration/wiki/Spring-Integration-4.1-to-4.2-Migration-Guide" target="_top">Migration Guide</a>
for important changes that might affect your applications.
Migration guides for all versions back to <span class="emphasis"><em>2.1</em></span> can be found on the <a class="ulink" href="https://github.com/spring-projects/spring-integration/wiki" target="_top">Wiki</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="x4.2-new-components" href="#x4.2-new-components"></a>H.2&nbsp;New Components</h2></div></div></div>

<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="x4.2-JMX" href="#x4.2-JMX"></a>H.2.1&nbsp;Major Management/JMX Rework</h3></div></div></div>

<p>A new <code class="literal">MetricsFactory</code> strategy interface has been introduced.
This, together with other changes in the JMX and management infrastructure provides much more control over management
configuration and runtime performance.</p>
<p>However, this has some important implications for (some) user environments.</p>
<p>For complete details, see <a class="xref" href="#metrics-management" title="9.1&nbsp;Metrics and Management">Section&nbsp;9.1, &#8220;Metrics and Management&#8221;</a> and <a class="xref" href="#jmx-42-improvements" title="JMX Improvements">the section called &#8220;JMX Improvements&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="x4.2-mongodb-metadata-store" href="#x4.2-mongodb-metadata-store"></a>H.2.2&nbsp;MongoDB Metadata Store</h3></div></div></div>

<p>The <code class="literal">MongoDbMetadataStore</code> is now available. For more information, see <a class="xref" href="#mongodb-metadata-store" title="22.3.2&nbsp;MongoDB Metadata Store">Section&nbsp;22.3.2, &#8220;MongoDB Metadata Store&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="x4.2-secured-channel-annotation" href="#x4.2-secured-channel-annotation"></a>H.2.3&nbsp;SecuredChannel Annotation</h3></div></div></div>

<p>The <code class="literal">@SecuredChannel</code> annotation has been introduced, replacing the deprecated <code class="literal">ChannelSecurityInterceptorFactoryBean</code>.
For more information, see <a class="xref" href="#security" title="Appendix&nbsp;D.&nbsp;Security in Spring Integration">Appendix&nbsp;D, <i>Security in Spring Integration</i></a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="x4.2-security-context-propagation" href="#x4.2-security-context-propagation"></a>H.2.4&nbsp;SecurityContext Propagation</h3></div></div></div>

<p>The <code class="literal">SecurityContextPropagationChannelInterceptor</code> has been
introduced for the <code class="literal">SecurityContext</code> propagation from one message flow&#8217;s Thread to another.
For more information, see <a class="xref" href="#security" title="Appendix&nbsp;D.&nbsp;Security in Spring Integration">Appendix&nbsp;D, <i>Security in Spring Integration</i></a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="x4.2-file-splitter" href="#x4.2-file-splitter"></a>H.2.5&nbsp;FileSplitter</h3></div></div></div>

<p>The <code class="literal">FileSplitter</code>, which splits text files into lines, was added in 4.1.2.
It now has full support in the <code class="literal">int-file:</code> namespace; see <a class="xref" href="#file-splitter" title="14.5&nbsp;File Splitter">Section&nbsp;14.5, &#8220;File Splitter&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="x4.2-zk" href="#x4.2-zk"></a>H.2.6&nbsp;Zookeeper Support</h3></div></div></div>

<p>Zookeeper support has been added to the framework to assist when running on a clustered/multi-host environment.</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
ZookeeperMetadataStore
</li><li class="listitem">
ZookeeperLockRegistry
</li><li class="listitem">
Zookeeper Leadership
</li></ul></div>
<p>See <a class="xref" href="#zookeeper" title="37.&nbsp;Zookeeper Support">Chapter&nbsp;37, <i>Zookeeper Support</i></a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="x4.2-barrier" href="#x4.2-barrier"></a>H.2.7&nbsp;Thread Barrier</h3></div></div></div>

<p>A new thread <code class="literal">&lt;int:barrier/&gt;</code> component is available allowing a thread to be suspended until some asynchronous event
occurs.</p>
<p>See <a class="xref" href="#barrier" title="6.8&nbsp;Thread Barrier">Section&nbsp;6.8, &#8220;Thread Barrier&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="x4.2-stomp" href="#x4.2-stomp"></a>H.2.8&nbsp;STOMP Support</h3></div></div></div>

<p>STOMP support has been added to the framework as <span class="emphasis"><em>inbound</em></span> and <span class="emphasis"><em>outbound</em></span> channel adapters pair.
See <a class="xref" href="#stomp" title="28.&nbsp;STOMP Support">Chapter&nbsp;28, <i>STOMP Support</i></a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="x4.2-codec" href="#x4.2-codec"></a>H.2.9&nbsp;Codec</h3></div></div></div>

<p>A new <code class="literal">Codec</code> abstraction has been introduced, to encode/decode objects to/from <code class="literal">byte[]</code>.
An implementation that uses Kryo is provided.
Codec-based transformers and message converters are also provided.</p>
<p>See <a class="xref" href="#codec" title="7.4&nbsp;Codec">Section&nbsp;7.4, &#8220;Codec&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="x4.2-prepared-statement-setter" href="#x4.2-prepared-statement-setter"></a>H.2.10&nbsp;Message PreparedStatement Setter</h3></div></div></div>

<p>A new <code class="literal">MessagePreparedStatementSetter</code> functional interface callback is available for the <code class="literal">JdbcMessageHandler</code>
(<code class="literal">&lt;int-jdbc:outbound-gateway&gt;</code> and <code class="literal">&lt;int-jdbc:outbound-channel-adapter&gt;</code>) as an alternative to the
<code class="literal">SqlParameterSourceFactory</code> to populate parameters on the <code class="literal">PreparedStatement</code> with the <code class="literal">requestMessage</code> context.</p>
<p>See <a class="xref" href="#jdbc-outbound-channel-adapter" title="18.2&nbsp;Outbound Channel Adapter">Section&nbsp;18.2, &#8220;Outbound Channel Adapter&#8221;</a> for more information.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="x4.2-general" href="#x4.2-general"></a>H.3&nbsp;General Changes</h2></div></div></div>

<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="x4.2-wire-tap" href="#x4.2-wire-tap"></a>H.3.1&nbsp;Wire Tap</h3></div></div></div>

<p>As an alternative to the existing <code class="literal">selector</code> attribute, the <code class="literal">&lt;wire-tap/&gt;</code> now supports the <code class="literal">selector-expression</code> attribute.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="x4.2-file-changes" href="#x4.2-file-changes"></a>H.3.2&nbsp;File Changes</h3></div></div></div>

<p>See <a class="xref" href="#files" title="14.&nbsp;File Support">Chapter&nbsp;14, <i>File Support</i></a> for more information about these changes.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_appending_new_lines" href="#_appending_new_lines"></a>Appending New Lines</h4></div></div></div>

<p>The <code class="literal">&lt;int-file:outbound-channel-adapter&gt;</code> and <code class="literal">&lt;int-file:outbound-gateway&gt;</code> now support an <code class="literal">append-new-line</code> attribute.
If set to <code class="literal">true</code>, a new line is appended to the file after a message is written.
The default attribute value is <code class="literal">false</code>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_ignoring_hidden_files" href="#_ignoring_hidden_files"></a>Ignoring Hidden Files</h4></div></div></div>

<p>The <code class="literal">ignore-hidden</code> attribute has been introduced for the <code class="literal">&lt;int-file:inbound-channel-adapter&gt;</code> to pick up or not
the <span class="emphasis"><em>hidden</em></span> files from the source directory.
It is <code class="literal">true</code> by default.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_writing_inputstream_payloads" href="#_writing_inputstream_payloads"></a>Writing InputStream Payloads</h4></div></div></div>

<p>The <code class="literal">FileWritingMessageHandler</code> now also accepts <code class="literal">InputStream</code> as a valid message payload type.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_headdirectoryscanner" href="#_headdirectoryscanner"></a>HeadDirectoryScanner</h4></div></div></div>

<p>The <code class="literal">HeadDirectoryScanner</code> can now be used with other <code class="literal">FileListFilter</code> s.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_last_modified_filter" href="#_last_modified_filter"></a>Last Modified Filter</h4></div></div></div>

<p>The <code class="literal">LastModifiedFileListFilter</code> has been added.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_watchservice_directory_scanner" href="#_watchservice_directory_scanner"></a>WatchService Directory Scanner</h4></div></div></div>

<p>The <code class="literal">WatchServiceDirectoryScanner</code> is now available.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_persistent_file_list_filter_changes" href="#_persistent_file_list_filter_changes"></a>Persistent File List Filter Changes</h4></div></div></div>

<p>The <code class="literal">AbstractPersistentFileListFilter</code> has a new property <code class="literal">flushOnUpdate</code> which, when set to true, will <code class="literal">flush()</code> the
metadata store if it implements <code class="literal">Flushable</code> (e.g. the <code class="literal">PropertiesPersistingMetadataStore</code>).</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="x4.2-class-package-change" href="#x4.2-class-package-change"></a>H.3.3&nbsp;Class Package Change</h3></div></div></div>

<p>The <code class="literal">ScatterGatherHandler</code> class has been moved from the <code class="literal">org.springframework.integration.handler</code> to the <code class="literal">org.springframework.integration.scattergather</code>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_tcp_changes" href="#_tcp_changes"></a>H.3.4&nbsp;TCP Changes</h3></div></div></div>

<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.2-tcp-serializers" href="#x4.2-tcp-serializers"></a>TCP Serializers</h4></div></div></div>

<p>The TCP <code class="literal">Serializers</code> no longer <code class="literal">flush()</code> the <code class="literal">OutputStream</code>; this is now done by the <code class="literal">TcpNxxConnection</code> classes.
If you are using the serializers directly within user code, you may have to <code class="literal">flush()</code> the <code class="literal">OutputStream</code>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.2-tcp-server-exceptions" href="#x4.2-tcp-server-exceptions"></a>Server Socket Exceptions</h4></div></div></div>

<p><code class="literal">TcpConnectionServerExceptionEvent</code> s are now published whenever an unexpected exception occurs on a TCP server socket (also added to 4.1.3, 4.0.7).
See <a class="xref" href="#tcp-events" title="31.5&nbsp;TCP Connection Events">Section&nbsp;31.5, &#8220;TCP Connection Events&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.2-tcp-server-port" href="#x4.2-tcp-server-port"></a>TCP Server Port</h4></div></div></div>

<p>If a TCP server socket factory is configured to listen on a random port, the actual port chosen by the OS can now
be obtained using <code class="literal">getPort()</code>.
<code class="literal">getServerSocketAddress()</code> is also available.</p>
<p>See <a class="xref" href="#connection-factories" title="31.3&nbsp;TCP Connection Factories">Section&nbsp;31.3, &#8220;TCP Connection Factories&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.2-tcp-gw-rto" href="#x4.2-tcp-gw-rto"></a>TCP Gateway Remote Timeout</h4></div></div></div>

<p>The <code class="literal">TcpOutboundGateway</code> now supports <code class="literal">remote-timeout-expression</code> as an alternative to the existing <code class="literal">remote-timeout</code> attribute.
This allows setting the timeout based on each message.</p>
<p>Also, the <code class="literal">remote-timeout</code> no longer defaults to the same value as <code class="literal">reply-timeout</code> which has a completely different meaning.</p>
<p>See <a class="xref" href="#tcp-ob-gateway-attributes" title="Table&nbsp;31.7.&nbsp;TCP Outbound Gateway Attributes">Table&nbsp;31.7, &#8220;TCP Outbound Gateway Attributes&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.2-tcp-ssl" href="#x4.2-tcp-ssl"></a>TCP SSLSession Available for Header Mapping</h4></div></div></div>

<p><code class="literal">TcpConnection</code> s now support <code class="literal">getSslSession()</code> to enable users to extract information from the session to add to
message headers.</p>
<p>See <a class="xref" href="#ip-msg-headers" title="31.13&nbsp;IP Message Headers">Section&nbsp;31.13, &#8220;IP Message Headers&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.2-tcp-events" href="#x4.2-tcp-events"></a>TCP Events</h4></div></div></div>

<p>New events are now published whenever a correlation exception occurs - for example sending a message to a
non-existent socket.</p>
<p>The <code class="literal">TcpConnectionEventListeningMessageProducer</code> is deprecated; use the generic event adapter instead.</p>
<p>See <a class="xref" href="#tcp-events" title="31.5&nbsp;TCP Connection Events">Section&nbsp;31.5, &#8220;TCP Connection Events&#8221;</a> for more information.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="x4.2-inbound-channel-adapter-annotation" href="#x4.2-inbound-channel-adapter-annotation"></a>H.3.5&nbsp;@InboundChannelAdapter</h3></div></div></div>

<p>Previously, the <code class="literal">@Poller</code> on an inbound channel adapter defaulted the <code class="literal">maxMessagesPerPoll</code> attribute to <code class="literal">-1</code> (infinity).
This was inconsistent with the XML configuration of <code class="literal">&lt;inbound-channel-adapter/&gt;</code> s, which defaults to 1.
The annotation now defaults this attribute to 1.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="x4.2-api-changes" href="#x4.2-api-changes"></a>H.3.6&nbsp;API Changes</h3></div></div></div>

<p><code class="literal">o.s.integration.util.FunctionIterator</code> now requires a <code class="literal">o.s.integration.util.Function</code> instead of a
<code class="literal">reactor.function.Function</code>.
This was done to remove an unnecessary hard dependency on Reactor.
Any uses of this iterator will need to change the import.</p>
<p>Of course, Reactor is still supported for functionality such as the <code class="literal">Promise</code> gateway; the dependency was removed for those users who don&#8217;t need it.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="x4.2-jms-changes" href="#x4.2-jms-changes"></a>H.3.7&nbsp;JMS Changes</h3></div></div></div>

<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_reply_listener_lazy_initialization" href="#_reply_listener_lazy_initialization"></a>Reply Listener Lazy Initialization</h4></div></div></div>

<p>It is now possible to configure the reply listener in JMS outbound gateways to be initialized on-demand and stopped
after an idle period, instead of being controlled by the gateway&#8217;s lifecycle.</p>
<p>See <a class="xref" href="#jms-outbound-gateway" title="20.5&nbsp;Outbound Gateway">Section&nbsp;20.5, &#8220;Outbound Gateway&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_conversion_errors_in_message_driven_endpoints" href="#_conversion_errors_in_message_driven_endpoints"></a>Conversion Errors in Message-Driven Endpoints</h4></div></div></div>

<p>The <code class="literal">error-channel</code> now is used for the conversion errors, which have caused a transaction rollback and message redelivery previously.</p>
<p>See <a class="xref" href="#jms-message-driven-channel-adapter" title="20.2&nbsp;Message-Driven Channel Adapter">Section&nbsp;20.2, &#8220;Message-Driven Channel Adapter&#8221;</a> and <a class="xref" href="#jms-inbound-gateway" title="20.4&nbsp;Inbound Gateway">Section&nbsp;20.4, &#8220;Inbound Gateway&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_default_acknowledge_mode" href="#_default_acknowledge_mode"></a>Default Acknowledge Mode</h4></div></div></div>

<p>When using an implicitly defined <code class="literal">DefaultMessageListenerContainer</code>, the default <code class="literal">acknowledge</code> is now <code class="literal">transacted</code>.
<code class="literal">transacted</code> is recommended when using this container, to avoid message loss.
This default now applies to the message-driven inbound adapter and the inbound gateway, it was already the
default for jms-backed channels.</p>
<p>See <a class="xref" href="#jms-message-driven-channel-adapter" title="20.2&nbsp;Message-Driven Channel Adapter">Section&nbsp;20.2, &#8220;Message-Driven Channel Adapter&#8221;</a> and <a class="xref" href="#jms-inbound-gateway" title="20.4&nbsp;Inbound Gateway">Section&nbsp;20.4, &#8220;Inbound Gateway&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_shared_subscriptions" href="#_shared_subscriptions"></a>Shared Subscriptions</h4></div></div></div>

<p>Namespace support for shared subscriptions (JMS 2.0) has been added to message-driven endpoints and the
<code class="literal">&lt;int-jms:publish-subscribe-channel&gt;</code>.
Previously, you had to wire up listener containers as <code class="literal">&lt;bean/&gt;</code> s to use shared connections.</p>
<p>See <a class="xref" href="#jms" title="20.&nbsp;JMS Support">Chapter&nbsp;20, <i>JMS Support</i></a> for more information.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="x4.2-conditional-pollers" href="#x4.2-conditional-pollers"></a>H.3.8&nbsp;Conditional Pollers</h3></div></div></div>

<p>Much more flexibility is now provided for dynamic polling.</p>
<p>See <a class="xref" href="#conditional-pollers" title="4.2.3&nbsp;Conditional Pollers for Message Sources">Section&nbsp;4.2.3, &#8220;Conditional Pollers for Message Sources&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="x4.2-amqp-changes" href="#x4.2-amqp-changes"></a>H.3.9&nbsp;AMQP Changes</h3></div></div></div>

<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_publisher_confirms" href="#_publisher_confirms"></a>Publisher Confirms</h4></div></div></div>

<p>The <code class="literal">&lt;int-amqp:outbound-gateway&gt;</code> now supports <code class="literal">confirm-correlation-expression</code> and <code class="literal">confirm-(n)ack-channel</code>
attributes with similar purpose as for <code class="literal">&lt;int-amqp:outbound-channel-adapter&gt;</code>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_correlation_data" href="#_correlation_data"></a>Correlation Data</h4></div></div></div>

<p>For both the outbound channel adapter and gateway, if the correlation data is a <code class="literal">Message&lt;?&gt;</code>, it will be the basis
of the message on the ack/nack channel, with the additional header(s) added.
Previously, any correlation data (including <code class="literal">Message&lt;?&gt;</code>) was returned as the payload of the ack/nack message.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_the_inbound_gateway_properties" href="#_the_inbound_gateway_properties"></a>The Inbound Gateway properties</h4></div></div></div>

<p>The <code class="literal">&lt;int-amqp:inbound-gateway&gt;</code> now exposes the <code class="literal">amqp-template</code> attribute to allow more control over an external bean
for the reply <code class="literal">RabbitTemplate</code> or even provide your own <code class="literal">AmqpTemplate</code> implementation.
In addition the <code class="literal">default-reply-to</code> is exposed to be used if request message doesn&#8217;t have <code class="literal">replyTo</code> property.</p>
<p>See <a class="xref" href="#amqp" title="11.&nbsp;AMQP Support">Chapter&nbsp;11, <i>AMQP Support</i></a> for more information.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="x4.2-xpath-splitter" href="#x4.2-xpath-splitter"></a>H.3.10&nbsp;XPath Splitter Improvements</h3></div></div></div>

<p>The <code class="literal">XPathMessageSplitter</code> (<code class="literal">&lt;int-xml:xpath-splitter&gt;</code>) now allows the configuration of <code class="literal">output-properties</code>
for the internal <code class="literal">javax.xml.transform.Transformer</code> and supports an <code class="literal">Iterator</code> mode (defaults to <code class="literal">true</code>) for the xpath
evaluation <code class="literal">org.w3c.dom.NodeList</code> result.</p>
<p>See <a class="xref" href="#xml-xpath-splitting" title="35.5&nbsp;Splitting XML Messages">Section&nbsp;35.5, &#8220;Splitting XML Messages&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="x4.2-http-changes" href="#x4.2-http-changes"></a>H.3.11&nbsp;HTTP Changes</h3></div></div></div>

<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_cors" href="#_cors"></a>CORS</h4></div></div></div>

<p>The HTTP Inbound Endpoints (<code class="literal">&lt;int-http:inbound-channel-adapter&gt;</code> and <code class="literal">&lt;int-http:inbound-gateway&gt;</code>) now allow the
configuration of <span class="emphasis"><em>Cross-Origin Resource Sharing (CORS)</em></span>.</p>
<p>See <a class="xref" href="#http-cors" title="17.4.4&nbsp;Cross-Origin Resource Sharing (CORS) Support">Section&nbsp;17.4.4, &#8220;Cross-Origin Resource Sharing (CORS) Support&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_inbound_gateway_timeout" href="#_inbound_gateway_timeout"></a>Inbound Gateway Timeout</h4></div></div></div>

<p>The HTTP inbound gateway can be configured as to what status code to return when a request times out.
The default is now <code class="literal">500 Internal Server Error</code> instead of <code class="literal">200 OK</code>.</p>
<p>See <a class="xref" href="#http-response-statuscode" title="17.4.5&nbsp;Response StatusCode">Section&nbsp;17.4.5, &#8220;Response StatusCode&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_form_data" href="#_form_data"></a>Form Data</h4></div></div></div>

<p>Documentation is provided for when proxying <code class="literal">multipart/form-data</code> requests.
See <a class="xref" href="#http" title="17.&nbsp;HTTP Support">Chapter&nbsp;17, <i>HTTP Support</i></a> for more information.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="x4.2-gw" href="#x4.2-gw"></a>H.3.12&nbsp;Gateway Changes</h3></div></div></div>

<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_gateway_methods_can_return_completablefuture" href="#_gateway_methods_can_return_completablefuture"></a>Gateway Methods can Return CompletableFuture&lt;?&gt;</h4></div></div></div>

<p>When using Java 8, gateway methods can now return <code class="literal">CompletableFuture&lt;?&gt;</code>.
See <a class="xref" href="#gw-completable-future" title="CompletableFuture">the section called &#8220;CompletableFuture&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_messaginggateway_annotation" href="#_messaginggateway_annotation"></a>MessagingGateway Annotation</h4></div></div></div>

<p>The request and reply timeout properties are now <code class="literal">String</code> instead of <code class="literal">Long</code> to allow configuration with property
placeholders or SpEL. See <a class="xref" href="#messaging-gateway-annotation" title="8.4.6&nbsp;@MessagingGateway Annotation">Section&nbsp;8.4.6, &#8220;@MessagingGateway Annotation&#8221;</a>.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="x4.2-aggregator-changes" href="#x4.2-aggregator-changes"></a>H.3.13&nbsp;Aggregator Changes</h3></div></div></div>

<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_aggregator_performance" href="#_aggregator_performance"></a>Aggregator Performance</h4></div></div></div>

<p>This release includes some performance improvements for aggregating components (aggregator, resequencer, etc),
by more efficiently removing messages from groups when they are released.
New methods (<code class="literal">removeMessagesFromGroup</code>) have been added to the message store.
Set the <code class="literal">removeBatchSize</code> property (default <code class="literal">100</code>) to adjust the number of messages deleted in each operation.
Currently, JDBC, Redis and MongoDB message stores support this property.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_output_message_group_processor" href="#_output_message_group_processor"></a>Output Message Group Processor</h4></div></div></div>

<p>When using a <code class="literal">ref</code> or inner bean for the aggregator, it is now possible to bind a <code class="literal">MessageGroupProcessor</code> directly.
In addition, a <code class="literal">SimpleMessageGroupProcessor</code> is provided that simply returns the collection of messages in the group.
When an output processor produces a collection of <code class="literal">Message&lt;?&gt;</code>, the aggregator releases those messages individually.
Configuring the <code class="literal">SimpleMessageGroupProcessor</code> makes the aggregator a message barrier, were messages are held up
until they all arrive, and are then released individually. See <a class="xref" href="#aggregator" title="6.4&nbsp;Aggregator">Section&nbsp;6.4, &#8220;Aggregator&#8221;</a> for more information.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="__s_ftp_changes" href="#__s_ftp_changes"></a>H.3.14&nbsp;(S)FTP Changes</h3></div></div></div>

<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_inbound_channel_adapters" href="#_inbound_channel_adapters"></a>Inbound channel adapters</h4></div></div></div>

<p>You can now specify a <code class="literal">remote-directory-expression</code> on the inbound channel adapters, to determine the directory
at runtime.
See <a class="xref" href="#ftp" title="15.&nbsp;FTP/FTPS Adapters">Chapter&nbsp;15, <i>FTP/FTPS Adapters</i></a> and <a class="xref" href="#sftp" title="27.&nbsp;SFTP Adapters">Chapter&nbsp;27, <i>SFTP Adapters</i></a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_gateway_partial_results" href="#_gateway_partial_results"></a>Gateway Partial Results</h4></div></div></div>

<p>When use FTP/SFTP outbound gateways to operate on multiple files (<code class="literal">mget</code>, <code class="literal">mput</code>), it is possible for an exception to
occur after part of the request is completed.
If such a condition occurs, a <code class="literal">PartialSuccessException</code> is thrown containing the partial results.
See <a class="xref" href="#ftp-outbound-gateway" title="15.7&nbsp;FTP Outbound Gateway">Section&nbsp;15.7, &#8220;FTP Outbound Gateway&#8221;</a> and <a class="xref" href="#sftp-outbound-gateway" title="27.10&nbsp;SFTP Outbound Gateway">Section&nbsp;27.10, &#8220;SFTP Outbound Gateway&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_delegating_session_factory" href="#_delegating_session_factory"></a>Delegating Session Factory</h4></div></div></div>

<p>A delegating session factory is now available, enabling the selection of a particular session factory based on some
thread context value.</p>
<p>See <a class="xref" href="#ftp-dsf" title="15.3&nbsp;Delegating Session Factory">Section&nbsp;15.3, &#8220;Delegating Session Factory&#8221;</a> and <a class="xref" href="#sftp-dsf" title="27.4&nbsp;Delegating Session Factory">Section&nbsp;27.4, &#8220;Delegating Session Factory&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_default_sftp_session_factory" href="#_default_sftp_session_factory"></a>Default Sftp Session Factory</h4></div></div></div>

<p>Previously, the <code class="literal">DefaultSftpSessionFactory</code> unconditionally allowed connections to unknown hosts.
This is now configurable (default false).</p>
<p>The factory now requires a configured <code class="literal">knownHosts</code> file unless the <code class="literal">allowUnknownKeys</code> property is <code class="literal">true</code> (default
false).</p>
<p>See <a class="xref" href="#sftp-unk-hosts">Section&nbsp;27.2.1, &#8220;Configuration Properties&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_message_session_callback" href="#_message_session_callback"></a>Message Session Callback</h4></div></div></div>

<p>The <code class="literal">MessageSessionCallback&lt;F, T&gt;</code> has been introduced to perform any custom <code class="literal">Session</code> operation(s) with the
<code class="literal">requestMessage</code> context in the <code class="literal">&lt;int-(s)ftp:outbound-gateway/&gt;</code>.</p>
<p>See <a class="xref" href="#ftp-session-callback" title="15.10&nbsp;MessageSessionCallback">Section&nbsp;15.10, &#8220;MessageSessionCallback&#8221;</a> and <a class="xref" href="#sftp-session-callback" title="27.12&nbsp;MessageSessionCallback">Section&nbsp;27.12, &#8220;MessageSessionCallback&#8221;</a> for more information.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_websocket_changes_2" href="#_websocket_changes_2"></a>H.3.15&nbsp;Websocket Changes</h3></div></div></div>

<p><code class="literal">WebSocketHandlerDecoratorFactory</code> support has been added to the <code class="literal">ServerWebSocketContainer</code>
to allow chained customization for the internal <code class="literal">WebSocketHandler</code>.
See <a class="xref" href="#web-sockets-namespace" title="33.5&nbsp;WebSockets Namespace Support">Section&nbsp;33.5, &#8220;WebSockets Namespace Support&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_application_event_adapters_changes" href="#_application_event_adapters_changes"></a>H.3.16&nbsp;Application Event Adapters changes</h3></div></div></div>

<p>The <code class="literal">ApplicationEvent</code> adapters can now operate with <code class="literal">payload</code> as <code class="literal">event</code> directly allow omitting custom
<code class="literal">ApplicationEvent</code> extensions.
The <code class="literal">publish-payload</code> boolean attribute has been introduced on the <code class="literal">&lt;int-event:outbound-channel-adapter&gt;</code> for this
purpose.
See <a class="xref" href="#applicationevent" title="12.&nbsp;Spring ApplicationEvent Support">Chapter&nbsp;12, <i>Spring ApplicationEvent Support</i></a> for more information.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="migration-4.0-4.1" href="#migration-4.0-4.1"></a>H.4&nbsp;Changes between 4.0 and 4.1</h2></div></div></div>

<p>Please be sure to also see the <a class="ulink" href="https://github.com/spring-projects/spring-integration/wiki/Spring-Integration-4.0-to-4.1-Migration-Guide" target="_top">Migration Guide</a> for important changes that might affect your applications.
Migration guides for all versions back to <span class="emphasis"><em>2.1</em></span> can be found on the <a class="ulink" href="https://github.com/spring-projects/spring-integration/wiki" target="_top">Wiki</a>.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_new_components" href="#_new_components"></a>H.4.1&nbsp;New Components</h3></div></div></div>

<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.1-promise-gateway" href="#x4.1-promise-gateway"></a>Promise&lt;?&gt; Gateway</h4></div></div></div>

<p>A Reactor <code class="literal">Promise</code> return type is now supported for Messaging Gateway methods.
See <a class="xref" href="#async-gateway" title="8.4.9&nbsp;Asynchronous Gateway">Section&nbsp;8.4.9, &#8220;Asynchronous Gateway&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.1-web-socket-adapters" href="#x4.1-web-socket-adapters"></a>WebSocket support</h4></div></div></div>

<p>The <span class="emphasis"><em>WebSocket</em></span> module is now available.
It is fully based on the Spring WebSocket and Spring Messaging modules and provides an <code class="literal">&lt;inbound-channel-adapter&gt;</code> and an <code class="literal">&lt;outbound-channel-adapter&gt;</code>.
See <a class="xref" href="#web-sockets" title="33.&nbsp;WebSockets Support">Chapter&nbsp;33, <i>WebSockets Support</i></a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.1-scatter-gather" href="#x4.1-scatter-gather"></a>Scatter-Gather EIP pattern</h4></div></div></div>

<p>The <span class="emphasis"><em>Scatter-Gather</em></span> EIP pattern is now implemented.
See <a class="xref" href="#scatter-gather" title="6.7&nbsp;Scatter-Gather">Section&nbsp;6.7, &#8220;Scatter-Gather&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.1-Routing-Slip" href="#x4.1-Routing-Slip"></a>Routing Slip Pattern</h4></div></div></div>

<p>The <span class="emphasis"><em>Routing Slip</em></span> EIP pattern implementation is now provided.
See <a class="xref" href="#routing-slip" title="Routing Slip">the section called &#8220;Routing Slip&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.1-idempotent-receiver" href="#x4.1-idempotent-receiver"></a>Idempotent Receiver Pattern</h4></div></div></div>

<p>The <span class="emphasis"><em>Idempotent Receiver</em></span> EIP implementation is now provided via the <code class="literal">&lt;idempotent-receiver&gt;</code> component in XML, or the <code class="literal">IdempotentReceiverInterceptor</code> and <code class="literal">IdempotentReceiver</code> annotation when using Java Configuration.
See <a class="xref" href="#idempotent-receiver" title="8.9.10&nbsp;Idempotent Receiver Enterprise Integration Pattern">Section&nbsp;8.9.10, &#8220;Idempotent Receiver Enterprise Integration Pattern&#8221;</a> and their JavaDocs for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.1-BoonJsonObjectMapper" href="#x4.1-BoonJsonObjectMapper"></a>BoonJsonObjectMapper</h4></div></div></div>

<p>The <span class="emphasis"><em>Boon</em></span>`JsonObjectMapper` is now provided for the JSON transformers.
See <a class="xref" href="#transformer" title="7.1&nbsp;Transformer">Section&nbsp;7.1, &#8220;Transformer&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.1-redis-queue-gateways" href="#x4.1-redis-queue-gateways"></a>Redis Queue Gateways</h4></div></div></div>

<p>The <code class="literal">&lt;redis-queue-inbound-gateway&gt;</code> and <code class="literal">&lt;redis-queue-outbound-gateway&gt;</code> components are now provided.
See <a class="xref" href="#redis-queue-inbound-gateway" title="24.10&nbsp;Redis Queue Inbound Gateway">Section&nbsp;24.10, &#8220;Redis Queue Inbound Gateway&#8221;</a> and <a class="xref" href="#redis-queue-outbound-gateway" title="24.9&nbsp;Redis Queue Outbound Gateway">Section&nbsp;24.9, &#8220;Redis Queue Outbound Gateway&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.1-PollSkipAdvice" href="#x4.1-PollSkipAdvice"></a>PollSkipAdvice</h4></div></div></div>

<p>The <code class="literal">PollSkipAdvice</code> is now provided to be used within <code class="literal">&lt;advice-chain&gt;</code> of the <code class="literal">&lt;poller&gt;</code> to determine if the current <span class="emphasis"><em>poll</em></span> should be suppressed (skipped) by some condition implemented with <code class="literal">PollSkipStrategy</code>.
See <a class="xref" href="#polling-consumer" title="4.2&nbsp;Poller">Section&nbsp;4.2, &#8220;Poller&#8221;</a> for more information.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="x4.1-general" href="#x4.1-general"></a>H.4.2&nbsp;General Changes</h3></div></div></div>

<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.1-amqp-inbound-missing-queues" href="#x4.1-amqp-inbound-missing-queues"></a>AMQP Inbound Endpoints, Channel</h4></div></div></div>

<p>Elements that utilize a message listener container (inbound endpoints, channel) now support the <code class="literal">missing-queues-fatal</code> attribute.
See <a class="xref" href="#amqp" title="11.&nbsp;AMQP Support">Chapter&nbsp;11, <i>AMQP Support</i></a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.1-amqp-outbound-lazy-connect" href="#x4.1-amqp-outbound-lazy-connect"></a>AMQP Outbound Endpoints</h4></div></div></div>

<p>The AMQP outbound endpoints support a new property <code class="literal">lazy-connect</code> (default true).
When true, the connection to the broker is not established until the first message arrives (assuming there are no inbound endpoints, which always attempt to establish the connection during startup).
When set the <span class="emphasis"><em>false</em></span> an attempt to establish the connection is made during application startup.
See <a class="xref" href="#amqp" title="11.&nbsp;AMQP Support">Chapter&nbsp;11, <i>AMQP Support</i></a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.1-sms-copy-on-get" href="#x4.1-sms-copy-on-get"></a>SimpleMessageStore</h4></div></div></div>

<p>The <code class="literal">SimpleMessageStore</code> no longer makes a copy of the group when calling <code class="literal">getMessageGroup()</code>.
See <a class="xref" href="#sms-caution" title="Caution with SimpleMessageStore">Caution with SimpleMessageStore</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.1-ws-encode-uri" href="#x4.1-ws-encode-uri"></a>Web Service Outbound Gateway: encode-uri</h4></div></div></div>

<p>The <code class="literal">&lt;ws:outbound-gateway/&gt;</code> now provides an <code class="literal">encode-uri</code> attribute to allow disabling the encoding of the URI object before sending the request.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.1-http-status-code" href="#x4.1-http-status-code"></a>Http Inbound Channel Adapter and StatusCode</h4></div></div></div>

<p>The <code class="literal">&lt;http:inbound-channel-adapter&gt;</code> can now be configured with a <code class="literal">status-code-expression</code> to override the default <code class="literal">200 OK</code> status.
See <a class="xref" href="#http-namespace" title="17.4&nbsp;HTTP Namespace Support">Section&nbsp;17.4, &#8220;HTTP Namespace Support&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.1-mqtt" href="#x4.1-mqtt"></a>MQTT Adapter Changes</h4></div></div></div>

<p>The MQTT channel adapters can now be configured to connect to multiple servers, for example, to support High Availability (HA).
See <a class="xref" href="#mqtt" title="23.&nbsp;MQTT Support">Chapter&nbsp;23, <i>MQTT Support</i></a> for more information.</p>
<p>The MQTT message-driven channel adapter now supports specifying the QoS setting for each subscription.
See <a class="xref" href="#mqtt-inbound" title="23.2&nbsp;Inbound (message-driven) Channel Adapter">Section&nbsp;23.2, &#8220;Inbound (message-driven) Channel Adapter&#8221;</a> for more information.</p>
<p>The MQTT outbound channel adapter now supports asynchronous sends, avoiding blocking until delivery is confirmed.
See <a class="xref" href="#mqtt-outbound" title="23.3&nbsp;Outbound Channel Adapter">Section&nbsp;23.3, &#8220;Outbound Channel Adapter&#8221;</a> for more information.</p>
<p>It is now possible to programmatically subscribe to and unsubscribe from topics at runtime.
See <a class="xref" href="#mqtt-inbound" title="23.2&nbsp;Inbound (message-driven) Channel Adapter">Section&nbsp;23.2, &#8220;Inbound (message-driven) Channel Adapter&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.1-sftp" href="#x4.1-sftp"></a>FTP/SFTP Adapter Changes</h4></div></div></div>

<p>The FTP and SFTP outbound channel adapters now support appending to remote files, as well as taking specific actions when a remote file already exists.
The remote file templates now also support this as well as <code class="literal">rmdir()</code> and <code class="literal">exists()</code>.
In addition, the remote file templates provide access to the underlying client object enabling access to low-level APIs.</p>
<p>See <a class="xref" href="#ftp" title="15.&nbsp;FTP/FTPS Adapters">Chapter&nbsp;15, <i>FTP/FTPS Adapters</i></a> and <a class="xref" href="#sftp" title="27.&nbsp;SFTP Adapters">Chapter&nbsp;27, <i>SFTP Adapters</i></a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.1-splitter-iterator" href="#x4.1-splitter-iterator"></a>Splitter and Iterator</h4></div></div></div>

<p><code class="literal">Splitter</code> components now support an <code class="literal">Iterator</code> as the result object for producing output messages.
See <a class="xref" href="#splitter" title="6.3&nbsp;Splitter">Section&nbsp;6.3, &#8220;Splitter&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.1-aggregator" href="#x4.1-aggregator"></a>Aggregator</h4></div></div></div>

<p><code class="literal">Aggregator</code> s now support a new attribute <code class="literal">expire-groups-upon-timeout</code>.
See <a class="xref" href="#aggregator-config" title="6.4.4&nbsp;Configuring an Aggregator">Section&nbsp;6.4.4, &#8220;Configuring an Aggregator&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.1-content-enricher-improvement" href="#x4.1-content-enricher-improvement"></a>Content Enricher Improvements</h4></div></div></div>

<p>An <code class="literal">null-result-expression</code> attribute has been added, which is evaluated and returned if <code class="literal">&lt;enricher&gt;</code> returns <code class="literal">null</code>.
It can be added in <code class="literal">&lt;header&gt;</code> and <code class="literal">&lt;property&gt;</code>.
See <a class="xref" href="#content-enricher" title="7.2&nbsp;Content Enricher">Section&nbsp;7.2, &#8220;Content Enricher&#8221;</a> for more information.</p>
<p>An <code class="literal">error-channel</code> attribute has been added, which is used to handle an error flow if <code class="literal">Exception</code> occurs downstream of the <code class="literal">request-channel</code>.
This enable you to return an alternative object to use for enrichment.
See <a class="xref" href="#content-enricher" title="7.2&nbsp;Content Enricher">Section&nbsp;7.2, &#8220;Content Enricher&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.1-header-channel-registry" href="#x4.1-header-channel-registry"></a>Header Channel Registry</h4></div></div></div>

<p>The <code class="literal">&lt;header-enricher/&gt;</code>'s <code class="literal">&lt;header-channels-to-string/&gt;</code> element can now override the header channel registry&#8217;s default time for retaining channel mappings.
See <a class="xref" href="#header-channel-registry" title="Header Channel Registry">the section called &#8220;Header Channel Registry&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.1-orderly-shutdown" href="#x4.1-orderly-shutdown"></a>Orderly Shutdown</h4></div></div></div>

<p>Improvements have been made to the orderly shutdown algorithm.
See <a class="xref" href="#jmx-shutdown" title="9.7&nbsp;Orderly Shutdown">Section&nbsp;9.7, &#8220;Orderly Shutdown&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.1-recipientListRouter" href="#x4.1-recipientListRouter"></a>Management for RecipientListRouter</h4></div></div></div>

<p>The <code class="literal">RecipientListRouter</code> provides now several <span class="emphasis"><em>management</em></span> operations to configure <span class="emphasis"><em>recipients</em></span> at runtime.
With that the <code class="literal">&lt;recipient-list-router&gt;</code> can now be configured without any <code class="literal">&lt;recipient&gt;</code> from the start.
See <a class="xref" href="#recipient-list-router-management" title="RecipientListRouterManagement">the section called &#8220;RecipientListRouterManagement&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.1-AbstractHeaderMapper-changes" href="#x4.1-AbstractHeaderMapper-changes"></a>AbstractHeaderMapper: NON_STANDARD_HEADERS token</h4></div></div></div>

<p>The <code class="literal">AbstractHeaderMapper</code> implementations now provides the additional <code class="literal">NON_STANDARD_HEADERS</code> token to map any user-defined headers, which aren&#8217;t mapped by default.
See <a class="xref" href="#amqp-message-headers" title="11.12&nbsp;AMQP Message Headers">Section&nbsp;11.12, &#8220;AMQP Message Headers&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.1-amqp-channels" href="#x4.1-amqp-channels"></a>AMQP Channels: template-channel-transacted</h4></div></div></div>

<p>The new <code class="literal">template-channel-transacted</code> attribute has been introduced for AMQP <code class="literal">MessageChannel</code> s.
See <a class="xref" href="#amqp-channels" title="11.11&nbsp;AMQP Backed Message Channels">Section&nbsp;11.11, &#8220;AMQP Backed Message Channels&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.1-syslog" href="#x4.1-syslog"></a>Syslog Adapter</h4></div></div></div>

<p>The default syslog message converter now has an option to retain the original message in the payload, while still setting the headers.
See <a class="xref" href="#syslog-inbound-adapter" title="30.2&nbsp;Syslog <inbound-channel-adapter&gt;">Section&nbsp;30.2, &#8220;Syslog &lt;inbound-channel-adapter&gt;&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.1-async-gateway" href="#x4.1-async-gateway"></a>Async Gateway</h4></div></div></div>

<p>In addition to the <code class="literal">Promise</code> return type mentioned above, gateway methods may now return a <code class="literal">ListenableFuture</code>, introduced in Spring Framework 4.0.
You can also disable the async processing in the gateway, allowing a downstream flow to directly return a <code class="literal">Future</code>.
See <a class="xref" href="#async-gateway" title="8.4.9&nbsp;Asynchronous Gateway">Section&nbsp;8.4.9, &#8220;Asynchronous Gateway&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.1-aggregator-advice-chain" href="#x4.1-aggregator-advice-chain"></a>Aggregator Advice Chain</h4></div></div></div>

<p><code class="literal">Aggregator</code> s and <code class="literal">Resequencer</code> s now support an <code class="literal">&lt;expire-advice-chain/&gt;</code> and <code class="literal">&lt;expire-transactional/&gt;</code> sub-elements to <span class="emphasis"><em>advise</em></span> the <code class="literal">forceComplete</code> operation.
See <a class="xref" href="#aggregator-config" title="6.4.4&nbsp;Configuring an Aggregator">Section&nbsp;6.4.4, &#8220;Configuring an Aggregator&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.1-script-outbound-channel-adapter" href="#x4.1-script-outbound-channel-adapter"></a>Outbound Channel Adapter and Scripts</h4></div></div></div>

<p>The <code class="literal">&lt;int:outbound-channel-adapter/&gt;</code> now supports the <code class="literal">&lt;script/&gt;</code> sub-element.
The underlying script must have a <code class="literal">void</code> return type or return <code class="literal">null</code>.
See <a class="xref" href="#groovy" title="8.8&nbsp;Groovy support">Section&nbsp;8.8, &#8220;Groovy support&#8221;</a> and <a class="xref" href="#scripting" title="8.7&nbsp;Scripting support">Section&nbsp;8.7, &#8220;Scripting support&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.1-reseq" href="#x4.1-reseq"></a>Resequencer Changes</h4></div></div></div>

<p>When a message group in a resequencer is timed out (using <code class="literal">group-timeout</code> or a <code class="literal">MessageGroupStoreReaper</code>), late arriving messages will now be discarded immediately by default.
See <a class="xref" href="#resequencer" title="6.5&nbsp;Resequencer">Section&nbsp;6.5, &#8220;Resequencer&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.1-Optional-Parameter" href="#x4.1-Optional-Parameter"></a>Optional POJO method parameter</h4></div></div></div>

<p>Now Spring Integration consistently handles the Java 8&#8217;s <code class="literal">Optional</code> type.
See <a class="xref" href="#service-activator-namespace" title="8.5.2&nbsp;Configuring Service Activator">Section&nbsp;8.5.2, &#8220;Configuring Service Activator&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.1-queue-channel-queue.typ" href="#x4.1-queue-channel-queue.typ"></a>QueueChannel: backed Queue type</h4></div></div></div>

<p>The <code class="literal">QueueChannel</code> backed <code class="literal">Queue type</code> has been changed from <code class="literal">BlockingQueue</code> to the more generic <code class="literal">Queue</code>.
It allows the use of any external <code class="literal">Queue</code> implementation, for example Reactor&#8217;s <code class="literal">PersistentQueue</code>.
See <a class="xref" href="#channel-configuration-queuechannel" title="QueueChannel Configuration">the section called &#8220;QueueChannel Configuration&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.1-channel-interceptor" href="#x4.1-channel-interceptor"></a>ChannelInterceptor Changes</h4></div></div></div>

<p>The <code class="literal">ChannelInterceptor</code> now supports additional <code class="literal">afterSendCompletion()</code> and <code class="literal">afterReceiveCompletion()</code> methods.
See <a class="xref" href="#channel-interceptors" title="4.1.3&nbsp;Channel Interceptors">Section&nbsp;4.1.3, &#8220;Channel Interceptors&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.1-mail-peek" href="#x4.1-mail-peek"></a>IMAP PEEK</h4></div></div></div>

<p>Since <span class="emphasis"><em>version 4.1.1</em></span> there is a change of behavior if you explicitly set the javamail property <code class="literal">mail.[protocol].peek</code> to <code class="literal">false</code> (where <code class="literal">[protocol]</code> is <code class="literal">imap</code> or <code class="literal">imaps</code>).
See <a class="xref" href="#imap-peek" title="Important: IMAP PEEK">Important: IMAP PEEK</a>.</p>
</div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="migration-3.0-4.0" href="#migration-3.0-4.0"></a>H.5&nbsp;Changes between 3.0 and 4.0</h2></div></div></div>

<p>Please be sure to also see the <a class="ulink" href="https://github.com/spring-projects/spring-integration/wiki/Spring-Integration-3.0-to-4.0-Migration-Guide" target="_top">Migration Guide</a> for important changes that might affect your applications.
Migration guides for all versions back to <span class="emphasis"><em>2.1</em></span> can be found on the <a class="ulink" href="https://github.com/spring-projects/spring-integration/wiki" target="_top">Wiki</a>.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="x4.0-new-components" href="#x4.0-new-components"></a>H.5.1&nbsp;New Components</h3></div></div></div>

<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.0-mqtt" href="#x4.0-mqtt"></a>MQTT Channel Adapters</h4></div></div></div>

<p>The MQTT channel adapters (previously available in the Spring Integration Extensions repository) are now available as part of the normal Spring Integration distribution.
See <a class="xref" href="#mqtt" title="23.&nbsp;MQTT Support">Chapter&nbsp;23, <i>MQTT Support</i></a></p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.0-enable-configuration" href="#x4.0-enable-configuration"></a>@EnableIntegration</h4></div></div></div>

<p>The <code class="literal">@EnableIntegration</code> annotation has been added, to permit declaration of standard Spring Integration beans when using <code class="literal">@Configuration</code> classes.
See <a class="xref" href="#annotations" title="F.6&nbsp;Annotation Support">Section&nbsp;F.6, &#8220;Annotation Support&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.0-component-scan" href="#x4.0-component-scan"></a>@IntegrationComponentScan</h4></div></div></div>

<p>The <code class="literal">@IntegrationComponentScan</code> annotation has been added, to permit classpath scanning for Spring Integration specific components.
See <a class="xref" href="#annotations" title="F.6&nbsp;Annotation Support">Section&nbsp;F.6, &#8220;Annotation Support&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.0-message-history" href="#x4.0-message-history"></a>@EnableMessageHistory</h4></div></div></div>

<p>Message history can now be enabled with the <code class="literal">@EnableMessageHistory</code> annotation in a <code class="literal">@Configuration</code> class; in addition the message history settings can be modified by a JMX MBean.
In addition auto-created <code class="literal">MessageHandler</code> s for annotated endpoints (e.g.
<code class="literal">@ServiceActivator</code>, <code class="literal">@Splitter</code> etc.) now are also trackable by <code class="literal">MessageHistory</code>.
For more information, see <a class="xref" href="#message-history" title="9.3&nbsp;Message History">Section&nbsp;9.3, &#8220;Message History&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.0-messaging-gateway" href="#x4.0-messaging-gateway"></a>@MessagingGateway</h4></div></div></div>

<p>Messaging gateway interfaces can now be configured with the <code class="literal">@MessagingGateway</code> annotation.
It is an analogue of the <code class="literal">&lt;int:gateway/&gt;</code> xml element.
For more information, see <a class="xref" href="#messaging-gateway-annotation" title="8.4.6&nbsp;@MessagingGateway Annotation">Section&nbsp;8.4.6, &#8220;@MessagingGateway Annotation&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.0-boot" href="#x4.0-boot"></a>Spring Boot @EnableAutoConfiguration</h4></div></div></div>

<p>As well as the <code class="literal">@EnableIntegration</code> annotation mentioned above, a a hook has been introduced to allow the Spring Integration infrastructure beans to be configured using Spring Boot&#8217;s <code class="literal">@EnableAutoConfiguration</code>.
For more information seehttp://docs.spring.io/spring-boot/docs/current/reference/html/using-boot-auto-configuration.html[Spring Boot - AutoConfigure].</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.0-global-channel-interceptor" href="#x4.0-global-channel-interceptor"></a>@GlobalChannelInterceptor</h4></div></div></div>

<p>As well as the <code class="literal">@EnableIntegration</code> annotation mentioned above, the <code class="literal">@GlobalChannelInterceptor</code> annotation has bean introduced.
For more information, see <a class="xref" href="#annotations" title="F.6&nbsp;Annotation Support">Section&nbsp;F.6, &#8220;Annotation Support&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.0-integration-converter" href="#x4.0-integration-converter"></a>@IntegrationConverter</h4></div></div></div>

<p>The <code class="literal">@IntegrationConverter</code> annotation has bean introduced, as an analogue of <code class="literal">&lt;int:converter/&gt;</code> component.
For more information, see <a class="xref" href="#annotations" title="F.6&nbsp;Annotation Support">Section&nbsp;F.6, &#8220;Annotation Support&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.0-enable-publisher" href="#x4.0-enable-publisher"></a>@EnablePublisher</h4></div></div></div>

<p>The <code class="literal">@EnablePublisher</code> annotation has been added, to allow the specification of a <code class="literal">default-publisher-channel</code> for <code class="literal">@Publisher</code> annotations.
See <a class="xref" href="#annotations" title="F.6&nbsp;Annotation Support">Section&nbsp;F.6, &#8220;Annotation Support&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.0-redis-cms" href="#x4.0-redis-cms"></a>Redis Channel Message Stores</h4></div></div></div>

<p>A new Redis <code class="literal">MessageGroupStore</code>, that is optimized for use when backing a <code class="literal">QueueChannel</code> for persistence, is now provided.
For more information, see <a class="xref" href="#redis-cms" title="24.4.1&nbsp;Redis Channel Message Stores">Section&nbsp;24.4.1, &#8220;Redis Channel Message Stores&#8221;</a>.</p>
<p>A new Redis <code class="literal">ChannelPriorityMessageStore</code> is now provided.
This can be used to retrieve messages by priority.
For more information, see <a class="xref" href="#redis-cms" title="24.4.1&nbsp;Redis Channel Message Stores">Section&nbsp;24.4.1, &#8220;Redis Channel Message Stores&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.0-priority-channel-mondodb" href="#x4.0-priority-channel-mondodb"></a>MongodDB Channel Message Store</h4></div></div></div>

<p>MongoDB support now provides the <code class="literal">MongoDbChannelMessageStore</code> - a <span class="emphasis"><em>channel</em></span> specific <code class="literal">MessageStore</code> implementation.
With <code class="literal">priorityEnabled = true</code>, it can be used in <code class="literal">&lt;int:priority-queue&gt;</code> s to achieve <span class="emphasis"><em>priority</em></span> order polling of persisted messages.
For more information see <a class="xref" href="#mongodb-priority-channel-message-store" title="22.3.1&nbsp;MongoDB Channel Message Store">Section&nbsp;22.3.1, &#8220;MongoDB Channel Message Store&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.0-MBeanExport-annotation" href="#x4.0-MBeanExport-annotation"></a>@EnableIntegrationMBeanExport</h4></div></div></div>

<p>The <code class="literal">IntegrationMBeanExporter</code> can now be enabled with the <code class="literal">@EnableIntegrationMBeanExport</code> annotation in a <code class="literal">@Configuration</code> class.
For more information, see <a class="xref" href="#jmx-mbean-exporter" title="9.2.7&nbsp;MBean Exporter">Section&nbsp;9.2.7, &#8220;MBean Exporter&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.0-channel-security-interceptor" href="#x4.0-channel-security-interceptor"></a>ChannelSecurityInterceptorFactoryBean</h4></div></div></div>

<p>Configuration of Spring Security for message channels using <code class="literal">@Configuration</code> classes is now supported by using a <code class="literal">ChannelSecurityInterceptorFactoryBean</code>.
For more information, see <a class="xref" href="#security" title="Appendix&nbsp;D.&nbsp;Security in Spring Integration">Appendix&nbsp;D, <i>Security in Spring Integration</i></a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.0-redis-outbound-gateway" href="#x4.0-redis-outbound-gateway"></a>Redis Command Gateway</h4></div></div></div>

<p>The Redis support now provides the <code class="literal">&lt;outbound-gateway&gt;</code> component to perform generic Redis commands using the <code class="literal">RedisConnection#execute</code> method.
For more information, see <a class="xref" href="#redis-outbound-gateway" title="24.8&nbsp;Redis Outbound Command Gateway">Section&nbsp;24.8, &#8220;Redis Outbound Command Gateway&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.0-redis-gemfire-lock-registry" href="#x4.0-redis-gemfire-lock-registry"></a>RedisLockRegistry and GemfireLockRegistry</h4></div></div></div>

<p>The <code class="literal">RedisLockRegistry</code> and <code class="literal">GemfireLockRegistry</code> are now available supporting global locks visible to multiple application instances/servers.
These can be used with aggregating message handlers across multiple application instances such that group release will occur on only one instance.
For more information, see <a class="xref" href="#redis-lock-registry" title="24.11&nbsp;Redis Lock Registry">Section&nbsp;24.11, &#8220;Redis Lock Registry&#8221;</a>, <a class="xref" href="#gemfire-lock-registry" title="16.6&nbsp;Gemfire Lock Registry">Section&nbsp;16.6, &#8220;Gemfire Lock Registry&#8221;</a> and <a class="xref" href="#aggregator" title="6.4&nbsp;Aggregator">Section&nbsp;6.4, &#8220;Aggregator&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.0-poller-annotation" href="#x4.0-poller-annotation"></a>@Poller</h4></div></div></div>

<p>Annotation-based messaging configuration can now have a <code class="literal">poller</code> attribute.
This means that methods annotated with (<code class="literal">@ServiceActivator</code>, <code class="literal">@Aggregator</code> etc.) can now use an <code class="literal">inputChannel</code> that is a reference to a <code class="literal">PollableChannel</code>.
For more information, see <a class="xref" href="#annotations" title="F.6&nbsp;Annotation Support">Section&nbsp;F.6, &#8220;Annotation Support&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.0-inbound-channel-adapter-annotation" href="#x4.0-inbound-channel-adapter-annotation"></a>@InboundChannelAdapter and SmartLifecycle for Annotated Endpoints</h4></div></div></div>

<p>The <code class="literal">@InboundChannelAdapter</code> method annotation is now available.
It is an analogue of the <code class="literal">&lt;int:inbound-channel-adapter&gt;</code> XML component.
In addition, all Messaging Annotations now provide <code class="literal">SmartLifecycle</code> options.
For more information, see <a class="xref" href="#annotations" title="F.6&nbsp;Annotation Support">Section&nbsp;F.6, &#8220;Annotation Support&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.0-twitter-sog" href="#x4.0-twitter-sog"></a>Twitter Search Outbound Gateway</h4></div></div></div>

<p>A new twitter endpoint <code class="literal">&lt;int-twitter-search-outbound-gateway/&gt;</code> has been added.
Unlike the search inbound adapter which polls using the same search query each time, the outbound gateway allows on-demand customized queries.
For more information, see <a class="xref" href="#twitter-sog" title="32.6&nbsp;Twitter Search Outbound Gateway">Section&nbsp;32.6, &#8220;Twitter Search Outbound Gateway&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.0-gemfire-metadata" href="#x4.0-gemfire-metadata"></a>Gemfire Metadata Store</h4></div></div></div>

<p>The <code class="literal">GemfireMetadataStore</code> is provided, allowing it to be used, for example, in a <code class="literal">AbstractPersistentAcceptOnceFileListFilter</code> implementation in a multiple application instance/server environment.
For more information, see <a class="xref" href="#metadata-store" title="9.5&nbsp;Metadata Store">Section&nbsp;9.5, &#8220;Metadata Store&#8221;</a>, <a class="xref" href="#file-reading" title="14.2&nbsp;Reading Files">Section&nbsp;14.2, &#8220;Reading Files&#8221;</a>, <a class="xref" href="#ftp-inbound" title="15.4&nbsp;FTP Inbound Channel Adapter">Section&nbsp;15.4, &#8220;FTP Inbound Channel Adapter&#8221;</a> and <a class="xref" href="#sftp-inbound" title="27.7&nbsp;SFTP Inbound Channel Adapter">Section&nbsp;27.7, &#8220;SFTP Inbound Channel Adapter&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.0-bridge-annotations" href="#x4.0-bridge-annotations"></a>@BridgeFrom and @BridgeTo Annotations</h4></div></div></div>

<p>Annotation and Java configuration has introduced <code class="literal">@BridgeFrom</code> and <code class="literal">@BridgeTo</code> <code class="literal">@Bean</code> method annotations to mark <code class="literal">MessageChannel</code> beans in <code class="literal">@Configuration</code> classes.
For more information, see <a class="xref" href="#annotations" title="F.6&nbsp;Annotation Support">Section&nbsp;F.6, &#8220;Annotation Support&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.0-meta-messaging-annotations" href="#x4.0-meta-messaging-annotations"></a>Meta Messaging Annotations</h4></div></div></div>

<p>Messaging Annotations (<code class="literal">@ServiceActivator</code>, <code class="literal">@Router</code>, <code class="literal">@MessagingGateway</code> etc.) can now be configured as meta-annotations for user-defined Messaging Annotations.
In addition the user-defined annotations can have the same attributes (<code class="literal">inputChannel</code>, <code class="literal">@Poller</code>, <code class="literal">autoStartup</code> etc.).
For more information, see <a class="xref" href="#annotations" title="F.6&nbsp;Annotation Support">Section&nbsp;F.6, &#8220;Annotation Support&#8221;</a>.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="x4.0-general" href="#x4.0-general"></a>H.5.2&nbsp;General Changes</h3></div></div></div>

<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_requires_spring_framework_4_0" href="#_requires_spring_framework_4_0"></a>Requires Spring Framework 4.0</h4></div></div></div>

<p>Core messaging abstractions (<code class="literal">Message</code>, <code class="literal">MessageChannel</code> etc) have moved to the Spring Framework <code class="literal">spring-messaging</code> module.
Users who reference these classes directly in their code will need to make changes as described in the first section of the <a class="ulink" href="https://github.com/spring-projects/spring-integration/wiki/Spring-Integration-3.0-to-4.0-Migration-Guide" target="_top">Migration Guide</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.0-xpath-header-enricher-header-type" href="#x4.0-xpath-header-enricher-header-type"></a>Header Type for XPath Header Enricher</h4></div></div></div>

<p>The <code class="literal">header-type</code> attribute has been introduced for the <code class="literal">header</code> sub-element of the <code class="literal">&lt;int-xml:xpath-header-enricher&gt;</code>.
This attribute provides the target type for the header value to which the result of the XPath expression evaluation will be converted.
For more information see <a class="xref" href="#xml-xpath-header-enricher" title="35.7&nbsp;XPath Header Enricher">Section&nbsp;35.7, &#8220;XPath Header Enricher&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.0-object-to-json-transformer-result-type" href="#x4.0-object-to-json-transformer-result-type"></a>Object To Json Transformer: Node Result</h4></div></div></div>

<p>The <code class="literal">result-type</code> attribute has been introduced for the <code class="literal">&lt;int:object-to-json-transformer&gt;</code>.
This attribute provides the target type for the result of object mapping to JSON.
It supports <code class="literal">STRING</code> (default) and <code class="literal">NODE</code>.
For more information see <a class="xref" href="#transformer-xpath-spel-function">the section called &#8220;JSON Transformers&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.0-jms-header-mapping" href="#x4.0-jms-header-mapping"></a>JMS Header Mapping</h4></div></div></div>

<p>The <code class="literal">DefaultJmsHeaderMapper</code> now maps an incoming <code class="literal">JMSPriority</code> header to the Spring Integration <code class="literal">priority</code> header.
Previously <code class="literal">priority</code> was only considered for outbound messages.
For more information see <a class="xref" href="#jms-header-mapping" title="20.6&nbsp;Mapping Message Headers to/from JMS Message">Section&nbsp;20.6, &#8220;Mapping Message Headers to/from JMS Message&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.0-jms-ob" href="#x4.0-jms-ob"></a>JMS Outbound Channel Adapter</h4></div></div></div>

<p>The JMS outbound channel adapter now supports the <code class="literal">session-transacted</code> attribute (default false).
Previously, you had to inject a customized <code class="literal">JmsTemplate</code> to use transactions.
See <a class="xref" href="#jms-outbound-channel-adapter" title="20.3&nbsp;Outbound Channel Adapter">Section&nbsp;20.3, &#8220;Outbound Channel Adapter&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.0-jms-ib" href="#x4.0-jms-ib"></a>JMS Inbound Channel Adapter</h4></div></div></div>

<p>The JMS inbound channel adapter now supports the <code class="literal">session-transacted</code> attribute (default false).
Previously, you had to inject a customized <code class="literal">JmsTemplate</code> to use transactions (the adapter allowed <span class="emphasis"><em>transacted</em></span> in the acknowledgeMode which was incorrect, and didn&#8217;t work; this value is no longer allowed).
See<a class="xref" href="#jms-inbound-channel-adapter" title="20.1&nbsp;Inbound Channel Adapter">Section&nbsp;20.1, &#8220;Inbound Channel Adapter&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.0-datatype-channel" href="#x4.0-datatype-channel"></a>Datatype Channels</h4></div></div></div>

<p>You can now specify a <code class="literal">MessageConverter</code> to be used when converting (if necessary) payloads to one of the accepted <code class="literal">datatype</code> s in a Datatype channel.
For more information see <a class="xref" href="#channel-datatype-channel" title="Datatype Channel Configuration">the section called &#8220;Datatype Channel Configuration&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.0-retry-config" href="#x4.0-retry-config"></a>Simpler Retry Advice Configuration</h4></div></div></div>

<p>Simplified namespace support has been added to configure a <code class="literal">RequestHandlerRetryAdvice</code>.
For more information see <a class="xref" href="#retry-config" title="Configuring the Retry Advice">the section called &#8220;Configuring the Retry Advice&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.0-release-strategy-group-timeout" href="#x4.0-release-strategy-group-timeout"></a>Correlation Endpoint: Time-based Release Strategy</h4></div></div></div>

<p>The mutually exclusive <code class="literal">group-timeout</code> and <code class="literal">group-timeout-expression</code> attributes have been added to the <code class="literal">&lt;int:aggregator&gt;</code> and <code class="literal">&lt;int:resequencer&gt;</code>.
These attributes allow forced completion of a partial <code class="literal">MessageGroup</code>, if the <code class="literal">ReleaseStrategy</code> does not release a group and no further messages arrive within the time specified.
For more information see <a class="xref" href="#aggregator-config" title="6.4.4&nbsp;Configuring an Aggregator">Section&nbsp;6.4.4, &#8220;Configuring an Aggregator&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.0-redis-metadata" href="#x4.0-redis-metadata"></a>Redis Metadata Store</h4></div></div></div>

<p>The <code class="literal">RedisMetadataStore</code> now implements <code class="literal">ConcurrentMetadataStore</code>, allowing it to be used, for example, in a <code class="literal">AbstractPersistentAcceptOnceFileListFilter</code> implementation in a multiple application instance/server environment.
For more information, see <a class="xref" href="#redis-metadata-store" title="24.5&nbsp;Redis Metadata Store">Section&nbsp;24.5, &#8220;Redis Metadata Store&#8221;</a>, <a class="xref" href="#file-reading" title="14.2&nbsp;Reading Files">Section&nbsp;14.2, &#8220;Reading Files&#8221;</a>, <a class="xref" href="#ftp-inbound" title="15.4&nbsp;FTP Inbound Channel Adapter">Section&nbsp;15.4, &#8220;FTP Inbound Channel Adapter&#8221;</a> and <a class="xref" href="#sftp-inbound" title="27.7&nbsp;SFTP Inbound Channel Adapter">Section&nbsp;27.7, &#8220;SFTP Inbound Channel Adapter&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.0-jdbc-cs" href="#x4.0-jdbc-cs"></a>JdbcChannelMessageStore and PriorityChannel</h4></div></div></div>

<p>The <code class="literal">JdbcChannelMessageStore</code> now implements <code class="literal">PriorityCapableChannelMessageStore</code>, allowing it to be used as a <code class="literal">message-store</code> reference for <code class="literal">priority-queue</code> s.
For more information, see <a class="xref" href="#jdbc-message-store-channels" title="18.4.2&nbsp;Backing Message Channels">Section&nbsp;18.4.2, &#8220;Backing Message Channels&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.0-amqp" href="#x4.0-amqp"></a>AMQP Endpoints Delivery Mode</h4></div></div></div>

<p>Spring AMQP, by default, creates persistent messages on the broker.
This behavior can be overridden by setting the <code class="literal">amqp_deliveryMode</code> header and/or customizing the mappers.
A convenient <code class="literal">default-delivery-mode</code> attribute has now been added to the adapters to provide easier configuration of this important setting.
For more information, see <a class="xref" href="#amqp-outbound-channel-adapter" title="11.5&nbsp;Outbound Channel Adapter">Section&nbsp;11.5, &#8220;Outbound Channel Adapter&#8221;</a> and <a class="xref" href="#amqp-outbound-gateway" title="11.6&nbsp;Outbound Gateway">Section&nbsp;11.6, &#8220;Outbound Gateway&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.0-ftp" href="#x4.0-ftp"></a>FTP Timeouts</h4></div></div></div>

<p>The <code class="literal">DefaultFtpSessionFactory</code> now exposes the <code class="literal">connectTimeout</code>, <code class="literal">defaultTimeout</code> and <code class="literal">dataTimeout</code> properties, avoiding the need to subclass the factory just to set these common properties.
The <code class="literal">postProcess*</code> methods are still available for more advanced configuration.
See <a class="xref" href="#ftp-session-factory" title="15.2&nbsp;FTP Session Factory">Section&nbsp;15.2, &#8220;FTP Session Factory&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.0-twitter-status-updating" href="#x4.0-twitter-status-updating"></a>Twitter: StatusUpdatingMessageHandler</h4></div></div></div>

<p>The <code class="literal">StatusUpdatingMessageHandler</code> (<code class="literal">&lt;int-twitter:outbound-channel-adapter&gt;</code>) now supports the <code class="literal">tweet-data-expression</code> attribute to build a <code class="literal">org.springframework.social.twitter.api.TweetData</code> object for updating the timeline status allowing, for example, attaching an image.
See <a class="xref" href="#outbound-twitter-update" title="32.5.1&nbsp;Twitter Outbound Update Channel Adapter">Section&nbsp;32.5.1, &#8220;Twitter Outbound Update Channel Adapter&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.0-jpa-id-expression" href="#x4.0-jpa-id-expression"></a>JPA Retrieving Gateway: id-expression</h4></div></div></div>

<p>The <code class="literal">id-expression</code> attribute has been introduced for <code class="literal">&lt;int-jpa:retrieving-outbound-gateway&gt;</code> to perform <code class="literal">EntityManager.find(Class entityClass, Object primaryKey)</code>.
See <a class="xref" href="#jpa-retrieving-outbound-gateway" title="19.6.3&nbsp;Retrieving Outbound Gateway">Section&nbsp;19.6.3, &#8220;Retrieving Outbound Gateway&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.0-tcp-deserializer-events" href="#x4.0-tcp-deserializer-events"></a>TCP Deserialization Events</h4></div></div></div>

<p>When one of the standard deserializers encounters a problem decoding the input stream to a message, it will now emit a <code class="literal">TcpDeserializationExceptionEvent</code>, allowing applications to examine the data at the point the exception occurred.
See <a class="xref" href="#tcp-events" title="31.5&nbsp;TCP Connection Events">Section&nbsp;31.5, &#8220;TCP Connection Events&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.0-bean-messaging-annotations" href="#x4.0-bean-messaging-annotations"></a>Messaging Annotations on @Bean Definitions</h4></div></div></div>

<p>Messaging Annotations (<code class="literal">@ServiceActivator</code>, <code class="literal">@Router</code>, <code class="literal">@InboundChannelAdapter</code> etc.) can now be configured on <code class="literal">@Bean</code> definitions in <code class="literal">@Configuration</code> classes.
For more information, see <a class="xref" href="#annotations" title="F.6&nbsp;Annotation Support">Section&nbsp;F.6, &#8220;Annotation Support&#8221;</a>.</p>
</div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="migration-2.2-3.0" href="#migration-2.2-3.0"></a>H.6&nbsp;Changes Between 2.2 and 3.0</h2></div></div></div>

<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="x3.0-new-components" href="#x3.0-new-components"></a>H.6.1&nbsp;New Components</h3></div></div></div>

<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x3.0-request-mapping" href="#x3.0-request-mapping"></a>HTTP Request Mapping</h4></div></div></div>

<p>The HTTP module now provides powerful Request Mapping support for Inbound Endpoints.
Class <code class="literal">UriPathHandlerMapping</code> was replaced by <code class="literal">IntegrationRequestMappingHandlerMapping</code>, which is registered under the bean name <code class="literal">integrationRequestMappingHandlerMapping</code> in the application context.
Upon parsing of the HTTP Inbound Endpoint, a new <code class="literal">IntegrationRequestMappingHandlerMapping</code> bean is either registered or an existing bean is being reused.
To achieve flexible Request Mapping configuration, Spring Integration provides the <code class="literal">&lt;request-mapping/&gt;</code> sub-element for the <code class="literal">&lt;http:inbound-channel-adapter/&gt;</code> and the <code class="literal">&lt;http:inbound-gateway/&gt;</code>.
Both HTTP Inbound Endpoints are now fully based on the Request Mapping infrastructure that was introduced with Spring MVC 3.1.
For example, multiple paths are supported on a single inbound endpoint.
For more information see <a class="xref" href="#http-namespace" title="17.4&nbsp;HTTP Namespace Support">Section&nbsp;17.4, &#8220;HTTP Namespace Support&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x3.0-spel-customization" href="#x3.0-spel-customization"></a>Spring Expression Language (SpEL) Configuration</h4></div></div></div>

<p>A new <code class="literal">IntegrationEvaluationContextFactoryBean</code> is provided to allow configuration of custom <code class="literal">PropertyAccessor</code> s and functions for use in SpEL expressions throughout the framework.
For more information see <a class="xref" href="#spel" title="Appendix&nbsp;A.&nbsp;Spring Expression Language (SpEL)">Appendix&nbsp;A, <i>Spring Expression Language (SpEL)</i></a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x3.0-spel-functions" href="#x3.0-spel-functions"></a>SpEL Functions Support</h4></div></div></div>

<p>To customize the SpEL <code class="literal">EvaluationContext</code> with static <code class="literal">Method</code> functions, the new <code class="literal">&lt;spel-function/&gt;</code> component is introduced.
Two built-in functions are also provided (<code class="literal">#jsonPath</code> and <code class="literal">#xpath</code>).
For more information see <a class="xref" href="#spel-functions" title="A.3&nbsp;SpEL Functions">Section&nbsp;A.3, &#8220;SpEL Functions&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x3.0-spel-property-accessors" href="#x3.0-spel-property-accessors"></a>SpEL PropertyAccessors Support</h4></div></div></div>

<p>To customize the SpEL <code class="literal">EvaluationContext</code> with <code class="literal">PropertyAccessor</code> implementations the new <code class="literal">&lt;spel-property-accessors/&gt;</code> component is introduced.
For more information see <a class="xref" href="#spel-property-accessors" title="A.4&nbsp;PropertyAccessors">Section&nbsp;A.4, &#8220;PropertyAccessors&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x3.0-redis-new-components" href="#x3.0-redis-new-components"></a>Redis: New Components</h4></div></div></div>

<p>A new Redis-based <a class="ulink" href="http://docs.spring.io/spring-integration/docs/latest-ga/api/org/springframework/integration/store/MetadataStore.html" target="_top">MetadataStore</a> implementation has been added.
The <code class="literal">RedisMetadataStore</code> can be used to maintain state of a <code class="literal">MetadataStore</code> across application restarts.
This new <code class="literal">MetadataStore</code> implementation can be used with adapters such as:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Twitter Inbound Adapters
</li><li class="listitem">
Feed Inbound Channel Adapter
</li></ul></div>
<p>New queue-based components have been added.
The <code class="literal">&lt;int-redis:queue-inbound-channel-adapter/&gt;</code> and the <code class="literal">&lt;int-redis:queue-outbound-channel-adapter/&gt;</code> components are provided to perform <span class="emphasis"><em>right pop</em></span> and <span class="emphasis"><em>left push</em></span> operations on a Redis List, respectively.</p>
<p>For more information see <a class="xref" href="#redis" title="24.&nbsp;Redis Support">Chapter&nbsp;24, <i>Redis Support</i></a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x3.0-hcr" href="#x3.0-hcr"></a>Header Channel Registry</h4></div></div></div>

<p>It is now possible to instruct the framework to store reply and error channels in a registry for later resolution.
This is useful for cases where the <code class="literal">replyChannel</code> or <code class="literal">errorChannel</code> might be lost; for example when serializing a message.
See <a class="xref" href="#header-enricher" title="7.2.2&nbsp;Header Enricher">Section&nbsp;7.2.2, &#8220;Header Enricher&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x3.0-configurable-mongo-MS" href="#x3.0-configurable-mongo-MS"></a>MongoDB support: New ConfigurableMongoDbMessageStore</h4></div></div></div>

<p>In addition to the existing <code class="literal">eMongoDbMessageStore</code>, a new <code class="literal">ConfigurableMongoDbMessageStore</code> has been introduced.
This provides a more robust and flexible implementation of <code class="literal">MessageStore</code> for MongoDB.
It does not have backward compatibility, with the existing store, but it is recommended to use it for new applications.
Existing applications can use it, but messages in the old store will not be available.
See <a class="xref" href="#mongodb" title="22.&nbsp;MongoDb Support">Chapter&nbsp;22, <i>MongoDb Support</i></a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x3.0-syslog" href="#x3.0-syslog"></a>Syslog Support</h4></div></div></div>

<p>Building on the 2.2 <code class="literal">SyslogToMapTransformer</code> Spring Integration 3.0 now introduces <code class="literal">UDP</code> and <code class="literal">TCP</code> inbound channel adapters especially tailored for receiving SYSLOG messages.
For more information, see<a class="xref" href="#syslog" title="30.&nbsp;Syslog Support">Chapter&nbsp;30, <i>Syslog Support</i></a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x3.0-tail" href="#x3.0-tail"></a><span class="emphasis"><em>Tail</em></span> Support</h4></div></div></div>

<p>File 'tail&#8217;ing inbound channel adapters are now provided to generate messages when lines are added to the end of text files; see <a class="xref" href="#file-tailing" title="14.2.6&nbsp;'Tail&#8217;ing Files">Section&nbsp;14.2.6, &#8220;'Tail&#8217;ing Files&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x3.0-jmx" href="#x3.0-jmx"></a>JMX Support</h4></div></div></div>

<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
A new <code class="literal">&lt;int-jmx:tree-polling-channel-adapter/&gt;</code> is provided; this adapter queries the JMX MBean tree and sends a message with a payload that is the graph of objects that matches the query.
By default the MBeans are mapped to primitives and simple Objects like Map, List and arrays - permitting simple transformation, for example, to JSON.
</li><li class="listitem">
The <code class="literal">IntegrationMBeanExporter</code> now allows the configuration of a custom <code class="literal">ObjectNamingStrategy</code> using the <code class="literal">naming-strategy</code> attribute.
</li></ul></div>
<p>For more information, see <a class="xref" href="#jmx" title="9.2&nbsp;JMX Support">Section&nbsp;9.2, &#8220;JMX Support&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x3.0-tcp-events" href="#x3.0-tcp-events"></a>TCP/IP Connection Events and Connection Management</h4></div></div></div>

<p><code class="literal">TcpConnection</code> s now emit <code class="literal">ApplicationEvent</code> s (specifically <code class="literal">TcpConnectionEvent</code> s) when connections are opened, closed, or an exception occurs.
This allows applications to be informed of changes to TCP connections using the normal Spring <code class="literal">ApplicationListener</code> mechanism.</p>
<p><code class="literal">AbstractTcpConnection</code> has been renamed <code class="literal">TcpConnectionSupport</code>; custom connections that are subclasses of this class, can use its methods to publish events.
Similarly, <code class="literal">AbstractTcpConnectionInterceptor</code> has been renamed to <code class="literal">TcpConnectionInterceptorSupport</code>.</p>
<p>In addition, a new <code class="literal">&lt;int-ip:tcp-connection-event-inbound-channel-adapter/&gt;</code> is provided; by default, this adapter sends all <code class="literal">TcpConnectionEvent</code> s to a <code class="literal">Channel</code>.</p>
<p>Further, the TCP Connection Factories, now provide a new method <code class="literal">getOpenConnectionIds()</code>, which returns a list of identifiers for all open connections; this allows applications, for example, to broadcast to all open connections.</p>
<p>Finally, the connection factories also provide a new method <code class="literal">closeConnection(String connectionId)</code> which allows applications to explicitly close a connection using its ID.</p>
<p>For more information see <a class="xref" href="#tcp-events" title="31.5&nbsp;TCP Connection Events">Section&nbsp;31.5, &#8220;TCP Connection Events&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x3.0-inbound-script" href="#x3.0-inbound-script"></a>Inbound Channel Adapter Script Support</h4></div></div></div>

<p>The <code class="literal">&lt;int:inbound-channel-adapter/&gt;</code> now supports <code class="literal">&lt;expression/&gt;</code> and <code class="literal">&lt;script/&gt;</code> sub-elements to create a <code class="literal">MessageSource</code>; see <a class="xref" href="#channel-adapter-expressions-and-scripts" title="4.3.3&nbsp;Channel Adapter Expressions and Scripts">Section&nbsp;4.3.3, &#8220;Channel Adapter Expressions and Scripts&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x3.0-content-enricher-headers" href="#x3.0-content-enricher-headers"></a>Content Enricher: Headers Enrichment Support</h4></div></div></div>

<p>The Content Enricher now provides configuration for <code class="literal">&lt;header/&gt;</code> sub-elements, to enrich the outbound Message with headers based on the reply Message from the underlying message flow.
For more information see <a class="xref" href="#payload-enricher" title="7.2.3&nbsp;Payload Enricher">Section&nbsp;7.2.3, &#8220;Payload Enricher&#8221;</a>.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="x3.0-general" href="#x3.0-general"></a>H.6.2&nbsp;General Changes</h3></div></div></div>

<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x3.0-message-id" href="#x3.0-message-id"></a>Message ID Generation</h4></div></div></div>

<p>Previously, message ids were generated using the JDK <code class="literal">UUID.randomUUID()</code> method.
With this release, the default mechanism has been changed to use a more efficient algorithm which is significantly faster.
In addition, the ability to change the strategy used to generate message ids has been added.
For more information see <a class="xref" href="#message-id-generation" title="Message ID Generation">the section called &#8220;Message ID Generation&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x3.0-gateway" href="#x3.0-gateway"></a>&lt;gateway&gt; Changes</h4></div></div></div>

<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
It is now possible to set common headers across all gateway methods, and more options are provided for adding, to the message, information about which method was invoked.
</li><li class="listitem">
It is now possible to entirely customize the way that gateway method calls are mapped to messages.
</li><li class="listitem">
The <code class="literal">GatewayMethodMetadata</code> is now public class and it makes possible flexibly to configure the <code class="literal">GatewayProxyFactoryBean</code> programmatically from Java code.
</li></ul></div>
<p>For more information see <a class="xref" href="#gateway" title="8.4&nbsp;Messaging Gateways">Section&nbsp;8.4, &#8220;Messaging Gateways&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x3.0-http-endpointss" href="#x3.0-http-endpointss"></a>HTTP Endpoint Changes</h4></div></div></div>

<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>Outbound Endpoint <span class="emphasis"><em>encode-uri</em></span></strong></span> - <code class="literal">&lt;http:outbound-gateway/&gt;</code> and <code class="literal">&lt;http:outbound-channel-adapter/&gt;</code> now provide an <code class="literal">encode-uri</code> attribute to allow disabling the encoding of the URI object before sending the request.
</li><li class="listitem">
<span class="strong"><strong>Inbound Endpoint <span class="emphasis"><em>merge-with-default-converters</em></span></strong></span> - <code class="literal">&lt;http:inbound-gateway/&gt;</code> and <code class="literal">&lt;http:inbound-channel-adapter/&gt;</code> now have a <code class="literal">merge-with-default-converters</code> attribute to include the list of default <code class="literal">HttpMessageConverter</code> s after the custom message converters.
</li><li class="listitem">
<span class="strong"><strong><span class="emphasis"><em>If-(Un)Modified-Since</em></span> HTTP Headers</strong></span> - previously, <span class="emphasis"><em>If-Modified-Since</em></span> and <span class="emphasis"><em>If-Unmodified-Since</em></span> HTTP headers were incorrectly processed within from/to HTTP headers mapping in the <code class="literal">DefaultHttpHeaderMapper</code>.
Now, in addition correcting that issue, <code class="literal">DefaultHttpHeaderMapper</code> provides date parsing from formatted strings for any HTTP headers that accept date-time values.
</li><li class="listitem">
<span class="strong"><strong>Inbound Endpoint Expression Variables</strong></span> - In addition to the existing <span class="emphasis"><em>#requestParams</em></span> and <span class="emphasis"><em>#pathVariables</em></span>, the <code class="literal">&lt;http:inbound-gateway/&gt;</code> and <code class="literal">&lt;http:inbound-channel-adapter/&gt;</code> now support additional useful variables: <span class="emphasis"><em>#matrixVariables</em></span>, <span class="emphasis"><em>#requestAttributes</em></span>, <span class="emphasis"><em>#requestHeaders</em></span> and <span class="emphasis"><em>#cookies</em></span>.
These variables are available in both payload and header expressions.
</li><li class="listitem">
<span class="strong"><strong>Outbound Endpoint <span class="emphasis"><em>uri-variables-expression</em></span></strong></span> - HTTP Outbound Endpoints now support the <code class="literal">uri-variables-expression</code> attribute to specify an <code class="literal">Expression</code> to evaluate a <code class="literal">Map</code> for all URI variable placeholders within URL template.
This allows selection of a different map of expressions based on the outgoing message.
</li></ul></div>
<p>For more information see <a class="xref" href="#http" title="17.&nbsp;HTTP Support">Chapter&nbsp;17, <i>HTTP Support</i></a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x3.0-json-transformers" href="#x3.0-json-transformers"></a>Jackson Support (JSON)</h4></div></div></div>

<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
A new abstraction for JSON conversion has been introduced.
Implementations for Jackson 1.x and Jackson 2 are currently provided, with the version being determined by presence on the classpath.
Previously, only Jackson 1.x was supported.
</li><li class="listitem">
The <code class="literal">ObjectToJsonTransformer</code> and <code class="literal">JsonToObjectTransformer</code> now emit/consume headers containing type information.
</li></ul></div>
<p>For more information, see <span class="emphasis"><em>JSON Transformers</em></span> in <a class="xref" href="#transformer" title="7.1&nbsp;Transformer">Section&nbsp;7.1, &#8220;Transformer&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x3.0-id-for-chain-sub-components" href="#x3.0-id-for-chain-sub-components"></a>Chain Elements <span class="emphasis"><em>id</em></span> Attribute</h4></div></div></div>

<p>Previously, the <span class="emphasis"><em>id</em></span> attribute for elements within a <code class="literal">&lt;chain&gt;</code> was ignored and, in some cases, disallowed.
Now, the <span class="emphasis"><em>id</em></span> attribute is allowed for all elements within a <code class="literal">&lt;chain&gt;</code>.
The bean names of chain elements is a combination of the surrounding chain&#8217;s <span class="emphasis"><em>id</em></span> and the <span class="emphasis"><em>id</em></span> of the element itself.
For example: <span class="emphasis"><em>fooChain$child.fooTransformer.handler</em></span>.
For more information see <a class="xref" href="#chain" title="6.6&nbsp;Message Handler Chain">Section&nbsp;6.6, &#8220;Message Handler Chain&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x3.0-corr-endpoint-empty-groups" href="#x3.0-corr-endpoint-empty-groups"></a>Aggregator <span class="emphasis"><em>empty-group-min-timeout</em></span> property</h4></div></div></div>

<p>The <code class="literal">AbstractCorrelatingMessageHandler</code> provides a new property <code class="literal">empty-group-min-timeout</code> to allow empty group expiry to run on a longer schedule than expiring partial groups.
Empty groups will not be removed from the <code class="literal">MessageStore</code> until they have not been modified for at least this number of milliseconds.
For more information see <a class="xref" href="#aggregator-config" title="6.4.4&nbsp;Configuring an Aggregator">Section&nbsp;6.4.4, &#8220;Configuring an Aggregator&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x3.0-filelistfilter" href="#x3.0-filelistfilter"></a>Persistent File List Filters (file, (S)FTP)</h4></div></div></div>

<p>New <code class="literal">FileListFilter</code> s that use a persistent <code class="literal">MetadataStore</code> are now available.
These can be used to prevent duplicate files after a system restart.
See<a class="xref" href="#file-reading" title="14.2&nbsp;Reading Files">Section&nbsp;14.2, &#8220;Reading Files&#8221;</a>, <a class="xref" href="#ftp-inbound" title="15.4&nbsp;FTP Inbound Channel Adapter">Section&nbsp;15.4, &#8220;FTP Inbound Channel Adapter&#8221;</a>, and <a class="xref" href="#sftp-inbound" title="27.7&nbsp;SFTP Inbound Channel Adapter">Section&nbsp;27.7, &#8220;SFTP Inbound Channel Adapter&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x3.0-scripting-variables" href="#x3.0-scripting-variables"></a>Scripting Support: Variables Changes</h4></div></div></div>

<p>A new <code class="literal">variables</code> attribute has been introduced for scripting components.
In addition, variable bindings are now allowed for inline scripts.
See <a class="xref" href="#groovy" title="8.8&nbsp;Groovy support">Section&nbsp;8.8, &#8220;Groovy support&#8221;</a> and <a class="xref" href="#scripting" title="8.7&nbsp;Scripting support">Section&nbsp;8.7, &#8220;Scripting support&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x3.0-direct-channel-lb-ref" href="#x3.0-direct-channel-lb-ref"></a>Direct Channel Load Balancing configuration</h4></div></div></div>

<p>Previously, when configuring <code class="literal">LoadBalancingStrategy</code> on the channel&#8217;s <span class="emphasis"><em>dispatcher</em></span> sub-element, the only available option was to use a pre-defined enumeration of values which did not allow one to set a custom implementation of the <code class="literal">LoadBalancingStrategy</code>.
You can now use <code class="literal">load-balancer-ref</code> to provide a reference to a custom implementation of the <code class="literal">LoadBalancingStrategy</code>.
For more information see <a class="xref" href="#channel-implementations-directchannel" title="DirectChannel">the section called &#8220;DirectChannel&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x3.0-pub-sub" href="#x3.0-pub-sub"></a>PublishSubscribeChannel Behavior</h4></div></div></div>

<p>Previously, sending to a &lt;publish-subscribe-channel/&gt; that had no subscribers would return a <code class="literal">false</code> result.
If used in conjunction with a <code class="literal">MessagingTemplate</code>, this would result in an exception being thrown.
Now, the <code class="literal">PublishSubscribeChannel</code> has a property <code class="literal">minSubscribers</code> (default 0).
If the message is sent to at least the minimum number of subscribers, the send is deemed to be successful (even if zero).
If an application is expecting to get an exception under these conditions, set the minimum subscribers to at least 1.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x3.0--s-ftp-changes" href="#x3.0--s-ftp-changes"></a>FTP, SFTP and FTPS Changes</h4></div></div></div>

<p><span class="strong"><strong>The FTP, SFTP and FTPS endpoints no longer cache sessions by default</strong></span></p>
<p>The deprecated <code class="literal">cached-sessions</code> attribute has been removed from all endpoints.
Previously, the embedded caching mechanism controlled by this attribute&#8217;s value didn&#8217;t provide a way to limit the size of the cache, which could grow indefinitely.
The <code class="literal">CachingConnectionFactory</code> was introduced in release 2.1 and it became the preferred (and is now the only) way to cache sessions.</p>
<p>The <code class="literal">CachingConnectionFactory</code> now provides a new method <code class="literal">resetCache()</code>.
This immediately closes idle sessions and causes in-use sessions to be closed as and when they are returned to the cache.</p>
<p>The <code class="literal">DefaultSftpSessionFactory</code> (in conjunction with a <code class="literal">CachingSessionFactory</code>) now supports multiplexing channels over a single SSH connection (SFTP Only).</p>
<p><span class="strong"><strong>FTP, SFTP and FTPS Inbound Adapters</strong></span></p>
<p>Previously, there was no way to override the default filter used to process files retrieved from a remote server.
The <code class="literal">filter</code> attribute determines which files are retrieved but the <code class="literal">FileReadingMessageSource</code> uses an <code class="literal">AcceptOnceFileListFilter</code>.
This means that if a new copy of a file is retrieved, with the same name as a previously copied file, no message was sent from the adapter.</p>
<p>With this release, a new attribute <code class="literal">local-filter</code> allows you to override the default filter, for example with an <code class="literal">AcceptAllFileListFilter</code>, or some other custom filter.</p>
<p>For users that wish the behavior of the <code class="literal">AcceptOnceFileListFilter</code> to be maintained across JVM executions, a custom filter that retains state, perhaps on the file system, can now be configured.</p>
<p>Inbound Channel Adapters now support the <code class="literal">preserve-timestamp</code> attribute, which sets the local file modified timestamp to the timestamp from the server (default false).</p>
<p><span class="strong"><strong>FTP, SFTP and FTPS Gateways</strong></span></p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
The gateways now support the <span class="strong"><strong>mv</strong></span> command, enabling the renaming of remote files.
</li><li class="listitem">
The gateways now support recursive <span class="strong"><strong>ls</strong></span> and <span class="strong"><strong>mget</strong></span> commands, enabling the retrieval of a remote file tree.
</li><li class="listitem">
The gateways now support <span class="strong"><strong>put</strong></span> and <span class="strong"><strong>mput</strong></span> commands, enabling sending file(s) to the remote server.
</li><li class="listitem">
The <code class="literal">local-filename-generator-expression</code> attribute is now supported, enabling the naming of local files during retrieval.
By default, the same name as the remote file is used.
</li><li class="listitem">
The <code class="literal">local-directory-expression</code> attribute is now supported, enabling the naming of local directories during retrieval based on the remote directory.
</li></ul></div>
<p><span class="strong"><strong>Remote File Template</strong></span></p>
<p>A new higher-level abstraction (<code class="literal">RemoteFileTemplate</code>) is provided over the <code class="literal">Session</code> implementations used by the FTP and SFTP modules.
While it is used internally by endpoints, this abstraction can also be used programmatically and, like all Spring <code class="literal">*Template</code> implementations, reliably closes the underlying session while allowing low level access to the session when needed.</p>
<p>For more information, see <a class="xref" href="#ftp" title="15.&nbsp;FTP/FTPS Adapters">Chapter&nbsp;15, <i>FTP/FTPS Adapters</i></a> and <a class="xref" href="#sftp" title="27.&nbsp;SFTP Adapters">Chapter&nbsp;27, <i>SFTP Adapters</i></a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x3.0-outbound-gateway-requires-reply" href="#x3.0-outbound-gateway-requires-reply"></a><span class="emphasis"><em>requires-reply</em></span> Attribute for Outbound Gateways</h4></div></div></div>

<p>All Outbound Gateways (e.g.
<code class="literal">&lt;jdbc:outbound-gateway/&gt;</code> or <code class="literal">&lt;jms:outbound-gateway/&gt;</code>) are designed for <span class="emphasis"><em>request-reply</em></span> scenarios.
A response is expected from the external service and will be published to the <code class="literal">reply-channel</code>, or the <code class="literal">replyChannel</code> message header.
However, there are some cases where the external system might not always return a result, e.g.
a <code class="literal">&lt;jdbc:outbound-gateway/&gt;</code>, when a SELECT ends with an empty <code class="literal">ResultSet</code> or, say, a Web Service is One-Way.
An option is therefore needed to configure whether or not a <span class="emphasis"><em>reply</em></span> is required.
For this purpose, the <span class="emphasis"><em>requires-reply</em></span> attribute has been introduced for Outbound Gateway components.
In most cases, the default value for <span class="emphasis"><em>requires-reply</em></span> is <code class="literal">true</code> and, if there is not any result, a <code class="literal">ReplyRequiredException</code> will be thrown.
Changing the value to <code class="literal">false</code> means that, if an external service doesn&#8217;t return anything, the message-flow will end at that point, similar to an Outbound Channel Adapter.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The WebService outbound gateway has an additional attribute <code class="literal">ignore-empty-responses</code>; this is used to treat an empty String response as if no response was received.
It is true by default but can be set to false to allow the application to receive an empty String in the reply message payload.
When the attribute is true an empty string is treated as no response for the purposes of the <span class="emphasis"><em>requires-reply</em></span> attribute.
<span class="emphasis"><em>requires-reply</em></span> is false by default for the WebService outbound gateway.</p>
</td></tr></table></div>
<p>Note, the <code class="literal">requiresReply</code> property was previously present in the <code class="literal">AbstractReplyProducingMessageHandler</code> but set to <code class="literal">false</code>, and there wasn&#8217;t any way to configure it on Outbound Gateways using the XML namespace.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Previously, a gateway receiving no reply would silently end the flow (with a DEBUG log message); with this change an exception will now be thrown by default by most gateways.
To revert to the previous behavior, set <code class="literal">requires-reply</code> to false.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x3.0-amqp-mapping" href="#x3.0-amqp-mapping"></a>AMQP Outbound Gateway Header Mapping</h4></div></div></div>

<p>Previously, the &lt;int-amqp:outbound-gateway/&gt; mapped headers before invoking the message converter, and the converter could overwrite headers such as <code class="literal">content-type</code>.
The outbound adapter maps the headers after the conversion, which means headers like <code class="literal">content-type</code> from the outbound <code class="literal">Message</code> (if present) are used.</p>
<p>Starting with this release, the gateway now maps the headers after the message conversion, consistent with the adapter.
If your application relies on the previous behavior (where the converter&#8217;s headers overrode the mapped headers), you either need to filter those headers (before the message reaches the gateway) or set them appropriately.
The headers affected by the <code class="literal">SimpleMessageConverter</code> are <code class="literal">content-type</code> and <code class="literal">content-encoding</code>.
Custom message converters may set other headers.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x3.0-stored-proc-sql-return-type" href="#x3.0-stored-proc-sql-return-type"></a>Stored Procedure Components Improvements</h4></div></div></div>

<p>For more complex database-specific types, not supported by the standard <code class="literal">CallableStatement.getObject</code> method, 2 new additional attributes were introduced to the <code class="literal">&lt;sql-parameter-definition/&gt;</code> element with OUT-direction:</p>
<p><span class="emphasis"><em>type-name</em></span></p>
<p><span class="emphasis"><em>return-type</em></span></p>
<p>The <code class="literal">row-mapper</code> attribute of the Stored Procedure Inbound Channel Adapter <code class="literal">&lt;returning-resultset/&gt;</code> sub-element now supports a reference to a <code class="literal">RowMapper</code> bean definition.
Previously, it contained just a class name (which is still supported).</p>
<p>For more information see <a class="xref" href="#stored-procedures" title="18.5&nbsp;Stored Procedures">Section&nbsp;18.5, &#8220;Stored Procedures&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x3.0-ws-outbound-uri-substitution" href="#x3.0-ws-outbound-uri-substitution"></a>Web Service Outbound URI Configuration</h4></div></div></div>

<p>Web Service Outbound Gateway <span class="emphasis"><em>uri</em></span> attribute now supports <code class="literal">&lt;uri-variable/&gt;</code> substitution for all URI-schemes supported by Spring Web Services.
For more information see <a class="xref" href="#outbound-uri" title="34.4&nbsp;Outbound URI Configuration">Section&nbsp;34.4, &#8220;Outbound URI Configuration&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x3.0-redis" href="#x3.0-redis"></a>Redis Adapter Changes</h4></div></div></div>

<p>The Redis Inbound Channel Adapter can now use a <code class="literal">null</code> value for <code class="literal">serializer</code> property, with the raw data being the message payload.</p>
<p>The Redis Outbound Channel Adapter now has the <code class="literal">topic-expression</code> property to determine the Redis topic against the Message at runtime.</p>
<p>The Redis Inbound Channel Adapter, in addition to the existing <code class="literal">topics</code> attribute, now has the <code class="literal">topic-patterns</code> attribute.</p>
<p>For more information, see <a class="xref" href="#redis" title="24.&nbsp;Redis Support">Chapter&nbsp;24, <i>Redis Support</i></a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x3.0-advising-filters" href="#x3.0-advising-filters"></a>Advising Filters</h4></div></div></div>

<p>Previously, when a &lt;filter/&gt; had a &lt;request-handler-advice-chain/&gt;, the discard action was all performed within the scope of the advice chain (including any downstream flow on the <code class="literal">discard-channel</code>).
The filter element now has an attribute <code class="literal">discard-within-advice</code> (default <code class="literal">true</code>), to allow the discard action to be performed after the advice chain completes.
See <a class="xref" href="#advising-filters" title="8.9.6&nbsp;Advising Filters">Section&nbsp;8.9.6, &#8220;Advising Filters&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x3.0-annotation-advice" href="#x3.0-annotation-advice"></a>Advising Endpoints using Annotations</h4></div></div></div>

<p>Request Handler Advice Chains can now be configured using annotations.
See <a class="xref" href="#advising-with-annotations" title="8.9.7&nbsp;Advising Endpoints Using Annotations">Section&nbsp;8.9.7, &#8220;Advising Endpoints Using Annotations&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x3.0-o-t-s-t" href="#x3.0-o-t-s-t"></a>ObjectToStringTransformer Improvements</h4></div></div></div>

<p>This transformer now correctly transforms <code class="literal">byte[]</code> and <code class="literal">char[]</code> payloads to <code class="literal">String</code>.
For more information see <a class="xref" href="#transformer" title="7.1&nbsp;Transformer">Section&nbsp;7.1, &#8220;Transformer&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x3.0-jpa-changes" href="#x3.0-jpa-changes"></a>JPA Support Changes</h4></div></div></div>

<p>Payloads to <span class="emphasis"><em>persist</em></span> or <span class="emphasis"><em>merge</em></span> can now be of type <code class="literal">http://docs.oracle.com/javase/7/docs/api/java/lang/Iterable.html[java.lang.Iterable]</code>.</p>
<p>In that case, each object returned by the <code class="literal">Iterable</code> is treated as an entity and persisted or merged using the underlying <code class="literal">EntityManager</code>.
<span class="emphasis"><em>NULL</em></span> values returned by the iterator are ignored.</p>
<p>The JPA adapters now have additional attributes to optionally <span class="emphasis"><em>flush</em></span> and <span class="emphasis"><em>clear</em></span> entities from the associated persistence context after performing persistence operations.</p>
<p>Retrieving gateways had no mechanism to specify the first record to be retrieved which is a common use case.
The retrieving gateways now support specifying this parameter using a <code class="literal">first-result</code> and <code class="literal">first-result-expression</code> attributes to the gateway definition.
<a class="xref" href="#jpa-retrieving-outbound-gateway" title="19.6.3&nbsp;Retrieving Outbound Gateway">Section&nbsp;19.6.3, &#8220;Retrieving Outbound Gateway&#8221;</a>.</p>
<p>The JPA retrieving gateway and inbound adapter now have an attribute to specify the maximum number of results in a result set as an expression.
In addition, the <code class="literal">max-results</code> attribute has been introduced to replace <code class="literal">max-number-of-results</code>, which has been deprecated.
<code class="literal">max-results</code> and <code class="literal">max-results-expression</code> are used to provide the maximum number of results, or an expression to compute the maximum number of results, respectively, in the result set.</p>
<p>For more information see <a class="xref" href="#jpa" title="19.&nbsp;JPA Support">Chapter&nbsp;19, <i>JPA Support</i></a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x3.0-dalay-expression" href="#x3.0-dalay-expression"></a>Delayer: delay expression</h4></div></div></div>

<p>Previously, the <code class="literal">&lt;delayer&gt;</code> provided a <code class="literal">delay-header-name</code> attribute to determine the <span class="emphasis"><em>delay</em></span> value at runtime.
In complex cases it was necessary to precede the <code class="literal">&lt;delayer&gt;</code> with a <code class="literal">&lt;header-enricher&gt;</code>.
Spring Integration 3.0 introduced the <code class="literal">expression</code> attribute and <code class="literal">expression</code> sub-element for dynamic delay determination.
The <code class="literal">delay-header-name</code> attribute is now deprecated because the header evaluation can be specified in the <code class="literal">expression</code>.
In addition, the <code class="literal">ignore-expression-failures</code> was introduced to control the behavior when an expression evaluation fails.
For more information see <a class="xref" href="#delayer" title="8.6&nbsp;Delayer">Section&nbsp;8.6, &#8220;Delayer&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x3.0-jdbc-mysql-v5_6_4" href="#x3.0-jdbc-mysql-v5_6_4"></a>JDBC Message Store Improvements</h4></div></div></div>

<p><span class="emphasis"><em>Spring Integration 3.0</em></span> adds a new set of DDL scripts for <span class="emphasis"><em>MySQL</em></span> version 5.6.4 and higher.
Now <span class="emphasis"><em>MySQL</em></span> supports <span class="emphasis"><em>fractional
				seconds</em></span> and is thus improving the FIFO ordering when polling from a MySQL-based Message Store.
For more information, please see <a class="xref" href="#jdbc-message-store-generic" title="18.4.1&nbsp;The Generic JDBC Message Store">Section&nbsp;18.4.1, &#8220;The Generic JDBC Message Store&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x3.0-event-for-imap-idle" href="#x3.0-event-for-imap-idle"></a>IMAP Idle Connection Exceptions</h4></div></div></div>

<p>Previously, if an IMAP idle connection failed, it was logged but there was no mechanism to inform an application.
Such exceptions now generate <code class="literal">ApplicationEvent</code> s.
Applications can obtain these events using an <code class="literal">&lt;int-event:inbound-channel-adapter&gt;</code> or any <code class="literal">ApplicationListener</code> configured to receive an <code class="literal">ImapIdleExceptionEvent</code> or one of its super classes.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x3.0-tcp-headers" href="#x3.0-tcp-headers"></a>Message Headers and TCP</h4></div></div></div>

<p>The TCP connection factories now enable the configuration of a flexible mechanism to transfer selected headers (as well as the payload) over TCP.
A new <code class="literal">TcpMessageMapper</code> enables the selection of the headers, and an appropriate (de)serializer needs to be configured to write the resulting <code class="literal">Map</code> to the TCP stream.
A <code class="literal">MapJsonSerializer</code> is provided as a convenient mechanism to transfer headers and payload over TCP.
For more information see <a class="xref" href="#ip-headers" title="31.8.4&nbsp;Transferring Headers">Section&nbsp;31.8.4, &#8220;Transferring Headers&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x3.0-jms-mdca-te" href="#x3.0-jms-mdca-te"></a>JMS Message Driven Channel Adapter</h4></div></div></div>

<p>Previously, when configuring a <code class="literal">&lt;message-driven-channel-adapter/&gt;</code>, if you wished to use a specific <code class="literal">TaskExecutor</code>, it was necessary to declare a container bean and provide it to the adapter using the <code class="literal">container</code> attribute.
The <code class="literal">task-executor</code> is now provided, allowing it to be set directly on the adapter.
This is in addition to several other container attributes that were already available.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x3.0-rmi-ec" href="#x3.0-rmi-ec"></a>RMI Inbound Gateway</h4></div></div></div>

<p>The RMI Inbound Gateway now supports an <code class="literal">error-channel</code> attribute.
See <a class="xref" href="#rmi-inbound" title="26.3&nbsp;Inbound RMI">Section&nbsp;26.3, &#8220;Inbound RMI&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x3.0-xslt-transformer" href="#x3.0-xslt-transformer"></a>XsltPayloadTransformer</h4></div></div></div>

<p>You can now specify the transformer factory class name using the <code class="literal">transformer-factory-class</code> attribute.
See <a class="xref" href="#xml-xslt-payload-transformers" title="XsltPayloadTransformer">the section called &#8220;XsltPayloadTransformer&#8221;</a></p>
</div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="migration-2.1-2.2" href="#migration-2.1-2.2"></a>H.7&nbsp;Changes between 2.1 and 2.2</h2></div></div></div>

<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="x2.2-new-components" href="#x2.2-new-components"></a>H.7.1&nbsp;New Components</h3></div></div></div>

<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x2.2-redis-store-adapters" href="#x2.2-redis-store-adapters"></a>RedisStore Inbound and Outbound Channel Adapters</h4></div></div></div>

<p>Spring Integration now has RedisStore Inbound and Outbound Channel Adapters allowing you to write and read Message payloads to/from Redis collection(s).
For more information please see <a class="xref" href="#redis-store-outbound-channel-adapter" title="24.7&nbsp;RedisStore Outbound Channel Adapter">Section&nbsp;24.7, &#8220;RedisStore Outbound Channel Adapter&#8221;</a> and <a class="xref" href="#redis-store-inbound-channel-adapter" title="24.6&nbsp;RedisStore Inbound Channel Adapter">Section&nbsp;24.6, &#8220;RedisStore Inbound Channel Adapter&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x2.2-mongo-adapters" href="#x2.2-mongo-adapters"></a>MongoDB Inbound and Outbound Channel Adapters</h4></div></div></div>

<p>Spring Integration now has MongoDB Inbound and Outbound Channel Adapters allowing you to write and read Message payloads to/from a MongoDB document store.
For more information please see <a class="xref" href="#mongodb-outbound-channel-adapter" title="22.5&nbsp;MongoDB Outbound Channel Adapter">Section&nbsp;22.5, &#8220;MongoDB Outbound Channel Adapter&#8221;</a> and <a class="xref" href="#mongodb-inbound-channel-adapter" title="22.4&nbsp;MongoDB Inbound Channel Adapter">Section&nbsp;22.4, &#8220;MongoDB Inbound Channel Adapter&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x2.2-jpa" href="#x2.2-jpa"></a>JPA Endpoints</h4></div></div></div>

<p>Spring Integration now includes components for the Java Persistence API (JPA) for retrieving and persisting JPA entity objects.
The JPA Adapter includes the following components:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="emphasis"><em><a class="link" href="#jpa-inbound-channel-adapter" title="19.4&nbsp;Inbound Channel Adapter">Inbound Channel Adapter</a></em></span>
</li><li class="listitem">
<span class="emphasis"><em><a class="link" href="#jpa-outbound-channel-adapter" title="19.5&nbsp;Outbound Channel Adapter">Outbound Channel Adapter</a></em></span>
</li><li class="listitem">
<span class="emphasis"><em><a class="link" href="#jpa-updating-outbound-gateway" title="19.6.2&nbsp;Updating Outbound Gateway">Updating Outbound Gateway</a></em></span>
</li><li class="listitem">
<span class="emphasis"><em><a class="link" href="#jpa-retrieving-outbound-gateway" title="19.6.3&nbsp;Retrieving Outbound Gateway">Retrieving Outbound Gateway</a></em></span>
</li></ul></div>
<p>For more information please see <a class="xref" href="#jpa" title="19.&nbsp;JPA Support">Chapter&nbsp;19, <i>JPA Support</i></a></p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="x2.2-general" href="#x2.2-general"></a>H.7.2&nbsp;General Changes</h3></div></div></div>

<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x2.2-spring-31" href="#x2.2-spring-31"></a>Spring 3.1 Used by Default</h4></div></div></div>

<p>Spring Integration now uses Spring 3.1.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x2.2-handler-advice" href="#x2.2-handler-advice"></a>Adding Behavior to Endpoints</h4></div></div></div>

<p>The ability to add an &lt;advice-chain/&gt; to a poller has been available for some time.
However, the behavior added by this affects the entire integration flow.
It did not address the ability to add, say, retry, to an individual endpoint.
The 2.2.
release introduces the &lt;request-handler-advice-chain/&gt; to many endpoints.</p>
<p>In addition, 3 standard Advice classes have been provided for this purpose:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
MessageHandlerRetryAdvice
</li><li class="listitem">
MessageHandlerCircuitBreakerAdvice
</li><li class="listitem">
ExpressionEvaluatingMessageHandlerAdvice
</li></ul></div>
<p>For more information, see <a class="xref" href="#message-handler-advice-chain" title="8.9&nbsp;Adding Behavior to Endpoints">Section&nbsp;8.9, &#8220;Adding Behavior to Endpoints&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x2.2-transaction-sync" href="#x2.2-transaction-sync"></a>Transaction Synchronization and Pseudo Transactions</h4></div></div></div>

<p>Pollers can now participate in Spring&#8217;s <span class="emphasis"><em>Transaction Synchronization</em></span> feature.
This allows for synchronizing such operations as renaming files by an inbound channel adapter depending on whether the transaction commits, or rolls back.</p>
<p>In addition, these features can be enabled when there is not a <span class="emphasis"><em>real</em></span> transaction present, by means of a <code class="literal">PseudoTransactionManager</code>.</p>
<p>For more information see <a class="xref" href="#transaction-synchronization" title="C.3&nbsp;Transaction Synchronization">Section&nbsp;C.3, &#8220;Transaction Synchronization&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x2.2-file-adapter" href="#x2.2-file-adapter"></a>File Adapter - Improved File Overwrite/Append Handling</h4></div></div></div>

<p>When using the <span class="emphasis"><em>File Oubound Channel Adapter</em></span> or the <span class="emphasis"><em>File Outbound Gateway</em></span>, a new <span class="emphasis"><em>mode</em></span> property was added.
Prior to <span class="emphasis"><em>Spring Integration 2.2</em></span>, target files were replaced when they existed.
Now you can specify the following options:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
REPLACE (Default)
</li><li class="listitem">
APPEND
</li><li class="listitem">
FAIL
</li><li class="listitem">
IGNORE
</li></ul></div>
<p>For more information please see <a class="xref" href="#file-writing-destination-exists" title="14.3.3&nbsp;Dealing with Existing Destination Files">Section&nbsp;14.3.3, &#8220;Dealing with Existing Destination Files&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x2.2-outbound-gateways" href="#x2.2-outbound-gateways"></a>Reply-Timeout added to more Outbound Gateways</h4></div></div></div>

<p>The XML Namespace support adds the <span class="emphasis"><em>reply-timeout</em></span> attribute to the following <span class="emphasis"><em>Outbound Gateways</em></span>:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Amqp Outbound Gateway
</li><li class="listitem">
File Outbound Gateway
</li><li class="listitem">
Ftp Outbound Gateway
</li><li class="listitem">
Sftp Outbound Gateway
</li><li class="listitem">
Ws Outbound Gateway
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x2.2-amqp-11" href="#x2.2-amqp-11"></a>Spring-AMQP 1.1</h4></div></div></div>

<p>Spring Integration now uses Spring AMQP 1.1.
This enables several features to be used within a Spring Integration application, including&#8230;&#8203;</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
A fixed reply queue for the outbound gateway
</li><li class="listitem">
HA (mirrored) queues
</li><li class="listitem">
Publisher Confirms
</li><li class="listitem">
Returned Messages
</li><li class="listitem">
Support for Dead Letter Exchanges/Dead Letter Queues
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x2.2-jdbc-11" href="#x2.2-jdbc-11"></a>JDBC Support - Stored Procedures Components</h4></div></div></div>

<p><span class="emphasis"><em>SpEL Support</em></span></p>
<p>When using the Stored Procedure components of the Spring Integration JDBC Adapter, you can now provide Stored Procedure Names or Stored Function Names using Spring Expression Language (SpEL).</p>
<p>This allows you to specify the Stored Procedures to be invoked at runtime.
For example, you can provide Stored Procedure names that you would like to execute via Message Headers.
For more information please see <a class="xref" href="#stored-procedures" title="18.5&nbsp;Stored Procedures">Section&nbsp;18.5, &#8220;Stored Procedures&#8221;</a>.</p>
<p><span class="emphasis"><em>JMX Support</em></span></p>
<p>The Stored Procedure components now provide basic JMX support, exposing some of their properties as MBeans:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Stored Procedure Name
</li><li class="listitem">
Stored Procedure Name Expression
</li><li class="listitem">
JdbcCallOperations Cache Statistics
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x2.2-jdbc-gateway-update-optional" href="#x2.2-jdbc-gateway-update-optional"></a>JDBC Support - Outbound Gateway</h4></div></div></div>

<p>When using the JDBC Outbound Gateway, the update query is no longer mandatory.
You can now provide solely a select query using the request message as a source of parameters.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x2.2-jdbc-message-store-channels" href="#x2.2-jdbc-message-store-channels"></a>JDBC Support - Channel-specific Message Store Implementation</h4></div></div></div>

<p>A new <span class="emphasis"><em>Message Channel</em></span>-specific Message Store Implementation has been added, providing a more scalable solution using database-specific SQL queries.
For more information please see: <a class="xref" href="#jdbc-message-store-channels" title="18.4.2&nbsp;Backing Message Channels">Section&nbsp;18.4.2, &#8220;Backing Message Channels&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x2.2-shutdown" href="#x2.2-shutdown"></a>Orderly Shutdown</h4></div></div></div>

<p>A method <code class="literal">stopActiveComponents()</code> has been added to the IntegrationMBeanExporter.
This allows a Spring Integration application to be shut down in an orderly manner, disallowing new inbound messages to certain adapters and waiting for some time to allow in-flight messages to complete.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x2.2-jms-og" href="#x2.2-jms-og"></a>JMS Oubound Gateway Improvements</h4></div></div></div>

<p>The JMS Outbound Gateway can now be configured to use a`MessageListener` container to receive replies.
This can improve performance of the gateway.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x2.2-o-t-j-t" href="#x2.2-o-t-j-t"></a>object-to-json-transformer</h4></div></div></div>

<p>The <code class="literal">ObjectToJsonTransformer</code> now sets the <span class="emphasis"><em>content-type</em></span> header to <span class="emphasis"><em>application/json</em></span> by default.
For more information see <a class="xref" href="#transformer" title="7.1&nbsp;Transformer">Section&nbsp;7.1, &#8220;Transformer&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="httpChanges" href="#httpChanges"></a>HTTP Support</h4></div></div></div>

<p>Java serialization over HTTP is no longer enabled by default.
Previously, when setting a <code class="literal">expected-response-type</code> to a <code class="literal">Serializable</code> object, the <code class="literal">Accept</code> header was not properly set up.
The <code class="literal">SerializingHttpMessageConverter</code> has now been updated to set the Accept header to <code class="literal">application/x-java-serialized-object</code>.
However, because this could cause incompatibility with existing applications, it was decided to no longer automatically add this converter to the HTTP endpoints.</p>
<p>If you wish to use Java serialization, you will need to add the <code class="literal">SerializingHttpMessageConverter</code> to the appropriate endpoints, using the <code class="literal">message-converters</code> attribute, when using XML configuration, or using the <code class="literal">setMessageConverters()</code> method.</p>
<p>Alternatively, you may wish to consider using JSON instead which is enabled by simply having <code class="literal">Jackson</code> on the classpath.</p>
</div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="migration-2.0-2.1" href="#migration-2.0-2.1"></a>H.8&nbsp;Changes between 2.0 and 2.1</h2></div></div></div>

<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="x2.1-new-components" href="#x2.1-new-components"></a>H.8.1&nbsp;New Components</h3></div></div></div>

<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x2.1-new-scripting-support" href="#x2.1-new-scripting-support"></a>JSR-223 Scripting Support</h4></div></div></div>

<p>In Spring Integration 2.0, support for <a class="ulink" href="http://groovy.codehaus.org/" target="_top">Groovy</a> was added.
With Spring Integration 2.1 we expanded support for additional languages substantially by implementing support for <a class="ulink" href="http://www.jcp.org/en/jsr/detail?id=223" target="_top">JSR-223</a> (Scripting for the Java&#8482; Platform).
Now you have the ability to use any scripting language that supports JSR-223 including:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Javascript
</li><li class="listitem">
Ruby/JRuby
</li><li class="listitem">
Python/Jython
</li><li class="listitem">
Groovy
</li></ul></div>
<p>For further details please see <a class="xref" href="#scripting" title="8.7&nbsp;Scripting support">Section&nbsp;8.7, &#8220;Scripting support&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x2.1-new-gemfire-support" href="#x2.1-new-gemfire-support"></a>GemFire Support</h4></div></div></div>

<p>Spring Integration provides support for <a class="ulink" href="http://www.vmware.com/products/application-platform/vfabric-gemfire/overview.html" target="_top">GemFire</a> by providing inbound adapters for entry and continuous query events, an outbound adapter to write entries to the cache, and <a class="ulink" href="http://static.springsource.org/spring-integration/api/org/springframework/integration/store/MessageStore.html" target="_top"><code class="literal">MessageStore</code></a> and <a class="ulink" href="http://static.springsource.org/spring-integration/api/org/springframework/integration/store/MessageGroupStore.html" target="_top"><code class="literal">MessageGroupStore</code></a> implementations.
Spring integration leverages the <a class="ulink" href="http://www.springsource.org/spring-gemfire" target="_top"><span class="emphasis"><em>Spring Gemfire</em></span></a> project, providing a thin wrapper over its components.</p>
<p>For further details please see <a class="xref" href="#gemfire" title="16.&nbsp;GemFire Support">Chapter&nbsp;16, <i>GemFire Support</i></a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x2.1-new-amqp-support" href="#x2.1-new-amqp-support"></a>AMQP Support</h4></div></div></div>

<p>Spring Integration 2.1 adds several Channel Adapters for receiving and sending messages using thehttp://www.amqp.org/[<span class="emphasis"><em>Advanced Message Queuing Protocol</em></span>] (AMQP).
Furthermore, Spring Integration also provides a point-to-point Message Channel, as well as a publish/subscribe Message Channel that are backed by AMQP Exchanges and Queues.</p>
<p>For further details please see <a class="xref" href="#amqp" title="11.&nbsp;AMQP Support">Chapter&nbsp;11, <i>AMQP Support</i></a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x2.1-new-mongodb-support" href="#x2.1-new-mongodb-support"></a>MongoDB Support</h4></div></div></div>

<p>As of version 2.1 Spring Integration provides support for <a class="ulink" href="http://www.mongodb.org/" target="_top">MongoDB</a> by providing a MongoDB-based MessageStore.</p>
<p>For further details please see <a class="xref" href="#mongodb" title="22.&nbsp;MongoDb Support">Chapter&nbsp;22, <i>MongoDb Support</i></a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x2.1-new-redis-support" href="#x2.1-new-redis-support"></a>Redis Support</h4></div></div></div>

<p>As of version 2.1 Spring Integration supports <a class="ulink" href="http://redis.io/" target="_top">Redis</a>, an advanced key-value store, by providing a Redis-based MessageStore as well as Publish-Subscribe Messaging adapters.</p>
<p>For further details please see <a class="xref" href="#redis" title="24.&nbsp;Redis Support">Chapter&nbsp;24, <i>Redis Support</i></a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x2.1-new-resource-support" href="#x2.1-new-resource-support"></a>Support for Spring&#8217;s Resource abstraction</h4></div></div></div>

<p>As of version 2.1, we&#8217;ve introduced a new <span class="emphasis"><em>Resource Inbound Channel Adapter</em></span> that builds upon Spring&#8217;s Resource abstraction to support greater flexibility across a variety of actual types of underlying resources, such as a file, a URL, or a class path resource.
Therefore, it&#8217;s similar to but more generic than the <span class="emphasis"><em>File Inbound Channel Adapter</em></span>.</p>
<p>For further details please see <a class="xref" href="#resource-inbound-channel-adapter" title="25.2&nbsp;Resource Inbound Channel Adapter">Section&nbsp;25.2, &#8220;Resource Inbound Channel Adapter&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x2.1-new-stored-proc-support" href="#x2.1-new-stored-proc-support"></a>Stored Procedure Components</h4></div></div></div>

<p>With Spring Integration 2.1, the <code class="literal">JDBC</code> Module also provides Stored Procedure support by adding several new components, including inbound/outbound channel adapters and an Outbound Gateway.
The Stored Procedure support leverages Spring&#8217;shttp://static.springsource.org/spring/docs/3.0.x/javadoc-api/org/springframework/jdbc/core/simple/SimpleJdbcCall.html[<code class="literal">SimpleJdbcCall</code>] class and consequently supports stored procedures for:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Apache Derby
</li><li class="listitem">
DB2
</li><li class="listitem">
MySQL
</li><li class="listitem">
Microsoft SQL Server
</li><li class="listitem">
Oracle
</li><li class="listitem">
PostgreSQL
</li><li class="listitem">
Sybase
</li></ul></div>
<p>The Stored Procedure components also support Sql Functions for the following databases:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
MySQL
</li><li class="listitem">
Microsoft SQL Server
</li><li class="listitem">
Oracle
</li><li class="listitem">
PostgreSQL
</li></ul></div>
<p>For further details please see <a class="xref" href="#stored-procedures" title="18.5&nbsp;Stored Procedures">Section&nbsp;18.5, &#8220;Stored Procedures&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x2.1-new-xpath-filter-support" href="#x2.1-new-xpath-filter-support"></a>XPath and XML Validating Filter</h4></div></div></div>

<p>Spring Integration 2.1 provides a new XPath-based Message Filter, that is part of the <code class="literal">XML</code> module.
The XPath Filter allows you to filter messages using provided XPath Expressions.
Furthermore, documentation was added for the XML Validating Filter.</p>
<p>For more details please see <a class="xref" href="#xml-xpath-filter" title="35.8&nbsp;Using the XPath Filter">Section&nbsp;35.8, &#8220;Using the XPath Filter&#8221;</a> and <a class="xref" href="#xml-validating-filter" title="35.10&nbsp;XML Validating Filter">Section&nbsp;35.10, &#8220;XML Validating Filter&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x2.1-new-payload-enricher-support" href="#x2.1-new-payload-enricher-support"></a>Payload Enricher</h4></div></div></div>

<p>Since Spring Integration 2.1, the Payload Enricher is provided.
A Payload Enricher defines an endpoint that typically passes ahttp://static.springsource.org/spring-integration/api/org/springframework/integration/Message.html[<code class="literal">Message</code>] to the exposed request channel and then expects a reply message.
The reply message then becomes the root object for evaluation of expressions to enrich the target payload.</p>
<p>For further details please see <a class="xref" href="#payload-enricher" title="7.2.3&nbsp;Payload Enricher">Section&nbsp;7.2.3, &#8220;Payload Enricher&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x2.1-new-ftp-outbound-gateway" href="#x2.1-new-ftp-outbound-gateway"></a>FTP and SFTP Outbound Gateways</h4></div></div></div>

<p>Spring Integration 2.1 provides two new Outbound Gateways in order to interact with remote File Transfer Protocol (FTP) or Secure File Transfer Protocol (SFT) servers.
These two gateways allow you to directly execute a limited set of remote commands.</p>
<p>For instance, you can use these Outbound Gateways to list, retrieve and delete remote files and have the Spring Integration message flow continue with the remote server&#8217;s response.</p>
<p>For further details please see <a class="xref" href="#ftp-outbound-gateway" title="15.7&nbsp;FTP Outbound Gateway">Section&nbsp;15.7, &#8220;FTP Outbound Gateway&#8221;</a> and <a class="xref" href="#sftp-outbound-gateway" title="27.10&nbsp;SFTP Outbound Gateway">Section&nbsp;27.10, &#8220;SFTP Outbound Gateway&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x2.1-new-ftp-session-caching" href="#x2.1-new-ftp-session-caching"></a>FTP Session Caching</h4></div></div></div>

<p>As of version 2.1, we have exposed more flexibility with regards to session management for remote file adapters (e.g., FTP, SFTP etc).</p>
<p>Specifically, the <code class="literal">cache-sessions</code> attribute, which is available via the XML namespace support, is now <span class="emphasis"><em>deprecated</em></span>.
Alternatively, we added the <code class="literal">sessionCacheSize</code> and <code class="literal">sessionWaitTimeout</code> attributes on the <code class="literal">CachingSessionFactory</code>.</p>
<p>For further details please see <a class="xref" href="#ftp-session-caching" title="15.8&nbsp;FTP Session Caching">Section&nbsp;15.8, &#8220;FTP Session Caching&#8221;</a> and <a class="xref" href="#sftp-session-caching" title="27.5&nbsp;SFTP Session Caching">Section&nbsp;27.5, &#8220;SFTP Session Caching&#8221;</a>.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="x2.1-framework-refactorings" href="#x2.1-framework-refactorings"></a>H.8.2&nbsp;Framework Refactoring</h3></div></div></div>

<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x2.1-router-standardization" href="#x2.1-router-standardization"></a>Standardizing Router Configuration</h4></div></div></div>

<p>Router parameters have been standardized across all router implementations with Spring Integration 2.1 providing a more consistent user experience.</p>
<p>With Spring Integration 2.1 the <code class="literal">ignore-channel-name-resolution-failures</code> attribute has been removed in favor of consolidating its behavior with the <code class="literal">resolution-required</code> attribute.
Also, the <code class="literal">resolution-required</code> attribute now defaults to <code class="literal">true</code>.</p>
<p>Starting with Spring Integration 2.1, routers will no longer silently drop any messages, if no default output channel was defined.
This means, that by default routers now require at least one resolved channel (if no <code class="literal">default-output-channel</code> was set) and by default will throw a <code class="literal">MessageDeliveryException</code> if no channel was determined (or an attempt to send was not successful).</p>
<p>If, however, you do desire to drop messages silently, simply set <code class="literal">default-output-channel="nullChannel"</code>.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>With the standardization of Router parameters and the consolidation of the parameters described above, there is the possibility of breaking older Spring Integration based applications.</p>
</td></tr></table></div>
<p>For further details please see <a class="xref" href="#router" title="6.1&nbsp;Routers">Section&nbsp;6.1, &#8220;Routers&#8221;</a></p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x2.1-schema-updated" href="#x2.1-schema-updated"></a>XML Schemas updated to 2.1</h4></div></div></div>

<p>Spring Integration 2.1 ships with an updated XML Schema (version 2.1), providing many improvements, e.g.
the Router standardizations discussed above.</p>
<p>From now on, users <span class="emphasis"><em>must</em></span> always declare the latest XML schema (currently version 2.1).
Alternatively, they can use the version-less schema.
Generally, the best option is to use version-less namespaces, as these will automatically use the latest available version of Spring Integration.</p>
<p>Declaring a version-less Spring Integration namespace:</p>
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
   <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
   <span class="hl-attribute">xmlns:int</span>=<span class="hl-value">"http://www.springframework.org/schema/integration"</span>
   <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"http://www.springframework.org/schema/integration
           http://www.springframework.org/schema/integration/spring-integration.xsd
           http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans.xsd"</span><span class="hl-tag">&gt;</span>
...
<span class="hl-tag">&lt;/beans&gt;</span></pre>
<p>Declaring a Spring Integration namespace using an explicit version:</p>
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
   <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
   <span class="hl-attribute">xmlns:int</span>=<span class="hl-value">"http://www.springframework.org/schema/integration"</span>
   <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"http://www.springframework.org/schema/integration
           http://www.springframework.org/schema/integration/spring-integration-2.2.xsd
           http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans.xsd"</span><span class="hl-tag">&gt;</span>
...
<span class="hl-tag">&lt;/beans&gt;</span></pre>
<p>The old 1.0 and 2.0 schemas are still there, but if an Application Context still references one of those deprecated schemas, the validator will fail on initialization.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="x2.1-source-control-infrastructure" href="#x2.1-source-control-infrastructure"></a>H.8.3&nbsp;Source Control Management and Build Infrastructure</h3></div></div></div>

<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x2.1-move-to-github" href="#x2.1-move-to-github"></a>Source Code now hosted on Github</h4></div></div></div>

<p>Since version 2.0, the Spring Integration project uses <a class="ulink" href="http://git-scm.com/" target="_top">Git</a> for version control.
In order to increase community visibility even further, the project was moved from SpringSource hosted Git repositories to <a class="ulink" href="http://www.github.com/" target="_top">Github</a>.
The Spring Integration Git repository is located at: <a class="ulink" href="https://github.com/spring-projects/spring-integration" target="_top">spring-integration</a>.</p>
<p>For the project we also improved the process of providing code contributions and we ensure that every commit is peer-reviewed.
In fact, core committers now follow the same process as contributors.
For more details please see:</p>
<p><a class="ulink" href="https://github.com/spring-projects/spring-integration/blob/master/CONTRIBUTING.adoc" target="_top">Contributing</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x2.1-sonar" href="#x2.1-sonar"></a>Improved Source Code Visibility with Sonar</h4></div></div></div>

<p>In an effort to provide better source code visibility and consequently to monitor the quality of Spring Integration&#8217;s source code, an instance of <a class="ulink" href="http://www.sonarsource.org/" target="_top">Sonar</a> was setup and metrics are gathered nightly and made available at:</p>
<p><a class="ulink" href="https://sonar.spring.io/dashboard?id=org.springframework.integration%3Aspring-integration%3Amaster" target="_top">sonar.spring.io</a>.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="x2.1-new-samples" href="#x2.1-new-samples"></a>H.8.4&nbsp;New Samples</h3></div></div></div>

<p>For the 2.1 release of Spring Integration we also expanded the Spring Integration Samples project and added many new samples, e.g.
samples covering AMQP support, the new payload enricher, a sample illustrating techniques for testing Spring Integration flow fragments, as well as an example for executing Stored Procedures against Oracle.
For details please visit:</p>
<p><a class="ulink" href="https://github.com/spring-projects/spring-integration-samples" target="_top">spring-integration-samples</a>.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="migration-1.0-2.0" href="#migration-1.0-2.0"></a>H.9&nbsp;Changes between 1.0 and 2.0</h2></div></div></div>

<p>For a detailed migration guide in regards to upgrading an existing application that uses Spring Integration older than version 2.0, please see:</p>
<p><a class="ulink" href="https://github.com/spring-projects/spring-integration/wiki/Spring-Integration-1.0-to-2.0-Migration-Guide" target="_top">Spring Integration 1.0 to 2.0 Migration Guide</a></p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="migration-spring-30-support" href="#migration-spring-30-support"></a>H.9.1&nbsp;Spring 3 support</h3></div></div></div>

<p>Spring Integration 2.0 is built on top of Spring 3.0.5 and makes many of its features available to our users.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="spel-support" href="#spel-support"></a>Support for the Spring Expression Language (SpEL)</h4></div></div></div>

<p>You can now use SpEL expressions within the <span class="emphasis"><em>transformer, router, filter,
            splitter, aggregator, service-activator, header-enricher</em></span>, and many more elements of the Spring Integration core namespace as well as various adapters.
There are many samples provided throughout this manual.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="conversion-support" href="#conversion-support"></a>ConversionService and Converter</h4></div></div></div>

<p>You can now benefit from <span class="emphasis"><em>Conversion Service</em></span> support provided with Spring while configuring many Spring Integration components such as <a class="ulink" href="http://www.eaipatterns.com/DatatypeChannel.html" target="_top">Datatype Channel</a>.
See <a class="xref" href="#channel-implementations" title="4.1.2&nbsp;Message Channel Implementations">Section&nbsp;4.1.2, &#8220;Message Channel Implementations&#8221;</a> as well <a class="xref" href="#service-activator-introduction" title="8.5.1&nbsp;Introduction">Section&nbsp;8.5.1, &#8220;Introduction&#8221;</a>.
Also, the SpEL support mentioned in the previous point also relies upon the ConversionService.
Therefore, you can register Converters once, and take advantage of them anywhere you are using SpEL expressions.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="task-scheduler-poller-support" href="#task-scheduler-poller-support"></a>TaskScheduler and Trigger</h4></div></div></div>

<p>Spring 3.0 defines two new strategies related to scheduling: <span class="emphasis"><em>TaskScheduler and Trigger</em></span> Spring Integration (which uses a lot of scheduling) now builds upon these.
In fact, Spring Integration 1.0 had originally defined some of the components (e.g.
CronTrigger) that have now been migrated into Spring 3.0&#8217;s core API.
Now, you can benefit from reusing the same components within the entire Application Context (not just Spring Integration configuration).
Configuration of Spring Integration Pollers has been greatly simplified as well by providing attributes for directly configuring rates, delays, cron expressions, and trigger references.
See <a class="xref" href="#channel-adapter" title="4.3&nbsp;Channel Adapter">Section&nbsp;4.3, &#8220;Channel Adapter&#8221;</a> for sample configurations.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="rest-support" href="#rest-support"></a>RestTemplate and HttpMessageConverter</h4></div></div></div>

<p>Our outbound HTTP adapters now delegate to Spring&#8217;s RestTemplate for executing the HTTP request and handling its response.
This also means that you can reuse any custom HttpMessageConverter implementations.
See <a class="xref" href="#http-outbound" title="17.3&nbsp;Http Outbound Components">Section&nbsp;17.3, &#8220;Http Outbound Components&#8221;</a> for more details.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="new-eip" href="#new-eip"></a>H.9.2&nbsp;Enterprise Integration Pattern Additions</h3></div></div></div>

<p>Also in 2.0 we have added support for even more of the patterns described in Hohpe and Woolf&#8217;s <a class="ulink" href="http://www.eaipatterns.com/" target="_top">Enterprise Integration Patterns</a> book.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="new-message-history" href="#new-message-history"></a>Message History</h4></div></div></div>

<p>We now provide support for the <a class="ulink" href="http://www.eaipatterns.com/MessageHistory.html" target="_top">Message History</a> pattern allowing you to keep track of all traversed components, including the name of each channel and endpoint as well as the timestamp of that traversal.
See <a class="xref" href="#message-history" title="9.3&nbsp;Message History">Section&nbsp;9.3, &#8220;Message History&#8221;</a> for more details.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="new-message-store" href="#new-message-store"></a>Message Store</h4></div></div></div>

<p>We now provide support for the <a class="ulink" href="http://www.eaipatterns.com/MessageStore.html" target="_top">Message Store</a> pattern.
The Message Store provides a strategy for persisting messages on behalf of any process whose scope extends beyond a single transaction, such as the Aggregator and Resequencer.
Many sections of this document provide samples on how to use a Message Store as it affects several areas of Spring Integration.
See <a class="xref" href="#message-store" title="9.4&nbsp;Message Store">Section&nbsp;9.4, &#8220;Message Store&#8221;</a>, <a class="xref" href="#claim-check" title="7.3&nbsp;Claim Check">Section&nbsp;7.3, &#8220;Claim Check&#8221;</a>, <a class="xref" href="#channel" title="4.1&nbsp;Message Channels">Section&nbsp;4.1, &#8220;Message Channels&#8221;</a>, <a class="xref" href="#aggregator" title="6.4&nbsp;Aggregator">Section&nbsp;6.4, &#8220;Aggregator&#8221;</a>, <a class="xref" href="#jdbc" title="18.&nbsp;JDBC Support">Chapter&nbsp;18, <i>JDBC Support</i></a>, and <a class="xref" href="#resequencer" title="6.5&nbsp;Resequencer">Section&nbsp;6.5, &#8220;Resequencer&#8221;</a> for more details</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="new-claim-check" href="#new-claim-check"></a>Claim Check</h4></div></div></div>

<p>We have added an implementation of the <a class="ulink" href="http://www.eaipatterns.com/StoreInLibrary.html" target="_top">Claim Check</a> pattern.
The idea behind the Claim Check pattern is that you can exchange a Message payload for a "claim ticket" and vice-versa.
This allows you to reduce bandwidth and/or avoid potential security issues when sending Messages across channels.
See <a class="xref" href="#claim-check" title="7.3&nbsp;Claim Check">Section&nbsp;7.3, &#8220;Claim Check&#8221;</a> for more details.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="new-control-bus" href="#new-control-bus"></a>Control Bus</h4></div></div></div>

<p>We have provided implementations of the <a class="ulink" href="http://www.eaipatterns.com/ControlBus.html" target="_top">Control Bus</a> pattern which allows you to use messaging to manage and monitor endpoints and channels.
The implementations include both a SpEL-based approach and one that executes Groovy scripts.
See <a class="xref" href="#control-bus" title="9.6&nbsp;Control Bus">Section&nbsp;9.6, &#8220;Control Bus&#8221;</a> and <a class="xref" href="#groovy-control-bus" title="8.8.2&nbsp;Control Bus">Section&nbsp;8.8.2, &#8220;Control Bus&#8221;</a> for more details.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="new-adapters" href="#new-adapters"></a>H.9.3&nbsp;New Channel Adapters and Gateways</h3></div></div></div>

<p>We have added several new Channel Adapters and Messaging Gateways in Spring Integration 2.0.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="new-ip" href="#new-ip"></a>TCP/UDP Adapters</h4></div></div></div>

<p>We have added Channel Adapters for receiving and sending messages over the TCP and UDP internet protocols.
See <a class="xref" href="#ip" title="31.&nbsp;TCP and UDP Support">Chapter&nbsp;31, <i>TCP and UDP Support</i></a> for more details.
Also, you can checkout the following blog: <a class="ulink" href="http://blog.springsource.com/2010/03/29/using-udp-and-tcp-adapters-in-spring-integration-2-0-m3/" target="_top">TCP/UDP support</a></p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="new-twitter" href="#new-twitter"></a>Twitter Adapters</h4></div></div></div>

<p>Twitter adapters provides support for sending and receiving Twitter Status updates as well as Direct Messages.
You can also perform Twitter Searches with an inbound Channel Adapter.
See <a class="xref" href="#twitter" title="32.&nbsp;Twitter Support">Chapter&nbsp;32, <i>Twitter Support</i></a> for more details.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="new-xmpp" href="#new-xmpp"></a>XMPP Adapters</h4></div></div></div>

<p>The new XMPP adapters support both Chat Messages and Presence events.
See <a class="xref" href="#xmpp" title="36.&nbsp;XMPP Support">Chapter&nbsp;36, <i>XMPP Support</i></a> for more details.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="new-ftp" href="#new-ftp"></a>FTP/FTPS Adapters</h4></div></div></div>

<p>Inbound and outbound File transfer support over FTP/FTPS is now available.
See <a class="xref" href="#ftp" title="15.&nbsp;FTP/FTPS Adapters">Chapter&nbsp;15, <i>FTP/FTPS Adapters</i></a> for more details.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="new-sftp" href="#new-sftp"></a>SFTP Adapters</h4></div></div></div>

<p>Inbound and outbound File transfer support over SFTP is now available.
See <a class="xref" href="#sftp" title="27.&nbsp;SFTP Adapters">Chapter&nbsp;27, <i>SFTP Adapters</i></a> for more details.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="new-feed" href="#new-feed"></a>Feed Adapters</h4></div></div></div>

<p>We have also added Channel Adapters for receiving news feeds (ATOM/RSS).
See <a class="xref" href="#feed" title="13.&nbsp;Feed Adapter">Chapter&nbsp;13, <i>Feed Adapter</i></a> for more details.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="new-other" href="#new-other"></a>H.9.4&nbsp;Other Additions</h3></div></div></div>

<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="new-groovy" href="#new-groovy"></a>Groovy Support</h4></div></div></div>

<p>With Spring Integration 2.0 we&#8217;ve added Groovy support allowing you to use Groovy scripting language to provide integration and/or business logic.
See <a class="xref" href="#groovy" title="8.8&nbsp;Groovy support">Section&nbsp;8.8, &#8220;Groovy support&#8221;</a> for more details.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="new-map-transformer" href="#new-map-transformer"></a>Map Transformers</h4></div></div></div>

<p>These symmetrical transformers convert payload objects to and from a Map.
See <a class="xref" href="#transformer" title="7.1&nbsp;Transformer">Section&nbsp;7.1, &#8220;Transformer&#8221;</a> for more details.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="new-json-transformer" href="#new-json-transformer"></a>JSON Transformers</h4></div></div></div>

<p>These symmetrical transformers convert payload objects to and from JSON.
See <a class="xref" href="#transformer" title="7.1&nbsp;Transformer">Section&nbsp;7.1, &#8220;Transformer&#8221;</a> for more details.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="new-serialize-transformer" href="#new-serialize-transformer"></a>Serialization Transformers</h4></div></div></div>

<p>These symmetrical transformers convert payload objects to and from byte arrays.
They also support the Serializer and Deserializer strategy interfaces that have been added as of Spring 3.0.5.
See <a class="xref" href="#transformer" title="7.1&nbsp;Transformer">Section&nbsp;7.1, &#8220;Transformer&#8221;</a> for more details.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="new-refactoring" href="#new-refactoring"></a>H.9.5&nbsp;Framework Refactoring</h3></div></div></div>

<p>The core API went through some significant refactoring to make it simpler and more usable.
Although we anticipate that the impact to the end user should be minimal, please read through this document to find what was changed.
Especially, visit <a class="xref" href="#dynamic-routers" title="6.1.5&nbsp;Dynamic Routers">Section&nbsp;6.1.5, &#8220;Dynamic Routers&#8221;</a> , <a class="xref" href="#gateway" title="8.4&nbsp;Messaging Gateways">Section&nbsp;8.4, &#8220;Messaging Gateways&#8221;</a>, <a class="xref" href="#http-outbound" title="17.3&nbsp;Http Outbound Components">Section&nbsp;17.3, &#8220;Http Outbound Components&#8221;</a>, <a class="xref" href="#message" title="5.1&nbsp;Message">Section&nbsp;5.1, &#8220;Message&#8221;</a>, and <a class="xref" href="#aggregator" title="6.4&nbsp;Aggregator">Section&nbsp;6.4, &#8220;Aggregator&#8221;</a> for more details.
If you are depending directly on some of the core components (Message, MessageHeaders, MessageChannel, MessageBuilder, etc.), you will notice that you need to update any import statements.
We restructured some packaging to provide the flexibility we needed for extending the domain model while avoiding any cyclical dependencies (it is a policy of the framework to avoid such "tangles").</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="new-infrastructure" href="#new-infrastructure"></a>H.9.6&nbsp;New Source Control Management and Build Infrastructure</h3></div></div></div>

<p>With Spring Integration 2.0 we have switched our build environment to use Git for source control.
To access our repository simply follow this URL: <a class="ulink" href="http://git.springsource.org/spring-integration" target="_top">http://git.springsource.org/spring-integration</a>.
We have also switched our build system to <a class="ulink" href="http://gradle.org/" target="_top">Gradle</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="new-samples" href="#new-samples"></a>H.9.7&nbsp;New Spring Integration Samples</h3></div></div></div>

<p>With Spring Integration 2.0 we have decoupled the samples from our main release distribution.
Please read this blog to get more info <a class="ulink" href="http://blog.springsource.com/2010/09/29/new-spring-integration-samples/" target="_top">New Spring Integration Samples</a> We have also created many new samples, including samples for every new Adapter.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="new-sts" href="#new-sts"></a>H.9.8&nbsp;Spring Tool Suite Visual Editor for Spring Integration</h3></div></div></div>

<p>There is an amazing new visual editor for Spring Integration included within the latest version of SpringSource Tool Suite.
If you are not already using STS, please download it here:</p>
<p><a class="ulink" href="https://spring.io/tools/sts" target="_top">Spring Tool Suite</a></p>
</div>
</div>
</div>
</div>
</div></body></html>