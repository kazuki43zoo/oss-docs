<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>17.&nbsp;File Support</title><link rel="stylesheet" type="text/css" href="css/manual-multipage.css"><meta name="generator" content="DocBook XSL Stylesheets V1.78.1"><link rel="home" href="index.html" title="Spring Integration Reference Manual"><link rel="up" href="spring-integration-endpoints.html" title="Part&nbsp;V.&nbsp;Integration Endpoints"><link rel="prev" href="feed.html" title="16.&nbsp;Feed Adapter"><link rel="next" href="ftp.html" title="18.&nbsp;FTP/FTPS Adapters"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">17.&nbsp;File Support</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="feed.html">Prev</a>&nbsp;</td><th width="60%" align="center">Part&nbsp;V.&nbsp;Integration Endpoints</th><td width="20%" align="right">&nbsp;<a accesskey="n" href="ftp.html">Next</a></td></tr></table><hr></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="files" href="#files"></a>17.&nbsp;File Support</h2></div></div></div>

<p>Spring Integration&#8217;s file support extends the Spring Integration core with a dedicated vocabulary to deal with reading, writing, and transforming files.</p>
<p>You need to include this dependency into your project:</p>
<div class="informalexample">
<p>
<b>Maven.&nbsp;</b>

</p><pre class="programlisting"><span class="hl-tag">&lt;dependency&gt;</span>
    <span class="hl-tag">&lt;groupId&gt;</span>org.springframework.integration<span class="hl-tag">&lt;/groupId&gt;</span>
    <span class="hl-tag">&lt;artifactId&gt;</span>spring-integration-file<span class="hl-tag">&lt;/artifactId&gt;</span>
    <span class="hl-tag">&lt;version&gt;</span>5.1.2.RELEASE<span class="hl-tag">&lt;/version&gt;</span>
<span class="hl-tag">&lt;/dependency&gt;</span></pre><p>

</p>
<p>
<b>Gradle.&nbsp;</b>

</p><pre class="programlisting">compile <span class="hl-string">"org.springframework.integration:spring-integration-file:5.1.2.RELEASE"</span></pre><p>

</p>
</div>
<p>It provides a namespace that enables elements defining channel adapters dedicated to files and support for transformers that can read file contents into strings or byte arrays.</p>
<p>This section explains the workings of <code class="literal">FileReadingMessageSource</code> and <code class="literal">FileWritingMessageHandler</code> and how to configure them as beans.
It also discusses the support for dealing with files through file-specific implementations of <code class="literal">Transformer</code>.
Finally, it explains the file-specific namespace.</p>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="file-reading" href="#file-reading"></a>17.1&nbsp;Reading Files</h2></div></div></div>

<p>A <code class="literal">FileReadingMessageSource</code> can be used to consume files from the filesystem.
This is an implementation of <code class="literal">MessageSource</code> that creates messages from a file system directory.
The following example shows how to configure a <code class="literal">FileReadingMessageSource</code>:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"pollableFileSource"</span>
    <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.file.FileReadingMessageSource"</span>
    <span class="hl-attribute">p:directory</span>=<span class="hl-value">"${input.directory}"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>To prevent creating messages for certain files, you can supply a <code class="literal">FileListFilter</code>.
By default, we use the following filters:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">IgnoreHiddenFileListFilter</code>
</li><li class="listitem">
<code class="literal">AcceptOnceFileListFilter</code>
</li></ul></div>
<p>The <code class="literal">IgnoreHiddenFileListFilter</code> ensures that hidden files are not processed.
Note that the exact definition of hidden is system-dependent.
For example, on UNIX-based systems, a file beginning with a period character is considered to be hidden.
Microsoft Windows, on the other hand, has a dedicated file attribute to indicate hidden files.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Version 4.2 introduced the <code class="literal">IgnoreHiddenFileListFilter</code>.
In prior versions, hidden files were included.
With the default configuration, the <code class="literal">IgnoreHiddenFileListFilter</code> is triggered first, followed by the <code class="literal">AcceptOnceFileListFilter</code>.</p>
</td></tr></table></div>
<p>The <code class="literal">AcceptOnceFileListFilter</code> ensures files are picked up only once from the directory.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The <code class="literal">AcceptOnceFileListFilter</code> stores its state in memory.
If you wish the state to survive a system restart, you can use the <code class="literal">FileSystemPersistentAcceptOnceFileListFilter</code>.
This filter stores the accepted file names in a <code class="literal">MetadataStore</code> implementation (see <a class="xref" href="system-management-chapter.html#metadata-store" title="12.5&nbsp;Metadata Store">Section&nbsp;12.5, &#8220;Metadata Store&#8221;</a>).
This filter matches on the filename and modified time.</p>
<p>Since version 4.0, this filter requires a <code class="literal">ConcurrentMetadataStore</code>.
When used with a shared data store (such as <code class="literal">Redis</code> with the <code class="literal">RedisMetadataStore</code>), it lets filter keys be shared across multiple application instances or across a network file share being used by multiple servers.</p>
<p>Since version 4.1.5, this filter has a new property (<code class="literal">flushOnUpdate</code>), which causes it to flush the metadata store on every update (if the store implements <code class="literal">Flushable</code>).</p>
</td></tr></table></div>
<p>The following example configures a <code class="literal">FileReadingMessageSource</code> with a filter:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"pollableFileSource"</span>
    <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.file.FileReadingMessageSource"</span>
    <span class="hl-attribute">p:inputDirectory</span>=<span class="hl-value">"${input.directory}"</span>
    <span class="hl-attribute">p:filter-ref</span>=<span class="hl-value">"customFilterBean"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>A common problem with reading files is that a file may be detected before it is ready (that is, some other process may still be writing the file).
The default <code class="literal">AcceptOnceFileListFilter</code> does not prevent this.
In most cases, this can be prevented if the file-writing process renames each file as soon as it is ready for reading.
A <code class="literal">filename-pattern</code> or <code class="literal">filename-regex</code> filter that accepts only files that are ready (perhaps based on a known suffix), composed with the default <code class="literal">AcceptOnceFileListFilter</code>, allows for this situation.
The <code class="literal">CompositeFileListFilter</code> enables the composition, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"pollableFileSource"</span>
    <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.file.FileReadingMessageSource"</span>
    <span class="hl-attribute">p:inputDirectory</span>=<span class="hl-value">"${input.directory}"</span>
    <span class="hl-attribute">p:filter-ref</span>=<span class="hl-value">"compositeFilter"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"compositeFilter"</span>
    <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.file.filters.CompositeFileListFilter"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg&gt;</span>
        <span class="hl-tag">&lt;list&gt;</span>
            <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.file.filters.AcceptOnceFileListFilter"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.file.filters.RegexPatternFileListFilter"</span><span class="hl-tag">&gt;</span>
                <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"^test.*$"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;/bean&gt;</span>
        <span class="hl-tag">&lt;/list&gt;</span>
    <span class="hl-tag">&lt;/constructor-arg&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
</div>
<p>If it is not possible to create the file with a temporary name and rename to the final name, Spring Integration provides another alternative.
Version 4.2 added the <code class="literal">LastModifiedFileListFilter</code>.
This filter can be configured with an <code class="literal">age</code> property so that only files older than this value are passed by the filter.
The age defaults to 60 seconds, but you should choose an age that is large enough to avoid picking up a file early (due to, say, network glitches).
The following example shows how to configure a <code class="literal">LastModifiedFileListFilter</code>:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"filter"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.file.filters.LastModifiedFileListFilter"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"age"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"120"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
</div>
<p>Starting with version 4.3.7, a <code class="literal">ChainFileListFilter</code> (an extension of <code class="literal">CompositeFileListFilter</code>) has been introduced to allow scenarios when subsequent filters should only see the result of the previous filter.
(With the <code class="literal">CompositeFileListFilter</code>, all filters see all the files, but it passes only files that have passed all filters).
An example of where the new behavior is required is a combination of <code class="literal">LastModifiedFileListFilter</code> and <code class="literal">AcceptOnceFileListFilter</code>, when we do not wish to accept the file until some amount of time has elapsed.
With the <code class="literal">CompositeFileListFilter</code>, since the <code class="literal">AcceptOnceFileListFilter</code> sees all the files on the first pass, it does not pass it later when the other filter does.
The <code class="literal">CompositeFileListFilter</code> approach is useful when a pattern filter is combined with a custom filter that looks for a secondary file to indicate that file transfer is complete.
The pattern filter might only pass the primary file (such as <code class="literal">something.txt</code>) but the "<code class="literal">done</code>" filter needs to see whether (for example) <code class="literal">something.done</code> is present.</p>
<p>Say we have files <code class="literal">a.txt</code>, <code class="literal">a.done</code>, and <code class="literal">b.txt</code>.</p>
<p>The pattern filter passes only <code class="literal">a.txt</code> and <code class="literal">b.txt</code>, while the "<code class="literal">done</code>" filter sees all three files and passes only <code class="literal">a.txt</code>.
The final result of the composite filter is that only <code class="literal">a.txt</code> is released.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>With the <code class="literal">ChainFileListFilter</code>, if any filter in the chain returns an empty list, the remaining filters are not invoked.</p>
</td></tr></table></div>
<p>Version 5.0 introduced an <code class="literal">ExpressionFileListFilter</code> to execute SpEL expression against a file as a context evaluation root object.
For this purpose, all the XML components for file handling (local and remote), along with an existing <code class="literal">filter</code> attribute, have been supplied with the <code class="literal">filter-expression</code> option, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-file:inbound-channel-adapter</span>
        <span class="hl-attribute">directory</span>=<span class="hl-value">"${inputdir}"</span>
        <span class="hl-attribute">filter-expression</span>=<span class="hl-value">"name matches '.text'"</span>
        <span class="hl-attribute">auto-startup</span>=<span class="hl-value">"false"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>Version 5.0.5 introduced the <code class="literal">DiscardAwareFileListFilter</code> implementations that have an interest in rejected files.
For this purpose, such a filter implementation should be supplied with a callback through <code class="literal">addDiscardCallback(Consumer&lt;File&gt;)</code>.
In the framework, this functionality is used from the <code class="literal">FileReadingMessageSource.WatchServiceDirectoryScanner</code>, in combination with <code class="literal">LastModifiedFileListFilter</code>.
Unlike the regular <code class="literal">DirectoryScanner</code>, the <code class="literal">WatchService</code> provides files for processing according to the events on the target file system.
At the moment of polling an internal queue with those files, the <code class="literal">LastModifiedFileListFilter</code> may discard them because they are too young relative to its configured <code class="literal">age</code>.
Therefore, we lose the file for future possible considerations.
The discard callback hook lets us retain the file in the internal queue so that it is available to be checked against the <code class="literal">age</code> in subsequent polls.
The <code class="literal">CompositeFileListFilter</code> also implements a <code class="literal">DiscardAwareFileListFilter</code> and populates a discard callback to all its <code class="literal">DiscardAwareFileListFilter</code> delegates.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Since <code class="literal">CompositeFileListFilter</code> matches the files against all delegates, the <code class="literal">discardCallback</code> may be called several times for the same file.</p>
</td></tr></table></div>
<p>Starting with version 5.1, the <code class="literal">FileReadingMessageSource</code> doesn&#8217;t check a directory for existence and doesn&#8217;t create it until its <code class="literal">start()</code> is called (typically via wrapping <code class="literal">SourcePollingChannelAdapter</code>).
Previously, there was no simple way to prevent an operation system permissions error when referencing the directory, for example from tests, or when permissions are applied later.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_message_headers" href="#_message_headers"></a>17.1.1&nbsp;Message Headers</h3></div></div></div>

<p>Starting with version 5.0, the <code class="literal">FileReadingMessageSource</code> (in addition to the <code class="literal">payload</code> as a polled <code class="literal">File</code>) populates the following headers to the outbound <code class="literal">Message</code>:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">FileHeaders.FILENAME</code>: The <code class="literal">File.getName()</code> of the file to send.
Can be used for subsequent rename or copy logic.
</li><li class="listitem">
<code class="literal">FileHeaders.ORIGINAL_FILE</code>: The <code class="literal">File</code> object itself.
Typically, this header is populated automatically by framework components (such as <a class="link" href="files.html#file-splitter" title="17.4&nbsp;File Splitter">splitters</a> or <a class="link" href="files.html#file-transforming" title="17.3&nbsp;File Transformers">transformers</a>) when we lose the original <code class="literal">File</code> object.
However, for consistency and convenience with any other custom use cases, this header can be useful to get access to the original file.
</li><li class="listitem">
<code class="literal">FileHeaders.RELATIVE_PATH</code>: A new header introduced to represent the part of file path relative to the root directory for the scan.
This header can be useful when the requirement is to restore a source directory hierarchy in the other places.
For this purpose, the <code class="literal">DefaultFileNameGenerator</code> (see "`<a class="xref" href="files.html#file-writing-file-names" title="17.2.1&nbsp;Generating File Names">Section&nbsp;17.2.1, &#8220;Generating File Names&#8221;</a>) can be configured to use this header.
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_directory_scanning_and_polling" href="#_directory_scanning_and_polling"></a>17.1.2&nbsp;Directory Scanning and Polling</h3></div></div></div>

<p>The <code class="literal">FileReadingMessageSource</code> does not produce messages for files from the directory immediately.
It uses an internal queue for <span class="emphasis"><em>eligible files</em></span> returned by the <code class="literal">scanner</code>.
The <code class="literal">scanEachPoll</code> option is used to ensure that the internal queue is refreshed with the latest input directory content on each poll.
By default (<code class="literal">scanEachPoll = false</code>), the <code class="literal">FileReadingMessageSource</code> empties its queue before scanning the directory again.
This default behavior is particularly useful to reduce scans of large numbers of files in a directory.
However, in cases where custom ordering is required, it is important to consider the effects of setting this flag to <code class="literal">true</code>.
The order in which files are processed may not be as expected.
By default, files in the queue are processed in their natural (<code class="literal">path</code>) order.
New files added by a scan, even when the queue already has files, are inserted in the appropriate position to maintain that natural order.
To customize the order, the <code class="literal">FileReadingMessageSource</code> can accept a <code class="literal">Comparator&lt;File&gt;</code> as a constructor argument.
It is used by the internal (<code class="literal">PriorityBlockingQueue</code>) to reorder its content according to the business requirements.
Therefore, to process files in a specific order, you should provide a comparator to the <code class="literal">FileReadingMessageSource</code> rather than ordering the list produced by a custom <code class="literal">DirectoryScanner</code>.</p>
<p>Version 5.0 introduced <code class="literal">RecursiveDirectoryScanner</code> to perform file tree visiting.
The implementation is based on the <code class="literal">Files.walk(Path start, int maxDepth, FileVisitOption... options)</code> functionality.
The root directory (<code class="literal">DirectoryScanner.listFiles(File)</code>) argument is excluded from the result.
All other sub-directories inclusions and exclusions are based on the target <code class="literal">FileListFilter</code> implementation.
For example, the <code class="literal">SimplePatternFileListFilter</code> filters out directories by default.
See <a class="ulink" href="https://docs.spring.io/spring-integration/api/org/springframework/integration/file/filters/AbstractDirectoryAwareFileListFilter.html" target="_top"><code class="literal">AbstractDirectoryAwareFileListFilter</code></a> and its implementations for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="file-namespace-support" href="#file-namespace-support"></a>17.1.3&nbsp;Namespace Support</h3></div></div></div>

<p>The configuration for file reading can be simplified by using the file-specific namespace.
To do so, use the following template:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
  <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
  <span class="hl-attribute">xmlns:int</span>=<span class="hl-value">"http://www.springframework.org/schema/integration"</span>
  <span class="hl-attribute">xmlns:int-file</span>=<span class="hl-value">"http://www.springframework.org/schema/integration/file"</span>
  <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"http://www.springframework.org/schema/beans
    http://www.springframework.org/schema/beans/spring-beans.xsd
    http://www.springframework.org/schema/integration
    http://www.springframework.org/schema/integration/spring-integration.xsd
    http://www.springframework.org/schema/integration/file
    http://www.springframework.org/schema/integration/file/spring-integration-file.xsd"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;/beans&gt;</span></pre>
</div>
<p>Within this namespace, you can reduce the <code class="literal">FileReadingMessageSource</code> and wrap it in an inbound Channel Adapter, as follows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-file:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"filesIn1"</span>
    <span class="hl-attribute">directory</span>=<span class="hl-value">"file:${input.directory}"</span> <span class="hl-attribute">prevent-duplicates</span>=<span class="hl-value">"true"</span> <span class="hl-attribute">ignore-hidden</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int-file:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"filesIn2"</span>
    <span class="hl-attribute">directory</span>=<span class="hl-value">"file:${input.directory}"</span>
    <span class="hl-attribute">filter</span>=<span class="hl-value">"customFilterBean"</span><span class="hl-tag"> /&gt;</span>

<span class="hl-tag">&lt;int-file:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"filesIn3"</span>
    <span class="hl-attribute">directory</span>=<span class="hl-value">"file:${input.directory}"</span>
    <span class="hl-attribute">filename-pattern</span>=<span class="hl-value">"test*"</span><span class="hl-tag"> /&gt;</span>

<span class="hl-tag">&lt;int-file:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"filesIn4"</span>
    <span class="hl-attribute">directory</span>=<span class="hl-value">"file:${input.directory}"</span>
    <span class="hl-attribute">filename-regex</span>=<span class="hl-value">"test[0-9]+\.txt"</span><span class="hl-tag"> /&gt;</span></pre>
</div>
<p>The first channel adapter example relies on the default <code class="literal">FileListFilter</code> implementations:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">IgnoreHiddenFileListFilter</code> (do not process hidden files)
</li><li class="listitem">
<code class="literal">AcceptOnceFileListFilter</code> (prevent duplication)
</li></ul></div>
<p>Therefore, you can also leave off the <code class="literal">prevent-duplicates</code> and <code class="literal">ignore-hidden</code> attributes, as they are <code class="literal">true</code> by default.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Spring Integration 4.2 introduced the <code class="literal">ignore-hidden</code> attribute. In prior versions, hidden files were included.</p>
</td></tr></table></div>
<p>The second channel adapter example uses a custom filter, the third uses the <code class="literal">filename-pattern</code> attribute to add an <code class="literal">AntPathMatcher</code> based filter, and the fourth uses the <code class="literal">filename-regex</code> attribute to add a regular expression pattern-based filter to the <code class="literal">FileReadingMessageSource</code>.
The <code class="literal">filename-pattern</code> and <code class="literal">filename-regex</code> attributes are each mutually exclusive with the regular <code class="literal">filter</code> reference attribute.
However, you can use the <code class="literal">filter</code> attribute to reference an instance of <code class="literal">CompositeFileListFilter</code> that combines any number of filters, including one or more pattern-based filters to fit your particular needs.</p>
<p>When multiple processes read from the same directory, you may want to lock files to prevent them from being picked up concurrently.
To do so, you can use a <code class="literal">FileLocker</code>.
There is a <code class="literal">java.nio</code>-based implementation available, but it is also possible to implement your own locking scheme.
The <code class="literal">nio</code> locker can be injected as follows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-file:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"filesIn"</span>
    <span class="hl-attribute">directory</span>=<span class="hl-value">"file:${input.directory}"</span> <span class="hl-attribute">prevent-duplicates</span>=<span class="hl-value">"true"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int-file:nio-locker/&gt;</span>
<span class="hl-tag">&lt;/int-file:inbound-channel-adapter&gt;</span></pre>
</div>
<p>You can configure a custom locker as follows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-file:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"filesIn"</span>
    <span class="hl-attribute">directory</span>=<span class="hl-value">"file:${input.directory}"</span> <span class="hl-attribute">prevent-duplicates</span>=<span class="hl-value">"true"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int-file:locker</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"customLocker"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-file:inbound-channel-adapter&gt;</span></pre>
</div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>When a file inbound adapter is configured with a locker, it takes responsibility for acquiring a lock before the file is allowed to be received.
It does not assume the responsibility to unlock the file.
If you have processed the file and keep the locks hanging around, you have a memory leak.
If this is a problem, you should call <code class="literal">FileLocker.unlock(File file)</code> yourself at the appropriate time.</p>
</td></tr></table></div>
<p>When filtering and locking files is not enough, you might need to control the way files are listed entirely.
To implement this type of requirement, you can use an implementation of <code class="literal">DirectoryScanner</code>.
This scanner lets you determine exactly what files are listed in each poll.
This is also the interface that Spring Integration uses internally to wire <code class="literal">FileListFilter</code> instances and <code class="literal">FileLocker</code> to the <code class="literal">FileReadingMessageSource</code>.
You can inject a custom <code class="literal">DirectoryScanner</code> into the <code class="literal">&lt;int-file:inbound-channel-adapter/&gt;</code> on the <code class="literal">scanner</code> attribute, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-file:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"filesIn"</span> <span class="hl-attribute">directory</span>=<span class="hl-value">"file:${input.directory}"</span>
     <span class="hl-attribute">scanner</span>=<span class="hl-value">"customDirectoryScanner"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>Doing so gives you full freedom to choose the ordering, listing, and locking strategies.</p>
<p>It is also important to understand that filters (including <code class="literal">patterns</code>, <code class="literal">regex</code>, <code class="literal">prevent-duplicates</code>, and others) and <code class="literal">locker</code> instances are actually used by the <code class="literal">scanner</code>.
Any of these attributes set on the adapter are subsequently injected into the internal <code class="literal">scanner</code>.
For the case of an external <code class="literal">scanner</code>, all filter and locker attributes are prohibited on the <code class="literal">FileReadingMessageSource</code>.
They must be specified (if required) on that custom <code class="literal">DirectoryScanner</code>.
In other words, if you inject a <code class="literal">scanner</code> into the <code class="literal">FileReadingMessageSource</code>, you should supply <code class="literal">filter</code> and <code class="literal">locker</code> on that <code class="literal">scanner</code>, not on the <code class="literal">FileReadingMessageSource</code>.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>By default, the <code class="literal">DefaultDirectoryScanner</code> uses an <code class="literal">IgnoreHiddenFileListFilter</code> and an <code class="literal">AcceptOnceFileListFilter</code>.
To prevent their use, you can configure your own filter (such as <code class="literal">AcceptAllFileListFilter</code>) or even set it to <code class="literal">null</code>.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="watch-service-directory-scanner" href="#watch-service-directory-scanner"></a>17.1.4&nbsp;<code class="literal">WatchServiceDirectoryScanner</code></h3></div></div></div>

<p>The <code class="literal">FileReadingMessageSource.WatchServiceDirectoryScanner</code> relies on file-system events when new files are added to the directory.
During initialization, the directory is registered to generate events.
The initial file list is also built during initialization.
While walking the directory tree, any subdirectories encountered are also registered to generate events.
On the first poll, the initial file list from walking the directory is returned.
On subsequent polls, files from new creation events are returned.
If a new subdirectory is added, its creation event is used to walk the new subtree to find existing files and register any new subdirectories found.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>There is an issue with <code class="literal">WatchKey</code> when its internal events <code class="literal">queue</code> is not drained by the program as quickly as the directory modification events occur.
If the queue size is exceeded, a <code class="literal">StandardWatchEventKinds.OVERFLOW</code> is emitted to indicate that some file system events may be lost.
In this case, the root directory is re-scanned completely.
To avoid duplicates, consider using an appropriate <code class="literal">FileListFilter</code> (such as the <code class="literal">AcceptOnceFileListFilter</code>) or removing files when processing is complete.</p>
</td></tr></table></div>
<p>The <code class="literal">WatchServiceDirectoryScanner</code> can be enabled through the <code class="literal">FileReadingMessageSource.use-watch-service</code> option, which is mutually exclusive with the <code class="literal">scanner</code> option.
An internal <code class="literal">FileReadingMessageSource.WatchServiceDirectoryScanner</code> instance is populated for the provided <code class="literal">directory</code>.</p>
<p>In addition, now the <code class="literal">WatchService</code> polling logic can track the <code class="literal">StandardWatchEventKinds.ENTRY_MODIFY</code> and <code class="literal">StandardWatchEventKinds.ENTRY_DELETE</code>.</p>
<p>If you need to track the modification of existing files as well as new files, you should implement the <code class="literal">ENTRY_MODIFY</code> events logic in the <code class="literal">FileListFilter</code>.
Otherwise, the files from those events are treated the same way.</p>
<p>The <code class="literal">ResettableFileListFilter</code> implementations pick up the <code class="literal">ENTRY_DELETE</code> events.
Consequently, their files are provided for the <code class="literal">remove()</code> operation.
When this event is enabled, filters such as the <code class="literal">AcceptOnceFileListFilter</code> have the file removed
As a result, if a file with the same name appears, it passes the filter and is sent as a message.</p>
<p>For this purpose, the <code class="literal">watch-events</code> property (<code class="literal">FileReadingMessageSource.setWatchEvents(WatchEventType... watchEvents)</code>) has been introduced.
(<code class="literal">WatchEventType</code> is a public inner enumeration in <code class="literal">FileReadingMessageSource</code>.)
With such an option, we can use one downstream flow logic for new files and use some other logic for modified files.
The following example shows how to configure different logic for create and modify events in the same directory:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-file:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"newFiles"</span>
     <span class="hl-attribute">directory</span>=<span class="hl-value">"${input.directory}"</span>
     <span class="hl-attribute">use-watch-service</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int-file:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"modifiedFiles"</span>
     <span class="hl-attribute">directory</span>=<span class="hl-value">"${input.directory}"</span>
     <span class="hl-attribute">use-watch-service</span>=<span class="hl-value">"true"</span>
     <span class="hl-attribute">filter</span>=<span class="hl-value">"acceptAllFilter"</span>
     <span class="hl-attribute">watch-events</span>=<span class="hl-value">"MODIFY"</span><span class="hl-tag">/&gt;</span> <span class="hl-comment">&lt;!-- The default is CREATE. --&gt;</span></pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_limiting_memory_consumption" href="#_limiting_memory_consumption"></a>17.1.5&nbsp;Limiting Memory Consumption</h3></div></div></div>

<p>You can use a <code class="literal">HeadDirectoryScanner</code> to limit the number of files retained in memory.
This can be useful when scanning large directories.
With XML configuration, this is enabled by setting the <code class="literal">queue-size</code> property on the inbound channel adapter.</p>
<p>Prior to version 4.2, this setting was incompatible with the use of any other filters.
Any other filters (including <code class="literal">prevent-duplicates="true"</code>) overwrote the filter used to limit the size.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The use of a <code class="literal">HeadDirectoryScanner</code> is incompatible with an <code class="literal">AcceptOnceFileListFilter</code>.
Since all filters are consulted during the poll decision, the <code class="literal">AcceptOnceFileListFilter</code> does not know that other filters might be temporarily filtering files.
Even if files that were previously filtered by the <code class="literal">HeadDirectoryScanner.HeadFilter</code> are now available, the <code class="literal">AcceptOnceFileListFilter</code> filters them.</p>
<p>Generally, instead of using an <code class="literal">AcceptOnceFileListFilter</code> in this case, you should remove the processed files so that the previously filtered files are available on a future poll.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_with_java_configuration_7" href="#_configuring_with_java_configuration_7"></a>17.1.6&nbsp;Configuring with Java Configuration</h3></div></div></div>

<p>The following Spring Boot application shows an example of how to configure the inbound adapter with Java configuration:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@SpringBootApplication</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> FileReadingJavaApplication {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
        <span class="hl-keyword">new</span> SpringApplicationBuilder(FileReadingJavaApplication.<span class="hl-keyword">class</span>)
            .web(false)
            .run(args);
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> MessageChannel fileInputChannel() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> DirectChannel();
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <em><span class="hl-annotation" style="color: gray">@InboundChannelAdapter(value = "fileInputChannel", poller = @Poller(fixedDelay = "1000"))</span></em>
    <span class="hl-keyword">public</span> MessageSource&lt;File&gt; fileReadingMessageSource() {
         FileReadingMessageSource source = <span class="hl-keyword">new</span> FileReadingMessageSource();
         source.setDirectory(<span class="hl-keyword">new</span> File(INBOUND_PATH));
         source.setFilter(<span class="hl-keyword">new</span> SimplePatternFileListFilter(<span class="hl-string">"*.txt"</span>));
         <span class="hl-keyword">return</span> source;
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <em><span class="hl-annotation" style="color: gray">@Transformer(inputChannel = "fileInputChannel", outputChannel = "processFileChannel")</span></em>
    <span class="hl-keyword">public</span> FileToStringTransformer fileToStringTransformer() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> FileToStringTransformer();
    }

}</pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_with_the_java_dsl_8" href="#_configuring_with_the_java_dsl_8"></a>17.1.7&nbsp;Configuring with the Java DSL</h3></div></div></div>

<p>The following Spring Boot application shows an example of how to configure the inbound adapter with the Java DSL:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@SpringBootApplication</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> FileReadingJavaApplication {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
        <span class="hl-keyword">new</span> SpringApplicationBuilder(FileReadingJavaApplication.<span class="hl-keyword">class</span>)
            .web(false)
            .run(args);
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> IntegrationFlow fileReadingFlow() {
         <span class="hl-keyword">return</span> IntegrationFlows
                  .from(s -&gt; s.file(<span class="hl-keyword">new</span> File(INBOUND_PATH))
                              .patternFilter(<span class="hl-string">"*.txt"</span>),
                          e -&gt; e.poller(Pollers.fixedDelay(<span class="hl-number">1000</span>)))
                  .transform(Files.toStringTransformer())
                  .channel(<span class="hl-string">"processFileChannel"</span>)
                  .get();
        }

}</pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="file-tailing" href="#file-tailing"></a>17.1.8&nbsp;'tail&#8217;ing Files</h3></div></div></div>

<p>Another popular use case is to get <span class="emphasis"><em>lines</em></span> from the end (or tail) of a file, capturing new lines when they are added.
Two implementations are provided.
The first, <code class="literal">OSDelegatingFileTailingMessageProducer</code>, uses the native <code class="literal">tail</code> command (on operating systems that have one).
This is generally the most efficient implementation on those platforms.
For operating systems that do not have a <code class="literal">tail</code> command, the second implementation, <code class="literal">ApacheCommonsFileTailingMessageProducer</code>, uses the Apache <code class="literal">commons-io</code> <code class="literal">Tailer</code> class.</p>
<p>In both cases, file system events, such as files being unavailable and other events, are published as <code class="literal">ApplicationEvent</code> instances by using the normal Spring event publishing mechanism.
Examples of such events include the following:</p>
<div class="informalexample">
<pre class="programlisting">[message=tail: cannot open `/tmp/somefile<span class="hl-string">' for reading:
               No such file or directory, file=/tmp/somefile]

[message=tail: `/tmp/somefile'</span> has become accessible, file=/tmp/somefile]

[message=tail: `/tmp/somefile<span class="hl-string">' has become inaccessible:
               No such file or directory, file=/tmp/somefile]

[message=tail: `/tmp/somefile'</span> has appeared;
               following end of new file, file=/tmp/somefile]</pre>
</div>
<p>The sequence of events shown in the preceding example might occur, for example, when a file is rotated.</p>
<p>Starting with version 5.0, a <code class="literal">FileTailingIdleEvent</code> is emitted when there is no data in the file during <code class="literal">idleEventInterval</code>.
The following example shows what such an event looks like:</p>
<div class="informalexample">
<pre class="programlisting">[message=Idle timeout, file=/tmp/somefile] [idle time=<span class="hl-number">5438</span>]</pre>
</div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Not all platforms that support a <code class="literal">tail</code> command provide these status messages.</p>
</td></tr></table></div>
<p>Messages emitted from these endpoints have the following headers:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">FileHeaders.ORIGINAL_FILE</code>: The <code class="literal">File</code> object
</li><li class="listitem">
<code class="literal">FileHeaders.FILENAME</code>: The file name (<code class="literal">File.getName()</code>)
</li></ul></div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>In versions prior to version 5.0, the <code class="literal">FileHeaders.FILENAME</code> header contained a string representation of the file&#8217;s absolute path.
You can now obtain that string representation by calling <code class="literal">getAbsolutePath()</code> on the original file header.</p>
</td></tr></table></div>
<p>The following example creates a native adapter with the default options (<span class="emphasis"><em>-F -n 0</em></span>, meaning to follow the file name from the current end).</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-file:tail-inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"native"</span>
	<span class="hl-attribute">channel</span>=<span class="hl-value">"input"</span>
	<span class="hl-attribute">task-executor</span>=<span class="hl-value">"exec"</span>
	<span class="hl-attribute">file</span>=<span class="hl-value">"/tmp/foo"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>The following example creates a native adapter with <span class="emphasis"><em>-F -n +0</em></span> options (meaning follow the file name, emitting all existing lines).</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-file:tail-inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"native"</span>
	<span class="hl-attribute">channel</span>=<span class="hl-value">"input"</span>
	<span class="hl-attribute">native-options</span>=<span class="hl-value">"-F -n +0"</span>
	<span class="hl-attribute">task-executor</span>=<span class="hl-value">"exec"</span>
	<span class="hl-attribute">file-delay</span>=<span class="hl-value">10000</span>
	<span class="hl-attribute">file</span>=<span class="hl-value">"/tmp/foo"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>If the <code class="literal">tail</code> command fails (on some platforms, a missing file causes the <code class="literal">tail</code> to fail, even with <code class="literal">-F</code> specified), the command is retried every 10 seconds.</p>
<p>By default, native adapters capture from standard output and send the content as messages.
They also capture from standard error to raise events.
Starting with version 4.3.6, you can discard the standard error events by setting the <code class="literal">enable-status-reader</code> to <code class="literal">false</code>, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-file:tail-inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"native"</span>
	<span class="hl-attribute">channel</span>=<span class="hl-value">"input"</span>
	<span class="hl-attribute">enable-status-reader</span>=<span class="hl-value">"false"</span>
	<span class="hl-attribute">task-executor</span>=<span class="hl-value">"exec"</span>
	<span class="hl-attribute">file</span>=<span class="hl-value">"/tmp/foo"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>In the following example, <code class="literal">IdleEventInterval</code> is set to <code class="literal">5000</code>, meaning that, if no lines are written for five seconds, <code class="literal">FileTailingIdleEvent</code> is triggered every five seconds:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-file:tail-inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"native"</span>
	<span class="hl-attribute">channel</span>=<span class="hl-value">"input"</span>
	<span class="hl-attribute">idle-event-interval</span>=<span class="hl-value">"5000"</span>
	<span class="hl-attribute">task-executor</span>=<span class="hl-value">"exec"</span>
	<span class="hl-attribute">file</span>=<span class="hl-value">"/tmp/somefile"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>This can be useful when you need to stop the adapter.</p>
<p>The following example creates an Apache <code class="literal">commons-io</code> <code class="literal">Tailer</code> adapter that examines the file for new lines every two seconds and checks for existence of a missing file every ten seconds:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-file:tail-inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"apache"</span>
	<span class="hl-attribute">channel</span>=<span class="hl-value">"input"</span>
	<span class="hl-attribute">task-executor</span>=<span class="hl-value">"exec"</span>
	<span class="hl-attribute">file</span>=<span class="hl-value">"/tmp/bar"</span>
	<span class="hl-attribute">delay</span>=<span class="hl-value">"2000"</span>
	<span class="hl-attribute">end</span>=<span class="hl-value">"false"</span>             <a name="CO23-1" href="#CO23-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
	reopen="true"           <a name="CO23-2" href="#CO23-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
	file-delay="10000"/&gt;</pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO23-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The file is tailed from the beginning (<code class="literal">end="false"</code>) instead of the end (which is the default).</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO23-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The file is reopened for each chunk (the default is to keep the file open).</p>
</td></tr></table></div>
</div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Specifying the <code class="literal">delay</code>, <code class="literal">end</code> or <code class="literal">reopen</code> attributes forces the use of the Apache <code class="literal">commons-io</code> adapter and makes the <code class="literal">native-options</code> attribute unavailable.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="file-incomplete" href="#file-incomplete"></a>17.1.9&nbsp;Dealing With Incomplete Data</h3></div></div></div>

<p>A common problem in file-transfer scenarios is how to determine that the transfer is complete so that you do not start reading an incomplete file.
A common technique to solve this problem is to write the file with a temporary name and then atomically rename it to the final name.
This technique, together with a filter that masks the temporary file from being picked up by the consumer, provides a robust solution.
This technique is used by Spring Integration components that write files (locally or remotely).
By default, they append <code class="literal">.writing</code> to the file name and remove it when the transfer is complete.</p>
<p>Another common technique is to write a second "<code class="literal">marker</code>" file to indicate that the file transfer is complete.
In this scenario, you should not consider <code class="literal">somefile.txt</code> (for example) to be available for use until <code class="literal">somefile.txt.complete</code> is also present.
Spring Integration version 5.0 introduced new filters to support this mechanism.
Implementations are provided for the file system (<code class="literal">FileSystemMarkerFilePresentFileListFilter</code>), <a class="link" href="ftp.html#ftp-incomplete" title="18.4.6&nbsp;Dealing With Incomplete Data">FTP</a> and <a class="link" href="sftp.html#sftp-incomplete" title="30.6.5&nbsp;Dealing With Incomplete Data">SFTP</a>.
They are configurable such that the marker file can have any name, although it is usually related to the file being transferred.
See the <a class="ulink" href="https://docs.spring.io/spring-integration/api/org/springframework/integration/file/filters/FileSystemMarkerFilePresentFileListFilter.html" target="_top">Javadoc</a> for more information.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="file-writing" href="#file-writing"></a>17.2&nbsp;Writing files</h2></div></div></div>

<p>To write messages to the file system, you can use a <a class="ulink" href="http://docs.spring.io/spring-integration/api/org/springframework/integration/file/FileWritingMessageHandler.html" target="_top"><code class="literal">FileWritingMessageHandler</code></a>.
This class can deal with the following payload types:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">File</code>
</li><li class="listitem">
<code class="literal">String</code>
</li><li class="listitem">
byte array
</li><li class="listitem">
<code class="literal">InputStream</code> (since <span class="emphasis"><em>version 4.2</em></span>)
</li></ul></div>
<p>For a String payload, you can configure the encoding and the charset.</p>
<p>To make things easier, you can configure the <code class="literal">FileWritingMessageHandler</code> as part of an outbound channel adapter or outbound gateway by using the XML namespace.</p>
<p>Starting with version 4.3, you can specify the buffer size to use when writing files.</p>
<p>Starting with version 5.1, you can provide a <code class="literal">BiConsumer&lt;File, Message&lt;?&gt;&gt;</code> <code class="literal">newFileCallback</code> which is triggered if you use <code class="literal">FileExistsMode.APPEND</code> or <code class="literal">FileExistsMode.APPEND_NO_FLUSH</code> and a new file has to be created.
This callback receives a newly created file and the message which triggered it.
This callback could be used to write a CSV header defined in the message header, for an example.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="file-writing-file-names" href="#file-writing-file-names"></a>17.2.1&nbsp;Generating File Names</h3></div></div></div>

<p>In its simplest form, the <code class="literal">FileWritingMessageHandler</code> requires only a destination directory for writing the files.
The name of the file to be written is determined by the handler&#8217;s <a class="ulink" href="http://docs.spring.io/spring-integration/api/org/springframework/integration/file/FileNameGenerator.html" target="_top"><code class="literal">FileNameGenerator</code></a>.
The <a class="ulink" href="http://docs.spring.io/spring-integration/api/org/springframework/integration/file/DefaultFileNameGenerator.html" target="_top">default implementation</a> looks for a message header whose key matches the constant defined as <a class="ulink" href="http://docs.spring.io/spring-integration/api/constant-values.html#org.springframework.integration.file.FileHeaders.FILENAME" target="_top"><code class="literal">FileHeaders.FILENAME</code></a>.</p>
<p>Alternatively, you can specify an expression to be evaluated against the message to generate a file name&#8201;&#8212;&#8201;for example, <code class="literal">headers['myCustomHeader'] + '.something'</code>.
The expression must evaluate to a <code class="literal">String</code>.
For convenience, the <code class="literal">DefaultFileNameGenerator</code> also provides the <code class="literal">setHeaderName</code> method, letting you explicitly specify the message header whose value is to be used as the filename.</p>
<p>Once set up, the <code class="literal">DefaultFileNameGenerator</code> employs the following resolution steps to determine the filename for a given message payload:</p>
<div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
Evaluate the expression against the message and, if the result is a non-empty <code class="literal">String</code>, use it as the filename.
</li><li class="listitem">
Otherwise, if the payload is a <code class="literal">java.io.File</code>, use the <code class="literal">File</code> object&#8217;s filename.
</li><li class="listitem">
Otherwise, use the message ID appended with .<code class="literal">msg</code> as the filename.
</li></ol></div>
<p>When you use the XML namespace support, both the file outbound channel adapter and the file outbound gateway support the following mutually exclusive configuration attributes:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">filename-generator</code> (a reference to a <code class="literal">FileNameGenerator</code> implementation)
</li><li class="listitem">
<code class="literal">filename-generator-expression</code> (an expression that evaluates to a <code class="literal">String</code>)
</li></ul></div>
<p>While writing files, a temporary file suffix is used (its default is <code class="literal">.writing</code>).
It is appended to the filename while the file is being written.
To customize the suffix, you can set the <code class="literal">temporary-file-suffix</code> attribute on both the file outbound channel adapter and the file outbound gateway.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>When using the <code class="literal">APPEND</code> file <code class="literal">mode</code>, the <code class="literal">temporary-file-suffix</code> attribute is ignored, since the data is appended to the file directly.</p>
</td></tr></table></div>
<p>Starting with ,version 4.2.5, the generated file name (as a result of <code class="literal">filename-generator</code> or <code class="literal">filename-generator-expression</code>
evaluation) can represent a child path together with the target file name.
It is used as a second constructor argument for <code class="literal">File(File parent, String child)</code> as before.
However, in the past we did not create (<code class="literal">mkdirs()</code>) directories for the child path, assuming only the file name.
This approach is useful for cases when we need to restore the file system tree to match the source directory&#8201;&#8212;&#8201;for example, when unzipping the archive and saving all the files in the target directory in the original order.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="file-writing-output-directory" href="#file-writing-output-directory"></a>17.2.2&nbsp;Specifying the Output Directory</h3></div></div></div>

<p>Both, the file outbound channel adapter and the file outbound gateway provide two mutually exclusive configuration attributes for specifying the output directory:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">directory</code>
</li><li class="listitem">
<code class="literal">directory-expression</code>
</li></ul></div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Spring Integration 2.2 introduced the <code class="literal">directory-expression</code> attribute.</p>
</td></tr></table></div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_using_the_literal_directory_literal_attribute" href="#_using_the_literal_directory_literal_attribute"></a>Using the <code class="literal">directory</code> Attribute</h4></div></div></div>

<p>When you use the <code class="literal">directory</code> attribute, the output directory is set to a fixed value, which is set when the <code class="literal">FileWritingMessageHandler</code> is initialized.
If you do not specify this attribute, you must use the <code class="literal">directory-expression</code> attribute.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_using_the_literal_directory_expression_literal_attribute" href="#_using_the_literal_directory_expression_literal_attribute"></a>Using the <code class="literal">directory-expression</code> Attribute</h4></div></div></div>

<p>If you want to have full SpEL support, you can use the <code class="literal">directory-expression</code> attribute.
This attribute accepts a SpEL expression that is evaluated for each message being processed.
Thus, you have full access to a message&#8217;s payload and its headers when you dynamically specify the output file directory.</p>
<p>The SpEL expression must resolve to either a <code class="literal">String</code> or to <code class="literal">java.io.File</code>.
Furthermore, the resulting <code class="literal">String</code> or <code class="literal">File</code> must point to a directory.
If you do not specify the <code class="literal">directory-expression</code> attribute, then you must set the <code class="literal">directory</code> attribute.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_using_the_literal_auto_create_directory_literal_attribute" href="#_using_the_literal_auto_create_directory_literal_attribute"></a>Using the <code class="literal">auto-create-directory</code> Attribute</h4></div></div></div>

<p>By default, if the destination directory does not exist, the respective destination directory and any non-existing parent directories are  automatically created.
To prevent that behavior, you can set the <code class="literal">auto-create-directory</code> attribute to <code class="literal">false</code>.
This attribute applies to both the <code class="literal">directory</code> and the <code class="literal">directory-expression</code> attributes.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>When using the <code class="literal">directory</code> attribute and <code class="literal">auto-create-directory</code> is <code class="literal">false</code>, the following change was made starting with Spring Integration 2.2:</p>
<p>Instead of checking for the existence of the destination directory when the adapter is initialized, this check is now performed for each message being processed.</p>
<p>Furthermore, if <code class="literal">auto-create-directory</code> is <code class="literal">true</code> and the directory was deleted between the processing of messages, the directory is re-created for each message being processed.</p>
</td></tr></table></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="file-writing-destination-exists" href="#file-writing-destination-exists"></a>17.2.3&nbsp;Dealing with Existing Destination Files</h3></div></div></div>

<p>When you write files and the destination file already exists, the default behavior is to overwrite that target file.
You can change this behavior by setting the <code class="literal">mode</code> attribute on the relevant file outbound components.
The following options exist:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">REPLACE</code> (Default)
</li><li class="listitem">
<code class="literal">REPLACE_IF_MODIFIED</code>
</li><li class="listitem">
<code class="literal">APPEND</code>
</li><li class="listitem">
<code class="literal">APPEND_NO_FLUSH</code>
</li><li class="listitem">
<code class="literal">FAIL</code>
</li><li class="listitem">
<code class="literal">IGNORE</code>
</li></ul></div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Spring Integration 2.2 introduced the <code class="literal">mode</code> attribute and the <code class="literal">APPEND</code>, <code class="literal">FAIL</code>, and <code class="literal">IGNORE</code> options.</p>
</td></tr></table></div>
<div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">REPLACE</code></span></dt><dd>
If the target file already exists, it is overwritten.
If the <code class="literal">mode</code> attribute is not specified, this is the default behavior when writing files.
</dd><dt><span class="term"><code class="literal">REPLACE_IF_MODIFIED</code></span></dt><dd>
If the target file already exists, it is overwritten only if the last modified timestamp differs from that of the source file.
For <code class="literal">File</code> payloads, the payload <code class="literal">lastModified</code> time is compared to the existing file.
For other payloads, the <code class="literal">FileHeaders.SET_MODIFIED</code> (<code class="literal">file_setModified</code>) header is compared to the existing file.
If the header is missing or has a value that is not a <code class="literal">Number</code>, the file is always replaced.
</dd><dt><span class="term"><code class="literal">APPEND</code></span></dt><dd>
This mode lets you append message content to the existing file instead of creating a new file each time.
Note that this attribute is mutually exclusive with the <code class="literal">temporary-file-suffix</code> attribute because, when it appends content to the existing file, the adapter no longer uses a temporary file.
The file is closed after each message.
</dd><dt><span class="term"><code class="literal">APPEND_NO_FLUSH</code></span></dt><dd>
This option has the same semantics as <code class="literal">APPEND</code>, but the data is not flushed and the file is not closed after each message.
This can provide a significant performance at the risk of data loss in the event of a failure.
See <a class="xref" href="files.html#file-flushing" title="17.2.4&nbsp;Flushing Files When Using APPEND_NO_FLUSH">Section&nbsp;17.2.4, &#8220;Flushing Files When Using <code class="literal">APPEND_NO_FLUSH</code>&#8221;</a> for more information.
</dd><dt><span class="term"><code class="literal">FAIL</code></span></dt><dd>
If the target file exists, a <a class="ulink" href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/messaging/MessageHandlingException.html" target="_top"><code class="literal">MessageHandlingException</code></a> is thrown.
</dd><dt><span class="term"><code class="literal">IGNORE</code></span></dt><dd>
If the target file exists, the message payload is silently ignored.
</dd></dl></div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>When using a temporary file suffix (the default is <code class="literal">.writing</code>), the <code class="literal">IGNORE</code> option applies if either the final file name or the temporary file name exists.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="file-flushing" href="#file-flushing"></a>17.2.4&nbsp;Flushing Files When Using <code class="literal">APPEND_NO_FLUSH</code></h3></div></div></div>

<p>The <code class="literal">APPEND_NO_FLUSH</code> mode was added in version 4.3.
Using it can improve performance because the file is not closed after each message.
However, this can cause data loss in the event of a failure.</p>
<p>Spring Integration provides several flushing strategies to mitigate this data loss:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Use <code class="literal">flushInterval</code>. If a file is not written to for this period of time, it is automatically flushed.
This is approximate and may be up to <code class="literal">1.33x</code> this time (with an average of <code class="literal">1.167x</code>).
</li><li class="listitem">
Send a message containing a regular expression to the message handler&#8217;s <code class="literal">trigger</code> method.
Files with absolute path names matching the pattern are flushed.
</li><li class="listitem">
Provide the handler with a custom <code class="literal">MessageFlushPredicate</code> implementation to modify the action taken when a message is sent to the <code class="literal">trigger</code> method.
</li><li class="listitem">
Invoke one of the handler&#8217;s <code class="literal">flushIfNeeded</code> methods by passing in a custom <code class="literal">FileWritingMessageHandler.FlushPredicate</code> or <code class="literal">FileWritingMessageHandler.MessageFlushPredicate</code> implementation.
</li></ul></div>
<p>The predicates are called for each open file.
See the <a class="ulink" href="https://docs.spring.io/spring-integration/api/index.html" target="_top">Javadoc</a> for these interfaces for more information.
Note that, since version 5.0, the predicate methods provide another parameter: the time that the current file was first written to if new or previously closed.</p>
<p>When using <code class="literal">flushInterval</code>, the interval starts at the last write.
The file is flushed only if it is idle for the interval.
Starting with version 4.3.7, an additional property (<code class="literal">flushWhenIdle</code>) can be set to <code class="literal">false</code>, meaning that the interval starts with the first write to a previously flushed (or new) file.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="file-timestamps" href="#file-timestamps"></a>17.2.5&nbsp;File Timestamps</h3></div></div></div>

<p>By default, the destination file&#8217;s <code class="literal">lastModified</code> timestamp is the time when the file was created (except that an in-place rename retains the current timestamp).
Starting with version 4.3, you can now configure <code class="literal">preserve-timestamp</code> (or <code class="literal">setPreserveTimestamp(true)</code> when using Java configuration).
For <code class="literal">File</code> payloads, this transfers the timestamp from the inbound file to the outbound (regardless of whether a copy was required).
For other payloads, if the <code class="literal">FileHeaders.SET_MODIFIED</code> header (<code class="literal">file_setModified</code>) is present, it is used to set the destination file&#8217;s <code class="literal">lastModified</code> timestamp, as long as the header is a <code class="literal">Number</code>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="file-permissions" href="#file-permissions"></a>17.2.6&nbsp;File Permissions</h3></div></div></div>

<p>Starting with version 5.0, when writing files to a file system that supports Posix permissions, you can specify those permissions on the outbound channel adapter or gateway.
The property is an integer and is usually supplied in the familiar octal format&#8201;&#8212;&#8201;for example, <code class="literal">0640</code>, meaning that the owner has read/write permissions, the group has read-only permission, and others have no access.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="file-outbound-channel-adapter" href="#file-outbound-channel-adapter"></a>17.2.7&nbsp;File Outbound Channel Adapter</h3></div></div></div>

<p>The following example configures a file outbound channel adapter:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-file:outbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"filesOut"</span> <span class="hl-attribute">directory</span>=<span class="hl-value">"${input.directory.property}"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>The namespace-based configuration also supports a <code class="literal">delete-source-files</code> attribute.
If set to <code class="literal">true</code>, it triggers the deletion of the original source files after writing to a destination.
The default value for that flag is <code class="literal">false</code>.
The following example shows how to set it to <code class="literal">true</code>:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-file:outbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"filesOut"</span>
    <span class="hl-attribute">directory</span>=<span class="hl-value">"${output.directory}"</span>
    <span class="hl-attribute">delete-source-files</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The <code class="literal">delete-source-files</code> attribute has an effect only if the inbound message has a <code class="literal">File</code> payload or if the <code class="literal">FileHeaders.ORIGINAL_FILE</code> header value contains either the source <code class="literal">File</code> instance or a <code class="literal">String</code> representing the original file path.</p>
</td></tr></table></div>
<p>Starting with version 4.2, the <code class="literal">FileWritingMessageHandler</code> supports an <code class="literal">append-new-line</code> option.
If set to <code class="literal">true</code>, a new line is appended to the file after a message is written.
The default attribute value is <code class="literal">false</code>.
The following example shows how to use the <code class="literal">append-new-line</code> option:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-file:outbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"newlineAdapter"</span>
	<span class="hl-attribute">append-new-line</span>=<span class="hl-value">"true"</span>
    <span class="hl-attribute">directory</span>=<span class="hl-value">"${output.directory}"</span><span class="hl-tag">/&gt;</span></pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="file-writing-output-gateway" href="#file-writing-output-gateway"></a>17.2.8&nbsp;Outbound Gateway</h3></div></div></div>

<p>In cases where you want to continue processing messages based on the written file, you can use the <code class="literal">outbound-gateway</code> instead.
It plays a role similar to that of the <code class="literal">outbound-channel-adapter</code>.
However, after writing the file, it also sends it to the reply channel as the payload of a message.</p>
<p>The following example configures an outbound gateway:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-file:outbound-gateway</span> <span class="hl-attribute">id</span>=<span class="hl-value">"mover"</span> <span class="hl-attribute">request-channel</span>=<span class="hl-value">"moveInput"</span>
    <span class="hl-attribute">reply-channel</span>=<span class="hl-value">"output"</span>
    <span class="hl-attribute">directory</span>=<span class="hl-value">"${output.directory}"</span>
    <span class="hl-attribute">mode</span>=<span class="hl-value">"REPLACE"</span> <span class="hl-attribute">delete-source-files</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>As mentioned earlier, you can also specify the <code class="literal">mode</code> attribute, which defines the behavior of how to deal with situations where the destination file already exists.
See <a class="xref" href="files.html#file-writing-destination-exists" title="17.2.3&nbsp;Dealing with Existing Destination Files">Section&nbsp;17.2.3, &#8220;Dealing with Existing Destination Files&#8221;</a> for further details.
Generally, when using the file outbound gateway, the result file is returned as the message payload on the reply channel.</p>
<p>This also applies when specifying the <code class="literal">IGNORE</code> mode.
In that case the pre-existing destination file is returned.
If the payload of the request message was a file, you still have access to that original file through the message header.
See <a class="ulink" href="http://docs.spring.io/spring-integration/api/org/springframework/integration/file/FileHeaders.html" target="_top">FileHeaders.ORIGINAL_FILE</a>.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The <span class="emphasis"><em>outbound-gateway</em></span> works well in cases where you want to first move a file and then send it through a processing pipeline.
In such cases, you may connect the file namespace&#8217;s <code class="literal">inbound-channel-adapter</code> element to the <code class="literal">outbound-gateway</code> and then connect that gateway&#8217;s <code class="literal">reply-channel</code> to the beginning of the pipeline.</p>
</td></tr></table></div>
<p>If you have more elaborate requirements or need to support additional payload types as input to be converted to file content, you can extend the <code class="literal">FileWritingMessageHandler</code>, but a much better option is to rely on a <a class="link" href="files.html#file-transforming" title="17.3&nbsp;File Transformers"><code class="literal">Transformer</code></a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_with_java_configuration_8" href="#_configuring_with_java_configuration_8"></a>17.2.9&nbsp;Configuring with Java Configuration</h3></div></div></div>

<p>The following Spring Boot application shows an example of how to configure the inbound adapter with Java configuration:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@SpringBootApplication</span></em>
<em><span class="hl-annotation" style="color: gray">@IntegrationComponentScan</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> FileWritingJavaApplication {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
        ConfigurableApplicationContext context =
                      <span class="hl-keyword">new</span> SpringApplicationBuilder(FileWritingJavaApplication.<span class="hl-keyword">class</span>)
                              .web(false)
                              .run(args);
             MyGateway gateway = context.getBean(MyGateway.<span class="hl-keyword">class</span>);
             gateway.writeToFile(<span class="hl-string">"foo.txt"</span>, <span class="hl-keyword">new</span> File(tmpDir.getRoot(), <span class="hl-string">"fileWritingFlow"</span>), <span class="hl-string">"foo"</span>);
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "writeToFileChannel")</span></em>
    <span class="hl-keyword">public</span> MessageHandler fileWritingMessageHandler() {
         Expression directoryExpression = <span class="hl-keyword">new</span> SpelExpressionParser().parseExpression(<span class="hl-string">"headers.directory"</span>);
         FileWritingMessageHandler handler = <span class="hl-keyword">new</span> FileWritingMessageHandler(directoryExpression);
         handler.setFileExistsMode(FileExistsMode.APPEND);
         <span class="hl-keyword">return</span> handler;
    }

    <em><span class="hl-annotation" style="color: gray">@MessagingGateway(defaultRequestChannel = "writeToFileChannel")</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> MyGateway {

        <span class="hl-keyword">void</span> writeToFile(<em><span class="hl-annotation" style="color: gray">@Header(FileHeaders.FILENAME)</span></em> String fileName,
                       <em><span class="hl-annotation" style="color: gray">@Header(FileHeaders.FILENAME)</span></em> File directory, String data);

    }
}</pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_with_the_java_dsl_9" href="#_configuring_with_the_java_dsl_9"></a>17.2.10&nbsp;Configuring with the Java DSL</h3></div></div></div>

<p>The following Spring Boot application shows an example of how to configure the inbound adapter with the Java DSL:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@SpringBootApplication</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> FileWritingJavaApplication {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
        ConfigurableApplicationContext context =
                 <span class="hl-keyword">new</span> SpringApplicationBuilder(FileWritingJavaApplication.<span class="hl-keyword">class</span>)
                         .web(false)
                         .run(args);
        MessageChannel fileWritingInput = context.getBean(<span class="hl-string">"fileWritingInput"</span>, MessageChannel.<span class="hl-keyword">class</span>);
        fileWritingInput.send(<span class="hl-keyword">new</span> GenericMessage&lt;&gt;(<span class="hl-string">"foo"</span>));
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
   	<span class="hl-keyword">public</span> IntegrationFlow fileWritingFlow() {
   	    <span class="hl-keyword">return</span> IntegrationFlows.from(<span class="hl-string">"fileWritingInput"</span>)
   		        .enrichHeaders(h -&gt; h.header(FileHeaders.FILENAME, <span class="hl-string">"foo.txt"</span>)
   		                  .header(<span class="hl-string">"directory"</span>, <span class="hl-keyword">new</span> File(tmpDir.getRoot(), <span class="hl-string">"fileWritingFlow"</span>)))
   	            .handleWithAdapter(a -&gt; a.fileGateway(m -&gt; m.getHeaders().get(<span class="hl-string">"directory"</span>)))
   	            .channel(MessageChannels.queue(<span class="hl-string">"fileWritingResultChannel"</span>))
   	            .get();
    }

}</pre>
</div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="file-transforming" href="#file-transforming"></a>17.3&nbsp;File Transformers</h2></div></div></div>

<p>To transform data read from the file system to objects and the other way around, you need to do some work.
Unlike <code class="literal">FileReadingMessageSource</code> and to a lesser extent <code class="literal">FileWritingMessageHandler</code>, you probably need your own mechanism to get the job done.
For this, you can implement the <code class="literal">Transformer</code> interface.
Alternatively, you can extend the <code class="literal">AbstractFilePayloadTransformer</code> for inbound messages.
Spring Integration provides some obvious implementations.</p>
<p>See the <a class="ulink" href="https://docs.spring.io/spring-integration/api/org/springframework/integration/transformer/Transformer.html" target="_top">Javadoc for the <code class="literal">Transformer</code> interface</a> to see which Spring Integration classes implement it.
Similarly, you can check the <a class="ulink" href="https://docs.spring.io/spring-integration/api/org/springframework/integration/file/transformer/AbstractFilePayloadTransformer.html" target="_top">Javadoc for the <code class="literal">AbstractFilePayloadTransformer</code> class</a> to see which Spring Integration classes extend it.</p>
<p><code class="literal">FileToByteArrayTransformer</code> extends <code class="literal">AbstractFilePayloadTransformer</code> and transforms a <code class="literal">File</code> object into a <code class="literal">byte[]</code> by using Spring&#8217;s <code class="literal">FileCopyUtils</code>.
It is often better to use a sequence of transformers than to put all transformations in a single class.
In that case the <code class="literal">File</code> to <code class="literal">byte[]</code> conversion might be a logical first step.</p>
<p><code class="literal">FileToStringTransformer</code> extends <code class="literal">AbstractFilePayloadTransformer</code> convert a <code class="literal">File</code> object to a <code class="literal">String</code>.
If nothing else, this can be useful for debugging (consider using it with a <a class="link" href="messaging-channels-section.html#channel-wiretap" title="Wire Tap">wire tap</a>).</p>
<p>To configure file-specific transformers, you can use the appropriate elements from the file namespace, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-file:file-to-bytes-transformer</span>  <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span>
    <span class="hl-attribute">delete-files</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int-file:file-to-string-transformer</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span>
    <span class="hl-attribute">delete-files</span>=<span class="hl-value">"true"</span> <span class="hl-attribute">charset</span>=<span class="hl-value">"UTF-8"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>The <code class="literal">delete-files</code> option signals to the transformer that it should delete the inbound file after the transformation is complete.
This is in no way a replacement for using an <code class="literal">AcceptOnceFileListFilter</code> when the <code class="literal">FileReadingMessageSource</code> is being used in a multi-threaded environment (such as when you use Spring Integration in general).</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="file-splitter" href="#file-splitter"></a>17.4&nbsp;File Splitter</h2></div></div></div>

<p>The <code class="literal">FileSplitter</code> was added in version 4.1.2, and its namespace support was added in version 4.2.
The <code class="literal">FileSplitter</code> splits text files into individual lines, based on <code class="literal">BufferedReader.readLine()</code>.
By default, the splitter uses an <code class="literal">Iterator</code> to emit lines one at a time as they are read from the file.
Setting the <code class="literal">iterator</code> property to <code class="literal">false</code> causes it to read all the lines into memory before emitting them as messages.
One use case for this might be if you want to detect I/O errors on the file before sending any messages containing lines.
However, it is only practical for relatively short files.</p>
<p>Inbound payloads can be <code class="literal">File</code>, <code class="literal">String</code> (a <code class="literal">File</code> path), <code class="literal">InputStream</code>, or <code class="literal">Reader</code>.
Other payload types are emitted unchanged.</p>
<p>The following listing shows all the possible attributes for <code class="literal">&lt;int-file:splitter&gt;</code>:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-file:splitter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"splitter"</span> <a name="CO24-1" href="#CO24-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
    iterator=""                  <a name="CO24-2" href="#CO24-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
    markers=""                   <a name="CO24-3" href="#CO24-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
    markers-json=""              <a name="CO24-4" href="#CO24-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
    apply-sequence=""            <a name="CO24-5" href="#CO24-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
    requires-reply=""            <a name="CO24-6" href="#CO24-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>
    charset=""                   <a name="CO24-7" href="#CO24-7"></a><span><img src="images/callouts/7.png" alt="7" border="0"></span>
    first-line-as-header=""      <a name="CO24-8" href="#CO24-8"></a><span><img src="images/callouts/8.png" alt="8" border="0"></span>
    input-channel=""             <a name="CO24-9" href="#CO24-9"></a><span><img src="images/callouts/9.png" alt="9" border="0"></span>
    output-channel=""            <a name="CO24-10" href="#CO24-10"></a><span><img src="images/callouts/10.png" alt="10" border="0"></span>
    send-timeout=""              <a name="CO24-11" href="#CO24-11"></a><span><img src="images/callouts/11.png" alt="11" border="0"></span>
    auto-startup=""              <a name="CO24-12" href="#CO24-12"></a><span><img src="images/callouts/12.png" alt="12" border="0"></span>
    order=""                     <a name="CO24-13" href="#CO24-13"></a><span><img src="images/callouts/13.png" alt="13" border="0"></span>
    phase="" /&gt;                  <a name="CO24-14" href="#CO24-14"></a><span><img src="images/callouts/14.png" alt="14" border="0"></span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO24-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The bean name of the splitter.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO24-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Set to <code class="literal">true</code> (the default) to use an iterator or <code class="literal">false</code> to load the file into memory before sending lines.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO24-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Set to <code class="literal">true</code> to emit start-of-file and end-of-file marker messages before and after the file data.
Markers are messages with <code class="literal">FileSplitter.FileMarker</code> payloads (with <code class="literal">START</code> and <code class="literal">END</code> values in the <code class="literal">mark</code> property).
You might use markers when sequentially processing files in a downstream flow where some lines are filtered.
They enable the downstream processing to know when a file has been completely processed.
In addition, a <code class="literal">file_marker</code> header that contains <code class="literal">START</code> or <code class="literal">END</code> is added to these messages.
The <code class="literal">END</code> marker includes a line count.
If the file is empty, only <code class="literal">START</code> and <code class="literal">END</code> markers are emitted with <code class="literal">0</code> as the <code class="literal">lineCount</code>.
The default is <code class="literal">false</code>.
When <code class="literal">true</code>, <code class="literal">apply-sequence</code> is <code class="literal">false</code> by default.
See also <code class="literal">markers-json</code> (the next attribute).</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO24-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>When <code class="literal">markers</code> is true, set this to <code class="literal">true</code> to have the <code class="literal">FileMarker</code> objects be converted to a JSON string.
Requires a supported JSON processor library (Jackson or Boon) on the classpath.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO24-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Set to <code class="literal">false</code> to disable the inclusion of <code class="literal">sequenceSize</code> and <code class="literal">sequenceNumber</code> headers in messages.
The default is <code class="literal">true</code>, unless <code class="literal">markers</code> is <code class="literal">true</code>.
When <code class="literal">true</code> and <code class="literal">markers</code> is <code class="literal">true</code>, the markers are included in the sequencing.
When <code class="literal">true</code> and <code class="literal">iterator</code> is <code class="literal">true</code>, the <code class="literal">sequenceSize</code> header is set to <code class="literal">0</code>, because the size is unknown.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO24-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Set to <code class="literal">true</code> to cause a <code class="literal">RequiresReplyException</code> to be thrown if there are no lines in the file.
The default is <code class="literal">false</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO24-7"><span><img src="images/callouts/7.png" alt="7" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Set the charset name to be used when reading text data into <code class="literal">String</code> payloads.
The default is the platform charset.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO24-8"><span><img src="images/callouts/8.png" alt="8" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The header name for the first line to be carried as a header in the messages emitted for the remaining lines.
Since version 5.0.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO24-9"><span><img src="images/callouts/9.png" alt="9" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Set the input channel used to send messages to the splitter.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO24-10"><span><img src="images/callouts/10.png" alt="10" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Set the output channel to which messages are sent.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO24-11"><span><img src="images/callouts/11.png" alt="11" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Set the send timeout.
Only applies if the <code class="literal">output-channel</code> can block&#8201;&#8212;&#8201;such as a full <code class="literal">QueueChannel</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO24-12"><span><img src="images/callouts/12.png" alt="12" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Set to <code class="literal">false</code> to disable automatically starting the splitter when the context is refreshed.
The default is <code class="literal">true</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO24-13"><span><img src="images/callouts/13.png" alt="13" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Set the order of this endpoint if the <code class="literal">input-channel</code> is a <code class="literal">&lt;publish-subscribe-channel/&gt;</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO24-14"><span><img src="images/callouts/14.png" alt="14" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Set the startup phase for the splitter (used when <code class="literal">auto-startup</code> is <code class="literal">true</code>).</p>
</td></tr></table></div>
</div>
<p>The <code class="literal">FileSplitter</code> also splits any text-based <code class="literal">InputStream</code> into lines.
Starting with version 4.3, when used in conjunction with an FTP or SFTP streaming inbound channel adapter or an FTP or SFTP outbound gateway that uses the <code class="literal">stream</code> option to retrieve a file, the splitter automatically closes the session that supports the stream when the file is completely consumed
See <a class="xref" href="ftp.html#ftp-streaming" title="18.5&nbsp;FTP Streaming Inbound Channel Adapter">Section&nbsp;18.5, &#8220;FTP Streaming Inbound Channel Adapter&#8221;</a> and <a class="xref" href="sftp.html#sftp-streaming" title="30.7&nbsp;SFTP Streaming Inbound Channel Adapter">Section&nbsp;30.7, &#8220;SFTP Streaming Inbound Channel Adapter&#8221;</a> as well as <a class="xref" href="ftp.html#ftp-outbound-gateway" title="18.9&nbsp;FTP Outbound Gateway">Section&nbsp;18.9, &#8220;FTP Outbound Gateway&#8221;</a> and <a class="xref" href="sftp.html#sftp-outbound-gateway" title="30.11&nbsp;SFTP Outbound Gateway">Section&nbsp;30.11, &#8220;SFTP Outbound Gateway&#8221;</a> for more information about these facilities.</p>
<p>When using Java configuration, an additional constructor is available, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> FileSplitter(<span class="hl-keyword">boolean</span> iterator, <span class="hl-keyword">boolean</span> markers, <span class="hl-keyword">boolean</span> markersJson)</pre>
</div>
<p>When <code class="literal">markersJson</code> is true, the markers are represented as a JSON string, as long as a suitable JSON processor library (such as Jackson or Boon) is on the classpath.</p>
<p>Version 5.0 introduced the <code class="literal">firstLineAsHeader</code> option to specify that the first line of content is a header (such as column names in a CSV file).
The argument passed to this property is the header name under which the first line is carried as a header in the messages emitted for the remaining lines.
This line is not included in the sequence header (if <code class="literal">applySequence</code> is true) nor in the <code class="literal">lineCount</code> associated with <code class="literal">FileMarker.END</code> .
If a file contains only the header line, the file is treated as empty and, therefore, only <code class="literal">FileMarker</code> instances are emitted during splitting (if markers are enabled&#8201;&#8212;&#8201;otherwise, no messages are emitted).
By default (if no header name is set), the first line is considered to be data and becomes the payload of the first emitted message.</p>
<p>If you need more complex logic about header extraction from the file content (not first line, not the whole content of the line, not one particular header, and so on), consider using  <a class="link" href="messaging-transformation-chapter.html#header-enricher" title="9.2.1&nbsp;Header Enricher">header enricher</a> ahead of the <code class="literal">FileSplitter</code>.
Note that the lines that have been moved to the headers might be filtered downstream from the normal content process.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_with_java_configuration_9" href="#_configuring_with_java_configuration_9"></a>17.4.1&nbsp;Configuring with Java Configuration</h3></div></div></div>

<p>The following Spring Boot application shows an example of how to configure a file splitter with Java configuration:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Splitter(inputChannel="toSplitter")</span></em>
<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> MessageHandler fileSplitter() {
    FileSplitter splitter = <span class="hl-keyword">new</span> FileSplitter(true, true);
    splitter.setApplySequence(true);
    splitter.setOutputChannel(outputChannel);
    <span class="hl-keyword">return</span> splitter;
}</pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_with_the_java_dsl_10" href="#_configuring_with_the_java_dsl_10"></a>17.4.2&nbsp;Configuring with the Java DSL</h3></div></div></div>

<p>The following Spring Boot application shows an example of how to configure a file splitter with the Java DSL:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@SpringBootApplication</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> FileSplitterApplication {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
        <span class="hl-keyword">new</span> SpringApplicationBuilder(FileSplitterApplication.<span class="hl-keyword">class</span>)
            .web(false)
            .run(args);
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> IntegrationFlow fileSplitterFlow() {
        <span class="hl-keyword">return</span> IntegrationFlows
            .from(Files.inboundAdapter(tmpDir.getRoot())
                 .filter(<span class="hl-keyword">new</span> ChainFileListFilter&lt;File&gt;()
                        .addFilter(<span class="hl-keyword">new</span> AcceptOnceFileListFilter&lt;&gt;())
                        .addFilter(<span class="hl-keyword">new</span> ExpressionFileListFilter&lt;&gt;(
                             <span class="hl-keyword">new</span> FunctionExpression&lt;File&gt;(f -&gt; <span class="hl-string">"foo.tmp"</span>.equals(f.getName()))))))
            .split(Files.splitter()
                     .markers()
                     .charset(StandardCharsets.US_ASCII)
                     .firstLineAsHeader(<span class="hl-string">"fileHeader"</span>)
                     .applySequence(true))
            .channel(c -&gt; c.queue(<span class="hl-string">"fileSplittingResultChannel"</span>))
            .get();
    }

}</pre>
</div>
</div>
</div>
</div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="feed.html">Prev</a>&nbsp;</td><td width="20%" align="center"><a accesskey="u" href="spring-integration-endpoints.html">Up</a></td><td width="40%" align="right">&nbsp;<a accesskey="n" href="ftp.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">16.&nbsp;Feed Adapter&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top">&nbsp;18.&nbsp;FTP/FTPS Adapters</td></tr></table></div></body></html>