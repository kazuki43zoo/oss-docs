<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>8.&nbsp;Message Routing</title><link rel="stylesheet" type="text/css" href="css/manual-multipage.css"><meta name="generator" content="DocBook XSL Stylesheets V1.78.1"><link rel="home" href="index.html" title="Spring Integration Reference Manual"><link rel="up" href="spring-integration-core-messaging.html" title="Part&nbsp;IV.&nbsp;Core Messaging"><link rel="prev" href="message.html" title="7.&nbsp;Message"><link rel="next" href="messaging-transformation-chapter.html" title="9.&nbsp;Message Transformation"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">8.&nbsp;Message Routing</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="message.html">Prev</a>&nbsp;</td><th width="60%" align="center">Part&nbsp;IV.&nbsp;Core Messaging</th><td width="20%" align="right">&nbsp;<a accesskey="n" href="messaging-transformation-chapter.html">Next</a></td></tr></table><hr></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="messaging-routing-chapter" href="#messaging-routing-chapter"></a>8.&nbsp;Message Routing</h2></div></div></div>

<p>This chapter covers the details of using Spring Integration to route messages.</p>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="router" href="#router"></a>8.1&nbsp;Routers</h2></div></div></div>

<p>This section covers how routers work.
It includes the following topics:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="xref" href="messaging-routing-chapter.html#router-overview" title="8.1.1&nbsp;Overview">Section&nbsp;8.1.1, &#8220;Overview&#8221;</a>
</li><li class="listitem">
<a class="xref" href="messaging-routing-chapter.html#router-common-parameters" title="8.1.2&nbsp;Common Router Parameters">Section&nbsp;8.1.2, &#8220;Common Router Parameters&#8221;</a>
</li><li class="listitem">
<a class="xref" href="messaging-routing-chapter.html#router-implementations" title="8.1.3&nbsp;Router Implementations">Section&nbsp;8.1.3, &#8220;Router Implementations&#8221;</a>
</li><li class="listitem">
<a class="xref" href="messaging-routing-chapter.html#router-namespace" title="8.1.4&nbsp;Configuring a Generic Router">Section&nbsp;8.1.4, &#8220;Configuring a Generic Router&#8221;</a>
</li><li class="listitem">
<a class="xref" href="messaging-routing-chapter.html#router-spel" title="8.1.5&nbsp;Routers and the Spring Expression Language (SpEL)">Section&nbsp;8.1.5, &#8220;Routers and the Spring Expression Language (SpEL)&#8221;</a>
</li><li class="listitem">
<a class="xref" href="messaging-routing-chapter.html#dynamic-routers" title="8.1.6&nbsp;Dynamic Routers">Section&nbsp;8.1.6, &#8220;Dynamic Routers&#8221;</a>
</li></ul></div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="router-overview" href="#router-overview"></a>8.1.1&nbsp;Overview</h3></div></div></div>

<p>Routers are a crucial element in many messaging architectures.
They consume messages from a message channel and forward each consumed message to one or more different message channels depending on a set of conditions.</p>
<p>Spring Integration provides the following routers:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="messaging-routing-chapter.html#router-implementations-payloadtyperouter" title="PayloadTypeRouter">Payload Type Router</a>
</li><li class="listitem">
<a class="link" href="messaging-routing-chapter.html#router-implementations-headervaluerouter" title="HeaderValueRouter">Header Value Router</a>
</li><li class="listitem">
<a class="link" href="messaging-routing-chapter.html#router-implementations-recipientlistrouter" title="RecipientListRouter">Recipient List Router</a>
</li><li class="listitem">
<a class="link" href="xml.html#xml-xpath-routing" title="38.5&nbsp;Routing XML Messages with XPath">XPath Router (part of the XML module)</a>
</li><li class="listitem">
<a class="link" href="messaging-routing-chapter.html#router-implementations-exception-router" title="Routing and Error Handling">Error Message Exception Type Router</a>
</li><li class="listitem">
<a class="link" href="messaging-routing-chapter.html#router-namespace" title="8.1.4&nbsp;Configuring a Generic Router">(Generic) Router</a>
</li></ul></div>
<p>Router implementations share many configuration parameters.
However, certain differences exist between routers.
Furthermore, the availability of configuration parameters depends on whether routers are used inside or outside of a chain.
In order to provide a quick overview, all available attributes are listed in the two following tables .</p>
<p>The following table shows the configuration parameters available for a router outside of a chain:</p>
<div class="table"><a name="d5e2460" href="#d5e2460"></a><p class="title"><b>Table&nbsp;8.1.&nbsp;Routers Outside of a Chain</b></p><div class="table-contents">

<table summary="Routers Outside of a Chain" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"><col class="col_4"><col class="col_5"><col class="col_6"><col class="col_7"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Attribute</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">router</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">header value router</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">xpath router</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">payload type router</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">recipient list route</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">exception type router</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>apply-sequence</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>default-output-channel</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>resolution-required</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>ignore-send-failures</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>timeout</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>id</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>auto-startup</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>input-channel</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>order</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>method</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>ref</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>expression</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>header-name</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>evaluate-as-string</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>xpath-expression-ref</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>converter</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="" align="left" valign="top">&nbsp;</td></tr></tbody></table>
</div></div><br class="table-break">
<p>The following table shows the configuration parameters available for a router inside of a chain:</p>
<div class="table"><a name="d5e2991" href="#d5e2991"></a><p class="title"><b>Table&nbsp;8.2.&nbsp;Routers Inside of a Chain</b></p><div class="table-contents">

<table summary="Routers Inside of a Chain" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"><col class="col_4"><col class="col_5"><col class="col_6"><col class="col_7"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Attribute</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">router</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">header value router</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">xpath router</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">payload type router</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">recipient list router</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">exception type router</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>apply-sequence</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>default-output-channel</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>resolution-required</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>ignore-send-failures</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>timeout</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>id</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>auto-startup</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>input-channel</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>order</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>method</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>ref</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>expression</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>header-name</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>evaluate-as-string</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>xpath-expression-ref</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>converter</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="" align="left" valign="top">&nbsp;</td></tr></tbody></table>
</div></div><br class="table-break">
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>As of Spring Integration 2.1, router parameters have been more standardized across all router implementations.
Consequently, a few minor changes may break older Spring Integration based applications.</p>
<p>Since Spring Integration 2.1, the <code class="literal">ignore-channel-name-resolution-failures</code> attribute is removed in favor of consolidating its behavior with the <code class="literal">resolution-required</code> attribute.
Also, the <code class="literal">resolution-required</code> attribute now defaults to <code class="literal">true</code>.</p>
<p>Prior to these changes, the <code class="literal">resolution-required</code> attribute defaulted to <code class="literal">false</code>, causing messages to be silently dropped when no channel was resolved and no <code class="literal">default-output-channel</code> was set.
The new behavior requires at least one resolved channel and, by default, throws a <code class="literal">MessageDeliveryException</code> if no channel was determined (or an attempt to send was not successful).</p>
<p>If you do desire to drop messages silently, you can set <code class="literal">default-output-channel="nullChannel"</code>.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="router-common-parameters" href="#router-common-parameters"></a>8.1.2&nbsp;Common Router Parameters</h3></div></div></div>

<p>This section describes the parameters common to all router parameters (the parameters with all their boxes ticked in the two tables shown earlier in this chapter).</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="router-common-parameters-all" href="#router-common-parameters-all"></a>Inside and Outside of a Chain</h4></div></div></div>

<p>The following parameters are valid for all routers inside and outside of chains.</p>
<div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">apply-sequence</code></span></dt><dd>
This attribute specifies whether sequence number and size headers should be added to each message.
This optional attribute defaults to <code class="literal">false</code>.
</dd><dt><span class="term"><code class="literal">default-output-channel</code></span></dt><dd>
<p class="simpara">If set, this attribute provides a reference to the channel where messages should be sent if channel resolution fails to return any channels.
If no default output channel is provided, the router throws an exception.
If you would like to silently drop those messages instead, set the default output channel attribute value to <code class="literal">nullChannel</code>.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>A message is sent only to the <code class="literal">default-output-channel</code> if <code class="literal">resolution-required</code> is <code class="literal">false</code> and the channel is not resolved.</p>
</td></tr></table></div>
</dd><dt><span class="term"><code class="literal">resolution-required</code></span></dt><dd>
<p class="simpara">This attribute specifies whether channel names must always be successfully resolved to channel instances that exist.
If set to <code class="literal">true</code>, a <code class="literal">MessagingException</code> is raised when the channel cannot be resolved.
Setting this attribute to <code class="literal">false</code> causes any unresovable channels to be ignored.
This optional attribute defaults to <code class="literal">true</code>.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>A Message is sent only to the <code class="literal">default-output-channel</code>, if specified, when <code class="literal">resolution-required</code> is <code class="literal">false</code> and the channel is not resolved.</p>
</td></tr></table></div>
</dd><dt><span class="term"><code class="literal">ignore-send-failures</code></span></dt><dd>
<p class="simpara">If set to <code class="literal">true</code>, failures to send to a message channel is ignored.
If set to <code class="literal">false</code>, a <code class="literal">MessageDeliveryException</code> is thrown instead, and, if the router resolves more than one channel, any subsequent channels do not receive the message.</p>
<p class="simpara">The exact behavior of this attribute depends on the type of the <code class="literal">Channel</code> to which the messages are sent.
For example, when using direct channels (single threaded), send failures can be caused by exceptions thrown by components much further downstream.
However, when sending messages to a simple queue channel (asynchronous), the likelihood of an exception to be thrown is rather remote.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>While most routers route to a single channel, they can return more than one channel name.
The <code class="literal">recipient-list-router</code>, for instance, does exactly that.
If you set this attribute to <code class="literal">true</code> on a router that only routes to a single channel, any caused exception is swallowed, which usually makes little sense.
In that case, it would be better to catch the exception in an error flow at the flow entry point.
Therefore, setting the <code class="literal">ignore-send-failures</code> attribute to <code class="literal">true</code> usually makes more sense when the router implementation returns more than one channel name, because the other channel(s) following the one that fails would still receive the message.</p>
</td></tr></table></div>
<p class="simpara">This attribute defaults to <code class="literal">false</code>.</p>
</dd><dt><span class="term"><code class="literal">timeout</code></span></dt><dd>
The <code class="literal">timeout</code> attribute specifies the maximum amount of time in milliseconds to wait when sending messages to the target Message Channels.
By default, the send operation blocks indefinitely.
</dd></dl></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="router-common-parameters-top" href="#router-common-parameters-top"></a>Top-Level (Outside of a Chain)</h4></div></div></div>

<p>The following parameters are valid only across all top-level routers that are outside of chains.</p>
<div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">id</code></span></dt><dd>
Identifies the underlying Spring bean definition, which, in the case of routers, is an instance of <code class="literal">EventDrivenConsumer</code> or <code class="literal">PollingConsumer</code>, depending on whether the router&#8217;s <code class="literal">input-channel</code> is a <code class="literal">SubscribableChannel</code> or a <code class="literal">PollableChannel</code>, respectively.
This is an optional attribute.
</dd><dt><span class="term"><code class="literal">auto-startup</code></span></dt><dd>
This "<code class="literal">lifecycle</code>" attribute signaled whether this component should be started during startup of the application context.
This optional attribute defaults to <code class="literal">true</code>.
</dd><dt><span class="term"><code class="literal">input-channel</code></span></dt><dd>
The receiving message channel of this endpoint.
</dd><dt><span class="term"><code class="literal">order</code></span></dt><dd>
This attribute defines the order for invocation when this endpoint is connected as a subscriber to a channel.
This is particularly relevant when that channel uses a failover dispatching strategy.
It has no effect when this endpoint itself is a polling consumer for a channel with a queue.
</dd></dl></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="router-implementations" href="#router-implementations"></a>8.1.3&nbsp;Router Implementations</h3></div></div></div>

<p>Since content-based routing often requires some domain-specific logic, most use cases require Spring Integration&#8217;s options for delegating to POJOs by using either the XML namespace support or annotations.
Both of these are discussed later.
However, we first present a couple of implementations that fulfill common requirements.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="router-implementations-payloadtyperouter" href="#router-implementations-payloadtyperouter"></a><code class="literal">PayloadTypeRouter</code></h4></div></div></div>

<p>A <code class="literal">PayloadTypeRouter</code> sends messages to the channel defined by payload-type mappings, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"payloadTypeRouter"</span>
      <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.router.PayloadTypeRouter"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"channelMapping"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;map&gt;</span>
            <span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"java.lang.String"</span> <span class="hl-attribute">value-ref</span>=<span class="hl-value">"stringChannel"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"java.lang.Integer"</span> <span class="hl-attribute">value-ref</span>=<span class="hl-value">"integerChannel"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/map&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
</div>
<p>Configuration of the <code class="literal">PayloadTypeRouter</code> is also supported by the namespace provided by Spring Integration (see <code class="literal">&lt;&lt;configuration-namespace&gt;&gt;</code>), which essentially simplifies configuration by combining the <code class="literal">&lt;router/&gt;</code> configuration and its corresponding implementation (defined by using a <code class="literal">&lt;bean/&gt;</code> element) into a single and more concise configuration element.
The following example shows a <code class="literal">PayloadTypeRouter</code> configuration that is equivalent to the one above but uses the namespace support:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:payload-type-router</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"routingChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:mapping</span> <span class="hl-attribute">type</span>=<span class="hl-value">"java.lang.String"</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"stringChannel"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;int:mapping</span> <span class="hl-attribute">type</span>=<span class="hl-value">"java.lang.Integer"</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"integerChannel"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/int:payload-type-router&gt;</span></pre>
</div>
<p>The following example shows the equivalent router configured in Java:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "routingChannel")</span></em>
<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> PayloadTypeRouter router() {
    PayloadTypeRouter router = <span class="hl-keyword">new</span> PayloadTypeRouter();
    router.setChannelMapping(String.<span class="hl-keyword">class</span>.getName(), <span class="hl-string">"stringChannel"</span>);
    router.setChannelMapping(Integer.<span class="hl-keyword">class</span>.getName(), <span class="hl-string">"integerChannel"</span>);
    <span class="hl-keyword">return</span> router;
}</pre>
</div>
<p>When using the Java DSL, there are two options.</p>
<p>First, you can define the router object as shown in the preceding example:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> IntegrationFlow routerFlow1() {
    <span class="hl-keyword">return</span> IntegrationFlows.from(<span class="hl-string">"routingChannel"</span>)
            .route(router())
            .get();
}

<span class="hl-keyword">public</span> PayloadTypeRouter router() {
    PayloadTypeRouter router = <span class="hl-keyword">new</span> PayloadTypeRouter();
    router.setChannelMapping(String.<span class="hl-keyword">class</span>.getName(), <span class="hl-string">"stringChannel"</span>);
    router.setChannelMapping(Integer.<span class="hl-keyword">class</span>.getName(), <span class="hl-string">"integerChannel"</span>);
    <span class="hl-keyword">return</span> router;
}</pre>
<p>Note that the router can be, but does not have to be, a <code class="literal">@Bean</code>.
The flow registers it if it is not a <code class="literal">@Bean</code>.</p>
<p>Second, you can define the routing function within the DSL flow itself, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> IntegrationFlow routerFlow2() {
    <span class="hl-keyword">return</span> IntegrationFlows.from(<span class="hl-string">"routingChannel"</span>)
            .&lt;Object, Class&lt;?&gt;&gt;route(Object::getClass, m -&gt; m
                    .channelMapping(String.<span class="hl-keyword">class</span>, <span class="hl-string">"stringChannel"</span>)
                    .channelMapping(Integer.<span class="hl-keyword">class</span>, <span class="hl-string">"integerChannel"</span>))
            .get();
}</pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="router-implementations-headervaluerouter" href="#router-implementations-headervaluerouter"></a><code class="literal">HeaderValueRouter</code></h4></div></div></div>

<p>A <code class="literal">HeaderValueRouter</code> sends Messages to the channel based on the individual header value mappings.
When a <code class="literal">HeaderValueRouter</code> is created, it is initialized with the name of the header to be evaluated.
The value of the header could be one of two things:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
An arbitrary value
</li><li class="listitem">
A channel name
</li></ul></div>
<p>If it is an arbitrary value, additional mappings for these header values to channel names are required.
Otherwise, no additional configuration is needed.</p>
<p>Spring Integration provides a simple namespace-based XML configuration to configure a <code class="literal">HeaderValueRouter</code>.
The following example demonstrates configuration for the <code class="literal">HeaderValueRouter</code> when mapping of header values to channels is required:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:header-value-router</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"routingChannel"</span> <span class="hl-attribute">header-name</span>=<span class="hl-value">"testHeader"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:mapping</span> <span class="hl-attribute">value</span>=<span class="hl-value">"someHeaderValue"</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"channelA"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;int:mapping</span> <span class="hl-attribute">value</span>=<span class="hl-value">"someOtherHeaderValue"</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"channelB"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/int:header-value-router&gt;</span></pre>
</div>
<p>During the resolution process, the router defined in the preceding example may encounter channel resolution failures, causing an exception.
If you want to suppress such exceptions and send unresolved messages to the default output channel (identified with the <code class="literal">default-output-channel</code> attribute) set <code class="literal">resolution-required</code> to <code class="literal">false</code>.</p>
<p>Normally, messages for which the header value is not explicitly mapped to a channel are sent to the <code class="literal">default-output-channel</code>.
However, when the header value is mapped to a channel name but the channel cannot be resolved, setting the <code class="literal">resolution-required</code> attribute to <code class="literal">false</code> results in routing such messages to the <code class="literal">default-output-channel</code>.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>As of Spring Integration 2.1, the attribute was changed from <code class="literal">ignore-channel-name-resolution-failures</code> to <code class="literal">resolution-required</code>.
Attribute <code class="literal">resolution-required</code> defaults to <code class="literal">true</code>.</p>
</td></tr></table></div>
<p>The following example shows the equivalent router configured in Java:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "routingChannel")</span></em>
<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> HeaderValueRouter router() {
    HeaderValueRouter router = <span class="hl-keyword">new</span> HeaderValueRouter(<span class="hl-string">"testHeader"</span>);
    router.setChannelMapping(<span class="hl-string">"someHeaderValue"</span>, <span class="hl-string">"channelA"</span>);
    router.setChannelMapping(<span class="hl-string">"someOtherHeaderValue"</span>, <span class="hl-string">"channelB"</span>);
    <span class="hl-keyword">return</span> router;
}</pre>
</div>
<p>When using the Java DSL, there are two options.
First, you can define the router object as shown in the preceding example:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> IntegrationFlow routerFlow1() {
    <span class="hl-keyword">return</span> IntegrationFlows.from(<span class="hl-string">"routingChannel"</span>)
            .route(router())
            .get();
}

<span class="hl-keyword">public</span> HeaderValueRouter router() {
    HeaderValueRouter router = <span class="hl-keyword">new</span> HeaderValueRouter(<span class="hl-string">"testHeader"</span>);
    router.setChannelMapping(<span class="hl-string">"someHeaderValue"</span>, <span class="hl-string">"channelA"</span>);
    router.setChannelMapping(<span class="hl-string">"someOtherHeaderValue"</span>, <span class="hl-string">"channelB"</span>);
    <span class="hl-keyword">return</span> router;
}</pre>
</div>
<p>Note that the router can be, but does not have to be, a <code class="literal">@Bean</code>.
The flow registers it if it is not a <code class="literal">@Bean</code>.</p>
<p>Second, you can define the routing function within the DSL flow itself, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> IntegrationFlow routerFlow2() {
    <span class="hl-keyword">return</span> IntegrationFlows.from(<span class="hl-string">"routingChannel"</span>)
            .&lt;Message&lt;?&gt;, String&gt;route(m -&gt; m.getHeaders().get(<span class="hl-string">"testHeader"</span>, String.<span class="hl-keyword">class</span>), m -&gt; m
                    .channelMapping(<span class="hl-string">"someHeaderValue"</span>, <span class="hl-string">"channelA"</span>)
                    .channelMapping(<span class="hl-string">"someOtherHeaderValue"</span>, <span class="hl-string">"channelB"</span>),
                e -&gt; e.id(<span class="hl-string">"headerValueRouter"</span>))
            .get();
}</pre>
</div>
<p>Configuration where mapping of header values to channel names is not required, because header values themselves represent channel names.
The following example shows a router that does not require mapping of header values to channel names:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:header-value-router</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"routingChannel"</span> <span class="hl-attribute">header-name</span>=<span class="hl-value">"testHeader"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Since Spring Integration 2.1, the behavior of resolving channels is more explicit.
For example, if you omit the <code class="literal">default-output-channel</code> attribute, the router was unable to resolve at least one valid channel, and any channel name resolution failures were ignored by setting <code class="literal">resolution-required</code> to <code class="literal">false</code>, then a <code class="literal">MessageDeliveryException</code> is thrown.</p>
<p>Basically, by default, the router must be able to route messages successfully to at least one channel.
If you really want to drop messages, you must also have <code class="literal">default-output-channel</code> set to <code class="literal">nullChannel</code>.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="router-implementations-recipientlistrouter" href="#router-implementations-recipientlistrouter"></a><code class="literal">RecipientListRouter</code></h4></div></div></div>

<p>A <code class="literal">RecipientListRouter</code> sends each received message to a statically defined list of message channels.
The following example creates a <code class="literal">RecipientListRouter</code>:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"recipientListRouter"</span>
      <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.router.RecipientListRouter"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"channels"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;list&gt;</span>
            <span class="hl-tag">&lt;ref</span> <span class="hl-attribute">bean</span>=<span class="hl-value">"channel1"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;ref</span> <span class="hl-attribute">bean</span>=<span class="hl-value">"channel2"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;ref</span> <span class="hl-attribute">bean</span>=<span class="hl-value">"channel3"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/list&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
</div>
<p>Spring Integration also provides namespace support for the <code class="literal">RecipientListRouter</code> configuration (see <a class="xref" href="configuration.html#configuration-namespace" title="E.1&nbsp;Namespace Support">Section&nbsp;E.1, &#8220;Namespace Support&#8221;</a>) as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:recipient-list-router</span> <span class="hl-attribute">id</span>=<span class="hl-value">"customRouter"</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"routingChannel"</span>
        <span class="hl-attribute">timeout</span>=<span class="hl-value">"1234"</span>
        <span class="hl-attribute">ignore-send-failures</span>=<span class="hl-value">"true"</span>
        <span class="hl-attribute">apply-sequence</span>=<span class="hl-value">"true"</span><span class="hl-tag">&gt;</span>
  <span class="hl-tag">&lt;int:recipient</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"channel1"</span><span class="hl-tag">/&gt;</span>
  <span class="hl-tag">&lt;int:recipient</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"channel2"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:recipient-list-router&gt;</span></pre>
</div>
<p>The following example shows the equivalent router configured in Java:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "routingChannel")</span></em>
<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> RecipientListRouter router() {
    RecipientListRouter router = <span class="hl-keyword">new</span> RecipientListRouter();
    router.setSendTimeout(<span class="hl-number">1</span>_<span class="hl-number">234L</span>);
    router.setIgnoreSendFailures(true);
    router.setApplySequence(true);
    router.addRecipient(<span class="hl-string">"channel1"</span>);
    router.addRecipient(<span class="hl-string">"channel2"</span>);
    router.addRecipient(<span class="hl-string">"channel3"</span>);
    <span class="hl-keyword">return</span> router;
}</pre>
</div>
<p>The following example shows the equivalent router configured by using the Java DSL:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> IntegrationFlow routerFlow() {
    <span class="hl-keyword">return</span> IntegrationFlows.from(<span class="hl-string">"routingChannel"</span>)
            .routeToRecipients(r -&gt; r
                    .applySequence(true)
                    .ignoreSendFailures(true)
                    .recipient(<span class="hl-string">"channel1"</span>)
                    .recipient(<span class="hl-string">"channel2"</span>)
                    .recipient(<span class="hl-string">"channel3"</span>)
                    .sendTimeout(<span class="hl-number">1</span>_<span class="hl-number">234L</span>))
            .get();
}</pre>
</div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The <span class="emphasis"><em>apply-sequence</em></span> flag here has the same effect as it does for a publish-subscribe-channel, and, as with a publish-subscribe-channel, it is disabled by default on the <code class="literal">recipient-list-router</code>.
See <a class="xref" href="messaging-channels-section.html#channel-configuration-pubsubchannel" title="PublishSubscribeChannel Configuration">the section called &#8220;<code class="literal">PublishSubscribeChannel</code> Configuration&#8221;</a> for more information.</p>
</td></tr></table></div>
<p>Another convenient option when configuring a <code class="literal">RecipientListRouter</code> is to use Spring Expression Language (SpEL) support as selectors for individual recipient channels.
Doing so is similar to using a filter at the beginning of a <span class="emphasis"><em>chain</em></span> to act as a "<code class="literal">selective consumer</code>".
However, in this case, it is all combined rather concisely into the router&#8217;s configuration, as the following example shows:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:recipient-list-router</span> <span class="hl-attribute">id</span>=<span class="hl-value">"customRouter"</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"routingChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:recipient</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"channel1"</span> <span class="hl-attribute">selector-expression</span>=<span class="hl-value">"payload.equals('foo')"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int:recipient</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"channel2"</span> <span class="hl-attribute">selector-expression</span>=<span class="hl-value">"headers.containsKey('bar')"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:recipient-list-router&gt;</span></pre>
<p>In the preceding configuration, a SpEL expression identified by the <code class="literal">selector-expression</code> attribute is evaluated to determine whether this recipient should be included in the recipient list for a given input message.
The evaluation result of the expression must be a boolean.
If this attribute is not defined, the channel is always among the list of recipients.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="recipient-list-router-management" href="#recipient-list-router-management"></a><code class="literal">RecipientListRouterManagement</code></h4></div></div></div>

<p>Starting with version 4.1, the <code class="literal">RecipientListRouter</code> provides several operations to manipulate recipients dynamically at runtime.
These management operations are presented by <code class="literal">RecipientListRouterManagement</code> through the <code class="literal">@ManagedResource</code> annotation.
They are available by using <a class="xref" href="system-management-chapter.html#control-bus" title="12.6&nbsp;Control Bus">Section&nbsp;12.6, &#8220;Control Bus&#8221;</a> as well as by using JMX, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;control-bus</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"controlBus"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;recipient-list-router</span> <span class="hl-attribute">id</span>=<span class="hl-value">"simpleRouter"</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"routingChannelA"</span><span class="hl-tag">&gt;</span>
   <span class="hl-tag">&lt;recipient</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"channel1"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/recipient-list-router&gt;</span>

<span class="hl-tag">&lt;channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"channel2"</span><span class="hl-tag">/&gt;</span></pre>
<pre class="programlisting">messagingTemplate.convertAndSend(controlBus, <span class="hl-string">"@'simpleRouter.handler'.addRecipient('channel2')"</span>);</pre>
</div>
<p>From the application start up the <code class="literal">simpleRouter</code>, has only one <code class="literal">channel1</code> recipient.
But after the <code class="literal">addRecipient</code> command, <code class="literal">channel2</code> recipient is added.
It is a "<code class="literal">registering an interest in something that is part of the message</code>" use case, when we may be interested in messages from the router at some time period, so we are subscribing to the the <code class="literal">recipient-list-router</code> and, at some point, decide to unsubscribe.</p>
<p>Because of the runtime management operation for the <code class="literal">&lt;recipient-list-router&gt;</code>, it can be configured without any <code class="literal">&lt;recipient&gt;</code> from the start.
In this case, the behavior of <code class="literal">RecipientListRouter</code> is the same when there is no one matching recipient for the message.
If <code class="literal">defaultOutputChannel</code> is configured, the message is sent there.
Otherwise the <code class="literal">MessageDeliveryException</code> is thrown.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="router-implementations-xpath-router" href="#router-implementations-xpath-router"></a>XPath Router</h4></div></div></div>

<p>The XPath Router is part of the XML Module.
See <a class="xref" href="xml.html#xml-xpath-routing" title="38.5&nbsp;Routing XML Messages with XPath">Section&nbsp;38.5, &#8220;Routing XML Messages with XPath&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="router-implementations-exception-router" href="#router-implementations-exception-router"></a>Routing and Error Handling</h4></div></div></div>

<p>Spring Integration also provides a special type-based router called <code class="literal">ErrorMessageExceptionTypeRouter</code> for routing error messages (defined as messages whose <code class="literal">payload</code> is a <code class="literal">Throwable</code> instance).
<code class="literal">ErrorMessageExceptionTypeRouter</code> is similar to the <code class="literal">PayloadTypeRouter</code>.
In fact, they are almost identical.
The only difference is that, while <code class="literal">PayloadTypeRouter</code> navigates the instance hierarchy of a payload instance (for example, <code class="literal">payload.getClass().getSuperclass()</code>) to find the most specific type and channel mappings,
the <code class="literal">ErrorMessageExceptionTypeRouter</code> navigates the hierarchy of <span class="emphasis"><em>exception causes</em></span> (for example, <code class="literal">payload.getCause()</code>)
to find the most specific <code class="literal">Throwable</code> type or channel mappings and uses <code class="literal">mappingClass.isInstance(cause)</code> to match the
<code class="literal">cause</code> to the class or any super class.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Since version 4.3 the <code class="literal">ErrorMessageExceptionTypeRouter</code> loads all mapping classes during the initialization
phase to fail-fast for a <code class="literal">ClassNotFoundException</code>.</p>
</td></tr></table></div>
<p>The following example shows a sample configuration for <code class="literal">ErrorMessageExceptionTypeRouter</code>:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:exception-type-router</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"inputChannel"</span>
                           <span class="hl-attribute">default-output-channel</span>=<span class="hl-value">"defaultChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:mapping</span> <span class="hl-attribute">exception-type</span>=<span class="hl-value">"java.lang.IllegalArgumentException"</span>
                 <span class="hl-attribute">channel</span>=<span class="hl-value">"illegalChannel"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int:mapping</span> <span class="hl-attribute">exception-type</span>=<span class="hl-value">"java.lang.NullPointerException"</span>
                 <span class="hl-attribute">channel</span>=<span class="hl-value">"npeChannel"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:exception-type-router&gt;</span>

<span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"illegalChannel"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"npeChannel"</span><span class="hl-tag"> /&gt;</span></pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="router-namespace" href="#router-namespace"></a>8.1.4&nbsp;Configuring a Generic Router</h3></div></div></div>

<p>Spring Integration provides a generic router. You can use it for general-purpose routing (as opposed to the other routers provided by Spring Integration, each of which has some form of specialization).</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_configuring_a_content_based_router_with_xml" href="#_configuring_a_content_based_router_with_xml"></a>Configuring a Content-based Router with XML</h4></div></div></div>

<p>The <code class="literal">router</code> element provides a way to connect a router to an input channel and also accepts the optional <code class="literal">default-output-channel</code> attribute.
The <code class="literal">ref</code> attribute references the bean name of a custom router implementation (which must extend <code class="literal">AbstractMessageRouter</code>).
The following example shows three generic routers:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:router</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"payloadTypeRouter"</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input1"</span>
            <span class="hl-attribute">default-output-channel</span>=<span class="hl-value">"defaultOutput1"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int:router</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"recipientListRouter"</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input2"</span>
            <span class="hl-attribute">default-output-channel</span>=<span class="hl-value">"defaultOutput2"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int:router</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"customRouter"</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input3"</span>
            <span class="hl-attribute">default-output-channel</span>=<span class="hl-value">"defaultOutput3"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;beans:bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"customRouterBean"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.foo.MyCustomRouter"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>Alternatively, <code class="literal">ref</code> may point to a POJO that contains the <code class="literal">@Router</code> annotation (shown later), or you can combine the <code class="literal">ref</code> with an explicit method name.
Specifying a method applies the same behavior described in the <code class="literal">@Router</code> annotation section, later in this document.
The following example defines a router that points to a POJO in its <code class="literal">ref</code> attribute:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:router</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"somePojo"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"someMethod"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>We generally recommend using a <code class="literal">ref</code> attribute if the custom router implementation is referenced in other <code class="literal">&lt;router&gt;</code> definitions.
However if the custom router implementation should be scoped to a single definition of the <code class="literal">&lt;router&gt;</code>, you can provide an inner bean definition, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:router</span> <span class="hl-attribute">method</span>=<span class="hl-value">"someMethod"</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input3"</span>
            <span class="hl-attribute">default-output-channel</span>=<span class="hl-value">"defaultOutput3"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;beans:bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.foo.MyCustomRouter"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:router&gt;</span></pre>
</div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Using both the <code class="literal">ref</code> attribute and an inner handler definition in the same <code class="literal">&lt;router&gt;</code> configuration is not allowed.
Doing so creates an ambiguous condition and throws an exception.</p>
</td></tr></table></div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>If the <code class="literal">ref</code> attribute references a bean that extends <code class="literal">AbstractMessageProducingHandler</code> (such as routers provided by the framework itself), the configuration is optimized to reference the router directly.
In this case, each <code class="literal">ref</code> attribute must refer to a separate bean instance (or a <code class="literal">prototype</code>-scoped bean) or use the inner <code class="literal">&lt;bean/&gt;</code> configuration type.
However, this optimization applies only if you do not provide any router-specific attributes in the router XML definition.
If you inadvertently reference the same message handler from multiple beans, you get a configuration exception.</p>
</td></tr></table></div>
<p>The following example shows the equivalent router configured in Java:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<em><span class="hl-annotation" style="color: gray">@Router(inputChannel = "routingChannel")</span></em>
<span class="hl-keyword">public</span> AbstractMessageRouter myCustomRouter() {
    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> AbstractMessageRouter() {

        <em><span class="hl-annotation" style="color: gray">@Override</span></em>
        <span class="hl-keyword">protected</span> Collection&lt;MessageChannel&gt; determineTargetChannels(Message&lt;?&gt; message) {
            <span class="hl-keyword">return</span> <span class="hl-comment">// determine channel(s) for message</span>
        }

    };
}</pre>
</div>
<p>The following example shows the equivalent router configured by using the Java DSL:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> IntegrationFlow routerFlow() {
    <span class="hl-keyword">return</span> IntegrationFlows.from(<span class="hl-string">"routingChannel"</span>)
            .route(myCustomRouter())
            .get();
}

<span class="hl-keyword">public</span> AbstractMessageRouter myCustomRouter() {
    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> AbstractMessageRouter() {

        <em><span class="hl-annotation" style="color: gray">@Override</span></em>
        <span class="hl-keyword">protected</span> Collection&lt;MessageChannel&gt; determineTargetChannels(Message&lt;?&gt; message) {
            <span class="hl-keyword">return</span> <span class="hl-comment">// determine channel(s) for message</span>
        }

    };
}</pre>
</div>
<p>Alternately, you can route on data from the message payload, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> IntegrationFlow routerFlow() {
    <span class="hl-keyword">return</span> IntegrationFlows.from(<span class="hl-string">"routingChannel"</span>)
            .route(String.<span class="hl-keyword">class</span>, p -&gt; p.contains(<span class="hl-string">"foo"</span>) ? <span class="hl-string">"fooChannel"</span> : <span class="hl-string">"barChannel"</span>)
            .get();
}</pre>
</div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="router-spel" href="#router-spel"></a>8.1.5&nbsp;Routers and the Spring Expression Language (SpEL)</h3></div></div></div>

<p>Sometimes, the routing logic may be simple, and writing a separate class for it and configuring it as a bean may seem like overkill.
As of Spring Integration 2.0, we offer an alternative that lets you use SpEL to implement simple computations that previously required a custom POJO router.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>For more information about the Spring Expression Language, see the <a class="ulink" href="https://docs.spring.io/spring/docs/current/spring-framework-reference/core.html#expressions" target="_top">relevant chapter in the Spring Framework Reference Guide</a>:</p>
</td></tr></table></div>
<p>Generally, a SpEL expression is evaluated and its result is mapped to a channel, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:router</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"inChannel"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"payload.paymentType"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:mapping</span> <span class="hl-attribute">value</span>=<span class="hl-value">"CASH"</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"cashPaymentChannel"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int:mapping</span> <span class="hl-attribute">value</span>=<span class="hl-value">"CREDIT"</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"authorizePaymentChannel"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int:mapping</span> <span class="hl-attribute">value</span>=<span class="hl-value">"DEBIT"</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"authorizePaymentChannel"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:router&gt;</span></pre>
</div>
<p>The following example shows the equivalent router configured in Java:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Router(inputChannel = "routingChannel")</span></em>
<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> ExpressionEvaluatingRouter router() {
    ExpressionEvaluatingRouter router = <span class="hl-keyword">new</span> ExpressionEvaluatingRouter(<span class="hl-string">"payload.paymentType"</span>);
    router.setChannelMapping(<span class="hl-string">"CASH"</span>, <span class="hl-string">"cashPaymentChannel"</span>);
    router.setChannelMapping(<span class="hl-string">"CREDIT"</span>, <span class="hl-string">"authorizePaymentChannel"</span>);
    router.setChannelMapping(<span class="hl-string">"DEBIT"</span>, <span class="hl-string">"authorizePaymentChannel"</span>);
    <span class="hl-keyword">return</span> router;
}</pre>
</div>
<p>The following example shows the equivalent router configured in the Java DSL:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> IntegrationFlow routerFlow() {
    <span class="hl-keyword">return</span> IntegrationFlows.from(<span class="hl-string">"routingChannel"</span>)
        .route(<span class="hl-string">"payload.paymentType"</span>, r -&gt; r
            .channelMapping(<span class="hl-string">"CASH"</span>, <span class="hl-string">"cashPaymentChannel"</span>)
            .channelMapping(<span class="hl-string">"CREDIT"</span>, <span class="hl-string">"authorizePaymentChannel"</span>)
            .channelMapping(<span class="hl-string">"DEBIT"</span>, <span class="hl-string">"authorizePaymentChannel"</span>))
        .get();
}</pre>
</div>
<p>To simplify things even more, the SpEL expression may evaluate to a channel name, as the following expression shows:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:router</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"inChannel"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"payload + 'Channel'"</span><span class="hl-tag">/&gt;</span></pre>
<p>In the preceding configuration, the result channel is computed by the SpEL expression, which concatenates the value of the <code class="literal">payload</code> with the literal <code class="literal">String</code>, <span class="emphasis"><em>Channel</em></span>.</p>
<p>Another virtue of SpEL for configuring routers is that an expression can return a <code class="literal">Collection</code>, effectively making every <code class="literal">&lt;router&gt;</code> a recipient list router.
Whenever the expression returns multiple channel values, the message is forwarded to each channel.
The following example shows such an expression:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:router</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"inChannel"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"headers.channels"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>In the above configuration, if the message includes a header with a name of <span class="emphasis"><em>channels</em></span> and the value of that header is a <code class="literal">List</code> of channel names, the message is sent to each channel in the list.
You may also find collection projection and collection selection expressions useful when you need to select multiple channels.
For further information, see:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="ulink" href="http://static.springsource.org/spring/docs/current/spring-framework-reference/html/expressions.html#expressions-collection-projection" target="_top">Collection Projection</a>
</li><li class="listitem">
<a class="ulink" href="http://static.springsource.org/spring/docs/current/spring-framework-reference/html/expressions.html#expressions-collection-selection" target="_top">Collection Selection</a>
</li></ul></div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="router-annotation" href="#router-annotation"></a>Configuring a Router with Annotations</h4></div></div></div>

<p>When using <code class="literal">@Router</code> to annotate a method, the method may return either a <code class="literal">MessageChannel</code> or a <code class="literal">String</code> type.
In the latter case, the endpoint resolves the channel name as it does for the default output channel.
Additionally, the method may return either a single value or a collection.
If a collection is returned, the reply message is sent to multiple channels.
To summarize, the following method signatures are all valid:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Router</span></em>
<span class="hl-keyword">public</span> MessageChannel route(Message message) {...}

<em><span class="hl-annotation" style="color: gray">@Router</span></em>
<span class="hl-keyword">public</span> List&lt;MessageChannel&gt; route(Message message) {...}

<em><span class="hl-annotation" style="color: gray">@Router</span></em>
<span class="hl-keyword">public</span> String route(Foo payload) {...}

<em><span class="hl-annotation" style="color: gray">@Router</span></em>
<span class="hl-keyword">public</span> List&lt;String&gt; route(Foo payload) {...}</pre>
</div>
<p>In addition to payload-based routing, a message may be routed based on metadata available within the message header as either a property or an attribute.
In this case, a method annotated with <code class="literal">@Router</code> may include a parameter annotated with <code class="literal">@Header</code>, which is mapped to a header value as the following example shows and documented in <a class="xref" href="configuration.html#annotations" title="E.5&nbsp;Annotation Support">Section&nbsp;E.5, &#8220;Annotation Support&#8221;</a>:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Router</span></em>
<span class="hl-keyword">public</span> List&lt;String&gt; route(<em><span class="hl-annotation" style="color: gray">@Header("orderStatus")</span></em> OrderStatus status)</pre>
</div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>For routing of XML-based Messages, including XPath support, see <a class="xref" href="xml.html" title="38.&nbsp;XML Support - Dealing with XML Payloads">Chapter&nbsp;38, <i>XML Support - Dealing with XML Payloads</i></a>.</p>
</td></tr></table></div>
<p>See also <a class="xref" href="java-dsl.html#java-dsl-routers" title="11.7&nbsp;Message Routers">Section&nbsp;11.7, &#8220;Message Routers&#8221;</a> in the Java DSL chapter for more information about router configuration.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="dynamic-routers" href="#dynamic-routers"></a>8.1.6&nbsp;Dynamic Routers</h3></div></div></div>

<p>Spring Integration provides quite a few different router configurations for common content-based routing use cases as well as the option of implementing custom routers as POJOs.
For example, <code class="literal">PayloadTypeRouter</code> provides a simple way to configure a router that computes channels based on the payload type of the incoming message while <code class="literal">HeaderValueRouter</code> provides the same convenience in configuring a router that computes channels by evaluating the value of a particular message Header.
There are also expression-based (SpEL) routers, in which the channel is determined based on evaluating an expression.
All of these type of routers exhibit some dynamic characteristics.</p>
<p>However, these routers all require static configuration.
Even in the case of expression-based routers, the expression itself is defined as part of the router configuration, which means that the same expression operating on the same value always results in the computation of the same channel.
This is acceptable in most cases, since such routes are well defined and therefore predictable.
But there are times when we need to change router configurations dynamically so that message flows may be routed to a different channel.</p>
<p>For example, you might want to bring down some part of your system for maintenance and temporarily re-reroute messages to a different message flow.
As another example, you may want to introduce more granularity to your message flow by adding another route to handle a more concrete type of <code class="literal">java.lang.Number</code> (in the case of <code class="literal">PayloadTypeRouter</code>).</p>
<p>Unfortunately, with static router configuration to accomplish either of those goals, you would have to bring down your entire application, change the configuration of the router (change routes), and bring the application back up.
This is obviously not a solution anyone wants.</p>
<p>The <a class="ulink" href="http://www.eaipatterns.com/DynamicRouter.html" target="_top">dynamic router</a> pattern describes the mechanisms by which you can change or configure routers dynamically without bringing down the system or individual routers.&nbsp;</p>
<p>Before we get into the specifics of how Spring Integration supports dynamic routing, we need to consider the typical flow of a router:</p>
<div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
Compute a channel identifier, which is a value calculated by the router once it receives the message.
Typically, it is a String or an instance of the actual <code class="literal">MessageChannel</code>.
</li><li class="listitem">
Resolve the channel identifier to a channel name.
We describe specifics of this process later in this section.
</li><li class="listitem">
Resolve the channel name to the actual <code class="literal">MessageChannel</code>
</li></ol></div>
<p>There is not much that can be done with regard to dynamic routing if Step 1 results in the actual instance of the <code class="literal">MessageChannel</code>, because the <code class="literal">MessageChannel</code> is the final product of any router&#8217;s job.
However, if the first step results in a channel identifier that is not an instance of <code class="literal">MessageChannel</code>, you have quite a few possible ways to influence the process of deriving the <code class="literal">MessageChannel</code>.
Consider the following example of a payload type router:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:payload-type-router</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"routingChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:mapping</span> <span class="hl-attribute">type</span>=<span class="hl-value">"java.lang.String"</span>  <span class="hl-attribute">channel</span>=<span class="hl-value">"channel1"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;int:mapping</span> <span class="hl-attribute">type</span>=<span class="hl-value">"java.lang.Integer"</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"channel2"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/int:payload-type-router&gt;</span></pre>
</div>
<p>Within the context of a payload type router, the three steps mentioned earlier would be realized as follows:</p>
<div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
Compute a channel identifier that is the fully qualified name of the payload type (for example, <code class="literal">java.lang.String</code>).
</li><li class="listitem">
Resolve the channel identifier to a channel name, where the result of the previous step is used to select the appropriate value from the payload type mapping defined in the <code class="literal">mapping</code> element.
</li><li class="listitem">
Resolve the channel name to the actual instance of the <code class="literal">MessageChannel</code> as a reference to a bean within the application context (which is hopefully a <code class="literal">MessageChannel</code>) identified by the result of the previous step.
</li></ol></div>
<p>In other words, each step feeds the next step until the process completes.</p>
<p>Now consider an example of a header value router:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:header-value-router</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"inputChannel"</span> <span class="hl-attribute">header-name</span>=<span class="hl-value">"testHeader"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:mapping</span> <span class="hl-attribute">value</span>=<span class="hl-value">"foo"</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"fooChannel"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;int:mapping</span> <span class="hl-attribute">value</span>=<span class="hl-value">"bar"</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"barChannel"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/int:header-value-router&gt;</span></pre>
</div>
<p>Now we can consider how the three steps work for a header value router:</p>
<div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
Compute a channel identifier that is the value of the header identified by the <code class="literal">header-name</code> attribute.
</li><li class="listitem">
Resolve the channel identifier a to channel name, where the result of the previous step is used to select the appropriate value from the general mapping defined in the <code class="literal">mapping</code> element.
</li><li class="listitem">
Resolve the channel name to the actual instance of the <code class="literal">MessageChannel</code> as a reference to a bean within the application context (which is hopefully a <code class="literal">MessageChannel</code>) identified by the result of the previous step.
</li></ol></div>
<p>The preceding two configurations of two different router types look almost identical.
However, if you look at the alternate configuration of the <code class="literal">HeaderValueRouter</code> we clearly see that there is no <code class="literal">mapping</code> sub element, as the following listing shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:header-value-router&nbsp;input-channel="inputChannel"&nbsp;header-name="testHeader"&gt;</span></pre>
</div>
<p>However, the configuration is still perfectly valid.
So the natural question is what about the mapping in the second step?</p>
<p>The second step is now optional.
If <code class="literal">mapping</code> is not defined, then the channel identifier value computed in the first step is automatically treated as the <code class="literal">channel name</code>, which is now resolved to the actual <code class="literal">MessageChannel</code>, as in the third step.&nbsp;
What it also means is that the second step is one of the key steps to providing dynamic characteristics to the routers, since it introduces a process that lets you change the way channel identifier resolves to the channel name, thus influencing the process of determining the final instance of the <code class="literal">MessageChannel</code> from the initial channel identifier.&nbsp;</p>
<p>For example, in the preceding configuration, assume that the <code class="literal">testHeader</code> value is <span class="emphasis"><em>kermit</em></span>, which is now a channel identifier (the first step).
Since there is no mapping in this router, resolving this channel identifier to a channel name (the second step) is impossible and this channel identifier is now treated as the channel name.
However, what if there was a mapping but for a different value?
The end result would still be the same, because, if a new value cannot be determined through the process of resolving the channel identifier to a channel name, the channel identifier becomes the channel name.</p>
<p>All that is left is for the third step to resolve the channel name (<span class="emphasis"><em>kermit</em></span>) to an actual instance of the <code class="literal">MessageChannel</code> identified by this name.
That basically involves a bean lookup for the provided name.
Now all messages that contain the header-value pair as <code class="literal">testHeader=kermit</code> are going to be routed to a <code class="literal">MessageChannel</code> whose bean name (its <code class="literal">id</code>) is <span class="emphasis"><em>kermit</em></span>.</p>
<p>But what if you want to route these messages to the <span class="emphasis"><em>simpson</em></span> channel? Obviously changing a static configuration works, but doing so also requires bringing your system down.
However, if you had access to the channel identifier map, you could introduce a new mapping where the header-value pair is now <code class="literal">kermit=simpson</code>, thus letting the second step treat <span class="emphasis"><em>kermit</em></span> as a channel identifier while resolving it to <span class="emphasis"><em>simpson</em></span> as the channel name.</p>
<p>The same obviously applies for <code class="literal">PayloadTypeRouter</code>, where you can now remap or remove a particular payload type mapping.
In fact, it applies to every other router, including expression-based routers, since their computed values now have a chance to go through the second step to be resolved to the actual <code class="literal">channel name</code>.</p>
<p>Any router that is a subclass of the <code class="literal">AbstractMappingMessageRouter</code> (which includes most framework-defined routers) is a dynamic router, because the <code class="literal">channelMapping</code> is defined at the <code class="literal">AbstractMappingMessageRouter</code> level.
That map&#8217;s setter method is exposed as a public method along with the <span class="emphasis"><em>setChannelMapping</em></span> and <span class="emphasis"><em>removeChannelMapping</em></span> methods.
These let you  change, add, and remove router mappings at runtime, as long as you have a reference to the router itself.
It also means that you could expose these same configuration options through JMX (see <a class="xref" href="system-management-chapter.html#jmx" title="12.2&nbsp;JMX Support">Section&nbsp;12.2, &#8220;JMX Support&#8221;</a>) or the Spring Integration control bus (see <a class="xref" href="system-management-chapter.html#control-bus" title="12.6&nbsp;Control Bus">Section&nbsp;12.6, &#8220;Control Bus&#8221;</a>) functionality.&nbsp;</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="dynamic-routers-control-bus" href="#dynamic-routers-control-bus"></a>Manage Router Mappings using the Control Bus</h4></div></div></div>

<p>One way to manage the router mappings is through the <a class="ulink" href="http://www.eaipatterns.com/ControlBus.html" target="_top">control bus</a> pattern, which exposes a control channel to which you can send control messages to manage and monitor Spring Integration components, including routers.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>For more information about the control bus, see <a class="xref" href="system-management-chapter.html#control-bus" title="12.6&nbsp;Control Bus">Section&nbsp;12.6, &#8220;Control Bus&#8221;</a>.</p>
</td></tr></table></div>
<p>Typically, you would send a control message asking to invoke a particular operation on a particular managed component (such as a
router).
The following managed operations (methods) are specific to changing the router resolution process:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">public void setChannelMapping(String key, String channelName)</code>: Lets you add a new or modify an existing mapping between <code class="literal">channel identifier</code> and <code class="literal">channel name</code>
</li><li class="listitem">
<code class="literal">public void removeChannelMapping(String key)</code>: Lets you remove a particular channel mapping, thus disconnecting the relationship between <code class="literal">channel identifier</code> and <code class="literal">channel name</code>
</li></ul></div>
<p>Note that these methods can be used for simple changes (such as updating a single route or adding or removing a route).
However, if you want to remove one route and add another, the updates are not atomic.
This means that the routing table may be in an indeterminate state between the updates.
Starting with version 4.0, you can now use the control bus to update the entire routing table atomically.
The following methods let you do so:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">public Map&lt;String, String&gt;getChannelMappings()</code>: Returns the current mappings.
</li><li class="listitem">
<code class="literal">public void replaceChannelMappings(Properties channelMappings)</code>: Updates the mappings.
Note that the <code class="literal">channelMappings</code> parameter is a <code class="literal">Properties</code> object.
This arrangement lets a control bus command use the built-in <code class="literal">StringToPropertiesConverter</code>, as the following example shows:
</li></ul></div>
<div class="informalexample">
<pre class="screen">"@'router.handler'.replaceChannelMappings('foo=qux \n baz=bar')"</pre>
</div>
<p>Note that each mapping is separated by a newline character (<code class="literal">\n</code>).
For programmatic changes to the map, we recommend that you use the <code class="literal">setChannelMappings</code> method, due to type-safety concerns.
<code class="literal">replaceChannelMappings</code> ignores keys or values that are not <code class="literal">String</code> objects.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="dynamic-routers-jmx" href="#dynamic-routers-jmx"></a>Manage Router Mappings by Using JMX</h4></div></div></div>

<p>You can also use Spring&#8217;s JMX support to expose a router instance and then use your favorite JMX client (for example, JConsole) to manage those operations (methods) for changing the router&#8217;s configuration.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>For more information about Spring Integration&#8217;s JMX support, see <a class="xref" href="system-management-chapter.html#jmx" title="12.2&nbsp;JMX Support">Section&nbsp;12.2, &#8220;JMX Support&#8221;</a>.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="routing-slip" href="#routing-slip"></a>Routing Slip</h4></div></div></div>

<p>Starting with version 4.1, Spring Integration provides an implementation of the <a class="ulink" href="http://www.eaipatterns.com/RoutingTable.html" target="_top">routing slip</a> enterprise integration pattern.
It is implemented as a <code class="literal">routingSlip</code> message header, which is used to determine the next channel in <code class="literal">AbstractMessageProducingHandler</code> instances, when an <code class="literal">outputChannel</code> is not specified for the endpoint.
This pattern is useful in complex, dynamic cases, when it can become difficult to configure multiple routers to determine message flow.
When a message arrives at an endpoint that has no <code class="literal">output-channel</code>, the <code class="literal">routingSlip</code> is consulted to determine the next channel to which the message is sent.
When the routing slip is exhausted, normal <code class="literal">replyChannel</code> processing resumes.</p>
<p>Configuration for the routing slip is presented as a <code class="literal">HeaderEnricher</code> option&#8201;&#8212;&#8201;a semicolon-separated routing slip that contains <code class="literal">path</code> entries, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;util:properties</span> <span class="hl-attribute">id</span>=<span class="hl-value">"properties"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;beans:prop</span> <span class="hl-attribute">key</span>=<span class="hl-value">"myRoutePath1"</span><span class="hl-tag">&gt;</span>channel1<span class="hl-tag">&lt;/beans:prop&gt;</span>
    <span class="hl-tag">&lt;beans:prop</span> <span class="hl-attribute">key</span>=<span class="hl-value">"myRoutePath2"</span><span class="hl-tag">&gt;</span>request.headers[myRoutingSlipChannel]<span class="hl-tag">&lt;/beans:prop&gt;</span>
<span class="hl-tag">&lt;/util:properties&gt;</span>

<span class="hl-tag">&lt;context:property-placeholder</span> <span class="hl-attribute">properties-ref</span>=<span class="hl-value">"properties"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;header-enricher</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"process"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;routing-slip</span>
        <span class="hl-attribute">value</span>=<span class="hl-value">"${myRoutePath1}; @routingSlipRoutingPojo.get(request, reply);
               routingSlipRoutingStrategy; ${myRoutePath2}; finishChannel"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/header-enricher&gt;</span></pre>
</div>
<p>The preceding example has:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
A <code class="literal">&lt;context:property-placeholder&gt;</code> configuration to demonstrate that the entries in the routing slip <code class="literal">path</code> can be specified as resolvable keys.
</li><li class="listitem">
The <code class="literal">&lt;header-enricher&gt;</code> <code class="literal">&lt;routing-slip&gt;</code> sub-element is used to populate the <code class="literal">RoutingSlipHeaderValueMessageProcessor</code> to the <code class="literal">HeaderEnricher</code> handler.
</li><li class="listitem">
The <code class="literal">RoutingSlipHeaderValueMessageProcessor</code> accepts a <code class="literal">String</code> array of resolved routing slip <code class="literal">path</code> entries and returns (from <code class="literal">processMessage()</code>) a <code class="literal">singletonMap</code> with the <code class="literal">path</code> as <code class="literal">key</code> and <code class="literal">0</code> as initial <code class="literal">routingSlipIndex</code>.
</li></ul></div>
<p>Routing Slip <code class="literal">path</code> entries can contain <code class="literal">MessageChannel</code> bean names, <code class="literal">RoutingSlipRouteStrategy</code> bean names, and Spring expressions (SpEL).
The <code class="literal">RoutingSlipHeaderValueMessageProcessor</code> checks each routing slip <code class="literal">path</code> entry against the <code class="literal">BeanFactory</code> on the first <code class="literal">processMessage</code> invocation.
It converts entries (which are not bean names in the application context) to <code class="literal">ExpressionEvaluatingRoutingSlipRouteStrategy</code> instances.
<code class="literal">RoutingSlipRouteStrategy</code> entries are invoked multiple times, until they return null or an empty <code class="literal">String</code>.</p>
<p>Since the routing slip is involved in the <code class="literal">getOutputChannel</code> process, we have a request-reply context.
The <code class="literal">RoutingSlipRouteStrategy</code> has been introduced to determine the next <code class="literal">outputChannel</code> that uses the <code class="literal">requestMessage</code> and the <code class="literal">reply</code> object.
An implementation of this strategy should be registered as a bean in the application context, and its bean name is used in the routing slip <code class="literal">path</code>.
The <code class="literal">ExpressionEvaluatingRoutingSlipRouteStrategy</code> implementation is provided.
It accepts a SpEL expression and an internal <code class="literal">ExpressionEvaluatingRoutingSlipRouteStrategy.RequestAndReply</code> object is used as the root object of the evaluation context.
This is to avoid the overhead of <code class="literal">EvaluationContext</code> creation for each <code class="literal">ExpressionEvaluatingRoutingSlipRouteStrategy.getNextPath()</code> invocation.
It is a simple Java bean with two properties: <code class="literal">Message&lt;?&gt; request</code> and <code class="literal">Object reply</code>.
With this expression implementation, we can specify routing slip <code class="literal">path</code> entries by using SpEL (for example, <code class="literal">@routingSlipRoutingPojo.get(request, reply)</code> and <code class="literal">request.headers[myRoutingSlipChannel]</code>) and avoid defining a bean for the <code class="literal">RoutingSlipRouteStrategy</code>.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The <code class="literal">requestMessage</code> argument is always a <code class="literal">Message&lt;?&gt;</code>.
Depending on context, the reply object may be a <code class="literal">Message&lt;?&gt;</code>, an <code class="literal">AbstractIntegrationMessageBuilder</code>, or an arbitrary application domain object (when, for example, it is returned by a POJO method invoked by a service activator).
In the first two cases, the usual <code class="literal">Message</code> properties (<code class="literal">payload</code> and <code class="literal">headers</code>) are available when using SpEL (or a Java implementation).
For an arbitrary domain object, these properties are not available.
For this reason, be careful when you use routing slips in conjunction with POJO methods if the result is used to determine the
next path.</p>
</td></tr></table></div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>If a routing slip is involved in a distributed environment, we recommend not using inline expressions for the Routing Slip <code class="literal">path</code>. This recommendation applies to distributed environments such as cross-JVM applications, using a <code class="literal">request-reply</code> through a message broker (such as<a class="xref" href="amqp.html" title="14.&nbsp;AMQP Support">Chapter&nbsp;14, <i>AMQP Support</i></a> or <a class="xref" href="jms.html" title="23.&nbsp;JMS Support">Chapter&nbsp;23, <i>JMS Support</i></a>), or using a persistent <code class="literal">MessageStore</code> (<a class="xref" href="system-management-chapter.html#message-store" title="12.4&nbsp;Message Store">Section&nbsp;12.4, &#8220;Message Store&#8221;</a>) in the integration flow.
The framework uses <code class="literal">RoutingSlipHeaderValueMessageProcessor</code> to convert them to <code class="literal">ExpressionEvaluatingRoutingSlipRouteStrategy</code> objects, and they are used in the <code class="literal">routingSlip</code> message header.
Since this class is not <code class="literal">Serializable</code> (it cannot be, because it depends on the <code class="literal">BeanFactory</code>), the entire <code class="literal">Message</code> becomes non-serializable and, in any distributed operation, we end up with a <code class="literal">NotSerializableException</code>.
To overcome this limitation, register an <code class="literal">ExpressionEvaluatingRoutingSlipRouteStrategy</code> bean with the desired SpEL and use its bean name in the routing slip <code class="literal">path</code> configuration.</p>
</td></tr></table></div>
<p>For Java configuration, you can add a <code class="literal">RoutingSlipHeaderValueMessageProcessor</code> instance to the <code class="literal">HeaderEnricher</code> bean definition, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<em><span class="hl-annotation" style="color: gray">@Transformer(inputChannel = "routingSlipHeaderChannel")</span></em>
<span class="hl-keyword">public</span> HeaderEnricher headerEnricher() {
    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> HeaderEnricher(Collections.singletonMap(IntegrationMessageHeaderAccessor.ROUTING_SLIP,
            <span class="hl-keyword">new</span> RoutingSlipHeaderValueMessageProcessor(<span class="hl-string">"myRoutePath1"</span>,
                                                       <span class="hl-string">"@routingSlipRoutingPojo.get(request, reply)"</span>,
                                                       <span class="hl-string">"routingSlipRoutingStrategy"</span>,
                                                       <span class="hl-string">"request.headers[myRoutingSlipChannel]"</span>,
                                                       <span class="hl-string">"finishChannel"</span>)));
}</pre>
</div>
<p>The routing slip algorithm works as follows when an endpoint produces a reply and no <code class="literal">outputChannel</code> has been defined:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
The <code class="literal">routingSlipIndex</code> is used to get a value from the routing slip <code class="literal">path</code> list.
</li><li class="listitem">
If the value from <code class="literal">routingSlipIndex</code> is <code class="literal">String</code>, it is used to get a bean from <code class="literal">BeanFactory</code>.
</li><li class="listitem">
If a returned bean is an instance of <code class="literal">MessageChannel</code>, it is used as the next <code class="literal">outputChannel</code> and the <code class="literal">routingSlipIndex</code> is incremented in the reply message header (the routing slip <code class="literal">path</code> entries remain unchanged).
</li><li class="listitem">
If a returned bean is an instance of <code class="literal">RoutingSlipRouteStrategy</code> and its <code class="literal">getNextPath</code> does not return an empty <code class="literal">String</code>, that result is used as a bean name for the next <code class="literal">outputChannel</code>.
The <code class="literal">routingSlipIndex</code> remains unchanged.
</li><li class="listitem">
If <code class="literal">RoutingSlipRouteStrategy.getNextPath</code> returns an empty <code class="literal">String</code>, the <code class="literal">routingSlipIndex</code> is incremented and the <code class="literal">getOutputChannelFromRoutingSlip</code> is invoked recursively for the next Routing Slip <code class="literal">path</code> item.
</li><li class="listitem">
If the next routing slip <code class="literal">path</code> entry is not a <code class="literal">String</code>, it must be an instance of <code class="literal">RoutingSlipRouteStrategy</code>.
</li><li class="listitem">
When the <code class="literal">routingSlipIndex</code> exceeds the size of the routing slip <code class="literal">path</code> list, the algorithm moves to the default behavior for the standard <code class="literal">replyChannel</code> header.
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="process-manager" href="#process-manager"></a>Process Manager Enterprise Integration Pattern</h4></div></div></div>

<p>Enterprise integration patterns include the <a class="ulink" href="http://www.eaipatterns.com/ProcessManager.html" target="_top">process manager</a> pattern.
You can now easily implement this pattern by using custom process manager logic encapsulated in a <code class="literal">RoutingSlipRouteStrategy</code> within the routing slip.
In addition to a bean name, the <code class="literal">RoutingSlipRouteStrategy</code> can return any <code class="literal">MessageChannel</code> object, and there is no requirement that this <code class="literal">MessageChannel</code> instance be a bean in the application context.
This way, we can provide powerful dynamic routing logic when there is no way to predict which channel should be used.
A <code class="literal">MessageChannel</code> can be created within the <code class="literal">RoutingSlipRouteStrategy</code> and returned.
A <code class="literal">FixedSubscriberChannel</code> with an associated <code class="literal">MessageHandler</code> implementation is a good combination for such cases.
For example, you can route to a <a class="ulink" href="https://github.com/reactor/reactor/wiki/Streams" target="_top">reactor stream</a>, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> PollableChannel resultsChannel() {
    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> QueueChannel();
}
<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> RoutingSlipRouteStrategy routeStrategy() {
    <span class="hl-keyword">return</span> (requestMessage, reply) -&gt; requestMessage.getPayload() <span class="hl-keyword">instanceof</span> String
            ? <span class="hl-keyword">new</span> FixedSubscriberChannel(m -&gt;
            Mono.just((String) m.getPayload())
                    .map(String::toUpperCase)
                    .subscribe(v -&gt; messagingTemplate().convertAndSend(resultsChannel(), v)))
            : <span class="hl-keyword">new</span> FixedSubscriberChannel(m -&gt;
            Mono.just((Integer) m.getPayload())
                    .map(v -&gt; v * <span class="hl-number">2</span>)
                    .subscribe(v -&gt; messagingTemplate().convertAndSend(resultsChannel(), v)));
}</pre>
</div>
</div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="filter" href="#filter"></a>8.2&nbsp;Filter</h2></div></div></div>

<p>Message filters are used to decide whether a <code class="literal">Message</code> should be passed along or dropped based on some criteria, such as a message header value or message content itself.
Therefore, a message filter is similar to a router, except that, for each message received from the filter&#8217;s input channel, that same message may or may not be sent to the filter&#8217;s output channel.
Unlike the router, it makes no decision regarding which message channel to send the message to but decides only whether to send the message at all.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>As we describe later in this section, the filter also supports a discard channel.
In certain cases, it can play the role of a very simple router (or "<code class="literal">switch</code>"), based on a boolean condition.</p>
</td></tr></table></div>
<p>In Spring Integration, you can configure a message filter as a message endpoint that delegates to an implementation of the <code class="literal">MessageSelector</code> interface.
That interface is itself quite simple, as the following listing shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> MessageSelector {

    <span class="hl-keyword">boolean</span> accept(Message&lt;?&gt; message);

}</pre>
</div>
<p>The <code class="literal">MessageFilter</code> constructor accepts a selector instance, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting">MessageFilter filter = <span class="hl-keyword">new</span> MessageFilter(someSelector);</pre>
</div>
<p>In combination with the namespace and SpEL, you can configure powerful filters with very little Java code.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="filter-xml" href="#filter-xml"></a>8.2.1&nbsp;Configuring a Filter with XML</h3></div></div></div>

<p>You can use the <code class="literal">&lt;filter&gt;</code> element is used to create a message-selecting endpoint.
In addition to <code class="literal">input-channel</code> and <code class="literal">output-channel</code> attributes, it requires a <code class="literal">ref</code> attribute.
The <code class="literal">ref</code> can point to a <code class="literal">MessageSelector</code> implementation, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:filter</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"selector"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"selector"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"example.MessageSelectorImpl"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>Alternatively, you can add the <code class="literal">method</code> attribute.
In that case, the <code class="literal">ref</code> attribute may refer to any object.
The referenced method may expect either the <code class="literal">Message</code> type or the payload type of inbound messages.
The method must return a boolean value.
If the method returns <span class="emphasis"><em>true</em></span>, the message is sent to the output channel.
The following example shows how to configure a filter that uses the <code class="literal">method</code> attribute:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:filter</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span>
    <span class="hl-attribute">ref</span>=<span class="hl-value">"exampleObject"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"someBooleanReturningMethod"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"exampleObject"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"example.SomeObject"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>If the selector or adapted POJO method returns <code class="literal">false</code>, a few settings  control the handling of the rejected message.
By default (if configured as in the preceding example), rejected messages are silently dropped.
If rejection should instead result in an error condition, set the <code class="literal">throw-exception-on-rejection</code> attribute to <code class="literal">true</code>, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:filter</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"selector"</span>
    <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span> <span class="hl-attribute">throw-exception-on-rejection</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>If you want rejected messages to be routed to a specific channel, provide that reference as the <code class="literal">discard-channel</code>, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:filter</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"selector"</span>
    <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span> <span class="hl-attribute">discard-channel</span>=<span class="hl-value">"rejectedMessages"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>See also <a class="xref" href="messaging-endpoints-chapter.html#advising-filters" title="10.9.6&nbsp;Advising Filters">Section&nbsp;10.9.6, &#8220;Advising Filters&#8221;</a>.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Message filters are commonly used in conjunction with a publish-subscribe channel.
Many filter endpoints may be subscribed to the same channel, and they decide whether or not to pass the message to the next endpoint, which could be any of the supported types (such as a service activator).
This provides a reactive alternative to the more proactive approach of using a message router with a single point-to-point input channel and multiple output channels.</p>
</td></tr></table></div>
<p>We recommend using a <code class="literal">ref</code> attribute if the custom filter implementation is referenced in other <code class="literal">&lt;filter&gt;</code> definitions.
However, if the custom filter implementation is scoped to a single <code class="literal">&lt;filter&gt;</code> element, you should provide an inner bean definition, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:filter</span> <span class="hl-attribute">method</span>=<span class="hl-value">"someMethod"</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"inChannel"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"outChannel"</span><span class="hl-tag">&gt;</span>
  <span class="hl-tag">&lt;beans:bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.foo.MyCustomFilter"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/filter&gt;</span></pre>
</div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Using both the <code class="literal">ref</code> attribute and an inner handler definition in the same <code class="literal">&lt;filter&gt;</code> configuration is not allowed, as it creates an ambiguous condition and throws an exception.</p>
</td></tr></table></div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>If the <code class="literal">ref</code> attribute references a bean that extends <code class="literal">MessageFilter</code> (such as filters provided by the framework itself), the configuration is optimized by injecting the output channel into the filter bean directly.
In this case, each <code class="literal">ref</code> must be to a separate bean instance (or a <code class="literal">prototype</code>-scoped bean) or use the inner <code class="literal">&lt;bean/&gt;</code> configuration type.
However, this optimization applies only if you do not provide any filter-specific attributes in the filter XML definition.
If you inadvertently reference the same message handler from multiple beans, you get a configuration exception.</p>
</td></tr></table></div>
<p>With the introduction of SpEL support, Spring Integration added the <code class="literal">expression</code> attribute to the filter element.
It can be used to avoid Java entirely for simple filters, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:filter</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"payload.equals('nonsense')"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>The string passed as the value of the expression attribute is evaluated as a SpEL expression with the message available in the evaluation context.
If you must include the result of an expression in the scope of the application context, you can use the <code class="literal">#{}</code> notation, as defined in the <a class="ulink" href="http://docs.spring.io/spring/docs/current/spring-framework-reference/html/expressions.html#expressions-beandef" target="_top">SpEL reference documentation</a>, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:filter</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span>
            <span class="hl-attribute">expression</span>=<span class="hl-value">"payload.matches(#{filterPatterns.nonsensePattern})"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>If the expression itself needs to be dynamic, you can use an <span class="emphasis"><em>expression</em></span> sub-element.
That provides a level of indirection for resolving the expression by its key from an <code class="literal">ExpressionSource</code>.
That is a strategy interface that you can implement directly, or you can rely upon a version available in Spring Integration that loads expressions from a "<code class="literal">resource bundle</code>" and can check for modifications after a given number of seconds.
All of this is demonstrated in the following configuration example, where the expression could be reloaded within one minute if the underlying file had been modified:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:filter</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:expression</span> <span class="hl-attribute">key</span>=<span class="hl-value">"filterPatterns.example"</span> <span class="hl-attribute">source</span>=<span class="hl-value">"myExpressions"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:filter&gt;</span>

<span class="hl-tag">&lt;beans:bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myExpressions"</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myExpressions"</span>
    <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.expression.ReloadableResourceBundleExpressionSource"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;beans:property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"basename"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"config/integration/expressions"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;beans:property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"cacheSeconds"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"60"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/beans:bean&gt;</span></pre>
</div>
<p>If the <code class="literal">ExpressionSource</code> bean is named <code class="literal">expressionSource</code>, you need not provide the` source` attribute on the <code class="literal">&lt;expression&gt;</code> element. However, in the preceding example, we show it for completeness.</p>
<p>The <span class="emphasis"><em>config/integration/expressions.properties</em></span> file (or any more-specific version with a locale extension to be resolved in the typical way that resource-bundles are loaded) can contain a key/value pair, as the following example shows:</p>
<div class="informalexample">
<pre class="screen">filterPatterns.example=payload &gt; 100</pre>
</div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>All of these examples that use <code class="literal">expression</code> as an attribute or sub-element can also be applied within transformer, router, splitter, service-activator, and header-enricher elements.
The semantics and role of the given component type would affect the interpretation of the evaluation result, in the same way that the return value of a method-invocation would be interpreted.
For example, an expression can return strings that are to be treated as message channel names by a router component.
However, the underlying functionality of evaluating the expression against the message as the root object and resolving bean names if prefixed with <span class="emphasis"><em>@</em></span> is consistent across all of the core EIP components within Spring Integration.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="filter-annotations" href="#filter-annotations"></a>8.2.2&nbsp;Configuring a Filter with Annotations</h3></div></div></div>

<p>The following example shows how to configure a filter by using annotations:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> PetFilter {
    ...
    <em><span class="hl-annotation" style="color: gray">@Filter</span></em>  <a name="CO3-1" href="#CO3-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
    <span class="hl-keyword">public</span> <span class="hl-keyword">boolean</span> dogsOnly(String input) {
        ...
    }
}</pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO3-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>An annotation indicating that this method is to be used as a filter.
It must be specified if this class is to be used as a filter.</p>
</td></tr></table></div>
<p>All of the configuration options provided by the XML element are also available for the <code class="literal">@Filter</code> annotation.</p>
<p>The filter can be either referenced explicitly from XML or, if the <code class="literal">@MessageEndpoint</code> annotation is defined on the class, detected automatically through classpath scanning.</p>
<p>See also <a class="xref" href="messaging-endpoints-chapter.html#advising-with-annotations" title="10.9.7&nbsp;Advising Endpoints Using Annotations">Section&nbsp;10.9.7, &#8220;Advising Endpoints Using Annotations&#8221;</a>.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="splitter" href="#splitter"></a>8.3&nbsp;Splitter</h2></div></div></div>

<p>The splitter is a component whose role is to partition a message into several parts and send the resulting messages to be processed independently.
Very often, they are upstream producers in a pipeline that includes an aggregator.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_programming_model" href="#_programming_model"></a>8.3.1&nbsp;Programming Model</h3></div></div></div>

<p>The API for performing splitting consists of one base class, <code class="literal">AbstractMessageSplitter</code>.
It is a <code class="literal">MessageHandler</code> implementation that encapsulates features common to splitters, such as filling in the appropriate message headers (<code class="literal">CORRELATION_ID</code>, <code class="literal">SEQUENCE_SIZE</code>, and <code class="literal">SEQUENCE_NUMBER</code>) on the messages that are produced.
This filling enables tracking down the messages and the results of their processing (in a typical scenario, these headers get copied to the messages that are produced by the various transforming endpoints).
The values can then be used, for example, by a <a class="ulink" href="http://www.eaipatterns.com/DistributionAggregate.html" target="_top">composed message processor</a>.</p>
<p>The following example shows an excerpt from <code class="literal">AbstractMessageSplitter</code>:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">abstract</span> <span class="hl-keyword">class</span> AbstractMessageSplitter
    <span class="hl-keyword">extends</span> AbstractReplyProducingMessageConsumer {
    ...
    <span class="hl-keyword">protected</span> <span class="hl-keyword">abstract</span> Object splitMessage(Message&lt;?&gt; message);

}</pre>
<p>To implement a specific splitter in an application, you can extend <code class="literal">AbstractMessageSplitter</code> and implement the <code class="literal">splitMessage</code> method, which contains logic for splitting the messages.
The return value can be one of the following:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
A <code class="literal">Collection</code> or an array of messages or an <code class="literal">Iterable</code> (or <code class="literal">Iterator</code>) that iterates over messages.
In this case, the messages are sent as messages (after the <code class="literal">CORRELATION_ID</code>, <code class="literal">SEQUENCE_SIZE</code> and <code class="literal">SEQUENCE_NUMBER</code> are populated).
Using this approach gives you more control&#8201;&#8212;&#8201;for example, to populate custom message headers as part of the splitting process.
</li><li class="listitem">
A <code class="literal">Collection</code> or an array of non-message objects or an <code class="literal">Iterable</code> (or <code class="literal">Iterator</code>) that iterates over non-message objects.
It works like the prior case, except that each collection element is used as a message payload.
Using this approach lets you focus on the domain objects without having to consider the messaging system and produces code that is easier to test.
</li><li class="listitem">
a <code class="literal">Message</code> or non-message object (but not a collection or an array).
It works like the previous cases, except that a single message is sent out.
</li></ul></div>
<p>In Spring Integration, any POJO can implement the splitting algorithm, provided that it defines a method that accepts a single argument and has a return value.
In this case, the return value of the method is interpreted as described earlier.
The input argument might either be a <code class="literal">Message</code> or a simple POJO.
In the latter case, the splitter receives the payload of the incoming message.
We recommend this approach, because it decouples the code from the Spring Integration API and is typically easier to test.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_iterators" href="#_iterators"></a>Iterators</h4></div></div></div>

<p>Starting with version 4.1, the <code class="literal">AbstractMessageSplitter</code> supports the <code class="literal">Iterator</code> type for the <code class="literal">value</code> to split.
Note, in the case of an <code class="literal">Iterator</code> (or <code class="literal">Iterable</code>), we don&#8217;t have access to the number of underlying items and the <code class="literal">SEQUENCE_SIZE</code> header is set to <code class="literal">0</code>.
This means that the default <code class="literal">SequenceSizeReleaseStrategy</code> of an <code class="literal">&lt;aggregator&gt;</code> won&#8217;t work and the group for the <code class="literal">CORRELATION_ID</code> from the <code class="literal">splitter</code> won&#8217;t be released; it will remain as <code class="literal">incomplete</code>.
In this case you should use an appropriate custom <code class="literal">ReleaseStrategy</code> or rely on <code class="literal">send-partial-result-on-expiry</code> together with <code class="literal">group-timeout</code> or a <code class="literal">MessageGroupStoreReaper</code>.</p>
<p>Starting with version 5.0, the <code class="literal">AbstractMessageSplitter</code> provides <code class="literal">protected obtainSizeIfPossible()</code> methods to allow the determination of the size of the <code class="literal">Iterable</code> and <code class="literal">Iterator</code> objects if that is possible.
For example <code class="literal">XPathMessageSplitter</code> can determine the size of the underlying <code class="literal">NodeList</code> object.
And starting with version 5.0.9, this method also properly returns a size of the <code class="literal">com.fasterxml.jackson.core.TreeNode</code>.</p>
<p>An <code class="literal">Iterator</code> object is useful to avoid the need for building an entire collection in the memory before splitting.
For example, when underlying items are populated from some external system (e.g. DataBase or FTP <code class="literal">MGET</code>) using iterations or streams.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_stream_and_flux" href="#_stream_and_flux"></a>Stream and Flux</h4></div></div></div>

<p>Starting with version 5.0, the <code class="literal">AbstractMessageSplitter</code> supports the Java <code class="literal">Stream</code> and Reactive Streams <code class="literal">Publisher</code> types for the <code class="literal">value</code> to split.
In this case, the target <code class="literal">Iterator</code> is built on their iteration functionality.</p>
<p>In addition, if the splitter&#8217;s output channel is an instance of a <code class="literal">ReactiveStreamsSubscribableChannel</code>, the <code class="literal">AbstractMessageSplitter</code> produces a <code class="literal">Flux</code> result instead of an <code class="literal">Iterator</code>, and the output channel is subscribed to this <code class="literal">Flux</code> for back-pressure-based splitting on downstream flow demand.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_a_splitter_with_xml" href="#_configuring_a_splitter_with_xml"></a>8.3.2&nbsp;Configuring a Splitter with XML</h3></div></div></div>

<p>A splitter can be configured through XML as follows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"inputChannel"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int:splitter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"splitter"</span>         <a name="CO4-1" href="#CO4-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
  ref="splitterBean"                <a name="CO4-2" href="#CO4-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
  method="split"                    <a name="CO4-3" href="#CO4-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
  input-channel="inputChannel"      <a name="CO4-4" href="#CO4-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
  output-channel="outputChannel" /&gt; <a name="CO4-5" href="#CO4-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>

<span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"outputChannel"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;beans:bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"splitterBean"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"sample.PojoSplitter"</span><span class="hl-tag">/&gt;</span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO4-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The ID of the splitter is optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO4-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A reference to a bean defined in the application context.
The bean must implement the splitting logic, as described in the earlier section.
Optional.
If a reference to a bean is not provided, it is assumed that the payload of the message that arrived on the <code class="literal">input-channel</code> is an implementation of <code class="literal">java.util.Collection</code> and the default splitting logic is applied to the collection, incorporating each individual element into a message and sending it to the <code class="literal">output-channel</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO4-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The method (defined on the bean) that implements the splitting logic.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO4-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The input channel of the splitter.
Required.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO4-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The channel to which the splitter sends the results of splitting the incoming message.
Optional (because incoming messages can specify a reply channel themselves).</p>
</td></tr></table></div>
</div>
<p>We recommend using a <code class="literal">ref</code> attribute if the custom splitter implementation can be referenced in other <code class="literal">&lt;splitter&gt;</code> definitions.
However if the custom splitter handler implementation should be scoped to a single definition of the <code class="literal">&lt;splitter&gt;</code>, you can configure an inner bean definition, as the following example follows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:splitter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"testSplitter"</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"inChannel"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"split"</span>
                <span class="hl-attribute">output-channel</span>=<span class="hl-value">"outChannel"</span><span class="hl-tag">&gt;</span>
  <span class="hl-tag">&lt;beans:bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.foo.TestSplitter"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:splitter&gt;</span></pre>
</div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Using both a <code class="literal">ref</code> attribute and an inner handler definition in the same <code class="literal">&lt;int:splitter&gt;</code> configuration is not allowed, as it creates an ambiguous condition and results in an exception being thrown.</p>
</td></tr></table></div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>If the <code class="literal">ref</code> attribute references a bean that extends <code class="literal">AbstractMessageProducingHandler</code> (such as splitters provided by the framework itself), the configuration is optimized by injecting the output channel into the handler directly.
In this case, each <code class="literal">ref</code> must be a separate bean instance (or a <code class="literal">prototype</code>-scoped bean) or use the inner <code class="literal">&lt;bean/&gt;</code> configuration type.
However, this optimization applies only if you do not provide any splitter-specific attributes in the splitter XML definition.
If you inadvertently reference the same message handler from multiple beans, you get a configuration exception.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_a_splitter_with_annotations" href="#_configuring_a_splitter_with_annotations"></a>8.3.3&nbsp;Configuring a Splitter with Annotations</h3></div></div></div>

<p>The <code class="literal">@Splitter</code> annotation is applicable to methods that expect either the <code class="literal">Message</code> type or the message payload type, and the return values of the method should be a <code class="literal">Collection</code> of any type.
If the returned values are not actual <code class="literal">Message</code> objects, each item is wrapped in a <code class="literal">Message</code> as the payload of the <code class="literal">Message</code>.
Each resulting <code class="literal">Message</code> is sent to the designated output channel for the endpoint on which the <code class="literal">@Splitter</code> is defined.</p>
<p>The following example shows how to configure a splitter by using the <code class="literal">@Splitter</code> annotation:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Splitter</span></em>
List&lt;LineItem&gt; extractItems(Order order) {
    <span class="hl-keyword">return</span> order.getItems()
}</pre>
</div>
<p>See also <a class="xref" href="messaging-endpoints-chapter.html#advising-with-annotations" title="10.9.7&nbsp;Advising Endpoints Using Annotations">Section&nbsp;10.9.7, &#8220;Advising Endpoints Using Annotations&#8221;</a>.</p>
<p>See also <a class="xref" href="java-dsl.html#java-dsl-splitters" title="11.8&nbsp;Splitters">Section&nbsp;11.8, &#8220;Splitters&#8221;</a> in the Java DSL chapter.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="aggregator" href="#aggregator"></a>8.4&nbsp;Aggregator</h2></div></div></div>

<p>Basically a mirror-image of the splitter, the aggregator is a type of message handler that receives multiple messages and combines them into a single message.
In fact, an aggregator is often a downstream consumer in a pipeline that includes a splitter.</p>
<p>Technically, the aggregator is more complex than a splitter, because it is stateful.
It must hold the messages to be aggregated and determine when the complete group of messages is ready to be aggregated.
In order to do so, it requires a <code class="literal">MessageStore</code>.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="aggregator-functionality" href="#aggregator-functionality"></a>8.4.1&nbsp;Functionality</h3></div></div></div>

<p>The Aggregator combines a group of related messages, by correlating and storing them, until the group is deemed to be complete.
At that point, the aggregator creates a single message by processing the whole group and sends the aggregated message as output.</p>
<p>Implementing an aggregator requires providing the logic to perform the aggregation (that is, the creation of a single message from many).
Two related concepts are correlation and release.</p>
<p>Correlation determines how messages are grouped for aggregation.
In Spring Integration, correlation is done by default, based on the <code class="literal">IntegrationMessageHeaderAccessor.CORRELATION_ID</code> message header.
Messages with the same <code class="literal">IntegrationMessageHeaderAccessor.CORRELATION_ID</code> are grouped together.
However, you can customize the correlation strategy to allow other ways of specifying how the messages should be grouped together.
To do so, you can implement a <code class="literal">CorrelationStrategy</code> (covered later in this chapter).</p>
<p>To determine the point at which a group of messages is ready to be processed, a <code class="literal">ReleaseStrategy</code> is consulted.
The default release strategy for the aggregator releases a group when all messages included in a sequence are present, based on the <code class="literal">IntegrationMessageHeaderAccessor.SEQUENCE_SIZE</code> header.
You can override this default strategy by providing a reference to a custom <code class="literal">ReleaseStrategy</code> implementation.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="aggregator-api" href="#aggregator-api"></a>8.4.2&nbsp;Programming Model</h3></div></div></div>

<p>The Aggregation API consists of a number of classes:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
The interface <code class="literal">MessageGroupProcessor</code>, and its subclasses: <code class="literal">MethodInvokingAggregatingMessageGroupProcessor</code> and <code class="literal">ExpressionEvaluatingMessageGroupProcessor</code>
</li><li class="listitem">
The <code class="literal">ReleaseStrategy</code> interface and its default implementation: <code class="literal">SimpleSequenceSizeReleaseStrategy</code>
</li><li class="listitem">
The <code class="literal">CorrelationStrategy</code> interface and its default implementation: <code class="literal">HeaderAttributeCorrelationStrategy</code>
</li></ul></div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_literal_aggregatingmessagehandler_literal" href="#_literal_aggregatingmessagehandler_literal"></a><code class="literal">AggregatingMessageHandler</code></h4></div></div></div>

<p>The <code class="literal">AggregatingMessageHandler</code> (a subclass of <code class="literal">AbstractCorrelatingMessageHandler</code>) is a <code class="literal">MessageHandler</code> implementation, encapsulating the common functionality of an aggregator (and other correlating use cases), which are as follows:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Correlating messages into a group to be aggregated
</li><li class="listitem">
Maintaining those messages in a <code class="literal">MessageStore</code> until the group can be released
</li><li class="listitem">
Deciding when the group can be released
</li><li class="listitem">
Aggregating the released group into a single message
</li><li class="listitem">
Recognizing and responding to an expired group
</li></ul></div>
<p>The responsibility for deciding how the messages should be grouped together is delegated to a <code class="literal">CorrelationStrategy</code> instance.
The responsibility for deciding whether the message group can be released is delegated to a <code class="literal">ReleaseStrategy</code> instance.</p>
<p>The following listing shows a brief highlight of the base <code class="literal">AbstractAggregatingMessageGroupProcessor</code> (the responsibility for implementing the <code class="literal">aggregatePayloads</code> method is left to the developer):</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">abstract</span> <span class="hl-keyword">class</span> AbstractAggregatingMessageGroupProcessor
              <span class="hl-keyword">implements</span> MessageGroupProcessor {

    <span class="hl-keyword">protected</span> Map&lt;String, Object&gt; aggregateHeaders(MessageGroup group) {
        <span class="hl-comment">// default implementation exists</span>
    }

    <span class="hl-keyword">protected</span> <span class="hl-keyword">abstract</span> Object aggregatePayloads(MessageGroup group, Map&lt;String, Object&gt; defaultHeaders);

}</pre>
</div>
<p>The <code class="literal">CorrelationStrategy</code> is owned by the <code class="literal">AbstractCorrelatingMessageHandler</code> and  has a default value based on the <code class="literal">IntegrationMessageHeaderAccessor.CORRELATION_ID</code> message header, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> AbstractCorrelatingMessageHandler(MessageGroupProcessor processor, MessageGroupStore store,
        CorrelationStrategy correlationStrategy, ReleaseStrategy releaseStrategy) {
    ...
    <span class="hl-keyword">this</span>.correlationStrategy = correlationStrategy == null ?
        <span class="hl-keyword">new</span> HeaderAttributeCorrelationStrategy(IntegrationMessageHeaderAccessor.CORRELATION_ID) : correlationStrategy;
    <span class="hl-keyword">this</span>.releaseStrategy = releaseStrategy == null ? <span class="hl-keyword">new</span> SimpleSequenceSizeReleaseStrategy() : releaseStrategy;
    ...
}</pre>
</div>
<p>As for the actual processing of the message group, the default implementation is the <code class="literal">DefaultAggregatingMessageGroupProcessor</code>.
It creates a single <code class="literal">Message</code> whose payload is a <code class="literal">List</code> of the payloads received for a given group.
This works well for simple scatter-gather implementations with a splitter, a publish-subscribe channel, or a recipient list router upstream.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>When using a publish-subscribe channel or a recipient list router in this type of scenario, be sure to enable the <code class="literal">apply-sequence</code> flag.
Doing so adds the necessary headers: <code class="literal">CORRELATION_ID</code>, <code class="literal">SEQUENCE_NUMBER</code>, and <code class="literal">SEQUENCE_SIZE</code>.
That behavior is enabled by default for splitters in Spring Integration, but it is not enabled for publish-subscribe channels or for recipient list routers because those components may be used in a variety of contexts in which these headers are not necessary.</p>
</td></tr></table></div>
<p>When implementing a specific aggregator strategy for an application, you can extend <code class="literal">AbstractAggregatingMessageGroupProcessor</code> and implement the <code class="literal">aggregatePayloads</code> method.
However, there are better solutions, less coupled to the API, for implementing the aggregation logic, which can be configured either through XML or through annotations.</p>
<p>In general, any POJO can implement the aggregation algorithm if it provides a method that accepts a single <code class="literal">java.util.List</code> as an argument (parameterized lists are supported as well).
This method is invoked for aggregating messages as follows:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
If the argument is a <code class="literal">java.util.Collection&lt;T&gt;</code> and the parameter type T is assignable to <code class="literal">Message</code>, the whole list of messages accumulated for aggregation is sent to the aggregator.
</li><li class="listitem">
If the argument is a non-parameterized <code class="literal">java.util.Collection</code> or the parameter type is not assignable to <code class="literal">Message</code>, the method receives the payloads of the accumulated messages.
</li><li class="listitem">
If the return type is not assignable to <code class="literal">Message</code>, it is treated as the payload for a <code class="literal">Message</code> that is automatically created by the framework.
</li></ul></div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>In the interest of code simplicity and promoting best practices such as low coupling, testability, and others, the preferred way of implementing the aggregation logic is through a POJO and using the XML or annotation support for configuring it in the application.</p>
</td></tr></table></div>
<p>Starting with version 5.1, after processing message group, an <code class="literal">AbstractCorrelatingMessageHandler</code> performs a <code class="literal">MessageBuilder.popSequenceDetails()</code> message headers modification for the proper splitter-aggregator scenario with several nested levels.
It is done only if the message group release result is not a message or collection of messages.
In that case a target <code class="literal">MessageGroupProcessor</code> is responsible for the <code class="literal">MessageBuilder.popSequenceDetails()</code> call while building those messages.
This functionality can be controlled by a new <code class="literal">popSequence</code> <code class="literal">boolean</code> property, so the <code class="literal">MessageBuilder.popSequenceDetails()</code> can be disabled in some scenarios when correlation details have not been populated by the standard splitter.
This property, essentially, undoes what has been done by the nearest upstream <code class="literal">applySequence = true</code> in the <code class="literal">AbstractMessageSplitter</code>.
See <a class="xref" href="messaging-routing-chapter.html#splitter" title="8.3&nbsp;Splitter">Section&nbsp;8.3, &#8220;Splitter&#8221;</a> for more information.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left"><a name="agg-message-collection" href="#agg-message-collection"></a>Important</th></tr><tr><td align="left" valign="top">
<p>The <code class="literal">SimpleMessageGroup.getMessages()</code> method returns an <code class="literal">unmodifiableCollection</code>.
Therefore, if your aggregating POJO method has a <code class="literal">Collection&lt;Message&gt;</code> parameter, the argument passed in is exactly that <code class="literal">Collection</code> instance and, when you use a <code class="literal">SimpleMessageStore</code> for the aggregator, that original <code class="literal">Collection&lt;Message&gt;</code> is cleared after releasing the group.
Consequently, the <code class="literal">Collection&lt;Message&gt;</code> variable in the POJO is cleared too, if it is passed out of the aggregator.
If you wish to simply release that collection as-is for further processing, you must build a new <code class="literal">Collection</code> (for example, <code class="literal">new ArrayList&lt;Message&gt;(messages)</code>).
Starting with version 4.3, the framework no longer copies the messages to a new collection, to avoid undesired extra object creation.</p>
</td></tr></table></div>
<p>If the <code class="literal">processMessageGroup</code> method of the <code class="literal">MessageGroupProcessor</code> returns a collection, it must be a collection of <code class="literal">Message&lt;?&gt;</code> objects.
In this case, the messages are individually released.
Prior to version 4.2, it was not possible to provide a <code class="literal">MessageGroupProcessor</code> by using XML configuration.
Only POJO methods could be used for aggregation.
Now, if the framework detects that the referenced (or inner) bean implements <code class="literal">MessageProcessor</code>, it is used as the aggregator&#8217;s output processor.</p>
<p>If you wish to release a collection of objects from a custom <code class="literal">MessageGroupProcessor</code> as the payload of a message, your class should extend <code class="literal">AbstractAggregatingMessageGroupProcessor</code> and implement <code class="literal">aggregatePayloads()</code>.</p>
<p>Also, since version 4.2, a <code class="literal">SimpleMessageGroupProcessor</code> is provided.
It returns the collection of messages from the group, which, as indicated earlier, causes the released messages to be sent individually.</p>
<p>This lets the aggregator work as a message barrier, where arriving messages are held until the release strategy fires and the group is released as a sequence of individual messages.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_literal_releasestrategy_literal" href="#_literal_releasestrategy_literal"></a><code class="literal">ReleaseStrategy</code></h4></div></div></div>

<p>The <code class="literal">ReleaseStrategy</code> interface is defined as follows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> ReleaseStrategy {

  <span class="hl-keyword">boolean</span> canRelease(MessageGroup group);

}</pre>
</div>
<p>In general, any POJO can implement the completion decision logic if it provides a method that accepts a single <code class="literal">java.util.List</code> as an argument (parameterized lists are supported as well) and returns a boolean value.
This method is invoked after the arrival of each new message, to decide whether the group is complete or not, as follows:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
If the argument is a <code class="literal">java.util.List&lt;T&gt;</code> and the parameter type <code class="literal">T</code> is assignable to <code class="literal">Message</code>, the whole list of messages accumulated in the group is sent to the method.
</li><li class="listitem">
If the argument is a non-parametrized <code class="literal">java.util.List</code> or the parameter type is not assignable to <code class="literal">Message</code>, the method receives the payloads of the accumulated messages.
</li><li class="listitem">
The method must return <code class="literal">true</code> if the message group is ready for aggregation or false otherwise.
</li></ul></div>
<p>The following example shows how to use the <code class="literal">@ReleaseStrategy</code> annotation for a <code class="literal">List</code> of type <code class="literal">Message</code>:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyReleaseStrategy {

    <em><span class="hl-annotation" style="color: gray">@ReleaseStrategy</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">boolean</span> canMessagesBeReleased(List&lt;Message&lt;?&gt;&gt;) {...}
}</pre>
</div>
<p>The following example shows how to use the <code class="literal">@ReleaseStrategy</code> annotation for a <code class="literal">List</code> of type <code class="literal">String</code>:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyReleaseStrategy {

    <em><span class="hl-annotation" style="color: gray">@ReleaseStrategy</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">boolean</span> canMessagesBeReleased(List&lt;String&gt;) {...}
}</pre>
</div>
<p>Based on the signatures in the preceding two examples, the POJO-based release strategy is passed a <code class="literal">Collection</code> of not-yet-released messages (if you need access to the whole <code class="literal">Message</code>) or a <code class="literal">Collection</code> of payload objects (if the type parameter is anything other than <code class="literal">Message</code>).
This satisfies the majority of use cases.
However if, for some reason, you need to access the full <code class="literal">MessageGroup</code>, you should provide an implementation of the <code class="literal">ReleaseStrategy</code> interface.</p>
<div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Warning"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Warning]" src="images/warning.png"></td><th align="left">Warning</th></tr><tr><td align="left" valign="top">
<p>When handling potentially large groups, you should understand how these methods are invoked, because the release strategy may be invoked multiple times before the group is released.
The most efficient is an implementation of <code class="literal">ReleaseStrategy</code>, because the aggregator can invoke it directly.
The second most efficient is a POJO method with a <code class="literal">Collection&lt;Message&lt;?&gt;&gt;</code> parameter type.
The least efficient is a POJO method with a <code class="literal">Collection&lt;Something&gt;</code> type. The framework has to copy the payloads from the messages in the group into a new collection (and possibly attempt conversion on the payloads to <code class="literal">Something</code>) every time the release strategy is called.
Using <code class="literal">Collection&lt;?&gt;</code> avoids the conversion but still requires creating the new <code class="literal">Collection</code>.</p>
<p>For these reasons, for large groups, we recommended that you implement <code class="literal">ReleaseStrategy</code>.</p>
</td></tr></table></div>
<p>When the group is released for aggregation, all its not-yet-released messages are processed and removed from the group.
If the group is also complete (that is, if all messages from a sequence have arrived or if there is no sequence defined), then the group is marked as complete.
Any new messages for this group are sent to the discard channel (if defined).
Setting <code class="literal">expire-groups-upon-completion</code> to <code class="literal">true</code> (the default is <code class="literal">false</code>) removes the entire group, and any new messages (with the same correlation ID as the removed group) form a new group.
You can release partial sequences by using a <code class="literal">MessageGroupStoreReaper</code> together with <code class="literal">send-partial-result-on-expiry</code> being set to <code class="literal">true</code>.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>To facilitate discarding of late-arriving messages, the aggregator must maintain state about the group after it has been released.
This can eventually cause out-of-memory conditions.
To avoid such situations, you should consider configuring a <code class="literal">MessageGroupStoreReaper</code> to remove the group metadata.
The expiry parameters should be set to expire groups once a point has been reach after after which late messages are not expected to arrive.
For information about configuring a reaper, see <a class="xref" href="messaging-routing-chapter.html#reaper" title="8.4.4&nbsp;Managing State in an Aggregator: MessageGroupStore">Section&nbsp;8.4.4, &#8220;Managing State in an Aggregator: <code class="literal">MessageGroupStore</code>&#8221;</a>.</p>
</td></tr></table></div>
<p>Spring Integration provides an implementation for <code class="literal">ReleaseStrategy</code>: <code class="literal">SimpleSequenceSizeReleaseStrategy</code>.
This implementation consults the <code class="literal">SEQUENCE_NUMBER</code> and <code class="literal">SEQUENCE_SIZE</code> headers of each arriving message to decide when a message group is complete and ready to be aggregated.
As shown earlier, it is also the default strategy.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Before version 5.0, the default release strategy was <code class="literal">SequenceSizeReleaseStrategy</code>, which does not perform well with large groups.
With that strategy, duplicate sequence numbers are detected and rejected.
This operation can be expensive.</p>
</td></tr></table></div>
<p>If you are aggregating large groups, you don&#8217;t need to release partial groups, and you don&#8217;t need to detect/reject duplicate sequences, consider using the <code class="literal">SimpleSequenceSizeReleaseStrategy</code> instead - it is much more efficient for these use cases, and is the default since <span class="emphasis"><em>version 5.0</em></span> when partial group release is not specified.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_aggregating_large_groups" href="#_aggregating_large_groups"></a>Aggregating Large Groups</h4></div></div></div>

<p>The 4.3 release changed the default <code class="literal">Collection</code> for messages in a <code class="literal">SimpleMessageGroup</code> to <code class="literal">HashSet</code> (it was previously a <code class="literal">BlockingQueue</code>).
This was expensive when removing individual messages from large groups (an O(n) linear scan was required).
Although the hash set is generally much faster to remove, it can be expensive for large messages, because the hash has to be calculated on both inserts and removes.
If you have messages that are expensive to hash, consider using some other collection type.
As discussed in <a class="xref" href="system-management-chapter.html#message-group-factory" title="12.4.1&nbsp;Using MessageGroupFactory">Section&nbsp;12.4.1, &#8220;Using <code class="literal">MessageGroupFactory</code>&#8221;</a>, a <code class="literal">SimpleMessageGroupFactory</code> is provided so that you can select the <code class="literal">Collection</code> that best suits your needs.
You can also provide your own factory implementation to create some other <code class="literal">Collection&lt;Message&lt;?&gt;&gt;</code>.</p>
<p>The following example shows how to configure an aggregator with the previous implementation and a <code class="literal">SimpleSequenceSizeReleaseStrategy</code>:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:aggregator</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"aggregate"</span>
    <span class="hl-attribute">output-channel</span>=<span class="hl-value">"out"</span> <span class="hl-attribute">message-store</span>=<span class="hl-value">"store"</span> <span class="hl-attribute">release-strategy</span>=<span class="hl-value">"releaser"</span><span class="hl-tag"> /&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"store"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.store.SimpleMessageStore"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"messageGroupFactory"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.store.SimpleMessageGroupFactory"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"BLOCKING_QUEUE"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/bean&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"releaser"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"SimpleSequenceSizeReleaseStrategy"</span><span class="hl-tag"> /&gt;</span></pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_correlation_strategy" href="#_correlation_strategy"></a>Correlation Strategy</h4></div></div></div>

<p>The <code class="literal">CorrelationStrategy</code> interface is defined as follows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> CorrelationStrategy {

  Object getCorrelationKey(Message&lt;?&gt; message);

}</pre>
</div>
<p>The method returns an <code class="literal">Object</code> that represents the correlation key used for associating the message with a message group.
The key must satisfy the criteria used for a key in a <code class="literal">Map</code> with respect to the implementation of <code class="literal">equals()</code> and <code class="literal">hashCode()</code>.</p>
<p>In general, any POJO can implement the correlation logic, and the rules for mapping a message to a method&#8217;s argument (or arguments) are the same as for a <code class="literal">ServiceActivator</code> (including support for <code class="literal">@Header</code> annotations).
The method must return a value, and the value must not be <code class="literal">null</code>.</p>
<p>Spring Integration provides an implementation for <code class="literal">CorrelationStrategy</code>: <code class="literal">HeaderAttributeCorrelationStrategy</code>.
This implementation returns the value of one of the message headers (whose name is specified by a constructor argument) as the correlation key.
By default, the correlation strategy is a <code class="literal">HeaderAttributeCorrelationStrategy</code> that returns the value of the <code class="literal">CORRELATION_ID</code> header attribute.
If you have a custom header name you would like to use for correlation, you can configure it on an instance of <code class="literal">HeaderAttributeCorrelationStrategy</code> and provide that as a reference for the aggregator&#8217;s correlation strategy.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_lock_registry" href="#_lock_registry"></a>Lock Registry</h4></div></div></div>

<p>Changes to groups are thread safe.
So, when you send messages for the same correlation ID concurrently, only one of them will be processed in the aggregator, making it effectively as a <span class="strong"><strong>single-threaded per message group</strong></span>.
A <code class="literal">LockRegistry</code> is used to obtain a lock for the resolved correlation ID.
A <code class="literal">DefaultLockRegistry</code> is used by default (in-memory).
For synchronizing updates across servers where a shared <code class="literal">MessageGroupStore</code> is being used, you must configure a shared lock registry.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="aggregator-deadlocks" href="#aggregator-deadlocks"></a>Avoiding Deadlocks</h4></div></div></div>

<p>As discussed above, when message groups are mutated (messages added or released) a lock is held.</p>
<p>Consider the following flow:</p>
<div class="informalexample">
<pre class="screen">...-&gt;aggregator1-&gt; ... -&gt;aggregator2-&gt; ...</pre>
</div>
<p>If there are multiple threads, <span class="strong"><strong>and the aggregators share a common lock registry</strong></span>, it is possible to get a deadlock.
This will cause hung threads and <code class="literal">jstack &lt;pid&gt;</code> might present a result such as:</p>
<div class="informalexample">
<pre class="screen">Found one Java-level deadlock:
=============================
"t2":
  waiting for ownable synchronizer 0x000000076c1cbfa0, (a java.util.concurrent.locks.ReentrantLock$NonfairSync),
  which is held by "t1"
"t1":
  waiting for ownable synchronizer 0x000000076c1ccc00, (a java.util.concurrent.locks.ReentrantLock$NonfairSync),
  which is held by "t2"</pre>
</div>
<p>There are several ways to avoid this problem:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
ensure each aggregator has its own lock registry (this can be a shared registry across application instances but two or more aggregators in the flow must each have a distinct registry)
</li><li class="listitem">
use an <code class="literal">ExecutorChannel</code> or <code class="literal">QueueChannel</code> as the output channel of the aggregator so that the downstream flow runs on a new thread
</li><li class="listitem">
starting with version 5.1.1, set the <code class="literal">releaseLockBeforeSend</code> aggregator property to <code class="literal">true</code>
</li></ul></div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>This problem can also be caused if, for some reason, the output of a single aggregator is eventually routed back to the same aggregator.
Of course, the first solution above does not apply in this case.</p>
</td></tr></table></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="aggregator-java-dsl" href="#aggregator-java-dsl"></a>8.4.3&nbsp;Configuring an Aggregator in Java DSL</h3></div></div></div>

<p>See <a class="xref" href="java-dsl.html#java-dsl-aggregators" title="11.9&nbsp;Aggregators and Resequencers">Section&nbsp;11.9, &#8220;Aggregators and Resequencers&#8221;</a> for how to configure an aggregator in Java DSL.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="aggregator-xml" href="#aggregator-xml"></a>Configuring an Aggregator with XML</h4></div></div></div>

<p>Spring Integration supports the configuration of an aggregator with XML through the <code class="literal">&lt;aggregator/&gt;</code> element.
The following example shows an example of an aggregator:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"inputChannel"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int:aggregator</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myAggregator"</span>                          <a name="CO5-1" href="#CO5-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
        auto-startup="true"                                <a name="CO5-2" href="#CO5-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
        input-channel="inputChannel"                       <a name="CO5-3" href="#CO5-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
        output-channel="outputChannel"                     <a name="CO5-4" href="#CO5-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
        discard-channel="throwAwayChannel"                 <a name="CO5-5" href="#CO5-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
        message-store="persistentMessageStore"             <a name="CO5-6" href="#CO5-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>
        order="1"                                          <a name="CO5-7" href="#CO5-7"></a><span><img src="images/callouts/7.png" alt="7" border="0"></span>
        send-partial-result-on-expiry="false"              <a name="CO5-8" href="#CO5-8"></a><span><img src="images/callouts/8.png" alt="8" border="0"></span>
        send-timeout="1000"                                <a name="CO5-9" href="#CO5-9"></a><span><img src="images/callouts/9.png" alt="9" border="0"></span>

        correlation-strategy="correlationStrategyBean"     <a name="CO5-10" href="#CO5-10"></a><span><img src="images/callouts/10.png" alt="10" border="0"></span>
        correlation-strategy-method="correlate"            <a name="CO5-11" href="#CO5-11"></a><span><img src="images/callouts/11.png" alt="11" border="0"></span>
        correlation-strategy-expression="headers['foo']"   <a name="CO5-12" href="#CO5-12"></a><span><img src="images/callouts/12.png" alt="12" border="0"></span>

        ref="aggregatorBean"                               <a name="CO5-13" href="#CO5-13"></a><span><img src="images/callouts/13.png" alt="13" border="0"></span>
        method="aggregate"                                 <a name="CO5-14" href="#CO5-14"></a><span><img src="images/callouts/14.png" alt="14" border="0"></span>

        release-strategy="releaseStrategyBean"             <a name="CO5-15" href="#CO5-15"></a><span><img src="images/callouts/15.png" alt="15" border="0"></span>
        release-strategy-method="release"                  <a name="CO5-16" href="#CO5-16"></a>(16)
        release-strategy-expression="size() == 5"          <a name="CO5-17" href="#CO5-17"></a>(17)

        expire-groups-upon-completion="false"              <a name="CO5-18" href="#CO5-18"></a>(18)
        empty-group-min-timeout="60000"                    <a name="CO5-19" href="#CO5-19"></a>(19)

        lock-registry="lockRegistry"                       <a name="CO5-20" href="#CO5-20"></a>(20)

        group-timeout="60000"                              <a name="CO5-21" href="#CO5-21"></a>(21)
        group-timeout-expression="size() ge 2 ? 100 : -1"  <a name="CO5-22" href="#CO5-22"></a>(22)
        expire-groups-upon-timeout="true"                  <a name="CO5-23" href="#CO5-23"></a>(23)

        scheduler="taskScheduler" &gt;                        <a name="CO5-24" href="#CO5-24"></a>(24)
            <span class="hl-tag">&lt;expire-transactional/&gt;</span>                        <a name="CO5-25" href="#CO5-25"></a>(25)
            <span class="hl-tag">&lt;expire-advice-chain/&gt;</span>                         <a name="CO5-26" href="#CO5-26"></a>(26)
<span class="hl-tag">&lt;/aggregator&gt;</span>

<span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"outputChannel"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"throwAwayChannel"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"persistentMessageStore"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.jdbc.store.JdbcMessageStore"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"dataSource"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"aggregatorBean"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"sample.PojoAggregator"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"releaseStrategyBean"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"sample.PojoReleaseStrategy"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"correlationStrategyBean"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"sample.PojoCorrelationStrategy"</span><span class="hl-tag">/&gt;</span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO5-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The id of the aggregator is optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO5-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Lifecycle attribute signaling whether the aggregator should be started during application context startup.
Optional (the default is <span class="emphasis"><em>true</em></span>).</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO5-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The channel from which where aggregator receives messages.
Required.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO5-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The channel to which the aggregator sends the aggregation results.
Optional (because incoming messages can themselves specify a reply channel in the <span class="emphasis"><em>replyChannel</em></span> message header).</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO5-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The channel to which the aggregator sends the messages that timed out (if <code class="literal">send-partial-result-on-expiry</code> is <code class="literal">false</code>).
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO5-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A reference to a <code class="literal">MessageGroupStore</code> used to store groups of messages under their correlation key until they are complete.
Optional.
By default, it is a volatile in-memory store.
See <a class="xref" href="system-management-chapter.html#message-store" title="12.4&nbsp;Message Store">Section&nbsp;12.4, &#8220;Message Store&#8221;</a> for more information.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO5-7"><span><img src="images/callouts/7.png" alt="7" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The order of this aggregator when more than one handle is subscribed to the same <code class="literal">DirectChannel</code> (use for load-balancing purposes).
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO5-8"><span><img src="images/callouts/8.png" alt="8" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Indicates that expired messages should be aggregated and sent to the <span class="emphasis"><em>output-channel</em></span> or <span class="emphasis"><em>replyChannel</em></span> once their containing <code class="literal">MessageGroup</code> is expired (see <a class="ulink" href="https://docs.spring.io/spring-integration/api/org/springframework/integration/store/MessageGroupStore.html#expireMessageGroups-long" target="_top"><code class="literal">MessageGroupStore.expireMessageGroups(long)</code></a>).
One way of expiring a <code class="literal">MessageGroup</code> is by configuring a <code class="literal">MessageGroupStoreReaper</code>.
However you can alternatively expire <code class="literal">MessageGroup</code> by calling <code class="literal">MessageGroupStore.expireMessageGroups(timeout)</code>.
You can accomplish that through a Control Bus operation or, if you have a reference to the <code class="literal">MessageGroupStore</code> instance, by invoking <code class="literal">expireMessageGroups(timeout)</code>.
Otherwise, by itself, this attribute does nothing.
It serves only as an indicator of whether to discard or send to the output or reply channel any messages that are still in the <code class="literal">MessageGroup</code> that is about to be expired.
Optional (the default is <code class="literal">false</code>).
NOTE: This attribute might more properly be called <code class="literal">send-partial-result-on-timeout</code>, because the group may not actually expire if <code class="literal">expire-groups-upon-timeout</code> is set to <code class="literal">false</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO5-9"><span><img src="images/callouts/9.png" alt="9" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The timeout interval to wait when sending a reply <code class="literal">Message</code> to the <code class="literal">output-channel</code> or <code class="literal">discard-channel</code>.
Defaults to <code class="literal">-1</code>, which results in blocking indefinitely.
It is applied only if the output channel has some <span class="emphasis"><em>sending</em></span> limitations, such as a <code class="literal">QueueChannel</code> with a fixed <span class="emphasis"><em>capacity</em></span>.
In this case, a <code class="literal">MessageDeliveryException</code> is thrown.
For <code class="literal">AbstractSubscribableChannel</code> implementations, the <code class="literal">send-timeout</code> is ignored .
For <code class="literal">group-timeout(-expression)</code>, the <code class="literal">MessageDeliveryException</code> from the scheduled expire task leads this task to be rescheduled.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO5-10"><span><img src="images/callouts/10.png" alt="10" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A reference to a bean that implements the message correlation (grouping) algorithm.
The bean can be an implementation of the <code class="literal">CorrelationStrategy</code> interface or a POJO.
In the latter case, the <code class="literal">correlation-strategy-method</code> attribute must be defined as well.
Optional (by default, the aggregator uses the <code class="literal">IntegrationMessageHeaderAccessor.CORRELATION_ID</code> header).</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO5-11"><span><img src="images/callouts/11.png" alt="11" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A method defined on the bean referenced by <code class="literal">correlation-strategy</code>.
It implements the correlation decision algorithm.
Optional, with restrictions (<code class="literal">correlation-strategy</code> must be present).</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO5-12"><span><img src="images/callouts/12.png" alt="12" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A SpEL expression representing the correlation strategy.
Example: <code class="literal">"headers['something']"</code>.
Only one of <code class="literal">correlation-strategy</code> or <code class="literal">correlation-strategy-expression</code> is allowed.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO5-13"><span><img src="images/callouts/13.png" alt="13" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A reference to a bean defined in the application context.
The bean must implement the aggregation logic, as described earlier.
Optional (by default, the list of aggregated messages becomes a payload of the output message).</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO5-14"><span><img src="images/callouts/14.png" alt="14" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A method defined on the bean referenced by the <code class="literal">ref</code> attribute.
It implements the message aggregation algorithm.
Optional (it depends on <code class="literal">ref</code> attribute being defined).</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO5-15"><span><img src="images/callouts/15.png" alt="15" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A reference to a bean that implements the release strategy.
The bean can be an implementation of the <code class="literal">ReleaseStrategy</code> interface or a POJO.
In the latter case, the <code class="literal">release-strategy-method</code> attribute must be defined as well.
Optional (by default, the aggregator uses the <code class="literal">IntegrationMessageHeaderAccessor.SEQUENCE_SIZE</code> header attribute).</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO5-16">(16)</a> </p></td><td valign="top" align="left">
<p>A method defined on the bean referenced by the <code class="literal">release-strategy</code> attribute.
It implements the completion decision algorithm.
Optional, with restrictions (<code class="literal">release-strategy</code> must be present).</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO5-17">(17)</a> </p></td><td valign="top" align="left">
<p>A SpEL expression representing the release strategy.
The root object for the expression is a <code class="literal">MessageGroup</code>.
Example: <code class="literal">"size() == 5"</code>.
Only one of <code class="literal">release-strategy</code> or <code class="literal">release-strategy-expression</code> is allowed.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO5-18">(18)</a> </p></td><td valign="top" align="left">
<p>When set to <code class="literal">true</code> (the default is <code class="literal">false</code>), completed groups are removed from the message store, letting subsequent messages with the same correlation form a new group.
The default behavior is to send messages with the same correlation as a completed group to the <code class="literal">discard-channel</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO5-19">(19)</a> </p></td><td valign="top" align="left">
<p>Applies only if a <code class="literal">MessageGroupStoreReaper</code> is configured for the <code class="literal">MessageStore</code> of the <code class="literal">&lt;aggregator&gt;</code>.
By default, when a <code class="literal">MessageGroupStoreReaper</code> is configured to expire partial groups, empty groups are also removed.
Empty groups exist after a group is normally released.
The empty groups enable the detection and discarding of late-arriving messages.
If you wish to expire empty groups on a longer schedule than expiring partial groups, set this property.
Empty groups are then not removed from the <code class="literal">MessageStore</code> until they have not been modified for at least this number of milliseconds.
Note that the actual time to expire an empty group is also affected by the reaper&#8217;s <code class="literal">timeout</code> property, and it could be as much as this value plus the timeout.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO5-20">(20)</a> </p></td><td valign="top" align="left">
<p>A reference to a <code class="literal">org.springframework.integration.util.LockRegistry</code> bean.
It used to obtain a <code class="literal">Lock</code> based on the <code class="literal">groupId</code> for concurrent operations on the <code class="literal">MessageGroup</code>.
By default, an internal <code class="literal">DefaultLockRegistry</code> is used.
Use of a distributed <code class="literal">LockRegistry</code>, such as the <code class="literal">ZookeeperLockRegistry</code>, ensures only one instance of the aggregator can operate on a group concurrently.
See <a class="xref" href="redis.html#redis-lock-registry" title="27.10&nbsp;Redis Lock Registry">Section&nbsp;27.10, &#8220;Redis Lock Registry&#8221;</a>, <a class="xref" href="gemfire.html#gemfire-lock-registry" title="19.5&nbsp;Gemfire Lock Registry">Section&nbsp;19.5, &#8220;Gemfire Lock Registry&#8221;</a>, and <a class="xref" href="zookeeper.html#zk-lock-registry" title="40.2&nbsp;Zookeeper Lock Registry">Section&nbsp;40.2, &#8220;Zookeeper Lock Registry&#8221;</a> for more information.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO5-21">(21)</a> </p></td><td valign="top" align="left">
<p>A timeout (in milliseconds) to force the <code class="literal">MessageGroup</code> complete when the <code class="literal">ReleaseStrategy</code> does not release the group when the current message arrives.
This attribute provides a built-in time-based release strategy for the aggregator when there is a need to emit a partial result (or discard the group) if a new message does not arrive for the <code class="literal">MessageGroup</code> within the timeout.
When a new message arrives at the aggregator, any existing <code class="literal">ScheduledFuture&lt;?&gt;</code> for its <code class="literal">MessageGroup</code> is canceled.
If the <code class="literal">ReleaseStrategy</code> returns <code class="literal">false</code> (meaning do not release) and <code class="literal">groupTimeout &gt; 0</code>, a new task is scheduled to expire the group.
We do not advise setting this attribute to zero (or a negative value).
Doing so effectively disables the aggregator, because every message group is immediately completed.
You can, however, conditionally set it to zero (or a negative value) by using an expression.
See <code class="literal">group-timeout-expression</code> for information.
The action taken during the completion depends on the <code class="literal">ReleaseStrategy</code> and the <code class="literal">send-partial-group-on-expiry</code> attribute.
See <a class="xref" href="messaging-routing-chapter.html#agg-and-group-to" title="Aggregator and Group Timeout">the section called &#8220;Aggregator and Group Timeout&#8221;</a> for more information.
It is mutually exclusive with <span class="emphasis"><em>group-timeout-expression</em></span> attribute.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO5-22">(22)</a> </p></td><td valign="top" align="left">
<p>The SpEL expression that evaluates to a <code class="literal">groupTimeout</code> with the <code class="literal">MessageGroup</code> as the <code class="literal">#root</code> evaluation context object.
Used for scheduling the <code class="literal">MessageGroup</code> to be forced complete.
If the expression evaluates to <code class="literal">null</code>, the completion is not scheduled.
If it evaluates to zero, the group is completed immediately on the current thread.
In effect, this provides a dynamic <code class="literal">group-timeout</code> property.
See <code class="literal">group-timeout</code> for more information.
Mutually exclusive with <span class="emphasis"><em>group-timeout</em></span> attribute.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO5-23">(23)</a> </p></td><td valign="top" align="left">
<p>When a group is completed due to a timeout (or by a <code class="literal">MessageGroupStoreReaper</code>), the group is expired (completely removed) by default.
Late arriving messages start a new group.
You can set this to <code class="literal">false</code> to complete the group but have its metadata remain so that late arriving messages are discarded.
Empty groups can be expired later using a <code class="literal">MessageGroupStoreReaper</code> together with the <code class="literal">empty-group-min-timeout</code> attribute.
It defaults to <span class="emphasis"><em>true</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO5-24">(24)</a> </p></td><td valign="top" align="left">
<p>A <code class="literal">TaskScheduler</code> bean reference to schedule the <code class="literal">MessageGroup</code> to be forced complete if no new message arrives for the <code class="literal">MessageGroup</code> within the <code class="literal">groupTimeout</code>.
If not provided, the default scheduler (<code class="literal">taskScheduler</code>) registered in the <code class="literal">ApplicationContext</code> (<code class="literal">ThreadPoolTaskScheduler</code>) is used.
This attribute does not apply if <code class="literal">group-timeout</code> or <code class="literal">group-timeout-expression</code> is not specified.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO5-25">(25)</a> </p></td><td valign="top" align="left">
<p>Since version 4.1.
It lets a transaction be started for the <code class="literal">forceComplete</code> operation.
It is initiated from a <code class="literal">group-timeout(-expression)</code> or by a <code class="literal">MessageGroupStoreReaper</code> and is not applied to the normal <code class="literal">add</code>, <code class="literal">release</code>, and <code class="literal">discard</code> operations.
Only this sub-element or <code class="literal">&lt;expire-advice-chain/&gt;</code> is allowed.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO5-26">(26)</a> </p></td><td valign="top" align="left">
<p>Since <span class="emphasis"><em>version 4.1</em></span>.
It allows the configuration of any <code class="literal">Advice</code> for the <code class="literal">forceComplete</code> operation.
It is initiated from a <code class="literal">group-timeout(-expression)</code> or by a <code class="literal">MessageGroupStoreReaper</code> and is not applied to the normal <code class="literal">add</code>, <code class="literal">release</code>, and <code class="literal">discard</code> operations.
Only this sub-element or <code class="literal">&lt;expire-transactional/&gt;</code> is allowed.
A transaction <code class="literal">Advice</code> can also be configured here by using the Spring <code class="literal">tx</code> namespace.</p>
</td></tr></table></div>
</div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important: Expiring Groups"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Expiring Groups</th></tr><tr><td align="left" valign="top">

<p>There are two attributes related to expiring (completely removing) groups.
When a group is expired, there is no record of it, and, if a new message arrives with the same correlation, a new group is started.
When a group is completed (without expiry), the empty group remains and late-arriving messages are discarded.
Empty groups can be removed later by using a <code class="literal">MessageGroupStoreReaper</code> in combination with the <code class="literal">empty-group-min-timeout</code> attribute.</p>
<p><code class="literal">expire-groups-upon-completion</code> relates to "<code class="literal">normal</code>" completion when the <code class="literal">ReleaseStrategy</code> releases the group.
This defaults to <code class="literal">false</code>.</p>
<p>If a group is not completed normally but is released or discarded because of a timeout, the group is normally expired.
Since version 4.1, you can control this behavior by using <code class="literal">expire-groups-upon-timeout</code>.
It defaults to <code class="literal">true</code> for backwards compatibility.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>When a group is timed out, the <code class="literal">ReleaseStrategy</code> is given one more opportunity to release the group.
If it does so and <code class="literal">expire-groups-upon-timeout</code> is false, expiration is controlled by <code class="literal">expire-groups-upon-completion</code>.
If the group is not released by the release strategy during timeout, then the expiration is controlled by the <code class="literal">expire-groups-upon-timeout</code>.
Timed-out groups are either discarded or a partial release occurs (based on <code class="literal">send-partial-result-on-expiry</code>).</p>
</td></tr></table></div>
<p>Since version 5.0, empty groups are also scheduled for removal after <code class="literal">empty-group-min-timeout</code>.
If <code class="literal">expireGroupsUponCompletion == false</code> and <code class="literal">minimumTimeoutForEmptyGroups &gt; 0</code>, the task to remove the group is scheduled when normal or partial sequences release happens.</p>
</td></tr></table></div>
<p>We generally recommend using a <code class="literal">ref</code> attribute if a custom aggregator handler implementation may be referenced in other <code class="literal">&lt;aggregator&gt;</code> definitions.
However, if a custom aggregator implementation is only being used by a single definition of the <code class="literal">&lt;aggregator&gt;</code>, you can use an inner bean definition (starting with version 1.0.3) to configure the aggregation POJO within the <code class="literal">&lt;aggregator&gt;</code> element, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;aggregator</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"sum"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;beans:bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.foo.PojoAggregator"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/aggregator&gt;</span></pre>
</div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Using both a <code class="literal">ref</code> attribute and an inner bean definition in the same <code class="literal">&lt;aggregator&gt;</code> configuration is not allowed, as it creates an ambiguous condition.
In such cases, an Exception is thrown.</p>
</td></tr></table></div>
<p>The following example shows an implementation of the aggregator bean:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> PojoAggregator {

  <span class="hl-keyword">public</span> Long add(List&lt;Long&gt; results) {
    <span class="hl-keyword">long</span> total = <span class="hl-number">0l</span>;
    <span class="hl-keyword">for</span> (<span class="hl-keyword">long</span> partialResult: results) {
      total += partialResult;
    }
    <span class="hl-keyword">return</span> total;
  }
}</pre>
</div>
<p>An implementation of the completion strategy bean for the preceding example might be as follows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> PojoReleaseStrategy {
...
  <span class="hl-keyword">public</span> <span class="hl-keyword">boolean</span> canRelease(List&lt;Long&gt; numbers) {
    <span class="hl-keyword">int</span> sum = <span class="hl-number">0</span>;
    <span class="hl-keyword">for</span> (<span class="hl-keyword">long</span> number: numbers) {
      sum += number;
    }
    <span class="hl-keyword">return</span> sum &gt;= maxValue;
  }
}</pre>
</div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Wherever it makes sense to do so, the release strategy method and the aggregator method can be combined into a single bean.</p>
</td></tr></table></div>
<p>An implementation of the correlation strategy bean for the example above might be as follows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> PojoCorrelationStrategy {
...
  <span class="hl-keyword">public</span> Long groupNumbersByLastDigit(Long number) {
    <span class="hl-keyword">return</span> number % <span class="hl-number">10</span>;
  }
}</pre>
</div>
<p>The aggregator in the preceding example would group numbers by some criterion (in this case, the remainder after dividing by ten) and hold the group until the sum of the numbers provided by the payloads exceeds a certain value.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Wherever it makes sense to do so, the release strategy method, the correlation strategy method, and the aggregator method can be combined in a single bean.
(Actually, all of them or any two of them can be combined.)</p>
</td></tr></table></div>
<div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="aggregator-spel" href="#aggregator-spel"></a>Aggregators and Spring Expression Language (SpEL)</h5></div></div></div>

<p>Since Spring Integration 2.0, you can handle the various strategies (correlation, release, and aggregation) with <a class="ulink" href="http://docs.spring.io/spring/docs/current/spring-framework-reference/html/expressions.html" target="_top">SpEL</a>, which we recommend if the logic behind such a release strategy is relatively simple.
Suppose you have a legacy component that was designed to receive an array of objects.
We know that the default release strategy assembles all aggregated messages in the <code class="literal">List</code>.
Now we have two problems.
First, we need to extract individual messages from the list. Second, we need to extract the payload of each message and assemble the array of objects.
The following example solves both problems:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> String[] processRelease(List&lt;Message&lt;String&gt;&gt; messages){
    List&lt;String&gt; stringList = <span class="hl-keyword">new</span> ArrayList&lt;String&gt;();
    <span class="hl-keyword">for</span> (Message&lt;String&gt; message : messages) {
        stringList.add(message.getPayload());
    }
    <span class="hl-keyword">return</span> stringList.toArray(<span class="hl-keyword">new</span> String[]{});
}</pre>
</div>
<p>However, with SpEL, such a requirement could actually be handled relatively easily with a one-line expression, thus sparing you from writing a custom class and configuring it as a bean.
The following example shows how to do so:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:aggregator</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"aggChannel"</span>
    <span class="hl-attribute">output-channel</span>=<span class="hl-value">"replyChannel"</span>
    <span class="hl-attribute">expression</span>=<span class="hl-value">"#this.![payload].toArray()"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>In the preceding configuration, we use a <a class="ulink" href="http://docs.spring.io/spring/docs/current/spring-framework-reference/html/expressions.html#expressions-collection-projection" target="_top">collection projection</a> expression to assemble a new collection from the payloads of all the messages in the list and then transform it to an array, thus achieving the same result as the earlier Java code.</p>
<p>You can apply the same expression-based approach when dealing with custom release and correlation strategies.</p>
<p>Instead of defining a bean for a custom <code class="literal">CorrelationStrategy</code> in the <code class="literal">correlation-strategy</code> attribute, you can implement your simple correlation logic as a SpEL expression and configure it in the <code class="literal">correlation-strategy-expression</code> attribute, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting">correlation-strategy-expression="payload.person.id"</pre>
</div>
<p>In the preceding example, we assume that the payload has a <code class="literal">person</code> attribute with an <code class="literal">id</code>, which is going to be used to correlate messages.</p>
<p>Likewise, for the <code class="literal">ReleaseStrategy</code>, you can implement your release logic as a SpEL expression and configure it in the <code class="literal">release-strategy-expression</code> attribute.
The root object for evaluation context is the <code class="literal">MessageGroup</code> itself.
The <code class="literal">List</code> of messages can be referenced by using the <code class="literal">message</code> property of the group within the expression.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>In releases prior to version 5.0, the root object was the collection of <code class="literal">Message&lt;?&gt;</code>, as the previous example shows:</p>
</td></tr></table></div>
<div class="informalexample">
<pre class="programlisting">release-strategy-expression="!messages.?[payload==5].empty"</pre>
</div>
<p>In the preceding example, the root object of the SpEL evaluation context is the <code class="literal">MessageGroup</code> itself, and you are stating that, as soon as there is a message with payload of <code class="literal">5</code> in this group, the group should be released.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="agg-and-group-to" href="#agg-and-group-to"></a>Aggregator and Group Timeout</h5></div></div></div>

<p>Starting with version 4.0, two new mutually exclusive attributes have been introduced: <code class="literal">group-timeout</code> and <code class="literal">group-timeout-expression</code> (see the earlier description).
See <a class="xref" href="messaging-routing-chapter.html#aggregator-xml" title="Configuring an Aggregator with XML">the section called &#8220;Configuring an Aggregator with XML&#8221;</a>.
In some cases, you may need to emit the aggregator result (or discard the group) after a timeout if the <code class="literal">ReleaseStrategy</code> does not release when the current message arrives.
For this purpose, the <code class="literal">groupTimeout</code> option lets scheduling the <code class="literal">MessageGroup</code> be forced to complete, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;aggregator</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span>
        <span class="hl-attribute">send-partial-result-on-expiry</span>=<span class="hl-value">"true"</span>
        <span class="hl-attribute">group-timeout-expression</span>=<span class="hl-value">"size() ge 2 ? 10000 : -1"</span>
        <span class="hl-attribute">release-strategy-expression</span>=<span class="hl-value">"messages[0].headers.sequenceNumber == messages[0].headers.sequenceSize"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>With this example, the normal release is possible if the aggregator receives the last message in sequence as defined by the <code class="literal">release-strategy-expression</code>.
If that specific message does not arrive, the <code class="literal">groupTimeout</code> forces the group to complete after ten seconds, as long as the group contains at least two Messages.</p>
<p>The results of forcing the group to complete depends on the <code class="literal">ReleaseStrategy</code> and the <code class="literal">send-partial-result-on-expiry</code>.
First, the release strategy is again consulted to see if a normal release is to be made.
While the group has not changed, the <code class="literal">ReleaseStrategy</code> can decide to release the group at this time.
If the release strategy still does not release the group, it is expired.
If <code class="literal">send-partial-result-on-expiry</code> is <code class="literal">true</code>, existing messages in the (partial) <code class="literal">MessageGroup</code> are released as a normal aggregator reply message to the <code class="literal">output-channel</code>.
Otherwise, it is discarded.</p>
<p>There is a difference between <code class="literal">groupTimeout</code> behavior and <code class="literal">MessageGroupStoreReaper</code> (see <a class="xref" href="messaging-routing-chapter.html#aggregator-xml" title="Configuring an Aggregator with XML">the section called &#8220;Configuring an Aggregator with XML&#8221;</a>).
The reaper initiates forced completion for all <code class="literal">MessageGroup</code> s in the <code class="literal">MessageGroupStore</code> periodically.
The <code class="literal">groupTimeout</code> does it for each <code class="literal">MessageGroup</code> individually if a new message does not arrive during the <code class="literal">groupTimeout</code>.
Also, the reaper can be used to remove empty groups (empty groups are retained in order to discard late messages if <code class="literal">expire-groups-upon-completion</code> is false).</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="aggregator-annotations" href="#aggregator-annotations"></a>Configuring an Aggregator with Annotations</h4></div></div></div>

<p>The following example shows an aggregator configured with annotations:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> Waiter {
  ...

  <em><span class="hl-annotation" style="color: gray">@Aggregator</span></em>  <a name="CO6-1" href="#CO6-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
  <span class="hl-keyword">public</span> Delivery aggregatingMethod(List&lt;OrderItem&gt; items) {
    ...
  }

  <em><span class="hl-annotation" style="color: gray">@ReleaseStrategy</span></em>  <a name="CO6-2" href="#CO6-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
  <span class="hl-keyword">public</span> <span class="hl-keyword">boolean</span> releaseChecker(List&lt;Message&lt;?&gt;&gt; messages) {
    ...
  }

  <em><span class="hl-annotation" style="color: gray">@CorrelationStrategy</span></em>  <a name="CO6-3" href="#CO6-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
  <span class="hl-keyword">public</span> String correlateBy(OrderItem item) {
    ...
  }
}</pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO6-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>An annotation indicating that this method should be used as an aggregator.
It must be specified if this class is used as an aggregator.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO6-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>An annotation indicating that this method is used as the release strategy of an aggregator.
If not present on any method, the aggregator uses the <code class="literal">SimpleSequenceSizeReleaseStrategy</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO6-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>An annotation indicating that this method should be used as the correlation strategy of an aggregator.
If no correlation strategy is indicated, the aggregator uses the <code class="literal">HeaderAttributeCorrelationStrategy</code> based on <code class="literal">CORRELATION_ID</code>.</p>
</td></tr></table></div>
</div>
<p>All of the configuration options provided by the XML element are also available for the <code class="literal">@Aggregator</code> annotation.</p>
<p>The aggregator can be either referenced explicitly from XML or, if the <code class="literal">@MessageEndpoint</code> is defined on the class, detected automatically through classpath scanning.</p>
<p>Annotation configuration (<code class="literal">@Aggregator</code> and others) for the Aggregator component covers only simple use cases, where most default options are sufficient.
If you need more control over those options when using annotation configuration, consider using a <code class="literal">@Bean</code> definition for the <code class="literal">AggregatingMessageHandler</code> and mark its <code class="literal">@Bean</code> method with <code class="literal">@ServiceActivator</code>, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "aggregatorChannel")</span></em>
<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> MessageHandler aggregator(MessageGroupStore jdbcMessageGroupStore) {
     AggregatingMessageHandler aggregator =
                       <span class="hl-keyword">new</span> AggregatingMessageHandler(<span class="hl-keyword">new</span> DefaultAggregatingMessageGroupProcessor(),
                                                 jdbcMessageGroupStore);
     aggregator.setOutputChannel(resultsChannel());
     aggregator.setGroupTimeoutExpression(<span class="hl-keyword">new</span> ValueExpression&lt;&gt;(<span class="hl-number">500L</span>));
     aggregator.setTaskScheduler(<span class="hl-keyword">this</span>.taskScheduler);
     <span class="hl-keyword">return</span> aggregator;
}</pre>
</div>
<p>See <a class="xref" href="messaging-routing-chapter.html#aggregator-api" title="8.4.2&nbsp;Programming Model">Section&nbsp;8.4.2, &#8220;Programming Model&#8221;</a> and <a class="xref" href="configuration.html#annotations_on_beans" title="E.6.1&nbsp;Annotations on @Bean Methods">Section&nbsp;E.6.1, &#8220;Annotations on <code class="literal">@Bean</code> Methods&#8221;</a> for more information.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Starting with version 4.2, the <code class="literal">AggregatorFactoryBean</code> is available to simplify Java configuration for the <code class="literal">AggregatingMessageHandler</code>.</p>
</td></tr></table></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="reaper" href="#reaper"></a>8.4.4&nbsp;Managing State in an Aggregator: <code class="literal">MessageGroupStore</code></h3></div></div></div>

<p>Aggregator (and some other patterns in Spring Integration) is a stateful pattern that requires decisions to be made based on a group of messages that have arrived over a period of time, all with the same correlation key.
The design of the interfaces in the stateful patterns (such as <code class="literal">ReleaseStrategy</code>) is driven by the principle that the components (whether defined by the framework or by a user) should be able to remain stateless.
All state is carried by the <code class="literal">MessageGroup</code> and its management is delegated to the <code class="literal">MessageGroupStore</code>.
The <code class="literal">MessageGroupStore</code> interface is defined as follows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> MessageGroupStore {

    <span class="hl-keyword">int</span> getMessageCountForAllMessageGroups();

    <span class="hl-keyword">int</span> getMarkedMessageCountForAllMessageGroups();

    <span class="hl-keyword">int</span> getMessageGroupCount();

    MessageGroup getMessageGroup(Object groupId);

    MessageGroup addMessageToGroup(Object groupId, Message&lt;?&gt; message);

    MessageGroup markMessageGroup(MessageGroup group);

    MessageGroup removeMessageFromGroup(Object key, Message&lt;?&gt; messageToRemove);

    MessageGroup markMessageFromGroup(Object key, Message&lt;?&gt; messageToMark);

    <span class="hl-keyword">void</span> removeMessageGroup(Object groupId);

    <span class="hl-keyword">void</span> registerMessageGroupExpiryCallback(MessageGroupCallback callback);

    <span class="hl-keyword">int</span> expireMessageGroups(<span class="hl-keyword">long</span> timeout);
}</pre>
</div>
<p>For more information, see the <a class="ulink" href="http://docs.spring.io/spring-integration/api/org/springframework/integration/store/MessageGroupStore.html" target="_top">Javadoc</a>.</p>
<p>The <code class="literal">MessageGroupStore</code> accumulates state information in <code class="literal">MessageGroups</code> while waiting for a release strategy to be triggered, and that event might not ever happen.
So, to prevent stale messages from lingering, and for volatile stores to provide a hook for cleaning up when the application shuts down, the <code class="literal">MessageGroupStore</code> lets you register callbacks to apply to its <code class="literal">MessageGroups</code> when they expire.
The interface is very straightforward, as the following listing shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> MessageGroupCallback {

    <span class="hl-keyword">void</span> execute(MessageGroupStore messageGroupStore, MessageGroup group);

}</pre>
</div>
<p>The callback has direct access to the store and the message group so that it can manage the persistent state (for example, by entirely removing the group from the store).</p>
<p>The <code class="literal">MessageGroupStore</code> maintains a list of these callbacks, which it applies, on demand, to all messages whose timestamps are earlier than a time supplied as a parameter (see the <code class="literal">registerMessageGroupExpiryCallback(..)</code> and <code class="literal">expireMessageGroups(..)</code> methods, described earlier).
For more detail, see <a class="xref" href="messaging-routing-chapter.html#reaper" title="8.4.4&nbsp;Managing State in an Aggregator: MessageGroupStore">Section&nbsp;8.4.4, &#8220;Managing State in an Aggregator: <code class="literal">MessageGroupStore</code>&#8221;</a>.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>It is important not to use the same <code class="literal">MessageGroupStore</code> instance in different aggregator components, when you intend to rely on the <code class="literal">expireMessageGroups</code> functionality.
Every <code class="literal">AbstractCorrelatingMessageHandler</code> registers its own <code class="literal">MessageGroupCallback</code> based on the <code class="literal">forceComplete()</code> callback.
This way each group for expiration may be completed or discarded by the wrong aggregator.
Starting with version 5.0.10, a <code class="literal">UniqueExpiryCallback</code> is used from the <code class="literal">AbstractCorrelatingMessageHandler</code> for the registration callback in the <code class="literal">MessageGroupStore</code>.
The <code class="literal">MessageGroupStore</code>, in turn, checks for presence an instance of this class and logs an error with an appropriate message if one is already present in the callbacks set.
This way the Framework disallows usage of the <code class="literal">MessageGroupStore</code> instance in different aggregators/resequencers to avoid the mentioned side effect of expiration the groups not created by the particular correlation handler.</p>
</td></tr></table></div>
<p>You can call the <code class="literal">expireMessageGroups</code> method with a timeout value.
Any message older than the current time minus this value is expired and has the callbacks applied.
Thus, it is the user of the store that defines what is meant by message group "<code class="literal">expiry</code>".</p>
<p>As a convenience for users, Spring Integration provides a wrapper for the message expiry in the form of a <code class="literal">MessageGroupStoreReaper</code>, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"reaper"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org...MessageGroupStoreReaper"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"messageGroupStore"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"messageStore"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"timeout"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"30000"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;task:scheduled-tasks</span> <span class="hl-attribute">scheduler</span>=<span class="hl-value">"scheduler"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;task:scheduled</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"reaper"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"run"</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"10000"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/task:scheduled-tasks&gt;</span></pre>
</div>
<p>The reaper is a <code class="literal">Runnable</code>.
In the preceding example, the message group store&#8217;s expire method is called every ten seconds.
The timeout itself is 30 seconds.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>It is important to understand that the <span class="emphasis"><em>timeout</em></span> property of <code class="literal">MessageGroupStoreReaper</code> is an approximate value and is impacted by the the rate of the task scheduler, since this property is only checked on the next scheduled execution of the <code class="literal">MessageGroupStoreReaper</code> task.
For example, if the timeout is set for ten minutes but the <code class="literal">MessageGroupStoreReaper</code> task is scheduled to run every hour and the last execution of the <code class="literal">MessageGroupStoreReaper</code> task happened one minute before the timeout, the <code class="literal">MessageGroup</code> does not expire for the next 59 minutes.
Consequently, we recommend setting the rate to be at least equal to the value of the timeout or shorter.</p>
</td></tr></table></div>
<p>In addition to the reaper, the expiry callbacks are invoked when the application shuts down through a lifecycle callback in the <code class="literal">AbstractCorrelatingMessageHandler</code>.</p>
<p>The <code class="literal">AbstractCorrelatingMessageHandler</code> registers its own expiry callback, and this is the link with the boolean flag <code class="literal">send-partial-result-on-expiry</code> in the XML configuration of the aggregator.
If the flag is set to <code class="literal">true</code>, then, when the expiry callback is invoked, any unmarked messages in groups that are not yet released can be sent on to the output channel.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>When a shared <code class="literal">MessageStore</code> is used for different correlation endpoints, you must configure a proper <code class="literal">CorrelationStrategy</code> to ensure uniqueness for group IDs.
Otherwise, unexpected behavior may happen when one correlation endpoint releases or expire messages from others.
Messages with the same correlation key are stored in the same message group.</p>
<p>Some <code class="literal">MessageStore</code> implementations allow using the same physical resources, by partitioning the data.
For example, the <code class="literal">JdbcMessageStore</code> has a <code class="literal">region</code> property, and the <code class="literal">MongoDbMessageStore</code> has a <code class="literal">collectionName</code> property.</p>
<p>For more information about the <code class="literal">MessageStore</code> interface and its implementations, see <a class="xref" href="system-management-chapter.html#message-store" title="12.4&nbsp;Message Store">Section&nbsp;12.4, &#8220;Message Store&#8221;</a>.</p>
</td></tr></table></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="resequencer" href="#resequencer"></a>8.5&nbsp;Resequencer</h2></div></div></div>

<p>The resequencer is related to the aggregator but serves a different purpose. While the aggregator combines messages, the resequencer passes messages through without changing them.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="resequencer-functionality" href="#resequencer-functionality"></a>8.5.1&nbsp;Functionality</h3></div></div></div>

<p>The resequencer works in a similar way to the aggregator, in the sense that it uses the <code class="literal">CORRELATION_ID</code> to store messages in groups. he difference is that the Resequencer does not process the messages in any way.
Instead, it releases them in the order of their <code class="literal">SEQUENCE_NUMBER</code> header values.</p>
<p>With respect to that, you can opt to release all messages at once (after the whole sequence, according to the <code class="literal">SEQUENCE_SIZE</code>, and other possibilities) or as soon as a valid sequence is available. (We cover what we mean by "a valid sequence" later in this chapter.)</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>The resequencer is intended to resequence relatively short sequences of messages with small gaps.
If you have a large number of disjoint sequences with many gaps, you may experience performance issues.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_a_resequencer" href="#_configuring_a_resequencer"></a>8.5.2&nbsp;Configuring a Resequencer</h3></div></div></div>

<p>See <a class="xref" href="java-dsl.html#java-dsl-aggregators" title="11.9&nbsp;Aggregators and Resequencers">Section&nbsp;11.9, &#8220;Aggregators and Resequencers&#8221;</a> for configuring a resequencer in Java DSL.</p>
<p>Configuring a resequencer requires only including the appropriate element in XML.</p>
<p>The following example shows a resequencer configuration:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"inputChannel"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"outputChannel"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int:resequencer</span> <span class="hl-attribute">id</span>=<span class="hl-value">"completelyDefinedResequencer"</span>  <a name="CO7-1" href="#CO7-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
  input-channel="inputChannel"  <a name="CO7-2" href="#CO7-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
  output-channel="outputChannel"  <a name="CO7-3" href="#CO7-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
  discard-channel="discardChannel"  <a name="CO7-4" href="#CO7-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
  release-partial-sequences="true"  <a name="CO7-5" href="#CO7-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
  message-store="messageStore"  <a name="CO7-6" href="#CO7-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>
  send-partial-result-on-expiry="true"  <a name="CO7-7" href="#CO7-7"></a><span><img src="images/callouts/7.png" alt="7" border="0"></span>
  send-timeout="86420000"  <a name="CO7-8" href="#CO7-8"></a><span><img src="images/callouts/8.png" alt="8" border="0"></span>
  correlation-strategy="correlationStrategyBean"  <a name="CO7-9" href="#CO7-9"></a><span><img src="images/callouts/9.png" alt="9" border="0"></span>
  correlation-strategy-method="correlate"  <a name="CO7-10" href="#CO7-10"></a><span><img src="images/callouts/10.png" alt="10" border="0"></span>
  correlation-strategy-expression="headers['something']"  <a name="CO7-11" href="#CO7-11"></a><span><img src="images/callouts/11.png" alt="11" border="0"></span>
  release-strategy="releaseStrategyBean"  <a name="CO7-12" href="#CO7-12"></a><span><img src="images/callouts/12.png" alt="12" border="0"></span>
  release-strategy-method="release"  <a name="CO7-13" href="#CO7-13"></a><span><img src="images/callouts/13.png" alt="13" border="0"></span>
  release-strategy-expression="size() == 10"  <a name="CO7-14" href="#CO7-14"></a><span><img src="images/callouts/14.png" alt="14" border="0"></span>
  empty-group-min-timeout="60000"  <a name="CO7-15" href="#CO7-15"></a><span><img src="images/callouts/15.png" alt="15" border="0"></span>

  lock-registry="lockRegistry"  <a name="CO7-16" href="#CO7-16"></a>(16)

  group-timeout="60000"  <a name="CO7-17" href="#CO7-17"></a>(17)
  group-timeout-expression="size() ge 2 ? 100 : -1"  <a name="CO7-18" href="#CO7-18"></a>(18)
  scheduler="taskScheduler" /&gt;  <a name="CO7-19" href="#CO7-19"></a>(19)
  expire-group-upon-timeout="false" /&gt;  <a name="CO7-20" href="#CO7-20"></a>(20)</pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO7-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The id of the resequencer is optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO7-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The input channel of the resequencer.
Required.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO7-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The channel to which the resequencer sends the reordered messages.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO7-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The channel to which the resequencer  sends the messages that timed out (if <code class="literal">send-partial-result-on-timeout</code> is set to <code class="literal">false</code>).
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO7-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Whether to send out ordered sequences as soon as they are available or only after the whole message group arrives.
Optional. (The default is <code class="literal">false</code>.)</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO7-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A reference to a <code class="literal">MessageGroupStore</code> that can be used to store groups of messages under their correlation key until they are complete.
Optional. (The default is a volatile in-memory store.)</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO7-7"><span><img src="images/callouts/7.png" alt="7" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Whether, upon the expiration of the group, the ordered group should be sent out (even if some of the messages are missing).
Optional. (The default is false.)
See <a class="xref" href="messaging-routing-chapter.html#reaper" title="8.4.4&nbsp;Managing State in an Aggregator: MessageGroupStore">Section&nbsp;8.4.4, &#8220;Managing State in an Aggregator: <code class="literal">MessageGroupStore</code>&#8221;</a>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO7-8"><span><img src="images/callouts/8.png" alt="8" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The timeout interval to wait when sending a reply <code class="literal">Message</code> to the <code class="literal">output-channel</code> or <code class="literal">discard-channel</code>.
Defaults to <code class="literal">-1</code>, which blocks indefinitely.
It is applied only if the output channel has some <span class="emphasis"><em>sending</em></span> limitations, such as a  <code class="literal">QueueChannel</code> with a fixed <span class="emphasis"><em>capacity</em></span>.
In this case, a <code class="literal">MessageDeliveryException</code> is thrown.
The <code class="literal">send-timeout</code> is ignored for <code class="literal">AbstractSubscribableChannel</code> implementations.
For <code class="literal">group-timeout(-expression)</code>, the <code class="literal">MessageDeliveryException</code> from the scheduled expire task leads this task to be rescheduled.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO7-9"><span><img src="images/callouts/9.png" alt="9" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A reference to a bean that implements the message correlation (grouping) algorithm.
The bean can be an implementation of the <code class="literal">CorrelationStrategy</code> interface or a POJO.
In the latter case, the <code class="literal">correlation-strategy-method</code> attribute must also be defined.
Optional. (By default, the aggregator uses the <code class="literal">IntegrationMessageHeaderAccessor.CORRELATION_ID</code> header.)</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO7-10"><span><img src="images/callouts/10.png" alt="10" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A method that is defined on the bean referenced by <code class="literal">correlation-strategy</code> and that implements the correlation decision algorithm.
Optional, with restrictions (requires <code class="literal">correlation-strategy</code> to be present).</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO7-11"><span><img src="images/callouts/11.png" alt="11" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A SpEL expression representing the correlation strategy.
Example: <code class="literal">"headers['something']"</code>.
Only one of <code class="literal">correlation-strategy</code> or <code class="literal">correlation-strategy-expression</code> is allowed.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO7-12"><span><img src="images/callouts/12.png" alt="12" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A reference to a bean that implements the release strategy.
The bean can be an implementation of the <code class="literal">ReleaseStrategy</code> interface or a POJO.
In the latter case, the <code class="literal">release-strategy-method</code> attribute must also be defined.
Optional (by default, the aggregator will use the <code class="literal">IntegrationMessageHeaderAccessor.SEQUENCE_SIZE</code> header attribute).</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO7-13"><span><img src="images/callouts/13.png" alt="13" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A method that is defined on the bean referenced by <code class="literal">release-strategy</code> and that implements the completion decision algorithm.
Optional, with restrictions (requires <code class="literal">release-strategy</code> to be present).</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO7-14"><span><img src="images/callouts/14.png" alt="14" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A SpEL expression representing the release strategy.
The root object for the expression is a <code class="literal">MessageGroup</code>.
Example: <code class="literal">"size() == 5"</code>.
Only one of <code class="literal">release-strategy</code> or <code class="literal">release-strategy-expression</code> is allowed.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO7-15"><span><img src="images/callouts/15.png" alt="15" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Only applies if a <code class="literal">MessageGroupStoreReaper</code> is configured for the <code class="literal">&lt;resequencer&gt;</code> <code class="literal">MessageStore</code>.
By default, when a <code class="literal">MessageGroupStoreReaper</code> is configured to expire partial groups, empty groups are also removed.
Empty groups exist after a group is released normally.
This is to enable the detection and discarding of late-arriving messages.
If you wish to expire empty groups on a longer schedule than expiring partial groups, set this property.
Empty groups are then not removed from the <code class="literal">MessageStore</code> until they have not been modified for at least this number of milliseconds.
Note that the actual time to expire an empty group is also affected by the reaper&#8217;s timeout property, and it could be as much as this value plus the timeout.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO7-16">(16)</a> </p></td><td valign="top" align="left">
<p>See <a class="xref" href="messaging-routing-chapter.html#aggregator-xml" title="Configuring an Aggregator with XML">the section called &#8220;Configuring an Aggregator with XML&#8221;</a>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO7-17">(17)</a> </p></td><td valign="top" align="left">
<p>See <a class="xref" href="messaging-routing-chapter.html#aggregator-xml" title="Configuring an Aggregator with XML">the section called &#8220;Configuring an Aggregator with XML&#8221;</a>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO7-18">(18)</a> </p></td><td valign="top" align="left">
<p>See <a class="xref" href="messaging-routing-chapter.html#aggregator-xml" title="Configuring an Aggregator with XML">the section called &#8220;Configuring an Aggregator with XML&#8221;</a>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO7-19">(19)</a> </p></td><td valign="top" align="left">
<p>See <a class="xref" href="messaging-routing-chapter.html#aggregator-xml" title="Configuring an Aggregator with XML">the section called &#8220;Configuring an Aggregator with XML&#8221;</a>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO7-20">(20)</a> </p></td><td valign="top" align="left">
<p>By default, when a group is completed due to a timeout (or by a <code class="literal">MessageGroupStoreReaper</code>), the empty group&#8217;s metadata is retained.
Late arriving messages are immediately discarded.
Set this to <code class="literal">true</code> to remove the group completely.
Then, late arriving messages start a new group and are not be discarded until the group again times out.
The new group is never released normally because of the "<code class="literal">hole</code>" in the sequence range that caused the timeout.
Empty groups can be expired (completely removed) later by using a <code class="literal">MessageGroupStoreReaper</code> together with the <code class="literal">empty-group-min-timeout</code> attribute.
Starting with version 5.0, empty groups are also scheduled for removal after the <code class="literal">empty-group-min-timeout</code> elapses.
The default is <span class="emphasis"><em>false</em></span>.</p>
</td></tr></table></div>
</div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Since there is no custom behavior to be implemented in Java classes for resequencers, there is no annotation support for it.</p>
</td></tr></table></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="chain" href="#chain"></a>8.6&nbsp;Message Handler Chain</h2></div></div></div>

<p>The <code class="literal">MessageHandlerChain</code> is an implementation of <code class="literal">MessageHandler</code> that can be configured as a single message endpoint while actually delegating to a chain of other handlers, such as filters, transformers, splitters, and so on.
When several handlers need to be connected in a fixed, linear progression, this can lead to a much simpler configuration.
For example, it is fairly common to provide a transformer before other components.
Similarly, when you provide a filter before some other component in a chain, you essentially create a <a class="ulink" href="http://www.eaipatterns.com/MessageSelector.html" target="_top">selective consumer</a>.
In either case, the chain requires only a single <code class="literal">input-channel</code> and a single <code class="literal">output-channel</code>, eliminating the need to define channels for each individual component.</p>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>Spring Integration&#8217;s <code class="literal">Filter</code> provides a boolean property: <code class="literal">throwExceptionOnRejection</code>.
When you provide multiple selective consumers on the same point-to-point channel with different acceptance criteria, you should set this value <span class="emphasis"><em>true</em></span> (the default is <code class="literal">false</code>) so that the dispatcher knows that the message was rejected and, as a result, tries to pass the message on to other subscribers.
If the exception were not thrown, it would appear to the dispatcher that the message had been passed on successfully even though the filter had dropped the message to prevent further processing.
If you do indeed want to "<code class="literal">drop</code>" the messages, the filter&#8217;s <span class="emphasis"><em>discard-channel</em></span> might be useful, since it does give you a chance to perform some operation with the dropped message (such as sending it to a JMS queue or writing it to a log).</p>
</td></tr></table></div>
<p>The handler chain simplifies configuration while internally maintaining the same degree of loose coupling between components, and it is trivial to modify the configuration if at some point a non-linear arrangement is required.</p>
<p>Internally, the chain is expanded into a linear setup of the listed endpoints, separated by anonymous channels.
The reply channel header is not taken into account within the chain.
Only after the last handler is invoked is the resulting message forwarded to the reply channel or the chain&#8217;s output channel.
Because of this setup, all handlers except the last must implement the <code class="literal">MessageProducer</code> interface (which provides a <span class="emphasis"><em>setOutputChannel()</em></span> method).
If the <code class="literal">outputChannel</code> on the <code class="literal">MessageHandlerChain</code> is set, the last handler needs only an output channel.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>As with other endpoints, the <code class="literal">output-channel</code> is optional.
If there is a reply message at the end of the chain, the output-channel takes precedence.
However, if it is not available, the chain handler checks for a reply channel header on the inbound message as a fallback.</p>
</td></tr></table></div>
<p>In most cases, you need not implement <code class="literal">MessageHandler</code> yourself.
The next section focuses on namespace support for the chain element.
Most Spring Integration endpoints, such as service activators and transformers, are suitable for use within a <code class="literal">MessageHandlerChain</code>.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="chain-namespace" href="#chain-namespace"></a>8.6.1&nbsp;Configuring a Chain</h3></div></div></div>

<p>The <code class="literal">&lt;chain&gt;</code> element provides an <code class="literal">input-channel</code> attribute.
If the last element in the chain is capable of producing reply messages (optional), it also supports an <code class="literal">output-channel</code> attribute.
The sub-elements are then filters, transformers, splitters, and service-activators.
The last element may also be a router or an outbound channel adapter.
The following example shows a chain definition:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:chain</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:filter</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"someSelector"</span> <span class="hl-attribute">throw-exception-on-rejection</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int:header-enricher&gt;</span>
        <span class="hl-tag">&lt;int:header</span> <span class="hl-attribute">name</span>=<span class="hl-value">"thing1"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"thing2"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/int:header-enricher&gt;</span>
    <span class="hl-tag">&lt;int:service-activator</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"someService"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"someMethod"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:chain&gt;</span></pre>
</div>
<p>The <code class="literal">&lt;header-enricher&gt;</code> element used in the preceding example sets a message header named <code class="literal">thing1</code> with a value of <code class="literal">thing2</code> on the message.
A header enricher is a specialization of <code class="literal">Transformer</code> that touches only header values.
You could obtain the same result by implementing a <code class="literal">MessageHandler</code> that did the header modifications and wiring that as a bean, but the header-enricher is a simpler option.</p>
<p>The <code class="literal">&lt;chain&gt;</code> can be configured as the last <span class="emphasis"><em>black-box</em></span> consumer of the message flow.
For this solution, you can to put it at the end of the &lt;chain&gt; some &lt;outbound-channel-adapter&gt;, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:chain</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int-xml:marshalling-transformer</span> <span class="hl-attribute">marshaller</span>=<span class="hl-value">"marshaller"</span> <span class="hl-attribute">result-type</span>=<span class="hl-value">"StringResult"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;int:service-activator</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"someService"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"someMethod"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int:header-enricher&gt;</span>
        <span class="hl-tag">&lt;int:header</span> <span class="hl-attribute">name</span>=<span class="hl-value">"thing1"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"thing2"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/int:header-enricher&gt;</span>
    <span class="hl-tag">&lt;int:logging-channel-adapter</span> <span class="hl-attribute">level</span>=<span class="hl-value">"INFO"</span> <span class="hl-attribute">log-full-message</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:chain&gt;</span></pre>
</div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important: Disallowed Attributes and Elements"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Disallowed Attributes and Elements</th></tr><tr><td align="left" valign="top">

<p>Certain attributes, such as <code class="literal">order</code> and <code class="literal">input-channel</code> are not allowed to be specified on components used within a chain.
The same is true for the poller sub-element.</p>
<p>For the Spring Integration core components, the XML schema itself enforces some of these constraints.
However, for non-core components or your own custom components, these constraints are enforced by the XML namespace parser, not by the XML schema.</p>
<p>These XML namespace parser constraints were added with Spring Integration 2.2.
If you try to use disallowed attributes and elements, the XML namespace parser throws a <code class="literal">BeanDefinitionParsingException</code>.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_using_the_emphasis_id_emphasis_attribute" href="#_using_the_emphasis_id_emphasis_attribute"></a>8.6.2&nbsp;Using the <span class="emphasis"><em>id</em></span> Attribute</h3></div></div></div>

<p>Beginning with Spring Integration 3.0, if a chain element is given an <code class="literal">id</code> attribute, the bean name for the element is a combination of the chain&#8217;s <code class="literal">id</code> and the <code class="literal">id</code> of the element itself.
Elements without <code class="literal">id</code> attributes are not registered as beans, but each one is given a <code class="literal">componentName</code> that includes the chain <code class="literal">id</code>.
Consider the following example:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:chain</span> <span class="hl-attribute">id</span>=<span class="hl-value">"somethingChain"</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:service-activator</span> <span class="hl-attribute">id</span>=<span class="hl-value">"somethingService"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"someService"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"someMethod"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int:object-to-json-transformer/&gt;</span>
<span class="hl-tag">&lt;/int:chain&gt;</span></pre>
</div>
<p>In the preceding example:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
The <code class="literal">&lt;chain&gt;</code> root element has an <code class="literal">id</code> of <span class="emphasis"><em>somethingChain</em></span>.
Consequently, the <code class="literal">AbstractEndpoint</code> implementation (<code class="literal">PollingConsumer</code> or <code class="literal">EventDrivenConsumer</code>, depending on the <code class="literal">input-channel</code> type) bean takes this value as its bean name.
</li><li class="listitem">
The <code class="literal">MessageHandlerChain</code> bean acquires a bean alias (<span class="emphasis"><em>somethingChain.handler</em></span>), which allows direct access to this bean from the <code class="literal">BeanFactory</code>.
</li><li class="listitem">
The <code class="literal">&lt;service-activator&gt;</code> is not a fully fledged messaging endpoint (it is not a <code class="literal">PollingConsumer</code> or <code class="literal">EventDrivenConsumer</code>).
It is a <code class="literal">MessageHandler</code> within the <code class="literal">&lt;chain&gt;</code>.
In this case, the bean name registered with the <code class="literal">BeanFactory</code> is <span class="emphasis"><em>somethingChain$child.somethingService.handler</em></span>.
</li><li class="listitem">
The <code class="literal">componentName</code> of this <code class="literal">ServiceActivatingHandler</code> takes the same value but without the <span class="emphasis"><em>.handler</em></span> suffix.
It becomes <span class="emphasis"><em>somethingChain$child.somethingService</em></span>.
</li><li class="listitem">
The last <code class="literal">&lt;chain&gt;</code> sub-component, <code class="literal">&lt;object-to-json-transformer&gt;</code>, does not have an <code class="literal">id</code> attribute.
Its <code class="literal">componentName</code> is based on its position in the <code class="literal">&lt;chain&gt;</code>.
In this case, it is <span class="emphasis"><em>somethingChain$child#1</em></span>.
(The final element of the name is the order within the chain, beginning with <span class="emphasis"><em>#0</em></span>).
Note, this transformer is not registered as a bean within the application context, so it does not get a <code class="literal">beanName</code>.
However its <code class="literal">componentName</code> has a value that is useful for logging and other purposes.
</li></ul></div>
<p>The <code class="literal">id</code> attribute for <code class="literal">&lt;chain&gt;</code> elements lets them be eligible for <a class="link" href="system-management-chapter.html#jmx-mbean-exporter" title="12.2.7&nbsp;MBean Exporter">JMX export</a>, and they are trackable in the <a class="link" href="system-management-chapter.html#message-history" title="12.3&nbsp;Message History">message history</a>.
You can access them from the <code class="literal">BeanFactory</code> by using the appropriate bean name, as discussed earlier.</p>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>It is useful to provide an explicit <code class="literal">id</code> attribute on <code class="literal">&lt;chain&gt;</code> elements to simplify the identification of sub-components in logs and to provide access to them from the <code class="literal">BeanFactory</code> etc.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_calling_a_chain_from_within_a_chain" href="#_calling_a_chain_from_within_a_chain"></a>8.6.3&nbsp;Calling a Chain from within a Chain</h3></div></div></div>

<p>Sometimes, you need to make a nested call to another chain from within a chain and then come back and continue execution within the original chain.
To accomplish this, you can use a messaging gateway by including a &lt;gateway&gt; element, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:chain&nbsp;id="main-chain"&nbsp;input-channel="in"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"out"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:header-enricher&gt;</span>
      <span class="hl-tag">&lt;int:header</span> <span class="hl-attribute">name</span>=<span class="hl-value">"name"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"Many"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;/int:header-enricher&gt;</span>
    <span class="hl-tag">&lt;int:service-activator&gt;</span>
      <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.foo.SampleService"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;/int:service-activator&gt;</span>
    <span class="hl-tag">&lt;int:gateway</span> <span class="hl-attribute">request-channel</span>=<span class="hl-value">"inputA"</span><span class="hl-tag">/&gt;</span> &nbsp;
<span class="hl-tag">&lt;/int:chain&gt;</span>

<span class="hl-tag">&lt;int:chain&nbsp;id="nested-chain-a"&nbsp;input-channel="inputA"&gt;</span>
    <span class="hl-tag">&lt;int:header-enricher&gt;</span>
        <span class="hl-tag">&lt;int:header</span> <span class="hl-attribute">name</span>=<span class="hl-value">"name"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"Moe"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;/int:header-enricher&gt;</span>
    <span class="hl-tag">&lt;int:gateway</span> <span class="hl-attribute">request-channel</span>=<span class="hl-value">"inputB"</span><span class="hl-tag">/&gt;</span>&nbsp;
    <span class="hl-tag">&lt;int:service-activator&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.foo.SampleService"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;/int:service-activator&gt;</span>
<span class="hl-tag">&lt;/int:chain&gt;</span>

<span class="hl-tag">&lt;int:chain&nbsp;id="nested-chain-b"&nbsp;input-channel="inputB"&gt;</span>
    <span class="hl-tag">&lt;int:header-enricher&gt;</span>
        <span class="hl-tag">&lt;int:header</span> <span class="hl-attribute">name</span>=<span class="hl-value">"name"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"Jack"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;/int:header-enricher&gt;</span>
    <span class="hl-tag">&lt;int:service-activator&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.foo.SampleService"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;/int:service-activator&gt;</span>
<span class="hl-tag">&lt;/int:chain&gt;</span></pre>
</div>
<p>In the preceding example, <code class="literal">nested-chain-a</code> is called at the end of <code class="literal">main-chain</code> processing by the <span class="emphasis"><em>gateway</em></span> element configured there.
While in <code class="literal">nested-chain-a</code>, a call to a <code class="literal">nested-chain-b</code> is made after header enrichment.
Then the flow comes back to finish execution in <code class="literal">nested-chain-b</code>.
Finally, the flow returns to <code class="literal">main-chain</code>.
When the nested version of a <code class="literal">&lt;gateway&gt;</code> element is defined in the chain, it does not require the <code class="literal">service-interface</code> attribute.
Instead, it takes the message in its current state and places it on the channel defined in the <code class="literal">request-channel</code> attribute.
When the downstream flow initiated by that gateway completes, a <code class="literal">Message</code> is returned to the gateway and continues its journey within the current chain.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="scatter-gather" href="#scatter-gather"></a>8.7&nbsp;Scatter-Gather</h2></div></div></div>

<p>Starting with version 4.1, Spring Integration provides an implementation of the <a class="ulink" href="http://www.eaipatterns.com/BroadcastAggregate.html" target="_top">scatter-gather</a> enterprise integration pattern.
It is a compound endpoint for which the goal is to send a message to the recipients and aggregate the results.
As noted in <a class="ulink" href="http://www.eaipatterns.com" target="_top"><span class="emphasis"><em>Enterprise Integration Patterns</em></span></a>, it is a component for scenarios such as "<code class="literal">best quote</code>", where we need to request information from several suppliers and decide which one provides us with the best term for the requested item.</p>
<p>Previously, the pattern could be configured by using discrete components.
This enhancement brings more convenient configuration.</p>
<p>The <code class="literal">ScatterGatherHandler</code> is a request-reply endpoint that combines a <code class="literal">PublishSubscribeChannel</code> (or a <code class="literal">RecipientListRouter</code>) and an <code class="literal">AggregatingMessageHandler</code>.
The request message is sent to the <code class="literal">scatter</code> channel, and the <code class="literal">ScatterGatherHandler</code> waits for the reply that the aggregator sends to the <code class="literal">outputChannel</code>.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="scatter-gather-functionality" href="#scatter-gather-functionality"></a>8.7.1&nbsp;Functionality</h3></div></div></div>

<p>The <code class="literal">Scatter-Gather</code> pattern suggests two scenarios: "<code class="literal">auction</code>" and "<code class="literal">distribution</code>".
In both cases, the <code class="literal">aggregation</code> function is the same and provides all the options available for the <code class="literal">AggregatingMessageHandler</code>.
(Actually, the <code class="literal">ScatterGatherHandler</code> requires only an <code class="literal">AggregatingMessageHandler</code> as a constructor argument.)
See <a class="xref" href="messaging-routing-chapter.html#aggregator" title="8.4&nbsp;Aggregator">Section&nbsp;8.4, &#8220;Aggregator&#8221;</a> for more information.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_auction" href="#_auction"></a>Auction</h4></div></div></div>

<p>The auction <code class="literal">Scatter-Gather</code> variant uses "<code class="literal">publish-subscribe</code>" logic for the request message, where the "<code class="literal">scatter</code>" channel is a <code class="literal">PublishSubscribeChannel</code> with <code class="literal">apply-sequence="true"</code>.
However, this channel can be any <code class="literal">MessageChannel</code> implementation (as is the case with the <code class="literal">request-channel</code> in the <code class="literal">ContentEnricher</code>&#8201;&#8212;&#8201;see <a class="xref" href="messaging-transformation-chapter.html#content-enricher" title="9.2&nbsp;Content Enricher">Section&nbsp;9.2, &#8220;Content Enricher&#8221;</a>).
However, in this case, you should create your own custom <code class="literal">correlationStrategy</code> for the <code class="literal">aggregation</code> function.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_distribution" href="#_distribution"></a>Distribution</h4></div></div></div>

<p>The distribution <code class="literal">Scatter-Gather</code> variant is based on the <code class="literal">RecipientListRouter</code> (see <a class="xref" href="messaging-routing-chapter.html#router-implementations-recipientlistrouter" title="RecipientListRouter">the section called &#8220;<code class="literal">RecipientListRouter</code>&#8221;</a>) with all available options for the <code class="literal">RecipientListRouter</code>.
This is the second <code class="literal">ScatterGatherHandler</code> constructor argument.
If you want to rely on only the default <code class="literal">correlationStrategy</code> for the <code class="literal">recipient-list-router</code> and the <code class="literal">aggregator</code>, you should specify <code class="literal">apply-sequence="true"</code>.
Otherwise, you should supply a custom <code class="literal">correlationStrategy</code> for the <code class="literal">aggregator</code>.
Unlike the <code class="literal">PublishSubscribeChannel</code> variant (the auction variant), having a <code class="literal">recipient-list-router</code> <code class="literal">selector</code> option lets filter target suppliers based on the message.
With <code class="literal">apply-sequence="true"</code>, the default <code class="literal">sequenceSize</code> is supplied, and the <code class="literal">aggregator</code> can release the group correctly.
The distribution option is mutually exclusive with the auction option.</p>
<p>For both the auction and the distribution variants, the request (scatter) message is enriched with the <code class="literal">gatherResultChannel</code> header to wait for a reply message from the <code class="literal">aggregator</code>.</p>
<p>By default, all suppliers should send their result to the <code class="literal">replyChannel</code> header (usually by omitting the <code class="literal">output-channel</code> from the ultimate endpoint).
However, the <code class="literal">gatherChannel</code> option is also provided, letting suppliers send their reply to that channel for the aggregation.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="scatter-gather-namespace" href="#scatter-gather-namespace"></a>8.7.2&nbsp;Configuring a Scatter-Gather Endpoint</h3></div></div></div>

<p>The following example shows Java configuration for the bean definition for <code class="literal">Scatter-Gather</code>:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> MessageHandler distributor() {
    RecipientListRouter router = <span class="hl-keyword">new</span> RecipientListRouter();
    router.setApplySequence(true);
    router.setChannels(Arrays.asList(distributionChannel1(), distributionChannel2(),
            distributionChannel3()));
    <span class="hl-keyword">return</span> router;
}

<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> MessageHandler gatherer() {
	<span class="hl-keyword">return</span> <span class="hl-keyword">new</span> AggregatingMessageHandler(
			<span class="hl-keyword">new</span> ExpressionEvaluatingMessageGroupProcessor(<span class="hl-string">"^[payload gt 5] ?: -1D"</span>),
			<span class="hl-keyword">new</span> SimpleMessageStore(),
			<span class="hl-keyword">new</span> HeaderAttributeCorrelationStrategy(
			       IntegrationMessageHeaderAccessor.CORRELATION_ID),
			<span class="hl-keyword">new</span> ExpressionEvaluatingReleaseStrategy(<span class="hl-string">"size() == 2"</span>));
}

<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "distributionChannel")</span></em>
<span class="hl-keyword">public</span> MessageHandler scatterGatherDistribution() {
	ScatterGatherHandler handler = <span class="hl-keyword">new</span> ScatterGatherHandler(distributor(), gatherer());
	handler.setOutputChannel(output());
	<span class="hl-keyword">return</span> handler;
}</pre>
</div>
<p>In the preceding example, we configure the <code class="literal">RecipientListRouter</code> <code class="literal">distributor</code> bean with <code class="literal">applySequence="true"</code> and the list of recipient channels.
The next bean is for an <code class="literal">AggregatingMessageHandler</code>.
Finally, we inject both those beans into the <code class="literal">ScatterGatherHandler</code> bean definition and mark it as a <code class="literal">@ServiceActivator</code> to wire the scatter-gather component into the integration flow.</p>
<p>The following example shows how to configure the <code class="literal">&lt;scatter-gather&gt;</code> endpoint by using the XML namespace:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;scatter-gather</span>
		<span class="hl-attribute">id</span>=<span class="hl-value">""</span>  <a name="CO8-1" href="#CO8-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
		auto-startup=""  <a name="CO8-2" href="#CO8-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
		input-channel=""  <a name="CO8-3" href="#CO8-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
		output-channel=""  <a name="CO8-4" href="#CO8-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
		scatter-channel=""  <a name="CO8-5" href="#CO8-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
		gather-channel=""  <a name="CO8-6" href="#CO8-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>
		order=""  <a name="CO8-7" href="#CO8-7"></a><span><img src="images/callouts/7.png" alt="7" border="0"></span>
		phase=""  <a name="CO8-8" href="#CO8-8"></a><span><img src="images/callouts/8.png" alt="8" border="0"></span>
		send-timeout=""  <a name="CO8-9" href="#CO8-9"></a><span><img src="images/callouts/9.png" alt="9" border="0"></span>
		gather-timeout=""  <a name="CO8-10" href="#CO8-10"></a><span><img src="images/callouts/10.png" alt="10" border="0"></span>
		requires-reply="" &gt; <a name="CO8-11" href="#CO8-11"></a><span><img src="images/callouts/11.png" alt="11" border="0"></span>
			<span class="hl-tag">&lt;scatterer/&gt;</span>  <a name="CO8-12" href="#CO8-12"></a><span><img src="images/callouts/12.png" alt="12" border="0"></span>
			<span class="hl-tag">&lt;gatherer/&gt;</span>  <a name="CO8-13" href="#CO8-13"></a><span><img src="images/callouts/13.png" alt="13" border="0"></span>
<span class="hl-tag">&lt;/scatter-gather&gt;</span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO8-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The id of the endpoint.
The <code class="literal">ScatterGatherHandler</code> bean is registered with an alias of <code class="literal">id + '.handler'</code>.
The <code class="literal">RecipientListRouter</code> bean is registered with an alias of <code class="literal">id + '.scatterer'</code>.
The <code class="literal">AggregatingMessageHandler`bean is registered with an alias of `id + '.gatherer'</code>.
Optional.
(The <code class="literal">BeanFactory</code> generates a default <code class="literal">id</code> value.)</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO8-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Lifecycle attribute signaling whether the endpoint should be started during application context initialization.
In addition, the <code class="literal">ScatterGatherHandler</code> also implements <code class="literal">Lifecycle</code> and starts and stops <code class="literal">gatherEndpoint</code>, which is created internally if a <code class="literal">gather-channel</code> is provided.
Optional.
(The default is <code class="literal">true</code>.)</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO8-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The channel on which to receive request messages to handle them in the <code class="literal">ScatterGatherHandler</code>.
Required.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO8-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The channel to which the <code class="literal">ScatterGatherHandler</code> sends the aggregation results.
Optional.
(Incoming messages can specify a reply channel themselves in the <code class="literal">replyChannel</code> message header).</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO8-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The channel to which to send the scatter message for the auction scenario.
Optional.
Mutually exclusive with the <code class="literal">&lt;scatterer&gt;</code> sub-element.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO8-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The channel on which to receive replies from each supplier for the aggregation.
It is used as the <code class="literal">replyChannel</code> header in the scatter message.
Optional.
By default, the <code class="literal">FixedSubscriberChannel</code> is created.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO8-7"><span><img src="images/callouts/7.png" alt="7" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The order of this component when more than one handler is subscribed to the same <code class="literal">DirectChannel</code> (use for load balancing purposes).
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO8-8"><span><img src="images/callouts/8.png" alt="8" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Specifies the phase in which the endpoint should be started and stopped.
The startup order proceeds from lowest to highest, and the shutdown order is from highest to lowest.
By default, this value is <code class="literal">Integer.MAX_VALUE</code>, meaning that this container starts as late as possible and stops as soon as possible.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO8-9"><span><img src="images/callouts/9.png" alt="9" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The timeout interval to wait when sending a reply <code class="literal">Message</code> to the <code class="literal">output-channel</code>.
By default, the send blocks for one second.
It applies only if the output channel has some <span class="emphasis"><em>sending</em></span> limitations&#8201;&#8212;&#8201;for example, a <code class="literal">QueueChannel</code> with a fixed <span class="emphasis"><em>capacity</em></span> that is full.
In this case, a <code class="literal">MessageDeliveryException</code> is thrown.
The <code class="literal">send-timeout</code> is ignored for <code class="literal">AbstractSubscribableChannel</code> implementations.
For <code class="literal">group-timeout(-expression)</code>, the <code class="literal">MessageDeliveryException</code> from the scheduled expire task leads this task to be rescheduled.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO8-10"><span><img src="images/callouts/10.png" alt="10" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Lets you specify how long the scatter-gather waits for the reply message before returning.
By default, it waits indefinitely.
<span class="emphasis"><em>null</em></span> is returned if the reply times out.
Optional.
It defaults to <code class="literal">-1</code>, meaning to wait indefinitely.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO8-11"><span><img src="images/callouts/11.png" alt="11" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Specifies whether the scatter-gather must return a non-null value.
This value is <code class="literal">true</code> by default.
Consequently, a <code class="literal">ReplyRequiredException</code> is thrown when the underlying aggregator returns a null value after <code class="literal">gather-timeout</code>.
Note, if <code class="literal">null</code> is a possibility, the <code class="literal">gather-timeout</code> should be specified to avoid an indefinite wait.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO8-12"><span><img src="images/callouts/12.png" alt="12" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The <code class="literal">&lt;recipient-list-router&gt;</code> options.
Optional.
Mutually exclusive with <code class="literal">scatter-channel</code> attribute.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO8-13"><span><img src="images/callouts/13.png" alt="13" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The <code class="literal">&lt;aggregator&gt;</code> options.
Required.</p>
</td></tr></table></div>
</div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="barrier" href="#barrier"></a>8.8&nbsp;Thread Barrier</h2></div></div></div>

<p>Sometimes, we need to suspend a message flow thread until some other asynchronous event occurs.
For example, consider an HTTP request that publishes a message to RabbitMQ.
We might wish to not reply to the user until the RabbitMQ broker has issued an acknowledgment that the message was
received.</p>
<p>In version 4.2, Spring Integration introduced the <code class="literal">&lt;barrier/&gt;</code> component for this purpose.
The underlying <code class="literal">MessageHandler</code> is the <code class="literal">BarrierMessageHandler</code>.
This class also implements
<code class="literal">MessageTriggerAction</code>, in which a message passed to the <code class="literal">trigger()</code> method releases a corresponding thread in the
<code class="literal">handleRequestMessage()</code> method (if present).</p>
<p>The suspended thread and trigger thread are correlated by invoking a <code class="literal">CorrelationStrategy</code> on the messages.
When a message is sent to the <code class="literal">input-channel</code>, the thread is suspended for up to <code class="literal">timeout</code> milliseconds, waiting for
a corresponding trigger message.
The default correlation strategy uses the <code class="literal">IntegrationMessageHeaderAccessor.CORRELATION_ID</code> header.
When a trigger message arrives with the same correlation, the thread is released.
The message sent to the <code class="literal">output-channel</code> after release is constructed by using a <code class="literal">MessageGroupProcessor</code>.
By default, the message is a <code class="literal">Collection&lt;?&gt;</code> of the two payloads, and the headers are merged by using a
<code class="literal">DefaultAggregatingMessageGroupProcessor</code>.</p>
<div class="caution" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Caution"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Caution]" src="images/caution.png"></td><th align="left">Caution</th></tr><tr><td align="left" valign="top">
<p>If the <code class="literal">trigger()</code> method is invoked first (or after the main thread times out), it is suspended for up to <code class="literal">timeout</code> waiting for the suspending message to arrive.
If you do not want to suspend the trigger thread, consider handing off to a <code class="literal">TaskExecutor</code> instead so that its thread is suspended instead.</p>
</td></tr></table></div>
<p>The <code class="literal">requires-reply</code> property determines the action to take if the suspended thread times out before the trigger message arrives.
By default, it is <code class="literal">false</code>, which means the endpoint returns <code class="literal">null</code>, the flow ends, and the thread returns to the
caller.
When <code class="literal">true</code>, a <code class="literal">ReplyRequiredException</code> is thrown.</p>
<p>You can call the <code class="literal">trigger()</code> method programmatically (obtain the bean reference by using the name, <code class="literal">barrier.handler</code>&#8201;&#8212;&#8201;where <code class="literal">barrier</code> is the bean name of the barrier endpoint).
Alternatively, you can configure an <code class="literal">&lt;outbound-channel-adapter/&gt;</code> to trigger the release.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Only one thread can be suspended with the same correlation.
The same correlation can be used multiple times but only once concurrently.
An exception is thrown if a second thread arrives with the same correlation.</p>
</td></tr></table></div>
<p>The following example shows how to use a custom header for correlation:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:barrier</span> <span class="hl-attribute">id</span>=<span class="hl-value">"barrier1"</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"in"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"out"</span>
        <span class="hl-attribute">correlation-strategy-expression</span>=<span class="hl-value">"headers['myHeader']"</span>
        <span class="hl-attribute">output-processor</span>=<span class="hl-value">"myOutputProcessor"</span>
        <span class="hl-attribute">discard-channel</span>=<span class="hl-value">"lateTriggerChannel"</span>
        <span class="hl-attribute">timeout</span>=<span class="hl-value">"10000"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;/int:barrier&gt;</span>

<span class="hl-tag">&lt;int:outbound-channel-adapter</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"release"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"barrier1.handler"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"trigger"</span><span class="hl-tag"> /&gt;</span></pre>
<p>Depending on which one has a message arrive first, either the thread sending a message to <code class="literal">in</code> or the thread sending a message to <code class="literal">release</code> waits for up to ten seconds until the other message arrives.
When the message is released, the <code class="literal">out</code> channel is sent a message that combines the result of invoking the custom <code class="literal">MessageGroupProcessor</code> bean, named <code class="literal">myOutputProcessor</code>.
If the main thread times out and a trigger arrives later, you can configure a discard channel to which the late trigger is sent.
The following example shows the Java configuration to do so:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Configuration</span></em>
<em><span class="hl-annotation" style="color: gray">@EnableIntegration</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> Config {

    <em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel="in")</span></em>
    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> BarrierMessageHandler barrier() {
        BarrierMessageHandler barrier = <span class="hl-keyword">new</span> BarrierMessageHandler(<span class="hl-number">10000</span>);
        barrier.setOutputChannel(out());
        barrier.setDiscardChannel(lateTriggers());
        <span class="hl-keyword">return</span> barrier;
    }

    <em><span class="hl-annotation" style="color: gray">@ServiceActivator</span></em> (inputChannel=<span class="hl-string">"release"</span>)
    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> MessageHandler releaser() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> MessageHandler() {

            <em><span class="hl-annotation" style="color: gray">@Override</span></em>
            <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> handleMessage(Message&lt;?&gt; message) <span class="hl-keyword">throws</span> MessagingException {
                barrier().trigger(message);
            }

        };
    }

}</pre>
<p>For an example of this component, see the <a class="ulink" href="https://github.com/spring-projects/spring-integration-samples/tree/master/basic/barrier" target="_top">barrier sample application</a>.</p>
</div>
</div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="message.html">Prev</a>&nbsp;</td><td width="20%" align="center"><a accesskey="u" href="spring-integration-core-messaging.html">Up</a></td><td width="40%" align="right">&nbsp;<a accesskey="n" href="messaging-transformation-chapter.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">7.&nbsp;Message&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top">&nbsp;9.&nbsp;Message Transformation</td></tr></table></div></body></html>