<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>Spring Integration Reference Manual</title><link rel="stylesheet" type="text/css" href="css/manual-singlepage.css"><meta name="generator" content="DocBook XSL Stylesheets V1.78.1"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div lang="en" class="book"><div class="titlepage"><div><div><h1 class="title"><a name="d5e1"></a>Spring Integration Reference Manual</h1></div><div><div class="authorgroup"><h2>Authors</h2>
      <span class="author"><span class="firstname">Mark</span> <span class="surname">Fisher</span></span>, <span class="author"><span class="firstname">Marius</span> <span class="surname">Bogoevici</span></span>, <span class="author"><span class="firstname">Iwein</span> <span class="surname">Fuld</span></span>, <span class="author"><span class="firstname">Jonas</span> <span class="surname">Partner</span></span>, <span class="author"><span class="firstname">Oleg</span> <span class="surname">Zhurakousky</span></span>, <span class="author"><span class="firstname">Gary</span> <span class="surname">Russell</span></span>, <span class="author"><span class="firstname">Dave</span> <span class="surname">Syer</span></span>, <span class="author"><span class="firstname">Josh</span> <span class="surname">Long</span></span>, <span class="author"><span class="firstname">David</span> <span class="surname">Turanski</span></span>, <span class="author"><span class="firstname">Gunnar</span> <span class="surname">Hillert</span></span>, <span class="author"><span class="firstname">Artem</span> <span class="surname">Bilan</span></span>, <span class="author"><span class="firstname">Amol</span> <span class="surname">Nayak</span></span>, <span class="author"><span class="firstname">Jay</span> <span class="surname">Bryant</span></span>
    </div></div><div><p class="releaseinfo">5.1.2.RELEASE</p></div><div><p class="copyright">Copyright &copy; 2009, 2010, 2011, 2012, 2013, 2014, 2015, 2016, 2017, 2018 
          Pivotal Software, Inc. All Rights Reserved.
      </p></div><div><div class="legalnotice"><a name="d5e63" href="#d5e63"></a>
	<p>
		Copies of this document may be made for your own use and for distribution to
		others, provided that you do not charge any fee for such copies and further
		provided that each copy contains this Copyright Notice, whether distributed in
		print or electronically.
	</p>
</div></div><div></div></div><hr></div><div class="toc"><p><b>Table of Contents</b></p><dl class="toc"><dt><span class="preface"><a href="#d5e65"></a></span></dt><dt><span class="part"><a href="#preface">I. Preface</a></span></dt><dd><dl><dt><span class="chapter"><a href="#system-requirements">1. Requirements</a></span></dt><dd><dl><dt><span class="section"><a href="#supported-java-versions">1.1. Compatible Java Versions</a></span></dt><dt><span class="section"><a href="#supported-spring-versions">1.2. Compatible Versions of the Spring Framework</a></span></dt></dl></dd><dt><span class="chapter"><a href="#code-conventions">2. Code Conventions</a></span></dt><dt><span class="chapter"><a href="#guide-conventions">3. Conventions in This Guide</a></span></dt></dl></dd><dt><span class="part"><a href="#whats-new-part">II. What&#8217;s New?</a></span></dt><dd><dl><dt><span class="chapter"><a href="#whats-new">4. What&#8217;s New in Spring Integration 5.1?</a></span></dt><dd><dl><dt><span class="section"><a href="#x5.1-new-components">4.1. New Components</a></span></dt><dd><dl><dt><span class="section"><a href="#x5.1-AmqpDedicatedChannelAdvice">4.1.1. <code class="literal">AmqpDedicatedChannelAdvice</code></a></span></dt><dt><span class="section"><a href="#x5.1-Functions">4.1.2. Improved Function Support</a></span></dt><dt><span class="section"><a href="#x5.1-LongRunningTest">4.1.3. <code class="literal">@LongRunningTest</code></a></span></dt></dl></dd><dt><span class="section"><a href="#x5.1-general">4.2. General Changes</a></span></dt><dd><dl><dt><span class="section"><a href="#x5.1-java-dsl">4.2.1. Java DSL</a></span></dt><dt><span class="section"><a href="#x5.1-dispatcher-exceptions">4.2.2. Dispatcher Exceptions</a></span></dt><dt><span class="section"><a href="#x5.1-global-channel-interceptors">4.2.3. Global Channel Interceptors</a></span></dt><dt><span class="section"><a href="#x5.1-channel-interceptors">4.2.4. Channel Interceptors</a></span></dt><dt><span class="section"><a href="#x5.1-object-to-json-transformer">4.2.5. <code class="literal">ObjectToJsonTransformer</code></a></span></dt><dt><span class="section"><a href="#x5.1-integration-flows-generated-bean-names">4.2.6. Integration Flows: Generated Bean Names</a></span></dt><dt><span class="section"><a href="#x5.1-aggregator">4.2.7. Aggregator Changes</a></span></dt><dt><span class="section"><a href="#x5.1-publisher">4.2.8. @Publisher annotation changes</a></span></dt></dl></dd><dt><span class="section"><a href="#x5.1-files">4.3. Files Changes</a></span></dt><dt><span class="section"><a href="#x5.1-amqp">4.4. AMQP Changes</a></span></dt><dt><span class="section"><a href="#x5.1-jdbc">4.5. JDBC Changes</a></span></dt><dt><span class="section"><a href="#x5.1-ftp-sftp">4.6. FTP and SFTP Changes</a></span></dt><dt><span class="section"><a href="#x51.-tcp">4.7. TCP Support</a></span></dt><dt><span class="section"><a href="#x5.1-twitter">4.8. Twitter Support</a></span></dt><dt><span class="section"><a href="#x51.-jms">4.9. JMS Support</a></span></dt><dt><span class="section"><a href="#x51.-http">4.10. HTTP/WebFlux Support</a></span></dt><dt><span class="section"><a href="#x51.-jmx">4.11. JMX Changes</a></span></dt><dt><span class="section"><a href="#x51.-micrometer">4.12. Micrometer Support Changes</a></span></dt><dt><span class="section"><a href="#x51.-integration-graph">4.13. Integration Graph Customization</a></span></dt><dt><span class="section"><a href="#x51.-global-properties">4.14. Integration Global Properties</a></span></dt><dt><span class="section"><a href="#x51.-poller-annotation">4.15. The <code class="literal">receiveTimeout</code> for <code class="literal">@Poller</code></a></span></dt></dl></dd></dl></dd><dt><span class="part"><a href="#spring-integration-introduction">III. Overview of Spring Integration Framework</a></span></dt><dd><dl><dt><span class="chapter"><a href="#overview">5. Spring Integration Overview</a></span></dt><dd><dl><dt><span class="section"><a href="#overview-background">5.1. Background</a></span></dt><dt><span class="section"><a href="#overview-goalsandprinciples">5.2. Goals and Principles</a></span></dt><dt><span class="section"><a href="#overview-components">5.3. Main Components</a></span></dt><dd><dl><dt><span class="section"><a href="#overview-components-message">5.3.1. Message</a></span></dt><dt><span class="section"><a href="#overview-components-channel">5.3.2. Message Channel</a></span></dt><dt><span class="section"><a href="#overview-components-endpoint">5.3.3. Message Endpoint</a></span></dt></dl></dd><dt><span class="section"><a href="#overview-endpoints">5.4. Message Endpoints</a></span></dt><dd><dl><dt><span class="section"><a href="#overview-endpoints-transformer">5.4.1. Message Transformer</a></span></dt><dt><span class="section"><a href="#overview-endpoints-filter">5.4.2. Message Filter</a></span></dt><dt><span class="section"><a href="#overview-endpoints-router">5.4.3. Message Router</a></span></dt><dt><span class="section"><a href="#overview-endpoints-splitter">5.4.4. Splitter</a></span></dt><dt><span class="section"><a href="#overview-endpoints-aggregator">5.4.5. Aggregator</a></span></dt><dt><span class="section"><a href="#overview-endpoints-service-activator">5.4.6. Service Activator</a></span></dt><dt><span class="section"><a href="#overview-endpoints-channeladapter">5.4.7. Channel Adapter</a></span></dt><dt><span class="section"><a href="#endpoint-bean-names">5.4.8. Endpoint Bean Names</a></span></dt></dl></dd><dt><span class="section"><a href="#configuration-enable-integration">5.5. Configuration and <code class="literal">@EnableIntegration</code></a></span></dt><dt><span class="section"><a href="#programming-considerations">5.6. Programming Considerations</a></span></dt><dd><dl><dt><span class="section"><a href="#shaded">5.6.1. Considerations When Using Packaged (for example, Shaded) Jars</a></span></dt></dl></dd><dt><span class="section"><a href="#programming-tips">5.7. Programming Tips and Tricks</a></span></dt><dd><dl><dt><span class="section"><a href="#_xml_schemas">5.7.1. XML Schemas</a></span></dt><dt><span class="section"><a href="#_finding_class_names_for_java_and_dsl_configuration">5.7.2. Finding Class Names for Java and DSL Configuration</a></span></dt></dl></dd><dt><span class="section"><a href="#pojo-invocation">5.8. POJO Method invocation</a></span></dt></dl></dd></dl></dd><dt><span class="part"><a href="#spring-integration-core-messaging">IV. Core Messaging</a></span></dt><dd><dl><dt><span class="chapter"><a href="#messaging-channels-section">6. Messaging Channels</a></span></dt><dd><dl><dt><span class="section"><a href="#channel">6.1. Message Channels</a></span></dt><dd><dl><dt><span class="section"><a href="#channel-interfaces">6.1.1. The MessageChannel Interface</a></span></dt><dd><dl><dt><span class="section"><a href="#channel-interfaces-pollablechannel"><code class="literal">PollableChannel</code></a></span></dt><dt><span class="section"><a href="#channel-interfaces-subscribablechannel"><code class="literal">SubscribableChannel</code></a></span></dt></dl></dd><dt><span class="section"><a href="#channel-implementations">6.1.2. Message Channel Implementations</a></span></dt><dd><dl><dt><span class="section"><a href="#channel-implementations-publishsubscribechannel"><code class="literal">PublishSubscribeChannel</code></a></span></dt><dt><span class="section"><a href="#channel-implementations-queuechannel"><code class="literal">QueueChannel</code></a></span></dt><dt><span class="section"><a href="#channel-implementations-prioritychannel"><code class="literal">PriorityChannel</code></a></span></dt><dt><span class="section"><a href="#channel-implementations-rendezvouschannel"><code class="literal">RendezvousChannel</code></a></span></dt><dt><span class="section"><a href="#channel-implementations-directchannel"><code class="literal">DirectChannel</code></a></span></dt><dt><span class="section"><a href="#executor-channel"><code class="literal">ExecutorChannel</code></a></span></dt><dt><span class="section"><a href="#channel-implementations-threadlocalchannel">Scoped Channel</a></span></dt></dl></dd><dt><span class="section"><a href="#channel-interceptors">6.1.3. Channel Interceptors</a></span></dt><dt><span class="section"><a href="#channel-template">6.1.4. <code class="literal">MessagingTemplate</code></a></span></dt><dt><span class="section"><a href="#channel-configuration">6.1.5. Configuring Message Channels</a></span></dt><dd><dl><dt><span class="section"><a href="#channel-configuration-directchannel"><code class="literal">DirectChannel</code> Configuration</a></span></dt><dt><span class="section"><a href="#channel-datatype-channel">Datatype Channel Configuration</a></span></dt><dt><span class="section"><a href="#channel-configuration-queuechannel"><code class="literal">QueueChannel</code> Configuration</a></span></dt><dt><span class="section"><a href="#channel-configuration-pubsubchannel"><code class="literal">PublishSubscribeChannel</code> Configuration</a></span></dt><dt><span class="section"><a href="#channel-configuration-executorchannel"><code class="literal">ExecutorChannel</code></a></span></dt><dt><span class="section"><a href="#channel-configuration-prioritychannel"><code class="literal">PriorityChannel</code> Configuration</a></span></dt><dt><span class="section"><a href="#channel-configuration-rendezvouschannel"><code class="literal">RendezvousChannel</code> Configuration</a></span></dt><dt><span class="section"><a href="#channel-configuration-threadlocalchannel">Scoped Channel Configuration</a></span></dt><dt><span class="section"><a href="#channel-configuration-interceptors">Channel Interceptor Configuration</a></span></dt><dt><span class="section"><a href="#global-channel-configuration-interceptors">Global Channel Interceptor Configuration</a></span></dt><dt><span class="section"><a href="#channel-wiretap">Wire Tap</a></span></dt><dt><span class="section"><a href="#conditional-wiretap">Conditional Wire Taps</a></span></dt><dt><span class="section"><a href="#channel-global-wiretap">Global Wire Tap Configuration</a></span></dt></dl></dd><dt><span class="section"><a href="#channel-special-channels">6.1.6. Special Channels</a></span></dt></dl></dd><dt><span class="section"><a href="#polling-consumer">6.2. Poller</a></span></dt><dd><dl><dt><span class="section"><a href="#_polling_consumer">6.2.1. Polling Consumer</a></span></dt><dt><span class="section"><a href="#pollable-message-source">6.2.2. Pollable Message Source</a></span></dt><dt><span class="section"><a href="#deferred-acks-message-source">6.2.3. Deferred Acknowledgment Pollable Message Source</a></span></dt><dt><span class="section"><a href="#conditional-pollers">6.2.4. Conditional Pollers for Message Sources</a></span></dt><dd><dl><dt><span class="section"><a href="#_background">Background</a></span></dt><dt><span class="section"><a href="#_literal_smart_literal_polling">"<code class="literal">Smart</code>" Polling</a></span></dt><dt><span class="section"><a href="#_literal_simpleactiveidlemessagesourceadvice_literal"><code class="literal">SimpleActiveIdleMessageSourceAdvice</code></a></span></dt><dt><span class="section"><a href="#_literal_compoundtriggeradvice_literal"><code class="literal">CompoundTriggerAdvice</code></a></span></dt></dl></dd></dl></dd><dt><span class="section"><a href="#channel-adapter">6.3. Channel Adapter</a></span></dt><dd><dl><dt><span class="section"><a href="#channel-adapter-namespace-inbound">6.3.1. Configuring An Inbound Channel Adapter</a></span></dt><dt><span class="section"><a href="#channel-adapter-namespace-outbound">6.3.2. Configuring An Outbound Channel Adapter</a></span></dt><dt><span class="section"><a href="#channel-adapter-expressions-and-scripts">6.3.3. Channel Adapter Expressions and Scripts</a></span></dt></dl></dd><dt><span class="section"><a href="#bridge">6.4. Messaging Bridge</a></span></dt><dd><dl><dt><span class="section"><a href="#bridge-namespace">6.4.1. Configuring a Bridge with XML</a></span></dt><dt><span class="section"><a href="#bridge-annot">6.4.2. Configuring a Bridge with Java Configuration</a></span></dt><dt><span class="section"><a href="#bridge-dsl">6.4.3. Configuring a Bridge with the Java DSL</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#message">7. Message</a></span></dt><dd><dl><dt><span class="section"><a href="#message-interface">7.1. The <code class="literal">Message</code> Interface</a></span></dt><dt><span class="section"><a href="#message-headers">7.2. Message Headers</a></span></dt><dd><dl><dt><span class="section"><a href="#message-header-accessor">7.2.1. <code class="literal">MessageHeaderAccessor</code> API</a></span></dt><dt><span class="section"><a href="#message-id-generation">7.2.2. Message ID Generation</a></span></dt><dt><span class="section"><a href="#read-only-headers">7.2.3. Read-only Headers</a></span></dt><dt><span class="section"><a href="#header-propagation">7.2.4. Header Propagation</a></span></dt></dl></dd><dt><span class="section"><a href="#message-implementations">7.3. Message Implementations</a></span></dt><dt><span class="section"><a href="#message-builder">7.4. The <code class="literal">MessageBuilder</code> Helper Class</a></span></dt></dl></dd><dt><span class="chapter"><a href="#messaging-routing-chapter">8. Message Routing</a></span></dt><dd><dl><dt><span class="section"><a href="#router">8.1. Routers</a></span></dt><dd><dl><dt><span class="section"><a href="#router-overview">8.1.1. Overview</a></span></dt><dt><span class="section"><a href="#router-common-parameters">8.1.2. Common Router Parameters</a></span></dt><dd><dl><dt><span class="section"><a href="#router-common-parameters-all">Inside and Outside of a Chain</a></span></dt><dt><span class="section"><a href="#router-common-parameters-top">Top-Level (Outside of a Chain)</a></span></dt></dl></dd><dt><span class="section"><a href="#router-implementations">8.1.3. Router Implementations</a></span></dt><dd><dl><dt><span class="section"><a href="#router-implementations-payloadtyperouter"><code class="literal">PayloadTypeRouter</code></a></span></dt><dt><span class="section"><a href="#router-implementations-headervaluerouter"><code class="literal">HeaderValueRouter</code></a></span></dt><dt><span class="section"><a href="#router-implementations-recipientlistrouter"><code class="literal">RecipientListRouter</code></a></span></dt><dt><span class="section"><a href="#recipient-list-router-management"><code class="literal">RecipientListRouterManagement</code></a></span></dt><dt><span class="section"><a href="#router-implementations-xpath-router">XPath Router</a></span></dt><dt><span class="section"><a href="#router-implementations-exception-router">Routing and Error Handling</a></span></dt></dl></dd><dt><span class="section"><a href="#router-namespace">8.1.4. Configuring a Generic Router</a></span></dt><dd><dl><dt><span class="section"><a href="#_configuring_a_content_based_router_with_xml">Configuring a Content-based Router with XML</a></span></dt></dl></dd><dt><span class="section"><a href="#router-spel">8.1.5. Routers and the Spring Expression Language (SpEL)</a></span></dt><dd><dl><dt><span class="section"><a href="#router-annotation">Configuring a Router with Annotations</a></span></dt></dl></dd><dt><span class="section"><a href="#dynamic-routers">8.1.6. Dynamic Routers</a></span></dt><dd><dl><dt><span class="section"><a href="#dynamic-routers-control-bus">Manage Router Mappings using the Control Bus</a></span></dt><dt><span class="section"><a href="#dynamic-routers-jmx">Manage Router Mappings by Using JMX</a></span></dt><dt><span class="section"><a href="#routing-slip">Routing Slip</a></span></dt><dt><span class="section"><a href="#process-manager">Process Manager Enterprise Integration Pattern</a></span></dt></dl></dd></dl></dd><dt><span class="section"><a href="#filter">8.2. Filter</a></span></dt><dd><dl><dt><span class="section"><a href="#filter-xml">8.2.1. Configuring a Filter with XML</a></span></dt><dt><span class="section"><a href="#filter-annotations">8.2.2. Configuring a Filter with Annotations</a></span></dt></dl></dd><dt><span class="section"><a href="#splitter">8.3. Splitter</a></span></dt><dd><dl><dt><span class="section"><a href="#_programming_model">8.3.1. Programming Model</a></span></dt><dd><dl><dt><span class="section"><a href="#_iterators">Iterators</a></span></dt><dt><span class="section"><a href="#_stream_and_flux">Stream and Flux</a></span></dt></dl></dd><dt><span class="section"><a href="#_configuring_a_splitter_with_xml">8.3.2. Configuring a Splitter with XML</a></span></dt><dt><span class="section"><a href="#_configuring_a_splitter_with_annotations">8.3.3. Configuring a Splitter with Annotations</a></span></dt></dl></dd><dt><span class="section"><a href="#aggregator">8.4. Aggregator</a></span></dt><dd><dl><dt><span class="section"><a href="#aggregator-functionality">8.4.1. Functionality</a></span></dt><dt><span class="section"><a href="#aggregator-api">8.4.2. Programming Model</a></span></dt><dd><dl><dt><span class="section"><a href="#_literal_aggregatingmessagehandler_literal"><code class="literal">AggregatingMessageHandler</code></a></span></dt><dt><span class="section"><a href="#_literal_releasestrategy_literal"><code class="literal">ReleaseStrategy</code></a></span></dt><dt><span class="section"><a href="#_aggregating_large_groups">Aggregating Large Groups</a></span></dt><dt><span class="section"><a href="#_correlation_strategy">Correlation Strategy</a></span></dt><dt><span class="section"><a href="#_lock_registry">Lock Registry</a></span></dt><dt><span class="section"><a href="#aggregator-deadlocks">Avoiding Deadlocks</a></span></dt></dl></dd><dt><span class="section"><a href="#aggregator-java-dsl">8.4.3. Configuring an Aggregator in Java DSL</a></span></dt><dd><dl><dt><span class="section"><a href="#aggregator-xml">Configuring an Aggregator with XML</a></span></dt><dt><span class="section"><a href="#aggregator-annotations">Configuring an Aggregator with Annotations</a></span></dt></dl></dd><dt><span class="section"><a href="#reaper">8.4.4. Managing State in an Aggregator: <code class="literal">MessageGroupStore</code></a></span></dt></dl></dd><dt><span class="section"><a href="#resequencer">8.5. Resequencer</a></span></dt><dd><dl><dt><span class="section"><a href="#resequencer-functionality">8.5.1. Functionality</a></span></dt><dt><span class="section"><a href="#_configuring_a_resequencer">8.5.2. Configuring a Resequencer</a></span></dt></dl></dd><dt><span class="section"><a href="#chain">8.6. Message Handler Chain</a></span></dt><dd><dl><dt><span class="section"><a href="#chain-namespace">8.6.1. Configuring a Chain</a></span></dt><dt><span class="section"><a href="#_using_the_emphasis_id_emphasis_attribute">8.6.2. Using the <span class="emphasis"><em>id</em></span> Attribute</a></span></dt><dt><span class="section"><a href="#_calling_a_chain_from_within_a_chain">8.6.3. Calling a Chain from within a Chain</a></span></dt></dl></dd><dt><span class="section"><a href="#scatter-gather">8.7. Scatter-Gather</a></span></dt><dd><dl><dt><span class="section"><a href="#scatter-gather-functionality">8.7.1. Functionality</a></span></dt><dd><dl><dt><span class="section"><a href="#_auction">Auction</a></span></dt><dt><span class="section"><a href="#_distribution">Distribution</a></span></dt></dl></dd><dt><span class="section"><a href="#scatter-gather-namespace">8.7.2. Configuring a Scatter-Gather Endpoint</a></span></dt></dl></dd><dt><span class="section"><a href="#barrier">8.8. Thread Barrier</a></span></dt></dl></dd><dt><span class="chapter"><a href="#messaging-transformation-chapter">9. Message Transformation</a></span></dt><dd><dl><dt><span class="section"><a href="#transformer">9.1. Transformer</a></span></dt><dd><dl><dt><span class="section"><a href="#transformer-namespace">9.1.1. Configuring a Transformer with XML</a></span></dt><dt><span class="section"><a href="#_transformers_and_spring_expression_language_spel">9.1.2. Transformers and Spring Expression Language (SpEL)</a></span></dt><dt><span class="section"><a href="#_common_transformers">9.1.3. Common Transformers</a></span></dt><dd><dl><dt><span class="section"><a href="#_object_to_string_transformer">Object-to-String Transformer</a></span></dt><dt><span class="section"><a href="#_literal_object_literal_to_literal_map_literal_and_literal_map_literal_to_literal_object_literal_transformers"><code class="literal">Object</code>-to-<code class="literal">Map</code> and <code class="literal">Map</code>-to-<code class="literal">Object</code> Transformers</a></span></dt><dt><span class="section"><a href="#stream-transformer">Stream Transformer</a></span></dt><dt><span class="section"><a href="#json-transformers">JSON Transformers</a></span></dt></dl></dd><dt><span class="section"><a href="#transformer-annotation">9.1.4. Configuring a Transformer with Annotations</a></span></dt><dt><span class="section"><a href="#header-filter">9.1.5. Header Filter</a></span></dt><dt><span class="section"><a href="#_codec_based_transformers">9.1.6. Codec-Based Transformers</a></span></dt></dl></dd><dt><span class="section"><a href="#content-enricher">9.2. Content Enricher</a></span></dt><dd><dl><dt><span class="section"><a href="#header-enricher">9.2.1. Header Enricher</a></span></dt><dd><dl><dt><span class="section"><a href="#_pojo_support">POJO Support</a></span></dt><dt><span class="section"><a href="#_spel_support">SpEL Support</a></span></dt><dt><span class="section"><a href="#_configuring_a_header_enricher_with_java_configuration">Configuring a Header Enricher with Java Configuration</a></span></dt><dt><span class="section"><a href="#_configuring_a_header_enricher_with_the_java_dsl">Configuring a Header Enricher with the Java DSL</a></span></dt><dt><span class="section"><a href="#header-channel-registry">Header Channel Registry</a></span></dt></dl></dd><dt><span class="section"><a href="#payload-enricher">9.2.2. Payload Enricher</a></span></dt><dd><dl><dt><span class="section"><a href="#payload-enricher-configuration">Configuration</a></span></dt><dt><span class="section"><a href="#payload-enricher-examples">Examples</a></span></dt><dt><span class="section"><a href="#_how_do_i_pass_only_a_subset_of_data_to_the_request_channel">How Do I Pass Only a Subset of Data to the Request Channel?</a></span></dt><dt><span class="section"><a href="#_how_can_i_enrich_payloads_with_static_information_without_using_a_request_channel">How Can I Enrich Payloads with Static Information without Using a Request Channel?</a></span></dt></dl></dd></dl></dd><dt><span class="section"><a href="#claim-check">9.3. Claim Check</a></span></dt><dd><dl><dt><span class="section"><a href="#claim-check-in">9.3.1. Incoming Claim Check Transformer</a></span></dt><dt><span class="section"><a href="#claim-check-out">9.3.2. Outgoing Claim Check Transformer</a></span></dt><dt><span class="section"><a href="#_claim_once">9.3.3. Claim Once</a></span></dt><dt><span class="section"><a href="#_a_word_on_message_store">9.3.4. A Word on Message Store</a></span></dt></dl></dd><dt><span class="section"><a href="#codec">9.4. Codec</a></span></dt><dd><dl><dt><span class="section"><a href="#_literal_encodingpayloadtransformer_literal">9.4.1. <code class="literal">EncodingPayloadTransformer</code></a></span></dt><dt><span class="section"><a href="#_literal_decodingtransformer_literal">9.4.2. <code class="literal">DecodingTransformer</code></a></span></dt><dt><span class="section"><a href="#_literal_codecmessageconverter_literal">9.4.3. <code class="literal">CodecMessageConverter</code></a></span></dt><dt><span class="section"><a href="#_kryo">9.4.4. Kryo</a></span></dt><dd><dl><dt><span class="section"><a href="#_customizing_kryo">Customizing Kryo</a></span></dt></dl></dd></dl></dd></dl></dd><dt><span class="chapter"><a href="#messaging-endpoints-chapter">10. Messaging Endpoints</a></span></dt><dd><dl><dt><span class="section"><a href="#endpoint">10.1. Message Endpoints</a></span></dt><dd><dl><dt><span class="section"><a href="#endpoint-handler">10.1.1. Message Handler</a></span></dt><dt><span class="section"><a href="#endpoint-eventdrivenconsumer">10.1.2. Event-driven Consumer</a></span></dt><dt><span class="section"><a href="#endpoint-pollingconsumer">10.1.3. Polling Consumer</a></span></dt><dt><span class="section"><a href="#endpoint-namespace">10.1.4. Endpoint Namespace Support</a></span></dt><dd><dl><dt><span class="section"><a href="#_examples">Examples</a></span></dt><dt><span class="section"><a href="#aop-advice-chains">AOP Advice chains</a></span></dt></dl></dd><dt><span class="section"><a href="#polling-consumer-change-polling-rate">10.1.5. Changing Polling Rate at Runtime</a></span></dt><dt><span class="section"><a href="#payload-type-conversion">10.1.6. Payload Type Conversion</a></span></dt><dt><span class="section"><a href="#content-type-conversion">10.1.7. Content Type Conversion</a></span></dt><dt><span class="section"><a href="#async-polling">10.1.8. Asynchronous Polling</a></span></dt><dt><span class="section"><a href="#endpoint-inner">10.1.9. Endpoint Inner Beans</a></span></dt></dl></dd><dt><span class="section"><a href="#endpoint-roles">10.2. Endpoint Roles</a></span></dt><dt><span class="section"><a href="#leadership-event-handling">10.3. Leadership Event Handling</a></span></dt><dt><span class="section"><a href="#gateway">10.4. Messaging Gateways</a></span></dt><dd><dl><dt><span class="section"><a href="#gateway-proxy">10.4.1. Enter the <code class="literal">GatewayProxyFactoryBean</code></a></span></dt><dt><span class="section"><a href="#gateway-namespace">10.4.2. Gateway XML Namespace Support</a></span></dt><dt><span class="section"><a href="#gateway-default-reply-channel">10.4.3. Setting the Default Reply Channel</a></span></dt><dt><span class="section"><a href="#gateway-configuration-annotations">10.4.4. Gateway Configuration with Annotations and XML</a></span></dt><dd><dl><dt><span class="section"><a href="#_expressions_and_literal_global_literal_headers">Expressions and "<code class="literal">Global</code>" Headers</a></span></dt></dl></dd><dt><span class="section"><a href="#gateway-mapping">10.4.5. Mapping Method Arguments to a Message</a></span></dt><dd><dl><dt><span class="section"><a href="#_mapping_method_arguments">Mapping Method Arguments</a></span></dt></dl></dd><dt><span class="section"><a href="#messaging-gateway-annotation">10.4.6. <code class="literal">@MessagingGateway</code> Annotation</a></span></dt><dt><span class="section"><a href="#gateway-calling-no-argument-methods">10.4.7. Invoking No-Argument Methods</a></span></dt><dt><span class="section"><a href="#gateway-error-handling">10.4.8. Error Handling</a></span></dt><dt><span class="section"><a href="#gateway-timeouts">10.4.9. Gateway Timeouts</a></span></dt><dt><span class="section"><a href="#async-gateway">10.4.10. Asynchronous Gateway</a></span></dt><dd><dl><dt><span class="section"><a href="#_literal_listenablefuture_literal"><code class="literal">ListenableFuture</code></a></span></dt><dt><span class="section"><a href="#gateway-asynctaskexecutor"><code class="literal">AsyncTaskExecutor</code></a></span></dt><dt><span class="section"><a href="#gw-completable-future"><code class="literal">CompletableFuture</code></a></span></dt><dt><span class="section"><a href="#_reactor_literal_mono_literal">Reactor <code class="literal">Mono</code></a></span></dt><dt><span class="section"><a href="#_downstream_flows_returning_an_asynchronous_type">Downstream Flows Returning an Asynchronous Type</a></span></dt><dt><span class="section"><a href="#_literal_void_literal_return_type"><code class="literal">void</code> Return Type</a></span></dt></dl></dd><dt><span class="section"><a href="#gateway-no-response">10.4.11. Gateway Behavior When No response Arrives</a></span></dt><dd><dl><dt><span class="section"><a href="#long-running-process-downstream">Long-running Process Downstream</a></span></dt><dt><span class="section"><a href="#_downstream_component_returns_emphasis_null_emphasis">Downstream Component Returns <span class="emphasis"><em>null</em></span></a></span></dt><dt><span class="section"><a href="#_downstream_component_return_signature_is_emphasis_void_emphasis_while_gateway_method_signature_is_non_void">Downstream Component Return Signature is <span class="emphasis"><em>void</em></span> While Gateway Method Signature Is Non-void</a></span></dt><dt><span class="section"><a href="#_downstream_component_results_in_runtime_exception">Downstream Component Results in Runtime Exception</a></span></dt></dl></dd></dl></dd><dt><span class="section"><a href="#service-activator">10.5. Service Activator</a></span></dt><dd><dl><dt><span class="section"><a href="#service-activator-namespace">10.5.1. Configuring Service Activator</a></span></dt><dd><dl><dt><span class="section"><a href="#_service_activators_and_the_spring_expression_language_spel">Service Activators and the Spring Expression Language (SpEL)</a></span></dt></dl></dd><dt><span class="section"><a href="#async-service-activator">10.5.2. Asynchronous Service Activator</a></span></dt><dt><span class="section"><a href="#service-activator-return-type">10.5.3. Service Activator and Method Return Type</a></span></dt></dl></dd><dt><span class="section"><a href="#delayer">10.6. Delayer</a></span></dt><dd><dl><dt><span class="section"><a href="#delayer-namespace">10.6.1. Configuring a Delayer</a></span></dt><dt><span class="section"><a href="#delayer-message-store">10.6.2. Delayer and a Message Store</a></span></dt><dt><span class="section"><a href="#delayer-release-failures">10.6.3. Release Failures</a></span></dt></dl></dd><dt><span class="section"><a href="#scripting">10.7. Scripting Support</a></span></dt><dd><dl><dt><span class="section"><a href="#scripting-config">10.7.1. Script Configuration</a></span></dt><dd><dl><dt><span class="section"><a href="#scripting-script-variable-bindings">Script Variable Bindings</a></span></dt></dl></dd></dl></dd><dt><span class="section"><a href="#groovy">10.8. Groovy support</a></span></dt><dd><dl><dt><span class="section"><a href="#groovy-config">10.8.1. Groovy Configuration</a></span></dt><dt><span class="section"><a href="#_groovy_object_customization">10.8.2. Groovy Object Customization</a></span></dt><dt><span class="section"><a href="#_groovy_script_compiler_customization">10.8.3. Groovy Script Compiler Customization</a></span></dt><dt><span class="section"><a href="#groovy-control-bus">10.8.4. Control Bus</a></span></dt></dl></dd><dt><span class="section"><a href="#message-handler-advice-chain">10.9. Adding Behavior to Endpoints</a></span></dt><dd><dl><dt><span class="section"><a href="#advice-classes">10.9.1. Provided Advice Classes</a></span></dt><dd><dl><dt><span class="section"><a href="#retry-advice">Retry Advice</a></span></dt><dt><span class="section"><a href="#circuit-breaker-advice">Circuit Breaker Advice</a></span></dt><dt><span class="section"><a href="#expression-advice">Expression Evaluating Advice</a></span></dt></dl></dd><dt><span class="section"><a href="#custom-advice">10.9.2. Custom Advice Classes</a></span></dt><dt><span class="section"><a href="#other-advice">10.9.3. Other Advice Chain Elements</a></span></dt><dt><span class="section"><a href="#handle-message-advice">10.9.4. Handling Message Advice</a></span></dt><dt><span class="section"><a href="#tx-handle-message-advice">10.9.5. Transaction Support</a></span></dt><dt><span class="section"><a href="#advising-filters">10.9.6. Advising Filters</a></span></dt><dt><span class="section"><a href="#advising-with-annotations">10.9.7. Advising Endpoints Using Annotations</a></span></dt><dt><span class="section"><a href="#advice-order">10.9.8. Ordering Advices within an Advice Chain</a></span></dt><dt><span class="section"><a href="#advised-handler-properties">10.9.9. Advised Handler Properties</a></span></dt><dt><span class="section"><a href="#idempotent-receiver">10.9.10. Idempotent Receiver Enterprise Integration Pattern</a></span></dt></dl></dd><dt><span class="section"><a href="#logging-channel-adapter">10.10. Logging Channel Adapter</a></span></dt><dd><dl><dt><span class="section"><a href="#_using_java_configuration">10.10.1. Using Java Configuration</a></span></dt><dt><span class="section"><a href="#_configuring_with_the_java_dsl">10.10.2. Configuring with the Java DSL</a></span></dt></dl></dd><dt><span class="section"><a href="#functions-support">10.11. <code class="literal">java.util.function</code> Interfaces Support</a></span></dt><dd><dl><dt><span class="section"><a href="#kotlin-functions-support">10.11.1. Kotlin Lambdas</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#java-dsl">11. Java DSL</a></span></dt><dd><dl><dt><span class="section"><a href="#java-dsl-basics">11.1. DSL Basics</a></span></dt><dt><span class="section"><a href="#java-dsl-channels">11.2. Message Channels</a></span></dt><dt><span class="section"><a href="#java-dsl-pollers">11.3. Pollers</a></span></dt><dt><span class="section"><a href="#java-dsl-endpoints">11.4. DSL and Endpoint Configuration</a></span></dt><dt><span class="section"><a href="#java-dsl-transformers">11.5. Transformers</a></span></dt><dt><span class="section"><a href="#java-dsl-inbound-adapters">11.6. Inbound Channel Adapters</a></span></dt><dt><span class="section"><a href="#java-dsl-routers">11.7. Message Routers</a></span></dt><dt><span class="section"><a href="#java-dsl-splitters">11.8. Splitters</a></span></dt><dt><span class="section"><a href="#java-dsl-aggregators">11.9. Aggregators and Resequencers</a></span></dt><dt><span class="section"><a href="#java-dsl-handle">11.10. Service Activators and the <code class="literal">.handle()</code> method</a></span></dt><dt><span class="section"><a href="#java-dsl-log">11.11. Operator log()</a></span></dt><dt><span class="section"><a href="#java-dsl-wiretap">11.12. <code class="literal">MessageChannelSpec.wireTap()</code></a></span></dt><dt><span class="section"><a href="#java-dsl-flows">11.13. Working With Message Flows</a></span></dt><dt><span class="section"><a href="#java-dsl-function-expression">11.14. <code class="literal">FunctionExpression</code></a></span></dt><dt><span class="section"><a href="#java-dsl-subflows">11.15. Sub-flows support</a></span></dt><dt><span class="section"><a href="#java-dsl-protocol-adapters">11.16. Using Protocol Adapters</a></span></dt><dt><span class="section"><a href="#java-dsl-flow-adapter">11.17. <code class="literal">IntegrationFlowAdapter</code></a></span></dt><dt><span class="section"><a href="#java-dsl-runtime-flows">11.18. Dynamic and Runtime Integration Flows</a></span></dt><dt><span class="section"><a href="#java-dsl-gateway">11.19. <code class="literal">IntegrationFlow</code> as Gateway</a></span></dt></dl></dd><dt><span class="chapter"><a href="#system-management-chapter">12. System Management</a></span></dt><dd><dl><dt><span class="section"><a href="#metrics-management">12.1. Metrics and Management</a></span></dt><dd><dl><dt><span class="section"><a href="#configuring-metrics-capture">12.1.1. Configuring Metrics Capture</a></span></dt><dt><span class="section"><a href="#micrometer-integration">12.1.2. Micrometer Integration</a></span></dt><dt><span class="section"><a href="#mgmt-channel-features">12.1.3. <code class="literal">MessageChannel</code> Metric Features</a></span></dt><dt><span class="section"><a href="#mgmt-handler-features">12.1.4. MessageHandler Metric Features</a></span></dt><dt><span class="section"><a href="#mgmt-statistics">12.1.5. Time-Based Average Estimates</a></span></dt><dt><span class="section"><a href="#mgmt-metrics-factory">12.1.6. Metrics Factory</a></span></dt><dd><dl><dt><span class="section"><a href="#_customizing_the_default_channel_and_handler_statistics">Customizing the Default Channel and Handler Statistics</a></span></dt><dt><span class="section"><a href="#_advanced_customization">Advanced Customization</a></span></dt><dt><span class="section"><a href="#_performance_improvement">Performance Improvement</a></span></dt></dl></dd></dl></dd><dt><span class="section"><a href="#jmx">12.2. JMX Support</a></span></dt><dd><dl><dt><span class="section"><a href="#jmx-notification-listening-channel-adapter">12.2.1. Notification-listening Channel Adapter</a></span></dt><dt><span class="section"><a href="#jmx-notification-publishing-channel-adapter">12.2.2. Notification-publishing Channel Adapter</a></span></dt><dt><span class="section"><a href="#jmx-attribute-polling-channel-adapter">12.2.3. Attribute-polling Channel Adapter</a></span></dt><dt><span class="section"><a href="#tree-polling-channel-adapter">12.2.4. Tree-polling Channel Adapter</a></span></dt><dt><span class="section"><a href="#jmx-operation-invoking-channel-adapter">12.2.5. Operation-invoking Channel Adapter</a></span></dt><dt><span class="section"><a href="#jmx-operation-invoking-outbound-gateway">12.2.6. Operation-invoking Outbound Gateway</a></span></dt><dt><span class="section"><a href="#jmx-mbean-exporter">12.2.7. MBean Exporter</a></span></dt><dd><dl><dt><span class="section"><a href="#jmx-mbean-features">MBean Object Names</a></span></dt><dt><span class="section"><a href="#jmx-42-improvements">JMX Improvements</a></span></dt><dt><span class="section"><a href="#jmx-mbean-shutdown">Orderly Shutdown Managed Operation</a></span></dt></dl></dd></dl></dd><dt><span class="section"><a href="#message-history">12.3. Message History</a></span></dt><dd><dl><dt><span class="section"><a href="#message-history-config">12.3.1. Message History Configuration</a></span></dt></dl></dd><dt><span class="section"><a href="#message-store">12.4. Message Store</a></span></dt><dd><dl><dt><span class="section"><a href="#message-group-factory">12.4.1. Using <code class="literal">MessageGroupFactory</code></a></span></dt><dt><span class="section"><a href="#lazy-load-message-group">12.4.2. Persistent <code class="literal">MessageGroupStore</code> and Lazy-load</a></span></dt></dl></dd><dt><span class="section"><a href="#metadata-store">12.5. Metadata Store</a></span></dt><dd><dl><dt><span class="section"><a href="#idempotent-receiver-pattern">12.5.1. Idempotent Receiver and Metadata Store</a></span></dt><dt><span class="section"><a href="#metadatastore-listener">12.5.2. <code class="literal">MetadataStoreListener</code></a></span></dt></dl></dd><dt><span class="section"><a href="#control-bus">12.6. Control Bus</a></span></dt><dt><span class="section"><a href="#jmx-shutdown">12.7. Orderly Shutdown</a></span></dt><dt><span class="section"><a href="#integration-graph">12.8. Integration Graph</a></span></dt><dd><dl><dt><span class="section"><a href="#_graph_runtime_model">12.8.1. Graph Runtime Model</a></span></dt></dl></dd><dt><span class="section"><a href="#_integration_graph_controller">12.9. Integration Graph Controller</a></span></dt></dl></dd></dl></dd><dt><span class="part"><a href="#spring-integration-endpoints">V. Integration Endpoints</a></span></dt><dd><dl><dt><span class="chapter"><a href="#endpoint-summary">13. Endpoint Quick Reference Table</a></span></dt><dt><span class="chapter"><a href="#amqp">14. AMQP Support</a></span></dt><dd><dl><dt><span class="section"><a href="#amqp-inbound-channel-adapter">14.1. Inbound Channel Adapter</a></span></dt><dd><dl><dt><span class="section"><a href="#_configuring_with_java_configuration">14.1.1. Configuring with Java Configuration</a></span></dt><dt><span class="section"><a href="#_configuring_with_the_java_dsl_2">14.1.2. Configuring with the Java DSL</a></span></dt></dl></dd><dt><span class="section"><a href="#_polled_inbound_channel_adapter">14.2. Polled Inbound Channel Adapter</a></span></dt><dt><span class="section"><a href="#amqp-inbound-gateway">14.3. Inbound Gateway</a></span></dt><dd><dl><dt><span class="section"><a href="#_configuring_with_java_configuration_2">14.3.1. Configuring with Java Configuration</a></span></dt><dt><span class="section"><a href="#_configuring_with_the_java_dsl_3">14.3.2. Configuring with the Java DSL</a></span></dt></dl></dd><dt><span class="section"><a href="#amqp-inbound-ack">14.4. Inbound Endpoint Acknowledge Mode</a></span></dt><dt><span class="section"><a href="#amqp-outbound-channel-adapter">14.5. Outbound Channel Adapter</a></span></dt><dd><dl><dt><span class="section"><a href="#_configuring_with_java_configuration_3">14.5.1. Configuring with Java Configuration</a></span></dt><dt><span class="section"><a href="#_configuring_with_the_java_dsl_4">14.5.2. Configuring with the Java DSL</a></span></dt></dl></dd><dt><span class="section"><a href="#amqp-outbound-gateway">14.6. Outbound Gateway</a></span></dt><dd><dl><dt><span class="section"><a href="#_configuring_with_java_configuration_4">14.6.1. Configuring with Java Configuration</a></span></dt><dt><span class="section"><a href="#_configuring_with_the_java_dsl_5">14.6.2. Configuring with the Java DSL</a></span></dt></dl></dd><dt><span class="section"><a href="#amqp-async-outbound-gateway">14.7. Asynchronous Outbound Gateway</a></span></dt><dd><dl><dt><span class="section"><a href="#_configuring_with_java_configuration_5">14.7.1. Configuring with Java Configuration</a></span></dt><dt><span class="section"><a href="#_configuring_with_the_java_dsl_6">14.7.2. Configuring with the Java DSL</a></span></dt></dl></dd><dt><span class="section"><a href="#content-type-conversion-outbound">14.8. Outbound Message Conversion</a></span></dt><dt><span class="section"><a href="#amqp-user-id">14.9. Outbound User ID</a></span></dt><dt><span class="section"><a href="#amqp-delay">14.10. Delayed Message Exchange</a></span></dt><dt><span class="section"><a href="#amqp-channels">14.11. AMQP-backed Message Channels</a></span></dt><dd><dl><dt><span class="section"><a href="#_configuring_with_java_configuration_6">14.11.1. Configuring with Java Configuration</a></span></dt><dt><span class="section"><a href="#_configuring_with_the_java_dsl_7">14.11.2. Configuring with the Java DSL</a></span></dt></dl></dd><dt><span class="section"><a href="#amqp-message-headers">14.12. AMQP Message Headers</a></span></dt><dd><dl><dt><span class="section"><a href="#_overview">14.12.1. Overview</a></span></dt><dt><span class="section"><a href="#amqp-content-type">14.12.2. contentType Header</a></span></dt></dl></dd><dt><span class="section"><a href="#amqp-strict-ordering">14.13. Strict Message Ordering</a></span></dt><dd><dl><dt><span class="section"><a href="#_inbound">14.13.1. Inbound</a></span></dt><dt><span class="section"><a href="#_outbound">14.13.2. Outbound</a></span></dt></dl></dd><dt><span class="section"><a href="#_amqp_samples">14.14. AMQP Samples</a></span></dt></dl></dd><dt><span class="chapter"><a href="#applicationevent">15. Spring <code class="literal">ApplicationEvent</code> Support</a></span></dt><dd><dl><dt><span class="section"><a href="#appevent-inbound">15.1. Receiving Spring Application Events</a></span></dt><dt><span class="section"><a href="#appevent-outbound">15.2. Sending Spring Application Events</a></span></dt></dl></dd><dt><span class="chapter"><a href="#feed">16. Feed Adapter</a></span></dt><dd><dl><dt><span class="section"><a href="#feed-inbound-channel-adapter">16.1. Feed Inbound Channel Adapter</a></span></dt><dt><span class="section"><a href="#_duplicate_entries">16.2. Duplicate Entries</a></span></dt><dt><span class="section"><a href="#_other_options">16.3. Other Options</a></span></dt><dt><span class="section"><a href="#feed-java-configuration">16.4. Java DSL Configuration</a></span></dt></dl></dd><dt><span class="chapter"><a href="#files">17. File Support</a></span></dt><dd><dl><dt><span class="section"><a href="#file-reading">17.1. Reading Files</a></span></dt><dd><dl><dt><span class="section"><a href="#_message_headers">17.1.1. Message Headers</a></span></dt><dt><span class="section"><a href="#_directory_scanning_and_polling">17.1.2. Directory Scanning and Polling</a></span></dt><dt><span class="section"><a href="#file-namespace-support">17.1.3. Namespace Support</a></span></dt><dt><span class="section"><a href="#watch-service-directory-scanner">17.1.4. <code class="literal">WatchServiceDirectoryScanner</code></a></span></dt><dt><span class="section"><a href="#_limiting_memory_consumption">17.1.5. Limiting Memory Consumption</a></span></dt><dt><span class="section"><a href="#_configuring_with_java_configuration_7">17.1.6. Configuring with Java Configuration</a></span></dt><dt><span class="section"><a href="#_configuring_with_the_java_dsl_8">17.1.7. Configuring with the Java DSL</a></span></dt><dt><span class="section"><a href="#file-tailing">17.1.8. 'tail&#8217;ing Files</a></span></dt><dt><span class="section"><a href="#file-incomplete">17.1.9. Dealing With Incomplete Data</a></span></dt></dl></dd><dt><span class="section"><a href="#file-writing">17.2. Writing files</a></span></dt><dd><dl><dt><span class="section"><a href="#file-writing-file-names">17.2.1. Generating File Names</a></span></dt><dt><span class="section"><a href="#file-writing-output-directory">17.2.2. Specifying the Output Directory</a></span></dt><dd><dl><dt><span class="section"><a href="#_using_the_literal_directory_literal_attribute">Using the <code class="literal">directory</code> Attribute</a></span></dt><dt><span class="section"><a href="#_using_the_literal_directory_expression_literal_attribute">Using the <code class="literal">directory-expression</code> Attribute</a></span></dt><dt><span class="section"><a href="#_using_the_literal_auto_create_directory_literal_attribute">Using the <code class="literal">auto-create-directory</code> Attribute</a></span></dt></dl></dd><dt><span class="section"><a href="#file-writing-destination-exists">17.2.3. Dealing with Existing Destination Files</a></span></dt><dt><span class="section"><a href="#file-flushing">17.2.4. Flushing Files When Using <code class="literal">APPEND_NO_FLUSH</code></a></span></dt><dt><span class="section"><a href="#file-timestamps">17.2.5. File Timestamps</a></span></dt><dt><span class="section"><a href="#file-permissions">17.2.6. File Permissions</a></span></dt><dt><span class="section"><a href="#file-outbound-channel-adapter">17.2.7. File Outbound Channel Adapter</a></span></dt><dt><span class="section"><a href="#file-writing-output-gateway">17.2.8. Outbound Gateway</a></span></dt><dt><span class="section"><a href="#_configuring_with_java_configuration_8">17.2.9. Configuring with Java Configuration</a></span></dt><dt><span class="section"><a href="#_configuring_with_the_java_dsl_9">17.2.10. Configuring with the Java DSL</a></span></dt></dl></dd><dt><span class="section"><a href="#file-transforming">17.3. File Transformers</a></span></dt><dt><span class="section"><a href="#file-splitter">17.4. File Splitter</a></span></dt><dd><dl><dt><span class="section"><a href="#_configuring_with_java_configuration_9">17.4.1. Configuring with Java Configuration</a></span></dt><dt><span class="section"><a href="#_configuring_with_the_java_dsl_10">17.4.2. Configuring with the Java DSL</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#ftp">18. FTP/FTPS Adapters</a></span></dt><dd><dl><dt><span class="section"><a href="#ftp-session-factory">18.1. FTP Session Factory</a></span></dt><dd><dl><dt><span class="section"><a href="#_default_factories">18.1.1. Default Factories</a></span></dt></dl></dd><dt><span class="section"><a href="#_advanced_configuration">18.2. Advanced Configuration</a></span></dt><dd><dl><dt><span class="section"><a href="#_ftps_and_shared_sslsession">18.2.1. FTPS and Shared SSLSession</a></span></dt></dl></dd><dt><span class="section"><a href="#ftp-dsf">18.3. Delegating Session Factory</a></span></dt><dt><span class="section"><a href="#ftp-inbound">18.4. FTP Inbound Channel Adapter</a></span></dt><dd><dl><dt><span class="section"><a href="#_more_on_file_filtering_and_incomplete_files">18.4.1. More on File Filtering and Incomplete Files</a></span></dt><dt><span class="section"><a href="#_poller_configuration_notes_for_the_inbound_ftp_adapter">18.4.2. Poller Configuration Notes for the Inbound FTP Adapter</a></span></dt><dt><span class="section"><a href="#_recovering_from_failures">18.4.3. Recovering from Failures</a></span></dt><dt><span class="section"><a href="#_configuring_with_java_configuration_10">18.4.4. Configuring with Java Configuration</a></span></dt><dt><span class="section"><a href="#_configuring_with_the_java_dsl_11">18.4.5. Configuring with the Java DSL</a></span></dt><dt><span class="section"><a href="#ftp-incomplete">18.4.6. Dealing With Incomplete Data</a></span></dt></dl></dd><dt><span class="section"><a href="#ftp-streaming">18.5. FTP Streaming Inbound Channel Adapter</a></span></dt><dd><dl><dt><span class="section"><a href="#ftp-streaming-java">18.5.1. Configuring with Java Configuration</a></span></dt></dl></dd><dt><span class="section"><a href="#ftp-rotating-server-advice">18.6. Inbound Channel Adapters: Polling Multiple Servers and Directories</a></span></dt><dt><span class="section"><a href="#ftp-max-fetch">18.7. Inbound Channel Adapters: Controlling Remote File Fetching</a></span></dt><dt><span class="section"><a href="#ftp-outbound">18.8. FTP Outbound Channel Adapter</a></span></dt><dd><dl><dt><span class="section"><a href="#_avoiding_partially_written_files">18.8.1. Avoiding Partially Written Files</a></span></dt><dt><span class="section"><a href="#_configuring_with_java_configuration_11">18.8.2. Configuring with Java Configuration</a></span></dt><dt><span class="section"><a href="#_configuring_with_the_java_dsl_12">18.8.3. Configuring with the Java DSL</a></span></dt></dl></dd><dt><span class="section"><a href="#ftp-outbound-gateway">18.9. FTP Outbound Gateway</a></span></dt><dd><dl><dt><span class="section"><a href="#ftp-using-ls">18.9.1. Using the <code class="literal">ls</code> Command</a></span></dt><dt><span class="section"><a href="#_using_the_literal_nlst_literal_command">18.9.2. Using the <code class="literal">nlst</code> Command</a></span></dt><dt><span class="section"><a href="#_using_the_literal_get_literal_command">18.9.3. Using the <code class="literal">get</code> Command</a></span></dt><dt><span class="section"><a href="#_using_the_literal_mget_literal_command">18.9.4. Using the <code class="literal">mget</code> Command</a></span></dt><dt><span class="section"><a href="#ftp-put-command">18.9.5. Using the <code class="literal">put</code> Command</a></span></dt><dt><span class="section"><a href="#_using_the_literal_rm_literal_command">18.9.6. Using the <code class="literal">rm</code> Command</a></span></dt><dt><span class="section"><a href="#_using_the_literal_mv_literal_command">18.9.7. Using the <code class="literal">mv</code> Command</a></span></dt><dt><span class="section"><a href="#_additional_information_about_ftp_outbound_gateway_commands">18.9.8. Additional Information about FTP Outbound Gateway Commands</a></span></dt><dt><span class="section"><a href="#_configuring_with_java_configuration_12">18.9.9. Configuring with Java Configuration</a></span></dt><dt><span class="section"><a href="#_configuring_with_the_java_dsl_13">18.9.10. Configuring with the Java DSL</a></span></dt><dt><span class="section"><a href="#ftp-partial">18.9.11. Outbound Gateway Partial Success (<code class="literal">mget</code> and <code class="literal">mput</code>)</a></span></dt></dl></dd><dt><span class="section"><a href="#ftp-session-caching">18.10. FTP Session Caching</a></span></dt><dt><span class="section"><a href="#ftp-rft">18.11. Using <code class="literal">RemoteFileTemplate</code></a></span></dt><dt><span class="section"><a href="#ftp-session-callback">18.12. Using <code class="literal">MessageSessionCallback</code></a></span></dt></dl></dd><dt><span class="chapter"><a href="#gemfire">19. Pivotal GemFire and Apache Geode Support</a></span></dt><dd><dl><dt><span class="section"><a href="#gemfire-inbound">19.1. Inbound Channel Adapter</a></span></dt><dt><span class="section"><a href="#gemfire-cq">19.2. Continuous Query Inbound Channel Adapter</a></span></dt><dt><span class="section"><a href="#gemfire-outbound">19.3. Outbound Channel Adapter</a></span></dt><dt><span class="section"><a href="#gemfire-message-store">19.4. Gemfire Message Store</a></span></dt><dt><span class="section"><a href="#gemfire-lock-registry">19.5. Gemfire Lock Registry</a></span></dt><dt><span class="section"><a href="#gemfire-metadata-store">19.6. Gemfire Metadata Store</a></span></dt></dl></dd><dt><span class="chapter"><a href="#http">20. HTTP Support</a></span></dt><dd><dl><dt><span class="section"><a href="#http-inbound">20.1. Http Inbound Components</a></span></dt><dt><span class="section"><a href="#http-outbound">20.2. HTTP Outbound Components</a></span></dt><dd><dl><dt><span class="section"><a href="#_using_literal_httprequestexecutingmessagehandler_literal">20.2.1. Using <code class="literal">HttpRequestExecutingMessageHandler</code></a></span></dt><dt><span class="section"><a href="#_using_cookies">20.2.2. Using Cookies</a></span></dt></dl></dd><dt><span class="section"><a href="#http-namespace">20.3. HTTP Namespace Support</a></span></dt><dd><dl><dt><span class="section"><a href="#_inbound_2">20.3.1. Inbound</a></span></dt><dt><span class="section"><a href="#http-request-mapping">20.3.2. Request Mapping Support</a></span></dt><dt><span class="section"><a href="#http-cors">20.3.3. Cross-origin Resource Sharing (CORS) Support</a></span></dt><dt><span class="section"><a href="#http-response-statuscode">20.3.4. Response Status Code</a></span></dt><dt><span class="section"><a href="#_uri_template_variables_and_expressions">20.3.5. URI Template Variables and Expressions</a></span></dt><dt><span class="section"><a href="#_outbound_2">20.3.6. Outbound</a></span></dt><dt><span class="section"><a href="#mapping-uri-variables">20.3.7. Mapping URI Variables</a></span></dt><dt><span class="section"><a href="#_controlling_uri_encoding">20.3.8. Controlling URI Encoding</a></span></dt></dl></dd><dt><span class="section"><a href="#http-java-config">20.4. Configuring HTTP Endpoints with Java</a></span></dt><dt><span class="section"><a href="#http-timeout">20.5. Timeout Handling</a></span></dt><dd><dl><dt><span class="section"><a href="#_http_inbound_gateway">20.5.1. HTTP Inbound Gateway</a></span></dt></dl></dd><dt><span class="section"><a href="#http-proxy">20.6. HTTP Proxy configuration</a></span></dt><dd><dl><dt><span class="section"><a href="#_standard_java_proxy_configuration">20.6.1. Standard Java Proxy configuration</a></span></dt><dt><span class="section"><a href="#_spring_s_literal_simpleclienthttprequestfactory_literal">20.6.2. Spring&#8217;s <code class="literal">SimpleClientHttpRequestFactory</code></a></span></dt></dl></dd><dt><span class="section"><a href="#http-header-mapping">20.7. HTTP Header Mappings</a></span></dt><dt><span class="section"><a href="#int-graph-controller">20.8. Integration Graph Controller</a></span></dt><dt><span class="section"><a href="#http-samples">20.9. HTTP Samples</a></span></dt><dd><dl><dt><span class="section"><a href="#multipart-rest-inbound">20.9.1. Multipart HTTP Request&#8201;&#8212;&#8201;RestTemplate (Client) and Http Inbound Gateway (Server)</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#jdbc">21. JDBC Support</a></span></dt><dd><dl><dt><span class="section"><a href="#jdbc-inbound-channel-adapter">21.1. Inbound Channel Adapter</a></span></dt><dd><dl><dt><span class="section"><a href="#jdbc-polling-transactions">21.1.1. Polling and Transactions</a></span></dt><dt><span class="section"><a href="#jdbc-max-rows-versus-max-messages-per-poll">21.1.2. <code class="literal">max-rows</code> Versus <code class="literal">max-messages-per-poll</code></a></span></dt></dl></dd><dt><span class="section"><a href="#jdbc-outbound-channel-adapter">21.2. Outbound Channel Adapter</a></span></dt><dd><dl><dt><span class="section"><a href="#_passing_parameters_by_using_spel_expressions">21.2.1. Passing Parameters by Using SpEL Expressions</a></span></dt><dt><span class="section"><a href="#_using_the_literal_preparedstatement_literal_callback">21.2.2. Using the <code class="literal">PreparedStatement</code> Callback</a></span></dt><dt><span class="section"><a href="#_batch_update">21.2.3. Batch Update</a></span></dt></dl></dd><dt><span class="section"><a href="#jdbc-outbound-gateway">21.3. Outbound Gateway</a></span></dt><dt><span class="section"><a href="#jdbc-message-store">21.4. JDBC Message Store</a></span></dt><dd><dl><dt><span class="section"><a href="#_initializing_the_database">21.4.1. Initializing the Database</a></span></dt><dt><span class="section"><a href="#jdbc-message-store-generic">21.4.2. The Generic JDBC Message Store</a></span></dt><dt><span class="section"><a href="#jdbc-message-store-channels">21.4.3. Backing Message Channels</a></span></dt><dd><dl><dt><span class="section"><a href="#_supported_databases">Supported Databases</a></span></dt><dt><span class="section"><a href="#_custom_message_insertion">Custom Message Insertion</a></span></dt><dt><span class="section"><a href="#_concurrent_polling">Concurrent Polling</a></span></dt><dt><span class="section"><a href="#_priority_channel">Priority Channel</a></span></dt></dl></dd><dt><span class="section"><a href="#_partitioning_a_message_store">21.4.4. Partitioning a Message Store</a></span></dt></dl></dd><dt><span class="section"><a href="#stored-procedures">21.5. Stored Procedures</a></span></dt><dd><dl><dt><span class="section"><a href="#sp-supported-databases">21.5.1. Supported Databases</a></span></dt><dt><span class="section"><a href="#sp-configuration">21.5.2. Configuration</a></span></dt><dt><span class="section"><a href="#sp-common-config-params">21.5.3. Common Configuration Attributes</a></span></dt><dt><span class="section"><a href="#sp-common-config-subelements">21.5.4. Common Configuration Sub-Elements</a></span></dt><dt><span class="section"><a href="#sp-defining-parameter-sources">21.5.5. Defining Parameter Sources</a></span></dt><dt><span class="section"><a href="#stored-procedure-inbound-channel-adapter">21.5.6. Stored Procedure Inbound Channel Adapter</a></span></dt><dt><span class="section"><a href="#stored-procedure-outbound-channel-adapter">21.5.7. Stored Procedure Outbound Channel Adapter</a></span></dt><dt><span class="section"><a href="#stored-procedure-outbound-gateway">21.5.8. Stored Procedure Outbound Gateway</a></span></dt><dt><span class="section"><a href="#sp-examples">21.5.9. Examples</a></span></dt></dl></dd><dt><span class="section"><a href="#jdbc-lock-registry">21.6. JDBC Lock Registry</a></span></dt><dt><span class="section"><a href="#jdbc-metadata-store">21.7. JDBC Metadata Store</a></span></dt></dl></dd><dt><span class="chapter"><a href="#jpa">22. JPA Support</a></span></dt><dd><dl><dt><span class="section"><a href="#_functionality">22.1. Functionality</a></span></dt><dt><span class="section"><a href="#jpa-supported-persistence-providers">22.2. Supported Persistence Providers</a></span></dt><dt><span class="section"><a href="#jpa-java-implementation">22.3. Java Implementation</a></span></dt><dt><span class="section"><a href="#jpa-namespace-support">22.4. Namespace Support</a></span></dt><dd><dl><dt><span class="section"><a href="#jpa-namespace-support-common-attributes">22.4.1. Common XML Namespace Configuration Attributes</a></span></dt><dt><span class="section"><a href="#jpa-parameters">22.4.2. Providing JPA Query Parameters</a></span></dt><dt><span class="section"><a href="#jpa-transactions">22.4.3. Transaction Handling</a></span></dt></dl></dd><dt><span class="section"><a href="#jpa-inbound-channel-adapter">22.5. Inbound Channel Adapter</a></span></dt><dd><dl><dt><span class="section"><a href="#jpaInboundChannelAdapterParameters">22.5.1. Configuration Parameter Reference</a></span></dt><dt><span class="section"><a href="#_configuring_with_java_configuration_13">22.5.2. Configuring with Java Configuration</a></span></dt><dt><span class="section"><a href="#_configuring_with_the_java_dsl_14">22.5.3. Configuring with the Java DSL</a></span></dt></dl></dd><dt><span class="section"><a href="#jpa-outbound-channel-adapter">22.6. Outbound Channel Adapter</a></span></dt><dd><dl><dt><span class="section"><a href="#jpa-outbound-channel-adapter-entity-class">22.6.1. Using an Entity Class</a></span></dt><dt><span class="section"><a href="#jpa-using-jpaql">22.6.2. Using JPA Query Language (JPA QL)</a></span></dt><dt><span class="section"><a href="#jpa-using-native-queries">22.6.3. Using Native Queries</a></span></dt><dt><span class="section"><a href="#_using_named_queries">22.6.4. Using Named Queries</a></span></dt><dt><span class="section"><a href="#jpaOutboundChannelAdapterParameters">22.6.5. Configuration Parameter Reference</a></span></dt><dt><span class="section"><a href="#_configuring_with_java_configuration_14">22.6.6. Configuring with Java Configuration</a></span></dt><dt><span class="section"><a href="#_configuring_with_the_java_dsl_15">22.6.7. Configuring with the Java DSL</a></span></dt></dl></dd><dt><span class="section"><a href="#jpa-outbound-gateways">22.7. Outbound Gateways</a></span></dt><dd><dl><dt><span class="section"><a href="#jpa-outbound-gateway-common-parameters">22.7.1. Common Configuration Parameters</a></span></dt><dt><span class="section"><a href="#jpa-updating-outbound-gateway">22.7.2. Updating Outbound Gateway</a></span></dt><dt><span class="section"><a href="#_configuring_with_java_configuration_15">22.7.3. Configuring with Java Configuration</a></span></dt><dt><span class="section"><a href="#_configuring_with_the_java_dsl_16">22.7.4. Configuring with the Java DSL</a></span></dt><dt><span class="section"><a href="#jpa-retrieving-outbound-gateway">22.7.5. Retrieving Outbound Gateway</a></span></dt><dt><span class="section"><a href="#_configuring_with_java_configuration_16">22.7.6. Configuring with Java Configuration</a></span></dt><dt><span class="section"><a href="#_configuring_with_the_java_dsl_17">22.7.7. Configuring with the Java DSL</a></span></dt><dt><span class="section"><a href="#outboundGatewaySamples">22.7.8. JPA Outbound Gateway Samples</a></span></dt><dd><dl><dt><span class="section"><a href="#_update_by_using_an_entity_class">Update by Using an Entity Class</a></span></dt><dt><span class="section"><a href="#_update_using_jpql">Update using JPQL</a></span></dt><dt><span class="section"><a href="#_retrieving_an_entity_using_jpql">Retrieving an Entity using JPQL</a></span></dt><dt><span class="section"><a href="#_retrieving_an_entity_by_using_literal_id_expression_literal">Retrieving an Entity by Using <code class="literal">id-expression</code></a></span></dt><dt><span class="section"><a href="#_update_using_a_named_query">Update using a Named Query</a></span></dt></dl></dd></dl></dd></dl></dd><dt><span class="chapter"><a href="#jms">23. JMS Support</a></span></dt><dd><dl><dt><span class="section"><a href="#jms-inbound-channel-adapter">23.1. Inbound Channel Adapter</a></span></dt><dd><dl><dt><span class="section"><a href="#jms-ib-transactions">23.1.1. Transactions</a></span></dt></dl></dd><dt><span class="section"><a href="#jms-message-driven-channel-adapter">23.2. Message-driven Channel Adapter</a></span></dt><dd><dl><dt><span class="section"><a href="#jms-md-conversion-errors">23.2.1. Inbound Conversion Errors</a></span></dt></dl></dd><dt><span class="section"><a href="#jms-outbound-channel-adapter">23.3. Outbound Channel Adapter</a></span></dt><dd><dl><dt><span class="section"><a href="#jms-ob-transactions">23.3.1. Transactions</a></span></dt></dl></dd><dt><span class="section"><a href="#jms-inbound-gateway">23.4. Inbound Gateway</a></span></dt><dt><span class="section"><a href="#jms-outbound-gateway">23.5. Outbound Gateway</a></span></dt><dd><dl><dt><span class="section"><a href="#jms-outbound-gateway-reply-listener">23.5.1. Using a <code class="literal">&lt;reply-listener/&gt;</code></a></span></dt><dt><span class="section"><a href="#_idle_reply_listeners">23.5.2. Idle Reply Listeners</a></span></dt><dt><span class="section"><a href="#_gateway_reply_correlation">23.5.3. Gateway Reply Correlation</a></span></dt><dt><span class="section"><a href="#jms-async-gateway">23.5.4. Async Gateway</a></span></dt><dt><span class="section"><a href="#jms-og-attributes">23.5.5. Attribute Reference</a></span></dt></dl></dd><dt><span class="section"><a href="#jms-header-mapping">23.6. Mapping Message Headers to and from JMS Message</a></span></dt><dt><span class="section"><a href="#jms-conversion-and-marshalling">23.7. Message Conversion, Marshalling, and Unmarshalling</a></span></dt><dt><span class="section"><a href="#jms-channel">23.8. JMS-backed Message Channels</a></span></dt><dt><span class="section"><a href="#jms-selectors">23.9. Using JMS Message Selectors</a></span></dt><dt><span class="section"><a href="#jms-samples">23.10. JMS Samples</a></span></dt></dl></dd><dt><span class="chapter"><a href="#mail">24. Mail Support</a></span></dt><dd><dl><dt><span class="section"><a href="#mail-outbound">24.1. Mail-sending Channel Adapter</a></span></dt><dt><span class="section"><a href="#mail-inbound">24.2. Mail-receiving Channel Adapter</a></span></dt><dt><span class="section"><a href="#mail-mapping">24.3. Inbound Mail Message Mapping</a></span></dt><dt><span class="section"><a href="#mail-namespace">24.4. Mail Namespace Support</a></span></dt><dd><dl><dt><span class="section"><a href="#_imap_literal_idle_literal_and_lost_connections">24.4.1. IMAP <code class="literal">idle</code> and Lost Connections</a></span></dt></dl></dd><dt><span class="section"><a href="#imap-seen">24.5. Marking IMAP Messages When <code class="literal">\Recent</code> Is Not Supported</a></span></dt><dt><span class="section"><a href="#mail-filtering">24.6. Email Message Filtering</a></span></dt><dt><span class="section"><a href="#mail-tx-sync">24.7. Transaction Synchronization</a></span></dt></dl></dd><dt><span class="chapter"><a href="#mongodb">25. MongoDb Support</a></span></dt><dd><dl><dt><span class="section"><a href="#mongodb-connection">25.1. Connecting to MongoDb</a></span></dt><dd><dl><dt><span class="section"><a href="#_using_literal_mongodbfactory_literal">25.1.1. Using <code class="literal">MongoDbFactory</code></a></span></dt></dl></dd><dt><span class="section"><a href="#mongodb-message-store">25.2. MongoDB Message Store</a></span></dt><dd><dl><dt><span class="section"><a href="#mongodb-priority-channel-message-store">25.2.1. MongoDB Channel Message Store</a></span></dt><dt><span class="section"><a href="#mongodb-metadata-store">25.2.2. MongoDB Metadata Store</a></span></dt></dl></dd><dt><span class="section"><a href="#mongodb-inbound-channel-adapter">25.3. MongoDB Inbound Channel Adapter</a></span></dt><dt><span class="section"><a href="#mongodb-outbound-channel-adapter">25.4. MongoDB Outbound Channel Adapter</a></span></dt><dt><span class="section"><a href="#mongodb-outbound-gateway">25.5. MongoDB Outbound Gateway</a></span></dt><dd><dl><dt><span class="section"><a href="#_configuring_with_java_configuration_17">25.5.1. Configuring with Java Configuration</a></span></dt><dt><span class="section"><a href="#_configuring_with_the_java_dsl_18">25.5.2. Configuring with the Java DSL</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#mqtt">26. MQTT Support</a></span></dt><dd><dl><dt><span class="section"><a href="#mqtt-inbound">26.1. Inbound (Message-driven) Channel Adapter</a></span></dt><dd><dl><dt><span class="section"><a href="#_adding_and_removing_topics_at_runtime">26.1.1. Adding and Removing Topics at Runtime</a></span></dt><dt><span class="section"><a href="#_configuring_with_java_configuration_18">26.1.2. Configuring with Java Configuration</a></span></dt><dt><span class="section"><a href="#_configuring_with_the_java_dsl_19">26.1.3. Configuring with the Java DSL</a></span></dt></dl></dd><dt><span class="section"><a href="#mqtt-outbound">26.2. Outbound Channel Adapter</a></span></dt><dd><dl><dt><span class="section"><a href="#_configuring_with_java_configuration_19">26.2.1. Configuring with Java Configuration</a></span></dt><dt><span class="section"><a href="#_configuring_with_the_java_dsl_20">26.2.2. Configuring with the Java DSL</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#redis">27. Redis Support</a></span></dt><dd><dl><dt><span class="section"><a href="#redis-connection">27.1. Connecting to Redis</a></span></dt><dd><dl><dt><span class="section"><a href="#_using_literal_redisconnectionfactory_literal">27.1.1. Using <code class="literal">RedisConnectionFactory</code></a></span></dt><dt><span class="section"><a href="#_using_literal_redistemplate_literal">27.1.2. Using <code class="literal">RedisTemplate</code></a></span></dt></dl></dd><dt><span class="section"><a href="#redis-messages">27.2. Messaging with Redis</a></span></dt><dd><dl><dt><span class="section"><a href="#redis-pub-sub-channel">27.2.1. Redis Publish/Subscribe channel</a></span></dt><dt><span class="section"><a href="#redis-inbound-channel-adapter">27.2.2. Redis Inbound Channel Adapter</a></span></dt><dt><span class="section"><a href="#redis-outbound-channel-adapter">27.2.3. Redis Outbound Channel Adapter</a></span></dt><dt><span class="section"><a href="#redis-queue-inbound-channel-adapter">27.2.4. Redis Queue Inbound Channel Adapter</a></span></dt><dt><span class="section"><a href="#redis-queue-outbound-channel-adapter">27.2.5. Redis Queue Outbound Channel Adapter</a></span></dt><dt><span class="section"><a href="#redis-application-events">27.2.6. Redis Application Events</a></span></dt></dl></dd><dt><span class="section"><a href="#redis-message-store">27.3. Redis Message Store</a></span></dt><dd><dl><dt><span class="section"><a href="#redis-cms">27.3.1. Redis Channel Message Stores</a></span></dt></dl></dd><dt><span class="section"><a href="#redis-metadata-store">27.4. Redis Metadata Store</a></span></dt><dt><span class="section"><a href="#redis-store-inbound-channel-adapter">27.5. Redis Store Inbound Channel Adapter</a></span></dt><dt><span class="section"><a href="#redis-store-outbound-channel-adapter">27.6. RedisStore Outbound Channel Adapter</a></span></dt><dt><span class="section"><a href="#redis-outbound-gateway">27.7. Redis Outbound Command Gateway</a></span></dt><dt><span class="section"><a href="#redis-queue-outbound-gateway">27.8. Redis Queue Outbound Gateway</a></span></dt><dt><span class="section"><a href="#redis-queue-inbound-gateway">27.9. Redis Queue Inbound Gateway</a></span></dt><dt><span class="section"><a href="#redis-lock-registry">27.10. Redis Lock Registry</a></span></dt></dl></dd><dt><span class="chapter"><a href="#resource">28. Resource Support</a></span></dt><dd><dl><dt><span class="section"><a href="#resource-inbound-channel-adapter">28.1. Resource Inbound Channel Adapter</a></span></dt></dl></dd><dt><span class="chapter"><a href="#rmi">29. RMI Support</a></span></dt><dd><dl><dt><span class="section"><a href="#rmi-outbound">29.1. Outbound RMI</a></span></dt><dt><span class="section"><a href="#rmi-inbound">29.2. Inbound RMI</a></span></dt><dt><span class="section"><a href="#rmi-namespace">29.3. RMI namespace support</a></span></dt><dt><span class="section"><a href="#_configuring_with_java_configuration_20">29.4. Configuring with Java Configuration</a></span></dt></dl></dd><dt><span class="chapter"><a href="#sftp">30. SFTP Adapters</a></span></dt><dd><dl><dt><span class="section"><a href="#sftp-session-factory">30.1. SFTP Session Factory</a></span></dt><dd><dl><dt><span class="section"><a href="#sftp-session-factory-properties">30.1.1. Configuration Properties</a></span></dt></dl></dd><dt><span class="section"><a href="#sftp-proxy-factory-bean">30.2. Proxy Factory Bean</a></span></dt><dt><span class="section"><a href="#sftp-dsf">30.3. Delegating Session Factory</a></span></dt><dt><span class="section"><a href="#sftp-session-caching">30.4. SFTP Session Caching</a></span></dt><dt><span class="section"><a href="#sftp-rft">30.5. Using <code class="literal">RemoteFileTemplate</code></a></span></dt><dt><span class="section"><a href="#sftp-inbound">30.6. SFTP Inbound Channel Adapter</a></span></dt><dd><dl><dt><span class="section"><a href="#_more_on_file_filtering_and_large_files">30.6.1. More on File Filtering and Large Files</a></span></dt><dt><span class="section"><a href="#_recovering_from_failures_2">30.6.2. Recovering from Failures</a></span></dt><dt><span class="section"><a href="#_configuring_with_java_configuration_21">30.6.3. Configuring with Java Configuration</a></span></dt><dt><span class="section"><a href="#_configuring_with_the_java_dsl_21">30.6.4. Configuring with the Java DSL</a></span></dt><dt><span class="section"><a href="#sftp-incomplete">30.6.5. Dealing With Incomplete Data</a></span></dt></dl></dd><dt><span class="section"><a href="#sftp-streaming">30.7. SFTP Streaming Inbound Channel Adapter</a></span></dt><dd><dl><dt><span class="section"><a href="#sftp-streaming-java-config">30.7.1. Configuring with Java Configuration</a></span></dt></dl></dd><dt><span class="section"><a href="#sftp-rotating-server-advice">30.8. Inbound Channel Adapters: Polling Multiple Servers and Directories</a></span></dt><dt><span class="section"><a href="#sftp-max-fetch">30.9. Inbound Channel Adapters: Controlling Remote File Fetching</a></span></dt><dt><span class="section"><a href="#sftp-outbound">30.10. SFTP Outbound Channel Adapter</a></span></dt><dd><dl><dt><span class="section"><a href="#_spel_and_the_sftp_outbound_adapter">30.10.1. SpEL and the SFTP Outbound Adapter</a></span></dt><dt><span class="section"><a href="#_avoiding_partially_written_files_2">30.10.2. Avoiding Partially Written Files</a></span></dt><dt><span class="section"><a href="#_configuring_with_java_configuration_22">30.10.3. Configuring with Java Configuration</a></span></dt><dt><span class="section"><a href="#_configuring_with_the_java_dsl_22">30.10.4. Configuring with the Java DSL</a></span></dt></dl></dd><dt><span class="section"><a href="#sftp-outbound-gateway">30.11. SFTP Outbound Gateway</a></span></dt><dd><dl><dt><span class="section"><a href="#_using_the_literal_ls_literal_command">30.11.1. Using the <code class="literal">ls</code> Command</a></span></dt><dt><span class="section"><a href="#_using_the_literal_get_literal_command_2">30.11.2. Using the <code class="literal">get</code> Command</a></span></dt><dt><span class="section"><a href="#_using_the_literal_mget_literal_command_2">30.11.3. Using the <code class="literal">mget</code> Command</a></span></dt><dt><span class="section"><a href="#sftp-put-command">30.11.4. Using the <code class="literal">put</code> Command</a></span></dt><dt><span class="section"><a href="#_using_the_literal_mput_literal_command">30.11.5. Using the <code class="literal">mput</code> Command</a></span></dt><dt><span class="section"><a href="#_using_the_literal_mv_literal_command_2">30.11.6. Using the <code class="literal">mv</code> Command</a></span></dt><dt><span class="section"><a href="#_additional_command_information">30.11.7. Additional Command Information</a></span></dt><dt><span class="section"><a href="#_configuring_with_java_configuration_23">30.11.8. Configuring with Java Configuration</a></span></dt><dt><span class="section"><a href="#_configuring_with_the_java_dsl_23">30.11.9. Configuring with the Java DSL</a></span></dt><dt><span class="section"><a href="#sftp-partial">30.11.10. Outbound Gateway Partial Success (<code class="literal">mget</code> and <code class="literal">mput</code>)</a></span></dt></dl></dd><dt><span class="section"><a href="#sftp-jsch-logging">30.12. SFTP/JSCH Logging</a></span></dt><dt><span class="section"><a href="#sftp-session-callback">30.13. MessageSessionCallback</a></span></dt></dl></dd><dt><span class="chapter"><a href="#stomp">31. STOMP Support</a></span></dt><dd><dl><dt><span class="section"><a href="#stomp-overview">31.1. Overview</a></span></dt><dt><span class="section"><a href="#stomp-inbound-adapter">31.2. STOMP Inbound Channel Adapter</a></span></dt><dt><span class="section"><a href="#stomp-outbound-adapter">31.3. STOMP Outbound Channel Adapter</a></span></dt><dt><span class="section"><a href="#stomp-headers">31.4. STOMP Headers Mapping</a></span></dt><dt><span class="section"><a href="#stomp-events">31.5. STOMP Integration Events</a></span></dt><dt><span class="section"><a href="#stomp-java-config">31.6. STOMP Adapters Java Configuration</a></span></dt><dt><span class="section"><a href="#stomp-namespace">31.7. STOMP Namespace Support</a></span></dt><dd><dl><dt><span class="section"><a href="#stomp-outbound-channel-adapter">31.7.1. Understanding the <code class="literal">&lt;int-stomp:outbound-channel-adapter&gt;</code> Element</a></span></dt><dt><span class="section"><a href="#_understanding_the_literal_int_stomp_inbound_channel_adapter_literal_element">31.7.2. Understanding the <code class="literal">&lt;int-stomp:inbound-channel-adapter&gt;</code> Element</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#stream">32. Stream Support</a></span></dt><dd><dl><dt><span class="section"><a href="#stream-reading">32.1. Reading from Streams</a></span></dt><dt><span class="section"><a href="#stream-writing">32.2. Writing to Streams</a></span></dt><dt><span class="section"><a href="#stream-namespace">32.3. Stream Namespace Support</a></span></dt></dl></dd><dt><span class="chapter"><a href="#syslog">33. Syslog Support</a></span></dt><dd><dl><dt><span class="section"><a href="#syslog-inbound-adapter">33.1. Syslog Inbound Channel Adapter</a></span></dt><dd><dl><dt><span class="section"><a href="#syslog-inbound-examplers">33.1.1. Example Configuration</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#ip">34. TCP and UDP Support</a></span></dt><dd><dl><dt><span class="section"><a href="#ip-intro">34.1. Introduction</a></span></dt><dt><span class="section"><a href="#udp-adapters">34.2. UDP Adapters</a></span></dt><dd><dl><dt><span class="section"><a href="#_outbound_udp_adapters_xml_configuration">34.2.1. Outbound UDP Adapters (XML Configuration)</a></span></dt><dt><span class="section"><a href="#_outbound_udp_adapters_java_configuration">34.2.2. Outbound UDP Adapters (Java Configuration)</a></span></dt><dt><span class="section"><a href="#_outbound_udp_adapters_java_dsl_configuration">34.2.3. Outbound UDP Adapters (Java DSL Configuration)</a></span></dt><dt><span class="section"><a href="#_inbound_udp_adapters_xml_configuration">34.2.4. Inbound UDP Adapters (XML Configuration)</a></span></dt><dt><span class="section"><a href="#_inbound_udp_adapters_java_configuration">34.2.5. Inbound UDP Adapters (Java Configuration)</a></span></dt><dt><span class="section"><a href="#_inbound_udp_adapters_java_dsl_configuration">34.2.6. Inbound UDP Adapters (Java DSL Configuration)</a></span></dt><dt><span class="section"><a href="#_server_listening_events">34.2.7. Server Listening Events</a></span></dt><dt><span class="section"><a href="#_advanced_outbound_configuration">34.2.8. Advanced Outbound Configuration</a></span></dt></dl></dd><dt><span class="section"><a href="#tcp-connection-factories">34.3. TCP Connection Factories</a></span></dt><dd><dl><dt><span class="section"><a href="#caching-cf">34.3.1. TCP Caching Client Connection Factory</a></span></dt><dt><span class="section"><a href="#failover-cf">34.3.2. TCP Failover Client Connection Factory</a></span></dt><dt><span class="section"><a href="#tcp-affinity-cf">34.3.3. TCP Thread Affinity Connection Factory</a></span></dt></dl></dd><dt><span class="section"><a href="#ip-interceptors">34.4. TCP Connection Interceptors</a></span></dt><dt><span class="section"><a href="#tcp-events">34.5. TCP Connection Events</a></span></dt><dt><span class="section"><a href="#tcp-adapters">34.6. TCP Adapters</a></span></dt><dt><span class="section"><a href="#tcp-gateways">34.7. TCP Gateways</a></span></dt><dt><span class="section"><a href="#ip-correlation">34.8. TCP Message Correlation</a></span></dt><dd><dl><dt><span class="section"><a href="#ip-gateways">34.8.1. Gateways</a></span></dt><dt><span class="section"><a href="#ip-collaborating-adapters">34.8.2. Collaborating Outbound and Inbound Channel Adapters</a></span></dt><dt><span class="section"><a href="#ip-headers">34.8.3. Transferring Headers</a></span></dt></dl></dd><dt><span class="section"><a href="#note_nio">34.9. About Non-blocking I/O (NIO)</a></span></dt><dd><dl><dt><span class="section"><a href="#_pool_size">34.9.1. Pool Size</a></span></dt><dt><span class="section"><a href="#io-thread-pool-task-executor-caller-runs">34.9.2. Thread Pool Task Executor with <code class="literal">CALLER_RUNS</code> Policy</a></span></dt></dl></dd><dt><span class="section"><a href="#ssl-tls">34.10. SSL/TLS Support</a></span></dt><dd><dl><dt><span class="section"><a href="#ip-ssl-tls-getting-started">34.10.1. Getting Started</a></span></dt><dt><span class="section"><a href="#tcp-ssl-host-verification">34.10.2. Host Verification</a></span></dt></dl></dd><dt><span class="section"><a href="#tcp-advanced-techniques">34.11. Advanced Techniques</a></span></dt><dd><dl><dt><span class="section"><a href="#_strategy_interfaces">34.11.1. Strategy Interfaces</a></span></dt><dd><dl><dt><span class="section"><a href="#_the_literal_tcpsslcontextsupport_literal_strategy_interface">The <code class="literal">TcpSSLContextSupport</code> Strategy Interface</a></span></dt><dt><span class="section"><a href="#_the_literal_tcpsocketfactorysupport_literal_strategy_interface">The <code class="literal">TcpSocketFactorySupport</code> Strategy Interface</a></span></dt><dt><span class="section"><a href="#_the_literal_tcpsocketsupport_literal_strategy_interface">The <code class="literal">TcpSocketSupport</code> Strategy Interface</a></span></dt><dt><span class="section"><a href="#_the_literal_tcpnetconnectionsupport_literal_strategy_interface">The <code class="literal">TcpNetConnectionSupport</code> Strategy Interface</a></span></dt><dt><span class="section"><a href="#_the_literal_tcpnioconnectionsupport_literal_strategy_interface">The <code class="literal">TcpNioConnectionSupport</code> Strategy Interface</a></span></dt></dl></dd><dt><span class="section"><a href="#ssl-client-authentication-example">34.11.2. Example: Enabling SSL Client Authentication</a></span></dt></dl></dd><dt><span class="section"><a href="#ip-endpoint-reference">34.12. IP Configuration Attributes</a></span></dt><dt><span class="section"><a href="#ip-msg-headers">34.13. IP Message Headers</a></span></dt><dt><span class="section"><a href="#ip-annotation">34.14. Annotation-Based Configuration</a></span></dt></dl></dd><dt><span class="chapter"><a href="#webflux">35. WebFlux Support</a></span></dt><dd><dl><dt><span class="section"><a href="#webflux-inbound">35.1. WebFlux Inbound Components</a></span></dt><dt><span class="section"><a href="#webflux-outbound">35.2. WebFlux Outbound Components</a></span></dt><dt><span class="section"><a href="#webflux-namespace">35.3. WebFlux Namespace Support</a></span></dt><dd><dl><dt><span class="section"><a href="#_inbound_3">35.3.1. Inbound</a></span></dt><dt><span class="section"><a href="#_outbound_3">35.3.2. Outbound</a></span></dt></dl></dd><dt><span class="section"><a href="#webflux-java-config">35.4. Configuring WebFlux Endpoints with Java</a></span></dt><dt><span class="section"><a href="#webflux-header-mapping">35.5. WebFlux Header Mappings</a></span></dt></dl></dd><dt><span class="chapter"><a href="#web-sockets">36. WebSockets Support</a></span></dt><dd><dl><dt><span class="section"><a href="#web-socket-overview">36.1. Overview</a></span></dt><dt><span class="section"><a href="#web-socket-inbound-adapter">36.2. WebSocket Inbound Channel Adapter</a></span></dt><dt><span class="section"><a href="#web-socket-outbound-adapter">36.3. WebSocket Outbound Channel Adapter</a></span></dt><dt><span class="section"><a href="#web-sockets-namespace">36.4. WebSockets Namespace Support</a></span></dt><dd><dl><dt><span class="section"><a href="#websocket-client-container-attributes">36.4.1. <code class="literal">&lt;int-websocket:client-container&gt;</code> Attributes</a></span></dt><dt><span class="section"><a href="#_literal_int_websocket_server_container_literal_attributes">36.4.2. <code class="literal">&lt;int-websocket:server-container&gt;</code> Attributes</a></span></dt><dt><span class="section"><a href="#websocket-outbound-channel-adapter-attributes">36.4.3. <code class="literal">&lt;int-websocket:outbound-channel-adapter&gt;</code> Attributes</a></span></dt><dt><span class="section"><a href="#_literal_int_websocket_inbound_channel_adapter_literal_attributes">36.4.4. <code class="literal">&lt;int-websocket:inbound-channel-adapter&gt;</code> Attributes</a></span></dt></dl></dd><dt><span class="section"><a href="#client-stomp-encoder">36.5. Using <code class="literal">ClientStompEncoder</code></a></span></dt></dl></dd><dt><span class="chapter"><a href="#ws">37. Web Services Support</a></span></dt><dd><dl><dt><span class="section"><a href="#webservices-outbound">37.1. Outbound Web Service Gateways</a></span></dt><dt><span class="section"><a href="#webservices-inbound">37.2. Inbound Web Service Gateways</a></span></dt><dt><span class="section"><a href="#webservices-namespace">37.3. Web Service Namespace Support</a></span></dt><dt><span class="section"><a href="#outbound-uri">37.4. Outbound URI Configuration</a></span></dt><dd><dl><dt><span class="section"><a href="#_controlling_uri_encoding_2">37.4.1. Controlling URI Encoding</a></span></dt></dl></dd><dt><span class="section"><a href="#ws-message-headers">37.5. WS Message Headers</a></span></dt><dt><span class="section"><a href="#mtom-support">37.6. MTOM Support</a></span></dt></dl></dd><dt><span class="chapter"><a href="#xml">38. XML Support - Dealing with XML Payloads</a></span></dt><dd><dl><dt><span class="section"><a href="#xpath-namespace-support">38.1. Namespace Support</a></span></dt><dd><dl><dt><span class="section"><a href="#xml-xpath-expressions">38.1.1. XPath Expressions</a></span></dt><dd><dl><dt><span class="section"><a href="#_providing_namespaces_optional_to_xpath_expressions">Providing Namespaces (Optional) to XPath Expressions</a></span></dt><dt><span class="section"><a href="#_using_xpath_expressions_with_default_namespaces">Using XPath Expressions with Default Namespaces</a></span></dt></dl></dd></dl></dd><dt><span class="section"><a href="#xml-transformation">38.2. Transforming XML Payloads</a></span></dt><dd><dl><dt><span class="section"><a href="#xml-transformation-beans">38.2.1. Configuring Transformers as Beans</a></span></dt><dd><dl><dt><span class="section"><a href="#xml-unmarshalling-transformer">UnmarshallingTransformer</a></span></dt><dt><span class="section"><a href="#xml-marshalling-transformer">Using <code class="literal">MarshallingTransformer</code></a></span></dt><dt><span class="section"><a href="#xml-xslt-payload-transformers">XsltPayloadTransformer</a></span></dt><dt><span class="section"><a href="#xml-using-result-transformers">Using <code class="literal">ResultTransformer</code> Implementations</a></span></dt></dl></dd><dt><span class="section"><a href="#xml-transformer-namespace">38.2.2. Namespace Support for XML Transformers</a></span></dt><dd><dl><dt><span class="section"><a href="#_using_an_literal_unmarshallingtransformer_literal">Using an <code class="literal">UnmarshallingTransformer</code></a></span></dt><dt><span class="section"><a href="#_using_a_literal_marshallingtransformer_literal">Using a <code class="literal">MarshallingTransformer</code></a></span></dt><dt><span class="section"><a href="#_using_an_literal_xsltpayloadtransformer_literal">Using an <code class="literal">XsltPayloadTransformer</code></a></span></dt></dl></dd><dt><span class="section"><a href="#xml-using-result-transformers-namespace">38.2.3. Namespace Configuration and Result Transformers</a></span></dt><dd><dl><dt><span class="section"><a href="#_literal_xsltpayloadtransformer_literal_and_literal_xsl_output_method_text_literal"><code class="literal">XsltPayloadTransformer</code> and <code class="literal">&lt;xsl:output method="text"/&gt;</code></a></span></dt></dl></dd></dl></dd><dt><span class="section"><a href="#xml-xpath-transformer">38.3. Transforming XML Messages with XPath</a></span></dt><dd><dl><dt><span class="section"><a href="#_simple_xpath_transformation">38.3.1. Simple XPath Transformation</a></span></dt><dt><span class="section"><a href="#_node_mappers">38.3.2. Node Mappers</a></span></dt><dt><span class="section"><a href="#_xml_payload_converter">38.3.3. XML Payload Converter</a></span></dt></dl></dd><dt><span class="section"><a href="#xml-xpath-splitting">38.4. Splitting XML Messages</a></span></dt><dt><span class="section"><a href="#xml-xpath-routing">38.5. Routing XML Messages with XPath</a></span></dt><dd><dl><dt><span class="section"><a href="#xpath-routing-converter">38.5.1. XML Payload Converter</a></span></dt></dl></dd><dt><span class="section"><a href="#xml-xpath-header-enricher">38.6. XPath Header Enricher</a></span></dt><dt><span class="section"><a href="#xml-xpath-filter">38.7. Using the XPath Filter</a></span></dt><dt><span class="section"><a href="#xpath-spel-function">38.8. #xpath SpEL Function</a></span></dt><dt><span class="section"><a href="#xml-validating-filter">38.9. XML Validating Filter</a></span></dt></dl></dd><dt><span class="chapter"><a href="#xmpp">39. XMPP Support</a></span></dt><dd><dl><dt><span class="section"><a href="#xmpp-connection">39.1. XMPP Connection</a></span></dt><dt><span class="section"><a href="#xmpp-messages">39.2. XMPP Messages</a></span></dt><dd><dl><dt><span class="section"><a href="#xmpp-message-inbound-channel-adapter">39.2.1. Inbound Message Channel Adapter</a></span></dt><dt><span class="section"><a href="#xmpp-message-outbound-channel-adapter">39.2.2. Outbound Message Channel Adapter</a></span></dt></dl></dd><dt><span class="section"><a href="#xmpp-presence">39.3. XMPP Presence</a></span></dt><dd><dl><dt><span class="section"><a href="#xmpp-roster-inbound-channel-adapter">39.3.1. Inbound Presence Message Channel Adapter</a></span></dt><dt><span class="section"><a href="#xmpp-roster-outbound-channel-adapter">39.3.2. Outbound Presence Message Channel Adapter</a></span></dt></dl></dd><dt><span class="section"><a href="#xmpp-advanced">39.4. Advanced Configuration</a></span></dt><dt><span class="section"><a href="#xmpp-message-headers">39.5. XMPP Message Headers</a></span></dt><dt><span class="section"><a href="#xmpp-extensions">39.6. XMPP Extensions</a></span></dt></dl></dd><dt><span class="chapter"><a href="#zookeeper">40. Zookeeper Support</a></span></dt><dd><dl><dt><span class="section"><a href="#zk-metadata-store">40.1. Zookeeper Metadata Store</a></span></dt><dt><span class="section"><a href="#zk-lock-registry">40.2. Zookeeper Lock Registry</a></span></dt><dt><span class="section"><a href="#zk-leadership">40.3. Zookeeper Leadership Event Handling</a></span></dt></dl></dd></dl></dd><dt><span class="part"><a href="#spring-integration-appendices">VI. Appendices</a></span></dt><dd><dl><dt><span class="appendix"><a href="#spel">A. Spring Expression Language (SpEL)</a></span></dt><dd><dl><dt><span class="section"><a href="#spel-customization">A.1. SpEL Evaluation Context Customization</a></span></dt><dt><span class="section"><a href="#spel-functions">A.2. SpEL Functions</a></span></dt><dd><dl><dt><span class="section"><a href="#_built_in_spel_functions">A.2.1. Built-in SpEL Functions</a></span></dt></dl></dd><dt><span class="section"><a href="#spel-property-accessors">A.3. Property Accessors</a></span></dt></dl></dd><dt><span class="appendix"><a href="#message-publishing">B. Message Publishing</a></span></dt><dd><dl><dt><span class="section"><a href="#message-publishing-config">B.1. Message Publishing Configuration</a></span></dt><dd><dl><dt><span class="section"><a href="#publisher-annotation">B.1.1. Annotation-driven Configuration with the <code class="literal">@Publisher</code> Annotation</a></span></dt><dt><span class="section"><a href="#aop-based-interceptor">B.1.2. XML-based Approach with the <code class="literal">&lt;publishing-interceptor&gt;</code> element</a></span></dt><dd><dl><dt><span class="section"><a href="#_asynchronous_publishing">Asynchronous Publishing</a></span></dt></dl></dd><dt><span class="section"><a href="#scheduled-producer">B.1.3. Producing and Publishing Messages Based on a Scheduled Trigger</a></span></dt></dl></dd></dl></dd><dt><span class="appendix"><a href="#transactions">C. Transaction Support</a></span></dt><dd><dl><dt><span class="section"><a href="#understanding-transaction">C.1. Understanding Transactions in Message flows</a></span></dt><dd><dl><dt><span class="section"><a href="#transaction-poller">C.1.1. Poller Transaction Support</a></span></dt></dl></dd><dt><span class="section"><a href="#transaction-boundaries">C.2. Transaction Boundaries</a></span></dt><dt><span class="section"><a href="#transaction-synchronization">C.3. Transaction Synchronization</a></span></dt><dt><span class="section"><a href="#pseudo-transactions">C.4. Pseudo Transactions</a></span></dt></dl></dd><dt><span class="appendix"><a href="#security">D. Security in Spring Integration</a></span></dt><dd><dl><dt><span class="section"><a href="#securing-channels">D.1. Securing channels</a></span></dt><dt><span class="section"><a href="#security-context-propagation">D.2. Security Context Propagation</a></span></dt></dl></dd><dt><span class="appendix"><a href="#configuration">E. Configuration</a></span></dt><dd><dl><dt><span class="section"><a href="#configuration-namespace">E.1. Namespace Support</a></span></dt><dt><span class="section"><a href="#namespace-taskscheduler">E.2. Configuring the Task Scheduler</a></span></dt><dt><span class="section"><a href="#namespace-errorhandler">E.3. Error Handling</a></span></dt><dt><span class="section"><a href="#global-properties">E.4. Global Properties</a></span></dt><dt><span class="section"><a href="#annotations">E.5. Annotation Support</a></span></dt><dd><dl><dt><span class="section"><a href="#configuration-using-poller-annotation">E.5.1. Using the <code class="literal">@Poller</code> Annotation</a></span></dt><dt><span class="section"><a href="#_using_the_literal_inboundchanneladapter_literal_annotation">E.5.2. Using the <code class="literal">@InboundChannelAdapter</code> Annotation</a></span></dt><dt><span class="section"><a href="#_using_the_literal_integrationcomponentscan_literal_annotation">E.5.3. Using the <code class="literal">@IntegrationComponentScan</code> Annotation</a></span></dt></dl></dd><dt><span class="section"><a href="#meta-annotations">E.6. Messaging Meta-Annotations</a></span></dt><dd><dl><dt><span class="section"><a href="#annotations_on_beans">E.6.1. Annotations on <code class="literal">@Bean</code> Methods</a></span></dt><dt><span class="section"><a href="#_creating_a_bridge_with_annotations">E.6.2. Creating a Bridge with Annotations</a></span></dt><dt><span class="section"><a href="#_advising_annotated_endpoints">E.6.3. Advising Annotated Endpoints</a></span></dt></dl></dd><dt><span class="section"><a href="#message-mapping-rules">E.7. Message Mapping Rules and Conventions</a></span></dt><dd><dl><dt><span class="section"><a href="#sample-scenarios">E.7.1. Sample Scenarios</a></span></dt><dt><span class="section"><a href="#_annotation_based_mapping">E.7.2. Annotation-based Mapping</a></span></dt><dt><span class="section"><a href="#complex-scenarios">E.7.3. Complex Scenarios</a></span></dt></dl></dd></dl></dd><dt><span class="appendix"><a href="#testing">F. Testing support</a></span></dt><dd><dl><dt><span class="section"><a href="#testing-utilities">F.1. Testing Utilities</a></span></dt><dd><dl><dt><span class="section"><a href="#_testutils">F.1.1. TestUtils</a></span></dt><dt><span class="section"><a href="#_using_the_literal_socketutils_literal_class">F.1.2. Using the <code class="literal">SocketUtils</code> Class</a></span></dt><dt><span class="section"><a href="#_using_literal_onlyoncetrigger_literal">F.1.3. Using <code class="literal">OnlyOnceTrigger</code></a></span></dt><dt><span class="section"><a href="#_support_components">F.1.4. Support Components</a></span></dt><dt><span class="section"><a href="#test-junit-rules">F.1.5. JUnit Rules and Conditions</a></span></dt><dt><span class="section"><a href="#_hamcrest_and_mockito_matchers">F.1.6. Hamcrest and Mockito Matchers</a></span></dt></dl></dd><dt><span class="section"><a href="#test-context">F.2. Spring Integration and the Test Context</a></span></dt><dt><span class="section"><a href="#testing-mocks">F.3. Integration Mocks</a></span></dt><dd><dl><dt><span class="section"><a href="#_mockintegration">F.3.1. MockIntegration</a></span></dt></dl></dd><dt><span class="section"><a href="#testing-other-resources">F.4. Other Resources</a></span></dt></dl></dd><dt><span class="appendix"><a href="#samples">G. Spring Integration Samples</a></span></dt><dd><dl><dt><span class="section"><a href="#samples-get">G.1. Where to Get Samples</a></span></dt><dt><span class="section"><a href="#_submitting_samples_or_sample_requests">G.2. Submitting Samples or Sample Requests</a></span></dt><dd><dl><dt><span class="section"><a href="#samples-how-can-i-contribute">G.2.1. How Can I Contribute My Own Samples?</a></span></dt><dt><span class="section"><a href="#_code_contribution_process">G.2.2. Code Contribution Process</a></span></dt><dt><span class="section"><a href="#_sample_requests">G.2.3. Sample Requests</a></span></dt></dl></dd><dt><span class="section"><a href="#samples-structure">G.3. Samples Structure</a></span></dt><dt><span class="section"><a href="#samples-impl">G.4. Samples</a></span></dt><dd><dl><dt><span class="section"><a href="#samples-loan-broker">G.4.1. Loan Broker</a></span></dt><dd><dl><dt><span class="section"><a href="#_design">Design</a></span></dt><dt><span class="section"><a href="#_composed_message_processor">Composed Message Processor</a></span></dt></dl></dd><dt><span class="section"><a href="#samples-cafe">G.4.2. The Cafe Sample</a></span></dt><dt><span class="section"><a href="#samples-xml-messaging">G.4.3. The XML Messaging Sample</a></span></dt></dl></dd></dl></dd><dt><span class="appendix"><a href="#resources">H. Additional Resources</a></span></dt><dt><span class="appendix"><a href="#history">I. Change History</a></span></dt><dd><dl><dt><span class="section"><a href="#migration-4.3-5.0">I.1. Changes between 4.3 and 5.0</a></span></dt><dt><span class="section"><a href="#x5.0-new-components">I.2. New Components</a></span></dt><dd><dl><dt><span class="section"><a href="#_java_dsl">I.2.1. Java DSL</a></span></dt><dt><span class="section"><a href="#_testing_support">I.2.2. Testing Support</a></span></dt><dt><span class="section"><a href="#_mongodb_outbound_gateway">I.2.3. MongoDB Outbound Gateway</a></span></dt><dt><span class="section"><a href="#_webflux_gateways_and_channel_adapters">I.2.4. WebFlux Gateways and Channel Adapters</a></span></dt><dt><span class="section"><a href="#_content_type_conversion">I.2.5. Content Type Conversion</a></span></dt><dt><span class="section"><a href="#_literal_errormessagepublisher_literal_and_literal_errormessagestrategy_literal">I.2.6. <code class="literal">ErrorMessagePublisher</code> and <code class="literal">ErrorMessageStrategy</code></a></span></dt><dt><span class="section"><a href="#_jdbc_metadata_store">I.2.7. JDBC Metadata Store</a></span></dt></dl></dd><dt><span class="section"><a href="#x5.0-general">I.3. General Changes</a></span></dt><dd><dl><dt><span class="section"><a href="#_core_changes">I.3.1. Core Changes</a></span></dt><dt><span class="section"><a href="#_gateway_changes">I.3.2. Gateway Changes</a></span></dt><dt><span class="section"><a href="#_aggregator_performance_changes">I.3.3. Aggregator Performance Changes</a></span></dt><dt><span class="section"><a href="#_splitter_changes">I.3.4. Splitter Changes</a></span></dt><dt><span class="section"><a href="#_jms_changes">I.3.5. JMS Changes</a></span></dt><dt><span class="section"><a href="#_mail_changes">I.3.6. Mail Changes</a></span></dt><dt><span class="section"><a href="#_feed_changes">I.3.7. Feed Changes</a></span></dt><dt><span class="section"><a href="#_file_changes">I.3.8. File Changes</a></span></dt><dt><span class="section"><a href="#_ftp_and_sftp_changes">I.3.9. FTP and SFTP Changes</a></span></dt><dt><span class="section"><a href="#_integration_properties">I.3.10. Integration Properties</a></span></dt><dt><span class="section"><a href="#_stream_changes">I.3.11. Stream Changes</a></span></dt><dt><span class="section"><a href="#_barrier_changes">I.3.12. Barrier Changes</a></span></dt><dt><span class="section"><a href="#_amqp_changes">I.3.13. AMQP Changes</a></span></dt><dt><span class="section"><a href="#_http_changes">I.3.14. HTTP Changes</a></span></dt><dt><span class="section"><a href="#_mqtt_changes">I.3.15. MQTT Changes</a></span></dt><dt><span class="section"><a href="#_stomp_changes">I.3.16. STOMP Changes</a></span></dt><dt><span class="section"><a href="#_web_services_changes">I.3.17. Web Services Changes</a></span></dt><dt><span class="section"><a href="#_redis_changes">I.3.18. Redis Changes</a></span></dt><dt><span class="section"><a href="#_tcp_changes">I.3.19. TCP Changes</a></span></dt><dt><span class="section"><a href="#_gemfire_changes">I.3.20. Gemfire Changes</a></span></dt><dt><span class="section"><a href="#_jdbc_changes">I.3.21. JDBC Changes</a></span></dt><dt><span class="section"><a href="#_metrics_changes">I.3.22. Metrics Changes</a></span></dt><dt><span class="section"><a href="#_literal_endpointid_literal_annotations">I.3.23. <code class="literal">@EndpointId</code> Annotations</a></span></dt></dl></dd><dt><span class="section"><a href="#migration-4.2-4.3">I.4. Changes between 4.2 and 4.3</a></span></dt><dt><span class="section"><a href="#x4.3-new-components">I.5. New Components</a></span></dt><dd><dl><dt><span class="section"><a href="#_amqp_async_outbound_gateway">I.5.1. AMQP Async Outbound Gateway</a></span></dt><dt><span class="section"><a href="#_literal_messagegroupfactory_literal">I.5.2. <code class="literal">MessageGroupFactory</code></a></span></dt><dt><span class="section"><a href="#_literal_persistentmessagegroup_literal">I.5.3. <code class="literal">PersistentMessageGroup</code></a></span></dt><dt><span class="section"><a href="#_ftp_and_sftp_streaming_inbound_channel_adapters">I.5.4. FTP and SFTP Streaming Inbound Channel Adapters</a></span></dt><dt><span class="section"><a href="#_literal_streamtransformer_literal">I.5.5. <code class="literal">StreamTransformer</code></a></span></dt><dt><span class="section"><a href="#_integration_graph">I.5.6. Integration Graph</a></span></dt><dt><span class="section"><a href="#_jdbc_lock_registry">I.5.7. JDBC Lock Registry</a></span></dt><dt><span class="section"><a href="#_literal_leaderinitiator_literal_for_literal_lockregistry_literal">I.5.8. <code class="literal">LeaderInitiator</code> for <code class="literal">LockRegistry</code></a></span></dt></dl></dd><dt><span class="section"><a href="#x4.3-general">I.6. General Changes</a></span></dt><dd><dl><dt><span class="section"><a href="#_core_changes_2">I.6.1. Core Changes</a></span></dt><dd><dl><dt><span class="section"><a href="#_outbound_gateway_within_a_chain">Outbound Gateway within a Chain</a></span></dt><dt><span class="section"><a href="#_asynchronous_service_activator">Asynchronous Service Activator</a></span></dt><dt><span class="section"><a href="#_messaging_annotation_support_changes">Messaging Annotation Support changes</a></span></dt></dl></dd><dt><span class="section"><a href="#_mail_changes_2">I.6.2. Mail Changes</a></span></dt><dd><dl><dt><span class="section"><a href="#_customizable_user_flag">Customizable User Flag</a></span></dt><dt><span class="section"><a href="#_mail_message_mapping">Mail Message Mapping</a></span></dt></dl></dd><dt><span class="section"><a href="#_jms_changes_2">I.6.3. JMS Changes</a></span></dt><dd><dl><dt><span class="section"><a href="#_header_mapper">Header Mapper</a></span></dt><dt><span class="section"><a href="#_asynchronous_gateway">Asynchronous Gateway</a></span></dt></dl></dd><dt><span class="section"><a href="#_aggregator_changes">I.6.4. Aggregator Changes</a></span></dt><dt><span class="section"><a href="#_tcp_udp_changes">I.6.5. TCP/UDP Changes</a></span></dt><dd><dl><dt><span class="section"><a href="#_events">Events</a></span></dt><dt><span class="section"><a href="#_stream_deserializers">Stream Deserializers</a></span></dt><dt><span class="section"><a href="#_tcp_message_mapper">TCP Message Mapper</a></span></dt></dl></dd><dt><span class="section"><a href="#_file_changes_2">I.6.6. File Changes</a></span></dt><dd><dl><dt><span class="section"><a href="#_destination_directory_creation">Destination Directory Creation</a></span></dt><dt><span class="section"><a href="#_buffer_size">Buffer Size</a></span></dt><dt><span class="section"><a href="#_appending_and_flushing">Appending and Flushing</a></span></dt><dt><span class="section"><a href="#_preserving_timestamps">Preserving Timestamps</a></span></dt><dt><span class="section"><a href="#_splitter_changes_2">Splitter Changes</a></span></dt><dt><span class="section"><a href="#_file_filters">File Filters</a></span></dt></dl></dd><dt><span class="section"><a href="#_amqp_changes_2">I.6.7. AMQP Changes</a></span></dt><dd><dl><dt><span class="section"><a href="#_content_type_message_converter">Content Type Message Converter</a></span></dt><dt><span class="section"><a href="#_headers_for_delayed_message_handling">Headers for Delayed Message Handling</a></span></dt><dt><span class="section"><a href="#_amqp_backed_channels">AMQP-Backed Channels</a></span></dt></dl></dd><dt><span class="section"><a href="#_redis_changes_2">I.6.8. Redis Changes</a></span></dt><dd><dl><dt><span class="section"><a href="#_list_push_pop_direction">List Push/Pop Direction</a></span></dt><dt><span class="section"><a href="#_queue_inbound_gateway_default_serializer">Queue Inbound Gateway Default Serializer</a></span></dt></dl></dd><dt><span class="section"><a href="#_http_changes_2">I.6.9. HTTP Changes</a></span></dt><dt><span class="section"><a href="#_sftp_changes">I.6.10. SFTP Changes</a></span></dt><dd><dl><dt><span class="section"><a href="#_factory_bean">Factory Bean</a></span></dt><dt><span class="section"><a href="#_literal_chmod_literal_changes"><code class="literal">chmod</code> Changes</a></span></dt></dl></dd><dt><span class="section"><a href="#_ftp_changes">I.6.11. FTP Changes</a></span></dt><dd><dl><dt><span class="section"><a href="#_session_changes">Session Changes</a></span></dt></dl></dd><dt><span class="section"><a href="#_router_changes">I.6.12. Router Changes</a></span></dt><dt><span class="section"><a href="#_header_mapping">I.6.13. Header Mapping</a></span></dt><dd><dl><dt><span class="section"><a href="#_general">General</a></span></dt><dt><span class="section"><a href="#_amqp_header_mapping">AMQP Header Mapping</a></span></dt></dl></dd><dt><span class="section"><a href="#_groovy_scripts">I.6.14. Groovy Scripts</a></span></dt><dt><span class="section"><a href="#_literal_inboundchanneladapter_literal_changes">I.6.15. <code class="literal">@InboundChannelAdapter</code> Changes</a></span></dt><dt><span class="section"><a href="#_xmpp_changes">I.6.16. XMPP Changes</a></span></dt><dt><span class="section"><a href="#_wiretap_late_binding">I.6.17. WireTap Late Binding</a></span></dt><dt><span class="section"><a href="#_literal_channelmessagestorequeryprovider_literal_changes">I.6.18. <code class="literal">ChannelMessageStoreQueryProvider</code> Changes</a></span></dt><dt><span class="section"><a href="#_websocket_changes">I.6.19. WebSocket Changes</a></span></dt></dl></dd><dt><span class="section"><a href="#migration-4.1-4.2">I.7. Changes between 4.1 and 4.2</a></span></dt><dt><span class="section"><a href="#x4.2-new-components">I.8. New Components</a></span></dt><dd><dl><dt><span class="section"><a href="#x4.2-JMX">I.8.1. Major Management/JMX Rework</a></span></dt><dt><span class="section"><a href="#x4.2-mongodb-metadata-store">I.8.2. MongoDB Metadata Store</a></span></dt><dt><span class="section"><a href="#x4.2-secured-channel-annotation">I.8.3. SecuredChannel Annotation</a></span></dt><dt><span class="section"><a href="#x4.2-security-context-propagation">I.8.4. <code class="literal">SecurityContext</code> Propagation</a></span></dt><dt><span class="section"><a href="#x4.2-file-splitter">I.8.5. FileSplitter</a></span></dt><dt><span class="section"><a href="#x4.2-zk">I.8.6. Zookeeper Support</a></span></dt><dt><span class="section"><a href="#x4.2-barrier">I.8.7. Thread Barrier</a></span></dt><dt><span class="section"><a href="#x4.2-stomp">I.8.8. STOMP Support</a></span></dt><dt><span class="section"><a href="#x4.2-codec">I.8.9. Codec</a></span></dt><dt><span class="section"><a href="#x4.2-prepared-statement-setter">I.8.10. Message PreparedStatement Setter</a></span></dt></dl></dd><dt><span class="section"><a href="#x4.2-general">I.9. General Changes</a></span></dt><dd><dl><dt><span class="section"><a href="#x4.2-wire-tap">I.9.1. WireTap</a></span></dt><dt><span class="section"><a href="#x4.2-file-changes">I.9.2. File Changes</a></span></dt><dd><dl><dt><span class="section"><a href="#_appending_new_lines">Appending New Lines</a></span></dt><dt><span class="section"><a href="#_ignoring_hidden_files">Ignoring Hidden Files</a></span></dt><dt><span class="section"><a href="#_writing_literal_inputstream_literal_payloads">Writing <code class="literal">InputStream</code> Payloads</a></span></dt><dt><span class="section"><a href="#_literal_headdirectoryscanner_literal"><code class="literal">HeadDirectoryScanner</code></a></span></dt><dt><span class="section"><a href="#_last_modified_filter">Last Modified Filter</a></span></dt><dt><span class="section"><a href="#_watch_service_directory_scanner">Watch Service Directory Scanner</a></span></dt><dt><span class="section"><a href="#_persistent_file_list_filter_changes">Persistent File List Filter Changes</a></span></dt></dl></dd><dt><span class="section"><a href="#x4.2-class-package-change">I.9.3. Class Package Change</a></span></dt><dt><span class="section"><a href="#_tcp_changes_2">I.9.4. TCP Changes</a></span></dt><dd><dl><dt><span class="section"><a href="#x4.2-tcp-serializers">TCP Serializers</a></span></dt><dt><span class="section"><a href="#x4.2-tcp-server-exceptions">Server Socket Exceptions</a></span></dt><dt><span class="section"><a href="#x4.2-tcp-server-port">TCP Server Port</a></span></dt><dt><span class="section"><a href="#x4.2-tcp-gw-rto">TCP Gateway Remote Timeout</a></span></dt><dt><span class="section"><a href="#x4.2-tcp-ssl">TCP SSLSession Available for Header Mapping</a></span></dt><dt><span class="section"><a href="#x4.2-tcp-events">TCP Events</a></span></dt></dl></dd><dt><span class="section"><a href="#x4.2-inbound-channel-adapter-annotation">I.9.5. <code class="literal">@InboundChannelAdapter</code> Changes</a></span></dt><dt><span class="section"><a href="#x4.2-api-changes">I.9.6. API Changes</a></span></dt><dt><span class="section"><a href="#x4.2-jms-changes">I.9.7. JMS Changes</a></span></dt><dd><dl><dt><span class="section"><a href="#_reply_listener_lazy_initialization">Reply Listener Lazy Initialization</a></span></dt><dt><span class="section"><a href="#_conversion_errors_in_message_driven_endpoints">Conversion Errors in Message-Driven Endpoints</a></span></dt><dt><span class="section"><a href="#_default_acknowledge_mode">Default Acknowledge Mode</a></span></dt><dt><span class="section"><a href="#_shared_subscriptions">Shared Subscriptions</a></span></dt></dl></dd><dt><span class="section"><a href="#x4.2-conditional-pollers">I.9.8. Conditional Pollers</a></span></dt><dt><span class="section"><a href="#x4.2-amqp-changes">I.9.9. AMQP Changes</a></span></dt><dd><dl><dt><span class="section"><a href="#_publisher_confirmations">Publisher Confirmations</a></span></dt><dt><span class="section"><a href="#_correlation_data">Correlation Data</a></span></dt><dt><span class="section"><a href="#_inbound_gateway_properties">Inbound Gateway Properties</a></span></dt></dl></dd><dt><span class="section"><a href="#x4.2-xpath-splitter">I.9.10. XPath Splitter Improvements</a></span></dt><dt><span class="section"><a href="#x4.2-http-changes">I.9.11. HTTP Changes</a></span></dt><dd><dl><dt><span class="section"><a href="#_cors">CORS</a></span></dt><dt><span class="section"><a href="#_inbound_gateway_timeout">Inbound Gateway Timeout</a></span></dt><dt><span class="section"><a href="#_form_data">Form Data</a></span></dt></dl></dd><dt><span class="section"><a href="#x4.2-gw">I.9.12. Gateway Changes</a></span></dt><dd><dl><dt><span class="section"><a href="#_gateway_methods_can_return_literal_completablefuture_literal">Gateway Methods can Return <code class="literal">CompletableFuture&lt;?&gt;</code></a></span></dt><dt><span class="section"><a href="#_messaginggateway_annotation">MessagingGateway Annotation</a></span></dt></dl></dd><dt><span class="section"><a href="#x4.2-aggregator-changes">I.9.13. Aggregator Changes</a></span></dt><dd><dl><dt><span class="section"><a href="#_aggregator_performance">Aggregator Performance</a></span></dt><dt><span class="section"><a href="#_output_message_group_processor">Output Message Group Processor</a></span></dt></dl></dd><dt><span class="section"><a href="#_ftp_and_sftp_changes_2">I.9.14. FTP and SFTP Changes</a></span></dt><dd><dl><dt><span class="section"><a href="#_inbound_channel_adapters">Inbound Channel Adapters</a></span></dt><dt><span class="section"><a href="#_gateway_partial_results">Gateway Partial Results</a></span></dt><dt><span class="section"><a href="#_delegating_session_factory">Delegating Session Factory</a></span></dt><dt><span class="section"><a href="#_default_sftp_session_factory">Default Sftp Session Factory</a></span></dt><dt><span class="section"><a href="#_message_session_callback">Message Session Callback</a></span></dt></dl></dd><dt><span class="section"><a href="#_websocket_changes_2">I.9.15. Websocket Changes</a></span></dt><dt><span class="section"><a href="#_application_event_adapters_changes">I.9.16. Application Event Adapters changes</a></span></dt></dl></dd><dt><span class="section"><a href="#migration-4.0-4.1">I.10. Changes between 4.0 and 4.1</a></span></dt><dd><dl><dt><span class="section"><a href="#_new_components">I.10.1. New Components</a></span></dt><dd><dl><dt><span class="section"><a href="#x4.1-promise-gateway">Promise&lt;?&gt; Gateway</a></span></dt><dt><span class="section"><a href="#x4.1-web-socket-adapters">WebSocket support</a></span></dt><dt><span class="section"><a href="#x4.1-scatter-gather">Scatter-Gather Enterprise Integration Pattern</a></span></dt><dt><span class="section"><a href="#x4.1-Routing-Slip">Routing Slip Pattern</a></span></dt><dt><span class="section"><a href="#x4.1-idempotent-receiver">Idempotent Receiver Pattern</a></span></dt><dt><span class="section"><a href="#x4.1-BoonJsonObjectMapper">Boon <code class="literal">JsonObjectMapper</code></a></span></dt><dt><span class="section"><a href="#x4.1-redis-queue-gateways">Redis Queue Gateways</a></span></dt><dt><span class="section"><a href="#x4.1-PollSkipAdvice"><code class="literal">PollSkipAdvice</code></a></span></dt></dl></dd><dt><span class="section"><a href="#x4.1-general">I.10.2. General Changes</a></span></dt><dd><dl><dt><span class="section"><a href="#x4.1-amqp-inbound-missing-queues">AMQP Inbound Endpoints, Channel</a></span></dt><dt><span class="section"><a href="#x4.1-amqp-outbound-lazy-connect">AMQP Outbound Endpoints</a></span></dt><dt><span class="section"><a href="#x4.1-sms-copy-on-get">SimpleMessageStore</a></span></dt><dt><span class="section"><a href="#x4.1-ws-encode-uri">Web Service Outbound Gateway: <code class="literal">encode-uri</code></a></span></dt><dt><span class="section"><a href="#x4.1-http-status-code">Http Inbound Channel Adapter and Status Code</a></span></dt><dt><span class="section"><a href="#x4.1-mqtt">MQTT Adapter Changes</a></span></dt><dt><span class="section"><a href="#x4.1-sftp">FTP and SFTP Adapter Changes</a></span></dt><dt><span class="section"><a href="#x4.1-splitter-iterator">Splitter and Iterator</a></span></dt><dt><span class="section"><a href="#x4.1-aggregator">Aggregator</a></span></dt><dt><span class="section"><a href="#x4.1-content-enricher-improvement">Content Enricher Improvements</a></span></dt><dt><span class="section"><a href="#x4.1-header-channel-registry">Header Channel Registry</a></span></dt><dt><span class="section"><a href="#x4.1-orderly-shutdown">Orderly Shutdown</a></span></dt><dt><span class="section"><a href="#x4.1-recipientListRouter">Management for <code class="literal">RecipientListRouter</code></a></span></dt><dt><span class="section"><a href="#x4.1-AbstractHeaderMapper-changes">AbstractHeaderMapper: NON_STANDARD_HEADERS token</a></span></dt><dt><span class="section"><a href="#x4.1-amqp-channels">AMQP Channels: <code class="literal">template-channel-transacted</code></a></span></dt><dt><span class="section"><a href="#x4.1-syslog">Syslog Adapter</a></span></dt><dt><span class="section"><a href="#x4.1-async-gateway">Asynchronous Gateway</a></span></dt><dt><span class="section"><a href="#x4.1-aggregator-advice-chain">Aggregator Advice Chain</a></span></dt><dt><span class="section"><a href="#x4.1-script-outbound-channel-adapter">Outbound Channel Adapter and Scripts</a></span></dt><dt><span class="section"><a href="#x4.1-reseq">Resequencer Changes</a></span></dt><dt><span class="section"><a href="#x4.1-Optional-Parameter">Optional POJO method parameter</a></span></dt><dt><span class="section"><a href="#x4.1-queue-channel-queue.typ"><code class="literal">QueueChannel</code> backed Queue type</a></span></dt><dt><span class="section"><a href="#x4.1-channel-interceptor"><code class="literal">ChannelInterceptor</code> Changes</a></span></dt><dt><span class="section"><a href="#x4.1-mail-peek">IMAP PEEK</a></span></dt></dl></dd></dl></dd><dt><span class="section"><a href="#migration-3.0-4.0">I.11. Changes between 3.0 and 4.0</a></span></dt><dd><dl><dt><span class="section"><a href="#x4.0-new-components">I.11.1. New Components</a></span></dt><dd><dl><dt><span class="section"><a href="#x4.0-mqtt">MQTT Channel Adapters</a></span></dt><dt><span class="section"><a href="#x4.0-enable-configuration"><code class="literal">@EnableIntegration</code></a></span></dt><dt><span class="section"><a href="#x4.0-component-scan"><code class="literal">@IntegrationComponentScan</code></a></span></dt><dt><span class="section"><a href="#x4.0-message-history">"<code class="literal">@EnableMessageHistory</code>"</a></span></dt><dt><span class="section"><a href="#x4.0-messaging-gateway"><code class="literal">@MessagingGateway</code></a></span></dt><dt><span class="section"><a href="#x4.0-boot">Spring Boot <code class="literal">@EnableAutoConfiguration</code></a></span></dt><dt><span class="section"><a href="#x4.0-global-channel-interceptor"><code class="literal">@GlobalChannelInterceptor</code></a></span></dt><dt><span class="section"><a href="#x4.0-integration-converter"><code class="literal">@IntegrationConverter</code></a></span></dt><dt><span class="section"><a href="#x4.0-enable-publisher"><code class="literal">@EnablePublisher</code></a></span></dt><dt><span class="section"><a href="#x4.0-redis-cms">Redis Channel Message Stores</a></span></dt><dt><span class="section"><a href="#x4.0-priority-channel-mondodb">MongodDB Channel Message Store</a></span></dt><dt><span class="section"><a href="#x4.0-MBeanExport-annotation"><code class="literal">@EnableIntegrationMBeanExport</code></a></span></dt><dt><span class="section"><a href="#x4.0-channel-security-interceptor"><code class="literal">ChannelSecurityInterceptorFactoryBean</code></a></span></dt><dt><span class="section"><a href="#x4.0-redis-outbound-gateway">Redis Command Gateway</a></span></dt><dt><span class="section"><a href="#x4.0-redis-gemfire-lock-registry"><code class="literal">RedisLockRegistry</code> and <code class="literal">GemfireLockRegistry</code></a></span></dt><dt><span class="section"><a href="#x4.0-poller-annotation"><code class="literal">@Poller</code></a></span></dt><dt><span class="section"><a href="#x4.0-inbound-channel-adapter-annotation"><code class="literal">@InboundChannelAdapter</code> and <code class="literal">SmartLifecycle</code> for Annotated Endpoints</a></span></dt><dt><span class="section"><a href="#x4.0-twitter-sog">Twitter Search Outbound Gateway</a></span></dt><dt><span class="section"><a href="#x4.0-gemfire-metadata">Gemfire Metadata Store</a></span></dt><dt><span class="section"><a href="#x4.0-bridge-annotations"><code class="literal">@BridgeFrom</code> and <code class="literal">@BridgeTo</code> Annotations</a></span></dt><dt><span class="section"><a href="#x4.0-meta-messaging-annotations">Meta-messaging Annotations</a></span></dt></dl></dd><dt><span class="section"><a href="#x4.0-general">I.11.2. General Changes</a></span></dt><dd><dl><dt><span class="section"><a href="#_requires_spring_framework_4_0">Requires Spring Framework 4.0</a></span></dt><dt><span class="section"><a href="#x4.0-xpath-header-enricher-header-type">Header Type for XPath Header Enricher</a></span></dt><dt><span class="section"><a href="#x4.0-object-to-json-transformer-result-type">Object To JSON Transformer: Node Result</a></span></dt><dt><span class="section"><a href="#x4.0-jms-header-mapping">JMS Header Mapping</a></span></dt><dt><span class="section"><a href="#x4.0-jms-ob">JMS Outbound Channel Adapter</a></span></dt><dt><span class="section"><a href="#x4.0-jms-ib">JMS Inbound Channel Adapter</a></span></dt><dt><span class="section"><a href="#x4.0-datatype-channel">Datatype Channels</a></span></dt><dt><span class="section"><a href="#x4.0-retry-config">Simpler Retry Advice Configuration</a></span></dt><dt><span class="section"><a href="#x4.0-release-strategy-group-timeout">Correlation Endpoint: Time-based Release Strategy</a></span></dt><dt><span class="section"><a href="#x4.0-redis-metadata">Redis Metadata Store</a></span></dt><dt><span class="section"><a href="#x4.0-jdbc-cs"><code class="literal">JdbcChannelMessageStore</code> and <code class="literal">PriorityChannel</code></a></span></dt><dt><span class="section"><a href="#x4.0-amqp">AMQP Endpoints Delivery Mode</a></span></dt><dt><span class="section"><a href="#x4.0-ftp">FTP Timeouts</a></span></dt><dt><span class="section"><a href="#x4.0-twitter-status-updating">Twitter: <code class="literal">StatusUpdatingMessageHandler</code></a></span></dt><dt><span class="section"><a href="#x4.0-jpa-id-expression">JPA Retrieving Gateway: <code class="literal">id-expression</code></a></span></dt><dt><span class="section"><a href="#x4.0-tcp-deserializer-events">TCP Deserialization Events</a></span></dt><dt><span class="section"><a href="#x4.0-bean-messaging-annotations">Messaging Annotations on <code class="literal">@Bean</code> Definitions</a></span></dt></dl></dd></dl></dd><dt><span class="section"><a href="#migration-2.2-3.0">I.12. Changes Between 2.2 and 3.0</a></span></dt><dd><dl><dt><span class="section"><a href="#x3.0-new-components">I.12.1. New Components</a></span></dt><dd><dl><dt><span class="section"><a href="#x3.0-request-mapping">HTTP Request Mapping</a></span></dt><dt><span class="section"><a href="#x3.0-spel-customization">Spring Expression Language (SpEL) Configuration</a></span></dt><dt><span class="section"><a href="#x3.0-spel-functions">SpEL Functions Support</a></span></dt><dt><span class="section"><a href="#x3.0-spel-property-accessors">SpEL PropertyAccessors Support</a></span></dt><dt><span class="section"><a href="#x3.0-redis-new-components">Redis: New Components</a></span></dt><dt><span class="section"><a href="#x3.0-hcr">Header Channel Registry</a></span></dt><dt><span class="section"><a href="#x3.0-configurable-mongo-MS">MongoDB support: New <code class="literal">ConfigurableMongoDbMessageStore</code></a></span></dt><dt><span class="section"><a href="#x3.0-syslog">Syslog Support</a></span></dt><dt><span class="section"><a href="#x3.0-tail"><code class="literal">tail</code> Support</a></span></dt><dt><span class="section"><a href="#x3.0-jmx">JMX Support</a></span></dt><dt><span class="section"><a href="#x3.0-tcp-events">TCP/IP Connection Events and Connection Management</a></span></dt><dt><span class="section"><a href="#x3.0-inbound-script">Inbound Channel Adapter Script Support</a></span></dt><dt><span class="section"><a href="#x3.0-content-enricher-headers">Content Enricher: Headers Enrichment Support</a></span></dt></dl></dd><dt><span class="section"><a href="#x3.0-general">I.12.2. General Changes</a></span></dt><dd><dl><dt><span class="section"><a href="#x3.0-message-id">Message ID Generation</a></span></dt><dt><span class="section"><a href="#x3.0-gateway">"<code class="literal">&lt;gateway&gt;</code>" Changes</a></span></dt><dt><span class="section"><a href="#x3.0-http-endpointss">HTTP Endpoint Changes</a></span></dt><dt><span class="section"><a href="#x3.0-json-transformers">Jackson Support (JSON)</a></span></dt><dt><span class="section"><a href="#x3.0-id-for-chain-sub-components">Chain Elements <code class="literal">id</code> Attribute</a></span></dt><dt><span class="section"><a href="#x3.0-corr-endpoint-empty-groups">Aggregator <span class="emphasis"><em>empty-group-min-timeout</em></span> property</a></span></dt><dt><span class="section"><a href="#x3.0-filelistfilter">Persistent File List Filters (file, (S)FTP)</a></span></dt><dt><span class="section"><a href="#x3.0-scripting-variables">Scripting Support: Variables Changes</a></span></dt><dt><span class="section"><a href="#x3.0-direct-channel-lb-ref">Direct Channel Load Balancing configuration</a></span></dt><dt><span class="section"><a href="#x3.0-pub-sub">PublishSubscribeChannel Behavior</a></span></dt><dt><span class="section"><a href="#x3.0--s-ftp-changes">FTP, SFTP and FTPS Changes</a></span></dt><dt><span class="section"><a href="#x3.0-outbound-gateway-requires-reply"><span class="emphasis"><em>requires-reply</em></span> Attribute for Outbound Gateways</a></span></dt><dt><span class="section"><a href="#x3.0-amqp-mapping">AMQP Outbound Gateway Header Mapping</a></span></dt><dt><span class="section"><a href="#x3.0-stored-proc-sql-return-type">Stored Procedure Components Improvements</a></span></dt><dt><span class="section"><a href="#x3.0-ws-outbound-uri-substitution">Web Service Outbound URI Configuration</a></span></dt><dt><span class="section"><a href="#x3.0-redis">Redis Adapter Changes</a></span></dt><dt><span class="section"><a href="#x3.0-advising-filters">Advising Filters</a></span></dt><dt><span class="section"><a href="#x3.0-annotation-advice">Advising Endpoints using Annotations</a></span></dt><dt><span class="section"><a href="#x3.0-o-t-s-t">ObjectToStringTransformer Improvements</a></span></dt><dt><span class="section"><a href="#x3.0-jpa-changes">JPA Support Changes</a></span></dt><dt><span class="section"><a href="#x3.0-dalay-expression">Delayer: delay expression</a></span></dt><dt><span class="section"><a href="#x3.0-jdbc-mysql-v5_6_4">JDBC Message Store Improvements</a></span></dt><dt><span class="section"><a href="#x3.0-event-for-imap-idle">IMAP Idle Connection Exceptions</a></span></dt><dt><span class="section"><a href="#x3.0-tcp-headers">Message Headers and TCP</a></span></dt><dt><span class="section"><a href="#x3.0-jms-mdca-te">JMS Message Driven Channel Adapter</a></span></dt><dt><span class="section"><a href="#x3.0-rmi-ec">RMI Inbound Gateway</a></span></dt><dt><span class="section"><a href="#x3.0-xslt-transformer"><code class="literal">XsltPayloadTransformer</code></a></span></dt></dl></dd></dl></dd><dt><span class="section"><a href="#migration-2.1-2.2">I.13. Changes between 2.1 and 2.2</a></span></dt><dd><dl><dt><span class="section"><a href="#x2.2-new-components">I.13.1. New Components</a></span></dt><dd><dl><dt><span class="section"><a href="#x2.2-redis-store-adapters"><code class="literal">RedisStore</code> Inbound and Outbound Channel Adapters</a></span></dt><dt><span class="section"><a href="#x2.2-mongo-adapters">MongoDB Inbound and Outbound Channel Adapters</a></span></dt><dt><span class="section"><a href="#x2.2-jpa">JPA Endpoints</a></span></dt></dl></dd><dt><span class="section"><a href="#x2.2-general">I.13.2. General Changes</a></span></dt><dd><dl><dt><span class="section"><a href="#x2.2-spring-31">Spring 3.1 Used by Default</a></span></dt><dt><span class="section"><a href="#x2.2-handler-advice">Adding Behavior to Endpoints</a></span></dt><dt><span class="section"><a href="#x2.2-transaction-sync">Transaction Synchronization and Pseudo Transactions</a></span></dt><dt><span class="section"><a href="#x2.2-file-adapter">File Adapter: Improved File Overwrite and Append Handling</a></span></dt><dt><span class="section"><a href="#x2.2-outbound-gateways">Reply-Timeout Added to More Outbound Gateways</a></span></dt><dt><span class="section"><a href="#x2.2-amqp-11">Spring-AMQP 1.1</a></span></dt><dt><span class="section"><a href="#x2.2-jdbc-11">JDBC Support - Stored Procedures Components</a></span></dt><dt><span class="section"><a href="#x2.2-jdbc-gateway-update-optional">JDBC Support: Outbound Gateway</a></span></dt><dt><span class="section"><a href="#x2.2-jdbc-message-store-channels">JDBC Support: Channel-specific Message Store Implementation</a></span></dt><dt><span class="section"><a href="#x2.2-shutdown">Orderly Shutdown</a></span></dt><dt><span class="section"><a href="#x2.2-jms-og">JMS Outbound Gateway Improvements</a></span></dt><dt><span class="section"><a href="#x2.2-o-t-j-t"><code class="literal">ObjectToJsonTransformer</code></a></span></dt><dt><span class="section"><a href="#httpChanges">HTTP Support</a></span></dt></dl></dd></dl></dd><dt><span class="section"><a href="#migration-2.0-2.1">I.14. Changes between 2.0 and 2.1</a></span></dt><dd><dl><dt><span class="section"><a href="#x2.1-new-components">I.14.1. New Components</a></span></dt><dd><dl><dt><span class="section"><a href="#x2.1-new-scripting-support">JSR-223 Scripting Support</a></span></dt><dt><span class="section"><a href="#x2.1-new-gemfire-support">GemFire Support</a></span></dt><dt><span class="section"><a href="#x2.1-new-amqp-support">AMQP Support</a></span></dt><dt><span class="section"><a href="#x2.1-new-mongodb-support">MongoDB Support</a></span></dt><dt><span class="section"><a href="#x2.1-new-redis-support">Redis Support</a></span></dt><dt><span class="section"><a href="#x2.1-new-resource-support">Support for Spring&#8217;s Resource abstraction</a></span></dt><dt><span class="section"><a href="#x2.1-new-stored-proc-support">Stored Procedure Components</a></span></dt><dt><span class="section"><a href="#x2.1-new-xpath-filter-support">XPath and XML Validating Filter</a></span></dt><dt><span class="section"><a href="#x2.1-new-payload-enricher-support">Payload Enricher</a></span></dt><dt><span class="section"><a href="#x2.1-new-ftp-outbound-gateway">FTP and SFTP Outbound Gateways</a></span></dt><dt><span class="section"><a href="#x2.1-new-ftp-session-caching">FTP Session Caching</a></span></dt></dl></dd><dt><span class="section"><a href="#x2.1-framework-refactorings">I.14.2. Framework Refactoring</a></span></dt><dd><dl><dt><span class="section"><a href="#x2.1-router-standardization">Standardizing Router Configuration</a></span></dt><dt><span class="section"><a href="#x2.1-schema-updated">XML Schemas updated to 2.1</a></span></dt></dl></dd><dt><span class="section"><a href="#x2.1-source-control-infrastructure">I.14.3. Source Control Management and Build Infrastructure</a></span></dt><dd><dl><dt><span class="section"><a href="#x2.1-move-to-github">Source Code Now Hosted on Github</a></span></dt><dt><span class="section"><a href="#x2.1-sonar">Improved Source Code Visibility with Sonar</a></span></dt></dl></dd><dt><span class="section"><a href="#x2.1-new-samples">I.14.4. New Samples</a></span></dt></dl></dd><dt><span class="section"><a href="#migration-1.0-2.0">I.15. Changes between Versions 1.0 and 2.0</a></span></dt><dd><dl><dt><span class="section"><a href="#migration-spring-30-support">I.15.1. Spring 3 support</a></span></dt><dd><dl><dt><span class="section"><a href="#spel-support">Support for the Spring Expression Language (SpEL)</a></span></dt><dt><span class="section"><a href="#conversion-support">Conversion Service and Converter</a></span></dt><dt><span class="section"><a href="#task-scheduler-poller-support"><code class="literal">TaskScheduler</code> and <code class="literal">Trigger</code></a></span></dt><dt><span class="section"><a href="#rest-support"><code class="literal">RestTemplate</code> and <code class="literal">HttpMessageConverter</code></a></span></dt></dl></dd><dt><span class="section"><a href="#new-eip">I.15.2. Enterprise Integration Pattern Additions</a></span></dt><dd><dl><dt><span class="section"><a href="#new-message-history">Message History</a></span></dt><dt><span class="section"><a href="#new-message-store">Message Store</a></span></dt><dt><span class="section"><a href="#new-claim-check">Claim Check</a></span></dt><dt><span class="section"><a href="#new-control-bus">Control Bus</a></span></dt></dl></dd><dt><span class="section"><a href="#new-adapters">I.15.3. New Channel Adapters and Gateways</a></span></dt><dd><dl><dt><span class="section"><a href="#new-ip">TCP and UDP Adapters</a></span></dt><dt><span class="section"><a href="#new-twitter">Twitter Adapters</a></span></dt><dt><span class="section"><a href="#new-xmpp">XMPP Adapters</a></span></dt><dt><span class="section"><a href="#new-ftp">FTP and FTPS Adapters</a></span></dt><dt><span class="section"><a href="#new-sftp">SFTP Adapters</a></span></dt><dt><span class="section"><a href="#new-feed">Feed Adapters</a></span></dt></dl></dd><dt><span class="section"><a href="#new-other">I.15.4. Other Additions</a></span></dt><dd><dl><dt><span class="section"><a href="#new-groovy">Groovy Support</a></span></dt><dt><span class="section"><a href="#new-map-transformer">Map Transformers</a></span></dt><dt><span class="section"><a href="#new-json-transformer">JSON Transformers</a></span></dt><dt><span class="section"><a href="#new-serialize-transformer">Serialization Transformers</a></span></dt></dl></dd><dt><span class="section"><a href="#new-refactoring">I.15.5. Framework Refactoring</a></span></dt><dt><span class="section"><a href="#new-infrastructure">I.15.6. New Source Control Management and Build Infrastructure</a></span></dt><dt><span class="section"><a href="#new-samples">I.15.7. New Spring Integration Samples</a></span></dt><dt><span class="section"><a href="#new-sts">I.15.8. Spring Tool Suite Visual Editor for Spring Integration</a></span></dt></dl></dd></dl></dd></dl></dd></dl></div>

<div class="preface"><div class="titlepage"><div><div><h1 class="title"><a name="d5e65" href="#d5e65"></a></h1></div></div></div>

<p>&copy; 2009-2018 Pivotal Software, Inc. All rights reserved.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Copies of this document may be made for your own use and for distribution to others, provided that you do not charge any fee for such copies and further provided that each copy contains this Copyright Notice, whether distributed in print or electronically.</p>
</td></tr></table></div>
</div>
<div class="part"><div class="titlepage"><div><div><h1 class="title"><a name="preface" href="#preface"></a>Part&nbsp;I.&nbsp;Preface</h1></div></div></div>

<div class="partintro"><div></div>
<p>This chapter includes:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="xref" href="#system-requirements" title="1.&nbsp;Requirements">Chapter&nbsp;1, <i>Requirements</i></a>
</li><li class="listitem">
<a class="xref" href="#code-conventions" title="2.&nbsp;Code Conventions">Chapter&nbsp;2, <i>Code Conventions</i></a>
</li><li class="listitem">
<a class="xref" href="#guide-conventions" title="3.&nbsp;Conventions in This Guide">Chapter&nbsp;3, <i>Conventions in This Guide</i></a>
</li></ul></div>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="system-requirements" href="#system-requirements"></a>1.&nbsp;Requirements</h2></div></div></div>

<p>This section details the compatible <a class="ulink" href="http://www.oracle.com/technetwork/java/javase/downloads/index.html" target="_top">Java</a> and <a class="ulink" href="http://www.springsource.org/spring-framework" target="_top">Spring Framework</a> versions.</p>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="supported-java-versions" href="#supported-java-versions"></a>1.1&nbsp;Compatible Java Versions</h2></div></div></div>

<p>For Spring Integration 5.1.x, the minimum compatible Java version is Java SE 8.
Older versions of Java are not supported.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="supported-spring-versions" href="#supported-spring-versions"></a>1.2&nbsp;Compatible Versions of the Spring Framework</h2></div></div></div>

<p>Spring Integration 5.1.x requires Spring Framework 5.1 or later.</p>
</div>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="code-conventions" href="#code-conventions"></a>2.&nbsp;Code Conventions</h2></div></div></div>

<p>Spring Framework 2.0 introduced support for namespaces, which simplifies the XML configuration of the application context and lets Spring Integration provide broad namespace support.</p>
<p>In this reference guide, the <code class="literal">int</code> namespace prefix is used for Spring Integration&#8217;s core namespace support.
Each Spring Integration adapter type (also called a module) provides its own namespace, which is configured by using the following convention:</p>
<p>The following example shows the <code class="literal">int</code>, <code class="literal">int-event</code>, and <code class="literal">int-stream</code> namespaces in use:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
  <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
  <span class="hl-attribute">xmlns:int</span>=<span class="hl-value">"http://www.springframework.org/schema/integration"</span>
  <span class="hl-attribute">xmlns:int-webflux</span>=<span class="hl-value">"http://www.springframework.org/schema/integration/webflux"</span>
  <span class="hl-attribute">xmlns:int-stream</span>=<span class="hl-value">"http://www.springframework.org/schema/integration/stream"</span>
  <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"
   http://www.springframework.org/schema/beans
   http://www.springframework.org/schema/beans/spring-beans.xsd
   http://www.springframework.org/schema/integration
   http://www.springframework.org/schema/integration/spring-integration.xsd
   http://www.springframework.org/schema/integration/webflux
   http://www.springframework.org/schema/integration/webflux/spring-integration-webflux.xsd
   http://www.springframework.org/schema/integration/stream
   http://www.springframework.org/schema/integration/stream/spring-integration-stream.xsd"</span><span class="hl-tag">&gt;</span>
&#8230;
<span class="hl-tag">&lt;/beans&gt;</span></pre>
</div>
<p>For a detailed explanation regarding Spring Integration&#8217;s namespace support, see <a class="xref" href="#configuration-namespace" title="E.1&nbsp;Namespace Support">Section&nbsp;E.1, &#8220;Namespace Support&#8221;</a>.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The namespace prefix can be freely chosen.
You may even choose not to use any namespace prefixes at all.
Therefore, you should apply the convention that best suits your application.
Be aware, though, that SpringSource Tool Suite&#8482; (STS) uses the same namespace conventions for Spring Integration as used in this reference guide.</p>
</td></tr></table></div>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="guide-conventions" href="#guide-conventions"></a>3.&nbsp;Conventions in This Guide</h2></div></div></div>

<p>In some cases, to aid formatting when specifying long fully qualified class names, we shorten
<code class="literal">org.springframework</code> to <code class="literal">o.s</code> and <code class="literal">org.springframework.integration</code> to <code class="literal">o.s.i</code>, such as with
<code class="literal">o.s.i.transaction.TransactionSynchronizationFactory</code>.</p>
</div>
</div>
<div class="part"><div class="titlepage"><div><div><h1 class="title"><a name="whats-new-part" href="#whats-new-part"></a>Part&nbsp;II.&nbsp;What&#8217;s New?</h1></div></div></div>

<div class="partintro"><div></div>
<p>For those who are already familiar with Spring Integration, this chapter provides a brief overview of the new features of version 5.1.
If you are interested in the changes and features that were introduced in earlier versions, see the <a class="xref" href="#history" title="Appendix&nbsp;I.&nbsp;Change History">Appendix&nbsp;I, <i>Change History</i></a>.</p>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="whats-new" href="#whats-new"></a>4.&nbsp;What&#8217;s New in Spring Integration 5.1?</h2></div></div></div>

<p>This chapter provides an overview of the new features and improvements that have been introduced with Spring
Integration <code class="literal">5.1</code>.
If you are interested in more details, see the Issue Tracker tickets that were resolved as part of the 5.1 development process.</p>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="x5.1-new-components" href="#x5.1-new-components"></a>4.1&nbsp;New Components</h2></div></div></div>

<p>The following components are new in 5.1:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="xref" href="#x5.1-AmqpDedicatedChannelAdvice" title="4.1.1&nbsp;AmqpDedicatedChannelAdvice">Section&nbsp;4.1.1, &#8220;<code class="literal">AmqpDedicatedChannelAdvice</code>&#8221;</a>
</li></ul></div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="x5.1-AmqpDedicatedChannelAdvice" href="#x5.1-AmqpDedicatedChannelAdvice"></a>4.1.1&nbsp;<code class="literal">AmqpDedicatedChannelAdvice</code></h3></div></div></div>

<p>See <a class="xref" href="#amqp-strict-ordering" title="14.13&nbsp;Strict Message Ordering">Section&nbsp;14.13, &#8220;Strict Message Ordering&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="x5.1-Functions" href="#x5.1-Functions"></a>4.1.2&nbsp;Improved Function Support</h3></div></div></div>

<p>The <code class="literal">java.util.function</code> interfaces now have improved integration support in the Framework components.
Also Kotlin lambdas now can be used for handler and source methods.</p>
<p>See <a class="xref" href="#functions-support" title="10.11&nbsp;java.util.function Interfaces Support">Section&nbsp;10.11, &#8220;<code class="literal">java.util.function</code> Interfaces Support&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="x5.1-LongRunningTest" href="#x5.1-LongRunningTest"></a>4.1.3&nbsp;<code class="literal">@LongRunningTest</code></h3></div></div></div>

<p>A JUnit 5 <code class="literal">@LongRunningTest</code> conditional annotation is provided to check the environment or system properties for the <code class="literal">RUN_LONG_INTEGRATION_TESTS</code> entry with the value of <code class="literal">true</code> to determine if test should be run or skipped.</p>
<p>See <a class="xref" href="#test-junit-rules" title="F.1.5&nbsp;JUnit Rules and Conditions">Section&nbsp;F.1.5, &#8220;JUnit Rules and Conditions&#8221;</a>.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="x5.1-general" href="#x5.1-general"></a>4.2&nbsp;General Changes</h2></div></div></div>

<p>The following changes have been made in version 5.1:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="xref" href="#x5.1-java-dsl" title="4.2.1&nbsp;Java DSL">Section&nbsp;4.2.1, &#8220;Java DSL&#8221;</a>
</li><li class="listitem">
<a class="xref" href="#x5.1-dispatcher-exceptions" title="4.2.2&nbsp;Dispatcher Exceptions">Section&nbsp;4.2.2, &#8220;Dispatcher Exceptions&#8221;</a>
</li><li class="listitem">
<a class="xref" href="#x5.1-global-channel-interceptors" title="4.2.3&nbsp;Global Channel Interceptors">Section&nbsp;4.2.3, &#8220;Global Channel Interceptors&#8221;</a>
</li><li class="listitem">
<a class="xref" href="#x5.1-object-to-json-transformer" title="4.2.5&nbsp;ObjectToJsonTransformer">Section&nbsp;4.2.5, &#8220;<code class="literal">ObjectToJsonTransformer</code>&#8221;</a>
</li><li class="listitem">
<a class="xref" href="#x5.1-integration-flows-generated-bean-names" title="4.2.6&nbsp;Integration Flows: Generated Bean Names">Section&nbsp;4.2.6, &#8220;Integration Flows: Generated Bean Names&#8221;</a>
</li><li class="listitem">
<a class="xref" href="#x5.1-aggregator" title="4.2.7&nbsp;Aggregator Changes">Section&nbsp;4.2.7, &#8220;Aggregator Changes&#8221;</a>
</li><li class="listitem">
<a class="xref" href="#x5.1-publisher" title="4.2.8&nbsp;@Publisher annotation changes">Section&nbsp;4.2.8, &#8220;@Publisher annotation changes&#8221;</a>
</li><li class="listitem">
<a class="xref" href="#x51.-integration-graph" title="4.13&nbsp;Integration Graph Customization">Section&nbsp;4.13, &#8220;Integration Graph Customization&#8221;</a>
</li><li class="listitem">
<a class="xref" href="#x51.-global-properties" title="4.14&nbsp;Integration Global Properties">Section&nbsp;4.14, &#8220;Integration Global Properties&#8221;</a>
</li><li class="listitem">
<a class="xref" href="#x51.-poller-annotation" title="4.15&nbsp;The receiveTimeout for @Poller">Section&nbsp;4.15, &#8220;The <code class="literal">receiveTimeout</code> for <code class="literal">@Poller</code>&#8221;</a>
</li></ul></div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="x5.1-java-dsl" href="#x5.1-java-dsl"></a>4.2.1&nbsp;Java DSL</h3></div></div></div>

<p>The <code class="literal">IntegrationFlowContext</code> is now an interface and <code class="literal">IntegrationFlowRegistration</code> is an inner interface of <code class="literal">IntegrationFlowContext</code>.</p>
<p>A new <code class="literal">logAndReply()</code> operator has been introduced for convenience when you wish to log at the end of a flow for request-reply configurations.
This avoid confusion with <code class="literal">log()</code> which is treated as a one-way end flow component.</p>
<p>A generated bean name for any <code class="literal">NamedComponent</code> within an integration flow is now based on the component type for better readability from visual tools, logs analyzers and metrics collectors.</p>
<p>The <code class="literal">GenericHandler.handle()</code> now excepts a <code class="literal">MessageHeaders</code> type for the second argument.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="x5.1-dispatcher-exceptions" href="#x5.1-dispatcher-exceptions"></a>4.2.2&nbsp;Dispatcher Exceptions</h3></div></div></div>

<p>Exceptions caught and re-thrown by <code class="literal">AbstractDispatcher</code> are now more consistent:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
A <code class="literal">MessagingException</code> of any kind that has a <code class="literal">failedMessage</code> property is re-thrown unchanged.
</li><li class="listitem">
All other exceptions are wrapped in a <code class="literal">MessageDeliveryException</code> with the <code class="literal">failedMessage</code> property set.
</li></ul></div>
<p>Previously:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
A <code class="literal">MessagingException</code> of any kind that has a <code class="literal">failedMessage</code> property was re-thrown unchanged
</li><li class="listitem">
A <code class="literal">MessagingException</code> that had no <code class="literal">failedMessage</code> property was wrapped in a <code class="literal">MessagingException</code> with the <code class="literal">failedMessage</code> property set.
</li><li class="listitem">
Other <code class="literal">RuntimeException</code> instances were re-thrown unchanged.
</li><li class="listitem">
Checked exceptions were wrapped in a <code class="literal">MessageDeliveryException</code> with the <code class="literal">failedMessage</code> property set.
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="x5.1-global-channel-interceptors" href="#x5.1-global-channel-interceptors"></a>4.2.3&nbsp;Global Channel Interceptors</h3></div></div></div>

<p>Global channel interceptors now apply to dynamically registered channels, such as through the <code class="literal">IntegrationFlowContext</code> when using the Java DSL or beans that are initialized using <code class="literal">beanFactory.initializeBean()</code>.
Previously, when beans were created after the application context was refreshed, interceptors were not applied.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="x5.1-channel-interceptors" href="#x5.1-channel-interceptors"></a>4.2.4&nbsp;Channel Interceptors</h3></div></div></div>

<p><code class="literal">ChannelInterceptor.postReceive()</code> is no longer called when no message is received; it is no longer necessary to check for a <code class="literal">null</code> <code class="literal">Message&lt;?&gt;</code>.
Previously, the method was called.
If you have an interceptor that relies on the previous behavior, implement <code class="literal">afterReceiveCompleted()</code> instead, since that method is invoked, regardless of whether a message is received or not.
Furthermore, the <code class="literal">PolledAmqpChannel</code> and <code class="literal">PolledJmsChannel</code> previously did not invoke <code class="literal">afterReceiveCompleted()</code> with <code class="literal">null</code>; they now do.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="x5.1-object-to-json-transformer" href="#x5.1-object-to-json-transformer"></a>4.2.5&nbsp;<code class="literal">ObjectToJsonTransformer</code></h3></div></div></div>

<p>A new <code class="literal">ResultType.BYTES</code> mode is introduced for the <code class="literal">ObjectToJsonTransformer</code>.</p>
<p>See <a class="xref" href="#json-transformers" title="JSON Transformers">the section called &#8220;JSON Transformers&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="x5.1-integration-flows-generated-bean-names" href="#x5.1-integration-flows-generated-bean-names"></a>4.2.6&nbsp;Integration Flows: Generated Bean Names</h3></div></div></div>

<p>Starting with version 5.0.5, generated bean names for the components in an <code class="literal">IntegrationFlow</code> include the flow bean name, followed by a dot, as a prefix. For example, if a flow bean were named <code class="literal">flowBean</code>, a generated bean might be named <code class="literal">flowBean.generatedBean</code>.</p>
<p>See <a class="xref" href="#java-dsl-flows" title="11.13&nbsp;Working With Message Flows">Section&nbsp;11.13, &#8220;Working With Message Flows&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="x5.1-aggregator" href="#x5.1-aggregator"></a>4.2.7&nbsp;Aggregator Changes</h3></div></div></div>

<p>If the <code class="literal">groupTimeout</code> is evaluated to a negative value, an aggregator now expires the group immediately.
Only <code class="literal">null</code> is considered as a signal to do nothing for the current message.</p>
<p>A new <code class="literal">popSequence</code> property has been introduced to allow (by default) to call a <code class="literal">MessageBuilder.popSequenceDetails()</code> for the output message.
Also an <code class="literal">AbstractAggregatingMessageGroupProcessor</code> returns now an <code class="literal">AbstractIntegrationMessageBuilder</code> instead of the whole <code class="literal">Message</code> for optimization.</p>
<p>See <a class="xref" href="#aggregator" title="8.4&nbsp;Aggregator">Section&nbsp;8.4, &#8220;Aggregator&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="x5.1-publisher" href="#x5.1-publisher"></a>4.2.8&nbsp;@Publisher annotation changes</h3></div></div></div>

<p>Starting with version 5.1, you must explicitly turn on the <code class="literal">@Publisher</code> AOP functionality by using <code class="literal">@EnablePublisher</code> or by using the <code class="literal">&lt;int:enable-publisher&gt;</code> child element on <code class="literal">&lt;int:annotation-config&gt;</code>.</p>
<p>See <a class="xref" href="#publisher-annotation" title="B.1.1&nbsp;Annotation-driven Configuration with the @Publisher Annotation">Section&nbsp;B.1.1, &#8220;Annotation-driven Configuration with the <code class="literal">@Publisher</code> Annotation&#8221;</a> for more information.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="x5.1-files" href="#x5.1-files"></a>4.3&nbsp;Files Changes</h2></div></div></div>

<p>If you are using <code class="literal">FileExistsMode.APPEND</code> or <code class="literal">FileExistsMode.APPEND_NO_FLUSH</code> you can provide a <code class="literal">newFileCallback</code> that will be called when creating a new file.
This callback receives the newly created file and the message that triggered the callback.
This could be used to write a CSV header, for an example.</p>
<p>The <code class="literal">FileReadingMessageSource</code> now doesn&#8217;t check and create a directory until its <code class="literal">start()</code> is called.
So, if an Inbound Channel Adapter for the <code class="literal">FileReadingMessageSource</code> has <code class="literal">autoStartup = false</code>, there are no failures against the file system during application start up.</p>
<p>See <a class="xref" href="#files" title="17.&nbsp;File Support">Chapter&nbsp;17, <i>File Support</i></a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="x5.1-amqp" href="#x5.1-amqp"></a>4.4&nbsp;AMQP Changes</h2></div></div></div>

<p>We have made <code class="literal">ID</code> and <code class="literal">Timestamp</code> header mapping changes in the <code class="literal">DefaultAmqpHeaderMapper</code>.
See the note near the bottom of <a class="xref" href="#amqp-message-headers" title="14.12&nbsp;AMQP Message Headers">Section&nbsp;14.12, &#8220;AMQP Message Headers&#8221;</a> for more information.</p>
<p>The <code class="literal">contentType</code> header is now correctly mapped as an entry in the general headers map.
See <a class="xref" href="#amqp-content-type" title="14.12.2&nbsp;contentType Header">Section&nbsp;14.12.2, &#8220;contentType Header&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="x5.1-jdbc" href="#x5.1-jdbc"></a>4.5&nbsp;JDBC Changes</h2></div></div></div>

<p>A confusing <code class="literal">max-rows-per-poll</code> property on the JDBC Inbound Channel Adapter and JDBC Outbound Gateway has been deprecated in favor of the newly introduced <code class="literal">max-rows</code> property.</p>
<p>The <code class="literal">JdbcMessageHandler</code> supports now a <code class="literal">batchUpdate</code> functionality when the payload of the request message is an instance of an <code class="literal">Iterable</code> type.</p>
<p>The indexes for the <code class="literal">INT_CHANNEL_MESSAGE</code> table (for the <code class="literal">JdbcChannelMessageStore</code>) have been optimized.
If you have large message groups in such a store, you may wish to alter the indexes.</p>
<p>See <a class="xref" href="#jdbc" title="21.&nbsp;JDBC Support">Chapter&nbsp;21, <i>JDBC Support</i></a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="x5.1-ftp-sftp" href="#x5.1-ftp-sftp"></a>4.6&nbsp;FTP and SFTP Changes</h2></div></div></div>

<p>A <code class="literal">RotatingServerAdvice</code> is now available to poll multiple servers and directories with the inbound channel adapters.
See <a class="xref" href="#ftp-rotating-server-advice" title="18.6&nbsp;Inbound Channel Adapters: Polling Multiple Servers and Directories">Section&nbsp;18.6, &#8220;Inbound Channel Adapters: Polling Multiple Servers and Directories&#8221;</a> and <a class="xref" href="#sftp-rotating-server-advice" title="30.8&nbsp;Inbound Channel Adapters: Polling Multiple Servers and Directories">Section&nbsp;30.8, &#8220;Inbound Channel Adapters: Polling Multiple Servers and Directories&#8221;</a> for more information.</p>
<p>Also, inbound adapter <code class="literal">localFilenameExpression</code> instances can contain the <code class="literal">#remoteDirectory</code> variable, which contains the remote directory being polled.
The generic type of the comparators (used to sort the fetched file list for the streaming adapters) has changed from <code class="literal">Comparator&lt;AbstractFileInfo&lt;F&gt;&gt;</code> to <code class="literal">Comparator&lt;F&gt;</code>.
See <a class="xref" href="#ftp-streaming" title="18.5&nbsp;FTP Streaming Inbound Channel Adapter">Section&nbsp;18.5, &#8220;FTP Streaming Inbound Channel Adapter&#8221;</a> and <a class="xref" href="#sftp-streaming" title="30.7&nbsp;SFTP Streaming Inbound Channel Adapter">Section&nbsp;30.7, &#8220;SFTP Streaming Inbound Channel Adapter&#8221;</a> for more information.</p>
<p>In addition, the synchronizers for inbound channel adapters can now be provided with a <code class="literal">Comparator</code>.
This is useful when using <code class="literal">maxFetchSize</code> to limit the files retrieved.</p>
<p>The <code class="literal">CachingSessionFactory</code> has a new property <code class="literal">testSession</code> which, when true, causes the factory to perform a <code class="literal">test()</code> operation on the <code class="literal">Session</code> when checking out an existing session from the cache.</p>
<p>See <a class="xref" href="#sftp-session-caching" title="30.4&nbsp;SFTP Session Caching">Section&nbsp;30.4, &#8220;SFTP Session Caching&#8221;</a> and <a class="xref" href="#ftp-session-caching" title="18.10&nbsp;FTP Session Caching">Section&nbsp;18.10, &#8220;FTP Session Caching&#8221;</a> for more information.</p>
<p>The outbound gateway MPUT command now supports a message payload with a collection of files or strings.
See <a class="xref" href="#sftp-outbound-gateway" title="30.11&nbsp;SFTP Outbound Gateway">Section&nbsp;30.11, &#8220;SFTP Outbound Gateway&#8221;</a> and <a class="xref" href="#ftp-outbound-gateway" title="18.9&nbsp;FTP Outbound Gateway">Section&nbsp;18.9, &#8220;FTP Outbound Gateway&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="x51.-tcp" href="#x51.-tcp"></a>4.7&nbsp;TCP Support</h2></div></div></div>

<p>When using SSL, host verification is now enabled, by default, to prevent man-in-the-middle attacks with a trusted certificate.
See <a class="xref" href="#tcp-ssl-host-verification" title="34.10.2&nbsp;Host Verification">Section&nbsp;34.10.2, &#8220;Host Verification&#8221;</a> for more information.</p>
<p>In addition the key and trust store types can now be configured on the <code class="literal">DefaultTcpSSLContextSupport</code>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="x5.1-twitter" href="#x5.1-twitter"></a>4.8&nbsp;Twitter Support</h2></div></div></div>

<p>Since the Spring Social project has moved to <a class="ulink" href="https://spring.io/blog/2018/07/03/spring-social-end-of-life-announcement" target="_top">end of life status</a>, Twitter support in Spring Integration has been moved to the Extensions project.
See <a class="ulink" href="https://github.com/spring-projects/spring-integration-extensions/tree/master/spring-integration-social-twitter" target="_top">Spring Integration Social Twitter</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="x51.-jms" href="#x51.-jms"></a>4.9&nbsp;JMS Support</h2></div></div></div>

<p>The <code class="literal">JmsSendingMessageHandler</code> now provides <code class="literal">deliveryModeExpression</code> and <code class="literal">timeToLiveExpression</code> options to determine respective QoS options for JMS message to send at runtime.
The <code class="literal">DefaultJmsHeaderMapper</code> now allows to map inbound <code class="literal">JMSDeliveryMode</code> and <code class="literal">JMSExpiration</code> properties via setting to <code class="literal">true</code> respective <code class="literal">setMapInboundDeliveryMode()</code> and <code class="literal">setMapInboundExpiration()</code> options.
When a <code class="literal">JmsMessageDrivenEndpoint</code> or <code class="literal">JmsInboundGateway</code> is stopped, the associated listener container is now shut down; this closes its shared connection and any consumers.
You can configure the endpoints to revert to the previous behavior.</p>
<p>See <a class="xref" href="#jms" title="23.&nbsp;JMS Support">Chapter&nbsp;23, <i>JMS Support</i></a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="x51.-http" href="#x51.-http"></a>4.10&nbsp;HTTP/WebFlux Support</h2></div></div></div>

<p>The <code class="literal">statusCodeExpression</code> (and <code class="literal">Function</code>) is now supplied with the <code class="literal">RequestEntity&lt;?&gt;</code> as a root object for evaluation context, so request headers, method, URI and body are available for target status code calculation.</p>
<p>See <a class="xref" href="#http" title="20.&nbsp;HTTP Support">Chapter&nbsp;20, <i>HTTP Support</i></a> and <a class="xref" href="#webflux" title="35.&nbsp;WebFlux Support">Chapter&nbsp;35, <i>WebFlux Support</i></a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="x51.-jmx" href="#x51.-jmx"></a>4.11&nbsp;JMX Changes</h2></div></div></div>

<p>Object name key values are now quoted if they contain any characters other than those allowed in a Java identifier (or period <code class="literal">.</code>).
e.g. <code class="literal">org.springframework.integration:type=MessageChannel,</code> <code class="literal">name="input:foo.myGroup.errors"</code>.
This has the side effect that previously "allowed" names, with such characters, will now be quoted.
e.g. <code class="literal">org.springframework.integration:type=MessageChannel,</code> <code class="literal">name="input#foo.myGroup.errors"</code>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="x51.-micrometer" href="#x51.-micrometer"></a>4.12&nbsp;Micrometer Support Changes</h2></div></div></div>

<p>It is now simpler to customize the standard Micrometer meters created by the framework.
See <a class="xref" href="#micrometer-integration" title="12.1.2&nbsp;Micrometer Integration">Section&nbsp;12.1.2, &#8220;Micrometer Integration&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="x51.-integration-graph" href="#x51.-integration-graph"></a>4.13&nbsp;Integration Graph Customization</h2></div></div></div>

<p>It is now possible to add additional properties to the <code class="literal">IntegrationNode</code> s via <code class="literal">Function&lt;NamedComponent, Map&lt;String, Object&gt;&gt; additionalPropertiesCallback</code> on the <code class="literal">IntegrationGraphServer</code>.
See <a class="xref" href="#integration-graph" title="12.8&nbsp;Integration Graph">Section&nbsp;12.8, &#8220;Integration Graph&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="x51.-global-properties" href="#x51.-global-properties"></a>4.14&nbsp;Integration Global Properties</h2></div></div></div>

<p>The Integration global properties (including defaults) can now be printed in the logs, when a <code class="literal">DEBUG</code> logic level is turned on for the <code class="literal">org.springframework.integration</code> category.
See <a class="xref" href="#global-properties" title="E.4&nbsp;Global Properties">Section&nbsp;E.4, &#8220;Global Properties&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="x51.-poller-annotation" href="#x51.-poller-annotation"></a>4.15&nbsp;The <code class="literal">receiveTimeout</code> for <code class="literal">@Poller</code></h2></div></div></div>

<p>The <code class="literal">@Poller</code> annotation now provides a <code class="literal">receiveTimeout</code> option for convenience.
See <a class="xref" href="#configuration-using-poller-annotation" title="E.5.1&nbsp;Using the @Poller Annotation">Section&nbsp;E.5.1, &#8220;Using the <code class="literal">@Poller</code> Annotation&#8221;</a> for more information.</p>
</div>
</div>
</div>
<div class="part"><div class="titlepage"><div><div><h1 class="title"><a name="spring-integration-introduction" href="#spring-integration-introduction"></a>Part&nbsp;III.&nbsp;Overview of Spring Integration Framework</h1></div></div></div>

<div class="partintro"><div></div>
<p>Spring Integration provides an extension of the Spring programming model to support the well known <a class="ulink" href="http://www.eaipatterns.com/" target="_top">Enterprise Integration Patterns</a>.
It enables lightweight messaging within Spring-based applications and supports integration with external systems through declarative adapters.
Those adapters provide a higher level of abstraction over Spring&#8217;s support for remoting, messaging, and scheduling.
Spring Integration&#8217;s primary goal is to provide a simple model for building enterprise integration solutions while maintaining the separation of concerns that is essential for producing maintainable, testable code.</p>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="overview" href="#overview"></a>5.&nbsp;Spring Integration Overview</h2></div></div></div>

<p>This chapter provides a high-level introduction to Spring Integration&#8217;s core concepts and components.
It includes some programming tips to help you make the most of Spring Integration.</p>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="overview-background" href="#overview-background"></a>5.1&nbsp;Background</h2></div></div></div>

<p>One of the key themes of the Spring Framework is Inversion of Control (IoC).
In its broadest sense, this means that the framework handles responsibilities on behalf of the components that are managed within its context.
The components themselves are simplified, because they are relieved of those responsibilities.
For example, dependency injection relieves the components of the responsibility of locating or creating their dependencies.
Likewise, aspect-oriented programming relieves business components of generic cross-cutting concerns by modularizing them into reusable aspects.
In each case, the end result is a system that is easier to test, understand, maintain, and extend.</p>
<p>Furthermore, the Spring framework and portfolio provide a comprehensive programming model for building enterprise applications.
Developers benefit from the consistency of this model and especially from the fact that it is based upon well established best practices, such as programming to interfaces and favoring composition over inheritance.
Spring&#8217;s simplified abstractions and powerful support libraries boost developer productivity while simultaneously increasing the level of testability and portability.</p>
<p>Spring Integration is motivated by these same goals and principles.
It extends the Spring programming model into the messaging domain and builds upon Spring&#8217;s existing enterprise integration support to provide an even higher level of abstraction.
It supports message-driven architectures where inversion of control applies to runtime concerns, such as when certain business logic should run and where the response should be sent.
It supports routing and transformation of messages so that different transports and different data formats can be integrated without impacting testability.
In other words, the messaging and integration concerns are handled by the framework.
Business components are further isolated from the infrastructure, and developers are relieved of complex integration responsibilities.</p>
<p>As an extension of the Spring programming model, Spring Integration provides a wide variety of configuration options, including annotations, XML with namespace support, XML with generic "<code class="literal">bean</code>" elements, and direct usage of the underlying API.
That API is based upon well defined strategy interfaces and non-invasive, delegating adapters.
Spring Integration&#8217;s design is inspired by the recognition of a strong affinity between common patterns within Spring and the well known patterns described in <a class="ulink" href="http://www.eaipatterns.com" target="_top"><span class="emphasis"><em>Enterprise Integration Patterns</em></span></a>, by Gregor Hohpe and Bobby Woolf (Addison Wesley, 2004).
Developers who have read that book should be immediately comfortable with the Spring Integration concepts and terminology.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="overview-goalsandprinciples" href="#overview-goalsandprinciples"></a>5.2&nbsp;Goals and Principles</h2></div></div></div>

<p>Spring Integration is motivated by the following goals:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Provide a simple model for implementing complex enterprise integration solutions.
</li><li class="listitem">
Facilitate asynchronous, message-driven behavior within a Spring-based application.
</li><li class="listitem">
Promote intuitive, incremental adoption for existing Spring users.
</li></ul></div>
<p>Spring Integration is guided by the following principles:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Components should be loosely coupled for modularity and testability.
</li><li class="listitem">
The framework should enforce separation of concerns between business logic and integration logic.
</li><li class="listitem">
Extension points should be abstract in nature (but within well-defined boundaries) to promote reuse and portability.
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="overview-components" href="#overview-components"></a>5.3&nbsp;Main Components</h2></div></div></div>

<p>From a vertical perspective, a layered architecture facilitates separation of concerns, and interface-based contracts between layers promote loose coupling.
Spring-based applications are typically designed this way, and the Spring framework and portfolio provide a strong foundation for following this best practice for the full stack of an enterprise application.
Message-driven architectures add a horizontal perspective, yet these same goals are still relevant.
Just as "<code class="literal">layered architecture</code>" is an extremely generic and abstract paradigm, messaging systems typically follow the similarly abstract "<code class="literal">pipes-and-filters</code>" model.
The "<code class="literal">filters</code>" represent any components capable of producing or consuming messages, and the "<code class="literal">pipes</code>" transport the messages between filters so that the components themselves remain loosely-coupled.
It is important to note that these two high-level paradigms are not mutually exclusive.
The underlying messaging infrastructure that supports the "<code class="literal">pipes</code>" should still be encapsulated in a layer whose contracts are defined as interfaces.
Likewise, the "<code class="literal">filters</code>" themselves should be managed within a layer that is logically above the application&#8217;s service layer, interacting with those services through interfaces in much the same way that a web tier would.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="overview-components-message" href="#overview-components-message"></a>5.3.1&nbsp;Message</h3></div></div></div>

<p>In Spring Integration, a message is a generic wrapper for any Java object combined with metadata used by the framework while handling that object.
It consists of a payload and headers.
The payload can be of any type, and the headers hold commonly required information such as ID, timestamp, correlation ID, and return address.
Headers are also used for passing values to and from connected transports.
For example, when creating a message from a received file, the file name may be stored in a header to be accessed by downstream components.
Likewise, if a message&#8217;s content is ultimately going to be sent by an outbound mail adapter, the various properties (to, from, cc, subject, and others) may be configured as message header values by an upstream component.
Developers can also store any arbitrary key-value pairs in the headers.</p>
<div class="figure"><a name="d5e468" href="#d5e468"></a><p class="title"><b>Figure&nbsp;5.1.&nbsp;Message</b></p><div class="figure-contents">

<div class="mediaobject" align="center"><img src="images/message.jpg" align="middle" alt="Message"></div>
</div></div><br class="figure-break">
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="overview-components-channel" href="#overview-components-channel"></a>5.3.2&nbsp;Message Channel</h3></div></div></div>

<p>A message channel represents the "<code class="literal">pipe</code>" of a pipes-and-filters architecture.
Producers send messages to a channel, and consumers receive messages from a channel.
The message channel therefore decouples the messaging components and also provides a convenient point for interception and monitoring of messages.</p>
<div class="figure"><a name="d5e479" href="#d5e479"></a><p class="title"><b>Figure&nbsp;5.2.&nbsp;Message Channel</b></p><div class="figure-contents">

<div class="mediaobject" align="center"><img src="images/channel.jpg" align="middle" alt="Message Channel"></div>
</div></div><br class="figure-break">
<p>A message channel may follow either point-to-point or publish-subscribe semantics.
With a point-to-point channel, no more than one consumer can receive each message sent to the channel.
Publish-subscribe channels, on the other hand, attempt to broadcast each message to all subscribers on the channel.
Spring Integration supports both of these models.</p>
<p>Whereas "<code class="literal">point-to-point</code>" and "publish-subscribe" define the two options for how many consumers ultimately receive each message, there is another important consideration: Should the channel buffer messages?
In Spring Integration, pollable channels are capable of buffering Messages within a queue.
The advantage of buffering is that it allows for throttling the inbound messages and thereby prevents overloading a consumer.
However, as the name suggests, this also adds some complexity, since a consumer can only receive the messages from such a channel if a poller is configured.
On the other hand, a consumer connected to a subscribable channel is simply message-driven.
<a class="xref" href="#channel-implementations" title="6.1.2&nbsp;Message Channel Implementations">Section&nbsp;6.1.2, &#8220;Message Channel Implementations&#8221;</a> has a detailed discussion of the variety of channel implementations available in Spring Integration.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="overview-components-endpoint" href="#overview-components-endpoint"></a>5.3.3&nbsp;Message Endpoint</h3></div></div></div>

<p>One of the primary goals of Spring Integration is to simplify the development of enterprise integration solutions through inversion of control.
This means that you should not have to implement consumers and producers directly, and you should not even have to build messages and invoke send or receive operations on a message channel.
Instead, you should be able to focus on your specific domain model with an implementation based on plain objects.
Then, by providing declarative configuration, you can "<code class="literal">connect</code>" your domain-specific code to the messaging infrastructure provided by Spring Integration.
The components responsible for these connections are message endpoints.
This does not mean that you should necessarily connect your existing application code directly.
Any real-world enterprise integration solution requires some amount of code focused upon integration concerns such as routing and transformation.
The important thing is to achieve separation of concerns between the integration logic and the business logic.
In other words, as with the Model-View-Controller (MVC) paradigm for web applications, the goal should be to provide a thin but dedicated layer that translates inbound requests into service layer invocations and then translates service layer return values into outbound replies.
The next section provides an overview of the message endpoint types that handle these responsibilities, and, in upcoming chapters, you can see how Spring Integration&#8217;s declarative configuration options provide a non-invasive way to use each of these.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="overview-endpoints" href="#overview-endpoints"></a>5.4&nbsp;Message Endpoints</h2></div></div></div>

<p>A Message Endpoint represents the "<code class="literal">filter</code>" of a pipes-and-filters architecture.
As mentioned earlier, the endpoint&#8217;s primary role is to connect application code to the messaging framework and to do so in a non-invasive manner.
In other words, the application code should ideally have no awareness of the message objects or the message channels.
This is similar to the role of a controller in the MVC paradigm.
Just as a controller handles HTTP requests, the message endpoint handles messages.
Just as controllers are mapped to URL patterns, message endpoints are mapped to message channels.
The goal is the same in both cases: isolate application code from the infrastructure.
These concepts and all of the patterns that follow are discussed at length in the <a class="ulink" href="http://www.eaipatterns.com" target="_top"><span class="emphasis"><em>Enterprise Integration Patterns</em></span></a> book.
Here, we provide only a high-level description of the main endpoint types supported by Spring Integration and the roles associated with those types.
The chapters that follow elaborate and provide sample code as well as configuration examples.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="overview-endpoints-transformer" href="#overview-endpoints-transformer"></a>5.4.1&nbsp;Message Transformer</h3></div></div></div>

<p>A message transformer is responsible for converting a message&#8217;s content or structure and returning the modified message.
Probably the most common type of transformer is one that converts the payload of the message from one format to another (such as
from XML to <code class="literal">java.lang.String</code>).
Similarly, a transformer can add, remove, or modify the message&#8217;s header values.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="overview-endpoints-filter" href="#overview-endpoints-filter"></a>5.4.2&nbsp;Message Filter</h3></div></div></div>

<p>A message filter determines whether a message should be passed to an output channel at all.
This simply requires a boolean test method that may check for a particular payload content type, a property value, the presence of a header, or other conditions.
If the message is accepted, it is sent to the output channel.
If not, it is dropped (or, for a more severe implementation, an <code class="literal">Exception</code> could be thrown).
Message filters are often used in conjunction with a publish-subscribe channel, where multiple consumers may receive the same message and use the criteria of the filter to narrow down the set of messages to be processed.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Be careful not to confuse the generic use of "<code class="literal">filter</code>" within the pipes-and-filters architectural pattern with this specific endpoint type that selectively narrows down the messages flowing between two channels.
The pipes-and-filters concept of a "<code class="literal">filter</code>" matches more closely with Spring Integration&#8217;s message endpoint: any component that can be connected to a message channel in order to send or receive messages.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="overview-endpoints-router" href="#overview-endpoints-router"></a>5.4.3&nbsp;Message Router</h3></div></div></div>

<p>A message router is responsible for deciding what channel or channels (if any) should receive the message next.
Typically, the decision is based upon the message&#8217;s content or the metadata available in the message headers.
A message router is often used as a dynamic alternative to a statically configured output channel on a service activator or other endpoint capable of sending reply messages.
Likewise, a message router provides a proactive alternative to the reactive message filters used by multiple subscribers, as described earlier.</p>
<div class="figure"><a name="d5e515" href="#d5e515"></a><p class="title"><b>Figure&nbsp;5.3.&nbsp;Message Router</b></p><div class="figure-contents">

<div class="mediaobject" align="center"><img src="images/router.jpg" align="middle" alt="Router"></div>
</div></div><br class="figure-break">
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="overview-endpoints-splitter" href="#overview-endpoints-splitter"></a>5.4.4&nbsp;Splitter</h3></div></div></div>

<p>A splitter is another type of message endpoint whose responsibility is to accept a message from its input channel, split that message into multiple messages, and send each of those to its output channel.
This is typically used for dividing a "<code class="literal">composite</code>" payload object into a group of messages containing the subdivided payloads.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="overview-endpoints-aggregator" href="#overview-endpoints-aggregator"></a>5.4.5&nbsp;Aggregator</h3></div></div></div>

<p>Basically a mirror-image of the splitter, the aggregator is a type of message endpoint that receives multiple messages and combines them into a single message.
In fact, aggregators are often downstream consumers in a pipeline that includes a splitter.
Technically, the aggregator is more complex than a splitter, because it is required to maintain state (the messages to be aggregated), to decide when the complete group of messages is available, and to timeout if necessary.
Furthermore, in case of a timeout, the aggregator needs to know whether to send the partial results, discard them, or send them to a separate channel.
Spring Integration provides a <code class="literal">CorrelationStrategy</code>, a <code class="literal">ReleaseStrategy</code>, and configurable settings for timeout, whether
to send partial results upon timeout, and a discard channel.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="overview-endpoints-service-activator" href="#overview-endpoints-service-activator"></a>5.4.6&nbsp;Service Activator</h3></div></div></div>

<p>A Service Activator is a generic endpoint for connecting a service instance to the messaging system.
The input message channel must be configured, and, if the service method to be invoked is capable of returning a value, an output message Channel may also be provided.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The output channel is optional, since each message may also provide its own <span class="emphasis"><em>Return Address</em></span> header.
This same rule applies for all consumer endpoints.</p>
</td></tr></table></div>
<p>The service activator invokes an operation on some service object to process the request message, extracting the request message&#8217;s payload and converting (if the method does not expect a message-typed parameter).
Whenever the service object&#8217;s method returns a value, that return value is likewise converted to a reply message if necessary (if it is not already a message type).
That reply message is sent to the output channel.
If no output channel has been configured, the reply is sent to the channel specified in the message&#8217;s "<code class="literal">return address</code>", if available.</p>
<p>A request-reply service activator endpoint connects a target object&#8217;s method to input and output Message Channels.</p>
<div class="figure"><a name="d5e540" href="#d5e540"></a><p class="title"><b>Figure&nbsp;5.4.&nbsp;Service Activator</b></p><div class="figure-contents">

<div class="mediaobject" align="center"><img src="images/handler-endpoint.jpg" align="middle" alt="handler endpoint"></div>
</div></div><br class="figure-break">
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>As discussed earlier, in <a class="link" href="#overview-components-channel" title="5.3.2&nbsp;Message Channel">Message Channel</a>, channels can be pollable or subscribable.
In the preceding diagram, this is depicted by the "<code class="literal">clock</code>" symbol and the solid arrow (poll) and the dotted arrow (subscribe).</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="overview-endpoints-channeladapter" href="#overview-endpoints-channeladapter"></a>5.4.7&nbsp;Channel Adapter</h3></div></div></div>

<p>A channel adapter is an endpoint that connects a message channel to some other system or transport.
Channel adapters may be either inbound or outbound.
Typically, the channel adapter does some mapping between the message and whatever object or resource is received from or sent to the other system (file, HTTP Request, JMS message, and others).
Depending on the transport, the channel adapter may also populate or extract message header values.
Spring Integration provides a number of channel adapters, which are described in upcoming chapters.</p>
<div class="figure"><a name="d5e554" href="#d5e554"></a><p class="title"><b>Figure&nbsp;5.5.&nbsp;An inbound channel adapter endpoint connects a source system to a <code class="literal">MessageChannel</code>.</b></p><div class="figure-contents">

<div class="mediaobject" align="center"><img src="images/source-endpoint.jpg" align="middle" alt="source endpoint"></div>
</div></div><br class="figure-break">
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Message sources can be pollable (for example, POP3) or message-driven_ (for example, IMAP Idle).
In the preceding diagram, this is depicted by the "<code class="literal">clock</code>" symbol and the solid arrow (poll) and the dotted arrow (message-driven).</p>
</td></tr></table></div>
<div class="figure"><a name="d5e565" href="#d5e565"></a><p class="title"><b>Figure&nbsp;5.6.&nbsp;An outbound channel adapter endpoint connects a <code class="literal">MessageChannel</code> to a target system.</b></p><div class="figure-contents">

<div class="mediaobject" align="center"><img src="images/target-endpoint.jpg" align="middle" alt="target endpoint"></div>
</div></div><br class="figure-break">
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>As discussed earlier in <a class="link" href="#overview-components-channel" title="5.3.2&nbsp;Message Channel">Message Channel</a>, channels can be pollable or subscribable.
In the preceding diagram, this is depicted by the "<code class="literal">clock</code>" symbol and the solid arrow (poll) and the dotted arrow (subscribe).</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="endpoint-bean-names" href="#endpoint-bean-names"></a>5.4.8&nbsp;Endpoint Bean Names</h3></div></div></div>

<p>Consuming endpoints (anything with an <code class="literal">inputChannel</code>) consist of two beans, the consumer and the message handler.
The consumer has a reference to the message handler and invokes it as messages arrive.</p>
<p>Consider the following XML example:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:service-activator</span> <span class="hl-attribute">id</span> = <span class="hl-value">"someService"</span> <span class="hl-attribute">...</span><span class="hl-tag"> /&gt;</span></pre>
</div>
<p>Given the preceding example, the bean names are as follows:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Consumer: <code class="literal">someService</code> (the <code class="literal">id</code>)
</li><li class="listitem">
Handler: <code class="literal">someService.handler</code>
</li></ul></div>
<p>When using Enterprise Integration Pattern (EIP) annotations, the names depend on several factors.
Consider the following example of an annotated POJO:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Component</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> SomeComponent {

    <em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = ...)</span></em>
    <span class="hl-keyword">public</span> String someMethod(...) {
        ...
    }

}</pre>
</div>
<p>Given the preceding example, the bean names are as follows:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Consumer: <code class="literal">someComponent.someMethod.serviceActivator</code>
</li><li class="listitem">
Handler: <code class="literal">someComponent.someMethod.serviceActivator.handler</code>
</li></ul></div>
<p>Starting with version 5.0.4, you can modify these names by using the <code class="literal">@EndpointId</code> annotation, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Component</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> SomeComponent {

    <em><span class="hl-annotation" style="color: gray">@EndpointId("someService")</span></em>
    <em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = ...)</span></em>
    <span class="hl-keyword">public</span> String someMethod(...) {
        ...
    }

}</pre>
</div>
<p>Given the preceding example, the bean names are as follows:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Consumer: <code class="literal">someService</code>
</li><li class="listitem">
Handler: <code class="literal">someService.handler</code>
</li></ul></div>
<p>The <code class="literal">@EndpointId</code> creates names as created by the <code class="literal">id</code> attribute with XML configuration.
Consider the following example of an annotated bean:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Configuratiom</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> SomeConfiguration {

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = ...)</span></em>
    <span class="hl-keyword">public</span> MessageHandler someHandler() {
        ...
    }

}</pre>
</div>
<p>Given the preceding example, the bean names are as follows:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Consumer: <code class="literal">someConfiguration.someHandler.serviceActivator</code>
</li><li class="listitem">
Handler: <code class="literal">someHandler</code> (the <code class="literal">@Bean</code> name)
</li></ul></div>
<p>Starting with version 5.0.4, you can modify these names by using the <code class="literal">@EndpointId</code> annotation, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Configuratiom</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> SomeConfiguration {

    <em><span class="hl-annotation" style="color: gray">@Bean("someService.handler")</span></em>             <a name="CO1-1" href="#CO1-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
    <em><span class="hl-annotation" style="color: gray">@EndpointId("someService")</span></em>               <a name="CO1-2" href="#CO1-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
    <em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = ...)</span></em>
    <span class="hl-keyword">public</span> MessageHandler someHandler() {
        ...
    }

}</pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO1-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Handler: <code class="literal">someService.handler</code> (the bean name)</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO1-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Consumer: <code class="literal">someService</code> (the endpoint ID)</p>
</td></tr></table></div>
</div>
<p>The <code class="literal">@EndpointId</code> annotation creates names as created by the <code class="literal">id</code> attribute with XML configuration, as long as you use the convention of appending <code class="literal">.handler</code> to the <code class="literal">@Bean</code> name.</p>
<p>There is one special case where a third bean is created: For architectural reasons, if a <code class="literal">MessageHandler</code> <code class="literal">@Bean</code> does not define an <code class="literal">AbstractReplyProducingMessageHandler</code>, the framework wraps the provided bean in a <code class="literal">ReplyProducingMessageHandlerWrapper</code>.
This wrapper supports request handler advice handling and emits the normal <span class="emphasis"><em>produced no reply</em></span> debug log messages.
Its bean name is the handler bean name plus <code class="literal">.wrapper</code> (when there is an <code class="literal">@EndpointId</code>&#8201;&#8212;&#8201;otherwise, it is the normal generated handler name).</p>
<p>Similarly <a class="link" href="#pollable-message-source" title="6.2.2&nbsp;Pollable Message Source">Pollable Message Sources</a> create two beans, a <code class="literal">SourcePollingChannelAdapter</code> (SPCA) and a <code class="literal">MessageSource</code>.</p>
<p>Consider the following XML configuration:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:inbound-channel-adapter</span> <span class="hl-attribute">id</span> = <span class="hl-value">"someAdapter"</span> <span class="hl-attribute">...</span><span class="hl-tag"> /&gt;</span></pre>
</div>
<p>Given the preceding XML configuration, the bean names are as follows:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
SPCA: <code class="literal">someAdapter</code> (the <code class="literal">id</code>)
</li><li class="listitem">
Handler: <code class="literal">someAdapter.source</code>
</li></ul></div>
<p>Consider the following Java configuration of a POJO to define an <code class="literal">@EndpointId</code>:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@EndpointId("someAdapter")</span></em>
<em><span class="hl-annotation" style="color: gray">@InboundChannelAdapter(channel = "channel3", poller = @Poller(fixedDelay = "5000"))</span></em>
<span class="hl-keyword">public</span> String pojoSource() {
    ...
}</pre>
</div>
<p>Given the preceding Java configuration example, the bean names are as follows:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
SPCA: <code class="literal">someAdapter</code>
</li><li class="listitem">
Handler: <code class="literal">someAdapter.source</code>
</li></ul></div>
<p>Consider the following Java configuration of a bean to define an <code class="literal">@EndpointID</code>:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean("someAdapter.source")</span></em>
<em><span class="hl-annotation" style="color: gray">@EndpointId("someAdapter")</span></em>
<em><span class="hl-annotation" style="color: gray">@InboundChannelAdapter(channel = "channel3", poller = @Poller(fixedDelay = "5000"))</span></em>
<span class="hl-keyword">public</span> MessageSource&lt;?&gt; source() {
    <span class="hl-keyword">return</span> () -&gt; {
        ...
    };
}</pre>
</div>
<p>Given the preceding example, the bean names are as follows:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
SPCA: <code class="literal">someAdapter</code>
</li><li class="listitem">
Handler: <code class="literal">someAdapter.source</code> (as long as you use the convention of appending <code class="literal">.source</code> to the <code class="literal">@Bean</code> name)
</li></ul></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="configuration-enable-integration" href="#configuration-enable-integration"></a>5.5&nbsp;Configuration and <code class="literal">@EnableIntegration</code></h2></div></div></div>

<p>Throughout this document, you can see references to XML namespace support for declaring elements in a Spring Integration flow.
This support is provided by a series of namespace parsers that generate appropriate bean definitions to implement a particular component.
For example, many endpoints consist of a <code class="literal">MessageHandler</code> bean and a <code class="literal">ConsumerEndpointFactoryBean</code> into which the handler and an input channel name are injected.</p>
<p>The first time a Spring Integration namespace element is encountered, the framework automatically declares a number of beans (a task scheduler, an implicit channel creator, and others) that are used to support the runtime environment.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Version 4.0 introduced the <code class="literal">@EnableIntegration</code> annotation, to allow the
registration of Spring Integration infrastructure beans (see the
<a class="ulink" href="http://docs.spring.io/spring-integration/docs/latest-ga/api/org/springframework/integration/config/EnableIntegration.html" target="_top">Javadoc</a>).
This annotation is required when only Java configuration is used&#8201;&#8212;&#8201;for example with Spring Boot or Spring Integration Messaging Annotation support and Spring Integration Java DSL with no XML integration configuration.</p>
</td></tr></table></div>
<p>The <code class="literal">@EnableIntegration</code> annotation is also useful when you have a parent context with no Spring Integration components
and two or more child contexts that use Spring Integration.
It lets these common components be declared once only, in the parent context.</p>
<p>The <code class="literal">@EnableIntegration</code> annotation registers many infrastructure components with the application context.
In particular, it:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Registers some built-in beans, such as <code class="literal">errorChannel</code> and its <code class="literal">LoggingHandler</code>, <code class="literal">taskScheduler</code> for pollers, <code class="literal">jsonPath</code> SpEL-function, and others.
</li><li class="listitem">
Adds several <code class="literal">BeanFactoryPostProcessor</code> instances to enhance the <code class="literal">BeanFactory</code> for global and default integration environment.
</li><li class="listitem">
Adds several <code class="literal">BeanPostProcessor</code> instances to enhance or convert and wrap particular beans for integration purposes.
</li><li class="listitem">
Adds annotation processors to parse messaging annotations and registers components for them with the application context.
</li></ul></div>
<p>The <code class="literal">@IntegrationComponentScan</code> annotation also permits classpath scanning.
This annotation plays a similar role as the standard Spring Framework <code class="literal">@ComponentScan</code> annotation, but it is restricted to components and annotations that are specific to Spring Integration, which the standard Spring Framework component scan mechanism cannot reach.
For an example, see <a class="xref" href="#messaging-gateway-annotation" title="10.4.6&nbsp;@MessagingGateway Annotation">Section&nbsp;10.4.6, &#8220;<code class="literal">@MessagingGateway</code> Annotation&#8221;</a>.</p>
<p>The <code class="literal">@EnablePublisher</code> annotation registers a <code class="literal">PublisherAnnotationBeanPostProcessor</code> bean and configures the <code class="literal">default-publisher-channel</code> for those <code class="literal">@Publisher</code> annotations that are provided without a <code class="literal">channel</code> attribute.
If more than one <code class="literal">@EnablePublisher</code> annotation is found, they must all have the same value for the default channel.
See <a class="xref" href="#publisher-annotation" title="B.1.1&nbsp;Annotation-driven Configuration with the @Publisher Annotation">Section&nbsp;B.1.1, &#8220;Annotation-driven Configuration with the <code class="literal">@Publisher</code> Annotation&#8221;</a> for more information.</p>
<p>The <code class="literal">@GlobalChannelInterceptor</code> annotation has been introduced to mark <code class="literal">ChannelInterceptor</code> beans for global channel interception.
This annotation is an analogue of the <code class="literal">&lt;int:channel-interceptor&gt;</code> XML element (see <a class="xref" href="#global-channel-configuration-interceptors" title="Global Channel Interceptor Configuration">the section called &#8220;Global Channel Interceptor Configuration&#8221;</a>).
<code class="literal">@GlobalChannelInterceptor</code> annotations can be placed at the class level (with a <code class="literal">@Component</code> stereotype annotation) or on <code class="literal">@Bean</code> methods within <code class="literal">@Configuration</code> classes.
In either case, the bean must implement <code class="literal">ChannelInterceptor</code>.</p>
<p>Starting with version 5.1, global channel interceptors apply to dynamically registered channels&#8201;&#8212;&#8201;such as beans that are initialized by using <code class="literal">beanFactory.initializeBean()</code> or through the <code class="literal">IntegrationFlowContext</code> when using the Java DSL.
Previously, interceptors were not applied when beans were created after the application context was refreshed.</p>
<p>The <code class="literal">@IntegrationConverter</code> annotation marks <code class="literal">Converter</code>, <code class="literal">GenericConverter</code>, or <code class="literal">ConverterFactory</code> beans as candidate converters for <code class="literal">integrationConversionService</code>.
This annotation is an analogue of the <code class="literal">&lt;int:converter&gt;</code> XML element (see <a class="xref" href="#payload-type-conversion" title="10.1.6&nbsp;Payload Type Conversion">Section&nbsp;10.1.6, &#8220;Payload Type Conversion&#8221;</a>).
You can place <code class="literal">@IntegrationConverter</code> annotations at the class level (with a <code class="literal">@Component</code> stereotype annotation) or on <code class="literal">@Bean</code> methods within <code class="literal">@Configuration</code> classes.</p>
<p>See <a class="xref" href="#annotations" title="E.5&nbsp;Annotation Support">Section&nbsp;E.5, &#8220;Annotation Support&#8221;</a> for more information about messaging mnnotations.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="programming-considerations" href="#programming-considerations"></a>5.6&nbsp;Programming Considerations</h2></div></div></div>

<p>You should use plain old java objects (POJOs) whenever possible and only expose the framework in your code when absolutely necessary.
See <a class="xref" href="#pojo-invocation" title="5.8&nbsp;POJO Method invocation">Section&nbsp;5.8, &#8220;POJO Method invocation&#8221;</a> for more information.</p>
<p>If you do expose the framework to your classes, there are some considerations that need to be taken into account, especially during application startup:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
If your component is <code class="literal">ApplicationContextAware</code>, you should generally not use the <code class="literal">ApplicationContext</code> in the <code class="literal">setApplicationContext()</code> method.
Instead, store a reference and defer such uses until later in the context lifecycle.
</li><li class="listitem">
If your component is an <code class="literal">InitializingBean</code> or uses <code class="literal">@PostConstruct</code> methods, do not send any messages from these initialization methods.
The application context is not yet initialized when these methods are called, and sending such messages is likely to fail.
If you need to send a messages during startup, implement <code class="literal">ApplicationListener</code> and wait for the <code class="literal">ContextRefreshedEvent</code>.
Alternatively, implement <code class="literal">SmartLifecycle</code>, put your bean in a late phase, and send the messages from the <code class="literal">start()</code> method.
</li></ul></div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="shaded" href="#shaded"></a>5.6.1&nbsp;Considerations When Using Packaged (for example, Shaded) Jars</h3></div></div></div>

<p>Spring Integration bootstraps certain features by using Spring Framework&#8217;s <code class="literal">SpringFactories</code> mechanism to load several <code class="literal">IntegrationConfigurationInitializer</code> classes.
This includes the <code class="literal">-core</code> jar as well as certain others, including <code class="literal">-http</code> and <code class="literal">-jmx</code>.
The information for this process is stored in a <code class="literal">META-INF/spring.factories</code> file in each jar.</p>
<p>Some developers prefer to repackage their application and all dependencies into a single jar by using well known tools, such as the <a class="ulink" href="https://maven.apache.org/plugins/maven-shade-plugin/" target="_top">Apache Maven Shade Plugin</a>.</p>
<p>By default, the shade plugin does not merge the <code class="literal">spring.factories</code> files when producing the shaded jar.</p>
<p>In addition to <code class="literal">spring.factories</code>, other <code class="literal">META-INF</code> files (<code class="literal">spring.handlers</code> and <code class="literal">spring.schemas</code>) are used for XML configuration.
These files also need to be merged.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p><a class="ulink" href="https://docs.spring.io/spring-boot/docs/current/reference/html/executable-jar.html" target="_top">Spring Boot&#8217;s executable jar mechanism</a> takes a different approach, in that it nests the jars, thus retaining each <code class="literal">spring.factories</code> file on the class path.
So, with a Spring Boot application, nothing more is needed if you use its default executable jar format.</p>
</td></tr></table></div>
<p>Even if you do not use Spring Boot, you can still use the tooling provided by Boot to enhance the shade plugin by adding transformers for the above mentioned files.</p>
<p>You may wish to consult the current <a class="ulink" href="https://github.com/spring-projects/spring-boot/blob/master/spring-boot-project/spring-boot-starters/spring-boot-starter-parent/pom.xml" target="_top">spring-boot-starter-parent pom</a> to see the current settings that boot uses.
The following example shows how to configure the plugin:</p>
<div class="example"><a name="d5e812" href="#d5e812"></a><p class="title"><b>Example&nbsp;5.1.&nbsp;pom.xml</b></p><div class="example-contents">

<pre class="programlisting">...
    <span class="hl-tag">&lt;plugins&gt;</span>
        <span class="hl-tag">&lt;plugin&gt;</span>
            <span class="hl-tag">&lt;groupId&gt;</span>org.apache.maven.plugins<span class="hl-tag">&lt;/groupId&gt;</span>
            <span class="hl-tag">&lt;artifactId&gt;</span>maven-shade-plugin<span class="hl-tag">&lt;/artifactId&gt;</span>
            <span class="hl-tag">&lt;configuration&gt;</span>
                <span class="hl-tag">&lt;keepDependenciesWithProvidedScope&gt;</span>true<span class="hl-tag">&lt;/keepDependenciesWithProvidedScope&gt;</span>
                <span class="hl-tag">&lt;createDependencyReducedPom&gt;</span>true<span class="hl-tag">&lt;/createDependencyReducedPom&gt;</span>
            <span class="hl-tag">&lt;/configuration&gt;</span>
            <span class="hl-tag">&lt;dependencies&gt;</span>
                <span class="hl-tag">&lt;dependency&gt;</span> <a name="CO2-1" href="#CO2-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
                    <span class="hl-tag">&lt;groupId&gt;</span>org.springframework.boot<span class="hl-tag">&lt;/groupId&gt;</span>
                    <span class="hl-tag">&lt;artifactId&gt;</span>spring-boot-maven-plugin<span class="hl-tag">&lt;/artifactId&gt;</span>
                    <span class="hl-tag">&lt;version&gt;</span>${spring.boot.version}<span class="hl-tag">&lt;/version&gt;</span>
                <span class="hl-tag">&lt;/dependency&gt;</span>
            <span class="hl-tag">&lt;/dependencies&gt;</span>
            <span class="hl-tag">&lt;executions&gt;</span>
                <span class="hl-tag">&lt;execution&gt;</span>
                    <span class="hl-tag">&lt;phase&gt;</span>package<span class="hl-tag">&lt;/phase&gt;</span>
                    <span class="hl-tag">&lt;goals&gt;</span>
                        <span class="hl-tag">&lt;goal&gt;</span>shade<span class="hl-tag">&lt;/goal&gt;</span>
                    <span class="hl-tag">&lt;/goals&gt;</span>
                    <span class="hl-tag">&lt;configuration&gt;</span>
                        <span class="hl-tag">&lt;transformers&gt;</span> <a name="CO2-2" href="#CO2-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
                            <span class="hl-tag">&lt;transformer</span>
                                <span class="hl-attribute">implementation</span>=<span class="hl-value">"org.apache.maven.plugins.shade.resource.AppendingTransformer"</span><span class="hl-tag">&gt;</span>
                                <span class="hl-tag">&lt;resource&gt;</span>META-INF/spring.handlers<span class="hl-tag">&lt;/resource&gt;</span>
                            <span class="hl-tag">&lt;/transformer&gt;</span>
                            <span class="hl-tag">&lt;transformer</span>
                                <span class="hl-attribute">implementation</span>=<span class="hl-value">"org.springframework.boot.maven.PropertiesMergingResourceTransformer"</span><span class="hl-tag">&gt;</span>
                                <span class="hl-tag">&lt;resource&gt;</span>META-INF/spring.factories<span class="hl-tag">&lt;/resource&gt;</span>
                            <span class="hl-tag">&lt;/transformer&gt;</span>
                            <span class="hl-tag">&lt;transformer</span>
                                <span class="hl-attribute">implementation</span>=<span class="hl-value">"org.apache.maven.plugins.shade.resource.AppendingTransformer"</span><span class="hl-tag">&gt;</span>
                                <span class="hl-tag">&lt;resource&gt;</span>META-INF/spring.schemas<span class="hl-tag">&lt;/resource&gt;</span>
                            <span class="hl-tag">&lt;/transformer&gt;</span>
                            <span class="hl-tag">&lt;transformer</span>
                                <span class="hl-attribute">implementation</span>=<span class="hl-value">"org.apache.maven.plugins.shade.resource.ServicesResourceTransformer"</span><span class="hl-tag"> /&gt;</span>
                        <span class="hl-tag">&lt;/transformers&gt;</span>
                    <span class="hl-tag">&lt;/configuration&gt;</span>
                <span class="hl-tag">&lt;/execution&gt;</span>
            <span class="hl-tag">&lt;/executions&gt;</span>
        <span class="hl-tag">&lt;/plugin&gt;</span>
    <span class="hl-tag">&lt;/plugins&gt;</span>
...</pre>
<p>Specifically,</p>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO2-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Add the <code class="literal">spring-boot-maven-plugin</code> as a dependency.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO2-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Configure the transformers.</p>
</td></tr></table></div>
</div></div><br class="example-break">
<p>You can add a property for <code class="literal">${spring.boot.version}</code> or use an explicit version.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="programming-tips" href="#programming-tips"></a>5.7&nbsp;Programming Tips and Tricks</h2></div></div></div>

<p>This section documents some of the ways to get the most from Spring Integration.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_xml_schemas" href="#_xml_schemas"></a>5.7.1&nbsp;XML Schemas</h3></div></div></div>

<p>When using XML configuration, to avoid getting false schema validation errors, you should use a "<code class="literal">Spring-aware</code>" IDE, such as the Spring Tool Suite (STS), Eclipse with the Spring IDE plugins, or IntelliJ IDEA.
These IDEs know how to resolve the correct XML schema from the classpath (by using the <code class="literal">META-INF/spring.schemas</code> file in the jars).
When using STS or Eclipse with the plugin, you must enable <code class="literal">Spring Project Nature</code> on the project.</p>
<p>The schemas hosted on the internet for certain legacy modules (those that existed in version 1.0) are the 1.0 versions for compatibility reasons.
If your IDE uses these schemas, you are likely to see false errors.</p>
<p>Each of these online schemas has a warning similar to the following:</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>This schema is for the 1.0 version of Spring Integration Core. We cannot update it to the current schema
because that will break any applications using 1.0.3 or lower. For subsequent versions, the unversioned
schema is resolved from the classpath and obtained from the jar.
Please refer to github:</p>
<p><a class="ulink" href="https://github.com/spring-projects/spring-integration/tree/master/spring-integration-core/src/main/resources/org/springframework/integration/config" target="_top">https://github.com/spring-projects/spring-integration/tree/master/spring-integration-core/src/main/resources/org/springframework/integration/config</a></p>
</td></tr></table></div>
<p>The affected modules are</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">core</code>  (<code class="literal">spring-integration.xsd</code>)
</li><li class="listitem">
<code class="literal">file</code>
</li><li class="listitem">
<code class="literal">http</code>
</li><li class="listitem">
<code class="literal">jms</code>
</li><li class="listitem">
<code class="literal">mail</code>
</li><li class="listitem">
<code class="literal">rmi</code>
</li><li class="listitem">
<code class="literal">security</code>
</li><li class="listitem">
<code class="literal">stream</code>
</li><li class="listitem">
<code class="literal">ws</code>
</li><li class="listitem">
<code class="literal">xml</code>
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_finding_class_names_for_java_and_dsl_configuration" href="#_finding_class_names_for_java_and_dsl_configuration"></a>5.7.2&nbsp;Finding Class Names for Java and DSL Configuration</h3></div></div></div>

<p>With XML configuration and Spring Integration Namespace support, the XML parsers hide how target beans are declared and wired together.
For Java configuration, it is important to understand the Framework API for target end-user applications.</p>
<p>The first-class citizens for EIP implementation are <code class="literal">Message</code>, <code class="literal">Channel</code>, and <code class="literal">Endpoint</code> (see <a class="xref" href="#overview-components" title="5.3&nbsp;Main Components">Section&nbsp;5.3, &#8220;Main Components&#8221;</a>, earlier in this chapter).
Their implementations (contracts) are:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">org.springframework.messaging.Message</code>: See <a class="xref" href="#message" title="7.&nbsp;Message">Chapter&nbsp;7, <i>Message</i></a>;
</li><li class="listitem">
<code class="literal">org.springframework.messaging.MessageChannel</code>: See <a class="xref" href="#channel" title="6.1&nbsp;Message Channels">Section&nbsp;6.1, &#8220;Message Channels&#8221;</a>;
</li><li class="listitem">
<code class="literal">org.springframework.integration.endpoint.AbstractEndpoint</code>: See <a class="xref" href="#polling-consumer" title="6.2&nbsp;Poller">Section&nbsp;6.2, &#8220;Poller&#8221;</a>.
</li></ul></div>
<p>The first two are simple enough to understand how to implement, configure, and use.
The last one deserves more attention</p>
<p>The <code class="literal">AbstractEndpoint</code> is widely used throughout the Spring Framework for different component implementations.
Its main implementations are:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">EventDrivenConsumer</code>, used when we subscribe to a <code class="literal">SubscribableChannel</code> to listen for messages.
</li><li class="listitem">
<code class="literal">PollingConsumer</code>, used when we poll for messages from a <code class="literal">PollableChannel</code>.
</li></ul></div>
<p>When you use messaging annotations or the Java DSL, you need ot worry about these components, because the Framework automatically produces them with appropriate annotations and <code class="literal">BeanPostProcessor</code> implementations.
When building components manually, you should use the <code class="literal">ConsumerEndpointFactoryBean</code> to help determine the target <code class="literal">AbstractEndpoint</code> consumer implementation to create, based on the provided <code class="literal">inputChannel</code> property.</p>
<p>On the other hand, the <code class="literal">ConsumerEndpointFactoryBean</code> delegates to an another first class citizen in the Framework:
<code class="literal">org.springframework.messaging.MessageHandler</code>.
The goal of the implementation of this interface is to handle the message consumed by the endpoint from the channel.
All EIP components in Spring Integration are <code class="literal">MessageHandler</code> implementations (for example, <code class="literal">AggregatingMessageHandler</code>, <code class="literal">MessageTransformingHandler</code>, <code class="literal">AbstractMessageSplitter</code>, and others).
The target protocol outbound adapters (<code class="literal">FileWritingMessageHandler</code>, <code class="literal">HttpRequestExecutingMessageHandler</code>, <code class="literal">AbstractMqttMessageHandler</code>, and others) are also <code class="literal">MessageHandler</code> implementations.
When you develop Spring Integration applications with Java configuration, you should look into the Spring Integration module to find an appropriate <code class="literal">MessageHandler</code> implementation to use for the <code class="literal">@ServiceActivator</code>\ configuration.
For example, to send an XMPP message (see <a class="xref" href="#xmpp" title="39.&nbsp;XMPP Support">Chapter&nbsp;39, <i>XMPP Support</i></a>) you should configure something like the following:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "input")</span></em>
<span class="hl-keyword">public</span> MessageHandler sendChatMessageHandler(XMPPConnection xmppConnection) {
    ChatMessageSendingMessageHandler handler = <span class="hl-keyword">new</span> ChatMessageSendingMessageHandler(xmppConnection);

    DefaultXmppHeaderMapper xmppHeaderMapper = <span class="hl-keyword">new</span> DefaultXmppHeaderMapper();
    xmppHeaderMapper.setRequestHeaderNames(<span class="hl-string">"*"</span>);
    handler.setHeaderMapper(xmppHeaderMapper);

    <span class="hl-keyword">return</span> handler;
}</pre>
</div>
<p>The <code class="literal">MessageHandler</code> implementations represent the outbound and processing part of the message flow.</p>
<p>The inbound message flow side has its own components, which are divided into polling and listening behaviors.
The listening (message-driven) components are simple and typically require only one target class implementation to be ready to
produce messages.
Listening components can be one-way <code class="literal">MessageProducerSupport</code> implementations, (such as <code class="literal">AbstractMqttMessageDrivenChannelAdapter</code> and <code class="literal">ImapIdleChannelAdapter</code>) or request-reply  <code class="literal">MessagingGatewaySupport</code> implementations (such as <code class="literal">AmqpInboundGateway</code> and <code class="literal">AbstractWebServiceInboundGateway</code>).</p>
<p>Polling inbound endpoints are for those protocols that do not provide a listener API or are not intended for
such a behavior, including any file based protocol (such as FTP), any data bases (RDBMS or NoSQL), and others.</p>
<p>These inbound endpoints consist of two components: the poller configuration, to initiate the polling task periodically,
and a message source class to read data from the target protocol and produce a message for the downstream integration flow.
The first class for the poller configuration is a <code class="literal">SourcePollingChannelAdapter</code>.
It is one more <code class="literal">AbstractEndpoint</code> implementation, but especially for polling to initiate an integration flow.
Typically, with the messaging annotations or Java DSL, you should not worry about this class.
The Framework produces a bean for it, based on the <code class="literal">@InboundChannelAdapter</code> configuration or a Java DSL builder spec.</p>
<p>Message source components are more important for the target application development, and they all implement the <code class="literal">MessageSource</code> interface (for example, <code class="literal">MongoDbMessageSource</code> and <code class="literal">AbstractTwitterMessageSource</code>).
With that in mind, our config for reading data from an RDBMS table with JDBC could resemble the following:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<em><span class="hl-annotation" style="color: gray">@InboundChannelAdapter(value = "fooChannel", poller = @Poller(fixedDelay="5000"))</span></em>
<span class="hl-keyword">public</span> MessageSource&lt;?&gt; storedProc(DataSource dataSource) {
    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> JdbcPollingChannelAdapter(dataSource, <span class="hl-string">"SELECT * FROM foo where status = 0"</span>);
}</pre>
</div>
<p>You can find all the required inbound and outbound classes for the target protocols in the particular Spring Integration module (in most cases, in the respective package).
For example, the <code class="literal">spring-integration-websocket</code> adapters are:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">o.s.i.websocket.inbound.WebSocketInboundChannelAdapter</code>: Implements <code class="literal">MessageProducerSupport</code> to listen for frames on the socket and produce message to the channel.
</li><li class="listitem">
<code class="literal">o.s.i.websocket.outbound.WebSocketOutboundMessageHandler</code>: The one-way <code class="literal">AbstractMessageHandler</code> implementation to convert incoming messages to the appropriate frame and send over websocket.
</li></ul></div>
<p>If you are familiar with Spring Integration XML configuration, starting with version 4.3, we provide information in the
XSD element definitions about which target classes are used to declare beans for the adapter or gateway, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;xsd:element</span> <span class="hl-attribute">name</span>=<span class="hl-value">"outbound-async-gateway"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;xsd:annotation&gt;</span>
		<span class="hl-tag">&lt;xsd:documentation&gt;</span>
Configures a Consumer Endpoint for the 'o.s.i.amqp.outbound.AsyncAmqpOutboundGateway'
that will publish an AMQP Message to the provided Exchange and expect a reply Message.
The sending thread returns immediately; the reply is sent asynchronously; uses 'AsyncRabbitTemplate.sendAndReceive()'.
       <span class="hl-tag">&lt;/xsd:documentation&gt;</span>
	<span class="hl-tag">&lt;/xsd:annotation&gt;</span></pre>
</div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="pojo-invocation" href="#pojo-invocation"></a>5.8&nbsp;POJO Method invocation</h2></div></div></div>

<p>As discussed in <a class="xref" href="#programming-considerations" title="5.6&nbsp;Programming Considerations">Section&nbsp;5.6, &#8220;Programming Considerations&#8221;</a>, we recommend using a POJO programming style, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@ServiceActivator</span></em>
<span class="hl-keyword">public</span> String myService(String payload) { ... }</pre>
</div>
<p>In this case, the framework extracts a <code class="literal">String</code> payload, invokes your method, and wraps the result in a message to send to the next component in the flow (the original headers are copied to the new message).
In fact, if you use XML configuration, you do not even need the <code class="literal">@ServiceActivator</code> annotation, as the following paired examples show:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:service-activator</span> <span class="hl-attribute">...</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"myPojo"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"myService"</span><span class="hl-tag"> /&gt;</span></pre>
<pre class="programlisting"><span class="hl-keyword">public</span> String myService(String payload) { ... }</pre>
</div>
<p>You can omit the <code class="literal">method</code> attribute as long as there is no ambiguity in the public methods on the class.</p>
<p>You can also obtain header information in your POJO methods, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@ServiceActivator</span></em>
<span class="hl-keyword">public</span> String myService(<em><span class="hl-annotation" style="color: gray">@Payload</span></em> String payload, <em><span class="hl-annotation" style="color: gray">@Header("foo")</span></em> String fooHeader) { ... }</pre>
</div>
<p>You can also dereference properties on the message, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@ServiceActivator</span></em>
<span class="hl-keyword">public</span> String myService(<em><span class="hl-annotation" style="color: gray">@Payload("payload.foo")</span></em> String foo, <em><span class="hl-annotation" style="color: gray">@Header("bar.baz")</span></em> String barbaz) { ... }</pre>
</div>
<p>Because various POJO method invocations are available, versions prior to 5.0 used SpEL (Spring Expression Language) to invoke the POJO methods.
SpEL (even interpreted) is usually "<code class="literal">fast enough</code>" for these operations, when compared to the actual work usually done in the methods.
However, starting with version 5.0, the <code class="literal">org.springframework.messaging.handler.invocation.InvocableHandlerMethod</code> is used by default whenever possible.
This technique is usually faster to execute than interpreted SpEL and is consistent with other Spring messaging projects.
The <code class="literal">InvocableHandlerMethod</code> is similar to the technique used to invoke controller methods in Spring MVC.
There are certain methods that are still always invoked when using SpEL.
Examples include annotated parameters with dereferenced properties, as discussed earlier.
This is because SpEL has the capability to navigate a property path.</p>
<p>There may be some other corner cases that we have not considered that also do not work with <code class="literal">InvocableHandlerMethod</code> instances.
For this reason, we automatically fall back to using SpEL in those cases.</p>
<p>If you wish, you can also set up your POJO method such that it always uses SpEL, with the <code class="literal">UseSpelInvoker</code> annotation, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@UseSpelInvoker(compilerMode = "IMMEDIATE")</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> bar(String bar) { ... }</pre>
</div>
<p>If the <code class="literal">compilerMode</code> property is omitted, the <code class="literal">spring.expression.compiler.mode</code> system property determines the compiler mode.
See <a class="ulink" href="http://docs.spring.io/spring-framework/docs/current/spring-framework-reference/html/expressions.html#expressions-spel-compilation" target="_top">SpEL compilation</a> for more information about compiled SpEL.</p>
</div>
</div>
</div>
<div class="part"><div class="titlepage"><div><div><h1 class="title"><a name="spring-integration-core-messaging" href="#spring-integration-core-messaging"></a>Part&nbsp;IV.&nbsp;Core Messaging</h1></div></div></div>

<div class="partintro"><div></div>
<p>This section covers all aspects of the core messaging API in Spring Integration.
It covers messages, message channels, and message endpoints.
It also covers many of the enterprise integration patterns, such as filter, router, transformer, service activator , splitter, and aggregator.
The section also contains material about system management, including the control bus and message history support.</p>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="messaging-channels-section" href="#messaging-channels-section"></a>6.&nbsp;Messaging Channels</h2></div></div></div>

<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="channel" href="#channel"></a>6.1&nbsp;Message Channels</h2></div></div></div>

<p>While the <code class="literal">Message</code> plays the crucial role of encapsulating data, it is the <code class="literal">MessageChannel</code> that decouples message producers from message consumers.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="channel-interfaces" href="#channel-interfaces"></a>6.1.1&nbsp;The MessageChannel Interface</h3></div></div></div>

<p>Spring Integration&#8217;s top-level <code class="literal">MessageChannel</code> interface is defined as follows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> MessageChannel {

    <span class="hl-keyword">boolean</span> send(Message message);

    <span class="hl-keyword">boolean</span> send(Message message, <span class="hl-keyword">long</span> timeout);
}</pre>
</div>
<p>When sending a message, the return value is <code class="literal">true</code> if the message is sent successfully.
If the send call times out or is interrupted, it returns <code class="literal">false</code>.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="channel-interfaces-pollablechannel" href="#channel-interfaces-pollablechannel"></a><code class="literal">PollableChannel</code></h4></div></div></div>

<p>Since message channels may or may not buffer messages (as discussed in the <a class="xref" href="#overview" title="5.&nbsp;Spring Integration Overview">Chapter&nbsp;5, <i>Spring Integration Overview</i></a>), two sub-interfaces define the buffering (pollable) and non-buffering (subscribable) channel behavior.
The following listing shows the definition of the <code class="literal">PollableChannel</code> interface:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> PollableChannel <span class="hl-keyword">extends</span> MessageChannel {

    Message&lt;?&gt; receive();

    Message&lt;?&gt; receive(<span class="hl-keyword">long</span> timeout);

}</pre>
</div>
<p>As with the send methods, when receiving a message, the return value is null in the case of a timeout or interrupt.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="channel-interfaces-subscribablechannel" href="#channel-interfaces-subscribablechannel"></a><code class="literal">SubscribableChannel</code></h4></div></div></div>

<p>The <code class="literal">SubscribableChannel</code> base interface is implemented by channels that send messages directly to their subscribed <code class="literal">MessageHandler</code> instances.
Therefore, they do not provide receive methods for polling.
Instead, they define methods for managing those subscribers.
The following listing shows the definition of the <code class="literal">SubscribableChannel</code> interface:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> SubscribableChannel <span class="hl-keyword">extends</span> MessageChannel {

    <span class="hl-keyword">boolean</span> subscribe(MessageHandler handler);

    <span class="hl-keyword">boolean</span> unsubscribe(MessageHandler handler);

}</pre>
</div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="channel-implementations" href="#channel-implementations"></a>6.1.2&nbsp;Message Channel Implementations</h3></div></div></div>

<p>Spring Integration provides several different message channel implementations.
The following sections briefly describe each one.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="channel-implementations-publishsubscribechannel" href="#channel-implementations-publishsubscribechannel"></a><code class="literal">PublishSubscribeChannel</code></h4></div></div></div>

<p>The <code class="literal">PublishSubscribeChannel</code> implementation broadcasts any <code class="literal">Message</code> sent to it to all of its subscribed handlers.
This is most often used for sending event messages, whose primary role is notification (as opposed to document messages, which are generally intended to be processed by a single handler).
Note that the <code class="literal">PublishSubscribeChannel</code> is intended for sending only.
Since it broadcasts to its subscribers directly when its <code class="literal">send(Message)</code> method is invoked, consumers cannot poll for messages (it does not implement <code class="literal">PollableChannel</code> and therefore has no <code class="literal">receive()</code> method).
Instead, any subscriber must itself be a <code class="literal">MessageHandler</code>, and the subscriber&#8217;s <code class="literal">handleMessage(Message)</code> method is invoked in turn.</p>
<p>Prior to version 3.0, invoking the <code class="literal">send</code> method on a <code class="literal">PublishSubscribeChannel</code> that had no subscribers returned <code class="literal">false</code>.
When used in conjunction with a <code class="literal">MessagingTemplate</code>, a <code class="literal">MessageDeliveryException</code> was thrown.
Starting with version 3.0, the behavior has changed such that a <code class="literal">send</code> is always considered successful if at least the minimum subscribers are present (and successfully handle the message).
This behavior can be modified by setting the <code class="literal">minSubscribers</code> property, which defaults to <code class="literal">0</code>.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>If you use a <code class="literal">TaskExecutor</code>, only the presence of the correct number of subscribers is used for this determination, because the actual handling of the message is performed asynchronously.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="channel-implementations-queuechannel" href="#channel-implementations-queuechannel"></a><code class="literal">QueueChannel</code></h4></div></div></div>

<p>The <code class="literal">QueueChannel</code> implementation wraps a queue.
Unlike the <code class="literal">PublishSubscribeChannel</code>, the <code class="literal">QueueChannel</code> has point-to-point semantics.
In other words, even if the channel has multiple consumers, only one of them should receive any <code class="literal">Message</code> sent to that channel.
It provides a default no-argument constructor (providing an essentially unbounded capacity of <code class="literal">Integer.MAX_VALUE</code>) as well as a constructor that accepts the queue capacity, as the following listing shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> QueueChannel(<span class="hl-keyword">int</span> capacity)</pre>
</div>
<p>A channel that has not reached its capacity limit storeS messages in its internal queue, and the <code class="literal">send()</code> method returns immediately, even if no receiver is ready to handle the message.
If the queue has reached capacity, the sender blocks until room is available.
Alternatively, if you use the send call that accepts a timeout, the queue blocks until either room is available or the timeout period elapses, whichever occurs first.
Similarly, a <code class="literal">receive</code> call returns immediately if a message is available on the queue, but, if the queue is empty, then a receive call may block until either a message is available or the timeout elapses.
In either case, it is possible to force an immediate return regardless of the queue&#8217;s state by passing a timeout value of 0.
Note, however, that calls to the no-arg versions of <code class="literal">send()</code> and <code class="literal">receive()</code> block indefinitely.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="channel-implementations-prioritychannel" href="#channel-implementations-prioritychannel"></a><code class="literal">PriorityChannel</code></h4></div></div></div>

<p>Whereas the <code class="literal">QueueChannel</code> enforces first-in-first-out (FIFO) ordering, the <code class="literal">PriorityChannel</code> is an alternative implementation that allows for messages to be ordered within the channel based upon a priority.
By default, the priority is determined by the <code class="literal">priority</code> header within each message.
However, for custom priority determination logic, a comparator of type <code class="literal">Comparator&lt;Message&lt;?&gt;&gt;</code> can be provided to the <code class="literal">PriorityChannel</code> constructor.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="channel-implementations-rendezvouschannel" href="#channel-implementations-rendezvouschannel"></a><code class="literal">RendezvousChannel</code></h4></div></div></div>

<p>The <code class="literal">RendezvousChannel</code> enables a "<code class="literal">direct-handoff</code>" scenario, wherein a sender blocks until another party invokes the channel&#8217;s <code class="literal">receive()</code> method.
The other party blocks until the sender sends the message.
Internally, this implementation is quite similar to the <code class="literal">QueueChannel</code>, except that it uses a <code class="literal">SynchronousQueue</code> (a zero-capacity implementation of <code class="literal">BlockingQueue</code>).
This works well in situations where the sender and receiver operate in different threads, but asynchronously dropping the message in a queue is not appropriate.
In other words, with a <code class="literal">RendezvousChannel</code>, the sender knows that some receiver has accepted the message, whereas with a <code class="literal">QueueChannel</code>, the message would have been stored to the internal queue and potentially never received.</p>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>Keep in mind that all of these queue-based channels are storing messages in-memory only by default.
When persistence is required, you can either provide a <span class="emphasis"><em>message-store</em></span> attribute within the <span class="emphasis"><em>queue</em></span> element to reference a persistent <code class="literal">MessageStore</code> implementation or you can replace the local channel with one that is backed by a persistent broker, such as a JMS-backed channel or channel adapter.
The latter option lets you take advantage of any JMS provider&#8217;s implementation for message persistence, as discussed in <a class="xref" href="#jms" title="23.&nbsp;JMS Support">Chapter&nbsp;23, <i>JMS Support</i></a>.
However, when buffering in a queue is not necessary, the simplest approach is to rely upon the <code class="literal">DirectChannel</code>, discussed in the next section.</p>
</td></tr></table></div>
<p>The <code class="literal">RendezvousChannel</code> is also useful for implementing request-reply operations.
The sender can create a temporary, anonymous instance of <code class="literal">RendezvousChannel</code>, which it then sets as the <span class="emphasis"><em>replyChannel</em></span> header when building a <code class="literal">Message</code>.
After sending that <code class="literal">Message</code>, the sender can immediately call <code class="literal">receive</code> (optionally providing a timeout value) in order to block while waiting for a reply <code class="literal">Message</code>.
This is very similar to the implementation used internally by many of Spring Integration&#8217;s request-reply components.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="channel-implementations-directchannel" href="#channel-implementations-directchannel"></a><code class="literal">DirectChannel</code></h4></div></div></div>

<p>The <code class="literal">DirectChannel</code> has point-to-point semantics but otherwise is more similar to the <code class="literal">PublishSubscribeChannel</code> than any of the queue-based channel implementations described earlier.
It implements the <code class="literal">SubscribableChannel</code> interface instead of the <code class="literal">PollableChannel</code> interface, so it dispatches messages directly to a subscriber.
As a point-to-point channel, however, it differs from the <code class="literal">PublishSubscribeChannel</code> in that it sends each <code class="literal">Message</code> to a single subscribed <code class="literal">MessageHandler</code>.</p>
<p>In addition to being the simplest point-to-point channel option, one of its most important features is that it enables a single thread to perform the operations on "<code class="literal">both sides</code>" of the channel.
For example, if a handler subscribes to a <code class="literal">DirectChannel</code>, then sending a <code class="literal">Message</code> to that channel triggers invocation of that handler&#8217;s <code class="literal">handleMessage(Message)</code> method directly in the sender&#8217;s thread, before the <code class="literal">send()</code> method invocation can return.</p>
<p>The key motivation for providing a channel implementation with this behavior is to support transactions that must span across the channel while still benefiting from the abstraction and loose coupling that the channel provides.
If the send call is invoked within the scope of a transaction, the outcome of the handler&#8217;s invocation (for example,
updating a database record) plays a role in determining the ultimate result of that transaction (commit or rollback).</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Since the <code class="literal">DirectChannel</code> is the simplest option and does not add any additional overhead that would be required for scheduling and managing the threads of a poller, it is the default channel type within Spring Integration.
The general idea is to define the channels for an application, consider which of those need to provide buffering or to throttle input, and modify those to be queue-based <code class="literal">PollableChannels</code>.
Likewise, if a channel needs to broadcast messages, it should not be a <code class="literal">DirectChannel</code> but rather a <code class="literal">PublishSubscribeChannel</code>.
Later, we show how each of these channels can be configured.</p>
</td></tr></table></div>
<p>The <code class="literal">DirectChannel</code> internally delegates to a message dispatcher to invoke its subscribed message handlers, and that dispatcher can have a load-balancing strategy exposed by <code class="literal">load-balancer</code> or <code class="literal">load-balancer-ref</code> attributes (mutually exclusive).
The load balancing strategy is used by the message dispatcher to help determine how messages are distributed amongst message handlers when multiple message handlers subscribe to the same channel.
As a convenience, the <code class="literal">load-balancer</code> attribute exposes an enumeration of values pointing to pre-existing implementations of <code class="literal">LoadBalancingStrategy</code>.
<code class="literal">round-robin</code> (load-balances across the handlers in rotation) and <code class="literal">none</code> (for the cases where one wants to explicitly disable load balancing) are the only available values.
Other strategy implementations may be added in future versions.
However, since version 3.0, you can provide your own implementation of the <code class="literal">LoadBalancingStrategy</code> and inject it by using the <code class="literal">load-balancer-ref</code> attribute, which should point to a bean that implements <code class="literal">LoadBalancingStrategy</code>, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"lbRefChannel"</span><span class="hl-tag">&gt;</span>
  <span class="hl-tag">&lt;int:dispatcher</span> <span class="hl-attribute">load-balancer-ref</span>=<span class="hl-value">"lb"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:channel&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"lb"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"foo.bar.SampleLoadBalancingStrategy"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>Note that the <code class="literal">load-balancer</code> and <code class="literal">load-balancer-ref</code> attributes are mutually exclusive.</p>
<p>The load-balancing also works in conjunction with a boolean <code class="literal">failover</code> property.
If the "<code class="literal">failover</code>" value is true (the default), the dispatcher falls back to any subsequent handlers (as necessary) when preceding handlers throw exceptions.
The order is determined by an optional order value defined on the handlers themselves or, if no such value exists, the order in which the handlers subscribed.</p>
<p>If a certain situation requires that the dispatcher always try to invoke the first handler and then fall back in the same fixed order sequence every time an error occurs, no load-balancing strategy should be provided.
In other words, the dispatcher still supports the <code class="literal">failover</code> boolean property even when no load-balancing is enabled.
Without load-balancing, however, the invocation of handlers always begins with the first, according to their order.
For example, this approach works well when there is a clear definition of primary, secondary, tertiary, and so on.
When using the namespace support, the <code class="literal">order</code> attribute on any endpoint determines the order.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Keep in mind that load-balancing and <code class="literal">failover</code> apply only when a channel has more than one subscribed message handler.
When using the namespace support, this means that more than one endpoint shares the same channel reference defined in the <code class="literal">input-channel</code> attribute.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="executor-channel" href="#executor-channel"></a><code class="literal">ExecutorChannel</code></h4></div></div></div>

<p>The <code class="literal">ExecutorChannel</code> is a point-to-point channel that supports the same dispatcher configuration as <code class="literal">DirectChannel</code> (load-balancing strategy and the <code class="literal">failover</code> boolean property).
The key difference between these two dispatching channel types is that the <code class="literal">ExecutorChannel</code> delegates to an instance of <code class="literal">TaskExecutor</code> to perform the dispatch.
This means that the send method typically does not block, but it also means that the handler invocation may not occur in the sender&#8217;s thread.
It therefore does not support transactions that span the sender and receiving handler.</p>
<div class="caution" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Caution"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Caution]" src="images/caution.png"></td><th align="left">Caution</th></tr><tr><td align="left" valign="top">
<p>The sender can sometimes block.
For example, when using a <code class="literal">TaskExecutor</code> with a rejection policy that throttles the client (such as the <code class="literal">ThreadPoolExecutor.CallerRunsPolicy</code>), the sender&#8217;s thread can execute the method any time the thread pool is at its maximum capacity and the executor&#8217;s work queue is full.
Since that situation would only occur in a non-predictable way, you should not rely upon it for transactions.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="channel-implementations-threadlocalchannel" href="#channel-implementations-threadlocalchannel"></a>Scoped Channel</h4></div></div></div>

<p>Spring Integration 1.0 provided a <code class="literal">ThreadLocalChannel</code> implementation, but that has been removed as of 2.0.
Now the more general way to handle the same requirement is to add a <code class="literal">scope</code> attribute to a channel.
The value of the attribute can be the name of a scope that is available within the context.
For example, in a web environment, certain scopes are available, and any custom scope implementations can be registered with the context.
The following example shows a thread-local scope being applied to a channel, including the registration of the scope itself:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"threadScopedChannel"</span> <span class="hl-attribute">scope</span>=<span class="hl-value">"thread"</span><span class="hl-tag">&gt;</span>
     <span class="hl-tag">&lt;int:queue /&gt;</span>
<span class="hl-tag">&lt;/int:channel&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.beans.factory.config.CustomScopeConfigurer"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"scopes"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;map&gt;</span>
            <span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"thread"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"org.springframework.context.support.SimpleThreadScope"</span><span class="hl-tag"> /&gt;</span>
        <span class="hl-tag">&lt;/map&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
</div>
<p>The channel defined in the previous example also delegates to a queue internally, but the channel is bound to the current thread, so the contents of the queue are similarly bound.
That way, the thread that sends to the channel can later receive those same messages, but no other thread would be able to access them.
While thread-scoped channels are rarely needed, they can be useful in situations where <code class="literal">DirectChannel</code> instances are being used to enforce a single thread of operation but any reply messages should be sent to a "<code class="literal">terminal</code>" channel.
If that terminal channel is thread-scoped, the original sending thread can collect its replies from the terminal channel.</p>
<p>Now, since any channel can be scoped, you can define your own scopes in addition to thread-Local.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="channel-interceptors" href="#channel-interceptors"></a>6.1.3&nbsp;Channel Interceptors</h3></div></div></div>

<p>One of the advantages of a messaging architecture is the ability to provide common behavior and capture meaningful information about the messages passing through the system in a non-invasive way.
Since the <code class="literal">Message</code> instances are sent to and received from <code class="literal">MessageChannel</code> instances, those channels provide an opportunity for intercepting the send and receive operations.
The <code class="literal">ChannelInterceptor</code> strategy interface, shown in the following listing, provides methods for each of those operations:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> ChannelInterceptor {

    Message&lt;?&gt; preSend(Message&lt;?&gt; message, MessageChannel channel);

    <span class="hl-keyword">void</span> postSend(Message&lt;?&gt; message, MessageChannel channel, <span class="hl-keyword">boolean</span> sent);

    <span class="hl-keyword">void</span> afterSendCompletion(Message&lt;?&gt; message, MessageChannel channel, <span class="hl-keyword">boolean</span> sent, Exception ex);

    <span class="hl-keyword">boolean</span> preReceive(MessageChannel channel);

    Message&lt;?&gt; postReceive(Message&lt;?&gt; message, MessageChannel channel);

    <span class="hl-keyword">void</span> afterReceiveCompletion(Message&lt;?&gt; message, MessageChannel channel, Exception ex);
}</pre>
</div>
<p>After implementing the interface, registering the interceptor with a channel is just a matter of making the following call:</p>
<div class="informalexample">
<pre class="programlisting">channel.addInterceptor(someChannelInterceptor);</pre>
</div>
<p>The methods that return a <code class="literal">Message</code> instance can be used for transforming the <code class="literal">Message</code> or can return <span class="emphasis"><em>null</em></span> to prevent further processing (of course, any of the methods can throw a <code class="literal">RuntimeException</code>).
Also, the <code class="literal">preReceive</code> method can return <code class="literal">false</code> to prevent the receive operation from proceeding.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Keep in mind that <code class="literal">receive()</code> calls are only relevant for <code class="literal">PollableChannels</code>.
In fact, the <code class="literal">SubscribableChannel</code> interface does not even define a <code class="literal">receive()</code> method.
The reason for this is that when a <code class="literal">Message</code> is sent to a <code class="literal">SubscribableChannel</code>, it is sent directly to zero or more subscribers, depending on the type of channel (for example,
a <code class="literal">PublishSubscribeChannel</code> sends to all of its subscribers).
Therefore, the <code class="literal">preReceive(...)</code>, <code class="literal">postReceive(...)</code>, and <code class="literal">afterReceiveCompletion(...)</code> interceptor methods are invoked only when the interceptor is applied to a <code class="literal">PollableChannel</code>.</p>
</td></tr></table></div>
<p>Spring Integration also provides an implementation of the <a class="ulink" href="http://eaipatterns.com/WireTap.html" target="_top">Wire Tap</a> pattern.
It is a simple interceptor that sends the <code class="literal">Message</code> to another channel without otherwise altering the existing flow.
It can be very useful for debugging and monitoring.
An example is shown in <a class="xref" href="#channel-wiretap" title="Wire Tap">the section called &#8220;Wire Tap&#8221;</a>.</p>
<p>Because it is rarely necessary to implement all of the interceptor methods, the interface provides no-op methods (methods returning <code class="literal">void</code> method have no code, the <code class="literal">Message</code>-returning methods return the <code class="literal">Message</code> as-is, and the <code class="literal">boolean</code> method returns <code class="literal">true</code>).</p>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>The order of invocation for the interceptor methods depends on the type of channel.
As described earlier, the queue-based channels are the only ones where the receive method is intercepted in the first place.
Additionally, the relationship between send and receive interception depends on the timing of the separate sender and receiver threads.
For example, if a receiver is already blocked while waiting for a message, the order could be as follows: <code class="literal">preSend</code>, <code class="literal">preReceive</code>, <code class="literal">postReceive</code>, <code class="literal">postSend</code>.
However, if a receiver polls after the sender has placed a message on the channel and has already returned, the order would be as follows: <code class="literal">preSend</code>, <code class="literal">postSend</code> (some-time-elapses), <code class="literal">preReceive</code>, <code class="literal">postReceive</code>.
The time that elapses in such a case depends on a number of factors and is therefore generally unpredictable (in fact, the receive may never happen).
The type of queue also plays a role (for example, rendezvous versus priority).
In short, you cannot rely on the order beyond the fact that <code class="literal">preSend</code> precedes <code class="literal">postSend</code> and <code class="literal">preReceive</code> precedes <code class="literal">postReceive</code>.</p>
</td></tr></table></div>
<p>Starting with Spring Framework 4.1 and Spring Integration 4.1, the <code class="literal">ChannelInterceptor</code> provides new methods: <code class="literal">afterSendCompletion()</code> and <code class="literal">afterReceiveCompletion()</code>.
They are invoked after <code class="literal">send()' and 'receive()</code> calls, regardless of any exception that is raised, which allow for resource cleanup.
Note that the channel invokes these methods on the <code class="literal">ChannelInterceptor</code> list in the reverse order of the initial <code class="literal">preSend()</code> and <code class="literal">preReceive()</code> calls.</p>
<p>Starting with version 5.1, global channel interceptors now apply to dynamically registered channels - such as through beans that are initialized by using <code class="literal">beanFactory.initializeBean()</code> or <code class="literal">IntegrationFlowContext</code> when using the Java DSL.
Previously, interceptors were not applied when beans were created after the application context was refreshed.</p>
<p>Also, starting with version 5.1, <code class="literal">ChannelInterceptor.postReceive()</code> is no longer called when no message is received; it is no longer necessary to check for a <code class="literal">null</code> <code class="literal">Message&lt;?&gt;</code>.
Previously, the method was called.
If you have an interceptor that relies on the previous behavior, implement <code class="literal">afterReceiveCompleted()</code> instead, since that method is invoked, regardless of whether a message is received or not.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="channel-template" href="#channel-template"></a>6.1.4&nbsp;<code class="literal">MessagingTemplate</code></h3></div></div></div>

<p>When the endpoints and their various configuration options are introduced, Spring Integration provides a foundation for messaging components that enables non-invasive invocation of your application code from the messaging system.
However, it is sometimes necessary to invoke the messaging system from your application code.
For convenience when implementing such use cases, Spring Integration provides a <code class="literal">MessagingTemplate</code> that supports a variety of operations across the message channels, including request and reply scenarios.
For example, it is possible to send a request and wait for a reply, as follows:</p>
<div class="informalexample">
<pre class="programlisting">MessagingTemplate template = <span class="hl-keyword">new</span> MessagingTemplate();

Message reply = template.sendAndReceive(someChannel, <span class="hl-keyword">new</span> GenericMessage(<span class="hl-string">"test"</span>));</pre>
</div>
<p>In the preceding example, a temporary anonymous channel would be created internally by the template.
The <span class="emphasis"><em>sendTimeout</em></span> and <span class="emphasis"><em>receiveTimeout</em></span> properties may also be set on the template, and other exchange types are also supported.
The following listing shows the signatures for such methods:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">boolean</span> send(<span class="hl-keyword">final</span> MessageChannel channel, <span class="hl-keyword">final</span> Message&lt;?&gt; message) { ...
}

<span class="hl-keyword">public</span> Message&lt;?&gt; sendAndReceive(<span class="hl-keyword">final</span> MessageChannel channel, <span class="hl-keyword">final</span> Message&lt;?&gt; request) { ...
}

<span class="hl-keyword">public</span> Message&lt;?&gt; receive(<span class="hl-keyword">final</span> PollableChannel&lt;?&gt; channel) { ...
}</pre>
</div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>A less invasive approach that lets you invoke simple interfaces with payload or header values instead of <code class="literal">Message</code> instances is described in <a class="xref" href="#gateway-proxy" title="10.4.1&nbsp;Enter the GatewayProxyFactoryBean">Section&nbsp;10.4.1, &#8220;Enter the <code class="literal">GatewayProxyFactoryBean</code>&#8221;</a>.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="channel-configuration" href="#channel-configuration"></a>6.1.5&nbsp;Configuring Message Channels</h3></div></div></div>

<p>To create a message channel instance, you can use the &lt;channel/&gt; element, as follows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"exampleChannel"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>The default channel type is point-to-point.
To create a publish-subscribe channel, use the <code class="literal">&lt;publish-subscribe-channel/&gt;</code> element, as follows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:publish-subscribe-channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"exampleChannel"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>When you use the <code class="literal">&lt;channel/&gt;</code> element without any sub-elements, it creates a <code class="literal">DirectChannel</code> instance (a <code class="literal">SubscribableChannel</code>).</p>
<p>However, you can alternatively provide a variety of <code class="literal">&lt;queue/&gt;</code> sub-elements to create any of the pollable channel types (as described in <a class="xref" href="#channel-implementations" title="6.1.2&nbsp;Message Channel Implementations">Section&nbsp;6.1.2, &#8220;Message Channel Implementations&#8221;</a>).
The following sections shows examples of each channel type.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="channel-configuration-directchannel" href="#channel-configuration-directchannel"></a><code class="literal">DirectChannel</code> Configuration</h4></div></div></div>

<p>As mentioned earlier, <code class="literal">DirectChannel</code> is the default type.
The following listing shows who to define one in XML:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"directChannel"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>A default channel has a round-robin load-balancer and also has failover enabled (see <a class="xref" href="#channel-implementations-directchannel" title="DirectChannel">the section called &#8220;<code class="literal">DirectChannel</code>&#8221;</a> for more detail).
To disable one or both of these, add a <code class="literal">&lt;dispatcher/&gt;</code> sub-element and configure the attributes as follows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"failFastChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:dispatcher</span> <span class="hl-attribute">failover</span>=<span class="hl-value">"false"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/channel&gt;</span>

<span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"channelWithFixedOrderSequenceFailover"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:dispatcher</span> <span class="hl-attribute">load-balancer</span>=<span class="hl-value">"none"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:channel&gt;</span></pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="channel-datatype-channel" href="#channel-datatype-channel"></a>Datatype Channel Configuration</h4></div></div></div>

<p>Sometimes, a consumer can process only a particular type of payload, forcing you to ensure the payload type of the input messages.
The first thing that comes to mind may be to use a message filter.
However, all that message filter can do is filter out messages that are not compliant with the requirements of the consumer.
Another way would be to use a content-based router and route messages with non-compliant data-types to specific transformers to enforce transformation and conversion to the required data type.
This would work, but a simpler way to accomplish the same thing is to apply the <a class="ulink" href="http://www.eaipatterns.com/DatatypeChannel.html" target="_top">Datatype Channel</a> pattern.
You can use separate datatype channels for each specific payload data type.</p>
<p>To create a datatype channel that accepts only messages that contain a certain payload type, provide the data type&#8217;s fully-qualified class name in the channel element&#8217;s <code class="literal">datatype</code> attribute, as the following example shows:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"numberChannel"</span> <span class="hl-attribute">datatype</span>=<span class="hl-value">"java.lang.Number"</span><span class="hl-tag">/&gt;</span></pre>
<p>Note that the type check passes for any type that is assignable to the channel&#8217;s datatype.
In other words, the <code class="literal">numberChannel</code> in the preceding example would accept messages whose payload is <code class="literal">java.lang.Integer</code> or <code class="literal">java.lang.Double</code>.
Multiple types can be provided as a comma-delimited list, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"stringOrNumberChannel"</span> <span class="hl-attribute">datatype</span>=<span class="hl-value">"java.lang.String,java.lang.Number"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>So the <span class="emphasis"><em>numberChannel</em></span> in the preceding example accepts only messages with a data type of <code class="literal">java.lang.Number</code>.
But what happens if the payload of the message is not of the required type? It depends on whether you have defined a bean named <code class="literal">integrationConversionService</code> that is an instance of Spring&#8217;s <a class="ulink" href="http://static.springsource.org/spring/docs/current/spring-framework-reference/html/validation.html#core-convert-ConversionService-API" target="_top">Conversion Service</a>.
If not, then an <code class="literal">Exception</code> would be thrown immediately.
However, if you have defined an <code class="literal">integrationConversionService</code> bean, it is used in an attempt to convert the message&#8217;s payload to the acceptable type.</p>
<p>You can even register custom converters.
For example, suppose you send a message with a <code class="literal">String</code> payload to the <span class="emphasis"><em>numberChannel</em></span> we configured above.
You might handle the message as follows:</p>
<pre class="programlisting">MessageChannel inChannel = context.getBean(<span class="hl-string">"numberChannel"</span>, MessageChannel.<span class="hl-keyword">class</span>);
inChannel.send(<span class="hl-keyword">new</span> GenericMessage&lt;String&gt;(<span class="hl-string">"5"</span>));</pre>
<p>Typically this would be a perfectly legal operation.
However, since we use Datatype Channel, the result of such operation would generate an exception similar to the following:</p>
<div class="informalexample">
<pre class="screen">Exception in thread "main" org.springframework.integration.MessageDeliveryException:
Channel 'numberChannel'
expected one of the following datataypes [class java.lang.Number],
but received [class java.lang.String]
&#8230;</pre>
</div>
<p>The exception happens because we require the payload type to be a <code class="literal">Number</code>, but we sent a <code class="literal">String</code>.
So we need something to convert a <code class="literal">String</code> to a <code class="literal">Number</code>.
For that, we can implement a converter similar to the following example:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">class</span> StringToIntegerConverter <span class="hl-keyword">implements</span> Converter&lt;String, Integer&gt; {
    <span class="hl-keyword">public</span> Integer convert(String source) {
        <span class="hl-keyword">return</span> Integer.parseInt(source);
    }
}</pre>
</div>
<p>Then we can register it as a converter with the Integration Conversion Service, as the following example shows:</p>
<pre class="programlisting">&lt;<span class="hl-keyword">int</span>:converter ref=<span class="hl-string">"strToInt"</span>/&gt;

&lt;bean id=<span class="hl-string">"strToInt"</span> <span class="hl-keyword">class</span>=<span class="hl-string">"org.springframework.integration.util.Demo.StringToIntegerConverter"</span>/&gt;</pre>
<p>When the <span class="emphasis"><em>converter</em></span> element is parsed, it creates the <code class="literal">integrationConversionService</code> bean if one is not already defined.
With that converter in place, the <code class="literal">send</code> operation would now be successful, because the datatype channel uses that converter to convert the <code class="literal">String</code> payload to an <code class="literal">Integer</code>.</p>
<p>For more information regarding payload type conversion, see <a class="xref" href="#payload-type-conversion" title="10.1.6&nbsp;Payload Type Conversion">Section&nbsp;10.1.6, &#8220;Payload Type Conversion&#8221;</a>.</p>
<p>Beginning with version 4.0, the <code class="literal">integrationConversionService</code> is invoked by the <code class="literal">DefaultDatatypeChannelMessageConverter</code>, which looks up the conversion service in the application context.
To use a different conversion technique, you can specify the <code class="literal">message-converter</code> attribute on the channel.
This must be a reference to a <code class="literal">MessageConverter</code> implementation.
Only the <code class="literal">fromMessage</code> method is used.
It provides the converter with access to the message headers (in case the conversion might need information from the headers, such as <code class="literal">content-type</code>).
The method can return only the converted payload or a full <code class="literal">Message</code> object.
If the latter, the converter must be careful to copy all the headers from the inbound message.</p>
<p>Alternatively, you can declare a <code class="literal">&lt;bean/&gt;</code> of type <code class="literal">MessageConverter</code> with an ID of <code class="literal">datatypeChannelMessageConverter</code>, and that converter is used by all channels with a <code class="literal">datatype</code>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="channel-configuration-queuechannel" href="#channel-configuration-queuechannel"></a><code class="literal">QueueChannel</code> Configuration</h4></div></div></div>

<p>To create a <code class="literal">QueueChannel</code>, use the <code class="literal">&lt;queue/&gt;</code> sub-element.
You may specify the channel&#8217;s capacity as follows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"queueChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;queue</span> <span class="hl-attribute">capacity</span>=<span class="hl-value">"25"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:channel&gt;</span></pre>
</div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>If you do not provide a value for the <span class="emphasis"><em>capacity</em></span> attribute on this <code class="literal">&lt;queue/&gt;</code> sub-element, the resulting queue is unbounded.
To avoid issues such as running out of memory, we highly recommend that you set an explicit value for a bounded queue.</p>
</td></tr></table></div>
<div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="_persistent_literal_queuechannel_literal_configuration" href="#_persistent_literal_queuechannel_literal_configuration"></a>Persistent <code class="literal">QueueChannel</code> Configuration</h5></div></div></div>

<p>Since a <code class="literal">QueueChannel</code> provides the capability to buffer messages but does so in-memory only by default, it also introduces a possibility that messages could be lost in the event of a system failure.
To mitigate this risk, a <code class="literal">QueueChannel</code> may be backed by a persistent implementation of the <code class="literal">MessageGroupStore</code> strategy interface.
For more details on <code class="literal">MessageGroupStore</code> and <code class="literal">MessageStore</code>, see <a class="xref" href="#message-store" title="12.4&nbsp;Message Store">Section&nbsp;12.4, &#8220;Message Store&#8221;</a>.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>The <code class="literal">capacity</code> attribute is not allowed when the <code class="literal">message-store</code> attribute is used.</p>
</td></tr></table></div>
<p>When a <code class="literal">QueueChannel</code> receives a <code class="literal">Message</code>, it adds the message to the message store.
When a <code class="literal">Message</code> is polled from a <code class="literal">QueueChannel</code>, it is removed from the message store.</p>
<p>By default, a <code class="literal">QueueChannel</code> stores its messages in an in-memory queue, which can lead to the lost message scenario mentioned earlier.
However, Spring Integration provides persistent stores, such as the <code class="literal">JdbcChannelMessageStore</code>.</p>
<p>You can configure a message store for any <code class="literal">QueueChannel</code> by adding the <code class="literal">message-store</code> attribute, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"dbBackedChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:queue</span> <span class="hl-attribute">message-store</span>=<span class="hl-value">"channelStore"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:channel&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"channelStore"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.jdbc.store.JdbcChannelMessageStore"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"dataSource"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"dataSource"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"channelMessageStoreQueryProvider"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"queryProvider"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
</div>
<p>The Spring Integration JDBC module also provides a schema Data Definition Language (DDL) for a number of popular databases.
These schemas are located in the org.springframework.integration.jdbc.store.channel package of that module (<code class="literal">spring-integration-jdbc</code>).</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>One important feature is that, with any transactional persistent store (such as <code class="literal">JdbcChannelMessageStore</code>), as long as the poller has a transaction configured, a message removed from the store can be permanently removed only if the transaction completes successfully.
Otherwise the transaction rolls back, and the <code class="literal">Message</code> is not lost.</p>
</td></tr></table></div>
<p>Many other implementations of the message store are available as the growing number of Spring projects related to "<code class="literal">NoSQL</code>" data stores come to provide underlying support for these stores.
You can also provide your own implementation of the <code class="literal">MessageGroupStore</code> interface if you cannot find one that meets your particular needs.</p>
<p>Since version 4.0, we recommend that <code class="literal">QueueChannel</code> instances be configured to use a <code class="literal">ChannelMessageStore</code>, if possible.
These are generally optimized for this use, as compared to a general message store.
If the <code class="literal">ChannelMessageStore</code> is a <code class="literal">ChannelPriorityMessageStore</code>, the messages are received in FIFO within priority order.
The notion of priority is determined by the message store implementation.
For example, the following example shows the Java configuration for the <a class="xref" href="#mongodb-priority-channel-message-store" title="25.2.1&nbsp;MongoDB Channel Message Store">Section&nbsp;25.2.1, &#8220;MongoDB Channel Message Store&#8221;</a>:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> BasicMessageGroupStore mongoDbChannelMessageStore(MongoDbFactory mongoDbFactory) {
    MongoDbChannelMessageStore store = <span class="hl-keyword">new</span> MongoDbChannelMessageStore(mongoDbFactory);
    store.setPriorityEnabled(true);
    <span class="hl-keyword">return</span> store;
}

<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> PollableChannel priorityQueue(BasicMessageGroupStore mongoDbChannelMessageStore) {
    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> PriorityChannel(<span class="hl-keyword">new</span> MessageGroupQueue(mongoDbChannelMessageStore, <span class="hl-string">"priorityQueue"</span>));
}</pre>
</div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Pay attention to the <code class="literal">MessageGroupQueue</code> class.
That is a <code class="literal">BlockingQueue</code> implementation to use the <code class="literal">MessageGroupStore</code> operations.</p>
</td></tr></table></div>
<p>The same implementation with Java DSL might look like the following example:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> IntegrationFlow priorityFlow(PriorityCapableChannelMessageStore mongoDbChannelMessageStore) {
    <span class="hl-keyword">return</span> IntegrationFlows.from((Channels c) -&gt;
            c.priority(<span class="hl-string">"priorityChannel"</span>, mongoDbChannelMessageStore, <span class="hl-string">"priorityGroup"</span>))
            ....
            .get();
}</pre>
<p>Another option to customize the <code class="literal">QueueChannel</code> environment is provided by the <code class="literal">ref</code> attribute of the <code class="literal">&lt;int:queue&gt;</code> sub-element or its particular constructor.
This attribute supplies the reference to any <code class="literal">java.util.Queue</code> implementation.
For example, a Hazelcast distributed <a class="ulink" href="https://hazelcast.com/use-cases/imdg/imdg-messaging/" target="_top"><code class="literal">IQueue</code></a> can be configured as follows:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> HazelcastInstance hazelcastInstance() {
    <span class="hl-keyword">return</span> Hazelcast.newHazelcastInstance(<span class="hl-keyword">new</span> Config()
                                           .setProperty(<span class="hl-string">"hazelcast.logging.type"</span>, <span class="hl-string">"log4j"</span>));
}

<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> PollableChannel distributedQueue() {
    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> QueueChannel(hazelcastInstance()
                              .getQueue(<span class="hl-string">"springIntegrationQueue"</span>));
}</pre>
</div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="channel-configuration-pubsubchannel" href="#channel-configuration-pubsubchannel"></a><code class="literal">PublishSubscribeChannel</code> Configuration</h4></div></div></div>

<p>To create a <code class="literal">PublishSubscribeChannel</code>, use the &lt;publish-subscribe-channel/&gt; element.
When using this element, you can also specify the <code class="literal">task-executor</code> used for publishing messages (if none is specified, it publishes in the sender&#8217;s thread), as follows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:publish-subscribe-channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"pubsubChannel"</span> <span class="hl-attribute">task-executor</span>=<span class="hl-value">"someExecutor"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>If you provide a resequencer or aggregator downstream from a <code class="literal">PublishSubscribeChannel</code>, you can set the <span class="emphasis"><em>apply-sequence</em></span> property on the channel to <code class="literal">true</code>.
Doing so indicates that the channel should set the <code class="literal">sequence-size</code> and <code class="literal">sequence-number</code> message headers as well as the correlation ID prior to passing along the messages.
For example, if there are five subscribers, the <code class="literal">sequence-size</code> would be set to <code class="literal">5</code>, and the messages would have <code class="literal">sequence-number</code> header values ranging from <code class="literal">1</code> to <code class="literal">5</code>.</p>
<p>Along with the <code class="literal">Executor</code>, you can also configure an <code class="literal">ErrorHandler</code>.
By default, the <code class="literal">PublishSubscribeChannel</code> uses a <code class="literal">MessagePublishingErrorHandler</code> implementation to send an error to the <code class="literal">MessageChannel</code> from the <code class="literal">errorChannel</code> header or into the global <code class="literal">errorChannel</code> instance.
If an <code class="literal">Executor</code> is not configured, the <code class="literal">ErrorHandler</code> is ignored and exceptions are thrown directly to the caller&#8217;s thread.</p>
<p>If you provide a <code class="literal">Resequencer</code> or <code class="literal">Aggregator</code> downstream from a <code class="literal">PublishSubscribeChannel</code>, you can set the <span class="emphasis"><em>apply-sequence</em></span> property on the channel to <code class="literal">true</code>.
Doing so indicates that the channel should set the sequence-size and sequence-number message headers as well as the correlation ID prior to passing along the messages.
For example, if there are five subscribers, the sequence-size would be set to <code class="literal">5</code>, and the messages would have sequence-number header values ranging from <code class="literal">1</code> to <code class="literal">5</code>.</p>
<p>The following example shows how to set the <code class="literal">apply-sequence</code> header to <code class="literal">true</code>:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:publish-subscribe-channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"pubsubChannel"</span> <span class="hl-attribute">apply-sequence</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The <code class="literal">apply-sequence</code> value is <code class="literal">false</code> by default so that a publish-subscribe channel can send the exact same message instances to multiple outbound channels.
Since Spring Integration enforces immutability of the payload and header references, when the flag is set to <code class="literal">true</code>, the channel creates new <code class="literal">Message</code> instances with the same payload reference but different header values.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="channel-configuration-executorchannel" href="#channel-configuration-executorchannel"></a><code class="literal">ExecutorChannel</code></h4></div></div></div>

<p>To create an <code class="literal">ExecutorChannel</code>, add the <code class="literal">&lt;dispatcher&gt;</code> sub-element with a <code class="literal">task-executor</code> attribute.
The attribute&#8217;s value can reference any <code class="literal">TaskExecutor</code> within the context.
For example, doing so enables configuration of a thread pool for dispatching messages to subscribed handlers.
As mentioned earlier, doing so breaks the single-threaded execution context between sender and receiver so that any active transaction context is not shared by the invocation of the handler (that is, the handler may throw an <code class="literal">Exception</code>, but the <code class="literal">send</code> invocation has already returned successfully).
The following example shows how to use the <code class="literal">dispatcher</code> element and specify an executor in the <code class="literal">task-executor</code> attribute:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"executorChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:dispatcher</span> <span class="hl-attribute">task-executor</span>=<span class="hl-value">"someExecutor"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:channel&gt;</span></pre>
</div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The <code class="literal">load-balancer</code> and <code class="literal">failover</code> options are also both available on the &lt;dispatcher/&gt; sub-element, as described earlier in <a class="xref" href="#channel-configuration-directchannel" title="DirectChannel Configuration">the section called &#8220;<code class="literal">DirectChannel</code> Configuration&#8221;</a>.
The same defaults apply.
Consequently, the channel has a round-robin load-balancing strategy with failover enabled unless explicit configuration is provided for one or both of those attributes, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"executorChannelWithoutFailover"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:dispatcher</span> <span class="hl-attribute">task-executor</span>=<span class="hl-value">"someExecutor"</span> <span class="hl-attribute">failover</span>=<span class="hl-value">"false"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:channel&gt;</span></pre>
</div>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="channel-configuration-prioritychannel" href="#channel-configuration-prioritychannel"></a><code class="literal">PriorityChannel</code> Configuration</h4></div></div></div>

<p>To create a <code class="literal">PriorityChannel</code>, use the <code class="literal">&lt;priority-queue/&gt;</code> sub-element, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"priorityChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:priority-queue</span> <span class="hl-attribute">capacity</span>=<span class="hl-value">"20"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:channel&gt;</span></pre>
</div>
<p>By default, the channel consults the <code class="literal">priority</code> header of the message.
However, you can instead provide a custom <code class="literal">Comparator</code> reference.
Also, note that the <code class="literal">PriorityChannel</code> (like the other types) does support the <code class="literal">datatype</code> attribute.
As with the <code class="literal">QueueChannel</code>, it also supports a <code class="literal">capacity</code> attribute.
The following example demonstrates all of these:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"priorityChannel"</span> <span class="hl-attribute">datatype</span>=<span class="hl-value">"example.Widget"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:priority-queue</span> <span class="hl-attribute">comparator</span>=<span class="hl-value">"widgetComparator"</span>
                    <span class="hl-attribute">capacity</span>=<span class="hl-value">"10"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:channel&gt;</span></pre>
</div>
<p>Since version 4.0, the <code class="literal">priority-channel</code> child element supports the <code class="literal">message-store</code> option (<code class="literal">comparator</code> and <code class="literal">capacity</code> are not allowed in that case).
The message store must be a <code class="literal">PriorityCapableChannelMessageStore</code>.
Implementations of the <code class="literal">PriorityCapableChannelMessageStore</code> are currently provided for <code class="literal">Redis</code>, <code class="literal">JDBC</code>, and <code class="literal">MongoDB</code>.
See <a class="xref" href="#channel-configuration-queuechannel" title="QueueChannel Configuration">the section called &#8220;<code class="literal">QueueChannel</code> Configuration&#8221;</a> and <a class="xref" href="#message-store" title="12.4&nbsp;Message Store">Section&nbsp;12.4, &#8220;Message Store&#8221;</a> for more information.
You can find sample configuration in <a class="xref" href="#jdbc-message-store-channels" title="21.4.3&nbsp;Backing Message Channels">Section&nbsp;21.4.3, &#8220;Backing Message Channels&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="channel-configuration-rendezvouschannel" href="#channel-configuration-rendezvouschannel"></a><code class="literal">RendezvousChannel</code> Configuration</h4></div></div></div>

<p>A <code class="literal">RendezvousChannel</code> is created when the queue sub-element is a <code class="literal">&lt;rendezvous-queue&gt;</code>.
It does not provide any additional configuration options to those described earlier, and its queue does not accept any capacity value, since it is a zero-capacity direct handoff queue.
The following example shows how to declare a <code class="literal">RendezvousChannel</code>:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"rendezvousChannel"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int:rendezvous-queue/&gt;</span>
<span class="hl-tag">&lt;/int:channel&gt;</span></pre>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="channel-configuration-threadlocalchannel" href="#channel-configuration-threadlocalchannel"></a>Scoped Channel Configuration</h4></div></div></div>

<p>Any channel can be configured with a <code class="literal">scope</code> attribute, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"threadLocalChannel"</span> <span class="hl-attribute">scope</span>=<span class="hl-value">"thread"</span><span class="hl-tag">/&gt;</span></pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="channel-configuration-interceptors" href="#channel-configuration-interceptors"></a>Channel Interceptor Configuration</h4></div></div></div>

<p>Message channels may also have interceptors, as described in <a class="xref" href="#channel-interceptors" title="6.1.3&nbsp;Channel Interceptors">Section&nbsp;6.1.3, &#8220;Channel Interceptors&#8221;</a>.
The <code class="literal">&lt;interceptors/&gt;</code> sub-element can be added to a <code class="literal">&lt;channel/&gt;</code> (or the more specific element types).
You can provide the <code class="literal">ref</code> attribute to reference any Spring-managed object that implements the <code class="literal">ChannelInterceptor</code> interface, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"exampleChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:interceptors&gt;</span>
        <span class="hl-tag">&lt;ref</span> <span class="hl-attribute">bean</span>=<span class="hl-value">"trafficMonitoringInterceptor"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/int:interceptors&gt;</span>
<span class="hl-tag">&lt;/int:channel&gt;</span></pre>
</div>
<p>In general, we recommend defining the interceptor implementations in a separate location, since they usually provide common behavior that can be reused across multiple channels.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="global-channel-configuration-interceptors" href="#global-channel-configuration-interceptors"></a>Global Channel Interceptor Configuration</h4></div></div></div>

<p>Channel interceptors provide a clean and concise way of applying cross-cutting behavior per individual channel.
If the same behavior should be applied on multiple channels, configuring the same set of interceptors for each channel would not be the most efficient way.
To avoid repeated configuration while also enabling interceptors to apply to multiple channels, Spring Integration provides global interceptors.
Consider the following pair of examples:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:channel-interceptor</span> <span class="hl-attribute">pattern</span>=<span class="hl-value">"input*, thing2*, thing1, !cat*"</span> <span class="hl-attribute">order</span>=<span class="hl-value">"3"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"thing1.thing2SampleInterceptor"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:channel-interceptor&gt;</span></pre>
<pre class="programlisting"><span class="hl-tag">&lt;int:channel-interceptor</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"myInterceptor"</span> <span class="hl-attribute">pattern</span>=<span class="hl-value">"input*, thing2*, thing1, !cat*"</span> <span class="hl-attribute">order</span>=<span class="hl-value">"3"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myInterceptor"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"thing1.thing2SampleInterceptor"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>Each <code class="literal">&lt;channel-interceptor/&gt;</code> element lets you define a global interceptor, which is applied on all channels that match any patterns defined by the <code class="literal">pattern</code> attribute.
In the preceding case, the global interceptor is applied on the <span class="emphasis"><em>thing1</em></span> channel and all other channels that begin with <span class="emphasis"><em>thing2</em></span> or <span class="emphasis"><em>input</em></span> but not to channels starting with <span class="emphasis"><em>thing3</em></span> (since version 5.0).</p>
<div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Warning"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Warning]" src="images/warning.png"></td><th align="left">Warning</th></tr><tr><td align="left" valign="top">
<p>The addition of this syntax to the pattern causes one possible (though perhaps unlikely) problem.
If you have a bean named <code class="literal">!thing1</code> and you included a pattern of <code class="literal">!thing1</code> in your channel interceptor&#8217;s  <code class="literal">pattern</code> patterns, it no longer matches.
The pattern now matches all beans not named <code class="literal">thing1</code>.
In this case, you can escape the <code class="literal">!</code> in the pattern with <code class="literal">\</code>.
The pattern <code class="literal">\!thing1</code> matches a bean named <code class="literal">!thing1</code>.</p>
</td></tr></table></div>
<p>The order attribute lets you manage where this interceptor is injected when there are multiple interceptors on a given channel.
For example, channel <span class="emphasis"><em>inputChannel</em></span> could have individual interceptors configured locally (see below), as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"inputChannel"</span><span class="hl-tag">&gt;</span>&nbsp;
  <span class="hl-tag">&lt;int:interceptors&gt;</span>
    <span class="hl-tag">&lt;int:wire-tap</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"logger"</span><span class="hl-tag">/&gt;</span>&nbsp;
  <span class="hl-tag">&lt;/int:interceptors&gt;</span>
<span class="hl-tag">&lt;/int:channel&gt;</span></pre>
</div>
<p>A reasonable question is "<code class="literal">how is a global interceptor injected in relation to other interceptors configured locally or through other global interceptor definitions?</code>"
The current implementation provides a simple mechanism for defining the order of interceptor execution.
A positive number in the <code class="literal">order</code> attribute ensures interceptor injection after any existing interceptors, while a negative number ensures that the interceptor is injected before existing interceptors.
This means that, in the preceding example, the global interceptor is injected after (since its <code class="literal">order</code> is greater than <code class="literal">0</code>) the <span class="emphasis"><em>wire-tap</em></span> interceptor configured locally.
If there were another global interceptor with a matching <code class="literal">pattern</code>, its order would be determined by comparing the values of both interceptors' <code class="literal">order</code> attributes.
To inject a global interceptor before the existing interceptors, use a negative value for the <code class="literal">order</code> attribute.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Note that both the <code class="literal">order</code> and <code class="literal">pattern</code> attributes are optional.
The default value for <code class="literal">order</code> will be 0 and for <code class="literal">pattern</code>, the default is <span class="emphasis"><em>*</em></span> (to match all channels).</p>
</td></tr></table></div>
<p>Starting with version 4.3.15, you can configure the <code class="literal">spring.integration.postProcessDynamicBeans = true</code> property to apply any global interceptors to dynamically created <code class="literal">MessageChannel</code> beans.
See <a class="xref" href="#global-properties" title="E.4&nbsp;Global Properties">Section&nbsp;E.4, &#8220;Global Properties&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="channel-wiretap" href="#channel-wiretap"></a>Wire Tap</h4></div></div></div>

<p>As mentioned earlier, Spring Integration provides a simple wire tap interceptor.
You can configure a wire tap on any channel within an <code class="literal">&lt;interceptors/&gt;</code> element.
Doing so is especially useful for debugging and can be used in conjunction with Spring Integration&#8217;s logging channel adapter as follows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"in"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:interceptors&gt;</span>
        <span class="hl-tag">&lt;int:wire-tap</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"logger"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/int:interceptors&gt;</span>
<span class="hl-tag">&lt;/int:channel&gt;</span>

<span class="hl-tag">&lt;int:logging-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"logger"</span> <span class="hl-attribute">level</span>=<span class="hl-value">"DEBUG"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>The <span class="emphasis"><em>logging-channel-adapter</em></span> also accepts an <span class="emphasis"><em>expression</em></span> attribute so that you can evaluate a SpEL expression against the <span class="emphasis"><em>payload</em></span> and <span class="emphasis"><em>headers</em></span> variables.
Alternatively, to log the full message <code class="literal">toString()</code> result, provide a value of <code class="literal">true</code> for the <span class="emphasis"><em>log-full-message</em></span> attribute.
By default, it is <code class="literal">false</code> so that only the payload is logged.
Setting it to <code class="literal">true</code> enables logging of all headers in addition to the payload.
The <span class="emphasis"><em>expression</em></span> option provides the most flexibility (for example, <code class="literal">expression="payload.user.name"</code>).</p>
</td></tr></table></div>
<p>One of the common misconceptions about the wire tap and other similar components (<a class="xref" href="#message-publishing-config" title="B.1&nbsp;Message Publishing Configuration">Section&nbsp;B.1, &#8220;Message Publishing Configuration&#8221;</a>) is that they are automatically asynchronous in nature.
By default, wire tap as a component is not invoked asynchronously.
Instead, Spring Integration focuses on a single unified approach to configuring asynchronous behavior: the message channel.
What makes certain parts of the message flow synchronous or asynchronous is the type of Message Channel that has been configured within that flow.
That is one of the primary benefits of the message channel abstraction.
From the inception of the framework, we have always emphasized the need and the value of the message channel as a first-class citizen of the framework.
It is not just an internal, implicit realization of the EIP pattern. It is fully exposed as a configurable component to the end user.
So, the wire tap component is only responsible for performing the following tasks:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Intercept a message flow by tapping into a channel (for example, <code class="literal">channelA</code>)
</li><li class="listitem">
Grab each message
</li><li class="listitem">
Send the message to another channel (for example, <code class="literal">channelB</code>)
</li></ul></div>
<p>It is essentially a variation of the bridge pattern, but it is encapsulated within a channel definition (and hence easier to enable and disable without disrupting a flow).
Also, unlike the bridge, it basically forks another message flow.
Is that flow synchronous or asynchronous? The answer depends on the type of message channel that <span class="emphasis"><em>channelB</em></span> is.
We have the following options: direct channel, pollable channel, and executor channel.
The last two break the thread boundary, making communication over such channels asynchronous, because the dispatching of the message from that channel to its subscribed handlers happens on a different thread than the one used to send the message to that channel.
That is what is going to make your wire-tap flow synchronous or asynchronous.
It is consistent with other components within the framework (such as message publisher) and adds a level of consistency and simplicity by sparing you from worrying in advance (other than writing thread-safe code) about whether a particular piece of code should be implemented as synchronous or asynchronous.
The actual wiring of two pieces of code (say, component A and component B) over a message channel is what makes their collaboration synchronous or asynchronous.
You may even want to change from synchronous to asynchronous in the future, and message channel lets you to do it swiftly without ever touching the code.</p>
<p>One final point regarding the wire tap is that, despite the rationale provided above for not being asynchronous by default, you should keep in mind that it is usually desirable to hand off the message as soon as possible.
Therefore, it would be quite common to use an asynchronous channel option as the wire tap&#8217;s outbound channel.
However we doe not enforce asynchronous behavior by default.
There are a number of use cases that would break if we did, including that you might not want to break a transactional boundary.
Perhaps you use the wire tap pattern for auditing purposes, and you do want the audit messages to be sent within the original transaction.
As an example, you might connect the wire tap to a JMS outbound channel adapter.
That way, you get the best of both worlds: 1) the sending of a JMS Message can occur within the transaction while 2) it is still a "<code class="literal">fire-and-forget</code>" action, thereby preventing any noticeable delay in the main message flow.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Starting with version 4.0, it is important to avoid circular references when an interceptor (such as the <a class="ulink" href="https://docs.spring.io/autorepo/docs/spring-integration/current/api/org/springframework/integration/channel/interceptor/WireTap.html" target="_top"><code class="literal">WireTap</code> class</a>) references a channel.
You need to exclude such channels from those being intercepted by the current interceptor.
This can be done with appropriate patterns or programmatically.
If you have a custom <code class="literal">ChannelInterceptor</code> that references a <code class="literal">channel</code>, consider implementing <code class="literal">VetoCapableInterceptor</code>.
That way, the framework asks the interceptor if it is OK to intercept each channel that is a candidate, based on the supplied pattern.
You can also add runtime protection in the interceptor methods to ensure that the channel is not one that is referenced by the interceptor.
The <code class="literal">WireTap</code> uses both of these techniques.</p>
</td></tr></table></div>
<p>Starting with version 4.3, the <code class="literal">WireTap</code> has additional constructors that take a <code class="literal">channelName</code> instead of a
<code class="literal">MessageChannel</code> instance.
This can be convenient for Java configuration and when channel auto-creation logic is being used.
The target <code class="literal">MessageChannel</code> bean is resolved from the provided <code class="literal">channelName</code> later, on the first interaction with the
interceptor.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Channel resolution requires a <code class="literal">BeanFactory</code>, so the wire tap instance must be a Spring-managed bean.</p>
</td></tr></table></div>
<p>This late-binding approach also allows simplification of typical wire-tapping patterns with Java DSL configuration, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> PollableChannel myChannel() {
    <span class="hl-keyword">return</span> MessageChannels.queue()
            .wireTap(<span class="hl-string">"loggingFlow.input"</span>)
            .get();
}

<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> IntegrationFlow loggingFlow() {
    <span class="hl-keyword">return</span> f -&gt; f.log();
}</pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="conditional-wiretap" href="#conditional-wiretap"></a>Conditional Wire Taps</h4></div></div></div>

<p>Wire taps can be made conditional by using the <code class="literal">selector</code> or <code class="literal">selector-expression</code> attributes.
The <code class="literal">selector</code> references a <code class="literal">MessageSelector</code> bean, which can determine at runtime whether the message should go to the tap channel.
Similarly, the <code class="literal">selector-expression</code> is a boolean SpEL expression that performs the same purpose: If the expression evaluates to <code class="literal">true</code>, the message is sent to the tap channel.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="channel-global-wiretap" href="#channel-global-wiretap"></a>Global Wire Tap Configuration</h4></div></div></div>

<p>It is possible to configure a global wire tap as a special case of the <a class="xref" href="#global-channel-configuration-interceptors" title="Global Channel Interceptor Configuration">the section called &#8220;Global Channel Interceptor Configuration&#8221;</a>.
To do so, configure a top level <code class="literal">wire-tap</code> element.
Now, in addition to the normal <code class="literal">wire-tap</code> namespace support, the <code class="literal">pattern</code> and <code class="literal">order</code> attributes are supported and work in exactly the same way as they do for the <code class="literal">channel-interceptor</code>.
The following examlpe shows how to configure a global wire tap:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:wire-tap</span> <span class="hl-attribute">pattern</span>=<span class="hl-value">"input*, thing2*, thing1"</span> <span class="hl-attribute">order</span>=<span class="hl-value">"3"</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"wiretapChannel"</span><span class="hl-tag">/&gt;</span></pre>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>A global wire tap provides a convenient way to configure a single-channel wire tap externally without modifying the existing channel configuration.
To do so, set the <code class="literal">pattern</code> attribute to the target channel name.
For example, you can use this technique to configure a test case to verify messages on a channel.</p>
</td></tr></table></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="channel-special-channels" href="#channel-special-channels"></a>6.1.6&nbsp;Special Channels</h3></div></div></div>

<p>If namespace support is enabled, two special channels are defined within the application context by default: <code class="literal">errorChannel</code> and <code class="literal">nullChannel</code>.
The <span class="emphasis"><em>nullChannel</em></span> acts like <code class="literal">/dev/null</code>, logging any message sent to it at the <code class="literal">DEBUG</code> level and returning immediately.
Any time you face channel resolution errors for a reply that you do not care about, you can set the affected component&#8217;s <code class="literal">output-channel</code> attribute to <span class="emphasis"><em>nullChannel</em></span> (the name, <span class="emphasis"><em>nullChannel</em></span>, is reserved within the application context).
The <span class="emphasis"><em>errorChannel</em></span> is used internally for sending error messages and may be overridden with a custom configuration.
This is discussed in greater detail in <a class="xref" href="#namespace-errorhandler" title="E.3&nbsp;Error Handling">Section&nbsp;E.3, &#8220;Error Handling&#8221;</a>.</p>
<p>See also <a class="xref" href="#java-dsl-channels" title="11.2&nbsp;Message Channels">Section&nbsp;11.2, &#8220;Message Channels&#8221;</a> in the Java DSL chapter for more information about message channel and interceptors.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="polling-consumer" href="#polling-consumer"></a>6.2&nbsp;Poller</h2></div></div></div>

<p>This section describes how polling works in Spring Integration.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_polling_consumer" href="#_polling_consumer"></a>6.2.1&nbsp;Polling Consumer</h3></div></div></div>

<p>When Message Endpoints (Channel Adapters) are connected to channels and instantiated, they produce one of the following instances:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="ulink" href="http://static.springsource.org/spring-integration/api/org/springframework/integration/endpoint/PollingConsumer.html" target="_top"><code class="literal">PollingConsumer</code></a>
</li><li class="listitem">
<a class="ulink" href="http://static.springsource.org/spring-integration/api/org/springframework/integration/endpoint/EventDrivenConsumer.html" target="_top"><code class="literal">EventDrivenConsumer</code></a>
</li></ul></div>
<p>The actual implementation depends on the type of channel to which these endpoints connect.
A channel adapter connected to a channel that implements the <a class="ulink" href="http://docs.spring.io/spring/docs/current/javadoc-api/index.html?org/springframework/messaging/SubscribableChannel.html" target="_top"><code class="literal">org.springframework.messaging.SubscribableChannel</code></a> interface produces an instance of <code class="literal">EventDrivenConsumer</code>.
On the other hand, a channel adapter connected to a channel that implements the  <a class="ulink" href="http://docs.spring.io/spring/docs/current/javadoc-api/index.html?org/springframework/messaging/PollableChannel.html" target="_top"><code class="literal">org.springframework.messaging.PollableChannel</code></a> interface (such as a <code class="literal">QueueChannel</code>) produces an instance of <code class="literal">PollingConsumer</code>.</p>
<p>Polling consumers let Spring Integration components actively poll for Messages rather than process messages in an event-driven manner.</p>
<p>They represent a critical cross-cutting concern in many messaging scenarios.
In Spring Integration, polling consumers are based on the pattern with the same name, which is described in the book <span class="emphasis"><em>Enterprise Integration Patterns</em></span>, by Gregor Hohpe and Bobby Woolf.
You can find a description of the pattern on the <a class="ulink" href="http://www.enterpriseintegrationpatterns.com/PollingConsumer.html" target="_top">book&#8217;s website</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="pollable-message-source" href="#pollable-message-source"></a>6.2.2&nbsp;Pollable Message Source</h3></div></div></div>

<p>Spring Integration offers a second variation of the polling consumer pattern.
When inbound channel adapters are used, these adapters are often wrapped by a <code class="literal">SourcePollingChannelAdapter</code>.
For example, when retrieving messages from a remote FTP Server location, the adapter described in <a class="xref" href="#ftp-inbound" title="18.4&nbsp;FTP Inbound Channel Adapter">Section&nbsp;18.4, &#8220;FTP Inbound Channel Adapter&#8221;</a> is configured with a poller to periodically retrieve messages.
So, when components are configured with pollers, the resulting instances are of one of the following types:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="ulink" href="http://static.springsource.org/spring-integration/api/org/springframework/integration/endpoint/PollingConsumer.html" target="_top"><code class="literal">PollingConsumer</code></a>
</li><li class="listitem">
<a class="ulink" href="http://static.springsource.org/spring-integration/api/org/springframework/integration/endpoint/SourcePollingChannelAdapter.html" target="_top"><code class="literal">SourcePollingChannelAdapter</code></a>
</li></ul></div>
<p>This means that pollers are used in both inbound and outbound messaging scenarios.
Here are some use cases in which pollers are used:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Polling certain external systems, such as FTP Servers, Databases, and Web Services
</li><li class="listitem">
Polling internal (pollable) message channels
</li><li class="listitem">
Polling internal services (such as repeatedly executing methods on a Java class)
</li></ul></div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>AOP advice classes can be applied to pollers, in an <code class="literal">advice-chain</code>, such as a transaction advice to start a transaction.
Starting with version 4.1, a <code class="literal">PollSkipAdvice</code> is provided.
Pollers use triggers to determine the time of the next poll.
The <code class="literal">PollSkipAdvice</code> can be used to suppress (skip) a poll, perhaps because there is some downstream condition that would prevent the message being processed.
To use this advice, you have to provide it with an implementation of a <code class="literal">PollSkipStrategy</code>.
Starting with version 4.2.5, a <code class="literal">SimplePollSkipStrategy</code> is provided.
To use it, you can add an instance as a bean to the application context, inject it into a <code class="literal">PollSkipAdvice</code>, and add that to the poller&#8217;s
advice chain.
To skip polling, call <code class="literal">skipPolls()</code>.
To resume polling, call <code class="literal">reset()</code>.
Version 4.2 added more flexibility in this area.
See <a class="xref" href="#conditional-pollers" title="6.2.4&nbsp;Conditional Pollers for Message Sources">Section&nbsp;6.2.4, &#8220;Conditional Pollers for Message Sources&#8221;</a>.</p>
</td></tr></table></div>
<p>This chapter is meant to only give a high-level overview of polling consumers and how they fit into the concept of message channels (see <a class="xref" href="#channel" title="6.1&nbsp;Message Channels">Section&nbsp;6.1, &#8220;Message Channels&#8221;</a>) and channel adapters (see <a class="xref" href="#channel-adapter" title="6.3&nbsp;Channel Adapter">Section&nbsp;6.3, &#8220;Channel Adapter&#8221;</a>).
For more information regarding messaging endpoints in general and polling consumers in particular, see <a class="xref" href="#endpoint" title="10.1&nbsp;Message Endpoints">Section&nbsp;10.1, &#8220;Message Endpoints&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="deferred-acks-message-source" href="#deferred-acks-message-source"></a>6.2.3&nbsp;Deferred Acknowledgment Pollable Message Source</h3></div></div></div>

<p>Starting with version 5.0.1, certain modules provide <code class="literal">MessageSource</code> implementations that support deferring acknowledgment until the downstream flow completes (or hands off the message to another thread).
This is currently limited to the <code class="literal">AmqpMessageSource</code> and the <code class="literal">KafkaMessageSource</code> provided by the <a class="ulink" href="https://github.com/spring-projects/spring-integration-kafka" target="_top"><code class="literal">spring-kafka-integration</code> extension project, version 3.0.1 or higher</a>.</p>
<p>With these message sources, the <code class="literal">IntegrationMessageHeaderAccessor.ACKNOWLEDGMENT_CALLBACK</code> header (see <a class="xref" href="#message-header-accessor" title="7.2.1&nbsp;MessageHeaderAccessor API">Section&nbsp;7.2.1, &#8220;<code class="literal">MessageHeaderAccessor</code> API&#8221;</a>) is added to the message.
The value of the header is an instance of <code class="literal">AcknowledgmentCallback</code>, as the following example shows:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@FunctionalInterface</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> AcknowledgmentCallback {

    <span class="hl-keyword">void</span> acknlowledge(Status status);

    <span class="hl-keyword">boolean</span> isAcknowledged();

    <span class="hl-keyword">void</span> noAutoAck();

    <span class="hl-keyword">default</span> <span class="hl-keyword">boolean</span> isAutoAck();

    enum Status {

        <strong class="hl-tag" style="color: blue">/**
         * Mark the message as accepted.
         */</strong>
        ACCEPT,

        <strong class="hl-tag" style="color: blue">/**
         * Mark the message as rejected.
         */</strong>
        REJECT,

        <strong class="hl-tag" style="color: blue">/**
         * Reject the message and requeue so that it will be redelivered.
         */</strong>
        REQUEUE

    }

}</pre>
<p>Not all message sources (for example, Kafka) support the <code class="literal">REJECT</code> status.
It is treated the same as <code class="literal">ACCEPT</code>.</p>
<p>Applications can acknowledge a message at any time, as the following example shows:</p>
<pre class="programlisting">Message&lt;?&gt; received = source.receive();

...

StaticMessageHeaderAccessor.getAcknowledgmentCallback(received)
        .acknowledge(Status.ACCEPT);</pre>
<p>If the <code class="literal">MessageSource</code> is wired into a <code class="literal">SourcePollingChannelAdapter</code>, when the poller thread returns to the adapter after the downstream flow completes, the adapter checks whether the acknowledgment has already been acknowledged and, if not, sets its status to <code class="literal">ACCEPT</code> it (or <code class="literal">REJECT</code> if the flow throws an exception).
The status values are defined in the <a class="ulink" href="https://docs.spring.io/spring-integration/api/org/springframework/integration/support/AcknowledgmentCallback.Status.html" target="_top"><code class="literal">AcknowledgmentCallback.Status</code> enumeration</a>.</p>
<p>Spring Integration provides <code class="literal">MessageSourcePollingTemplate</code> to perform ad-hoc polling of a <code class="literal">MessageSource</code>.
This, too, takes care of setting <code class="literal">ACCEPT</code> or <code class="literal">REJECT</code> on the <code class="literal">AcknowledgmentCallback</code> when the <code class="literal">MessageHandler</code> callback returns (or throws an exception).
The following example shows how to poll with the <code class="literal">MessageSourcePollingTemplate</code>:</p>
<pre class="programlisting">MessageSourcePollingTemplate template =
    <span class="hl-keyword">new</span> MessageSourcePollingTemplate(<span class="hl-keyword">this</span>.source);
template.poll(h -&gt; {
    ...
});</pre>
<p>In both cases (<code class="literal">SourcePollingChannelAdapter</code> and <code class="literal">MessageSourcePollingTemplate</code>), you can disable auto ack/nack by calling <code class="literal">noAutoAck()</code> on the callback.
You might do this if you hand off the message to another thread and wish to acknowledge later.
Not all implementations support this (for example, Apache Kafka does not, because the offset commit has to be performed on the same thread).</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="conditional-pollers" href="#conditional-pollers"></a>6.2.4&nbsp;Conditional Pollers for Message Sources</h3></div></div></div>

<p>This section covers how to use conditional pollers.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_background" href="#_background"></a>Background</h4></div></div></div>

<p><code class="literal">Advice</code> objects, in an <code class="literal">advice-chain</code> on a poller, advise the whole polling task (both message retrieval and processing).
These "<code class="literal">around advice</code>" methods do not have access to any context for the poll&#8201;&#8212;&#8201;only the poll itself.
This is fine for requirements such as making a task transactional or skipping a poll due to some external condition, as discussed earlier.
What if we wish to take some action depending on the result of the <code class="literal">receive</code> part of the poll or if we want to adjust the poller depending on conditions? For those instances, Spring Integration offers "<code class="literal">Smart</code>" Polling.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_literal_smart_literal_polling" href="#_literal_smart_literal_polling"></a>"<code class="literal">Smart</code>" Polling</h4></div></div></div>

<p>Version 4.2 introduced the <code class="literal">AbstractMessageSourceAdvice</code>.
Any <code class="literal">Advice</code> objects in the <code class="literal">advice-chain</code> that subclass this class are applied only to the receive operation.
Such classes implement the following methods:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">beforeReceive(MessageSource&lt;?&gt; source)</code>
This method is called before the <code class="literal">MessageSource.receive()</code> method.
It lets you examine and reconfigure the source. Returning <code class="literal">false</code> cancels this poll (similar to the <code class="literal">PollSkipAdvice</code> mentioned earlier).
</li><li class="listitem">
<code class="literal">Message&lt;?&gt; afterReceive(Message&lt;?&gt; result, MessageSource&lt;?&gt; source)</code>
This method is called after the <code class="literal">receive()</code> method.
Again, you can reconfigure the source or take any action (perhaps depending on the result, which can be <code class="literal">null</code> if there was no message created by the source).
You can even return a different message
</li></ul></div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important: Thread safety"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Thread safety</th></tr><tr><td align="left" valign="top">

<p>If an advice mutates the <code class="literal">MessageSource</code>, you should not configure the poller with a <code class="literal">TaskExecutor</code>.
If an advice mutates the source, such mutations are not thread safe and could cause unexpected results, especially with high frequency pollers.
If you need to process poll results concurrently, consider using a downstream <code class="literal">ExecutorChannel</code> instead of adding an executor to the poller.</p>
</td></tr></table></div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important: Advice Chain Ordering"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Advice Chain Ordering</th></tr><tr><td align="left" valign="top">

<p>You should understand how the advice chain is processed during initialization.
<code class="literal">Advice</code> objects that do not extend <code class="literal">AbstractMessageSourceAdvice</code> are applied to the whole poll process and are all invoked first, in order, before any <code class="literal">AbstractMessageSourceAdvice</code>.
Then <code class="literal">AbstractMessageSourceAdvice</code> objects are invoked in order around the <code class="literal">MessageSource</code> <code class="literal">receive()</code> method.
If you have, for example, <code class="literal">Advice</code> objects <code class="literal">a, b, c, d</code>, where <code class="literal">b</code> and <code class="literal">d</code> are <code class="literal">AbstractMessageSourceAdvice</code>, the objects are applied in the following order: <code class="literal">a, c, b, d</code>.
Also, if a <code class="literal">MessageSource</code> is already a <code class="literal">Proxy</code>, the <code class="literal">AbstractMessageSourceAdvice</code> is invoked after any existing <code class="literal">Advice</code> objects.
If you wish to change the order, you must wire up the proxy yourself.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_literal_simpleactiveidlemessagesourceadvice_literal" href="#_literal_simpleactiveidlemessagesourceadvice_literal"></a><code class="literal">SimpleActiveIdleMessageSourceAdvice</code></h4></div></div></div>

<p>This advice is a simple implementation of <code class="literal">AbstractMessageSourceAdvice</code>.
When used in conjunction with a <code class="literal">DynamicPeriodicTrigger</code>, it adjusts the polling frequency, depending on whether or not the previous poll resulted in a message or not.
The poller must also have a reference to the same <code class="literal">DynamicPeriodicTrigger</code>.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important: Important: Async Handoff"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important: Async Handoff</th></tr><tr><td align="left" valign="top">

<p><code class="literal">SimpleActiveIdleMessageSourceAdvice</code> modifies the trigger based on the <code class="literal">receive()</code> result.
This works only if the advice is called on the poller thread.
It does not work if the poller has a <code class="literal">task-executor</code>.
To use this advice where you wish to use async operations after the result of a poll, do the async handoff later, perhaps by using an <code class="literal">ExecutorChannel</code>.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_literal_compoundtriggeradvice_literal" href="#_literal_compoundtriggeradvice_literal"></a><code class="literal">CompoundTriggerAdvice</code></h4></div></div></div>

<p>This advice allows the selection of one of two triggers based on whether a poll returns a message or not.
Consider a poller that uses a <code class="literal">CronTrigger</code>.
<code class="literal">CronTrigger</code> instances are immutable, so they cannot be altered once constructed.
Consider a use case where we want to use a cron expression to trigger a poll once each hour but, if no message is
received, poll once per minute and, when a message is retrieved, revert to using the cron expression.</p>
<p>The advice (and poller) use a <code class="literal">CompoundTrigger</code> for this purpose.
The trigger&#8217;s <code class="literal">primary</code> trigger can be a <code class="literal">CronTrigger</code>.
When the advice detects that no message is received, it adds the secondary trigger to the <code class="literal">CompoundTrigger</code>.
When the <code class="literal">CompoundTrigger</code> instance&#8217;s <code class="literal">nextExecutionTime</code> method is invoked, it delegates to the secondary trigger, if
present.
Otherwise, it delegates to the primary trigger.</p>
<p>The poller must also have a reference to the same <code class="literal">CompoundTrigger</code>.</p>
<p>The following example shows the configuration for the hourly cron expression with a fallback to every minute:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:inbound-channel-adapter</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"nullChannel"</span> <span class="hl-attribute">auto-startup</span>=<span class="hl-value">"false"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.endpoint.PollerAdviceTests.Source"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">trigger</span>=<span class="hl-value">"compoundTrigger"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;int:advice-chain&gt;</span>
            <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.aop.CompoundTriggerAdvice"</span><span class="hl-tag">&gt;</span>
                <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"compoundTrigger"</span><span class="hl-tag">/&gt;</span>
                <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"secondary"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;/bean&gt;</span>
        <span class="hl-tag">&lt;/int:advice-chain&gt;</span>
    <span class="hl-tag">&lt;/int:poller&gt;</span>
<span class="hl-tag">&lt;/int:inbound-channel-adapter&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"compoundTrigger"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.util.CompoundTrigger"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"primary"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"primary"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.scheduling.support.CronTrigger"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"0 0 * * * *"</span><span class="hl-tag"> /&gt;</span> <span class="hl-comment">&lt;!-- top of every hour --&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"secondary"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.scheduling.support.PeriodicTrigger"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"60000"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important: Important: Async Handoff"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important: Async Handoff</th></tr><tr><td align="left" valign="top">

<p><code class="literal">CompoundTriggerAdvice</code> modifies the trigger based on the <code class="literal">receive()</code> result.
This works only if the advice is called on the poller thread.
It does not work if the poller has a <code class="literal">task-executor</code>.
To use this advice where you wish to use async operations after the result of a poll, do the async handoff later, perhaps by using an <code class="literal">ExecutorChannel</code>.</p>
</td></tr></table></div>
</div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="channel-adapter" href="#channel-adapter"></a>6.3&nbsp;Channel Adapter</h2></div></div></div>

<p>A channel adapter is a message endpoint that enables connecting a single sender or receiver to a message channel.
Spring Integration provides a number of adapters to support various transports, such as JMS, file, HTTP, web services, mail, and more.
Upcoming chapters of this reference guide discuss each adapter.
However, this chapter focuses on the simple but flexible method-invoking channel adapter support.
There are both inbound and outbound adapters, and each may be configured with XML elements provided in the core namespace.
These provide an easy way to extend Spring Integration, as long as you have a method that can be invoked as either a source or a destination.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="channel-adapter-namespace-inbound" href="#channel-adapter-namespace-inbound"></a>6.3.1&nbsp;Configuring An Inbound Channel Adapter</h3></div></div></div>

<p>An <code class="literal">inbound-channel-adapter</code> element can invoke any method on a Spring-managed object and send a non-null return value to a <code class="literal">MessageChannel</code> after converting the method&#8217;s output to a <code class="literal">Message</code>.
When the adapter&#8217;s subscription is activated, a poller tries to receive messages from the source.
The poller is scheduled with the <code class="literal">TaskScheduler</code> according to the provided configuration.
To configure the polling interval or cron expression for an individual channel adapter, you can provide a <span class="emphasis"><em>poller</em></span> element with one of the scheduling attributes, such as <span class="emphasis"><em>fixed-rate</em></span> or <span class="emphasis"><em>cron</em></span>.
The following example defines two <code class="literal">inbound-channel-adapter</code> instances:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:inbound-channel-adapter</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"source1"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"method1"</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"channel1"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"5000"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:inbound-channel-adapter&gt;</span>

<span class="hl-tag">&lt;int:inbound-channel-adapter</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"source2"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"method2"</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"channel2"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">cron</span>=<span class="hl-value">"30 * 9-17 * * MON-FRI"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:channel-adapter&gt;</span></pre>
</div>
<p>See also <a class="xref" href="#channel-adapter-expressions-and-scripts" title="6.3.3&nbsp;Channel Adapter Expressions and Scripts">Section&nbsp;6.3.3, &#8220;Channel Adapter Expressions and Scripts&#8221;</a>.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>If no poller is provided, then a single default poller must be registered within the context.
See <a class="xref" href="#endpoint-namespace" title="10.1.4&nbsp;Endpoint Namespace Support">Section&nbsp;10.1.4, &#8220;Endpoint Namespace Support&#8221;</a> for more detail.</p>
</td></tr></table></div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important: Important: Poller Configuration"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important: Poller Configuration</th></tr><tr><td align="left" valign="top">

<p>Some <code class="literal">inbound-channel-adapter</code> types are backed by a <code class="literal">SourcePollingChannelAdapter</code>, which means they contain a poller configuration that polls the <code class="literal">MessageSource</code> (to invoke a custom method that produces the value that becomes a <code class="literal">Message</code> payload) based on the configuration specified in the Poller.
The following example shows the configuration of two pollers:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">max-messages-per-poll</span>=<span class="hl-value">"1"</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"1000"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">max-messages-per-poll</span>=<span class="hl-value">"10"</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"1000"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>In the the first configuration, the polling task is invoked once per poll, and, during each task (poll), the method (which results in the production of the message) is invoked once, based on the <code class="literal">max-messages-per-poll</code> attribute value.
In the second configuration, the polling task is invoked 10 times per poll or until it returns <span class="emphasis"><em>null</em></span>, thus possibly producing ten messages per poll while each poll happens at one-second intervals.
However, what happens if the configuration looks like the following example:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"1000"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>Note that there is no <code class="literal">max-messages-per-poll</code> specified.
As we cover later, the identical poller configuration in the <code class="literal">PollingConsumer</code> (for example, service-activator, filter, router, and others) would have a default value of -1 for <code class="literal">max-messages-per-poll</code>, which means "<code class="literal">execute the polling task non-stop unless the polling method returns null (perhaps because there are no more messages in the `QueueChannel</code>)`" and then sleep for one second.</p>
<p>However, in the <code class="literal">SourcePollingChannelAdapter</code>, it is a bit different.
The default value for <code class="literal">max-messages-per-poll</code> is <code class="literal">1</code>, unless you explicitly set it to a negative value (such as <code class="literal">-1</code>).
This makes sure that the poller can react to lifecycle events (such as start and stop) and prevents it from potentially spinning in an infinite loop if the implementation of the custom method of the <code class="literal">MessageSource</code> has a potential to never return null and happens to be non-interruptible.</p>
<p>However, if you are sure that your method can return null and you need to poll for as many sources as available per each poll, you should explicitly set <code class="literal">max-messages-per-poll</code> to a negative value, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">max-messages-per-poll</span>=<span class="hl-value">"-1"</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"1000"</span><span class="hl-tag">/&gt;</span></pre>
</div>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="channel-adapter-namespace-outbound" href="#channel-adapter-namespace-outbound"></a>6.3.2&nbsp;Configuring An Outbound Channel Adapter</h3></div></div></div>

<p>An <code class="literal">outbound-channel-adapter</code> element can also connect a <code class="literal">MessageChannel</code> to any POJO consumer method that should be invoked with the payload of messages sent to that channel.
The following example shows how to define an outbound channel adapter:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:outbound-channel-adapter</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"channel1"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"target"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"handle"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;beans:bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"target"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.MyPojo"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>If the channel being adapted is a <code class="literal">PollableChannel</code>, you must provide a poller sub-element, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:outbound-channel-adapter</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"channel2"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"target"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"handle"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"3000"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/int:outbound-channel-adapter&gt;</span>

<span class="hl-tag">&lt;beans:bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"target"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.MyPojo"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>You should use a <code class="literal">ref</code> attribute if the POJO consumer implementation can be reused in other <code class="literal">&lt;outbound-channel-adapter&gt;</code> definitions.
However, if the consumer implementation is referenced by only a single definition of the <code class="literal">&lt;outbound-channel-adapter&gt;</code>, you can define it as an inner bean, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:outbound-channel-adapter</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"channel"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"handle"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;beans:bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.Foo"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:outbound-channel-adapter&gt;</span></pre>
</div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Using both the <code class="literal">ref</code> attribute and an inner handler definition in the same <code class="literal">&lt;outbound-channel-adapter&gt;</code> configuration is not allowed, as it creates an ambiguous condition.
Such a configuration results in an exception being thrown.</p>
</td></tr></table></div>
<p>Any channel adapter can be created without a <code class="literal">channel</code> reference, in which case it implicitly creates an instance of <code class="literal">DirectChannel</code>.
The created channel&#8217;s name matches the <code class="literal">id</code> attribute of the <code class="literal">&lt;inbound-channel-adapter&gt;</code> or <code class="literal">&lt;outbound-channel-adapter&gt;</code> element.
Therefore, if <code class="literal">channel</code> is not provided, <code class="literal">id</code> is required.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="channel-adapter-expressions-and-scripts" href="#channel-adapter-expressions-and-scripts"></a>6.3.3&nbsp;Channel Adapter Expressions and Scripts</h3></div></div></div>

<p>Like many other Spring Integration components, the <code class="literal">&lt;inbound-channel-adapter&gt;</code> and <code class="literal">&lt;outbound-channel-adapter&gt;</code> also provide support for SpEL expression evaluation.
To use SpEL, provide the expression string in the <span class="emphasis"><em>expression</em></span> attribute instead of providing the <span class="emphasis"><em>ref</em></span> and <span class="emphasis"><em>method</em></span> attributes that are used for method-invocation on a bean.
When an expression is evaluated, it follows the same contract as method-invocation where: the expression for an <code class="literal">&lt;inbound-channel-adapter&gt;</code> generates a message any time the evaluation result is a non-null value, while the expression for an <code class="literal">&lt;outbound-channel-adapter&gt;</code> must be the equivalent of a void-returning method invocation.</p>
<p>Starting with Spring Integration 3.0, an <code class="literal">&lt;int:inbound-channel-adapter/&gt;</code> can also be configured with a SpEL <code class="literal">&lt;expression/&gt;</code> (or even with a <code class="literal">&lt;script/&gt;</code>) sub-element, for when more sophistication is required than can be achieved with the simple <span class="emphasis"><em>expression</em></span> attribute.
If you provide a script as a <code class="literal">Resource</code> by using the <code class="literal">location</code> attribute, you can also set <code class="literal">refresh-check-delay</code>, which allows the resource to be periodically refreshed.
If you want the script to be checked on each poll, you would need to coordinate this setting with the poller&#8217;s trigger, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:inbound-channel-adapter</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"source1"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"method1"</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"channel1"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">max-messages-per-poll</span>=<span class="hl-value">"1"</span> <span class="hl-attribute">fixed-delay</span>=<span class="hl-value">"5000"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;script:script</span> <span class="hl-attribute">lang</span>=<span class="hl-value">"ruby"</span> <span class="hl-attribute">location</span>=<span class="hl-value">"Foo.rb"</span> <span class="hl-attribute">refresh-check-delay</span>=<span class="hl-value">"5000"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:inbound-channel-adapter&gt;</span></pre>
</div>
<p>See also the <code class="literal">cacheSeconds</code> property on the <code class="literal">ReloadableResourceBundleExpressionSource</code> when using the <code class="literal">&lt;expression/&gt;</code> sub-element.
For more information regarding expressions, see <a class="xref" href="#spel" title="Appendix&nbsp;A.&nbsp;Spring Expression Language (SpEL)">Appendix&nbsp;A, <i>Spring Expression Language (SpEL)</i></a>. For scripts, see <a class="xref" href="#groovy" title="10.8&nbsp;Groovy support">Section&nbsp;10.8, &#8220;Groovy support&#8221;</a> and <a class="xref" href="#scripting" title="10.7&nbsp;Scripting Support">Section&nbsp;10.7, &#8220;Scripting Support&#8221;</a>.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>The <code class="literal">&lt;int:inbound-channel-adapter/&gt;</code> is endpoint starts a message flow by periodically triggering to poll some underlying <code class="literal">MessageSource</code>.
Since, at the time of polling, there is no message object, expressions and scripts do not have access to a root <code class="literal">Message</code>, so there are no payload or headers properties that are available in most other messaging SpEL expressions.
The script can generate and return a complete <code class="literal">Message</code> object with headers and payload or only a payload, which is added to a message with basic headers.</p>
</td></tr></table></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="bridge" href="#bridge"></a>6.4&nbsp;Messaging Bridge</h2></div></div></div>

<p>A messaging bridge is a relatively trivial endpoint that connects two message channels or channel adapters.
For example, you may want to connect a <code class="literal">PollableChannel</code> to a <code class="literal">SubscribableChannel</code> so that the subscribing endpoints do not have to worry about any polling configuration.
Instead, the messaging bridge provides the polling configuration.</p>
<p>By providing an intermediary poller between two channels, you can use a messaging bridge to throttle inbound messages.
The poller&#8217;s trigger determines the rate at which messages arrive on the second channel, and the poller&#8217;s <code class="literal">maxMessagesPerPoll</code> property enforces a limit on the throughput.</p>
<p>Another valid use for a messaging bridge is to connect two different systems.
In such a scenario, Spring Integration&#8217;s role is limited to making the connection between these systems and managing a poller, if necessary.
It is probably more common to have at least a transformer between the two systems, to translate between their formats.
In that case, the channels can be provided as the <span class="emphasis"><em>input-channel</em></span> and <span class="emphasis"><em>output-channel</em></span> of a transformer endpoint.
If data format translation is not required, the messaging bridge may indeed be sufficient.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="bridge-namespace" href="#bridge-namespace"></a>6.4.1&nbsp;Configuring a Bridge with XML</h3></div></div></div>

<p>You can use the <code class="literal">&lt;bridge&gt;</code> element is used to create a messaging bridge between two message channels or channel adapters.
To do so, provide the <code class="literal">input-channel</code> and <code class="literal">output-channel</code> attributes, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:bridge</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>As mentioned above, a common use case for the messaging bridge is to connect a <code class="literal">PollableChannel</code> to a <code class="literal">SubscribableChannel</code>.
When performing this role, the messaging bridge may also serve as a throttler:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:bridge</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"pollable"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"subscribable"</span><span class="hl-tag">&gt;</span>
     <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">max-messages-per-poll</span>=<span class="hl-value">"10"</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"5000"</span><span class="hl-tag">/&gt;</span>
 <span class="hl-tag">&lt;/int:bridge&gt;</span></pre>
</div>
<p>You can use a similar mechanism to connecting channel adapters.
The following example shows a simple "<code class="literal">echo</code>" between the <code class="literal">stdin</code> and <code class="literal">stdout</code> adapters from Spring Integration&#8217;s <code class="literal">stream</code> namespace:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-stream:stdin-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"stdin"</span><span class="hl-tag">/&gt;</span>

 <span class="hl-tag">&lt;int-stream:stdout-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"stdout"</span><span class="hl-tag">/&gt;</span>

 <span class="hl-tag">&lt;int:bridge</span> <span class="hl-attribute">id</span>=<span class="hl-value">"echo"</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"stdin"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"stdout"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>Similar configurations work for other (potentially more useful) Channel Adapter bridges, such as file-to-JMS or mail-to-file.
Upcoming chapters cover the various channel adapters.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>If no <span class="emphasis"><em>output-channel</em></span> is defined on a bridge, the reply channel provided by the inbound message is used, if available.
If neither an output nor a reply channel is available, an exception is thrown.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="bridge-annot" href="#bridge-annot"></a>6.4.2&nbsp;Configuring a Bridge with Java Configuration</h3></div></div></div>

<p>The following example shows how to configure a bridge in Java by using the <code class="literal">@BridgeFrom</code> annotation:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> PollableChannel polled() {
    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> QueueChannel();
}

<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<em><span class="hl-annotation" style="color: gray">@BridgeFrom(value = "polled", poller = @Poller(fixedDelay = "5000", maxMessagesPerPoll = "10"))</span></em>
<span class="hl-keyword">public</span> SubscribableChannel direct() {
    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> DirectChannel();
}</pre>
</div>
<p>The following example shows how to configure a bridge in Java by using the <code class="literal">@BridgeTo</code> annotation:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<em><span class="hl-annotation" style="color: gray">@BridgeTo(value = "direct", poller = @Poller(fixedDelay = "5000", maxMessagesPerPoll = "10"))</span></em>
<span class="hl-keyword">public</span> PollableChannel polled() {
    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> QueueChannel();
}

<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> SubscribableChannel direct() {
    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> DirectChannel();
}</pre>
<p>Alternately, you can use a <code class="literal">BridgeHandler</code>, as the following example shows:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "polled",
        poller = @Poller(fixedRate = "5000", maxMessagesPerPoll = "10"))</span></em>
<span class="hl-keyword">public</span> BridgeHandler bridge() {
    BridgeHandler bridge = <span class="hl-keyword">new</span> BridgeHandler();
    bridge.setOutputChannelName(<span class="hl-string">"direct"</span>);
    <span class="hl-keyword">return</span> bridge;
}</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="bridge-dsl" href="#bridge-dsl"></a>6.4.3&nbsp;Configuring a Bridge with the Java DSL</h3></div></div></div>

<p>You can use the Java Domain Specific Language (DSL) to configure a bridge, as the following example shows:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> IntegrationFlow bridgeFlow() {
    <span class="hl-keyword">return</span> IntegrationFlows.from(<span class="hl-string">"polled"</span>)
            .bridge(e -&gt; e.poller(Pollers.fixedDelay(<span class="hl-number">5000</span>).maxMessagesPerPoll(<span class="hl-number">10</span>)))
            .channel(<span class="hl-string">"direct"</span>)
            .get();
}</pre>
</div>
</div>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="message" href="#message"></a>7.&nbsp;Message</h2></div></div></div>

<p>The Spring Integration <code class="literal">Message</code> is a generic container for data.
Any object can be provided as the payload, and each <code class="literal">Message</code> instance includes headers containing user-extensible properties as key-value pairs.</p>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="message-interface" href="#message-interface"></a>7.1&nbsp;The <code class="literal">Message</code> Interface</h2></div></div></div>

<p>The following listing shows the definition of the <code class="literal">Message</code> interface:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> Message&lt;T&gt; {

    T getPayload();

    MessageHeaders getHeaders();

}</pre>
</div>
<p>The <code class="literal">Message</code> interface is a core part of the API.
By encapsulating the data in a generic wrapper, the messaging system can pass it around without any knowledge of the data&#8217;s type.
As an application evolves to support new types or when the types themselves are modified or extended, the messaging system is not affected.
On the other hand, when some component in the messaging system does require access to information about the <code class="literal">Message</code>, such metadata can typically be stored to and retrieved from the metadata in the message headers.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="message-headers" href="#message-headers"></a>7.2&nbsp;Message Headers</h2></div></div></div>

<p>Just as Spring Integration lets any <code class="literal">Object</code> be used as the payload of a <code class="literal">Message</code>, it also supports any <code class="literal">Object</code> types as header values.
In fact, the <code class="literal">MessageHeaders</code> class implements the <code class="literal">java.util.Map_ interface</code>, as the following class definition shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">final</span> <span class="hl-keyword">class</span> MessageHeaders <span class="hl-keyword">implements</span> Map&lt;String, Object&gt;, Serializable {
  ...
}</pre>
</div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Even though the <code class="literal">MessageHeaders</code> class implements <code class="literal">Map</code>, it is effectively a read-only implementation.
Any attempt to <code class="literal">put</code> a value in the Map results in an <code class="literal">UnsupportedOperationException</code>.
The same applies for <code class="literal">remove</code> and <code class="literal">clear</code>.
Since messages may be passed to multiple consumers, the structure of the <code class="literal">Map</code> cannot be modified.
Likewise, the message&#8217;s payload <code class="literal">Object</code> can not be <code class="literal">set</code> after the initial creation.
However, the mutability of the header values themselves (or the payload Object) is intentionally left as a decision for the framework user.</p>
</td></tr></table></div>
<p>As an implementation of <code class="literal">Map</code>, the headers can be retrieved by calling <code class="literal">get(..)</code> with the name of the header.
Alternatively, you can provide the expected <code class="literal">Class</code> as an additional parameter.
Even better, when retrieving one of the pre-defined values, convenient getters are available.
The following example shows each of these three options:</p>
<div class="informalexample">
<pre class="programlisting">Object someValue = message.getHeaders().get(<span class="hl-string">"someKey"</span>);

CustomerId customerId = message.getHeaders().get(<span class="hl-string">"customerId"</span>, CustomerId.<span class="hl-keyword">class</span>);

Long timestamp = message.getHeaders().getTimestamp();</pre>
</div>
<p>The following table describes the pre-defined message headers:</p>
<div class="table"><a name="d5e2094" href="#d5e2094"></a><p class="title"><b>Table&nbsp;7.1.&nbsp;Pre-defined Message Headers</b></p><div class="table-contents">

<table summary="Pre-defined Message Headers" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Header Name</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Header Type</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Usage</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><pre class="literallayout"> MessageHeaders.ID</pre></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><pre class="literallayout"> java.util.UUID</pre></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>An identifier for this message instance.
Changes each time a message is mutated.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><pre class="literallayout"> MessageHeaders.
TIMESTAMP</pre></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><pre class="literallayout"> java.lang.Long</pre></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The time the message was created.
Changes each time a message is mutated.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><pre class="literallayout"> MessageHeaders.
REPLY_CHANNEL</pre></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><pre class="literallayout"> java.lang.Object
(String or
MessageChannel)</pre></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>A channel to which a reply (if any) is sent when no explicit output channel is configured and there is no <code class="literal">ROUTING_SLIP</code> or the <code class="literal">ROUTING_SLIP</code> is exhausted.
If the value is a <code class="literal">String</code>, it must represent a bean name or have been generated by a <code class="literal">ChannelRegistry.</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><pre class="literallayout"> MessageHeaders.
ERROR_CHANNEL</pre></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><pre class="literallayout"> java.lang.Object
(String or
MessageChannel)</pre></td><td style="" align="left" valign="top"><p>A channel to which errors are sent.
If the value is a <code class="literal">String</code>, it must represent a bean name or have been generated by a <code class="literal">ChannelRegistry.</code></p></td></tr></tbody></table>
</div></div><br class="table-break">
<p>Many inbound and outbound adapter implementations also provide or expect certain headers, and you can configure additional user-defined headers.
Constants for these headers can be found in those modules where such headers exist&#8201;&#8212;&#8201;for example. <code class="literal">AmqpHeaders</code>, <code class="literal">JmsHeaders</code>, and so on.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="message-header-accessor" href="#message-header-accessor"></a>7.2.1&nbsp;<code class="literal">MessageHeaderAccessor</code> API</h3></div></div></div>

<p>Starting with Spring Framework 4.0 and Spring Integration 4.0, the core messaging abstraction has been moved to the <code class="literal">spring-messaging</code> module, and the <code class="literal">MessageHeaderAccessor</code> API has been introduced to provide additional abstraction over messaging implementations.
All (core) Spring Integration-specific message headers constants are now declared in the <code class="literal">IntegrationMessageHeaderAccessor</code> class.
The following table describes the pre-defined message headers:</p>
<div class="table"><a name="d5e2150" href="#d5e2150"></a><p class="title"><b>Table&nbsp;7.2.&nbsp;Pre-defined Message Headers</b></p><div class="table-contents">

<table summary="Pre-defined Message Headers" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Header Name</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Header Type</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Usage</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><pre class="literallayout"> IntegrationMessageHeaderAccessor.
CORRELATION_ID</pre></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><pre class="literallayout"> java.lang.Object</pre></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Used to correlate two or more messages.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><pre class="literallayout"> IntegrationMessageHeaderAccessor.
SEQUENCE_NUMBER</pre></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><pre class="literallayout"> java.lang.Integer</pre></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Usually a sequence number with a group of messages with a <code class="literal">SEQUENCE_SIZE</code> but can also be used in a <code class="literal">&lt;resequencer/&gt;</code> to resequence an unbounded group of messages.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><pre class="literallayout"> IntegrationMessageHeaderAccessor.
SEQUENCE_SIZE</pre></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><pre class="literallayout"> java.lang.Integer</pre></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The number of messages within a group of correlated messages.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><pre class="literallayout"> IntegrationMessageHeaderAccessor.
EXPIRATION_DATE</pre></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><pre class="literallayout"> java.lang.Long</pre></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Indicates when a message is expired.
Not used by the framework directly but can be set with a header enricher and used in a <code class="literal">&lt;filter/&gt;</code> that is configured with an <code class="literal">UnexpiredMessageSelector</code>.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><pre class="literallayout"> IntegrationMessageHeaderAccessor.
PRIORITY</pre></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><pre class="literallayout"> java.lang.Integer</pre></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Message priority&#8201;&#8212;&#8201;for example, within a <code class="literal">PriorityChannel</code>.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><pre class="literallayout"> IntegrationMessageHeaderAccessor.
DUPLICATE_MESSAGE</pre></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><pre class="literallayout"> java.lang.Boolean</pre></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>True if a message was detected as a duplicate by an idempotent receiver interceptor.
See <a class="xref" href="#idempotent-receiver" title="10.9.10&nbsp;Idempotent Receiver Enterprise Integration Pattern">Section&nbsp;10.9.10, &#8220;Idempotent Receiver Enterprise Integration Pattern&#8221;</a>.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><pre class="literallayout"> IntegrationMessageHeaderAccessor.
CLOSEABLE_RESOURCE</pre></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><pre class="literallayout"> java.io.Closeable</pre></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>This header is present if the message is associated with a <code class="literal">Closeable</code> that should be closed when message processing is complete.
An example is the <code class="literal">Session</code> associated with a streamed file transfer using FTP, SFTP, and so on.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><pre class="literallayout"> IntegrationMessageHeaderAccessor.
DELIVERY_ATTEMPT</pre></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><pre class="literallayout"> java.lang.
AtomicInteger</pre></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>If a message-driven channel adapter supports the configuration of a <code class="literal">RetryTemplate</code>, this header contains the current delivery attempt.</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><pre class="literallayout"> IntegrationMessageHeaderAccessor.
ACKNOWLEDGMENT_CALLBACK</pre></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><pre class="literallayout"> o.s.i.support.
Acknowledgment
Callback</pre></td><td style="" align="left" valign="top"><p>If a message source supports it, a call back to accept, reject, or requeue a message.
See <a class="xref" href="#deferred-acks-message-source" title="6.2.3&nbsp;Deferred Acknowledgment Pollable Message Source">Section&nbsp;6.2.3, &#8220;Deferred Acknowledgment Pollable Message Source&#8221;</a>.</p></td></tr></tbody></table>
</div></div><br class="table-break">
<p>Convenient typed getters for some of these headers are provided on the <code class="literal">IntegrationMessageHeaderAccessor</code> class, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting">IntegrationMessageHeaderAccessor accessor = <span class="hl-keyword">new</span> IntegrationMessageHeaderAccessor(message);
<span class="hl-keyword">int</span> sequenceNumber = accessor.getSequenceNumber();
Object correlationId = accessor.getCorrelationId();
...</pre>
</div>
<p>The following table describes headers that also appear in the <code class="literal">IntegrationMessageHeaderAccessor</code> but are generally not used by user code (that is, they are generally used by internal parts of Spring Integration&#8201;&#8212;&#8201;their inclusion here is for completeness):</p>
<div class="table"><a name="d5e2241" href="#d5e2241"></a><p class="title"><b>Table&nbsp;7.3.&nbsp;Pre-defined Message Headers</b></p><div class="table-contents">

<table summary="Pre-defined Message Headers" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Header Name</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Header Type</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Usage</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><pre class="literallayout"> `IntegrationMessageHeaderAccessor.
SEQUENCE_DETAILS`</pre></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><pre class="literallayout"> `java.util.`
`List&lt;List&lt;Object&gt;&gt;`</pre></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>A stack of correlation data used when nested correlation is needed (for example, <code class="literal">splitter-&gt;...-&gt;splitter-&gt;...-&gt;aggregator-&gt;...-&gt;aggregator</code>).</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><pre class="literallayout"> `IntegrationMessageHeaderAccessor.
ROUTING_SLIP`</pre></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><pre class="literallayout"> `java.util.`
`Map&lt;List&lt;Object&gt;, Integer&gt;`</pre></td><td style="" align="left" valign="top"><p>See <a class="xref" href="#routing-slip" title="Routing Slip">the section called &#8220;Routing Slip&#8221;</a>.</p></td></tr></tbody></table>
</div></div><br class="table-break">
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="message-id-generation" href="#message-id-generation"></a>7.2.2&nbsp;Message ID Generation</h3></div></div></div>

<p>When a message transitions through an application, each time it is mutated (for example,
by a transformer) a new message ID is assigned.
The message ID is a <code class="literal">UUID</code>.
Beginning with Spring Integration 3.0, the default strategy used for IS generation is more efficient than the previous <code class="literal">java.util.UUID.randomUUID()</code> implementation.
It uses simple random numbers based on a secure random seed instead of creating a secure random number each time.</p>
<p>A different UUID generation strategy can be selected by declaring a bean that implements <code class="literal">org.springframework.util.IdGenerator</code> in the application context.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Only one UUID generation strategy can be used in a classloader.
This means that, if two or more application contexts run in the same classloader, they share the same strategy.
If one of the contexts changes the strategy, it is used by all contexts.
If two or more contexts in the same classloader declare a bean of type <code class="literal">org.springframework.util.IdGenerator</code>, they must all be an instance of the same class.
Otherwise, the context attempting to replace a custom strategy fails to initialize.
If the strategy is the same, but parameterized, the strategy in the first context to be initialized is used.</p>
</td></tr></table></div>
<p>In addition to the default strategy, two additional <code class="literal">IdGenerators</code> are provided.
<code class="literal">org.springframework.util.JdkIdGenerator</code> uses the previous <code class="literal">UUID.randomUUID()</code> mechanism.
You can use <code class="literal">o.s.i.support.IdGenerators.SimpleIncrementingIdGenerator</code> when a UUID is not really needed and a simple incrementing value is sufficient.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="read-only-headers" href="#read-only-headers"></a>7.2.3&nbsp;Read-only Headers</h3></div></div></div>

<p>The <code class="literal">MessageHeaders.ID</code> and <code class="literal">MessageHeaders.TIMESTAMP</code> are read-only headers and cannot be overridden.</p>
<p>Since version 4.3.2, the <code class="literal">MessageBuilder</code> provides the <code class="literal">readOnlyHeaders(String... readOnlyHeaders)</code> API to customize a list of headers that should not be copied from an upstream <code class="literal">Message</code>.
Only the <code class="literal">MessageHeaders.ID</code> and <code class="literal">MessageHeaders.TIMESTAMP</code> are read only by default.
The global <code class="literal">spring.integration.readOnly.headers</code> property (see <a class="xref" href="#global-properties" title="E.4&nbsp;Global Properties">Section&nbsp;E.4, &#8220;Global Properties&#8221;</a>) is provided to customize <code class="literal">DefaultMessageBuilderFactory</code> for framework components.
This can be useful when you would like do not populate some out-of-the-box headers, such as <code class="literal">contentType</code> by the <code class="literal">ObjectToJsonTransformer</code> (see <a class="xref" href="#json-transformers" title="JSON Transformers">the section called &#8220;JSON Transformers&#8221;</a>).</p>
<p>When you try to build a new message using <code class="literal">MessageBuilder</code>, this kind of header is ignored and a particular <code class="literal">INFO</code> message is emitted to logs.</p>
<p>Starting with version 5.0, <a class="link" href="#gateway" title="10.4&nbsp;Messaging Gateways">Messaging Gateway</a>, <a class="link" href="#header-enricher" title="9.2.1&nbsp;Header Enricher">Header Enricher</a>, <a class="link" href="#payload-enricher" title="9.2.2&nbsp;Payload Enricher">Content Enricher</a> and <a class="link" href="#header-filter" title="9.1.5&nbsp;Header Filter">Header Filter</a> do not let you configure the <code class="literal">MessageHeaders.ID</code> and <code class="literal">MessageHeaders.TIMESTAMP</code> header names when <code class="literal">DefaultMessageBuilderFactory</code> is used, and they throw <code class="literal">BeanInitializationException</code>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="header-propagation" href="#header-propagation"></a>7.2.4&nbsp;Header Propagation</h3></div></div></div>

<p>When messages are processed (and modified) by message-producing endpoints (such as a <a class="link" href="#service-activator" title="10.5&nbsp;Service Activator">service activator</a>), in general, inbound headers are propagated to the outbound message.
One exception to this is a <a class="link" href="#transformer" title="9.1&nbsp;Transformer">transformer</a>, when a complete message is returned to the framework.
In that case, the user code is responsible for the entire outbound message.
When a transformer just returns the payload, the inbound headers are propagated.
Also, a header is only propagated if it does not already exist in the outbound message, letting you change header values as needed.</p>
<p>Starting with version 4.3.10, you can configure message handlers (that modify messages and produce output) to suppress the propagation of specific headers.
To configure the header(s) you do not want to be copied, call the <code class="literal">setNotPropagatedHeaders()</code> or <code class="literal">addNotPropagatedHeaders()</code> methods on the <code class="literal">MessageProducingMessageHandler</code> abstract class.</p>
<p>You can also globally suppress propagation of specific message headers by setting the <code class="literal">readOnlyHeaders</code> property in <code class="literal">META-INF/spring.integration.properties</code> to a comma-delimited list of headers.</p>
<p>Starting with version 5.0, the <code class="literal">setNotPropagatedHeaders()</code> implementation on the <code class="literal">AbstractMessageProducingHandler</code> applies simple patterns (<code class="literal">xxx*</code>, <code class="literal">*xxx</code>, <code class="literal">*xxx*</code>, or <code class="literal">xxx*yyy</code>) to allow filtering headers with a common suffix or prefix.
See <a class="ulink" href="https://docs.spring.io/spring-integration/api/org/springframework/integration/util/PatternMatchUtils.html" target="_top"><code class="literal">PatternMatchUtils</code> Javadoc</a> for more information.
When one of the patterns is <code class="literal">*</code> (asterisk), no headers are propagated.
All other patterns are ignored.
In that case, the service activator behaves the same way as a transformer and any required headers must be supplied in the <code class="literal">Message</code> returned from the service method.
The <code class="literal">notPropagatedHeaders()</code> option is available in the <code class="literal">ConsumerEndpointSpec</code> for the Java DSL
It is also available for XML configuration of the <code class="literal">&lt;service-activator&gt;</code> component as a <code class="literal">not-propagated-headers</code> attribute.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Header propagation suppression does not apply to those endpoints that do not modify the message, such as <a class="link" href="#bridge" title="6.4&nbsp;Messaging Bridge">bridges</a> and <a class="link" href="#router" title="8.1&nbsp;Routers">routers</a>.</p>
</td></tr></table></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="message-implementations" href="#message-implementations"></a>7.3&nbsp;Message Implementations</h2></div></div></div>

<p>The base implementation of the <code class="literal">Message</code> interface is <code class="literal">GenericMessage&lt;T&gt;</code>, and it provides two constructors, shown in the following listing:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">new</span> GenericMessage&lt;T&gt;(T payload);

<span class="hl-keyword">new</span> GenericMessage&lt;T&gt;(T payload, Map&lt;String, Object&gt; headers)</pre>
</div>
<p>When a <code class="literal">Message</code> is created, a random unique ID is generated.
The constructor that accepts a <code class="literal">Map</code> of headers copies the provided headers to the newly created <code class="literal">Message</code>.</p>
<p>There is also a convenient implementation of <code class="literal">Message</code> designed to communicate error conditions.
This implementation takes a <code class="literal">Throwable</code> object as its payload, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting">ErrorMessage message = <span class="hl-keyword">new</span> ErrorMessage(someThrowable);

Throwable t = message.getPayload();</pre>
</div>
<p>Note that this implementation takes advantage of the fact that the <code class="literal">GenericMessage</code> base class is parameterized.
Therefore, as shown in both examples, no casting is necessary when retrieving the <code class="literal">Message</code> payload <code class="literal">Object</code>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="message-builder" href="#message-builder"></a>7.4&nbsp;The <code class="literal">MessageBuilder</code> Helper Class</h2></div></div></div>

<p>You may notice that the <code class="literal">Message</code> interface defines retrieval methods for its payload and headers but provides no setters.
The reason for this is that a <code class="literal">Message</code> cannot be modified after its initial creation.
Therefore, when a <code class="literal">Message</code> instance is sent to multiple consumers (for example,
through a publish-subscribe Channel), if one of those consumers needs to send a reply with a different payload type, it must create a new <code class="literal">Message</code>.
As a result, the other consumers are not affected by those changes.
Keep in mind that multiple consumers may access the same payload instance or header value, and whether such an instance is itself immutable is a decision left to you.
In other words, the contract for <code class="literal">Message</code> instances is similar to that of an unmodifiable <code class="literal">Collection</code>, and the <code class="literal">MessageHeaders</code> map further exemplifies that.
Even though the <code class="literal">MessageHeaders</code> class implements <code class="literal">java.util.Map</code>, any attempt to invoke a <code class="literal">put</code> operation (or <span class="emphasis"><em>remove</em></span> or <span class="emphasis"><em>clear</em></span>) on a <code class="literal">MessageHeaders</code> instance results in an <code class="literal">UnsupportedOperationException</code>.</p>
<p>Rather than requiring the creation and population of a Map to pass into the GenericMessage constructor, Spring Integration does provide a far more convenient way to construct Messages: <code class="literal">MessageBuilder</code>.
The <code class="literal">MessageBuilder</code> provides two factory methods for creating <code class="literal">Message</code> instances from either an existing <code class="literal">Message</code> or with a payload <code class="literal">Object</code>.
When building from an existing <code class="literal">Message</code>, the headers and payload of that <code class="literal">Message</code> are copied to the new <code class="literal">Message</code>, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting">Message&lt;String&gt; message1 = MessageBuilder.withPayload(<span class="hl-string">"test"</span>)
        .setHeader(<span class="hl-string">"foo"</span>, <span class="hl-string">"bar"</span>)
        .build();

Message&lt;String&gt; message2 = MessageBuilder.fromMessage(message1).build();

assertEquals(<span class="hl-string">"test"</span>, message2.getPayload());
assertEquals(<span class="hl-string">"bar"</span>, message2.getHeaders().get(<span class="hl-string">"foo"</span>));</pre>
</div>
<p>If you need to create a <code class="literal">Message</code> with a new payload but still want to copy the headers from an existing <code class="literal">Message</code>, you can use one of the <span class="emphasis"><em>copy</em></span> methods, as the following example shows:</p>
<pre class="programlisting">Message&lt;String&gt; message3 = MessageBuilder.withPayload(<span class="hl-string">"test3"</span>)
        .copyHeaders(message1.getHeaders())
        .build();

Message&lt;String&gt; message4 = MessageBuilder.withPayload(<span class="hl-string">"test4"</span>)
        .setHeader(<span class="hl-string">"foo"</span>, <span class="hl-number">123</span>)
        .copyHeadersIfAbsent(message1.getHeaders())
        .build();

assertEquals(<span class="hl-string">"bar"</span>, message3.getHeaders().get(<span class="hl-string">"foo"</span>));
assertEquals(<span class="hl-number">123</span>, message4.getHeaders().get(<span class="hl-string">"foo"</span>));</pre>
<p>Note that the <code class="literal">copyHeadersIfAbsent</code> method does not overwrite existing values.
Also, in the preceding example, you can see how to set any user-defined header with <code class="literal">setHeader</code>.
Finally, there are <code class="literal">set</code> methods available for the predefined headers as well as a non-destructive method for setting any header (<code class="literal">MessageHeaders</code> also defines constants for the pre-defined header names).</p>
<p>You can also use <code class="literal">MessageBuilder</code> to set the priority of messages, as the following example shows:</p>
<pre class="programlisting">Message&lt;Integer&gt; importantMessage = MessageBuilder.withPayload(<span class="hl-number">99</span>)
        .setPriority(<span class="hl-number">5</span>)
        .build();

assertEquals(<span class="hl-number">5</span>, importantMessage.getHeaders().getPriority());

Message&lt;Integer&gt; lessImportantMessage = MessageBuilder.fromMessage(importantMessage)
        .setHeaderIfAbsent(IntegrationMessageHeaderAccessor.PRIORITY, <span class="hl-number">2</span>)
        .build();

assertEquals(<span class="hl-number">2</span>, lessImportantMessage.getHeaders().getPriority());</pre>
<p>The <code class="literal">priority</code> header is considered only when using a <code class="literal">PriorityChannel</code> (as described in the next chapter).
It is defined as a <code class="literal">java.lang.Integer</code>.</p>
</div>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="messaging-routing-chapter" href="#messaging-routing-chapter"></a>8.&nbsp;Message Routing</h2></div></div></div>

<p>This chapter covers the details of using Spring Integration to route messages.</p>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="router" href="#router"></a>8.1&nbsp;Routers</h2></div></div></div>

<p>This section covers how routers work.
It includes the following topics:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="xref" href="#router-overview" title="8.1.1&nbsp;Overview">Section&nbsp;8.1.1, &#8220;Overview&#8221;</a>
</li><li class="listitem">
<a class="xref" href="#router-common-parameters" title="8.1.2&nbsp;Common Router Parameters">Section&nbsp;8.1.2, &#8220;Common Router Parameters&#8221;</a>
</li><li class="listitem">
<a class="xref" href="#router-implementations" title="8.1.3&nbsp;Router Implementations">Section&nbsp;8.1.3, &#8220;Router Implementations&#8221;</a>
</li><li class="listitem">
<a class="xref" href="#router-namespace" title="8.1.4&nbsp;Configuring a Generic Router">Section&nbsp;8.1.4, &#8220;Configuring a Generic Router&#8221;</a>
</li><li class="listitem">
<a class="xref" href="#router-spel" title="8.1.5&nbsp;Routers and the Spring Expression Language (SpEL)">Section&nbsp;8.1.5, &#8220;Routers and the Spring Expression Language (SpEL)&#8221;</a>
</li><li class="listitem">
<a class="xref" href="#dynamic-routers" title="8.1.6&nbsp;Dynamic Routers">Section&nbsp;8.1.6, &#8220;Dynamic Routers&#8221;</a>
</li></ul></div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="router-overview" href="#router-overview"></a>8.1.1&nbsp;Overview</h3></div></div></div>

<p>Routers are a crucial element in many messaging architectures.
They consume messages from a message channel and forward each consumed message to one or more different message channels depending on a set of conditions.</p>
<p>Spring Integration provides the following routers:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="#router-implementations-payloadtyperouter" title="PayloadTypeRouter">Payload Type Router</a>
</li><li class="listitem">
<a class="link" href="#router-implementations-headervaluerouter" title="HeaderValueRouter">Header Value Router</a>
</li><li class="listitem">
<a class="link" href="#router-implementations-recipientlistrouter" title="RecipientListRouter">Recipient List Router</a>
</li><li class="listitem">
<a class="link" href="#xml-xpath-routing" title="38.5&nbsp;Routing XML Messages with XPath">XPath Router (part of the XML module)</a>
</li><li class="listitem">
<a class="link" href="#router-implementations-exception-router" title="Routing and Error Handling">Error Message Exception Type Router</a>
</li><li class="listitem">
<a class="link" href="#router-namespace" title="8.1.4&nbsp;Configuring a Generic Router">(Generic) Router</a>
</li></ul></div>
<p>Router implementations share many configuration parameters.
However, certain differences exist between routers.
Furthermore, the availability of configuration parameters depends on whether routers are used inside or outside of a chain.
In order to provide a quick overview, all available attributes are listed in the two following tables .</p>
<p>The following table shows the configuration parameters available for a router outside of a chain:</p>
<div class="table"><a name="d5e2460" href="#d5e2460"></a><p class="title"><b>Table&nbsp;8.1.&nbsp;Routers Outside of a Chain</b></p><div class="table-contents">

<table summary="Routers Outside of a Chain" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"><col class="col_4"><col class="col_5"><col class="col_6"><col class="col_7"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Attribute</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">router</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">header value router</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">xpath router</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">payload type router</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">recipient list route</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">exception type router</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>apply-sequence</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>default-output-channel</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>resolution-required</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>ignore-send-failures</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>timeout</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>id</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>auto-startup</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>input-channel</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>order</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>method</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>ref</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>expression</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>header-name</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>evaluate-as-string</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>xpath-expression-ref</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>converter</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="" align="left" valign="top">&nbsp;</td></tr></tbody></table>
</div></div><br class="table-break">
<p>The following table shows the configuration parameters available for a router inside of a chain:</p>
<div class="table"><a name="d5e2991" href="#d5e2991"></a><p class="title"><b>Table&nbsp;8.2.&nbsp;Routers Inside of a Chain</b></p><div class="table-contents">

<table summary="Routers Inside of a Chain" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"><col class="col_4"><col class="col_5"><col class="col_6"><col class="col_7"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Attribute</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">router</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">header value router</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">xpath router</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">payload type router</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">recipient list router</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">exception type router</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>apply-sequence</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>default-output-channel</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>resolution-required</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>ignore-send-failures</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>timeout</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>id</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>auto-startup</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>input-channel</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>order</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>method</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>ref</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>expression</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>header-name</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>evaluate-as-string</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>xpath-expression-ref</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>converter</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><div class="informalfigure">
<div class="mediaobject"><img src="images/tickmark.png" alt="tickmark"></div>
</div></td><td style="border-right: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="" align="left" valign="top">&nbsp;</td></tr></tbody></table>
</div></div><br class="table-break">
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>As of Spring Integration 2.1, router parameters have been more standardized across all router implementations.
Consequently, a few minor changes may break older Spring Integration based applications.</p>
<p>Since Spring Integration 2.1, the <code class="literal">ignore-channel-name-resolution-failures</code> attribute is removed in favor of consolidating its behavior with the <code class="literal">resolution-required</code> attribute.
Also, the <code class="literal">resolution-required</code> attribute now defaults to <code class="literal">true</code>.</p>
<p>Prior to these changes, the <code class="literal">resolution-required</code> attribute defaulted to <code class="literal">false</code>, causing messages to be silently dropped when no channel was resolved and no <code class="literal">default-output-channel</code> was set.
The new behavior requires at least one resolved channel and, by default, throws a <code class="literal">MessageDeliveryException</code> if no channel was determined (or an attempt to send was not successful).</p>
<p>If you do desire to drop messages silently, you can set <code class="literal">default-output-channel="nullChannel"</code>.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="router-common-parameters" href="#router-common-parameters"></a>8.1.2&nbsp;Common Router Parameters</h3></div></div></div>

<p>This section describes the parameters common to all router parameters (the parameters with all their boxes ticked in the two tables shown earlier in this chapter).</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="router-common-parameters-all" href="#router-common-parameters-all"></a>Inside and Outside of a Chain</h4></div></div></div>

<p>The following parameters are valid for all routers inside and outside of chains.</p>
<div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">apply-sequence</code></span></dt><dd>
This attribute specifies whether sequence number and size headers should be added to each message.
This optional attribute defaults to <code class="literal">false</code>.
</dd><dt><span class="term"><code class="literal">default-output-channel</code></span></dt><dd>
<p class="simpara">If set, this attribute provides a reference to the channel where messages should be sent if channel resolution fails to return any channels.
If no default output channel is provided, the router throws an exception.
If you would like to silently drop those messages instead, set the default output channel attribute value to <code class="literal">nullChannel</code>.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>A message is sent only to the <code class="literal">default-output-channel</code> if <code class="literal">resolution-required</code> is <code class="literal">false</code> and the channel is not resolved.</p>
</td></tr></table></div>
</dd><dt><span class="term"><code class="literal">resolution-required</code></span></dt><dd>
<p class="simpara">This attribute specifies whether channel names must always be successfully resolved to channel instances that exist.
If set to <code class="literal">true</code>, a <code class="literal">MessagingException</code> is raised when the channel cannot be resolved.
Setting this attribute to <code class="literal">false</code> causes any unresovable channels to be ignored.
This optional attribute defaults to <code class="literal">true</code>.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>A Message is sent only to the <code class="literal">default-output-channel</code>, if specified, when <code class="literal">resolution-required</code> is <code class="literal">false</code> and the channel is not resolved.</p>
</td></tr></table></div>
</dd><dt><span class="term"><code class="literal">ignore-send-failures</code></span></dt><dd>
<p class="simpara">If set to <code class="literal">true</code>, failures to send to a message channel is ignored.
If set to <code class="literal">false</code>, a <code class="literal">MessageDeliveryException</code> is thrown instead, and, if the router resolves more than one channel, any subsequent channels do not receive the message.</p>
<p class="simpara">The exact behavior of this attribute depends on the type of the <code class="literal">Channel</code> to which the messages are sent.
For example, when using direct channels (single threaded), send failures can be caused by exceptions thrown by components much further downstream.
However, when sending messages to a simple queue channel (asynchronous), the likelihood of an exception to be thrown is rather remote.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>While most routers route to a single channel, they can return more than one channel name.
The <code class="literal">recipient-list-router</code>, for instance, does exactly that.
If you set this attribute to <code class="literal">true</code> on a router that only routes to a single channel, any caused exception is swallowed, which usually makes little sense.
In that case, it would be better to catch the exception in an error flow at the flow entry point.
Therefore, setting the <code class="literal">ignore-send-failures</code> attribute to <code class="literal">true</code> usually makes more sense when the router implementation returns more than one channel name, because the other channel(s) following the one that fails would still receive the message.</p>
</td></tr></table></div>
<p class="simpara">This attribute defaults to <code class="literal">false</code>.</p>
</dd><dt><span class="term"><code class="literal">timeout</code></span></dt><dd>
The <code class="literal">timeout</code> attribute specifies the maximum amount of time in milliseconds to wait when sending messages to the target Message Channels.
By default, the send operation blocks indefinitely.
</dd></dl></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="router-common-parameters-top" href="#router-common-parameters-top"></a>Top-Level (Outside of a Chain)</h4></div></div></div>

<p>The following parameters are valid only across all top-level routers that are outside of chains.</p>
<div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">id</code></span></dt><dd>
Identifies the underlying Spring bean definition, which, in the case of routers, is an instance of <code class="literal">EventDrivenConsumer</code> or <code class="literal">PollingConsumer</code>, depending on whether the router&#8217;s <code class="literal">input-channel</code> is a <code class="literal">SubscribableChannel</code> or a <code class="literal">PollableChannel</code>, respectively.
This is an optional attribute.
</dd><dt><span class="term"><code class="literal">auto-startup</code></span></dt><dd>
This "<code class="literal">lifecycle</code>" attribute signaled whether this component should be started during startup of the application context.
This optional attribute defaults to <code class="literal">true</code>.
</dd><dt><span class="term"><code class="literal">input-channel</code></span></dt><dd>
The receiving message channel of this endpoint.
</dd><dt><span class="term"><code class="literal">order</code></span></dt><dd>
This attribute defines the order for invocation when this endpoint is connected as a subscriber to a channel.
This is particularly relevant when that channel uses a failover dispatching strategy.
It has no effect when this endpoint itself is a polling consumer for a channel with a queue.
</dd></dl></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="router-implementations" href="#router-implementations"></a>8.1.3&nbsp;Router Implementations</h3></div></div></div>

<p>Since content-based routing often requires some domain-specific logic, most use cases require Spring Integration&#8217;s options for delegating to POJOs by using either the XML namespace support or annotations.
Both of these are discussed later.
However, we first present a couple of implementations that fulfill common requirements.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="router-implementations-payloadtyperouter" href="#router-implementations-payloadtyperouter"></a><code class="literal">PayloadTypeRouter</code></h4></div></div></div>

<p>A <code class="literal">PayloadTypeRouter</code> sends messages to the channel defined by payload-type mappings, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"payloadTypeRouter"</span>
      <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.router.PayloadTypeRouter"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"channelMapping"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;map&gt;</span>
            <span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"java.lang.String"</span> <span class="hl-attribute">value-ref</span>=<span class="hl-value">"stringChannel"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"java.lang.Integer"</span> <span class="hl-attribute">value-ref</span>=<span class="hl-value">"integerChannel"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/map&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
</div>
<p>Configuration of the <code class="literal">PayloadTypeRouter</code> is also supported by the namespace provided by Spring Integration (see <code class="literal">&lt;&lt;configuration-namespace&gt;&gt;</code>), which essentially simplifies configuration by combining the <code class="literal">&lt;router/&gt;</code> configuration and its corresponding implementation (defined by using a <code class="literal">&lt;bean/&gt;</code> element) into a single and more concise configuration element.
The following example shows a <code class="literal">PayloadTypeRouter</code> configuration that is equivalent to the one above but uses the namespace support:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:payload-type-router</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"routingChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:mapping</span> <span class="hl-attribute">type</span>=<span class="hl-value">"java.lang.String"</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"stringChannel"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;int:mapping</span> <span class="hl-attribute">type</span>=<span class="hl-value">"java.lang.Integer"</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"integerChannel"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/int:payload-type-router&gt;</span></pre>
</div>
<p>The following example shows the equivalent router configured in Java:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "routingChannel")</span></em>
<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> PayloadTypeRouter router() {
    PayloadTypeRouter router = <span class="hl-keyword">new</span> PayloadTypeRouter();
    router.setChannelMapping(String.<span class="hl-keyword">class</span>.getName(), <span class="hl-string">"stringChannel"</span>);
    router.setChannelMapping(Integer.<span class="hl-keyword">class</span>.getName(), <span class="hl-string">"integerChannel"</span>);
    <span class="hl-keyword">return</span> router;
}</pre>
</div>
<p>When using the Java DSL, there are two options.</p>
<p>First, you can define the router object as shown in the preceding example:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> IntegrationFlow routerFlow1() {
    <span class="hl-keyword">return</span> IntegrationFlows.from(<span class="hl-string">"routingChannel"</span>)
            .route(router())
            .get();
}

<span class="hl-keyword">public</span> PayloadTypeRouter router() {
    PayloadTypeRouter router = <span class="hl-keyword">new</span> PayloadTypeRouter();
    router.setChannelMapping(String.<span class="hl-keyword">class</span>.getName(), <span class="hl-string">"stringChannel"</span>);
    router.setChannelMapping(Integer.<span class="hl-keyword">class</span>.getName(), <span class="hl-string">"integerChannel"</span>);
    <span class="hl-keyword">return</span> router;
}</pre>
<p>Note that the router can be, but does not have to be, a <code class="literal">@Bean</code>.
The flow registers it if it is not a <code class="literal">@Bean</code>.</p>
<p>Second, you can define the routing function within the DSL flow itself, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> IntegrationFlow routerFlow2() {
    <span class="hl-keyword">return</span> IntegrationFlows.from(<span class="hl-string">"routingChannel"</span>)
            .&lt;Object, Class&lt;?&gt;&gt;route(Object::getClass, m -&gt; m
                    .channelMapping(String.<span class="hl-keyword">class</span>, <span class="hl-string">"stringChannel"</span>)
                    .channelMapping(Integer.<span class="hl-keyword">class</span>, <span class="hl-string">"integerChannel"</span>))
            .get();
}</pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="router-implementations-headervaluerouter" href="#router-implementations-headervaluerouter"></a><code class="literal">HeaderValueRouter</code></h4></div></div></div>

<p>A <code class="literal">HeaderValueRouter</code> sends Messages to the channel based on the individual header value mappings.
When a <code class="literal">HeaderValueRouter</code> is created, it is initialized with the name of the header to be evaluated.
The value of the header could be one of two things:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
An arbitrary value
</li><li class="listitem">
A channel name
</li></ul></div>
<p>If it is an arbitrary value, additional mappings for these header values to channel names are required.
Otherwise, no additional configuration is needed.</p>
<p>Spring Integration provides a simple namespace-based XML configuration to configure a <code class="literal">HeaderValueRouter</code>.
The following example demonstrates configuration for the <code class="literal">HeaderValueRouter</code> when mapping of header values to channels is required:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:header-value-router</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"routingChannel"</span> <span class="hl-attribute">header-name</span>=<span class="hl-value">"testHeader"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:mapping</span> <span class="hl-attribute">value</span>=<span class="hl-value">"someHeaderValue"</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"channelA"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;int:mapping</span> <span class="hl-attribute">value</span>=<span class="hl-value">"someOtherHeaderValue"</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"channelB"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/int:header-value-router&gt;</span></pre>
</div>
<p>During the resolution process, the router defined in the preceding example may encounter channel resolution failures, causing an exception.
If you want to suppress such exceptions and send unresolved messages to the default output channel (identified with the <code class="literal">default-output-channel</code> attribute) set <code class="literal">resolution-required</code> to <code class="literal">false</code>.</p>
<p>Normally, messages for which the header value is not explicitly mapped to a channel are sent to the <code class="literal">default-output-channel</code>.
However, when the header value is mapped to a channel name but the channel cannot be resolved, setting the <code class="literal">resolution-required</code> attribute to <code class="literal">false</code> results in routing such messages to the <code class="literal">default-output-channel</code>.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>As of Spring Integration 2.1, the attribute was changed from <code class="literal">ignore-channel-name-resolution-failures</code> to <code class="literal">resolution-required</code>.
Attribute <code class="literal">resolution-required</code> defaults to <code class="literal">true</code>.</p>
</td></tr></table></div>
<p>The following example shows the equivalent router configured in Java:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "routingChannel")</span></em>
<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> HeaderValueRouter router() {
    HeaderValueRouter router = <span class="hl-keyword">new</span> HeaderValueRouter(<span class="hl-string">"testHeader"</span>);
    router.setChannelMapping(<span class="hl-string">"someHeaderValue"</span>, <span class="hl-string">"channelA"</span>);
    router.setChannelMapping(<span class="hl-string">"someOtherHeaderValue"</span>, <span class="hl-string">"channelB"</span>);
    <span class="hl-keyword">return</span> router;
}</pre>
</div>
<p>When using the Java DSL, there are two options.
First, you can define the router object as shown in the preceding example:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> IntegrationFlow routerFlow1() {
    <span class="hl-keyword">return</span> IntegrationFlows.from(<span class="hl-string">"routingChannel"</span>)
            .route(router())
            .get();
}

<span class="hl-keyword">public</span> HeaderValueRouter router() {
    HeaderValueRouter router = <span class="hl-keyword">new</span> HeaderValueRouter(<span class="hl-string">"testHeader"</span>);
    router.setChannelMapping(<span class="hl-string">"someHeaderValue"</span>, <span class="hl-string">"channelA"</span>);
    router.setChannelMapping(<span class="hl-string">"someOtherHeaderValue"</span>, <span class="hl-string">"channelB"</span>);
    <span class="hl-keyword">return</span> router;
}</pre>
</div>
<p>Note that the router can be, but does not have to be, a <code class="literal">@Bean</code>.
The flow registers it if it is not a <code class="literal">@Bean</code>.</p>
<p>Second, you can define the routing function within the DSL flow itself, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> IntegrationFlow routerFlow2() {
    <span class="hl-keyword">return</span> IntegrationFlows.from(<span class="hl-string">"routingChannel"</span>)
            .&lt;Message&lt;?&gt;, String&gt;route(m -&gt; m.getHeaders().get(<span class="hl-string">"testHeader"</span>, String.<span class="hl-keyword">class</span>), m -&gt; m
                    .channelMapping(<span class="hl-string">"someHeaderValue"</span>, <span class="hl-string">"channelA"</span>)
                    .channelMapping(<span class="hl-string">"someOtherHeaderValue"</span>, <span class="hl-string">"channelB"</span>),
                e -&gt; e.id(<span class="hl-string">"headerValueRouter"</span>))
            .get();
}</pre>
</div>
<p>Configuration where mapping of header values to channel names is not required, because header values themselves represent channel names.
The following example shows a router that does not require mapping of header values to channel names:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:header-value-router</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"routingChannel"</span> <span class="hl-attribute">header-name</span>=<span class="hl-value">"testHeader"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Since Spring Integration 2.1, the behavior of resolving channels is more explicit.
For example, if you omit the <code class="literal">default-output-channel</code> attribute, the router was unable to resolve at least one valid channel, and any channel name resolution failures were ignored by setting <code class="literal">resolution-required</code> to <code class="literal">false</code>, then a <code class="literal">MessageDeliveryException</code> is thrown.</p>
<p>Basically, by default, the router must be able to route messages successfully to at least one channel.
If you really want to drop messages, you must also have <code class="literal">default-output-channel</code> set to <code class="literal">nullChannel</code>.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="router-implementations-recipientlistrouter" href="#router-implementations-recipientlistrouter"></a><code class="literal">RecipientListRouter</code></h4></div></div></div>

<p>A <code class="literal">RecipientListRouter</code> sends each received message to a statically defined list of message channels.
The following example creates a <code class="literal">RecipientListRouter</code>:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"recipientListRouter"</span>
      <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.router.RecipientListRouter"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"channels"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;list&gt;</span>
            <span class="hl-tag">&lt;ref</span> <span class="hl-attribute">bean</span>=<span class="hl-value">"channel1"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;ref</span> <span class="hl-attribute">bean</span>=<span class="hl-value">"channel2"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;ref</span> <span class="hl-attribute">bean</span>=<span class="hl-value">"channel3"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/list&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
</div>
<p>Spring Integration also provides namespace support for the <code class="literal">RecipientListRouter</code> configuration (see <a class="xref" href="#configuration-namespace" title="E.1&nbsp;Namespace Support">Section&nbsp;E.1, &#8220;Namespace Support&#8221;</a>) as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:recipient-list-router</span> <span class="hl-attribute">id</span>=<span class="hl-value">"customRouter"</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"routingChannel"</span>
        <span class="hl-attribute">timeout</span>=<span class="hl-value">"1234"</span>
        <span class="hl-attribute">ignore-send-failures</span>=<span class="hl-value">"true"</span>
        <span class="hl-attribute">apply-sequence</span>=<span class="hl-value">"true"</span><span class="hl-tag">&gt;</span>
  <span class="hl-tag">&lt;int:recipient</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"channel1"</span><span class="hl-tag">/&gt;</span>
  <span class="hl-tag">&lt;int:recipient</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"channel2"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:recipient-list-router&gt;</span></pre>
</div>
<p>The following example shows the equivalent router configured in Java:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "routingChannel")</span></em>
<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> RecipientListRouter router() {
    RecipientListRouter router = <span class="hl-keyword">new</span> RecipientListRouter();
    router.setSendTimeout(<span class="hl-number">1</span>_<span class="hl-number">234L</span>);
    router.setIgnoreSendFailures(true);
    router.setApplySequence(true);
    router.addRecipient(<span class="hl-string">"channel1"</span>);
    router.addRecipient(<span class="hl-string">"channel2"</span>);
    router.addRecipient(<span class="hl-string">"channel3"</span>);
    <span class="hl-keyword">return</span> router;
}</pre>
</div>
<p>The following example shows the equivalent router configured by using the Java DSL:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> IntegrationFlow routerFlow() {
    <span class="hl-keyword">return</span> IntegrationFlows.from(<span class="hl-string">"routingChannel"</span>)
            .routeToRecipients(r -&gt; r
                    .applySequence(true)
                    .ignoreSendFailures(true)
                    .recipient(<span class="hl-string">"channel1"</span>)
                    .recipient(<span class="hl-string">"channel2"</span>)
                    .recipient(<span class="hl-string">"channel3"</span>)
                    .sendTimeout(<span class="hl-number">1</span>_<span class="hl-number">234L</span>))
            .get();
}</pre>
</div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The <span class="emphasis"><em>apply-sequence</em></span> flag here has the same effect as it does for a publish-subscribe-channel, and, as with a publish-subscribe-channel, it is disabled by default on the <code class="literal">recipient-list-router</code>.
See <a class="xref" href="#channel-configuration-pubsubchannel" title="PublishSubscribeChannel Configuration">the section called &#8220;<code class="literal">PublishSubscribeChannel</code> Configuration&#8221;</a> for more information.</p>
</td></tr></table></div>
<p>Another convenient option when configuring a <code class="literal">RecipientListRouter</code> is to use Spring Expression Language (SpEL) support as selectors for individual recipient channels.
Doing so is similar to using a filter at the beginning of a <span class="emphasis"><em>chain</em></span> to act as a "<code class="literal">selective consumer</code>".
However, in this case, it is all combined rather concisely into the router&#8217;s configuration, as the following example shows:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:recipient-list-router</span> <span class="hl-attribute">id</span>=<span class="hl-value">"customRouter"</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"routingChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:recipient</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"channel1"</span> <span class="hl-attribute">selector-expression</span>=<span class="hl-value">"payload.equals('foo')"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int:recipient</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"channel2"</span> <span class="hl-attribute">selector-expression</span>=<span class="hl-value">"headers.containsKey('bar')"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:recipient-list-router&gt;</span></pre>
<p>In the preceding configuration, a SpEL expression identified by the <code class="literal">selector-expression</code> attribute is evaluated to determine whether this recipient should be included in the recipient list for a given input message.
The evaluation result of the expression must be a boolean.
If this attribute is not defined, the channel is always among the list of recipients.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="recipient-list-router-management" href="#recipient-list-router-management"></a><code class="literal">RecipientListRouterManagement</code></h4></div></div></div>

<p>Starting with version 4.1, the <code class="literal">RecipientListRouter</code> provides several operations to manipulate recipients dynamically at runtime.
These management operations are presented by <code class="literal">RecipientListRouterManagement</code> through the <code class="literal">@ManagedResource</code> annotation.
They are available by using <a class="xref" href="#control-bus" title="12.6&nbsp;Control Bus">Section&nbsp;12.6, &#8220;Control Bus&#8221;</a> as well as by using JMX, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;control-bus</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"controlBus"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;recipient-list-router</span> <span class="hl-attribute">id</span>=<span class="hl-value">"simpleRouter"</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"routingChannelA"</span><span class="hl-tag">&gt;</span>
   <span class="hl-tag">&lt;recipient</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"channel1"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/recipient-list-router&gt;</span>

<span class="hl-tag">&lt;channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"channel2"</span><span class="hl-tag">/&gt;</span></pre>
<pre class="programlisting">messagingTemplate.convertAndSend(controlBus, <span class="hl-string">"@'simpleRouter.handler'.addRecipient('channel2')"</span>);</pre>
</div>
<p>From the application start up the <code class="literal">simpleRouter</code>, has only one <code class="literal">channel1</code> recipient.
But after the <code class="literal">addRecipient</code> command, <code class="literal">channel2</code> recipient is added.
It is a "<code class="literal">registering an interest in something that is part of the message</code>" use case, when we may be interested in messages from the router at some time period, so we are subscribing to the the <code class="literal">recipient-list-router</code> and, at some point, decide to unsubscribe.</p>
<p>Because of the runtime management operation for the <code class="literal">&lt;recipient-list-router&gt;</code>, it can be configured without any <code class="literal">&lt;recipient&gt;</code> from the start.
In this case, the behavior of <code class="literal">RecipientListRouter</code> is the same when there is no one matching recipient for the message.
If <code class="literal">defaultOutputChannel</code> is configured, the message is sent there.
Otherwise the <code class="literal">MessageDeliveryException</code> is thrown.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="router-implementations-xpath-router" href="#router-implementations-xpath-router"></a>XPath Router</h4></div></div></div>

<p>The XPath Router is part of the XML Module.
See <a class="xref" href="#xml-xpath-routing" title="38.5&nbsp;Routing XML Messages with XPath">Section&nbsp;38.5, &#8220;Routing XML Messages with XPath&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="router-implementations-exception-router" href="#router-implementations-exception-router"></a>Routing and Error Handling</h4></div></div></div>

<p>Spring Integration also provides a special type-based router called <code class="literal">ErrorMessageExceptionTypeRouter</code> for routing error messages (defined as messages whose <code class="literal">payload</code> is a <code class="literal">Throwable</code> instance).
<code class="literal">ErrorMessageExceptionTypeRouter</code> is similar to the <code class="literal">PayloadTypeRouter</code>.
In fact, they are almost identical.
The only difference is that, while <code class="literal">PayloadTypeRouter</code> navigates the instance hierarchy of a payload instance (for example, <code class="literal">payload.getClass().getSuperclass()</code>) to find the most specific type and channel mappings,
the <code class="literal">ErrorMessageExceptionTypeRouter</code> navigates the hierarchy of <span class="emphasis"><em>exception causes</em></span> (for example, <code class="literal">payload.getCause()</code>)
to find the most specific <code class="literal">Throwable</code> type or channel mappings and uses <code class="literal">mappingClass.isInstance(cause)</code> to match the
<code class="literal">cause</code> to the class or any super class.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Since version 4.3 the <code class="literal">ErrorMessageExceptionTypeRouter</code> loads all mapping classes during the initialization
phase to fail-fast for a <code class="literal">ClassNotFoundException</code>.</p>
</td></tr></table></div>
<p>The following example shows a sample configuration for <code class="literal">ErrorMessageExceptionTypeRouter</code>:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:exception-type-router</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"inputChannel"</span>
                           <span class="hl-attribute">default-output-channel</span>=<span class="hl-value">"defaultChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:mapping</span> <span class="hl-attribute">exception-type</span>=<span class="hl-value">"java.lang.IllegalArgumentException"</span>
                 <span class="hl-attribute">channel</span>=<span class="hl-value">"illegalChannel"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int:mapping</span> <span class="hl-attribute">exception-type</span>=<span class="hl-value">"java.lang.NullPointerException"</span>
                 <span class="hl-attribute">channel</span>=<span class="hl-value">"npeChannel"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:exception-type-router&gt;</span>

<span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"illegalChannel"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"npeChannel"</span><span class="hl-tag"> /&gt;</span></pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="router-namespace" href="#router-namespace"></a>8.1.4&nbsp;Configuring a Generic Router</h3></div></div></div>

<p>Spring Integration provides a generic router. You can use it for general-purpose routing (as opposed to the other routers provided by Spring Integration, each of which has some form of specialization).</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_configuring_a_content_based_router_with_xml" href="#_configuring_a_content_based_router_with_xml"></a>Configuring a Content-based Router with XML</h4></div></div></div>

<p>The <code class="literal">router</code> element provides a way to connect a router to an input channel and also accepts the optional <code class="literal">default-output-channel</code> attribute.
The <code class="literal">ref</code> attribute references the bean name of a custom router implementation (which must extend <code class="literal">AbstractMessageRouter</code>).
The following example shows three generic routers:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:router</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"payloadTypeRouter"</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input1"</span>
            <span class="hl-attribute">default-output-channel</span>=<span class="hl-value">"defaultOutput1"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int:router</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"recipientListRouter"</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input2"</span>
            <span class="hl-attribute">default-output-channel</span>=<span class="hl-value">"defaultOutput2"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int:router</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"customRouter"</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input3"</span>
            <span class="hl-attribute">default-output-channel</span>=<span class="hl-value">"defaultOutput3"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;beans:bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"customRouterBean"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.foo.MyCustomRouter"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>Alternatively, <code class="literal">ref</code> may point to a POJO that contains the <code class="literal">@Router</code> annotation (shown later), or you can combine the <code class="literal">ref</code> with an explicit method name.
Specifying a method applies the same behavior described in the <code class="literal">@Router</code> annotation section, later in this document.
The following example defines a router that points to a POJO in its <code class="literal">ref</code> attribute:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:router</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"somePojo"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"someMethod"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>We generally recommend using a <code class="literal">ref</code> attribute if the custom router implementation is referenced in other <code class="literal">&lt;router&gt;</code> definitions.
However if the custom router implementation should be scoped to a single definition of the <code class="literal">&lt;router&gt;</code>, you can provide an inner bean definition, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:router</span> <span class="hl-attribute">method</span>=<span class="hl-value">"someMethod"</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input3"</span>
            <span class="hl-attribute">default-output-channel</span>=<span class="hl-value">"defaultOutput3"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;beans:bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.foo.MyCustomRouter"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:router&gt;</span></pre>
</div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Using both the <code class="literal">ref</code> attribute and an inner handler definition in the same <code class="literal">&lt;router&gt;</code> configuration is not allowed.
Doing so creates an ambiguous condition and throws an exception.</p>
</td></tr></table></div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>If the <code class="literal">ref</code> attribute references a bean that extends <code class="literal">AbstractMessageProducingHandler</code> (such as routers provided by the framework itself), the configuration is optimized to reference the router directly.
In this case, each <code class="literal">ref</code> attribute must refer to a separate bean instance (or a <code class="literal">prototype</code>-scoped bean) or use the inner <code class="literal">&lt;bean/&gt;</code> configuration type.
However, this optimization applies only if you do not provide any router-specific attributes in the router XML definition.
If you inadvertently reference the same message handler from multiple beans, you get a configuration exception.</p>
</td></tr></table></div>
<p>The following example shows the equivalent router configured in Java:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<em><span class="hl-annotation" style="color: gray">@Router(inputChannel = "routingChannel")</span></em>
<span class="hl-keyword">public</span> AbstractMessageRouter myCustomRouter() {
    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> AbstractMessageRouter() {

        <em><span class="hl-annotation" style="color: gray">@Override</span></em>
        <span class="hl-keyword">protected</span> Collection&lt;MessageChannel&gt; determineTargetChannels(Message&lt;?&gt; message) {
            <span class="hl-keyword">return</span> <span class="hl-comment">// determine channel(s) for message</span>
        }

    };
}</pre>
</div>
<p>The following example shows the equivalent router configured by using the Java DSL:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> IntegrationFlow routerFlow() {
    <span class="hl-keyword">return</span> IntegrationFlows.from(<span class="hl-string">"routingChannel"</span>)
            .route(myCustomRouter())
            .get();
}

<span class="hl-keyword">public</span> AbstractMessageRouter myCustomRouter() {
    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> AbstractMessageRouter() {

        <em><span class="hl-annotation" style="color: gray">@Override</span></em>
        <span class="hl-keyword">protected</span> Collection&lt;MessageChannel&gt; determineTargetChannels(Message&lt;?&gt; message) {
            <span class="hl-keyword">return</span> <span class="hl-comment">// determine channel(s) for message</span>
        }

    };
}</pre>
</div>
<p>Alternately, you can route on data from the message payload, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> IntegrationFlow routerFlow() {
    <span class="hl-keyword">return</span> IntegrationFlows.from(<span class="hl-string">"routingChannel"</span>)
            .route(String.<span class="hl-keyword">class</span>, p -&gt; p.contains(<span class="hl-string">"foo"</span>) ? <span class="hl-string">"fooChannel"</span> : <span class="hl-string">"barChannel"</span>)
            .get();
}</pre>
</div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="router-spel" href="#router-spel"></a>8.1.5&nbsp;Routers and the Spring Expression Language (SpEL)</h3></div></div></div>

<p>Sometimes, the routing logic may be simple, and writing a separate class for it and configuring it as a bean may seem like overkill.
As of Spring Integration 2.0, we offer an alternative that lets you use SpEL to implement simple computations that previously required a custom POJO router.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>For more information about the Spring Expression Language, see the <a class="ulink" href="https://docs.spring.io/spring/docs/current/spring-framework-reference/core.html#expressions" target="_top">relevant chapter in the Spring Framework Reference Guide</a>:</p>
</td></tr></table></div>
<p>Generally, a SpEL expression is evaluated and its result is mapped to a channel, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:router</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"inChannel"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"payload.paymentType"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:mapping</span> <span class="hl-attribute">value</span>=<span class="hl-value">"CASH"</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"cashPaymentChannel"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int:mapping</span> <span class="hl-attribute">value</span>=<span class="hl-value">"CREDIT"</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"authorizePaymentChannel"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int:mapping</span> <span class="hl-attribute">value</span>=<span class="hl-value">"DEBIT"</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"authorizePaymentChannel"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:router&gt;</span></pre>
</div>
<p>The following example shows the equivalent router configured in Java:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Router(inputChannel = "routingChannel")</span></em>
<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> ExpressionEvaluatingRouter router() {
    ExpressionEvaluatingRouter router = <span class="hl-keyword">new</span> ExpressionEvaluatingRouter(<span class="hl-string">"payload.paymentType"</span>);
    router.setChannelMapping(<span class="hl-string">"CASH"</span>, <span class="hl-string">"cashPaymentChannel"</span>);
    router.setChannelMapping(<span class="hl-string">"CREDIT"</span>, <span class="hl-string">"authorizePaymentChannel"</span>);
    router.setChannelMapping(<span class="hl-string">"DEBIT"</span>, <span class="hl-string">"authorizePaymentChannel"</span>);
    <span class="hl-keyword">return</span> router;
}</pre>
</div>
<p>The following example shows the equivalent router configured in the Java DSL:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> IntegrationFlow routerFlow() {
    <span class="hl-keyword">return</span> IntegrationFlows.from(<span class="hl-string">"routingChannel"</span>)
        .route(<span class="hl-string">"payload.paymentType"</span>, r -&gt; r
            .channelMapping(<span class="hl-string">"CASH"</span>, <span class="hl-string">"cashPaymentChannel"</span>)
            .channelMapping(<span class="hl-string">"CREDIT"</span>, <span class="hl-string">"authorizePaymentChannel"</span>)
            .channelMapping(<span class="hl-string">"DEBIT"</span>, <span class="hl-string">"authorizePaymentChannel"</span>))
        .get();
}</pre>
</div>
<p>To simplify things even more, the SpEL expression may evaluate to a channel name, as the following expression shows:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:router</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"inChannel"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"payload + 'Channel'"</span><span class="hl-tag">/&gt;</span></pre>
<p>In the preceding configuration, the result channel is computed by the SpEL expression, which concatenates the value of the <code class="literal">payload</code> with the literal <code class="literal">String</code>, <span class="emphasis"><em>Channel</em></span>.</p>
<p>Another virtue of SpEL for configuring routers is that an expression can return a <code class="literal">Collection</code>, effectively making every <code class="literal">&lt;router&gt;</code> a recipient list router.
Whenever the expression returns multiple channel values, the message is forwarded to each channel.
The following example shows such an expression:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:router</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"inChannel"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"headers.channels"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>In the above configuration, if the message includes a header with a name of <span class="emphasis"><em>channels</em></span> and the value of that header is a <code class="literal">List</code> of channel names, the message is sent to each channel in the list.
You may also find collection projection and collection selection expressions useful when you need to select multiple channels.
For further information, see:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="ulink" href="http://static.springsource.org/spring/docs/current/spring-framework-reference/html/expressions.html#expressions-collection-projection" target="_top">Collection Projection</a>
</li><li class="listitem">
<a class="ulink" href="http://static.springsource.org/spring/docs/current/spring-framework-reference/html/expressions.html#expressions-collection-selection" target="_top">Collection Selection</a>
</li></ul></div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="router-annotation" href="#router-annotation"></a>Configuring a Router with Annotations</h4></div></div></div>

<p>When using <code class="literal">@Router</code> to annotate a method, the method may return either a <code class="literal">MessageChannel</code> or a <code class="literal">String</code> type.
In the latter case, the endpoint resolves the channel name as it does for the default output channel.
Additionally, the method may return either a single value or a collection.
If a collection is returned, the reply message is sent to multiple channels.
To summarize, the following method signatures are all valid:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Router</span></em>
<span class="hl-keyword">public</span> MessageChannel route(Message message) {...}

<em><span class="hl-annotation" style="color: gray">@Router</span></em>
<span class="hl-keyword">public</span> List&lt;MessageChannel&gt; route(Message message) {...}

<em><span class="hl-annotation" style="color: gray">@Router</span></em>
<span class="hl-keyword">public</span> String route(Foo payload) {...}

<em><span class="hl-annotation" style="color: gray">@Router</span></em>
<span class="hl-keyword">public</span> List&lt;String&gt; route(Foo payload) {...}</pre>
</div>
<p>In addition to payload-based routing, a message may be routed based on metadata available within the message header as either a property or an attribute.
In this case, a method annotated with <code class="literal">@Router</code> may include a parameter annotated with <code class="literal">@Header</code>, which is mapped to a header value as the following example shows and documented in <a class="xref" href="#annotations" title="E.5&nbsp;Annotation Support">Section&nbsp;E.5, &#8220;Annotation Support&#8221;</a>:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Router</span></em>
<span class="hl-keyword">public</span> List&lt;String&gt; route(<em><span class="hl-annotation" style="color: gray">@Header("orderStatus")</span></em> OrderStatus status)</pre>
</div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>For routing of XML-based Messages, including XPath support, see <a class="xref" href="#xml" title="38.&nbsp;XML Support - Dealing with XML Payloads">Chapter&nbsp;38, <i>XML Support - Dealing with XML Payloads</i></a>.</p>
</td></tr></table></div>
<p>See also <a class="xref" href="#java-dsl-routers" title="11.7&nbsp;Message Routers">Section&nbsp;11.7, &#8220;Message Routers&#8221;</a> in the Java DSL chapter for more information about router configuration.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="dynamic-routers" href="#dynamic-routers"></a>8.1.6&nbsp;Dynamic Routers</h3></div></div></div>

<p>Spring Integration provides quite a few different router configurations for common content-based routing use cases as well as the option of implementing custom routers as POJOs.
For example, <code class="literal">PayloadTypeRouter</code> provides a simple way to configure a router that computes channels based on the payload type of the incoming message while <code class="literal">HeaderValueRouter</code> provides the same convenience in configuring a router that computes channels by evaluating the value of a particular message Header.
There are also expression-based (SpEL) routers, in which the channel is determined based on evaluating an expression.
All of these type of routers exhibit some dynamic characteristics.</p>
<p>However, these routers all require static configuration.
Even in the case of expression-based routers, the expression itself is defined as part of the router configuration, which means that the same expression operating on the same value always results in the computation of the same channel.
This is acceptable in most cases, since such routes are well defined and therefore predictable.
But there are times when we need to change router configurations dynamically so that message flows may be routed to a different channel.</p>
<p>For example, you might want to bring down some part of your system for maintenance and temporarily re-reroute messages to a different message flow.
As another example, you may want to introduce more granularity to your message flow by adding another route to handle a more concrete type of <code class="literal">java.lang.Number</code> (in the case of <code class="literal">PayloadTypeRouter</code>).</p>
<p>Unfortunately, with static router configuration to accomplish either of those goals, you would have to bring down your entire application, change the configuration of the router (change routes), and bring the application back up.
This is obviously not a solution anyone wants.</p>
<p>The <a class="ulink" href="http://www.eaipatterns.com/DynamicRouter.html" target="_top">dynamic router</a> pattern describes the mechanisms by which you can change or configure routers dynamically without bringing down the system or individual routers.&nbsp;</p>
<p>Before we get into the specifics of how Spring Integration supports dynamic routing, we need to consider the typical flow of a router:</p>
<div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
Compute a channel identifier, which is a value calculated by the router once it receives the message.
Typically, it is a String or an instance of the actual <code class="literal">MessageChannel</code>.
</li><li class="listitem">
Resolve the channel identifier to a channel name.
We describe specifics of this process later in this section.
</li><li class="listitem">
Resolve the channel name to the actual <code class="literal">MessageChannel</code>
</li></ol></div>
<p>There is not much that can be done with regard to dynamic routing if Step 1 results in the actual instance of the <code class="literal">MessageChannel</code>, because the <code class="literal">MessageChannel</code> is the final product of any router&#8217;s job.
However, if the first step results in a channel identifier that is not an instance of <code class="literal">MessageChannel</code>, you have quite a few possible ways to influence the process of deriving the <code class="literal">MessageChannel</code>.
Consider the following example of a payload type router:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:payload-type-router</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"routingChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:mapping</span> <span class="hl-attribute">type</span>=<span class="hl-value">"java.lang.String"</span>  <span class="hl-attribute">channel</span>=<span class="hl-value">"channel1"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;int:mapping</span> <span class="hl-attribute">type</span>=<span class="hl-value">"java.lang.Integer"</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"channel2"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/int:payload-type-router&gt;</span></pre>
</div>
<p>Within the context of a payload type router, the three steps mentioned earlier would be realized as follows:</p>
<div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
Compute a channel identifier that is the fully qualified name of the payload type (for example, <code class="literal">java.lang.String</code>).
</li><li class="listitem">
Resolve the channel identifier to a channel name, where the result of the previous step is used to select the appropriate value from the payload type mapping defined in the <code class="literal">mapping</code> element.
</li><li class="listitem">
Resolve the channel name to the actual instance of the <code class="literal">MessageChannel</code> as a reference to a bean within the application context (which is hopefully a <code class="literal">MessageChannel</code>) identified by the result of the previous step.
</li></ol></div>
<p>In other words, each step feeds the next step until the process completes.</p>
<p>Now consider an example of a header value router:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:header-value-router</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"inputChannel"</span> <span class="hl-attribute">header-name</span>=<span class="hl-value">"testHeader"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:mapping</span> <span class="hl-attribute">value</span>=<span class="hl-value">"foo"</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"fooChannel"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;int:mapping</span> <span class="hl-attribute">value</span>=<span class="hl-value">"bar"</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"barChannel"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/int:header-value-router&gt;</span></pre>
</div>
<p>Now we can consider how the three steps work for a header value router:</p>
<div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
Compute a channel identifier that is the value of the header identified by the <code class="literal">header-name</code> attribute.
</li><li class="listitem">
Resolve the channel identifier a to channel name, where the result of the previous step is used to select the appropriate value from the general mapping defined in the <code class="literal">mapping</code> element.
</li><li class="listitem">
Resolve the channel name to the actual instance of the <code class="literal">MessageChannel</code> as a reference to a bean within the application context (which is hopefully a <code class="literal">MessageChannel</code>) identified by the result of the previous step.
</li></ol></div>
<p>The preceding two configurations of two different router types look almost identical.
However, if you look at the alternate configuration of the <code class="literal">HeaderValueRouter</code> we clearly see that there is no <code class="literal">mapping</code> sub element, as the following listing shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:header-value-router&nbsp;input-channel="inputChannel"&nbsp;header-name="testHeader"&gt;</span></pre>
</div>
<p>However, the configuration is still perfectly valid.
So the natural question is what about the mapping in the second step?</p>
<p>The second step is now optional.
If <code class="literal">mapping</code> is not defined, then the channel identifier value computed in the first step is automatically treated as the <code class="literal">channel name</code>, which is now resolved to the actual <code class="literal">MessageChannel</code>, as in the third step.&nbsp;
What it also means is that the second step is one of the key steps to providing dynamic characteristics to the routers, since it introduces a process that lets you change the way channel identifier resolves to the channel name, thus influencing the process of determining the final instance of the <code class="literal">MessageChannel</code> from the initial channel identifier.&nbsp;</p>
<p>For example, in the preceding configuration, assume that the <code class="literal">testHeader</code> value is <span class="emphasis"><em>kermit</em></span>, which is now a channel identifier (the first step).
Since there is no mapping in this router, resolving this channel identifier to a channel name (the second step) is impossible and this channel identifier is now treated as the channel name.
However, what if there was a mapping but for a different value?
The end result would still be the same, because, if a new value cannot be determined through the process of resolving the channel identifier to a channel name, the channel identifier becomes the channel name.</p>
<p>All that is left is for the third step to resolve the channel name (<span class="emphasis"><em>kermit</em></span>) to an actual instance of the <code class="literal">MessageChannel</code> identified by this name.
That basically involves a bean lookup for the provided name.
Now all messages that contain the header-value pair as <code class="literal">testHeader=kermit</code> are going to be routed to a <code class="literal">MessageChannel</code> whose bean name (its <code class="literal">id</code>) is <span class="emphasis"><em>kermit</em></span>.</p>
<p>But what if you want to route these messages to the <span class="emphasis"><em>simpson</em></span> channel? Obviously changing a static configuration works, but doing so also requires bringing your system down.
However, if you had access to the channel identifier map, you could introduce a new mapping where the header-value pair is now <code class="literal">kermit=simpson</code>, thus letting the second step treat <span class="emphasis"><em>kermit</em></span> as a channel identifier while resolving it to <span class="emphasis"><em>simpson</em></span> as the channel name.</p>
<p>The same obviously applies for <code class="literal">PayloadTypeRouter</code>, where you can now remap or remove a particular payload type mapping.
In fact, it applies to every other router, including expression-based routers, since their computed values now have a chance to go through the second step to be resolved to the actual <code class="literal">channel name</code>.</p>
<p>Any router that is a subclass of the <code class="literal">AbstractMappingMessageRouter</code> (which includes most framework-defined routers) is a dynamic router, because the <code class="literal">channelMapping</code> is defined at the <code class="literal">AbstractMappingMessageRouter</code> level.
That map&#8217;s setter method is exposed as a public method along with the <span class="emphasis"><em>setChannelMapping</em></span> and <span class="emphasis"><em>removeChannelMapping</em></span> methods.
These let you  change, add, and remove router mappings at runtime, as long as you have a reference to the router itself.
It also means that you could expose these same configuration options through JMX (see <a class="xref" href="#jmx" title="12.2&nbsp;JMX Support">Section&nbsp;12.2, &#8220;JMX Support&#8221;</a>) or the Spring Integration control bus (see <a class="xref" href="#control-bus" title="12.6&nbsp;Control Bus">Section&nbsp;12.6, &#8220;Control Bus&#8221;</a>) functionality.&nbsp;</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="dynamic-routers-control-bus" href="#dynamic-routers-control-bus"></a>Manage Router Mappings using the Control Bus</h4></div></div></div>

<p>One way to manage the router mappings is through the <a class="ulink" href="http://www.eaipatterns.com/ControlBus.html" target="_top">control bus</a> pattern, which exposes a control channel to which you can send control messages to manage and monitor Spring Integration components, including routers.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>For more information about the control bus, see <a class="xref" href="#control-bus" title="12.6&nbsp;Control Bus">Section&nbsp;12.6, &#8220;Control Bus&#8221;</a>.</p>
</td></tr></table></div>
<p>Typically, you would send a control message asking to invoke a particular operation on a particular managed component (such as a
router).
The following managed operations (methods) are specific to changing the router resolution process:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">public void setChannelMapping(String key, String channelName)</code>: Lets you add a new or modify an existing mapping between <code class="literal">channel identifier</code> and <code class="literal">channel name</code>
</li><li class="listitem">
<code class="literal">public void removeChannelMapping(String key)</code>: Lets you remove a particular channel mapping, thus disconnecting the relationship between <code class="literal">channel identifier</code> and <code class="literal">channel name</code>
</li></ul></div>
<p>Note that these methods can be used for simple changes (such as updating a single route or adding or removing a route).
However, if you want to remove one route and add another, the updates are not atomic.
This means that the routing table may be in an indeterminate state between the updates.
Starting with version 4.0, you can now use the control bus to update the entire routing table atomically.
The following methods let you do so:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">public Map&lt;String, String&gt;getChannelMappings()</code>: Returns the current mappings.
</li><li class="listitem">
<code class="literal">public void replaceChannelMappings(Properties channelMappings)</code>: Updates the mappings.
Note that the <code class="literal">channelMappings</code> parameter is a <code class="literal">Properties</code> object.
This arrangement lets a control bus command use the built-in <code class="literal">StringToPropertiesConverter</code>, as the following example shows:
</li></ul></div>
<div class="informalexample">
<pre class="screen">"@'router.handler'.replaceChannelMappings('foo=qux \n baz=bar')"</pre>
</div>
<p>Note that each mapping is separated by a newline character (<code class="literal">\n</code>).
For programmatic changes to the map, we recommend that you use the <code class="literal">setChannelMappings</code> method, due to type-safety concerns.
<code class="literal">replaceChannelMappings</code> ignores keys or values that are not <code class="literal">String</code> objects.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="dynamic-routers-jmx" href="#dynamic-routers-jmx"></a>Manage Router Mappings by Using JMX</h4></div></div></div>

<p>You can also use Spring&#8217;s JMX support to expose a router instance and then use your favorite JMX client (for example, JConsole) to manage those operations (methods) for changing the router&#8217;s configuration.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>For more information about Spring Integration&#8217;s JMX support, see <a class="xref" href="#jmx" title="12.2&nbsp;JMX Support">Section&nbsp;12.2, &#8220;JMX Support&#8221;</a>.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="routing-slip" href="#routing-slip"></a>Routing Slip</h4></div></div></div>

<p>Starting with version 4.1, Spring Integration provides an implementation of the <a class="ulink" href="http://www.eaipatterns.com/RoutingTable.html" target="_top">routing slip</a> enterprise integration pattern.
It is implemented as a <code class="literal">routingSlip</code> message header, which is used to determine the next channel in <code class="literal">AbstractMessageProducingHandler</code> instances, when an <code class="literal">outputChannel</code> is not specified for the endpoint.
This pattern is useful in complex, dynamic cases, when it can become difficult to configure multiple routers to determine message flow.
When a message arrives at an endpoint that has no <code class="literal">output-channel</code>, the <code class="literal">routingSlip</code> is consulted to determine the next channel to which the message is sent.
When the routing slip is exhausted, normal <code class="literal">replyChannel</code> processing resumes.</p>
<p>Configuration for the routing slip is presented as a <code class="literal">HeaderEnricher</code> option&#8201;&#8212;&#8201;a semicolon-separated routing slip that contains <code class="literal">path</code> entries, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;util:properties</span> <span class="hl-attribute">id</span>=<span class="hl-value">"properties"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;beans:prop</span> <span class="hl-attribute">key</span>=<span class="hl-value">"myRoutePath1"</span><span class="hl-tag">&gt;</span>channel1<span class="hl-tag">&lt;/beans:prop&gt;</span>
    <span class="hl-tag">&lt;beans:prop</span> <span class="hl-attribute">key</span>=<span class="hl-value">"myRoutePath2"</span><span class="hl-tag">&gt;</span>request.headers[myRoutingSlipChannel]<span class="hl-tag">&lt;/beans:prop&gt;</span>
<span class="hl-tag">&lt;/util:properties&gt;</span>

<span class="hl-tag">&lt;context:property-placeholder</span> <span class="hl-attribute">properties-ref</span>=<span class="hl-value">"properties"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;header-enricher</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"process"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;routing-slip</span>
        <span class="hl-attribute">value</span>=<span class="hl-value">"${myRoutePath1}; @routingSlipRoutingPojo.get(request, reply);
               routingSlipRoutingStrategy; ${myRoutePath2}; finishChannel"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/header-enricher&gt;</span></pre>
</div>
<p>The preceding example has:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
A <code class="literal">&lt;context:property-placeholder&gt;</code> configuration to demonstrate that the entries in the routing slip <code class="literal">path</code> can be specified as resolvable keys.
</li><li class="listitem">
The <code class="literal">&lt;header-enricher&gt;</code> <code class="literal">&lt;routing-slip&gt;</code> sub-element is used to populate the <code class="literal">RoutingSlipHeaderValueMessageProcessor</code> to the <code class="literal">HeaderEnricher</code> handler.
</li><li class="listitem">
The <code class="literal">RoutingSlipHeaderValueMessageProcessor</code> accepts a <code class="literal">String</code> array of resolved routing slip <code class="literal">path</code> entries and returns (from <code class="literal">processMessage()</code>) a <code class="literal">singletonMap</code> with the <code class="literal">path</code> as <code class="literal">key</code> and <code class="literal">0</code> as initial <code class="literal">routingSlipIndex</code>.
</li></ul></div>
<p>Routing Slip <code class="literal">path</code> entries can contain <code class="literal">MessageChannel</code> bean names, <code class="literal">RoutingSlipRouteStrategy</code> bean names, and Spring expressions (SpEL).
The <code class="literal">RoutingSlipHeaderValueMessageProcessor</code> checks each routing slip <code class="literal">path</code> entry against the <code class="literal">BeanFactory</code> on the first <code class="literal">processMessage</code> invocation.
It converts entries (which are not bean names in the application context) to <code class="literal">ExpressionEvaluatingRoutingSlipRouteStrategy</code> instances.
<code class="literal">RoutingSlipRouteStrategy</code> entries are invoked multiple times, until they return null or an empty <code class="literal">String</code>.</p>
<p>Since the routing slip is involved in the <code class="literal">getOutputChannel</code> process, we have a request-reply context.
The <code class="literal">RoutingSlipRouteStrategy</code> has been introduced to determine the next <code class="literal">outputChannel</code> that uses the <code class="literal">requestMessage</code> and the <code class="literal">reply</code> object.
An implementation of this strategy should be registered as a bean in the application context, and its bean name is used in the routing slip <code class="literal">path</code>.
The <code class="literal">ExpressionEvaluatingRoutingSlipRouteStrategy</code> implementation is provided.
It accepts a SpEL expression and an internal <code class="literal">ExpressionEvaluatingRoutingSlipRouteStrategy.RequestAndReply</code> object is used as the root object of the evaluation context.
This is to avoid the overhead of <code class="literal">EvaluationContext</code> creation for each <code class="literal">ExpressionEvaluatingRoutingSlipRouteStrategy.getNextPath()</code> invocation.
It is a simple Java bean with two properties: <code class="literal">Message&lt;?&gt; request</code> and <code class="literal">Object reply</code>.
With this expression implementation, we can specify routing slip <code class="literal">path</code> entries by using SpEL (for example, <code class="literal">@routingSlipRoutingPojo.get(request, reply)</code> and <code class="literal">request.headers[myRoutingSlipChannel]</code>) and avoid defining a bean for the <code class="literal">RoutingSlipRouteStrategy</code>.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The <code class="literal">requestMessage</code> argument is always a <code class="literal">Message&lt;?&gt;</code>.
Depending on context, the reply object may be a <code class="literal">Message&lt;?&gt;</code>, an <code class="literal">AbstractIntegrationMessageBuilder</code>, or an arbitrary application domain object (when, for example, it is returned by a POJO method invoked by a service activator).
In the first two cases, the usual <code class="literal">Message</code> properties (<code class="literal">payload</code> and <code class="literal">headers</code>) are available when using SpEL (or a Java implementation).
For an arbitrary domain object, these properties are not available.
For this reason, be careful when you use routing slips in conjunction with POJO methods if the result is used to determine the
next path.</p>
</td></tr></table></div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>If a routing slip is involved in a distributed environment, we recommend not using inline expressions for the Routing Slip <code class="literal">path</code>. This recommendation applies to distributed environments such as cross-JVM applications, using a <code class="literal">request-reply</code> through a message broker (such as<a class="xref" href="#amqp" title="14.&nbsp;AMQP Support">Chapter&nbsp;14, <i>AMQP Support</i></a> or <a class="xref" href="#jms" title="23.&nbsp;JMS Support">Chapter&nbsp;23, <i>JMS Support</i></a>), or using a persistent <code class="literal">MessageStore</code> (<a class="xref" href="#message-store" title="12.4&nbsp;Message Store">Section&nbsp;12.4, &#8220;Message Store&#8221;</a>) in the integration flow.
The framework uses <code class="literal">RoutingSlipHeaderValueMessageProcessor</code> to convert them to <code class="literal">ExpressionEvaluatingRoutingSlipRouteStrategy</code> objects, and they are used in the <code class="literal">routingSlip</code> message header.
Since this class is not <code class="literal">Serializable</code> (it cannot be, because it depends on the <code class="literal">BeanFactory</code>), the entire <code class="literal">Message</code> becomes non-serializable and, in any distributed operation, we end up with a <code class="literal">NotSerializableException</code>.
To overcome this limitation, register an <code class="literal">ExpressionEvaluatingRoutingSlipRouteStrategy</code> bean with the desired SpEL and use its bean name in the routing slip <code class="literal">path</code> configuration.</p>
</td></tr></table></div>
<p>For Java configuration, you can add a <code class="literal">RoutingSlipHeaderValueMessageProcessor</code> instance to the <code class="literal">HeaderEnricher</code> bean definition, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<em><span class="hl-annotation" style="color: gray">@Transformer(inputChannel = "routingSlipHeaderChannel")</span></em>
<span class="hl-keyword">public</span> HeaderEnricher headerEnricher() {
    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> HeaderEnricher(Collections.singletonMap(IntegrationMessageHeaderAccessor.ROUTING_SLIP,
            <span class="hl-keyword">new</span> RoutingSlipHeaderValueMessageProcessor(<span class="hl-string">"myRoutePath1"</span>,
                                                       <span class="hl-string">"@routingSlipRoutingPojo.get(request, reply)"</span>,
                                                       <span class="hl-string">"routingSlipRoutingStrategy"</span>,
                                                       <span class="hl-string">"request.headers[myRoutingSlipChannel]"</span>,
                                                       <span class="hl-string">"finishChannel"</span>)));
}</pre>
</div>
<p>The routing slip algorithm works as follows when an endpoint produces a reply and no <code class="literal">outputChannel</code> has been defined:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
The <code class="literal">routingSlipIndex</code> is used to get a value from the routing slip <code class="literal">path</code> list.
</li><li class="listitem">
If the value from <code class="literal">routingSlipIndex</code> is <code class="literal">String</code>, it is used to get a bean from <code class="literal">BeanFactory</code>.
</li><li class="listitem">
If a returned bean is an instance of <code class="literal">MessageChannel</code>, it is used as the next <code class="literal">outputChannel</code> and the <code class="literal">routingSlipIndex</code> is incremented in the reply message header (the routing slip <code class="literal">path</code> entries remain unchanged).
</li><li class="listitem">
If a returned bean is an instance of <code class="literal">RoutingSlipRouteStrategy</code> and its <code class="literal">getNextPath</code> does not return an empty <code class="literal">String</code>, that result is used as a bean name for the next <code class="literal">outputChannel</code>.
The <code class="literal">routingSlipIndex</code> remains unchanged.
</li><li class="listitem">
If <code class="literal">RoutingSlipRouteStrategy.getNextPath</code> returns an empty <code class="literal">String</code>, the <code class="literal">routingSlipIndex</code> is incremented and the <code class="literal">getOutputChannelFromRoutingSlip</code> is invoked recursively for the next Routing Slip <code class="literal">path</code> item.
</li><li class="listitem">
If the next routing slip <code class="literal">path</code> entry is not a <code class="literal">String</code>, it must be an instance of <code class="literal">RoutingSlipRouteStrategy</code>.
</li><li class="listitem">
When the <code class="literal">routingSlipIndex</code> exceeds the size of the routing slip <code class="literal">path</code> list, the algorithm moves to the default behavior for the standard <code class="literal">replyChannel</code> header.
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="process-manager" href="#process-manager"></a>Process Manager Enterprise Integration Pattern</h4></div></div></div>

<p>Enterprise integration patterns include the <a class="ulink" href="http://www.eaipatterns.com/ProcessManager.html" target="_top">process manager</a> pattern.
You can now easily implement this pattern by using custom process manager logic encapsulated in a <code class="literal">RoutingSlipRouteStrategy</code> within the routing slip.
In addition to a bean name, the <code class="literal">RoutingSlipRouteStrategy</code> can return any <code class="literal">MessageChannel</code> object, and there is no requirement that this <code class="literal">MessageChannel</code> instance be a bean in the application context.
This way, we can provide powerful dynamic routing logic when there is no way to predict which channel should be used.
A <code class="literal">MessageChannel</code> can be created within the <code class="literal">RoutingSlipRouteStrategy</code> and returned.
A <code class="literal">FixedSubscriberChannel</code> with an associated <code class="literal">MessageHandler</code> implementation is a good combination for such cases.
For example, you can route to a <a class="ulink" href="https://github.com/reactor/reactor/wiki/Streams" target="_top">reactor stream</a>, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> PollableChannel resultsChannel() {
    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> QueueChannel();
}
<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> RoutingSlipRouteStrategy routeStrategy() {
    <span class="hl-keyword">return</span> (requestMessage, reply) -&gt; requestMessage.getPayload() <span class="hl-keyword">instanceof</span> String
            ? <span class="hl-keyword">new</span> FixedSubscriberChannel(m -&gt;
            Mono.just((String) m.getPayload())
                    .map(String::toUpperCase)
                    .subscribe(v -&gt; messagingTemplate().convertAndSend(resultsChannel(), v)))
            : <span class="hl-keyword">new</span> FixedSubscriberChannel(m -&gt;
            Mono.just((Integer) m.getPayload())
                    .map(v -&gt; v * <span class="hl-number">2</span>)
                    .subscribe(v -&gt; messagingTemplate().convertAndSend(resultsChannel(), v)));
}</pre>
</div>
</div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="filter" href="#filter"></a>8.2&nbsp;Filter</h2></div></div></div>

<p>Message filters are used to decide whether a <code class="literal">Message</code> should be passed along or dropped based on some criteria, such as a message header value or message content itself.
Therefore, a message filter is similar to a router, except that, for each message received from the filter&#8217;s input channel, that same message may or may not be sent to the filter&#8217;s output channel.
Unlike the router, it makes no decision regarding which message channel to send the message to but decides only whether to send the message at all.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>As we describe later in this section, the filter also supports a discard channel.
In certain cases, it can play the role of a very simple router (or "<code class="literal">switch</code>"), based on a boolean condition.</p>
</td></tr></table></div>
<p>In Spring Integration, you can configure a message filter as a message endpoint that delegates to an implementation of the <code class="literal">MessageSelector</code> interface.
That interface is itself quite simple, as the following listing shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> MessageSelector {

    <span class="hl-keyword">boolean</span> accept(Message&lt;?&gt; message);

}</pre>
</div>
<p>The <code class="literal">MessageFilter</code> constructor accepts a selector instance, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting">MessageFilter filter = <span class="hl-keyword">new</span> MessageFilter(someSelector);</pre>
</div>
<p>In combination with the namespace and SpEL, you can configure powerful filters with very little Java code.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="filter-xml" href="#filter-xml"></a>8.2.1&nbsp;Configuring a Filter with XML</h3></div></div></div>

<p>You can use the <code class="literal">&lt;filter&gt;</code> element is used to create a message-selecting endpoint.
In addition to <code class="literal">input-channel</code> and <code class="literal">output-channel</code> attributes, it requires a <code class="literal">ref</code> attribute.
The <code class="literal">ref</code> can point to a <code class="literal">MessageSelector</code> implementation, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:filter</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"selector"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"selector"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"example.MessageSelectorImpl"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>Alternatively, you can add the <code class="literal">method</code> attribute.
In that case, the <code class="literal">ref</code> attribute may refer to any object.
The referenced method may expect either the <code class="literal">Message</code> type or the payload type of inbound messages.
The method must return a boolean value.
If the method returns <span class="emphasis"><em>true</em></span>, the message is sent to the output channel.
The following example shows how to configure a filter that uses the <code class="literal">method</code> attribute:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:filter</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span>
    <span class="hl-attribute">ref</span>=<span class="hl-value">"exampleObject"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"someBooleanReturningMethod"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"exampleObject"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"example.SomeObject"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>If the selector or adapted POJO method returns <code class="literal">false</code>, a few settings  control the handling of the rejected message.
By default (if configured as in the preceding example), rejected messages are silently dropped.
If rejection should instead result in an error condition, set the <code class="literal">throw-exception-on-rejection</code> attribute to <code class="literal">true</code>, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:filter</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"selector"</span>
    <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span> <span class="hl-attribute">throw-exception-on-rejection</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>If you want rejected messages to be routed to a specific channel, provide that reference as the <code class="literal">discard-channel</code>, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:filter</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"selector"</span>
    <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span> <span class="hl-attribute">discard-channel</span>=<span class="hl-value">"rejectedMessages"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>See also <a class="xref" href="#advising-filters" title="10.9.6&nbsp;Advising Filters">Section&nbsp;10.9.6, &#8220;Advising Filters&#8221;</a>.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Message filters are commonly used in conjunction with a publish-subscribe channel.
Many filter endpoints may be subscribed to the same channel, and they decide whether or not to pass the message to the next endpoint, which could be any of the supported types (such as a service activator).
This provides a reactive alternative to the more proactive approach of using a message router with a single point-to-point input channel and multiple output channels.</p>
</td></tr></table></div>
<p>We recommend using a <code class="literal">ref</code> attribute if the custom filter implementation is referenced in other <code class="literal">&lt;filter&gt;</code> definitions.
However, if the custom filter implementation is scoped to a single <code class="literal">&lt;filter&gt;</code> element, you should provide an inner bean definition, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:filter</span> <span class="hl-attribute">method</span>=<span class="hl-value">"someMethod"</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"inChannel"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"outChannel"</span><span class="hl-tag">&gt;</span>
  <span class="hl-tag">&lt;beans:bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.foo.MyCustomFilter"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/filter&gt;</span></pre>
</div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Using both the <code class="literal">ref</code> attribute and an inner handler definition in the same <code class="literal">&lt;filter&gt;</code> configuration is not allowed, as it creates an ambiguous condition and throws an exception.</p>
</td></tr></table></div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>If the <code class="literal">ref</code> attribute references a bean that extends <code class="literal">MessageFilter</code> (such as filters provided by the framework itself), the configuration is optimized by injecting the output channel into the filter bean directly.
In this case, each <code class="literal">ref</code> must be to a separate bean instance (or a <code class="literal">prototype</code>-scoped bean) or use the inner <code class="literal">&lt;bean/&gt;</code> configuration type.
However, this optimization applies only if you do not provide any filter-specific attributes in the filter XML definition.
If you inadvertently reference the same message handler from multiple beans, you get a configuration exception.</p>
</td></tr></table></div>
<p>With the introduction of SpEL support, Spring Integration added the <code class="literal">expression</code> attribute to the filter element.
It can be used to avoid Java entirely for simple filters, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:filter</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"payload.equals('nonsense')"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>The string passed as the value of the expression attribute is evaluated as a SpEL expression with the message available in the evaluation context.
If you must include the result of an expression in the scope of the application context, you can use the <code class="literal">#{}</code> notation, as defined in the <a class="ulink" href="http://docs.spring.io/spring/docs/current/spring-framework-reference/html/expressions.html#expressions-beandef" target="_top">SpEL reference documentation</a>, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:filter</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span>
            <span class="hl-attribute">expression</span>=<span class="hl-value">"payload.matches(#{filterPatterns.nonsensePattern})"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>If the expression itself needs to be dynamic, you can use an <span class="emphasis"><em>expression</em></span> sub-element.
That provides a level of indirection for resolving the expression by its key from an <code class="literal">ExpressionSource</code>.
That is a strategy interface that you can implement directly, or you can rely upon a version available in Spring Integration that loads expressions from a "<code class="literal">resource bundle</code>" and can check for modifications after a given number of seconds.
All of this is demonstrated in the following configuration example, where the expression could be reloaded within one minute if the underlying file had been modified:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:filter</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:expression</span> <span class="hl-attribute">key</span>=<span class="hl-value">"filterPatterns.example"</span> <span class="hl-attribute">source</span>=<span class="hl-value">"myExpressions"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:filter&gt;</span>

<span class="hl-tag">&lt;beans:bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myExpressions"</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myExpressions"</span>
    <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.expression.ReloadableResourceBundleExpressionSource"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;beans:property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"basename"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"config/integration/expressions"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;beans:property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"cacheSeconds"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"60"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/beans:bean&gt;</span></pre>
</div>
<p>If the <code class="literal">ExpressionSource</code> bean is named <code class="literal">expressionSource</code>, you need not provide the` source` attribute on the <code class="literal">&lt;expression&gt;</code> element. However, in the preceding example, we show it for completeness.</p>
<p>The <span class="emphasis"><em>config/integration/expressions.properties</em></span> file (or any more-specific version with a locale extension to be resolved in the typical way that resource-bundles are loaded) can contain a key/value pair, as the following example shows:</p>
<div class="informalexample">
<pre class="screen">filterPatterns.example=payload &gt; 100</pre>
</div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>All of these examples that use <code class="literal">expression</code> as an attribute or sub-element can also be applied within transformer, router, splitter, service-activator, and header-enricher elements.
The semantics and role of the given component type would affect the interpretation of the evaluation result, in the same way that the return value of a method-invocation would be interpreted.
For example, an expression can return strings that are to be treated as message channel names by a router component.
However, the underlying functionality of evaluating the expression against the message as the root object and resolving bean names if prefixed with <span class="emphasis"><em>@</em></span> is consistent across all of the core EIP components within Spring Integration.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="filter-annotations" href="#filter-annotations"></a>8.2.2&nbsp;Configuring a Filter with Annotations</h3></div></div></div>

<p>The following example shows how to configure a filter by using annotations:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> PetFilter {
    ...
    <em><span class="hl-annotation" style="color: gray">@Filter</span></em>  <a name="CO3-1" href="#CO3-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
    <span class="hl-keyword">public</span> <span class="hl-keyword">boolean</span> dogsOnly(String input) {
        ...
    }
}</pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO3-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>An annotation indicating that this method is to be used as a filter.
It must be specified if this class is to be used as a filter.</p>
</td></tr></table></div>
<p>All of the configuration options provided by the XML element are also available for the <code class="literal">@Filter</code> annotation.</p>
<p>The filter can be either referenced explicitly from XML or, if the <code class="literal">@MessageEndpoint</code> annotation is defined on the class, detected automatically through classpath scanning.</p>
<p>See also <a class="xref" href="#advising-with-annotations" title="10.9.7&nbsp;Advising Endpoints Using Annotations">Section&nbsp;10.9.7, &#8220;Advising Endpoints Using Annotations&#8221;</a>.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="splitter" href="#splitter"></a>8.3&nbsp;Splitter</h2></div></div></div>

<p>The splitter is a component whose role is to partition a message into several parts and send the resulting messages to be processed independently.
Very often, they are upstream producers in a pipeline that includes an aggregator.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_programming_model" href="#_programming_model"></a>8.3.1&nbsp;Programming Model</h3></div></div></div>

<p>The API for performing splitting consists of one base class, <code class="literal">AbstractMessageSplitter</code>.
It is a <code class="literal">MessageHandler</code> implementation that encapsulates features common to splitters, such as filling in the appropriate message headers (<code class="literal">CORRELATION_ID</code>, <code class="literal">SEQUENCE_SIZE</code>, and <code class="literal">SEQUENCE_NUMBER</code>) on the messages that are produced.
This filling enables tracking down the messages and the results of their processing (in a typical scenario, these headers get copied to the messages that are produced by the various transforming endpoints).
The values can then be used, for example, by a <a class="ulink" href="http://www.eaipatterns.com/DistributionAggregate.html" target="_top">composed message processor</a>.</p>
<p>The following example shows an excerpt from <code class="literal">AbstractMessageSplitter</code>:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">abstract</span> <span class="hl-keyword">class</span> AbstractMessageSplitter
    <span class="hl-keyword">extends</span> AbstractReplyProducingMessageConsumer {
    ...
    <span class="hl-keyword">protected</span> <span class="hl-keyword">abstract</span> Object splitMessage(Message&lt;?&gt; message);

}</pre>
<p>To implement a specific splitter in an application, you can extend <code class="literal">AbstractMessageSplitter</code> and implement the <code class="literal">splitMessage</code> method, which contains logic for splitting the messages.
The return value can be one of the following:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
A <code class="literal">Collection</code> or an array of messages or an <code class="literal">Iterable</code> (or <code class="literal">Iterator</code>) that iterates over messages.
In this case, the messages are sent as messages (after the <code class="literal">CORRELATION_ID</code>, <code class="literal">SEQUENCE_SIZE</code> and <code class="literal">SEQUENCE_NUMBER</code> are populated).
Using this approach gives you more control&#8201;&#8212;&#8201;for example, to populate custom message headers as part of the splitting process.
</li><li class="listitem">
A <code class="literal">Collection</code> or an array of non-message objects or an <code class="literal">Iterable</code> (or <code class="literal">Iterator</code>) that iterates over non-message objects.
It works like the prior case, except that each collection element is used as a message payload.
Using this approach lets you focus on the domain objects without having to consider the messaging system and produces code that is easier to test.
</li><li class="listitem">
a <code class="literal">Message</code> or non-message object (but not a collection or an array).
It works like the previous cases, except that a single message is sent out.
</li></ul></div>
<p>In Spring Integration, any POJO can implement the splitting algorithm, provided that it defines a method that accepts a single argument and has a return value.
In this case, the return value of the method is interpreted as described earlier.
The input argument might either be a <code class="literal">Message</code> or a simple POJO.
In the latter case, the splitter receives the payload of the incoming message.
We recommend this approach, because it decouples the code from the Spring Integration API and is typically easier to test.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_iterators" href="#_iterators"></a>Iterators</h4></div></div></div>

<p>Starting with version 4.1, the <code class="literal">AbstractMessageSplitter</code> supports the <code class="literal">Iterator</code> type for the <code class="literal">value</code> to split.
Note, in the case of an <code class="literal">Iterator</code> (or <code class="literal">Iterable</code>), we don&#8217;t have access to the number of underlying items and the <code class="literal">SEQUENCE_SIZE</code> header is set to <code class="literal">0</code>.
This means that the default <code class="literal">SequenceSizeReleaseStrategy</code> of an <code class="literal">&lt;aggregator&gt;</code> won&#8217;t work and the group for the <code class="literal">CORRELATION_ID</code> from the <code class="literal">splitter</code> won&#8217;t be released; it will remain as <code class="literal">incomplete</code>.
In this case you should use an appropriate custom <code class="literal">ReleaseStrategy</code> or rely on <code class="literal">send-partial-result-on-expiry</code> together with <code class="literal">group-timeout</code> or a <code class="literal">MessageGroupStoreReaper</code>.</p>
<p>Starting with version 5.0, the <code class="literal">AbstractMessageSplitter</code> provides <code class="literal">protected obtainSizeIfPossible()</code> methods to allow the determination of the size of the <code class="literal">Iterable</code> and <code class="literal">Iterator</code> objects if that is possible.
For example <code class="literal">XPathMessageSplitter</code> can determine the size of the underlying <code class="literal">NodeList</code> object.
And starting with version 5.0.9, this method also properly returns a size of the <code class="literal">com.fasterxml.jackson.core.TreeNode</code>.</p>
<p>An <code class="literal">Iterator</code> object is useful to avoid the need for building an entire collection in the memory before splitting.
For example, when underlying items are populated from some external system (e.g. DataBase or FTP <code class="literal">MGET</code>) using iterations or streams.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_stream_and_flux" href="#_stream_and_flux"></a>Stream and Flux</h4></div></div></div>

<p>Starting with version 5.0, the <code class="literal">AbstractMessageSplitter</code> supports the Java <code class="literal">Stream</code> and Reactive Streams <code class="literal">Publisher</code> types for the <code class="literal">value</code> to split.
In this case, the target <code class="literal">Iterator</code> is built on their iteration functionality.</p>
<p>In addition, if the splitter&#8217;s output channel is an instance of a <code class="literal">ReactiveStreamsSubscribableChannel</code>, the <code class="literal">AbstractMessageSplitter</code> produces a <code class="literal">Flux</code> result instead of an <code class="literal">Iterator</code>, and the output channel is subscribed to this <code class="literal">Flux</code> for back-pressure-based splitting on downstream flow demand.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_a_splitter_with_xml" href="#_configuring_a_splitter_with_xml"></a>8.3.2&nbsp;Configuring a Splitter with XML</h3></div></div></div>

<p>A splitter can be configured through XML as follows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"inputChannel"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int:splitter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"splitter"</span>         <a name="CO4-1" href="#CO4-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
  ref="splitterBean"                <a name="CO4-2" href="#CO4-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
  method="split"                    <a name="CO4-3" href="#CO4-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
  input-channel="inputChannel"      <a name="CO4-4" href="#CO4-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
  output-channel="outputChannel" /&gt; <a name="CO4-5" href="#CO4-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>

<span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"outputChannel"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;beans:bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"splitterBean"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"sample.PojoSplitter"</span><span class="hl-tag">/&gt;</span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO4-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The ID of the splitter is optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO4-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A reference to a bean defined in the application context.
The bean must implement the splitting logic, as described in the earlier section.
Optional.
If a reference to a bean is not provided, it is assumed that the payload of the message that arrived on the <code class="literal">input-channel</code> is an implementation of <code class="literal">java.util.Collection</code> and the default splitting logic is applied to the collection, incorporating each individual element into a message and sending it to the <code class="literal">output-channel</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO4-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The method (defined on the bean) that implements the splitting logic.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO4-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The input channel of the splitter.
Required.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO4-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The channel to which the splitter sends the results of splitting the incoming message.
Optional (because incoming messages can specify a reply channel themselves).</p>
</td></tr></table></div>
</div>
<p>We recommend using a <code class="literal">ref</code> attribute if the custom splitter implementation can be referenced in other <code class="literal">&lt;splitter&gt;</code> definitions.
However if the custom splitter handler implementation should be scoped to a single definition of the <code class="literal">&lt;splitter&gt;</code>, you can configure an inner bean definition, as the following example follows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:splitter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"testSplitter"</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"inChannel"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"split"</span>
                <span class="hl-attribute">output-channel</span>=<span class="hl-value">"outChannel"</span><span class="hl-tag">&gt;</span>
  <span class="hl-tag">&lt;beans:bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.foo.TestSplitter"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:splitter&gt;</span></pre>
</div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Using both a <code class="literal">ref</code> attribute and an inner handler definition in the same <code class="literal">&lt;int:splitter&gt;</code> configuration is not allowed, as it creates an ambiguous condition and results in an exception being thrown.</p>
</td></tr></table></div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>If the <code class="literal">ref</code> attribute references a bean that extends <code class="literal">AbstractMessageProducingHandler</code> (such as splitters provided by the framework itself), the configuration is optimized by injecting the output channel into the handler directly.
In this case, each <code class="literal">ref</code> must be a separate bean instance (or a <code class="literal">prototype</code>-scoped bean) or use the inner <code class="literal">&lt;bean/&gt;</code> configuration type.
However, this optimization applies only if you do not provide any splitter-specific attributes in the splitter XML definition.
If you inadvertently reference the same message handler from multiple beans, you get a configuration exception.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_a_splitter_with_annotations" href="#_configuring_a_splitter_with_annotations"></a>8.3.3&nbsp;Configuring a Splitter with Annotations</h3></div></div></div>

<p>The <code class="literal">@Splitter</code> annotation is applicable to methods that expect either the <code class="literal">Message</code> type or the message payload type, and the return values of the method should be a <code class="literal">Collection</code> of any type.
If the returned values are not actual <code class="literal">Message</code> objects, each item is wrapped in a <code class="literal">Message</code> as the payload of the <code class="literal">Message</code>.
Each resulting <code class="literal">Message</code> is sent to the designated output channel for the endpoint on which the <code class="literal">@Splitter</code> is defined.</p>
<p>The following example shows how to configure a splitter by using the <code class="literal">@Splitter</code> annotation:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Splitter</span></em>
List&lt;LineItem&gt; extractItems(Order order) {
    <span class="hl-keyword">return</span> order.getItems()
}</pre>
</div>
<p>See also <a class="xref" href="#advising-with-annotations" title="10.9.7&nbsp;Advising Endpoints Using Annotations">Section&nbsp;10.9.7, &#8220;Advising Endpoints Using Annotations&#8221;</a>.</p>
<p>See also <a class="xref" href="#java-dsl-splitters" title="11.8&nbsp;Splitters">Section&nbsp;11.8, &#8220;Splitters&#8221;</a> in the Java DSL chapter.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="aggregator" href="#aggregator"></a>8.4&nbsp;Aggregator</h2></div></div></div>

<p>Basically a mirror-image of the splitter, the aggregator is a type of message handler that receives multiple messages and combines them into a single message.
In fact, an aggregator is often a downstream consumer in a pipeline that includes a splitter.</p>
<p>Technically, the aggregator is more complex than a splitter, because it is stateful.
It must hold the messages to be aggregated and determine when the complete group of messages is ready to be aggregated.
In order to do so, it requires a <code class="literal">MessageStore</code>.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="aggregator-functionality" href="#aggregator-functionality"></a>8.4.1&nbsp;Functionality</h3></div></div></div>

<p>The Aggregator combines a group of related messages, by correlating and storing them, until the group is deemed to be complete.
At that point, the aggregator creates a single message by processing the whole group and sends the aggregated message as output.</p>
<p>Implementing an aggregator requires providing the logic to perform the aggregation (that is, the creation of a single message from many).
Two related concepts are correlation and release.</p>
<p>Correlation determines how messages are grouped for aggregation.
In Spring Integration, correlation is done by default, based on the <code class="literal">IntegrationMessageHeaderAccessor.CORRELATION_ID</code> message header.
Messages with the same <code class="literal">IntegrationMessageHeaderAccessor.CORRELATION_ID</code> are grouped together.
However, you can customize the correlation strategy to allow other ways of specifying how the messages should be grouped together.
To do so, you can implement a <code class="literal">CorrelationStrategy</code> (covered later in this chapter).</p>
<p>To determine the point at which a group of messages is ready to be processed, a <code class="literal">ReleaseStrategy</code> is consulted.
The default release strategy for the aggregator releases a group when all messages included in a sequence are present, based on the <code class="literal">IntegrationMessageHeaderAccessor.SEQUENCE_SIZE</code> header.
You can override this default strategy by providing a reference to a custom <code class="literal">ReleaseStrategy</code> implementation.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="aggregator-api" href="#aggregator-api"></a>8.4.2&nbsp;Programming Model</h3></div></div></div>

<p>The Aggregation API consists of a number of classes:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
The interface <code class="literal">MessageGroupProcessor</code>, and its subclasses: <code class="literal">MethodInvokingAggregatingMessageGroupProcessor</code> and <code class="literal">ExpressionEvaluatingMessageGroupProcessor</code>
</li><li class="listitem">
The <code class="literal">ReleaseStrategy</code> interface and its default implementation: <code class="literal">SimpleSequenceSizeReleaseStrategy</code>
</li><li class="listitem">
The <code class="literal">CorrelationStrategy</code> interface and its default implementation: <code class="literal">HeaderAttributeCorrelationStrategy</code>
</li></ul></div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_literal_aggregatingmessagehandler_literal" href="#_literal_aggregatingmessagehandler_literal"></a><code class="literal">AggregatingMessageHandler</code></h4></div></div></div>

<p>The <code class="literal">AggregatingMessageHandler</code> (a subclass of <code class="literal">AbstractCorrelatingMessageHandler</code>) is a <code class="literal">MessageHandler</code> implementation, encapsulating the common functionality of an aggregator (and other correlating use cases), which are as follows:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Correlating messages into a group to be aggregated
</li><li class="listitem">
Maintaining those messages in a <code class="literal">MessageStore</code> until the group can be released
</li><li class="listitem">
Deciding when the group can be released
</li><li class="listitem">
Aggregating the released group into a single message
</li><li class="listitem">
Recognizing and responding to an expired group
</li></ul></div>
<p>The responsibility for deciding how the messages should be grouped together is delegated to a <code class="literal">CorrelationStrategy</code> instance.
The responsibility for deciding whether the message group can be released is delegated to a <code class="literal">ReleaseStrategy</code> instance.</p>
<p>The following listing shows a brief highlight of the base <code class="literal">AbstractAggregatingMessageGroupProcessor</code> (the responsibility for implementing the <code class="literal">aggregatePayloads</code> method is left to the developer):</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">abstract</span> <span class="hl-keyword">class</span> AbstractAggregatingMessageGroupProcessor
              <span class="hl-keyword">implements</span> MessageGroupProcessor {

    <span class="hl-keyword">protected</span> Map&lt;String, Object&gt; aggregateHeaders(MessageGroup group) {
        <span class="hl-comment">// default implementation exists</span>
    }

    <span class="hl-keyword">protected</span> <span class="hl-keyword">abstract</span> Object aggregatePayloads(MessageGroup group, Map&lt;String, Object&gt; defaultHeaders);

}</pre>
</div>
<p>The <code class="literal">CorrelationStrategy</code> is owned by the <code class="literal">AbstractCorrelatingMessageHandler</code> and  has a default value based on the <code class="literal">IntegrationMessageHeaderAccessor.CORRELATION_ID</code> message header, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> AbstractCorrelatingMessageHandler(MessageGroupProcessor processor, MessageGroupStore store,
        CorrelationStrategy correlationStrategy, ReleaseStrategy releaseStrategy) {
    ...
    <span class="hl-keyword">this</span>.correlationStrategy = correlationStrategy == null ?
        <span class="hl-keyword">new</span> HeaderAttributeCorrelationStrategy(IntegrationMessageHeaderAccessor.CORRELATION_ID) : correlationStrategy;
    <span class="hl-keyword">this</span>.releaseStrategy = releaseStrategy == null ? <span class="hl-keyword">new</span> SimpleSequenceSizeReleaseStrategy() : releaseStrategy;
    ...
}</pre>
</div>
<p>As for the actual processing of the message group, the default implementation is the <code class="literal">DefaultAggregatingMessageGroupProcessor</code>.
It creates a single <code class="literal">Message</code> whose payload is a <code class="literal">List</code> of the payloads received for a given group.
This works well for simple scatter-gather implementations with a splitter, a publish-subscribe channel, or a recipient list router upstream.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>When using a publish-subscribe channel or a recipient list router in this type of scenario, be sure to enable the <code class="literal">apply-sequence</code> flag.
Doing so adds the necessary headers: <code class="literal">CORRELATION_ID</code>, <code class="literal">SEQUENCE_NUMBER</code>, and <code class="literal">SEQUENCE_SIZE</code>.
That behavior is enabled by default for splitters in Spring Integration, but it is not enabled for publish-subscribe channels or for recipient list routers because those components may be used in a variety of contexts in which these headers are not necessary.</p>
</td></tr></table></div>
<p>When implementing a specific aggregator strategy for an application, you can extend <code class="literal">AbstractAggregatingMessageGroupProcessor</code> and implement the <code class="literal">aggregatePayloads</code> method.
However, there are better solutions, less coupled to the API, for implementing the aggregation logic, which can be configured either through XML or through annotations.</p>
<p>In general, any POJO can implement the aggregation algorithm if it provides a method that accepts a single <code class="literal">java.util.List</code> as an argument (parameterized lists are supported as well).
This method is invoked for aggregating messages as follows:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
If the argument is a <code class="literal">java.util.Collection&lt;T&gt;</code> and the parameter type T is assignable to <code class="literal">Message</code>, the whole list of messages accumulated for aggregation is sent to the aggregator.
</li><li class="listitem">
If the argument is a non-parameterized <code class="literal">java.util.Collection</code> or the parameter type is not assignable to <code class="literal">Message</code>, the method receives the payloads of the accumulated messages.
</li><li class="listitem">
If the return type is not assignable to <code class="literal">Message</code>, it is treated as the payload for a <code class="literal">Message</code> that is automatically created by the framework.
</li></ul></div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>In the interest of code simplicity and promoting best practices such as low coupling, testability, and others, the preferred way of implementing the aggregation logic is through a POJO and using the XML or annotation support for configuring it in the application.</p>
</td></tr></table></div>
<p>Starting with version 5.1, after processing message group, an <code class="literal">AbstractCorrelatingMessageHandler</code> performs a <code class="literal">MessageBuilder.popSequenceDetails()</code> message headers modification for the proper splitter-aggregator scenario with several nested levels.
It is done only if the message group release result is not a message or collection of messages.
In that case a target <code class="literal">MessageGroupProcessor</code> is responsible for the <code class="literal">MessageBuilder.popSequenceDetails()</code> call while building those messages.
This functionality can be controlled by a new <code class="literal">popSequence</code> <code class="literal">boolean</code> property, so the <code class="literal">MessageBuilder.popSequenceDetails()</code> can be disabled in some scenarios when correlation details have not been populated by the standard splitter.
This property, essentially, undoes what has been done by the nearest upstream <code class="literal">applySequence = true</code> in the <code class="literal">AbstractMessageSplitter</code>.
See <a class="xref" href="#splitter" title="8.3&nbsp;Splitter">Section&nbsp;8.3, &#8220;Splitter&#8221;</a> for more information.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left"><a name="agg-message-collection" href="#agg-message-collection"></a>Important</th></tr><tr><td align="left" valign="top">
<p>The <code class="literal">SimpleMessageGroup.getMessages()</code> method returns an <code class="literal">unmodifiableCollection</code>.
Therefore, if your aggregating POJO method has a <code class="literal">Collection&lt;Message&gt;</code> parameter, the argument passed in is exactly that <code class="literal">Collection</code> instance and, when you use a <code class="literal">SimpleMessageStore</code> for the aggregator, that original <code class="literal">Collection&lt;Message&gt;</code> is cleared after releasing the group.
Consequently, the <code class="literal">Collection&lt;Message&gt;</code> variable in the POJO is cleared too, if it is passed out of the aggregator.
If you wish to simply release that collection as-is for further processing, you must build a new <code class="literal">Collection</code> (for example, <code class="literal">new ArrayList&lt;Message&gt;(messages)</code>).
Starting with version 4.3, the framework no longer copies the messages to a new collection, to avoid undesired extra object creation.</p>
</td></tr></table></div>
<p>If the <code class="literal">processMessageGroup</code> method of the <code class="literal">MessageGroupProcessor</code> returns a collection, it must be a collection of <code class="literal">Message&lt;?&gt;</code> objects.
In this case, the messages are individually released.
Prior to version 4.2, it was not possible to provide a <code class="literal">MessageGroupProcessor</code> by using XML configuration.
Only POJO methods could be used for aggregation.
Now, if the framework detects that the referenced (or inner) bean implements <code class="literal">MessageProcessor</code>, it is used as the aggregator&#8217;s output processor.</p>
<p>If you wish to release a collection of objects from a custom <code class="literal">MessageGroupProcessor</code> as the payload of a message, your class should extend <code class="literal">AbstractAggregatingMessageGroupProcessor</code> and implement <code class="literal">aggregatePayloads()</code>.</p>
<p>Also, since version 4.2, a <code class="literal">SimpleMessageGroupProcessor</code> is provided.
It returns the collection of messages from the group, which, as indicated earlier, causes the released messages to be sent individually.</p>
<p>This lets the aggregator work as a message barrier, where arriving messages are held until the release strategy fires and the group is released as a sequence of individual messages.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_literal_releasestrategy_literal" href="#_literal_releasestrategy_literal"></a><code class="literal">ReleaseStrategy</code></h4></div></div></div>

<p>The <code class="literal">ReleaseStrategy</code> interface is defined as follows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> ReleaseStrategy {

  <span class="hl-keyword">boolean</span> canRelease(MessageGroup group);

}</pre>
</div>
<p>In general, any POJO can implement the completion decision logic if it provides a method that accepts a single <code class="literal">java.util.List</code> as an argument (parameterized lists are supported as well) and returns a boolean value.
This method is invoked after the arrival of each new message, to decide whether the group is complete or not, as follows:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
If the argument is a <code class="literal">java.util.List&lt;T&gt;</code> and the parameter type <code class="literal">T</code> is assignable to <code class="literal">Message</code>, the whole list of messages accumulated in the group is sent to the method.
</li><li class="listitem">
If the argument is a non-parametrized <code class="literal">java.util.List</code> or the parameter type is not assignable to <code class="literal">Message</code>, the method receives the payloads of the accumulated messages.
</li><li class="listitem">
The method must return <code class="literal">true</code> if the message group is ready for aggregation or false otherwise.
</li></ul></div>
<p>The following example shows how to use the <code class="literal">@ReleaseStrategy</code> annotation for a <code class="literal">List</code> of type <code class="literal">Message</code>:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyReleaseStrategy {

    <em><span class="hl-annotation" style="color: gray">@ReleaseStrategy</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">boolean</span> canMessagesBeReleased(List&lt;Message&lt;?&gt;&gt;) {...}
}</pre>
</div>
<p>The following example shows how to use the <code class="literal">@ReleaseStrategy</code> annotation for a <code class="literal">List</code> of type <code class="literal">String</code>:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyReleaseStrategy {

    <em><span class="hl-annotation" style="color: gray">@ReleaseStrategy</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">boolean</span> canMessagesBeReleased(List&lt;String&gt;) {...}
}</pre>
</div>
<p>Based on the signatures in the preceding two examples, the POJO-based release strategy is passed a <code class="literal">Collection</code> of not-yet-released messages (if you need access to the whole <code class="literal">Message</code>) or a <code class="literal">Collection</code> of payload objects (if the type parameter is anything other than <code class="literal">Message</code>).
This satisfies the majority of use cases.
However if, for some reason, you need to access the full <code class="literal">MessageGroup</code>, you should provide an implementation of the <code class="literal">ReleaseStrategy</code> interface.</p>
<div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Warning"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Warning]" src="images/warning.png"></td><th align="left">Warning</th></tr><tr><td align="left" valign="top">
<p>When handling potentially large groups, you should understand how these methods are invoked, because the release strategy may be invoked multiple times before the group is released.
The most efficient is an implementation of <code class="literal">ReleaseStrategy</code>, because the aggregator can invoke it directly.
The second most efficient is a POJO method with a <code class="literal">Collection&lt;Message&lt;?&gt;&gt;</code> parameter type.
The least efficient is a POJO method with a <code class="literal">Collection&lt;Something&gt;</code> type. The framework has to copy the payloads from the messages in the group into a new collection (and possibly attempt conversion on the payloads to <code class="literal">Something</code>) every time the release strategy is called.
Using <code class="literal">Collection&lt;?&gt;</code> avoids the conversion but still requires creating the new <code class="literal">Collection</code>.</p>
<p>For these reasons, for large groups, we recommended that you implement <code class="literal">ReleaseStrategy</code>.</p>
</td></tr></table></div>
<p>When the group is released for aggregation, all its not-yet-released messages are processed and removed from the group.
If the group is also complete (that is, if all messages from a sequence have arrived or if there is no sequence defined), then the group is marked as complete.
Any new messages for this group are sent to the discard channel (if defined).
Setting <code class="literal">expire-groups-upon-completion</code> to <code class="literal">true</code> (the default is <code class="literal">false</code>) removes the entire group, and any new messages (with the same correlation ID as the removed group) form a new group.
You can release partial sequences by using a <code class="literal">MessageGroupStoreReaper</code> together with <code class="literal">send-partial-result-on-expiry</code> being set to <code class="literal">true</code>.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>To facilitate discarding of late-arriving messages, the aggregator must maintain state about the group after it has been released.
This can eventually cause out-of-memory conditions.
To avoid such situations, you should consider configuring a <code class="literal">MessageGroupStoreReaper</code> to remove the group metadata.
The expiry parameters should be set to expire groups once a point has been reach after after which late messages are not expected to arrive.
For information about configuring a reaper, see <a class="xref" href="#reaper" title="8.4.4&nbsp;Managing State in an Aggregator: MessageGroupStore">Section&nbsp;8.4.4, &#8220;Managing State in an Aggregator: <code class="literal">MessageGroupStore</code>&#8221;</a>.</p>
</td></tr></table></div>
<p>Spring Integration provides an implementation for <code class="literal">ReleaseStrategy</code>: <code class="literal">SimpleSequenceSizeReleaseStrategy</code>.
This implementation consults the <code class="literal">SEQUENCE_NUMBER</code> and <code class="literal">SEQUENCE_SIZE</code> headers of each arriving message to decide when a message group is complete and ready to be aggregated.
As shown earlier, it is also the default strategy.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Before version 5.0, the default release strategy was <code class="literal">SequenceSizeReleaseStrategy</code>, which does not perform well with large groups.
With that strategy, duplicate sequence numbers are detected and rejected.
This operation can be expensive.</p>
</td></tr></table></div>
<p>If you are aggregating large groups, you don&#8217;t need to release partial groups, and you don&#8217;t need to detect/reject duplicate sequences, consider using the <code class="literal">SimpleSequenceSizeReleaseStrategy</code> instead - it is much more efficient for these use cases, and is the default since <span class="emphasis"><em>version 5.0</em></span> when partial group release is not specified.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_aggregating_large_groups" href="#_aggregating_large_groups"></a>Aggregating Large Groups</h4></div></div></div>

<p>The 4.3 release changed the default <code class="literal">Collection</code> for messages in a <code class="literal">SimpleMessageGroup</code> to <code class="literal">HashSet</code> (it was previously a <code class="literal">BlockingQueue</code>).
This was expensive when removing individual messages from large groups (an O(n) linear scan was required).
Although the hash set is generally much faster to remove, it can be expensive for large messages, because the hash has to be calculated on both inserts and removes.
If you have messages that are expensive to hash, consider using some other collection type.
As discussed in <a class="xref" href="#message-group-factory" title="12.4.1&nbsp;Using MessageGroupFactory">Section&nbsp;12.4.1, &#8220;Using <code class="literal">MessageGroupFactory</code>&#8221;</a>, a <code class="literal">SimpleMessageGroupFactory</code> is provided so that you can select the <code class="literal">Collection</code> that best suits your needs.
You can also provide your own factory implementation to create some other <code class="literal">Collection&lt;Message&lt;?&gt;&gt;</code>.</p>
<p>The following example shows how to configure an aggregator with the previous implementation and a <code class="literal">SimpleSequenceSizeReleaseStrategy</code>:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:aggregator</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"aggregate"</span>
    <span class="hl-attribute">output-channel</span>=<span class="hl-value">"out"</span> <span class="hl-attribute">message-store</span>=<span class="hl-value">"store"</span> <span class="hl-attribute">release-strategy</span>=<span class="hl-value">"releaser"</span><span class="hl-tag"> /&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"store"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.store.SimpleMessageStore"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"messageGroupFactory"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.store.SimpleMessageGroupFactory"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"BLOCKING_QUEUE"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/bean&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"releaser"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"SimpleSequenceSizeReleaseStrategy"</span><span class="hl-tag"> /&gt;</span></pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_correlation_strategy" href="#_correlation_strategy"></a>Correlation Strategy</h4></div></div></div>

<p>The <code class="literal">CorrelationStrategy</code> interface is defined as follows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> CorrelationStrategy {

  Object getCorrelationKey(Message&lt;?&gt; message);

}</pre>
</div>
<p>The method returns an <code class="literal">Object</code> that represents the correlation key used for associating the message with a message group.
The key must satisfy the criteria used for a key in a <code class="literal">Map</code> with respect to the implementation of <code class="literal">equals()</code> and <code class="literal">hashCode()</code>.</p>
<p>In general, any POJO can implement the correlation logic, and the rules for mapping a message to a method&#8217;s argument (or arguments) are the same as for a <code class="literal">ServiceActivator</code> (including support for <code class="literal">@Header</code> annotations).
The method must return a value, and the value must not be <code class="literal">null</code>.</p>
<p>Spring Integration provides an implementation for <code class="literal">CorrelationStrategy</code>: <code class="literal">HeaderAttributeCorrelationStrategy</code>.
This implementation returns the value of one of the message headers (whose name is specified by a constructor argument) as the correlation key.
By default, the correlation strategy is a <code class="literal">HeaderAttributeCorrelationStrategy</code> that returns the value of the <code class="literal">CORRELATION_ID</code> header attribute.
If you have a custom header name you would like to use for correlation, you can configure it on an instance of <code class="literal">HeaderAttributeCorrelationStrategy</code> and provide that as a reference for the aggregator&#8217;s correlation strategy.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_lock_registry" href="#_lock_registry"></a>Lock Registry</h4></div></div></div>

<p>Changes to groups are thread safe.
So, when you send messages for the same correlation ID concurrently, only one of them will be processed in the aggregator, making it effectively as a <span class="strong"><strong>single-threaded per message group</strong></span>.
A <code class="literal">LockRegistry</code> is used to obtain a lock for the resolved correlation ID.
A <code class="literal">DefaultLockRegistry</code> is used by default (in-memory).
For synchronizing updates across servers where a shared <code class="literal">MessageGroupStore</code> is being used, you must configure a shared lock registry.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="aggregator-deadlocks" href="#aggregator-deadlocks"></a>Avoiding Deadlocks</h4></div></div></div>

<p>As discussed above, when message groups are mutated (messages added or released) a lock is held.</p>
<p>Consider the following flow:</p>
<div class="informalexample">
<pre class="screen">...-&gt;aggregator1-&gt; ... -&gt;aggregator2-&gt; ...</pre>
</div>
<p>If there are multiple threads, <span class="strong"><strong>and the aggregators share a common lock registry</strong></span>, it is possible to get a deadlock.
This will cause hung threads and <code class="literal">jstack &lt;pid&gt;</code> might present a result such as:</p>
<div class="informalexample">
<pre class="screen">Found one Java-level deadlock:
=============================
"t2":
  waiting for ownable synchronizer 0x000000076c1cbfa0, (a java.util.concurrent.locks.ReentrantLock$NonfairSync),
  which is held by "t1"
"t1":
  waiting for ownable synchronizer 0x000000076c1ccc00, (a java.util.concurrent.locks.ReentrantLock$NonfairSync),
  which is held by "t2"</pre>
</div>
<p>There are several ways to avoid this problem:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
ensure each aggregator has its own lock registry (this can be a shared registry across application instances but two or more aggregators in the flow must each have a distinct registry)
</li><li class="listitem">
use an <code class="literal">ExecutorChannel</code> or <code class="literal">QueueChannel</code> as the output channel of the aggregator so that the downstream flow runs on a new thread
</li><li class="listitem">
starting with version 5.1.1, set the <code class="literal">releaseLockBeforeSend</code> aggregator property to <code class="literal">true</code>
</li></ul></div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>This problem can also be caused if, for some reason, the output of a single aggregator is eventually routed back to the same aggregator.
Of course, the first solution above does not apply in this case.</p>
</td></tr></table></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="aggregator-java-dsl" href="#aggregator-java-dsl"></a>8.4.3&nbsp;Configuring an Aggregator in Java DSL</h3></div></div></div>

<p>See <a class="xref" href="#java-dsl-aggregators" title="11.9&nbsp;Aggregators and Resequencers">Section&nbsp;11.9, &#8220;Aggregators and Resequencers&#8221;</a> for how to configure an aggregator in Java DSL.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="aggregator-xml" href="#aggregator-xml"></a>Configuring an Aggregator with XML</h4></div></div></div>

<p>Spring Integration supports the configuration of an aggregator with XML through the <code class="literal">&lt;aggregator/&gt;</code> element.
The following example shows an example of an aggregator:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"inputChannel"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int:aggregator</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myAggregator"</span>                          <a name="CO5-1" href="#CO5-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
        auto-startup="true"                                <a name="CO5-2" href="#CO5-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
        input-channel="inputChannel"                       <a name="CO5-3" href="#CO5-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
        output-channel="outputChannel"                     <a name="CO5-4" href="#CO5-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
        discard-channel="throwAwayChannel"                 <a name="CO5-5" href="#CO5-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
        message-store="persistentMessageStore"             <a name="CO5-6" href="#CO5-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>
        order="1"                                          <a name="CO5-7" href="#CO5-7"></a><span><img src="images/callouts/7.png" alt="7" border="0"></span>
        send-partial-result-on-expiry="false"              <a name="CO5-8" href="#CO5-8"></a><span><img src="images/callouts/8.png" alt="8" border="0"></span>
        send-timeout="1000"                                <a name="CO5-9" href="#CO5-9"></a><span><img src="images/callouts/9.png" alt="9" border="0"></span>

        correlation-strategy="correlationStrategyBean"     <a name="CO5-10" href="#CO5-10"></a><span><img src="images/callouts/10.png" alt="10" border="0"></span>
        correlation-strategy-method="correlate"            <a name="CO5-11" href="#CO5-11"></a><span><img src="images/callouts/11.png" alt="11" border="0"></span>
        correlation-strategy-expression="headers['foo']"   <a name="CO5-12" href="#CO5-12"></a><span><img src="images/callouts/12.png" alt="12" border="0"></span>

        ref="aggregatorBean"                               <a name="CO5-13" href="#CO5-13"></a><span><img src="images/callouts/13.png" alt="13" border="0"></span>
        method="aggregate"                                 <a name="CO5-14" href="#CO5-14"></a><span><img src="images/callouts/14.png" alt="14" border="0"></span>

        release-strategy="releaseStrategyBean"             <a name="CO5-15" href="#CO5-15"></a><span><img src="images/callouts/15.png" alt="15" border="0"></span>
        release-strategy-method="release"                  <a name="CO5-16" href="#CO5-16"></a>(16)
        release-strategy-expression="size() == 5"          <a name="CO5-17" href="#CO5-17"></a>(17)

        expire-groups-upon-completion="false"              <a name="CO5-18" href="#CO5-18"></a>(18)
        empty-group-min-timeout="60000"                    <a name="CO5-19" href="#CO5-19"></a>(19)

        lock-registry="lockRegistry"                       <a name="CO5-20" href="#CO5-20"></a>(20)

        group-timeout="60000"                              <a name="CO5-21" href="#CO5-21"></a>(21)
        group-timeout-expression="size() ge 2 ? 100 : -1"  <a name="CO5-22" href="#CO5-22"></a>(22)
        expire-groups-upon-timeout="true"                  <a name="CO5-23" href="#CO5-23"></a>(23)

        scheduler="taskScheduler" &gt;                        <a name="CO5-24" href="#CO5-24"></a>(24)
            <span class="hl-tag">&lt;expire-transactional/&gt;</span>                        <a name="CO5-25" href="#CO5-25"></a>(25)
            <span class="hl-tag">&lt;expire-advice-chain/&gt;</span>                         <a name="CO5-26" href="#CO5-26"></a>(26)
<span class="hl-tag">&lt;/aggregator&gt;</span>

<span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"outputChannel"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"throwAwayChannel"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"persistentMessageStore"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.jdbc.store.JdbcMessageStore"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"dataSource"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"aggregatorBean"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"sample.PojoAggregator"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"releaseStrategyBean"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"sample.PojoReleaseStrategy"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"correlationStrategyBean"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"sample.PojoCorrelationStrategy"</span><span class="hl-tag">/&gt;</span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO5-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The id of the aggregator is optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO5-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Lifecycle attribute signaling whether the aggregator should be started during application context startup.
Optional (the default is <span class="emphasis"><em>true</em></span>).</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO5-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The channel from which where aggregator receives messages.
Required.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO5-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The channel to which the aggregator sends the aggregation results.
Optional (because incoming messages can themselves specify a reply channel in the <span class="emphasis"><em>replyChannel</em></span> message header).</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO5-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The channel to which the aggregator sends the messages that timed out (if <code class="literal">send-partial-result-on-expiry</code> is <code class="literal">false</code>).
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO5-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A reference to a <code class="literal">MessageGroupStore</code> used to store groups of messages under their correlation key until they are complete.
Optional.
By default, it is a volatile in-memory store.
See <a class="xref" href="#message-store" title="12.4&nbsp;Message Store">Section&nbsp;12.4, &#8220;Message Store&#8221;</a> for more information.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO5-7"><span><img src="images/callouts/7.png" alt="7" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The order of this aggregator when more than one handle is subscribed to the same <code class="literal">DirectChannel</code> (use for load-balancing purposes).
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO5-8"><span><img src="images/callouts/8.png" alt="8" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Indicates that expired messages should be aggregated and sent to the <span class="emphasis"><em>output-channel</em></span> or <span class="emphasis"><em>replyChannel</em></span> once their containing <code class="literal">MessageGroup</code> is expired (see <a class="ulink" href="https://docs.spring.io/spring-integration/api/org/springframework/integration/store/MessageGroupStore.html#expireMessageGroups-long" target="_top"><code class="literal">MessageGroupStore.expireMessageGroups(long)</code></a>).
One way of expiring a <code class="literal">MessageGroup</code> is by configuring a <code class="literal">MessageGroupStoreReaper</code>.
However you can alternatively expire <code class="literal">MessageGroup</code> by calling <code class="literal">MessageGroupStore.expireMessageGroups(timeout)</code>.
You can accomplish that through a Control Bus operation or, if you have a reference to the <code class="literal">MessageGroupStore</code> instance, by invoking <code class="literal">expireMessageGroups(timeout)</code>.
Otherwise, by itself, this attribute does nothing.
It serves only as an indicator of whether to discard or send to the output or reply channel any messages that are still in the <code class="literal">MessageGroup</code> that is about to be expired.
Optional (the default is <code class="literal">false</code>).
NOTE: This attribute might more properly be called <code class="literal">send-partial-result-on-timeout</code>, because the group may not actually expire if <code class="literal">expire-groups-upon-timeout</code> is set to <code class="literal">false</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO5-9"><span><img src="images/callouts/9.png" alt="9" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The timeout interval to wait when sending a reply <code class="literal">Message</code> to the <code class="literal">output-channel</code> or <code class="literal">discard-channel</code>.
Defaults to <code class="literal">-1</code>, which results in blocking indefinitely.
It is applied only if the output channel has some <span class="emphasis"><em>sending</em></span> limitations, such as a <code class="literal">QueueChannel</code> with a fixed <span class="emphasis"><em>capacity</em></span>.
In this case, a <code class="literal">MessageDeliveryException</code> is thrown.
For <code class="literal">AbstractSubscribableChannel</code> implementations, the <code class="literal">send-timeout</code> is ignored .
For <code class="literal">group-timeout(-expression)</code>, the <code class="literal">MessageDeliveryException</code> from the scheduled expire task leads this task to be rescheduled.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO5-10"><span><img src="images/callouts/10.png" alt="10" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A reference to a bean that implements the message correlation (grouping) algorithm.
The bean can be an implementation of the <code class="literal">CorrelationStrategy</code> interface or a POJO.
In the latter case, the <code class="literal">correlation-strategy-method</code> attribute must be defined as well.
Optional (by default, the aggregator uses the <code class="literal">IntegrationMessageHeaderAccessor.CORRELATION_ID</code> header).</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO5-11"><span><img src="images/callouts/11.png" alt="11" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A method defined on the bean referenced by <code class="literal">correlation-strategy</code>.
It implements the correlation decision algorithm.
Optional, with restrictions (<code class="literal">correlation-strategy</code> must be present).</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO5-12"><span><img src="images/callouts/12.png" alt="12" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A SpEL expression representing the correlation strategy.
Example: <code class="literal">"headers['something']"</code>.
Only one of <code class="literal">correlation-strategy</code> or <code class="literal">correlation-strategy-expression</code> is allowed.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO5-13"><span><img src="images/callouts/13.png" alt="13" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A reference to a bean defined in the application context.
The bean must implement the aggregation logic, as described earlier.
Optional (by default, the list of aggregated messages becomes a payload of the output message).</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO5-14"><span><img src="images/callouts/14.png" alt="14" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A method defined on the bean referenced by the <code class="literal">ref</code> attribute.
It implements the message aggregation algorithm.
Optional (it depends on <code class="literal">ref</code> attribute being defined).</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO5-15"><span><img src="images/callouts/15.png" alt="15" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A reference to a bean that implements the release strategy.
The bean can be an implementation of the <code class="literal">ReleaseStrategy</code> interface or a POJO.
In the latter case, the <code class="literal">release-strategy-method</code> attribute must be defined as well.
Optional (by default, the aggregator uses the <code class="literal">IntegrationMessageHeaderAccessor.SEQUENCE_SIZE</code> header attribute).</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO5-16">(16)</a> </p></td><td valign="top" align="left">
<p>A method defined on the bean referenced by the <code class="literal">release-strategy</code> attribute.
It implements the completion decision algorithm.
Optional, with restrictions (<code class="literal">release-strategy</code> must be present).</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO5-17">(17)</a> </p></td><td valign="top" align="left">
<p>A SpEL expression representing the release strategy.
The root object for the expression is a <code class="literal">MessageGroup</code>.
Example: <code class="literal">"size() == 5"</code>.
Only one of <code class="literal">release-strategy</code> or <code class="literal">release-strategy-expression</code> is allowed.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO5-18">(18)</a> </p></td><td valign="top" align="left">
<p>When set to <code class="literal">true</code> (the default is <code class="literal">false</code>), completed groups are removed from the message store, letting subsequent messages with the same correlation form a new group.
The default behavior is to send messages with the same correlation as a completed group to the <code class="literal">discard-channel</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO5-19">(19)</a> </p></td><td valign="top" align="left">
<p>Applies only if a <code class="literal">MessageGroupStoreReaper</code> is configured for the <code class="literal">MessageStore</code> of the <code class="literal">&lt;aggregator&gt;</code>.
By default, when a <code class="literal">MessageGroupStoreReaper</code> is configured to expire partial groups, empty groups are also removed.
Empty groups exist after a group is normally released.
The empty groups enable the detection and discarding of late-arriving messages.
If you wish to expire empty groups on a longer schedule than expiring partial groups, set this property.
Empty groups are then not removed from the <code class="literal">MessageStore</code> until they have not been modified for at least this number of milliseconds.
Note that the actual time to expire an empty group is also affected by the reaper&#8217;s <code class="literal">timeout</code> property, and it could be as much as this value plus the timeout.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO5-20">(20)</a> </p></td><td valign="top" align="left">
<p>A reference to a <code class="literal">org.springframework.integration.util.LockRegistry</code> bean.
It used to obtain a <code class="literal">Lock</code> based on the <code class="literal">groupId</code> for concurrent operations on the <code class="literal">MessageGroup</code>.
By default, an internal <code class="literal">DefaultLockRegistry</code> is used.
Use of a distributed <code class="literal">LockRegistry</code>, such as the <code class="literal">ZookeeperLockRegistry</code>, ensures only one instance of the aggregator can operate on a group concurrently.
See <a class="xref" href="#redis-lock-registry" title="27.10&nbsp;Redis Lock Registry">Section&nbsp;27.10, &#8220;Redis Lock Registry&#8221;</a>, <a class="xref" href="#gemfire-lock-registry" title="19.5&nbsp;Gemfire Lock Registry">Section&nbsp;19.5, &#8220;Gemfire Lock Registry&#8221;</a>, and <a class="xref" href="#zk-lock-registry" title="40.2&nbsp;Zookeeper Lock Registry">Section&nbsp;40.2, &#8220;Zookeeper Lock Registry&#8221;</a> for more information.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO5-21">(21)</a> </p></td><td valign="top" align="left">
<p>A timeout (in milliseconds) to force the <code class="literal">MessageGroup</code> complete when the <code class="literal">ReleaseStrategy</code> does not release the group when the current message arrives.
This attribute provides a built-in time-based release strategy for the aggregator when there is a need to emit a partial result (or discard the group) if a new message does not arrive for the <code class="literal">MessageGroup</code> within the timeout.
When a new message arrives at the aggregator, any existing <code class="literal">ScheduledFuture&lt;?&gt;</code> for its <code class="literal">MessageGroup</code> is canceled.
If the <code class="literal">ReleaseStrategy</code> returns <code class="literal">false</code> (meaning do not release) and <code class="literal">groupTimeout &gt; 0</code>, a new task is scheduled to expire the group.
We do not advise setting this attribute to zero (or a negative value).
Doing so effectively disables the aggregator, because every message group is immediately completed.
You can, however, conditionally set it to zero (or a negative value) by using an expression.
See <code class="literal">group-timeout-expression</code> for information.
The action taken during the completion depends on the <code class="literal">ReleaseStrategy</code> and the <code class="literal">send-partial-group-on-expiry</code> attribute.
See <a class="xref" href="#agg-and-group-to" title="Aggregator and Group Timeout">the section called &#8220;Aggregator and Group Timeout&#8221;</a> for more information.
It is mutually exclusive with <span class="emphasis"><em>group-timeout-expression</em></span> attribute.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO5-22">(22)</a> </p></td><td valign="top" align="left">
<p>The SpEL expression that evaluates to a <code class="literal">groupTimeout</code> with the <code class="literal">MessageGroup</code> as the <code class="literal">#root</code> evaluation context object.
Used for scheduling the <code class="literal">MessageGroup</code> to be forced complete.
If the expression evaluates to <code class="literal">null</code>, the completion is not scheduled.
If it evaluates to zero, the group is completed immediately on the current thread.
In effect, this provides a dynamic <code class="literal">group-timeout</code> property.
See <code class="literal">group-timeout</code> for more information.
Mutually exclusive with <span class="emphasis"><em>group-timeout</em></span> attribute.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO5-23">(23)</a> </p></td><td valign="top" align="left">
<p>When a group is completed due to a timeout (or by a <code class="literal">MessageGroupStoreReaper</code>), the group is expired (completely removed) by default.
Late arriving messages start a new group.
You can set this to <code class="literal">false</code> to complete the group but have its metadata remain so that late arriving messages are discarded.
Empty groups can be expired later using a <code class="literal">MessageGroupStoreReaper</code> together with the <code class="literal">empty-group-min-timeout</code> attribute.
It defaults to <span class="emphasis"><em>true</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO5-24">(24)</a> </p></td><td valign="top" align="left">
<p>A <code class="literal">TaskScheduler</code> bean reference to schedule the <code class="literal">MessageGroup</code> to be forced complete if no new message arrives for the <code class="literal">MessageGroup</code> within the <code class="literal">groupTimeout</code>.
If not provided, the default scheduler (<code class="literal">taskScheduler</code>) registered in the <code class="literal">ApplicationContext</code> (<code class="literal">ThreadPoolTaskScheduler</code>) is used.
This attribute does not apply if <code class="literal">group-timeout</code> or <code class="literal">group-timeout-expression</code> is not specified.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO5-25">(25)</a> </p></td><td valign="top" align="left">
<p>Since version 4.1.
It lets a transaction be started for the <code class="literal">forceComplete</code> operation.
It is initiated from a <code class="literal">group-timeout(-expression)</code> or by a <code class="literal">MessageGroupStoreReaper</code> and is not applied to the normal <code class="literal">add</code>, <code class="literal">release</code>, and <code class="literal">discard</code> operations.
Only this sub-element or <code class="literal">&lt;expire-advice-chain/&gt;</code> is allowed.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO5-26">(26)</a> </p></td><td valign="top" align="left">
<p>Since <span class="emphasis"><em>version 4.1</em></span>.
It allows the configuration of any <code class="literal">Advice</code> for the <code class="literal">forceComplete</code> operation.
It is initiated from a <code class="literal">group-timeout(-expression)</code> or by a <code class="literal">MessageGroupStoreReaper</code> and is not applied to the normal <code class="literal">add</code>, <code class="literal">release</code>, and <code class="literal">discard</code> operations.
Only this sub-element or <code class="literal">&lt;expire-transactional/&gt;</code> is allowed.
A transaction <code class="literal">Advice</code> can also be configured here by using the Spring <code class="literal">tx</code> namespace.</p>
</td></tr></table></div>
</div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important: Expiring Groups"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Expiring Groups</th></tr><tr><td align="left" valign="top">

<p>There are two attributes related to expiring (completely removing) groups.
When a group is expired, there is no record of it, and, if a new message arrives with the same correlation, a new group is started.
When a group is completed (without expiry), the empty group remains and late-arriving messages are discarded.
Empty groups can be removed later by using a <code class="literal">MessageGroupStoreReaper</code> in combination with the <code class="literal">empty-group-min-timeout</code> attribute.</p>
<p><code class="literal">expire-groups-upon-completion</code> relates to "<code class="literal">normal</code>" completion when the <code class="literal">ReleaseStrategy</code> releases the group.
This defaults to <code class="literal">false</code>.</p>
<p>If a group is not completed normally but is released or discarded because of a timeout, the group is normally expired.
Since version 4.1, you can control this behavior by using <code class="literal">expire-groups-upon-timeout</code>.
It defaults to <code class="literal">true</code> for backwards compatibility.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>When a group is timed out, the <code class="literal">ReleaseStrategy</code> is given one more opportunity to release the group.
If it does so and <code class="literal">expire-groups-upon-timeout</code> is false, expiration is controlled by <code class="literal">expire-groups-upon-completion</code>.
If the group is not released by the release strategy during timeout, then the expiration is controlled by the <code class="literal">expire-groups-upon-timeout</code>.
Timed-out groups are either discarded or a partial release occurs (based on <code class="literal">send-partial-result-on-expiry</code>).</p>
</td></tr></table></div>
<p>Since version 5.0, empty groups are also scheduled for removal after <code class="literal">empty-group-min-timeout</code>.
If <code class="literal">expireGroupsUponCompletion == false</code> and <code class="literal">minimumTimeoutForEmptyGroups &gt; 0</code>, the task to remove the group is scheduled when normal or partial sequences release happens.</p>
</td></tr></table></div>
<p>We generally recommend using a <code class="literal">ref</code> attribute if a custom aggregator handler implementation may be referenced in other <code class="literal">&lt;aggregator&gt;</code> definitions.
However, if a custom aggregator implementation is only being used by a single definition of the <code class="literal">&lt;aggregator&gt;</code>, you can use an inner bean definition (starting with version 1.0.3) to configure the aggregation POJO within the <code class="literal">&lt;aggregator&gt;</code> element, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;aggregator</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"sum"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;beans:bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.foo.PojoAggregator"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/aggregator&gt;</span></pre>
</div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Using both a <code class="literal">ref</code> attribute and an inner bean definition in the same <code class="literal">&lt;aggregator&gt;</code> configuration is not allowed, as it creates an ambiguous condition.
In such cases, an Exception is thrown.</p>
</td></tr></table></div>
<p>The following example shows an implementation of the aggregator bean:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> PojoAggregator {

  <span class="hl-keyword">public</span> Long add(List&lt;Long&gt; results) {
    <span class="hl-keyword">long</span> total = <span class="hl-number">0l</span>;
    <span class="hl-keyword">for</span> (<span class="hl-keyword">long</span> partialResult: results) {
      total += partialResult;
    }
    <span class="hl-keyword">return</span> total;
  }
}</pre>
</div>
<p>An implementation of the completion strategy bean for the preceding example might be as follows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> PojoReleaseStrategy {
...
  <span class="hl-keyword">public</span> <span class="hl-keyword">boolean</span> canRelease(List&lt;Long&gt; numbers) {
    <span class="hl-keyword">int</span> sum = <span class="hl-number">0</span>;
    <span class="hl-keyword">for</span> (<span class="hl-keyword">long</span> number: numbers) {
      sum += number;
    }
    <span class="hl-keyword">return</span> sum &gt;= maxValue;
  }
}</pre>
</div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Wherever it makes sense to do so, the release strategy method and the aggregator method can be combined into a single bean.</p>
</td></tr></table></div>
<p>An implementation of the correlation strategy bean for the example above might be as follows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> PojoCorrelationStrategy {
...
  <span class="hl-keyword">public</span> Long groupNumbersByLastDigit(Long number) {
    <span class="hl-keyword">return</span> number % <span class="hl-number">10</span>;
  }
}</pre>
</div>
<p>The aggregator in the preceding example would group numbers by some criterion (in this case, the remainder after dividing by ten) and hold the group until the sum of the numbers provided by the payloads exceeds a certain value.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Wherever it makes sense to do so, the release strategy method, the correlation strategy method, and the aggregator method can be combined in a single bean.
(Actually, all of them or any two of them can be combined.)</p>
</td></tr></table></div>
<div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="aggregator-spel" href="#aggregator-spel"></a>Aggregators and Spring Expression Language (SpEL)</h5></div></div></div>

<p>Since Spring Integration 2.0, you can handle the various strategies (correlation, release, and aggregation) with <a class="ulink" href="http://docs.spring.io/spring/docs/current/spring-framework-reference/html/expressions.html" target="_top">SpEL</a>, which we recommend if the logic behind such a release strategy is relatively simple.
Suppose you have a legacy component that was designed to receive an array of objects.
We know that the default release strategy assembles all aggregated messages in the <code class="literal">List</code>.
Now we have two problems.
First, we need to extract individual messages from the list. Second, we need to extract the payload of each message and assemble the array of objects.
The following example solves both problems:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> String[] processRelease(List&lt;Message&lt;String&gt;&gt; messages){
    List&lt;String&gt; stringList = <span class="hl-keyword">new</span> ArrayList&lt;String&gt;();
    <span class="hl-keyword">for</span> (Message&lt;String&gt; message : messages) {
        stringList.add(message.getPayload());
    }
    <span class="hl-keyword">return</span> stringList.toArray(<span class="hl-keyword">new</span> String[]{});
}</pre>
</div>
<p>However, with SpEL, such a requirement could actually be handled relatively easily with a one-line expression, thus sparing you from writing a custom class and configuring it as a bean.
The following example shows how to do so:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:aggregator</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"aggChannel"</span>
    <span class="hl-attribute">output-channel</span>=<span class="hl-value">"replyChannel"</span>
    <span class="hl-attribute">expression</span>=<span class="hl-value">"#this.![payload].toArray()"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>In the preceding configuration, we use a <a class="ulink" href="http://docs.spring.io/spring/docs/current/spring-framework-reference/html/expressions.html#expressions-collection-projection" target="_top">collection projection</a> expression to assemble a new collection from the payloads of all the messages in the list and then transform it to an array, thus achieving the same result as the earlier Java code.</p>
<p>You can apply the same expression-based approach when dealing with custom release and correlation strategies.</p>
<p>Instead of defining a bean for a custom <code class="literal">CorrelationStrategy</code> in the <code class="literal">correlation-strategy</code> attribute, you can implement your simple correlation logic as a SpEL expression and configure it in the <code class="literal">correlation-strategy-expression</code> attribute, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting">correlation-strategy-expression="payload.person.id"</pre>
</div>
<p>In the preceding example, we assume that the payload has a <code class="literal">person</code> attribute with an <code class="literal">id</code>, which is going to be used to correlate messages.</p>
<p>Likewise, for the <code class="literal">ReleaseStrategy</code>, you can implement your release logic as a SpEL expression and configure it in the <code class="literal">release-strategy-expression</code> attribute.
The root object for evaluation context is the <code class="literal">MessageGroup</code> itself.
The <code class="literal">List</code> of messages can be referenced by using the <code class="literal">message</code> property of the group within the expression.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>In releases prior to version 5.0, the root object was the collection of <code class="literal">Message&lt;?&gt;</code>, as the previous example shows:</p>
</td></tr></table></div>
<div class="informalexample">
<pre class="programlisting">release-strategy-expression="!messages.?[payload==5].empty"</pre>
</div>
<p>In the preceding example, the root object of the SpEL evaluation context is the <code class="literal">MessageGroup</code> itself, and you are stating that, as soon as there is a message with payload of <code class="literal">5</code> in this group, the group should be released.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="agg-and-group-to" href="#agg-and-group-to"></a>Aggregator and Group Timeout</h5></div></div></div>

<p>Starting with version 4.0, two new mutually exclusive attributes have been introduced: <code class="literal">group-timeout</code> and <code class="literal">group-timeout-expression</code> (see the earlier description).
See <a class="xref" href="#aggregator-xml" title="Configuring an Aggregator with XML">the section called &#8220;Configuring an Aggregator with XML&#8221;</a>.
In some cases, you may need to emit the aggregator result (or discard the group) after a timeout if the <code class="literal">ReleaseStrategy</code> does not release when the current message arrives.
For this purpose, the <code class="literal">groupTimeout</code> option lets scheduling the <code class="literal">MessageGroup</code> be forced to complete, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;aggregator</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span>
        <span class="hl-attribute">send-partial-result-on-expiry</span>=<span class="hl-value">"true"</span>
        <span class="hl-attribute">group-timeout-expression</span>=<span class="hl-value">"size() ge 2 ? 10000 : -1"</span>
        <span class="hl-attribute">release-strategy-expression</span>=<span class="hl-value">"messages[0].headers.sequenceNumber == messages[0].headers.sequenceSize"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>With this example, the normal release is possible if the aggregator receives the last message in sequence as defined by the <code class="literal">release-strategy-expression</code>.
If that specific message does not arrive, the <code class="literal">groupTimeout</code> forces the group to complete after ten seconds, as long as the group contains at least two Messages.</p>
<p>The results of forcing the group to complete depends on the <code class="literal">ReleaseStrategy</code> and the <code class="literal">send-partial-result-on-expiry</code>.
First, the release strategy is again consulted to see if a normal release is to be made.
While the group has not changed, the <code class="literal">ReleaseStrategy</code> can decide to release the group at this time.
If the release strategy still does not release the group, it is expired.
If <code class="literal">send-partial-result-on-expiry</code> is <code class="literal">true</code>, existing messages in the (partial) <code class="literal">MessageGroup</code> are released as a normal aggregator reply message to the <code class="literal">output-channel</code>.
Otherwise, it is discarded.</p>
<p>There is a difference between <code class="literal">groupTimeout</code> behavior and <code class="literal">MessageGroupStoreReaper</code> (see <a class="xref" href="#aggregator-xml" title="Configuring an Aggregator with XML">the section called &#8220;Configuring an Aggregator with XML&#8221;</a>).
The reaper initiates forced completion for all <code class="literal">MessageGroup</code> s in the <code class="literal">MessageGroupStore</code> periodically.
The <code class="literal">groupTimeout</code> does it for each <code class="literal">MessageGroup</code> individually if a new message does not arrive during the <code class="literal">groupTimeout</code>.
Also, the reaper can be used to remove empty groups (empty groups are retained in order to discard late messages if <code class="literal">expire-groups-upon-completion</code> is false).</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="aggregator-annotations" href="#aggregator-annotations"></a>Configuring an Aggregator with Annotations</h4></div></div></div>

<p>The following example shows an aggregator configured with annotations:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> Waiter {
  ...

  <em><span class="hl-annotation" style="color: gray">@Aggregator</span></em>  <a name="CO6-1" href="#CO6-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
  <span class="hl-keyword">public</span> Delivery aggregatingMethod(List&lt;OrderItem&gt; items) {
    ...
  }

  <em><span class="hl-annotation" style="color: gray">@ReleaseStrategy</span></em>  <a name="CO6-2" href="#CO6-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
  <span class="hl-keyword">public</span> <span class="hl-keyword">boolean</span> releaseChecker(List&lt;Message&lt;?&gt;&gt; messages) {
    ...
  }

  <em><span class="hl-annotation" style="color: gray">@CorrelationStrategy</span></em>  <a name="CO6-3" href="#CO6-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
  <span class="hl-keyword">public</span> String correlateBy(OrderItem item) {
    ...
  }
}</pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO6-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>An annotation indicating that this method should be used as an aggregator.
It must be specified if this class is used as an aggregator.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO6-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>An annotation indicating that this method is used as the release strategy of an aggregator.
If not present on any method, the aggregator uses the <code class="literal">SimpleSequenceSizeReleaseStrategy</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO6-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>An annotation indicating that this method should be used as the correlation strategy of an aggregator.
If no correlation strategy is indicated, the aggregator uses the <code class="literal">HeaderAttributeCorrelationStrategy</code> based on <code class="literal">CORRELATION_ID</code>.</p>
</td></tr></table></div>
</div>
<p>All of the configuration options provided by the XML element are also available for the <code class="literal">@Aggregator</code> annotation.</p>
<p>The aggregator can be either referenced explicitly from XML or, if the <code class="literal">@MessageEndpoint</code> is defined on the class, detected automatically through classpath scanning.</p>
<p>Annotation configuration (<code class="literal">@Aggregator</code> and others) for the Aggregator component covers only simple use cases, where most default options are sufficient.
If you need more control over those options when using annotation configuration, consider using a <code class="literal">@Bean</code> definition for the <code class="literal">AggregatingMessageHandler</code> and mark its <code class="literal">@Bean</code> method with <code class="literal">@ServiceActivator</code>, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "aggregatorChannel")</span></em>
<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> MessageHandler aggregator(MessageGroupStore jdbcMessageGroupStore) {
     AggregatingMessageHandler aggregator =
                       <span class="hl-keyword">new</span> AggregatingMessageHandler(<span class="hl-keyword">new</span> DefaultAggregatingMessageGroupProcessor(),
                                                 jdbcMessageGroupStore);
     aggregator.setOutputChannel(resultsChannel());
     aggregator.setGroupTimeoutExpression(<span class="hl-keyword">new</span> ValueExpression&lt;&gt;(<span class="hl-number">500L</span>));
     aggregator.setTaskScheduler(<span class="hl-keyword">this</span>.taskScheduler);
     <span class="hl-keyword">return</span> aggregator;
}</pre>
</div>
<p>See <a class="xref" href="#aggregator-api" title="8.4.2&nbsp;Programming Model">Section&nbsp;8.4.2, &#8220;Programming Model&#8221;</a> and <a class="xref" href="#annotations_on_beans" title="E.6.1&nbsp;Annotations on @Bean Methods">Section&nbsp;E.6.1, &#8220;Annotations on <code class="literal">@Bean</code> Methods&#8221;</a> for more information.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Starting with version 4.2, the <code class="literal">AggregatorFactoryBean</code> is available to simplify Java configuration for the <code class="literal">AggregatingMessageHandler</code>.</p>
</td></tr></table></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="reaper" href="#reaper"></a>8.4.4&nbsp;Managing State in an Aggregator: <code class="literal">MessageGroupStore</code></h3></div></div></div>

<p>Aggregator (and some other patterns in Spring Integration) is a stateful pattern that requires decisions to be made based on a group of messages that have arrived over a period of time, all with the same correlation key.
The design of the interfaces in the stateful patterns (such as <code class="literal">ReleaseStrategy</code>) is driven by the principle that the components (whether defined by the framework or by a user) should be able to remain stateless.
All state is carried by the <code class="literal">MessageGroup</code> and its management is delegated to the <code class="literal">MessageGroupStore</code>.
The <code class="literal">MessageGroupStore</code> interface is defined as follows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> MessageGroupStore {

    <span class="hl-keyword">int</span> getMessageCountForAllMessageGroups();

    <span class="hl-keyword">int</span> getMarkedMessageCountForAllMessageGroups();

    <span class="hl-keyword">int</span> getMessageGroupCount();

    MessageGroup getMessageGroup(Object groupId);

    MessageGroup addMessageToGroup(Object groupId, Message&lt;?&gt; message);

    MessageGroup markMessageGroup(MessageGroup group);

    MessageGroup removeMessageFromGroup(Object key, Message&lt;?&gt; messageToRemove);

    MessageGroup markMessageFromGroup(Object key, Message&lt;?&gt; messageToMark);

    <span class="hl-keyword">void</span> removeMessageGroup(Object groupId);

    <span class="hl-keyword">void</span> registerMessageGroupExpiryCallback(MessageGroupCallback callback);

    <span class="hl-keyword">int</span> expireMessageGroups(<span class="hl-keyword">long</span> timeout);
}</pre>
</div>
<p>For more information, see the <a class="ulink" href="http://docs.spring.io/spring-integration/api/org/springframework/integration/store/MessageGroupStore.html" target="_top">Javadoc</a>.</p>
<p>The <code class="literal">MessageGroupStore</code> accumulates state information in <code class="literal">MessageGroups</code> while waiting for a release strategy to be triggered, and that event might not ever happen.
So, to prevent stale messages from lingering, and for volatile stores to provide a hook for cleaning up when the application shuts down, the <code class="literal">MessageGroupStore</code> lets you register callbacks to apply to its <code class="literal">MessageGroups</code> when they expire.
The interface is very straightforward, as the following listing shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> MessageGroupCallback {

    <span class="hl-keyword">void</span> execute(MessageGroupStore messageGroupStore, MessageGroup group);

}</pre>
</div>
<p>The callback has direct access to the store and the message group so that it can manage the persistent state (for example, by entirely removing the group from the store).</p>
<p>The <code class="literal">MessageGroupStore</code> maintains a list of these callbacks, which it applies, on demand, to all messages whose timestamps are earlier than a time supplied as a parameter (see the <code class="literal">registerMessageGroupExpiryCallback(..)</code> and <code class="literal">expireMessageGroups(..)</code> methods, described earlier).
For more detail, see <a class="xref" href="#reaper" title="8.4.4&nbsp;Managing State in an Aggregator: MessageGroupStore">Section&nbsp;8.4.4, &#8220;Managing State in an Aggregator: <code class="literal">MessageGroupStore</code>&#8221;</a>.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>It is important not to use the same <code class="literal">MessageGroupStore</code> instance in different aggregator components, when you intend to rely on the <code class="literal">expireMessageGroups</code> functionality.
Every <code class="literal">AbstractCorrelatingMessageHandler</code> registers its own <code class="literal">MessageGroupCallback</code> based on the <code class="literal">forceComplete()</code> callback.
This way each group for expiration may be completed or discarded by the wrong aggregator.
Starting with version 5.0.10, a <code class="literal">UniqueExpiryCallback</code> is used from the <code class="literal">AbstractCorrelatingMessageHandler</code> for the registration callback in the <code class="literal">MessageGroupStore</code>.
The <code class="literal">MessageGroupStore</code>, in turn, checks for presence an instance of this class and logs an error with an appropriate message if one is already present in the callbacks set.
This way the Framework disallows usage of the <code class="literal">MessageGroupStore</code> instance in different aggregators/resequencers to avoid the mentioned side effect of expiration the groups not created by the particular correlation handler.</p>
</td></tr></table></div>
<p>You can call the <code class="literal">expireMessageGroups</code> method with a timeout value.
Any message older than the current time minus this value is expired and has the callbacks applied.
Thus, it is the user of the store that defines what is meant by message group "<code class="literal">expiry</code>".</p>
<p>As a convenience for users, Spring Integration provides a wrapper for the message expiry in the form of a <code class="literal">MessageGroupStoreReaper</code>, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"reaper"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org...MessageGroupStoreReaper"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"messageGroupStore"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"messageStore"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"timeout"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"30000"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;task:scheduled-tasks</span> <span class="hl-attribute">scheduler</span>=<span class="hl-value">"scheduler"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;task:scheduled</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"reaper"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"run"</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"10000"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/task:scheduled-tasks&gt;</span></pre>
</div>
<p>The reaper is a <code class="literal">Runnable</code>.
In the preceding example, the message group store&#8217;s expire method is called every ten seconds.
The timeout itself is 30 seconds.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>It is important to understand that the <span class="emphasis"><em>timeout</em></span> property of <code class="literal">MessageGroupStoreReaper</code> is an approximate value and is impacted by the the rate of the task scheduler, since this property is only checked on the next scheduled execution of the <code class="literal">MessageGroupStoreReaper</code> task.
For example, if the timeout is set for ten minutes but the <code class="literal">MessageGroupStoreReaper</code> task is scheduled to run every hour and the last execution of the <code class="literal">MessageGroupStoreReaper</code> task happened one minute before the timeout, the <code class="literal">MessageGroup</code> does not expire for the next 59 minutes.
Consequently, we recommend setting the rate to be at least equal to the value of the timeout or shorter.</p>
</td></tr></table></div>
<p>In addition to the reaper, the expiry callbacks are invoked when the application shuts down through a lifecycle callback in the <code class="literal">AbstractCorrelatingMessageHandler</code>.</p>
<p>The <code class="literal">AbstractCorrelatingMessageHandler</code> registers its own expiry callback, and this is the link with the boolean flag <code class="literal">send-partial-result-on-expiry</code> in the XML configuration of the aggregator.
If the flag is set to <code class="literal">true</code>, then, when the expiry callback is invoked, any unmarked messages in groups that are not yet released can be sent on to the output channel.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>When a shared <code class="literal">MessageStore</code> is used for different correlation endpoints, you must configure a proper <code class="literal">CorrelationStrategy</code> to ensure uniqueness for group IDs.
Otherwise, unexpected behavior may happen when one correlation endpoint releases or expire messages from others.
Messages with the same correlation key are stored in the same message group.</p>
<p>Some <code class="literal">MessageStore</code> implementations allow using the same physical resources, by partitioning the data.
For example, the <code class="literal">JdbcMessageStore</code> has a <code class="literal">region</code> property, and the <code class="literal">MongoDbMessageStore</code> has a <code class="literal">collectionName</code> property.</p>
<p>For more information about the <code class="literal">MessageStore</code> interface and its implementations, see <a class="xref" href="#message-store" title="12.4&nbsp;Message Store">Section&nbsp;12.4, &#8220;Message Store&#8221;</a>.</p>
</td></tr></table></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="resequencer" href="#resequencer"></a>8.5&nbsp;Resequencer</h2></div></div></div>

<p>The resequencer is related to the aggregator but serves a different purpose. While the aggregator combines messages, the resequencer passes messages through without changing them.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="resequencer-functionality" href="#resequencer-functionality"></a>8.5.1&nbsp;Functionality</h3></div></div></div>

<p>The resequencer works in a similar way to the aggregator, in the sense that it uses the <code class="literal">CORRELATION_ID</code> to store messages in groups. he difference is that the Resequencer does not process the messages in any way.
Instead, it releases them in the order of their <code class="literal">SEQUENCE_NUMBER</code> header values.</p>
<p>With respect to that, you can opt to release all messages at once (after the whole sequence, according to the <code class="literal">SEQUENCE_SIZE</code>, and other possibilities) or as soon as a valid sequence is available. (We cover what we mean by "a valid sequence" later in this chapter.)</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>The resequencer is intended to resequence relatively short sequences of messages with small gaps.
If you have a large number of disjoint sequences with many gaps, you may experience performance issues.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_a_resequencer" href="#_configuring_a_resequencer"></a>8.5.2&nbsp;Configuring a Resequencer</h3></div></div></div>

<p>See <a class="xref" href="#java-dsl-aggregators" title="11.9&nbsp;Aggregators and Resequencers">Section&nbsp;11.9, &#8220;Aggregators and Resequencers&#8221;</a> for configuring a resequencer in Java DSL.</p>
<p>Configuring a resequencer requires only including the appropriate element in XML.</p>
<p>The following example shows a resequencer configuration:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"inputChannel"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"outputChannel"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int:resequencer</span> <span class="hl-attribute">id</span>=<span class="hl-value">"completelyDefinedResequencer"</span>  <a name="CO7-1" href="#CO7-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
  input-channel="inputChannel"  <a name="CO7-2" href="#CO7-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
  output-channel="outputChannel"  <a name="CO7-3" href="#CO7-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
  discard-channel="discardChannel"  <a name="CO7-4" href="#CO7-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
  release-partial-sequences="true"  <a name="CO7-5" href="#CO7-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
  message-store="messageStore"  <a name="CO7-6" href="#CO7-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>
  send-partial-result-on-expiry="true"  <a name="CO7-7" href="#CO7-7"></a><span><img src="images/callouts/7.png" alt="7" border="0"></span>
  send-timeout="86420000"  <a name="CO7-8" href="#CO7-8"></a><span><img src="images/callouts/8.png" alt="8" border="0"></span>
  correlation-strategy="correlationStrategyBean"  <a name="CO7-9" href="#CO7-9"></a><span><img src="images/callouts/9.png" alt="9" border="0"></span>
  correlation-strategy-method="correlate"  <a name="CO7-10" href="#CO7-10"></a><span><img src="images/callouts/10.png" alt="10" border="0"></span>
  correlation-strategy-expression="headers['something']"  <a name="CO7-11" href="#CO7-11"></a><span><img src="images/callouts/11.png" alt="11" border="0"></span>
  release-strategy="releaseStrategyBean"  <a name="CO7-12" href="#CO7-12"></a><span><img src="images/callouts/12.png" alt="12" border="0"></span>
  release-strategy-method="release"  <a name="CO7-13" href="#CO7-13"></a><span><img src="images/callouts/13.png" alt="13" border="0"></span>
  release-strategy-expression="size() == 10"  <a name="CO7-14" href="#CO7-14"></a><span><img src="images/callouts/14.png" alt="14" border="0"></span>
  empty-group-min-timeout="60000"  <a name="CO7-15" href="#CO7-15"></a><span><img src="images/callouts/15.png" alt="15" border="0"></span>

  lock-registry="lockRegistry"  <a name="CO7-16" href="#CO7-16"></a>(16)

  group-timeout="60000"  <a name="CO7-17" href="#CO7-17"></a>(17)
  group-timeout-expression="size() ge 2 ? 100 : -1"  <a name="CO7-18" href="#CO7-18"></a>(18)
  scheduler="taskScheduler" /&gt;  <a name="CO7-19" href="#CO7-19"></a>(19)
  expire-group-upon-timeout="false" /&gt;  <a name="CO7-20" href="#CO7-20"></a>(20)</pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO7-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The id of the resequencer is optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO7-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The input channel of the resequencer.
Required.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO7-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The channel to which the resequencer sends the reordered messages.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO7-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The channel to which the resequencer  sends the messages that timed out (if <code class="literal">send-partial-result-on-timeout</code> is set to <code class="literal">false</code>).
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO7-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Whether to send out ordered sequences as soon as they are available or only after the whole message group arrives.
Optional. (The default is <code class="literal">false</code>.)</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO7-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A reference to a <code class="literal">MessageGroupStore</code> that can be used to store groups of messages under their correlation key until they are complete.
Optional. (The default is a volatile in-memory store.)</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO7-7"><span><img src="images/callouts/7.png" alt="7" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Whether, upon the expiration of the group, the ordered group should be sent out (even if some of the messages are missing).
Optional. (The default is false.)
See <a class="xref" href="#reaper" title="8.4.4&nbsp;Managing State in an Aggregator: MessageGroupStore">Section&nbsp;8.4.4, &#8220;Managing State in an Aggregator: <code class="literal">MessageGroupStore</code>&#8221;</a>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO7-8"><span><img src="images/callouts/8.png" alt="8" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The timeout interval to wait when sending a reply <code class="literal">Message</code> to the <code class="literal">output-channel</code> or <code class="literal">discard-channel</code>.
Defaults to <code class="literal">-1</code>, which blocks indefinitely.
It is applied only if the output channel has some <span class="emphasis"><em>sending</em></span> limitations, such as a  <code class="literal">QueueChannel</code> with a fixed <span class="emphasis"><em>capacity</em></span>.
In this case, a <code class="literal">MessageDeliveryException</code> is thrown.
The <code class="literal">send-timeout</code> is ignored for <code class="literal">AbstractSubscribableChannel</code> implementations.
For <code class="literal">group-timeout(-expression)</code>, the <code class="literal">MessageDeliveryException</code> from the scheduled expire task leads this task to be rescheduled.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO7-9"><span><img src="images/callouts/9.png" alt="9" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A reference to a bean that implements the message correlation (grouping) algorithm.
The bean can be an implementation of the <code class="literal">CorrelationStrategy</code> interface or a POJO.
In the latter case, the <code class="literal">correlation-strategy-method</code> attribute must also be defined.
Optional. (By default, the aggregator uses the <code class="literal">IntegrationMessageHeaderAccessor.CORRELATION_ID</code> header.)</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO7-10"><span><img src="images/callouts/10.png" alt="10" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A method that is defined on the bean referenced by <code class="literal">correlation-strategy</code> and that implements the correlation decision algorithm.
Optional, with restrictions (requires <code class="literal">correlation-strategy</code> to be present).</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO7-11"><span><img src="images/callouts/11.png" alt="11" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A SpEL expression representing the correlation strategy.
Example: <code class="literal">"headers['something']"</code>.
Only one of <code class="literal">correlation-strategy</code> or <code class="literal">correlation-strategy-expression</code> is allowed.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO7-12"><span><img src="images/callouts/12.png" alt="12" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A reference to a bean that implements the release strategy.
The bean can be an implementation of the <code class="literal">ReleaseStrategy</code> interface or a POJO.
In the latter case, the <code class="literal">release-strategy-method</code> attribute must also be defined.
Optional (by default, the aggregator will use the <code class="literal">IntegrationMessageHeaderAccessor.SEQUENCE_SIZE</code> header attribute).</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO7-13"><span><img src="images/callouts/13.png" alt="13" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A method that is defined on the bean referenced by <code class="literal">release-strategy</code> and that implements the completion decision algorithm.
Optional, with restrictions (requires <code class="literal">release-strategy</code> to be present).</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO7-14"><span><img src="images/callouts/14.png" alt="14" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A SpEL expression representing the release strategy.
The root object for the expression is a <code class="literal">MessageGroup</code>.
Example: <code class="literal">"size() == 5"</code>.
Only one of <code class="literal">release-strategy</code> or <code class="literal">release-strategy-expression</code> is allowed.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO7-15"><span><img src="images/callouts/15.png" alt="15" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Only applies if a <code class="literal">MessageGroupStoreReaper</code> is configured for the <code class="literal">&lt;resequencer&gt;</code> <code class="literal">MessageStore</code>.
By default, when a <code class="literal">MessageGroupStoreReaper</code> is configured to expire partial groups, empty groups are also removed.
Empty groups exist after a group is released normally.
This is to enable the detection and discarding of late-arriving messages.
If you wish to expire empty groups on a longer schedule than expiring partial groups, set this property.
Empty groups are then not removed from the <code class="literal">MessageStore</code> until they have not been modified for at least this number of milliseconds.
Note that the actual time to expire an empty group is also affected by the reaper&#8217;s timeout property, and it could be as much as this value plus the timeout.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO7-16">(16)</a> </p></td><td valign="top" align="left">
<p>See <a class="xref" href="#aggregator-xml" title="Configuring an Aggregator with XML">the section called &#8220;Configuring an Aggregator with XML&#8221;</a>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO7-17">(17)</a> </p></td><td valign="top" align="left">
<p>See <a class="xref" href="#aggregator-xml" title="Configuring an Aggregator with XML">the section called &#8220;Configuring an Aggregator with XML&#8221;</a>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO7-18">(18)</a> </p></td><td valign="top" align="left">
<p>See <a class="xref" href="#aggregator-xml" title="Configuring an Aggregator with XML">the section called &#8220;Configuring an Aggregator with XML&#8221;</a>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO7-19">(19)</a> </p></td><td valign="top" align="left">
<p>See <a class="xref" href="#aggregator-xml" title="Configuring an Aggregator with XML">the section called &#8220;Configuring an Aggregator with XML&#8221;</a>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO7-20">(20)</a> </p></td><td valign="top" align="left">
<p>By default, when a group is completed due to a timeout (or by a <code class="literal">MessageGroupStoreReaper</code>), the empty group&#8217;s metadata is retained.
Late arriving messages are immediately discarded.
Set this to <code class="literal">true</code> to remove the group completely.
Then, late arriving messages start a new group and are not be discarded until the group again times out.
The new group is never released normally because of the "<code class="literal">hole</code>" in the sequence range that caused the timeout.
Empty groups can be expired (completely removed) later by using a <code class="literal">MessageGroupStoreReaper</code> together with the <code class="literal">empty-group-min-timeout</code> attribute.
Starting with version 5.0, empty groups are also scheduled for removal after the <code class="literal">empty-group-min-timeout</code> elapses.
The default is <span class="emphasis"><em>false</em></span>.</p>
</td></tr></table></div>
</div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Since there is no custom behavior to be implemented in Java classes for resequencers, there is no annotation support for it.</p>
</td></tr></table></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="chain" href="#chain"></a>8.6&nbsp;Message Handler Chain</h2></div></div></div>

<p>The <code class="literal">MessageHandlerChain</code> is an implementation of <code class="literal">MessageHandler</code> that can be configured as a single message endpoint while actually delegating to a chain of other handlers, such as filters, transformers, splitters, and so on.
When several handlers need to be connected in a fixed, linear progression, this can lead to a much simpler configuration.
For example, it is fairly common to provide a transformer before other components.
Similarly, when you provide a filter before some other component in a chain, you essentially create a <a class="ulink" href="http://www.eaipatterns.com/MessageSelector.html" target="_top">selective consumer</a>.
In either case, the chain requires only a single <code class="literal">input-channel</code> and a single <code class="literal">output-channel</code>, eliminating the need to define channels for each individual component.</p>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>Spring Integration&#8217;s <code class="literal">Filter</code> provides a boolean property: <code class="literal">throwExceptionOnRejection</code>.
When you provide multiple selective consumers on the same point-to-point channel with different acceptance criteria, you should set this value <span class="emphasis"><em>true</em></span> (the default is <code class="literal">false</code>) so that the dispatcher knows that the message was rejected and, as a result, tries to pass the message on to other subscribers.
If the exception were not thrown, it would appear to the dispatcher that the message had been passed on successfully even though the filter had dropped the message to prevent further processing.
If you do indeed want to "<code class="literal">drop</code>" the messages, the filter&#8217;s <span class="emphasis"><em>discard-channel</em></span> might be useful, since it does give you a chance to perform some operation with the dropped message (such as sending it to a JMS queue or writing it to a log).</p>
</td></tr></table></div>
<p>The handler chain simplifies configuration while internally maintaining the same degree of loose coupling between components, and it is trivial to modify the configuration if at some point a non-linear arrangement is required.</p>
<p>Internally, the chain is expanded into a linear setup of the listed endpoints, separated by anonymous channels.
The reply channel header is not taken into account within the chain.
Only after the last handler is invoked is the resulting message forwarded to the reply channel or the chain&#8217;s output channel.
Because of this setup, all handlers except the last must implement the <code class="literal">MessageProducer</code> interface (which provides a <span class="emphasis"><em>setOutputChannel()</em></span> method).
If the <code class="literal">outputChannel</code> on the <code class="literal">MessageHandlerChain</code> is set, the last handler needs only an output channel.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>As with other endpoints, the <code class="literal">output-channel</code> is optional.
If there is a reply message at the end of the chain, the output-channel takes precedence.
However, if it is not available, the chain handler checks for a reply channel header on the inbound message as a fallback.</p>
</td></tr></table></div>
<p>In most cases, you need not implement <code class="literal">MessageHandler</code> yourself.
The next section focuses on namespace support for the chain element.
Most Spring Integration endpoints, such as service activators and transformers, are suitable for use within a <code class="literal">MessageHandlerChain</code>.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="chain-namespace" href="#chain-namespace"></a>8.6.1&nbsp;Configuring a Chain</h3></div></div></div>

<p>The <code class="literal">&lt;chain&gt;</code> element provides an <code class="literal">input-channel</code> attribute.
If the last element in the chain is capable of producing reply messages (optional), it also supports an <code class="literal">output-channel</code> attribute.
The sub-elements are then filters, transformers, splitters, and service-activators.
The last element may also be a router or an outbound channel adapter.
The following example shows a chain definition:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:chain</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:filter</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"someSelector"</span> <span class="hl-attribute">throw-exception-on-rejection</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int:header-enricher&gt;</span>
        <span class="hl-tag">&lt;int:header</span> <span class="hl-attribute">name</span>=<span class="hl-value">"thing1"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"thing2"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/int:header-enricher&gt;</span>
    <span class="hl-tag">&lt;int:service-activator</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"someService"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"someMethod"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:chain&gt;</span></pre>
</div>
<p>The <code class="literal">&lt;header-enricher&gt;</code> element used in the preceding example sets a message header named <code class="literal">thing1</code> with a value of <code class="literal">thing2</code> on the message.
A header enricher is a specialization of <code class="literal">Transformer</code> that touches only header values.
You could obtain the same result by implementing a <code class="literal">MessageHandler</code> that did the header modifications and wiring that as a bean, but the header-enricher is a simpler option.</p>
<p>The <code class="literal">&lt;chain&gt;</code> can be configured as the last <span class="emphasis"><em>black-box</em></span> consumer of the message flow.
For this solution, you can to put it at the end of the &lt;chain&gt; some &lt;outbound-channel-adapter&gt;, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:chain</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int-xml:marshalling-transformer</span> <span class="hl-attribute">marshaller</span>=<span class="hl-value">"marshaller"</span> <span class="hl-attribute">result-type</span>=<span class="hl-value">"StringResult"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;int:service-activator</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"someService"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"someMethod"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int:header-enricher&gt;</span>
        <span class="hl-tag">&lt;int:header</span> <span class="hl-attribute">name</span>=<span class="hl-value">"thing1"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"thing2"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/int:header-enricher&gt;</span>
    <span class="hl-tag">&lt;int:logging-channel-adapter</span> <span class="hl-attribute">level</span>=<span class="hl-value">"INFO"</span> <span class="hl-attribute">log-full-message</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:chain&gt;</span></pre>
</div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important: Disallowed Attributes and Elements"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Disallowed Attributes and Elements</th></tr><tr><td align="left" valign="top">

<p>Certain attributes, such as <code class="literal">order</code> and <code class="literal">input-channel</code> are not allowed to be specified on components used within a chain.
The same is true for the poller sub-element.</p>
<p>For the Spring Integration core components, the XML schema itself enforces some of these constraints.
However, for non-core components or your own custom components, these constraints are enforced by the XML namespace parser, not by the XML schema.</p>
<p>These XML namespace parser constraints were added with Spring Integration 2.2.
If you try to use disallowed attributes and elements, the XML namespace parser throws a <code class="literal">BeanDefinitionParsingException</code>.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_using_the_emphasis_id_emphasis_attribute" href="#_using_the_emphasis_id_emphasis_attribute"></a>8.6.2&nbsp;Using the <span class="emphasis"><em>id</em></span> Attribute</h3></div></div></div>

<p>Beginning with Spring Integration 3.0, if a chain element is given an <code class="literal">id</code> attribute, the bean name for the element is a combination of the chain&#8217;s <code class="literal">id</code> and the <code class="literal">id</code> of the element itself.
Elements without <code class="literal">id</code> attributes are not registered as beans, but each one is given a <code class="literal">componentName</code> that includes the chain <code class="literal">id</code>.
Consider the following example:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:chain</span> <span class="hl-attribute">id</span>=<span class="hl-value">"somethingChain"</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:service-activator</span> <span class="hl-attribute">id</span>=<span class="hl-value">"somethingService"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"someService"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"someMethod"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int:object-to-json-transformer/&gt;</span>
<span class="hl-tag">&lt;/int:chain&gt;</span></pre>
</div>
<p>In the preceding example:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
The <code class="literal">&lt;chain&gt;</code> root element has an <code class="literal">id</code> of <span class="emphasis"><em>somethingChain</em></span>.
Consequently, the <code class="literal">AbstractEndpoint</code> implementation (<code class="literal">PollingConsumer</code> or <code class="literal">EventDrivenConsumer</code>, depending on the <code class="literal">input-channel</code> type) bean takes this value as its bean name.
</li><li class="listitem">
The <code class="literal">MessageHandlerChain</code> bean acquires a bean alias (<span class="emphasis"><em>somethingChain.handler</em></span>), which allows direct access to this bean from the <code class="literal">BeanFactory</code>.
</li><li class="listitem">
The <code class="literal">&lt;service-activator&gt;</code> is not a fully fledged messaging endpoint (it is not a <code class="literal">PollingConsumer</code> or <code class="literal">EventDrivenConsumer</code>).
It is a <code class="literal">MessageHandler</code> within the <code class="literal">&lt;chain&gt;</code>.
In this case, the bean name registered with the <code class="literal">BeanFactory</code> is <span class="emphasis"><em>somethingChain$child.somethingService.handler</em></span>.
</li><li class="listitem">
The <code class="literal">componentName</code> of this <code class="literal">ServiceActivatingHandler</code> takes the same value but without the <span class="emphasis"><em>.handler</em></span> suffix.
It becomes <span class="emphasis"><em>somethingChain$child.somethingService</em></span>.
</li><li class="listitem">
The last <code class="literal">&lt;chain&gt;</code> sub-component, <code class="literal">&lt;object-to-json-transformer&gt;</code>, does not have an <code class="literal">id</code> attribute.
Its <code class="literal">componentName</code> is based on its position in the <code class="literal">&lt;chain&gt;</code>.
In this case, it is <span class="emphasis"><em>somethingChain$child#1</em></span>.
(The final element of the name is the order within the chain, beginning with <span class="emphasis"><em>#0</em></span>).
Note, this transformer is not registered as a bean within the application context, so it does not get a <code class="literal">beanName</code>.
However its <code class="literal">componentName</code> has a value that is useful for logging and other purposes.
</li></ul></div>
<p>The <code class="literal">id</code> attribute for <code class="literal">&lt;chain&gt;</code> elements lets them be eligible for <a class="link" href="#jmx-mbean-exporter" title="12.2.7&nbsp;MBean Exporter">JMX export</a>, and they are trackable in the <a class="link" href="#message-history" title="12.3&nbsp;Message History">message history</a>.
You can access them from the <code class="literal">BeanFactory</code> by using the appropriate bean name, as discussed earlier.</p>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>It is useful to provide an explicit <code class="literal">id</code> attribute on <code class="literal">&lt;chain&gt;</code> elements to simplify the identification of sub-components in logs and to provide access to them from the <code class="literal">BeanFactory</code> etc.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_calling_a_chain_from_within_a_chain" href="#_calling_a_chain_from_within_a_chain"></a>8.6.3&nbsp;Calling a Chain from within a Chain</h3></div></div></div>

<p>Sometimes, you need to make a nested call to another chain from within a chain and then come back and continue execution within the original chain.
To accomplish this, you can use a messaging gateway by including a &lt;gateway&gt; element, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:chain&nbsp;id="main-chain"&nbsp;input-channel="in"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"out"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:header-enricher&gt;</span>
      <span class="hl-tag">&lt;int:header</span> <span class="hl-attribute">name</span>=<span class="hl-value">"name"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"Many"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;/int:header-enricher&gt;</span>
    <span class="hl-tag">&lt;int:service-activator&gt;</span>
      <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.foo.SampleService"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;/int:service-activator&gt;</span>
    <span class="hl-tag">&lt;int:gateway</span> <span class="hl-attribute">request-channel</span>=<span class="hl-value">"inputA"</span><span class="hl-tag">/&gt;</span> &nbsp;
<span class="hl-tag">&lt;/int:chain&gt;</span>

<span class="hl-tag">&lt;int:chain&nbsp;id="nested-chain-a"&nbsp;input-channel="inputA"&gt;</span>
    <span class="hl-tag">&lt;int:header-enricher&gt;</span>
        <span class="hl-tag">&lt;int:header</span> <span class="hl-attribute">name</span>=<span class="hl-value">"name"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"Moe"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;/int:header-enricher&gt;</span>
    <span class="hl-tag">&lt;int:gateway</span> <span class="hl-attribute">request-channel</span>=<span class="hl-value">"inputB"</span><span class="hl-tag">/&gt;</span>&nbsp;
    <span class="hl-tag">&lt;int:service-activator&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.foo.SampleService"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;/int:service-activator&gt;</span>
<span class="hl-tag">&lt;/int:chain&gt;</span>

<span class="hl-tag">&lt;int:chain&nbsp;id="nested-chain-b"&nbsp;input-channel="inputB"&gt;</span>
    <span class="hl-tag">&lt;int:header-enricher&gt;</span>
        <span class="hl-tag">&lt;int:header</span> <span class="hl-attribute">name</span>=<span class="hl-value">"name"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"Jack"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;/int:header-enricher&gt;</span>
    <span class="hl-tag">&lt;int:service-activator&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.foo.SampleService"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;/int:service-activator&gt;</span>
<span class="hl-tag">&lt;/int:chain&gt;</span></pre>
</div>
<p>In the preceding example, <code class="literal">nested-chain-a</code> is called at the end of <code class="literal">main-chain</code> processing by the <span class="emphasis"><em>gateway</em></span> element configured there.
While in <code class="literal">nested-chain-a</code>, a call to a <code class="literal">nested-chain-b</code> is made after header enrichment.
Then the flow comes back to finish execution in <code class="literal">nested-chain-b</code>.
Finally, the flow returns to <code class="literal">main-chain</code>.
When the nested version of a <code class="literal">&lt;gateway&gt;</code> element is defined in the chain, it does not require the <code class="literal">service-interface</code> attribute.
Instead, it takes the message in its current state and places it on the channel defined in the <code class="literal">request-channel</code> attribute.
When the downstream flow initiated by that gateway completes, a <code class="literal">Message</code> is returned to the gateway and continues its journey within the current chain.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="scatter-gather" href="#scatter-gather"></a>8.7&nbsp;Scatter-Gather</h2></div></div></div>

<p>Starting with version 4.1, Spring Integration provides an implementation of the <a class="ulink" href="http://www.eaipatterns.com/BroadcastAggregate.html" target="_top">scatter-gather</a> enterprise integration pattern.
It is a compound endpoint for which the goal is to send a message to the recipients and aggregate the results.
As noted in <a class="ulink" href="http://www.eaipatterns.com" target="_top"><span class="emphasis"><em>Enterprise Integration Patterns</em></span></a>, it is a component for scenarios such as "<code class="literal">best quote</code>", where we need to request information from several suppliers and decide which one provides us with the best term for the requested item.</p>
<p>Previously, the pattern could be configured by using discrete components.
This enhancement brings more convenient configuration.</p>
<p>The <code class="literal">ScatterGatherHandler</code> is a request-reply endpoint that combines a <code class="literal">PublishSubscribeChannel</code> (or a <code class="literal">RecipientListRouter</code>) and an <code class="literal">AggregatingMessageHandler</code>.
The request message is sent to the <code class="literal">scatter</code> channel, and the <code class="literal">ScatterGatherHandler</code> waits for the reply that the aggregator sends to the <code class="literal">outputChannel</code>.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="scatter-gather-functionality" href="#scatter-gather-functionality"></a>8.7.1&nbsp;Functionality</h3></div></div></div>

<p>The <code class="literal">Scatter-Gather</code> pattern suggests two scenarios: "<code class="literal">auction</code>" and "<code class="literal">distribution</code>".
In both cases, the <code class="literal">aggregation</code> function is the same and provides all the options available for the <code class="literal">AggregatingMessageHandler</code>.
(Actually, the <code class="literal">ScatterGatherHandler</code> requires only an <code class="literal">AggregatingMessageHandler</code> as a constructor argument.)
See <a class="xref" href="#aggregator" title="8.4&nbsp;Aggregator">Section&nbsp;8.4, &#8220;Aggregator&#8221;</a> for more information.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_auction" href="#_auction"></a>Auction</h4></div></div></div>

<p>The auction <code class="literal">Scatter-Gather</code> variant uses "<code class="literal">publish-subscribe</code>" logic for the request message, where the "<code class="literal">scatter</code>" channel is a <code class="literal">PublishSubscribeChannel</code> with <code class="literal">apply-sequence="true"</code>.
However, this channel can be any <code class="literal">MessageChannel</code> implementation (as is the case with the <code class="literal">request-channel</code> in the <code class="literal">ContentEnricher</code>&#8201;&#8212;&#8201;see <a class="xref" href="#content-enricher" title="9.2&nbsp;Content Enricher">Section&nbsp;9.2, &#8220;Content Enricher&#8221;</a>).
However, in this case, you should create your own custom <code class="literal">correlationStrategy</code> for the <code class="literal">aggregation</code> function.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_distribution" href="#_distribution"></a>Distribution</h4></div></div></div>

<p>The distribution <code class="literal">Scatter-Gather</code> variant is based on the <code class="literal">RecipientListRouter</code> (see <a class="xref" href="#router-implementations-recipientlistrouter" title="RecipientListRouter">the section called &#8220;<code class="literal">RecipientListRouter</code>&#8221;</a>) with all available options for the <code class="literal">RecipientListRouter</code>.
This is the second <code class="literal">ScatterGatherHandler</code> constructor argument.
If you want to rely on only the default <code class="literal">correlationStrategy</code> for the <code class="literal">recipient-list-router</code> and the <code class="literal">aggregator</code>, you should specify <code class="literal">apply-sequence="true"</code>.
Otherwise, you should supply a custom <code class="literal">correlationStrategy</code> for the <code class="literal">aggregator</code>.
Unlike the <code class="literal">PublishSubscribeChannel</code> variant (the auction variant), having a <code class="literal">recipient-list-router</code> <code class="literal">selector</code> option lets filter target suppliers based on the message.
With <code class="literal">apply-sequence="true"</code>, the default <code class="literal">sequenceSize</code> is supplied, and the <code class="literal">aggregator</code> can release the group correctly.
The distribution option is mutually exclusive with the auction option.</p>
<p>For both the auction and the distribution variants, the request (scatter) message is enriched with the <code class="literal">gatherResultChannel</code> header to wait for a reply message from the <code class="literal">aggregator</code>.</p>
<p>By default, all suppliers should send their result to the <code class="literal">replyChannel</code> header (usually by omitting the <code class="literal">output-channel</code> from the ultimate endpoint).
However, the <code class="literal">gatherChannel</code> option is also provided, letting suppliers send their reply to that channel for the aggregation.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="scatter-gather-namespace" href="#scatter-gather-namespace"></a>8.7.2&nbsp;Configuring a Scatter-Gather Endpoint</h3></div></div></div>

<p>The following example shows Java configuration for the bean definition for <code class="literal">Scatter-Gather</code>:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> MessageHandler distributor() {
    RecipientListRouter router = <span class="hl-keyword">new</span> RecipientListRouter();
    router.setApplySequence(true);
    router.setChannels(Arrays.asList(distributionChannel1(), distributionChannel2(),
            distributionChannel3()));
    <span class="hl-keyword">return</span> router;
}

<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> MessageHandler gatherer() {
	<span class="hl-keyword">return</span> <span class="hl-keyword">new</span> AggregatingMessageHandler(
			<span class="hl-keyword">new</span> ExpressionEvaluatingMessageGroupProcessor(<span class="hl-string">"^[payload gt 5] ?: -1D"</span>),
			<span class="hl-keyword">new</span> SimpleMessageStore(),
			<span class="hl-keyword">new</span> HeaderAttributeCorrelationStrategy(
			       IntegrationMessageHeaderAccessor.CORRELATION_ID),
			<span class="hl-keyword">new</span> ExpressionEvaluatingReleaseStrategy(<span class="hl-string">"size() == 2"</span>));
}

<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "distributionChannel")</span></em>
<span class="hl-keyword">public</span> MessageHandler scatterGatherDistribution() {
	ScatterGatherHandler handler = <span class="hl-keyword">new</span> ScatterGatherHandler(distributor(), gatherer());
	handler.setOutputChannel(output());
	<span class="hl-keyword">return</span> handler;
}</pre>
</div>
<p>In the preceding example, we configure the <code class="literal">RecipientListRouter</code> <code class="literal">distributor</code> bean with <code class="literal">applySequence="true"</code> and the list of recipient channels.
The next bean is for an <code class="literal">AggregatingMessageHandler</code>.
Finally, we inject both those beans into the <code class="literal">ScatterGatherHandler</code> bean definition and mark it as a <code class="literal">@ServiceActivator</code> to wire the scatter-gather component into the integration flow.</p>
<p>The following example shows how to configure the <code class="literal">&lt;scatter-gather&gt;</code> endpoint by using the XML namespace:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;scatter-gather</span>
		<span class="hl-attribute">id</span>=<span class="hl-value">""</span>  <a name="CO8-1" href="#CO8-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
		auto-startup=""  <a name="CO8-2" href="#CO8-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
		input-channel=""  <a name="CO8-3" href="#CO8-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
		output-channel=""  <a name="CO8-4" href="#CO8-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
		scatter-channel=""  <a name="CO8-5" href="#CO8-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
		gather-channel=""  <a name="CO8-6" href="#CO8-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>
		order=""  <a name="CO8-7" href="#CO8-7"></a><span><img src="images/callouts/7.png" alt="7" border="0"></span>
		phase=""  <a name="CO8-8" href="#CO8-8"></a><span><img src="images/callouts/8.png" alt="8" border="0"></span>
		send-timeout=""  <a name="CO8-9" href="#CO8-9"></a><span><img src="images/callouts/9.png" alt="9" border="0"></span>
		gather-timeout=""  <a name="CO8-10" href="#CO8-10"></a><span><img src="images/callouts/10.png" alt="10" border="0"></span>
		requires-reply="" &gt; <a name="CO8-11" href="#CO8-11"></a><span><img src="images/callouts/11.png" alt="11" border="0"></span>
			<span class="hl-tag">&lt;scatterer/&gt;</span>  <a name="CO8-12" href="#CO8-12"></a><span><img src="images/callouts/12.png" alt="12" border="0"></span>
			<span class="hl-tag">&lt;gatherer/&gt;</span>  <a name="CO8-13" href="#CO8-13"></a><span><img src="images/callouts/13.png" alt="13" border="0"></span>
<span class="hl-tag">&lt;/scatter-gather&gt;</span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO8-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The id of the endpoint.
The <code class="literal">ScatterGatherHandler</code> bean is registered with an alias of <code class="literal">id + '.handler'</code>.
The <code class="literal">RecipientListRouter</code> bean is registered with an alias of <code class="literal">id + '.scatterer'</code>.
The <code class="literal">AggregatingMessageHandler`bean is registered with an alias of `id + '.gatherer'</code>.
Optional.
(The <code class="literal">BeanFactory</code> generates a default <code class="literal">id</code> value.)</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO8-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Lifecycle attribute signaling whether the endpoint should be started during application context initialization.
In addition, the <code class="literal">ScatterGatherHandler</code> also implements <code class="literal">Lifecycle</code> and starts and stops <code class="literal">gatherEndpoint</code>, which is created internally if a <code class="literal">gather-channel</code> is provided.
Optional.
(The default is <code class="literal">true</code>.)</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO8-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The channel on which to receive request messages to handle them in the <code class="literal">ScatterGatherHandler</code>.
Required.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO8-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The channel to which the <code class="literal">ScatterGatherHandler</code> sends the aggregation results.
Optional.
(Incoming messages can specify a reply channel themselves in the <code class="literal">replyChannel</code> message header).</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO8-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The channel to which to send the scatter message for the auction scenario.
Optional.
Mutually exclusive with the <code class="literal">&lt;scatterer&gt;</code> sub-element.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO8-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The channel on which to receive replies from each supplier for the aggregation.
It is used as the <code class="literal">replyChannel</code> header in the scatter message.
Optional.
By default, the <code class="literal">FixedSubscriberChannel</code> is created.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO8-7"><span><img src="images/callouts/7.png" alt="7" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The order of this component when more than one handler is subscribed to the same <code class="literal">DirectChannel</code> (use for load balancing purposes).
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO8-8"><span><img src="images/callouts/8.png" alt="8" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Specifies the phase in which the endpoint should be started and stopped.
The startup order proceeds from lowest to highest, and the shutdown order is from highest to lowest.
By default, this value is <code class="literal">Integer.MAX_VALUE</code>, meaning that this container starts as late as possible and stops as soon as possible.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO8-9"><span><img src="images/callouts/9.png" alt="9" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The timeout interval to wait when sending a reply <code class="literal">Message</code> to the <code class="literal">output-channel</code>.
By default, the send blocks for one second.
It applies only if the output channel has some <span class="emphasis"><em>sending</em></span> limitations&#8201;&#8212;&#8201;for example, a <code class="literal">QueueChannel</code> with a fixed <span class="emphasis"><em>capacity</em></span> that is full.
In this case, a <code class="literal">MessageDeliveryException</code> is thrown.
The <code class="literal">send-timeout</code> is ignored for <code class="literal">AbstractSubscribableChannel</code> implementations.
For <code class="literal">group-timeout(-expression)</code>, the <code class="literal">MessageDeliveryException</code> from the scheduled expire task leads this task to be rescheduled.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO8-10"><span><img src="images/callouts/10.png" alt="10" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Lets you specify how long the scatter-gather waits for the reply message before returning.
By default, it waits indefinitely.
<span class="emphasis"><em>null</em></span> is returned if the reply times out.
Optional.
It defaults to <code class="literal">-1</code>, meaning to wait indefinitely.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO8-11"><span><img src="images/callouts/11.png" alt="11" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Specifies whether the scatter-gather must return a non-null value.
This value is <code class="literal">true</code> by default.
Consequently, a <code class="literal">ReplyRequiredException</code> is thrown when the underlying aggregator returns a null value after <code class="literal">gather-timeout</code>.
Note, if <code class="literal">null</code> is a possibility, the <code class="literal">gather-timeout</code> should be specified to avoid an indefinite wait.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO8-12"><span><img src="images/callouts/12.png" alt="12" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The <code class="literal">&lt;recipient-list-router&gt;</code> options.
Optional.
Mutually exclusive with <code class="literal">scatter-channel</code> attribute.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO8-13"><span><img src="images/callouts/13.png" alt="13" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The <code class="literal">&lt;aggregator&gt;</code> options.
Required.</p>
</td></tr></table></div>
</div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="barrier" href="#barrier"></a>8.8&nbsp;Thread Barrier</h2></div></div></div>

<p>Sometimes, we need to suspend a message flow thread until some other asynchronous event occurs.
For example, consider an HTTP request that publishes a message to RabbitMQ.
We might wish to not reply to the user until the RabbitMQ broker has issued an acknowledgment that the message was
received.</p>
<p>In version 4.2, Spring Integration introduced the <code class="literal">&lt;barrier/&gt;</code> component for this purpose.
The underlying <code class="literal">MessageHandler</code> is the <code class="literal">BarrierMessageHandler</code>.
This class also implements
<code class="literal">MessageTriggerAction</code>, in which a message passed to the <code class="literal">trigger()</code> method releases a corresponding thread in the
<code class="literal">handleRequestMessage()</code> method (if present).</p>
<p>The suspended thread and trigger thread are correlated by invoking a <code class="literal">CorrelationStrategy</code> on the messages.
When a message is sent to the <code class="literal">input-channel</code>, the thread is suspended for up to <code class="literal">timeout</code> milliseconds, waiting for
a corresponding trigger message.
The default correlation strategy uses the <code class="literal">IntegrationMessageHeaderAccessor.CORRELATION_ID</code> header.
When a trigger message arrives with the same correlation, the thread is released.
The message sent to the <code class="literal">output-channel</code> after release is constructed by using a <code class="literal">MessageGroupProcessor</code>.
By default, the message is a <code class="literal">Collection&lt;?&gt;</code> of the two payloads, and the headers are merged by using a
<code class="literal">DefaultAggregatingMessageGroupProcessor</code>.</p>
<div class="caution" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Caution"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Caution]" src="images/caution.png"></td><th align="left">Caution</th></tr><tr><td align="left" valign="top">
<p>If the <code class="literal">trigger()</code> method is invoked first (or after the main thread times out), it is suspended for up to <code class="literal">timeout</code> waiting for the suspending message to arrive.
If you do not want to suspend the trigger thread, consider handing off to a <code class="literal">TaskExecutor</code> instead so that its thread is suspended instead.</p>
</td></tr></table></div>
<p>The <code class="literal">requires-reply</code> property determines the action to take if the suspended thread times out before the trigger message arrives.
By default, it is <code class="literal">false</code>, which means the endpoint returns <code class="literal">null</code>, the flow ends, and the thread returns to the
caller.
When <code class="literal">true</code>, a <code class="literal">ReplyRequiredException</code> is thrown.</p>
<p>You can call the <code class="literal">trigger()</code> method programmatically (obtain the bean reference by using the name, <code class="literal">barrier.handler</code>&#8201;&#8212;&#8201;where <code class="literal">barrier</code> is the bean name of the barrier endpoint).
Alternatively, you can configure an <code class="literal">&lt;outbound-channel-adapter/&gt;</code> to trigger the release.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Only one thread can be suspended with the same correlation.
The same correlation can be used multiple times but only once concurrently.
An exception is thrown if a second thread arrives with the same correlation.</p>
</td></tr></table></div>
<p>The following example shows how to use a custom header for correlation:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:barrier</span> <span class="hl-attribute">id</span>=<span class="hl-value">"barrier1"</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"in"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"out"</span>
        <span class="hl-attribute">correlation-strategy-expression</span>=<span class="hl-value">"headers['myHeader']"</span>
        <span class="hl-attribute">output-processor</span>=<span class="hl-value">"myOutputProcessor"</span>
        <span class="hl-attribute">discard-channel</span>=<span class="hl-value">"lateTriggerChannel"</span>
        <span class="hl-attribute">timeout</span>=<span class="hl-value">"10000"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;/int:barrier&gt;</span>

<span class="hl-tag">&lt;int:outbound-channel-adapter</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"release"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"barrier1.handler"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"trigger"</span><span class="hl-tag"> /&gt;</span></pre>
<p>Depending on which one has a message arrive first, either the thread sending a message to <code class="literal">in</code> or the thread sending a message to <code class="literal">release</code> waits for up to ten seconds until the other message arrives.
When the message is released, the <code class="literal">out</code> channel is sent a message that combines the result of invoking the custom <code class="literal">MessageGroupProcessor</code> bean, named <code class="literal">myOutputProcessor</code>.
If the main thread times out and a trigger arrives later, you can configure a discard channel to which the late trigger is sent.
The following example shows the Java configuration to do so:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Configuration</span></em>
<em><span class="hl-annotation" style="color: gray">@EnableIntegration</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> Config {

    <em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel="in")</span></em>
    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> BarrierMessageHandler barrier() {
        BarrierMessageHandler barrier = <span class="hl-keyword">new</span> BarrierMessageHandler(<span class="hl-number">10000</span>);
        barrier.setOutputChannel(out());
        barrier.setDiscardChannel(lateTriggers());
        <span class="hl-keyword">return</span> barrier;
    }

    <em><span class="hl-annotation" style="color: gray">@ServiceActivator</span></em> (inputChannel=<span class="hl-string">"release"</span>)
    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> MessageHandler releaser() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> MessageHandler() {

            <em><span class="hl-annotation" style="color: gray">@Override</span></em>
            <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> handleMessage(Message&lt;?&gt; message) <span class="hl-keyword">throws</span> MessagingException {
                barrier().trigger(message);
            }

        };
    }

}</pre>
<p>For an example of this component, see the <a class="ulink" href="https://github.com/spring-projects/spring-integration-samples/tree/master/basic/barrier" target="_top">barrier sample application</a>.</p>
</div>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="messaging-transformation-chapter" href="#messaging-transformation-chapter"></a>9.&nbsp;Message Transformation</h2></div></div></div>

<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="transformer" href="#transformer"></a>9.1&nbsp;Transformer</h2></div></div></div>

<p>Message transformers play a very important role in enabling the loose-coupling of message producers and message consumers.
Rather than requiring every message-producing component to know what type is expected by the next consumer, you can add transformers between those components.
Generic transformers, such as one that converts a <code class="literal">String</code> to an XML Document, are also highly reusable.</p>
<p>For some systems, it may be best to provide a <a class="ulink" href="http://www.eaipatterns.com/CanonicalDataModel.html" target="_top">canonical data model</a>, but Spring Integration&#8217;s general philosophy is not to require any particular format.
Rather, for maximum flexibility, Spring Integration aims to provide the simplest possible model for extension.
As with the other endpoint types, the use of declarative configuration in XML or Java annotations enables simple POJOs to be adapted for the role of message transformers.
The rest of this chapter describes these configuration options.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>For the sake of maximizing flexibility, Spring does not require XML-based message payloads.
Nevertheless, the framework does provide some convenient transformers for dealing with XML-based payloads if that is indeed the right choice for your application.
For more information on those transformers, see <a class="xref" href="#xml" title="38.&nbsp;XML Support - Dealing with XML Payloads">Chapter&nbsp;38, <i>XML Support - Dealing with XML Payloads</i></a>.</p>
</td></tr></table></div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="transformer-namespace" href="#transformer-namespace"></a>9.1.1&nbsp;Configuring a Transformer with XML</h3></div></div></div>

<p>The <code class="literal">&lt;transformer&gt;</code> element is used to create a message-transforming endpoint.
In addition to <code class="literal">input-channel</code> and <code class="literal">output-channel</code> attributes, it requires a ` attribute`.
The <code class="literal">ref</code> may either point to an object that contains the <code class="literal">@Transformer</code> annotation on a single method (see <a class="xref" href="#transformer-annotation" title="9.1.4&nbsp;Configuring a Transformer with Annotations">Section&nbsp;9.1.4, &#8220;Configuring a Transformer with Annotations&#8221;</a>), or it may be combined with an explicit method name value provided in the <code class="literal">method</code> attribute.</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:transformer</span> <span class="hl-attribute">id</span>=<span class="hl-value">"testTransformer"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"testTransformerBean"</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"inChannel"</span>
             <span class="hl-attribute">method</span>=<span class="hl-value">"transform"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"outChannel"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;beans:bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"testTransformerBean"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.foo.TestTransformer"</span><span class="hl-tag"> /&gt;</span></pre>
</div>
<p>Using a <code class="literal">ref</code> attribute is generally recommended if the custom transformer handler implementation can be reused in other <code class="literal">&lt;transformer&gt;</code> definitions.
However, if the custom transformer handler implementation should be scoped to a single definition of the <code class="literal">&lt;transformer&gt;</code>, you can define an inner bean definition, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:transformer</span> <span class="hl-attribute">id</span>=<span class="hl-value">"testTransformer"</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"inChannel"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"transform"</span>
                <span class="hl-attribute">output-channel</span>=<span class="hl-value">"outChannel"</span><span class="hl-tag">&gt;</span>
  <span class="hl-tag">&lt;beans:bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.foo.TestTransformer"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/transformer&gt;</span></pre>
</div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Using both the <code class="literal">ref</code> attribute and an inner handler definition in the same <code class="literal">&lt;transformer&gt;</code> configuration is not allowed, as it creates an ambiguous condition and results in an exception being thrown.</p>
</td></tr></table></div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>If the <code class="literal">ref</code> attribute references a bean that extends <code class="literal">AbstractMessageProducingHandler</code> (such as transformers provided by the framework itself), the configuration is optimized by injecting the output channel into the handler directly.
In this case, each <code class="literal">ref</code> must be to a separate bean instance (or a <code class="literal">prototype</code>-scoped bean) or use the inner <code class="literal">&lt;bean/&gt;</code> configuration type.
If you inadvertently reference the same message handler from multiple beans, you get a configuration exception.</p>
</td></tr></table></div>
<p>When using a POJO, the method that is used for transformation may expect either the <code class="literal">Message</code> type or the payload type of inbound messages.
It may also accept message header values either individually or as a full map by using the <code class="literal">@Header</code> and <code class="literal">@Headers</code> parameter annotations, respectively.
The return value of the method can be any type.
If the return value is itself a <code class="literal">Message</code>, that is passed along to the transformer&#8217;s output channel.</p>
<p>As of Spring Integration 2.0, a message transformer&#8217;s transformation method can no longer return <code class="literal">null</code>.
Returning <code class="literal">null</code> results in an exception, because a message transformer should always be expected to transform each source message into a valid target message.
In other words, a message transformer should not be used as a message filter, because there is a dedicated <code class="literal">&lt;filter&gt;</code> option for that.
However, if you do need this type of behavior (where a component might return <code class="literal">null</code> and that should not be considered an error), you could use a service activator.
Its <code class="literal">requires-reply</code> value is <code class="literal">false</code> by default, but that can be set to <code class="literal">true</code> in order to have exceptions thrown for <code class="literal">null</code> return values, as with the transformer.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_transformers_and_spring_expression_language_spel" href="#_transformers_and_spring_expression_language_spel"></a>9.1.2&nbsp;Transformers and Spring Expression Language (SpEL)</h3></div></div></div>

<p>Like routers, aggregators, and other components, as of Spring Integration 2.0, transformers can also benefit from <a class="ulink" href="http://docs.spring.io/spring/docs/current/spring-framework-reference/html/expressions.html" target="_top">SpEL support</a> whenever transformation logic is relatively simple. The following example shows how to use a SpEL expression:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:transformer</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"inChannel"</span>
	<span class="hl-attribute">output-channel</span>=<span class="hl-value">"outChannel"</span>
	<span class="hl-attribute">expression</span>=<span class="hl-value">"payload.toUpperCase() + '- [' + T(java.lang.System).currentTimeMillis() + ']'"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>The preceding example transforms the payload without writing a custom transformer.
Our payload (assumed to be a <code class="literal">String</code>) is upper-cased, concatenated with the current timestamp, and has some formatting applied.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_common_transformers" href="#_common_transformers"></a>9.1.3&nbsp;Common Transformers</h3></div></div></div>

<p>Spring Integration provides a few transformer implementations.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_object_to_string_transformer" href="#_object_to_string_transformer"></a>Object-to-String Transformer</h4></div></div></div>

<p>Because it is fairly common to use the <code class="literal">toString()</code> representation of an <code class="literal">Object</code>, Spring Integration provides an <code class="literal">ObjectToStringTransformer</code> whose output is a <code class="literal">Message</code> with a String <code class="literal">payload</code>.
That <code class="literal">String</code> is the result of invoking the <code class="literal">toString()</code> operation on the inbound Message&#8217;s payload.
The following example shows how to declare an instance of the object-to-string transformer:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:object-to-string-transformer</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"in"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"out"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>A potential use for this transformer would be sending some arbitrary object to the <span class="emphasis"><em>outbound-channel-adapter</em></span> in the <code class="literal">file</code> namespace.
Whereas that channel adapter only supports <code class="literal">String</code>, byte-array, or <code class="literal">java.io.File</code> payloads by default, adding this transformer immediately before the adapter handles the necessary conversion.
That works fine as long as the result of the <code class="literal">toString()</code> call is what you want to be written to the file.
Otherwise, you can provide a custom POJO-based transformer by using the generic <span class="emphasis"><em>transformer</em></span> element shown previously.</p>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>When debugging, this transformer is not typically necessary, since the <span class="emphasis"><em>logging-channel-adapter</em></span> is capable of logging the message payload.
See <a class="xref" href="#channel-wiretap" title="Wire Tap">the section called &#8220;Wire Tap&#8221;</a> for more detail.</p>
</td></tr></table></div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The object-to-string transformer is very simple.
It invokes <code class="literal">toString()</code> on the inbound payload.
Since Spring Integration 3.0, there are two exceptions to this rule:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
If the payload is a <code class="literal">char[]</code>, it invokes <code class="literal">new String(payload)</code>.
</li><li class="listitem">
If the payload is a <code class="literal">byte[]</code>, it invokes <code class="literal">new String(payload, charset)</code>, where <code class="literal">charset</code> is UTF-8 by default.
The <code class="literal">charset</code> can be modified by supplying the charset attribute on the transformer.
</li></ul></div>
<p>For more sophistication (such as selection of the charset dynamically, at runtime), you can use a SpEL expression-based transformer instead, as the following example shows:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:transformer</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"in"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"out"</span>
       <span class="hl-attribute">expression</span>=<span class="hl-value">"new java.lang.String(payload, headers['myCharset']"</span><span class="hl-tag"> /&gt;</span></pre>
</td></tr></table></div>
<p>If you need to serialize an <code class="literal">Object</code> to a byte array or deserialize a byte array back into an <code class="literal">Object</code>, Spring Integration provides symmetrical serialization transformers.
These use standard Java serialization by default, but you can provide an implementation of Spring 3.0&#8217;s serializer or seserializer strategies by using the <span class="emphasis"><em>serializer</em></span> and <span class="emphasis"><em>deserializer</em></span> attributes, respectively.
The following example shows to use Spring&#8217;s serializer and deserializer:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:payload-serializing-transformer</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"objectsIn"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"bytesOut"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int:payload-deserializing-transformer</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"bytesIn"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"objectsOut"</span>
    <span class="hl-attribute">white-list</span>=<span class="hl-value">"com.mycom.*,com.yourcom.*"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>When deserializing data from untrusted sources, you should consider adding a <code class="literal">white-list</code> of package and class patterns.
By default, all classes are deserialized.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_literal_object_literal_to_literal_map_literal_and_literal_map_literal_to_literal_object_literal_transformers" href="#_literal_object_literal_to_literal_map_literal_and_literal_map_literal_to_literal_object_literal_transformers"></a><code class="literal">Object</code>-to-<code class="literal">Map</code> and <code class="literal">Map</code>-to-<code class="literal">Object</code> Transformers</h4></div></div></div>

<p>Spring Integration also provides <code class="literal">Object</code>-to-<code class="literal">Map</code> and <code class="literal">Map</code>-to-<code class="literal">Object</code> transformers, which use the JSON to serialize and de-serialize the object graphs.
The object hierarchy is introspected to the most primitive types (<code class="literal">String</code>, <code class="literal">int</code>, and so on).
The path to this type is described with SpEL, which becomes the <code class="literal">key</code> in the transformed <code class="literal">Map</code>.
The primitive type becomes the value.</p>
<p>Consider the following example:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> Parent{
&nbsp;&nbsp; &nbsp;<span class="hl-keyword">private</span> Child child;
&nbsp;&nbsp; &nbsp;<span class="hl-keyword">private</span> String name;&nbsp;
&nbsp;&nbsp; &nbsp;<span class="hl-comment">// setters and getters are omitted</span>
}

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> Child{
&nbsp;&nbsp;&nbsp; <span class="hl-keyword">private</span> String name;&nbsp;
 &nbsp;&nbsp; <span class="hl-keyword">private</span> List&lt;String&gt; nickNames;
&nbsp; &nbsp; <span class="hl-comment">// setters and getters are omitted</span>
}</pre>
</div>
<p>The two classes in the preceding example are transformed to the following <code class="literal">Map</code>:</p>
<div class="informalexample">
<pre class="screen">{person.name=George, person.child.name=Jenna, person.child.nickNames[0]=Jen ...}</pre>
</div>
<p>The JSON-based <code class="literal">Map</code> lets you describe the object structure without sharing the actual types, which lets you restore and rebuild the object graph into a differently typed object graph, as long as you maintain the structure.</p>
<p>For example, the preceding structure could be restored back to the following object graph by using the <code class="literal">Map</code>-to-<code class="literal">Object</code> transformer:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> Father {
&nbsp;&nbsp; &nbsp;<span class="hl-keyword">private</span> Kid child;
&nbsp;&nbsp; &nbsp;<span class="hl-keyword">private</span> String name;&nbsp;
&nbsp;&nbsp; &nbsp;<span class="hl-comment">// setters and getters are omitted</span>
}

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> Kid {
&nbsp;&nbsp; &nbsp;<span class="hl-keyword">private</span> String name;&nbsp;
&nbsp;&nbsp;  <span class="hl-keyword">private</span> List&lt;String&gt; nickNames;
 &nbsp;&nbsp; <span class="hl-comment">// setters and getters are omitted</span>
}</pre>
</div>
<p>If you need to create a "<code class="literal">structured</code>" map, you can provide the <span class="emphasis"><em>flatten</em></span> attribute.
The default is <span class="emphasis"><em>true</em></span>.
If you set it to <span class="emphasis"><em>false</em></span>, the structure is a <code class="literal">Map</code> of <code class="literal">Map</code> objects.</p>
<p>Consider the following example:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> Parent {
	<span class="hl-keyword">private</span> Child child;
	<span class="hl-keyword">private</span> String name;
	<span class="hl-comment">// setters and getters are omitted</span>
}

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> Child {
	<span class="hl-keyword">private</span> String name;
	<span class="hl-keyword">private</span> List&lt;String&gt; nickNames;
	<span class="hl-comment">// setters and getters are omitted</span>
}</pre>
</div>
<p>The two classes in the preceding example are transformed to the following <code class="literal">Map</code>:</p>
<div class="informalexample">
<pre class="screen">{name=George, child={name=Jenna, nickNames=[Bimbo, ...]}}</pre>
</div>
<p>To configure these transformers, Spring Integration provides namespace support for Object-to-Map, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:object-to-map-transformer</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"directInput"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>You can also set the <code class="literal">flatten</code> attribute to false, as follows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:object-to-map-transformer</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"directInput"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span> <span class="hl-attribute">flatten</span>=<span class="hl-value">"false"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>Spring Integration provides namespace support for Map-to-Object, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:map-to-object-transformer</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span><span class="hl-attribute">&nbsp;</span>
  <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;output-channel</span>=<span class="hl-value">"output"</span><span class="hl-attribute">&nbsp;</span>
  <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">type</span>=<span class="hl-value">"org.something.Person"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>Alterately, you could use a <code class="literal">ref</code> attribute and a prototype-scoped bean, as the following example shows:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:map-to-object-transformer</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"inputA"</span><span class="hl-attribute">&nbsp;</span>
  <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"outputA"</span><span class="hl-attribute">&nbsp;</span>
  <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">&nbsp;</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"person"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"person"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.something.Person"</span> <span class="hl-attribute">scope</span>=<span class="hl-value">"prototype"</span><span class="hl-tag">/&gt;</span></pre>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The <span class="emphasis"><em>ref</em></span> and <span class="emphasis"><em>type</em></span> attributes are mutually exclusive.
Also, if you use the <span class="emphasis"><em>ref</em></span> attribute, you must point to a <span class="emphasis"><em>prototype</em></span> scoped bean.
Otherwise, a <code class="literal">BeanCreationException</code> is thrown.&nbsp;</p>
</td></tr></table></div>
<p>Starting with version 5.0, you can supply the <code class="literal">ObjectToMapTransformer</code> with a customized <code class="literal">JsonObjectMapper</code>&#8201;&#8212;&#8201;for when you need special formats for dates or nulls for empty collections (and other uses).
See <a class="xref" href="#json-transformers" title="JSON Transformers">the section called &#8220;JSON Transformers&#8221;</a> for more information about <code class="literal">JsonObjectMapper</code> implementations.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="stream-transformer" href="#stream-transformer"></a>Stream Transformer</h4></div></div></div>

<p>The <code class="literal">StreamTransformer</code> transforms <code class="literal">InputStream</code> payloads to a <code class="literal">byte[]</code>( or a <code class="literal">String</code> if a <code class="literal">charset</code> is provided).</p>
<p>The following example shows how to use the <code class="literal">stream-tansformer</code> element in XML:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:stream-transformer</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"directInput"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span><span class="hl-tag">/&gt;</span> <span class="hl-comment">&lt;!-- byte[] --&gt;</span>

<span class="hl-tag">&lt;int:stream-transformer</span> <span class="hl-attribute">id</span>=<span class="hl-value">"withCharset"</span> <span class="hl-attribute">charset</span>=<span class="hl-value">"UTF-8"</span>
    <span class="hl-attribute">input-channel</span>=<span class="hl-value">"charsetChannel"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span><span class="hl-tag">/&gt;</span> <span class="hl-comment">&lt;!-- String --&gt;</span></pre>
</div>
<p>The following example shows how to use the <code class="literal">StreamTransformer</code> class and the <code class="literal">@Transformer</code> annotation to configure a stream transformer in Java:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<em><span class="hl-annotation" style="color: gray">@Transformer(inputChannel = "stream", outputChannel = "data")</span></em>
<span class="hl-keyword">public</span> StreamTransformer streamToBytes() {
    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> StreamTransformer(); <span class="hl-comment">// transforms to byte[]</span>
}

<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<em><span class="hl-annotation" style="color: gray">@Transformer(inputChannel = "stream", outputChannel = "data")</span></em>
<span class="hl-keyword">public</span> StreamTransformer streamToString() {
    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> StreamTransformer(<span class="hl-string">"UTF-8"</span>); <span class="hl-comment">// transforms to String</span>
}</pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="json-transformers" href="#json-transformers"></a>JSON Transformers</h4></div></div></div>

<p>Spring Integration provides Object-to-JSON and JSON-to-Object transformers.
The following pair of examples show how to declare them in XML:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:object-to-json-transformer</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"objectMapperInput"</span><span class="hl-tag">/&gt;</span></pre>
<pre class="programlisting"><span class="hl-tag">&lt;int:json-to-object-transformer</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"objectMapperInput"</span>
    <span class="hl-attribute">type</span>=<span class="hl-value">"foo.MyDomainObject"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>By default, the transformers in the preceding listing use a vanilla <code class="literal">JsonObjectMapper</code>.
It is based on an implementation from the classpath.
You can provide your own custom <code class="literal">JsonObjectMapper</code> implementation with appropriate options or based on a required library (such as GSON), as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:json-to-object-transformer</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"objectMapperInput"</span>
    <span class="hl-attribute">type</span>=<span class="hl-value">"something.MyDomainObject"</span> <span class="hl-attribute">object-mapper</span>=<span class="hl-value">"customObjectMapper"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Beginning with version 3.0, the <code class="literal">object-mapper</code> attribute references an instance of a new strategy interface: <code class="literal">JsonObjectMapper</code>.
This abstraction lets multiple implementations of JSON mappers be used.
Implementations that wrap <a class="ulink" href="https://github.com/RichardHightower/boon" target="_top">Boon</a> and <a class="ulink" href="https://github.com/FasterXML" target="_top">Jackson 2</a> are provided, with the version being detected on the classpath.
These classes are <code class="literal">BoonJsonObjectMapper</code> and <code class="literal">Jackson2JsonObjectMapper</code>, respectively.</p>
<p>Note, <code class="literal">BoonJsonObjectMapper</code> was added in version 4.1.</p>
</td></tr></table></div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>If you have requirements to use both Jackson and Boon in the same application, keep in mind that, before version 3.0, the JSON transformers used only Jackson 1.x.
From 4.1 on, the framework selects Jackson 2 by default, preferring it to the Boon implementation if both are on the classpath.
Jackson 1.x is no longer supported by the framework internally. However, you can still use it within your code by including the necessary library.
To avoid unexpected issues with JSON mapping features when you use annotations, you may need to apply annotations from both Jackson and Boon on domain classes, as the following example shows:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@org.codehaus.jackson.annotate.JsonIgnoreProperties(ignoreUnknown=true)</span></em>
<em><span class="hl-annotation" style="color: gray">@com.fasterxml.jackson.annotation.JsonIgnoreProperties(ignoreUnknown=true)</span></em>
<em><span class="hl-annotation" style="color: gray">@org.boon.json.annotations.JsonIgnoreProperties("thing1")</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> Thing1 {

        <em><span class="hl-annotation" style="color: gray">@org.codehaus.jackson.annotate.JsonProperty("thing1Thing2")</span></em>
        <em><span class="hl-annotation" style="color: gray">@com.fasterxml.jackson.annotation.JsonProperty("thing1Thing2")</span></em>
        <em><span class="hl-annotation" style="color: gray">@org.boon.json.annotations.JsonProperty("thing1Thing2")</span></em>
        <span class="hl-keyword">public</span> Object thing2;

}</pre>
</td></tr></table></div>
<p>You may wish to consider using a <code class="literal">FactoryBean</code> or a factory method to create the <code class="literal">JsonObjectMapper</code> with the required characteristics.
The following example shows how to use such a factory:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ObjectMapperFactory {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> Jackson2JsonObjectMapper getMapper() {
        ObjectMapper mapper = <span class="hl-keyword">new</span> ObjectMapper();
        mapper.configure(JsonParser.Feature.ALLOW_COMMENTS, true);
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> Jackson2JsonObjectMapper(mapper);
    }
}</pre>
</div>
<p>The following example shows how to do the same thing in XML</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"customObjectMapper"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"something.ObjectMapperFactory"</span>
            <span class="hl-attribute">factory-method</span>=<span class="hl-value">"getMapper"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Beginning with version 2.2, the <code class="literal">object-to-json-transformer</code> sets the <code class="literal">content-type</code> header to <code class="literal">application/json</code>, by default, if the input message does not already have that header.</p>
<p>It you wish to set the <code class="literal">content-type</code> header to some other value or explicitly overwrite any existing header with some value (including <code class="literal">application/json</code>), use the <code class="literal">content-type</code> attribute.
If you wish to suppress the setting of the header, set the <code class="literal">content-type</code> attribute to an empty string (<code class="literal">""</code>).
Doing so results in a message with no <code class="literal">content-type</code> header, unless such a header was present on the input message.</p>
</td></tr></table></div>
<p>Beginning with version 3.0, the <code class="literal">ObjectToJsonTransformer</code> adds headers, reflecting the source type, to the message.
Similarly, the <code class="literal">JsonToObjectTransformer</code> can use those type headers when converting the JSON to an object.
These headers are mapped in the AMQP adapters so that they are entirely compatible with the Spring-AMQP <a class="ulink" href="http://docs.spring.io/spring-amqp/api/" target="_top"><code class="literal">JsonMessageConverter</code></a>.</p>
<p>This enables the following flows to work without any special configuration:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">...-&gt;amqp-outbound-adapter----&gt;</code>
</li><li class="listitem">
<p class="simpara"><code class="literal">----&gt;amqp-inbound-adapter-&gt;json-to-object-transformer-&gt;...</code></p>
<p class="simpara">Where the outbound adapter is configured with a <code class="literal">JsonMessageConverter</code> and the inbound adapter uses the default <code class="literal">SimpleMessageConverter</code>.</p>
</li><li class="listitem">
<code class="literal">...-&gt;object-to-json-transformer-&gt;amqp-outbound-adapter----&gt;</code>
</li><li class="listitem">
<p class="simpara"><code class="literal">----&gt;amqp-inbound-adapter-&gt;...</code></p>
<p class="simpara">Where the outbound adapter is configured with a <code class="literal">SimpleMessageConverter</code> and the inbound adapter uses the default <code class="literal">JsonMessageConverter</code>.</p>
</li><li class="listitem">
<code class="literal">...-&gt;object-to-json-transformer-&gt;amqp-outbound-adapter----&gt;</code>
</li><li class="listitem">
<p class="simpara"><code class="literal">----&gt;amqp-inbound-adapter-&gt;json-to-object-transformer-&gt;</code></p>
<p class="simpara">Where both adapters are configured with a <code class="literal">SimpleMessageConverter</code>.</p>
</li></ul></div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>When using the headers to determine the type, you should not provide a <code class="literal">class</code> attribute, because it takes precedence over the headers.</p>
</td></tr></table></div>
<p>In addition to JSON Transformers, Spring Integration provides a built-in <code class="literal">#jsonPath</code> SpEL function for use in expressions.
For more information see <a class="xref" href="#spel" title="Appendix&nbsp;A.&nbsp;Spring Expression Language (SpEL)">Appendix&nbsp;A, <i>Spring Expression Language (SpEL)</i></a>.</p>
<p><a name="transformer-xpath-spel-function" href="#transformer-xpath-spel-function"></a>Since version 3.0, Spring Integration also provides a built-in <code class="literal">#xpath</code> SpEL function for use in expressions.
For more information see <a class="xref" href="#xpath-spel-function" title="38.8&nbsp;#xpath SpEL Function">Section&nbsp;38.8, &#8220;#xpath SpEL Function&#8221;</a>.</p>
<p>Beginning with version 4.0, the <code class="literal">ObjectToJsonTransformer</code> supports the <code class="literal">resultType</code> property, to specify the node JSON representation.
The result node tree representation depends on the implementation of the provided <code class="literal">JsonObjectMapper</code>.
By default, the <code class="literal">ObjectToJsonTransformer</code> uses a <code class="literal">Jackson2JsonObjectMapper</code> and delegates the conversion of the object to the node tree to the <code class="literal">ObjectMapper#valueToTree</code> method.
The node JSON representation provides efficiency for using the <code class="literal">JsonPropertyAccessor</code> when the downstream message flow uses SpEL expressions with access to the properties of the JSON data.
See <a class="xref" href="#spel-property-accessors" title="A.3&nbsp;Property Accessors">Section&nbsp;A.3, &#8220;Property Accessors&#8221;</a> for more information.
When using Boon, the <code class="literal">NODE</code> representation is a <code class="literal">Map&lt;String, Object&gt;</code></p>
<p>Beginning with version 5.1, the <code class="literal">resultType</code> can be configured as <code class="literal">BYTES</code> to produce a message with the <code class="literal">byte[]</code> payload for convenience when working with downstream handlers which operate with this data type.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="transformer-annotation" href="#transformer-annotation"></a>9.1.4&nbsp;Configuring a Transformer with Annotations</h3></div></div></div>

<p>You can add the <code class="literal">@Transformer</code> annotation to methods that expect either the <code class="literal">Message</code> type or the message payload type.
The return value is handled in the exact same way as described earlier <a class="link" href="#transformer-namespace" title="9.1.1&nbsp;Configuring a Transformer with XML">in the section describing the <code class="literal">&lt;transformer&gt;</code> element</a>.
The following example shows how to use the <code class="literal">@Transformer</code> annotation to transform a <code class="literal">String</code> into an <code class="literal">Order</code>:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Transformer</span></em>
Order generateOrder(String productId) {
    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> Order(productId);
}</pre>
</div>
<p>Transformer methods can also accept the <code class="literal">@Header</code> and <code class="literal">@Headers</code> annotations, as documented in <code class="literal">&lt;&lt;annotations&gt;&gt;</code>.
The following examples shows how to use the <code class="literal">@Header</code> annotation:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Transformer</span></em>
Order generateOrder(String productId, <em><span class="hl-annotation" style="color: gray">@Header("customerName")</span></em> String customer) {
    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> Order(productId, customer);
}</pre>
</div>
<p>See also <a class="xref" href="#advising-with-annotations" title="10.9.7&nbsp;Advising Endpoints Using Annotations">Section&nbsp;10.9.7, &#8220;Advising Endpoints Using Annotations&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="header-filter" href="#header-filter"></a>9.1.5&nbsp;Header Filter</h3></div></div></div>

<p>Sometimes, your transformation use case might be as simple as removing a few headers.
For such a use case, Spring Integration provides a header filter that lets you specify certain header names that should be removed from the output message (for example, removing headers for security reasons or a value that was needed only temporarily).
Basically, the header filter is the opposite  of the header enricher.
The latter is discussed in <a class="xref" href="#header-enricher" title="9.2.1&nbsp;Header Enricher">Section&nbsp;9.2.1, &#8220;Header Enricher&#8221;</a>.
The following example defines a header filter:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:header-filter</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"inputChannel"</span>
		<span class="hl-attribute">output-channel</span>=<span class="hl-value">"outputChannel"</span> <span class="hl-attribute">header-names</span>=<span class="hl-value">"lastName, state"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>As you can see, configuration of a header filter is quite simple.
It is a typical endpoint with input and output channels and a <code class="literal">header-names</code> attribute.
That attribute accepts the names of the headers (delimited by commas if there are multiple) that need to be removed.
So, in the preceding example, the headers named <span class="emphasis"><em>lastName</em></span> and <span class="emphasis"><em>state</em></span> are not present on the outbound message.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_codec_based_transformers" href="#_codec_based_transformers"></a>9.1.6&nbsp;Codec-Based Transformers</h3></div></div></div>

<p>See <a class="xref" href="#codec" title="9.4&nbsp;Codec">Section&nbsp;9.4, &#8220;Codec&#8221;</a>.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="content-enricher" href="#content-enricher"></a>9.2&nbsp;Content Enricher</h2></div></div></div>

<p>At times, you may have a requirement to enhance a request with more information than was provided by the target system.
The <a class="ulink" href="http://www.eaipatterns.com/DataEnricher.html" target="_top">data enricher</a> pattern describes various scenarios as well as the component (Enricher) that lets you address such requirements.</p>
<p>The Spring Integration <code class="literal">Core</code> module includes two enrichers:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="#header-enricher" title="9.2.1&nbsp;Header Enricher">Header Enricher</a>
</li><li class="listitem">
<a class="link" href="#payload-enricher" title="9.2.2&nbsp;Payload Enricher">Payload Enricher</a>
</li></ul></div>
<p>It also includes three adapter-specific header enrichers:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="#xml-xpath-header-enricher" title="38.6&nbsp;XPath Header Enricher">XPath Header Enricher (XML Module)</a>
</li><li class="listitem">
<a class="link" href="#mail-namespace" title="24.4&nbsp;Mail Namespace Support">Mail Header Enricher (Mail Module)</a>
</li><li class="listitem">
<a class="link" href="#xmpp-message-outbound-channel-adapter" title="39.2.2&nbsp;Outbound Message Channel Adapter">XMPP Header Enricher (XMPP Module)</a>
</li></ul></div>
<p>See the adapter-specific sections of this reference manual to learn more about those adapters.</p>
<p>For more information regarding expressions support, see <a class="xref" href="#spel" title="Appendix&nbsp;A.&nbsp;Spring Expression Language (SpEL)">Appendix&nbsp;A, <i>Spring Expression Language (SpEL)</i></a>.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="header-enricher" href="#header-enricher"></a>9.2.1&nbsp;Header Enricher</h3></div></div></div>

<p>If you need do nothing more than add headers to a message and the headers are not dynamically determined by the message content, referencing a custom implementation of a transformer may be overkill.
For that reason, Spring Integration provides support for the header enricher pattern.
It is exposed through the <code class="literal">&lt;header-enricher&gt;</code> element.
The following example shows how to use it:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:header-enricher</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"in"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"out"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:header</span> <span class="hl-attribute">name</span>=<span class="hl-value">"foo"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"123"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int:header</span> <span class="hl-attribute">name</span>=<span class="hl-value">"bar"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"someBean"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:header-enricher&gt;</span></pre>
</div>
<p>The header enricher also provides helpful sub-elements to set well known header names, as the following example shows:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:header-enricher</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"in"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"out"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:error-channel</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"applicationErrorChannel"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int:reply-channel</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"quoteReplyChannel"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int:correlation-id</span> <span class="hl-attribute">value</span>=<span class="hl-value">"123"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int:priority</span> <span class="hl-attribute">value</span>=<span class="hl-value">"HIGHEST"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;routing-slip</span> <span class="hl-attribute">value</span>=<span class="hl-value">"channel1; routingSlipRoutingStrategy; request.headers[myRoutingSlipChannel]"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int:header</span> <span class="hl-attribute">name</span>=<span class="hl-value">"bar"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"someBean"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:header-enricher&gt;</span></pre>
<p>The preceding configuration shows that, for well known headers (such as <code class="literal">errorChannel</code>, <code class="literal">correlationId</code>, <code class="literal">priority</code>, <code class="literal">replyChannel</code>, <code class="literal">routing-slip</code>, and others), instead of using generic <code class="literal">&lt;header&gt;</code> sub-elements where you would have to provide both header <span class="emphasis"><em>name</em></span> and <span class="emphasis"><em>value</em></span>, you can use convenient sub-elements to set those values directly.</p>
<p>Starting with version 4.1, the header enricher provides a <code class="literal">routing-slip</code> sub-element.
See <a class="xref" href="#routing-slip" title="Routing Slip">the section called &#8220;Routing Slip&#8221;</a> for more information.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_pojo_support" href="#_pojo_support"></a>POJO Support</h4></div></div></div>

<p>Often, a header value cannot be defined statically and has to be determined dynamically based on some content in the message.
That is why the header enricher lets you also specify a bean reference by using the <code class="literal">ref</code> and <code class="literal">method</code> attributes.
The specified method calculates the header value.
Consider the following configuration and a bean with a method that modifies a <code class="literal">String</code>:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:header-enricher</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"in"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"out"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:header</span> <span class="hl-attribute">name</span>=<span class="hl-value">"something"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"computeValue"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"myBean"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:header-enricher&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myBean"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"thing1.thing2.MyBean"</span><span class="hl-tag">/&gt;</span></pre>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyBean {

    <span class="hl-keyword">public</span> String computeValue(String payload){
        <span class="hl-keyword">return</span> payload.toUpperCase() + <span class="hl-string">"_US"</span>;
    }
}</pre>
</div>
<p>You can also configure your POJO as an inner bean, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:header-enricher</span>  <span class="hl-attribute">input-channel</span>=<span class="hl-value">"inputChannel"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"outputChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:header</span> <span class="hl-attribute">name</span>=<span class="hl-value">"some_header"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.MyEnricher"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/int:header&gt;</span>
<span class="hl-tag">&lt;/int:header-enricher&gt;</span></pre>
</div>
<p>You can similarly point to a Groovy script, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:header-enricher</span>  <span class="hl-attribute">input-channel</span>=<span class="hl-value">"inputChannel"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"outputChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:header</span> <span class="hl-attribute">name</span>=<span class="hl-value">"some_header"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;int-groovy:script</span> <span class="hl-attribute">location</span>=<span class="hl-value">"org/SampleGroovyHeaderEnricher.groovy"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/int:header&gt;</span>
<span class="hl-tag">&lt;/int:header-enricher&gt;</span></pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_spel_support" href="#_spel_support"></a>SpEL Support</h4></div></div></div>

<p>In Spring Integration 2.0, we introduced the convenience of the <a class="ulink" href="http://docs.spring.io/spring/docs/current/spring-framework-reference/html/expressions.html" target="_top">Spring Expression Language (SpEL)</a> to help configure many different components.
The header enricher is one of them.
Look again at the POJO example shown earlier.
You can see that the computation logic to determine the header value is pretty simple.
A natural question would be: "Is there an even simpler way to accomplish this?".
That is where SpEL shows its true power.
Consider the following example:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:header-enricher</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"in"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"out"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:header</span> <span class="hl-attribute">name</span>=<span class="hl-value">"foo"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"payload.toUpperCase() + '_US'"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:header-enricher&gt;</span></pre>
<p>By using SpEL for such simple cases, you no longer have to provide a separate class and configure it in the application context.
All you need do is configured the <code class="literal">expression</code> attribute with a valid SpEL expression.
The <span class="emphasis"><em>payload</em></span> and <span class="emphasis"><em>headers</em></span> variables are bound to the SpEL evaluation context, giving you full access to the incoming message.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_configuring_a_header_enricher_with_java_configuration" href="#_configuring_a_header_enricher_with_java_configuration"></a>Configuring a Header Enricher with Java Configuration</h4></div></div></div>

<p>The following two examples show how to use Java Configuration for header enrichers:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<em><span class="hl-annotation" style="color: gray">@Transformer(inputChannel = "enrichHeadersChannel", outputChannel = "emailChannel")</span></em>
<span class="hl-keyword">public</span> HeaderEnricher enrichHeaders() {
    Map&lt;String, ? <span class="hl-keyword">extends</span> HeaderValueMessageProcessor&lt;?&gt;&gt; headersToAdd =
            Collections.singletonMap(<span class="hl-string">"emailUrl"</span>,
                      <span class="hl-keyword">new</span> StaticHeaderValueMessageProcessor&lt;&gt;(<span class="hl-keyword">this</span>.imapUrl));
    HeaderEnricher enricher = <span class="hl-keyword">new</span> HeaderEnricher(headersToAdd);
    <span class="hl-keyword">return</span> enricher;
}

<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<em><span class="hl-annotation" style="color: gray">@Transformer(inputChannel="enrichHeadersChannel", outputChannel="emailChannel")</span></em>
<span class="hl-keyword">public</span> HeaderEnricher enrichHeaders() {
    Map&lt;String, HeaderValueMessageProcessor&lt;?&gt;&gt; headersToAdd = <span class="hl-keyword">new</span> HashMap&lt;&gt;();
    headersToAdd.put(<span class="hl-string">"emailUrl"</span>, <span class="hl-keyword">new</span> StaticHeaderValueMessageProcessor&lt;String&gt;(<span class="hl-keyword">this</span>.imapUrl));
    Expression expression = <span class="hl-keyword">new</span> SpelExpressionParser().parseExpression(<span class="hl-string">"payload.from[0].toString()"</span>);
    headersToAdd.put(<span class="hl-string">"from"</span>,
               <span class="hl-keyword">new</span> ExpressionEvaluatingHeaderValueMessageProcessor&lt;&gt;(expression, String.<span class="hl-keyword">class</span>));
    HeaderEnricher enricher = <span class="hl-keyword">new</span> HeaderEnricher(headersToAdd);
    <span class="hl-keyword">return</span> enricher;
}</pre>
</div>
<p>The first example adds a single literal header.
The second example adds two headers, a literal header and one based on a SpEL expression.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_configuring_a_header_enricher_with_the_java_dsl" href="#_configuring_a_header_enricher_with_the_java_dsl"></a>Configuring a Header Enricher with the Java DSL</h4></div></div></div>

<p>The following example shows Java DSL Configuration for a header enricher:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> IntegrationFlow enrichHeadersInFlow() {
    <span class="hl-keyword">return</span> f -&gt; f
                ...
                .enrichHeaders(h -&gt; h.header(<span class="hl-string">"emailUrl"</span>, <span class="hl-keyword">this</span>.emailUrl)
                                     .headerExpression(<span class="hl-string">"from"</span>, <span class="hl-string">"payload.from[0].toString()"</span>))
                .handle(...);
}</pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="header-channel-registry" href="#header-channel-registry"></a>Header Channel Registry</h4></div></div></div>

<p>Starting with Spring Integration 3.0, a new sub-element <code class="literal">&lt;int:header-channels-to-string/&gt;</code> is available.
It has no attributes.
This new sub-element converts existing <code class="literal">replyChannel</code> and <code class="literal">errorChannel</code> headers (when they are a <code class="literal">MessageChannel</code>) to a <code class="literal">String</code> and stores the channels in a registry for later resolution, when it is time to send a reply or handle an error.
This is useful for cases where the headers might be lost&#8201;&#8212;&#8201;for example, when serializing a message into a message store or when transporting the message over JMS.
If the header does not already exist or it is not a <code class="literal">MessageChannel</code>, no changes are made.</p>
<p>Using this functionality requires the presence of a <code class="literal">HeaderChannelRegistry</code> bean.
By default, the framework creates a <code class="literal">DefaultHeaderChannelRegistry</code> with the default expiry (60 seconds).
Channels are removed from the registry after this time.
To change this behavior, define a bean with an <code class="literal">id</code> of <code class="literal">integrationHeaderChannelRegistry</code> and configure the required default delay by using a constructor argument (in milliseconds).</p>
<p>Since version 4.1, you can set a property called <code class="literal">removeOnGet</code> to <code class="literal">true</code> on the <code class="literal">&lt;bean/&gt;</code> definition, and the mapping entry is removed immediately on first use.
This might be useful in a high-volume environment and when the channel is only used once, rather than waiting for the reaper to remove it.</p>
<p>The <code class="literal">HeaderChannelRegistry</code> has a <code class="literal">size()</code> method to determine the current size of the registry.
The <code class="literal">runReaper()</code> method cancels the current scheduled task and runs the reaper immediately.
The task is then scheduled to run again based on the current delay.
These methods can be invoked directly by getting a reference to the registry, or you can send a message with, for example, the following content to a control bus:</p>
<div class="informalexample">
<pre class="screen">"@integrationHeaderChannelRegistry.runReaper()"</pre>
</div>
<p>This sub-element is a convenience, and is the equivalent of specifying the following configuration:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:reply-channel</span>
    <span class="hl-attribute">expression</span>=<span class="hl-value">"@integrationHeaderChannelRegistry.channelToChannelName(headers.replyChannel)"</span>
    <span class="hl-attribute">overwrite</span>=<span class="hl-value">"true"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;int:error-channel</span>
    <span class="hl-attribute">expression</span>=<span class="hl-value">"@integrationHeaderChannelRegistry.channelToChannelName(headers.errorChannel)"</span>
    <span class="hl-attribute">overwrite</span>=<span class="hl-value">"true"</span><span class="hl-tag"> /&gt;</span></pre>
</div>
<p>Starting with version 4.1, you can now override the registry&#8217;s configured reaper delay so that the the channel mapping is retained for at least the specified time, regardless of the reaper delay.
The following example shows how to do so:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:header-enricher</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"inputTtl"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"next"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:header-channels-to-string</span> <span class="hl-attribute">time-to-live-expression</span>=<span class="hl-value">"120000"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/int:header-enricher&gt;</span>

<span class="hl-tag">&lt;int:header-enricher</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"inputCustomTtl"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"next"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:header-channels-to-string</span>
        <span class="hl-attribute">time-to-live-expression</span>=<span class="hl-value">"headers['channelTTL'] ?: 120000"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/int:header-enricher&gt;</span></pre>
</div>
<p>In the first case, the time to live for every header channel mapping will be two minutes.
In the second case, the time to live is specified in the message header and uses an Elvis operator to use two minutes if there is no header.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="payload-enricher" href="#payload-enricher"></a>9.2.2&nbsp;Payload Enricher</h3></div></div></div>

<p>In certain situations, the header enricher, as discussed earlier, may not be sufficient and payloads themselves may have to be enriched with additional information.
For example, order messages that enter the Spring Integration messaging system have to look up the order&#8217;s customer based on the provided customer number and then enrich the original payload with that information.</p>
<p>Spring Integration 2.1 introduced the payload enricher.
The payload enricher defines an endpoint that passes a <code class="literal">Message</code> to the exposed request channel and then expects a reply message.
The reply message then becomes the root object for evaluation of expressions to enrich the target payload.</p>
<p>The payload enricher provides full XML namespace support through the <code class="literal">enricher</code> element.
In order to send request messages, the payload enricher has a <code class="literal">request-channel</code> attribute that lets you dispatch messages to a request channel.</p>
<p>Basically, by defining the request channel, the payload enricher acts as a gateway, waiting for the message sent to the request channel to return.
The enricher then augments the message&#8217;s payload with the data provided by the reply message.</p>
<p>When sending messages to the request channel, you also have the option to send only a subset of the original payload by using the <code class="literal">request-payload-expression</code> attribute.</p>
<p>The enriching of payloads is configured through SpEL expressions, providing a maximum degree of flexibility.
Therefore, you can not only enrich payloads with direct values from the reply channel&#8217;s <code class="literal">Message</code>, but you can use SpEL expressions to extract a subset from that message or to apply additional inline transformations, letting you further manipulate the data.</p>
<p>If you need only to enrich payloads with static values, you need not provide the <code class="literal">request-channel</code> attribute.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Enrichers are a variant of transformers.
In many cases, you could use a payload enricher or a generic transformer implementation to add additional data to your message payloads.
You should familiarize yourself with all transformation-capable components that are provided by Spring Integration and carefully select the implementation that semantically fits your business case best.</p>
</td></tr></table></div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="payload-enricher-configuration" href="#payload-enricher-configuration"></a>Configuration</h4></div></div></div>

<p>The following example shows all available configuration options for the payload enricher:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:enricher</span> <span class="hl-attribute">request-channel</span>=<span class="hl-value">""</span>                           <a name="CO9-1" href="#CO9-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
              auto-startup="true"                          <a name="CO9-2" href="#CO9-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
              id=""                                        <a name="CO9-3" href="#CO9-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
              order=""                                     <a name="CO9-4" href="#CO9-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
              output-channel=""                            <a name="CO9-5" href="#CO9-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
              request-payload-expression=""                <a name="CO9-6" href="#CO9-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>
              reply-channel=""                             <a name="CO9-7" href="#CO9-7"></a><span><img src="images/callouts/7.png" alt="7" border="0"></span>
              error-channel=""                             <a name="CO9-8" href="#CO9-8"></a><span><img src="images/callouts/8.png" alt="8" border="0"></span>
              send-timeout=""                              <a name="CO9-9" href="#CO9-9"></a><span><img src="images/callouts/9.png" alt="9" border="0"></span>
              should-clone-payload="false"&gt;                <a name="CO9-10" href="#CO9-10"></a><span><img src="images/callouts/10.png" alt="10" border="0"></span>
    <span class="hl-tag">&lt;int:poller&gt;</span><span class="hl-tag">&lt;/int:poller&gt;</span>                              <a name="CO9-11" href="#CO9-11"></a><span><img src="images/callouts/11.png" alt="11" border="0"></span>
    <span class="hl-tag">&lt;int:property</span> <span class="hl-attribute">name</span>=<span class="hl-value">""</span> <span class="hl-attribute">expression</span>=<span class="hl-value">""</span> <span class="hl-attribute">null-result-expression</span>=<span class="hl-value">"'Could not determine the name'"</span><span class="hl-tag">/&gt;</span>   <a name="CO9-12" href="#CO9-12"></a><span><img src="images/callouts/12.png" alt="12" border="0"></span>
    <span class="hl-tag">&lt;int:property</span> <span class="hl-attribute">name</span>=<span class="hl-value">""</span> <span class="hl-attribute">value</span>=<span class="hl-value">"23"</span> <span class="hl-attribute">type</span>=<span class="hl-value">"java.lang.Integer"</span> <span class="hl-attribute">null-result-expression</span>=<span class="hl-value">"'0'"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int:header</span> <span class="hl-attribute">name</span>=<span class="hl-value">""</span> <span class="hl-attribute">expression</span>=<span class="hl-value">""</span> <span class="hl-attribute">null-result-expression</span>=<span class="hl-value">""</span><span class="hl-tag">/&gt;</span>   <a name="CO9-13" href="#CO9-13"></a><span><img src="images/callouts/13.png" alt="13" border="0"></span>
    <span class="hl-tag">&lt;int:header</span> <span class="hl-attribute">name</span>=<span class="hl-value">""</span> <span class="hl-attribute">value</span>=<span class="hl-value">""</span> <span class="hl-attribute">overwrite</span>=<span class="hl-value">""</span> <span class="hl-attribute">type</span>=<span class="hl-value">""</span> <span class="hl-attribute">null-result-expression</span>=<span class="hl-value">""</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:enricher&gt;</span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO9-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Channel to which a message is sent to get the data to use for enrichment.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO9-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Lifecycle attribute signaling whether this component should be started during the application context startup.
Defaults to true.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO9-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>ID of the underlying bean definition, which is either an <code class="literal">EventDrivenConsumer</code> or a <code class="literal">PollingConsumer</code>.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO9-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Specifies the order for invocation when this endpoint is connected as a subscriber to a channel.
This is particularly relevant when that channel is using a "<code class="literal">failover</code>" dispatching strategy.
It has no effect when this endpoint is itself a polling consumer for a channel with a queue.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO9-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Identifies the message channel where a message is sent after it is being processed by this endpoint.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO9-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>By default, the original message&#8217;s payload is used as payload that is sent to the <code class="literal">request-channel</code>.
By specifying a SpEL expression as the value for the <code class="literal">request-payload-expression</code> attribute, you can use a subset of the original payload, a header value, or any other resolvable SpEL expression as the basis for the payload that is sent to the request-channel.
For the expression evaluation, the full message is available as the <span class="emphasis"><em>root object</em></span>.
For instance, the following SpEL expressions (among others) are possible:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">payload.something</code>
</li><li class="listitem">
<code class="literal">headers.something</code>
</li><li class="listitem">
<code class="literal">new java.util.Date()</code>
</li><li class="listitem">
<code class="literal">'thing1' + 'thing2'</code>
</li></ul></div>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO9-7"><span><img src="images/callouts/7.png" alt="7" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Channel where a reply message is expected.
This is optional.
Typically, the auto-generated temporary reply channel suffices.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO9-8"><span><img src="images/callouts/8.png" alt="8" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The channel to which an <code class="literal">ErrorMessage</code> is sent if an <code class="literal">Exception</code> occurs downstream of the <code class="literal">request-channel</code>.
This enables you to return an alternative object to use for enrichment.
If it is not set, an <code class="literal">Exception</code> is thrown to the caller.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO9-9"><span><img src="images/callouts/9.png" alt="9" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Maximum amount of time in milliseconds to wait when sending a message to the channel, if the channel might block.
For example, a queue channel can block until space is available, if its maximum capacity has been reached.
Internally, the send timeout is set on the <code class="literal">MessagingTemplate</code> and ultimately applied when invoking the send operation on the <code class="literal">MessageChannel</code>.
By default, the send timeout is set to <span class="emphasis"><em>-1</em></span>, which can cause the send operation on the <code class="literal">MessageChannel</code>, depending on the implementation, to block indefinitely.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO9-10"><span><img src="images/callouts/10.png" alt="10" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Boolean value indicating whether any payload that implements <code class="literal">Cloneable</code> should be cloned prior to sending the message to the request channel for acquiring the enriching data.
The cloned version would be used as the target payload for the ultimate reply.
The default is <code class="literal">false</code>.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO9-11"><span><img src="images/callouts/11.png" alt="11" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Lets you configure a message poller if this endpoint is a polling consumer.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO9-12"><span><img src="images/callouts/12.png" alt="12" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Each <code class="literal">property</code> sub-element provides the name of a property (through the mandatory <code class="literal">name</code> attribute).
That property should be settable on the target payload instance.
Exactly one of the <code class="literal">value</code> or <code class="literal">expression</code> attributes must be provided as well&#8201;&#8212;&#8201;the former for a literal value to set and the latter for a SpEL expression to be evaluated.
The root object of the evaluation context is the message that was returned from the flow initiated by this enricher&#8201;&#8212;&#8201;the input message if there is no request channel or the application context (using the <span class="emphasis"><em>@&lt;beanName&gt;.&lt;beanProperty&gt;</em></span> SpEL syntax).
Starting with version 4.0, when specifying a <code class="literal">value</code> attribute, you can also specify an optional <code class="literal">type</code> attribute.
When the destination is a typed setter method, the framework coerces the value appropriately (as long as a <code class="literal">PropertyEditor</code>) exists to handle the conversion.
If, however, the target payload is a <code class="literal">Map</code>, the entry is populated with the value without conversion.
The <code class="literal">type</code> attribute lets you, for example, convert a <code class="literal">String</code> containing a number to an <code class="literal">Integer</code> value in the target payload.
Starting with version 4.1, you can also specify an optional <code class="literal">null-result-expression</code> attribute.
When the <code class="literal">enricher</code> returns null, it is evaluated, and the output of the evaluation is returned instead.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO9-13"><span><img src="images/callouts/13.png" alt="13" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Each <code class="literal">header</code> sub-element provides the name of a message header (through the mandatory <code class="literal">name</code> attribute).
Exactly one of the <code class="literal">value</code> or <code class="literal">expression</code> attributes must also be provided&#8201;&#8212;&#8201;the former for a literal value to set and the latter for a SpEL expression to be evaluated.
The root object of the evaluation context is the message that was returned from the flow initiated by this enricher&#8201;&#8212;&#8201;the input message if there is no request channel or the application context (using the <span class="emphasis"><em>@&lt;beanName&gt;.&lt;beanProperty&gt;</em></span> SpEL syntax).
Note that, similarly to the <code class="literal">&lt;header-enricher&gt;</code>, the <code class="literal">&lt;enricher&gt;</code> element&#8217;s <code class="literal">header</code> element has <code class="literal">type</code> and <code class="literal">overwrite</code> attributes.
However, a key difference is that, with the <code class="literal">&lt;enricher&gt;</code>, the <code class="literal">overwrite</code> attribute is <code class="literal">true</code> by default, to be consistent with the <code class="literal">&lt;enricher&gt;</code> element&#8217;s <code class="literal">&lt;property&gt;</code> sub-element.
Starting with version 4.1, you can also specify an optional <code class="literal">null-result-expression</code> attribute.
When the <code class="literal">enricher</code> returns null, it is evaluated, and the output of the evaluation is returned instead.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="payload-enricher-examples" href="#payload-enricher-examples"></a>Examples</h4></div></div></div>

<p>This section contains several examples of using a payload enricher in various situations.</p>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>The code samples shown here are part of the Spring Integration Samples project.
See <a class="xref" href="#samples" title="Appendix&nbsp;G.&nbsp;Spring Integration Samples">Appendix&nbsp;G, <i>Spring Integration Samples</i></a>.</p>
</td></tr></table></div>
<p>In the following example, a <code class="literal">User</code> object is passed as the payload of the <code class="literal">Message</code>:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:enricher</span> <span class="hl-attribute">id</span>=<span class="hl-value">"findUserEnricher"</span>
              <span class="hl-attribute">input-channel</span>=<span class="hl-value">"findUserEnricherChannel"</span>
              <span class="hl-attribute">request-channel</span>=<span class="hl-value">"findUserServiceChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"email"</span>    <span class="hl-attribute">expression</span>=<span class="hl-value">"payload.email"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int:property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"password"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"payload.password"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:enricher&gt;</span></pre>
</div>
<p>The <code class="literal">User</code> has several properties, but only the <code class="literal">username</code> is set initially.
The enricher&#8217;s <code class="literal">request-channel</code> attribute is configured to pass the <code class="literal">User</code> to the <code class="literal">findUserServiceChannel</code>.</p>
<p>Through the implicitly set <code class="literal">reply-channel</code>, a <code class="literal">User</code> object is returned and, by using the <code class="literal">property</code> sub-element, properties from the reply are extracted and used to enrich the original payload.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_how_do_i_pass_only_a_subset_of_data_to_the_request_channel" href="#_how_do_i_pass_only_a_subset_of_data_to_the_request_channel"></a>How Do I Pass Only a Subset of Data to the Request Channel?</h4></div></div></div>

<p>When using a <code class="literal">request-payload-expression</code> attribute, a single property of the payload instead of the full message can be passed on to the request channel.
In the following example, the username property is passed on to the request channel:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:enricher</span> <span class="hl-attribute">id</span>=<span class="hl-value">"findUserByUsernameEnricher"</span>
              <span class="hl-attribute">input-channel</span>=<span class="hl-value">"findUserByUsernameEnricherChannel"</span>
              <span class="hl-attribute">request-channel</span>=<span class="hl-value">"findUserByUsernameServiceChannel"</span>
              <span class="hl-attribute">request-payload-expression</span>=<span class="hl-value">"payload.username"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"email"</span>    <span class="hl-attribute">expression</span>=<span class="hl-value">"payload.email"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int:property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"password"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"payload.password"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:enricher&gt;</span></pre>
</div>
<p>Keep in mind that, although only the username is passed, the resulting message to the request channel contains the full set of <code class="literal">MessageHeaders</code>.</p>
<div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="_how_can_i_enrich_payloads_that_consist_of_collection_data" href="#_how_can_i_enrich_payloads_that_consist_of_collection_data"></a>How Can I Enrich Payloads that Consist of Collection Data?</h5></div></div></div>

<p>In the following example, instead of a <code class="literal">User</code> object, a <code class="literal">Map</code> is passed in:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:enricher</span> <span class="hl-attribute">id</span>=<span class="hl-value">"findUserWithMapEnricher"</span>
              <span class="hl-attribute">input-channel</span>=<span class="hl-value">"findUserWithMapEnricherChannel"</span>
              <span class="hl-attribute">request-channel</span>=<span class="hl-value">"findUserByUsernameServiceChannel"</span>
              <span class="hl-attribute">request-payload-expression</span>=<span class="hl-value">"payload.username"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"user"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"payload"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:enricher&gt;</span></pre>
</div>
<p>The <code class="literal">Map</code> contains the username under the <code class="literal">username</code> map key.
Only the <code class="literal">username</code> is passed on to the request channel.
The reply contains a full <code class="literal">User</code> object, which is ultimately added to the <code class="literal">Map</code> under the <code class="literal">user</code> key.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_how_can_i_enrich_payloads_with_static_information_without_using_a_request_channel" href="#_how_can_i_enrich_payloads_with_static_information_without_using_a_request_channel"></a>How Can I Enrich Payloads with Static Information without Using a Request Channel?</h4></div></div></div>

<p>The following example does not use a request channel at all but solely enriches the message&#8217;s payload with static values:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:enricher</span> <span class="hl-attribute">id</span>=<span class="hl-value">"userEnricher"</span>
              <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"user.updateDate"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"new java.util.Date()"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int:property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"user.firstName"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"William"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int:property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"user.lastName"</span>  <span class="hl-attribute">value</span>=<span class="hl-value">"Shakespeare"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int:property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"user.age"</span>       <span class="hl-attribute">value</span>=<span class="hl-value">"42"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:enricher&gt;</span></pre>
</div>
<p>Note that the word, <span class="emphasis"><em>static</em></span>, is used loosely here.
You can still use SpEL expressions for setting those values.</p>
</div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="claim-check" href="#claim-check"></a>9.3&nbsp;Claim Check</h2></div></div></div>

<p>In earlier sections, we covered several content enricher components that can help you deal with situations where a message is missing a piece of data.
We also discussed content filtering, which lets you remove data items from a message.
However, there are times when we want to hide data temporarily.
For example, in a distributed system, we may receive a message with a very large payload.
Some intermittent message processing steps may not need access to this payload and some may only need to access certain headers, so carrying the large message payload through each processing step may cause performance degradation, may produce a security risk, and may make debugging more difficult.</p>
<p>The <a class="ulink" href="http://www.eaipatterns.com/StoreInLibrary.html" target="_top">store in library</a> (or claim check) pattern describes a mechanism that lets you store data in a well known place while maintaining only a pointer (a claim check) to where that data is located.
You can pass that pointer around as the payload of a new message, thereby letting any component within the message flow get the actual data as soon as it needs it.
This approach is very similar to the certified mail process, where you get a claim check in your mailbox and then have to go to the post office to claim your actual package.
It is also the same idea as baggage claim after a flight or in a hotel.</p>
<p>Spring Integration provides two types of claim check transformers:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Incoming Claim Check Transformer
</li><li class="listitem">
Outgoing Claim Check Transformer
</li></ul></div>
<p>Convenient namespace-based mechanisms are available to configure them.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="claim-check-in" href="#claim-check-in"></a>9.3.1&nbsp;Incoming Claim Check Transformer</h3></div></div></div>

<p>An incoming claim check transformer transforms an incoming message by storing it in the message store identified by its <code class="literal">message-store</code> attribute.
The following example defines an incoming claim check transformer:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:claim-check-in</span> <span class="hl-attribute">id</span>=<span class="hl-value">"checkin"</span>
        <span class="hl-attribute">input-channel</span>=<span class="hl-value">"checkinChannel"</span>
        <span class="hl-attribute">message-store</span>=<span class="hl-value">"testMessageStore"</span>
        <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>In the preceding configuration, the message that is received on the <code class="literal">input-channel</code> is persisted to the message store identified with the <code class="literal">message-store</code> attribute and indexed with a generated ID.
That ID is the claim check for that message.
The claim check also becomes the payload of the new (transformed) message that is sent to the <code class="literal">output-channel</code>.</p>
<p>Now, assume that at some point you do need access to the actual message.
You can access the message store manually and get the contents of the message, or you can use the same approach (creating a transformer) except that now you transform the Claim Check to the actual message by using an outgoing claim check transformer.</p>
<p>The following listing provides an overview of all available parameters of an incoming claim check transformer:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:claim-check-in</span> <span class="hl-attribute">auto-startup</span>=<span class="hl-value">"true"</span>  <a name="CO10-1" href="#CO10-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
                    id=""                           <a name="CO10-2" href="#CO10-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
                    input-channel=""                <a name="CO10-3" href="#CO10-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
                    message-store="messageStore"    <a name="CO10-4" href="#CO10-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
                    order=""                        <a name="CO10-5" href="#CO10-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
                    output-channel=""               <a name="CO10-6" href="#CO10-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>
                    send-timeout=""&gt;                <a name="CO10-7" href="#CO10-7"></a><span><img src="images/callouts/7.png" alt="7" border="0"></span>
    <span class="hl-tag">&lt;int:poller&gt;</span><span class="hl-tag">&lt;/int:poller&gt;</span>                       <a name="CO10-8" href="#CO10-8"></a><span><img src="images/callouts/8.png" alt="8" border="0"></span>
<span class="hl-tag">&lt;/int:claim-check-in&gt;</span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO10-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Lifecycle attribute signaling whether this component should be started during application context startup.
It defaults to <code class="literal">true</code>.
This attribute is not available inside a <code class="literal">Chain</code> element.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO10-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>ID identifying the underlying bean definition (<code class="literal">MessageTransformingHandler</code>).
This attribute is not available inside a <code class="literal">Chain</code> element.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO10-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The receiving message channel of this endpoint.
This attribute is not available inside a <code class="literal">Chain</code> element.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO10-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Reference to the <code class="literal">MessageStore</code> to be used by this claim check transformer.
If not specified, the default reference is to a bean named <code class="literal">messageStore</code>.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO10-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Specifies the order for invocation when this endpoint is connected as a subscriber to a channel.
This is particularly relevant when that channel uses a <code class="literal">failover</code> dispatching strategy.
It has no effect when this endpoint is itself a polling consumer for a channel with a queue.
This attribute is not available inside a <code class="literal">Chain</code> element.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO10-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Identifies the message channel where the message is sent after being processed by this endpoint.
This attribute is not available inside a <code class="literal">Chain</code> element.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO10-7"><span><img src="images/callouts/7.png" alt="7" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Specifies the maximum amount of time (in milliseconds) to wait when sending a reply message to the output channel.
Defaults to <code class="literal">-1</code>&#8201;&#8212;&#8201;blocking indefinitely.
This attribute is not available inside a <code class="literal">Chain</code> element.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO10-8"><span><img src="images/callouts/8.png" alt="8" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Defines a poller.
This element is not available inside a <code class="literal">Chain</code> element.
Optional.</p>
</td></tr></table></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="claim-check-out" href="#claim-check-out"></a>9.3.2&nbsp;Outgoing Claim Check Transformer</h3></div></div></div>

<p>An outgoing claim check transformer lets you transform a message with a claim check payload into a message with the original content as its payload.</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:claim-check-out</span> <span class="hl-attribute">id</span>=<span class="hl-value">"checkout"</span>
        <span class="hl-attribute">input-channel</span>=<span class="hl-value">"checkoutChannel"</span>
        <span class="hl-attribute">message-store</span>=<span class="hl-value">"testMessageStore"</span>
        <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>In the preceding configuration, the message received on the <code class="literal">input-channel</code> should have a claim check as its payload.
The outgoing claim check transformer transforms it into a message with the original payload by querying the message store for a message identified by the provided claim check.
It then sends the newly checked-out message to the <code class="literal">output-channel</code>.</p>
<p>The following listing provides an overview of all available parameters of an outgoing claim check transformer:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:claim-check-out</span> <span class="hl-attribute">auto-startup</span>=<span class="hl-value">"true"</span>  <a name="CO11-1" href="#CO11-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
                     id=""                           <a name="CO11-2" href="#CO11-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
                     input-channel=""                <a name="CO11-3" href="#CO11-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
                     message-store="messageStore"    <a name="CO11-4" href="#CO11-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
                     order=""                        <a name="CO11-5" href="#CO11-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
                     output-channel=""               <a name="CO11-6" href="#CO11-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>
                     remove-message="false"          <a name="CO11-7" href="#CO11-7"></a><span><img src="images/callouts/7.png" alt="7" border="0"></span>
                     send-timeout=""&gt;                <a name="CO11-8" href="#CO11-8"></a><span><img src="images/callouts/8.png" alt="8" border="0"></span>
    <span class="hl-tag">&lt;int:poller&gt;</span><span class="hl-tag">&lt;/int:poller&gt;</span>                        <a name="CO11-9" href="#CO11-9"></a><span><img src="images/callouts/9.png" alt="9" border="0"></span>
<span class="hl-tag">&lt;/int:claim-check-out&gt;</span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO11-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Lifecycle attribute signaling whether this component should be started during application context startup.
It defaults to <code class="literal">true</code>.
This attribute is not available inside a <code class="literal">Chain</code> element.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO11-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>ID identifying the underlying bean definition (<code class="literal">MessageTransformingHandler</code>).
This attribute is not available inside a <code class="literal">Chain</code> element.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO11-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The receiving message channel of this endpoint.
This attribute is not available inside a <code class="literal">Chain</code> element.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO11-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Reference to the <code class="literal">MessageStore</code> to be used by this claim check transformer.
If not specified, the default reference is to a bean named <code class="literal">messageStore</code>.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO11-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Specifies the order for invocation when this endpoint is connected as a subscriber to a channel.
This is particularly relevant when that channel is using a <code class="literal">failover</code> dispatching strategy.
It has no effect when this endpoint is itself a polling consumer for a channel with a queue.
This attribute is not available inside a <code class="literal">Chain</code> element.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO11-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Identifies the message channel where the message is sent after being processed by this endpoint.
This attribute is not available inside a <code class="literal">Chain</code> element.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO11-7"><span><img src="images/callouts/7.png" alt="7" border="0"></span></a> </p></td><td valign="top" align="left">
<p>If set to <code class="literal">true</code>, the message is removed from the <code class="literal">MessageStore</code> by this transformer.
This setting is useful when Message can be "<code class="literal">claimed</code>" only once.
It defaults to <code class="literal">false</code>.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO11-8"><span><img src="images/callouts/8.png" alt="8" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Specifies the maximum amount of time (in milliseconds) to wait when sending a reply message to the output channel.
It defaults to <code class="literal">-1</code>&#8201;&#8212;&#8201;blocking indefinitely.
This attribute is not available inside a <code class="literal">Chain</code> element.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO11-9"><span><img src="images/callouts/9.png" alt="9" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Defines a poller.
This element is not available inside a <code class="literal">Chain</code> element.
Optional.</p>
</td></tr></table></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_claim_once" href="#_claim_once"></a>9.3.3&nbsp;Claim Once</h3></div></div></div>

<p>Sometimes, a particular message must be claimed only once.
As an analogy, consider process of handling airplane luggage.
You checking in your luggage on departure and claiming it on arrival.
Once the luggage has been claimed, it can not be claimed again without first checking it back in.
To accommodate such cases, we introduced a <code class="literal">remove-message</code> boolean attribute on the <code class="literal">claim-check-out</code> transformer.
This attribute is set to <code class="literal">false</code> by default.
However, if set to <code class="literal">true</code>, the claimed message is removed from the <code class="literal">MessageStore</code> so that it cannot be claimed again.</p>
<p>This feature has an impact in terms of storage space, especially in the case of the in-memory <code class="literal">Map</code>-based <code class="literal">SimpleMessageStore</code>, where failing to remove messages could ultimately lead to an <code class="literal">OutOfMemoryException</code>.
Therefore, if you do not expect multiple claims to be made, we recommend that you set the <code class="literal">remove-message</code> attribute&#8217;s value to <code class="literal">true</code>.
The following example show how to use the <code class="literal">remove-message</code> attribute:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:claim-check-out</span> <span class="hl-attribute">id</span>=<span class="hl-value">"checkout"</span>
        <span class="hl-attribute">input-channel</span>=<span class="hl-value">"checkoutChannel"</span>
        <span class="hl-attribute">message-store</span>=<span class="hl-value">"testMessageStore"</span>
        <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span>
        <span class="hl-attribute">remove-message</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span></pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_a_word_on_message_store" href="#_a_word_on_message_store"></a>9.3.4&nbsp;A Word on Message Store</h3></div></div></div>

<p>Although we rarely care about the details of the claim checks (as long as they work), you should know that the current implementation of the actual claim check (the pointer) in Spring Integration uses a UUID to ensure uniqueness.</p>
<p><code class="literal">org.springframework.integration.store.MessageStore</code> is a strategy interface for storing and retrieving messages.
Spring Integration provides two convenient implementations of it:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">SimpleMessageStore</code>: An in-memory, <code class="literal">Map</code>-based implementation (the default, good for testing)
</li><li class="listitem">
<code class="literal">JdbcMessageStore</code>: An implementation that uses a relational database over JDBC
</li></ul></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="codec" href="#codec"></a>9.4&nbsp;Codec</h2></div></div></div>

<p>Version 4.2 of Spring Integration introduced the <code class="literal">Codec</code> abstraction.
Codecs encode and decode objects to and from <code class="literal">byte[]</code>.
They offer an alternative to Java serialization.
One advantage is that, typically, objects need not implement <code class="literal">Serializable</code>.
We provide one implementation that uses <a class="ulink" href="https://github.com/EsotericSoftware/kryo" target="_top">Kryo</a> for serialization, but you can provide your own implementation for use in any of the following components:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">EncodingPayloadTransformer</code>
</li><li class="listitem">
<code class="literal">DecodingTransformer</code>
</li><li class="listitem">
<code class="literal">CodecMessageConverter</code>
</li></ul></div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_literal_encodingpayloadtransformer_literal" href="#_literal_encodingpayloadtransformer_literal"></a>9.4.1&nbsp;<code class="literal">EncodingPayloadTransformer</code></h3></div></div></div>

<p>This transformer encodes the payload to a <code class="literal">byte[]</code> by using the codec.
It does not affect message headers.</p>
<p>See the <a class="ulink" href="https://docs.spring.io/spring-integration/api/org/springframework/integration/transformer/EncodingPayloadTransformer.html" target="_top">Javadoc</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_literal_decodingtransformer_literal" href="#_literal_decodingtransformer_literal"></a>9.4.2&nbsp;<code class="literal">DecodingTransformer</code></h3></div></div></div>

<p>This transformer decodes a <code class="literal">byte[]</code> by using the codec.
It needs to be configured with the <code class="literal">Class</code> to which the object should be decoded (or an expression that resolves to a <code class="literal">Class</code>).
If the resulting object is a <code class="literal">Message&lt;?&gt;</code>, inbound headers are not retained.</p>
<p>See the <a class="ulink" href="https://docs.spring.io/spring-integration/api/org/springframework/integration/transformer/DecodingTransformer.html" target="_top">Javadoc</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_literal_codecmessageconverter_literal" href="#_literal_codecmessageconverter_literal"></a>9.4.3&nbsp;<code class="literal">CodecMessageConverter</code></h3></div></div></div>

<p>Certain endpoints (such as TCP and Redis) have no concept of message headers.
They support the use of a <code class="literal">MessageConverter</code>, and the <code class="literal">CodecMessageConverter</code> can be used to convert a message to or from a <code class="literal">byte[]</code> for
transmission.</p>
<p>See the <a class="ulink" href="https://docs.spring.io/spring-integration/api/org/springframework/integration/codec/CodecMessageConverter.html" target="_top">Javadoc</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_kryo" href="#_kryo"></a>9.4.4&nbsp;Kryo</h3></div></div></div>

<p>Currently, this is the only implementation of <code class="literal">Codec</code>, and it provides two kinds of <code class="literal">Codec</code>:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">PojoCodec</code>: Used in the transformers
</li><li class="listitem">
<code class="literal">MessageCodec</code>: Used in the <code class="literal">CodecMessageConverter</code>
</li></ul></div>
<p>The framework provides several custom serializers:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">FileSerializer</code>
</li><li class="listitem">
<code class="literal">MessageHeadersSerializer</code>
</li><li class="listitem">
<code class="literal">MutableMessageHeadersSerializer</code>
</li></ul></div>
<p>The first can be used with the <code class="literal">PojoCodec</code> by initializing it with the <code class="literal">FileKryoRegistrar</code>.
The second and third are used with the <code class="literal">MessageCodec</code>, which is initialized with the <code class="literal">MessageKryoRegistrar</code>.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_customizing_kryo" href="#_customizing_kryo"></a>Customizing Kryo</h4></div></div></div>

<p>By default, Kryo delegates unknown Java types to its <code class="literal">FieldSerializer</code>.
Kryo also registers default serializers for each primitive type, along with <code class="literal">String</code>, <code class="literal">Collection</code>, and <code class="literal">Map</code>.
<code class="literal">FieldSerializer</code> uses reflection to navigate the object graph. A more efficient approach is to implement a custom
serializer that is aware of the object&#8217;s structure and can directly serialize selected primitive fields.
The following example shows such a serializer:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> AddressSerializer <span class="hl-keyword">extends</span> Serializer&lt;Address&gt; {

    <em><span class="hl-annotation" style="color: gray">@Override</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> write(Kryo kryo, Output output, Address address) {
        output.writeString(address.getStreet());
        output.writeString(address.getCity());
        output.writeString(address.getCountry());
    }

    <em><span class="hl-annotation" style="color: gray">@Override</span></em>
    <span class="hl-keyword">public</span> Address read(Kryo kryo, Input input, Class&lt;Address&gt; type) {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> Address(input.readString(), input.readString(), input.readString());
    }
}</pre>
</div>
<p>The <code class="literal">Serializer</code> interface exposes <code class="literal">Kryo</code>, <code class="literal">Input</code>, and <code class="literal">Output</code>, which provide complete control over which fields are included and other internal settings, as described in the <a class="ulink" href="https://github.com/EsotericSoftware/kryo" target="_top">Kryo documentation</a>.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>When registering your custom serializer, you need a registration ID.
The registration IDs are arbitrary.
However, in our case, the IDs must be explicitly defined, because each Kryo instance across the distributed application must use the same IDs.
Kryo recommends small positive integers and reserves a few ids (value &lt; 10).
Spring Integration currently defaults to using 40, 41, and 42 (for the file and message header serializers mentioned earlier).
We recommend you start at 60, to allow for expansion in the framework.
You can override these framework defaults by configuring the registrars mentioned earlier.</p>
</td></tr></table></div>
<div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="_using_a_custom_kryo_serializer" href="#_using_a_custom_kryo_serializer"></a>Using a Custom Kryo Serializer</h5></div></div></div>

<p>If you need custom serialization, see the <a class="ulink" href="https://github.com/EsotericSoftware/kryo" target="_top">Kryo</a> documentation, because you need to use the native API to do the customization.
For an example, see the <a class="ulink" href="https://github.com/spring-projects/spring-integration/blob/master/spring-integration-core/src/main/java/org/springframework/integration/codec/kryo/MessageCodec.java" target="_top"><code class="literal">MessageCodec</code></a> implementation.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="_implementing_kryoserializable" href="#_implementing_kryoserializable"></a>Implementing KryoSerializable</h5></div></div></div>

<p>If you have write access to the domain object source code, you can implement <code class="literal">KryoSerializable</code> as described <a class="ulink" href="https://github.com/EsotericSoftware/kryo#kryoserializable" target="_top">here</a>.
In this case, the class provides the serialization methods itself and no further configuration is required.
However benchmarks have shown this is not quite as efficient as registering a custom serializer explicitly.
The following example shows a custom Kryo serializer:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> Address <span class="hl-keyword">implements</span> KryoSerializable {
    ...

    <em><span class="hl-annotation" style="color: gray">@Override</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> write(Kryo kryo, Output output) {
        output.writeString(<span class="hl-keyword">this</span>.street);
        output.writeString(<span class="hl-keyword">this</span>.city);
        output.writeString(<span class="hl-keyword">this</span>.country);
    }

    <em><span class="hl-annotation" style="color: gray">@Override</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> read(Kryo kryo, Input input) {
        <span class="hl-keyword">this</span>.street = input.readString();
        <span class="hl-keyword">this</span>.city = input.readString();
        <span class="hl-keyword">this</span>.country = input.readString();
    }
}</pre>
</div>
<p>You can also use this technique to wrap a serialization library other than Kryo.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="_using_the_literal_defaultserializer_literal_annotation" href="#_using_the_literal_defaultserializer_literal_annotation"></a>Using the <code class="literal">@DefaultSerializer</code> Annotation</h5></div></div></div>

<p>Kryo also provides a <code class="literal">@DefaultSerializer</code> annotation, as described <a class="ulink" href="https://github.com/EsotericSoftware/kryo#default-serializers" target="_top">here</a>.</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@DefaultSerializer(SomeClassSerializer.class)</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> SomeClass {
       <span class="hl-comment">// ...</span>
}</pre>
</div>
<p>If you have write access to the domain object, this may be a simpler way to specify a custom serializer.
Note that this does not register the class with an ID, which may make the technique unhelpful for certain situations.</p>
</div>
</div>
</div>
</div>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="messaging-endpoints-chapter" href="#messaging-endpoints-chapter"></a>10.&nbsp;Messaging Endpoints</h2></div></div></div>

<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="endpoint" href="#endpoint"></a>10.1&nbsp;Message Endpoints</h2></div></div></div>

<p>The first part of this chapter covers some background theory and reveals quite a bit about the underlying API that drives Spring Integration&#8217;s various messaging components.
This information can be helpful if you want to really understand what goes on behind the scenes.
However, if you want to get up and running with the simplified namespace-based configuration of the various elements, feel free to skip ahead to <a class="xref" href="#endpoint-namespace" title="10.1.4&nbsp;Endpoint Namespace Support">Section&nbsp;10.1.4, &#8220;Endpoint Namespace Support&#8221;</a> for now.</p>
<p>As mentioned in the overview, message endpoints are responsible for connecting the various messaging components to channels.
Over the next several chapters, we cover a number of different components that consume messages.
Some of these are also capable of sending reply messages.
Sending messages is quite straightforward.
As shown earlier in <a class="xref" href="#channel" title="6.1&nbsp;Message Channels">Section&nbsp;6.1, &#8220;Message Channels&#8221;</a>, you can send a message to a message channel.
However, receiving is a bit more complicated.
The main reason is that there are two types of consumers: <a class="ulink" href="http://www.eaipatterns.com/PollingConsumer.html" target="_top">polling consumers</a> and <a class="ulink" href="http://www.eaipatterns.com/EventDrivenConsumer.html" target="_top">event-driven consumers</a>.</p>
<p>Of the two, event-driven consumers are much simpler.
Without any need to manage and schedule a separate poller thread, they are essentially listeners with a callback method.
When connecting to one of Spring Integration&#8217;s subscribable message channels, this simple option works great.
However, when connecting to a buffering, pollable message channel, some component has to schedule and manage the polling threads.
Spring Integration provides two different endpoint implementations to accommodate these two types of consumers.
Therefore, the consumers themselves need only implement the callback interface.
When polling is required, the endpoint acts as a container for the consumer instance.
The benefit is similar to that of using a container for hosting message-driven beans, but, since these consumers are Spring-managed objects running within an <code class="literal">ApplicationContext</code>, it more closely resembles Spring&#8217;s own <code class="literal">MessageListener</code> containers.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="endpoint-handler" href="#endpoint-handler"></a>10.1.1&nbsp;Message Handler</h3></div></div></div>

<p>Spring Integration&#8217;s <code class="literal">MessageHandler</code> interface is implemented by many of the components within the framework.
In other words, this is not part of the public API, and you would not typically implement <code class="literal">MessageHandler</code> directly.
Nevertheless, it is used by a message consumer for actually handling the consumed messages, so being aware of this strategy interface does help in terms of understanding the overall role of a consumer.
The interface is defined as follows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> MessageHandler {

    <span class="hl-keyword">void</span> handleMessage(Message&lt;?&gt; message);

}</pre>
</div>
<p>Despite its simplicity, this interface provides the foundation for most of the components (routers, transformers, splitters, aggregators, service activators, and others) covered in the following chapters.
Those components each perform very different functionality with the messages they handle, but the requirements for actually receiving a message are the same, and the choice between polling and event-driven behavior is also the same.
Spring Integration provides two endpoint implementations that host these callback-based handlers and let them be connected to message channels.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="endpoint-eventdrivenconsumer" href="#endpoint-eventdrivenconsumer"></a>10.1.2&nbsp;Event-driven Consumer</h3></div></div></div>

<p>Because it is the simpler of the two, we cover the event-driven consumer endpoint first.
You may recall that the <code class="literal">SubscribableChannel</code> interface provides a <code class="literal">subscribe()</code> method and that the method accepts a <code class="literal">MessageHandler</code> parameter (as shown in <a class="xref" href="#channel-interfaces-subscribablechannel" title="SubscribableChannel">the section called &#8220;<code class="literal">SubscribableChannel</code>&#8221;</a>).
The following listing shows the definition of the <code class="literal">subscribe</code> method:</p>
<div class="informalexample">
<pre class="programlisting">subscribableChannel.subscribe(messageHandler);</pre>
</div>
<p>Since a handler that is subscribed to a channel does not have to actively poll that channel, this is an event-driven consumer, and the implementation provided by Spring Integration accepts a <code class="literal">SubscribableChannel</code> and a <code class="literal">MessageHandler</code>, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting">SubscribableChannel channel = context.getBean(<span class="hl-string">"subscribableChannel"</span>, SubscribableChannel.<span class="hl-keyword">class</span>);

EventDrivenConsumer consumer = <span class="hl-keyword">new</span> EventDrivenConsumer(channel, exampleHandler);</pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="endpoint-pollingconsumer" href="#endpoint-pollingconsumer"></a>10.1.3&nbsp;Polling Consumer</h3></div></div></div>

<p>Spring Integration also provides a <code class="literal">PollingConsumer</code>, and it can be instantiated in the same way except that the channel must implement <code class="literal">PollableChannel</code>, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting">PollableChannel channel = context.getBean(<span class="hl-string">"pollableChannel"</span>, PollableChannel.<span class="hl-keyword">class</span>);

PollingConsumer consumer = <span class="hl-keyword">new</span> PollingConsumer(channel, exampleHandler);</pre>
</div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>For more information regarding polling consumers, see <a class="xref" href="#polling-consumer" title="6.2&nbsp;Poller">Section&nbsp;6.2, &#8220;Poller&#8221;</a> and <a class="xref" href="#channel-adapter" title="6.3&nbsp;Channel Adapter">Section&nbsp;6.3, &#8220;Channel Adapter&#8221;</a>.</p>
</td></tr></table></div>
<p>There are many other configuration options for the polling consumer.
For example, the trigger is a required property.
The following example shows how to set the trigger:</p>
<div class="informalexample">
<pre class="programlisting">PollingConsumer consumer = <span class="hl-keyword">new</span> PollingConsumer(channel, handler);

consumer.setTrigger(<span class="hl-keyword">new</span> IntervalTrigger(<span class="hl-number">30</span>, TimeUnit.SECONDS));</pre>
</div>
<p>Spring Integration currently provides two implementations of the <code class="literal">Trigger</code> interface: <code class="literal">IntervalTrigger</code> and <code class="literal">CronTrigger</code>.
The <code class="literal">IntervalTrigger</code> is typically defined with a simple interval (in milliseconds) but also supports an <code class="literal">initialDelay</code> property and a boolean <code class="literal">fixedRate</code> property (the default is <code class="literal">false</code>&#8201;&#8212;&#8201;that is, no fixed delay).
The following example sets both properties:</p>
<div class="informalexample">
<pre class="programlisting">IntervalTrigger trigger = <span class="hl-keyword">new</span> IntervalTrigger(<span class="hl-number">1000</span>);
trigger.setInitialDelay(<span class="hl-number">5000</span>);
trigger.setFixedRate(true);</pre>
</div>
<p>The result of the three settings in the preceding example is a trigger that waits five seconds and then triggers every second.</p>
<p>The <code class="literal">CronTrigger</code> requires a valid cron expression.
See the <a class="ulink" href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/scheduling/support/CronTrigger.html" target="_top">Javadoc</a> for details.
The following example sets a new <code class="literal">CronTrigger</code>:</p>
<div class="informalexample">
<pre class="programlisting">CronTrigger trigger = <span class="hl-keyword">new</span> CronTrigger(<span class="hl-string">"*/10 * * * * MON-FRI"</span>);</pre>
</div>
<p>The result of the trigger defined in the previous example is a trigger that triggers every ten seconds, Monday through Friday.</p>
<p>In addition to the trigger, you can specify two other polling-related configuration properties: <code class="literal">maxMessagesPerPoll</code> and <code class="literal">receiveTimeout</code>.
The following example shows how to set these two properties:</p>
<div class="informalexample">
<pre class="programlisting">PollingConsumer consumer = <span class="hl-keyword">new</span> PollingConsumer(channel, handler);

consumer.setMaxMessagesPerPoll(<span class="hl-number">10</span>);
consumer.setReceiveTimeout(<span class="hl-number">5000</span>);</pre>
</div>
<p>The <code class="literal">maxMessagesPerPoll</code> property specifies the maximum number of messages to receive within a given poll operation.
This means that the poller continues calling receive() without waiting, until either <code class="literal">null</code> is returned or the maximum value is reached.
For example, if a poller has a ten-second interval trigger and a <code class="literal">maxMessagesPerPoll</code> setting of <code class="literal">25</code>, and it is polling a channel that has 100 messages in its queue, all 100 messages can be retrieved within 40 seconds.
It grabs 25, waits ten seconds, grabs the next 25, and so on.</p>
<p>The <code class="literal">receiveTimeout</code> property specifies the amount of time the poller should wait if no messages are available when it invokes the receive operation.
For example, consider two options that seem similar on the surface but are actually quite different: The first has an interval trigger of 5 seconds and a receive timeout of 50 milliseconds, while the second has an interval trigger of 50 milliseconds and a receive timeout of 5 seconds.
The first one may receive a message up to 4950 milliseconds later than it arrived on the channel (if that message arrived immediately after one of its poll calls returned).
On the other hand, the second configuration never misses a message by more than 50 milliseconds.
The difference is that the second option requires a thread to wait. However, as a result, it can respond much more quickly to arriving messages.
This technique, known as "<code class="literal">long polling</code>", can be used to emulate event-driven behavior on a polled source.</p>
<p>A polling consumer can also delegate to a Spring <code class="literal">TaskExecutor</code>, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting">PollingConsumer consumer = <span class="hl-keyword">new</span> PollingConsumer(channel, handler);

TaskExecutor taskExecutor = context.getBean(<span class="hl-string">"exampleExecutor"</span>, TaskExecutor.<span class="hl-keyword">class</span>);
consumer.setTaskExecutor(taskExecutor);</pre>
</div>
<p>Furthermore, a <code class="literal">PollingConsumer</code> has a property called <code class="literal">adviceChain</code>.
This property lets you to specify a <code class="literal">List</code> of AOP advices for handling additional cross cutting concerns including transactions.
These advices are applied around the <code class="literal">doPoll()</code> method.
For more in-depth information, see the sections on AOP advice chains and transaction support under <a class="xref" href="#endpoint-namespace" title="10.1.4&nbsp;Endpoint Namespace Support">Section&nbsp;10.1.4, &#8220;Endpoint Namespace Support&#8221;</a>.</p>
<p>The earlier examples show dependency lookups.
However, keep in mind that these consumers are most often configured as Spring bean definitions.
In fact, Spring Integration also provides a <code class="literal">FactoryBean</code> called <code class="literal">ConsumerEndpointFactoryBean</code> that creates the appropriate consumer type based on the type of channel.
Also, Spring Integration has full XML namespace support to even further hide those details.
The namespace-based configuration is in this guide featured as each component type is introduced.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Many of the <code class="literal">MessageHandler</code> implementations can generate reply messages.
As mentioned earlier, sending messages is trivial when compared to receiving messages.
Nevertheless, when and how many reply messages are sent depends on the handler type.
For example, an aggregator waits for a number of messages to arrive and is often configured as a downstream consumer for a splitter, which can generate multiple replies for each message it handles.
When using the namespace configuration, you do not strictly need to know all of the details.
However, it still might be worth knowing that several of these components share a common base class, the <code class="literal">AbstractReplyProducingMessageHandler</code>, and that it provides a <code class="literal">setOutputChannel(..)</code> method.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="endpoint-namespace" href="#endpoint-namespace"></a>10.1.4&nbsp;Endpoint Namespace Support</h3></div></div></div>

<p>Throughout this reference manual, you can find specific configuration examples for endpoint elements, such as router, transformer, service-activator, and so on.
Most of these support an <code class="literal">input-channel</code> attribute and many support an <code class="literal">output-channel</code> attribute.
After being parsed, these endpoint elements produce an instance of either the <code class="literal">PollingConsumer</code> or the <code class="literal">EventDrivenConsumer</code>, depending on the type of the <code class="literal">input-channel</code> that is referenced: <code class="literal">PollableChannel</code> or <code class="literal">SubscribableChannel</code>, respectively.
When the channel is pollable, the polling behavior is based on the endpoint element&#8217;s <code class="literal">poller</code> sub-element and its attributes.</p>
<p>The following listing lists all of the available configuration options for a <code class="literal">poller</code>:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">cron</span>=<span class="hl-value">""</span>                                  <a name="CO12-1" href="#CO12-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
            default="false"                          <a name="CO12-2" href="#CO12-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
            error-channel=""                         <a name="CO12-3" href="#CO12-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
            fixed-delay=""                           <a name="CO12-4" href="#CO12-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
            fixed-rate=""                            <a name="CO12-5" href="#CO12-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
            id=""                                    <a name="CO12-6" href="#CO12-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>
            max-messages-per-poll=""                 <a name="CO12-7" href="#CO12-7"></a><span><img src="images/callouts/7.png" alt="7" border="0"></span>
            receive-timeout=""                       <a name="CO12-8" href="#CO12-8"></a><span><img src="images/callouts/8.png" alt="8" border="0"></span>
            ref=""                                   <a name="CO12-9" href="#CO12-9"></a><span><img src="images/callouts/9.png" alt="9" border="0"></span>
            task-executor=""                         <a name="CO12-10" href="#CO12-10"></a><span><img src="images/callouts/10.png" alt="10" border="0"></span>
            time-unit="MILLISECONDS"                 <a name="CO12-11" href="#CO12-11"></a><span><img src="images/callouts/11.png" alt="11" border="0"></span>
            trigger=""&gt;                              <a name="CO12-12" href="#CO12-12"></a><span><img src="images/callouts/12.png" alt="12" border="0"></span>
            <span class="hl-tag">&lt;int:advice-chain /&gt;</span>                     <a name="CO12-13" href="#CO12-13"></a><span><img src="images/callouts/13.png" alt="13" border="0"></span>
            <span class="hl-tag">&lt;int:transactional /&gt;</span>                    <a name="CO12-14" href="#CO12-14"></a><span><img src="images/callouts/14.png" alt="14" border="0"></span>
<span class="hl-tag">&lt;/int:poller&gt;</span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO12-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Provides the ability to configure pollers by using Cron expressions.
The underlying implementation uses an <code class="literal">org.springframework.scheduling.support.CronTrigger</code>.
If this attribute is set, none of the following attributes must be specified: <code class="literal">fixed-delay</code>, <code class="literal">trigger</code>, <code class="literal">fixed-rate</code>, and <code class="literal">ref</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO12-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>By setting this attribute to <code class="literal">true</code>, you can define exactly one global default poller.
An exception is raised if more than one default poller is defined in the application context.
Any endpoints connected to a <code class="literal">PollableChannel</code> (<code class="literal">PollingConsumer</code>) or any <code class="literal">SourcePollingChannelAdapter</code> that does not have an explicitly configured poller then uses the global default poller.
It defaults to <code class="literal">false</code>.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO12-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Identifies the channel to which error messages are sent if a failure occurs in this poller&#8217;s invocation.
To completely suppress exceptions, you can provide a reference to the <code class="literal">nullChannel</code>.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO12-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The fixed delay trigger uses a <code class="literal">PeriodicTrigger</code> under the covers.
If you do not use the <code class="literal">time-unit</code> attribute, the specified value is represented in milliseconds.
If this attribute is set, none of the following attributes must be specified: <code class="literal">fixed-rate</code>, <code class="literal">trigger</code>, <code class="literal">cron</code>, and <code class="literal">ref</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO12-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The fixed rate trigger uses a <code class="literal">PeriodicTrigger</code> under the covers.
If you do not use the <code class="literal">time-unit</code> attribute, the specified value is represented in milliseconds.
If this attribute is set, none of the following attributes must be specified: <code class="literal">fixed-delay</code>, <code class="literal">trigger</code>, <code class="literal">cron</code>, and <code class="literal">ref</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO12-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The ID referring to the poller&#8217;s underlying bean-definition, which is of type <code class="literal">org.springframework.integration.scheduling.PollerMetadata</code>.
The <code class="literal">id</code> attribute is required for a top-level poller element, unless it is the default poller (<code class="literal">default="true"</code>).</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO12-7"><span><img src="images/callouts/7.png" alt="7" border="0"></span></a> </p></td><td valign="top" align="left">
<p>See <a class="xref" href="#channel-adapter-namespace-inbound" title="6.3.1&nbsp;Configuring An Inbound Channel Adapter">Section&nbsp;6.3.1, &#8220;Configuring An Inbound Channel Adapter&#8221;</a> for more information.
If not specified, the default value depends on the context.
If you use a <code class="literal">PollingConsumer</code>, this attribute defaults to <code class="literal">-1</code>.
However, if you use a <code class="literal">SourcePollingChannelAdapter</code>, the <code class="literal">max-messages-per-poll</code> attribute defaults to <code class="literal">1</code>.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO12-8"><span><img src="images/callouts/8.png" alt="8" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Value is set on the underlying class <code class="literal">PollerMetadata</code>.
If not specified, it defaults to 1000 (milliseconds).
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO12-9"><span><img src="images/callouts/9.png" alt="9" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Bean reference to another top-level poller.
The <code class="literal">ref</code> attribute must not be present on the top-level <code class="literal">poller</code> element.
However, if this attribute is set, none of the following attributes must be specified: <code class="literal">fixed-rate</code>, <code class="literal">trigger</code>, <code class="literal">cron</code>, and <code class="literal">fixed-delay</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO12-10"><span><img src="images/callouts/10.png" alt="10" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Provides the ability to reference a custom task executor.
See <a class="xref" href="#taskexecutor-support" title="TaskExecutor Support">the section called &#8220;TaskExecutor Support&#8221;</a> for further information.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO12-11"><span><img src="images/callouts/11.png" alt="11" border="0"></span></a> </p></td><td valign="top" align="left">
<p>This attribute specifies the <code class="literal">java.util.concurrent.TimeUnit</code> enum value on the underlying <code class="literal">org.springframework.scheduling.support.PeriodicTrigger</code>.
Therefore, this attribute can be used only in combination with the <code class="literal">fixed-delay</code> or <code class="literal">fixed-rate</code> attributes.
If combined with either <code class="literal">cron</code> or a <code class="literal">trigger</code> reference attribute, it causes a failure.
The minimal supported granularity for a <code class="literal">PeriodicTrigger</code> is milliseconds.
Therefore, the only available options are milliseconds and seconds.
If this value is not provided, any <code class="literal">fixed-delay</code> or <code class="literal">fixed-rate</code> value is interpreted as milliseconds.
Basically, this enum provides a convenience for seconds-based interval trigger values.
For hourly, daily, and monthly settings, we recommend using a <code class="literal">cron</code> trigger instead.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO12-12"><span><img src="images/callouts/12.png" alt="12" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Reference to any Spring-configured bean that implements the <code class="literal">org.springframework.scheduling.Trigger</code> interface.
However, if this attribute is set, none of the following attributes must be specified: <code class="literal">fixed-delay</code>, <code class="literal">fixed-rate</code>, <code class="literal">cron</code>, and <code class="literal">ref</code>.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO12-13"><span><img src="images/callouts/13.png" alt="13" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Allows specifying extra AOP advices to handle additional cross-cutting concerns.
See <a class="xref" href="#transaction-support" title="Transaction Support">the section called &#8220;Transaction Support&#8221;</a> for further information.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO12-14"><span><img src="images/callouts/14.png" alt="14" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Pollers can be made transactional.
See <a class="xref" href="#aop-advice-chains" title="AOP Advice chains">the section called &#8220;AOP Advice chains&#8221;</a> for further information.
Optional.</p>
</td></tr></table></div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_examples" href="#_examples"></a>Examples</h4></div></div></div>

<p>A simple interval-based poller with a 1-second interval can be configured as follows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:transformer</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"pollable"</span>
    <span class="hl-attribute">ref</span>=<span class="hl-value">"transformer"</span>
    <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"1000"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:transformer&gt;</span></pre>
</div>
<p>As an alternative to using the <code class="literal">fixed-rate</code> attribute, you can also use the <code class="literal">fixed-delay</code> attribute.</p>
<p>For a poller based on a Cron expression, use the <code class="literal">cron</code> attribute instead, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:transformer</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"pollable"</span>
    <span class="hl-attribute">ref</span>=<span class="hl-value">"transformer"</span>
    <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">cron</span>=<span class="hl-value">"*/10 * * * * MON-FRI"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:transformer&gt;</span></pre>
</div>
<p>If the input channel is a <code class="literal">PollableChannel</code>, the poller configuration is required.
Specifically, as mentioned earlier, the <code class="literal">trigger</code> is a required property of the <code class="literal">PollingConsumer</code> class.
Therefore, if you omit the <code class="literal">poller</code> sub-element for a polling consumer endpoint&#8217;s configuration, an exception may be thrown.
The exception may also be thrown if you attempt to configure a poller on the element that is connected to a non-pollable channel.</p>
<p>It is also possible to create top-level pollers, in which case only a <code class="literal">ref</code> attribute is required, as the following example shows:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">id</span>=<span class="hl-value">"weekdayPoller"</span> <span class="hl-attribute">cron</span>=<span class="hl-value">"*/10 * * * * MON-FRI"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int:transformer</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"pollable"</span>
    <span class="hl-attribute">ref</span>=<span class="hl-value">"transformer"</span>
    <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"weekdayPoller"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:transformer&gt;</span></pre>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The <code class="literal">ref</code> attribute is allowed only on the inner poller definitions.
Defining this attribute on a top-level poller results in a configuration exception being thrown during initialization of the application context.</p>
</td></tr></table></div>
<div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="_global_default_pollers" href="#_global_default_pollers"></a>Global Default Pollers</h5></div></div></div>

<p>To simplify the configuration even further, you can define a global default poller.
A single top-level poller within an <code class="literal">ApplicationContext</code> may have the <code class="literal">default</code> attribute set to <code class="literal">true</code>.
In that case, any endpoint with a <code class="literal">PollableChannel</code> for its input channel, that is defined within the same <code class="literal">ApplicationContext</code>, and has no explicitly configured <code class="literal">poller</code> sub-element uses that default.
The following example shows such a poller and a transformer that uses it:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">id</span>=<span class="hl-value">"defaultPoller"</span> <span class="hl-attribute">default</span>=<span class="hl-value">"true"</span> <span class="hl-attribute">max-messages-per-poll</span>=<span class="hl-value">"5"</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"3000"</span><span class="hl-tag">/&gt;</span>

<span class="hl-comment">&lt;!-- No &lt;poller/&gt; sub-element is necessary, because there is a default --&gt;</span>
<span class="hl-tag">&lt;int:transformer</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"pollable"</span>
                 <span class="hl-attribute">ref</span>=<span class="hl-value">"transformer"</span>
                 <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="transaction-support" href="#transaction-support"></a>Transaction Support</h5></div></div></div>

<p>Spring Integration also provides transaction support for the pollers so that each receive-and-forward operation can be performed as an atomic unit of work.
To configure transactions for a poller, add the <code class="literal">&lt;transactional/&gt;</code> sub-element.
The following example shows the available attributes:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">fixed-delay</span>=<span class="hl-value">"1000"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:transactional</span> <span class="hl-attribute">transaction-manager</span>=<span class="hl-value">"txManager"</span>
                       <span class="hl-attribute">propagation</span>=<span class="hl-value">"REQUIRED"</span>
                       <span class="hl-attribute">isolation</span>=<span class="hl-value">"REPEATABLE_READ"</span>
                       <span class="hl-attribute">timeout</span>=<span class="hl-value">"10000"</span>
                       <span class="hl-attribute">read-only</span>=<span class="hl-value">"false"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:poller&gt;</span></pre>
<p>For more information, see <a class="xref" href="#transaction-poller" title="C.1.1&nbsp;Poller Transaction Support">Section&nbsp;C.1.1, &#8220;Poller Transaction Support&#8221;</a>.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="aop-advice-chains" href="#aop-advice-chains"></a>AOP Advice chains</h4></div></div></div>

<p>Since Spring transaction support depends on the proxy mechanism with <code class="literal">TransactionInterceptor</code> (AOP Advice) handling transactional behavior of the message flow initiated by the poller, you must sometimes provide extra advices to handle other cross cutting behavior associated with the poller.
For that, the <code class="literal">poller</code> defines an <code class="literal">advice-chain</code>&nbsp;element that lets you add more advices in a class that&nbsp;implements the <code class="literal">MethodInterceptor</code> interface.
The following example shows how to define an <code class="literal">advice-chain</code> for a <code class="literal">poller</code>:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:service-activator</span> <span class="hl-attribute">id</span>=<span class="hl-value">"advicedSa"</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"goodInputWithAdvice"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"testBean"</span>
		<span class="hl-attribute">method</span>=<span class="hl-value">"good"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span><span class="hl-tag">&gt;</span>
	<span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">max-messages-per-poll</span>=<span class="hl-value">"1"</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"10000"</span><span class="hl-tag">&gt;</span>
		 <span class="hl-tag">&lt;int:advice-chain&gt;</span>
			<span class="hl-tag">&lt;ref</span> <span class="hl-attribute">bean</span>=<span class="hl-value">"adviceA"</span><span class="hl-tag"> /&gt;</span>
			<span class="hl-tag">&lt;beans:bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.something.SampleAdvice"</span><span class="hl-tag"> /&gt;</span>
			<span class="hl-tag">&lt;ref</span> <span class="hl-attribute">bean</span>=<span class="hl-value">"txAdvice"</span><span class="hl-tag"> /&gt;</span>
		<span class="hl-tag">&lt;/int:advice-chain&gt;</span>
	<span class="hl-tag">&lt;/int:poller&gt;</span>
<span class="hl-tag">&lt;/int:service-activator&gt;</span></pre>
</div>
<p>For more information on how to implement the <code class="literal">MethodInterceptor</code> interface, see the <a class="ulink" href="https://docs.spring.io/spring/docs/current/spring-framework-reference/core.html#aop-api" target="_top">AOP sections of the Spring Framework Reference Guide</a>.
An advice chain can also be applied on a poller that does not have any transaction configuration, letting you enhance the behavior of the message flow initiated by the poller.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>When using an advice chain, the <code class="literal">&lt;transactional/&gt;</code> child element cannot be specified.
Instead, declare a <code class="literal">&lt;tx:advice/&gt;</code> bean and add it to the <code class="literal">&lt;advice-chain/&gt;</code>.
See <a class="xref" href="#transaction-poller" title="C.1.1&nbsp;Poller Transaction Support">Section&nbsp;C.1.1, &#8220;Poller Transaction Support&#8221;</a> for complete configuration details.</p>
</td></tr></table></div>
<div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="taskexecutor-support" href="#taskexecutor-support"></a>TaskExecutor Support</h5></div></div></div>

<p>The polling threads may be executed by any instance of Spring&#8217;s <code class="literal">TaskExecutor</code> abstraction.
This enables concurrency for an endpoint or group of endpoints.
As of Spring 3.0, the core Spring Framework has a <code class="literal">task</code> namespace, and its <code class="literal">&lt;executor/&gt;</code> element supports the creation of a simple thread pool executor.
That element accepts attributes for common concurrency settings, such as pool-size and queue-capacity.
Configuring a thread-pooling executor can make a substantial difference in how the endpoint performs under load.
These settings are available for each endpoint, since the performance of an endpoint is one of the major factors to consider (the other major factor being the expected volume on the channel to which the endpoint subscribes).
To enable concurrency for a polling endpoint that is configured with the XML namespace support, provide the <code class="literal">task-executor</code> reference on its <code class="literal">&lt;poller/&gt;</code> element and then provide one or more of the properties shown in the following example:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">task-executor</span>=<span class="hl-value">"pool"</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"1000"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;task:executor</span> <span class="hl-attribute">id</span>=<span class="hl-value">"pool"</span>
               <span class="hl-attribute">pool-size</span>=<span class="hl-value">"5-25"</span>
               <span class="hl-attribute">queue-capacity</span>=<span class="hl-value">"20"</span>
               <span class="hl-attribute">keep-alive</span>=<span class="hl-value">"120"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>If you do not provide a task-executor, the consumer&#8217;s handler is invoked in the caller&#8217;s thread.
Note that the caller is usually the default <code class="literal">TaskScheduler</code> (see <a class="xref" href="#namespace-taskscheduler" title="E.2&nbsp;Configuring the Task Scheduler">Section&nbsp;E.2, &#8220;Configuring the Task Scheduler&#8221;</a>).
You should also keep in mind that the <code class="literal">task-executor</code> attribute can provide a reference to any implementation of Spring&#8217;s <code class="literal">TaskExecutor</code> interface by specifying the bean name.
The <code class="literal">executor</code> element shown earlier is provided for convenience.</p>
<p>As mentioned earlier in the <a class="link" href="#endpoint-pollingconsumer" title="10.1.3&nbsp;Polling Consumer">background section for polling consumers</a>, you can also configure a polling consumer in such a way as to emulate event-driven behavior.
With a long <code class="literal">receive-timeout</code> and a short <code class="literal">interval-trigger</code>, you can ensure a very timely reaction to arriving messages even on a polled message source.
Note that this applies only  to sources that have a blocking wait call with a timeout.
For example, the file poller does not block.
Each receive() call returns immediately and either contains new files or not.
Therefore, even if a poller contains a long <code class="literal">receive-timeout</code>, that value would never be used in such a scenario.
On the other hand, when using Spring Integration&#8217;s own queue-based channels, the timeout value does have a chance to participate.
The following example shows how a polling consumer can receive messages nearly instantaneously:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:service-activator</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"someQueueChannel"</span>
    <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">receive-timeout</span>=<span class="hl-value">"30000"</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"10"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;/int:service-activator&gt;</span></pre>
</div>
<p>Using this approach does not carry much overhead, since, internally, it is nothing more then a timed-wait thread, which does not require nearly as much CPU resource usage as (for example) a thrashing, infinite while loop.</p>
</div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="polling-consumer-change-polling-rate" href="#polling-consumer-change-polling-rate"></a>10.1.5&nbsp;Changing Polling Rate at Runtime</h3></div></div></div>

<p>When configuring a poller with a <code class="literal">fixed-delay</code> or a <code class="literal">fixed-rate</code> attribute, the default implementation uses a <code class="literal">PeriodicTrigger</code> instance.
The <code class="literal">PeriodicTrigger</code> is part of the core Spring Framework.
It accepts the interval only as a constructor argument.
Therefore, it cannot be changed at runtime.</p>
<p>However, you can define your own implementation of the <code class="literal">org.springframework.scheduling.Trigger</code> interface.
You could even use the <code class="literal">PeriodicTrigger</code> as a starting point.
Then you can add a setter for the interval (period), or you can even embed your own throttling logic within the trigger itself.
The <code class="literal">period</code> property is used with each call to <code class="literal">nextExecutionTime</code> to schedule the next poll.
To use this custom trigger within pollers, declare the bean definition of the custom trigger in your application context and inject the dependency into your poller configuration by using the <code class="literal">trigger</code> attribute, which references the custom trigger bean instance.
You can now obtain a reference to the trigger bean and change the polling interval between polls.</p>
<p>For an example, see the <a class="ulink" href="https://github.com/SpringSource/spring-integration-samples/tree/master/intermediate" target="_top">Spring Integration Samples</a> project.
It contains a sample called <code class="literal">dynamic-poller</code>, which uses a custom trigger and demonstrates the ability to change the polling interval at runtime.</p>
<p>The sample provides a custom trigger that implements the <a class="ulink" href="http://static.springsource.org/spring/docs/current/javadoc-api/org/springframework/scheduling/Trigger.html" target="_top"><code class="literal">org.springframework.scheduling.Trigger</code></a> interface.
The sample&#8217;s trigger is based on Spring&#8217;s <a class="ulink" href="http://static.springsource.org/spring/docs/current/javadoc-api/org/springframework/scheduling/support/PeriodicTrigger.html" target="_top"><code class="literal">PeriodicTrigger</code></a> implementation.
However, the fields of the custom trigger are not final, and the properties have explicit getters and setters, letting you dynamically change the polling period at runtime.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>It is important to note, though, that because the Trigger method is <code class="literal">nextExecutionTime()</code>, any changes to a dynamic trigger do not take effect until the next poll, based on the existing configuration.
It is not possible to force a trigger to fire before its currently configured next execution time.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="payload-type-conversion" href="#payload-type-conversion"></a>10.1.6&nbsp;Payload Type Conversion</h3></div></div></div>

<p>Throughout this reference manual, you can also see specific configuration and implementation examples of various endpoints that accept a message or&nbsp;any arbitrary <code class="literal">Object</code> as an input parameter.
In the case of an <code class="literal">Object</code>, such a parameter is mapped to&nbsp;a message payload or part of the payload or header (when using the Spring Expression Language).
However, the type of input parameter of the endpoint method sometimes does not match the type of the payload or its part.
In this scenario, we need to perform type conversion.
Spring Integration provides a convenient way for registering type converters (by using the Spring <code class="literal">ConversionService</code>) within its own instance of a conversion service bean named <code class="literal">integrationConversionService</code>.
That bean is automatically created as soon as the first converter is defined by using the Spring Integration infrastructure.
To register a converter, you can implement <code class="literal">org.springframework.core.convert.converter.Converter</code>, <code class="literal">org.springframework.core.convert.converter.GenericConverter</code>, or <code class="literal">org.springframework.core.convert.converter.ConverterFactory</code>.</p>
<p>The <code class="literal">Converter</code> implementation is the simplest and converts from a single type to another.
For more sophistication, such as converting to a class hierarchy, you can implement a <code class="literal">GenericConverter</code> and possibly a <code class="literal">ConditionalConverter</code>.
These give you complete access to the <code class="literal">from</code> and <code class="literal">to</code> type descriptors, enabling complex conversions.
For example, if you have an abstract class called <code class="literal">Something</code> that is the target of your conversion (parameter type, channel data type, and so on), you have two concrete implementations called <code class="literal">Thing1</code> and <code class="literal">Thing</code>, and you wish to convert to one or the other based on the input type, the <code class="literal">GenericConverter</code> would be a good fit.
For more information, see the Javadoc for these interfaces:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="ulink" href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/core/convert/converter/Converter.html" target="_top">org.springframework.core.convert.converter.Converter</a>
</li><li class="listitem">
<a class="ulink" href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/core/convert/converter/package-summary.html" target="_top">org.springframework.core.convert.converter.GenericConverter</a>
</li><li class="listitem">
<a class="ulink" href="https://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/core/convert/converter/ConverterFactory.html" target="_top">org.springframework.core.convert.converter.ConverterFactory</a>
</li></ul></div>
<p>When you have implemented your converter, you can register it with convenient namespace support, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:converter</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"sampleConverter"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"sampleConverter"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"foo.bar.TestConverter"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>Alternately, you can use an inner bean, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:converter&gt;</span>
    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.config.xml.ConverterParserTests$TestConverter3"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:converter&gt;</span></pre>
</div>
<p>Starting with Spring Integration 4.0, you can use annotations to create the preceding configuration, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Component</span></em>
<em><span class="hl-annotation" style="color: gray">@IntegrationConverter</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> TestConverter <span class="hl-keyword">implements</span> Converter&lt;Boolean, Number&gt; {

	<span class="hl-keyword">public</span> Number convert(Boolean source) {
		<span class="hl-keyword">return</span> source ? <span class="hl-number">1</span> : <span class="hl-number">0</span>;
	}

}</pre>
</div>
<p>Alternately, you can use the <code class="literal">@Configuration</code> annotation, as the following example shows:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Configuration</span></em>
<em><span class="hl-annotation" style="color: gray">@EnableIntegration</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ContextConfiguration {

	<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
	<em><span class="hl-annotation" style="color: gray">@IntegrationConverter</span></em>
	<span class="hl-keyword">public</span> SerializingConverter serializingConverter() {
		<span class="hl-keyword">return</span> <span class="hl-keyword">new</span> SerializingConverter();
	}

}</pre>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>When configuring an application context, the Spring Framework lets you add a <code class="literal">conversionService</code> bean (see <a class="ulink" href="http://static.springsource.org/spring/docs/current/spring-framework-reference/html/validation.html#core-convert-Spring-config" target="_top">Configuring a ConversionService</a> chapter).
This service is used, when needed, to perform appropriate conversions during bean creation and configuration.</p>
<p>In contrast, the <code class="literal">integrationConversionService</code> is used for runtime conversions.
These uses are quite different.
Converters that are intended for use when wiring bean constructor arguments and properties may produce unintended results if used at runtime for Spring Integration expression evaluation against messages within data type channels, payload type transformers, and so on.</p>
<p>However, if you do want to use the Spring <code class="literal">conversionService</code> as the Spring Integration <code class="literal">integrationConversionService</code>, you can configure an alias in the application context, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;alias</span> <span class="hl-attribute">name</span>=<span class="hl-value">"conversionService"</span> <span class="hl-attribute">alias</span>=<span class="hl-value">"integrationConversionService"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>In this case, the converters provided by the <code class="literal">conversionService</code> are available for Spring Integration runtime conversion.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="content-type-conversion" href="#content-type-conversion"></a>10.1.7&nbsp;Content Type Conversion</h3></div></div></div>

<p>Starting with version 5.0, by default, the method invocation mechanism is based on the <code class="literal">org.springframework.messaging.handler.invocation.InvocableHandlerMethod</code> infrastructure.
Its <code class="literal">HandlerMethodArgumentResolver</code> implementations (such as <code class="literal">PayloadArgumentResolver</code> and <code class="literal">MessageMethodArgumentResolver</code>) can use the <code class="literal">MessageConverter</code> abstraction to convert an incoming <code class="literal">payload</code> to the target method argument type.
The conversion can be based on the <code class="literal">contentType</code> message header.
For this purpose, Spring Integration provides the <code class="literal">ConfigurableCompositeMessageConverter</code>, which delegates to a list of registered converters to be invoked until one of them returns a non-null result.
By default, this converter provides (in strict order):</p>
<div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
<a class="ulink" href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/jms/support/converter/MappingJackson2MessageConverter.html" target="_top"><code class="literal">MappingJackson2MessageConverter</code></a> if the Jackson processor is present on the classpath
</li><li class="listitem">
<a class="ulink" href="https://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/messaging/converter/ByteArrayMessageConverter.html" target="_top"><code class="literal">ByteArrayMessageConverter</code></a>
</li><li class="listitem">
<a class="ulink" href="https://docs.spring.io/spring-integration/docs/current/api//org/springframework/integration/support/converter/ObjectStringMessageConverter.html" target="_top"><code class="literal">ObjectStringMessageConverter</code></a>
</li><li class="listitem">
<a class="ulink" href="https://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/messaging/converter/GenericMessageConverter.html" target="_top"><code class="literal">GenericMessageConverter</code></a>
</li></ol></div>
<p>See the Javadoc (linked in the preceding list) for more information about their purpose and appropriate <code class="literal">contentType</code> values for conversion.
The <code class="literal">ConfigurableCompositeMessageConverter</code> is used because it can be be supplied with any other <code class="literal">MessageConverter</code> implementations, including or excluding the previously mentioned default converters.
It can also be registered as an appropriate bean in the application context, overriding the default converter, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean(name = IntegrationContextUtils.ARGUMENT_RESOLVER_MESSAGE_CONVERTER_BEAN_NAME)</span></em>
<span class="hl-keyword">public</span> ConfigurableCompositeMessageConverter compositeMessageConverter() {
    List&lt;MessageConverter&gt; converters =
        Arrays.asList(<span class="hl-keyword">new</span> MarshallingMessageConverter(jaxb2Marshaller()),
                 <span class="hl-keyword">new</span> JavaSerializationMessageConverter());
    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> ConfigurableCompositeMessageConverter(converters);
}</pre>
</div>
<p>Those two new converters are registered in the composite before the defaults.
You can also not use a <code class="literal">ConfigurableCompositeMessageConverter</code> but provide your own <code class="literal">MessageConverter</code> by registering a bean with the name, <code class="literal">integrationArgumentResolverMessageConverter</code> (by setting the <code class="literal">IntegrationContextUtils.ARGUMENT_RESOLVER_MESSAGE_CONVERTER_BEAN_NAME</code> property).</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The <code class="literal">MessageConverter</code>-based (including <code class="literal">contentType</code> header) conversion is not available when using SpEL method invocation.
In this case, only the regular class-to-class conversion mentioned above in the <a class="xref" href="#payload-type-conversion" title="10.1.6&nbsp;Payload Type Conversion">Section&nbsp;10.1.6, &#8220;Payload Type Conversion&#8221;</a> is available.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="async-polling" href="#async-polling"></a>10.1.8&nbsp;Asynchronous Polling</h3></div></div></div>

<p>If you want the polling to be asynchronous, a poller can optionally specify a <code class="literal">task-executor</code> attribute that points to an existing instance of any <code class="literal">TaskExecutor</code> bean (Spring 3.0 provides a convenient namespace configuration through the <code class="literal">task</code> namespace).
However, there are certain things you must understand when configuring a poller with a <code class="literal">TaskExecutor</code>.&nbsp;</p>
<p>The problem is that there are two configurations in place, the poller and the <code class="literal">TaskExecutor</code>.
They must be in tune&nbsp;with each other.
Otherwise, you might end up creating an artificial memory leak.</p>
<p>Consider the following configuration:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"publishChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:queue /&gt;</span>
<span class="hl-tag">&lt;/int:channel&gt;</span>

<span class="hl-tag">&lt;int:service-activator</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"publishChannel"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"myService"</span><span class="hl-tag">&gt;</span>
	<span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">receive-timeout</span>=<span class="hl-value">"5000"</span><span class="hl-attribute">&nbsp;task-executor</span>=<span class="hl-value">"taskExecutor"</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"50"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/int:service-activator&gt;</span>

<span class="hl-tag">&lt;task:executor</span> <span class="hl-attribute">id</span>=<span class="hl-value">"taskExecutor"</span> <span class="hl-attribute">pool-size</span>=<span class="hl-value">"20"</span><span class="hl-tag"> /&gt;</span></pre>
</div>
<p>The preceding configuration demonstrates an out-of-tune configuration.</p>
<p>By default, the task executor has an unbounded task queue.
The poller keeps scheduling new tasks even though all the threads are blocked, waiting for either a new message to arrive or the timeout to expire.
Given that there are 20 threads executing tasks with a five-second timeout, they aree executed at a rate of 4 per second.
However, new tasks are being scheduled at a rate of 20 per second, so the internal queue in the task executor grows at a rate of 16 per second (while the process is idle), so we have a memory leak.</p>
<p>One of the ways to handle this is to set the <code class="literal">queue-capacity</code> attribute of the task executor.
Even 0 is a reasonable value.
You can also manage it by specifying what to do with messages that can not be queued by setting the <code class="literal">rejection-policy</code> attribute of the Task Executor (for example, to <code class="literal">DISCARD</code>).
In other words, there are certain details you must understand when configuring <code class="literal">TaskExecutor</code>.
See <a class="ulink" href="http://docs.spring.io/spring/docs/current/spring-framework-reference/html/scheduling.html" target="_top">"<code class="literal">Task Execution and Scheduling</code>"</a> in the Spring reference manual for more detail on the subject.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="endpoint-inner" href="#endpoint-inner"></a>10.1.9&nbsp;Endpoint Inner Beans</h3></div></div></div>

<p>Many endpoints are composite beans.
This includes all consumers and all polled inbound channel adapters.
Consumers (polled or event-driven) delegate to a <code class="literal">MessageHandler</code>.
Polled adapters obtain messages by delegating to a <code class="literal">MessageSource</code>.
Often, it is useful to obtain a reference to the delegate bean, perhaps to change configuration at runtime or for testing.
These beans can be obtained from the <code class="literal">ApplicationContext</code> with well known names.
<code class="literal">MessageHandler</code> instances are registered with the application context with bean IDs similar to <code class="literal">someConsumer.handler</code> (where <span class="emphasis"><em>consumer</em></span> is the value of the endpoint&#8217;s <code class="literal">id</code> attribute).
<code class="literal">MessageSource</code> instances are registered with bean IDs similar to <code class="literal">somePolledAdapter.source</code>, where <span class="emphasis"><em>somePolledAdapter</em></span> is the ID of the adapter.</p>
<p>The preceding only applies to the framework component itself.
You can instead use an inner bean definition, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:service-activator</span> <span class="hl-attribute">id</span>=<span class="hl-value">"exampleServiceActivator"</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"inChannel"</span>
            <span class="hl-attribute">output-channel</span> = <span class="hl-value">"outChannel"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"foo"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;beans:bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.foo.ExampleServiceActivator"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:service-activator&gt;</span></pre>
</div>
<p>The bean is treated like any inner bean declared and is not registered with the application context.
If you wish to access this bean in some other manner, declare it at the top level with an <code class="literal">id</code> and use the <code class="literal">ref</code> attribute instead.
See the <a class="ulink" href="http://docs.spring.io/spring-framework/docs/current/spring-framework-reference/html/beans.html#beans-inner-beans" target="_top">Spring Documentation</a> for more information.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="endpoint-roles" href="#endpoint-roles"></a>10.2&nbsp;Endpoint Roles</h2></div></div></div>

<p>Starting with version 4.2, endpoints can be assigned to roles.
Roles let endpoints be started and stopped as a group.
This is particularly useful when using leadership election, where a set of endpoints can be started or stopped when leadership is granted or revoked, respectively.
For this purpose the framework registers a <code class="literal">SmartLifecycleRoleController</code> bean in the application context with the name <code class="literal">IntegrationContextUtils.INTEGRATION_LIFECYCLE_ROLE_CONTROLLER</code>.
Whenever it is necessary to control lifecycles, this bean can be injected or <code class="literal">@Autowired</code>:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.some.project.SomeLifecycleControl"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"roleController"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"integrationLifecycleRoleController"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
</div>
<p>You can assign endpoints to roles using XML, Java configuration, or programmatically.
The following example shows how to configure endpoint roles with XML:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"ica"</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"someChannel"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"'foo'"</span> <span class="hl-attribute">role</span>=<span class="hl-value">"cluster"</span>
        <span class="hl-attribute">auto-startup</span>=<span class="hl-value">"false"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"60000"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/int:inbound-channel-adapter&gt;</span></pre>
</div>
<p>The following example shows how to configure endpoint roles for a bean created in Java:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "sendAsyncChannel", autoStartup="false")</span></em>
<em><span class="hl-annotation" style="color: gray">@Role("cluster")</span></em>
<span class="hl-keyword">public</span> MessageHandler sendAsyncHandler() {
    <span class="hl-keyword">return</span> <span class="hl-comment">// some MessageHandler</span>
}</pre>
</div>
<p>The following example shows how to configure endpoint roles on a method in Java:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Payload("#args[0].toLowerCase()")</span></em>
<em><span class="hl-annotation" style="color: gray">@Role("cluster")</span></em>
<span class="hl-keyword">public</span> String handle(String payload) {
    <span class="hl-keyword">return</span> payload.toUpperCase();
}</pre>
</div>
<p>The following example shows how to configure endpoint roles by using the <code class="literal">SmartLifecycleRoleController</code> in Java:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Autowired</span></em>
<span class="hl-keyword">private</span> SmartLifecycleRoleController roleController;
...
    <span class="hl-keyword">this</span>.roleController.addSmartLifeCycleToRole(<span class="hl-string">"cluster"</span>, someEndpoint);
...</pre>
</div>
<p>The following example shows how to configure endpoint roles by using an <code class="literal">IntegrationFlow</code> in Java:</p>
<div class="informalexample">
<pre class="programlisting">IntegrationFlow flow -&gt; flow
        .handle(..., e -&gt; e.role(<span class="hl-string">"cluster"</span>));</pre>
</div>
<p>Each of these adds the endpoint to the <code class="literal">cluster</code> role.</p>
<p>Invoking <code class="literal">roleController.startLifecyclesInRole("cluster")</code> and the corresponding <code class="literal">stop...</code> method starts and stops the endpoints.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Any object that implements <code class="literal">SmartLifecycle</code> can be programmatically added&#8201;&#8212;&#8201;not just endpoints.</p>
</td></tr></table></div>
<p>The <code class="literal">SmartLifecycleRoleController</code> implements <code class="literal">ApplicationListener&lt;AbstractLeaderEvent&gt;</code> and it automatically starts and stops its configured <code class="literal">SmartLifecycle</code> objects when leadership is granted or revoked (when some bean publishes <code class="literal">OnGrantedEvent</code> or <code class="literal">OnRevokedEvent</code>, respectively).</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>When using leadership election to start and stop components, it is important to set the <code class="literal">auto-startup</code> XML attribute (<code class="literal">autoStartup</code> bean property) to <code class="literal">false</code> so that the application context does not start the components during context initialization.</p>
</td></tr></table></div>
<p>Starting with version 4.3.8, the <code class="literal">SmartLifecycleRoleController</code> provides several status methods:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> Collection&lt;String&gt; getRoles() <a name="CO13-1" href="#CO13-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>

<span class="hl-keyword">public</span> <span class="hl-keyword">boolean</span> allEndpointsRunning(String role) <a name="CO13-2" href="#CO13-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>

<span class="hl-keyword">public</span> <span class="hl-keyword">boolean</span> noEndpointsRunning(String role) <a name="CO13-3" href="#CO13-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>

<span class="hl-keyword">public</span> Map&lt;String, Boolean&gt; getEndpointsRunningStatus(String role) <a name="CO13-4" href="#CO13-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span></pre>
</div>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO13-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Returns a list of the roles being managed.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO13-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Returns <code class="literal">true</code> if all endpoints in the role are running.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO13-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Returns <code class="literal">true</code> if none of the endpoints in the role are running.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO13-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Returns a map of <code class="literal">component name : running status</code>. The component name is usually the bean name.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="leadership-event-handling" href="#leadership-event-handling"></a>10.3&nbsp;Leadership Event Handling</h2></div></div></div>

<p>Groups of endpoints can be started and stopped based on leadership being granted or revoked, respectively.
This is useful in clustered scenarios where shared resources must be consumed by only a single instance.
An example of this is a file inbound channel adapter that is polling a shared directory.
(See <a class="xref" href="#file-reading" title="17.1&nbsp;Reading Files">Section&nbsp;17.1, &#8220;Reading Files&#8221;</a>).</p>
<p>To participate in a leader election and be notified when elected leader, when leadership is revoked, or on failure to acquire the resources to become leader, an application creates a component in the application context called a "<code class="literal">leader initiator</code>".
Normally, a leader initiator is a <code class="literal">SmartLifecycle</code>, so it starts (optionally) when the context starts and then publishes notifications when leadership changes.
You can also receive failure notifications by setting the <code class="literal">publishFailedEvents</code> to <code class="literal">true</code> (starting with version 5.0), for cases when you want take a specific action if a failure occurs.
By convention, you should provide a <code class="literal">Candidate</code> that receives the callbacks.
You can also revoke the leadership through a <code class="literal">Context</code> object provided by the framework.
Your code can also listen for <code class="literal">o.s.i.leader.event.AbstractLeaderEvent</code> instances (the super class of <code class="literal">OnGrantedEvent</code> and <code class="literal">OnRevokedEvent</code>) and respond accordingly (for instance, by using a <code class="literal">SmartLifecycleRoleController</code>).
The events contain a reference to the <code class="literal">Context</code> object.
The following listing shows the definition of the <code class="literal">Context</code> interface:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> Context {

	<span class="hl-keyword">boolean</span> isLeader();

	<span class="hl-keyword">void</span> yield();

	String getRole();

}</pre>
</div>
<p>Starting with version 5.0.6, the context provides a reference to the candidate&#8217;s role.</p>
<p>Spring Integration provides a basic implementation of a leader initiator that is based on the <code class="literal">LockRegistry</code> abstraction.
To use it, you need to create an instance as a bean, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> LockRegistryLeaderInitiator leaderInitiator(LockRegistry locks) {
    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> LockRegistryLeaderInitiator(locks);
}</pre>
</div>
<p>If the lock registry is implemented correctly, there is only ever at most one leader.
If the lock registry also provides locks that throw exceptions (ideally, <code class="literal">InterruptedException</code>) when they expire or are broken, the duration of the leaderless periods can be as short as is allowed by the inherent latency in the lock implementation.
By default, the <code class="literal">busyWaitMillis</code> property adds some additional latency to prevent CPU starvation in the (more usual) case that the locks are imperfect and you only know they expired when you try to obtain one again.</p>
<p>See <a class="xref" href="#zk-leadership" title="40.3&nbsp;Zookeeper Leadership Event Handling">Section&nbsp;40.3, &#8220;Zookeeper Leadership Event Handling&#8221;</a> for more information about leadership election and events that use Zookeeper.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="gateway" href="#gateway"></a>10.4&nbsp;Messaging Gateways</h2></div></div></div>

<p>A gateway hides the messaging API provided by Spring Integration.
It lets your application&#8217;s business logic be unaware of the Spring Integration API.
By using a generic Gateway, your code interacts with only a simple interface.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="gateway-proxy" href="#gateway-proxy"></a>10.4.1&nbsp;Enter the <code class="literal">GatewayProxyFactoryBean</code></h3></div></div></div>

<p>As mentioned earlier, it would be great to have no dependency on the Spring Integration API&#8201;&#8212;&#8201;including the gateway class.
For that reason, Spring Integration provides the <code class="literal">GatewayProxyFactoryBean</code>, which generates a proxy for any interface and internally invokes the gateway methods shown below.
By using dependency injection, you can then expose the interface to your business methods.</p>
<p>The following example shows an interface that can be used to interact with Spring Integration:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">package</span> org.cafeteria;

<span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> Cafe {

    <span class="hl-keyword">void</span> placeOrder(Order order);

}</pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="gateway-namespace" href="#gateway-namespace"></a>10.4.2&nbsp;Gateway XML Namespace Support</h3></div></div></div>

<p>Namespace support is also provided.
It lets you configure an interface as a service, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:gateway</span> <span class="hl-attribute">id</span>=<span class="hl-value">"cafeService"</span>
         <span class="hl-attribute">service-interface</span>=<span class="hl-value">"org.cafeteria.Cafe"</span>
         <span class="hl-attribute">default-request-channel</span>=<span class="hl-value">"requestChannel"</span>
         <span class="hl-attribute">default-reply-timeout</span>=<span class="hl-value">"10000"</span>
         <span class="hl-attribute">default-reply-channel</span>=<span class="hl-value">"replyChannel"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>With this configuration defined, the <code class="literal">cafeService</code> can now be injected into other beans, and the code that invokes the methods on that proxied instance of the <code class="literal">Cafe</code> interface has no awareness of the Spring Integration API.
The general approach is similar to that of Spring Remoting (RMI, HttpInvoker, and so on).
See the <a class="link" href="#samples" title="Appendix&nbsp;G.&nbsp;Spring Integration Samples">"<code class="literal">Samples</code>"</a> Appendix for an example that uses the <code class="literal">gateway</code> element (in the Cafe demo).</p>
<p>The defaults in the preceding configuration are applied to all methods on the gateway interface.
If a reply timeout is not specified, the calling thread waits indefinitely for a reply.
See <a class="xref" href="#gateway-no-response" title="10.4.11&nbsp;Gateway Behavior When No response Arrives">Section&nbsp;10.4.11, &#8220;Gateway Behavior When No response Arrives&#8221;</a>.</p>
<p>The defaults can be overridden for individual methods.
See <a class="xref" href="#gateway-configuration-annotations" title="10.4.4&nbsp;Gateway Configuration with Annotations and XML">Section&nbsp;10.4.4, &#8220;Gateway Configuration with Annotations and XML&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="gateway-default-reply-channel" href="#gateway-default-reply-channel"></a>10.4.3&nbsp;Setting the Default Reply Channel</h3></div></div></div>

<p>Typically, you need not specify the <code class="literal">default-reply-channel</code>, since a Gateway auto-creates a temporary, anonymous reply channel, where it listens for the reply.
However, some cases may prompt you to define a <code class="literal">default-reply-channel</code> (or <code class="literal">reply-channel</code> with adapter gateways, such as HTTP, JMS, and others).</p>
<p>For some background, we briefly discuss some of the inner workings of the gateway.
A gateway creates a temporary point-to-point reply channel.
It is anonymous and is added to the message headers with the name, <code class="literal">replyChannel</code>.
When providing an explicit <code class="literal">default-reply-channel</code> (<code class="literal">reply-channel</code> with remote adapter gateways), you can point to a publish-subscribe channel, which is so named because you can add more than one subscriber to it.
Internally, Spring Integration creates a bridge between the temporary <code class="literal">replyChannel</code> and the explicitly defined <code class="literal">default-reply-channel</code>.</p>
<p>Suppose you want your reply to go not only to the gateway but also to some other consumer.
In this case, you want two things:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
A named channel to which you can subscribe
</li><li class="listitem">
That channel to be a publish-subscribe-channel
</li></ul></div>
<p>The default strategy used by the gateway does not satisfy those needs, because the reply channel added to the header is anonymous and point-to-point.
This means that no other subscriber can get a handle to it and, even if it could, the channel has point-to-point behavior such that only one subscriber would get the message.
By defining a <code class="literal">default-reply-channel</code> you can point to a channel of your choosing.
In this case, that is a <code class="literal">publish-subscribe-channel</code>.
The gateway creates a bridge from it to the temporary, anonymous reply channel that is stored in the header.</p>
<p>You might also want to explicitly provide a reply channel for monitoring or auditing through an interceptor (for example, <a class="link" href="#channel-wiretap" title="Wire Tap">wiretap</a>).
To configure a channel interceptor, you need a named channel.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="gateway-configuration-annotations" href="#gateway-configuration-annotations"></a>10.4.4&nbsp;Gateway Configuration with Annotations and XML</h3></div></div></div>

<p>Consider the following example, which expands on the previous <code class="literal">Cafe</code> interface example by adding a <code class="literal">@Gateway</code> annotation:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> Cafe {

    <em><span class="hl-annotation" style="color: gray">@Gateway(requestChannel="orders")</span></em>
    <span class="hl-keyword">void</span> placeOrder(Order order);

}</pre>
</div>
<p>The <code class="literal">@Header</code> annotation lets you add values that are interpreted as message headers, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> FileWriter {

    <em><span class="hl-annotation" style="color: gray">@Gateway(requestChannel="filesOut")</span></em>
    <span class="hl-keyword">void</span> write(<span class="hl-keyword">byte</span>[] content, <em><span class="hl-annotation" style="color: gray">@Header(FileHeaders.FILENAME)</span></em> String filename);

}</pre>
</div>
<p>If you prefer the XML approach to configuring gateway methods, you can add <code class="literal">method</code> elements to the gateway configuration, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:gateway</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myGateway"</span> <span class="hl-attribute">service-interface</span>=<span class="hl-value">"org.foo.bar.TestGateway"</span>
      <span class="hl-attribute">default-request-channel</span>=<span class="hl-value">"inputC"</span><span class="hl-tag">&gt;</span>
  <span class="hl-tag">&lt;int:default-header</span> <span class="hl-attribute">name</span>=<span class="hl-value">"calledMethod"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"#gatewayMethod.name"</span><span class="hl-tag">/&gt;</span>
  <span class="hl-tag">&lt;int:method</span> <span class="hl-attribute">name</span>=<span class="hl-value">"echo"</span> <span class="hl-attribute">request-channel</span>=<span class="hl-value">"inputA"</span> <span class="hl-attribute">reply-timeout</span>=<span class="hl-value">"2"</span> <span class="hl-attribute">request-timeout</span>=<span class="hl-value">"200"</span><span class="hl-tag">/&gt;</span>
  <span class="hl-tag">&lt;int:method</span> <span class="hl-attribute">name</span>=<span class="hl-value">"echoUpperCase"</span> <span class="hl-attribute">request-channel</span>=<span class="hl-value">"inputB"</span><span class="hl-tag">/&gt;</span>
  <span class="hl-tag">&lt;int:method</span> <span class="hl-attribute">name</span>=<span class="hl-value">"echoViaDefault"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:gateway&gt;</span></pre>
</div>
<p>You can also use XML to provide individual headers for each method invocation.
This could be useful if the headers you want to set are static in nature and you do not want to embed them in the gateway&#8217;s method signature by using <code class="literal">@Header</code> annotations.
For example, in the loan broker example, we want to influence how aggregation of the loan quotes is done, based on what type of request was initiated (single quote or all quotes).
Determining the type of the request by evaluating which gateway method was invoked, although possible, would violate the separation of concerns paradigm (the method is a Java artifact).
However, expressing your intention (meta information) in message headers is natural in a messaging architecture.
The following example shows how to add a different message header for each of two methods:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:gateway</span> <span class="hl-attribute">id</span>=<span class="hl-value">"loanBrokerGateway"</span>
         <span class="hl-attribute">service-interface</span>=<span class="hl-value">"org.springframework.integration.loanbroker.LoanBrokerGateway"</span><span class="hl-tag">&gt;</span>
  <span class="hl-tag">&lt;int:method</span> <span class="hl-attribute">name</span>=<span class="hl-value">"getLoanQuote"</span> <span class="hl-attribute">request-channel</span>=<span class="hl-value">"loanBrokerPreProcessingChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:header</span> <span class="hl-attribute">name</span>=<span class="hl-value">"RESPONSE_TYPE"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"BEST"</span><span class="hl-tag">/&gt;</span>
  <span class="hl-tag">&lt;/int:method&gt;</span>
  <span class="hl-tag">&lt;int:method</span> <span class="hl-attribute">name</span>=<span class="hl-value">"getAllLoanQuotes"</span> <span class="hl-attribute">request-channel</span>=<span class="hl-value">"loanBrokerPreProcessingChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:header</span> <span class="hl-attribute">name</span>=<span class="hl-value">"RESPONSE_TYPE"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"ALL"</span><span class="hl-tag">/&gt;</span>
  <span class="hl-tag">&lt;/int:method&gt;</span>
<span class="hl-tag">&lt;/int:gateway&gt;</span></pre>
</div>
<p>In the preceding example a different value is set for the <span class="emphasis"><em>RESPONSE_TYPE</em></span> header, based on the gateway&#8217;s method.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_expressions_and_literal_global_literal_headers" href="#_expressions_and_literal_global_literal_headers"></a>Expressions and "<code class="literal">Global</code>" Headers</h4></div></div></div>

<p>The <code class="literal">&lt;header/&gt;</code> element supports <code class="literal">expression</code> as an alternative to <code class="literal">value</code>.
The SpEL expression is evaluated to determine the value of the header.
There is no <code class="literal">#root</code> object, but the following variables are available:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
#args: An <code class="literal">Object[]</code> containing the method arguments
</li><li class="listitem">
#gatewayMethod: The object (derived from <code class="literal">java.reflect.Method</code>) that represents the method in the <code class="literal">service-interface</code> that was invoked.
A header containing this variable can be used later in the flow (for example, for routing).
For example, if you wish to route on the simple method name, you might add a header with the following expression: <code class="literal">#gatewayMethod.name</code>.
</li></ul></div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The <code class="literal">java.reflect.Method</code> is not serializable.
A header with an expression of <code class="literal">#gatewayMethod</code> is lost if you later serialize the message.
Consequently, you may wish to use <code class="literal">#gatewayMethod.name</code> or <code class="literal">#gatewayMethod.toString()</code> in those cases.
The <code class="literal">toString()</code> method provides a <code class="literal">String</code> representation of the method, including parameter and return types.</p>
</td></tr></table></div>
<p>Since version 3.0, <code class="literal">&lt;default-header/&gt;</code> elements can be defined to add headers to all the messages produced by the gateway, regardless of the method invoked.
Specific headers defined for a method take precedence over default headers.
Specific headers defined for a method here override any <code class="literal">@Header</code> annotations in the service interface.
However, default headers do NOT override any <code class="literal">@Header</code> annotations in the service interface.</p>
<p>The gateway now also supports a <code class="literal">default-payload-expression</code>, which is applied for all methods (unless overridden).</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="gateway-mapping" href="#gateway-mapping"></a>10.4.5&nbsp;Mapping Method Arguments to a Message</h3></div></div></div>

<p>Using the configuration techniques in the previous section allows control of how method arguments are mapped to message elements (payload and headers).
When no explicit configuration is used, certain conventions are used to perform the mapping.
In some cases, these conventions cannot determine which argument is the payload and which should be mapped to headers.
Consider the following example:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> String send1(Object thing1, Map thing2);

<span class="hl-keyword">public</span> String send2(Map thing1, Map thing2);</pre>
</div>
<p>In the first case, the convention is to map the first argument to the payload (as long as it is not a <code class="literal">Map</code>) and the contents of the second argument become headers.</p>
<p>In the second case (or the first when the argument for parameter <code class="literal">thing1</code> is a <code class="literal">Map</code>), the framework cannot determine which argument should be the payload.
Consequently, mapping fails.
This can generally be resolved using a <code class="literal">payload-expression</code>, a <code class="literal">@Payload</code> annotation, or a <code class="literal">@Headers</code> annotation.</p>
<p>Alternatively (and whenever the conventions break down), you can take the entire responsibility for mapping the method calls to messages.
To do so, implement an <code class="literal">MethodArgsMessageMapper</code> and provide it to the <code class="literal">&lt;gateway/&gt;</code> by using the <code class="literal">mapper</code> attribute.
The mapper maps a <code class="literal">MethodArgsHolder</code>, which is a simple class that wraps the <code class="literal">java.reflect.Method</code> instance and an <code class="literal">Object[]</code> containing the arguments.
When providing a custom mapper, the <code class="literal">default-payload-expression</code> attribute and <code class="literal">&lt;default-header/&gt;</code> elements are not allowed on the gateway.
Similarly, the <code class="literal">payload-expression</code> attribute and <code class="literal">&lt;header/&gt;</code> elements are not allowed on any <code class="literal">&lt;method/&gt;</code> elements.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_mapping_method_arguments" href="#_mapping_method_arguments"></a>Mapping Method Arguments</h4></div></div></div>

<p>The following examples show how method arguments can be mapped to the message and shows some examples of invalid configuration:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> MyGateway {

    <span class="hl-keyword">void</span> payloadAndHeaderMapWithoutAnnotations(String s, Map&lt;String, Object&gt; map);

    <span class="hl-keyword">void</span> payloadAndHeaderMapWithAnnotations(<em><span class="hl-annotation" style="color: gray">@Payload</span></em> String s, <em><span class="hl-annotation" style="color: gray">@Headers</span></em> Map&lt;String, Object&gt; map);

    <span class="hl-keyword">void</span> headerValuesAndPayloadWithAnnotations(<em><span class="hl-annotation" style="color: gray">@Header("k1")</span></em> String x, <em><span class="hl-annotation" style="color: gray">@Payload</span></em> String s, <em><span class="hl-annotation" style="color: gray">@Header("k2")</span></em> String y);

    <span class="hl-keyword">void</span> mapOnly(Map&lt;String, Object&gt; map); <span class="hl-comment">// the payload is the map and no custom headers are added</span>

    <span class="hl-keyword">void</span> twoMapsAndOneAnnotatedWithPayload(<em><span class="hl-annotation" style="color: gray">@Payload</span></em> Map&lt;String, Object&gt; payload, Map&lt;String, Object&gt; headers);

    <em><span class="hl-annotation" style="color: gray">@Payload("#args[0] + #args[1] + '!'")</span></em>
    <span class="hl-keyword">void</span> payloadAnnotationAtMethodLevel(String a, String b);

    <em><span class="hl-annotation" style="color: gray">@Payload("@someBean.exclaim(#args[0])")</span></em>
    <span class="hl-keyword">void</span> payloadAnnotationAtMethodLevelUsingBeanResolver(String s);

    <span class="hl-keyword">void</span> payloadAnnotationWithExpression(<em><span class="hl-annotation" style="color: gray">@Payload("toUpperCase()")</span></em> String s);

    <span class="hl-keyword">void</span> payloadAnnotationWithExpressionUsingBeanResolver(<em><span class="hl-annotation" style="color: gray">@Payload("@someBean.sum(#this)")</span></em> String s); <span class="hl-comment">//  </span><a name="CO14-1" href="#CO14-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>

    <span class="hl-comment">// invalid</span>
    <span class="hl-keyword">void</span> twoMapsWithoutAnnotations(Map&lt;String, Object&gt; m1, Map&lt;String, Object&gt; m2);

    <span class="hl-comment">// invalid</span>
    <span class="hl-keyword">void</span> twoPayloads(<em><span class="hl-annotation" style="color: gray">@Payload</span></em> String s1, <em><span class="hl-annotation" style="color: gray">@Payload</span></em> String s2);

    <span class="hl-comment">// invalid</span>
    <span class="hl-keyword">void</span> payloadAndHeaderAnnotationsOnSameParameter(<em><span class="hl-annotation" style="color: gray">@Payload</span></em> <em><span class="hl-annotation" style="color: gray">@Header("x")</span></em> String s);

    <span class="hl-comment">// invalid</span>
    <span class="hl-keyword">void</span> payloadAndHeadersAnnotationsOnSameParameter(<em><span class="hl-annotation" style="color: gray">@Payload</span></em> <em><span class="hl-annotation" style="color: gray">@Headers</span></em> Map&lt;String, Object&gt; map);

}</pre>
</div>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO14-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Note that, in this example, the SpEL variable, <code class="literal">#this</code>, refers to the argument&#8201;&#8212;&#8201;in this case, the value of <code class="literal">s</code>.</p>
</td></tr></table></div>
<p>The XML equivalent looks a little different, since there is no <code class="literal">#this</code> context for the method argument.
However, expressions can refer to method arguments by using the <code class="literal">#args</code> variable, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:gateway</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myGateway"</span> <span class="hl-attribute">service-interface</span>=<span class="hl-value">"org.something.MyGateway"</span><span class="hl-tag">&gt;</span>
  <span class="hl-tag">&lt;int:method</span> <span class="hl-attribute">name</span>=<span class="hl-value">"send1"</span> <span class="hl-attribute">payload-expression</span>=<span class="hl-value">"#args[0] + 'thing2'"</span><span class="hl-tag">/&gt;</span>
  <span class="hl-tag">&lt;int:method</span> <span class="hl-attribute">name</span>=<span class="hl-value">"send2"</span> <span class="hl-attribute">payload-expression</span>=<span class="hl-value">"@someBean.sum(#args[0])"</span><span class="hl-tag">/&gt;</span>
  <span class="hl-tag">&lt;int:method</span> <span class="hl-attribute">name</span>=<span class="hl-value">"send3"</span> <span class="hl-attribute">payload-expression</span>=<span class="hl-value">"#method"</span><span class="hl-tag">/&gt;</span>
  <span class="hl-tag">&lt;int:method</span> <span class="hl-attribute">name</span>=<span class="hl-value">"send4"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:header</span> <span class="hl-attribute">name</span>=<span class="hl-value">"thing1"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"#args[2].toUpperCase()"</span><span class="hl-tag">/&gt;</span>
  <span class="hl-tag">&lt;/int:method&gt;</span>
<span class="hl-tag">&lt;/int:gateway&gt;</span></pre>
</div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="messaging-gateway-annotation" href="#messaging-gateway-annotation"></a>10.4.6&nbsp;<code class="literal">@MessagingGateway</code> Annotation</h3></div></div></div>

<p>Starting with version 4.0, gateway service interfaces can be marked with a <code class="literal">@MessagingGateway</code> annotation instead of requiring the definition of a <code class="literal">&lt;gateway /&gt;</code> xml element for configuration.
The following pair of examples compares the two approaches for configuring the same gateway:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:gateway</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myGateway"</span> <span class="hl-attribute">service-interface</span>=<span class="hl-value">"org.something.TestGateway"</span>
      <span class="hl-attribute">default-request-channel</span>=<span class="hl-value">"inputC"</span><span class="hl-tag">&gt;</span>
  <span class="hl-tag">&lt;int:default-header</span> <span class="hl-attribute">name</span>=<span class="hl-value">"calledMethod"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"#gatewayMethod.name"</span><span class="hl-tag">/&gt;</span>
  <span class="hl-tag">&lt;int:method</span> <span class="hl-attribute">name</span>=<span class="hl-value">"echo"</span> <span class="hl-attribute">request-channel</span>=<span class="hl-value">"inputA"</span> <span class="hl-attribute">reply-timeout</span>=<span class="hl-value">"2"</span> <span class="hl-attribute">request-timeout</span>=<span class="hl-value">"200"</span><span class="hl-tag">/&gt;</span>
  <span class="hl-tag">&lt;int:method</span> <span class="hl-attribute">name</span>=<span class="hl-value">"echoUpperCase"</span> <span class="hl-attribute">request-channel</span>=<span class="hl-value">"inputB"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:header</span> <span class="hl-attribute">name</span>=<span class="hl-value">"thing1"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"thing2"</span><span class="hl-tag">/&gt;</span>
  <span class="hl-tag">&lt;/int:method&gt;</span>
  <span class="hl-tag">&lt;int:method</span> <span class="hl-attribute">name</span>=<span class="hl-value">"echoViaDefault"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:gateway&gt;</span></pre>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@MessagingGateway(name = "myGateway", defaultRequestChannel = "inputC",
		  defaultHeaders = @GatewayHeader(name = "calledMethod",
		                           expression="#gatewayMethod.name"))</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> TestGateway {

   <em><span class="hl-annotation" style="color: gray">@Gateway(requestChannel = "inputA", replyTimeout = 2, requestTimeout = 200)</span></em>
   String echo(String payload);

   <em><span class="hl-annotation" style="color: gray">@Gateway(requestChannel = "inputB", headers = @GatewayHeader(name = "thing1", value="thing2"))</span></em>
   String echoUpperCase(String payload);

   String echoViaDefault(String payload);

}</pre>
</div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Similarly to the XML version, when Spring Integration discovers these annotations during a component scan, it creates the <code class="literal">proxy</code> implementation with its messaging infrastructure.
To perform this scan and register the <code class="literal">BeanDefinition</code> in the application context, add the <code class="literal">@IntegrationComponentScan</code> annotation to a <code class="literal">@Configuration</code> class.
The standard <code class="literal">@ComponentScan</code> infrastructure does not deal with interfaces.
Consequently, we introduced the custom <code class="literal">@IntegrationComponentScan</code> logic  to fine the <code class="literal">@MessagingGateway</code> annotation on the interfaces and register <code class="literal">GatewayProxyFactoryBean</code> instances for them.
See also <a class="xref" href="#annotations" title="E.5&nbsp;Annotation Support">Section&nbsp;E.5, &#8220;Annotation Support&#8221;</a>.</p>
</td></tr></table></div>
<p>Along with the <code class="literal">@MessagingGateway</code> annotation you can mark a service interface with the <code class="literal">@Profile</code> annotation to avoid the bean creation, if such a profile is not active.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>If you have no XML configuration, the <code class="literal">@EnableIntegration</code> annotation is required on at least one <code class="literal">@Configuration</code> class.
See <a class="xref" href="#configuration-enable-integration" title="5.5&nbsp;Configuration and @EnableIntegration">Section&nbsp;5.5, &#8220;Configuration and <code class="literal">@EnableIntegration</code>&#8221;</a> for more information.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="gateway-calling-no-argument-methods" href="#gateway-calling-no-argument-methods"></a>10.4.7&nbsp;Invoking No-Argument Methods</h3></div></div></div>

<p>When invoking methods on a Gateway interface that do not have any arguments, the default behavior is to receive a <code class="literal">Message</code> from a <code class="literal">PollableChannel</code>.</p>
<p>Sometimes, however, you may want to trigger no-argument methods so that you can interact with other components downstream that do not require user-provided parameters, such as triggering no-argument SQL calls or stored procedures.</p>
<p>To achieve send-and-receive semantics, you must provide a payload.
To generate a payload, method parameters on the interface are not necessary.
You can either use the <code class="literal">@Payload</code> annotation or the <code class="literal">payload-expression</code> attribute in XML on the <code class="literal">method</code> element.
The following list includes a few examples of what the payloads could be:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
a literal string
</li><li class="listitem">
#gatewayMethod.name
</li><li class="listitem">
new java.util.Date()
</li><li class="listitem">
@someBean.someMethod()'s return value
</li></ul></div>
<p>The following example shows how to use the <code class="literal">@Payload</code> annotation:</p>
<pre class="programlisting">public interface Cafe {

    @Payload("new java.util.Date()")
    List<span class="hl-tag">&lt;Order&gt;</span> retrieveOpenOrders();

}</pre>
<p>If a method has no argument and no return value but does contain a payload expression, it is treated as a send-only operation.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="gateway-error-handling" href="#gateway-error-handling"></a>10.4.8&nbsp;Error Handling</h3></div></div></div>

<p>The gateway invocation can result in errors.
By default, any error that occurs downstream is re-thrown "<code class="literal">as is</code>" upon the gateway&#8217;s method invocation.
For example, consider the following simple flow:</p>
<div class="informalexample">
<pre class="screen">gateway -&gt; service-activator</pre>
</div>
<p>If the service invoked by the service activator throws a <code class="literal">MyException</code> (for example), the framework wraps it in a <code class="literal">MessagingException</code> and attaches the message passed to the service activator in the <code class="literal">failedMessage</code> property.
Consequently, any logging performed by the framework has full the context of the failure.
By default, when the exception is caught by the gateway, the <code class="literal">MyException</code> is unwrapped and thrown to the caller.
You can configure a <code class="literal">throws</code> clause on the gateway method declaration to match the particular exception type in the cause chain.
For example, if you want to catch a whole <code class="literal">MessagingException</code> with all the messaging information of the reason of downstream error, you should have a gateway method similar to the following:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> MyGateway {

    <span class="hl-keyword">void</span> performProcess() <span class="hl-keyword">throws</span> MessagingException;

}</pre>
</div>
<p>Since we encourage POJO programming, you may not want to expose the caller to messaging infrastructure.</p>
<p>If your gateway method does not have a <code class="literal">throws</code> clause, the gateway traverses the cause tree, looking for a <code class="literal">RuntimeException</code> that is not a <code class="literal">MessagingException</code>.
If none is found, the framework throws the <code class="literal">MessagingException</code>.
If the <code class="literal">MyException</code> in the preceding discussion has a cause of <code class="literal">SomeOtherException</code> and your method <code class="literal">throws SomeOtherException</code>, the gateway further unwraps that and throws it to the caller.</p>
<p>When a gateway is declared with no <code class="literal">service-interface</code>, an internal framework interface <code class="literal">RequestReplyExchanger</code> is used.</p>
<p>Consider the following example:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> RequestReplyExchanger {

	Message&lt;?&gt; exchange(Message&lt;?&gt; request) <span class="hl-keyword">throws</span> MessagingException;

}</pre>
<p>Before version 5.0, this <code class="literal">exchange</code> method did not have a <code class="literal">throws</code> clause and, as a result, the exception was unwrapped.
If you use this interface and want to restore the previous unwrap behavior, use a custom <code class="literal">service-interface</code> instead or access the <code class="literal">cause</code> of the  <code class="literal">MessagingException</code> yourself.</p>
<p>However, you may want to log the error rather than propagating it or you may want to treat an exception as a valid reply (by mapping it to a message that conforms to some "error message" contract that the caller understands).
To accomplish this, the gateway provides support for a message channel dedicated to the errors by including support for the <code class="literal">error-channel</code> attribute.
In the following example, a <span class="emphasis"><em>transformer</em></span> creates a reply <code class="literal">Message</code> from the <code class="literal">Exception</code>:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:gateway</span> <span class="hl-attribute">id</span>=<span class="hl-value">"sampleGateway"</span>
    <span class="hl-attribute">default-request-channel</span>=<span class="hl-value">"gatewayChannel"</span>
    <span class="hl-attribute">service-interface</span>=<span class="hl-value">"foo.bar.SimpleGateway"</span>
    <span class="hl-attribute">error-channel</span>=<span class="hl-value">"exceptionTransformationChannel"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int:transformer</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"exceptionTransformationChannel"</span>
        <span class="hl-attribute">ref</span>=<span class="hl-value">"exceptionTransformer"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"createErrorResponse"</span><span class="hl-tag">/&gt;</span></pre>
<p>The <code class="literal">exceptionTransformer</code> could be a simple POJO that knows how to create the expected error response objects.
That becomes the payload that is sent back to the caller.
You could do many more elaborate things in such an "<code class="literal">error flow</code>", if necessary.
It might involve routers (including Spring Integration&#8217;s <code class="literal">ErrorMessageExceptionTypeRouter</code>), filters, and so on.
Most of the time, a simple <span class="emphasis"><em>transformer</em></span> should be sufficient, however.</p>
<p>Alternatively, you might want to only log the exception (or send it somewhere asynchronously).
If you provide a one-way flow, nothing would be sent back to the caller.
If you want to completely suppress exceptions, you can provide a reference to the global <code class="literal">nullChannel</code> (essentially a <code class="literal">/dev/null</code> approach).
Finally, as mentioned above, if no <code class="literal">error-channel</code> is defined, then the exceptions propagate as usual.</p>
<p>When you use the <code class="literal">@MessagingGateway</code> annotation (see <code class="literal">&lt;&lt;messaging-gateway-annotation&gt;&gt;</code>), you can use use the <code class="literal">errorChannel</code> attribute.</p>
<p>Starting with version 5.0, when you use a gateway method with a <code class="literal">void</code> return type (one-way flow), the <code class="literal">error-channel</code> reference (if provided) is populated in the standard <code class="literal">errorChannel</code> header of each sent message.
This feature allows a downstream asynchronous flow, based on the standard <code class="literal">ExecutorChannel</code> configuration (or a <code class="literal">QueueChannel</code>), to override a default global <code class="literal">errorChannel</code> exceptions sending behavior.
Previously you had to manually specify an <code class="literal">errorChannel</code> header with the <code class="literal">@GatewayHeader</code> annotation or the <code class="literal">&lt;header&gt;</code> element.
The <code class="literal">error-channel</code> property was ignored for <code class="literal">void</code> methods with an asynchronous flow.
Instead, error messages were sent to the default <code class="literal">errorChannel</code>.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Exposing the messaging system through simple POJI Gateways  provides benefits, but "<code class="literal">hiding</code>" the reality of the underlying messaging system does come at a price, so there are certain things you should consider.
We want our Java method to return as quickly as possible and not hang for an indefinite amount of time while the caller is waiting on it to return (whether void, a return value, or a thrown Exception).
When regular methods are used as a proxies in front of the messaging system, we have to take into account the potentially asynchronous nature of the underlying messaging.
This means that there might be a chance that a message that was initiated by a gateway could be dropped by a filter and never reach a component that is responsible for producing a reply.
Some service activator method might result in an exception, thus providing no reply (as we do not generate null messages).
In other words, multiple scenarios can cause a reply message to never come.
That is perfectly natural in messaging systems.
However, think about the implication on the gateway method.&nbsp;The gateway&#8217;s method input arguments&nbsp;were incorporated into a message and sent downstream.
The reply message would be converted to a return value of the gateway&#8217;s method.
So you might want to ensure that, for each gateway call, there is always a reply message.
Otherwise, your gateway method might never return and hang indefinitely.
One way to handle this situation is by using an asynchronous gateway (explained later in this section).
Another way of handling it is to explicitly set the <code class="literal">reply-timeout</code> attribute.
That way, the gateway does not hang any longer than the time specified by the <code class="literal">reply-timeout</code> and returns <span class="emphasis"><em>null</em></span> if that timeout does elapse.
Finally, you might want to consider setting downstream flags, such as <span class="emphasis"><em>requires-reply</em></span>, on a service-activator or <span class="emphasis"><em>throw-exceptions-on-rejection</em></span> on a filter.&nbsp;These options are discussed in more detail in the final section of this chapter.</p>
</td></tr></table></div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>If the downstream flow returns an <code class="literal">ErrorMessage</code>, its <code class="literal">payload</code> (a <code class="literal">Throwable</code>) is treated as a regular downstream error.
If there is an <code class="literal">error-channel</code> configured, it is sent to the error flow.
Otherwise the payload is thrown to the caller of the gateway.
Similarly, if the error flow on the <code class="literal">error-channel</code> returns an <code class="literal">ErrorMessage</code>, its payload is thrown to the caller.
The same applies to any message with a <code class="literal">Throwable</code> payload.
This can be useful in asynchronous situations when when you need to propagate an <code class="literal">Exception</code> directly to the caller.
To do so, you can either return an <code class="literal">Exception</code> (as the <code class="literal">reply</code> from some service) or throw it.
Generally, even with an asynchronous flow, the framework takes care of propagating an exception thrown by the downstream flow back to the gateway.
The <a class="ulink" href="https://github.com/spring-projects/spring-integration-samples/tree/master/intermediate/tcp-client-server-multiplex" target="_top">TCP Client-Server Multiplex</a> sample demonstrates both techniques to return the exception to the caller.
It emulates a socket IO error to the waiting thread by using an <code class="literal">aggregator</code> with <code class="literal">group-timeout</code> (see <a class="xref" href="#agg-and-group-to" title="Aggregator and Group Timeout">the section called &#8220;Aggregator and Group Timeout&#8221;</a>) and a <code class="literal">MessagingTimeoutException</code> reply on the discard flow.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="gateway-timeouts" href="#gateway-timeouts"></a>10.4.9&nbsp;Gateway Timeouts</h3></div></div></div>

<p>Gateways have two timeout properties: <code class="literal">requestTimeout</code> and <code class="literal">replyTimeout</code>.
The request timeout applies only if the channel can block (for example, a bounded <code class="literal">QueueChannel</code> that is full).
The <code class="literal">replyTimeout</code> value is how long the gateway waits for a reply or returns <code class="literal">null</code>.
It defaults to infinity.</p>
<p>The timeouts can be set as defaults for all methods on the gateway (<code class="literal">defaultRequestTimeout</code> and <code class="literal">defaultReplyTimeout</code>) or on the <code class="literal">MessagingGateway</code> interface annotation.
Individual methods can override these defaults (in <code class="literal">&lt;method/&gt;</code> child elements) or on the <code class="literal">@Gateway</code> annotation.</p>
<p>Starting with version 5.0, the timeouts can be defined as expressions, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Gateway(payloadExpression = "#args[0]", requestChannel = "someChannel",
        requestTimeoutExpression = "#args[1]", replyTimeoutExpression = "#args[2]")</span></em>
String lateReply(String payload, <span class="hl-keyword">long</span> requestTimeout, <span class="hl-keyword">long</span> replyTimeout);</pre>
</div>
<p>The evaluation context has a <code class="literal">BeanResolver</code> (use <code class="literal">@someBean</code> to reference other beans), and the <code class="literal">#args</code> array variable is available.</p>
<p>When configuring with XML, the timeout attributes can be a long value or a SpEL expression, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;method</span> <span class="hl-attribute">name</span>=<span class="hl-value">"someMethod"</span> <span class="hl-attribute">request-channel</span>=<span class="hl-value">"someRequestChannel"</span>
                      <span class="hl-attribute">payload-expression</span>=<span class="hl-value">"#args[0]"</span>
                      <span class="hl-attribute">request-timeout</span>=<span class="hl-value">"1000"</span>
                      <span class="hl-attribute">reply-timeout</span>=<span class="hl-value">"#args[1]"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;/method&gt;</span></pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="async-gateway" href="#async-gateway"></a>10.4.10&nbsp;Asynchronous Gateway</h3></div></div></div>

<p>As a pattern, the messaging gateway offers a nice way to hide messaging-specific code while still exposing the full capabilities of the messaging system.
As <a class="link" href="#gateway-proxy" title="10.4.1&nbsp;Enter the GatewayProxyFactoryBean">described earlier</a>, the <code class="literal">GatewayProxyFactoryBean</code> provides a convenient way to expose a proxy over a service-interface giving you POJO-based access to a messaging system (based on objects in your own domain, primitives/Strings, or other objects).
However, when a gateway is exposed through simple POJO methods that return values, it implies that, for each request message (generated when the method is invoked), there must be a reply message (generated when the method has returned).
Since messaging systems are naturally asynchronous, you may not always be able to guarantee the contract where "<code class="literal">for each request, there will always be be a reply</code>".&nbsp;Spring Integration 2.0 introduced support for an asynchronous gateway, which offers a convenient way to initiate flows when you may not know if a reply is expected or how long it takes for replies to arrive.</p>
<p>To handle these types of scenarios, Spring Integration uses <code class="literal">java.util.concurrent.Future</code> instances to support an asynchronous gateway.</p>
<p>From the XML configuration, nothing changes, and you still define asynchronous gateway the same way as you define a regular gateway, as the following example shows:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:gateway</span> <span class="hl-attribute">id</span>=<span class="hl-value">"mathService"</span><span class="hl-attribute">&nbsp;</span>
     <span class="hl-attribute">service-interface</span>=<span class="hl-value">"org.springframework.integration.sample.gateway.futures.MathServiceGateway"</span>
     <span class="hl-attribute">default-request-channel</span>=<span class="hl-value">"requestChannel"</span><span class="hl-tag">/&gt;</span></pre>
<p>However, the gateway interface (a service interface) is a little different, as follows:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> MathServiceGateway {

  Future&lt;Integer&gt; multiplyByTwo(<span class="hl-keyword">int</span> i);

}</pre>
<p>As the preceding example shows, the return type for the gateway method is a <code class="literal">Future</code>.
When <code class="literal">GatewayProxyFactoryBean</code> sees that the return type of the gateway method is a <code class="literal">Future</code>, it immediately switches to the asynchronous mode by using an <code class="literal">AsyncTaskExecutor</code>.
That is the extent of the differences.
The call to such a method always returns immediately with a <code class="literal">Future</code> instance.
Then you can interact with the <code class="literal">Future</code> at your own pace to get the result, cancel, and so on.
Also, as with any other use of <code class="literal">Future</code> instances, calling <code class="literal">get()</code> may reveal a timeout, an execution exception, and so on.
The following example shows how to use a <code class="literal">Future</code> that returns from an asynchronous gateway:</p>
<div class="informalexample">
<pre class="programlisting">MathServiceGateway mathService = ac.getBean(<span class="hl-string">"mathService"</span>, MathServiceGateway.<span class="hl-keyword">class</span>);
Future&lt;Integer&gt; result = mathService.multiplyByTwo(number);
<span class="hl-comment">// do something else here since the reply might take a moment</span>
<span class="hl-keyword">int</span> finalResult =&nbsp; result.get(<span class="hl-number">1000</span>, TimeUnit.SECONDS);</pre>
</div>
<p>For a more detailed example, see the <a class="ulink" href="https://github.com/spring-projects/spring-integration-samples/tree/master/intermediate/async-gateway" target="_top">async-gateway</a> sample in the Spring Integration samples.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_literal_listenablefuture_literal" href="#_literal_listenablefuture_literal"></a><code class="literal">ListenableFuture</code></h4></div></div></div>

<p>Starting with version 4.1, asynchronous gateway methods can also return <code class="literal">ListenableFuture</code> (introduced in Spring Framework 4.0).
These return types let you provide a callback, which is invoked when the result is available (or an exception occurs).
When the gateway detects this return type and the <a class="link" href="#gateway-asynctaskexecutor" title="AsyncTaskExecutor">task executor</a> is an <code class="literal">AsyncListenableTaskExecutor</code>, the executor&#8217;s <code class="literal">submitListenable()</code> method is invoked.
The following example shows how to use a <code class="literal">ListenableFuture</code>:</p>
<div class="informalexample">
<pre class="programlisting">ListenableFuture&lt;String&gt; result = <span class="hl-keyword">this</span>.asyncGateway.async(<span class="hl-string">"something"</span>);
result.addCallback(<span class="hl-keyword">new</span> ListenableFutureCallback&lt;String&gt;() {

    <em><span class="hl-annotation" style="color: gray">@Override</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> onSuccess(String result) {
        ...
    }

    <em><span class="hl-annotation" style="color: gray">@Override</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> onFailure(Throwable t) {
        ...
    }
});</pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="gateway-asynctaskexecutor" href="#gateway-asynctaskexecutor"></a><code class="literal">AsyncTaskExecutor</code></h4></div></div></div>

<p>By default, the <code class="literal">GatewayProxyFactoryBean</code> uses <code class="literal">org.springframework.core.task.SimpleAsyncTaskExecutor</code> when submitting internal <code class="literal">AsyncInvocationTask</code> instances for any gateway method whose return type is a <code class="literal">Future</code>.
However, the <code class="literal">async-executor</code> attribute in the <code class="literal">&lt;gateway/&gt;</code> element&#8217;s configuration lets you provide a reference to any implementation of <code class="literal">java.util.concurrent.Executor</code> available within the Spring application context.</p>
<p>The (default) <code class="literal">SimpleAsyncTaskExecutor</code> supports both <code class="literal">Future</code> and <code class="literal">ListenableFuture</code> return types, returning <code class="literal">FutureTask</code> or <code class="literal">ListenableFutureTask</code> respectively. See <a class="xref" href="#gw-completable-future" title="CompletableFuture">the section called &#8220;<code class="literal">CompletableFuture</code>&#8221;</a>.
Even though there is a default executor, it is often useful to provide an external one so that you can identify its threads in logs (when using XML, the thread name is based on the executor&#8217;s bean name), as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> AsyncTaskExecutor exec() {
    SimpleAsyncTaskExecutor simpleAsyncTaskExecutor = <span class="hl-keyword">new</span> SimpleAsyncTaskExecutor();
    simpleAsyncTaskExecutor.setThreadNamePrefix(<span class="hl-string">"exec-"</span>);
    <span class="hl-keyword">return</span> simpleAsyncTaskExecutor;
}

<em><span class="hl-annotation" style="color: gray">@MessagingGateway(asyncExecutor = "exec")</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> ExecGateway {

    <em><span class="hl-annotation" style="color: gray">@Gateway(requestChannel = "gatewayChannel")</span></em>
    Future&lt;?&gt; doAsync(String foo);

}</pre>
</div>
<p>If you wish to return a different <code class="literal">Future</code> implementation, you can provide a custom executor or disable the executor altogether and return the <code class="literal">Future</code> in the reply message payload from the downstream flow.
To disable the executor, set it to <code class="literal">null</code> in the <code class="literal">GatewayProxyFactoryBean</code> (by using <code class="literal">setAsyncTaskExecutor(null)</code>).
When configuring the gateway with XML, use <code class="literal">async-executor=""</code>.
When configuring by using the <code class="literal">@MessagingGateway</code> annotation, use code similar to the following:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@MessagingGateway(asyncExecutor = AnnotationConstants.NULL)</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> NoExecGateway {

    <em><span class="hl-annotation" style="color: gray">@Gateway(requestChannel = "gatewayChannel")</span></em>
    Future&lt;?&gt; doAsync(String foo);

}</pre>
</div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>If the return type is a specific concrete <code class="literal">Future</code> implementation or some other sub-interface that is not supported by the configured executor, the flow runs on the caller&#8217;s thread and the flow must return the required type in the reply message payload.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="gw-completable-future" href="#gw-completable-future"></a><code class="literal">CompletableFuture</code></h4></div></div></div>

<p>Starting with version 4.2, gateway methods can now return <code class="literal">CompletableFuture&lt;?&gt;</code>.
There are two modes of operation when returning this type:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
When an async executor is provided and the return type is exactly <code class="literal">CompletableFuture</code> (not a subclass), the framework runs the task on the executor and immediately returns a <code class="literal">CompletableFuture</code> to the caller.
<code class="literal">CompletableFuture.supplyAsync(Supplier&lt;U&gt; supplier, Executor executor)</code> is used to create the future.
</li><li class="listitem">
When the async executor is explicitly set to <code class="literal">null</code> and the return type is <code class="literal">CompletableFuture</code> or the return type is a subclass of <code class="literal">CompletableFuture</code>, the flow is invoked on the caller&#8217;s thread.
In this scenario, the downstream flow is expected to return a <code class="literal">CompletableFuture</code> of the appropriate type.
</li></ul></div>
<div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="_usage_scenarios" href="#_usage_scenarios"></a>Usage Scenarios</h5></div></div></div>

<p>In the following scenario, the caller thread returns immediately with a <code class="literal">CompletableFuture&lt;Invoice&gt;</code>, which is completed when the downstream flow replies to the gateway (with an <code class="literal">Invoice</code> object).</p>
<div class="informalexample">
<pre class="programlisting">CompletableFuture&lt;Invoice&gt; order(Order order);</pre>
<pre class="programlisting"><span class="hl-tag">&lt;int:gateway</span> <span class="hl-attribute">service-interface</span>=<span class="hl-value">"something.Service"</span> <span class="hl-attribute">default-request-channel</span>=<span class="hl-value">"orders"</span><span class="hl-tag"> /&gt;</span></pre>
</div>
<p>In the following  scenario, the caller thread returns with a <code class="literal">CompletableFuture&lt;Invoice&gt;</code> when the downstream flow provides it as the payload of the reply to the gateway.
Some other process must complete the future when the invoice is ready.</p>
<div class="informalexample">
<pre class="programlisting">CompletableFuture&lt;Invoice&gt; order(Order order);</pre>
<pre class="programlisting"><span class="hl-tag">&lt;int:gateway</span> <span class="hl-attribute">service-interface</span>=<span class="hl-value">"foo.Service"</span> <span class="hl-attribute">default-request-channel</span>=<span class="hl-value">"orders"</span>
    <span class="hl-attribute">async-executor</span>=<span class="hl-value">""</span><span class="hl-tag"> /&gt;</span></pre>
</div>
<p>In the following scenario, the caller thread returns with a <code class="literal">CompletableFuture&lt;Invoice&gt;</code> when the downstream flow provides it as the payload of the reply to the gateway.
Some other process must complete the future when the invoice is ready.
If <code class="literal">DEBUG</code> logging is enabled, a log entry is emitted, indicating that the async executor cannot be used for this scenario.</p>
<div class="informalexample">
<pre class="programlisting">MyCompletableFuture&lt;Invoice&gt; order(Order order);</pre>
<pre class="programlisting"><span class="hl-tag">&lt;int:gateway</span> <span class="hl-attribute">service-interface</span>=<span class="hl-value">"foo.Service"</span> <span class="hl-attribute">default-request-channel</span>=<span class="hl-value">"orders"</span><span class="hl-tag"> /&gt;</span></pre>
</div>
<p><code class="literal">CompletableFuture</code> instances can be used to perform additional manipulation on the reply, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting">CompletableFuture&lt;String&gt; process(String data);

...

CompletableFuture result = process(<span class="hl-string">"foo"</span>)
    .thenApply(t -&gt; t.toUpperCase());

...

String out = result.get(<span class="hl-number">10</span>, TimeUnit.SECONDS);</pre>
</div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_reactor_literal_mono_literal" href="#_reactor_literal_mono_literal"></a>Reactor <code class="literal">Mono</code></h4></div></div></div>

<p>Starting with version 5.0, the <code class="literal">GatewayProxyFactoryBean</code> allows the use of <a class="ulink" href="https://projectreactor.io/" target="_top">Project Reactor</a> with gateway interface methods, using a <a class="ulink" href="https://github.com/reactor/reactor-core" target="_top"><code class="literal">Mono&lt;T&gt;</code></a> return type.
The internal <code class="literal">AsyncInvocationTask</code> is wrapped in a <code class="literal">Mono.fromCallable()</code>.</p>
<p>A <code class="literal">Mono</code> can be used to retrieve the result later (similar to a <code class="literal">Future&lt;?&gt;</code>), or you can consume from it with the dispatcher by invoking your <code class="literal">Consumer</code> when the result is returned to the gateway.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>The <code class="literal">Mono</code> is not immediately flushed by the framework.
Consequently, the underlying message flow is not started before the gateway method returns (as it is with a <code class="literal">Future&lt;?&gt;</code> <code class="literal">Executor</code> task).
The flow starts when the <code class="literal">Mono</code> is subscribed to.
Alternatively, the <code class="literal">Mono</code> (being a <code class="literal">Composable</code>) might be a part of Reactor stream, when the <code class="literal">subscribe()</code> is related to the entire <code class="literal">Flux</code>.
The following example shows how to create a gateway with Project Reactor:</p>
</td></tr></table></div>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@MessagingGateway</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">interface</span> TestGateway {

	<em><span class="hl-annotation" style="color: gray">@Gateway(requestChannel = "promiseChannel")</span></em>
	Mono&lt;Integer&gt; multiply(Integer value);

	}

	    ...

	<em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "promiseChannel")</span></em>
	<span class="hl-keyword">public</span> Integer multiply(Integer value) {
			<span class="hl-keyword">return</span> value * <span class="hl-number">2</span>;
	}

		...

    Flux.just(<span class="hl-string">"1"</span>, <span class="hl-string">"2"</span>, <span class="hl-string">"3"</span>, <span class="hl-string">"4"</span>, <span class="hl-string">"5"</span>)
            .map(Integer::parseInt)
            .flatMap(<span class="hl-keyword">this</span>.testGateway::multiply)
            .collectList()
            .subscribe(integers -&gt; ...);</pre>
</div>
<p>Another example that uses Project Reactor is a simple callback scenario, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting">Mono&lt;Invoice&gt; mono = service.process(myOrder);

mono.subscribe(invoice -&gt; handleInvoice(invoice));</pre>
</div>
<p>The calling thread continues, with <code class="literal">handleInvoice()</code> being called when the flow completes.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_downstream_flows_returning_an_asynchronous_type" href="#_downstream_flows_returning_an_asynchronous_type"></a>Downstream Flows Returning an Asynchronous Type</h4></div></div></div>

<p>As mentioned in the <code class="literal">ListenableFuture</code> section above, if you wish some downstream component to return a message with an async payload (<code class="literal">Future</code>, <code class="literal">Mono</code>, and others), you must explicitly set the async executor to <code class="literal">null</code> (or <code class="literal">""</code> when using XML configuration).
The flow is then invoked on the caller thread and the result can be retrieved later.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_literal_void_literal_return_type" href="#_literal_void_literal_return_type"></a><code class="literal">void</code> Return Type</h4></div></div></div>

<p>Unlike the return types mentioned earlier, when the method return type is <code class="literal">void</code>, the framework cannot implicitly determine that you wish the downstream flow to run asynchronously, with the caller thread returning immediately.
In this case, you must annotate the interface method with <code class="literal">@Async</code>, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@MessagingGateway</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> MyGateway {

    <em><span class="hl-annotation" style="color: gray">@Gateway(requestChannel = "sendAsyncChannel")</span></em>
    <em><span class="hl-annotation" style="color: gray">@Async</span></em>
    <span class="hl-keyword">void</span> sendAsync(String payload);

}</pre>
</div>
<p>Unlike the <code class="literal">Future&lt;?&gt;</code> return types, there is no way to inform the caller if some exception is thrown by the flow, unless some custom <code class="literal">TaskExecutor</code> (such as an <code class="literal">ErrorHandlingTaskExecutor</code>) is associated with the <code class="literal">@Async</code> annotation.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="gateway-no-response" href="#gateway-no-response"></a>10.4.11&nbsp;Gateway Behavior When No response Arrives</h3></div></div></div>

<p>As <a class="link" href="#gateway-proxy" title="10.4.1&nbsp;Enter the GatewayProxyFactoryBean">explained earlier</a>, the gateway provides a convenient way of interacting with a messaging system through POJO method invocations.
However, a typical method invocation, which is generally expected to always return (even with an Exception), might not always map one-to-one to message exchanges (for example, a reply message might not arrive&#8201;&#8212;&#8201;the equivalent to a method not returning).</p>
<p>The rest of this section covers various scenarios and how to make the gateway behave more predictably.
Certain attributes can be configured to make synchronous gateway behavior more predictable, but some of them might not always work as you might expect.
One of them is <code class="literal">reply-timeout</code> (at the method level or <code class="literal">default-reply-timeout</code> at the gateway level).
We examine the <code class="literal">reply-timeout</code> attribute to see how it can and cannot influence the behavior of the synchronous gateway in various scenarios.
We examine a single-threaded scenario (all components downstream are connected through a direct channel) and multi-threaded scenarios (for example,&nbsp;somewhere downstream you may have a pollable or executor channel that breaks the single-thread boundary).</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="long-running-process-downstream" href="#long-running-process-downstream"></a>Long-running Process Downstream</h4></div></div></div>

<div class="variablelist"><dl class="variablelist"><dt><span class="term">Sync Gateway, single-threaded</span></dt><dd>
If a component downstream is still running (perhaps because of an infinite loop or a slow service), setting a <code class="literal">reply-timeout</code> has no effect, and the gateway method call does not return until the downstream service exits (by returning or throwing an exception).
</dd><dt><span class="term">Sync&nbsp;Gateway, multi-threaded</span></dt><dd>
If a component downstream is still running (perhaps because of an infinite loop or a slow service) in a multi-threaded message flow, setting the <code class="literal">reply-timeout</code> has an effect by allowing gateway method invocation to return once the timeout has been reached, because the <code class="literal">GatewayProxyFactoryBean</code> &nbsp;polls on the reply channel, waiting for a message until the timeout expires.
However, if the timeout has been reached before the actual reply was produced, it could result in a <span class="emphasis"><em>null</em></span> return from the gateway method.&nbsp;
You should understand that the reply message (if produced) is sent to a reply channel after the gateway method invocation might have returned, so you must be aware of that and design your flow with it in mind.
</dd></dl></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_downstream_component_returns_emphasis_null_emphasis" href="#_downstream_component_returns_emphasis_null_emphasis"></a>Downstream Component Returns <span class="emphasis"><em>null</em></span></h4></div></div></div>

<div class="variablelist"><dl class="variablelist"><dt><span class="term">Sync Gateway&#8201;&#8212;&#8201;single-threaded</span></dt><dd>
If a component downstream returns <span class="emphasis"><em>null</em></span> and no <code class="literal">reply-timeout</code> has been configured, the gateway method call hangs indefinitely, unless a <code class="literal">reply-timeout</code> has been configured or the <code class="literal">requires-reply</code> attribute has been set on the downstream component (for example, a service activator) that might return <span class="emphasis"><em>null</em></span>.
In this case, an exception would be thrown and propagated to the gateway.
</dd><dt><span class="term">Sync Gateway&#8201;&#8212;&#8201;multi-threaded</span></dt><dd>
The behavior is the same as the previous case.
</dd></dl></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_downstream_component_return_signature_is_emphasis_void_emphasis_while_gateway_method_signature_is_non_void" href="#_downstream_component_return_signature_is_emphasis_void_emphasis_while_gateway_method_signature_is_non_void"></a>Downstream Component Return Signature is <span class="emphasis"><em>void</em></span> While Gateway Method Signature Is Non-void</h4></div></div></div>

<div class="variablelist"><dl class="variablelist"><dt><span class="term">Sync Gateway&#8201;&#8212;&#8201;single-threaded</span></dt><dd>
If a component downstream returns <span class="emphasis"><em>void</em></span> and no <code class="literal">reply-timeout</code> has been configured, the gateway method call hangs indefinitely unless a <code class="literal">reply-timeout</code> has been configured.
</dd><dt><span class="term">Sync Gateway&#8201;&#8212;&#8201;multi-threaded</span></dt><dd>
The behavior is the same as the previous case.
</dd></dl></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_downstream_component_results_in_runtime_exception" href="#_downstream_component_results_in_runtime_exception"></a>Downstream Component Results in Runtime Exception</h4></div></div></div>

<div class="variablelist"><dl class="variablelist"><dt><span class="term">Sync Gateway&#8201;&#8212;&#8201;single-threaded</span></dt><dd>
If a component downstream throws a runtime exception, the exception is propagated through an error message back to the gateway and re-thrown.
</dd><dt><span class="term">Sync Gateway&#8201;&#8212;&#8201;multi-threaded</span></dt><dd>
The behavior is the same as the previous case.
</dd></dl></div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>You should understand that, by default, <code class="literal">reply-timeout</code> is unbounded.
Consequently, if you do not explicitly set the <code class="literal">reply-timeout</code>, your gateway method invocation might hang indefinitely.
So, to make sure you analyze your flow and if there is even a remote possibility of one of these scenarios to occur, you should set the <code class="literal">reply-timeout</code> attribute to a "<span class="emphasis"><em>safe</em></span>" value.
Even better, you can set the <code class="literal">requires-reply</code> attribute of the downstream component to <span class="emphasis"><em>true</em></span> to ensure a timely response, as produced by the throwing of an exception as soon as that downstream component returns null internally.
However you should also realize that there are some scenarios (see <a class="link" href="#long-running-process-downstream" title="Long-running Process Downstream">the first one</a>) where <code class="literal">reply-timeout</code> does not help.
That means it is also important to analyze your message flow and decide when to use a synchronous gateway rather than an asynchrnous gateway.
As <a class="link" href="#async-gateway" title="10.4.10&nbsp;Asynchronous Gateway">described earlier</a>, the latter case is a matter of defining gateway methods that return <code class="literal">Future</code> instances.
Then you are guaranteed to receive that return value, and you have more granular control over the results of the invocation.
Also, when dealing with a router, you should remember that setting the <code class="literal">resolution-required</code> attribute to <span class="emphasis"><em>true</em></span> results in an exception thrown by the router if it can not resolve a particular channel.
Likewise, when dealing with a Filter, you can set the <code class="literal">throw-exception-on-rejection</code> attribute.
In both of these cases, the resulting flow behaves like it contain a service activator with the <span class="emphasis"><em>requires-reply</em></span> attribute.
In other words, it helps to ensure a timely response from the gateway method invocation.</p>
</td></tr></table></div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p><code class="literal">reply-timeout</code> is unbounded for <code class="literal">&lt;gateway/&gt;</code> elements (created by the <code class="literal">GatewayProxyFactoryBean</code>).
Inbound gateways for external integration (WS, HTTP, and so on) share many characteristics and attributes with these gateways.
However, for those inbound gateways, the default <code class="literal">reply-timeout</code> is 1000 milliseconds (one second).
If a downstream asynchronous hand-off is made to another thread, you may need to increase this attribute to allow enough time for the flow to complete before the gateway times out.</p>
</td></tr></table></div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>You should understand that the timer starts when the thread returns to the gateway&#8201;&#8212;&#8201;that is, when the flow completes or a message is handed off to another thread.
At that time, the calling thread starts waiting for the reply.
If the flow was completely synchronous, the reply is immediately available.
For asynchronous flows, the thread waits for up to this time.</p>
</td></tr></table></div>
<p>See <a class="xref" href="#java-dsl-gateway" title="11.19&nbsp;IntegrationFlow as Gateway">Section&nbsp;11.19, &#8220;<code class="literal">IntegrationFlow</code> as Gateway&#8221;</a> in the Java DSL chapter for options to define gateways through <code class="literal">IntegrationFlows</code>.</p>
</div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="service-activator" href="#service-activator"></a>10.5&nbsp;Service Activator</h2></div></div></div>

<p>The service activator is the endpoint type for connecting any Spring-managed object to an input channel so that it may play the role of a service.
If the service produces output, it may also be connected to an output channel.
Alternatively, an output-producing service may be located at the end of a processing pipeline or message flow, in which case the inbound message&#8217;s <code class="literal">replyChannel</code> header can be used.
This is the default behavior if no output channel is defined.
As with most of the configuration options described here, the same behavior actually applies for most of the other components.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="service-activator-namespace" href="#service-activator-namespace"></a>10.5.1&nbsp;Configuring Service Activator</h3></div></div></div>

<p>To create a service activator, use the <span class="emphasis"><em>service-activator</em></span> element with the <span class="emphasis"><em>input-channel</em></span> and <span class="emphasis"><em>ref</em></span> attributes, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:service-activator</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"exampleChannel"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"exampleHandler"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>The preceding configuration selects all the methods from the <code class="literal">exampleHandler</code> that meet one of the messaging requirements, which are as follows:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
annotated with <code class="literal">@ServiceActivator</code>
</li><li class="listitem">
is <code class="literal">public</code>
</li><li class="listitem">
not return <code class="literal">void</code> if <code class="literal">requiresReply == true</code>
</li></ul></div>
<p>The target method for invocation at runtime is selected for each request message by their <code class="literal">payload</code> type or as a fallback to the <code class="literal">Message&lt;?&gt;</code> type if such a method is present on target class.</p>
<p>Starting with version 5.0, one service method can be marked with the <code class="literal">@org.springframework.integration.annotation.Default</code> as a fallback for all non-matching cases.
This can be useful when using <a class="link" href="#content-type-conversion" title="10.1.7&nbsp;Content Type Conversion">content-type conversion</a> with the target method being invoked after conversion.</p>
<p>To delegate to an explicitly defined method of any object, you can add the <code class="literal">method</code> attribute, as the following example shows:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:service-activator</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"exampleChannel"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"somePojo"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"someMethod"</span><span class="hl-tag">/&gt;</span></pre>
<p>In either case, when the service method returns a non-null value, the endpoint tries to send the reply message to an appropriate reply channel.
To determine the reply channel, it first checks whether an <code class="literal">output-channel</code> was provided in the endpoint configuration, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:service-activator</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"exampleChannel"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"replyChannel"</span>
                       <span class="hl-attribute">ref</span>=<span class="hl-value">"somePojo"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"someMethod"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>If the method returns a result and no <code class="literal">output-channel</code> is defined, the framework then checks the request message&#8217;s <code class="literal">replyChannel</code> header value.
If that value is available, it then checks its type.
If it is a <code class="literal">MessageChannel</code>, the reply message is sent to that channel.
If it is a <code class="literal">String</code>, the endpoint tries to resolve the channel name to a channel instance.
If the channel cannot be resolved, a <code class="literal">DestinationResolutionException</code> is thrown.
It it can be resolved, the message is sent there.
If the request message does not have a <code class="literal">replyChannel</code> header and the <code class="literal">reply</code> object is a <code class="literal">Message</code>, its <code class="literal">replyChannel</code> header is consulted for a target destination.
This is the technique used for request-reply messaging in Spring Integration, and it is also an example of the return address pattern.</p>
<p>If your method returns a result and you want to discard it and end the flow, you should configure the <code class="literal">output-channel</code> to send to a <code class="literal">NullChannel</code>.
For convenience, the framework registers one with the name, <code class="literal">nullChannel</code>.
See <a class="xref" href="#channel-special-channels" title="6.1.6&nbsp;Special Channels">Section&nbsp;6.1.6, &#8220;Special Channels&#8221;</a> for more information.</p>
<p>The service activator is one of those components that is not required to produce a reply message.
If your method returns <code class="literal">null</code> or has a <code class="literal">void</code> return type, the service activator exits after the method invocation, without any signals.
This behavior can be controlled by the <code class="literal">AbstractReplyProducingMessageHandler.requiresReply</code> option, which is also exposed as <code class="literal">requires-reply</code> when configuring with the XML namespace.
If the flag is set to <code class="literal">true</code> and the method returns null, a <code class="literal">ReplyRequiredException</code> is thrown.</p>
<p>The argument in the service method could be either a message or an arbitrary type.
If the latter, then it is assumed to be a message payload, which is extracted from the message and injected into the service method.
We generally recommend this approach, as it follows and promotes a POJO model when working with Spring Integration.
Arguments may also have <code class="literal">@Header</code> or <code class="literal">@Headers</code> annotations, as described in <a class="xref" href="#annotations" title="E.5&nbsp;Annotation Support">Section&nbsp;E.5, &#8220;Annotation Support&#8221;</a>.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The service method is not required to have any arguments, which means you can implement event-style service activators (where all you care about is an invocation of the service method) and not worry about the contents of the message.
Think of it as a null JMS message.
An example use case for such an implementation is a simple counter or monitor of messages deposited on the input channel.</p>
</td></tr></table></div>
<p>Starting with version 4.1, the framework correctly converts message properties (<code class="literal">payload</code> and <code class="literal">headers</code>) to the Java 8 <code class="literal">Optional</code> POJO method parameters, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyBean {
    <span class="hl-keyword">public</span> String computeValue(Optional&lt;String&gt; payload,
               <em><span class="hl-annotation" style="color: gray">@Header(value="foo", required=false)</span></em> String foo1,
               <em><span class="hl-annotation" style="color: gray">@Header(value="foo")</span></em> Optional&lt;String&gt; foo2) {
        <span class="hl-keyword">if</span> (payload.isPresent()) {
            String value = payload.get();
            ...
        }
        <span class="hl-keyword">else</span> {
           ...
       }
    }

}</pre>
</div>
<p>We generally recommend using a <code class="literal">ref</code> attribute if the custom service activator handler implementation can be reused in other <code class="literal">&lt;service-activator&gt;</code> definitions.
However, if the custom service activator handler implementation is only used within a single definition of the <code class="literal">&lt;service-activator&gt;</code>, you can provide an inner bean definition, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:service-activator</span> <span class="hl-attribute">id</span>=<span class="hl-value">"exampleServiceActivator"</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"inChannel"</span>
            <span class="hl-attribute">output-channel</span> = <span class="hl-value">"outChannel"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"someMethod"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;beans:bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.something.ExampleServiceActivator"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:service-activator&gt;</span></pre>
</div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Using both the <code class="literal">ref</code> attribute and an inner handler definition in the same <code class="literal">&lt;service-activator&gt;</code> configuration is not allowed, as it creates an ambiguous condition and results in an exception being thrown.</p>
</td></tr></table></div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>If the <code class="literal">ref</code> attribute references a bean that extends <code class="literal">AbstractMessageProducingHandler</code> (such as handlers provided by the framework itself), the configuration is optimized by injecting the output channel into the handler directly.
In this case, each <code class="literal">ref</code> must be to a separate bean instance (or a <code class="literal">prototype</code>-scoped bean) or use the inner <code class="literal">&lt;bean/&gt;</code> configuration type.
If you inadvertently reference the same message handler from multiple beans, you get a configuration exception.</p>
</td></tr></table></div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_service_activators_and_the_spring_expression_language_spel" href="#_service_activators_and_the_spring_expression_language_spel"></a>Service Activators and the Spring Expression Language (SpEL)</h4></div></div></div>

<p>Since Spring Integration 2.0, service activators can also benefit from <a class="ulink" href="https://docs.spring.io/spring/docs/current/spring-framework-reference/core.html#expressions" target="_top">SpEL</a>.</p>
<p>For example, you can invoke any bean method without pointing to the bean in a <code class="literal">ref</code> attribute or including it as an inner bean definition, as follows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:service-activator</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"in"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"out"</span>
	<span class="hl-attribute">expression</span>=<span class="hl-value">"@accountService.processAccount(payload, headers.accountId)"</span><span class="hl-tag">/&gt;</span>

	<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"accountService"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"thing1.thing2.Account"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>In the preceding configuration, instead of injecting <span class="emphasis"><em>accountService</em></span> by using a <code class="literal">ref</code> or as an inner bean, we use SpEL&#8217;s <code class="literal">@beanId</code> notation and invoke a method that takes a type compatible with the message payload.
We also pass a header value.
Any valid SpEL expression can be evaluated against any content in the message.
For simple scenarios, your service activators need not reference a bean if all logic can be encapsulated in such an expression, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:service-activator</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"in"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"out"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"payload * 2"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>In the preceding configuration, our service logic is to multiply the payload value by two.
SpEL lets us handle it relatively easily.</p>
<p>See <a class="xref" href="#java-dsl-handle" title="11.10&nbsp;Service Activators and the .handle() method">Section&nbsp;11.10, &#8220;Service Activators and the <code class="literal">.handle()</code> method&#8221;</a> in the Java DSL chapter for more information about configuring service activator.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="async-service-activator" href="#async-service-activator"></a>10.5.2&nbsp;Asynchronous Service Activator</h3></div></div></div>

<p>The service activator is invoked by the calling thread.
This is an upstream thread if the input channel is a <code class="literal">SubscribableChannel</code> or a poller thread for a <code class="literal">PollableChannel</code>.
If the service returns a <code class="literal">ListenableFuture&lt;?&gt;</code>, the default action is to send that as the payload of the message sent to the output (or reply) channel.
Starting with version 4.3, you can now set the <code class="literal">async</code> attribute to <code class="literal">true</code> (by using <code class="literal">setAsync(true)</code> when using Java configuration).
If the service returns a <code class="literal">ListenableFuture&lt;?&gt;</code> when this the <code class="literal">async</code> attribute is set to <code class="literal">true</code>, the calling thread is released immediately and the reply message is sent on the thread (from within your service) that completes the future.
This is particularly advantageous for long-running services that use a <code class="literal">PollableChannel</code>, because the poller thread is released to perform other services within the framework.</p>
<p>If the service completes the future with an <code class="literal">Exception</code>, normal error processing occurs.
An <code class="literal">ErrorMessage</code> is sent to the <code class="literal">errorChannel</code> message header, if present. Otherwise, an <code class="literal">ErrorMessage</code> is sent to the default <code class="literal">errorChannel</code> (if available).</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="service-activator-return-type" href="#service-activator-return-type"></a>10.5.3&nbsp;Service Activator and Method Return Type</h3></div></div></div>

<p>The service method can return any type which becomes reply message payload.
In this case a new <code class="literal">Message&lt;?&gt;</code> object is created and all the headers from a request message are copied.
This works the same way for most Spring Integration <code class="literal">MessageHandler</code> implementations, when interaction is based on a POJO method invocation.</p>
<p>A complete <code class="literal">Message&lt;?&gt;</code> object can also be returned from the method.
However keep in mind that, unlike <a class="link" href="#transformer" title="9.1&nbsp;Transformer">transformers</a>, for a Service Activator this message will be modified by copying the headers from the request message if they are not already present in the returned message.
So, if your method parameter is a <code class="literal">Message&lt;?&gt;</code> and you copy some, but not all, existing headers in your service method, they will reappear in the reply message.
It is not a Service Activator responsibility to remove headers from a reply message and, pursuing the loosely-coupled principle, it is better to add a <code class="literal">HeaderFilter</code> in the integration flow.
Alternatively, a Transformer can be used instead of a Service Activator but, in that case, when returning a full <code class="literal">Message&lt;?&gt;</code> the method is completely responsible for the message, including copying request message headers (if needed).
You must ensure that important framework headers (e.g. <code class="literal">replyChannel</code>, <code class="literal">errorChannel</code>), if present, have to be preserved.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="delayer" href="#delayer"></a>10.6&nbsp;Delayer</h2></div></div></div>

<p>A delayer is a simple endpoint that lets a message flow be delayed by a certain interval.
When a message is delayed, the original sender does not block.
Instead, the delayed messages are scheduled with an instance of <code class="literal">org.springframework.scheduling.TaskScheduler</code> to be sent to the output channel after the delay has passed.
This approach is scalable even for rather long delays, since it does not result in a large number of blocked sender threads.
On the contrary, in the typical case, a thread pool is used for the actual execution of releasing the messages.
This section contains several examples of configuring a delayer.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="delayer-namespace" href="#delayer-namespace"></a>10.6.1&nbsp;Configuring a Delayer</h3></div></div></div>

<p>The <code class="literal">&lt;delayer&gt;</code> element is used to delay the message flow between two message channels.
As with the other endpoints, you can provide the <span class="emphasis"><em>input-channel</em></span> and <span class="emphasis"><em>output-channel</em></span> attributes, but the delayer also has <span class="emphasis"><em>default-delay</em></span> and <span class="emphasis"><em>expression</em></span> attributes (and the <span class="emphasis"><em>expression</em></span> element) that determine the number of milliseconds by which each message should be delayed.
The following example delays all messages by three seconds:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:delayer</span> <span class="hl-attribute">id</span>=<span class="hl-value">"delayer"</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span>
             <span class="hl-attribute">default-delay</span>=<span class="hl-value">"3000"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>If you need to determine the delay for each message, you can also provide the SpEL expression by using the <span class="emphasis"><em>expression</em></span> attribute, as the following expression shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:delayer</span> <span class="hl-attribute">id</span>=<span class="hl-value">"delayer"</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span>
             <span class="hl-attribute">default-delay</span>=<span class="hl-value">"3000"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"headers['delay']"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>In the preceding example, the three-second delay applies only when the expression evaluates to null for a given inbound message.
If you want to apply a delay only to messages that have a valid result of the expression evaluation, you can use a <span class="emphasis"><em>default-delay</em></span> of <code class="literal">0</code> (the default).
For any message that has a delay of <code class="literal">0</code> (or less), the message is sent immediately, on the calling thread.</p>
<p>The following example shows the Java configuration equivalent of the preceding example:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "input")</span></em>
<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> DelayHandler delayer() {
    DelayHandler handler = <span class="hl-keyword">new</span> DelayHandler(<span class="hl-string">"delayer.messageGroupId"</span>);
    handler.setDefaultDelay(<span class="hl-number">3</span>_<span class="hl-number">000L</span>);
    handler.setDelayExpressionString(<span class="hl-string">"headers['delay']"</span>);
    handler.setOutputChannelName(<span class="hl-string">"output"</span>);
    <span class="hl-keyword">return</span> handler;
}</pre>
</div>
<p>The following example shows the Java DSL equivalent of the preceding example:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> IntegrationFlow flow() {
    <span class="hl-keyword">return</span> IntegrationFlows.from(<span class="hl-string">"input"</span>)
            .delay(<span class="hl-string">"delayer.messageGroupId"</span>, d -&gt; d
                    .defaultDelay(<span class="hl-number">3</span>_<span class="hl-number">000L</span>)
                    .delayExpression(<span class="hl-string">"headers['delay']"</span>))
            .channel(<span class="hl-string">"output"</span>)
            .get();
}</pre>
</div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The XML parser uses a message group ID of <code class="literal">&lt;beanName&gt;.messageGroupId</code>.</p>
</td></tr></table></div>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>The delay handler supports expression evaluation results that represent an interval in milliseconds (any <code class="literal">Object</code> whose <code class="literal">toString()</code> method produces a value that can be parsed into a <code class="literal">Long</code>) as well as <code class="literal">java.util.Date</code> instances representing an absolute time.
In the first case, the milliseconds are counted from the current time (for example
a value of <code class="literal">5000</code> would delay the message for at least five seconds from the time it is received by the delayer).
With a <code class="literal">Date</code> instance, the message is not released until the time represented by that <code class="literal">Date</code> object.
A value that equates to a non-positive delay or a Date in the past results in no delay.
Instead, it is sent directly to the output channel on the original sender&#8217;s thread.
If the expression evaluation result is not a <code class="literal">Date</code> and can not be parsed as a <code class="literal">Long</code>, the default delay (if any&#8201;&#8212;&#8201;the default is <code class="literal">0</code>) is applied.</p>
</td></tr></table></div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>The expression evaluation may throw an evaluation exception for various reasons, including an invalid expression or other conditions.
By default, such exceptions are ignored (though logged at the DEBUG level) and the delayer falls back to the default delay (if any).
You can modify this behavior by setting the <code class="literal">ignore-expression-failures</code> attribute.
By default, this attribute is set to <code class="literal">true</code> and the delayer behavior is as described earlier.
However, if you wish to not ignore expression evaluation exceptions and throw them to the delayer&#8217;s caller, set the <code class="literal">ignore-expression-failures</code> attribute to <code class="literal">false</code>.</p>
</td></tr></table></div>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>In the preceding example, the delay expression is specified as <code class="literal">headers['delay']</code>.
This is the SpEL <code class="literal">Indexer</code> syntax to access a <code class="literal">Map</code> element (<code class="literal">MessageHeaders</code> implements <code class="literal">Map</code>).
It invokes: <code class="literal">headers.get("delay")</code>.
For simple map element names (that do not contain <span class="emphasis"><em>.</em></span>) you can also use the SpEL "<code class="literal">dot accessor</code>" syntax, where the header expression shown earlier can be specified as <code class="literal">headers.delay</code>.
However, different results are achieved if the header is missing.
In the first case, the expression evaluates to <code class="literal">null</code>.
The second results in something similar to the following:</p>
<div class="informalexample">
<pre class="programlisting"> org.springframework.expression.spel.SpelEvaluationException: EL1<span class="hl-number">008E</span>:(pos <span class="hl-number">8</span>):
		   Field or property <span class="hl-string">'delay'</span> cannot be found on object of type <span class="hl-string">'org.springframework.messaging.MessageHeaders'</span></pre>
</div>
<p>Consequently, if there is a possibility of the header being omitted and you want to fall back to the default delay, it is generally more efficient (and recommended) to use the indexer syntax instead of dot property accessor syntax, because detecting the null is faster than catching an exception.</p>
</td></tr></table></div>
<p>The delayer delegates to an instance of Spring&#8217;s <code class="literal">TaskScheduler</code> abstraction.
The default scheduler used by the delayer is the <code class="literal">ThreadPoolTaskScheduler</code> instance provided by Spring Integration on startup.
See <a class="xref" href="#namespace-taskscheduler" title="E.2&nbsp;Configuring the Task Scheduler">Section&nbsp;E.2, &#8220;Configuring the Task Scheduler&#8221;</a>.
If you want to delegate to a different scheduler, you can provide a reference through the delayer element&#8217;s <span class="emphasis"><em>scheduler</em></span> attribute, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:delayer</span> <span class="hl-attribute">id</span>=<span class="hl-value">"delayer"</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span>
    <span class="hl-attribute">expression</span>=<span class="hl-value">"headers.delay"</span>
    <span class="hl-attribute">scheduler</span>=<span class="hl-value">"exampleTaskScheduler"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;task:scheduler</span> <span class="hl-attribute">id</span>=<span class="hl-value">"exampleTaskScheduler"</span> <span class="hl-attribute">pool-size</span>=<span class="hl-value">"3"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>If you configure an external <code class="literal">ThreadPoolTaskScheduler</code>, you can set <code class="literal">waitForTasksToCompleteOnShutdown = true</code> on this property.
It allows successful completion of <span class="emphasis"><em>delay</em></span> tasks that are already in the execution state (releasing the message) when the application is shutdown.
Before Spring Integration 2.2, this property was available on the <code class="literal">&lt;delayer&gt;</code> element, because <code class="literal">DelayHandler</code> could create its own scheduler on the background.
Since 2.2, the delayer requires an external scheduler instance and <code class="literal">waitForTasksToCompleteOnShutdown</code> was deleted.
You should use the scheduler&#8217;s own configuration.</p>
</td></tr></table></div>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p><code class="literal">ThreadPoolTaskScheduler</code> has a property <code class="literal">errorHandler</code>, which can be injected with some implementation of <code class="literal">org.springframework.util.ErrorHandler</code>.
This handler allows processing an <code class="literal">Exception</code> from the thread of the scheduled task sending the delayed message.
By default, it uses an <code class="literal">org.springframework.scheduling.support.TaskUtils$LoggingErrorHandler</code>, and you can see a stack trace in the logs.
You might want to consider using an <code class="literal">org.springframework.integration.channel.MessagePublishingErrorHandler</code>, which sends an <code class="literal">ErrorMessage</code> into an <code class="literal">error-channel</code>, either from the failed message&#8217;s header or into the default <code class="literal">error-channel</code>.
This error handling is performed after a transaction rolls back (if present).
See <a class="xref" href="#delayer-release-failures" title="10.6.3&nbsp;Release Failures">Section&nbsp;10.6.3, &#8220;Release Failures&#8221;</a>.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="delayer-message-store" href="#delayer-message-store"></a>10.6.2&nbsp;Delayer and a Message Store</h3></div></div></div>

<p>The <code class="literal">DelayHandler</code> persists delayed messages into the message group in the provided <code class="literal">MessageStore</code>.
(The <span class="emphasis"><em>groupId</em></span> is based on the required <span class="emphasis"><em>id</em></span> attribute of the <code class="literal">&lt;delayer&gt;</code> element.)
A delayed message is removed from the <code class="literal">MessageStore</code> by the scheduled task immediately before the <code class="literal">DelayHandler</code> sends the message to the <code class="literal">output-channel</code>.
If the provided <code class="literal">MessageStore</code> is persistent (such as <code class="literal">JdbcMessageStore</code>), it provides the ability to not lose messages on the application shutdown.
After application startup, the <code class="literal">DelayHandler</code> reads messages from its message group in the <code class="literal">MessageStore</code> and reschedules them with a delay based on the original arrival time of the message (if the delay is numeric).
For messages where the delay header was a <code class="literal">Date</code>, that <code class="literal">Date</code> is used when rescheduling.
If a delayed message remains in the <code class="literal">MessageStore</code> more than its <span class="emphasis"><em>delay</em></span>, it is sent immediately after startup.</p>
<p>The <code class="literal">&lt;delayer&gt;</code> can be enriched with either of two mutually exclusive elements: <code class="literal">&lt;transactional&gt;</code> and <code class="literal">&lt;advice-chain&gt;</code>.
The <code class="literal">List</code> of these AOP advices is applied to the proxied internal <code class="literal">DelayHandler.ReleaseMessageHandler</code>, which has the responsibility to release the message, after the delay, on a <code class="literal">Thread</code> of the scheduled task.
It might be used, for example, when the downstream message flow throws an exception and the transaction of the <code class="literal">ReleaseMessageHandler</code> is rolled back.
In this case, the delayed message remains in the persistent <code class="literal">MessageStore</code>.
You can use any custom <code class="literal">org.aopalliance.aop.Advice</code> implementation within the <code class="literal">&lt;advice-chain&gt;</code>.
The <code class="literal">&lt;transactional&gt;</code> element defines a simple advice chain that has only the transactional advice.
The following example shows an <code class="literal">advice-chain</code> within a <code class="literal">&lt;delayer&gt;</code>:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:delayer</span> <span class="hl-attribute">id</span>=<span class="hl-value">"delayer"</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span>
    <span class="hl-attribute">expression</span>=<span class="hl-value">"headers.delay"</span>
    <span class="hl-attribute">message-store</span>=<span class="hl-value">"jdbcMessageStore"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:advice-chain&gt;</span>
        <span class="hl-tag">&lt;beans:ref</span> <span class="hl-attribute">bean</span>=<span class="hl-value">"customAdviceBean"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;tx:advice&gt;</span>
            <span class="hl-tag">&lt;tx:attributes&gt;</span>
                <span class="hl-tag">&lt;tx:method</span> <span class="hl-attribute">name</span>=<span class="hl-value">"*"</span> <span class="hl-attribute">read-only</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;/tx:attributes&gt;</span>
        <span class="hl-tag">&lt;/tx:advice&gt;</span>
    <span class="hl-tag">&lt;/int:advice-chain&gt;</span>
<span class="hl-tag">&lt;/int:delayer&gt;</span></pre>
</div>
<p>The <code class="literal">DelayHandler</code> can be exported as a JMX <code class="literal">MBean</code> with managed operations (<code class="literal">getDelayedMessageCount</code> and <code class="literal">reschedulePersistedMessages</code>), which allows the rescheduling of delayed persisted messages at runtime&#8201;&#8212;&#8201;for example, if the <code class="literal">TaskScheduler</code> has previously been stopped.
These operations can be invoked through a <code class="literal">Control Bus</code> command, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting">Message&lt;String&gt; delayerReschedulingMessage =
    MessageBuilder.withPayload(<span class="hl-string">"@'delayer.handler'.reschedulePersistedMessages()"</span>).build();
    controlBusChannel.send(delayerReschedulingMessage);</pre>
</div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>For more information regarding the message store, JMX, and the control bus, see <a class="xref" href="#system-management-chapter" title="12.&nbsp;System Management">Chapter&nbsp;12, <i>System Management</i></a>.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="delayer-release-failures" href="#delayer-release-failures"></a>10.6.3&nbsp;Release Failures</h3></div></div></div>

<p>Starting with version 5.0.8, there are two new properties on the delayer:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">maxAttempts</code> (default 5)
</li><li class="listitem">
<code class="literal">retryDelay</code> (default 1 second)
</li></ul></div>
<p>When a message is released, if the downstream flow fails, the release will be attempted after the <code class="literal">retryDelay</code>.
If the <code class="literal">maxAttempts</code> is reached, the message is discarded (unless the release is transactional, in which case the message will remain in the store, but will no longer be scheduled for release, until the application is restarted, or the <code class="literal">reschedulePersistedMessages()</code> method is invoked, as discussed above).</p>
<p>In addition, you can configure a <code class="literal">delayedMessageErrorChannel</code>; when a release fails, an <code class="literal">ErrorMessage</code> is sent to that channel with the exception as the payload and has the <code class="literal">originalMessage</code> property.
The <code class="literal">ErrorMessage</code> contains a header <code class="literal">IntegrationMessageHeaderAccessor.DELIVERY_ATTEMPT</code> containing the current count.</p>
<p>If the error flow consumes the error message and exits normally, no further action is taken; if the release is transactional, the transaction will commit and the message deleted from the store.
If the error flow throws an exception, the release will be retried up to <code class="literal">maxAttempts</code> as discussed above.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="scripting" href="#scripting"></a>10.7&nbsp;Scripting Support</h2></div></div></div>

<p>Spring Integration 2.1 added support for the <a class="ulink" href="http://jcp.org/aboutJava/communityprocess/pr/jsr223/" target="_top">JSR223 Scripting for Java specification</a>, introduced in Java version 6.
It lets you use scripts written in any supported language (including Ruby, JRuby, Javascript, and Groovy) to provide the logic for various integration components, similar to the way the Spring Expression Language (SpEL) is used in Spring Integration.
For more information about JSR223, see the <a class="ulink" href="https://docs.oracle.com/javase/8/docs/technotes/guides/scripting/prog_guide/api.html" target="_top">documentation</a>.</p>
<p>You need to include this dependency into your project:</p>
<div class="informalexample">
<p>
<b>Maven.&nbsp;</b>

</p><pre class="programlisting"><span class="hl-tag">&lt;dependency&gt;</span>
    <span class="hl-tag">&lt;groupId&gt;</span>org.springframework.integration<span class="hl-tag">&lt;/groupId&gt;</span>
    <span class="hl-tag">&lt;artifactId&gt;</span>spring-integration-scripting<span class="hl-tag">&lt;/artifactId&gt;</span>
    <span class="hl-tag">&lt;version&gt;</span>5.1.2.RELEASE<span class="hl-tag">&lt;/version&gt;</span>
<span class="hl-tag">&lt;/dependency&gt;</span></pre><p>

</p>
<p>
<b>Gradle.&nbsp;</b>

</p><pre class="programlisting">compile <span class="hl-string">"org.springframework.integration:spring-integration-scripting:5.1.2.RELEASE"</span></pre><p>

</p>
</div>
<p>In addition you need to add a script engine implementation, e.g. JRuby, Jython.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Note that this feature requires Java 6 or higher.</p>
</td></tr></table></div>
<p>In order to use a JVM scripting language, a JSR223 implementation for that language must be included in your class path.
Java 6 natively supports Javascript.
The <a class="ulink" href="http://www.groovy-lang.org/" target="_top">Groovy</a> and <a class="ulink" href="http://jruby.org/" target="_top">JRuby</a> projects provide JSR233 support in their standard distributions.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Various JSR223 language implementations have been developed by third parties.
A particular implementation&#8217;s compatibility with Spring Integration depends on how well it conforms to the specification and the implementer&#8217;s interpretation of the specification.</p>
</td></tr></table></div>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>If you plan to use Groovy as your scripting language, we recommended you use <a class="link" href="#groovy" title="10.8&nbsp;Groovy support">Spring-Integration&#8217;s Groovy Support</a> as it offers additional features specific to Groovy.
However, this section is relevant as well.</p>
</td></tr></table></div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="scripting-config" href="#scripting-config"></a>10.7.1&nbsp;Script Configuration</h3></div></div></div>

<p>Depending on the complexity of your integration requirements, scripts may be provided inline as CDATA in XML configuration&nbsp;or as a reference to a Spring resource that contains the script.
To enable scripting support, Spring Integration defines a <code class="literal">ScriptExecutingMessageProcessor</code>,&nbsp;which binds the message payload to a variable named <code class="literal">payload</code> and the message headers to a <code class="literal">headers</code> variable, both accessible within the script execution context.
All you need to do is write a script that uses these variables.
The following pair of examples show sample configurations that create filters:</p>
<div class="example"><a name="d5e7821" href="#d5e7821"></a><p class="title"><b>Example&nbsp;10.1.&nbsp;Filter</b></p><div class="example-contents">

<pre class="programlisting"><span class="hl-tag">&lt;int:filter</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"referencedScriptInput"</span><span class="hl-tag">&gt;</span>
   <span class="hl-tag">&lt;int-script:script</span> <span class="hl-attribute">lang</span>=<span class="hl-value">"ruby"</span> <span class="hl-attribute">location</span>=<span class="hl-value">"some/path/to/ruby/script/RubyFilterTests.rb"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:filter&gt;</span>

<span class="hl-tag">&lt;int:filter</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"inlineScriptInput"</span><span class="hl-tag">&gt;</span>
     <span class="hl-tag">&lt;int-script:script</span> <span class="hl-attribute">lang</span>=<span class="hl-value">"groovy"</span><span class="hl-tag">&gt;</span>
     <span class="hl-tag">&lt;![CDATA[</span>
     return payload == 'good'
   <span class="hl-tag">]]&gt;</span>
  <span class="hl-tag">&lt;/int-script:script&gt;</span>
<span class="hl-tag">&lt;/int:filter&gt;</span></pre>
</div></div><br class="example-break">
<p>As the preceding examples show, the script can be included inline or can be included by reference to a resource location (by using the <code class="literal">location</code> attribute).
Additionally, the <code class="literal">lang</code> attribute corresponds to the language name (or its JSR223 alias)</p>
<p>Other Spring Integration endpoint elements that support scripting include <code class="literal">router</code>, <code class="literal">service-activator</code>, <code class="literal">transformer</code>, and <code class="literal">splitter</code>.
The scripting configuration in each case would be identical to the above (besides the endpoint element).</p>
<p>Another useful feature of scripting support is the ability to update (reload) scripts without having to restart the application context.
To do so, specify the <code class="literal">refresh-check-delay</code> attribute on the <code class="literal">script</code> element, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-script:script&nbsp;location="..."</span> <span class="hl-attribute">refresh-check-delay</span>=<span class="hl-value">"5000"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>In the preceding example, the script location is checked for updates every 5 seconds.
If the script is updated, any invocation that occurs later than 5 seconds since the update results in running the new script.</p>
<p>Consider the following example:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-script:script&nbsp;location="..."</span> <span class="hl-attribute">refresh-check-delay</span>=<span class="hl-value">"0"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>In the preceding example, the context is updated with any script modifications as soon as such modification occurs, providing a simple mechanism for <span class="emphasis"><em>real-time</em></span> configuration.
Any negative value means the script is not reloaded after initialization of the application context.
This is the default behavior.
The following example shows a script that never updates:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-script:script&nbsp;location="..."</span> <span class="hl-attribute">refresh-check-delay</span>=<span class="hl-value">"-1"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Inline scripts can not be reloaded.</p>
</td></tr></table></div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="scripting-script-variable-bindings" href="#scripting-script-variable-bindings"></a>Script Variable Bindings</h4></div></div></div>

<p>Variable bindings are required to enable the script to reference variables externally provided to the script&#8217;s execution context.
By default, <code class="literal">payload</code> and <code class="literal">headers</code> are used as binding variables.
You can bind additional variables to a script by using <code class="literal">&lt;variable&gt;</code> elements, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;script:script</span> <span class="hl-attribute">lang</span>=<span class="hl-value">"js"</span> <span class="hl-attribute">location</span>=<span class="hl-value">"foo/bar/MyScript.js"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;script:variable</span> <span class="hl-attribute">name</span>=<span class="hl-value">"foo"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"thing1"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;script:variable</span> <span class="hl-attribute">name</span>=<span class="hl-value">"bar"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"thing2"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;script:variable</span> <span class="hl-attribute">name</span>=<span class="hl-value">"date"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"date"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/script:script&gt;</span></pre>
</div>
<p>As shown in the preceding example, you can bind a script variable either to a scalar value or to a Spring bean reference.
Note that <code class="literal">payload</code> and <code class="literal">headers</code> are still included as binding variables.</p>
<p>With Spring Integration 3.0, in addition to the <code class="literal">variable</code> element, the <code class="literal">variables</code> attribute has been introduced.
This attribute and the <code class="literal">variable</code> elements are not mutually exclusive, and you can combine them within one <code class="literal">script</code> component.
However, variables must be unique, regardless of where they are defined.
Also, since Spring Integration 3.0, variable bindings are allowed for inline scripts, too, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;service-activator</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;script:script</span> <span class="hl-attribute">lang</span>=<span class="hl-value">"ruby"</span> <span class="hl-attribute">variables</span>=<span class="hl-value">"thing1=THING1, date-ref=dateBean"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;script:variable</span> <span class="hl-attribute">name</span>=<span class="hl-value">"thing2"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"thing2Bean"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;script:variable</span> <span class="hl-attribute">name</span>=<span class="hl-value">"thing3"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"thing2"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;![CDATA[</span>
            payload.foo = thing1
            payload.date = date
            payload.bar = thing2
            payload.baz = thing3
            payload
        <span class="hl-tag">]]&gt;</span>
    <span class="hl-tag">&lt;/script:script&gt;</span>
<span class="hl-tag">&lt;/service-activator&gt;</span></pre>
</div>
<p>The preceding example shows a combination of an inline script, a <code class="literal">variable</code> element, and a <code class="literal">variables</code> attribute.
The <code class="literal">variables</code> attribute contains a comma-separated value, where each segment contains an <span class="emphasis"><em>=</em></span> separated pair of the variable and its value.
The variable name can be suffixed with <code class="literal">-ref</code>, as in the <code class="literal">date-ref</code> variable in the preceding example.
That means that the binding variable has the name, <code class="literal">date</code>, but the value is a reference to the <code class="literal">dateBean</code> bean from the application context.
This may be useful when using property placeholder configuration or command-line arguments.</p>
<p>If you need more control over how variables are generated, you can implement your own Java class that uses the <code class="literal">ScriptVariableGenerator</code> strategy, which is defined by the following interface:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> ScriptVariableGenerator {

    Map&lt;String, Object&gt; generateScriptVariables(Message&lt;?&gt; message);

}</pre>
</div>
<p>This interface requires you to implement the <code class="literal">generateScriptVariables(Message)</code> method.
The message argument lets you access any data available in the message payload and headers, and the return value is the <code class="literal">Map</code> of bound variables.
This method is called every time the script is executed for a message.
The following example shows how to provide an implementation of <code class="literal">ScriptVariableGenerator</code> and reference it with the <code class="literal">script-variable-generator</code> attribute:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-script:script</span> <span class="hl-attribute">location</span>=<span class="hl-value">"foo/bar/MyScript.groovy"</span>
        <span class="hl-attribute">script-variable-generator</span>=<span class="hl-value">"variableGenerator"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"variableGenerator"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"foo.bar.MyScriptVariableGenerator"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>If a <code class="literal">script-variable-generator</code> is not provided, script components use <code class="literal">DefaultScriptVariableGenerator</code>, which merges any provided <code class="literal">&lt;variable&gt;</code> elements with <code class="literal">payload</code> and <code class="literal">headers</code> variables from the <code class="literal">Message</code> in its <code class="literal">generateScriptVariables(Message)</code> method.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>You cannot provide both the <code class="literal">script-variable-generator</code> attribute and <code class="literal">&lt;variable&gt;</code> element(s).
They are mutually exclusive.</p>
</td></tr></table></div>
</div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="groovy" href="#groovy"></a>10.8&nbsp;Groovy support</h2></div></div></div>

<p>In Spring Integration 2.0, we added Groovy support, letting you use the Groovy scripting language to provide the logic for various integration components&#8201;&#8212;&#8201;similar to the way the Spring Expression Language (SpEL) is supported for routing, transformation, and other integration concerns.
For more information about Groovy, see the Groovy documentation, which you can find on the <a class="ulink" href="http://www.groovy-lang.org/" target="_top">project website</a>.</p>
<p>You need to include this dependency into your project:</p>
<div class="informalexample">
<p>
<b>Maven.&nbsp;</b>

</p><pre class="programlisting"><span class="hl-tag">&lt;dependency&gt;</span>
    <span class="hl-tag">&lt;groupId&gt;</span>org.springframework.integration<span class="hl-tag">&lt;/groupId&gt;</span>
    <span class="hl-tag">&lt;artifactId&gt;</span>spring-integration-groovy<span class="hl-tag">&lt;/artifactId&gt;</span>
    <span class="hl-tag">&lt;version&gt;</span>5.1.2.RELEASE<span class="hl-tag">&lt;/version&gt;</span>
<span class="hl-tag">&lt;/dependency&gt;</span></pre><p>

</p>
<p>
<b>Gradle.&nbsp;</b>

</p><pre class="programlisting">compile <span class="hl-string">"org.springframework.integration:spring-integration-groovy:5.1.2.RELEASE"</span></pre><p>

</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="groovy-config" href="#groovy-config"></a>10.8.1&nbsp;Groovy Configuration</h3></div></div></div>

<p>With Spring Integration 2.1, the configuration namespace for the Groovy support is an extension of Spring Integration&#8217;s scripting support and shares the core configuration and behavior described in detail in the <a class="xref" href="#scripting" title="10.7&nbsp;Scripting Support">Section&nbsp;10.7, &#8220;Scripting Support&#8221;</a> section.
Even though Groovy scripts are well supported by generic scripting support, the Groovy support provides the <code class="literal">Groovy</code> configuration namespace, which is backed by the Spring Framework&#8217;s <code class="literal">org.springframework.scripting.groovy.GroovyScriptFactory</code> and related components, offering extended capabilities for using Groovy.
The following listing shows two sample configurations:</p>
<div class="example"><a name="d5e7917" href="#d5e7917"></a><p class="title"><b>Example&nbsp;10.2.&nbsp;Filter</b></p><div class="example-contents">

<pre class="programlisting"><span class="hl-tag">&lt;int:filter</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"referencedScriptInput"</span><span class="hl-tag">&gt;</span>
   <span class="hl-tag">&lt;int-groovy:script</span> <span class="hl-attribute">location</span>=<span class="hl-value">"some/path/to/groovy/file/GroovyFilterTests.groovy"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:filter&gt;</span>

<span class="hl-tag">&lt;int:filter</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"inlineScriptInput"</span><span class="hl-tag">&gt;</span>
     <span class="hl-tag">&lt;int-groovy:script&gt;</span><span class="hl-tag">&lt;![CDATA[</span>
     return payload == 'good'
   <span class="hl-tag">]]&gt;</span><span class="hl-tag">&lt;/int-groovy:script&gt;</span>
<span class="hl-tag">&lt;/int:filter&gt;</span></pre>
</div></div><br class="example-break">
<p>As the preceding examples show, the configuration looks identical to the general scripting support configuration.
The only difference is the use of the Groovy namespace, as indicated by the <code class="literal">int-groovy</code> namespace prefix.
Also note that the <code class="literal">lang</code> attribute on the <code class="literal">&lt;script&gt;</code> tag is not valid in this namespace.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_groovy_object_customization" href="#_groovy_object_customization"></a>10.8.2&nbsp;Groovy Object Customization</h3></div></div></div>

<p>If you need to customize the Groovy object itself (beyond setting variables) you can reference a bean that implements <code class="literal">GroovyObjectCustomizer</code> by using the <code class="literal">customizer</code> attribute.
For example, this might be useful if you want to implement a domain-specific language (DSL) by modifying the <code class="literal">MetaClass</code> and registering functions to be available within the script.
The following example shows how to do so:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:service-activator</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"groovyChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int-groovy:script</span> <span class="hl-attribute">location</span>=<span class="hl-value">"somewhere/SomeScript.groovy"</span> <span class="hl-attribute">customizer</span>=<span class="hl-value">"groovyCustomizer"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:service-activator&gt;</span>

<span class="hl-tag">&lt;beans:bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"groovyCustomizer"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.something.MyGroovyObjectCustomizer"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>Setting a custom <code class="literal">GroovyObjectCustomizer</code> is not mutually exclusive with <code class="literal">&lt;variable&gt;</code> elements or the <code class="literal">script-variable-generator</code> attribute.
It can also be provided when defining an inline script.</p>
<p>Spring Integration 3.0 introduced the <code class="literal">variables</code> attribute, which works in conjunction with the <code class="literal">variable</code> element.
Also, groovy scripts have the ability to resolve a variable to a bean in the <code class="literal">BeanFactory</code>, if a binding variable was not provided with the name.
The following example shows how to use a variable (<code class="literal">entityManager</code>):</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-groovy:script&gt;</span>
    <span class="hl-tag">&lt;![CDATA[</span>
        entityManager.persist(payload)
        payload
    <span class="hl-tag">]]&gt;</span>
<span class="hl-tag">&lt;/int-groovy:script&gt;</span></pre>
</div>
<p><code class="literal">entityManager</code> must be an appropriate bean in the application context.</p>
<p>For more information regarding the <code class="literal">&lt;variable&gt;</code> element, the <code class="literal">variables</code> attribute, and the <code class="literal">script-variable-generator</code> attribute, see  <a class="xref" href="#scripting-script-variable-bindings" title="Script Variable Bindings">the section called &#8220;Script Variable Bindings&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_groovy_script_compiler_customization" href="#_groovy_script_compiler_customization"></a>10.8.3&nbsp;Groovy Script Compiler Customization</h3></div></div></div>

<p>The <code class="literal">@CompileStatic</code> hint is the most popular Groovy compiler customization option.
It can be used on the class or method level.
For more information, see the Groovy <a class="ulink" href="http://docs.groovy-lang.org/latest/html/documentation/index.html#_static_compilation" target="_top">Reference Manual</a> and, specifically, <a class="ulink" href="http://docs.groovy-lang.org/latest/html/documentation/index.html#compilestatic-annotation" target="_top">@CompileStatic</a>.
To utilize this feature for short scripts (in integration scenarios), we are forced to change simple scripts to more Java-like code.
Consider the following <code class="literal">&lt;filter&gt;</code> script:</p>
<div class="informalexample">
<pre class="programlisting">headers.type == <span class="hl-string">'good'</span></pre>
</div>
<p>The preceding script becomes the following method in Spring Integration:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@groovy.transform.CompileStatic</span></em>
String filter(Map headers) {
	headers.type == <span class="hl-string">'good'</span>
}

filter(headers)</pre>
</div>
<p>With that, the <code class="literal">filter()</code> method is transformed and compiled to static Java code, bypassing the Groovy
dynamic phases of invocation, such as <code class="literal">getProperty()</code> factories and <code class="literal">CallSite</code> proxies.</p>
<p>Starting with version 4.3, you can configure the Spring Integration Groovy components with the <code class="literal">compile-static</code> <code class="literal">boolean</code> option, specifying that <code class="literal">ASTTransformationCustomizer</code> for <code class="literal">@CompileStatic</code> should be added to the internal <code class="literal">CompilerConfiguration</code>.
With that in place, you can omit the method declaration with <code class="literal">@CompileStatic</code> in our script code and still get compiled
plain Java code.
In this case, the preceding script can be short but still needs to be a little more verbose than interpreted script, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting">binding.variables.headers.type == <span class="hl-string">'good'</span></pre>
</div>
<p>You must access the <code class="literal">headers</code> and <code class="literal">payload</code> (or any other) variables through the <code class="literal">groovy.lang.Script</code> <code class="literal">binding</code> property because, with <code class="literal">@CompileStatic</code>, we do not have the  dynamic <code class="literal">GroovyObject.getProperty()</code> capability.</p>
<p>In addition, we introduced the <code class="literal">compiler-configuration</code> bean reference.
With this attribute, you can provide any other required Groovy compiler customizations, such as <code class="literal">ImportCustomizer</code>.
For more information about this feature, see the Groovy Documentation for <a class="ulink" href="http://groovy.jmiguel.eu/groovy.codehaus.org/Advanced+compiler+configuration.html" target="_top">advanced compiler configuration</a>.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Using <code class="literal">compilerConfiguration</code> does not automatically add an <code class="literal">ASTTransformationCustomizer</code> for the <code class="literal">@CompileStatic</code> annotation, and it overrides the <code class="literal">compileStatic</code> option.
If you still need <code class="literal">CompileStatic</code>, you should manually add a <code class="literal">new ASTTransformationCustomizer(CompileStatic.class)</code> into the <code class="literal">CompilationCustomizers</code> of that custom <code class="literal">compilerConfiguration</code>.</p>
</td></tr></table></div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The Groovy compiler customization does not have any effect on the <code class="literal">refresh-check-delay</code> option, and reloadable scripts can be statically compiled, too.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="groovy-control-bus" href="#groovy-control-bus"></a>10.8.4&nbsp;Control Bus</h3></div></div></div>

<p>As described in (<a class="ulink" href="http://www.eaipatterns.com/ControlBus.html" target="_top">Enterprise Integration Patterns</a>), the idea behind the control bus is that you can use the same messaging system for monitoring and managing the components within the framework as is used for "<code class="literal">application-level</code>" messaging.
In Spring Integration, we build upon the adapters described earlier so that you can send Messages as a means of invoking exposed operations.
One option for those operations is Groovy scripts.
The following example configures a Groovy script for the control bus:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-groovy:control-bus</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"operationChannel"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>The control bus has an input channel that can be accessed to invoke operations on the beans in the application context.</p>
<p>The Groovy control bus runs messages on the input channel as Groovy scripts.
It takes a message, compiles the body to a script, customizes it with a <code class="literal">GroovyObjectCustomizer</code>, and runs it.
The control bus' <code class="literal">MessageProcessor</code> exposes all beans in the application context that are annotated with <code class="literal">@ManagedResource</code> and implement Spring&#8217;s <code class="literal">Lifecycle</code> interface or extend Spring&#8217;s <code class="literal">CustomizableThreadCreator</code> base class (for example, several of the <code class="literal">TaskExecutor</code> and <code class="literal">TaskScheduler</code> implementations).</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Be careful about using managed beans with custom scopes (such as <span class="emphasis"><em>request</em></span>) in the Control Bus' command scripts, especially inside an asynchronous message flow.
If <code class="literal">MessageProcessor</code> of the control bus cannot expose a bean from the application context, you may end up with some <code class="literal">BeansException</code> during the command script&#8217;s run.
For example, if a custom scope&#8217;s context is not established, the attempt to get a bean within that scope triggers a <code class="literal">BeanCreationException</code>.</p>
</td></tr></table></div>
<p>If you need to further customize the Groovy objects, you can also provide a reference to a bean that implements <code class="literal">GroovyObjectCustomizer</code> through the <code class="literal">customizer</code> attribute, as the following example shows:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-groovy:control-bus</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span>
        <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span>
        <span class="hl-attribute">customizer</span>=<span class="hl-value">"groovyCustomizer"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;beans:bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"groovyCustomizer"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.foo.MyGroovyObjectCustomizer"</span><span class="hl-tag">/&gt;</span></pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="message-handler-advice-chain" href="#message-handler-advice-chain"></a>10.9&nbsp;Adding Behavior to Endpoints</h2></div></div></div>

<p>Prior to Spring Integration 2.2, you could add behavior to an entire Integration flow by adding an AOP Advice to a poller&#8217;s <code class="literal">&lt;advice-chain/&gt;</code> element.
However, suppose you want to retry, say, just a REST Web Service call, and not any downstream endpoints.</p>
<p>For example, consider the following flow:</p>
<div class="informalexample">
<pre class="screen">inbound-adapter-&gt;poller-&gt;http-gateway1-&gt;http-gateway2-&gt;jdbc-outbound-adapter</pre>
</div>
<p>If you configure some retry-logic into an advice chain on the poller and the call to <code class="literal">http-gateway2</code> failed because of a network glitch, the retry causes both <code class="literal">http-gateway1</code> and <code class="literal">http-gateway2</code> to be called a second time.
Similarly, after a transient failure in the jdbc-outbound-adapter, both HTTP gateways are called a second time before again calling the <code class="literal">jdbc-outbound-adapter</code>.</p>
<p>Spring Integration 2.2 adds the ability to add behavior to individual endpoints.
This is achieved by the addition of the <code class="literal">&lt;request-handler-advice-chain/&gt;</code> element to many endpoints.
The following example shows how to the <code class="literal">&lt;request-handler-advice-chain/&gt;</code> element within an <code class="literal">outbound-gateway</code>:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-http:outbound-gateway</span> <span class="hl-attribute">id</span>=<span class="hl-value">"withAdvice"</span>
    <span class="hl-attribute">url-expression</span>=<span class="hl-value">"'http://localhost/test1'"</span>
    <span class="hl-attribute">request-channel</span>=<span class="hl-value">"requests"</span>
    <span class="hl-attribute">reply-channel</span>=<span class="hl-value">"nextChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:request-handler-advice-chain&gt;</span>
        <span class="hl-tag">&lt;ref</span> <span class="hl-attribute">bean</span>=<span class="hl-value">"myRetryAdvice"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;/request-handler-advice-chain&gt;</span>
<span class="hl-tag">&lt;/int-http:outbound-gateway&gt;</span></pre>
<p>In this case, <code class="literal">myRetryAdvice</code> is applied only locally to this gateway and does not apply to further actions taken downstream after the reply is sent to <code class="literal">nextChannel</code>.
The scope of the advice is limited to the endpoint itself.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>At this time, you cannot advise an entire <code class="literal">&lt;chain/&gt;</code> of endpoints.
The schema does not allow a <code class="literal">&lt;request-handler-advice-chain&gt;</code> as a child element of the chain itself.</p>
<p>However, a <code class="literal">&lt;request-handler-advice-chain&gt;</code> can be added to individual reply-producing endpoints within a <code class="literal">&lt;chain&gt;</code> element.
An exception is that, in a chain that produces no reply, because the last element in the chain is an <code class="literal">outbound-channel-adapter</code>, that last element cannot be advised.
If you need to advise such an element, it must be moved outside of the chain (with the <code class="literal">output-channel</code> of the chain being the <code class="literal">input-channel</code> of the adapter).
The adapter can then be advised as usual.
For chains that produce a reply, every child element can be advised.</p>
</td></tr></table></div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="advice-classes" href="#advice-classes"></a>10.9.1&nbsp;Provided Advice Classes</h3></div></div></div>

<p>In addition to providing the general mechanism to apply AOP advice classes, Spring Integration provides three standard advice classes:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">RequestHandlerRetryAdvice</code> (described in <a class="xref" href="#retry-advice" title="Retry Advice">the section called &#8220;Retry Advice&#8221;</a>)
</li><li class="listitem">
<code class="literal">RequestHandlerCircuitBreakerAdvice</code> (described in <a class="xref" href="#circuit-breaker-advice" title="Circuit Breaker Advice">the section called &#8220;Circuit Breaker Advice&#8221;</a>)
</li><li class="listitem">
<code class="literal">ExpressionEvaluatingRequestHandlerAdvice</code> (described in <a class="xref" href="#expression-advice" title="Expression Evaluating Advice">the section called &#8220;Expression Evaluating Advice&#8221;</a>)
</li></ul></div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="retry-advice" href="#retry-advice"></a>Retry Advice</h4></div></div></div>

<p>The retry advice (<code class="literal">o.s.i.handler.advice.RequestHandlerRetryAdvice</code>) leverages the rich retry mechanisms provided by the <a class="ulink" href="https://github.com/spring-projects/spring-retry" target="_top">Spring Retry</a> project.
The core component of <code class="literal">spring-retry</code> is the <code class="literal">RetryTemplate</code>, which allows configuration of sophisticated retry scenarios, including <code class="literal">RetryPolicy</code> and <code class="literal">BackoffPolicy</code> strategies (with a number of implementations) as well as a <code class="literal">RecoveryCallback</code> strategy to determine the action to take when retries are exhausted.</p>
<div class="variablelist"><dl class="variablelist"><dt><span class="term">Stateless Retry</span></dt><dd>
Stateless retry is the case where the retry activity is handled entirely within the advice. The thread pauses (if configured to do so) and retries the action.
</dd><dt><span class="term">Stateful Retry</span></dt><dd>
Stateful retry is the case where the retry state is managed within the advice but where an exception is thrown and the caller resubmits the request.
An example for stateful retry is when we want the message originator (for example,JMS) to be responsible for resubmitting, rather than performing it on the current thread.
Stateful retry needs some mechanism to detect a retried submission.
</dd></dl></div>
<p>For more information on <code class="literal">spring-retry</code>, see <a class="ulink" href="https://docs.spring.io/spring-integration/api/" target="_top">the project&#8217;s Javadoc</a> and the reference documentation for <a class="ulink" href="http://docs.spring.io/spring-batch/reference/html/retry.html" target="_top">Spring Batch</a>, where <code class="literal">spring-retry</code> originated.</p>
<div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Warning"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Warning]" src="images/warning.png"></td><th align="left">Warning</th></tr><tr><td align="left" valign="top">
<p>The default back off behavior is to not back off. Retries are attempted immediately.
Using a back off policy that causes threads to pause between attempts may cause performance issues, including excessive memory use and thread starvation.
In high-volume environments, back off policies should be used with caution.</p>
</td></tr></table></div>
<div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="retry-config" href="#retry-config"></a>Configuring the Retry Advice</h5></div></div></div>

<p>The examples in this section use the following <code class="literal">&lt;service-activator&gt;</code> that always throws an exception:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> FailingService {

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> service(String message) {
        <span class="hl-keyword">throw</span> <span class="hl-keyword">new</span> RuntimeException(<span class="hl-string">"error"</span>);
    }
}</pre>
</div>
<div class="variablelist"><dl class="variablelist"><dt><span class="term">Simple Stateless Retry</span></dt><dd>
<p class="simpara">The default <code class="literal">RetryTemplate</code> has a <code class="literal">SimpleRetryPolicy</code> which tries three times.
There is no <code class="literal">BackOffPolicy</code>, so the three attempts are made back-to-back-to-back with no delay between attempts.
There is no <code class="literal">RecoveryCallback</code>, so the result is to throw the exception to the caller after the final failed retry occurs.
In a Spring Integration environment, this final exception might be handled by using an <code class="literal">error-channel</code> on the inbound endpoint.
The following example uses <code class="literal">RetryTemplate</code> and shows its <code class="literal">DEBUG</code> output:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:service-activator</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"failer"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"service"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:request-handler-advice-chain&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.handler.advice.RequestHandlerRetryAdvice"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/request-handler-advice-chain&gt;</span>
<span class="hl-tag">&lt;/int:service-activator&gt;</span>

DEBUG [task-scheduler-2]preSend on channel 'input', message: [Payload=...]
DEBUG [task-scheduler-2]Retry: count=0
DEBUG [task-scheduler-2]Checking for rethrow: count=1
DEBUG [task-scheduler-2]Retry: count=1
DEBUG [task-scheduler-2]Checking for rethrow: count=2
DEBUG [task-scheduler-2]Retry: count=2
DEBUG [task-scheduler-2]Checking for rethrow: count=3
DEBUG [task-scheduler-2]Retry failed last attempt: count=3</pre>
</div>
</dd><dt><span class="term">Simple Stateless Retry with Recovery</span></dt><dd>
<p class="simpara">The following example adds a <code class="literal">RecoveryCallback</code> to the preceding example and uses an <code class="literal">ErrorMessageSendingRecoverer</code> to send an <code class="literal">ErrorMessage</code> to a channel:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:service-activator</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"failer"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"service"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:request-handler-advice-chain&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.handler.advice.RequestHandlerRetryAdvice"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"recoveryCallback"</span><span class="hl-tag">&gt;</span>
                <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.handler.advice.ErrorMessageSendingRecoverer"</span><span class="hl-tag">&gt;</span>
                    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"myErrorChannel"</span><span class="hl-tag"> /&gt;</span>
                <span class="hl-tag">&lt;/bean&gt;</span>
            <span class="hl-tag">&lt;/property&gt;</span>
        <span class="hl-tag">&lt;/bean&gt;</span>
    <span class="hl-tag">&lt;/request-handler-advice-chain&gt;</span>
<span class="hl-tag">&lt;/int:int:service-activator&gt;</span>

DEBUG [task-scheduler-2]preSend on channel 'input', message: [Payload=...]
DEBUG [task-scheduler-2]Retry: count=0
DEBUG [task-scheduler-2]Checking for rethrow: count=1
DEBUG [task-scheduler-2]Retry: count=1
DEBUG [task-scheduler-2]Checking for rethrow: count=2
DEBUG [task-scheduler-2]Retry: count=2
DEBUG [task-scheduler-2]Checking for rethrow: count=3
DEBUG [task-scheduler-2]Retry failed last attempt: count=3
DEBUG [task-scheduler-2]Sending ErrorMessage :failedMessage:[Payload=...]</pre>
</div>
</dd><dt><span class="term">Stateless Retry with Customized Policies, and Recovery</span></dt><dd>
<p class="simpara">For more sophistication, we can provide the advice with a customized <code class="literal">RetryTemplate</code>.
This example continues to use the <code class="literal">SimpleRetryPolicy</code> but increases the attempts to four.
It also adds an <code class="literal">ExponentialBackoffPolicy</code> where the first retry waits one second, the second waits five seconds and the third waits 25 (for four attempts in all).
The following listing shows the example and its <code class="literal">DEBUG</code> output:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:service-activator</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"failer"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"service"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:request-handler-advice-chain&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.handler.advice.RequestHandlerRetryAdvice"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"recoveryCallback"</span><span class="hl-tag">&gt;</span>
                <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.handler.advice.ErrorMessageSendingRecoverer"</span><span class="hl-tag">&gt;</span>
                    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"myErrorChannel"</span><span class="hl-tag"> /&gt;</span>
                <span class="hl-tag">&lt;/bean&gt;</span>
            <span class="hl-tag">&lt;/property&gt;</span>
            <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"retryTemplate"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"retryTemplate"</span><span class="hl-tag"> /&gt;</span>
        <span class="hl-tag">&lt;/bean&gt;</span>
    <span class="hl-tag">&lt;/request-handler-advice-chain&gt;</span>
<span class="hl-tag">&lt;/int:service-activator&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"retryTemplate"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.retry.support.RetryTemplate"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"retryPolicy"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.retry.policy.SimpleRetryPolicy"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"maxAttempts"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"4"</span><span class="hl-tag"> /&gt;</span>
        <span class="hl-tag">&lt;/bean&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"backOffPolicy"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.retry.backoff.ExponentialBackOffPolicy"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"initialInterval"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"1000"</span><span class="hl-tag"> /&gt;</span>
            <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"multiplier"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"5.0"</span><span class="hl-tag"> /&gt;</span>
            <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"maxInterval"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"60000"</span><span class="hl-tag"> /&gt;</span>
        <span class="hl-tag">&lt;/bean&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

27.058 DEBUG [task-scheduler-1]preSend on channel 'input', message: [Payload=...]
27.071 DEBUG [task-scheduler-1]Retry: count=0
27.080 DEBUG [task-scheduler-1]Sleeping for 1000
28.081 DEBUG [task-scheduler-1]Checking for rethrow: count=1
28.081 DEBUG [task-scheduler-1]Retry: count=1
28.081 DEBUG [task-scheduler-1]Sleeping for 5000
33.082 DEBUG [task-scheduler-1]Checking for rethrow: count=2
33.082 DEBUG [task-scheduler-1]Retry: count=2
33.083 DEBUG [task-scheduler-1]Sleeping for 25000
58.083 DEBUG [task-scheduler-1]Checking for rethrow: count=3
58.083 DEBUG [task-scheduler-1]Retry: count=3
58.084 DEBUG [task-scheduler-1]Checking for rethrow: count=4
58.084 DEBUG [task-scheduler-1]Retry failed last attempt: count=4
58.086 DEBUG [task-scheduler-1]Sending ErrorMessage :failedMessage:[Payload=...]</pre>
</div>
</dd><dt><span class="term">Namespace Support for Stateless Retry</span></dt><dd>
<p class="simpara">Starting with version 4.0, the preceding configuration can be greatly simplified, thanks to the namespace support for the retry advice, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:service-activator</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"failer"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"service"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:request-handler-advice-chain&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"retrier"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;/request-handler-advice-chain&gt;</span>
<span class="hl-tag">&lt;/int:service-activator&gt;</span>

<span class="hl-tag">&lt;int:handler-retry-advice</span> <span class="hl-attribute">id</span>=<span class="hl-value">"retrier"</span> <span class="hl-attribute">max-attempts</span>=<span class="hl-value">"4"</span> <span class="hl-attribute">recovery-channel</span>=<span class="hl-value">"myErrorChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:exponential-back-off</span> <span class="hl-attribute">initial</span>=<span class="hl-value">"1000"</span> <span class="hl-attribute">multiplier</span>=<span class="hl-value">"5.0"</span> <span class="hl-attribute">maximum</span>=<span class="hl-value">"60000"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/int:handler-retry-advice&gt;</span></pre>
</div>
<p class="simpara">In the preceding example, the advice is defined as a top-level bean so that it can be used in multiple <code class="literal">request-handler-advice-chain</code> instances.
You can also define the advice directly within the chain, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:service-activator</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"failer"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"service"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:request-handler-advice-chain&gt;</span>
        <span class="hl-tag">&lt;int:retry-advice</span> <span class="hl-attribute">id</span>=<span class="hl-value">"retrier"</span> <span class="hl-attribute">max-attempts</span>=<span class="hl-value">"4"</span> <span class="hl-attribute">recovery-channel</span>=<span class="hl-value">"myErrorChannel"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;int:exponential-back-off</span> <span class="hl-attribute">initial</span>=<span class="hl-value">"1000"</span> <span class="hl-attribute">multiplier</span>=<span class="hl-value">"5.0"</span> <span class="hl-attribute">maximum</span>=<span class="hl-value">"60000"</span><span class="hl-tag"> /&gt;</span>
        <span class="hl-tag">&lt;/int:retry-advice&gt;</span>
    <span class="hl-tag">&lt;/request-handler-advice-chain&gt;</span>
<span class="hl-tag">&lt;/int:service-activator&gt;</span></pre>
</div>
<p class="simpara">A <code class="literal">&lt;handler-retry-advice&gt;</code> can have a <code class="literal">&lt;fixed-back-off&gt;</code> or <code class="literal">&lt;exponential-back-off&gt;</code> child element or have no child element.
A <code class="literal">&lt;handler-retry-advice&gt;</code> with no child element uses no back off.
If there is no <code class="literal">recovery-channel</code>, the exception is thrown when retries are exhausted.
The namespace can only be used with stateless retry.</p>
<p class="simpara">For more complex environments (custom policies etc), use normal <code class="literal">&lt;bean&gt;</code> definitions.</p>
</dd><dt><span class="term">Simple Stateful Retry with Recovery</span></dt><dd>
<p class="simpara">To make retry stateful, we need to provide the advice with a <code class="literal">RetryStateGenerator</code> implementation.
This class is used to identify a message as being a resubmission so that the <code class="literal">RetryTemplate</code> can determine the current state of retry for this message.
The framework provides a <code class="literal">SpelExpressionRetryStateGenerator</code>, which determines the message identifier by using a SpEL expression.
This example again uses the default policies (three attempts with no back off).
As with stateless retry, these policies can be customized.
The following listing shows the example and its <code class="literal">DEBUG</code> output:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:service-activator</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"failer"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"service"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:request-handler-advice-chain&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.handler.advice.RequestHandlerRetryAdvice"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"retryStateGenerator"</span><span class="hl-tag">&gt;</span>
                <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.handler.advice.SpelExpressionRetryStateGenerator"</span><span class="hl-tag">&gt;</span>
                    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"headers['jms_messageId']"</span><span class="hl-tag"> /&gt;</span>
                <span class="hl-tag">&lt;/bean&gt;</span>
            <span class="hl-tag">&lt;/property&gt;</span>
            <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"recoveryCallback"</span><span class="hl-tag">&gt;</span>
                <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.handler.advice.ErrorMessageSendingRecoverer"</span><span class="hl-tag">&gt;</span>
                    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"myErrorChannel"</span><span class="hl-tag"> /&gt;</span>
                <span class="hl-tag">&lt;/bean&gt;</span>
            <span class="hl-tag">&lt;/property&gt;</span>
        <span class="hl-tag">&lt;/bean&gt;</span>
    <span class="hl-tag">&lt;/int:request-handler-advice-chain&gt;</span>
<span class="hl-tag">&lt;/int:service-activator&gt;</span>

24.351 DEBUG [Container#0-1]preSend on channel 'input', message: [Payload=...]
24.368 DEBUG [Container#0-1]Retry: count=0
24.387 DEBUG [Container#0-1]Checking for rethrow: count=1
24.387 DEBUG [Container#0-1]Rethrow in retry for policy: count=1
24.387 WARN  [Container#0-1]failure occurred in gateway sendAndReceive
org.springframework.integration.MessagingException: Failed to invoke handler
...
Caused by: java.lang.RuntimeException: foo
...
24.391 DEBUG [Container#0-1]Initiating transaction rollback on application exception
...
25.412 DEBUG [Container#0-1]preSend on channel 'input', message: [Payload=...]
25.412 DEBUG [Container#0-1]Retry: count=1
25.413 DEBUG [Container#0-1]Checking for rethrow: count=2
25.413 DEBUG [Container#0-1]Rethrow in retry for policy: count=2
25.413 WARN  [Container#0-1]failure occurred in gateway sendAndReceive
org.springframework.integration.MessagingException: Failed to invoke handler
...
Caused by: java.lang.RuntimeException: foo
...
25.414 DEBUG [Container#0-1]Initiating transaction rollback on application exception
...
26.418 DEBUG [Container#0-1]preSend on channel 'input', message: [Payload=...]
26.418 DEBUG [Container#0-1]Retry: count=2
26.419 DEBUG [Container#0-1]Checking for rethrow: count=3
26.419 DEBUG [Container#0-1]Rethrow in retry for policy: count=3
26.419 WARN  [Container#0-1]failure occurred in gateway sendAndReceive
org.springframework.integration.MessagingException: Failed to invoke handler
...
Caused by: java.lang.RuntimeException: foo
...
26.420 DEBUG [Container#0-1]Initiating transaction rollback on application exception
...
27.425 DEBUG [Container#0-1]preSend on channel 'input', message: [Payload=...]
27.426 DEBUG [Container#0-1]Retry failed last attempt: count=3
27.426 DEBUG [Container#0-1]Sending ErrorMessage :failedMessage:[Payload=...]</pre>
</div>
<p class="simpara">If you compare the preceding example with the stateless examples, you can see that, with stateful retry, the exception is thrown to the caller on each failure.</p>
</dd><dt><span class="term">Exception Classification for Retry</span></dt><dd>
<p class="simpara">Spring Retry has a great deal of flexibility for determining which exceptions can invoke retry.
The default configuration retries for all exceptions and the exception classifier looks at the top-level exception.
If you configure it to, say, retry only on <code class="literal">MyException</code> and your application throws a <code class="literal">SomeOtherException</code> where the cause is a <code class="literal">MyException</code>, retry does not occur.</p>
<p class="simpara">Since Spring Retry 1.0.3, the <code class="literal">BinaryExceptionClassifier</code> has a property called <code class="literal">traverseCauses</code> (the default is <code class="literal">false</code>).
When <code class="literal">true</code>, it traverses exception causes until it finds a match or runs out of causes to traverse.</p>
<p class="simpara">To use this classifier for retry, use a <code class="literal">SimpleRetryPolicy</code> created with the constructor that takes the max attempts, the <code class="literal">Map</code> of <code class="literal">Exception</code> objects, and the <code class="literal">traverseCauses</code> boolean. Then you can inject this policy into the <code class="literal">RetryTemplate</code>.</p>
</dd></dl></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="circuit-breaker-advice" href="#circuit-breaker-advice"></a>Circuit Breaker Advice</h4></div></div></div>

<p>The general idea of the circuit breaker pattern is that, if a service is not currently available, do not waste time (and resources) trying to use it.
The <code class="literal">o.s.i.handler.advice.RequestHandlerCircuitBreakerAdvice</code> implements this pattern.
When the circuit breaker is in the closed state, the endpoint attempts to invoke the service.
The circuit breaker goes to the open state if a certain number of consecutive attempts fail.
When it is in the open state, new requests "<code class="literal">fail fast</code>" and no attempt is made to invoke the service until some time has expired.</p>
<p>When that time has expired, the circuit breaker is set to the half-open state.
When in this state, if even a single attempt fails, the breaker immediately goes to the open state.
If the attempt succeeds, the breaker goes to the closed state, in which case it does not go to the open state again until the configured number of consecutive failures again occur.
Any successful attempt resets the state to zero failures for the purpose of determining when the breaker might go to the open state again.</p>
<p>Typically, this advice might be used for external services, where it might take some time to fail (such as a timeout attempting to make a network connection).</p>
<p>The <code class="literal">RequestHandlerCircuitBreakerAdvice</code> has two properties: <code class="literal">threshold</code> and <code class="literal">halfOpenAfter</code>.
The <code class="literal">threshold</code> property represents the number of consecutive failures that need to occur before the breaker goes open.
It defaults to <code class="literal">5</code>.
The <code class="literal">halfOpenAfter</code> property represents the time after the last failure that the breaker waits before attempting another request.
The default is 1000 milliseconds.</p>
<p>The following example configures a circuit breaker and shows its <code class="literal">DEBUG</code> and <code class="literal">ERROR</code> output:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:service-activator</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"failer"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"service"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:request-handler-advice-chain&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.handler.advice.RequestHandlerCircuitBreakerAdvice"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"threshold"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"2"</span><span class="hl-tag"> /&gt;</span>
            <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"halfOpenAfter"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"12000"</span><span class="hl-tag"> /&gt;</span>
        <span class="hl-tag">&lt;/bean&gt;</span>
    <span class="hl-tag">&lt;/int:request-handler-advice-chain&gt;</span>
<span class="hl-tag">&lt;/int:service-activator&gt;</span>

05.617 DEBUG [task-scheduler-1]preSend on channel 'input', message: [Payload=...]
05.638 ERROR [task-scheduler-1]org.springframework.messaging.MessageHandlingException: java.lang.RuntimeException: foo
...
10.598 DEBUG [task-scheduler-2]preSend on channel 'input', message: [Payload=...]
10.600 ERROR [task-scheduler-2]org.springframework.messaging.MessageHandlingException: java.lang.RuntimeException: foo
...
15.598 DEBUG [task-scheduler-3]preSend on channel 'input', message: [Payload=...]
15.599 ERROR [task-scheduler-3]org.springframework.messaging.MessagingException: Circuit Breaker is Open for ServiceActivator
...
20.598 DEBUG [task-scheduler-2]preSend on channel 'input', message: [Payload=...]
20.598 ERROR [task-scheduler-2]org.springframework.messaging.MessagingException: Circuit Breaker is Open for ServiceActivator
...
25.598 DEBUG [task-scheduler-5]preSend on channel 'input', message: [Payload=...]
25.601 ERROR [task-scheduler-5]org.springframework.messaging.MessageHandlingException: java.lang.RuntimeException: foo
...
30.598 DEBUG [task-scheduler-1]preSend on channel 'input', message: [Payload=foo...]
30.599 ERROR [task-scheduler-1]org.springframework.messaging.MessagingException: Circuit Breaker is Open for ServiceActivator</pre>
</div>
<p>In the preceding example, the threshold is set to <code class="literal">2</code> and <code class="literal">halfOpenAfter</code> is set to <code class="literal">12</code> seconds.
A new request arrives every 5 seconds.
The first two attempts invoked the service.
The third and fourth failed with an exception indicating that the circuit breaker is open.
The fifth request was attempted because the request was 15 seconds after the last failure.
The sixth attempt fails immediately because the breaker immediately went to open.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="expression-advice" href="#expression-advice"></a>Expression Evaluating Advice</h4></div></div></div>

<p>The final supplied advice class is the <code class="literal">o.s.i.handler.advice.ExpressionEvaluatingRequestHandlerAdvice</code>.
This advice is more general than the other two advices.
It provides a mechanism to evaluate an expression on the original inbound message sent to the endpoint.
Separate expressions are available to be evaluated, after either success or failure.
Optionally, a message containing the evaluation result, together with the input message, can be sent to a message channel.</p>
<p>A typical use case for this advice might be with an <code class="literal">&lt;ftp:outbound-channel-adapter/&gt;</code>, perhaps to move the file to one directory if the transfer was successful or to another directory if it fails:</p>
<p>The advice has properties to set an expression when successful, an expression for failures, and corresponding channels for each.
For the successful case, the message sent to the <code class="literal">successChannel</code> is an <code class="literal">AdviceMessage</code>, with the payload being the result of the expression evaluation.
An additional property, called <code class="literal">inputMessage</code>, contains the original message sent to the handler.
A message sent to the <code class="literal">failureChannel</code> (when the handler throws an exception) is an <code class="literal">ErrorMessage</code> with a payload of <code class="literal">MessageHandlingExpressionEvaluatingAdviceException</code>.
Like all <code class="literal">MessagingException</code> instances, this payload has <code class="literal">failedMessage</code> and <code class="literal">cause</code> properties, as well as an additional property called <code class="literal">evaluationResult</code>, which contains the result of the expression evaluation.</p>
<p>When an exception is thrown in the scope of the advice, by default, that exception is thrown to the caller after any <code class="literal">failureExpression</code> is evaluated.
If you wish to suppress throwing the exception, set the <code class="literal">trapException</code> property to <code class="literal">true</code>.
The following advice shows how to configure an advice with Java DSL:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@SpringBootApplication</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> EerhaApplication {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
        ConfigurableApplicationContext context = SpringApplication.run(EerhaApplication.<span class="hl-keyword">class</span>, args);
        MessageChannel in = context.getBean(<span class="hl-string">"advised.input"</span>, MessageChannel.<span class="hl-keyword">class</span>);
        in.send(<span class="hl-keyword">new</span> GenericMessage&lt;&gt;(<span class="hl-string">"good"</span>));
        in.send(<span class="hl-keyword">new</span> GenericMessage&lt;&gt;(<span class="hl-string">"bad"</span>));
        context.close();
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> IntegrationFlow advised() {
        <span class="hl-keyword">return</span> f -&gt; f.handle((GenericHandler&lt;String&gt;) (payload, headers) -&gt; {
            <span class="hl-keyword">if</span> (payload.equals(<span class="hl-string">"good"</span>)) {
                <span class="hl-keyword">return</span> null;
            }
            <span class="hl-keyword">else</span> {
                <span class="hl-keyword">throw</span> <span class="hl-keyword">new</span> RuntimeException(<span class="hl-string">"some failure"</span>);
            }
        }, c -&gt; c.advice(expressionAdvice()));
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> Advice expressionAdvice() {
        ExpressionEvaluatingRequestHandlerAdvice advice = <span class="hl-keyword">new</span> ExpressionEvaluatingRequestHandlerAdvice();
        advice.setSuccessChannelName(<span class="hl-string">"success.input"</span>);
        advice.setOnSuccessExpressionString(<span class="hl-string">"payload + ' was successful'"</span>);
        advice.setFailureChannelName(<span class="hl-string">"failure.input"</span>);
        advice.setOnFailureExpressionString(
                <span class="hl-string">"payload + ' was bad, with reason: ' + #exception.cause.message"</span>);
        advice.setTrapException(true);
        <span class="hl-keyword">return</span> advice;
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> IntegrationFlow success() {
        <span class="hl-keyword">return</span> f -&gt; f.handle(System.out::println);
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> IntegrationFlow failure() {
        <span class="hl-keyword">return</span> f -&gt; f.handle(System.out::println);
    }

}</pre>
</div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="custom-advice" href="#custom-advice"></a>10.9.2&nbsp;Custom Advice Classes</h3></div></div></div>

<p>In addition to the provided advice classes <a class="link" href="#advice-classes" title="10.9.1&nbsp;Provided Advice Classes">described earlier</a>, you can implement your own advice classes.
While you can provide any implementation of <code class="literal">org.aopalliance.aop.Advice</code> (usually <code class="literal">org.aopalliance.intercept.MethodInterceptor</code>), we generally recommend that you subclass <code class="literal">o.s.i.handler.advice.AbstractRequestHandlerAdvice</code>.
This has the benefit of avoiding the writing of low-level aspect-oriented programming code as well as providing a starting point that is specifically tailored for use in this environment.</p>
<p>Subclasses need to implement the <code class="literal">doInvoke()`</code> method, the definition of which follows:</p>
<div class="informalexample">
<pre class="programlisting"><strong class="hl-tag" style="color: blue">/**
 * Subclasses implement this method to apply behavior to the {@link MessageHandler} callback.execute()
 * invokes the handler method and returns its result, or null).
 * @param callback Subclasses invoke the execute() method on this interface to invoke the handler method.
 * @param target The target handler.
 * @param message The message that will be sent to the handler.
 * @return the result after invoking the {@link MessageHandler}.
 * @throws Exception
 */</strong>
<span class="hl-keyword">protected</span> <span class="hl-keyword">abstract</span> Object doInvoke(ExecutionCallback callback, Object target, Message&lt;?&gt; message) <span class="hl-keyword">throws</span> Exception;</pre>
</div>
<p>The callback parameter is a convenience to avoid subclasses that deal with AOP directly.
Invoking the <code class="literal">callback.execute()</code> method invokes the message handler.</p>
<p>The <code class="literal">target</code> parameter is provided for those subclasses that need to maintain state for a specific handler, perhaps by maintaining that state in a <code class="literal">Map</code> keyed by the target.
This feature allows the same advice to be applied to multiple handlers.
The <code class="literal">RequestHandlerCircuitBreakerAdvice</code> uses advice this to keep circuit breaker state for each handler.</p>
<p>The <code class="literal">message</code> parameter is the message sent to the handler.
While the advice cannot modify the message before invoking the handler, it can modify the payload (if it has mutable properties).
Typically, an advice would use the message for logging or to send a copy of the message somewhere before or after invoking the handler.</p>
<p>The return value would normally be the value returned by <code class="literal">callback.execute()</code>.
However, the advice does have the ability to modify the return value.
Note that only <code class="literal">AbstractReplyProducingMessageHandler</code> instances return values.
The following example shows a custom advice class that extends <code class="literal">AbstractRequestHandlerAdvice</code>:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyAdvice <span class="hl-keyword">extends</span> AbstractRequestHandlerAdvice {

    <em><span class="hl-annotation" style="color: gray">@Override</span></em>
    <span class="hl-keyword">protected</span> Object doInvoke(ExecutionCallback callback, Object target, Message&lt;?&gt; message) <span class="hl-keyword">throws</span> Exception {
        <span class="hl-comment">// add code before the invocation</span>
        Object result = callback.execute();
        <span class="hl-comment">// add code after the invocation</span>
        <span class="hl-keyword">return</span> result;
    }
}</pre>
</div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>In addition to the <code class="literal">execute()</code> method, <code class="literal">ExecutionCallback</code> provides an additional method: <code class="literal">cloneAndExecute()</code>.
This method must be used in cases where the invocation might be called multiple times within a single execution of <code class="literal">doInvoke()</code>, such as in the <code class="literal">RequestHandlerRetryAdvice</code>.
This is required because the Spring AOP <code class="literal">org.springframework.aop.framework.ReflectiveMethodInvocation</code> object maintains state by keeping track of which advice in a chain was last invoked.
This state must be reset for each call.</p>
<p>For more information, see the <a class="ulink" href="http://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/aop/framework/ReflectiveMethodInvocation.html" target="_top">ReflectiveMethodInvocation</a> Javadoc.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="other-advice" href="#other-advice"></a>10.9.3&nbsp;Other Advice Chain Elements</h3></div></div></div>

<p>While the abstract class mentioned above is a convenience, you can add any <code class="literal">Advice</code>, including a transaction advice, to the chain.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="handle-message-advice" href="#handle-message-advice"></a>10.9.4&nbsp;Handling Message Advice</h3></div></div></div>

<p>As discussed in <a class="link" href="#message-handler-advice-chain" title="10.9&nbsp;Adding Behavior to Endpoints">the introduction to this section</a>, advice objects in a request handler advice chain are applied to just the current endpoint, not the downstream flow (if any).
For <code class="literal">MessageHandler</code> objects that produce a reply (such as those that extend <code class="literal">AbstractReplyProducingMessageHandler</code>), the advice is applied to an internal method: <code class="literal">handleRequestMessage()</code> (called from <code class="literal">MessageHandler.handleMessage()</code>).
For other message handlers, the advice is applied to <code class="literal">MessageHandler.handleMessage()</code>.</p>
<p>There are some circumstances where, even if a message handler is an <code class="literal">AbstractReplyProducingMessageHandler</code>, the advice must be applied to the <code class="literal">handleMessage</code> method.
For example, the <a class="link" href="#idempotent-receiver" title="10.9.10&nbsp;Idempotent Receiver Enterprise Integration Pattern">idempotent receiver</a> might return <code class="literal">null</code>, which would cause an exception if the handler&#8217;s <code class="literal">replyRequired</code> property is set to <code class="literal">true</code>.
Another example is the <code class="literal">BoundRabbitChannelAdvice</code>&#8201;&#8212;&#8201;see <a class="xref" href="#amqp-strict-ordering" title="14.13&nbsp;Strict Message Ordering">Section&nbsp;14.13, &#8220;Strict Message Ordering&#8221;</a>.</p>
<p>Starting with version 4.3.1, a new <code class="literal">HandleMessageAdvice</code> interface and its base implementation (<code class="literal">AbstractHandleMessageAdvice</code>) have been introduced.
<code class="literal">Advice</code> objects that implement <code class="literal">HandleMessageAdvice</code> are always applied to the <code class="literal">handleMessage()</code> method, regardless of the handler type.</p>
<p>It is important to understand that <code class="literal">HandleMessageAdvice</code> implementations (such as <a class="link" href="#idempotent-receiver" title="10.9.10&nbsp;Idempotent Receiver Enterprise Integration Pattern">idempotent receiver</a>), when applied to a handlers that return responses, are dissociated from the <code class="literal">adviceChain</code> and properly applied to the <code class="literal">MessageHandler.handleMessage()</code> method.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Because of this disassociation, the advice chain order is not honored.</p>
</td></tr></table></div>
<p>Consider the following configuration:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;some-reply-producing-endpoint</span> <span class="hl-attribute">...</span><span class="hl-tag"> &gt;</span>
    <span class="hl-tag">&lt;int:request-handler-advice-chain&gt;</span>
        <span class="hl-tag">&lt;tx:advice</span> <span class="hl-attribute">...</span><span class="hl-tag"> /&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"myHandleMessageAdvice"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;/int:request-handler-advice-chain&gt;</span>
<span class="hl-tag">&lt;/some-reply-producing-endpoint&gt;</span></pre>
</div>
<p>In the preceding example, the <code class="literal">&lt;tx:advice&gt;</code> is applied to the <code class="literal">AbstractReplyProducingMessageHandler.handleRequestMessage()</code>.
However, <code class="literal">myHandleMessageAdvice</code> is applied for to <code class="literal">MessageHandler.handleMessage()</code>.
Therefore, it is invoked <span class="strong"><strong>before</strong></span> the <code class="literal">&lt;tx:advice&gt;</code>.
To retain the order, you should follow the standard <a class="ulink" href="http://docs.spring.io/spring/docs/current/spring-framework-reference/html/aop-api.html" target="_top">Spring AOP</a> configuration approach and use an endpoint <code class="literal">id</code> together with the <code class="literal">.handler</code> suffix to obtain the target <code class="literal">MessageHandler</code> bean.
Note that, in that case, the entire downstream flow is within the transaction scope.</p>
<p>In the case of a <code class="literal">MessageHandler</code> that does not return a response, the advice chain order is retained.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="tx-handle-message-advice" href="#tx-handle-message-advice"></a>10.9.5&nbsp;Transaction Support</h3></div></div></div>

<p>Starting with version 5.0, a new <code class="literal">TransactionHandleMessageAdvice</code> has been introduced to make the whole downstream flow transactional, thanks to the <code class="literal">HandleMessageAdvice</code> implementation.
When a regular <code class="literal">TransactionInterceptor</code> is used in the <code class="literal">&lt;request-handler-advice-chain&gt;</code> element (for example, through configuring <code class="literal">&lt;tx:advice&gt;</code>), a started transaction is only applied only for an internal <code class="literal">AbstractReplyProducingMessageHandler.handleRequestMessage()</code> and is not propagated to the downstream flow.</p>
<p>To simplify XML configuration, along with the <code class="literal">&lt;request-handler-advice-chain&gt;</code>, a <code class="literal">&lt;transactional&gt;</code> element has been added to all <code class="literal">&lt;outbound-gateway&gt;</code> and <code class="literal">&lt;service-activator&gt;</code> and related components.
The following example shows <code class="literal">&lt;transactional&gt;</code> in use:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-rmi:outbound-gateway</span> <span class="hl-attribute">remote-channel</span>=<span class="hl-value">"foo"</span> <span class="hl-attribute">host</span>=<span class="hl-value">"localhost"</span>
    <span class="hl-attribute">request-channel</span>=<span class="hl-value">"good"</span> <span class="hl-attribute">reply-channel</span>=<span class="hl-value">"reply"</span> <span class="hl-attribute">port</span>=<span class="hl-value">"#{@port}"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;int-rmi:transactional/&gt;</span>
<span class="hl-tag">&lt;/int-rmi:outbound-gateway&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"transactionManager"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.mockito.Mockito"</span> <span class="hl-attribute">factory-method</span>=<span class="hl-value">"mock"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"org.springframework.transaction.PlatformTransactionManager"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
<p>If you are familiar with the <a class="link" href="#jpa" title="22.&nbsp;JPA Support">JPA integration components</a>, such a configuration is not new, but now we can start a transaction from any point in our flow&#8201;&#8212;&#8201;not only from the <code class="literal">&lt;poller&gt;</code> or a message-driven channel adapter such as <a class="link" href="#jms-message-driven-channel-adapter" title="23.2&nbsp;Message-driven Channel Adapter">JMS</a>.</p>
<p>Java configuration can be simplified by using the <code class="literal">TransactionInterceptorBuilder</code>, and the result bean name can be used in the <a class="link" href="#annotations" title="E.5&nbsp;Annotation Support">messaging annotations</a> <code class="literal">adviceChain</code> attribute, as the following example shows:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> ConcurrentMetadataStore store() {
    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> SimpleMetadataStore(hazelcastInstance()
                       .getMap(<span class="hl-string">"idempotentReceiverMetadataStore"</span>));
}

<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> IdempotentReceiverInterceptor idempotentReceiverInterceptor() {
    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> IdempotentReceiverInterceptor(
            <span class="hl-keyword">new</span> MetadataStoreSelector(
                    message -&gt; message.getPayload().toString(),
                    message -&gt; message.getPayload().toString().toUpperCase(), store()));
}

<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> TransactionInterceptor transactionInterceptor() {
    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> TransactionInterceptorBuilder(true)
                .transactionManager(<span class="hl-keyword">this</span>.transactionManager)
                .isolation(Isolation.READ_COMMITTED)
                .propagation(Propagation.REQUIRES_NEW)
                .build();
}

<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<em><span class="hl-annotation" style="color: gray">@org.springframework.integration.annotation.Transformer(inputChannel = "input",
         outputChannel = "output",
         adviceChain = { "idempotentReceiverInterceptor",
                 "transactionInterceptor" })</span></em>
<span class="hl-keyword">public</span> Transformer transformer() {
    <span class="hl-keyword">return</span> message -&gt; message;
}</pre>
<p>Note the <code class="literal">true</code> parameter on the <code class="literal">TransactionInterceptorBuilder</code> constructor.
It causes the creation of a <code class="literal">TransactionHandleMessageAdvice</code>, not a regular <code class="literal">TransactionInterceptor</code>.</p>
<p>Java DSL supports an <code class="literal">Advice</code> through the <code class="literal">.transactional()</code> options on the endpoint configuration, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> IntegrationFlow updatingGatewayFlow() {
    <span class="hl-keyword">return</span> f -&gt; f
        .handle(Jpa.updatingGateway(<span class="hl-keyword">this</span>.entityManagerFactory),
                e -&gt; e.transactional(true))
        .channel(c -&gt; c.queue(<span class="hl-string">"persistResults"</span>));
}</pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="advising-filters" href="#advising-filters"></a>10.9.6&nbsp;Advising Filters</h3></div></div></div>

<p>There is an additional consideration when advising <code class="literal">Filter</code> advices.
By default, any discard actions (when the filter returns <code class="literal">false</code>) are performed within the scope of the advice chain.
This could include all the flow downstream of the discard channel.
So, for example, if an element downstream of the discard channel throws an exception and there is a retry advice, the process is retried.
Also, if <code class="literal">throwExceptionOnRejection</code> is set to <code class="literal">true</code> (the exception is thrown within the scope of the advice).</p>
<p>Setting <code class="literal">discard-within-advice</code> to <code class="literal">false</code> modifies this behavior and the discard (or exception) occurs after the advice chain is called.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="advising-with-annotations" href="#advising-with-annotations"></a>10.9.7&nbsp;Advising Endpoints Using Annotations</h3></div></div></div>

<p>When configuring certain endpoints by using annotations (<code class="literal">@Filter</code>, <code class="literal">@ServiceActivator</code>, <code class="literal">@Splitter</code>, and <code class="literal">@Transformer</code>), you can supply a bean name for the advice chain in the <code class="literal">adviceChain</code> attribute.
In addition, the <code class="literal">@Filter</code> annotation also has the <code class="literal">discardWithinAdvice</code> attribute, which can be used to configure the discard behavior, as discussed in <a class="xref" href="#advising-filters" title="10.9.6&nbsp;Advising Filters">Section&nbsp;10.9.6, &#8220;Advising Filters&#8221;</a>.
The following example causes the discard to be performed after the advice:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@MessageEndpoint</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyAdvisedFilter {

    <em><span class="hl-annotation" style="color: gray">@Filter(inputChannel="input", outputChannel="output",
            adviceChain="adviceChain", discardWithinAdvice="false")</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">boolean</span> filter(String s) {
        <span class="hl-keyword">return</span> s.contains(<span class="hl-string">"good"</span>);
    }
}</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="advice-order" href="#advice-order"></a>10.9.8&nbsp;Ordering Advices within an Advice Chain</h3></div></div></div>

<p>Advice classes are "<code class="literal">around</code>" advices and are applied in a nested fashion.
The first advice is the outermost, while the last advice is the innermost (that is, closest to the handler being advised).
It is important to put the advice classes in the correct order to achieve the functionality you desire.</p>
<p>For example, suppose you want to add a retry advice and a transaction advice.
You may want to place the retry advice advice first, followed by the transaction advice.
Consequently, each retry is performed in a new transaction.
On the other hand, if you want all the attempts and any recovery operations (in the retry <code class="literal">RecoveryCallback</code>) to be scoped within the transaction, you could put the transaction advice first.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="advised-handler-properties" href="#advised-handler-properties"></a>10.9.9&nbsp;Advised Handler Properties</h3></div></div></div>

<p>Sometimes, it is useful to access handler properties from within the advice.
For example, most handlers implement <code class="literal">NamedComponent</code> to let you access the component name.</p>
<p>The target object can be accessed through the <code class="literal">target</code> argument (when subclassing <code class="literal">AbstractRequestHandlerAdvice</code>) or
<code class="literal">invocation.getThis()</code> (when implementing <code class="literal">org.aopalliance.intercept.MethodInterceptor</code>).</p>
<p>When the entire handler is advised (such as when the handler does not produce replies or the advice implements <code class="literal">HandleMessageAdvice</code>), you can cast the target object to an interface, such as <code class="literal">NamedComponent</code>, as shown in the following example:</p>
<div class="informalexample">
<pre class="programlisting">String componentName = ((NamedComponent) target).getComponentName();</pre>
</div>
<p>When you implement <code class="literal">MethodInterceptor</code> directly, you could cast the target object as follows:</p>
<div class="informalexample">
<pre class="programlisting">String componentName = ((NamedComponent) invocation.getThis()).getComponentName();</pre>
</div>
<p>When only the <code class="literal">handleRequestMessage()</code> method is advised (in a reply-producing handler), you need to access the
full handler, which is an <code class="literal">AbstractReplyProducingMessageHandler</code>.
The following example shows how to do so:</p>
<div class="informalexample">
<pre class="programlisting">AbstractReplyProducingMessageHandler handler =
    ((AbstractReplyProducingMessageHandler.RequestHandler) target).getAdvisedHandler();

String componentName = handler.getComponentName();</pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="idempotent-receiver" href="#idempotent-receiver"></a>10.9.10&nbsp;Idempotent Receiver Enterprise Integration Pattern</h3></div></div></div>

<p>Starting with version 4.1, Spring Integration provides an implementation of the <a class="ulink" href="http://www.eaipatterns.com/IdempotentReceiver.html" target="_top">Idempotent Receiver</a> Enterprise Integration Pattern.
It is a functional pattern and the whole idempotency logic should be implemented in the application.
However, to simplify the decision-making, the <code class="literal">IdempotentReceiverInterceptor</code> component is provided.
This is an AOP <code class="literal">Advice</code> that is applied to the <code class="literal">MessageHandler.handleMessage()</code> method and that can <code class="literal">filter</code> a request message or mark it as a <code class="literal">duplicate</code>, according to its configuration.</p>
<p>Previously, you could have implemented this pattern by using a custom <code class="literal">MessageSelector</code> in a <code class="literal">&lt;filter/&gt;</code> (see <a class="xref" href="#filter" title="8.2&nbsp;Filter">Section&nbsp;8.2, &#8220;Filter&#8221;</a>), for example.
However, since this pattern really defines the behavior of an endpoint rather than being an endpoint itself, the idempotent receiver implementation does not provide an endpoint component.
Rather, it is applied to endpoints declared in the application.</p>
<p>The logic of the <code class="literal">IdempotentReceiverInterceptor</code> is based on the provided <code class="literal">MessageSelector</code> and, if the message is not accepted by that selector, it is enriched with the <code class="literal">duplicateMessage</code> header set to <code class="literal">true</code>.
The target <code class="literal">MessageHandler</code> (or downstream flow) can consult this header to implement the correct idempotency logic.
If the <code class="literal">IdempotentReceiverInterceptor</code> is configured with a <code class="literal">discardChannel</code> or <code class="literal">throwExceptionOnRejection = true</code>, the duplicate message is not sent to the target <code class="literal">MessageHandler.handleMessage()</code>.
Rather, it is discarded.
If you want to discard (do nothing with) the duplicate message, the <code class="literal">discardChannel</code> should be configured with a <code class="literal">NullChannel</code>, such as the default <code class="literal">nullChannel</code> bean.</p>
<p>To maintain state between messages and provide the ability to compare messages for the idempotency, we provide the <code class="literal">MetadataStoreSelector</code>.
It accepts a <code class="literal">MessageProcessor</code> implementation (which creates a lookup key based on the <code class="literal">Message</code>) and an optional <code class="literal">ConcurrentMetadataStore</code> (<a class="xref" href="#metadata-store" title="12.5&nbsp;Metadata Store">Section&nbsp;12.5, &#8220;Metadata Store&#8221;</a>).
See the <a class="ulink" href="https://docs.spring.io/spring-integration/api/org/springframework/integration/selector/MetadataStoreSelector.html" target="_top"><code class="literal">MetadataStoreSelector</code> Javadoc</a> for more information.
You can also customize the <code class="literal">value</code> for <code class="literal">ConcurrentMetadataStore</code> by using an additional <code class="literal">MessageProcessor</code>.
By default, <code class="literal">MetadataStoreSelector</code> uses the <code class="literal">timestamp</code> message header.</p>
<p>For convenience, the <code class="literal">MetadataStoreSelector</code> options are configurable directly on the <code class="literal">&lt;idempotent-receiver&gt;</code> component.
The following listing shows all the possible attributes:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;idempotent-receiver</span>
        <span class="hl-attribute">id</span>=<span class="hl-value">""</span>  <a name="CO15-1" href="#CO15-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
        endpoint=""  <a name="CO15-2" href="#CO15-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
        selector=""  <a name="CO15-3" href="#CO15-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
        discard-channel=""  <a name="CO15-4" href="#CO15-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
        metadata-store=""  <a name="CO15-5" href="#CO15-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
        key-strategy=""  <a name="CO15-6" href="#CO15-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>
        key-expression=""  <a name="CO15-7" href="#CO15-7"></a><span><img src="images/callouts/7.png" alt="7" border="0"></span>
        value-strategy=""  <a name="CO15-8" href="#CO15-8"></a><span><img src="images/callouts/8.png" alt="8" border="0"></span>
        value-expression=""  <a name="CO15-9" href="#CO15-9"></a><span><img src="images/callouts/9.png" alt="9" border="0"></span>
        throw-exception-on-rejection="" /&gt;  <a name="CO15-10" href="#CO15-10"></a><span><img src="images/callouts/10.png" alt="10" border="0"></span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO15-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The ID of the <code class="literal">IdempotentReceiverInterceptor</code> bean.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO15-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Consumer endpoint name(s) or pattern(s) to which this interceptor is applied.
Separate names (patterns) with commas (<code class="literal">,</code>), such as <code class="literal">endpoint="aaa, bbb*, *ccc, *ddd*, eee*fff"</code>.
Endpoint bean names matching these patterns are then used to retrieve the target endpoint&#8217;s <code class="literal">MessageHandler</code> bean (using its <code class="literal">.handler</code> suffix), and the <code class="literal">IdempotentReceiverInterceptor</code> is applied to those beans.
Required.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO15-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A <code class="literal">MessageSelector</code> bean reference.
Mutually exclusive with <code class="literal">metadata-store</code> and <code class="literal">key-strategy (key-expression)</code>.
When <code class="literal">selector</code> is not provided, one of <code class="literal">key-strategy</code> or <code class="literal">key-strategy-expression</code> is required.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO15-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Identifies the channel to which to send a message when the <code class="literal">IdempotentReceiverInterceptor</code> does not accept it.
When omitted, duplicate messages are forwarded to the handler with a <code class="literal">duplicateMessage</code> header.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO15-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A <code class="literal">ConcurrentMetadataStore</code> reference.
Used by the underlying <code class="literal">MetadataStoreSelector</code>.
Mutually exclusive with <code class="literal">selector</code>.
Optional.
The default <code class="literal">MetadataStoreSelector</code> uses an internal <code class="literal">SimpleMetadataStore</code> that does not maintain state across application executions.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO15-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A <code class="literal">MessageProcessor</code> reference.
Used by the underlying <code class="literal">MetadataStoreSelector</code>.
Evaluates an <code class="literal">idempotentKey</code> from the request message.
Mutually exclusive with <code class="literal">selector</code> and <code class="literal">key-expression</code>.
When a <code class="literal">selector</code> is not provided, one of <code class="literal">key-strategy</code> or <code class="literal">key-strategy-expression</code> is required.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO15-7"><span><img src="images/callouts/7.png" alt="7" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A SpEL expression to populate an <code class="literal">ExpressionEvaluatingMessageProcessor</code>.
Used by the underlying <code class="literal">MetadataStoreSelector</code>.
Evaluates an <code class="literal">idempotentKey</code> by using the request message as the evaluation context root object.
Mutually exclusive with <code class="literal">selector</code> and <code class="literal">key-strategy</code>.
When a <code class="literal">selector</code> is not provided, one of <code class="literal">key-strategy</code> or <code class="literal">key-strategy-expression</code> is required.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO15-8"><span><img src="images/callouts/8.png" alt="8" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A <code class="literal">MessageProcessor</code> reference.
Used by the underlying <code class="literal">MetadataStoreSelector</code>.
Evaluates a <code class="literal">value</code> for the <code class="literal">idempotentKey</code> from the request message.
Mutually exclusive with <code class="literal">selector</code> and <code class="literal">value-expression</code>.
By default, the <span class="emphasis"><em>MetadataStoreSelector</em></span> uses the <span class="emphasis"><em>timestamp</em></span> message header as the Metadata <span class="emphasis"><em>value</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO15-9"><span><img src="images/callouts/9.png" alt="9" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A SpEL expression to populate an <code class="literal">ExpressionEvaluatingMessageProcessor</code>.
Used by the underlying <code class="literal">MetadataStoreSelector</code>.
Evaluates a <code class="literal">value</code> for the <code class="literal">idempotentKey</code> by using the request message as the evaluation context root object.
Mutually exclusive with <code class="literal">selector</code> and <code class="literal">value-strategy</code>.
By default, the <span class="emphasis"><em>MetadataStoreSelector</em></span> uses the <span class="emphasis"><em>timestamp</em></span> message header as the metadata <span class="emphasis"><em>value</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO15-10"><span><img src="images/callouts/10.png" alt="10" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Whether to throw an exception if the <code class="literal">IdempotentReceiverInterceptor</code> rejects the message.
Defaults to <code class="literal">false</code>.
It is applied regardless of whether or not a <code class="literal">discard-channel</code> is provided.</p>
</td></tr></table></div>
</div>
<p>For Java configuration, Spring Integration provides the method-level <code class="literal">@IdempotentReceiver</code> annotation.
It is used to mark a <code class="literal">method</code> that has a messaging annotation (<code class="literal">@ServiceActivator</code>, <code class="literal">@Router, and others) to specify which `IdempotentReceiverInterceptor</code> objects are applied to this endpoint.
The following example shows how to use the <code class="literal">@IdempotentReceiver</code> annotation:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> IdempotentReceiverInterceptor idempotentReceiverInterceptor() {
   <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> IdempotentReceiverInterceptor(<span class="hl-keyword">new</span> MetadataStoreSelector(m -&gt;
                                                    m.getHeaders().get(INVOICE_NBR_HEADER)));
}

<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "input", outputChannel = "output")</span></em>
<em><span class="hl-annotation" style="color: gray">@IdempotentReceiver("idempotentReceiverInterceptor")</span></em>
<span class="hl-keyword">public</span> MessageHandler myService() {
    ....
}</pre>
</div>
<p>When you use the Java DSL, you can add the interceptor to the endpoint&#8217;s advice chain, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> IntegrationFlow flow() {
    ...
        .handle(<span class="hl-string">"someBean"</span>, <span class="hl-string">"someMethod"</span>,
            e -&gt; e.advice(idempotentReceiverInterceptor()))
    ...
}</pre>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The <code class="literal">IdempotentReceiverInterceptor</code> is designed only for the <code class="literal">MessageHandler.handleMessage(Message&lt;?&gt;)</code> method.
Starting with version 4.3.1, it implements <code class="literal">HandleMessageAdvice</code>, with the <code class="literal">AbstractHandleMessageAdvice</code> as a base class, for better dissociation.
See <a class="xref" href="#handle-message-advice" title="10.9.4&nbsp;Handling Message Advice">Section&nbsp;10.9.4, &#8220;Handling Message Advice&#8221;</a> for more information.</p>
</td></tr></table></div>
</div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="logging-channel-adapter" href="#logging-channel-adapter"></a>10.10&nbsp;Logging Channel Adapter</h2></div></div></div>

<p>The <code class="literal">&lt;logging-channel-adapter&gt;</code> is often used in conjunction with a wire tap, as discussed in <a class="xref" href="#channel-wiretap" title="Wire Tap">the section called &#8220;Wire Tap&#8221;</a>.
However, it can also be used as the ultimate consumer of any flow.
For example, consider a flow that ends with a <code class="literal">&lt;service-activator&gt;</code> that returns a result, but you wish to discard that result.
To do that, you could send the result to <code class="literal">NullChannel</code>.
Alternatively, you can route it to an <code class="literal">INFO</code> level <code class="literal">&lt;logging-channel-adapter&gt;</code>.
That way, you can see the discarded message when logging at <code class="literal">INFO</code> level but not see it when logging at (for example) the <code class="literal">WARN</code> level.
With a <code class="literal">NullChannel</code>, you would see only the discarded message when logging at the <code class="literal">DEBUG</code> level.
The following listing shows all the possible attributes for the <code class="literal">logging-channel-adapter</code> element:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:logging-channel-adapter</span>
    <span class="hl-attribute">channel</span>=<span class="hl-value">""</span> <a name="CO16-1" href="#CO16-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
    level="INFO" <a name="CO16-2" href="#CO16-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
    expression="" <a name="CO16-3" href="#CO16-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
    log-full-message="false" <a name="CO16-4" href="#CO16-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
    logger-name="" /&gt; <a name="CO16-5" href="#CO16-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span></pre>
</div>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO16-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The channel connecting the logging adapter to an upstream component.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO16-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The logging level at which messages sent to this adapter will be logged.
Default: <code class="literal">INFO</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO16-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A SpEL expression representing exactly what parts of the message are logged.
Default: <code class="literal">payload</code>&#8201;&#8212;&#8201;only the payload is logged.
if <code class="literal">log-full-message</code> is specified, this attribute cannot be specified.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO16-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>When <code class="literal">true</code>, the entire message (including headers) is logged.
Default: <code class="literal">false</code>&#8201;&#8212;&#8201;only the payload is logged.
This attribute cannot be specified if <code class="literal">expression</code> is specified.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO16-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Specifies the <code class="literal">name</code> of the logger (known as <code class="literal">category</code> in <code class="literal">log4j</code>).
Used to identify log messages created by this adapter.
This enables setting the log name (in the logging subsystem) for individual adapters.
By default, all adapters log under the following name: <code class="literal">org.springframework.integration.handler.LoggingHandler</code>.</p>
</td></tr></table></div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_using_java_configuration" href="#_using_java_configuration"></a>10.10.1&nbsp;Using Java Configuration</h3></div></div></div>

<p>The following Spring Boot application shows an example of configuring the <code class="literal">LoggingHandler</code> by using Java configuration:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@SpringBootApplication</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> LoggingJavaApplication {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
        ConfigurableApplicationContext context =
             <span class="hl-keyword">new</span> SpringApplicationBuilder(LoggingJavaApplication.<span class="hl-keyword">class</span>)
                    .web(false)
                    .run(args);
         MyGateway gateway = context.getBean(MyGateway.<span class="hl-keyword">class</span>);
         gateway.sendToLogger(<span class="hl-string">"foo"</span>);
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "logChannel")</span></em>
    <span class="hl-keyword">public</span> LoggingHandler logging() {
        LoggingHandler adapter = <span class="hl-keyword">new</span> LoggingHandler(LoggingHandler.Level.DEBUG);
        adapter.setLoggerName(<span class="hl-string">"TEST_LOGGER"</span>);
        adapter.setLogExpressionString(<span class="hl-string">"headers.id + ': ' + payload"</span>);
        <span class="hl-keyword">return</span> adapter;
    }

    <em><span class="hl-annotation" style="color: gray">@MessagingGateway(defaultRequestChannel = "logChannel")</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> MyGateway {

        <span class="hl-keyword">void</span> sendToLogger(String data);

    }

}</pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_with_the_java_dsl" href="#_configuring_with_the_java_dsl"></a>10.10.2&nbsp;Configuring with the Java DSL</h3></div></div></div>

<p>The following Spring Boot application shows an example of configuring the logging channel adapter by using the Java DSL:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@SpringBootApplication</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> LoggingJavaApplication {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
        ConfigurableApplicationContext context =
             <span class="hl-keyword">new</span> SpringApplicationBuilder(LoggingJavaApplication.<span class="hl-keyword">class</span>)
                    .web(false)
                    .run(args);
         MyGateway gateway = context.getBean(MyGateway.<span class="hl-keyword">class</span>);
         gateway.sendToLogger(<span class="hl-string">"foo"</span>);
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> IntegrationFlow loggingFlow() {
        <span class="hl-keyword">return</span> IntegrationFlows.from(MyGateway.<span class="hl-keyword">class</span>)
                     .log(LoggingHandler.Level.DEBUG, <span class="hl-string">"TEST_LOGGER"</span>,
                           m -&gt; m.getHeaders().getId() + <span class="hl-string">": "</span> + m.getPayload());
    }

    <em><span class="hl-annotation" style="color: gray">@MessagingGateway</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> MyGateway {

        <span class="hl-keyword">void</span> sendToLogger(String data);

    }

}</pre>
</div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="functions-support" href="#functions-support"></a>10.11&nbsp;<code class="literal">java.util.function</code> Interfaces Support</h2></div></div></div>

<p>Starting with version 5.1, Spring Integration provides direct support for interfaces in the <code class="literal">java.util.function</code> package.
All messaging endpoints, (Service Activator, Transformer, Filter, etc.) can now refer to <code class="literal">Function</code> (or <code class="literal">Consumer</code>) beans.
The <a class="link" href="#annotations" title="E.5&nbsp;Annotation Support">Messaging Annotations</a> can be applied directly on these beans similar to regular <code class="literal">MessageHandler</code> definitions.
For example if you have this <code class="literal">Function</code> bean definition:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Configuration</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> FunctionConfiguration {

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> Function&lt;String, String&gt; functionAsService() {
        <span class="hl-keyword">return</span> String::toUpperCase;
    }

}</pre>
</div>
<p>You can use it as a simple reference in an XML configuration file:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;service-activator</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"processorViaFunctionChannel"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"functionAsService"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>When we configure our flow with Messaging Annotations, the code is straightforward:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<em><span class="hl-annotation" style="color: gray">@Transformer(inputChannel = "functionServiceChannel")</span></em>
<span class="hl-keyword">public</span> Function&lt;String, String&gt; functionAsService() {
    <span class="hl-keyword">return</span> String::toUpperCase;
}</pre>
</div>
<p>When the function returns an array, <code class="literal">Collection</code> (essentially, any <code class="literal">Iterable</code>), <code class="literal">Stream</code> or Reactor <code class="literal">Flux</code>, <code class="literal">@Splitter</code> can be used on such a bean to perform iteration over the result content.</p>
<p>The <code class="literal">java.util.function.Consumer</code> interface can be used for an <code class="literal">&lt;int:outbound-channel-adapter&gt;</code> or, together with the <code class="literal">@ServiceActivator</code> annotation, to perform the final step of a flow:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "messageConsumerServiceChannel")</span></em>
<span class="hl-keyword">public</span> Consumer&lt;Message&lt;?&gt;&gt; messageConsumerAsService() {
    <span class="hl-comment">// Has to be an anonymous class for proper type inference</span>
    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> Consumer&lt;Message&lt;?&gt;&gt;() {

        <em><span class="hl-annotation" style="color: gray">@Override</span></em>
        <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> accept(Message&lt;?&gt; e) {
            collector().add(e);
        }

    };
}</pre>
</div>
<p>Also, pay attention to the comment in the code snippet above: if you would like to deal with the whole message in your <code class="literal">Function</code>/<code class="literal">Consumer</code> you cannot use a lambda definition.
Because of Java type erasure we cannot determine the target type for the <code class="literal">apply()/accept()</code> method call.</p>
<p>The <code class="literal">java.util.function.Supplier</code> interface can simply be used together with the <code class="literal">@InboundChannelAdapter</code> annotation, or as a <code class="literal">ref</code> in an <code class="literal">&lt;int:inbound-channel-adapter&gt;</code>:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<em><span class="hl-annotation" style="color: gray">@InboundChannelAdapter(value = "inputChannel", poller = @Poller(fixedDelay = "1000"))</span></em>
<span class="hl-keyword">public</span> Supplier&lt;String&gt; pojoSupplier() {
    <span class="hl-keyword">return</span> () -&gt; <span class="hl-string">"foo"</span>;
}</pre>
</div>
<p>With the Java DSL we just need to use a reference to the function bean in the endpoint definitions.
Meanwhile an implementation of the <code class="literal">Supplier</code> interface can be used as regular <code class="literal">MessageSource</code> definition:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> Function&lt;String, String&gt; toUpperCaseFunction() {
    <span class="hl-keyword">return</span> String::toUpperCase;
}

<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> Supplier&lt;String&gt; stringSupplier() {
    <span class="hl-keyword">return</span> () -&gt; <span class="hl-string">"foo"</span>;
}

<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> IntegrationFlow supplierFlow() {
    <span class="hl-keyword">return</span> IntegrationFlows.from(stringSupplier())
                .transform(toUpperCaseFunction())
                .channel(<span class="hl-string">"suppliedChannel"</span>)
                .get();
}</pre>
</div>
<p>This function support is useful when used together with the <a class="ulink" href="https://cloud.spring.io/spring-cloud-function/" target="_top">Spring Cloud Function</a> framework, where we have a function catalog and can refer to its member functions from an integration flow definition.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="kotlin-functions-support" href="#kotlin-functions-support"></a>10.11.1&nbsp;Kotlin Lambdas</h3></div></div></div>

<p>The Framework also has been improved to support Kotlin lambdas for functions so now you can use a combination of the Kotlin language and Spring Integration flow definitions:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<em><span class="hl-annotation" style="color: gray">@Transformer(inputChannel = "functionServiceChannel")</span></em>
fun kotlinFunction(): (String) -&gt; String {
    <span class="hl-keyword">return</span> { it.toUpperCase() }
}

<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "messageConsumerServiceChannel")</span></em>
fun kotlinConsumer(): (Message&lt;Any&gt;) -&gt; Unit {
    <span class="hl-keyword">return</span> { print(it) }
}

<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<em><span class="hl-annotation" style="color: gray">@InboundChannelAdapter(value = "counterChannel",
        poller = [Poller(fixedRate = "10", maxMessagesPerPoll = "1")])</span></em>
fun kotlinSupplier(): () -&gt; String {
    <span class="hl-keyword">return</span> { <span class="hl-string">"baz"</span> }
}</pre>
</div>
</div>
</div>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="java-dsl" href="#java-dsl"></a>11.&nbsp;Java DSL</h2></div></div></div>

<p>The Spring Integration Java configuration and DSL provides a set of convenient builders and a fluent API that lets you configure Spring Integration message flows from Spring <code class="literal">@Configuration</code> classes.</p>
<p>The Java DSL for Spring Integration is essentially a facade for Spring Integration.
The DSL provides a simple way to embed Spring Integration Message Flows into your application by using the fluent <code class="literal">Builder</code> pattern together with existing Java configuration from Spring Framework and Spring Integration.
We also use and support lambdas (available with Java 8) to further simplify Java configuration.</p>
<p>The <a class="ulink" href="https://github.com/spring-projects/spring-integration-samples/tree/master/dsl/cafe-dsl" target="_top">cafe</a> offers a good example of using the DSL.</p>
<p>The DSL is  presented by the <code class="literal">IntegrationFlows</code> factory for the <code class="literal">IntegrationFlowBuilder</code>.
This produces the <code class="literal">IntegrationFlow</code> component, which should be registered as a Spring bean (by using the <code class="literal">@Bean</code> annotation).
The builder pattern is used to express arbitrarily complex structures as a hierarchy of methods that can accept lambdas as arguments.</p>
<p>The <code class="literal">IntegrationFlowBuilder</code> only collects integration components (<code class="literal">MessageChannel</code> instances, <code class="literal">AbstractEndpoint</code> instances, and so on) in the <code class="literal">IntegrationFlow</code> bean for further parsing and registration of concrete beans in the application context by the <code class="literal">IntegrationFlowBeanPostProcessor</code>.</p>
<p>The Java DSL uses Spring Integration classes directly and bypasses any XML generation and parsing.
However, the DSL offers more than syntactic sugar on top of XML.
One of its most compelling features is the ability to define inline lambdas to implement endpoint logic, eliminating the need for external classes to implement custom logic.
In some sense, Spring Integration&#8217;s support for the Spring Expression Language (SpEL) and inline scripting address this, but lambdas are easier and much more powerful.</p>
<p>The following example shows how to use Java Configuration for Spring Integration:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Configuration</span></em>
<em><span class="hl-annotation" style="color: gray">@EnableIntegration</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyConfiguration {

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> AtomicInteger integerSource() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> AtomicInteger();
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> IntegrationFlow myFlow() {
        <span class="hl-keyword">return</span> IntegrationFlows.from(integerSource::getAndIncrement,
                                         c -&gt; c.poller(Pollers.fixedRate(<span class="hl-number">100</span>)))
                    .channel(<span class="hl-string">"inputChannel"</span>)
                    .filter((Integer p) -&gt; p &gt; <span class="hl-number">0</span>)
                    .transform(Object::toString)
                    .channel(MessageChannels.queue())
                    .get();
    }
}</pre>
</div>
<p>The result of the preceding configuration example is that it creates, after <code class="literal">ApplicationContext</code> start up, Spring Integration endpoints and message channels.
Java configuration can be used both to replace and augment XML configuration.
You need not replace all of your existing XML configuration to use Java configuration.</p>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="java-dsl-basics" href="#java-dsl-basics"></a>11.1&nbsp;DSL Basics</h2></div></div></div>

<p>The <code class="literal">org.springframework.integration.dsl</code> package contains the <code class="literal">IntegrationFlowBuilder</code> API mentioned earlier and a number of <code class="literal">IntegrationComponentSpec</code> implementations, which are also builders and provide the fluent API to configure concrete endpoints.
The <code class="literal">IntegrationFlowBuilder</code> infrastructure provides common <a class="ulink" href="http://www.eaipatterns.com" target="_top">enterprise integration patterns</a> (EIP) for message-based applications, such as channels, endpoints, pollers, and channel interceptors.</p>
<p>Endpoints are expressed as verbs in the DSL to improve readability.
The following list includes the common DSL method names and the associated EIP endpoint:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
transform &#8594; <code class="literal">Transformer</code>
</li><li class="listitem">
filter &#8594; <code class="literal">Filter</code>
</li><li class="listitem">
handle &#8594; <code class="literal">ServiceActivator</code>
</li><li class="listitem">
split &#8594; <code class="literal">Splitter</code>
</li><li class="listitem">
aggregate &#8594; <code class="literal">Aggregator</code>
</li><li class="listitem">
route &#8594; <code class="literal">Router</code>
</li><li class="listitem">
bridge &#8594; <code class="literal">Bridge</code>
</li></ul></div>
<p>Conceptually, integration processes are constructed by composing these endpoints into one or more message flows.
Note that EIP does not formally define the term <span class="emphasis"><em>message flow</em></span>, but it is useful to think of it as a unit of work that uses well known messaging patterns.
The DSL provides an <code class="literal">IntegrationFlow</code> component to define a composition of channels and endpoints between them, but now <code class="literal">IntegrationFlow</code> plays only the configuration role to populate real beans in the application context and is not used at runtime.
The following example uses the <code class="literal">IntegrationFlows</code> factory to define an <code class="literal">IntegrationFlow</code> bean by using EIP-methods from <code class="literal">IntegrationFlowBuilder</code>:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> IntegrationFlow integerFlow() {
    <span class="hl-keyword">return</span> IntegrationFlows.from(<span class="hl-string">"input"</span>)
            .&lt;String, Integer&gt;transform(Integer::parseInt)
            .get();
}</pre>
</div>
<p>The <code class="literal">transform</code> method accepts a lambda as an endpoint argument to operate on the message payload.
The real argument of this method is <code class="literal">GenericTransformer&lt;S, T&gt;</code>.
Consequently, any of the provided transformers  (<code class="literal">ObjectToJsonTransformer</code>, <code class="literal">FileToStringTransformer</code>, and other) can be used here.</p>
<p>Under the covers, <code class="literal">IntegrationFlowBuilder</code> recognizes the <code class="literal">MessageHandler</code> and the endpoint for it, with <code class="literal">MessageTransformingHandler</code> and <code class="literal">ConsumerEndpointFactoryBean</code>, respectively.
Consider another example:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> IntegrationFlow myFlow() {
    <span class="hl-keyword">return</span> IntegrationFlows.from(<span class="hl-string">"input"</span>)
                .filter(<span class="hl-string">"World"</span>::equals)
                .transform(<span class="hl-string">"Hello "</span>::concat)
                .handle(System.out::println)
                .get();
}</pre>
</div>
<p>The preceding example composes a sequence of <code class="literal">Filter -&gt; Transformer -&gt; Service Activator</code>.
The flow is "<span class="emphasis"><em>one way</em></span>".
That is, it does not provide a reply message but only prints the payload to STDOUT.
The endpoints are automatically wired together by using direct channels.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important: Lambdas And Message<?&gt; Arguments"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left"><a name="java-dsl-class-cast" href="#java-dsl-class-cast"></a>Lambdas And <code class="literal">Message&lt;?&gt;</code> Arguments</th></tr><tr><td align="left" valign="top">

<p>When using lambdas in EIP methods, the "input" argument is generally the message payload.
If you wish to access the entire message, use one of the overloaded methods that take a <code class="literal">Class&lt;?&gt;</code> as the first parameter.
For example, this won&#8217;t work:</p>
<pre class="programlisting">.&lt;Message&lt;?&gt;, Foo&gt;transform(m -&gt; newFooFromMessage(m))</pre>
<p>This will fail at runtime with a <code class="literal">ClassCastException</code> because the lambda doesn&#8217;t retain the argument type and the framework will attempt to cast the payload to a <code class="literal">Message&lt;?&gt;</code>.</p>
<p>Instead, use:</p>
<pre class="programlisting">.(Message.<span class="hl-keyword">class</span>, m -&gt; newFooFromMessage(m))</pre>
</td></tr></table></div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important: Bean Definitions override"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left"><a name="bean-definitions-override" href="#bean-definitions-override"></a>Bean Definitions override</th></tr><tr><td align="left" valign="top">

<p>The Java DSL can register beans for the object defined in-line in the flow definition, as well as can reuse existing, injected beans.
In case of the same bean name defined for in-line object and existing bean definition, a <code class="literal">BeanDefinitionOverrideException</code> is thrown indicating that such a configuration is wrong.
However when you deal with <code class="literal">prototype</code> beans, there is no way to detect from the integration flow processor an existing bean definition because every time we call a <code class="literal">prototype</code> bean from the <code class="literal">BeanFactory</code> we get a new instance.
This way a provided instance is used in the <code class="literal">IntegrationFlow</code> as is without any bean registration and any possible check against existing <code class="literal">prototype</code> bean definition.
However <code class="literal">BeanFactory.initializeBean()</code> is called for this object if it has an explicit <code class="literal">id</code> and bean definition for this name is in <code class="literal">prototype</code> scope.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="java-dsl-channels" href="#java-dsl-channels"></a>11.2&nbsp;Message Channels</h2></div></div></div>

<p>In addition to the <code class="literal">IntegrationFlowBuilder</code> with EIP methods, the Java DSL provides a fluent API to configure <code class="literal">MessageChannel</code> instances.
For this purpose the <code class="literal">MessageChannels</code> builder factory is provided.
The following example shows how to use it:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> MessageChannel priorityChannel() {
    <span class="hl-keyword">return</span> MessageChannels.priority(<span class="hl-keyword">this</span>.mongoDbChannelMessageStore, <span class="hl-string">"priorityGroup"</span>)
                        .interceptor(wireTap())
                        .get();
}</pre>
</div>
<p>The same <code class="literal">MessageChannels</code> builder factory can be used in the <code class="literal">channel()</code> EIP method from <code class="literal">IntegrationFlowBuilder</code> to wire endpoints, similar to wiring an <code class="literal">input-channel</code>/<code class="literal">output-channel</code> pair in the XML configuration.
By default, endpoints are wired with <code class="literal">DirectChannel</code> instances where the bean name is based on the following pattern: <code class="literal">[IntegrationFlow.beanName].channel#[channelNameIndex]</code>.
This rule is also applied for unnamed channels produced by inline <code class="literal">MessageChannels</code> builder factory usage.
However all <code class="literal">MessageChannels</code> methods have a variant that is aware of the <code class="literal">channelId</code> that you can use to set the bean names for <code class="literal">MessageChannel</code> instances.
The <code class="literal">MessageChannel</code> references and <code class="literal">beanName</code> can be used as bean-method invocations.
The following example shows the possible ways to use the <code class="literal">channel()</code> EIP method:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> MessageChannel queueChannel() {
    <span class="hl-keyword">return</span> MessageChannels.queue().get();
}

<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> MessageChannel publishSubscribe() {
    <span class="hl-keyword">return</span> MessageChannels.publishSubscribe().get();
}

<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> IntegrationFlow channelFlow() {
    <span class="hl-keyword">return</span> IntegrationFlows.from(<span class="hl-string">"input"</span>)
                .fixedSubscriberChannel()
                .channel(<span class="hl-string">"queueChannel"</span>)
                .channel(publishSubscribe())
                .channel(MessageChannels.executor(<span class="hl-string">"executorChannel"</span>, <span class="hl-keyword">this</span>.taskExecutor))
                .channel(<span class="hl-string">"output"</span>)
                .get();
}</pre>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">from("input")</code> means "<span class="emphasis"><em>find and use the <code class="literal">MessageChannel</code> with the "input" id, or create one</em></span>".
</li><li class="listitem">
<code class="literal">fixedSubscriberChannel()</code> produces an instance of <code class="literal">FixedSubscriberChannel</code> and registers it with a name of <code class="literal">channelFlow.channel#0</code>.
</li><li class="listitem">
<code class="literal">channel("queueChannel")</code> works the same way but uses an existing <code class="literal">queueChannel</code> bean.
</li><li class="listitem">
<code class="literal">channel(publishSubscribe())</code> is the bean-method reference.
</li><li class="listitem">
<code class="literal">channel(MessageChannels.executor("executorChannel", this.taskExecutor))</code> is the <code class="literal">IntegrationFlowBuilder</code> that exposes <code class="literal">IntegrationComponentSpec</code> to the <code class="literal">ExecutorChannel</code> and registers it as <code class="literal">executorChannel</code>.
</li><li class="listitem">
<code class="literal">channel("output")</code> registers the <code class="literal">DirectChannel</code> bean with <code class="literal">output</code> as its name, as long as no beans with this name already exist.
</li></ul></div>
<p>Note: The preceding <code class="literal">IntegrationFlow</code> definition is valid, and all of its channels are applied to endpoints with <code class="literal">BridgeHandler</code> instances.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Be careful to use the same inline channel definition through <code class="literal">MessageChannels</code> factory from different <code class="literal">IntegrationFlow</code> instances.
Even if the DSL parser registers non-existent objects as beans, it cannot determine the same object (<code class="literal">MessageChannel</code>) from different <code class="literal">IntegrationFlow</code> containers.
The following example is wrong:</p>
</td></tr></table></div>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> IntegrationFlow startFlow() {
    <span class="hl-keyword">return</span> IntegrationFlows.from(<span class="hl-string">"input"</span>)
                .transform(...)
                .channel(MessageChannels.queue(<span class="hl-string">"queueChannel"</span>))
                .get();
}

<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> IntegrationFlow endFlow() {
    <span class="hl-keyword">return</span> IntegrationFlows.from(MessageChannels.queue(<span class="hl-string">"queueChannel"</span>))
                .handle(...)
                .get();
}</pre>
<p>The result of that bad example is the following exception:</p>
<pre class="screen">Caused by: java.lang.IllegalStateException:
Could not register object [queueChannel] under bean name 'queueChannel':
     there is already object [queueChannel] bound
	    at o.s.b.f.s.DefaultSingletonBeanRegistry.registerSingleton(DefaultSingletonBeanRegistry.java:129)</pre>
<p>To make it work, you need to declare <code class="literal">@Bean</code> for that channel and use its bean method from different <code class="literal">IntegrationFlow</code> instances.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="java-dsl-pollers" href="#java-dsl-pollers"></a>11.3&nbsp;Pollers</h2></div></div></div>

<p>Spring Integration also provides a fluent API that lets you configure <code class="literal">PollerMetadata</code> for <code class="literal">AbstractPollingEndpoint</code> implementations.
You can use the <code class="literal">Pollers</code> builder factory to configure common bean definitions or those created from <code class="literal">IntegrationFlowBuilder</code> EIP methods, as the following example shows:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean(name = PollerMetadata.DEFAULT_POLLER)</span></em>
<span class="hl-keyword">public</span> PollerSpec poller() {
    <span class="hl-keyword">return</span> Pollers.fixedRate(<span class="hl-number">500</span>)
        .errorChannel(<span class="hl-string">"myErrors"</span>);
}</pre>
<p>See <a class="ulink" href="https://docs.spring.io/spring-integration/api/org/springframework/integration/dsl/Pollers.html" target="_top"><code class="literal">Pollers</code></a> and <a class="ulink" href="https://docs.spring.io/spring-integration/api/org/springframework/integration/dsl/PollerSpec.html" target="_top"><code class="literal">PollerSpec</code></a> in the Javadoc for more information.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>If you use the DSL to construct a <code class="literal">PollerSpec</code> as a <code class="literal">@Bean</code>, do not call the <code class="literal">get()</code> method in the bean definition.
The <code class="literal">PollerSpec</code> is a <code class="literal">FactoryBean</code> that generates the <code class="literal">PollerMetadata</code> object from the specification and initializes all of its properties.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="java-dsl-endpoints" href="#java-dsl-endpoints"></a>11.4&nbsp;DSL and Endpoint Configuration</h2></div></div></div>

<p>All <code class="literal">IntegrationFlowBuilder</code> EIP methods have a variant that applies the lambda parameter to provide options for <code class="literal">AbstractEndpoint</code> instances: <code class="literal">SmartLifecycle</code>, <code class="literal">PollerMetadata</code>, <code class="literal">request-handler-advice-chain</code>, and others.
Each of them has generic arguments, so it lets you configure an endpoint and even its <code class="literal">MessageHandler</code> in the context, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> IntegrationFlow flow2() {
    <span class="hl-keyword">return</span> IntegrationFlows.from(<span class="hl-keyword">this</span>.inputChannel)
                .transform(<span class="hl-keyword">new</span> PayloadSerializingTransformer(),
                       c -&gt; c.autoStartup(false).id(<span class="hl-string">"payloadSerializingTransformer"</span>))
                .transform((Integer p) -&gt; p * <span class="hl-number">2</span>, c -&gt; c.advice(<span class="hl-keyword">this</span>.expressionAdvice()))
                .get();
}</pre>
</div>
<p>In addition, the <code class="literal">EndpointSpec</code> provides an <code class="literal">id()</code> method to let you register an endpoint bean with a given bean name, rather than a generated one.</p>
<p>If the <code class="literal">MessageHandler</code> is referenced as a bean, then any existing <code class="literal">adviceChain</code> configuration will be overridden if the <code class="literal">.advice()</code> method is present in the DSL definition:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> TcpOutboundGateway tcpOut() {
    TcpOutboundGateway gateway = <span class="hl-keyword">new</span> TcpOutboundGateway();
    gateway.setConnectionFactory(cf());
    gateway.setAdviceChain(Collections.singletonList(fooAdvice()));
    <span class="hl-keyword">return</span> gateway;
}

<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> IntegrationFlow clientTcpFlow() {
    <span class="hl-keyword">return</span> f -&gt; f
        .handle(tcpOut(), e -&gt; e.advice(testAdvice()))
        .transform(Transformers.objectToString());
}</pre>
<p>i.e. they are not merged, only the <code class="literal">testAdvice()</code> bean is used in this case.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="java-dsl-transformers" href="#java-dsl-transformers"></a>11.5&nbsp;Transformers</h2></div></div></div>

<p>The DSL API provides a convenient, fluent <code class="literal">Transformers</code> factory to be used as inline target object definition within the <code class="literal">.transform()</code> EIP method.
The following example shows how to use it:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> IntegrationFlow transformFlow() {
    <span class="hl-keyword">return</span> IntegrationFlows.from(<span class="hl-string">"input"</span>)
            .transform(Transformers.fromJson(MyPojo.<span class="hl-keyword">class</span>))
            .transform(Transformers.serializer())
            .get();
}</pre>
</div>
<p>It avoids inconvenient coding using setters and makes the flow definition more straightforward.
Note that you can use <code class="literal">Transformers</code> to declare target <code class="literal">Transformer</code> instances as <code class="literal">@Bean</code> instances and, again, use them from <code class="literal">IntegrationFlow</code> definition as bean methods.
Nevertheless, the DSL parser takes care of bean declarations for inline objects, if they are not yet defined as beans.</p>
<p>See <a class="ulink" href="https://docs.spring.io/spring-integration/api/org/springframework/integration/dsl/Transformers.html" target="_top">Transformers</a> in the Javadoc for more information and supported factory methods.</p>
<p>Also see <a class="xref" href="#java-dsl-class-cast" title="Lambdas And Message<?&gt; Arguments">Lambdas And <code class="literal">Message&lt;?&gt;</code> Arguments</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="java-dsl-inbound-adapters" href="#java-dsl-inbound-adapters"></a>11.6&nbsp;Inbound Channel Adapters</h2></div></div></div>

<p>Typically, message flows start from an inbound channel adapter (such as <code class="literal">&lt;int-jdbc:inbound-channel-adapter&gt;</code>).
The adapter is configured with <code class="literal">&lt;poller&gt;</code>, and it asks a <code class="literal">MessageSource&lt;?&gt;</code> to periodically produce messages.
Java DSL allows for starting <code class="literal">IntegrationFlow</code> from a <code class="literal">MessageSource&lt;?&gt;</code>, too.
For this purpose, the <code class="literal">IntegrationFlows</code> builder factory provides an overloaded <code class="literal">IntegrationFlows.from(MessageSource&lt;?&gt; messageSource)</code> method.
You can configure the <code class="literal">MessageSource&lt;?&gt;</code> as a bean and provide it as an argument for that method.
The second parameter of <code class="literal">IntegrationFlows.from()</code> is a <code class="literal">Consumer&lt;SourcePollingChannelAdapterSpec&gt;</code> lambda that lets you provide options (such as <code class="literal">PollerMetadata</code> or <code class="literal">SmartLifecycle</code>) for the <code class="literal">SourcePollingChannelAdapter</code>.
The following example shows how to use the fluent API and a lambda to create an <code class="literal">IntegrationFlow</code>:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> MessageSource&lt;Object&gt; jdbcMessageSource() {
    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> JdbcPollingChannelAdapter(<span class="hl-keyword">this</span>.dataSource, <span class="hl-string">"SELECT * FROM something"</span>);
}

<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> IntegrationFlow pollingFlow() {
    <span class="hl-keyword">return</span> IntegrationFlows.from(jdbcMessageSource(),
                c -&gt; c.poller(Pollers.fixedRate(<span class="hl-number">100</span>).maxMessagesPerPoll(<span class="hl-number">1</span>)))
            .transform(Transformers.toJson())
            .channel(<span class="hl-string">"furtherProcessChannel"</span>)
            .get();
}</pre>
</div>
<p>For those cases that have no requirements to build <code class="literal">Message</code> objects directly, you can use the <code class="literal">IntegrationFlows.from()</code> variant that is based on the <code class="literal">java.util.function.Supplier</code> .
The result of the <code class="literal">Supplier.get()</code> is automatically wrapped in a <code class="literal">Message</code> (if it is not already a <code class="literal">Message</code>).</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="java-dsl-routers" href="#java-dsl-routers"></a>11.7&nbsp;Message Routers</h2></div></div></div>

<p>Spring Integration natively provides specialized router types, including:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">HeaderValueRouter</code>
</li><li class="listitem">
<code class="literal">PayloadTypeRouter</code>
</li><li class="listitem">
<code class="literal">ExceptionTypeRouter</code>
</li><li class="listitem">
<code class="literal">RecipientListRouter</code>
</li><li class="listitem">
<code class="literal">XPathRouter</code>
</li></ul></div>
<p>As with many other DSL <code class="literal">IntegrationFlowBuilder</code> EIP methods, the <code class="literal">route()</code> method can apply any <code class="literal">AbstractMessageRouter</code> implementation or, for convenience, a <code class="literal">String</code> as a SpEL expression or a <code class="literal">ref</code>-<code class="literal">method</code> pair.
In addition, you can configure <code class="literal">route()</code> with a lambda and use a lambda for a <code class="literal">Consumer&lt;RouterSpec&lt;MethodInvokingRouter&gt;&gt;</code>.
The fluent API also provides <code class="literal">AbstractMappingMessageRouter</code> options such as <code class="literal">channelMapping(String key, String channelName)</code> pairs, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> IntegrationFlow routeFlow() {
    <span class="hl-keyword">return</span> IntegrationFlows.from(<span class="hl-string">"routerInput"</span>)
            .&lt;Integer, Boolean&gt;route(p -&gt; p % <span class="hl-number">2</span> == <span class="hl-number">0</span>,
                    m -&gt; m.suffix(<span class="hl-string">"Channel"</span>)
                            .channelMapping(<span class="hl-string">"true"</span>, <span class="hl-string">"even"</span>)
                            .channelMapping(<span class="hl-string">"false"</span>, <span class="hl-string">"odd"</span>)
            )
            .get();
}</pre>
</div>
<p>The following example shows a simple expression-based router:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> IntegrationFlow routeFlow() {
    <span class="hl-keyword">return</span> IntegrationFlows.from(<span class="hl-string">"routerInput"</span>)
            .route(<span class="hl-string">"headers['destChannel']"</span>)
            .get();
}</pre>
</div>
<p>The <code class="literal">routeToRecipients()</code> method takes a <code class="literal">Consumer&lt;RecipientListRouterSpec&gt;</code>, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> IntegrationFlow recipientListFlow() {
    <span class="hl-keyword">return</span> IntegrationFlows.from(<span class="hl-string">"recipientListInput"</span>)
            .&lt;String, String&gt;transform(p -&gt; p.replaceFirst(<span class="hl-string">"Payload"</span>, <span class="hl-string">""</span>))
                        .routeToRecipients(r -&gt; r
                .recipient(<span class="hl-string">"thing1-channel"</span>, <span class="hl-string">"'thing1' == payload"</span>)
                .recipient(<span class="hl-string">"thing2-channel"</span>, m -&gt;
                    m.getHeaders().containsKey(<span class="hl-string">"recipient"</span>)
                        &amp;&amp; (<span class="hl-keyword">boolean</span>) m.getHeaders().get(<span class="hl-string">"recipient"</span>))
                .recipientFlow(<span class="hl-string">"'thing1' == payload or 'thing2' == payload or 'thing3' == payload"</span>,
                    f -&gt; f.&lt;String, String&gt;transform(String::toUpperCase)
                        .channel(c -&gt; c.queue(<span class="hl-string">"recipientListSubFlow1Result"</span>)))
                .recipientFlow((String p) -&gt; p.startsWith(<span class="hl-string">"thing3"</span>),
                    f -&gt; f.transform(<span class="hl-string">"Hello "</span>::concat)
                        .channel(c -&gt; c.queue(<span class="hl-string">"recipientListSubFlow2Result"</span>)))
                .recipientFlow(<span class="hl-keyword">new</span> FunctionExpression&lt;Message&lt;?&gt;&gt;(m -&gt;
                                             <span class="hl-string">"thing3"</span>.equals(m.getPayload())),
                    f -&gt; f.channel(c -&gt; c.queue(<span class="hl-string">"recipientListSubFlow3Result"</span>)))
                .defaultOutputToParentFlow())
            .get();
}</pre>
</div>
<p>The <code class="literal">.defaultOutputToParentFlow()</code> of the <code class="literal">.routeToRecipients()</code> definition lets you set the router&#8217;s <code class="literal">defaultOutput</code> as a gateway to continue a process for the unmatched messages in the main flow.</p>
<p>Also see <a class="xref" href="#java-dsl-class-cast" title="Lambdas And Message<?&gt; Arguments">Lambdas And <code class="literal">Message&lt;?&gt;</code> Arguments</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="java-dsl-splitters" href="#java-dsl-splitters"></a>11.8&nbsp;Splitters</h2></div></div></div>

<p>To create a splitter, use the <code class="literal">split()</code> EIP method.
By default, if the payload is an <code class="literal">Iterable</code>, an <code class="literal">Iterator</code>, an <code class="literal">Array</code>, a <code class="literal">Stream</code>, or a reactive <code class="literal">Publisher</code>, the <code class="literal">split()</code> method outputs each item as an individual message.
It accepts a lambda, a SpEL expression, or any <code class="literal">AbstractMessageSplitter</code> implementation.
Alternatively, you can use it without parameters to provide the <code class="literal">DefaultMessageSplitter</code>.
The following example shows how to use the <code class="literal">split()</code> method by providing a lambda:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> IntegrationFlow splitFlow() {
    <span class="hl-keyword">return</span> IntegrationFlows.from(<span class="hl-string">"splitInput"</span>)
              .split(s -&gt;
                      s.applySequence(false).get().getT2().setDelimiters(<span class="hl-string">","</span>))
              .channel(MessageChannels.executor(<span class="hl-keyword">this</span>.taskExecutor()))
              .get();
}</pre>
<p>The preceding example creates a splitter that splits a message containing a comma-delimited <code class="literal">String</code>.
Note: The <code class="literal">getT2()</code> method comes from a <code class="literal">Tuple</code> <code class="literal">Collection</code>, which is the result of <code class="literal">EndpointSpec.get()</code>, and represents a pair of <code class="literal">ConsumerEndpointFactoryBean</code> and <code class="literal">DefaultMessageSplitter</code> for the preceding example.</p>
<p>Also see <a class="xref" href="#java-dsl-class-cast" title="Lambdas And Message<?&gt; Arguments">Lambdas And <code class="literal">Message&lt;?&gt;</code> Arguments</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="java-dsl-aggregators" href="#java-dsl-aggregators"></a>11.9&nbsp;Aggregators and Resequencers</h2></div></div></div>

<p>An <code class="literal">Aggregator</code> is conceptually the opposite of a <code class="literal">Splitter</code>.
It aggregates a sequence of individual messages into a single message and is necessarily more complex.
By default, an aggregator returns a message that contains a collection of payloads from incoming messages.
The same rules are applied for the <code class="literal">Resequencer</code>.
The following example shows a canonical example of the splitter-aggregator pattern:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> IntegrationFlow splitAggregateFlow() {
    <span class="hl-keyword">return</span> IntegrationFlows.from(<span class="hl-string">"splitAggregateInput"</span>)
            .split()
            .channel(MessageChannels.executor(<span class="hl-keyword">this</span>.taskExecutor()))
            .resequence()
            .aggregate()
            .get();
}</pre>
<p>The <code class="literal">split()</code> method splits the list into individual messages and sends them to the <code class="literal">ExecutorChannel</code>.
The <code class="literal">resequence()</code> method reorders messages by sequence details found in the message headers.
The <code class="literal">aggregate()</code> method collects those messages.</p>
<p>However, you can change the default behavior by specifying a release strategy and correlation strategy, among other things.
Consider the following example:</p>
<div class="informalexample">
<pre class="programlisting">.aggregate(a -&gt;
        a.correlationStrategy(m -&gt; m.getHeaders().get(<span class="hl-string">"myCorrelationKey"</span>))
            .releaseStrategy(g -&gt; g.size() &gt; <span class="hl-number">10</span>)
            .messageStore(messageStore()))</pre>
</div>
<p>The preceding example correlates messages that have <code class="literal">myCorrelationKey</code> headers and releases the messages once at least ten have been accumulated.</p>
<p>Similar lambda configurations are provided for the <code class="literal">resequence()</code> EIP method.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="java-dsl-handle" href="#java-dsl-handle"></a>11.10&nbsp;Service Activators and the <code class="literal">.handle()</code> method</h2></div></div></div>

<p>The <code class="literal">.handle()</code> EIP method&#8217;s goal is to invoke any <code class="literal">MessageHandler</code> implementation or any method on some POJO.
Another option is to define an "<code class="literal">activity</code>" by using lambda expressions.
Consequently, we introduced a generic <code class="literal">GenericHandler&lt;P&gt;</code> functional interface.
Its <code class="literal">handle</code> method requires two arguments: <code class="literal">P payload</code> and <code class="literal">MessageHeaders headers</code> (starting with version 5.1).
Having that, we can define a flow as follows:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> IntegrationFlow myFlow() {
    <span class="hl-keyword">return</span> IntegrationFlows.from(<span class="hl-string">"flow3Input"</span>)
        .&lt;Integer&gt;handle((p, h) -&gt; p * <span class="hl-number">2</span>)
        .get();
}</pre>
</div>
<p>The preceding example doubles any integer it receives.</p>
<p>However, one main goal of Spring Integration is <code class="literal">loose coupling</code>, through runtime type conversion from message payload to the target arguments of the message handler.
Since Java does not support generic type resolution for lambda classes, we introduced a workaround with an additional <code class="literal">payloadType</code> argument for the most EIP methods and <code class="literal">LambdaMessageProcessor</code>.
Doing so delegates the hard conversion work to Spring&#8217;s <code class="literal">ConversionService</code>, which uses the provided <code class="literal">type</code> and the requested message to target method arguments.
The following example shows what the resulting <code class="literal">IntegrationFlow</code> might look like:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> IntegrationFlow integerFlow() {
    <span class="hl-keyword">return</span> IntegrationFlows.from(<span class="hl-string">"input"</span>)
            .&lt;<span class="hl-keyword">byte</span>[], String&gt;transform(p - &gt; <span class="hl-keyword">new</span> String(p, <span class="hl-string">"UTF-8"</span>))
            .handle(Integer.<span class="hl-keyword">class</span>, (p, h) -&gt; p * <span class="hl-number">2</span>)
            .get();
}</pre>
</div>
<p>We also can register some <code class="literal">BytesToIntegerConverter</code> within <code class="literal">ConversionService</code> to get rid of that additional <code class="literal">.transform()</code>:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<em><span class="hl-annotation" style="color: gray">@IntegrationConverter</span></em>
<span class="hl-keyword">public</span> BytesToIntegerConverter bytesToIntegerConverter() {
   <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> BytesToIntegerConverter();
}

<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> IntegrationFlow integerFlow() {
    <span class="hl-keyword">return</span> IntegrationFlows.from(<span class="hl-string">"input"</span>)
             .handle(Integer.<span class="hl-keyword">class</span>, (p, h) -&gt; p * <span class="hl-number">2</span>)
            .get();
}</pre>
</div>
<p>Also see <a class="xref" href="#java-dsl-class-cast" title="Lambdas And Message<?&gt; Arguments">Lambdas And <code class="literal">Message&lt;?&gt;</code> Arguments</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="java-dsl-log" href="#java-dsl-log"></a>11.11&nbsp;Operator log()</h2></div></div></div>

<p>For convenience, to log the message journey through the Spring Integration flow (<code class="literal">&lt;logging-channel-adapter&gt;</code>), a <code class="literal">log()</code> operator is presented.
Internally, it is represented by the <code class="literal">WireTap</code> <code class="literal">ChannelInterceptor</code> with a <code class="literal">LoggingHandler</code> as its subscriber.
It is responsible for logging the incoming message into the next endpoint or the current channel.
The following example shows how to use <code class="literal">LoggingHandler</code>:</p>
<div class="informalexample">
<pre class="programlisting">.filter(...)
.log(LoggingHandler.Level.ERROR, <span class="hl-string">"test.category"</span>, m -&gt; m.getHeaders().getId())
.route(...)</pre>
</div>
<p>In the preceding example, an <code class="literal">id</code> header is logged at the <code class="literal">ERROR</code> level onto <code class="literal">test.category</code> only for messages that passed the filter and before routing.</p>
<p>When this operator is used at the end of a flow, it is a one-way handler and the flow ends.
To make it as a reply-producing flow, you can either use a simple <code class="literal">bridge()</code> after the <code class="literal">log()</code> or,  starting with version 5.1, you can use a <code class="literal">logAndReply()</code> operator instead.
<code class="literal">logAndReply</code> can only be used at the end of a flow.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="java-dsl-wiretap" href="#java-dsl-wiretap"></a>11.12&nbsp;<code class="literal">MessageChannelSpec.wireTap()</code></h2></div></div></div>

<p>Spring Integration includes a <code class="literal">.wireTap()</code> fluent API <code class="literal">MessageChannelSpec</code> builders.
The following example shows how to use the <code class="literal">wireTap</code> method to log input:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> QueueChannelSpec myChannel() {
    <span class="hl-keyword">return</span> MessageChannels.queue()
            .wireTap(<span class="hl-string">"loggingFlow.input"</span>);
}

<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> IntegrationFlow loggingFlow() {
    <span class="hl-keyword">return</span> f -&gt; f.log();
}</pre>
</div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>If the <code class="literal">MessageChannel</code> is an instance of <code class="literal">ChannelInterceptorAware</code>, the <code class="literal">log()</code> or <code class="literal">wireTap()</code> operators are applied to the current <code class="literal">MessageChannel</code>.
Otherwise, an intermediate <code class="literal">DirectChannel</code> is injected into the flow for the currently configured endpoint.
In the following example, the <code class="literal">WireTap</code> interceptor is added to <code class="literal">myChannel</code> directly, because <code class="literal">DirectChannel</code> implements <code class="literal">ChannelInterceptorAware</code>:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
MessageChannel myChannel() {
    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> DirectChannel();
}

...
    .channel(myChannel())
    .log()
}</pre>
</td></tr></table></div>
<p>When the current <code class="literal">MessageChannel</code> does not implement <code class="literal">ChannelInterceptorAware</code>, an implicit <code class="literal">DirectChannel</code> and <code class="literal">BridgeHandler</code> are injected into the <code class="literal">IntegrationFlow</code>, and the <code class="literal">WireTap</code> is added to this new <code class="literal">DirectChannel</code>.
The following example does not have any channel declaration:</p>
<div class="informalexample">
<pre class="programlisting">.handle(...)
.log()
}</pre>
</div>
<p>In the preceding example (and any time no channel has been declared), an implicit <code class="literal">DirectChannel</code> is injected in the current position of the <code class="literal">IntegrationFlow</code> and used as an output channel for the currently configured <code class="literal">ServiceActivatingHandler</code> (from the <code class="literal">.handle()</code>, <a class="link" href="#java-dsl-handle" title="11.10&nbsp;Service Activators and the .handle() method">described earlier</a>).</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="java-dsl-flows" href="#java-dsl-flows"></a>11.13&nbsp;Working With Message Flows</h2></div></div></div>

<p><code class="literal">IntegrationFlowBuilder</code> provides a top-level API to produce integration components wired to message flows.
When your integration may be accomplished with a single flow (which is often the case), this is convenient.
Alternately <code class="literal">IntegrationFlow</code> instances can be joined via <code class="literal">MessageChannel</code> instances.</p>
<p>By default, <code class="literal">MessageFlow</code> behaves as a "<code class="literal">chain</code>" in Spring Integration parlance.
That is, the endpoints are automatically and implicitly wired by <code class="literal">DirectChannel</code> instances.
The message flow is not actually constructed as a chain, which offers much more flexibility.
For example, you may send a message to any component within the flow, if you know its <code class="literal">inputChannel</code> name (that is, if you explicitly define it).
You may also reference externally defined channels within a flow to allow the use of channel adapters (to enable remote transport protocols, file I/O, and so on), instead of direct channels.
As such, the DSL does not support the Spring Integration <code class="literal">chain</code> element, because it does not add much value in this case.</p>
<p>Since the Spring Integration Java DSL produces the same bean definition model as any other configuration options and is based on the existing Spring Framework <code class="literal">@Configuration</code> infrastructure, it can be used together with XML definitions and wired with Spring Integration messaging annotation configuration.</p>
<p>You can also define direct <code class="literal">IntegrationFlow</code> instances by using a lambda.
The following example shows how to do so:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> IntegrationFlow lambdaFlow() {
    <span class="hl-keyword">return</span> f -&gt; f.filter(<span class="hl-string">"World"</span>::equals)
                   .transform(<span class="hl-string">"Hello "</span>::concat)
                   .handle(System.out::println);
}</pre>
</div>
<p>The result of this definition is the same set of integration components that are wired with an implicit direct channel.
The only limitation here is that this flow is started with a named direct channel - <code class="literal">lambdaFlow.input</code>.
Also, a Lambda flow cannot start from <code class="literal">MessageSource</code> or <code class="literal">MessageProducer</code>.</p>
<p>Starting with version 5.1, this kind of <code class="literal">IntegrationFlow</code> is wrapped to the proxy to expose lifecycle control and provide access to the <code class="literal">inputChannel</code> of the internally associated <code class="literal">StandardIntegrationFlow</code>.</p>
<p>Starting with version 5.0.6, the generated bean names for the components in an <code class="literal">IntegrationFlow</code> include the flow bean followed by a dot (<code class="literal">.</code>) as a prefix.
For example, the <code class="literal">ConsumerEndpointFactoryBean</code> for the <code class="literal">.transform("Hello "::concat)</code> in the preceding sample results in a bean name of <code class="literal">lambdaFlow.o.s.i.config.ConsumerEndpointFactoryBean#0</code>.
(The <code class="literal">o.s.i</code> is a shortened from <code class="literal">org.springframework.integration</code> to fit on the page.)
The <code class="literal">Transformer</code> implementation bean for that endpoint  has a bean name of <code class="literal">lambdaFlow.transformer#0</code> (starting with version 5.1), where instead of a fully qualified name of the <code class="literal">MethodInvokingTransformer</code> class, its component type is used.
The same pattern is applied for all the <code class="literal">NamedComponent</code> s when the bean name has to be generated within the flow.
These generated bean names are prepended with the flow ID for purposes such as parsing logs or grouping components together in some analysis tool, as well as to avoid a race condition when we concurrently register integration flows at runtime.
See <a class="xref" href="#java-dsl-runtime-flows" title="11.18&nbsp;Dynamic and Runtime Integration Flows">Section&nbsp;11.18, &#8220;Dynamic and Runtime Integration Flows&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="java-dsl-function-expression" href="#java-dsl-function-expression"></a>11.14&nbsp;<code class="literal">FunctionExpression</code></h2></div></div></div>

<p>We introduced the <code class="literal">FunctionExpression</code> class (an implementation of SpEL&#8217;s <code class="literal">Expression</code> interface) to let us use lambdas and <code class="literal">generics</code>.
The <code class="literal">Function&lt;T, R&gt;</code> option is provided for the DSL components, along with an <code class="literal">expression</code> option, when there is the implicit <code class="literal">Strategy</code> variant from Core Spring Integration.
The following example shows how to use a function expression:</p>
<div class="informalexample">
<pre class="programlisting">.enrich(e -&gt; e.requestChannel(<span class="hl-string">"enrichChannel"</span>)
            .requestPayload(Message::getPayload)
            .propertyFunction(<span class="hl-string">"date"</span>, m -&gt; <span class="hl-keyword">new</span> Date()))</pre>
</div>
<p>The <code class="literal">FunctionExpression</code> also supports runtime type conversion, as is done in <code class="literal">SpelExpression</code>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="java-dsl-subflows" href="#java-dsl-subflows"></a>11.15&nbsp;Sub-flows support</h2></div></div></div>

<p>Some of <code class="literal">if...else</code> and <code class="literal">publish-subscribe</code> components provide the ability to specify their logic or mapping by using sub-flows.
The simplest sample is <code class="literal">.publishSubscribeChannel()</code>, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> IntegrationFlow subscribersFlow() {
    <span class="hl-keyword">return</span> flow -&gt; flow
            .publishSubscribeChannel(Executors.newCachedThreadPool(), s -&gt; s
                    .subscribe(f -&gt; f
                            .&lt;Integer&gt;handle((p, h) -&gt; p / <span class="hl-number">2</span>)
                            .channel(c -&gt; c.queue(<span class="hl-string">"subscriber1Results"</span>)))
                    .subscribe(f -&gt; f
                            .&lt;Integer&gt;handle((p, h) -&gt; p * <span class="hl-number">2</span>)
                            .channel(c -&gt; c.queue(<span class="hl-string">"subscriber2Results"</span>))))
            .&lt;Integer&gt;handle((p, h) -&gt; p * <span class="hl-number">3</span>)
            .channel(c -&gt; c.queue(<span class="hl-string">"subscriber3Results"</span>));
}</pre>
</div>
<p>You can achieve the same result with separate <code class="literal">IntegrationFlow</code> <code class="literal">@Bean</code> definitions, but we hope you find the sub-flow style of logic composition useful.
We find that it results in shorter (and so more readable) code.</p>
<p>A similar <code class="literal">publish-subscribe</code> sub-flow composition provides the <code class="literal">.routeToRecipients()</code> method.</p>
<p>Another example is using <code class="literal">.discardFlow()</code> instead of <code class="literal">.discardChannel()</code> on the <code class="literal">.filter()</code> method.</p>
<p>The <code class="literal">.route()</code> deserves special attention.
Consider the following example:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> IntegrationFlow routeFlow() {
    <span class="hl-keyword">return</span> f -&gt; f
            .&lt;Integer, Boolean&gt;route(p -&gt; p % <span class="hl-number">2</span> == <span class="hl-number">0</span>,
                    m -&gt; m.channelMapping(<span class="hl-string">"true"</span>, <span class="hl-string">"evenChannel"</span>)
                            .subFlowMapping(<span class="hl-string">"false"</span>, sf -&gt;
                                    sf.&lt;Integer&gt;handle((p, h) -&gt; p * <span class="hl-number">3</span>)))
            .transform(Object::toString)
            .channel(c -&gt; c.queue(<span class="hl-string">"oddChannel"</span>));
}</pre>
</div>
<p>The <code class="literal">.channelMapping()</code> continues to work as it does in regular <code class="literal">Router</code> mapping, but the <code class="literal">.subFlowMapping()</code> tied that sub-flow to the main flow.
In other words, any router&#8217;s sub-flow returns to the main flow after <code class="literal">.route()</code>.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Sometimes, you need to refer to an existing <code class="literal">IntegrationFlow</code> <code class="literal">@Bean</code> from the <code class="literal">.subFlowMapping()</code>.
The following example shows how to do so:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> IntegrationFlow splitRouteAggregate() {
    <span class="hl-keyword">return</span> f -&gt; f
            .split()
            .&lt;Integer, Boolean&gt;route(o -&gt; o % <span class="hl-number">2</span> == <span class="hl-number">0</span>,
                    m -&gt; m
                            .subFlowMapping(true, oddFlow())
                            .subFlowMapping(false, sf -&gt; sf.gateway(evenFlow())))
            .aggregate();
}

<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> IntegrationFlow oddFlow() {
    <span class="hl-keyword">return</span> f -&gt; f.handle(m -&gt; System.out.println(<span class="hl-string">"odd"</span>));
}

<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> IntegrationFlow evenFlow() {
    <span class="hl-keyword">return</span> f -&gt; f.handle((p, h) -&gt; <span class="hl-string">"even"</span>);
}</pre>
<p>
In this case, when you need to receive a reply from such a sub-flow and continue the main flow, this <code class="literal">IntegrationFlow</code> bean reference (or its input channel) has to be wrapped with a <code class="literal">.gateway()</code> as shown in the preceding example.
The <code class="literal">oddFlow()</code> reference in the preceding example is not wrapped to the <code class="literal">.gateway()</code>.
Therefore, we do not expect a reply from this routing branch.
Otherwise, you end up with an exception similar to the following:</p>
<pre class="literallayout">Caused by: org.springframework.beans.factory.BeanCreationException:
    The 'currentComponent' (org.springframework.integration.router.MethodInvokingRouter@7965a51c)
    is a one-way 'MessageHandler' and it isn't appropriate to configure 'outputChannel'.
    This is the end of the integration flow.</pre>
<p>When you configure a sub-flow as a lambda, the framework handles the request-reply interaction with the sub-flow and a gateway is not needed.</p>
</td></tr></table></div>
<p>Sub-flows can be nested to any depth, but we do not recommend doing so.
In fact, even in the router case, adding complex sub-flows within a flow would quickly begin to look like a plate of spaghetti and be difficult for a human to parse.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="java-dsl-protocol-adapters" href="#java-dsl-protocol-adapters"></a>11.16&nbsp;Using Protocol Adapters</h2></div></div></div>

<p>All of the examples shown so far illustrate how the DSL supports a messaging architecture by using the Spring Integration programming model.
However, we have yet to do any real integration.
Doing so requires access to remote resources over HTTP, JMS, AMQP, TCP, JDBC, FTP, SMTP, and so on or access to the local file system.
Spring Integration supports all of these and more.
Ideally, the DSL should offer first class support for all of them, but it is a daunting task to implement all of these and keep up as new adapters are added to Spring Integration.
So the expectation is that the DSL is continually catching up with Spring Integration.</p>
<p>Consequently, we provide the high-level API to seamlessly define protocol-specific messaging.
We do so with the factory and builder patterns and with lambdas.
You can think of the factory classes as "<code class="literal">Namespace Factories</code>", because they play the same role as the XML namespace for components from the concrete protocol-specific Spring Integration modules.
Currently, Spring Integration Java DSL supports the <code class="literal">Amqp</code>, <code class="literal">Feed</code>, <code class="literal">Jms</code>, <code class="literal">Files</code>, <code class="literal">(S)Ftp</code>, <code class="literal">Http</code>, <code class="literal">JPA</code>, <code class="literal">MongoDb</code>,  <code class="literal">TCP/UDP</code>, <code class="literal">Mail</code>, <code class="literal">WebFlux</code>, and <code class="literal">Scripts</code> namespace factories.
The following example shows how to use three of them (<code class="literal">Amqp</code>, <code class="literal">Jms</code>, and <code class="literal">Mail</code>):</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> IntegrationFlow amqpFlow() {
    <span class="hl-keyword">return</span> IntegrationFlows.from(Amqp.inboundGateway(<span class="hl-keyword">this</span>.rabbitConnectionFactory, queue()))
            .transform(<span class="hl-string">"hello "</span>::concat)
            .transform(String.<span class="hl-keyword">class</span>, String::toUpperCase)
            .get();
}

<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> IntegrationFlow jmsOutboundGatewayFlow() {
    <span class="hl-keyword">return</span> IntegrationFlows.from(<span class="hl-string">"jmsOutboundGatewayChannel"</span>)
            .handle(Jms.outboundGateway(<span class="hl-keyword">this</span>.jmsConnectionFactory)
                        .replyContainer(c -&gt;
                                    c.concurrentConsumers(<span class="hl-number">3</span>)
                                            .sessionTransacted(true))
                        .requestDestination(<span class="hl-string">"jmsPipelineTest"</span>))
            .get();
}

<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> IntegrationFlow sendMailFlow() {
    <span class="hl-keyword">return</span> IntegrationFlows.from(<span class="hl-string">"sendMailChannel"</span>)
            .handle(Mail.outboundAdapter(<span class="hl-string">"localhost"</span>)
                            .port(smtpPort)
                            .credentials(<span class="hl-string">"user"</span>, <span class="hl-string">"pw"</span>)
                            .protocol(<span class="hl-string">"smtp"</span>)
                            .javaMailProperties(p -&gt; p.put(<span class="hl-string">"mail.debug"</span>, <span class="hl-string">"true"</span>)),
                    e -&gt; e.id(<span class="hl-string">"sendMailEndpoint"</span>))
            .get();
}</pre>
</div>
<p>The preceding example shows how to use the "<code class="literal">namespace factories</code>" as inline adapters declarations.
However, you can use them from <code class="literal">@Bean</code> definitions to make the <code class="literal">IntegrationFlow</code> method chain more readable.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>We are soliciting community feedback on these namespace factories before we spend effort on others.
We also appreciate any input into prioritization for which adapters and gateways we should support next.</p>
</td></tr></table></div>
<p>You can find more Java DSL samples in the protocol-specific chapters throughout this reference manual.</p>
<p>All other protocol channel adapters may be configured as generic beans and wired to the <code class="literal">IntegrationFlow</code>, as the following examples show:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> QueueChannelSpec wrongMessagesChannel() {
    <span class="hl-keyword">return</span> MessageChannels
            .queue()
            .wireTap(<span class="hl-string">"wrongMessagesWireTapChannel"</span>);
}

<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> IntegrationFlow xpathFlow(MessageChannel wrongMessagesChannel) {
    <span class="hl-keyword">return</span> IntegrationFlows.from(<span class="hl-string">"inputChannel"</span>)
            .filter(<span class="hl-keyword">new</span> StringValueTestXPathMessageSelector(<span class="hl-string">"namespace-uri(/*)"</span>, <span class="hl-string">"my:namespace"</span>),
                    e -&gt; e.discardChannel(wrongMessagesChannel))
            .log(LoggingHandler.Level.ERROR, <span class="hl-string">"test.category"</span>, m -&gt; m.getHeaders().getId())
            .route(xpathRouter(wrongMessagesChannel))
            .get();
}

<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> AbstractMappingMessageRouter xpathRouter(MessageChannel wrongMessagesChannel) {
    XPathRouter router = <span class="hl-keyword">new</span> XPathRouter(<span class="hl-string">"local-name(/*)"</span>);
    router.setEvaluateAsString(true);
    router.setResolutionRequired(false);
    router.setDefaultOutputChannel(wrongMessagesChannel);
    router.setChannelMapping(<span class="hl-string">"Tags"</span>, <span class="hl-string">"splittingChannel"</span>);
    router.setChannelMapping(<span class="hl-string">"Tag"</span>, <span class="hl-string">"receivedChannel"</span>);
    <span class="hl-keyword">return</span> router;
}</pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="java-dsl-flow-adapter" href="#java-dsl-flow-adapter"></a>11.17&nbsp;<code class="literal">IntegrationFlowAdapter</code></h2></div></div></div>

<p>The <code class="literal">IntegrationFlow</code> interface can be implemented directly and specified as a component for scanning, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Component</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyFlow <span class="hl-keyword">implements</span> IntegrationFlow {

    <em><span class="hl-annotation" style="color: gray">@Override</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> configure(IntegrationFlowDefinition&lt;?&gt; f) {
        f.&lt;String, String&gt;transform(String::toUpperCase);
    }

}</pre>
</div>
<p>It is picked up by the <code class="literal">IntegrationFlowBeanPostProcessor</code> and correctly parsed and registered in the application context.</p>
<p>For convenience and to gain the benefits of loosely coupled architecture, we provide the <code class="literal">IntegrationFlowAdapter</code> base class implementation.
It requires a <code class="literal">buildFlow()</code> method implementation to produce an <code class="literal">IntegrationFlowDefinition</code> by using one of <code class="literal">from()</code> methods, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Component</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyFlowAdapter <span class="hl-keyword">extends</span> IntegrationFlowAdapter {

    <span class="hl-keyword">private</span> <span class="hl-keyword">final</span> AtomicBoolean invoked = <span class="hl-keyword">new</span> AtomicBoolean();

    <span class="hl-keyword">public</span> Date nextExecutionTime(TriggerContext triggerContext) {
          <span class="hl-keyword">return</span> <span class="hl-keyword">this</span>.invoked.getAndSet(true) ? null : <span class="hl-keyword">new</span> Date();
    }

    <em><span class="hl-annotation" style="color: gray">@Override</span></em>
    <span class="hl-keyword">protected</span> IntegrationFlowDefinition&lt;?&gt; buildFlow() {
        <span class="hl-keyword">return</span> from(<span class="hl-keyword">this</span>, <span class="hl-string">"messageSource"</span>,
                      e -&gt; e.poller(p -&gt; p.trigger(<span class="hl-keyword">this</span>::nextExecutionTime)))
                 .split(<span class="hl-keyword">this</span>)
                 .transform(<span class="hl-keyword">this</span>)
                 .aggregate(a -&gt; a.processor(<span class="hl-keyword">this</span>, null), null)
                 .enrichHeaders(Collections.singletonMap(<span class="hl-string">"thing1"</span>, <span class="hl-string">"THING1"</span>))
                 .filter(<span class="hl-keyword">this</span>)
                 .handle(<span class="hl-keyword">this</span>)
                 .channel(c -&gt; c.queue(<span class="hl-string">"myFlowAdapterOutput"</span>));
    }

    <span class="hl-keyword">public</span> String messageSource() {
         <span class="hl-keyword">return</span> <span class="hl-string">"T,H,I,N,G,2"</span>;
    }

    <em><span class="hl-annotation" style="color: gray">@Splitter</span></em>
    <span class="hl-keyword">public</span> String[] split(String payload) {
         <span class="hl-keyword">return</span> StringUtils.commaDelimitedListToStringArray(payload);
    }

    <em><span class="hl-annotation" style="color: gray">@Transformer</span></em>
    <span class="hl-keyword">public</span> String transform(String payload) {
         <span class="hl-keyword">return</span> payload.toLowerCase();
    }

    <em><span class="hl-annotation" style="color: gray">@Aggregator</span></em>
    <span class="hl-keyword">public</span> String aggregate(List&lt;String&gt; payloads) {
           <span class="hl-keyword">return</span> payloads.stream().collect(Collectors.joining());
    }

    <em><span class="hl-annotation" style="color: gray">@Filter</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">boolean</span> filter(<em><span class="hl-annotation" style="color: gray">@Header</span></em> Optional&lt;String&gt; thing1) {
            <span class="hl-keyword">return</span> thing1.isPresent();
    }

    <em><span class="hl-annotation" style="color: gray">@ServiceActivator</span></em>
    <span class="hl-keyword">public</span> String handle(String payload, <em><span class="hl-annotation" style="color: gray">@Header</span></em> String thing1) {
           <span class="hl-keyword">return</span> payload + <span class="hl-string">":"</span> + thing1;
    }

}</pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="java-dsl-runtime-flows" href="#java-dsl-runtime-flows"></a>11.18&nbsp;Dynamic and Runtime Integration Flows</h2></div></div></div>

<p><code class="literal">IntegrationFlow</code> and all its dependent components can be registered at runtime.
Before version 5.0, we used the <code class="literal">BeanFactory.registerSingleton()</code> hook.
Starting in the Spring Framework <code class="literal">5.0</code>, we use the <code class="literal">instanceSupplier</code> hook for programmatic <code class="literal">BeanDefinition</code> registration.
The following example shows how to programmatically register a bean:</p>
<div class="informalexample">
<pre class="programlisting">BeanDefinition beanDefinition =
         BeanDefinitionBuilder.genericBeanDefinition((Class&lt;Object&gt;) bean.getClass(), () -&gt; bean)
               .getRawBeanDefinition();

((BeanDefinitionRegistry) <span class="hl-keyword">this</span>.beanFactory).registerBeanDefinition(beanName, beanDefinition);</pre>
</div>
<p>Note that, in the preceding example, the <code class="literal">instanceSupplier</code> hook is the last parameter to the <code class="literal">genericBeanDefinition</code> method, provided by a lambda in this case.</p>
<p>All the necessary bean initialization and lifecycle is done automatically, as it is with the standard context configuration bean definitions.</p>
<p>To simplify the development experience, Spring Integration introduced <code class="literal">IntegrationFlowContext</code> to register and manage <code class="literal">IntegrationFlow</code> instances at runtime, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Autowired</span></em>
<span class="hl-keyword">private</span> AbstractServerConnectionFactory server1;

<em><span class="hl-annotation" style="color: gray">@Autowired</span></em>
<span class="hl-keyword">private</span> IntegrationFlowContext flowContext;

...

<em><span class="hl-annotation" style="color: gray">@Test</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> testTcpGateways() {
    TestingUtilities.waitListening(<span class="hl-keyword">this</span>.server1, null);

    IntegrationFlow flow = f -&gt; f
            .handle(Tcp.outboundGateway(Tcp.netClient(<span class="hl-string">"localhost"</span>, <span class="hl-keyword">this</span>.server1.getPort())
                    .serializer(TcpCodecs.crlf())
                    .deserializer(TcpCodecs.lengthHeader1())
                    .id(<span class="hl-string">"client1"</span>))
                .remoteTimeout(m -&gt; <span class="hl-number">5000</span>))
            .transform(Transformers.objectToString());

    IntegrationFlowRegistration theFlow = <span class="hl-keyword">this</span>.flowContext.registration(flow).register();
    assertThat(theFlow.getMessagingTemplate().convertSendAndReceive(<span class="hl-string">"foo"</span>, String.<span class="hl-keyword">class</span>), equalTo(<span class="hl-string">"FOO"</span>));
}</pre>
</div>
<p>This is useful when we have multiple configuration options and have to create several instances of similar flows.
To do so, we can iterate our options and create and register <code class="literal">IntegrationFlow</code> instances within a loop.
Another variant is when our source of data is not Spring-based and we must create it on the fly.
Such a sample is Reactive Streams event source, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting">Flux&lt;Message&lt;?&gt;&gt; messageFlux =
    Flux.just(<span class="hl-string">"1,2,3,4"</span>)
        .map(v -&gt; v.split(<span class="hl-string">","</span>))
        .flatMapIterable(Arrays::asList)
        .map(Integer::parseInt)
        .map(GenericMessage&lt;Integer&gt;::<span class="hl-keyword">new</span>);

QueueChannel resultChannel = <span class="hl-keyword">new</span> QueueChannel();

IntegrationFlow integrationFlow =
    IntegrationFlows.from(messageFlux)
        .&lt;Integer, Integer&gt;transform(p -&gt; p * <span class="hl-number">2</span>)
        .channel(resultChannel)
        .get();

<span class="hl-keyword">this</span>.integrationFlowContext.registration(integrationFlow)
            .register();</pre>
</div>
<p>The <code class="literal">IntegrationFlowRegistrationBuilder</code> (as a result of the <code class="literal">IntegrationFlowContext.registration()</code>) can be used to specify a bean name for the <code class="literal">IntegrationFlow</code> to register, to control its <code class="literal">autoStartup</code>, and to register, non-Spring Integration beans.
Usually, those additional beans are connection factories (AMQP, JMS, (S)FTP, TCP/UDP, and others.), serializers and deserializers, or any other required support components.</p>
<p>You can use the <code class="literal">IntegrationFlowRegistration.destroy()</code> callback to remove a dynamically registered <code class="literal">IntegrationFlow</code> and all its dependent beans when you no longer need them.
See the <a class="ulink" href="https://docs.spring.io/spring-integration/api/org/springframework/integration/dsl/context/IntegrationFlowContext.html" target="_top"><code class="literal">IntegrationFlowContext</code> Javadoc</a> for more information.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Starting with version 5.0.6, all generated bean names in an <code class="literal">IntegrationFlow</code> definition are prepended with the flow ID as a prefix.
We recommend always specifying an explicit flow ID.
Otherwise, a synchronization barrier is initiated in the <code class="literal">IntegrationFlowContext</code>, to generate the bean name for the <code class="literal">IntegrationFlow</code> and register its beans.
We synchronize on these two operations to avoid a race condition when the same generated bean name may be used for different <code class="literal">IntegrationFlow</code> instances.</p>
</td></tr></table></div>
<p>Also, starting with version 5.0.6, the registration builder API has a new method: <code class="literal">useFlowIdAsPrefix()</code>.
This is useful if you wish to declare multiple instances of the same flow and avoid bean name collisions when components in the flows have the same ID, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">private</span> <span class="hl-keyword">void</span> registerFlows() {
    IntegrationFlowRegistration flow1 =
              <span class="hl-keyword">this</span>.flowContext.registration(buildFlow(<span class="hl-number">1234</span>))
                    .id(<span class="hl-string">"tcp1"</span>)
                    .useFlowIdAsPrefix()
                    .register();

    IntegrationFlowRegistration flow2 =
              <span class="hl-keyword">this</span>.flowContext.registration(buildFlow(<span class="hl-number">1235</span>))
                    .id(<span class="hl-string">"tcp2"</span>)
                    .useFlowIdAsPrefix()
                    .register();
}

<span class="hl-keyword">private</span> IntegrationFlow buildFlow(<span class="hl-keyword">int</span> port) {
    <span class="hl-keyword">return</span> f -&gt; f
            .handle(Tcp.outboundGateway(Tcp.netClient(<span class="hl-string">"localhost"</span>, port)
                    .serializer(TcpCodecs.crlf())
                    .deserializer(TcpCodecs.lengthHeader1())
                    .id(<span class="hl-string">"client"</span>))
                .remoteTimeout(m -&gt; <span class="hl-number">5000</span>))
            .transform(Transformers.objectToString());
}</pre>
</div>
<p>In this case, the message handler for the first flow can be referenced with bean a name of <code class="literal">tcp1.client.handler</code>.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>An <code class="literal">id</code> attribute is required when you usE <code class="literal">useFlowIdAsPrefix()</code>.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="java-dsl-gateway" href="#java-dsl-gateway"></a>11.19&nbsp;<code class="literal">IntegrationFlow</code> as Gateway</h2></div></div></div>

<p>The <code class="literal">IntegrationFlow</code> can start from the service interface that provides a <code class="literal">GatewayProxyFactoryBean</code> component, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> ControlBusGateway {

    <span class="hl-keyword">void</span> send(String command);
}

...

<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> IntegrationFlow controlBusFlow() {
    <span class="hl-keyword">return</span> IntegrationFlows.from(ControlBusGateway.<span class="hl-keyword">class</span>)
            .controlBus()
            .get();
}</pre>
</div>
<p>All the proxy for interface methods are supplied with the channel to send messages to the next integration component in the <code class="literal">IntegrationFlow</code>.
You can mark the service interface with the <code class="literal">@MessagingGateway</code> annotation and mark the methods with the <code class="literal">@Gateway</code> annotations.
Nevertheless, the <code class="literal">requestChannel</code> is ignored and overridden with that internal channel for the next component in the <code class="literal">IntegrationFlow</code>.
Otherwise, creating such a configuration by using <code class="literal">IntegrationFlow</code> does not make sense.</p>
<p>By default a <code class="literal">GatewayProxyFactoryBean</code> gets a conventional bean name, such as <code class="literal">[FLOW_BEAN_NAME.gateway]</code>.
You can change that ID by using the <code class="literal">@MessagingGateway.name()</code> attribute or the overloaded <code class="literal">from(Class&lt;?&gt; serviceInterface, String beanName)</code> factory method.</p>
<p>With Java 8, you can even create an integration fateway with the <code class="literal">java.util.function</code> interfaces, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> IntegrationFlow errorRecovererFlow() {
    <span class="hl-keyword">return</span> IntegrationFlows.from(Function.<span class="hl-keyword">class</span>, <span class="hl-string">"errorRecovererFunction"</span>)
            .handle((GenericHandler&lt;?&gt;) (p, h) -&gt; {
                <span class="hl-keyword">throw</span> <span class="hl-keyword">new</span> RuntimeException(<span class="hl-string">"intentional"</span>);
            }, e -&gt; e.advice(retryAdvice()))
            .get();
}</pre>
</div>
<p>That <code class="literal">errorRecovererFlow</code> can be used as follows:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Autowired</span></em>
<em><span class="hl-annotation" style="color: gray">@Qualifier("errorRecovererFunction")</span></em>
<span class="hl-keyword">private</span> Function&lt;String, String&gt; errorRecovererFlowGateway;</pre>
</div>
</div>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="system-management-chapter" href="#system-management-chapter"></a>12.&nbsp;System Management</h2></div></div></div>

<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="metrics-management" href="#metrics-management"></a>12.1&nbsp;Metrics and Management</h2></div></div></div>

<p>This section describes how to capture metrics for Spring Integration. In recent versions, we have relied more on Micrometer (see <a class="ulink" href="http://micrometer.io" target="_top">http://micrometer.io</a>), and we plan to use Micrometer even more in future releases.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="configuring-metrics-capture" href="#configuring-metrics-capture"></a>12.1.1&nbsp;Configuring Metrics Capture</h3></div></div></div>

<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Prior to version 4.2, metrics were only available when JMX was enabled.
See <a class="xref" href="#jmx" title="12.2&nbsp;JMX Support">Section&nbsp;12.2, &#8220;JMX Support&#8221;</a>.</p>
</td></tr></table></div>
<p>To enable <code class="literal">MessageSource</code>, <code class="literal">MessageChannel</code>, and <code class="literal">MessageHandler</code> metrics, add an <code class="literal">&lt;int:management/&gt;</code> bean to the application context (in XML) or annotate one of your <code class="literal">@Configuration</code> classes with <code class="literal">@EnableIntegrationManagement</code> (in Java).
<code class="literal">MessageSource</code> instances maintain only counts, <code class="literal">MessageChannel</code> instances and <code class="literal">MessageHandler</code> instances maintain duration statistics in addition to counts.
See <a class="xref" href="#mgmt-channel-features" title="12.1.3&nbsp;MessageChannel Metric Features">Section&nbsp;12.1.3, &#8220;<code class="literal">MessageChannel</code> Metric Features&#8221;</a> and <a class="xref" href="#mgmt-handler-features" title="12.1.4&nbsp;MessageHandler Metric Features">Section&nbsp;12.1.4, &#8220;MessageHandler Metric Features&#8221;</a>, later in this chapter.</p>
<p>Doing so causes the automatic registration of the <code class="literal">IntegrationManagementConfigurer</code> bean in the application context.
Only one such bean can exist in the context, and, if registered manually via a <code class="literal">&lt;bean/&gt;</code> definition, it must have the bean name set to <code class="literal">integrationManagementConfigurer</code>.
This bean applies its configuration to beans after all beans in the context have been instantiated.</p>
<p>In addition to metrics, you can control debug logging in the main message flow.
In very high volume applications, even calls to <code class="literal">isDebugEnabled()</code> can be quite expensive with some logging subsystems.
You can disable all such logging to avoid this overhead.
Exception logging (debug or otherwise) is not affected by this setting.</p>
<p>The following listing shows the available options for controlling logging:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:management</span>
    <span class="hl-attribute">default-logging-enabled</span>=<span class="hl-value">"true"</span> <a name="CO17-1" href="#CO17-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
    default-counts-enabled="false" <a name="CO17-2" href="#CO17-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
    default-stats-enabled="false" <a name="CO17-3" href="#CO17-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
    counts-enabled-patterns="foo, !baz, ba*" <a name="CO17-4" href="#CO17-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
    stats-enabled-patterns="fiz, buz" <a name="CO17-5" href="#CO17-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
    metrics-factory="myMetricsFactory" /&gt; <a name="CO17-6" href="#CO17-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span></pre>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Configuration</span></em>
<em><span class="hl-annotation" style="color: gray">@EnableIntegration</span></em>
@EnableIntegrationManagement(
    defaultLoggingEnabled = <span class="hl-string">"true"</span>, <a name="CO17-7" href="#CO17-7"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
    defaultCountsEnabled = <span class="hl-string">"false"</span>, <a name="CO17-8" href="#CO17-8"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
    defaultStatsEnabled = <span class="hl-string">"false"</span>, <a name="CO17-9" href="#CO17-9"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
    countsEnabled = { <span class="hl-string">"foo"</span>, <span class="hl-string">"${count.patterns}"</span> }, <a name="CO17-10" href="#CO17-10"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
    statsEnabled = { <span class="hl-string">"qux"</span>, <span class="hl-string">"!*"</span> }, <a name="CO17-11" href="#CO17-11"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
    MetricsFactory = <span class="hl-string">"myMetricsFactory"</span>) <a name="CO17-12" href="#CO17-12"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>
<span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">class</span> ContextConfiguration {
...
}</pre>
</div>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO17-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> <a href="#CO17-7"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Set to <code class="literal">false</code> to disable all logging in the main message flow, regardless of the log system category settings.
Set to <span class="emphasis"><em>true</em></span> to enable debug logging (if also enabled by the logging subsystem).
Only applied if you have not explicitly configured the setting in a bean definition.
The default is <code class="literal">true</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO17-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> <a href="#CO17-8"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Enable or disable count metrics for components that do not match one of the patterns in &lt;4&gt;.
Only applied if you have not explicitly configured the setting in a bean definition.
The default is <code class="literal">false</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO17-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> <a href="#CO17-9"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Enable or disable statistical metrics for components that do not match one of the patterns in &lt;5&gt;.
Only applied if you have not explicitly configured the setting in a bean definition.
The default is <span class="emphasis"><em>false</em></span>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO17-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> <a href="#CO17-10"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A comma-delimited list of patterns for beans for which counts should be enabled.
You can negate the pattern with <code class="literal">!</code>.
First match (positive or negative) wins.
In the unlikely event that you have a bean name starting with <code class="literal">!</code>, escape the <code class="literal">!</code> in the pattern.
For example, <code class="literal">\!something</code> positively matches a bean named <code class="literal">!something</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO17-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> <a href="#CO17-11"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A comma-delimited list of patterns for beans for which statistical metrics should be enabled.
You can negate the pattern\ with <code class="literal">!</code>.
First match (positive or negative) wins.
In the unlikely event that you have a bean name starting with <code class="literal">!</code>, escape the <code class="literal">!</code> in the pattern.
<code class="literal">\!something</code> positively matches a bean named <code class="literal">!something</code>.
The collection of statistics implies the collection of counts.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO17-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> <a href="#CO17-12"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A reference to a <code class="literal">MetricsFactory</code>.
See <a class="xref" href="#mgmt-metrics-factory" title="12.1.6&nbsp;Metrics Factory">Section&nbsp;12.1.6, &#8220;Metrics Factory&#8221;</a>.</p>
</td></tr></table></div>
<p>At runtime, counts and statistics can be obtained by calling <code class="literal">getChannelMetrics</code>, <code class="literal">getHandlerMetrics</code> and <code class="literal">getSourceMetrics</code> (all from the <code class="literal">IntegrationManagementConfigurer</code> class), which return <code class="literal">MessageChannelMetrics</code>, <code class="literal">MessageHandlerMetrics</code>, and <code class="literal">MessageSourceMetrics</code>, respectively.</p>
<p>See the <a class="ulink" href="https://docs.spring.io/spring-integration/api/index.html" target="_top">Javadoc</a> for complete information about these classes.</p>
<p>When JMX is enabled (see <a class="xref" href="#jmx" title="12.2&nbsp;JMX Support">Section&nbsp;12.2, &#8220;JMX Support&#8221;</a>), <code class="literal">IntegrationMBeanExporter</code> also exposes these metrics.</p>
<p>IMPORTANT:
<code class="literal">defaultLoggingEnabled</code>, <code class="literal">defaultCountsEnabled</code>, and <code class="literal">defaultStatsEnabled</code> are applied only if you have not explicitly configured the corresponding setting in a bean definition.</p>
<p>Starting with version 5.0.2, the framework automatically detects whether the application context has a single <code class="literal">MetricsFactory</code> bean and, if so, uses it instead of the default metrics factory.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="micrometer-integration" href="#micrometer-integration"></a>12.1.2&nbsp;Micrometer Integration</h3></div></div></div>

<p>Starting with version 5.0.3, the presence of a <a class="ulink" href="https://micrometer.io/" target="_top">Micrometer</a> <code class="literal">MeterRegistry</code> in the application context triggers support for Micrometer metrics in addition to the built-in metrics (note that built-in metrics will be removed in a future release).</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Micrometer was first supported in version 5.0.2, but changes were made to the Micrometer <code class="literal">Meters</code> in version 5.0.3 to make them more suitable for use in dimensional systems.
Further changes were made in 5.0.4.
If you use Micrometer, a minimum of version 5.0.4 is recommended, since some of the changes in 5.0.4 were breaking API changes.</p>
</td></tr></table></div>
<p>To use Micrometer, add one of the <code class="literal">MeterRegistry</code> beans to the application context.
If the <code class="literal">IntegrationManagementConfigurer</code> detects exactly one <code class="literal">MeterRegistry</code> bean, it configures a <code class="literal">MicrometerMetricsCaptor</code> bean with a name of <code class="literal">integrationMicrometerMetricsCaptor</code>.</p>
<p>For each <code class="literal">MessageHandler</code> and <code class="literal">MessageChannel</code>, timers are registered.
For each <code class="literal">MessageSource</code>, a counter is registered.</p>
<p>This only applies to objects that extend <code class="literal">AbstractMessageHandler</code>, <code class="literal">AbstractMessageChannel</code>, and <code class="literal">AbstractMessageSource</code> (which is the case for most framework components).</p>
<p>With Micrometer metrics, the <code class="literal">statsEnabled</code> flag has no effect, since statistics capture is delegated to Micrometer.
The <code class="literal">countsEnabled</code> flag controls whether the Micrometer <code class="literal">Meter</code> instances are updated when processing each message.</p>
<p>The <code class="literal">Timer</code> Meters for send operations on message channels have the following names or tags:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">name</code>: <code class="literal">spring.integration.send</code>
</li><li class="listitem">
<code class="literal">tag</code>: <code class="literal">type:channel</code>
</li><li class="listitem">
<code class="literal">tag</code>: <code class="literal">name:&lt;componentName&gt;</code>
</li><li class="listitem">
<code class="literal">tag</code>: <code class="literal">result:(success|failure)</code>
</li><li class="listitem">
<code class="literal">tag</code>: <code class="literal">exception:(none|exception simple class name)</code>
</li><li class="listitem">
<code class="literal">description</code>: <code class="literal">Send processing time</code>
</li></ul></div>
<p>(A <code class="literal">failure</code> result with a <code class="literal">none</code> exception means the channel&#8217;s <code class="literal">send()</code> operation returned <code class="literal">false</code>.)</p>
<p>The <code class="literal">Counter</code> Meters for receive operations on pollable message channels have the following names or tags:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">name</code>: <code class="literal">spring.integration.receive</code>
</li><li class="listitem">
<code class="literal">tag</code>: <code class="literal">type:channel</code>
</li><li class="listitem">
<code class="literal">tag</code>: <code class="literal">name:&lt;componentName&gt;</code>
</li><li class="listitem">
<code class="literal">tag</code>: <code class="literal">result:(success|failure)</code>
</li><li class="listitem">
<code class="literal">tag</code>: <code class="literal">exception:(none|exception simple class name)</code>
</li><li class="listitem">
<code class="literal">description</code>: <code class="literal">Messages received</code>
</li></ul></div>
<p>The <code class="literal">Timer</code> Meters for operations on message handlers have the following names or tags:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">name</code>: <code class="literal">spring.integration.send</code>
</li><li class="listitem">
<code class="literal">tag</code>: <code class="literal">type:handler</code>
</li><li class="listitem">
<code class="literal">tag</code>: <code class="literal">name:&lt;componentName&gt;</code>
</li><li class="listitem">
<code class="literal">tag</code>: <code class="literal">result:(success|failure)</code>
</li><li class="listitem">
<code class="literal">tag</code>: <code class="literal">exception:(none|exception simple class name)</code>
</li><li class="listitem">
<code class="literal">description</code>: <code class="literal">Send processing time</code>
</li></ul></div>
<p>The <code class="literal">Counter</code> meters for message sources have the following names/tags:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">name</code>: <code class="literal">spring.integration.receive</code>
</li><li class="listitem">
<code class="literal">tag</code>: <code class="literal">type:source</code>
</li><li class="listitem">
<code class="literal">tag</code>: <code class="literal">name:&lt;componentName&gt;</code>
</li><li class="listitem">
<code class="literal">tag</code>: <code class="literal">result:success</code>
</li><li class="listitem">
<code class="literal">tag</code>: <code class="literal">exception:none</code>
</li><li class="listitem">
<code class="literal">description</code>: <code class="literal">Messages received</code>
</li></ul></div>
<p>In addition, there are three <code class="literal">Gauge</code> Meters:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">spring.integration.channels</code>: The number of <code class="literal">MessageChannels</code> in the application.
</li><li class="listitem">
<code class="literal">spring.integration.handlers</code>: The number of <code class="literal">MessageHandlers</code> in the application.
</li><li class="listitem">
<code class="literal">spring.integration.sources</code>: The number of <code class="literal">MessageSources</code> in the application.
</li></ul></div>
<p>It is possible to customize the names and tags of <code class="literal">Meters</code> created by integration components by providing a subclass of <code class="literal">MicrometerMetricsCaptor</code>.
The <a class="ulink" href="https://github.com/spring-projects/spring-integration/blob/master/spring-integration-core/src/test/java/org/springframework/integration/support/management/micrometer/MicrometerCustomMetricsTests.java" target="_top">MicrometerCustomMetricsTests</a> test case shows a simple example of how to do that.
You can also further customize the meters by overloading the <code class="literal">build()</code> methods on builder subclasses.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="mgmt-channel-features" href="#mgmt-channel-features"></a>12.1.3&nbsp;<code class="literal">MessageChannel</code> Metric Features</h3></div></div></div>

<p>These legacy metrics will be removed in a future release.
See <a class="xref" href="#micrometer-integration" title="12.1.2&nbsp;Micrometer Integration">Section&nbsp;12.1.2, &#8220;Micrometer Integration&#8221;</a>.</p>
<p>Message channels report metrics according to their concrete type.
If you are looking at a <code class="literal">DirectChannel</code>, you see statistics for the send operation.
If it is a <code class="literal">QueueChannel</code>, you also see statistics for the receive operation as well as the count of messages that are currently buffered by this <code class="literal">QueueChannel</code>.
In both cases, some metrics are simple counters (message count and error count), and some are estimates of averages of interesting quantities.
The algorithms used to calculate these estimates are described briefly in the following table.</p>
<div class="table"><a name="d5e9573" href="#d5e9573"></a><p class="title"><b>Table&nbsp;12.1.&nbsp;MessageChannel Metrics</b></p><div class="table-contents">

<table summary="MessageChannel Metrics" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Metric Type</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Example</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Algorithm</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Count</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Send Count</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Simple incrementer.
Increases by one when an event occurs.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Error Count</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Send Error Count</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Simple incrementer.
Increases by one when an send results in an error.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Duration</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Send Duration (method execution time in milliseconds)</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Exponential moving average with decay factor (ten by default).
Average of the method execution time over roughly the last ten (by default) measurements.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Rate</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Send Rate (number of operations per second)</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Inverse of Exponential moving average of the interval between events with decay in time (lapsing over 60 seconds by default) and per measurement (last ten events by default).</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Error Rate</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Send Error Rate (number of errors per second)</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Inverse of exponential moving average of the interval between error events with decay in time (lapsing over 60 seconds by default) and per measurement (last ten events by default).</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>Ratio</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>Send Success Ratio (ratio of successful to total sends)</p></td><td style="" align="left" valign="top"><p>Estimate the success ratio as the exponential moving average of the series composed of values (1 for success and 0 for failure, decaying as per the rate measurement over time and events by default).
The error ratio is: 1 - success ratio.</p></td></tr></tbody></table>
</div></div><br class="table-break">
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="mgmt-handler-features" href="#mgmt-handler-features"></a>12.1.4&nbsp;MessageHandler Metric Features</h3></div></div></div>

<p>These legacy metrics will be removed in a future release. See <a class="xref" href="#micrometer-integration" title="12.1.2&nbsp;Micrometer Integration">Section&nbsp;12.1.2, &#8220;Micrometer Integration&#8221;</a>.</p>
<p>The following table shows the statistics maintained for message handlers.
Some metrics are simple counters (message count and error count), and one is an estimate of averages of send duration.
The algorithms used to calculate these estimates are described briefly in the following table:</p>
<div class="table"><a name="d5e9632" href="#d5e9632"></a><p class="title"><b>Table&nbsp;12.2.&nbsp;MessageHandlerMetrics</b></p><div class="table-contents">

<table summary="MessageHandlerMetrics" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Metric Type</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Example</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Algorithm</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Count</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Handle Count</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Simple incrementer.
Increases by one when an event occurs.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Error Count</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Handler Error Count</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Simple incrementer.
Increases by one when an invocation results in an error.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Active Count</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Handler Active Count</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Indicates the number of currently active threads currently invoking the handler (or any downstream synchronous flow).</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>Duration</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>Handle Duration (method execution time in milliseconds)</p></td><td style="" align="left" valign="top"><p>Exponential moving average with decay factor (ten by default).
Average of the method execution time over roughly the last ten (default) measurements.</p></td></tr></tbody></table>
</div></div><br class="table-break">
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="mgmt-statistics" href="#mgmt-statistics"></a>12.1.5&nbsp;Time-Based Average Estimates</h3></div></div></div>

<p>A feature of the time-based average estimates is that they decay with time if no new measurements arrive.
To help interpret the behavior over time, the time (in seconds) since the last measurement is also exposed as a metric.</p>
<p>There are two basic exponential models: decay per measurement (appropriate for duration and anything where the number of measurements is part of the metric) and decay per time unit (more suitable for rate measurements where the time in between measurements is part of the metric).
Both models depend on the fact that <code class="literal">S(n) = sum(i=0,i=n) w(i) x(i)</code> has a special form when <code class="literal">w(i) = r^i</code>, with <code class="literal">r=constant</code>: <code class="literal">S(n) = x(n) + r S(n-1)</code> (so you only have to store <code class="literal">S(n-1)</code> (not the whole series <code class="literal">x(i)</code>) to generate a new metric estimate from the last measurement).
The algorithms used in the duration metrics use <code class="literal">r=exp(-1/M)</code> with <code class="literal">M=10</code>.
The net effect is that the estimate, <code class="literal">S(n)</code>, is more heavily weighted to recent measurements and is composed roughly of the last <code class="literal">M</code> measurements.
So <code class="literal">M</code> is the "<code class="literal">window</code>" or lapse rate of the estimate.
For the vanilla moving average, <code class="literal">i</code> is a counter over the number of measurements.
For the rate, we interpret <code class="literal">i</code> as the elapsed time or a combination of elapsed time and a counter (so the metric estimate contains contributions roughly from the last <code class="literal">M</code> measurements and the last <code class="literal">T</code> seconds).</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="mgmt-metrics-factory" href="#mgmt-metrics-factory"></a>12.1.6&nbsp;Metrics Factory</h3></div></div></div>

<p>A strategy interface <code class="literal">MetricsFactory</code> has been introduced to let you provide custom channel metrics for your <code class="literal">MessageChannel</code> instances and <code class="literal">MessageHandler</code> instances.
By default, a <code class="literal">DefaultMetricsFactory</code> provides a default implementation of <code class="literal">MessageChannelMetrics</code> and <code class="literal">MessageHandlerMetrics</code>, <a class="link" href="#configuring-metrics-capture" title="12.1.1&nbsp;Configuring Metrics Capture">described earlier</a>.
To override the default <code class="literal">MetricsFactory</code>, configure it as <a class="link" href="#configuring-metrics-capture" title="12.1.1&nbsp;Configuring Metrics Capture">described earlier</a>, by providing a reference to your <code class="literal">MetricsFactory</code> bean instance.
You can either customize the default implementations, as described in the next section, or provide completely different
implementations by extending <code class="literal">AbstractMessageChannelMetrics</code> or <code class="literal">AbstractMessageHandlerMetrics</code>.</p>
<p>See also <a class="xref" href="#micrometer-integration" title="12.1.2&nbsp;Micrometer Integration">Section&nbsp;12.1.2, &#8220;Micrometer Integration&#8221;</a>.</p>
<p>In addition to the default metrics factory <a class="link" href="#configuring-metrics-capture" title="12.1.1&nbsp;Configuring Metrics Capture">described earlier</a>, the framework provides the <code class="literal">AggregatingMetricsFactory</code>.
This factory creates <code class="literal">AggregatingMessageChannelMetrics</code> and <code class="literal">AggregatingMessageHandlerMetrics</code> instances.
In very high volume scenarios, the cost of capturing statistics can be prohibitive (the time to make two calls to the system and
store the data for each message).
The aggregating metrics aggregate the response time over a sample of messages.
This can save significant CPU time.</p>
<div class="caution" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Caution"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Caution]" src="images/caution.png"></td><th align="left">Caution</th></tr><tr><td align="left" valign="top">
<p>The statistics are likely to be skewed if messages arrive in bursts.
These metrics are intended for use with high, constant-volume, message rates.</p>
</td></tr></table></div>
<p>The following example shows how to define an aggregrating metrics factory:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"aggregatingMetricsFactory"</span>
            <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.support.management.AggregatingMetricsFactory"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"1000"</span><span class="hl-tag"> /&gt;</span> <span class="hl-comment">&lt;!-- sample size --&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
</div>
<p>The preceding configuration aggregates the duration over 1000 messages.
Counts (send and error) are maintained per-message, but the statistics are per 1000 messages.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_customizing_the_default_channel_and_handler_statistics" href="#_customizing_the_default_channel_and_handler_statistics"></a>Customizing the Default Channel and Handler Statistics</h4></div></div></div>

<p>See <a class="xref" href="#mgmt-statistics" title="12.1.5&nbsp;Time-Based Average Estimates">Section&nbsp;12.1.5, &#8220;Time-Based Average Estimates&#8221;</a> and the <a class="ulink" href="https://docs.spring.io/spring-integration/api/index.html" target="_top">Javadoc</a> for the <code class="literal">ExponentialMovingAverage*</code> classes for more information about these values.</p>
<p>By default, the <code class="literal">DefaultMessageChannelMetrics</code> and <code class="literal">DefaultMessageHandlerMetrics</code> use a "<code class="literal">window</code>" of ten measurements,
a rate period of one second (meaning rate per second) and a decay lapse period of one minute.</p>
<p>If you wish to override these defaults, you can provide a custom <code class="literal">MetricsFactory</code> that returns appropriately configured
metrics and provide a reference to it in the MBean exporter, as <a class="link" href="#mgmt-metrics-factory" title="12.1.6&nbsp;Metrics Factory">described earlier</a>.</p>
<p>The following example shows how to do so:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">class</span> CustomMetrics <span class="hl-keyword">implements</span> MetricsFactory {

    <em><span class="hl-annotation" style="color: gray">@Override</span></em>
    <span class="hl-keyword">public</span> AbstractMessageChannelMetrics createChannelMetrics(String name) {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> DefaultMessageChannelMetrics(name,
                <span class="hl-keyword">new</span> ExponentialMovingAverage(<span class="hl-number">20</span>, <span class="hl-number">1000000.</span>),
                <span class="hl-keyword">new</span> ExponentialMovingAverageRate(<span class="hl-number">2000</span>, <span class="hl-number">120000</span>, <span class="hl-number">30</span>, true),
                <span class="hl-keyword">new</span> ExponentialMovingAverageRatio(<span class="hl-number">130000</span>, <span class="hl-number">40</span>, true),
                <span class="hl-keyword">new</span> ExponentialMovingAverageRate(<span class="hl-number">3000</span>, <span class="hl-number">140000</span>, <span class="hl-number">50</span>, true));
    }

    <em><span class="hl-annotation" style="color: gray">@Override</span></em>
    <span class="hl-keyword">public</span> AbstractMessageHandlerMetrics createHandlerMetrics(String name) {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> DefaultMessageHandlerMetrics(name, <span class="hl-keyword">new</span> ExponentialMovingAverage(<span class="hl-number">20</span>, <span class="hl-number">1000000.</span>));
    }

}</pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_advanced_customization" href="#_advanced_customization"></a>Advanced Customization</h4></div></div></div>

<p>The customizations described earlier are wholesale and apply to all appropriate beans exported by the MBean exporter.
This is the extent of customization available when you use XML configuration.</p>
<p>Individual beans can be provided with different implementations using by Java <code class="literal">@Configuration</code> or programmatically at
runtime (after the application context has been refreshed) by invoking the <code class="literal">configureMetrics</code> methods on
<code class="literal">AbstractMessageChannel</code> and <code class="literal">AbstractMessageHandler</code>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_performance_improvement" href="#_performance_improvement"></a>Performance Improvement</h4></div></div></div>

<p>Previously, the time-based metrics (see <a class="xref" href="#mgmt-statistics" title="12.1.5&nbsp;Time-Based Average Estimates">Section&nbsp;12.1.5, &#8220;Time-Based Average Estimates&#8221;</a>) were calculated in real time.
The statistics are now calculated when retrieved instead.
This resulted in a significant performance improvement, at the expense of a small amount of additional memory for each statistic.
As <a class="link" href="#configuring-metrics-capture" title="12.1.1&nbsp;Configuring Metrics Capture">discussed earlier</a>, you can disable the statistics altogether while retaining the MBean that allows the invocation of <code class="literal">Lifecycle</code> methods.</p>
</div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jmx" href="#jmx"></a>12.2&nbsp;JMX Support</h2></div></div></div>

<p>Spring Integration provides channel Adapters for receiving and publishing JMX Notifications.</p>
<p>You need to include this dependency into your project:</p>
<div class="informalexample">
<p>
<b>Maven.&nbsp;</b>

</p><pre class="programlisting"><span class="hl-tag">&lt;dependency&gt;</span>
    <span class="hl-tag">&lt;groupId&gt;</span>org.springframework.integration<span class="hl-tag">&lt;/groupId&gt;</span>
    <span class="hl-tag">&lt;artifactId&gt;</span>spring-integration-jmx<span class="hl-tag">&lt;/artifactId&gt;</span>
    <span class="hl-tag">&lt;version&gt;</span>5.1.2.RELEASE<span class="hl-tag">&lt;/version&gt;</span>
<span class="hl-tag">&lt;/dependency&gt;</span></pre><p>

</p>
<p>
<b>Gradle.&nbsp;</b>

</p><pre class="programlisting">compile <span class="hl-string">"org.springframework.integration:spring-integration-jmx:5.1.2.RELEASE"</span></pre><p>

</p>
</div>
<p>An inbound channel adapter allows for polling JMX MBean attribute values, and an outbound channel adapter allows for invoking JMX MBean operations.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jmx-notification-listening-channel-adapter" href="#jmx-notification-listening-channel-adapter"></a>12.2.1&nbsp;Notification-listening Channel Adapter</h3></div></div></div>

<p>The notification-listening channel adapter requires a JMX <code class="literal">ObjectName</code> for the MBean that publishes notifications to which this listener should be registered.
A very simple configuration might resemble the following:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-jmx:notification-listening-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"adapter"</span>
    <span class="hl-attribute">channel</span>=<span class="hl-value">"channel"</span>
    <span class="hl-attribute">object-name</span>=<span class="hl-value">"example.domain:name=publisher"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>The <code class="literal">notification-listening-channel-adapter</code> registers with an <code class="literal">MBeanServer</code> at startup, and the default bean name is <code class="literal">mbeanServer</code>, which happens to be the same bean name generated when using Spring&#8217;s <code class="literal">&lt;context:mbean-server/&gt;</code> element.
If you need to use a different name, be sure to include the <code class="literal">mbean-server</code> attribute.</p>
</td></tr></table></div>
<p>The adapter can also accept a reference to a <code class="literal">NotificationFilter</code> and a "<code class="literal">handback</code>" object to provide some context that is passed back with each notification.
Both of those attributes are optional.
Extending the preceding example to include those attributes as well as an explicit <code class="literal">MBeanServer</code> bean name produces the following example:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-jmx:notification-listening-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"adapter"</span>
    <span class="hl-attribute">channel</span>=<span class="hl-value">"channel"</span>
    <span class="hl-attribute">mbean-server</span>=<span class="hl-value">"someServer"</span>
    <span class="hl-attribute">object-name</span>=<span class="hl-value">"example.domain:name=somePublisher"</span>
    <span class="hl-attribute">notification-filter</span>=<span class="hl-value">"notificationFilter"</span>
    <span class="hl-attribute">handback</span>=<span class="hl-value">"myHandback"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>The _Notification-listening channel adapter is event-driven and registered with the <code class="literal">MBeanServer</code> directly.
It does not require any poller configuration.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>For this component only, the <code class="literal">object-name</code> attribute can contain an object name pattern (for example,
"org.something:type=MyType,name=*").
In that case, the adapter receives notifications from all MBeans with object names that match the pattern.
In addition, the <code class="literal">object-name</code> attribute can contain a SpEL reference to a <code class="literal">&lt;util:list&gt;</code> of object name patterns, as the following example shows:</p>
<pre class="programlisting"><span class="hl-tag">&lt;jmx:notification-listening-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"manyNotificationsAdapter"</span>
    <span class="hl-attribute">channel</span>=<span class="hl-value">"manyNotificationsChannel"</span>
    <span class="hl-attribute">object-name</span>=<span class="hl-value">"#{patterns}"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;util:list</span> <span class="hl-attribute">id</span>=<span class="hl-value">"patterns"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;value&gt;</span>org.foo:type=Foo,name=*<span class="hl-tag">&lt;/value&gt;</span>
    <span class="hl-tag">&lt;value&gt;</span>org.foo:type=Bar,name=*<span class="hl-tag">&lt;/value&gt;</span>
<span class="hl-tag">&lt;/util:list&gt;</span></pre>
<p>The names of the located MBean(s) are logged when DEBUG level logging is enabled.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jmx-notification-publishing-channel-adapter" href="#jmx-notification-publishing-channel-adapter"></a>12.2.2&nbsp;Notification-publishing Channel Adapter</h3></div></div></div>

<p>The notification-publishing channel adapter is relatively simple.
It requires only a JMX object name in its configuration, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;context:mbean-export/&gt;</span>

<span class="hl-tag">&lt;int-jmx:notification-publishing-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"adapter"</span>
    <span class="hl-attribute">channel</span>=<span class="hl-value">"channel"</span>
    <span class="hl-attribute">object-name</span>=<span class="hl-value">"example.domain:name=publisher"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>It also requires that an <code class="literal">MBeanExporter</code> be present in the context.
That is why the <code class="literal">&lt;context:mbean-export/&gt;</code> element is also shown in the preceding example.</p>
<p>When messages are sent to the channel for this adapter, the notification is created from the message content.
If the payload is a <code class="literal">String</code>, it is passed as the <code class="literal">message</code> text for the notification.
Any other payload type is passed as the <code class="literal">userData</code> of the notification.</p>
<p>JMX notifications also have a <code class="literal">type</code>, and it should be a dot-delimited <code class="literal">String</code>.
There are two ways to provide the <code class="literal">type</code>.
Precedence is always given to a message header value associated with the <code class="literal">JmxHeaders.NOTIFICATION_TYPE</code> key.
Alternatively, you can provide a fallback <code class="literal">default-notification-type</code> attribute in the configuration, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;context:mbean-export/&gt;</span>

<span class="hl-tag">&lt;int-jmx:notification-publishing-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"adapter"</span>
    <span class="hl-attribute">channel</span>=<span class="hl-value">"channel"</span>
    <span class="hl-attribute">object-name</span>=<span class="hl-value">"example.domain:name=publisher"</span>
    <span class="hl-attribute">default-notification-type</span>=<span class="hl-value">"some.default.type"</span><span class="hl-tag">/&gt;</span></pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jmx-attribute-polling-channel-adapter" href="#jmx-attribute-polling-channel-adapter"></a>12.2.3&nbsp;Attribute-polling Channel Adapter</h3></div></div></div>

<p>The attribute-polling channel adapter is useful when you need to periodically check on some value that is available through an MBean as a managed attribute.
You can configured the poller in the same way as any other polling adapter in Spring Integration (or you can rely on the default poller).
The <code class="literal">object-name</code> and the <code class="literal">attribute-name</code> are required.
An MBeanServer reference is also required.
However, by default, it automatically checks for a bean named <code class="literal">mbeanServer</code>, same as the notification-listening channel adapter <a class="link" href="#jmx-notification-listening-channel-adapter" title="12.2.1&nbsp;Notification-listening Channel Adapter">described earlier</a>.
The following example shows how to configure an attribute-polling channel adapter with XML:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-jmx:attribute-polling-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"adapter"</span>
    <span class="hl-attribute">channel</span>=<span class="hl-value">"channel"</span>
    <span class="hl-attribute">object-name</span>=<span class="hl-value">"example.domain:name=someService"</span>
    <span class="hl-attribute">attribute-name</span>=<span class="hl-value">"InvocationCount"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">max-messages-per-poll</span>=<span class="hl-value">"1"</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"5000"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-jmx:attribute-polling-channel-adapter&gt;</span></pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="tree-polling-channel-adapter" href="#tree-polling-channel-adapter"></a>12.2.4&nbsp;Tree-polling Channel Adapter</h3></div></div></div>

<p>The tree-polling channel adapter queries the JMX MBean tree and sends a message with a payload that is the graph of objects that matches the query.
By default, the MBeans are mapped to primitives and simple objects, such as <code class="literal">Map</code>, <code class="literal">List</code>, and arrays. Doing so permits simple transformation to (for example) JSON.
An MBeanServer reference is also required.
However, by default, it automatically checks for a bean named <code class="literal">mbeanServer</code>, same as the notification-listening channel adapter <a class="link" href="#jmx-notification-listening-channel-adapter" title="12.2.1&nbsp;Notification-listening Channel Adapter">described earlier</a>.
The following example shows how to configure an tree-polling channel adapter with XML:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-jmx:tree-polling-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"adapter"</span>
    <span class="hl-attribute">channel</span>=<span class="hl-value">"channel"</span>
    <span class="hl-attribute">query-name</span>=<span class="hl-value">"example.domain:type=*"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">max-messages-per-poll</span>=<span class="hl-value">"1"</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"5000"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-jmx:tree-polling-channel-adapter&gt;</span></pre>
</div>
<p>The preceding example includes all of the attributes on the selected MBeans.
You can filter the attributes by providing an <code class="literal">MBeanObjectConverter</code> that has an appropriate filter configured.
You can provide the converter as a reference to a bean definition by using the <code class="literal">converter</code> attribute, or you can use an inner <code class="literal">&lt;bean/&gt;</code> definition.
Spring Integration provides a <code class="literal">DefaultMBeanObjectConverter</code> that can take a <code class="literal">MBeanAttributeFilter</code> in its constructor argument.</p>
<p>Spring Integration provides two standard filters.
The <code class="literal">NamedFieldsMBeanAttributeFilter</code> lets you specify a list of attributes to include.
The <code class="literal">NotNamedFieldsMBeanAttributeFilter</code> lets you specify a list of attributes to exclude.
You can also implement your own filter.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jmx-operation-invoking-channel-adapter" href="#jmx-operation-invoking-channel-adapter"></a>12.2.5&nbsp;Operation-invoking Channel Adapter</h3></div></div></div>

<p>The operation-invoking channel adapter enables message-driven invocation of any managed operation exposed by an MBean.
Each invocation requires the operation name to be invoked and the object name of the target MBean.
Both of these must be explicitly provided by adapter configuration, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-jmx:operation-invoking-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"adapter"</span>
    <span class="hl-attribute">object-name</span>=<span class="hl-value">"example.domain:name=TestBean"</span>
    <span class="hl-attribute">operation-name</span>=<span class="hl-value">"ping"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>Then the adapter only needs to be able to discover the <code class="literal">mbeanServer</code> bean.
If a different bean name is required, then provide the <code class="literal">mbean-server</code> attribute with a reference.</p>
<p>The payload of the message is mapped to the parameters of the operation, if any.
A <code class="literal">Map</code>-typed payload with <code class="literal">String</code> keys is treated as name/value pairs, whereas a <code class="literal">List</code> or array is passed as a simple argument list (with no explicit parameter names).
If the operation requires a single parameter value, the payload can represent that single value.
Also, if the operation requires no parameters, the payload would be ignored.</p>
<p>If you want to expose a channel for a single common operation to be invoked by messages that need not contain headers, that last option works well.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jmx-operation-invoking-outbound-gateway" href="#jmx-operation-invoking-outbound-gateway"></a>12.2.6&nbsp;Operation-invoking Outbound Gateway</h3></div></div></div>

<p>Similarly to the operation-invoking channel adapter, Spring Integration also provides an operation-invoking outbound gateway, which you can use when dealing with non-void operations when a return value is required.
The return value is sent as the message payload to the <code class="literal">reply-channel</code> specified by the gateway.
The following example shows how to configure an operation-invoking outbound gateway with XML:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-jmx:operation-invoking-outbound-gateway</span> <span class="hl-attribute">request-channel</span>=<span class="hl-value">"requestChannel"</span>
   <span class="hl-attribute">reply-channel</span>=<span class="hl-value">"replyChannel"</span>
   <span class="hl-attribute">object-name</span>=<span class="hl-value">"o.s.i.jmx.config:type=TestBean,name=testBeanGateway"</span>
   <span class="hl-attribute">operation-name</span>=<span class="hl-value">"testWithReturn"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>If you do not provide the <code class="literal">reply-channel</code> attribute, the reply message is sent to the channel identified by the <code class="literal">IntegrationMessageHeaderAccessor.REPLY_CHANNEL</code> header.
That header is typically auto-created by the entry point into a message flow, such as any gateway component.
However, if the message flow was started by manually creating a Spring Integration message and sending it directly to a channel, you must specify the message header explicitly or use the <code class="literal">reply-channel</code> attribute.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jmx-mbean-exporter" href="#jmx-mbean-exporter"></a>12.2.7&nbsp;MBean Exporter</h3></div></div></div>

<p>Spring Integration components may  themselvesbe exposed as MBeans when the <code class="literal">IntegrationMBeanExporter</code> is configured.
To create an instance of the <code class="literal">IntegrationMBeanExporter</code>, define a bean and provide a reference to an <code class="literal">MBeanServer</code> and a domain name (if desired).
You can leave out the domain, in which case the default domain is <code class="literal">org.springframework.integration</code>.
The following example shows how to declare an instance of an <code class="literal">IntegrationMBeanExporter</code> and an associated <code class="literal">MBeanServer</code> instance:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-jmx:mbean-export</span> <span class="hl-attribute">id</span>=<span class="hl-value">"integrationMBeanExporter"</span>
            <span class="hl-attribute">default-domain</span>=<span class="hl-value">"my.company.domain"</span> <span class="hl-attribute">server</span>=<span class="hl-value">"mbeanServer"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"mbeanServer"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jmx.support.MBeanServerFactoryBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"locateExistingServerIfPossible"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
</div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>The MBean exporter is orthogonal to the one provided in Spring core.
It registers message channels and message handlers but does not register itself.
You can expose the exporter itself (and certain other components in Spring Integration) by using the standard <code class="literal">&lt;context:mbean-export/&gt;</code> tag.
The exporter has some metrics attached to it&#8201;&#8212;&#8201;for instance, a count of the number of active handlers and the number of queued messages.</p>
<p>It also has a useful operation, as discussed in <a class="xref" href="#jmx-mbean-shutdown" title="Orderly Shutdown Managed Operation">the section called &#8220;Orderly Shutdown Managed Operation&#8221;</a>.</p>
</td></tr></table></div>
<p>Spring Integration 4.0 introduced the <code class="literal">@EnableIntegrationMBeanExport</code> annotation to allow for convenient configuration of a default <code class="literal">integrationMbeanExporter</code> bean of type <code class="literal">IntegrationMBeanExporter</code> with several useful options at the <code class="literal">@Configuration</code> class level.
The following example shows how to configure this bean:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Configuration</span></em>
<em><span class="hl-annotation" style="color: gray">@EnableIntegration</span></em>
<em><span class="hl-annotation" style="color: gray">@EnableIntegrationMBeanExport(server = "mbeanServer", managedComponents = "input")</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ContextConfiguration {

	<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
	<span class="hl-keyword">public</span> MBeanServerFactoryBean mbeanServer() {
		<span class="hl-keyword">return</span> <span class="hl-keyword">new</span> MBeanServerFactoryBean();
	}
}</pre>
</div>
<p>If you need to provide more options or have several <code class="literal">IntegrationMBeanExporter</code> beans (such as
for different MBean Servers or to avoid conflicts with the standard Spring <code class="literal">MBeanExporter</code>&#8201;&#8212;&#8201;such as through
<code class="literal">@EnableMBeanExport</code>), you can configure an <code class="literal">IntegrationMBeanExporter</code> as a generic bean.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="jmx-mbean-features" href="#jmx-mbean-features"></a>MBean Object Names</h4></div></div></div>

<p>All the <code class="literal">MessageChannel</code>, <code class="literal">MessageHandler</code>, and <code class="literal">MessageSource</code> instances in the application are wrapped by the MBean exporter to provide management and monitoring features.
The generated JMX object names for each component type are listed in the following table:</p>
<div class="table"><a name="d5e9896" href="#d5e9896"></a><p class="title"><b>Table&nbsp;12.3.&nbsp;MBean Object Names</b></p><div class="table-contents">

<table summary="MBean Object Names" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Component Type</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Object Name</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>MessageChannel</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><pre class="literallayout"> `o.s.i:type=MessageChannel,name=&lt;channelName&gt;`</pre></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>MessageSource</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><pre class="literallayout"> `o.s.i:type=MessageSource,name=&lt;channelName&gt;,bean=&lt;source&gt;`</pre></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>MessageHandler</p></td><td style="" align="left" valign="top"><pre class="literallayout"> `o.s.i:type=MessageSource,name=&lt;channelName&gt;,bean=&lt;source&gt;`</pre></td></tr></tbody></table>
</div></div><br class="table-break">
<p>The <code class="literal">bean</code> attribute in the object names for sources and handlers takes one of the values in the following table:</p>
<div class="table"><a name="d5e9923" href="#d5e9923"></a><p class="title"><b>Table&nbsp;12.4.&nbsp;bean ObjectName Part</b></p><div class="table-contents">

<table summary="bean ObjectName Part" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Bean Value</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Description</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>endpoint</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The bean name of the enclosing endpoint (for example <code class="literal">&lt;service-activator&gt;</code>), if there is one</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>anonymous</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>An indication that the enclosing endpoint did not have a user-specified bean name, so the JMX name is the input channel name.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>internal</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>For well known Spring Integration default components</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>handler/source</p></td><td style="" align="left" valign="top"><p>None of the above. Fall back to the <code class="literal">toString()</code> method of the object being monitored (handler or source)</p></td></tr></tbody></table>
</div></div><br class="table-break">
<p>You can append custom elements to the object name by providing a reference to a <code class="literal">Properties</code> object in the <code class="literal">object-name-static-properties</code> attribute.</p>
<p>Also, since Spring Integration 3.0, you can use a custom <a class="ulink" href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/jmx/export/naming/ObjectNamingStrategy.html" target="_top"><code class="literal">ObjectNamingStrategy</code></a> by setting the <code class="literal">object-naming-strategy</code> attribute.
Doing so permits greater control over the naming of the MBeans, such as grouping all integration MBeans under an <span class="emphasis"><em>Integration</em></span> type.
The following example shows one possible custom naming strategy implementation:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> Namer <span class="hl-keyword">implements</span> ObjectNamingStrategy {

	<span class="hl-keyword">private</span> <span class="hl-keyword">final</span> ObjectNamingStrategy realNamer = <span class="hl-keyword">new</span> KeyNamingStrategy();
	<em><span class="hl-annotation" style="color: gray">@Override</span></em>
	<span class="hl-keyword">public</span> ObjectName getObjectName(Object managedBean, String beanKey) <span class="hl-keyword">throws</span> MalformedObjectNameException {
		String actualBeanKey = beanKey.replace(<span class="hl-string">"type="</span>, <span class="hl-string">"type=Integration,componentType="</span>);
		<span class="hl-keyword">return</span> realNamer.getObjectName(managedBean, actualBeanKey);
	}

}</pre>
</div>
<p>The <code class="literal">beanKey</code> argument is a <code class="literal">String</code> that contain the standard object name, beginning with the <code class="literal">default-domain</code> and including any additional static properties.
The preceding example moves the standard <code class="literal">type</code> part to <code class="literal">componentType</code> and sets the <code class="literal">type</code> to <span class="emphasis"><em>Integration</em></span>, enabling selection of all Integration MBeans in one query:<code class="literal">"my.domain:type=Integration,*</code>.
Doing so also groups the beans under one tree entry under the domain in such tools as VisualVM.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The default naming strategy is a <a class="ulink" href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/jmx/export/naming/MetadataNamingStrategy.html" target="_top"><code class="literal">MetadataNamingStrategy</code></a>.
The exporter propagates the <code class="literal">default-domain</code> to that object to let it generate a fallback object name if parsing of the bean key fails.
If your custom naming strategy is a <code class="literal">MetadataNamingStrategy</code> (or a subclass of it), the exporter does not propagate the <code class="literal">default-domain</code>.
You must configure it on your strategy bean.</p>
</td></tr></table></div>
<p>Starting with version 5.1; any bean names (represented by the <code class="literal">name</code> key in the object name) will be quoted if they contain any characters that are not allowed in a Java identifier (or period <code class="literal">.</code>).</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="jmx-42-improvements" href="#jmx-42-improvements"></a>JMX Improvements</h4></div></div></div>

<p>Version 4.2 introduced some important improvements, representing a fairly major overhaul to the JMX support in the framework.
These resulted in a significant performance improvement of the JMX statistics collection and much more control thereof.
However, it has some implications for user code in a few specific (uncommon) situations.
These changes are detailed below, with a caution where necessary.</p>
<div class="variablelist"><dl class="variablelist"><dt><span class="term">Metrics Capture</span></dt><dd>
<p class="simpara">Previously, <code class="literal">MessageSource</code>, <code class="literal">MessageChannel</code>, and <code class="literal">MessageHandler</code> metrics were captured by wrapping the object in a JDK dynamic proxy to intercept appropriate method calls and capture the statistics.
The proxy was added when an integration MBean exporter was declared in the context.</p>
<p class="simpara">Now, the statistics are captured by the beans themselves.
See <a class="xref" href="#metrics-management" title="12.1&nbsp;Metrics and Management">Section&nbsp;12.1, &#8220;Metrics and Management&#8221;</a> for more information.</p>
<div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Warning"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Warning]" src="images/warning.png"></td><th align="left">Warning</th></tr><tr><td align="left" valign="top">
<p>This change means that you no longer automatically get an MBean or statistics for custom <code class="literal">MessageHandler</code> implementations, unless those custom handlers extend <code class="literal">AbstractMessageHandler</code>.
The simplest way to resolve this is to extend <code class="literal">AbstractMessageHandler</code>.
If you cannot do so, another work around is to implement the <code class="literal">MessageHandlerMetrics</code> interface.
For convenience, a <code class="literal">DefaultMessageHandlerMetrics</code> is provided to capture and report statistics.
You should invoke the <code class="literal">beforeHandle</code> and <code class="literal">afterHandle</code> at the appropriate times.
Your <code class="literal">MessageHandlerMetrics</code> methods can then delegate to this object to obtain each statistic.
Similarly, <code class="literal">MessageSource</code> implementations must extend <code class="literal">AbstractMessageSource</code> or implement <code class="literal">MessageSourceMetrics</code>.
Message sources capture only a count, so there is no provided convenience class.
You should maintain the count in an <code class="literal">AtomicLong</code> field.</p>
</td></tr></table></div>
<p class="simpara">The removal of the proxy has two additional benefits:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Stack traces in exceptions are reduced (when JMX is enabled) because the proxy is not on the stack
</li><li class="listitem">
Cases where two MBeans were exported for the same bean now only export a single MBean with consolidated attributes and operations (see the MBean consolidation bullet, later).
</li></ul></div>
</dd><dt><span class="term">Resolution</span></dt><dd>
<code class="literal">System.nanoTime()</code> (rather than <code class="literal">System.currentTimeMillis()</code>) is now used to capture times .
This may provide more accuracy on some JVMs, espcially when you expect durations of less than one millisecond.
</dd><dt><span class="term">Setting Initial Statistics Collection State</span></dt><dd>
<p class="simpara">Previously, when JMX was enabled, all sources, channels, and handlers captured statistics.
You can now control whether the statistics are enabled on an individual component.
Further, you can capture simple counts on <code class="literal">MessageChannel</code> instances and <code class="literal">MessageHandler</code> instances instead of capturing the complete time-based statistics.
This can have significant performance implications, because you can selectively configure where you need detailed statistics and enable and disable collection at runtime.</p>
<p class="simpara">See <a class="xref" href="#metrics-management" title="12.1&nbsp;Metrics and Management">Section&nbsp;12.1, &#8220;Metrics and Management&#8221;</a>.</p>
</dd><dt><span class="term">@IntegrationManagedResource</span></dt><dd>
<p class="simpara">Similar to the <code class="literal">@ManagedResource</code> annotation, the <code class="literal">@IntegrationManagedResource</code> marks a class as being eligible to be exported as an MBean.
However, it is exported only if the application context has an <code class="literal">IntegrationMBeanExporter</code>.</p>
<p class="simpara">Certain Spring Integration classes (in the <code class="literal">org.springframework.integration</code>) package) that were previously annotated with`@ManagedResource` are now annotated with both <code class="literal">@ManagedResource</code> and <code class="literal">@IntegrationManagedResource</code>.
This is for backwards compatibility (see the next item).
Such MBeans are exported by any context <code class="literal">MBeanServer</code> or by an <code class="literal">IntegrationMBeanExporter</code> (but not both&#8201;&#8212;&#8201;if both exporters are present, the bean is exported by the integration exporter if the bean matches a <code class="literal">managed-components</code> pattern).</p>
</dd><dt><span class="term">Consolidated MBeans</span></dt><dd>
<p class="simpara">Certain classes within the framework (mapping routers, for example) have additional attributes and operations over and above those provided by metrics and <code class="literal">Lifecycle</code>.
We use a <code class="literal">Router</code> as an example here.</p>
<p class="simpara">Previously, beans of these types were exported as two distinct MBeans:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
The metrics MBean (with an object name such as <code class="literal">intDomain:type=MessageHandler,name=myRouter,bean=endpoint</code>).
This MBean had metrics attributes and metrics/Lifecycle operations.
</li><li class="listitem">
<p class="simpara">A second MBean (with an object name such as <code class="literal">ctxDomain:name=org.springframework.integration.config.</code> <code class="literal">RouterFactoryBean#0</code>,type=MethodInvokingRouter`) was exported with the channel mappings attribute and operations.</p>
<p class="simpara">Now the attributes and operations are consolidated into a single MBean.
The object name depends on the exporter.
If exported by the integration MBean exporter, the object name is, for example: <code class="literal">intDomain:type=MessageHandler,name=myRouter,bean=endpoint</code>.
If exported by another exporter, the object name is, for example: <code class="literal">ctxDomain:name=org.springframework.integration.config.</code> <code class="literal">RouterFactoryBean#0,type=MethodInvokingRouter</code>.
There is no difference between these MBeans (aside from the object name), except that the statistics are not enabled (the attributes are <code class="literal">0</code>) by exporters other than the integration exporter.
You can enable statistics at runtime by using the JMX operations.
When exported by the integration MBean exporter, the initial state can be managed as described earlier.</p>
<div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Warning"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Warning]" src="images/warning.png"></td><th align="left">Warning</th></tr><tr><td align="left" valign="top">
<p>If you currently use the second MBean to change, for example, channel mappings and you use the integration MBean exporter, note that the object name has changed because of the MBean consolidation.
There is no change if you are not using the integration MBean exporter.</p>
</td></tr></table></div>
</li></ul></div>
</dd><dt><span class="term">MBean Exporter Bean Name Patterns</span></dt><dd>
<p class="simpara">Previously, the <code class="literal">managed-components</code> patterns were inclusive only.
If a bean name matched one of the patterns, it would be included.
Now, the pattern can be negated by prefixing it with <code class="literal">!</code>.
For example, <code class="literal">!thing*, things</code> matches all bean names that do not start with <code class="literal">thing</code> except <code class="literal">things</code>.
Patterns are evaluated left to right.
The first match (positive or negative) wins, and then no further patterns are applied.</p>
<div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Warning"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Warning]" src="images/warning.png"></td><th align="left">Warning</th></tr><tr><td align="left" valign="top">
<p>The addition of this syntax to the pattern causes one possible (although perhaps unlikely) problem.
If you have a bean named <code class="literal">"!thing"</code> and you included a pattern of <code class="literal">!thing</code> in your MBean exporter&#8217;s <code class="literal">managed-components</code> patterns, it no longer matches; the pattern now matches all beans not named <code class="literal">thing</code>.
In this case, you can escape the <code class="literal">!</code> in the pattern with <code class="literal">\</code>.
The <code class="literal">\!thing</code> pattern matches a bean named <code class="literal">!thing</code>.</p>
</td></tr></table></div>
</dd><dt><span class="term">IntegrationMBeanExporter changes</span></dt><dd>
The <code class="literal">IntegrationMBeanExporter</code> no longer implements <code class="literal">SmartLifecycle</code>.
This means that <code class="literal">start()</code> and <code class="literal">stop()</code> operations are no longer available to registerand unregister MBeans.
The MBeans are now registered during context initialization and unregistered when the context is destroyed.
</dd></dl></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="jmx-mbean-shutdown" href="#jmx-mbean-shutdown"></a>Orderly Shutdown Managed Operation</h4></div></div></div>

<p>The MBean exporter provides a JMX operation to shut down the application in an orderly manner, intended for use before terminating the JVM.
The following example shows how to use it:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">void</span> stopActiveComponents(<span class="hl-keyword">long</span> howLong)</pre>
</div>
<p>Its use and operation are described in <a class="xref" href="#jmx-shutdown" title="12.7&nbsp;Orderly Shutdown">Section&nbsp;12.7, &#8220;Orderly Shutdown&#8221;</a>.</p>
</div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="message-history" href="#message-history"></a>12.3&nbsp;Message History</h2></div></div></div>

<p>The key benefit of a messaging architecture is loose coupling such that participating components do not maintain any awareness about one another.
This fact alone makes an application extremely flexible, letting you change components without affecting the rest of the flow, change messaging routes, change message consuming styles (polling versus event driven), and so on.
However, this unassuming style of architecture could prove to be difficult when things go wrong.
When debugging, you probably want as much information (its origin, the channels it has traversed, and other details) about the message as you can get.</p>
<p>Message history is one of those patterns that helps by giving you an option to maintain some level of awareness of a message path either for debugging purposes or for maintaining an audit trail.
Spring integration provides a simple way to configure your message flows to maintain the message history by adding a header to the message and updating that header every time a message passes through a tracked component.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="message-history-config" href="#message-history-config"></a>12.3.1&nbsp;Message History Configuration</h3></div></div></div>

<p>To enable message history, you need only define the <code class="literal">message-history</code> element in your configuration, as shown in the following example:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:message-history/&gt;</span></pre>
</div>
<p>Now every named component (component that has an <span class="emphasis"><em>id</em></span> defined) is tracked.
The framework sets the <span class="emphasis"><em>history</em></span> header in your message.
Its value a <code class="literal">List&lt;Properties&gt;</code>.</p>
<p>Consider the following configuration example:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:gateway&nbsp;id="sampleGateway"&nbsp;</span>
    <span class="hl-attribute">service-interface</span>=<span class="hl-value">"org.springframework.integration.history.sample.SampleGateway"</span>
    <span class="hl-attribute">default-request-channel</span>=<span class="hl-value">"bridgeInChannel"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int:chain&nbsp;id="sampleChain"&nbsp;input-channel="chainChannel"&nbsp;output-channel="filterChannel"&gt;</span>
  <span class="hl-tag">&lt;int:header-enricher&gt;</span>
    <span class="hl-tag">&lt;int:header&nbsp;name="baz"&nbsp;value="baz"/&gt;</span>
  <span class="hl-tag">&lt;/int:header-enricher&gt;</span>
<span class="hl-tag">&lt;/int:chain&gt;</span></pre>
</div>
<p>The preceding configuration produces a simple message history structure, with output similar to the following:</p>
<pre class="programlisting">[{name=sampleGateway, type=gateway, timestamp=<span class="hl-number">1283281668091</span>},
 {name=sampleChain, type=chain, timestamp=<span class="hl-number">1283281668094</span>}]</pre>
<p>To get access to message history, you need only access the <code class="literal">MessageHistory</code> header.
The folloiwng example shows how to do so:</p>
<div class="informalexample">
<pre class="programlisting">Iterator&lt;Properties&gt; historyIterator =
    message.getHeaders().get(MessageHistory.HEADER_NAME, MessageHistory.<span class="hl-keyword">class</span>).iterator();
assertTrue(historyIterator.hasNext());
Properties gatewayHistory = historyIterator.next();
assertEquals(<span class="hl-string">"sampleGateway"</span>, gatewayHistory.get(<span class="hl-string">"name"</span>));
assertTrue(historyIterator.hasNext());
Properties chainHistory = historyIterator.next();
assertEquals(<span class="hl-string">"sampleChain"</span>, chainHistory.get(<span class="hl-string">"name"</span>));</pre>
</div>
<p>You might not want to track all of the components.
To limit the history to certain components based on their names, you can provide the <code class="literal">tracked-components</code> attribute and specify a comma-delimited list of component names and patterns that match the components you want to track.
The following example shows how to do so:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:message-history</span> <span class="hl-attribute">tracked-components</span>=<span class="hl-value">"*Gateway, sample*, aName"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>In the preceding example, message history is maintained only for the components that end with <span class="emphasis"><em>Gateway</em></span>, start with <span class="emphasis"><em>sample</em></span>, or match the name, <span class="emphasis"><em>aName</em></span>, exactly.</p>
<p>Starting with version 4.0, you can also use the <code class="literal">@EnableMessageHistory</code> annotation in a <code class="literal">@Configuration</code> class.
In addition, the <code class="literal">MessageHistoryConfigurer</code> bean is now exposed as a JMX MBean by the <code class="literal">IntegrationMBeanExporter</code> (see <a class="xref" href="#jmx-mbean-exporter" title="12.2.7&nbsp;MBean Exporter">Section&nbsp;12.2.7, &#8220;MBean Exporter&#8221;</a>), letting you change the patterns at runtime.
Note, however, that the bean must be stopped (turning off message history) in order to change the patterns.
This feature might be useful to temporarily turn on history to analyze a system.
The MBean&#8217;s object name is <code class="literal">&lt;domain&gt;:name=messageHistoryConfigurer,type=MessageHistoryConfigurer</code>.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>If multiple beans (declared by <code class="literal">@EnableMessageHistory</code> and <code class="literal">&lt;message-history/&gt;</code>) exist, they must all have identical component name patterns (when trimmed and sorted).
Do not use a generic <code class="literal">&lt;bean/&gt;</code> definition for the <code class="literal">MessageHistoryConfigurer</code>.</p>
</td></tr></table></div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>By definition, the message history header is immutable (you cannot re-write history).
Therefore, when writing message history values, the components either create new messages (when the component is an origin) or they copy the history from a request message, modifying it and setting the new list on a reply message.
In either case, the values can be appended even if the message itself is crossing thread boundaries.
That means that the history values can greatly simplify debugging in an asynchronous message flow.</p>
</td></tr></table></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="message-store" href="#message-store"></a>12.4&nbsp;Message Store</h2></div></div></div>

<p>The <a class="ulink" href="http://www.eaipatterns.com" target="_top"><span class="emphasis"><em>Enterprise Integration Patterns</em></span></a> (EIP) book identifies several patterns that have the ability to buffer messages.
For example, an aggregator buffers messages until they can be released, and a <code class="literal">QueueChannel</code> buffers messages until consumers explicitly receive those messages from that channel.
Because of the failures that can occur at any point within your message flow, EIP components that buffer messages also introduce a point where messages could be lost.</p>
<p>To mitigate the risk of losing messages, EIP defines the <a class="ulink" href="http://eaipatterns.com/MessageStore.html" target="_top">message store</a> pattern, which lets EIP components store messages, typically in some type of persistent store (such as an RDBMS).</p>
<p>Spring Integration provides support for the message store pattern by:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Defining an <code class="literal">org.springframework.integration.store.MessageStore</code> strategy interface
</li><li class="listitem">
Providing several implementations of this interface
</li><li class="listitem">
Exposing a <code class="literal">message-store</code> attribute on all components that have the capability to buffer messages so that you can inject any instance that implements the <code class="literal">MessageStore</code> interface.
</li></ul></div>
<p>Details on how to configure a specific message store implementation and how to inject a <code class="literal">MessageStore</code> implementation into a specific buffering component are described throughout the manual (see the specific component, such as <a class="link" href="#channel-configuration-queuechannel" title="QueueChannel Configuration">QueueChannel</a>, <a class="link" href="#aggregator" title="8.4&nbsp;Aggregator">Aggregator</a>, <a class="link" href="#delayer" title="10.6&nbsp;Delayer">Delayer</a>, and others).
The following pair of examples show how to add a reference to a message store for a <code class="literal">QueueChannel</code> and for an aggregator:</p>
<div class="example"><a name="d5e10172" href="#d5e10172"></a><p class="title"><b>Example&nbsp;12.1.&nbsp;QueueChannel</b></p><div class="example-contents">

<pre class="programlisting"><span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myQueueChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:queue</span> <span class="hl-attribute">message-store</span>=<span class="hl-value">"refToMessageStore"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;int:channel&gt;</span></pre>
</div></div><br class="example-break">
<div class="example"><a name="d5e10175" href="#d5e10175"></a><p class="title"><b>Example&nbsp;12.2.&nbsp;Aggregator</b></p><div class="example-contents">

<pre class="programlisting"><span class="hl-tag">&lt;int:aggregator</span> <span class="hl-attribute">&#8230;</span> <span class="hl-attribute">message-store</span>=<span class="hl-value">"refToMessageStore"</span><span class="hl-tag">/&gt;</span></pre>
</div></div><br class="example-break">
<p>By default, messages are stored in-memory by using <code class="literal">o.s.i.store.SimpleMessageStore</code>, an implementation of <code class="literal">MessageStore</code>.
That might be fine for development or simple low-volume environments where the potential loss of non-persistent messages is not a concern.
However, the typical production application needs a more robust option, not only to mitigate the risk of message loss but also to avoid potential out-of-memory errors.
Therefore, we also provide <code class="literal">MessageStore</code> implementations for a variety of data-stores.
The following is a complete list of supported implementations:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="xref" href="#jdbc-message-store" title="21.4&nbsp;JDBC Message Store">Section&nbsp;21.4, &#8220;JDBC Message Store&#8221;</a>: Uses an RDBMS to store messages
</li><li class="listitem">
<a class="xref" href="#redis-message-store" title="27.3&nbsp;Redis Message Store">Section&nbsp;27.3, &#8220;Redis Message Store&#8221;</a>: Uses a Redis key/value datastore to store messages
</li><li class="listitem">
<a class="xref" href="#mongodb-message-store" title="25.2&nbsp;MongoDB Message Store">Section&nbsp;25.2, &#8220;MongoDB Message Store&#8221;</a>: Uses a MongoDB document store to store messages
</li><li class="listitem">
<a class="xref" href="#gemfire-message-store" title="19.4&nbsp;Gemfire Message Store">Section&nbsp;19.4, &#8220;Gemfire Message Store&#8221;</a>: Uses a Gemfire distributed cache to store messages
</li></ul></div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>However, be aware of some limitations while using persistent implementations of the <code class="literal">MessageStore</code>.</p>
<p>The Message data (payload and headers) is serialized and deserialized by using different serialization strategies, depending on the implementation of the <code class="literal">MessageStore</code>.
For example, when using <code class="literal">JdbcMessageStore</code>, only <code class="literal">Serializable</code> data is persisted by default.
In this case, non-Serializable headers are removed before serialization occurs.
Also, be aware of the protocol-specific headers that are injected by transport adapters (such as FTP, HTTP, JMS, and others).
For example, <code class="literal">&lt;http:inbound-channel-adapter/&gt;</code> maps HTTP headers into message headers, and one of them is an <code class="literal">ArrayList</code> of non-serializable <code class="literal">org.springframework.http.MediaType</code> instances.
However, you can inject your own implementation of the <code class="literal">Serializer</code> and <code class="literal">Deserializer</code> strategy interfaces into some <code class="literal">MessageStore</code> implementations (such as <code class="literal">JdbcMessageStore</code>) to change the behavior of serialization and deserialization.</p>
<p>Pay special attention to the headers that represent certain types of data.
For example, if one of the headers contains an instance of some Spring bean, upon deserialization, you may end up with a different instance of that bean, which directly affects some of the implicit headers created by the framework (such as <code class="literal">REPLY_CHANNEL</code> or <code class="literal">ERROR_CHANNEL</code>).
Currently, they are not serializable, but, even if they were, the deserialized channel would not represent the expected instance.</p>
<p>Beginning with Spring Integration version 3.0, you can resolve this issue with a header enricher configured to replace these headers with a name after registering the channel with the <code class="literal">HeaderChannelRegistry</code>.</p>
<p>Also, consider what happens when you configure a message-flow as follows: gateway &#8594; queue-channel (backed by a persistent Message Store) &#8594; service-activator. That gateway creates a temporary reply channel, which is lost by the time the service-activator&#8217;s poller reads from the queue.
Again, you can use the header enricher to replace the headers with a <code class="literal">String</code> representation.</p>
<p>For more information, see <a class="xref" href="#header-enricher" title="9.2.1&nbsp;Header Enricher">Section&nbsp;9.2.1, &#8220;Header Enricher&#8221;</a>.</p>
</td></tr></table></div>
<p>Spring Integration 4.0 introduced two new interfaces:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">ChannelMessageStore</code>: To implement operations specific for <code class="literal">QueueChannel</code> instances
</li><li class="listitem">
<code class="literal">PriorityCapableChannelMessageStore</code>: To mark <code class="literal">MessageStore</code> implementations to be used for <code class="literal">PriorityChannel</code> instances and to provide priority order for persisted messages.
</li></ul></div>
<p>The real behavior depends on the implementation.
The framework provides the following implementations, which can be used as a persistent <code class="literal">MessageStore</code> for <code class="literal">QueueChannel</code> and <code class="literal">PriorityChannel</code>:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="xref" href="#redis-cms" title="27.3.1&nbsp;Redis Channel Message Stores">Section&nbsp;27.3.1, &#8220;Redis Channel Message Stores&#8221;</a>
</li><li class="listitem">
<a class="xref" href="#mongodb-priority-channel-message-store" title="25.2.1&nbsp;MongoDB Channel Message Store">Section&nbsp;25.2.1, &#8220;MongoDB Channel Message Store&#8221;</a>
</li><li class="listitem">
<a class="xref" href="#jdbc-message-store-channels" title="21.4.3&nbsp;Backing Message Channels">Section&nbsp;21.4.3, &#8220;Backing Message Channels&#8221;</a>
</li></ul></div>
<div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Warning: Caution about SimpleMessageStore"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Warning]" src="images/warning.png"></td><th align="left"><a name="sms-caution" href="#sms-caution"></a>Caution about <code class="literal">SimpleMessageStore</code></th></tr><tr><td align="left" valign="top">

<p>Starting with version 4.1, the <code class="literal">SimpleMessageStore</code> no longer copies the message group when calling <code class="literal">getMessageGroup()</code>.
For large message groups, this was a significant performance problem.
4.0.1 introduced a boolean <code class="literal">copyOnGet</code> property that lets you control this behavior.
When used internally by the aggregator, this property was set to <code class="literal">false</code> to improve performance.
It is now <code class="literal">false</code> by default.</p>
<p>Users accessing the group store outside of components such as aggregators now get a direct reference to the group being used by the aggregator instead of a copy.
Manipulation of the group outside of the aggregator may cause unpredictable results.</p>
<p>For this reason, you should either not perform such manipulation or set the <code class="literal">copyOnGet</code> property to <code class="literal">true</code>.</p>
</td></tr></table></div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="message-group-factory" href="#message-group-factory"></a>12.4.1&nbsp;Using <code class="literal">MessageGroupFactory</code></h3></div></div></div>

<p>Starting with version 4.3, some <code class="literal">MessageGroupStore</code> implementations can be injected with a custom
<code class="literal">MessageGroupFactory</code> strategy to create and customize the <code class="literal">MessageGroup</code> instances used by the <code class="literal">MessageGroupStore</code>.
This defaults to a <code class="literal">SimpleMessageGroupFactory</code>, which produces <code class="literal">SimpleMessageGroup</code> instances based on the <code class="literal">GroupType.HASH_SET</code>
(<code class="literal">LinkedHashSet</code>) internal collection.
Other possible options are <code class="literal">SYNCHRONISED_SET</code> and <code class="literal">BLOCKING_QUEUE</code>, where the last one can be used to reinstate the
previous <code class="literal">SimpleMessageGroup</code> behavior.
Also the <code class="literal">PERSISTENT</code> option is available. See the next section for more information.
Starting with version 5.0.1, the <code class="literal">LIST</code> option is also available for when the order and uniqueness of messages in the group does not matter.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="lazy-load-message-group" href="#lazy-load-message-group"></a>12.4.2&nbsp;Persistent <code class="literal">MessageGroupStore</code> and Lazy-load</h3></div></div></div>

<p>Starting with version 4.3, all persistent <code class="literal">MessageGroupStore</code> instances retrieve <code class="literal">MessageGroup</code> instances and their <code class="literal">messages</code>
from the store in the lazy-load manner.
In most cases, it is useful for the correlation <code class="literal">MessageHandler</code> instances (see <a class="xref" href="#aggregator" title="8.4&nbsp;Aggregator">Section&nbsp;8.4, &#8220;Aggregator&#8221;</a> and <a class="xref" href="#resequencer" title="8.5&nbsp;Resequencer">Section&nbsp;8.5, &#8220;Resequencer&#8221;</a>),
when it would add overhead to load entire the <code class="literal">MessageGroup</code> from the store on each correlation operation.</p>
<p>You can use the <code class="literal">AbstractMessageGroupStore.setLazyLoadMessageGroups(false)</code> option to switch off the lazy-load behavior from the configuration.</p>
<p>Our performance tests for lazy-load on MongoDB <code class="literal">MessageStore</code> (<a class="xref" href="#mongodb-message-store" title="25.2&nbsp;MongoDB Message Store">Section&nbsp;25.2, &#8220;MongoDB Message Store&#8221;</a>) and
<code class="literal">&lt;aggregator&gt;</code> (<a class="xref" href="#aggregator" title="8.4&nbsp;Aggregator">Section&nbsp;8.4, &#8220;Aggregator&#8221;</a>)
use a custom <code class="literal">release-strategy</code> similar to the following:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:aggregator</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"inputChannel"</span>
                <span class="hl-attribute">output-channel</span>=<span class="hl-value">"outputChannel"</span>
                <span class="hl-attribute">message-store</span>=<span class="hl-value">"mongoStore"</span>
                <span class="hl-attribute">release-strategy-expression</span>=<span class="hl-value">"size() == 1000"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>It produces results similar to the following for 1000 simple messages:</p>
<div class="informalexample">
<pre class="screen">...
StopWatch 'Lazy-Load Performance': running time (millis) = 38918
-----------------------------------------
ms     %     Task name
-----------------------------------------
02652  007%  Lazy-Load
36266  093%  Eager
...</pre>
</div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="metadata-store" href="#metadata-store"></a>12.5&nbsp;Metadata Store</h2></div></div></div>

<p>Many external systems, services, or resources are not transactional (Twitter, RSS, file systems, and so on), and there is no any ability to mark the data as read.
Also, sometimes, you may need to implement the Enterprise Integration Pattern <a class="ulink" href="http://eaipatterns.com/IdempotentReceiver.html" target="_top">idempotent receiver</a> in some integration solutions.
To achieve this goal and store some previous state of the endpoint before the next interaction with external system or to deal with the next message, Spring Integration provides the metadata store component as an an implementation of the <code class="literal">org.springframework.integration.metadata.MetadataStore</code> interface with a general key-value contract.</p>
<p>The metadata store is designed to store various types of generic metadata (for example, the published date of the last feed entry that has been processed) to help components such as the feed adapter deal with duplicates.
If a component is not directly provided with a reference to a <code class="literal">MetadataStore</code>, the algorithm for locating a metadata store is as follows: First, look for a bean with a <code class="literal">metadataStore</code> ID in the application context.
If one is found, use it.
Otherwise, create a new instance of <code class="literal">SimpleMetadataStore</code>, which is an in-memory implementation that persists only metadata within the lifecycle of the currently running application context.
This means that, upon restart, you may end up with duplicate entries.</p>
<p>If you need to persist metadata between application context restarts, the framework provides the following persistent <code class="literal">MetadataStores</code>:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">PropertiesPersistingMetadataStore</code>
</li><li class="listitem">
<a class="xref" href="#gemfire-metadata-store" title="19.6&nbsp;Gemfire Metadata Store">Section&nbsp;19.6, &#8220;Gemfire Metadata Store&#8221;</a>
</li><li class="listitem">
<a class="xref" href="#jdbc-metadata-store" title="21.7&nbsp;JDBC Metadata Store">Section&nbsp;21.7, &#8220;JDBC Metadata Store&#8221;</a>
</li><li class="listitem">
<a class="xref" href="#mongodb-metadata-store" title="25.2.2&nbsp;MongoDB Metadata Store">Section&nbsp;25.2.2, &#8220;MongoDB Metadata Store&#8221;</a>
</li><li class="listitem">
<a class="xref" href="#redis-metadata-store" title="27.4&nbsp;Redis Metadata Store">Section&nbsp;27.4, &#8220;Redis Metadata Store&#8221;</a>
</li><li class="listitem">
<a class="xref" href="#zk-metadata-store" title="40.1&nbsp;Zookeeper Metadata Store">Section&nbsp;40.1, &#8220;Zookeeper Metadata Store&#8221;</a>
</li></ul></div>
<p>The <code class="literal">PropertiesPersistingMetadataStore</code> is backed by a properties file and a <a class="ulink" href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/util/PropertiesPersister.html" target="_top"><code class="literal">PropertiesPersister</code></a>.</p>
<p>By default, it persists only the state when the application context is closed normally. It implements <code class="literal">Flushable</code> so that you
can persist the state at will, by invoking <code class="literal">flush()</code>.
The following example shows how to configure a <span class="emphasis"><em>PropertiesPersistingMetadataStore</em></span> with XML:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"metadataStore"</span>
    <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.metadata.PropertiesPersistingMetadataStore"</span><span class="hl-tag">/&gt;</span></pre>
<p>Alternatively, you can provide your own implementation of the <code class="literal">MetadataStore</code> interface (for example,
<code class="literal">JdbcMetadataStore</code>) and configure it as a bean in the application context.</p>
<p>Starting with version 4.0, <code class="literal">SimpleMetadataStore</code>, <code class="literal">PropertiesPersistingMetadataStore</code>, and <code class="literal">RedisMetadataStore</code> implement <code class="literal">ConcurrentMetadataStore</code>.
These provide for atomic updates and can be used across multiple component or application instances.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="idempotent-receiver-pattern" href="#idempotent-receiver-pattern"></a>12.5.1&nbsp;Idempotent Receiver and Metadata Store</h3></div></div></div>

<p>The metadata store is useful for implementing the EIP <a class="ulink" href="http://eaipatterns.com/IdempotentReceiver.html" target="_top">idempotent receiver</a> pattern when there is need to filter an incoming message if it has already been processed and you can discard it or perform some other logic on discarding.
The following configuration shows an example of how to do so:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:filter</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"serviceChannel"</span>
			<span class="hl-attribute">output-channel</span>=<span class="hl-value">"idempotentServiceChannel"</span>
			<span class="hl-attribute">discard-channel</span>=<span class="hl-value">"discardChannel"</span>
			<span class="hl-attribute">expression</span>=<span class="hl-value">"@metadataStore.get(headers.businessKey) == null"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int:publish-subscribe-channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"idempotentServiceChannel"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int:outbound-channel-adapter</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"idempotentServiceChannel"</span>
                              <span class="hl-attribute">expression</span>=<span class="hl-value">"@metadataStore.put(headers.businessKey, '')"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int:service-activator</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"idempotentServiceChannel"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"service"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>The <code class="literal">value</code> of the idempotent entry may be an expiration date, after which that entry should be removed from metadata store by some scheduled reaper.</p>
<p>See also <a class="xref" href="#idempotent-receiver" title="10.9.10&nbsp;Idempotent Receiver Enterprise Integration Pattern">Section&nbsp;10.9.10, &#8220;Idempotent Receiver Enterprise Integration Pattern&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="metadatastore-listener" href="#metadatastore-listener"></a>12.5.2&nbsp;<code class="literal">MetadataStoreListener</code></h3></div></div></div>

<p>Some metadata stores (currently only zookeeper) support registering a listener to receive events when items change, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> MetadataStoreListener {

	<span class="hl-keyword">void</span> onAdd(String key, String value);

	<span class="hl-keyword">void</span> onRemove(String key, String oldValue);

	<span class="hl-keyword">void</span> onUpdate(String key, String newValue);
}</pre>
</div>
<p>See the <a class="ulink" href="https://docs.spring.io/spring-integration/api/org/springframework/integration/metadata/MetadataStoreListenerAdapter.html" target="_top">Javadoc</a> for more information.
The <code class="literal">MetadataStoreListenerAdapter</code> can be subclassed if you are interested only in a subset of events.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="control-bus" href="#control-bus"></a>12.6&nbsp;Control Bus</h2></div></div></div>

<p>As described in the <a class="ulink" href="http://www.eaipatterns.com" target="_top"><span class="emphasis"><em>Enterprise Integration Patterns</em></span></a> (EIP) book, the idea behind the control bus is that the same messaging system can be used for monitoring and managing the components within the framework as is used for "<code class="literal">application-level</code>" messaging.
In Spring Integration, we build upon the adapters described above so that you can send messages as a means of invoking exposed operations.</p>
<p>The following example shows how to configure a control bus with XML:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:control-bus</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"operationChannel"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>The control bus has an input channel that can be accessed for invoking operations on the beans in the application context.
It also has all the common properties of a service activating endpoint.
For example, you can specify an output channel if the result of the operation has a return value that you want to send on to a downstream channel.</p>
<p>The control bus runs messages on the input channel as Spring Expression Language (SpEL) expressions.
It takes a message, compiles the body to an expression, adds some context, and then runs it.
The default context supports any method that has been annotated with <code class="literal">@ManagedAttribute</code> or <code class="literal">@ManagedOperation</code>.
It also supports the methods on Spring&#8217;s <code class="literal">Lifecycle</code> interface, and it supports methods that are used to configure several of Spring&#8217;s <code class="literal">TaskExecutor</code> and <code class="literal">TaskScheduler</code> implementations.
The simplest way to ensure that your own methods are available to the control bus is to use the <code class="literal">@ManagedAttribute</code> or <code class="literal">@ManagedOperation</code> annotations.
Since those annotations are also used for exposing methods to a JMX MBean registry, they offer a convenient by-product: Often, the same types of operations you want to expose to the control bus are reasonable for exposing through JMX).
Resolution of any particular instance within the application context is achieved in the typical SpEL syntax.
To do so, provide the bean name with the SpEL prefix for beans (<code class="literal">@</code>).
For example, to execute a method on a Spring Bean, a client could send a message to the operation channel as follows:</p>
<div class="informalexample">
<pre class="programlisting">Message operation = MessageBuilder.withPayload(<span class="hl-string">"@myServiceBean.shutdown()"</span>).build();
operationChannel.send(operation)</pre>
</div>
<p>The root of the context for the expression is the <code class="literal">Message</code> itself, so you also have access to the <code class="literal">payload</code> and <code class="literal">headers</code> as variables within your expression.
This is consistent with all the other expression support in Spring Integration endpoints.</p>
<p>With Java annotations, you can configured the control bus as follows:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "operationChannel")</span></em>
<span class="hl-keyword">public</span> ExpressionControlBusFactoryBean controlBus() {
    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> ExpressionControlBusFactoryBean();
}</pre>
</div>
<p>Similarly, you can configure Java DSL flow definitions as follows:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> IntegrationFlow controlBusFlow() {
    <span class="hl-keyword">return</span> IntegrationFlows.from(<span class="hl-string">"controlBus"</span>)
              .controlBus()
              .get();
}</pre>
</div>
<p>If you prefer to use lambdas with automatic <code class="literal">DirectChannel</code> creation, you can create a control bus as follows:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> IntegrationFlow controlBus() {
    <span class="hl-keyword">return</span> IntegrationFlowDefinition::controlBus;
}</pre>
</div>
<p>In this case, the channel is named <code class="literal">controlBus.input</code>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jmx-shutdown" href="#jmx-shutdown"></a>12.7&nbsp;Orderly Shutdown</h2></div></div></div>

<p>As described in "<a class="xref" href="#jmx-mbean-exporter" title="12.2.7&nbsp;MBean Exporter">Section&nbsp;12.2.7, &#8220;MBean Exporter&#8221;</a>", the MBean exporter provides a JMX operation called <code class="literal">stopActiveComponents</code>, which is used to stop the application in an orderly manner.
The operation has a single <code class="literal">Long</code> parameter.
The parameter indicates how long (in milliseconds) the operation waits to allow in-flight messages to complete.
The operation works as follows:</p>
<div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
<p class="simpara">Call <code class="literal">beforeShutdown()</code> on all beans that implement <code class="literal">OrderlyShutdownCapable</code>.</p>
<p class="simpara">Doing so lets such components prepare for shutdown.
Examples of components that implement this interface and what they do with this call include JMS and AMQP message-driven adapters that stop their listener containers, TCP server connection factories that stop accepting new connections (while keeping existing connections open), TCP inbound endpoints that drop (log) any new messages received, and HTTP inbound endpoints that return <code class="literal">503 - Service Unavailable</code> for any new requests.</p>
</li><li class="listitem">
Stop any active channels, such as JMS- or AMQP-backed channels.
</li><li class="listitem">
Stop all <code class="literal">MessageSource</code> instances.
</li><li class="listitem">
Stop all inbound <code class="literal">MessageProducer</code> s (that are not <code class="literal">OrderlyShutdownCapable</code>).
</li><li class="listitem">
<p class="simpara">Wait for any remaining time left, as defined by the value of the <code class="literal">Long</code> parameter passed in to the operation.</p>
<p class="simpara">Doing so lets any in-flight messages complete their journeys.
It is therefore important to select an appropriate timeout when invoking this operation.</p>
</li><li class="listitem">
<p class="simpara">Call <code class="literal">afterShutdown()</code> on all <code class="literal">OrderlyShutdownCapable</code> components.</p>
<p class="simpara">Doing so lets such components perform final shutdown tasks (closing all open sockets, for example).</p>
</li></ol></div>
<p>As discussed in <a class="xref" href="#jmx-mbean-shutdown" title="Orderly Shutdown Managed Operation">the section called &#8220;Orderly Shutdown Managed Operation&#8221;</a>, this operation can be invoked by using JMX.
If you wish to programmatically invoke the method, you need to inject or otherwise get a reference to the <code class="literal">IntegrationMBeanExporter</code>.
If no <code class="literal">id</code> attribute is provided on the <code class="literal">&lt;int-jmx:mbean-export/&gt;</code> definition, the bean has a generated name.
This name contains a random component to avoid <code class="literal">ObjectName</code> collisions if multiple Spring Integration contexts exist in the same JVM (<code class="literal">MBeanServer</code>).</p>
<p>For this reason, if you wish to invoke the method programmatically, we recommend that you provide the exporter with an <code class="literal">id</code> attribute so that you can easily access it in the application context.</p>
<p>Finally, the operation can be invoked by using the <code class="literal">&lt;control-bus&gt;</code> element.
See the <a class="ulink" href="https://github.com/spring-projects/spring-integration-samples/tree/master/intermediate/monitoring" target="_top">monitoring Spring Integration sample application</a> for details.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The algorithm described earlier was improved in version 4.1.
Previously, all task executors and schedulers were stopped.
This could cause mid-flow messages in <code class="literal">QueueChannel</code> instances to remain.
Now the shutdown leaves pollers running, to let these messages be drained and processed.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="integration-graph" href="#integration-graph"></a>12.8&nbsp;Integration Graph</h2></div></div></div>

<p>Starting with version 4.3, Spring Integration provides access to an application&#8217;s runtime object model, which can, optionally, include component metrics.
It is exposed as a graph, which may be used to visualize the current state of the integration application.
The <code class="literal">o.s.i.support.management.graph</code> package contains all the required classes to collect, build, and render the runtime state of Spring Integration components as a single tree-like <code class="literal">Graph</code> object.
The <code class="literal">IntegrationGraphServer</code> should be declared as a bean to build, retrieve, and refresh the <code class="literal">Graph</code> object.
The resulting <code class="literal">Graph</code> object can be serialized to any format, although JSON is flexible and convenient to parse and represent on the client side.
A Spring Integration application with only the default components would expose a graph as follows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">{</span>
  <span class="hl-string">"contentDescriptor"</span>: <span class="hl-keyword">{</span>
    <span class="hl-string">"providerVersion"</span>: <span class="hl-string">"4.3.0.RELEASE"</span><span class="hl-keyword">,</span>
    <span class="hl-string">"providerFormatVersion"</span>: <span class="hl-number">1.0</span><span class="hl-keyword">,</span>
    <span class="hl-string">"provider"</span>: <span class="hl-string">"spring-integration"</span><span class="hl-keyword">,</span>
    <span class="hl-string">"name"</span>: <span class="hl-string">"myApplication"</span>
  <span class="hl-keyword">},</span>
  <span class="hl-string">"nodes"</span>: <span class="hl-keyword">[</span>
    <span class="hl-keyword">{</span>
      <span class="hl-string">"nodeId"</span>: <span class="hl-number">1</span><span class="hl-keyword">,</span>
      <span class="hl-string">"name"</span>: <span class="hl-string">"nullChannel"</span><span class="hl-keyword">,</span>
      <span class="hl-string">"stats"</span>: null<span class="hl-keyword">,</span>
      <span class="hl-string">"componentType"</span>: <span class="hl-string">"channel"</span>
    <span class="hl-keyword">},</span>
    <span class="hl-keyword">{</span>
      <span class="hl-string">"nodeId"</span>: <span class="hl-number">2</span><span class="hl-keyword">,</span>
      <span class="hl-string">"name"</span>: <span class="hl-string">"errorChannel"</span><span class="hl-keyword">,</span>
      <span class="hl-string">"stats"</span>: null<span class="hl-keyword">,</span>
      <span class="hl-string">"componentType"</span>: <span class="hl-string">"publish-subscribe-channel"</span>
    <span class="hl-keyword">},</span>
    <span class="hl-keyword">{</span>
      <span class="hl-string">"nodeId"</span>: <span class="hl-number">3</span><span class="hl-keyword">,</span>
      <span class="hl-string">"name"</span>: <span class="hl-string">"_org.springframework.integration.errorLogger"</span><span class="hl-keyword">,</span>
      <span class="hl-string">"stats"</span>: <span class="hl-keyword">{</span>
        <span class="hl-string">"duration"</span>: <span class="hl-keyword">{</span>
          <span class="hl-string">"count"</span>: <span class="hl-number">0</span><span class="hl-keyword">,</span>
          <span class="hl-string">"min"</span>: <span class="hl-number">0.0</span><span class="hl-keyword">,</span>
          <span class="hl-string">"max"</span>: <span class="hl-number">0.0</span><span class="hl-keyword">,</span>
          <span class="hl-string">"mean"</span>: <span class="hl-number">0.0</span><span class="hl-keyword">,</span>
          <span class="hl-string">"standardDeviation"</span>: <span class="hl-number">0.0</span><span class="hl-keyword">,</span>
          <span class="hl-string">"countLong"</span>: <span class="hl-number">0</span>
        <span class="hl-keyword">},</span>
        <span class="hl-string">"errorCount"</span>: <span class="hl-number">0</span><span class="hl-keyword">,</span>
        <span class="hl-string">"standardDeviationDuration"</span>: <span class="hl-number">0.0</span><span class="hl-keyword">,</span>
        <span class="hl-string">"countsEnabled"</span>: <span class="hl-keyword">true</span><span class="hl-keyword">,</span>
        <span class="hl-string">"statsEnabled"</span>: <span class="hl-keyword">true</span><span class="hl-keyword">,</span>
        <span class="hl-string">"loggingEnabled"</span>: <span class="hl-keyword">false</span><span class="hl-keyword">,</span>
        <span class="hl-string">"handleCount"</span>: <span class="hl-number">0</span><span class="hl-keyword">,</span>
        <span class="hl-string">"meanDuration"</span>: <span class="hl-number">0.0</span><span class="hl-keyword">,</span>
        <span class="hl-string">"maxDuration"</span>: <span class="hl-number">0.0</span><span class="hl-keyword">,</span>
        <span class="hl-string">"minDuration"</span>: <span class="hl-number">0.0</span><span class="hl-keyword">,</span>
        <span class="hl-string">"activeCount"</span>: <span class="hl-number">0</span>
      <span class="hl-keyword">},</span>
      <span class="hl-string">"componentType"</span>: <span class="hl-string">"logging-channel-adapter"</span><span class="hl-keyword">,</span>
      <span class="hl-string">"output"</span>: null<span class="hl-keyword">,</span>
      <span class="hl-string">"input"</span>: <span class="hl-string">"errorChannel"</span>
    <span class="hl-keyword">}</span>
  ]<span class="hl-keyword">,</span>
  <span class="hl-string">"links"</span>: <span class="hl-keyword">[</span>
    <span class="hl-keyword">{</span>
      <span class="hl-string">"from"</span>: <span class="hl-number">2</span><span class="hl-keyword">,</span>
      <span class="hl-string">"to"</span>: <span class="hl-number">3</span><span class="hl-keyword">,</span>
      <span class="hl-string">"type"</span>: <span class="hl-string">"input"</span>
    <span class="hl-keyword">}</span>
  <span class="hl-keyword">]</span>
<span class="hl-keyword">}</span></pre>
</div>
<p>In the preceding example, the graph consists of three top-level elements.</p>
<p>The <code class="literal">contentDescriptor</code> graph element contains general information about the application providing the data.
The <code class="literal">name</code> can be customized on the <code class="literal">IntegrationGraphServer</code> bean or in the <code class="literal">spring.application.name</code> application context environment property.
Other properties are provided by the framework and let you distinguish a similar model from other sources.</p>
<p>The <code class="literal">links</code> graph element represents connections between nodes from the <code class="literal">nodes</code> graph element and, therefore, between integration components in the source Spring Integration application.
For example, from a <code class="literal">MessageChannel</code> to an <code class="literal">EventDrivenConsumer</code> with some <code class="literal">MessageHandler</code>
or from an <code class="literal">AbstractReplyProducingMessageHandler</code> to a <code class="literal">MessageChannel</code>.
For convenience and to let you determine a link&#8217;s purpose, the model includes the <code class="literal">type</code> attribute.
The possible types are:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">input</code>: Identifies the direction from <code class="literal">MessageChannel</code> to the endpoint, <code class="literal">inputChannel</code>, or <code class="literal">requestChannel</code> property
</li><li class="listitem">
<code class="literal">output</code>: The direction from the <code class="literal">MessageHandler</code>, <code class="literal">MessageProducer</code>, or <code class="literal">SourcePollingChannelAdapter</code> to the <code class="literal">MessageChannel</code> through an <code class="literal">outputChannel</code> or <code class="literal">replyChannel</code> property
</li><li class="listitem">
<code class="literal">error</code>: From <code class="literal">MessageHandler</code> on <code class="literal">PollingConsumer</code> or <code class="literal">MessageProducer</code> or <code class="literal">SourcePollingChannelAdapter</code> to the <code class="literal">MessageChannel</code> through an <code class="literal">errorChannel</code> property;
</li><li class="listitem">
<code class="literal">discard</code>: From <code class="literal">DiscardingMessageHandler</code> (such as <code class="literal">MessageFilter</code>) to the <code class="literal">MessageChannel</code> through an <code class="literal">errorChannel</code> property.
</li><li class="listitem">
<code class="literal">route</code>: From <code class="literal">AbstractMappingMessageRouter</code> (such as <code class="literal">HeaderValueRouter</code>) to the <code class="literal">MessageChannel</code>.
Similar to <code class="literal">output</code> but determined at run-time.
May be a configured channel mapping or a dynamically resolved channel.
Routers typically retain only up to 100 dynamic routes for this purpose, but you can modify this value by setting the <code class="literal">dynamicChannelLimit</code> property.
</li></ul></div>
<p>The information from this element can be used by a visualization tool to render connections between nodes from the <code class="literal">nodes</code> graph element, where the <code class="literal">from</code> and <code class="literal">to</code> numbers represent the value from the <code class="literal">nodeId</code> property of the linked nodes.
For example, the <code class="literal">link</code> element can be used to determine the proper <code class="literal">port</code> on the target node.</p>
<p>The following "<code class="literal">text image</code>" shows the relationships between the types:</p>
<div class="informalexample">
<pre class="screen">              +---(discard)
              |
         +----o----+
         |         |
         |         |
         |         |
(input)--o         o---(output)
         |         |
         |         |
         |         |
         +----o----+
              |
              +---(error)</pre>
</div>
<p>The <code class="literal">nodes</code> graph element is perhaps the most interesting, because its elements contain not only the runtime components with their <code class="literal">componentType</code> instances and <code class="literal">name</code> values but can also optionally contain metrics exposed by the component.
Node elements contain various properties that are generally self-explanatory.
For example, expression-based components include the <code class="literal">expression</code> property that contains the primary expression string for the component.
To enable the metrics, add an <code class="literal">@EnableIntegrationManagement</code> to a <code class="literal">@Configuration</code> class or add an <code class="literal">&lt;int:management/&gt;</code> element to your XML configuration.
You can control exactly which components in the framework collect statistics.
See  <a class="xref" href="#metrics-management" title="12.1&nbsp;Metrics and Management">Section&nbsp;12.1, &#8220;Metrics and Management&#8221;</a> for complete information.
See the <code class="literal">stats</code> attribute from the <code class="literal">o.s.i.errorLogger</code> component in the JSON example shown earlier.
In this case, The <code class="literal">nullChannel</code> and <code class="literal">errorChannel</code> do not provide statistics information, because the configuration for this example was as follows:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Configuration</span></em>
<em><span class="hl-annotation" style="color: gray">@EnableIntegration</span></em>
<em><span class="hl-annotation" style="color: gray">@EnableIntegrationManagement(statsEnabled = "_org.springframework.integration.errorLogger.handler",
      countsEnabled = "!*",
      defaultLoggingEnabled = "false")</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ManagementConfiguration {

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> IntegrationGraphServer integrationGraphServer() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> IntegrationGraphServer();
    }

}</pre>
</div>
<p>The <code class="literal">nodeId</code> represents a unique incremental identifier to let you distinguish one component from another.
It is also used in the <code class="literal">links</code> element to represent a relationship (connection) of this component to others, if any.
The <code class="literal">input</code> and <code class="literal">output</code> attributes are for the <code class="literal">inputChannel</code> and <code class="literal">outputChannel</code> properties of the <code class="literal">AbstractEndpoint</code>, <code class="literal">MessageHandler</code>, <code class="literal">SourcePollingChannelAdapter</code>, or <code class="literal">MessageProducerSupport</code>.
See the next section for more information.</p>
<p>Starting with version 5.1, the <code class="literal">IntegrationGraphServer</code> accepts a <code class="literal">Function&lt;NamedComponent, Map&lt;String, Object&gt;&gt; additionalPropertiesCallback</code> for population of additional properties on the <code class="literal">IntegrationNode</code> for a particular <code class="literal">NamedComponent</code>.
For example you can expose the <code class="literal">SmartLifecycle</code> <code class="literal">autoStartup</code> and <code class="literal">running</code> properties into the target graph:</p>
<div class="informalexample">
<pre class="programlisting">server.setAdditionalPropertiesCallback(namedComponent -&gt; {
            Map&lt;String, Object&gt; properties = null;
            <span class="hl-keyword">if</span> (namedComponent <span class="hl-keyword">instanceof</span> SmartLifecycle) {
                SmartLifecycle smartLifecycle = (SmartLifecycle) namedComponent;
                properties = <span class="hl-keyword">new</span> HashMap&lt;&gt;();
                properties.put(<span class="hl-string">"auto-startup"</span>, smartLifecycle.isAutoStartup());
                properties.put(<span class="hl-string">"running"</span>, smartLifecycle.isRunning());
            }
            <span class="hl-keyword">return</span> properties;
        });</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_graph_runtime_model" href="#_graph_runtime_model"></a>12.8.1&nbsp;Graph Runtime Model</h3></div></div></div>

<p>Spring Integration components have various levels of complexity.
For example, any polled <code class="literal">MessageSource</code> also has a <code class="literal">SourcePollingChannelAdapter</code> and a <code class="literal">MessageChannel</code> to which to periodically send messages from the source data.
Other components might be middleware request-reply components (such as <code class="literal">JmsOutboundGateway</code>) with a consuming <code class="literal">AbstractEndpoint</code> to subscribe to (or poll) the <code class="literal">requestChannel</code> (<code class="literal">input</code>) for messages, and a <code class="literal">replyChannel</code> (<code class="literal">output</code>) to produce a reply message to send downstream.
Meanwhile, any <code class="literal">MessageProducerSupport</code> implementation (such as <code class="literal">ApplicationEventListeningMessageProducer</code>) wraps some source protocol listening logic and sends messages to the <code class="literal">outputChannel</code>.</p>
<p>Within the graph, Spring Integration components are represented by using the <code class="literal">IntegrationNode</code> class hierarchy, which you can find in the <code class="literal">o.s.i.support.management.graph</code> package.
For example, you can use the <code class="literal">ErrorCapableDiscardingMessageHandlerNode</code> for the <code class="literal">AggregatingMessageHandler</code> (because it has a <code class="literal">discardChannel</code> option) and can produce errors when consuming from a <code class="literal">PollableChannel</code> by using a <code class="literal">PollingConsumer</code>.
Another example is <code class="literal">CompositeMessageHandlerNode</code>&#8201;&#8212;&#8201;for a <code class="literal">MessageHandlerChain</code> when subscribed to a <code class="literal">SubscribableChannel</code> by using an <code class="literal">EventDrivenConsumer</code>.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The <code class="literal">@MessagingGateway</code> (see <a class="xref" href="#gateway" title="10.4&nbsp;Messaging Gateways">Section&nbsp;10.4, &#8220;Messaging Gateways&#8221;</a>) provides nodes for each of its method, where the <code class="literal">name</code> attribute is based on the gateway&#8217;s bean name and the short method signature.
Consider the following example of a gateway:</p>
</td></tr></table></div>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@MessagingGateway(defaultRequestChannel = "four")</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> Gate {

	<span class="hl-keyword">void</span> foo(String foo);

	<span class="hl-keyword">void</span> foo(Integer foo);

	<span class="hl-keyword">void</span> bar(String bar);

}</pre>
</div>
<p>The preceding gateway produces nodes similar to the following:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">{</span>
  <span class="hl-string">"nodeId"</span> : <span class="hl-number">10</span><span class="hl-keyword">,</span>
  <span class="hl-string">"name"</span> : <span class="hl-string">"gate.bar(class java.lang.String)"</span><span class="hl-keyword">,</span>
  <span class="hl-string">"stats"</span> : null<span class="hl-keyword">,</span>
  <span class="hl-string">"componentType"</span> : <span class="hl-string">"gateway"</span><span class="hl-keyword">,</span>
  <span class="hl-string">"output"</span> : <span class="hl-string">"four"</span><span class="hl-keyword">,</span>
  <span class="hl-string">"errors"</span> : null
<span class="hl-keyword">},</span>
<span class="hl-keyword">{</span>
  <span class="hl-string">"nodeId"</span> : <span class="hl-number">11</span><span class="hl-keyword">,</span>
  <span class="hl-string">"name"</span> : <span class="hl-string">"gate.foo(class java.lang.String)"</span><span class="hl-keyword">,</span>
  <span class="hl-string">"stats"</span> : null<span class="hl-keyword">,</span>
  <span class="hl-string">"componentType"</span> : <span class="hl-string">"gateway"</span><span class="hl-keyword">,</span>
  <span class="hl-string">"output"</span> : <span class="hl-string">"four"</span><span class="hl-keyword">,</span>
  <span class="hl-string">"errors"</span> : null
<span class="hl-keyword">},</span>
<span class="hl-keyword">{</span>
  <span class="hl-string">"nodeId"</span> : <span class="hl-number">12</span><span class="hl-keyword">,</span>
  <span class="hl-string">"name"</span> : <span class="hl-string">"gate.foo(class java.lang.Integer)"</span><span class="hl-keyword">,</span>
  <span class="hl-string">"stats"</span> : null<span class="hl-keyword">,</span>
  <span class="hl-string">"componentType"</span> : <span class="hl-string">"gateway"</span><span class="hl-keyword">,</span>
  <span class="hl-string">"output"</span> : <span class="hl-string">"four"</span><span class="hl-keyword">,</span>
  <span class="hl-string">"errors"</span> : null
<span class="hl-keyword">}</span></pre>
</div>
<p>You can use this  <code class="literal">IntegrationNode</code> hierarchy for parsing the graph model on the client side as well as to understand the general Spring Integration runtime behavior.
See also <a class="xref" href="#programming-tips" title="5.7&nbsp;Programming Tips and Tricks">Section&nbsp;5.7, &#8220;Programming Tips and Tricks&#8221;</a> for more information.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_integration_graph_controller" href="#_integration_graph_controller"></a>12.9&nbsp;Integration Graph Controller</h2></div></div></div>

<p>If your application is web-based (or built on top of Spring Boot with an embedded web container) and the Spring Integration HTTP or WebFlux module (see <a class="xref" href="#http" title="20.&nbsp;HTTP Support">Chapter&nbsp;20, <i>HTTP Support</i></a> and <a class="xref" href="#webflux" title="35.&nbsp;WebFlux Support">Chapter&nbsp;35, <i>WebFlux Support</i></a>, respectively) is present on the classpath, you can use a <code class="literal">IntegrationGraphController</code> to expose the <code class="literal">IntegrationGraphServer</code> functionality as a REST service.
For this purpose, the <code class="literal">@EnableIntegrationGraphController</code> and <code class="literal">@Configuration</code> class annotations and the <code class="literal">&lt;int-http:graph-controller/&gt;</code> XML element are available in the HTTP module.
Together with the <code class="literal">@EnableWebMvc</code> annotation (or <code class="literal">&lt;mvc:annotation-driven/&gt;</code> for XML definitions), this configuration registers an <code class="literal">IntegrationGraphController</code> <code class="literal">@RestController</code> where its <code class="literal">@RequestMapping.path</code> can be configured on the <code class="literal">@EnableIntegrationGraphController</code> annotation or <code class="literal">&lt;int-http:graph-controller/&gt;</code> element.
The default path is <code class="literal">/integration</code>.</p>
<p>The <code class="literal">IntegrationGraphController</code> <code class="literal">@RestController</code> provides the following services:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">@GetMapping(name = "getGraph")</code>: To retrieve the state of the Spring Integration components since the last <code class="literal">IntegrationGraphServer</code> refresh.
The <code class="literal">o.s.i.support.management.graph.Graph</code> is returned as a <code class="literal">@ResponseBody</code> of the REST service.
</li><li class="listitem">
<code class="literal">@GetMapping(path = "/refresh", name = "refreshGraph")</code>: To refresh the current <code class="literal">Graph</code> for the actual runtime state and return it as a REST response.
It is not necessary to refresh the graph for metrics.
They are provided in real-time when the graph is retrieved.
Refresh can be called if the application context has been modified since the graph was last retrieved.
In that case, the graph is completely rebuilt.
</li></ul></div>
<p>You can set security and cross-origin restrictions for the <code class="literal">IntegrationGraphController</code> with the standard configuration options and components provided by the Spring Security and Spring MVC projects.
The following example achieves those goals:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;mvc:annotation-driven /&gt;</span>

<span class="hl-tag">&lt;mvc:cors&gt;</span>
	<span class="hl-tag">&lt;mvc:mapping</span> <span class="hl-attribute">path</span>=<span class="hl-value">"/myIntegration/**"</span>
				 <span class="hl-attribute">allowed-origins</span>=<span class="hl-value">"http://localhost:9090"</span>
				 <span class="hl-attribute">allowed-methods</span>=<span class="hl-value">"GET"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/mvc:cors&gt;</span>

<span class="hl-tag">&lt;security:http&gt;</span>
    <span class="hl-tag">&lt;security:intercept-url</span> <span class="hl-attribute">pattern</span>=<span class="hl-value">"/myIntegration/**"</span> <span class="hl-attribute">access</span>=<span class="hl-value">"ROLE_ADMIN"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/security:http&gt;</span>


<span class="hl-tag">&lt;int-http:graph-controller</span> <span class="hl-attribute">path</span>=<span class="hl-value">"/myIntegration"</span><span class="hl-tag"> /&gt;</span></pre>
</div>
<p>The following example shows how to do the same thing with Java configuration:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Configuration</span></em>
<em><span class="hl-annotation" style="color: gray">@EnableWebMvc</span></em> <span class="hl-comment">// or @EnableWebFlux</span>
<em><span class="hl-annotation" style="color: gray">@EnableWebSecurity</span></em> <span class="hl-comment">// or @EnableWebFluxSecurity</span>
<em><span class="hl-annotation" style="color: gray">@EnableIntegration</span></em>
<em><span class="hl-annotation" style="color: gray">@EnableIntegrationGraphController(path = "/testIntegration", allowedOrigins="http://localhost:9090")</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> IntegrationConfiguration <span class="hl-keyword">extends</span> WebSecurityConfigurerAdapter {

    <em><span class="hl-annotation" style="color: gray">@Override</span></em>
    <span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> configure(HttpSecurity http) <span class="hl-keyword">throws</span> Exception {
	    http
            .authorizeRequests()
               .antMatchers(<span class="hl-string">"/testIntegration/**"</span>).hasRole(<span class="hl-string">"ADMIN"</span>)
            <span class="hl-comment">// ...</span>
            .formLogin();
    }

    <span class="hl-comment">//...</span>

}</pre>
</div>
<p>Note that, for convenience, the <code class="literal">@EnableIntegrationGraphController</code> annotation provides an <code class="literal">allowedOrigins</code> attribute.
This provides <code class="literal">GET</code> access to the <code class="literal">path</code>.
For more sophistication, you can configure the CORS mappings by using standard Spring MVC mechanisms.</p>
</div>
</div>
</div>
<div class="part"><div class="titlepage"><div><div><h1 class="title"><a name="spring-integration-endpoints" href="#spring-integration-endpoints"></a>Part&nbsp;V.&nbsp;Integration Endpoints</h1></div></div></div>

<div class="partintro"><div></div>
<p>This section covers the various channel adapters and messaging gateways provided by Spring Integration to support message-based communication with external systems.</p>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="endpoint-summary" href="#endpoint-summary"></a>13.&nbsp;Endpoint Quick Reference Table</h2></div></div></div>

<p>As discussed in the earlier sections, Spring Integration provides a number of endpoints used to interface with external systems, file systems, and others.</p>
<p>For transparent dependency management Spring Integration provides a bill-of-materials POM to be imported into the Maven configuration:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;dependencyManagement&gt;</span>
    <span class="hl-tag">&lt;dependencies&gt;</span>
        <span class="hl-tag">&lt;dependency&gt;</span>
            <span class="hl-tag">&lt;groupId&gt;</span>org.springframework.integration<span class="hl-tag">&lt;/groupId&gt;</span>
            <span class="hl-tag">&lt;artifactId&gt;</span>spring-integration-bom<span class="hl-tag">&lt;/artifactId&gt;</span>
            <span class="hl-tag">&lt;version&gt;</span>5.1.2.RELEASE<span class="hl-tag">&lt;/version&gt;</span>
            <span class="hl-tag">&lt;type&gt;</span>pom<span class="hl-tag">&lt;/type&gt;</span>
            <span class="hl-tag">&lt;scope&gt;</span>import<span class="hl-tag">&lt;/scope&gt;</span>
        <span class="hl-tag">&lt;/dependency&gt;</span>
    <span class="hl-tag">&lt;/dependencies&gt;</span>
<span class="hl-tag">&lt;/dependencyManagement&gt;</span></pre>
</div>
<p>To recap:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Inbound channel adapters are used for one-way integration to bring data into the messaging application.
</li><li class="listitem">
Outbound channel adapters are used for one-way integration to send data out of the messaging application.
</li><li class="listitem">
Inbound gateways are used for a bidirectional integration flow, where some other system invokes the messaging application and receives a reply.
</li><li class="listitem">
Outbound Gateways are used for a bidirectional integration flow, where the messaging application invokes some external service or entity and expects a result.
</li></ul></div>
<p>The following table summarizes the various endpoints with quick links to the appropriate chapter.</p>
<div class="table"><a name="d5e10663" href="#d5e10663"></a><p class="title"><b>Table&nbsp;13.1.&nbsp;Endpoint Quick Reference</b></p><div class="table-contents">

<table summary="Endpoint Quick Reference" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"><col class="col_4"><col class="col_5"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Module</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Inbound Adapter</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Outbound Adapter</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Inbound Gateway</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Outbound Gateway</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><span class="strong"><strong>AMQP</strong></span></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#amqp-inbound-channel-adapter" title="14.1&nbsp;Inbound Channel Adapter">Section&nbsp;14.1, &#8220;Inbound Channel Adapter&#8221;</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#amqp-outbound-channel-adapter" title="14.5&nbsp;Outbound Channel Adapter">Section&nbsp;14.5, &#8220;Outbound Channel Adapter&#8221;</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#amqp-inbound-gateway" title="14.3&nbsp;Inbound Gateway">Section&nbsp;14.3, &#8220;Inbound Gateway&#8221;</a></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#amqp-outbound-gateway" title="14.6&nbsp;Outbound Gateway">Section&nbsp;14.6, &#8220;Outbound Gateway&#8221;</a></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><span class="strong"><strong>Events</strong></span></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#appevent-inbound" title="15.1&nbsp;Receiving Spring Application Events">Section&nbsp;15.1, &#8220;Receiving Spring Application Events&#8221;</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#appevent-outbound" title="15.2&nbsp;Sending Spring Application Events">Section&nbsp;15.2, &#8220;Sending Spring Application Events&#8221;</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>N</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>N</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><span class="strong"><strong>Feed</strong></span></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#feed-inbound-channel-adapter" title="16.1&nbsp;Feed Inbound Channel Adapter">Section&nbsp;16.1, &#8220;Feed Inbound Channel Adapter&#8221;</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>N</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>N</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>N</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><span class="strong"><strong>File</strong></span></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#file-reading" title="17.1&nbsp;Reading Files">Section&nbsp;17.1, &#8220;Reading Files&#8221;</a> and <a class="xref" href="#file-tailing" title="17.1.8&nbsp;'tail&#8217;ing Files">Section&nbsp;17.1.8, &#8220;'tail&#8217;ing Files&#8221;</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#file-writing" title="17.2&nbsp;Writing files">Section&nbsp;17.2, &#8220;Writing files&#8221;</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>N</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#file-writing" title="17.2&nbsp;Writing files">Section&nbsp;17.2, &#8220;Writing files&#8221;</a></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><span class="strong"><strong>FTP(S)</strong></span></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#ftp-inbound" title="18.4&nbsp;FTP Inbound Channel Adapter">Section&nbsp;18.4, &#8220;FTP Inbound Channel Adapter&#8221;</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#ftp-outbound" title="18.8&nbsp;FTP Outbound Channel Adapter">Section&nbsp;18.8, &#8220;FTP Outbound Channel Adapter&#8221;</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>N</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#ftp-outbound-gateway" title="18.9&nbsp;FTP Outbound Gateway">Section&nbsp;18.9, &#8220;FTP Outbound Gateway&#8221;</a></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><span class="strong"><strong>Gemfire</strong></span></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#gemfire-inbound" title="19.1&nbsp;Inbound Channel Adapter">Section&nbsp;19.1, &#8220;Inbound Channel Adapter&#8221;</a> and <a class="xref" href="#gemfire-cq" title="19.2&nbsp;Continuous Query Inbound Channel Adapter">Section&nbsp;19.2, &#8220;Continuous Query Inbound Channel Adapter&#8221;</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#gemfire-outbound" title="19.3&nbsp;Outbound Channel Adapter">Section&nbsp;19.3, &#8220;Outbound Channel Adapter&#8221;</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>N</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>N</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><span class="strong"><strong>HTTP</strong></span></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#http-namespace" title="20.3&nbsp;HTTP Namespace Support">Section&nbsp;20.3, &#8220;HTTP Namespace Support&#8221;</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#http-namespace" title="20.3&nbsp;HTTP Namespace Support">Section&nbsp;20.3, &#8220;HTTP Namespace Support&#8221;</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#http-inbound" title="20.1&nbsp;Http Inbound Components">Section&nbsp;20.1, &#8220;Http Inbound Components&#8221;</a></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#http-outbound" title="20.2&nbsp;HTTP Outbound Components">Section&nbsp;20.2, &#8220;HTTP Outbound Components&#8221;</a></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><span class="strong"><strong>JDBC</strong></span></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#jdbc-inbound-channel-adapter" title="21.1&nbsp;Inbound Channel Adapter">Section&nbsp;21.1, &#8220;Inbound Channel Adapter&#8221;</a> and <a class="xref" href="#stored-procedure-inbound-channel-adapter" title="21.5.6&nbsp;Stored Procedure Inbound Channel Adapter">Section&nbsp;21.5.6, &#8220;Stored Procedure Inbound Channel Adapter&#8221;</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#jdbc-outbound-channel-adapter" title="21.2&nbsp;Outbound Channel Adapter">Section&nbsp;21.2, &#8220;Outbound Channel Adapter&#8221;</a> and <a class="xref" href="#stored-procedure-outbound-channel-adapter" title="21.5.7&nbsp;Stored Procedure Outbound Channel Adapter">Section&nbsp;21.5.7, &#8220;Stored Procedure Outbound Channel Adapter&#8221;</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>N</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#jdbc-outbound-gateway" title="21.3&nbsp;Outbound Gateway">Section&nbsp;21.3, &#8220;Outbound Gateway&#8221;</a> and <a class="xref" href="#stored-procedure-outbound-gateway" title="21.5.8&nbsp;Stored Procedure Outbound Gateway">Section&nbsp;21.5.8, &#8220;Stored Procedure Outbound Gateway&#8221;</a></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><span class="strong"><strong>JMS</strong></span></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#jms-inbound-channel-adapter" title="23.1&nbsp;Inbound Channel Adapter">Section&nbsp;23.1, &#8220;Inbound Channel Adapter&#8221;</a> and <a class="xref" href="#jms-message-driven-channel-adapter" title="23.2&nbsp;Message-driven Channel Adapter">Section&nbsp;23.2, &#8220;Message-driven Channel Adapter&#8221;</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#jms-outbound-channel-adapter" title="23.3&nbsp;Outbound Channel Adapter">Section&nbsp;23.3, &#8220;Outbound Channel Adapter&#8221;</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#jms-inbound-gateway" title="23.4&nbsp;Inbound Gateway">Section&nbsp;23.4, &#8220;Inbound Gateway&#8221;</a></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#jms-outbound-gateway" title="23.5&nbsp;Outbound Gateway">Section&nbsp;23.5, &#8220;Outbound Gateway&#8221;</a></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><span class="strong"><strong>JMX</strong></span></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#jmx-notification-listening-channel-adapter" title="12.2.1&nbsp;Notification-listening Channel Adapter">Section&nbsp;12.2.1, &#8220;Notification-listening Channel Adapter&#8221;</a> and <a class="xref" href="#jmx-attribute-polling-channel-adapter" title="12.2.3&nbsp;Attribute-polling Channel Adapter">Section&nbsp;12.2.3, &#8220;Attribute-polling Channel Adapter&#8221;</a> and <a class="xref" href="#tree-polling-channel-adapter" title="12.2.4&nbsp;Tree-polling Channel Adapter">Section&nbsp;12.2.4, &#8220;Tree-polling Channel Adapter&#8221;</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#jmx-notification-publishing-channel-adapter" title="12.2.2&nbsp;Notification-publishing Channel Adapter">Section&nbsp;12.2.2, &#8220;Notification-publishing Channel Adapter&#8221;</a> and <a class="xref" href="#jmx-operation-invoking-channel-adapter" title="12.2.5&nbsp;Operation-invoking Channel Adapter">Section&nbsp;12.2.5, &#8220;Operation-invoking Channel Adapter&#8221;</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>N</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#jmx-operation-invoking-outbound-gateway" title="12.2.6&nbsp;Operation-invoking Outbound Gateway">Section&nbsp;12.2.6, &#8220;Operation-invoking Outbound Gateway&#8221;</a></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><span class="strong"><strong>JPA</strong></span></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#jpa-inbound-channel-adapter" title="22.5&nbsp;Inbound Channel Adapter">Section&nbsp;22.5, &#8220;Inbound Channel Adapter&#8221;</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#jpa-outbound-channel-adapter" title="22.6&nbsp;Outbound Channel Adapter">Section&nbsp;22.6, &#8220;Outbound Channel Adapter&#8221;</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>N</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#jpa-updating-outbound-gateway" title="22.7.2&nbsp;Updating Outbound Gateway">Section&nbsp;22.7.2, &#8220;Updating Outbound Gateway&#8221;</a> and <a class="xref" href="#jpa-retrieving-outbound-gateway" title="22.7.5&nbsp;Retrieving Outbound Gateway">Section&nbsp;22.7.5, &#8220;Retrieving Outbound Gateway&#8221;</a></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><span class="strong"><strong>Mail</strong></span></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#mail-inbound" title="24.2&nbsp;Mail-receiving Channel Adapter">Section&nbsp;24.2, &#8220;Mail-receiving Channel Adapter&#8221;</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#mail-outbound" title="24.1&nbsp;Mail-sending Channel Adapter">Section&nbsp;24.1, &#8220;Mail-sending Channel Adapter&#8221;</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>N</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>N</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><span class="strong"><strong>MongoDB</strong></span></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#mongodb-inbound-channel-adapter" title="25.3&nbsp;MongoDB Inbound Channel Adapter">Section&nbsp;25.3, &#8220;MongoDB Inbound Channel Adapter&#8221;</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#mongodb-outbound-channel-adapter" title="25.4&nbsp;MongoDB Outbound Channel Adapter">Section&nbsp;25.4, &#8220;MongoDB Outbound Channel Adapter&#8221;</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>N</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>N</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><span class="strong"><strong>MQTT</strong></span></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#mqtt-inbound" title="26.1&nbsp;Inbound (Message-driven) Channel Adapter">Section&nbsp;26.1, &#8220;Inbound (Message-driven) Channel Adapter&#8221;</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#mqtt-outbound" title="26.2&nbsp;Outbound Channel Adapter">Section&nbsp;26.2, &#8220;Outbound Channel Adapter&#8221;</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>N</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>N</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><span class="strong"><strong>Redis</strong></span></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#redis-inbound-channel-adapter" title="27.2.2&nbsp;Redis Inbound Channel Adapter">Section&nbsp;27.2.2, &#8220;Redis Inbound Channel Adapter&#8221;</a> and <a class="xref" href="#redis-queue-inbound-channel-adapter" title="27.2.4&nbsp;Redis Queue Inbound Channel Adapter">Section&nbsp;27.2.4, &#8220;Redis Queue Inbound Channel Adapter&#8221;</a> and <a class="xref" href="#redis-store-inbound-channel-adapter" title="27.5&nbsp;Redis Store Inbound Channel Adapter">Section&nbsp;27.5, &#8220;Redis Store Inbound Channel Adapter&#8221;</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#redis-outbound-channel-adapter" title="27.2.3&nbsp;Redis Outbound Channel Adapter">Section&nbsp;27.2.3, &#8220;Redis Outbound Channel Adapter&#8221;</a> and <a class="xref" href="#redis-queue-outbound-channel-adapter" title="27.2.5&nbsp;Redis Queue Outbound Channel Adapter">Section&nbsp;27.2.5, &#8220;Redis Queue Outbound Channel Adapter&#8221;</a> and <a class="xref" href="#redis-store-outbound-channel-adapter" title="27.6&nbsp;RedisStore Outbound Channel Adapter">Section&nbsp;27.6, &#8220;RedisStore Outbound Channel Adapter&#8221;</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#redis-queue-inbound-gateway" title="27.9&nbsp;Redis Queue Inbound Gateway">Section&nbsp;27.9, &#8220;Redis Queue Inbound Gateway&#8221;</a></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#redis-outbound-gateway" title="27.7&nbsp;Redis Outbound Command Gateway">Section&nbsp;27.7, &#8220;Redis Outbound Command Gateway&#8221;</a> and <a class="xref" href="#redis-queue-outbound-gateway" title="27.8&nbsp;Redis Queue Outbound Gateway">Section&nbsp;27.8, &#8220;Redis Queue Outbound Gateway&#8221;</a></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><span class="strong"><strong>Resource</strong></span></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#resource-inbound-channel-adapter" title="28.1&nbsp;Resource Inbound Channel Adapter">Section&nbsp;28.1, &#8220;Resource Inbound Channel Adapter&#8221;</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>N</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>N</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>N</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><span class="strong"><strong>RMI</strong></span></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>N</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>N</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#rmi-inbound" title="29.2&nbsp;Inbound RMI">Section&nbsp;29.2, &#8220;Inbound RMI&#8221;</a></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#rmi-outbound" title="29.1&nbsp;Outbound RMI">Section&nbsp;29.1, &#8220;Outbound RMI&#8221;</a></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><span class="strong"><strong>SFTP</strong></span></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#sftp-inbound" title="30.6&nbsp;SFTP Inbound Channel Adapter">Section&nbsp;30.6, &#8220;SFTP Inbound Channel Adapter&#8221;</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#sftp-outbound" title="30.10&nbsp;SFTP Outbound Channel Adapter">Section&nbsp;30.10, &#8220;SFTP Outbound Channel Adapter&#8221;</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>N</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#sftp-outbound-gateway" title="30.11&nbsp;SFTP Outbound Gateway">Section&nbsp;30.11, &#8220;SFTP Outbound Gateway&#8221;</a></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><span class="strong"><strong>STOMP</strong></span></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#stomp-inbound-adapter" title="31.2&nbsp;STOMP Inbound Channel Adapter">Section&nbsp;31.2, &#8220;STOMP Inbound Channel Adapter&#8221;</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#stomp-outbound-adapter" title="31.3&nbsp;STOMP Outbound Channel Adapter">Section&nbsp;31.3, &#8220;STOMP Outbound Channel Adapter&#8221;</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>N</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>N</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><span class="strong"><strong>Stream</strong></span></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#stream-reading" title="32.1&nbsp;Reading from Streams">Section&nbsp;32.1, &#8220;Reading from Streams&#8221;</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#stream-writing" title="32.2&nbsp;Writing to Streams">Section&nbsp;32.2, &#8220;Writing to Streams&#8221;</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>N</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>N</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><span class="strong"><strong>Syslog</strong></span></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#syslog-inbound-adapter" title="33.1&nbsp;Syslog Inbound Channel Adapter">Section&nbsp;33.1, &#8220;Syslog Inbound Channel Adapter&#8221;</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>N</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>N</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>N</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><span class="strong"><strong>TCP</strong></span></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#tcp-adapters" title="34.6&nbsp;TCP Adapters">Section&nbsp;34.6, &#8220;TCP Adapters&#8221;</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#tcp-adapters" title="34.6&nbsp;TCP Adapters">Section&nbsp;34.6, &#8220;TCP Adapters&#8221;</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#tcp-gateways" title="34.7&nbsp;TCP Gateways">Section&nbsp;34.7, &#8220;TCP Gateways&#8221;</a></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#tcp-gateways" title="34.7&nbsp;TCP Gateways">Section&nbsp;34.7, &#8220;TCP Gateways&#8221;</a></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><span class="strong"><strong>UDP</strong></span></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#udp-adapters" title="34.2&nbsp;UDP Adapters">Section&nbsp;34.2, &#8220;UDP Adapters&#8221;</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#udp-adapters" title="34.2&nbsp;UDP Adapters">Section&nbsp;34.2, &#8220;UDP Adapters&#8221;</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>N</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>N</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><span class="strong"><strong>Web Services</strong></span></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>N</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>N</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#webservices-inbound" title="37.2&nbsp;Inbound Web Service Gateways">Section&nbsp;37.2, &#8220;Inbound Web Service Gateways&#8221;</a></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#webservices-outbound" title="37.1&nbsp;Outbound Web Service Gateways">Section&nbsp;37.1, &#8220;Outbound Web Service Gateways&#8221;</a></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><span class="strong"><strong>Web Sockets</strong></span></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#web-socket-inbound-adapter" title="36.2&nbsp;WebSocket Inbound Channel Adapter">Section&nbsp;36.2, &#8220;WebSocket Inbound Channel Adapter&#8221;</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#web-socket-outbound-adapter" title="36.3&nbsp;WebSocket Outbound Channel Adapter">Section&nbsp;36.3, &#8220;WebSocket Outbound Channel Adapter&#8221;</a></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>N</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>N</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p><span class="strong"><strong>XMPP</strong></span></p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#xmpp-messages" title="39.2&nbsp;XMPP Messages">Section&nbsp;39.2, &#8220;XMPP Messages&#8221;</a> and <a class="xref" href="#xmpp-presence" title="39.3&nbsp;XMPP Presence">Section&nbsp;39.3, &#8220;XMPP Presence&#8221;</a></p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p><a class="xref" href="#xmpp-messages" title="39.2&nbsp;XMPP Messages">Section&nbsp;39.2, &#8220;XMPP Messages&#8221;</a> and <a class="xref" href="#xmpp-presence" title="39.3&nbsp;XMPP Presence">Section&nbsp;39.3, &#8220;XMPP Presence&#8221;</a></p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>N</p></td><td style="" align="left" valign="top"><p>N</p></td></tr></tbody></table>
</div></div><br class="table-break">
<p>In addition, as discussed in <a class="xref" href="#spring-integration-core-messaging" title="Part&nbsp;IV.&nbsp;Core Messaging">Part&nbsp;IV, &#8220;Core Messaging&#8221;</a>, Spring Integration provides endpoints for interfacing with Plain Old Java Objects (POJOs).
As discussed in <a class="xref" href="#channel-adapter" title="6.3&nbsp;Channel Adapter">Section&nbsp;6.3, &#8220;Channel Adapter&#8221;</a>, the <code class="literal">&lt;int:inbound-channel-adapter&gt;</code> element lets you poll a Java method for data.
The <code class="literal">&lt;int:outbound-channel-adapter&gt;</code> element lets you send data to a <code class="literal">void</code> method.
As discussed in <a class="xref" href="#gateway" title="10.4&nbsp;Messaging Gateways">Section&nbsp;10.4, &#8220;Messaging Gateways&#8221;</a>, the <code class="literal">&lt;int:gateway&gt;</code> element lets any Java program invoke a messaging flow.
Each of these works without requiring any source-level dependencies on Spring Integration.
The equivalent of an outbound gateway in this context is using a service activator (see <a class="xref" href="#service-activator" title="10.5&nbsp;Service Activator">Section&nbsp;10.5, &#8220;Service Activator&#8221;</a>) to invoke a method that returns an <code class="literal">Object</code> of some kind.</p>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="amqp" href="#amqp"></a>14.&nbsp;AMQP Support</h2></div></div></div>

<p>Spring Integration provides channel adapters for receiving and sending messages by using the Advanced Message Queuing Protocol (AMQP).</p>
<p>You need to include this dependency into your project:</p>
<div class="informalexample">
<p>
<b>Maven.&nbsp;</b>

</p><pre class="programlisting"><span class="hl-tag">&lt;dependency&gt;</span>
    <span class="hl-tag">&lt;groupId&gt;</span>org.springframework.integration<span class="hl-tag">&lt;/groupId&gt;</span>
    <span class="hl-tag">&lt;artifactId&gt;</span>spring-integration-amqp<span class="hl-tag">&lt;/artifactId&gt;</span>
    <span class="hl-tag">&lt;version&gt;</span>5.1.2.RELEASE<span class="hl-tag">&lt;/version&gt;</span>
<span class="hl-tag">&lt;/dependency&gt;</span></pre><p>

</p>
<p>
<b>Gradle.&nbsp;</b>

</p><pre class="programlisting">compile <span class="hl-string">"org.springframework.integration:spring-integration-amqp:5.1.2.RELEASE"</span></pre><p>

</p>
</div>
<p>The following adapters are available:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="#amqp-inbound-channel-adapter" title="14.1&nbsp;Inbound Channel Adapter">Inbound Channel Adapter</a>
</li><li class="listitem">
<a class="link" href="#amqp-inbound-gateway" title="14.3&nbsp;Inbound Gateway">Inbound Gateway</a>
</li><li class="listitem">
<a class="link" href="#amqp-outbound-channel-adapter" title="14.5&nbsp;Outbound Channel Adapter">Outbound Channel Adapter</a>
</li><li class="listitem">
<a class="link" href="#amqp-outbound-gateway" title="14.6&nbsp;Outbound Gateway">Outbound Gateway</a>
</li><li class="listitem">
<a class="link" href="#amqp-async-outbound-gateway" title="14.7&nbsp;Asynchronous Outbound Gateway">Async Outbound Gateway</a>
</li></ul></div>
<p>Spring Integration also provides a point-to-point message channel and a publish-subscribe message channel backed by AMQP Exchanges and Queues.</p>
<p>To provide AMQP support, Spring Integration relies on (<a class="ulink" href="http://projects.spring.io/spring-amqp" target="_top">Spring AMQP</a>), which applies core Spring concepts to the development of AMQP-based messaging solutions.
Spring AMQP provides similar semantics to (<a class="ulink" href="http://docs.spring.io/spring/docs/current/spring-framework-reference/html/jms.html" target="_top">Spring JMS</a>).</p>
<p>Whereas the provided AMQP Channel Adapters are intended for unidirectional messaging (send or receive) only, Spring Integration also provides inbound and outbound AMQP gateways for request-reply operations.</p>
<p>TIP:
You should familiarize yourself with the <a class="ulink" href="http://docs.spring.io/spring-amqp/reference/html/" target="_top">reference documentation of the Spring AMQP project</a>.
It provides much more in-depth information about Spring&#8217;s integration with AMQP in general and RabbitMQ in particular.</p>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="amqp-inbound-channel-adapter" href="#amqp-inbound-channel-adapter"></a>14.1&nbsp;Inbound Channel Adapter</h2></div></div></div>

<p>The following listing shows the possible configuration options for an AMQP Inbound Channel Adapter:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-amqp:inbound-channel-adapter</span>
                                  <span class="hl-attribute">id</span>=<span class="hl-value">"inboundAmqp"</span>                <a name="CO18-1" href="#CO18-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
                                  channel="inboundChannel"        <a name="CO18-2" href="#CO18-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
                                  queue-names="si.test.queue"     <a name="CO18-3" href="#CO18-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
                                  acknowledge-mode="AUTO"         <a name="CO18-4" href="#CO18-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
                                  advice-chain=""                 <a name="CO18-5" href="#CO18-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
                                  channel-transacted=""           <a name="CO18-6" href="#CO18-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>
                                  concurrent-consumers=""         <a name="CO18-7" href="#CO18-7"></a><span><img src="images/callouts/7.png" alt="7" border="0"></span>
                                  connection-factory=""           <a name="CO18-8" href="#CO18-8"></a><span><img src="images/callouts/8.png" alt="8" border="0"></span>
                                  error-channel=""                <a name="CO18-9" href="#CO18-9"></a><span><img src="images/callouts/9.png" alt="9" border="0"></span>
                                  expose-listener-channel=""      <a name="CO18-10" href="#CO18-10"></a><span><img src="images/callouts/10.png" alt="10" border="0"></span>
                                  header-mapper=""                <a name="CO18-11" href="#CO18-11"></a><span><img src="images/callouts/11.png" alt="11" border="0"></span>
                                  mapped-request-headers=""       <a name="CO18-12" href="#CO18-12"></a><span><img src="images/callouts/12.png" alt="12" border="0"></span>
                                  listener-container=""           <a name="CO18-13" href="#CO18-13"></a><span><img src="images/callouts/13.png" alt="13" border="0"></span>
                                  message-converter=""            <a name="CO18-14" href="#CO18-14"></a><span><img src="images/callouts/14.png" alt="14" border="0"></span>
                                  message-properties-converter="" <a name="CO18-15" href="#CO18-15"></a><span><img src="images/callouts/15.png" alt="15" border="0"></span>
                                  phase=""                        <a name="CO18-16" href="#CO18-16"></a>(16)
                                  prefetch-count=""               <a name="CO18-17" href="#CO18-17"></a>(17)
                                  receive-timeout=""              <a name="CO18-18" href="#CO18-18"></a>(18)
                                  recovery-interval=""            <a name="CO18-19" href="#CO18-19"></a>(19)
                                  missing-queues-fatal=""         <a name="CO18-20" href="#CO18-20"></a>(20)
                                  shutdown-timeout=""             <a name="CO18-21" href="#CO18-21"></a>(21)
                                  task-executor=""                <a name="CO18-22" href="#CO18-22"></a>(22)
                                  transaction-attribute=""        <a name="CO18-23" href="#CO18-23"></a>(23)
                                  transaction-manager=""          <a name="CO18-24" href="#CO18-24"></a>(24)
                                  tx-size=""                      <a name="CO18-25" href="#CO18-25"></a>(25)
                                  consumers-per-queue /&gt;          <a name="CO18-26" href="#CO18-26"></a>(26)</pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO18-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The unique ID for this adapter.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO18-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Message channel to which converted messages should be sent.
Required.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO18-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Names of the AMQP queues (comma-separated list) from which messages should be consumed.
Required.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO18-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Acknowledge mode for the <code class="literal">MessageListenerContainer</code>.
When set to <code class="literal">MANUAL</code>, the delivery tag and channel are provided in message headers <code class="literal">amqp_deliveryTag</code> and <code class="literal">amqp_channel</code>, respectively.
The user application is responsible for acknowledgement.
<code class="literal">NONE</code> means no acknowledgements (<code class="literal">autoAck</code>).
<code class="literal">AUTO</code> means the adapter&#8217;s container acknowledges when the downstream flow completes.
Optional (defaults to AUTO).
See <a class="xref" href="#amqp-inbound-ack" title="14.4&nbsp;Inbound Endpoint Acknowledge Mode">Section&nbsp;14.4, &#8220;Inbound Endpoint Acknowledge Mode&#8221;</a>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO18-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Extra AOP Advices to handle cross-cutting behavior associated with this inbound channel adapter.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO18-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Flag to indicate that channels created by this component are transactional.
If true, it tells the framework to use a transactional channel and to end all operations (send or receive) with a commit or rollback, depending on the outcome, with an exception that signals a rollback.
Optional (Defaults to false).</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO18-7"><span><img src="images/callouts/7.png" alt="7" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Specify the number of concurrent consumers to create.
The default is <code class="literal">1</code>.
We recommend raising the number of concurrent consumers to scale the consumption of messages coming in from a queue.
However, note that any ordering guarantees are lost once multiple consumers are registered.
In general, use one consumer for low-volume queues.
Not allowed when <span class="emphasis"><em>consumers-per-queue</em></span> is set.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO18-8"><span><img src="images/callouts/8.png" alt="8" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Bean reference to the RabbitMQ <code class="literal">ConnectionFactory</code>.
Optional (defaults to <span class="emphasis"><em>connectionFactory</em></span>).</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO18-9"><span><img src="images/callouts/9.png" alt="9" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Message channel to which error messages should be sent.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO18-10"><span><img src="images/callouts/10.png" alt="10" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Whether the listener channel (com.rabbitmq.client.Channel) is exposed to a registered <code class="literal">ChannelAwareMessageListener</code>.
Optional (defaults to true).</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO18-11"><span><img src="images/callouts/11.png" alt="11" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A reference to an <code class="literal">AmqpHeaderMapper</code> to use when receiving AMQP Messages.
Optional.
By default, only standard AMQP properties (such as <code class="literal">contentType</code>) are copied to Spring Integration <code class="literal">MessageHeaders</code>.
Any user-defined headers within the AMQP <code class="literal">MessageProperties</code> are NOT copied to the message by the default <code class="literal">DefaultAmqpHeaderMapper</code>.
Not allowed if <span class="emphasis"><em>request-header-names</em></span> is provided.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO18-12"><span><img src="images/callouts/12.png" alt="12" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Comma-separated list of the names of AMQP Headers to be mapped from the AMQP request into the <code class="literal">MessageHeaders</code>.
This can only be provided if the <span class="emphasis"><em>header-mapper</em></span> reference is not provided.
The values in this list can also be simple patterns to be matched against the header names (such as "*" or "thing1*, thing2" or "*something").</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO18-13"><span><img src="images/callouts/13.png" alt="13" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Reference to the <code class="literal">AbstractMessageListenerContainer</code> to use for receiving AMQP Messages.
If this attribute is provided, no other attribute related to the listener container configuration should be provided.
In other words, by setting this reference, you must take full responsibility for the listener container configuration.
The only exception is the <code class="literal">MessageListener</code> itself.
Since that is actually the core responsibility of this channel adapter implementation, the referenced listener container must not already have its own <code class="literal">MessageListener</code>.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO18-14"><span><img src="images/callouts/14.png" alt="14" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The <code class="literal">MessageConverter</code> to use when receiving AMQP messages.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO18-15"><span><img src="images/callouts/15.png" alt="15" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The <code class="literal">MessagePropertiesConverter</code> to use when receiving AMQP messages.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO18-16">(16)</a> </p></td><td valign="top" align="left">
<p>Specifies the phase in which the underlying <code class="literal">AbstractMessageListenerContainer</code> should be started and stopped.
The startup order proceeds from lowest to highest, and the shutdown order is the reverse of that.
By default, this value is <code class="literal">Integer.MAX_VALUE</code>, meaning that this container starts as late as possible and stops as soon as possible.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO18-17">(17)</a> </p></td><td valign="top" align="left">
<p>Tells the AMQP broker how many messages to send to each consumer in a single request.
Often, you can set this value high to improve throughput.
It should be greater than or equal to the transaction size (see the <code class="literal">tx-size</code> attribute, later in this list).
Optional (defaults to <code class="literal">1</code>).</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO18-18">(18)</a> </p></td><td valign="top" align="left">
<p>Receive timeout in milliseconds.
Optional (defaults to <code class="literal">1000</code>).</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO18-19">(19)</a> </p></td><td valign="top" align="left">
<p>Specifies the interval between recovery attempts of the underlying <code class="literal">AbstractMessageListenerContainer</code> (in milliseconds).
Optional (defaults to <code class="literal">5000</code>).</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO18-20">(20)</a> </p></td><td valign="top" align="left">
<p>If <span class="emphasis"><em>true</em></span> and none of the queues are available on the broker, the container throws a fatal exception during startup and stops if the queues are deleted when the container is running (after making three attempts to passively declare the queues).
If <code class="literal">false</code>, the container does not throw an exception and goes into recovery mode, attempting to restart according to the <code class="literal">recovery-interval</code>.
Optional (defaults to <code class="literal">true</code>).</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO18-21">(21)</a> </p></td><td valign="top" align="left">
<p>The time to wait for workers (in milliseconds) after the underlying <code class="literal">AbstractMessageListenerContainer</code> is stopped and before the AMQP connection is forced closed.
If any workers are active when the shutdown signal comes, they are allowed to finish processing as long as they can finish within this timeout.
Otherwise, the connection is closed and messages remain unacknowledged (if the channel is transactional).
Optional (defaults to <code class="literal">5000</code>).</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO18-22">(22)</a> </p></td><td valign="top" align="left">
<p>By default, the underlying <code class="literal">AbstractMessageListenerContainer</code> uses a <code class="literal">SimpleAsyncTaskExecutor</code> implementation, that fires up a new thread for each task, running it asynchronously.
By default, the number of concurrent threads is unlimited.
Note that this implementation does not reuse threads.
Consider using a thread-pooling <code class="literal">TaskExecutor</code> implementation as an alternative.
Optional (defaults to <code class="literal">SimpleAsyncTaskExecutor</code>).</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO18-23">(23)</a> </p></td><td valign="top" align="left">
<p>By default, the underlying <code class="literal">AbstractMessageListenerContainer</code> creates a new instance of the <code class="literal">DefaultTransactionAttribute</code> (it takes the EJB approach to rolling back on runtime but not checked exceptions).
Optional (defaults to <code class="literal">DefaultTransactionAttribute</code>).</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO18-24">(24)</a> </p></td><td valign="top" align="left">
<p>Sets a bean reference to an external <code class="literal">PlatformTransactionManager</code> on the underlying <code class="literal">AbstractMessageListenerContainer</code>.
The transaction manager works in conjunction with the <code class="literal">channel-transacted</code> attribute.
If there is already a transaction in progress when the framework is sending or receiving a message and the <code class="literal">channelTransacted</code> flag is <code class="literal">true</code>, the commit or rollback of the messaging transaction is deferred until the end of the current transaction.
If the <code class="literal">channelTransacted</code> flag is <code class="literal">false</code>, no transaction semantics apply to the messaging operation (it is auto-acked).
For further information, see
<a class="ulink" href="http://docs.spring.io/spring-amqp/reference/html/%5Freference.html#%5Ftransactions" target="_top">Transactions with Spring AMQP</a>.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO18-25">(25)</a> </p></td><td valign="top" align="left">
<p>Tells the <code class="literal">SimpleMessageListenerContainer</code> how many messages to process in a single transaction (if the channel is transactional).
For best results, it should be less than or equal to the value set in <code class="literal">prefetch-count</code>.
Not allowed when <span class="emphasis"><em>consumers-per-queue</em></span> is set.
Optional (defaults to <code class="literal">1</code>).</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO18-26">(26)</a> </p></td><td valign="top" align="left">
<p>Indicates that the underlying listener container should be a <code class="literal">DirectMessageListenerContainer</code> instead of the default <code class="literal">SimpleMessageListenerContainer</code>.
See the <a class="ulink" href="https://docs.spring.io/spring-amqp/reference/html/" target="_top">Spring AMQP Reference Manual</a> for more information.</p>
</td></tr></table></div>
</div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note: container"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">container</th></tr><tr><td align="left" valign="top">

<p>Note that when configuring an external container, you cannot use the Spring AMQP namespace to define the container.
This is because the namespace requires at least one <code class="literal">&lt;listener/&gt;</code> element.
In this environment, the listener is internal to the adapter.
For this reason, you must define the container by using a normal Spring <code class="literal">&lt;bean/&gt;</code> definition, as the following example shows:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"container"</span>
 <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.amqp.rabbit.listener.SimpleMessageListenerContainer"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"connectionFactory"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"connectionFactory"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"queueNames"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"aName.queue"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"defaultRequeueRejected"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"false"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
</td></tr></table></div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Even though the Spring Integration JMS and AMQP support is similar, important differences exist.
The JMS inbound channel adapter is using a <code class="literal">JmsDestinationPollingSource</code> under the covers and expects a configured poller.
The AMQP inbound channel adapter uses an <code class="literal">AbstractMessageListenerContainer</code> and is message driven.
In that regard, it is more similar to the JMS message-driven channel adapter.</p>
</td></tr></table></div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_with_java_configuration" href="#_configuring_with_java_configuration"></a>14.1.1&nbsp;Configuring with Java Configuration</h3></div></div></div>

<p>The following Spring Boot application shows an example of configuring the inbound adapter with Java configuration:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@SpringBootApplication</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> AmqpJavaApplication {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
        <span class="hl-keyword">new</span> SpringApplicationBuilder(AmqpJavaApplication.<span class="hl-keyword">class</span>)
            .web(false)
            .run(args);
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> MessageChannel amqpInputChannel() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> DirectChannel();
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> AmqpInboundChannelAdapter inbound(SimpleMessageListenerContainer listenerContainer,
            <em><span class="hl-annotation" style="color: gray">@Qualifier("amqpInputChannel")</span></em> MessageChannel channel) {
        AmqpInboundChannelAdapter adapter = <span class="hl-keyword">new</span> AmqpInboundChannelAdapter(listenerContainer);
        adapter.setOutputChannel(channel);
        <span class="hl-keyword">return</span> adapter;
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> SimpleMessageListenerContainer container(ConnectionFactory connectionFactory) {
        SimpleMessageListenerContainer container =
                                   <span class="hl-keyword">new</span> SimpleMessageListenerContainer(connectionFactory);
        container.setQueueNames(<span class="hl-string">"aName"</span>);
        container.setConcurrentConsumers(<span class="hl-number">2</span>);
        <span class="hl-comment">// ...</span>
        <span class="hl-keyword">return</span> container;
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "amqpInputChannel")</span></em>
    <span class="hl-keyword">public</span> MessageHandler handler() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> MessageHandler() {

            <em><span class="hl-annotation" style="color: gray">@Override</span></em>
            <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> handleMessage(Message&lt;?&gt; message) <span class="hl-keyword">throws</span> MessagingException {
                System.out.println(message.getPayload());
            }

        };
    }

}</pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_with_the_java_dsl_2" href="#_configuring_with_the_java_dsl_2"></a>14.1.2&nbsp;Configuring with the Java DSL</h3></div></div></div>

<p>The following Spring Boot application provides an example of configuring the inbound adapter with the Java DSL:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@SpringBootApplication</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> AmqpJavaApplication {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
        <span class="hl-keyword">new</span> SpringApplicationBuilder(AmqpJavaApplication.<span class="hl-keyword">class</span>)
            .web(false)
            .run(args);
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> IntegrationFlow amqpInbound(ConnectionFactory connectionFactory) {
        <span class="hl-keyword">return</span> IntegrationFlows.from(Amqp.inboundAdapter(connectionFactory, <span class="hl-string">"aName"</span>))
                .handle(m -&gt; System.out.println(m.getPayload()))
                .get();
    }

}</pre>
</div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_polled_inbound_channel_adapter" href="#_polled_inbound_channel_adapter"></a>14.2&nbsp;Polled Inbound Channel Adapter</h2></div></div></div>

<p>Version 5.0.1 introduced a polled channel adapter, letting you fetch individual messages on demand&#8201;&#8212;&#8201;for example, with a <code class="literal">MessageSourcePollingTemplate</code> or a poller.
See <a class="xref" href="#deferred-acks-message-source" title="6.2.3&nbsp;Deferred Acknowledgment Pollable Message Source">Section&nbsp;6.2.3, &#8220;Deferred Acknowledgment Pollable Message Source&#8221;</a> for more information.</p>
<p>It does not currently support XML configuration.</p>
<p>The following example shows how to configure an <code class="literal">AmqpMessageSource</code> with Java configuration:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> AmqpMessageSource source(ConnectionFactory connectionFactory) {
    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> AmpqpMessageSource(connectionFactory, <span class="hl-string">"someQueue"</span>);
}</pre>
</div>
<p>See the <a class="ulink" href="https://docs.spring.io/spring-integration/api/org/springframework/integration/amqp/inbound/AmqpMessageSource.html" target="_top">Javadoc</a> for configuration properties.</p>
<p>The following example shows how to configure an <code class="literal">inboundPolledAdapter</code> with the Java DSL:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> IntegrationFlow flow() {
    <span class="hl-keyword">return</span> IntegrationFlows.from(Amqp.inboundPolledAdapter(connectionFactory(), DSL_QUEUE),
                    e -&gt; e.poller(Pollers.fixedDelay(<span class="hl-number">1</span>_<span class="hl-number">000</span>)).autoStartup(false))
            .handle(p -&gt; {
                ...
            })
            .get();
}</pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="amqp-inbound-gateway" href="#amqp-inbound-gateway"></a>14.3&nbsp;Inbound Gateway</h2></div></div></div>

<p>The inbound gateway supports all the attributes on the inbound channel adapter (except that <span class="emphasis"><em>channel</em></span> is replaced by <span class="emphasis"><em>request-channel</em></span>), plus some additional attributes.
The following listing shows the available attributes:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-amqp:inbound-gateway</span>
                          <span class="hl-attribute">id</span>=<span class="hl-value">"inboundGateway"</span>                <a name="CO19-1" href="#CO19-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
                          request-channel="myRequestChannel" <a name="CO19-2" href="#CO19-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
                          header-mapper=""                   <a name="CO19-3" href="#CO19-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
                          mapped-request-headers=""          <a name="CO19-4" href="#CO19-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
                          mapped-reply-headers=""            <a name="CO19-5" href="#CO19-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
                          reply-channel="myReplyChannel"     <a name="CO19-6" href="#CO19-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>
                          reply-timeout="1000"               <a name="CO19-7" href="#CO19-7"></a><span><img src="images/callouts/7.png" alt="7" border="0"></span>
                          amqp-template=""                   <a name="CO19-8" href="#CO19-8"></a><span><img src="images/callouts/8.png" alt="8" border="0"></span>
                          default-reply-to="" /&gt;             <a name="CO19-9" href="#CO19-9"></a><span><img src="images/callouts/9.png" alt="9" border="0"></span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO19-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The Unique ID for this adapter.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO19-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Message channel to which converted messages are sent.
Required.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO19-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A reference to an <code class="literal">AmqpHeaderMapper</code> to use when receiving AMQP Messages.
Optional.
By default, only standard AMQP properties (such as <code class="literal">contentType</code>) are copied to and from Spring Integration <code class="literal">MessageHeaders</code>.
Any user-defined headers within the AMQP <code class="literal">MessageProperties</code> are not copied to or from an AMQP message by the default <code class="literal">DefaultAmqpHeaderMapper</code>.
Not allowed if <span class="emphasis"><em>request-header-names</em></span> or <span class="emphasis"><em>reply-header-names</em></span> is provided.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO19-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Comma-separated list of names of AMQP Headers to be mapped from the AMQP request into the <code class="literal">MessageHeaders</code>.
This attribute can be provided only if the <span class="emphasis"><em>header-mapper</em></span> reference is not provided.
The values in this list can also be simple patterns to be matched against the header names (e.g. <code class="literal">"\*"</code> or <code class="literal">"thing1*, thing2"</code> or <code class="literal">"*thing1"</code>).</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO19-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Comma-separated list of names of <code class="literal">MessageHeaders</code> to be mapped into the AMQP message properties of the AMQP reply message.
All standard Headers (such as <code class="literal">contentType</code>) are mapped to AMQP Message Properties, while user-defined headers are mapped to the <span class="emphasis"><em>headers</em></span> property.
This attribute can only be provided if the <span class="emphasis"><em>header-mapper</em></span> reference is not provided.
The values in this list can also be simple patterns to be matched against the header names (for example, <code class="literal">"\*"</code> or <code class="literal">"foo*, bar"</code> or <code class="literal">"*foo"</code>).</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO19-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Message Channel where reply Messages are expected.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO19-7"><span><img src="images/callouts/7.png" alt="7" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Sets the <code class="literal">receiveTimeout</code> on the underlying <code class="literal">o.s.i.core.MessagingTemplate</code> for receiving messages from the reply channel.
If not specified, this property defaults to <code class="literal">1000</code> (1 second).
Only applies if the container thread hands off to another thread before the reply is sent.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO19-8"><span><img src="images/callouts/8.png" alt="8" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The customized <code class="literal">AmqpTemplate</code> bean reference (to have more control over the reply messages to send).
You can provide an alternative implementation to the <code class="literal">RabbitTemplate</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO19-9"><span><img src="images/callouts/9.png" alt="9" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The <code class="literal">replyTo</code> <code class="literal">o.s.amqp.core.Address</code> to be used when the <code class="literal">requestMessage</code> does not have a <code class="literal">replyTo</code>
property.
If this option is not specified, no <code class="literal">amqp-template</code> is provided, no <code class="literal">replyTo</code> property exists in the request message, and
an <code class="literal">IllegalStateException</code> is thrown because the reply cannot be routed.
If this option is not specified and an external <code class="literal">amqp-template</code> is provided, no exception is thrown.
You must either specify this option or configure a default <code class="literal">exchange</code> and <code class="literal">routingKey</code> on that template,
if you anticipate cases when no <code class="literal">replyTo</code> property exists in the request message.</p>
</td></tr></table></div>
<p>See the note in <a class="xref" href="#amqp-inbound-channel-adapter" title="14.1&nbsp;Inbound Channel Adapter">Section&nbsp;14.1, &#8220;Inbound Channel Adapter&#8221;</a> about configuring the <code class="literal">listener-container</code> attribute.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_with_java_configuration_2" href="#_configuring_with_java_configuration_2"></a>14.3.1&nbsp;Configuring with Java Configuration</h3></div></div></div>

<p>The following Spring Boot application shows an example of how to configure the inbound gateway with Java configuration:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@SpringBootApplication</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> AmqpJavaApplication {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
        <span class="hl-keyword">new</span> SpringApplicationBuilder(AmqpJavaApplication.<span class="hl-keyword">class</span>)
            .web(false)
            .run(args);
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> MessageChannel amqpInputChannel() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> DirectChannel();
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> AmqpInboundGateway inbound(SimpleMessageListenerContainer listenerContainer,
            <em><span class="hl-annotation" style="color: gray">@Qualifier("amqpInputChannel")</span></em> MessageChannel channel) {
        AmqpInboundGateway gateway = <span class="hl-keyword">new</span> AmqpInboundGateway(listenerContainer);
        gateway.setRequestChannel(channel);
        gateway.setDefaultReplyTo(<span class="hl-string">"bar"</span>);
        <span class="hl-keyword">return</span> gateway;
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> SimpleMessageListenerContainer container(ConnectionFactory connectionFactory) {
        SimpleMessageListenerContainer container =
                        <span class="hl-keyword">new</span> SimpleMessageListenerContainer(connectionFactory);
        container.setQueueNames(<span class="hl-string">"foo"</span>);
        container.setConcurrentConsumers(<span class="hl-number">2</span>);
        <span class="hl-comment">// ...</span>
        <span class="hl-keyword">return</span> container;
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "amqpInputChannel")</span></em>
    <span class="hl-keyword">public</span> MessageHandler handler() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> AbstractReplyProducingMessageHandler() {

            <em><span class="hl-annotation" style="color: gray">@Override</span></em>
            <span class="hl-keyword">protected</span> Object handleRequestMessage(Message&lt;?&gt; requestMessage) {
                <span class="hl-keyword">return</span> <span class="hl-string">"reply to "</span> + requestMessage.getPayload();
            }

        };
    }

}</pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_with_the_java_dsl_3" href="#_configuring_with_the_java_dsl_3"></a>14.3.2&nbsp;Configuring with the Java DSL</h3></div></div></div>

<p>The following Spring Boot application shows an example of how to configure the inbound gateway with the Java DSL:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@SpringBootApplication</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> AmqpJavaApplication {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
        <span class="hl-keyword">new</span> SpringApplicationBuilder(AmqpJavaApplication.<span class="hl-keyword">class</span>)
            .web(false)
            .run(args);
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em> <span class="hl-comment">// return the upper cased payload</span>
    <span class="hl-keyword">public</span> IntegrationFlow amqpInboundGateway(ConnectionFactory connectionFactory) {
        <span class="hl-keyword">return</span> IntegrationFlows.from(Amqp.inboundGateway(connectionFactory, <span class="hl-string">"foo"</span>))
                .transform(String.<span class="hl-keyword">class</span>, String::toUpperCase)
                .get();
    }

}</pre>
</div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="amqp-inbound-ack" href="#amqp-inbound-ack"></a>14.4&nbsp;Inbound Endpoint Acknowledge Mode</h2></div></div></div>

<p>By default, the inbound endpoints use the <code class="literal">AUTO</code> acknowledge mode, which means the container automatically acknowledges the message when the downstream integration flow completes (or a message is handed off to another thread by using a <code class="literal">QueueChannel</code> or <code class="literal">ExecutorChannel</code>).
Setting the mode to <code class="literal">NONE</code> configures the consumer such that acknowledgments are not used at all (the broker automatically acknowledges the message as soon as it is sent).
Setting the mode to <code class="literal">MANUAL</code> lets user code acknowledge the message at some other point during processing.
To support this, with this mode, the endpoints provide the <code class="literal">Channel</code> and <code class="literal">deliveryTag</code> in the <code class="literal">amqp_channel</code> and <code class="literal">amqp_deliveryTag</code> headers, respectively.</p>
<p>You can perform any valid Rabbit command on the <code class="literal">Channel</code> but, generally, only <code class="literal">basicAck</code> and <code class="literal">basicNack</code> (or <code class="literal">basicReject</code>) are used.
In order to not interfere with the operation of the container, you should not retain a reference to the channel and use it only in the context of the current message.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Since the <code class="literal">Channel</code> is a reference to a "<code class="literal">live</code>" object, it cannot be serialized and is lost if a message is persisted.</p>
</td></tr></table></div>
<p>The following example shows how you might use <code class="literal">MANUAL</code> acknowledgement:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "foo", outputChannel = "bar")</span></em>
<span class="hl-keyword">public</span> Object handle(<em><span class="hl-annotation" style="color: gray">@Payload</span></em> String payload, <em><span class="hl-annotation" style="color: gray">@Header(AmqpHeaders.CHANNEL)</span></em> Channel channel,
        <em><span class="hl-annotation" style="color: gray">@Header(AmqpHeaders.DELIVERY_TAG)</span></em> Long deliveryTag) <span class="hl-keyword">throws</span> Exception {

    <span class="hl-comment">// Do some processing</span>

    <span class="hl-keyword">if</span> (allOK) {
        channel.basicAck(deliveryTag, false);

        <span class="hl-comment">// perhaps do some more processing</span>

    }
    <span class="hl-keyword">else</span> {
        channel.basicNack(deliveryTag, false, true);
    }
    <span class="hl-keyword">return</span> someResultForDownStreamProcessing;
}</pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="amqp-outbound-channel-adapter" href="#amqp-outbound-channel-adapter"></a>14.5&nbsp;Outbound Channel Adapter</h2></div></div></div>

<p>The following example shows the available properties for an AMQP outbound channel adapter:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-amqp:outbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"outboundAmqp"</span>             <a name="CO20-1" href="#CO20-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
                               channel="outboundChannel"         <a name="CO20-2" href="#CO20-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
                               amqp-template="myAmqpTemplate"    <a name="CO20-3" href="#CO20-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
                               exchange-name=""                  <a name="CO20-4" href="#CO20-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
                               exchange-name-expression=""       <a name="CO20-5" href="#CO20-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
                               order="1"                         <a name="CO20-6" href="#CO20-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>
                               routing-key=""                    <a name="CO20-7" href="#CO20-7"></a><span><img src="images/callouts/7.png" alt="7" border="0"></span>
                               routing-key-expression=""         <a name="CO20-8" href="#CO20-8"></a><span><img src="images/callouts/8.png" alt="8" border="0"></span>
                               default-delivery-mode""           <a name="CO20-9" href="#CO20-9"></a><span><img src="images/callouts/9.png" alt="9" border="0"></span>
                               confirm-correlation-expression="" <a name="CO20-10" href="#CO20-10"></a><span><img src="images/callouts/10.png" alt="10" border="0"></span>
                               confirm-ack-channel=""            <a name="CO20-11" href="#CO20-11"></a><span><img src="images/callouts/11.png" alt="11" border="0"></span>
                               confirm-nack-channel=""           <a name="CO20-12" href="#CO20-12"></a><span><img src="images/callouts/12.png" alt="12" border="0"></span>
                               return-channel=""                 <a name="CO20-13" href="#CO20-13"></a><span><img src="images/callouts/13.png" alt="13" border="0"></span>
                               error-message-strategy=""         <a name="CO20-14" href="#CO20-14"></a><span><img src="images/callouts/14.png" alt="14" border="0"></span>
                               header-mapper=""                  <a name="CO20-15" href="#CO20-15"></a><span><img src="images/callouts/15.png" alt="15" border="0"></span>
                               mapped-request-headers=""         <a name="CO20-16" href="#CO20-16"></a>(16)
                               lazy-connect="true" /&gt;            <a name="CO20-17" href="#CO20-17"></a>(17)</pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO20-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The unique ID for this adapter.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO20-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Message channel to which messages should be sent to have them converted and published to an AMQP exchange.
Required.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO20-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Bean reference to the configured AMQP template.
Optional (defaults to <code class="literal">amqpTemplate</code>).</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO20-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The name of the AMQP exchange to which messages are sent.
If not provided, messages are sent to the default, no-name exchange.
Mutually exclusive with <span class="emphasis"><em>exchange-name-expression</em></span>.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO20-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A SpEL expression that is evaluated to determine the name of the AMQP exchange to which messages are sent, with the message as the root object.
If not provided, messages are sent to the default, no-name exchange.
Mutually exclusive with <span class="emphasis"><em>exchange-name</em></span>.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO20-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The order for this consumer when multiple consumers are registered, thereby enabling load-balancing and failover.
Optional (defaults to <code class="literal">Ordered.LOWEST_PRECEDENCE [=Integer.MAX_VALUE]</code>).</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO20-7"><span><img src="images/callouts/7.png" alt="7" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The fixed routing-key to use when sending messages.
By default, this is an empty <code class="literal">String</code>.
Mutually exclusive with <span class="emphasis"><em>routing-key-expression</em></span>.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO20-8"><span><img src="images/callouts/8.png" alt="8" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A SpEL expression that is evaluated to determine the routing key to use when sending messages, with the message as the root object (for example, <span class="emphasis"><em>payload.key</em></span>).
By default, this is an empty <code class="literal">String</code>.
Mutually exclusive with <span class="emphasis"><em>routing-key</em></span>.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO20-9"><span><img src="images/callouts/9.png" alt="9" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The default delivery mode for messages: <code class="literal">PERSISTENT</code> or <code class="literal">NON_PERSISTENT</code>.
Overridden if the <code class="literal">header-mapper</code> sets the delivery mode.
If the Spring Integration message header <code class="literal">amqp_deliveryMode</code> is present, the <code class="literal">DefaultHeaderMapper</code> sets the value.
If this attribute is not supplied and the header mapper does not set it, the default depends on the underlying Spring AMQP <code class="literal">MessagePropertiesConverter</code> used by the <code class="literal">RabbitTemplate</code>.
If that is not customized at all, the default is <code class="literal">PERSISTENT</code>.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO20-10"><span><img src="images/callouts/10.png" alt="10" border="0"></span></a> </p></td><td valign="top" align="left">
<p>An expression that defines correlation data.
When provided, this configures the underlying AMQP template to receive publisher confirmations.
Requires a dedicated <code class="literal">RabbitTemplate</code> and a <code class="literal">CachingConnectionFactory</code> with the <code class="literal">publisherConfirms</code> property set to
<code class="literal">true</code>. When a publisher confirmation is received and correlation data is supplied, it is written to either the
<code class="literal">confirm-ack-channel</code> or the <code class="literal">confirm-nack-channel</code>, depending on the confirmation type. The payload of the confirmation is
the correlation data, as defined by this expression.
The message has an <span class="emphasis"><em>amqp_publishConfirm</em></span> header set to <code class="literal">true</code> (<code class="literal">ack</code>) or <code class="literal">false</code> (<code class="literal">nack</code>).
Examples: <code class="literal">headers['myCorrelationData']</code> and <code class="literal">payload</code>.
Version 4.1 introduced the <code class="literal">amqp_publishConfirmNackCause</code> message header.
It contains the <code class="literal">cause</code> of a <span class="emphasis"><em>nack</em></span> for a publisher confirmation.
Starting with version 4.2, if the expression resolves to a <code class="literal">Message&lt;?&gt;</code> instance (such as <code class="literal">#this</code>), the message
emitted on the <code class="literal">ack</code>/<code class="literal">nack</code> channel is based on that message, with the additional header(s) added.
Previously, a new message was created with the correlation data as its payload, regardless of type.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO20-11"><span><img src="images/callouts/11.png" alt="11" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The channel to which positive (<code class="literal">ack</code>) publisher confirms are sent.
The payload is the correlation data defined by the <code class="literal">confirm-correlation-expression</code>.
If the expression is <code class="literal">#root</code> or <code class="literal">#this</code>, the message is built from the original message, with the <code class="literal">amqp_publishConfirm</code> header set to <code class="literal">true</code>.
Optional (the default is <code class="literal">nullChannel</code>).</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO20-12"><span><img src="images/callouts/12.png" alt="12" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The channel to which negative (<code class="literal">nack</code>) publisher confirmations are sent.
The payload is the correlation data defined by the <code class="literal">confirm-correlation-expression</code> (if there is no <code class="literal">ErrorMessageStrategy</code> configured).
If the expression is <code class="literal">#root</code> or <code class="literal">#this</code>, the message is built from the original message, with the <code class="literal">amqp_publishConfirm</code> header set to <code class="literal">false</code>.
When there is an <code class="literal">ErrorMessageStrategy</code>, the message is an <code class="literal">ErrorMessage</code> with a <code class="literal">NackedAmqpMessageException</code> payload.
Optional (the default is <code class="literal">nullChannel</code>).</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO20-13"><span><img src="images/callouts/13.png" alt="13" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The channel to which returned messages are sent.
When provided, the underlying AMQP template is configured to return undeliverable messages to the adapter.
When there is no <code class="literal">ErrorMessageStrategy</code> configured, the message is constructed from the data received from AMQP, with the following additional headers: <code class="literal">amqp_returnReplyCode</code>, <code class="literal">amqp_returnReplyText</code>, <code class="literal">amqp_returnExchange</code>, <code class="literal">amqp_returnRoutingKey</code>.
When there is an <code class="literal">ErrorMessageStrategy</code>, the message is an <code class="literal">ErrorMessage</code> with a <code class="literal">ReturnedAmqpMessageException</code> payload.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO20-14"><span><img src="images/callouts/14.png" alt="14" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A reference to an <code class="literal">ErrorMessageStrategy</code> implementation used to build <code class="literal">ErrorMessage</code> instances when sending returned or negatively acknowledged messages.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO20-15"><span><img src="images/callouts/15.png" alt="15" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A reference to an <code class="literal">AmqpHeaderMapper</code> to use when sending AMQP Messages.
By default, only standard AMQP properties (such as <code class="literal">contentType</code>) are copied to the Spring Integration <code class="literal">MessageHeaders</code>.
Any user-defined headers is not copied to the message by the default`DefaultAmqpHeaderMapper`.
Not allowed if <span class="emphasis"><em>request-header-names</em></span> is provided.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO20-16">(16)</a> </p></td><td valign="top" align="left">
<p>Comma-separated list of names of AMQP Headers to be mapped from the <code class="literal">MessageHeaders</code> to the AMQP Message.
Not allowed if the <span class="emphasis"><em>header-mapper</em></span> reference is provided.
The values in this list can also be simple patterns to be matched against the header names (e.g. <code class="literal">"\*"</code> or <code class="literal">"thing1*, thing2"</code> or <code class="literal">"*thing1"</code>).</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO20-17">(17)</a> </p></td><td valign="top" align="left">
<p>When set to <code class="literal">false</code>, the endpoint attempts to connect to the broker during application context initialization.
This allows "<code class="literal">fail fast</code>" detection of bad configuration but also causes initialization to fail if the broker is down.
When <code class="literal">true</code> (the default), the connection is established (if it does not already exist because some other component established it) when the first message is sent.</p>
</td></tr></table></div>
</div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important: return-channel"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">return-channel</th></tr><tr><td align="left" valign="top">

<p>Using a <code class="literal">return-channel</code> requires a <code class="literal">RabbitTemplate</code> with the <code class="literal">mandatory</code> property set to <code class="literal">true</code> and a <code class="literal">CachingConnectionFactory</code> with the <code class="literal">publisherReturns</code> property set to <code class="literal">true</code>.
When using multiple outbound endpoints with returns, a separate <code class="literal">RabbitTemplate</code> is needed for each endpoint.</p>
</td></tr></table></div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_with_java_configuration_3" href="#_configuring_with_java_configuration_3"></a>14.5.1&nbsp;Configuring with Java Configuration</h3></div></div></div>

<p>The following Spring Boot application shows an example of how to configure the outbound adapter with Java configuration:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@SpringBootApplication</span></em>
<em><span class="hl-annotation" style="color: gray">@IntegrationComponentScan</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> AmqpJavaApplication {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
         ConfigurableApplicationContext context =
              <span class="hl-keyword">new</span> SpringApplicationBuilder(AmqpJavaApplication.<span class="hl-keyword">class</span>)
                       .web(false)
                       .run(args);
         MyGateway gateway = context.getBean(MyGateway.<span class="hl-keyword">class</span>);
         gateway.sendToRabbit(<span class="hl-string">"foo"</span>);
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "amqpOutboundChannel")</span></em>
    <span class="hl-keyword">public</span> AmqpOutboundEndpoint amqpOutbound(AmqpTemplate amqpTemplate) {
        AmqpOutboundEndpoint outbound = <span class="hl-keyword">new</span> AmqpOutboundEndpoint(amqpTemplate);
        outbound.setRoutingKey(<span class="hl-string">"foo"</span>); <span class="hl-comment">// default exchange - route to queue 'foo'</span>
        <span class="hl-keyword">return</span> outbound;
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> MessageChannel amqpOutboundChannel() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> DirectChannel();
    }

    <em><span class="hl-annotation" style="color: gray">@MessagingGateway(defaultRequestChannel = "amqpOutboundChannel")</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> MyGateway {

        <span class="hl-keyword">void</span> sendToRabbit(String data);

    }

}</pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_with_the_java_dsl_4" href="#_configuring_with_the_java_dsl_4"></a>14.5.2&nbsp;Configuring with the Java DSL</h3></div></div></div>

<p>The following Spring Boot application shows an example of how to configure the outbound adapter with the Java DSL:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@SpringBootApplication</span></em>
<em><span class="hl-annotation" style="color: gray">@IntegrationComponentScan</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> AmqpJavaApplication {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
         ConfigurableApplicationContext context =
                  <span class="hl-keyword">new</span> SpringApplicationBuilder(AmqpJavaApplication.<span class="hl-keyword">class</span>)
                          .web(false)
                          .run(args);
         MyGateway gateway = context.getBean(MyGateway.<span class="hl-keyword">class</span>);
         gateway.sendToRabbit(<span class="hl-string">"foo"</span>);
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> IntegrationFlow amqpOutbound(AmqpTemplate amqpTemplate) {
        <span class="hl-keyword">return</span> IntegrationFlows.from(amqpOutboundChannel())
                .handle(Amqp.outboundAdapter(amqpTemplate)
                            .routingKey(<span class="hl-string">"foo"</span>)) <span class="hl-comment">// default exchange - route to queue 'foo'</span>
                .get();
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> MessageChannel amqpOutboundChannel() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> DirectChannel();
    }

    <em><span class="hl-annotation" style="color: gray">@MessagingGateway(defaultRequestChannel = "amqpOutboundChannel")</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> MyGateway {

        <span class="hl-keyword">void</span> sendToRabbit(String data);

    }
}</pre>
</div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="amqp-outbound-gateway" href="#amqp-outbound-gateway"></a>14.6&nbsp;Outbound Gateway</h2></div></div></div>

<p>The following listing shows the possible properties for an AMQP Outbound Gateway:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-amqp:outbound-gateway</span> <span class="hl-attribute">id</span>=<span class="hl-value">"inboundGateway"</span>                <a name="CO21-1" href="#CO21-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
                           request-channel="myRequestChannel" <a name="CO21-2" href="#CO21-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
                           amqp-template=""                   <a name="CO21-3" href="#CO21-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
                           exchange-name=""                   <a name="CO21-4" href="#CO21-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
                           exchange-name-expression=""        <a name="CO21-5" href="#CO21-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
                           order="1"                          <a name="CO21-6" href="#CO21-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>
                           reply-channel=""                   <a name="CO21-7" href="#CO21-7"></a><span><img src="images/callouts/7.png" alt="7" border="0"></span>
                           reply-timeout=""                   <a name="CO21-8" href="#CO21-8"></a><span><img src="images/callouts/8.png" alt="8" border="0"></span>
                           requires-reply=""                  <a name="CO21-9" href="#CO21-9"></a><span><img src="images/callouts/9.png" alt="9" border="0"></span>
                           routing-key=""                     <a name="CO21-10" href="#CO21-10"></a><span><img src="images/callouts/10.png" alt="10" border="0"></span>
                           routing-key-expression=""          <a name="CO21-11" href="#CO21-11"></a><span><img src="images/callouts/11.png" alt="11" border="0"></span>
                           default-delivery-mode""            <a name="CO21-12" href="#CO21-12"></a><span><img src="images/callouts/12.png" alt="12" border="0"></span>
                           confirm-correlation-expression=""  <a name="CO21-13" href="#CO21-13"></a><span><img src="images/callouts/13.png" alt="13" border="0"></span>
                           confirm-ack-channel=""             <a name="CO21-14" href="#CO21-14"></a><span><img src="images/callouts/14.png" alt="14" border="0"></span>
                           confirm-nack-channel=""            <a name="CO21-15" href="#CO21-15"></a><span><img src="images/callouts/15.png" alt="15" border="0"></span>
                           return-channel=""                  <a name="CO21-16" href="#CO21-16"></a>(16)
                           error-message-strategy=""          <a name="CO21-17" href="#CO21-17"></a>(17)
                           lazy-connect="true" /&gt;             <a name="CO21-18" href="#CO21-18"></a>(18)</pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO21-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The unique ID for this adapter.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO21-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Message channel to which messages are sent to have them converted and published to an AMQP exchange.
Required.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO21-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Bean reference to the configured AMQP template.
Optional (defaults to <code class="literal">amqpTemplate</code>).</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO21-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The name of the AMQP exchange to which messages should be sent.
If not provided, messages are sent to the default, no-name cxchange.
Mutually exclusive with <span class="emphasis"><em>exchange-name-expression</em></span>.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO21-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A SpEL expression that is evaluated to determine the name of the AMQP exchange to which messages should be sent, with the message as the root object.
If not provided, messages are sent to the default, no-name exchange.
Mutually exclusive with <span class="emphasis"><em>exchange-name</em></span>.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO21-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The order for this consumer when multiple consumers are registered, thereby enabling load-balancing and failover.
Optional (defaults to <code class="literal">Ordered.LOWEST_PRECEDENCE [=Integer.MAX_VALUE]</code>).</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO21-7"><span><img src="images/callouts/7.png" alt="7" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Message channel to which replies should be sent after being received from an AMQP queue and converted.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO21-8"><span><img src="images/callouts/8.png" alt="8" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The time the gateway waits when sending the reply message to the <code class="literal">reply-channel</code>.
This only applies if the <code class="literal">reply-channel</code> can block&#8201;&#8212;&#8201;such as a <code class="literal">QueueChannel</code> with a capacity limit that is currently full.
Defaults to infinity.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO21-9"><span><img src="images/callouts/9.png" alt="9" border="0"></span></a> </p></td><td valign="top" align="left">
<p>When <code class="literal">true</code>, the gateway throws an exception if no reply message is received within the <code class="literal">AmqpTemplate</code>'s <code class="literal">replyTimeout</code> property.
Defaults to <code class="literal">true</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO21-10"><span><img src="images/callouts/10.png" alt="10" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The <code class="literal">routing-key</code> to use when sending messages.
By default, this is an empty <code class="literal">String</code>.
Mutually exclusive with <span class="emphasis"><em>routing-key-expression</em></span>.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO21-11"><span><img src="images/callouts/11.png" alt="11" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A SpEL expression that is evaluated to determine the <code class="literal">routing-key</code> to use when sending messages, with the message as the root object (for example, <span class="emphasis"><em>payload.key</em></span>).
By default, this is an empty <code class="literal">String</code>.
Mutually exclusive with <span class="emphasis"><em>routing-key</em></span>.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO21-12"><span><img src="images/callouts/12.png" alt="12" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The default delivery mode for messages: <code class="literal">PERSISTENT</code> or <code class="literal">NON_PERSISTENT</code>.
Overridden if the <code class="literal">header-mapper</code> sets the delivery mode.
If the Spring Integration message header <code class="literal">amqp_deliveryMode</code> is present, the <code class="literal">DefaultHeaderMapper</code> sets the value.
If this attribute is not supplied and the header mapper does not set it, the default depends on the underlying Spring AMQP <code class="literal">MessagePropertiesConverter</code> used by the <code class="literal">RabbitTemplate</code>.
If that is not customized at all, the default is <code class="literal">PERSISTENT</code>.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO21-13"><span><img src="images/callouts/13.png" alt="13" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Since version 4.2.
An expression defining correlation data.
When provided, this configures the underlying AMQP template to receive publisher confirms.
Requires a dedicated <code class="literal">RabbitTemplate</code> and a <code class="literal">CachingConnectionFactory</code> with the <code class="literal">publisherConfirms</code> property set to <code class="literal">true</code>.
When a publisher confirm is received and correlation data is supplied, it is written to either the <code class="literal">confirm-ack-channel</code> or the <code class="literal">confirm-nack-channel</code>, depending on the confirmation type.
The payload of the confirm is the correlation data, as defined by this expression.
The message has a header <span class="emphasis"><em>amqp_publishConfirm</em></span> set to <code class="literal">true</code> (<code class="literal">ack</code>) or <code class="literal">false</code> (<code class="literal">nack</code>).
For <code class="literal">nack</code> confirmations, Spring Integration provides an additional header <code class="literal">amqp_publishConfirmNackCause</code>.
Examples: <code class="literal">headers['myCorrelationData']</code> and <code class="literal">payload</code>.
If the expression resolves to a <code class="literal">Message&lt;?&gt;</code> instance (such as <code class="literal">#this</code>), the message
emitted on the <code class="literal">ack</code>/<code class="literal">nack</code> channel is based on that message, with the additional headers added.
Previously, a new message was created with the correlation data as its payload, regardless of type.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO21-14"><span><img src="images/callouts/14.png" alt="14" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The channel to which positive (<code class="literal">ack</code>) publisher confirmations are sent.
The payload is the correlation data defined by <code class="literal">confirm-correlation-expression</code>.
If the expression is <code class="literal">#root</code> or <code class="literal">#this</code>, the message is built from the original message, with the <code class="literal">amqp_publishConfirm</code> header set to <code class="literal">true</code>.
Optional (the default is <code class="literal">nullChannel</code>).</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO21-15"><span><img src="images/callouts/15.png" alt="15" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The channel to which negative (<code class="literal">nack</code>) publisher confirmations are sent.
The payload is the correlation data defined by <code class="literal">confirm-correlation-expression</code> (if there is no <code class="literal">ErrorMessageStrategy</code> configured).
If the expression is <code class="literal">#root</code> or <code class="literal">#this</code>, the message is built from the original message, with the <code class="literal">amqp_publishConfirm</code> header set to <code class="literal">false</code>.
When there is an <code class="literal">ErrorMessageStrategy</code>, the message is an <code class="literal">ErrorMessage</code> with a <code class="literal">NackedAmqpMessageException</code> payload.
Optional (the default is <code class="literal">nullChannel</code>).</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO21-16">(16)</a> </p></td><td valign="top" align="left">
<p>The channel to which returned messages are sent.
When provided, the underlying AMQP template is configured to return undeliverable messages to the adapter.
When there is no <code class="literal">ErrorMessageStrategy</code> configured, the message is constructed from the data received from AMQP, with the following additional headers: <code class="literal">amqp_returnReplyCode</code>, <code class="literal">amqp_returnReplyText</code>, <code class="literal">amqp_returnExchange</code>, and <code class="literal">amqp_returnRoutingKey</code>.
When there is an <code class="literal">ErrorMessageStrategy</code>, the message is an <code class="literal">ErrorMessage</code> with a <code class="literal">ReturnedAmqpMessageException</code> payload.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO21-17">(17)</a> </p></td><td valign="top" align="left">
<p>A reference to an <code class="literal">ErrorMessageStrategy</code> implementation used to build <code class="literal">ErrorMessage</code> instances when sending returned or negatively acknowledged messages.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO21-18">(18)</a> </p></td><td valign="top" align="left">
<p>When set to <code class="literal">false</code>, the endpoint attempts to connect to the broker during application context initialization.
This allows "<code class="literal">fail fast</code>" detection of bad configuration by logging an error message if the broker is down.
When <code class="literal">true</code> (the default), the connection is established (if it does not already exist because some other component established it) when the first message is sent.</p>
</td></tr></table></div>
</div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important: return-channel"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">return-channel</th></tr><tr><td align="left" valign="top">

<p>Using a <code class="literal">return-channel</code> requires a <code class="literal">RabbitTemplate</code> with the <code class="literal">mandatory</code> property set to <code class="literal">true</code> and a <code class="literal">CachingConnectionFactory</code> with the <code class="literal">publisherReturns</code> property set to <code class="literal">true</code>.
When using multiple outbound endpoints with returns, a separate <code class="literal">RabbitTemplate</code> is needed for each endpoint.</p>
</td></tr></table></div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>The underlying <code class="literal">AmqpTemplate</code> has a default <code class="literal">replyTimeout</code> of five seconds.
If you require a longer timeout, you must configure it on the <code class="literal">template</code>.</p>
</td></tr></table></div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_with_java_configuration_4" href="#_configuring_with_java_configuration_4"></a>14.6.1&nbsp;Configuring with Java Configuration</h3></div></div></div>

<p>The following Spring Boot application shows an example of how to configure the outbound gateway with Java configuration:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@SpringBootApplication</span></em>
<em><span class="hl-annotation" style="color: gray">@IntegrationComponentScan</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> AmqpJavaApplication {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
         ConfigurableApplicationContext context =
                <span class="hl-keyword">new</span> SpringApplicationBuilder(AmqpJavaApplication.<span class="hl-keyword">class</span>)
                       .web(false)
                       .run(args);
         MyGateway gateway = context.getBean(MyGateway.<span class="hl-keyword">class</span>);
         String reply = gateway.sendToRabbit(<span class="hl-string">"foo"</span>);
         System.out.println(reply);
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "amqpOutboundChannel")</span></em>
    <span class="hl-keyword">public</span> AmqpOutboundEndpoint amqpOutbound(AmqpTemplate amqpTemplate) {
        AmqpOutboundEndpoint outbound = <span class="hl-keyword">new</span> AmqpOutboundEndpoint(amqpTemplate);
        outbound.setExpectReply(true);
        outbound.setRoutingKey(<span class="hl-string">"foo"</span>); <span class="hl-comment">// default exchange - route to queue 'foo'</span>
        <span class="hl-keyword">return</span> outbound;
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> MessageChannel amqpOutboundChannel() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> DirectChannel();
    }

    <em><span class="hl-annotation" style="color: gray">@MessagingGateway(defaultRequestChannel = "amqpOutboundChannel")</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> MyGateway {

        String sendToRabbit(String data);

    }

}</pre>
</div>
<p>Note that the only difference between the outbound adapter and outbound gateway configuration is the setting of the
<code class="literal">expectReply</code> property.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_with_the_java_dsl_5" href="#_configuring_with_the_java_dsl_5"></a>14.6.2&nbsp;Configuring with the Java DSL</h3></div></div></div>

<p>The following Spring Boot application shows an example of how to configure the outbound adapter with the Java DSL:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@SpringBootApplication</span></em>
<em><span class="hl-annotation" style="color: gray">@IntegrationComponentScan</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> AmqpJavaApplication {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
         ConfigurableApplicationContext context =
                 <span class="hl-keyword">new</span> SpringApplicationBuilder(AmqpJavaApplication.<span class="hl-keyword">class</span>)
                      .web(false)
                      .run(args);
         RabbitTemplate template = context.getBean(RabbitTemplate.<span class="hl-keyword">class</span>);
         MyGateway gateway = context.getBean(MyGateway.<span class="hl-keyword">class</span>);
         String reply = gateway.sendToRabbit(<span class="hl-string">"foo"</span>);
         System.out.println(reply);
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> IntegrationFlow amqpOutbound(AmqpTemplate amqpTemplate) {
        <span class="hl-keyword">return</span> IntegrationFlows.from(amqpOutboundChannel())
                .handle(Amqp.outboundGateway(amqpTemplate)
                        .routingKey(<span class="hl-string">"foo"</span>)) <span class="hl-comment">// default exchange - route to queue 'foo'</span>
                .get();
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> MessageChannel amqpOutboundChannel() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> DirectChannel();
    }

    <em><span class="hl-annotation" style="color: gray">@MessagingGateway(defaultRequestChannel = "amqpOutboundChannel")</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> MyGateway {

        String sendToRabbit(String data);

    }
}</pre>
</div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="amqp-async-outbound-gateway" href="#amqp-async-outbound-gateway"></a>14.7&nbsp;Asynchronous Outbound Gateway</h2></div></div></div>

<p>The gateway discussed in the previous section is synchronous, in that the sending thread is suspended until a
reply is received (or a timeout occurs).
Spring Integration version 4.3 added an asynchronous gateway, which uses the <code class="literal">AsyncRabbitTemplate</code> from Spring AMQP.
When a message is sent, the thread returns immediately after the send operation completes, and, when the message is received, the reply is sent on the template&#8217;s listener container thread.
This can be useful when the gateway is invoked on a poller thread.
The thread is released and is available for other tasks in the framework.</p>
<p>The following listing shows the possible configuration options for an AMQP asynchronous outbound gateway:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-amqp:outbound-gateway</span> <span class="hl-attribute">id</span>=<span class="hl-value">"inboundGateway"</span> <a name="CO22-1" href="#CO22-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
                           request-channel="myRequestChannel" <a name="CO22-2" href="#CO22-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
                           async-template="" <a name="CO22-3" href="#CO22-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
                           exchange-name="" <a name="CO22-4" href="#CO22-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
                           exchange-name-expression="" <a name="CO22-5" href="#CO22-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
                           order="1" <a name="CO22-6" href="#CO22-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>
                           reply-channel="" <a name="CO22-7" href="#CO22-7"></a><span><img src="images/callouts/7.png" alt="7" border="0"></span>
                           reply-timeout="" <a name="CO22-8" href="#CO22-8"></a><span><img src="images/callouts/8.png" alt="8" border="0"></span>
                           requires-reply="" <a name="CO22-9" href="#CO22-9"></a><span><img src="images/callouts/9.png" alt="9" border="0"></span>
                           routing-key="" <a name="CO22-10" href="#CO22-10"></a><span><img src="images/callouts/10.png" alt="10" border="0"></span>
                           routing-key-expression="" <a name="CO22-11" href="#CO22-11"></a><span><img src="images/callouts/11.png" alt="11" border="0"></span>
                           default-delivery-mode"" <a name="CO22-12" href="#CO22-12"></a><span><img src="images/callouts/12.png" alt="12" border="0"></span>
                           confirm-correlation-expression="" <a name="CO22-13" href="#CO22-13"></a><span><img src="images/callouts/13.png" alt="13" border="0"></span>
                           confirm-ack-channel="" <a name="CO22-14" href="#CO22-14"></a><span><img src="images/callouts/14.png" alt="14" border="0"></span>
                           confirm-nack-channel="" <a name="CO22-15" href="#CO22-15"></a><span><img src="images/callouts/15.png" alt="15" border="0"></span>
                           return-channel="" <a name="CO22-16" href="#CO22-16"></a>(16)
                           lazy-connect="true" /&gt; <a name="CO22-17" href="#CO22-17"></a>(17)</pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO22-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The unique ID for this adapter.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO22-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Message channel to which messages should be sent in order to have them converted and published to an AMQP exchange.
Required.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO22-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Bean reference to the configured <code class="literal">AsyncRabbitTemplate</code>.
Optional (it defaults to <code class="literal">asyncRabbitTemplate</code>).</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO22-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The name of the AMQP exchange to which messages should be sent.
If not provided, messages are sent to the default, no-name exchange.
Mutually exclusive with <span class="emphasis"><em>exchange-name-expression</em></span>.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO22-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A SpEL expression that is evaluated to determine the name of the AMQP exchange to which messages are sent, with the message as the root object.
If not provided, messages are sent to the default, no-name exchange.
Mutually exclusive with <span class="emphasis"><em>exchange-name</em></span>.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO22-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The order for this consumer when multiple consumers are registered, thereby enabling load-balancing and failover.
Optional (it defaults to <code class="literal">Ordered.LOWEST_PRECEDENCE [=Integer.MAX_VALUE]</code>).</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO22-7"><span><img src="images/callouts/7.png" alt="7" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Message channel to which replies should be sent after being received from an AMQP queue and converted.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO22-8"><span><img src="images/callouts/8.png" alt="8" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The time the gateway waits when sending the reply message to the <code class="literal">reply-channel</code>.
This only applies if the <code class="literal">reply-channel</code> can block&#8201;&#8212;&#8201;such as a <code class="literal">QueueChannel</code> with a capacity limit that is currently full.
The default is infinity.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO22-9"><span><img src="images/callouts/9.png" alt="9" border="0"></span></a> </p></td><td valign="top" align="left">
<p>When no reply message is received within the <code class="literal">AsyncRabbitTemplate</code>'s <code class="literal">receiveTimeout</code> property and this setting is <code class="literal">true</code>, the gateway sends an error message to the inbound message&#8217;s <code class="literal">errorChannel</code> header.
When no reply message is received within the <code class="literal">AsyncRabbitTemplate</code>'s <code class="literal">receiveTimeout</code> property and this setting is <code class="literal">false</code>, the gateway sends an error message to the default <code class="literal">errorChannel</code> (if available).
It defaults to <code class="literal">true</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO22-10"><span><img src="images/callouts/10.png" alt="10" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The routing-key to use when sending Messages.
By default, this is an empty <code class="literal">String</code>.
Mutually exclusive with <span class="emphasis"><em>routing-key-expression</em></span>.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO22-11"><span><img src="images/callouts/11.png" alt="11" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A SpEL expression that is evaluated to determine the routing-key to use when sending messages,
with the message as the root object (for example, <span class="emphasis"><em>payload.key</em></span>).
By default, this is an empty <code class="literal">String</code>.
Mutually exclusive with <span class="emphasis"><em>routing-key</em></span>.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO22-12"><span><img src="images/callouts/12.png" alt="12" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The default delivery mode for messages: <code class="literal">PERSISTENT</code> or <code class="literal">NON_PERSISTENT</code>.
Overridden if the <code class="literal">header-mapper</code> sets the delivery mode.
If the Spring Integration message header (<code class="literal">amqp_deliveryMode</code>) is present, the <code class="literal">DefaultHeaderMapper</code> sets the value.
If this attribute is not supplied and the header mapper does not set it, the default depends on the underlying Spring AMQP <code class="literal">MessagePropertiesConverter</code> used by the <code class="literal">RabbitTemplate</code>.
If that is not customized, the default is <code class="literal">PERSISTENT</code>.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO22-13"><span><img src="images/callouts/13.png" alt="13" border="0"></span></a> </p></td><td valign="top" align="left">
<p>An expression that defines correlation data.
When provided, this configures the underlying AMQP template to receive publisher confirmations.
Requires a dedicated <code class="literal">RabbitTemplate</code> and a <code class="literal">CachingConnectionFactory</code> with its <code class="literal">publisherConfirms</code> property set to
<code class="literal">true</code>. When a publisher confirmation is received and correlation data is supplied, the confirmation is written to either the
<code class="literal">confirm-ack-channel</code> or the <code class="literal">confirm-nack-channel</code>, depending on the confirmation type. The payload of the confirmation is
the correlation data as defined by this expression, and the message has its <span class="emphasis"><em>amqp_publishConfirm</em></span> header set to <code class="literal">true</code>
(<code class="literal">ack</code>) or <code class="literal">false</code> (<code class="literal">nack</code>).
For <code class="literal">nack</code> instances, an additional header (<code class="literal">amqp_publishConfirmNackCause</code>) is provided.
Examples: <code class="literal">headers['myCorrelationData']</code>, <code class="literal">payload</code>.
If the expression resolves to a <code class="literal">Message&lt;?&gt;</code> instance (such as "<code class="literal">#this</code>"), the message
emitted on the <code class="literal">ack</code>/<code class="literal">nack</code> channel is based on that message, with the additional headers added.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO22-14"><span><img src="images/callouts/14.png" alt="14" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The channel to which positive (<code class="literal">ack</code>) publisher confirmations are sent.
The payload is the correlation data defined by the <code class="literal">confirm-correlation-expression</code>.
Requires the underlying <code class="literal">AsyncRabbitTemplate</code> to have its <code class="literal">enableConfirms</code> property set to <code class="literal">true</code>.
Optional (the default is <code class="literal">nullChannel</code>).</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO22-15"><span><img src="images/callouts/15.png" alt="15" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Since version 4.2. The channel to which negative (<code class="literal">nack</code>) publisher confirmations are sent.
The payload is the correlation data defined by the <code class="literal">confirm-correlation-expression</code>.
Requires the underlying <code class="literal">AsyncRabbitTemplate</code> to have its <code class="literal">enableConfirms</code> property set to <code class="literal">true</code>.
Optional (the default is <code class="literal">nullChannel</code>).</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO22-16">(16)</a> </p></td><td valign="top" align="left">
<p>The channel to which returned messages are sent.
When provided, the underlying AMQP template is configured to return undeliverable messages to the gateway.
The message is constructed from the data received from AMQP, with the following additional headers:
<code class="literal">amqp_returnReplyCode</code>, <code class="literal">amqp_returnReplyText</code>, <code class="literal">amqp_returnExchange</code>, and <code class="literal">amqp_returnRoutingKey</code>.
Requires the underlying <code class="literal">AsyncRabbitTemplate</code> to have its <code class="literal">mandatory</code> property set to <code class="literal">true</code>.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO22-17">(17)</a> </p></td><td valign="top" align="left">
<p>When set to <code class="literal">false</code>, the endpoint tries to connect to the broker during application context initialization.
Doing so allows "<code class="literal">fail fast</code>" detection of bad configuration, by logging an error message if the broker is down.
When <code class="literal">true</code> (the default), the connection is established (if it does not already exist because some other component established
it) when the first message is sent.</p>
</td></tr></table></div>
</div>
<p>See also <a class="xref" href="#async-service-activator" title="10.5.2&nbsp;Asynchronous Service Activator">Section&nbsp;10.5.2, &#8220;Asynchronous Service Activator&#8221;</a> for more information.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important: RabbitTemplate"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">RabbitTemplate</th></tr><tr><td align="left" valign="top">

<p>When you use confirmations and returns, we recommend that the <code class="literal">RabbitTemplate</code> wired into the <code class="literal">AsyncRabbitTemplate</code> be dedicated.
Otherwise, unexpected side-effects may be encountered.</p>
</td></tr></table></div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_with_java_configuration_5" href="#_configuring_with_java_configuration_5"></a>14.7.1&nbsp;Configuring with Java Configuration</h3></div></div></div>

<p>The following configuration shows an example of how to configure the outbound gateway with Java configuration:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Configuration</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> AmqpAsyncConfig {

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "amqpOutboundChannel")</span></em>
    <span class="hl-keyword">public</span> AsyncAmqpOutboundGateway amqpOutbound(AmqpTemplate asyncTemplate) {
        AsyncAmqpOutboundGateway outbound = <span class="hl-keyword">new</span> AsyncAmqpOutboundGateway(asyncTemplate);
        outbound.setRoutingKey(<span class="hl-string">"foo"</span>); <span class="hl-comment">// default exchange - route to queue 'foo'</span>
        <span class="hl-keyword">return</span> outbound;
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> AsyncRabbitTemplate asyncTemplate(RabbitTemplate rabbitTemplate,
                     SimpleMessageListenerContainer replyContainer) {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> AsyncRabbitTemplate(rabbitTemplate, replyContainer);
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> SimpleMessageListenerContainer replyContainer() {
        SimpleMessageListenerContainer container = <span class="hl-keyword">new</span> SimpleMessageListenerContainer(ccf);
        container.setQueueNames(<span class="hl-string">"asyncRQ1"</span>);
        <span class="hl-keyword">return</span> container;
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> MessageChannel amqpOutboundChannel() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> DirectChannel();
    }

}</pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_with_the_java_dsl_6" href="#_configuring_with_the_java_dsl_6"></a>14.7.2&nbsp;Configuring with the Java DSL</h3></div></div></div>

<p>The following Spring Boot application shows an example of how to configure the outbound adapter with the Java DSL:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@SpringBootApplication</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> AmqpAsyncApplication {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
         ConfigurableApplicationContext context =
                 <span class="hl-keyword">new</span> SpringApplicationBuilder(AmqpAsyncApplication.<span class="hl-keyword">class</span>)
                      .web(false)
                      .run(args);
         MyGateway gateway = context.getBean(MyGateway.<span class="hl-keyword">class</span>);
         String reply = gateway.sendToRabbit(<span class="hl-string">"foo"</span>);
         System.out.println(reply);
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> IntegrationFlow asyncAmqpOutbound(AsyncRabbitTemplate asyncRabbitTemplate) {
        <span class="hl-keyword">return</span> f -&gt; f
                .handle(Amqp.asyncOutboundGateway(asyncRabbitTemplate)
                        .routingKey(<span class="hl-string">"foo"</span>)); <span class="hl-comment">// default exchange - route to queue 'foo'</span>
    }

    <em><span class="hl-annotation" style="color: gray">@MessagingGateway(defaultRequestChannel = "asyncAmqpOutbound.input")</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> MyGateway {

        String sendToRabbit(String data);

    }

}</pre>
</div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="content-type-conversion-outbound" href="#content-type-conversion-outbound"></a>14.8&nbsp;Outbound Message Conversion</h2></div></div></div>

<p>Spring AMQP 1.4 introduced the <code class="literal">ContentTypeDelegatingMessageConverter</code>, where the actual converter is selected based
on the incoming content type message property.
This can be used by inbound endpoints.</p>
<p>As of Spring Integration version 4.3, you can use the <code class="literal">ContentTypeDelegatingMessageConverter</code> on outbound endpoints as well, with the <code class="literal">contentType</code> header specifying which converter is used.</p>
<p>The following example configures a <code class="literal">ContentTypeDelegatingMessageConverter</code>, with the default converter being the <code class="literal">SimpleMessageConverter</code> (which handles Java serialization and plain text), together with a JSON converter:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;amqp:outbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"withContentTypeConverter"</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"ctRequestChannel"</span>
                               <span class="hl-attribute">exchange-name</span>=<span class="hl-value">"someExchange"</span>
                               <span class="hl-attribute">routing-key</span>=<span class="hl-value">"someKey"</span>
                               <span class="hl-attribute">amqp-template</span>=<span class="hl-value">"amqpTemplateContentTypeConverter"</span><span class="hl-tag"> /&gt;</span>

<span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"ctRequestChannel"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;rabbit:template</span> <span class="hl-attribute">id</span>=<span class="hl-value">"amqpTemplateContentTypeConverter"</span>
        <span class="hl-attribute">connection-factory</span>=<span class="hl-value">"connectionFactory"</span> <span class="hl-attribute">message-converter</span>=<span class="hl-value">"ctConverter"</span><span class="hl-tag"> /&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"ctConverter"</span>
        <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.amqp.support.converter.ContentTypeDelegatingMessageConverter"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"delegates"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;map&gt;</span>
            <span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"application/json"</span><span class="hl-tag">&gt;</span>
                <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.amqp.support.converter.Jackson2JsonMessageConverter"</span><span class="hl-tag"> /&gt;</span>
            <span class="hl-tag">&lt;/entry&gt;</span>
        <span class="hl-tag">&lt;/map&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
</div>
<p>Sending a message to <code class="literal">ctRequestChannel</code> with the <code class="literal">contentType</code> header set to <code class="literal">application/json</code> causes the JSON converter to be selected.</p>
<p>This applies to both the outbound channel adapter and gateway.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Starting with version 5.0, headers that are added to the <code class="literal">MessageProperties</code> of the outbound message are never overwritten by mapped headers (by default).
Previously, this was only the case if the message converter was a <code class="literal">ContentTypeDelegatingMessageConverter</code> (in that case, the header was mapped first so that the proper converter could be selected).
For other converters, such as the <code class="literal">SimpleMessageConverter</code>, mapped headers overwrote any headers added by the converter.
This caused problems when an outbound message had some leftover <code class="literal">contentType</code> headers (perhaps from an inbound channel adapter) and the correct outbound <code class="literal">contentType</code> was incorrectly overwritten.
The work-around was to use a header filter to remove the header before sending the message to the outbound endpoint.</p>
<p>There are, however, cases where the previous behavior is desired&#8201;&#8212;&#8201;for example, when a <code class="literal">String</code> payload that contains JSON, the <code class="literal">SimpleMessageConverter</code> is not aware of the content and sets the <code class="literal">contentType</code> message property to <code class="literal">text/plain</code> but your application would like to override that to <code class="literal">application/json</code> by setting the <code class="literal">contentType</code> header of the message sent to the outbound endpoint.
The <code class="literal">ObjectToJsonTransformer</code> does exactly that (by default).</p>
<p>There is now a property called <code class="literal">headersMappedLast</code> on the outbound channel adapter and gateway (as well as on AMQP-backed channels).
Setting this to <code class="literal">true</code> restores the behavior of overwriting the property added by the converter.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="amqp-user-id" href="#amqp-user-id"></a>14.9&nbsp;Outbound User ID</h2></div></div></div>

<p>Spring AMQP version 1.6 introduced a mechanism to allow the specification of a default user ID for outbound messages.
It has always been possible to set the <code class="literal">AmqpHeaders.USER_ID</code> header, which now takes precedence over the default.
This might be useful to message recipients.
For inbound messages, if the message publisher sets the property, it is made available in the <code class="literal">AmqpHeaders.RECEIVED_USER_ID</code> header.
Note that RabbitMQ <a class="ulink" href="https://www.rabbitmq.com/validated-user-id.html" target="_top">validates that the user ID is the actual user ID for the connection or that the connection allows impersonation</a>.</p>
<p>To configure a default user ID for outbound messages, configure it on a <code class="literal">RabbitTemplate</code> and configure the outbound adapter or gateway to use that template.
Similarly, to set the user ID property on replies, inject an appropriately configured template into the inbound gateway.
See the <a class="ulink" href="http://docs.spring.io/spring-amqp/reference/html/_reference.html#template-user-id" target="_top">Spring AMQP documentation</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="amqp-delay" href="#amqp-delay"></a>14.10&nbsp;Delayed Message Exchange</h2></div></div></div>

<p>Spring AMQP supports the <a class="ulink" href="http://docs.spring.io/spring-amqp/reference/html/_reference.html#delayed-message-exchange" target="_top">RabbitMQ Delayed Message Exchange Plugin</a>.
For inbound messages, the <code class="literal">x-delay</code> header is mapped to the <code class="literal">AmqpHeaders.RECEIVED_DELAY</code> header.
Setting the <code class="literal">AMQPHeaders.DELAY</code> header causes the corresponding <code class="literal">x-delay</code> header to be set in outbound messages.
You can also specify the <code class="literal">delay</code> and <code class="literal">delayExpression</code> properties on outbound endpoints (<code class="literal">delay-expression</code> when using XML configuration).
These properties take precedence over the <code class="literal">AmqpHeaders.DELAY</code> header.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="amqp-channels" href="#amqp-channels"></a>14.11&nbsp;AMQP-backed Message Channels</h2></div></div></div>

<p>There are two message channel implementations available.
One is point-to-point, and the other is publish-subscribe.
Both of these channels provide a wide range of configuration attributes for the underlying <code class="literal">AmqpTemplate</code> and
<code class="literal">SimpleMessageListenerContainer</code> (as shown earlier in this chapter for the channel adapters and gateways).
However, the examples we show here have minimal configuration.
Explore the XML schema to view the available attributes.</p>
<p>A point-to-point channel might look like the following example:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-amqp:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"p2pChannel"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>Under the covers, the preceding example causes a <code class="literal">Queue</code> named <code class="literal">si.p2pChannel</code> to be declared, and this channel sends to that <code class="literal">Queue</code> (technically, by sending to the no-name direct exchange with a routing key that matches the name of this <code class="literal">Queue</code>).
This channel also registers a consumer on that <code class="literal">Queue</code>.
If you want the channel to be "<code class="literal">pollable</code>" instead of message-driven, provide the <code class="literal">message-driven</code> flag with a value of <code class="literal">false</code>, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-amqp:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"p2pPollableChannel"</span>  <span class="hl-attribute">message-driven</span>=<span class="hl-value">"false"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>A publish-subscribe channel might look like the following:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-amqp:publish-subscribe-channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"pubSubChannel"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>Under the covers, the preceding example causes a fanout exchange named <code class="literal">si.fanout.pubSubChannel</code> to be declared, and this channel sends to that fanout exchange.
This channel also declares a server-named exclusive, auto-delete, non-durable <code class="literal">Queue</code> and binds that to the fanout exchange while registering a consumer on that <code class="literal">Queue</code> to receive messages.
There is no "<code class="literal">pollable</code>" option for a publish-subscribe-channel.
It must be message-driven.</p>
<p>Starting with version 4.1, AMQP-backed message channels (in conjunction with <code class="literal">channel-transacted</code>) support
<code class="literal">template-channel-transacted</code> to separate <code class="literal">transactional</code> configuration for the <code class="literal">AbstractMessageListenerContainer</code> and
for the <code class="literal">RabbitTemplate</code>.
Note that, previously, <code class="literal">channel-transacted</code> was <code class="literal">true</code> by default.
Now, by default, it is <code class="literal">false</code> for the <code class="literal">AbstractMessageListenerContainer</code>.</p>
<p>Prior to version 4.3, AMQP-backed channels only supported messages with <code class="literal">Serializable</code> payloads and headers.
The entire message was converted (serialized) and sent to RabbitMQ.
Now, you can set the <code class="literal">extract-payload</code> attribute (or <code class="literal">setExtractPayload()</code> when using Java configuration) to <code class="literal">true</code>.
When this flag is <code class="literal">true</code>, the message payload is converted and the headers are mapped, in a manner similar to when you use channel adapters.
This arrangement lets AMQP-backed channels be used with non-serializable payloads (perhaps with another message converter, such as the <code class="literal">Jackson2JsonMessageConverter</code>).
See <a class="xref" href="#amqp-message-headers" title="14.12&nbsp;AMQP Message Headers">Section&nbsp;14.12, &#8220;AMQP Message Headers&#8221;</a> for more about the default mapped headers.
You can modify the mapping by providing custom mappers that use the <code class="literal">outbound-header-mapper</code> and <code class="literal">inbound-header-mapper</code> attributes.
You can now also specify a <code class="literal">default-delivery-mode</code>, which is used to set the delivery mode when there is no <code class="literal">amqp_deliveryMode</code> header.
By default, Spring AMQP <code class="literal">MessageProperties</code> uses <code class="literal">PERSISTENT</code> delivery mode.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>As with other persistence-backed channels, AMQP-backed channels are intended to provide message persistence to avoid message loss.
They are not intended to distribute work to other peer applications.
For that purpose, use channel adapters instead.</p>
</td></tr></table></div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Starting with version 5.0, the pollable channel now blocks the poller thread for the specified <code class="literal">receiveTimeout</code> (the default is 1 second).
Previously, unlike other <code class="literal">PollableChannel</code> implementations, the thread returned immediately to the scheduler if no message was available, regardless of the receive timeout.
Blocking is a little more expensive than using a <code class="literal">basicGet()</code> to retrieve a message (with no timeout), because a consumer has to be created to receive each message.
To restore the previous behavior, set the poller&#8217;s <code class="literal">receiveTimeout</code> to 0.</p>
</td></tr></table></div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_with_java_configuration_6" href="#_configuring_with_java_configuration_6"></a>14.11.1&nbsp;Configuring with Java Configuration</h3></div></div></div>

<p>The following example shows how to configure the channels with Java configuration:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> AmqpChannelFactoryBean pollable(ConnectionFactory connectionFactory) {
    AmqpChannelFactoryBean factoryBean = <span class="hl-keyword">new</span> AmqpChannelFactoryBean();
    factoryBean.setConnectionFactory(connectionFactory);
    factoryBean.setQueueName(<span class="hl-string">"foo"</span>);
    factoryBean.setPubSub(false);
    <span class="hl-keyword">return</span> factoryBean;
}

<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> AmqpChannelFactoryBean messageDriven(ConnectionFactory connectionFactory) {
    AmqpChannelFactoryBean factoryBean = <span class="hl-keyword">new</span> AmqpChannelFactoryBean(true);
    factoryBean.setConnectionFactory(connectionFactory);
    factoryBean.setQueueName(<span class="hl-string">"bar"</span>);
    factoryBean.setPubSub(false);
    <span class="hl-keyword">return</span> factoryBean;
}

<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> AmqpChannelFactoryBean pubSub(ConnectionFactory connectionFactory) {
    AmqpChannelFactoryBean factoryBean = <span class="hl-keyword">new</span> AmqpChannelFactoryBean(true);
    factoryBean.setConnectionFactory(connectionFactory);
    factoryBean.setQueueName(<span class="hl-string">"baz"</span>);
    factoryBean.setPubSub(false);
    <span class="hl-keyword">return</span> factoryBean;
}</pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_with_the_java_dsl_7" href="#_configuring_with_the_java_dsl_7"></a>14.11.2&nbsp;Configuring with the Java DSL</h3></div></div></div>

<p>The following example shows how to configure the channels with the Java DSL:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> IntegrationFlow pollableInFlow(ConnectionFactory connectionFactory) {
    <span class="hl-keyword">return</span> IntegrationFlows.from(...)
            ...
            .channel(Amqp.pollableChannel(connectionFactory)
                    .queueName(<span class="hl-string">"foo"</span>))
            ...
            .get();
}

<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> IntegrationFlow messageDrivenInFow(ConnectionFactory connectionFactory) {
    <span class="hl-keyword">return</span> IntegrationFlows.from(...)
            ...
            .channel(Amqp.channel(connectionFactory)
                    .queueName(<span class="hl-string">"bar"</span>))
            ...
            .get();
}

<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> IntegrationFlow pubSubInFlow(ConnectionFactory connectionFactory) {
    <span class="hl-keyword">return</span> IntegrationFlows.from(...)
            ...
            .channel(Amqp.publisSubscribeChannel(connectionFactory)
                    .queueName(<span class="hl-string">"baz"</span>))
            ...
            .get();
}</pre>
</div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="amqp-message-headers" href="#amqp-message-headers"></a>14.12&nbsp;AMQP Message Headers</h2></div></div></div>

<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_overview" href="#_overview"></a>14.12.1&nbsp;Overview</h3></div></div></div>

<p>The Spring Integration AMQP Adapters automatically map all AMQP properties and headers.
(This is a change from 4.3 - previously, only standard headers were mapped).
By default, these properties are copied to and from Spring Integration <code class="literal">MessageHeaders</code> by using the
<a class="ulink" href="http://docs.spring.io/spring-integration/api/org/springframework/integration/amqp/support/DefaultAmqpHeaderMapper.html" target="_top"><code class="literal">DefaultAmqpHeaderMapper</code></a>.</p>
<p>You can pass in your own implementation of AMQP-specific header mappers, as the adapters have properties to support doing so.</p>
<p>Any user-defined headers within the AMQP <a class="ulink" href="http://docs.spring.io/spring-amqp/api/org/springframework/amqp/core/MessageProperties.html" target="_top"><code class="literal">MessageProperties</code></a> are copied to or from an AMQP message, unless explicitly negated by the <code class="literal">requestHeaderNames</code> or <code class="literal">replyHeaderNames</code> properties of the <code class="literal">DefaultAmqpHeaderMapper</code>.
By default, for an outbound mapper, no <code class="literal">x-*</code> headers are mapped.
See the <a class="link" href="#header-copy-caution" title="Caution">caution</a> that appears later in this section for why.</p>
<p>To override the default and revert to the pre-4.3 behavior, use <code class="literal">STANDARD_REQUEST_HEADERS</code> and
<code class="literal">STANDARD_REPLY_HEADERS</code> in the properties.</p>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>When mapping user-defined headers, the values can also contain simple wildcard patterns (such as <span class="emphasis"><em>thing*</em></span> or <code class="literal">*thing</code>) to be matched.
<code class="literal">*</code> matches all headers.</p>
</td></tr></table></div>
<p>Starting with version 4.1, the <code class="literal">AbstractHeaderMapper</code> (a <code class="literal">DefaultAmqpHeaderMapper</code> superclass) lets the <code class="literal">NON_STANDARD_HEADERS</code> token be configured for the <code class="literal">requestHeaderNames</code> and <code class="literal">replyHeaderNames</code> properties (in addition to the existing <code class="literal">STANDARD_REQUEST_HEADERS</code> and <code class="literal">STANDARD_REPLY_HEADERS</code>) to map all user-defined headers.</p>
<p>The <code class="literal">org.springframework.amqp.support.AmqpHeaders</code> class identifies the default headers that are used by the
<code class="literal">DefaultAmqpHeaderMapper</code>:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">amqp_appId</code>
</li><li class="listitem">
<code class="literal">amqp_clusterId</code>
</li><li class="listitem">
<code class="literal">amqp_contentEncoding</code>
</li><li class="listitem">
<code class="literal">amqp_contentLength</code>
</li><li class="listitem">
<code class="literal">content-type</code> (see <a class="xref" href="#amqp-content-type" title="14.12.2&nbsp;contentType Header">Section&nbsp;14.12.2, &#8220;contentType Header&#8221;</a>)
</li><li class="listitem">
<code class="literal">amqp_correlationId</code>
</li><li class="listitem">
<code class="literal">amqp_delay</code>
</li><li class="listitem">
<code class="literal">amqp_deliveryMode</code>
</li><li class="listitem">
<code class="literal">amqp_deliveryTag</code>
</li><li class="listitem">
<code class="literal">amqp_expiration</code>
</li><li class="listitem">
<code class="literal">amqp_messageCount</code>
</li><li class="listitem">
<code class="literal">amqp_messageId</code>
</li><li class="listitem">
<code class="literal">amqp_receivedDelay</code>
</li><li class="listitem">
<code class="literal">amqp_receivedDeliveryMode</code>
</li><li class="listitem">
<code class="literal">amqp_receivedExchange</code>
</li><li class="listitem">
<code class="literal">amqp_receivedRoutingKey</code>
</li><li class="listitem">
<code class="literal">amqp_redelivered</code>
</li><li class="listitem">
<code class="literal">amqp_replyTo</code>
</li><li class="listitem">
<code class="literal">amqp_timestamp</code>
</li><li class="listitem">
<code class="literal">amqp_type</code>
</li><li class="listitem">
<code class="literal">amqp_userId</code>
</li><li class="listitem">
<code class="literal">amqp_publishConfirm</code>
</li><li class="listitem">
<code class="literal">amqp_publishConfirmNackCause</code>
</li><li class="listitem">
<code class="literal">amqp_returnReplyCode</code>
</li><li class="listitem">
<code class="literal">amqp_returnReplyText</code>
</li><li class="listitem">
<code class="literal">amqp_returnExchange</code>
</li><li class="listitem">
<code class="literal">amqp_returnRoutingKey</code>
</li><li class="listitem">
<code class="literal">amqp_channel</code>
</li><li class="listitem">
<code class="literal">amqp_consumerTag</code>
</li><li class="listitem">
<code class="literal">amqp_consumerQueue</code>
</li></ul></div>
<div class="caution" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Caution"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Caution]" src="images/caution.png"></td><th align="left"><a name="header-copy-caution" href="#header-copy-caution"></a>Caution</th></tr><tr><td align="left" valign="top">
<p>As mentioned earlier in this section, using a header mapping pattern of`*` is a common way to copy all headers.
However, this can have some unexpected side effects, because certain RabbitMQ proprietary properties/headers are also
copied.
For example, when you use <a class="ulink" href="https://www.rabbitmq.com/federated-exchanges.html" target="_top">federation</a>, the received message may have
a property named <code class="literal">x-received-from</code>, which contains the node that sent the message.
If you use the wildcard character <code class="literal">*</code> for the request and reply header mapping on the inbound gateway, this header is copied, which may cause some issues with federation.
This reply message may be federated back to the sending broker, which may think that a message is looping and, as a result, silently drop it.
If you wish to use the convenience of wildcard header mapping, you may need to filter out some headers in the downstream flow.
For example, to avoid copying the <code class="literal">x-received-from</code> header back to the reply you can use <code class="literal">&lt;int:header-filter ... header-names="x-received-from"&gt;</code> before sending the reply to the AMQP inbound gateway.
Alternatively, you can explicitly list those properties that you actually want mapped, instead of using wildcards.
For these reasons, for inbound messages, the mapper (by default) does not map any <code class="literal">x-*</code> headers.
It also does not map the <code class="literal">deliveryMode</code> to the <code class="literal">amqp_deliveryMode</code> header, to avoid propagation of that header from an inbound message to an outbound message.
Instead, this header is mapped to <code class="literal">amqp_receivedDeliveryMode</code>, which is not mapped on output.</p>
</td></tr></table></div>
<p>Starting with version 4.3, patterns in the header mappings can be negated by preceding the pattern with <code class="literal">!</code>.
Negated patterns get priority, so a list such as
<code class="literal">STANDARD_REQUEST_HEADERS,thing1,ba*,!thing2,!thing3,qux,!thing1</code> does not map <code class="literal">thing1</code>
(nor <code class="literal">thing2</code> nor <code class="literal">thing3</code>).
The standard headers plus <code class="literal">bad</code> and <code class="literal">qux</code> are mapped.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>If you have a user-defined header that begins with <code class="literal">!</code> that you do wish to map, you need to escape it with
<code class="literal">\</code>, as follows: <code class="literal">STANDARD_REQUEST_HEADERS,\!myBangHeader</code>. The header named <code class="literal">!myBangHeader</code> is now mapped.</p>
</td></tr></table></div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Starting with <span class="emphasis"><em>version 5.1</em></span>, the <code class="literal">DefaultAmqpHeaderMapper</code> will fall back to mapping <code class="literal">MessageHeaders.ID</code> and <code class="literal">MessageHeaders.TIMESTAMP</code> to <code class="literal">MessageProperties.messageId</code> and <code class="literal">MessageProperties.timestamp</code> respectively, if the corresponding <code class="literal">amqp_messageId</code> or <code class="literal">amqp_timestamp</code> headers are not present on outbound messages.
Inbound properties will be mapped to the <code class="literal">amqp_*</code> headers as before.
It is useful to populate the <code class="literal">messageId</code> property when message consumers are using stateful retry.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="amqp-content-type" href="#amqp-content-type"></a>14.12.2&nbsp;contentType Header</h3></div></div></div>

<p>Unlike other headers, the <code class="literal">AmqpHeaders.CONTENT_TYPE</code> is not prefixed with <code class="literal">amqp_</code>; this allows transparent passing of the contentType header across different technologies.
E.g. an inbound HTTP message sent to a RabbitMQ queue.</p>
<p>The <code class="literal">contentType</code> header is mapped to Spring AMQP&#8217;s <code class="literal">MessageProperties.contentType</code> property and that is subsequently mapped to RabbitMQ&#8217;s <code class="literal">content_type</code> property.</p>
<p>Prior to <span class="emphasis"><em>version 5.1</em></span>, this header was also mapped as an entry in the <code class="literal">MessageProperties.headers</code> map; this was incorrect and, furthermore, the value could be wrong since the underlying Spring AMQP message converter might have changed the content type.
Such a change would be reflected in the first-class <code class="literal">content_type</code> property, but not in the RabbitMQ headers map.
Inbound mapping ignored the headers map value.
<code class="literal">contentType</code> is no longer mapped to an entry in the headers map.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="amqp-strict-ordering" href="#amqp-strict-ordering"></a>14.13&nbsp;Strict Message Ordering</h2></div></div></div>

<p>This section describes message ordering for inbound and outbound messages.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_inbound" href="#_inbound"></a>14.13.1&nbsp;Inbound</h3></div></div></div>

<p>If you require strict ordering of inbound messages, you must configure the inbound listener container&#8217;s <code class="literal">prefetchCount</code> property to <code class="literal">1</code>.
This is because, if a message fails and is redelivered, it arrives after existing prefetched messages.
Since Spring AMQP version 2.0, the <code class="literal">prefetchCount</code> defaults to <code class="literal">250</code> for improved performance.
Strict ordering requirements come at the cost of decreased performance.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_outbound" href="#_outbound"></a>14.13.2&nbsp;Outbound</h3></div></div></div>

<p>Consider the following integration flow:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> IntegrationFlow flow(RabbitTemplate template) {
    <span class="hl-keyword">return</span> IntegrationFlows.from(Gateway.<span class="hl-keyword">class</span>)
            .split(s -&gt; s.delimiters(<span class="hl-string">","</span>))
            .&lt;String, String&gt;transform(String::toUpperCase)
            .handle(Amqp.outboundAdapter(template).routingKey(<span class="hl-string">"rk"</span>))
            .get();
}</pre>
</div>
<p>Suppose we send messages <code class="literal">A</code>, <code class="literal">B</code> and <code class="literal">C</code> to the gateway.
While it is likely that messages <code class="literal">A</code>, <code class="literal">B</code>, <code class="literal">C</code> are sent in order, there is no guarantee.
This is because the template "<code class="literal">borrows</code>" a channel from the cache for each send operation, and there is no guarantee that the same channel is used for each message.
One solution is to start a transaction before the splitter, but transactions are expensive in RabbitMQ and can reduce performance several hundred fold.</p>
<p>To solve this problem in a more efficient manner, starting with version 5.1, Spring Integration provides the <code class="literal">BoundRabbitChannelAdvice</code> which is a <code class="literal">HandleMessageAdvice</code>.
See <a class="xref" href="#handle-message-advice" title="10.9.4&nbsp;Handling Message Advice">Section&nbsp;10.9.4, &#8220;Handling Message Advice&#8221;</a>.
When applied before the splitter, it ensures that all downstream operations are performed on the same channel and, optionally, can wait until publisher confirmations for all sent messages are received (if the connection factory is configured for confirmations).
The following example shows how to use <code class="literal">BoundRabbitChannelAdvice</code>:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> IntegrationFlow flow(RabbitTemplate template) {
    <span class="hl-keyword">return</span> IntegrationFlows.from(Gateway.<span class="hl-keyword">class</span>)
            .split(s -&gt; s.delimiters(<span class="hl-string">","</span>)
                    .advice(<span class="hl-keyword">new</span> BoundRabbitChannelAdvice(template, Duration.ofSeconds(<span class="hl-number">10</span>))))
            .&lt;String, String&gt;transform(String::toUpperCase)
            .handle(Amqp.outboundAdapter(template).routingKey(<span class="hl-string">"rk"</span>))
            .get();
}</pre>
</div>
<p>Notice that the same <code class="literal">RabbitTemplate</code> (which implements <code class="literal">RabbitOperations</code>) is used in the advice and the outbound adapter.
The advice runs the downstream flow within the template&#8217;s <code class="literal">invoke</code> method so that all operations run on the same channel.
If the optional timeout is provided, when the flow completes, the advice calls the <code class="literal">waitForConfirmsOrDie</code> method, which throws an exception if the confirmations are not received within the specified time.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>There must be no thread handoffs in the downstream flow (<code class="literal">QueueChannel</code>, <code class="literal">ExecutorChannel</code>, and others).</p>
</td></tr></table></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_amqp_samples" href="#_amqp_samples"></a>14.14&nbsp;AMQP Samples</h2></div></div></div>

<p>To experiment with the AMQP adapters, check out the samples available in the Spring Integration samples git repository at <a class="ulink" href="https://github.com/spring-projects/spring-integration-samples" target="_top">https://github.com/SpringSource/spring-integration-samples</a></p>
<p>Currently, one sample demonstrates the basic functionality of the Spring Integration AMQP adapter by using an outbound channel adapter and an inbound channel adapter.
As AMQP broker implementation in the sample uses <a class="ulink" href="http://www.rabbitmq.com/" target="_top">RabbitMQ</a>.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>In order to run the example, you need a running instance of RabbitMQ.
A local installation with just the basic defaults suffices.
For detailed RabbitMQ installation procedures, see <a class="ulink" href="http://www.rabbitmq.com/install.html" target="_top">http://www.rabbitmq.com/install.html</a></p>
</td></tr></table></div>
<p>Once the sample application is started, enter some text on the command prompt and a message containing that entered text is dispatched to the AMQP queue.
In return, that message is retrieved by Spring Integration and printed to the console.</p>
<p>The following image illustrates the basic set of Spring Integration components used in this sample.</p>
<div class="figure"><a name="d5e12228" href="#d5e12228"></a><p class="title"><b>Figure&nbsp;14.1.&nbsp;The Spring Integration graph of the AMQP sample</b></p><div class="figure-contents">

<div class="mediaobject"><img src="images/spring-integration-amqp-sample-graph.png" alt="spring integration amqp sample graph"></div>
</div></div><br class="figure-break">
</div>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="applicationevent" href="#applicationevent"></a>15.&nbsp;Spring <code class="literal">ApplicationEvent</code> Support</h2></div></div></div>

<p>Spring Integration provides support for inbound and outbound <code class="literal">ApplicationEvents</code>, as defined by the underlying Spring Framework.
For more information about Spring&#8217;s support for events and listeners, see the <a class="ulink" href="http://docs.spring.io/spring/docs/current/spring-framework-reference/html/beans.html#context-functionality-events" target="_top">Spring Reference Manual</a>.</p>
<p>You need to include this dependency into your project:</p>
<div class="informalexample">
<p>
<b>Maven.&nbsp;</b>

</p><pre class="programlisting"><span class="hl-tag">&lt;dependency&gt;</span>
    <span class="hl-tag">&lt;groupId&gt;</span>org.springframework.integration<span class="hl-tag">&lt;/groupId&gt;</span>
    <span class="hl-tag">&lt;artifactId&gt;</span>spring-integration-event<span class="hl-tag">&lt;/artifactId&gt;</span>
    <span class="hl-tag">&lt;version&gt;</span>5.1.2.RELEASE<span class="hl-tag">&lt;/version&gt;</span>
<span class="hl-tag">&lt;/dependency&gt;</span></pre><p>

</p>
<p>
<b>Gradle.&nbsp;</b>

</p><pre class="programlisting">compile <span class="hl-string">"org.springframework.integration:spring-integration-event:5.1.2.RELEASE"</span></pre><p>

</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="appevent-inbound" href="#appevent-inbound"></a>15.1&nbsp;Receiving Spring Application Events</h2></div></div></div>

<p>To receive events and send them to a channel, you can define an instance of Spring Integration&#8217;s <code class="literal">ApplicationEventListeningMessageProducer</code>.
This class is an implementation of Spring&#8217;s <code class="literal">ApplicationListener</code> interface.
By default, it passes all received events as Spring Integration messages.
To limit based on the type of event, you can use the <span class="emphasis"><em>eventTypes</em></span> property to configure the list of event types that you want to receive.
If a received event has a <code class="literal">Message</code> instance as its <span class="emphasis"><em>source</em></span>, that <code class="literal">Message</code> is passed as-is.
Otherwise, if a SpEL-based <code class="literal">payloadExpression</code> has been provided, that is evaluated against the <code class="literal">ApplicationEvent</code> instance.
If the event&#8217;s source is not a <code class="literal">Message</code> instance and no <code class="literal">payloadExpression</code> has been provided, the <code class="literal">ApplicationEvent</code> itself is passed as the payload.</p>
<p>Starting with version 4.2, the <code class="literal">ApplicationEventListeningMessageProducer</code> implements <code class="literal">GenericApplicationListener</code> and can be configured to accept not only <code class="literal">ApplicationEvent</code> types but any type for treating payload events (which are also supported since Spring Framework 4.2).
When the accepted event is an instance of <code class="literal">PayloadApplicationEvent</code>, its <code class="literal">payload</code> is used for the message to send.</p>
<p>For convenience, namespace support is provided to configure&nbsp;an <code class="literal">ApplicationEventListeningMessageProducer</code> with the <code class="literal">inbound-channel-adapter</code> element, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-event:inbound-channel-adapter</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"eventChannel"</span>
                                   <span class="hl-attribute">error-channel</span>=<span class="hl-value">"eventErrorChannel"</span>
                                   <span class="hl-attribute">event-types</span>=<span class="hl-value">"example.FooEvent, example.BarEvent, java.util.Date"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int:publish-subscribe-channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"eventChannel"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>In the preceding example, all application context events that match one of the types specified by the <span class="emphasis"><em>event-types</em></span> (optional) attribute are delivered as Spring Integration messages to the message channel named <span class="emphasis"><em>eventChannel</em></span>.
If a downstream component throws an exception, a <code class="literal">MessagingException</code> that contains the failed message and exception is sent to the channel named <span class="emphasis"><em>eventErrorChannel</em></span>.
If no <code class="literal">error-channel</code> is specified and the downstream channels are synchronous, the exception is propagated to the caller.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="appevent-outbound" href="#appevent-outbound"></a>15.2&nbsp;Sending Spring Application Events</h2></div></div></div>

<p>To send Spring <code class="literal">ApplicationEvents</code>, create an instance of the <code class="literal">ApplicationEventPublishingMessageHandler</code> and register it within an endpoint.
This implementation of the <code class="literal">MessageHandler</code> interface also implements Spring&#8217;s <code class="literal">ApplicationEventPublisherAware</code> interface and consequently acts as a bridge between Spring Integration messages and <code class="literal">ApplicationEvents</code>.</p>
<p>For convenience, namespace support is provided to configure&nbsp;an <code class="literal">ApplicationEventPublishingMessageHandler</code> with the <code class="literal">outbound-channel-adapter</code> element, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"eventChannel"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int-event:outbound-channel-adapter</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"eventChannel"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>If you use a <code class="literal">PollableChannel</code> (such as a <code class="literal">Queue</code>), you can also provide <code class="literal">poller</code> as a child element of the <code class="literal">outbound-channel-adapter</code> element.
You can also optionally provide a <code class="literal">task-executor</code> reference for that poller.
The following example demonstrates both:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"eventChannel"</span><span class="hl-tag">&gt;</span>
  <span class="hl-tag">&lt;int:queue/&gt;</span>
<span class="hl-tag">&lt;/int:channel&gt;</span>

<span class="hl-tag">&lt;int-event:outbound-channel-adapter</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"eventChannel"</span><span class="hl-tag">&gt;</span>
  <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">max-messages-per-poll</span>=<span class="hl-value">"1"</span> <span class="hl-attribute">task-executor</span>=<span class="hl-value">"executor"</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"100"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-event:outbound-channel-adapter&gt;</span>

<span class="hl-tag">&lt;task:executor</span> <span class="hl-attribute">id</span>=<span class="hl-value">"executor"</span> <span class="hl-attribute">pool-size</span>=<span class="hl-value">"5"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>In the preceding example, all messages sent to the <span class="emphasis"><em>eventChannel</em></span> channel are published as <code class="literal">ApplicationEvent</code> instances to any relevant <code class="literal">ApplicationListener</code> instances that are registered within the same Spring <code class="literal">ApplicationContext</code>.
If the payload of the message is an <code class="literal">ApplicationEvent</code>, it is passed as-is.
Otherwise, the message itself is wrapped in a <code class="literal">MessagingEvent</code> instance.</p>
<p>Starting with version 4.2, you can configure the <code class="literal">ApplicationEventPublishingMessageHandler</code> (<code class="literal">&lt;int-event:outbound-channel-adapter&gt;</code>) with the <code class="literal">publish-payload</code> boolean attribute to publish to the application context <code class="literal">payload</code> as is, instead of wrapping it to a <code class="literal">MessagingEvent</code> instance.</p>
</div>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="feed" href="#feed"></a>16.&nbsp;Feed Adapter</h2></div></div></div>

<p>Spring Integration provides support for syndication through feed adapters.
The implementation is based on the <a class="ulink" href="https://rometools.github.io/rome/" target="_top">ROME Framework</a>.</p>
<p>You need to include this dependency into your project:</p>
<div class="informalexample">
<p>
<b>Maven.&nbsp;</b>

</p><pre class="programlisting"><span class="hl-tag">&lt;dependency&gt;</span>
    <span class="hl-tag">&lt;groupId&gt;</span>org.springframework.integration<span class="hl-tag">&lt;/groupId&gt;</span>
    <span class="hl-tag">&lt;artifactId&gt;</span>spring-integration-feed<span class="hl-tag">&lt;/artifactId&gt;</span>
    <span class="hl-tag">&lt;version&gt;</span>5.1.2.RELEASE<span class="hl-tag">&lt;/version&gt;</span>
<span class="hl-tag">&lt;/dependency&gt;</span></pre><p>

</p>
<p>
<b>Gradle.&nbsp;</b>

</p><pre class="programlisting">compile <span class="hl-string">"org.springframework.integration:spring-integration-feed:5.1.2.RELEASE"</span></pre><p>

</p>
</div>
<p>Web syndication is a way to publish material such as news stories, press releases, blog posts, and other items typically available on a website but also made available in a feed format such as RSS or ATOM.</p>
<p>Spring integration provides support for web syndication through its <span class="emphasis"><em>feed</em></span> adapter and provides convenient namespace-based configuration for it.
To configure the <span class="emphasis"><em>feed</em></span> namespace, include the following elements within the headers of your XML configuration file:</p>
<div class="informalexample">
<pre class="programlisting">xmlns:int-feed="http://www.springframework.org/schema/integration/feed"
xsi:schemaLocation="http://www.springframework.org/schema/integration/feed
	http://www.springframework.org/schema/integration/feed/spring-integration-feed.xsd"</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="feed-inbound-channel-adapter" href="#feed-inbound-channel-adapter"></a>16.1&nbsp;Feed Inbound Channel Adapter</h2></div></div></div>

<p>The only adapter you really need to provide support for retrieving feeds is an inbound channel adapter.
It lets you subscribe to a particular URL.
The following example shows a possible configuration:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-feed:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"feedAdapter"</span>
        <span class="hl-attribute">channel</span>=<span class="hl-value">"feedChannel"</span>
        <span class="hl-attribute">url</span>=<span class="hl-value">"http://feeds.bbci.co.uk/news/rss.xml"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"10000"</span> <span class="hl-attribute">max-messages-per-poll</span>=<span class="hl-value">"100"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/int-feed:inbound-channel-adapter&gt;</span></pre>
</div>
<p>In the preceding configuration, we are subscribing to a URL identified by the <code class="literal">url</code> attribute.</p>
<p>As news items are retrieved, they are converted to messages and sent to a channel identified by the <code class="literal">channel</code> attribute.
The payload of each message is a <code class="literal">com.sun.syndication.feed.synd.SyndEntry</code> instance.
Each one encapsulates various data about a news item (content, dates, authors, and other details).</p>
<p>The inbound feed channel adapter is a polling consumer.
That means that you must provide a poller configuration.
However, one important thing you must understand with regard to a feed is that its inner workings are slightly different then most other polling consumers.
When an inbound feed adapter is started, it does the first poll and receives a <code class="literal">com.sun.syndication.feed.synd.SyndEntryFeed</code> instance.
That object contains multiple <code class="literal">SyndEntry</code> objects.
Each entry is stored in the local entry queue and is released based on the value in the <code class="literal">max-messages-per-poll</code> attribute, such that each message contains a single entry.
If, during retrieval of the entries from the entry queue, the queue has become empty, the adapter attempts to update the feed, thereby populating the queue with more entries (<code class="literal">SyndEntry</code> instances), if any are available.
Otherwise the next attempt to poll for a feed is determined by the trigger of the poller (every ten seconds in the preceding configuration).</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_duplicate_entries" href="#_duplicate_entries"></a>16.2&nbsp;Duplicate Entries</h2></div></div></div>

<p>Polling for a feed can result in entries that have already been processed ("<code class="literal">I already read that news item, why are you showing it to me again?</code>").
Spring Integration provides a convenient mechanism to eliminate the need to worry about duplicate entries.
Each feed entry has a "<code class="literal">published date</code>" field.
Every time a new <code class="literal">Message</code> is generated and sent, Spring Integration stores the value of the latest published date in an instance of the <code class="literal">MetadataStore</code> strategy (see <a class="xref" href="#metadata-store" title="12.5&nbsp;Metadata Store">Section&nbsp;12.5, &#8220;Metadata Store&#8221;</a>).</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The key used to persist the latest published date is the value of the (required) <code class="literal">id</code> attribute of the feed inbound channel adapter component plus the <code class="literal">feedUrl</code> (if any) from the adapter&#8217;s configuration.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_other_options" href="#_other_options"></a>16.3&nbsp;Other Options</h2></div></div></div>

<p>Starting with version 5.0, the deprecated <code class="literal">com.rometools.fetcher.FeedFetcher</code> option has been removed and an overloaded <code class="literal">FeedEntryMessageSource</code> constructor for an <code class="literal">org.springframework.core.io.Resource</code> is provided.
This is useful when the feed source is not an HTTP endpoint but is any other resource (such as local or remote on FTP).
In the <code class="literal">FeedEntryMessageSource</code> logic, such a resource (or provided <code class="literal">URL</code>) is parsed by the <code class="literal">SyndFeedInput</code> to the <code class="literal">SyndFeed</code> object for the processing mentioned earlier.
You can also inject a customized <code class="literal">SyndFeedInput</code> (for example, with the <code class="literal">allowDoctypes</code> option) instance into the <code class="literal">FeedEntryMessageSource</code>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="feed-java-configuration" href="#feed-java-configuration"></a>16.4&nbsp;Java DSL Configuration</h2></div></div></div>

<p>The following Spring Boot application shows an example of how to configure the inbound adapter with the Java DSL:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@SpringBootApplication</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> FeedJavaApplication {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
        <span class="hl-keyword">new</span> SpringApplicationBuilder(FeedJavaApplication.<span class="hl-keyword">class</span>)
            .web(false)
            .run(args);
    }

    <em><span class="hl-annotation" style="color: gray">@Value("org/springframework/integration/feed/sample.rss")</span></em>
    <span class="hl-keyword">private</span> Resource feedResource;

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> MetadataStore metadataStore() {
        PropertiesPersistingMetadataStore metadataStore = <span class="hl-keyword">new</span> PropertiesPersistingMetadataStore();
        metadataStore.setBaseDirectory(tempFolder.getRoot().getAbsolutePath());
        <span class="hl-keyword">return</span> metadataStore;
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> IntegrationFlow feedFlow() {
        <span class="hl-keyword">return</span> IntegrationFlows
                .from(Feed.inboundAdapter(<span class="hl-keyword">this</span>.feedResource, <span class="hl-string">"feedTest"</span>)
                                .metadataStore(metadataStore()),
                        e -&gt; e.poller(p -&gt; p.fixedDelay(<span class="hl-number">100</span>)))
                .channel(c -&gt; c.queue(<span class="hl-string">"entries"</span>))
                .get();
    }

}</pre>
</div>
</div>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="files" href="#files"></a>17.&nbsp;File Support</h2></div></div></div>

<p>Spring Integration&#8217;s file support extends the Spring Integration core with a dedicated vocabulary to deal with reading, writing, and transforming files.</p>
<p>You need to include this dependency into your project:</p>
<div class="informalexample">
<p>
<b>Maven.&nbsp;</b>

</p><pre class="programlisting"><span class="hl-tag">&lt;dependency&gt;</span>
    <span class="hl-tag">&lt;groupId&gt;</span>org.springframework.integration<span class="hl-tag">&lt;/groupId&gt;</span>
    <span class="hl-tag">&lt;artifactId&gt;</span>spring-integration-file<span class="hl-tag">&lt;/artifactId&gt;</span>
    <span class="hl-tag">&lt;version&gt;</span>5.1.2.RELEASE<span class="hl-tag">&lt;/version&gt;</span>
<span class="hl-tag">&lt;/dependency&gt;</span></pre><p>

</p>
<p>
<b>Gradle.&nbsp;</b>

</p><pre class="programlisting">compile <span class="hl-string">"org.springframework.integration:spring-integration-file:5.1.2.RELEASE"</span></pre><p>

</p>
</div>
<p>It provides a namespace that enables elements defining channel adapters dedicated to files and support for transformers that can read file contents into strings or byte arrays.</p>
<p>This section explains the workings of <code class="literal">FileReadingMessageSource</code> and <code class="literal">FileWritingMessageHandler</code> and how to configure them as beans.
It also discusses the support for dealing with files through file-specific implementations of <code class="literal">Transformer</code>.
Finally, it explains the file-specific namespace.</p>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="file-reading" href="#file-reading"></a>17.1&nbsp;Reading Files</h2></div></div></div>

<p>A <code class="literal">FileReadingMessageSource</code> can be used to consume files from the filesystem.
This is an implementation of <code class="literal">MessageSource</code> that creates messages from a file system directory.
The following example shows how to configure a <code class="literal">FileReadingMessageSource</code>:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"pollableFileSource"</span>
    <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.file.FileReadingMessageSource"</span>
    <span class="hl-attribute">p:directory</span>=<span class="hl-value">"${input.directory}"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>To prevent creating messages for certain files, you can supply a <code class="literal">FileListFilter</code>.
By default, we use the following filters:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">IgnoreHiddenFileListFilter</code>
</li><li class="listitem">
<code class="literal">AcceptOnceFileListFilter</code>
</li></ul></div>
<p>The <code class="literal">IgnoreHiddenFileListFilter</code> ensures that hidden files are not processed.
Note that the exact definition of hidden is system-dependent.
For example, on UNIX-based systems, a file beginning with a period character is considered to be hidden.
Microsoft Windows, on the other hand, has a dedicated file attribute to indicate hidden files.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Version 4.2 introduced the <code class="literal">IgnoreHiddenFileListFilter</code>.
In prior versions, hidden files were included.
With the default configuration, the <code class="literal">IgnoreHiddenFileListFilter</code> is triggered first, followed by the <code class="literal">AcceptOnceFileListFilter</code>.</p>
</td></tr></table></div>
<p>The <code class="literal">AcceptOnceFileListFilter</code> ensures files are picked up only once from the directory.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The <code class="literal">AcceptOnceFileListFilter</code> stores its state in memory.
If you wish the state to survive a system restart, you can use the <code class="literal">FileSystemPersistentAcceptOnceFileListFilter</code>.
This filter stores the accepted file names in a <code class="literal">MetadataStore</code> implementation (see <a class="xref" href="#metadata-store" title="12.5&nbsp;Metadata Store">Section&nbsp;12.5, &#8220;Metadata Store&#8221;</a>).
This filter matches on the filename and modified time.</p>
<p>Since version 4.0, this filter requires a <code class="literal">ConcurrentMetadataStore</code>.
When used with a shared data store (such as <code class="literal">Redis</code> with the <code class="literal">RedisMetadataStore</code>), it lets filter keys be shared across multiple application instances or across a network file share being used by multiple servers.</p>
<p>Since version 4.1.5, this filter has a new property (<code class="literal">flushOnUpdate</code>), which causes it to flush the metadata store on every update (if the store implements <code class="literal">Flushable</code>).</p>
</td></tr></table></div>
<p>The following example configures a <code class="literal">FileReadingMessageSource</code> with a filter:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"pollableFileSource"</span>
    <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.file.FileReadingMessageSource"</span>
    <span class="hl-attribute">p:inputDirectory</span>=<span class="hl-value">"${input.directory}"</span>
    <span class="hl-attribute">p:filter-ref</span>=<span class="hl-value">"customFilterBean"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>A common problem with reading files is that a file may be detected before it is ready (that is, some other process may still be writing the file).
The default <code class="literal">AcceptOnceFileListFilter</code> does not prevent this.
In most cases, this can be prevented if the file-writing process renames each file as soon as it is ready for reading.
A <code class="literal">filename-pattern</code> or <code class="literal">filename-regex</code> filter that accepts only files that are ready (perhaps based on a known suffix), composed with the default <code class="literal">AcceptOnceFileListFilter</code>, allows for this situation.
The <code class="literal">CompositeFileListFilter</code> enables the composition, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"pollableFileSource"</span>
    <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.file.FileReadingMessageSource"</span>
    <span class="hl-attribute">p:inputDirectory</span>=<span class="hl-value">"${input.directory}"</span>
    <span class="hl-attribute">p:filter-ref</span>=<span class="hl-value">"compositeFilter"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"compositeFilter"</span>
    <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.file.filters.CompositeFileListFilter"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg&gt;</span>
        <span class="hl-tag">&lt;list&gt;</span>
            <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.file.filters.AcceptOnceFileListFilter"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.file.filters.RegexPatternFileListFilter"</span><span class="hl-tag">&gt;</span>
                <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"^test.*$"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;/bean&gt;</span>
        <span class="hl-tag">&lt;/list&gt;</span>
    <span class="hl-tag">&lt;/constructor-arg&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
</div>
<p>If it is not possible to create the file with a temporary name and rename to the final name, Spring Integration provides another alternative.
Version 4.2 added the <code class="literal">LastModifiedFileListFilter</code>.
This filter can be configured with an <code class="literal">age</code> property so that only files older than this value are passed by the filter.
The age defaults to 60 seconds, but you should choose an age that is large enough to avoid picking up a file early (due to, say, network glitches).
The following example shows how to configure a <code class="literal">LastModifiedFileListFilter</code>:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"filter"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.file.filters.LastModifiedFileListFilter"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"age"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"120"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
</div>
<p>Starting with version 4.3.7, a <code class="literal">ChainFileListFilter</code> (an extension of <code class="literal">CompositeFileListFilter</code>) has been introduced to allow scenarios when subsequent filters should only see the result of the previous filter.
(With the <code class="literal">CompositeFileListFilter</code>, all filters see all the files, but it passes only files that have passed all filters).
An example of where the new behavior is required is a combination of <code class="literal">LastModifiedFileListFilter</code> and <code class="literal">AcceptOnceFileListFilter</code>, when we do not wish to accept the file until some amount of time has elapsed.
With the <code class="literal">CompositeFileListFilter</code>, since the <code class="literal">AcceptOnceFileListFilter</code> sees all the files on the first pass, it does not pass it later when the other filter does.
The <code class="literal">CompositeFileListFilter</code> approach is useful when a pattern filter is combined with a custom filter that looks for a secondary file to indicate that file transfer is complete.
The pattern filter might only pass the primary file (such as <code class="literal">something.txt</code>) but the "<code class="literal">done</code>" filter needs to see whether (for example) <code class="literal">something.done</code> is present.</p>
<p>Say we have files <code class="literal">a.txt</code>, <code class="literal">a.done</code>, and <code class="literal">b.txt</code>.</p>
<p>The pattern filter passes only <code class="literal">a.txt</code> and <code class="literal">b.txt</code>, while the "<code class="literal">done</code>" filter sees all three files and passes only <code class="literal">a.txt</code>.
The final result of the composite filter is that only <code class="literal">a.txt</code> is released.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>With the <code class="literal">ChainFileListFilter</code>, if any filter in the chain returns an empty list, the remaining filters are not invoked.</p>
</td></tr></table></div>
<p>Version 5.0 introduced an <code class="literal">ExpressionFileListFilter</code> to execute SpEL expression against a file as a context evaluation root object.
For this purpose, all the XML components for file handling (local and remote), along with an existing <code class="literal">filter</code> attribute, have been supplied with the <code class="literal">filter-expression</code> option, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-file:inbound-channel-adapter</span>
        <span class="hl-attribute">directory</span>=<span class="hl-value">"${inputdir}"</span>
        <span class="hl-attribute">filter-expression</span>=<span class="hl-value">"name matches '.text'"</span>
        <span class="hl-attribute">auto-startup</span>=<span class="hl-value">"false"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>Version 5.0.5 introduced the <code class="literal">DiscardAwareFileListFilter</code> implementations that have an interest in rejected files.
For this purpose, such a filter implementation should be supplied with a callback through <code class="literal">addDiscardCallback(Consumer&lt;File&gt;)</code>.
In the framework, this functionality is used from the <code class="literal">FileReadingMessageSource.WatchServiceDirectoryScanner</code>, in combination with <code class="literal">LastModifiedFileListFilter</code>.
Unlike the regular <code class="literal">DirectoryScanner</code>, the <code class="literal">WatchService</code> provides files for processing according to the events on the target file system.
At the moment of polling an internal queue with those files, the <code class="literal">LastModifiedFileListFilter</code> may discard them because they are too young relative to its configured <code class="literal">age</code>.
Therefore, we lose the file for future possible considerations.
The discard callback hook lets us retain the file in the internal queue so that it is available to be checked against the <code class="literal">age</code> in subsequent polls.
The <code class="literal">CompositeFileListFilter</code> also implements a <code class="literal">DiscardAwareFileListFilter</code> and populates a discard callback to all its <code class="literal">DiscardAwareFileListFilter</code> delegates.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Since <code class="literal">CompositeFileListFilter</code> matches the files against all delegates, the <code class="literal">discardCallback</code> may be called several times for the same file.</p>
</td></tr></table></div>
<p>Starting with version 5.1, the <code class="literal">FileReadingMessageSource</code> doesn&#8217;t check a directory for existence and doesn&#8217;t create it until its <code class="literal">start()</code> is called (typically via wrapping <code class="literal">SourcePollingChannelAdapter</code>).
Previously, there was no simple way to prevent an operation system permissions error when referencing the directory, for example from tests, or when permissions are applied later.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_message_headers" href="#_message_headers"></a>17.1.1&nbsp;Message Headers</h3></div></div></div>

<p>Starting with version 5.0, the <code class="literal">FileReadingMessageSource</code> (in addition to the <code class="literal">payload</code> as a polled <code class="literal">File</code>) populates the following headers to the outbound <code class="literal">Message</code>:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">FileHeaders.FILENAME</code>: The <code class="literal">File.getName()</code> of the file to send.
Can be used for subsequent rename or copy logic.
</li><li class="listitem">
<code class="literal">FileHeaders.ORIGINAL_FILE</code>: The <code class="literal">File</code> object itself.
Typically, this header is populated automatically by framework components (such as <a class="link" href="#file-splitter" title="17.4&nbsp;File Splitter">splitters</a> or <a class="link" href="#file-transforming" title="17.3&nbsp;File Transformers">transformers</a>) when we lose the original <code class="literal">File</code> object.
However, for consistency and convenience with any other custom use cases, this header can be useful to get access to the original file.
</li><li class="listitem">
<code class="literal">FileHeaders.RELATIVE_PATH</code>: A new header introduced to represent the part of file path relative to the root directory for the scan.
This header can be useful when the requirement is to restore a source directory hierarchy in the other places.
For this purpose, the <code class="literal">DefaultFileNameGenerator</code> (see "`<a class="xref" href="#file-writing-file-names" title="17.2.1&nbsp;Generating File Names">Section&nbsp;17.2.1, &#8220;Generating File Names&#8221;</a>) can be configured to use this header.
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_directory_scanning_and_polling" href="#_directory_scanning_and_polling"></a>17.1.2&nbsp;Directory Scanning and Polling</h3></div></div></div>

<p>The <code class="literal">FileReadingMessageSource</code> does not produce messages for files from the directory immediately.
It uses an internal queue for <span class="emphasis"><em>eligible files</em></span> returned by the <code class="literal">scanner</code>.
The <code class="literal">scanEachPoll</code> option is used to ensure that the internal queue is refreshed with the latest input directory content on each poll.
By default (<code class="literal">scanEachPoll = false</code>), the <code class="literal">FileReadingMessageSource</code> empties its queue before scanning the directory again.
This default behavior is particularly useful to reduce scans of large numbers of files in a directory.
However, in cases where custom ordering is required, it is important to consider the effects of setting this flag to <code class="literal">true</code>.
The order in which files are processed may not be as expected.
By default, files in the queue are processed in their natural (<code class="literal">path</code>) order.
New files added by a scan, even when the queue already has files, are inserted in the appropriate position to maintain that natural order.
To customize the order, the <code class="literal">FileReadingMessageSource</code> can accept a <code class="literal">Comparator&lt;File&gt;</code> as a constructor argument.
It is used by the internal (<code class="literal">PriorityBlockingQueue</code>) to reorder its content according to the business requirements.
Therefore, to process files in a specific order, you should provide a comparator to the <code class="literal">FileReadingMessageSource</code> rather than ordering the list produced by a custom <code class="literal">DirectoryScanner</code>.</p>
<p>Version 5.0 introduced <code class="literal">RecursiveDirectoryScanner</code> to perform file tree visiting.
The implementation is based on the <code class="literal">Files.walk(Path start, int maxDepth, FileVisitOption... options)</code> functionality.
The root directory (<code class="literal">DirectoryScanner.listFiles(File)</code>) argument is excluded from the result.
All other sub-directories inclusions and exclusions are based on the target <code class="literal">FileListFilter</code> implementation.
For example, the <code class="literal">SimplePatternFileListFilter</code> filters out directories by default.
See <a class="ulink" href="https://docs.spring.io/spring-integration/api/org/springframework/integration/file/filters/AbstractDirectoryAwareFileListFilter.html" target="_top"><code class="literal">AbstractDirectoryAwareFileListFilter</code></a> and its implementations for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="file-namespace-support" href="#file-namespace-support"></a>17.1.3&nbsp;Namespace Support</h3></div></div></div>

<p>The configuration for file reading can be simplified by using the file-specific namespace.
To do so, use the following template:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
  <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
  <span class="hl-attribute">xmlns:int</span>=<span class="hl-value">"http://www.springframework.org/schema/integration"</span>
  <span class="hl-attribute">xmlns:int-file</span>=<span class="hl-value">"http://www.springframework.org/schema/integration/file"</span>
  <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"http://www.springframework.org/schema/beans
    http://www.springframework.org/schema/beans/spring-beans.xsd
    http://www.springframework.org/schema/integration
    http://www.springframework.org/schema/integration/spring-integration.xsd
    http://www.springframework.org/schema/integration/file
    http://www.springframework.org/schema/integration/file/spring-integration-file.xsd"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;/beans&gt;</span></pre>
</div>
<p>Within this namespace, you can reduce the <code class="literal">FileReadingMessageSource</code> and wrap it in an inbound Channel Adapter, as follows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-file:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"filesIn1"</span>
    <span class="hl-attribute">directory</span>=<span class="hl-value">"file:${input.directory}"</span> <span class="hl-attribute">prevent-duplicates</span>=<span class="hl-value">"true"</span> <span class="hl-attribute">ignore-hidden</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int-file:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"filesIn2"</span>
    <span class="hl-attribute">directory</span>=<span class="hl-value">"file:${input.directory}"</span>
    <span class="hl-attribute">filter</span>=<span class="hl-value">"customFilterBean"</span><span class="hl-tag"> /&gt;</span>

<span class="hl-tag">&lt;int-file:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"filesIn3"</span>
    <span class="hl-attribute">directory</span>=<span class="hl-value">"file:${input.directory}"</span>
    <span class="hl-attribute">filename-pattern</span>=<span class="hl-value">"test*"</span><span class="hl-tag"> /&gt;</span>

<span class="hl-tag">&lt;int-file:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"filesIn4"</span>
    <span class="hl-attribute">directory</span>=<span class="hl-value">"file:${input.directory}"</span>
    <span class="hl-attribute">filename-regex</span>=<span class="hl-value">"test[0-9]+\.txt"</span><span class="hl-tag"> /&gt;</span></pre>
</div>
<p>The first channel adapter example relies on the default <code class="literal">FileListFilter</code> implementations:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">IgnoreHiddenFileListFilter</code> (do not process hidden files)
</li><li class="listitem">
<code class="literal">AcceptOnceFileListFilter</code> (prevent duplication)
</li></ul></div>
<p>Therefore, you can also leave off the <code class="literal">prevent-duplicates</code> and <code class="literal">ignore-hidden</code> attributes, as they are <code class="literal">true</code> by default.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Spring Integration 4.2 introduced the <code class="literal">ignore-hidden</code> attribute. In prior versions, hidden files were included.</p>
</td></tr></table></div>
<p>The second channel adapter example uses a custom filter, the third uses the <code class="literal">filename-pattern</code> attribute to add an <code class="literal">AntPathMatcher</code> based filter, and the fourth uses the <code class="literal">filename-regex</code> attribute to add a regular expression pattern-based filter to the <code class="literal">FileReadingMessageSource</code>.
The <code class="literal">filename-pattern</code> and <code class="literal">filename-regex</code> attributes are each mutually exclusive with the regular <code class="literal">filter</code> reference attribute.
However, you can use the <code class="literal">filter</code> attribute to reference an instance of <code class="literal">CompositeFileListFilter</code> that combines any number of filters, including one or more pattern-based filters to fit your particular needs.</p>
<p>When multiple processes read from the same directory, you may want to lock files to prevent them from being picked up concurrently.
To do so, you can use a <code class="literal">FileLocker</code>.
There is a <code class="literal">java.nio</code>-based implementation available, but it is also possible to implement your own locking scheme.
The <code class="literal">nio</code> locker can be injected as follows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-file:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"filesIn"</span>
    <span class="hl-attribute">directory</span>=<span class="hl-value">"file:${input.directory}"</span> <span class="hl-attribute">prevent-duplicates</span>=<span class="hl-value">"true"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int-file:nio-locker/&gt;</span>
<span class="hl-tag">&lt;/int-file:inbound-channel-adapter&gt;</span></pre>
</div>
<p>You can configure a custom locker as follows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-file:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"filesIn"</span>
    <span class="hl-attribute">directory</span>=<span class="hl-value">"file:${input.directory}"</span> <span class="hl-attribute">prevent-duplicates</span>=<span class="hl-value">"true"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int-file:locker</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"customLocker"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-file:inbound-channel-adapter&gt;</span></pre>
</div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>When a file inbound adapter is configured with a locker, it takes responsibility for acquiring a lock before the file is allowed to be received.
It does not assume the responsibility to unlock the file.
If you have processed the file and keep the locks hanging around, you have a memory leak.
If this is a problem, you should call <code class="literal">FileLocker.unlock(File file)</code> yourself at the appropriate time.</p>
</td></tr></table></div>
<p>When filtering and locking files is not enough, you might need to control the way files are listed entirely.
To implement this type of requirement, you can use an implementation of <code class="literal">DirectoryScanner</code>.
This scanner lets you determine exactly what files are listed in each poll.
This is also the interface that Spring Integration uses internally to wire <code class="literal">FileListFilter</code> instances and <code class="literal">FileLocker</code> to the <code class="literal">FileReadingMessageSource</code>.
You can inject a custom <code class="literal">DirectoryScanner</code> into the <code class="literal">&lt;int-file:inbound-channel-adapter/&gt;</code> on the <code class="literal">scanner</code> attribute, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-file:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"filesIn"</span> <span class="hl-attribute">directory</span>=<span class="hl-value">"file:${input.directory}"</span>
     <span class="hl-attribute">scanner</span>=<span class="hl-value">"customDirectoryScanner"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>Doing so gives you full freedom to choose the ordering, listing, and locking strategies.</p>
<p>It is also important to understand that filters (including <code class="literal">patterns</code>, <code class="literal">regex</code>, <code class="literal">prevent-duplicates</code>, and others) and <code class="literal">locker</code> instances are actually used by the <code class="literal">scanner</code>.
Any of these attributes set on the adapter are subsequently injected into the internal <code class="literal">scanner</code>.
For the case of an external <code class="literal">scanner</code>, all filter and locker attributes are prohibited on the <code class="literal">FileReadingMessageSource</code>.
They must be specified (if required) on that custom <code class="literal">DirectoryScanner</code>.
In other words, if you inject a <code class="literal">scanner</code> into the <code class="literal">FileReadingMessageSource</code>, you should supply <code class="literal">filter</code> and <code class="literal">locker</code> on that <code class="literal">scanner</code>, not on the <code class="literal">FileReadingMessageSource</code>.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>By default, the <code class="literal">DefaultDirectoryScanner</code> uses an <code class="literal">IgnoreHiddenFileListFilter</code> and an <code class="literal">AcceptOnceFileListFilter</code>.
To prevent their use, you can configure your own filter (such as <code class="literal">AcceptAllFileListFilter</code>) or even set it to <code class="literal">null</code>.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="watch-service-directory-scanner" href="#watch-service-directory-scanner"></a>17.1.4&nbsp;<code class="literal">WatchServiceDirectoryScanner</code></h3></div></div></div>

<p>The <code class="literal">FileReadingMessageSource.WatchServiceDirectoryScanner</code> relies on file-system events when new files are added to the directory.
During initialization, the directory is registered to generate events.
The initial file list is also built during initialization.
While walking the directory tree, any subdirectories encountered are also registered to generate events.
On the first poll, the initial file list from walking the directory is returned.
On subsequent polls, files from new creation events are returned.
If a new subdirectory is added, its creation event is used to walk the new subtree to find existing files and register any new subdirectories found.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>There is an issue with <code class="literal">WatchKey</code> when its internal events <code class="literal">queue</code> is not drained by the program as quickly as the directory modification events occur.
If the queue size is exceeded, a <code class="literal">StandardWatchEventKinds.OVERFLOW</code> is emitted to indicate that some file system events may be lost.
In this case, the root directory is re-scanned completely.
To avoid duplicates, consider using an appropriate <code class="literal">FileListFilter</code> (such as the <code class="literal">AcceptOnceFileListFilter</code>) or removing files when processing is complete.</p>
</td></tr></table></div>
<p>The <code class="literal">WatchServiceDirectoryScanner</code> can be enabled through the <code class="literal">FileReadingMessageSource.use-watch-service</code> option, which is mutually exclusive with the <code class="literal">scanner</code> option.
An internal <code class="literal">FileReadingMessageSource.WatchServiceDirectoryScanner</code> instance is populated for the provided <code class="literal">directory</code>.</p>
<p>In addition, now the <code class="literal">WatchService</code> polling logic can track the <code class="literal">StandardWatchEventKinds.ENTRY_MODIFY</code> and <code class="literal">StandardWatchEventKinds.ENTRY_DELETE</code>.</p>
<p>If you need to track the modification of existing files as well as new files, you should implement the <code class="literal">ENTRY_MODIFY</code> events logic in the <code class="literal">FileListFilter</code>.
Otherwise, the files from those events are treated the same way.</p>
<p>The <code class="literal">ResettableFileListFilter</code> implementations pick up the <code class="literal">ENTRY_DELETE</code> events.
Consequently, their files are provided for the <code class="literal">remove()</code> operation.
When this event is enabled, filters such as the <code class="literal">AcceptOnceFileListFilter</code> have the file removed
As a result, if a file with the same name appears, it passes the filter and is sent as a message.</p>
<p>For this purpose, the <code class="literal">watch-events</code> property (<code class="literal">FileReadingMessageSource.setWatchEvents(WatchEventType... watchEvents)</code>) has been introduced.
(<code class="literal">WatchEventType</code> is a public inner enumeration in <code class="literal">FileReadingMessageSource</code>.)
With such an option, we can use one downstream flow logic for new files and use some other logic for modified files.
The following example shows how to configure different logic for create and modify events in the same directory:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-file:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"newFiles"</span>
     <span class="hl-attribute">directory</span>=<span class="hl-value">"${input.directory}"</span>
     <span class="hl-attribute">use-watch-service</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int-file:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"modifiedFiles"</span>
     <span class="hl-attribute">directory</span>=<span class="hl-value">"${input.directory}"</span>
     <span class="hl-attribute">use-watch-service</span>=<span class="hl-value">"true"</span>
     <span class="hl-attribute">filter</span>=<span class="hl-value">"acceptAllFilter"</span>
     <span class="hl-attribute">watch-events</span>=<span class="hl-value">"MODIFY"</span><span class="hl-tag">/&gt;</span> <span class="hl-comment">&lt;!-- The default is CREATE. --&gt;</span></pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_limiting_memory_consumption" href="#_limiting_memory_consumption"></a>17.1.5&nbsp;Limiting Memory Consumption</h3></div></div></div>

<p>You can use a <code class="literal">HeadDirectoryScanner</code> to limit the number of files retained in memory.
This can be useful when scanning large directories.
With XML configuration, this is enabled by setting the <code class="literal">queue-size</code> property on the inbound channel adapter.</p>
<p>Prior to version 4.2, this setting was incompatible with the use of any other filters.
Any other filters (including <code class="literal">prevent-duplicates="true"</code>) overwrote the filter used to limit the size.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The use of a <code class="literal">HeadDirectoryScanner</code> is incompatible with an <code class="literal">AcceptOnceFileListFilter</code>.
Since all filters are consulted during the poll decision, the <code class="literal">AcceptOnceFileListFilter</code> does not know that other filters might be temporarily filtering files.
Even if files that were previously filtered by the <code class="literal">HeadDirectoryScanner.HeadFilter</code> are now available, the <code class="literal">AcceptOnceFileListFilter</code> filters them.</p>
<p>Generally, instead of using an <code class="literal">AcceptOnceFileListFilter</code> in this case, you should remove the processed files so that the previously filtered files are available on a future poll.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_with_java_configuration_7" href="#_configuring_with_java_configuration_7"></a>17.1.6&nbsp;Configuring with Java Configuration</h3></div></div></div>

<p>The following Spring Boot application shows an example of how to configure the inbound adapter with Java configuration:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@SpringBootApplication</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> FileReadingJavaApplication {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
        <span class="hl-keyword">new</span> SpringApplicationBuilder(FileReadingJavaApplication.<span class="hl-keyword">class</span>)
            .web(false)
            .run(args);
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> MessageChannel fileInputChannel() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> DirectChannel();
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <em><span class="hl-annotation" style="color: gray">@InboundChannelAdapter(value = "fileInputChannel", poller = @Poller(fixedDelay = "1000"))</span></em>
    <span class="hl-keyword">public</span> MessageSource&lt;File&gt; fileReadingMessageSource() {
         FileReadingMessageSource source = <span class="hl-keyword">new</span> FileReadingMessageSource();
         source.setDirectory(<span class="hl-keyword">new</span> File(INBOUND_PATH));
         source.setFilter(<span class="hl-keyword">new</span> SimplePatternFileListFilter(<span class="hl-string">"*.txt"</span>));
         <span class="hl-keyword">return</span> source;
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <em><span class="hl-annotation" style="color: gray">@Transformer(inputChannel = "fileInputChannel", outputChannel = "processFileChannel")</span></em>
    <span class="hl-keyword">public</span> FileToStringTransformer fileToStringTransformer() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> FileToStringTransformer();
    }

}</pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_with_the_java_dsl_8" href="#_configuring_with_the_java_dsl_8"></a>17.1.7&nbsp;Configuring with the Java DSL</h3></div></div></div>

<p>The following Spring Boot application shows an example of how to configure the inbound adapter with the Java DSL:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@SpringBootApplication</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> FileReadingJavaApplication {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
        <span class="hl-keyword">new</span> SpringApplicationBuilder(FileReadingJavaApplication.<span class="hl-keyword">class</span>)
            .web(false)
            .run(args);
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> IntegrationFlow fileReadingFlow() {
         <span class="hl-keyword">return</span> IntegrationFlows
                  .from(s -&gt; s.file(<span class="hl-keyword">new</span> File(INBOUND_PATH))
                              .patternFilter(<span class="hl-string">"*.txt"</span>),
                          e -&gt; e.poller(Pollers.fixedDelay(<span class="hl-number">1000</span>)))
                  .transform(Files.toStringTransformer())
                  .channel(<span class="hl-string">"processFileChannel"</span>)
                  .get();
        }

}</pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="file-tailing" href="#file-tailing"></a>17.1.8&nbsp;'tail&#8217;ing Files</h3></div></div></div>

<p>Another popular use case is to get <span class="emphasis"><em>lines</em></span> from the end (or tail) of a file, capturing new lines when they are added.
Two implementations are provided.
The first, <code class="literal">OSDelegatingFileTailingMessageProducer</code>, uses the native <code class="literal">tail</code> command (on operating systems that have one).
This is generally the most efficient implementation on those platforms.
For operating systems that do not have a <code class="literal">tail</code> command, the second implementation, <code class="literal">ApacheCommonsFileTailingMessageProducer</code>, uses the Apache <code class="literal">commons-io</code> <code class="literal">Tailer</code> class.</p>
<p>In both cases, file system events, such as files being unavailable and other events, are published as <code class="literal">ApplicationEvent</code> instances by using the normal Spring event publishing mechanism.
Examples of such events include the following:</p>
<div class="informalexample">
<pre class="programlisting">[message=tail: cannot open `/tmp/somefile<span class="hl-string">' for reading:
               No such file or directory, file=/tmp/somefile]

[message=tail: `/tmp/somefile'</span> has become accessible, file=/tmp/somefile]

[message=tail: `/tmp/somefile<span class="hl-string">' has become inaccessible:
               No such file or directory, file=/tmp/somefile]

[message=tail: `/tmp/somefile'</span> has appeared;
               following end of new file, file=/tmp/somefile]</pre>
</div>
<p>The sequence of events shown in the preceding example might occur, for example, when a file is rotated.</p>
<p>Starting with version 5.0, a <code class="literal">FileTailingIdleEvent</code> is emitted when there is no data in the file during <code class="literal">idleEventInterval</code>.
The following example shows what such an event looks like:</p>
<div class="informalexample">
<pre class="programlisting">[message=Idle timeout, file=/tmp/somefile] [idle time=<span class="hl-number">5438</span>]</pre>
</div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Not all platforms that support a <code class="literal">tail</code> command provide these status messages.</p>
</td></tr></table></div>
<p>Messages emitted from these endpoints have the following headers:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">FileHeaders.ORIGINAL_FILE</code>: The <code class="literal">File</code> object
</li><li class="listitem">
<code class="literal">FileHeaders.FILENAME</code>: The file name (<code class="literal">File.getName()</code>)
</li></ul></div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>In versions prior to version 5.0, the <code class="literal">FileHeaders.FILENAME</code> header contained a string representation of the file&#8217;s absolute path.
You can now obtain that string representation by calling <code class="literal">getAbsolutePath()</code> on the original file header.</p>
</td></tr></table></div>
<p>The following example creates a native adapter with the default options (<span class="emphasis"><em>-F -n 0</em></span>, meaning to follow the file name from the current end).</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-file:tail-inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"native"</span>
	<span class="hl-attribute">channel</span>=<span class="hl-value">"input"</span>
	<span class="hl-attribute">task-executor</span>=<span class="hl-value">"exec"</span>
	<span class="hl-attribute">file</span>=<span class="hl-value">"/tmp/foo"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>The following example creates a native adapter with <span class="emphasis"><em>-F -n +0</em></span> options (meaning follow the file name, emitting all existing lines).</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-file:tail-inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"native"</span>
	<span class="hl-attribute">channel</span>=<span class="hl-value">"input"</span>
	<span class="hl-attribute">native-options</span>=<span class="hl-value">"-F -n +0"</span>
	<span class="hl-attribute">task-executor</span>=<span class="hl-value">"exec"</span>
	<span class="hl-attribute">file-delay</span>=<span class="hl-value">10000</span>
	<span class="hl-attribute">file</span>=<span class="hl-value">"/tmp/foo"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>If the <code class="literal">tail</code> command fails (on some platforms, a missing file causes the <code class="literal">tail</code> to fail, even with <code class="literal">-F</code> specified), the command is retried every 10 seconds.</p>
<p>By default, native adapters capture from standard output and send the content as messages.
They also capture from standard error to raise events.
Starting with version 4.3.6, you can discard the standard error events by setting the <code class="literal">enable-status-reader</code> to <code class="literal">false</code>, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-file:tail-inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"native"</span>
	<span class="hl-attribute">channel</span>=<span class="hl-value">"input"</span>
	<span class="hl-attribute">enable-status-reader</span>=<span class="hl-value">"false"</span>
	<span class="hl-attribute">task-executor</span>=<span class="hl-value">"exec"</span>
	<span class="hl-attribute">file</span>=<span class="hl-value">"/tmp/foo"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>In the following example, <code class="literal">IdleEventInterval</code> is set to <code class="literal">5000</code>, meaning that, if no lines are written for five seconds, <code class="literal">FileTailingIdleEvent</code> is triggered every five seconds:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-file:tail-inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"native"</span>
	<span class="hl-attribute">channel</span>=<span class="hl-value">"input"</span>
	<span class="hl-attribute">idle-event-interval</span>=<span class="hl-value">"5000"</span>
	<span class="hl-attribute">task-executor</span>=<span class="hl-value">"exec"</span>
	<span class="hl-attribute">file</span>=<span class="hl-value">"/tmp/somefile"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>This can be useful when you need to stop the adapter.</p>
<p>The following example creates an Apache <code class="literal">commons-io</code> <code class="literal">Tailer</code> adapter that examines the file for new lines every two seconds and checks for existence of a missing file every ten seconds:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-file:tail-inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"apache"</span>
	<span class="hl-attribute">channel</span>=<span class="hl-value">"input"</span>
	<span class="hl-attribute">task-executor</span>=<span class="hl-value">"exec"</span>
	<span class="hl-attribute">file</span>=<span class="hl-value">"/tmp/bar"</span>
	<span class="hl-attribute">delay</span>=<span class="hl-value">"2000"</span>
	<span class="hl-attribute">end</span>=<span class="hl-value">"false"</span>             <a name="CO23-1" href="#CO23-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
	reopen="true"           <a name="CO23-2" href="#CO23-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
	file-delay="10000"/&gt;</pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO23-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The file is tailed from the beginning (<code class="literal">end="false"</code>) instead of the end (which is the default).</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO23-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The file is reopened for each chunk (the default is to keep the file open).</p>
</td></tr></table></div>
</div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Specifying the <code class="literal">delay</code>, <code class="literal">end</code> or <code class="literal">reopen</code> attributes forces the use of the Apache <code class="literal">commons-io</code> adapter and makes the <code class="literal">native-options</code> attribute unavailable.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="file-incomplete" href="#file-incomplete"></a>17.1.9&nbsp;Dealing With Incomplete Data</h3></div></div></div>

<p>A common problem in file-transfer scenarios is how to determine that the transfer is complete so that you do not start reading an incomplete file.
A common technique to solve this problem is to write the file with a temporary name and then atomically rename it to the final name.
This technique, together with a filter that masks the temporary file from being picked up by the consumer, provides a robust solution.
This technique is used by Spring Integration components that write files (locally or remotely).
By default, they append <code class="literal">.writing</code> to the file name and remove it when the transfer is complete.</p>
<p>Another common technique is to write a second "<code class="literal">marker</code>" file to indicate that the file transfer is complete.
In this scenario, you should not consider <code class="literal">somefile.txt</code> (for example) to be available for use until <code class="literal">somefile.txt.complete</code> is also present.
Spring Integration version 5.0 introduced new filters to support this mechanism.
Implementations are provided for the file system (<code class="literal">FileSystemMarkerFilePresentFileListFilter</code>), <a class="link" href="#ftp-incomplete" title="18.4.6&nbsp;Dealing With Incomplete Data">FTP</a> and <a class="link" href="#sftp-incomplete" title="30.6.5&nbsp;Dealing With Incomplete Data">SFTP</a>.
They are configurable such that the marker file can have any name, although it is usually related to the file being transferred.
See the <a class="ulink" href="https://docs.spring.io/spring-integration/api/org/springframework/integration/file/filters/FileSystemMarkerFilePresentFileListFilter.html" target="_top">Javadoc</a> for more information.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="file-writing" href="#file-writing"></a>17.2&nbsp;Writing files</h2></div></div></div>

<p>To write messages to the file system, you can use a <a class="ulink" href="http://docs.spring.io/spring-integration/api/org/springframework/integration/file/FileWritingMessageHandler.html" target="_top"><code class="literal">FileWritingMessageHandler</code></a>.
This class can deal with the following payload types:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">File</code>
</li><li class="listitem">
<code class="literal">String</code>
</li><li class="listitem">
byte array
</li><li class="listitem">
<code class="literal">InputStream</code> (since <span class="emphasis"><em>version 4.2</em></span>)
</li></ul></div>
<p>For a String payload, you can configure the encoding and the charset.</p>
<p>To make things easier, you can configure the <code class="literal">FileWritingMessageHandler</code> as part of an outbound channel adapter or outbound gateway by using the XML namespace.</p>
<p>Starting with version 4.3, you can specify the buffer size to use when writing files.</p>
<p>Starting with version 5.1, you can provide a <code class="literal">BiConsumer&lt;File, Message&lt;?&gt;&gt;</code> <code class="literal">newFileCallback</code> which is triggered if you use <code class="literal">FileExistsMode.APPEND</code> or <code class="literal">FileExistsMode.APPEND_NO_FLUSH</code> and a new file has to be created.
This callback receives a newly created file and the message which triggered it.
This callback could be used to write a CSV header defined in the message header, for an example.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="file-writing-file-names" href="#file-writing-file-names"></a>17.2.1&nbsp;Generating File Names</h3></div></div></div>

<p>In its simplest form, the <code class="literal">FileWritingMessageHandler</code> requires only a destination directory for writing the files.
The name of the file to be written is determined by the handler&#8217;s <a class="ulink" href="http://docs.spring.io/spring-integration/api/org/springframework/integration/file/FileNameGenerator.html" target="_top"><code class="literal">FileNameGenerator</code></a>.
The <a class="ulink" href="http://docs.spring.io/spring-integration/api/org/springframework/integration/file/DefaultFileNameGenerator.html" target="_top">default implementation</a> looks for a message header whose key matches the constant defined as <a class="ulink" href="http://docs.spring.io/spring-integration/api/constant-values.html#org.springframework.integration.file.FileHeaders.FILENAME" target="_top"><code class="literal">FileHeaders.FILENAME</code></a>.</p>
<p>Alternatively, you can specify an expression to be evaluated against the message to generate a file name&#8201;&#8212;&#8201;for example, <code class="literal">headers['myCustomHeader'] + '.something'</code>.
The expression must evaluate to a <code class="literal">String</code>.
For convenience, the <code class="literal">DefaultFileNameGenerator</code> also provides the <code class="literal">setHeaderName</code> method, letting you explicitly specify the message header whose value is to be used as the filename.</p>
<p>Once set up, the <code class="literal">DefaultFileNameGenerator</code> employs the following resolution steps to determine the filename for a given message payload:</p>
<div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
Evaluate the expression against the message and, if the result is a non-empty <code class="literal">String</code>, use it as the filename.
</li><li class="listitem">
Otherwise, if the payload is a <code class="literal">java.io.File</code>, use the <code class="literal">File</code> object&#8217;s filename.
</li><li class="listitem">
Otherwise, use the message ID appended with .<code class="literal">msg</code> as the filename.
</li></ol></div>
<p>When you use the XML namespace support, both the file outbound channel adapter and the file outbound gateway support the following mutually exclusive configuration attributes:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">filename-generator</code> (a reference to a <code class="literal">FileNameGenerator</code> implementation)
</li><li class="listitem">
<code class="literal">filename-generator-expression</code> (an expression that evaluates to a <code class="literal">String</code>)
</li></ul></div>
<p>While writing files, a temporary file suffix is used (its default is <code class="literal">.writing</code>).
It is appended to the filename while the file is being written.
To customize the suffix, you can set the <code class="literal">temporary-file-suffix</code> attribute on both the file outbound channel adapter and the file outbound gateway.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>When using the <code class="literal">APPEND</code> file <code class="literal">mode</code>, the <code class="literal">temporary-file-suffix</code> attribute is ignored, since the data is appended to the file directly.</p>
</td></tr></table></div>
<p>Starting with ,version 4.2.5, the generated file name (as a result of <code class="literal">filename-generator</code> or <code class="literal">filename-generator-expression</code>
evaluation) can represent a child path together with the target file name.
It is used as a second constructor argument for <code class="literal">File(File parent, String child)</code> as before.
However, in the past we did not create (<code class="literal">mkdirs()</code>) directories for the child path, assuming only the file name.
This approach is useful for cases when we need to restore the file system tree to match the source directory&#8201;&#8212;&#8201;for example, when unzipping the archive and saving all the files in the target directory in the original order.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="file-writing-output-directory" href="#file-writing-output-directory"></a>17.2.2&nbsp;Specifying the Output Directory</h3></div></div></div>

<p>Both, the file outbound channel adapter and the file outbound gateway provide two mutually exclusive configuration attributes for specifying the output directory:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">directory</code>
</li><li class="listitem">
<code class="literal">directory-expression</code>
</li></ul></div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Spring Integration 2.2 introduced the <code class="literal">directory-expression</code> attribute.</p>
</td></tr></table></div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_using_the_literal_directory_literal_attribute" href="#_using_the_literal_directory_literal_attribute"></a>Using the <code class="literal">directory</code> Attribute</h4></div></div></div>

<p>When you use the <code class="literal">directory</code> attribute, the output directory is set to a fixed value, which is set when the <code class="literal">FileWritingMessageHandler</code> is initialized.
If you do not specify this attribute, you must use the <code class="literal">directory-expression</code> attribute.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_using_the_literal_directory_expression_literal_attribute" href="#_using_the_literal_directory_expression_literal_attribute"></a>Using the <code class="literal">directory-expression</code> Attribute</h4></div></div></div>

<p>If you want to have full SpEL support, you can use the <code class="literal">directory-expression</code> attribute.
This attribute accepts a SpEL expression that is evaluated for each message being processed.
Thus, you have full access to a message&#8217;s payload and its headers when you dynamically specify the output file directory.</p>
<p>The SpEL expression must resolve to either a <code class="literal">String</code> or to <code class="literal">java.io.File</code>.
Furthermore, the resulting <code class="literal">String</code> or <code class="literal">File</code> must point to a directory.
If you do not specify the <code class="literal">directory-expression</code> attribute, then you must set the <code class="literal">directory</code> attribute.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_using_the_literal_auto_create_directory_literal_attribute" href="#_using_the_literal_auto_create_directory_literal_attribute"></a>Using the <code class="literal">auto-create-directory</code> Attribute</h4></div></div></div>

<p>By default, if the destination directory does not exist, the respective destination directory and any non-existing parent directories are  automatically created.
To prevent that behavior, you can set the <code class="literal">auto-create-directory</code> attribute to <code class="literal">false</code>.
This attribute applies to both the <code class="literal">directory</code> and the <code class="literal">directory-expression</code> attributes.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>When using the <code class="literal">directory</code> attribute and <code class="literal">auto-create-directory</code> is <code class="literal">false</code>, the following change was made starting with Spring Integration 2.2:</p>
<p>Instead of checking for the existence of the destination directory when the adapter is initialized, this check is now performed for each message being processed.</p>
<p>Furthermore, if <code class="literal">auto-create-directory</code> is <code class="literal">true</code> and the directory was deleted between the processing of messages, the directory is re-created for each message being processed.</p>
</td></tr></table></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="file-writing-destination-exists" href="#file-writing-destination-exists"></a>17.2.3&nbsp;Dealing with Existing Destination Files</h3></div></div></div>

<p>When you write files and the destination file already exists, the default behavior is to overwrite that target file.
You can change this behavior by setting the <code class="literal">mode</code> attribute on the relevant file outbound components.
The following options exist:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">REPLACE</code> (Default)
</li><li class="listitem">
<code class="literal">REPLACE_IF_MODIFIED</code>
</li><li class="listitem">
<code class="literal">APPEND</code>
</li><li class="listitem">
<code class="literal">APPEND_NO_FLUSH</code>
</li><li class="listitem">
<code class="literal">FAIL</code>
</li><li class="listitem">
<code class="literal">IGNORE</code>
</li></ul></div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Spring Integration 2.2 introduced the <code class="literal">mode</code> attribute and the <code class="literal">APPEND</code>, <code class="literal">FAIL</code>, and <code class="literal">IGNORE</code> options.</p>
</td></tr></table></div>
<div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">REPLACE</code></span></dt><dd>
If the target file already exists, it is overwritten.
If the <code class="literal">mode</code> attribute is not specified, this is the default behavior when writing files.
</dd><dt><span class="term"><code class="literal">REPLACE_IF_MODIFIED</code></span></dt><dd>
If the target file already exists, it is overwritten only if the last modified timestamp differs from that of the source file.
For <code class="literal">File</code> payloads, the payload <code class="literal">lastModified</code> time is compared to the existing file.
For other payloads, the <code class="literal">FileHeaders.SET_MODIFIED</code> (<code class="literal">file_setModified</code>) header is compared to the existing file.
If the header is missing or has a value that is not a <code class="literal">Number</code>, the file is always replaced.
</dd><dt><span class="term"><code class="literal">APPEND</code></span></dt><dd>
This mode lets you append message content to the existing file instead of creating a new file each time.
Note that this attribute is mutually exclusive with the <code class="literal">temporary-file-suffix</code> attribute because, when it appends content to the existing file, the adapter no longer uses a temporary file.
The file is closed after each message.
</dd><dt><span class="term"><code class="literal">APPEND_NO_FLUSH</code></span></dt><dd>
This option has the same semantics as <code class="literal">APPEND</code>, but the data is not flushed and the file is not closed after each message.
This can provide a significant performance at the risk of data loss in the event of a failure.
See <a class="xref" href="#file-flushing" title="17.2.4&nbsp;Flushing Files When Using APPEND_NO_FLUSH">Section&nbsp;17.2.4, &#8220;Flushing Files When Using <code class="literal">APPEND_NO_FLUSH</code>&#8221;</a> for more information.
</dd><dt><span class="term"><code class="literal">FAIL</code></span></dt><dd>
If the target file exists, a <a class="ulink" href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/messaging/MessageHandlingException.html" target="_top"><code class="literal">MessageHandlingException</code></a> is thrown.
</dd><dt><span class="term"><code class="literal">IGNORE</code></span></dt><dd>
If the target file exists, the message payload is silently ignored.
</dd></dl></div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>When using a temporary file suffix (the default is <code class="literal">.writing</code>), the <code class="literal">IGNORE</code> option applies if either the final file name or the temporary file name exists.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="file-flushing" href="#file-flushing"></a>17.2.4&nbsp;Flushing Files When Using <code class="literal">APPEND_NO_FLUSH</code></h3></div></div></div>

<p>The <code class="literal">APPEND_NO_FLUSH</code> mode was added in version 4.3.
Using it can improve performance because the file is not closed after each message.
However, this can cause data loss in the event of a failure.</p>
<p>Spring Integration provides several flushing strategies to mitigate this data loss:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Use <code class="literal">flushInterval</code>. If a file is not written to for this period of time, it is automatically flushed.
This is approximate and may be up to <code class="literal">1.33x</code> this time (with an average of <code class="literal">1.167x</code>).
</li><li class="listitem">
Send a message containing a regular expression to the message handler&#8217;s <code class="literal">trigger</code> method.
Files with absolute path names matching the pattern are flushed.
</li><li class="listitem">
Provide the handler with a custom <code class="literal">MessageFlushPredicate</code> implementation to modify the action taken when a message is sent to the <code class="literal">trigger</code> method.
</li><li class="listitem">
Invoke one of the handler&#8217;s <code class="literal">flushIfNeeded</code> methods by passing in a custom <code class="literal">FileWritingMessageHandler.FlushPredicate</code> or <code class="literal">FileWritingMessageHandler.MessageFlushPredicate</code> implementation.
</li></ul></div>
<p>The predicates are called for each open file.
See the <a class="ulink" href="https://docs.spring.io/spring-integration/api/index.html" target="_top">Javadoc</a> for these interfaces for more information.
Note that, since version 5.0, the predicate methods provide another parameter: the time that the current file was first written to if new or previously closed.</p>
<p>When using <code class="literal">flushInterval</code>, the interval starts at the last write.
The file is flushed only if it is idle for the interval.
Starting with version 4.3.7, an additional property (<code class="literal">flushWhenIdle</code>) can be set to <code class="literal">false</code>, meaning that the interval starts with the first write to a previously flushed (or new) file.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="file-timestamps" href="#file-timestamps"></a>17.2.5&nbsp;File Timestamps</h3></div></div></div>

<p>By default, the destination file&#8217;s <code class="literal">lastModified</code> timestamp is the time when the file was created (except that an in-place rename retains the current timestamp).
Starting with version 4.3, you can now configure <code class="literal">preserve-timestamp</code> (or <code class="literal">setPreserveTimestamp(true)</code> when using Java configuration).
For <code class="literal">File</code> payloads, this transfers the timestamp from the inbound file to the outbound (regardless of whether a copy was required).
For other payloads, if the <code class="literal">FileHeaders.SET_MODIFIED</code> header (<code class="literal">file_setModified</code>) is present, it is used to set the destination file&#8217;s <code class="literal">lastModified</code> timestamp, as long as the header is a <code class="literal">Number</code>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="file-permissions" href="#file-permissions"></a>17.2.6&nbsp;File Permissions</h3></div></div></div>

<p>Starting with version 5.0, when writing files to a file system that supports Posix permissions, you can specify those permissions on the outbound channel adapter or gateway.
The property is an integer and is usually supplied in the familiar octal format&#8201;&#8212;&#8201;for example, <code class="literal">0640</code>, meaning that the owner has read/write permissions, the group has read-only permission, and others have no access.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="file-outbound-channel-adapter" href="#file-outbound-channel-adapter"></a>17.2.7&nbsp;File Outbound Channel Adapter</h3></div></div></div>

<p>The following example configures a file outbound channel adapter:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-file:outbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"filesOut"</span> <span class="hl-attribute">directory</span>=<span class="hl-value">"${input.directory.property}"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>The namespace-based configuration also supports a <code class="literal">delete-source-files</code> attribute.
If set to <code class="literal">true</code>, it triggers the deletion of the original source files after writing to a destination.
The default value for that flag is <code class="literal">false</code>.
The following example shows how to set it to <code class="literal">true</code>:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-file:outbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"filesOut"</span>
    <span class="hl-attribute">directory</span>=<span class="hl-value">"${output.directory}"</span>
    <span class="hl-attribute">delete-source-files</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The <code class="literal">delete-source-files</code> attribute has an effect only if the inbound message has a <code class="literal">File</code> payload or if the <code class="literal">FileHeaders.ORIGINAL_FILE</code> header value contains either the source <code class="literal">File</code> instance or a <code class="literal">String</code> representing the original file path.</p>
</td></tr></table></div>
<p>Starting with version 4.2, the <code class="literal">FileWritingMessageHandler</code> supports an <code class="literal">append-new-line</code> option.
If set to <code class="literal">true</code>, a new line is appended to the file after a message is written.
The default attribute value is <code class="literal">false</code>.
The following example shows how to use the <code class="literal">append-new-line</code> option:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-file:outbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"newlineAdapter"</span>
	<span class="hl-attribute">append-new-line</span>=<span class="hl-value">"true"</span>
    <span class="hl-attribute">directory</span>=<span class="hl-value">"${output.directory}"</span><span class="hl-tag">/&gt;</span></pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="file-writing-output-gateway" href="#file-writing-output-gateway"></a>17.2.8&nbsp;Outbound Gateway</h3></div></div></div>

<p>In cases where you want to continue processing messages based on the written file, you can use the <code class="literal">outbound-gateway</code> instead.
It plays a role similar to that of the <code class="literal">outbound-channel-adapter</code>.
However, after writing the file, it also sends it to the reply channel as the payload of a message.</p>
<p>The following example configures an outbound gateway:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-file:outbound-gateway</span> <span class="hl-attribute">id</span>=<span class="hl-value">"mover"</span> <span class="hl-attribute">request-channel</span>=<span class="hl-value">"moveInput"</span>
    <span class="hl-attribute">reply-channel</span>=<span class="hl-value">"output"</span>
    <span class="hl-attribute">directory</span>=<span class="hl-value">"${output.directory}"</span>
    <span class="hl-attribute">mode</span>=<span class="hl-value">"REPLACE"</span> <span class="hl-attribute">delete-source-files</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>As mentioned earlier, you can also specify the <code class="literal">mode</code> attribute, which defines the behavior of how to deal with situations where the destination file already exists.
See <a class="xref" href="#file-writing-destination-exists" title="17.2.3&nbsp;Dealing with Existing Destination Files">Section&nbsp;17.2.3, &#8220;Dealing with Existing Destination Files&#8221;</a> for further details.
Generally, when using the file outbound gateway, the result file is returned as the message payload on the reply channel.</p>
<p>This also applies when specifying the <code class="literal">IGNORE</code> mode.
In that case the pre-existing destination file is returned.
If the payload of the request message was a file, you still have access to that original file through the message header.
See <a class="ulink" href="http://docs.spring.io/spring-integration/api/org/springframework/integration/file/FileHeaders.html" target="_top">FileHeaders.ORIGINAL_FILE</a>.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The <span class="emphasis"><em>outbound-gateway</em></span> works well in cases where you want to first move a file and then send it through a processing pipeline.
In such cases, you may connect the file namespace&#8217;s <code class="literal">inbound-channel-adapter</code> element to the <code class="literal">outbound-gateway</code> and then connect that gateway&#8217;s <code class="literal">reply-channel</code> to the beginning of the pipeline.</p>
</td></tr></table></div>
<p>If you have more elaborate requirements or need to support additional payload types as input to be converted to file content, you can extend the <code class="literal">FileWritingMessageHandler</code>, but a much better option is to rely on a <a class="link" href="#file-transforming" title="17.3&nbsp;File Transformers"><code class="literal">Transformer</code></a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_with_java_configuration_8" href="#_configuring_with_java_configuration_8"></a>17.2.9&nbsp;Configuring with Java Configuration</h3></div></div></div>

<p>The following Spring Boot application shows an example of how to configure the inbound adapter with Java configuration:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@SpringBootApplication</span></em>
<em><span class="hl-annotation" style="color: gray">@IntegrationComponentScan</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> FileWritingJavaApplication {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
        ConfigurableApplicationContext context =
                      <span class="hl-keyword">new</span> SpringApplicationBuilder(FileWritingJavaApplication.<span class="hl-keyword">class</span>)
                              .web(false)
                              .run(args);
             MyGateway gateway = context.getBean(MyGateway.<span class="hl-keyword">class</span>);
             gateway.writeToFile(<span class="hl-string">"foo.txt"</span>, <span class="hl-keyword">new</span> File(tmpDir.getRoot(), <span class="hl-string">"fileWritingFlow"</span>), <span class="hl-string">"foo"</span>);
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "writeToFileChannel")</span></em>
    <span class="hl-keyword">public</span> MessageHandler fileWritingMessageHandler() {
         Expression directoryExpression = <span class="hl-keyword">new</span> SpelExpressionParser().parseExpression(<span class="hl-string">"headers.directory"</span>);
         FileWritingMessageHandler handler = <span class="hl-keyword">new</span> FileWritingMessageHandler(directoryExpression);
         handler.setFileExistsMode(FileExistsMode.APPEND);
         <span class="hl-keyword">return</span> handler;
    }

    <em><span class="hl-annotation" style="color: gray">@MessagingGateway(defaultRequestChannel = "writeToFileChannel")</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> MyGateway {

        <span class="hl-keyword">void</span> writeToFile(<em><span class="hl-annotation" style="color: gray">@Header(FileHeaders.FILENAME)</span></em> String fileName,
                       <em><span class="hl-annotation" style="color: gray">@Header(FileHeaders.FILENAME)</span></em> File directory, String data);

    }
}</pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_with_the_java_dsl_9" href="#_configuring_with_the_java_dsl_9"></a>17.2.10&nbsp;Configuring with the Java DSL</h3></div></div></div>

<p>The following Spring Boot application shows an example of how to configure the inbound adapter with the Java DSL:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@SpringBootApplication</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> FileWritingJavaApplication {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
        ConfigurableApplicationContext context =
                 <span class="hl-keyword">new</span> SpringApplicationBuilder(FileWritingJavaApplication.<span class="hl-keyword">class</span>)
                         .web(false)
                         .run(args);
        MessageChannel fileWritingInput = context.getBean(<span class="hl-string">"fileWritingInput"</span>, MessageChannel.<span class="hl-keyword">class</span>);
        fileWritingInput.send(<span class="hl-keyword">new</span> GenericMessage&lt;&gt;(<span class="hl-string">"foo"</span>));
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
   	<span class="hl-keyword">public</span> IntegrationFlow fileWritingFlow() {
   	    <span class="hl-keyword">return</span> IntegrationFlows.from(<span class="hl-string">"fileWritingInput"</span>)
   		        .enrichHeaders(h -&gt; h.header(FileHeaders.FILENAME, <span class="hl-string">"foo.txt"</span>)
   		                  .header(<span class="hl-string">"directory"</span>, <span class="hl-keyword">new</span> File(tmpDir.getRoot(), <span class="hl-string">"fileWritingFlow"</span>)))
   	            .handleWithAdapter(a -&gt; a.fileGateway(m -&gt; m.getHeaders().get(<span class="hl-string">"directory"</span>)))
   	            .channel(MessageChannels.queue(<span class="hl-string">"fileWritingResultChannel"</span>))
   	            .get();
    }

}</pre>
</div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="file-transforming" href="#file-transforming"></a>17.3&nbsp;File Transformers</h2></div></div></div>

<p>To transform data read from the file system to objects and the other way around, you need to do some work.
Unlike <code class="literal">FileReadingMessageSource</code> and to a lesser extent <code class="literal">FileWritingMessageHandler</code>, you probably need your own mechanism to get the job done.
For this, you can implement the <code class="literal">Transformer</code> interface.
Alternatively, you can extend the <code class="literal">AbstractFilePayloadTransformer</code> for inbound messages.
Spring Integration provides some obvious implementations.</p>
<p>See the <a class="ulink" href="https://docs.spring.io/spring-integration/api/org/springframework/integration/transformer/Transformer.html" target="_top">Javadoc for the <code class="literal">Transformer</code> interface</a> to see which Spring Integration classes implement it.
Similarly, you can check the <a class="ulink" href="https://docs.spring.io/spring-integration/api/org/springframework/integration/file/transformer/AbstractFilePayloadTransformer.html" target="_top">Javadoc for the <code class="literal">AbstractFilePayloadTransformer</code> class</a> to see which Spring Integration classes extend it.</p>
<p><code class="literal">FileToByteArrayTransformer</code> extends <code class="literal">AbstractFilePayloadTransformer</code> and transforms a <code class="literal">File</code> object into a <code class="literal">byte[]</code> by using Spring&#8217;s <code class="literal">FileCopyUtils</code>.
It is often better to use a sequence of transformers than to put all transformations in a single class.
In that case the <code class="literal">File</code> to <code class="literal">byte[]</code> conversion might be a logical first step.</p>
<p><code class="literal">FileToStringTransformer</code> extends <code class="literal">AbstractFilePayloadTransformer</code> convert a <code class="literal">File</code> object to a <code class="literal">String</code>.
If nothing else, this can be useful for debugging (consider using it with a <a class="link" href="#channel-wiretap" title="Wire Tap">wire tap</a>).</p>
<p>To configure file-specific transformers, you can use the appropriate elements from the file namespace, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-file:file-to-bytes-transformer</span>  <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span>
    <span class="hl-attribute">delete-files</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int-file:file-to-string-transformer</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span>
    <span class="hl-attribute">delete-files</span>=<span class="hl-value">"true"</span> <span class="hl-attribute">charset</span>=<span class="hl-value">"UTF-8"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>The <code class="literal">delete-files</code> option signals to the transformer that it should delete the inbound file after the transformation is complete.
This is in no way a replacement for using an <code class="literal">AcceptOnceFileListFilter</code> when the <code class="literal">FileReadingMessageSource</code> is being used in a multi-threaded environment (such as when you use Spring Integration in general).</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="file-splitter" href="#file-splitter"></a>17.4&nbsp;File Splitter</h2></div></div></div>

<p>The <code class="literal">FileSplitter</code> was added in version 4.1.2, and its namespace support was added in version 4.2.
The <code class="literal">FileSplitter</code> splits text files into individual lines, based on <code class="literal">BufferedReader.readLine()</code>.
By default, the splitter uses an <code class="literal">Iterator</code> to emit lines one at a time as they are read from the file.
Setting the <code class="literal">iterator</code> property to <code class="literal">false</code> causes it to read all the lines into memory before emitting them as messages.
One use case for this might be if you want to detect I/O errors on the file before sending any messages containing lines.
However, it is only practical for relatively short files.</p>
<p>Inbound payloads can be <code class="literal">File</code>, <code class="literal">String</code> (a <code class="literal">File</code> path), <code class="literal">InputStream</code>, or <code class="literal">Reader</code>.
Other payload types are emitted unchanged.</p>
<p>The following listing shows all the possible attributes for <code class="literal">&lt;int-file:splitter&gt;</code>:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-file:splitter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"splitter"</span> <a name="CO24-1" href="#CO24-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
    iterator=""                  <a name="CO24-2" href="#CO24-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
    markers=""                   <a name="CO24-3" href="#CO24-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
    markers-json=""              <a name="CO24-4" href="#CO24-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
    apply-sequence=""            <a name="CO24-5" href="#CO24-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
    requires-reply=""            <a name="CO24-6" href="#CO24-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>
    charset=""                   <a name="CO24-7" href="#CO24-7"></a><span><img src="images/callouts/7.png" alt="7" border="0"></span>
    first-line-as-header=""      <a name="CO24-8" href="#CO24-8"></a><span><img src="images/callouts/8.png" alt="8" border="0"></span>
    input-channel=""             <a name="CO24-9" href="#CO24-9"></a><span><img src="images/callouts/9.png" alt="9" border="0"></span>
    output-channel=""            <a name="CO24-10" href="#CO24-10"></a><span><img src="images/callouts/10.png" alt="10" border="0"></span>
    send-timeout=""              <a name="CO24-11" href="#CO24-11"></a><span><img src="images/callouts/11.png" alt="11" border="0"></span>
    auto-startup=""              <a name="CO24-12" href="#CO24-12"></a><span><img src="images/callouts/12.png" alt="12" border="0"></span>
    order=""                     <a name="CO24-13" href="#CO24-13"></a><span><img src="images/callouts/13.png" alt="13" border="0"></span>
    phase="" /&gt;                  <a name="CO24-14" href="#CO24-14"></a><span><img src="images/callouts/14.png" alt="14" border="0"></span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO24-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The bean name of the splitter.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO24-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Set to <code class="literal">true</code> (the default) to use an iterator or <code class="literal">false</code> to load the file into memory before sending lines.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO24-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Set to <code class="literal">true</code> to emit start-of-file and end-of-file marker messages before and after the file data.
Markers are messages with <code class="literal">FileSplitter.FileMarker</code> payloads (with <code class="literal">START</code> and <code class="literal">END</code> values in the <code class="literal">mark</code> property).
You might use markers when sequentially processing files in a downstream flow where some lines are filtered.
They enable the downstream processing to know when a file has been completely processed.
In addition, a <code class="literal">file_marker</code> header that contains <code class="literal">START</code> or <code class="literal">END</code> is added to these messages.
The <code class="literal">END</code> marker includes a line count.
If the file is empty, only <code class="literal">START</code> and <code class="literal">END</code> markers are emitted with <code class="literal">0</code> as the <code class="literal">lineCount</code>.
The default is <code class="literal">false</code>.
When <code class="literal">true</code>, <code class="literal">apply-sequence</code> is <code class="literal">false</code> by default.
See also <code class="literal">markers-json</code> (the next attribute).</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO24-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>When <code class="literal">markers</code> is true, set this to <code class="literal">true</code> to have the <code class="literal">FileMarker</code> objects be converted to a JSON string.
Requires a supported JSON processor library (Jackson or Boon) on the classpath.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO24-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Set to <code class="literal">false</code> to disable the inclusion of <code class="literal">sequenceSize</code> and <code class="literal">sequenceNumber</code> headers in messages.
The default is <code class="literal">true</code>, unless <code class="literal">markers</code> is <code class="literal">true</code>.
When <code class="literal">true</code> and <code class="literal">markers</code> is <code class="literal">true</code>, the markers are included in the sequencing.
When <code class="literal">true</code> and <code class="literal">iterator</code> is <code class="literal">true</code>, the <code class="literal">sequenceSize</code> header is set to <code class="literal">0</code>, because the size is unknown.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO24-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Set to <code class="literal">true</code> to cause a <code class="literal">RequiresReplyException</code> to be thrown if there are no lines in the file.
The default is <code class="literal">false</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO24-7"><span><img src="images/callouts/7.png" alt="7" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Set the charset name to be used when reading text data into <code class="literal">String</code> payloads.
The default is the platform charset.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO24-8"><span><img src="images/callouts/8.png" alt="8" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The header name for the first line to be carried as a header in the messages emitted for the remaining lines.
Since version 5.0.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO24-9"><span><img src="images/callouts/9.png" alt="9" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Set the input channel used to send messages to the splitter.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO24-10"><span><img src="images/callouts/10.png" alt="10" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Set the output channel to which messages are sent.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO24-11"><span><img src="images/callouts/11.png" alt="11" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Set the send timeout.
Only applies if the <code class="literal">output-channel</code> can block&#8201;&#8212;&#8201;such as a full <code class="literal">QueueChannel</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO24-12"><span><img src="images/callouts/12.png" alt="12" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Set to <code class="literal">false</code> to disable automatically starting the splitter when the context is refreshed.
The default is <code class="literal">true</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO24-13"><span><img src="images/callouts/13.png" alt="13" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Set the order of this endpoint if the <code class="literal">input-channel</code> is a <code class="literal">&lt;publish-subscribe-channel/&gt;</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO24-14"><span><img src="images/callouts/14.png" alt="14" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Set the startup phase for the splitter (used when <code class="literal">auto-startup</code> is <code class="literal">true</code>).</p>
</td></tr></table></div>
</div>
<p>The <code class="literal">FileSplitter</code> also splits any text-based <code class="literal">InputStream</code> into lines.
Starting with version 4.3, when used in conjunction with an FTP or SFTP streaming inbound channel adapter or an FTP or SFTP outbound gateway that uses the <code class="literal">stream</code> option to retrieve a file, the splitter automatically closes the session that supports the stream when the file is completely consumed
See <a class="xref" href="#ftp-streaming" title="18.5&nbsp;FTP Streaming Inbound Channel Adapter">Section&nbsp;18.5, &#8220;FTP Streaming Inbound Channel Adapter&#8221;</a> and <a class="xref" href="#sftp-streaming" title="30.7&nbsp;SFTP Streaming Inbound Channel Adapter">Section&nbsp;30.7, &#8220;SFTP Streaming Inbound Channel Adapter&#8221;</a> as well as <a class="xref" href="#ftp-outbound-gateway" title="18.9&nbsp;FTP Outbound Gateway">Section&nbsp;18.9, &#8220;FTP Outbound Gateway&#8221;</a> and <a class="xref" href="#sftp-outbound-gateway" title="30.11&nbsp;SFTP Outbound Gateway">Section&nbsp;30.11, &#8220;SFTP Outbound Gateway&#8221;</a> for more information about these facilities.</p>
<p>When using Java configuration, an additional constructor is available, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> FileSplitter(<span class="hl-keyword">boolean</span> iterator, <span class="hl-keyword">boolean</span> markers, <span class="hl-keyword">boolean</span> markersJson)</pre>
</div>
<p>When <code class="literal">markersJson</code> is true, the markers are represented as a JSON string, as long as a suitable JSON processor library (such as Jackson or Boon) is on the classpath.</p>
<p>Version 5.0 introduced the <code class="literal">firstLineAsHeader</code> option to specify that the first line of content is a header (such as column names in a CSV file).
The argument passed to this property is the header name under which the first line is carried as a header in the messages emitted for the remaining lines.
This line is not included in the sequence header (if <code class="literal">applySequence</code> is true) nor in the <code class="literal">lineCount</code> associated with <code class="literal">FileMarker.END</code> .
If a file contains only the header line, the file is treated as empty and, therefore, only <code class="literal">FileMarker</code> instances are emitted during splitting (if markers are enabled&#8201;&#8212;&#8201;otherwise, no messages are emitted).
By default (if no header name is set), the first line is considered to be data and becomes the payload of the first emitted message.</p>
<p>If you need more complex logic about header extraction from the file content (not first line, not the whole content of the line, not one particular header, and so on), consider using  <a class="link" href="#header-enricher" title="9.2.1&nbsp;Header Enricher">header enricher</a> ahead of the <code class="literal">FileSplitter</code>.
Note that the lines that have been moved to the headers might be filtered downstream from the normal content process.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_with_java_configuration_9" href="#_configuring_with_java_configuration_9"></a>17.4.1&nbsp;Configuring with Java Configuration</h3></div></div></div>

<p>The following Spring Boot application shows an example of how to configure a file splitter with Java configuration:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Splitter(inputChannel="toSplitter")</span></em>
<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> MessageHandler fileSplitter() {
    FileSplitter splitter = <span class="hl-keyword">new</span> FileSplitter(true, true);
    splitter.setApplySequence(true);
    splitter.setOutputChannel(outputChannel);
    <span class="hl-keyword">return</span> splitter;
}</pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_with_the_java_dsl_10" href="#_configuring_with_the_java_dsl_10"></a>17.4.2&nbsp;Configuring with the Java DSL</h3></div></div></div>

<p>The following Spring Boot application shows an example of how to configure a file splitter with the Java DSL:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@SpringBootApplication</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> FileSplitterApplication {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
        <span class="hl-keyword">new</span> SpringApplicationBuilder(FileSplitterApplication.<span class="hl-keyword">class</span>)
            .web(false)
            .run(args);
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> IntegrationFlow fileSplitterFlow() {
        <span class="hl-keyword">return</span> IntegrationFlows
            .from(Files.inboundAdapter(tmpDir.getRoot())
                 .filter(<span class="hl-keyword">new</span> ChainFileListFilter&lt;File&gt;()
                        .addFilter(<span class="hl-keyword">new</span> AcceptOnceFileListFilter&lt;&gt;())
                        .addFilter(<span class="hl-keyword">new</span> ExpressionFileListFilter&lt;&gt;(
                             <span class="hl-keyword">new</span> FunctionExpression&lt;File&gt;(f -&gt; <span class="hl-string">"foo.tmp"</span>.equals(f.getName()))))))
            .split(Files.splitter()
                     .markers()
                     .charset(StandardCharsets.US_ASCII)
                     .firstLineAsHeader(<span class="hl-string">"fileHeader"</span>)
                     .applySequence(true))
            .channel(c -&gt; c.queue(<span class="hl-string">"fileSplittingResultChannel"</span>))
            .get();
    }

}</pre>
</div>
</div>
</div>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="ftp" href="#ftp"></a>18.&nbsp;FTP/FTPS Adapters</h2></div></div></div>

<p>Spring Integration provides support for file transfer operations with FTP and FTPS.</p>
<p>The File Transfer Protocol (FTP) is a simple network protocol that lets you transfer files between two computers on the Internet.
FTPS stands for "<code class="literal">FTP over SSL</code>".</p>
<p>You need to include this dependency into your project:</p>
<div class="informalexample">
<p>
<b>Maven.&nbsp;</b>

</p><pre class="programlisting"><span class="hl-tag">&lt;dependency&gt;</span>
    <span class="hl-tag">&lt;groupId&gt;</span>org.springframework.integration<span class="hl-tag">&lt;/groupId&gt;</span>
    <span class="hl-tag">&lt;artifactId&gt;</span>spring-integration-ftp<span class="hl-tag">&lt;/artifactId&gt;</span>
    <span class="hl-tag">&lt;version&gt;</span>5.1.2.RELEASE<span class="hl-tag">&lt;/version&gt;</span>
<span class="hl-tag">&lt;/dependency&gt;</span></pre><p>

</p>
<p>
<b>Gradle.&nbsp;</b>

</p><pre class="programlisting">compile <span class="hl-string">"org.springframework.integration:spring-integration-ftp:5.1.2.RELEASE"</span></pre><p>

</p>
</div>
<p>There are two actors when it comes to FTP communication: client and server.
To transfer files with FTP or FTPS, you use a client that initiates a connection to a remote computer that is running an FTP server.
After the connection is established, the client can choose to send or receive copies of files.</p>
<p>Spring Integration supports sending and receiving files over FTP or FTPS by providing three client-side endpoints: inbound channel adapter, outbound channel adapter, and outbound gateway.
It also provides convenient namespace-based configuration options for defining these client components.</p>
<p>To use the FTP namespace, add the following to the header of your XML file:</p>
<div class="informalexample">
<pre class="programlisting">xmlns:int-ftp="http://www.springframework.org/schema/integration/ftp"
xsi:schemaLocation="http://www.springframework.org/schema/integration/ftp
    http://www.springframework.org/schema/integration/ftp/spring-integration-ftp.xsd"</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="ftp-session-factory" href="#ftp-session-factory"></a>18.1&nbsp;FTP Session Factory</h2></div></div></div>

<p>Spring Integration provides factories you can use to create FTP (or FTPS) sessions.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_default_factories" href="#_default_factories"></a>18.1.1&nbsp;Default Factories</h3></div></div></div>

<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Starting with version 3.0, sessions are no longer cached by default.
See <a class="xref" href="#ftp-session-caching" title="18.10&nbsp;FTP Session Caching">Section&nbsp;18.10, &#8220;FTP Session Caching&#8221;</a>.</p>
</td></tr></table></div>
<p>Before configuring FTP adapters, you must configure an FTP session factory.
You can configure the FTP Session Factory with a regular bean definition where the implementation class is <code class="literal">o.s.i.ftp.session.DefaultFtpSessionFactory</code>.
The following example shows a basic configuration:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"ftpClientFactory"</span>
    <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.ftp.session.DefaultFtpSessionFactory"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"host"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"localhost"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"port"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"22"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"username"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"kermit"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"password"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"frog"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"clientMode"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"0"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"fileType"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"2"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"bufferSize"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"100000"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
</div>
<p>For FTPS connections, you can use <code class="literal">o.s.i.ftp.session.DefaultFtpsSessionFactory</code> instead.</p>
<p>The following example shows a complete configuration:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"ftpClientFactory"</span>
    <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.ftp.session.DefaultFtpsSessionFactory"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"host"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"localhost"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"port"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"22"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"username"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"oleg"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"password"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"password"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"clientMode"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"1"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"fileType"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"2"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"useClientMode"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"cipherSuites"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"a,b.c"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"keyManager"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"keyManager"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"protocol"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"SSL"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"trustManager"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"trustManager"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"prot"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"P"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"needClientAuth"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"authValue"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"oleg"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"sessionCreation"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"protocols"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"SSL, TLS"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"implicit"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
</div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>If you experience connectivity problems and would like to trace session creation as well as see which sessions are polled, you can enable session tracing by setting the logger to the <code class="literal">TRACE</code> level (for example, <code class="literal">log4j.category.org.springframework.integration.file=TRACE</code>).</p>
</td></tr></table></div>
<p>Now you need only inject these session factories into your adapters.
The protocol (FTP or FTPS) that an adapter uses depends on the type of session factory that has been injected into the adapter.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>A more practical way to provide values for FTP or FTPS session factories is to use Spring&#8217;s property placeholder support (See <a class="ulink" href="http://docs.spring.io/spring/docs/current/spring-framework-reference/html/beans.html#beans-factory-placeholderconfigurer" target="_top">http://docs.spring.io/spring/docs/current/spring-framework-reference/html/beans.html#beans-factory-placeholderconfigurer</a>).</p>
</td></tr></table></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_advanced_configuration" href="#_advanced_configuration"></a>18.2&nbsp;Advanced Configuration</h2></div></div></div>

<p><code class="literal">DefaultFtpSessionFactory</code> provides an abstraction over the underlying client API, which (since Spring Integration 2.0) is <a class="ulink" href="http://commons.apache.org/net/" target="_top">Apache Commons Net</a>.
This spares you from the low-level configuration details of the <code class="literal">org.apache.commons.net.ftp.FTPClient</code>.
Several common properties are exposed on the session factory (since version 4.0, this now includes <code class="literal">connectTimeout</code>, <code class="literal">defaultTimeout</code>, and <code class="literal">dataTimeout</code>).
However, you sometimes need access to lower level <code class="literal">FTPClient</code> configuration to achieve more advanced configuration (such as setting the port range for active mode).
For that purpose, <code class="literal">AbstractFtpSessionFactory</code> (the base class for all FTP Session Factories) exposes hooks, in the form of the two post-processing methods shown in the following listing:</p>
<div class="informalexample">
<pre class="programlisting"><strong class="hl-tag" style="color: blue">/**
 * Will handle additional initialization after client.connect() method was invoked,
 * but before any action on the client has been taken
 */</strong>
<span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> postProcessClientAfterConnect(T t) <span class="hl-keyword">throws</span> IOException {
    <span class="hl-comment">// NOOP</span>
}
<strong class="hl-tag" style="color: blue">/**
 * Will handle additional initialization before client.connect() method was invoked.
 */</strong>
<span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> postProcessClientBeforeConnect(T client) <span class="hl-keyword">throws</span> IOException {
    <span class="hl-comment">// NOOP</span>
}</pre>
</div>
<p>As you can see, there is no default implementation for these two methods.
However, by extending <code class="literal">DefaultFtpSessionFactory</code>, you can override these methods to provide more advanced configuration of the <code class="literal">FTPClient</code>, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> AdvancedFtpSessionFactory <span class="hl-keyword">extends</span> DefaultFtpSessionFactory {

    <span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> postProcessClientBeforeConnect(FTPClient ftpClient) <span class="hl-keyword">throws</span> IOException {
       ftpClient.setActivePortRange(<span class="hl-number">4000</span>, <span class="hl-number">5000</span>);
    }
}</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_ftps_and_shared_sslsession" href="#_ftps_and_shared_sslsession"></a>18.2.1&nbsp;FTPS and Shared SSLSession</h3></div></div></div>

<p>When using FTP over SSL or TLS, some servers require the same <code class="literal">SSLSession</code> to be used on the control and data connections.
This is to prevent "<code class="literal">stealing</code>" data connections.
See <a class="ulink" href="https://scarybeastsecurity.blogspot.cz/2009/02/vsftpd-210-released.html" target="_top">https://scarybeastsecurity.blogspot.cz/2009/02/vsftpd-210-released.html</a> for more information.</p>
<p>Currently, the Apache FTPSClient does not support this feature.
See <a class="ulink" href="https://issues.apache.org/jira/browse/NET-408" target="_top">NET-408</a>.</p>
<p>The following solution, courtesy of <a class="ulink" href="http://stackoverflow.com/questions/32398754/how-to-connect-to-ftps-server-with-data-connection-using-same-tls-session" target="_top">Stack Overflow</a>, uses reflection on the <code class="literal">sun.security.ssl.SSLSessionContextImpl</code>, so it may not work on other JVMs.
The stack overflow answer was submitted in 2015, and the solution has been tested by the Spring Integration team recently on JDK 1.8.0_112.</p>
<p>The following example shows how to create an FTPS session:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> DefaultFtpsSessionFactory sf() {
    DefaultFtpsSessionFactory sf = <span class="hl-keyword">new</span> DefaultFtpsSessionFactory() {

        <em><span class="hl-annotation" style="color: gray">@Override</span></em>
        <span class="hl-keyword">protected</span> FTPSClient createClientInstance() {
            <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> SharedSSLFTPSClient();
        }

    };
    sf.setHost(<span class="hl-string">"..."</span>);
    sf.setPort(<span class="hl-number">21</span>);
    sf.setUsername(<span class="hl-string">"..."</span>);
    sf.setPassword(<span class="hl-string">"..."</span>);
    sf.setNeedClientAuth(true);
    <span class="hl-keyword">return</span> sf;
}

<span class="hl-keyword">private</span> <span class="hl-keyword">static</span> <span class="hl-keyword">final</span> <span class="hl-keyword">class</span> SharedSSLFTPSClient <span class="hl-keyword">extends</span> FTPSClient {

    <em><span class="hl-annotation" style="color: gray">@Override</span></em>
    <span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> _prepareDataSocket_(<span class="hl-keyword">final</span> Socket socket) <span class="hl-keyword">throws</span> IOException {
        <span class="hl-keyword">if</span> (socket <span class="hl-keyword">instanceof</span> SSLSocket) {
            <span class="hl-comment">// Control socket is SSL</span>
            <span class="hl-keyword">final</span> SSLSession session = ((SSLSocket) _socket_).getSession();
            <span class="hl-keyword">final</span> SSLSessionContext context = session.getSessionContext();
            context.setSessionCacheSize(<span class="hl-number">0</span>); <span class="hl-comment">// you might want to limit the cache</span>
            <span class="hl-keyword">try</span> {
                <span class="hl-keyword">final</span> Field sessionHostPortCache = context.getClass()
                        .getDeclaredField(<span class="hl-string">"sessionHostPortCache"</span>);
                sessionHostPortCache.setAccessible(true);
                <span class="hl-keyword">final</span> Object cache = sessionHostPortCache.get(context);
                <span class="hl-keyword">final</span> Method method = cache.getClass().getDeclaredMethod(<span class="hl-string">"put"</span>, Object.<span class="hl-keyword">class</span>,
                        Object.<span class="hl-keyword">class</span>);
                method.setAccessible(true);
                String key = String.format(<span class="hl-string">"%s:%s"</span>, socket.getInetAddress().getHostName(),
                        String.valueOf(socket.getPort())).toLowerCase(Locale.ROOT);
                method.invoke(cache, key, session);
                key = String.format(<span class="hl-string">"%s:%s"</span>, socket.getInetAddress().getHostAddress(),
                        String.valueOf(socket.getPort())).toLowerCase(Locale.ROOT);
                method.invoke(cache, key, session);
            }
            <span class="hl-keyword">catch</span> (NoSuchFieldException e) {
                <span class="hl-comment">// Not running in expected JRE</span>
                logger.warn(<span class="hl-string">"No field sessionHostPortCache in SSLSessionContext"</span>, e);
            }
            <span class="hl-keyword">catch</span> (Exception e) {
                <span class="hl-comment">// Not running in expected JRE</span>
                logger.warn(e.getMessage());
            }
        }

    }

}</pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="ftp-dsf" href="#ftp-dsf"></a>18.3&nbsp;Delegating Session Factory</h2></div></div></div>

<p>Version 4.2 introduced the <code class="literal">DelegatingSessionFactory</code>, which allows the selection of the actual session factory at runtime.
Prior to invoking the FTP endpoint, call <code class="literal">setThreadKey()</code> on the factory to associate a key with the current thread.
That key is then used to lookup the actual session factory to be used.
You can clear the key by calling <code class="literal">clearThreadKey()</code> after use.</p>
<p>We added convenience methods so that you can easily do use a delegating session factory from a message flow.</p>
<p>The following example shows how to declare a delegating session factory:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"dsf"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.file.remote.session.DelegatingSessionFactory"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.file.remote.session.DefaultSessionFactoryLocator"</span><span class="hl-tag">&gt;</span>
            <span class="hl-comment">&lt;!-- delegate factories here --&gt;</span>
        <span class="hl-tag">&lt;/bean&gt;</span>
    <span class="hl-tag">&lt;/constructor-arg&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;int:service-activator</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"in"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"c1"</span>
        <span class="hl-attribute">expression</span>=<span class="hl-value">"@dsf.setThreadKey(#root, headers['factoryToUse'])"</span><span class="hl-tag"> /&gt;</span>

<span class="hl-tag">&lt;int-ftp:outbound-gateway</span> <span class="hl-attribute">request-channel</span>=<span class="hl-value">"c1"</span> <span class="hl-attribute">reply-channel</span>=<span class="hl-value">"c2"</span> <span class="hl-attribute">...</span><span class="hl-tag"> /&gt;</span>

<span class="hl-tag">&lt;int:service-activator</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"c2"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"out"</span>
        <span class="hl-attribute">expression</span>=<span class="hl-value">"@dsf.clearThreadKey(#root)"</span><span class="hl-tag"> /&gt;</span></pre>
</div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>When you use session caching (see <a class="xref" href="#ftp-session-caching" title="18.10&nbsp;FTP Session Caching">Section&nbsp;18.10, &#8220;FTP Session Caching&#8221;</a>), each of the delegates should be cached.
You cannot cache the <code class="literal">DelegatingSessionFactory</code> itself.</p>
</td></tr></table></div>
<p>Starting with <span class="emphasis"><em>version 5.0.7</em></span>, the <code class="literal">DelegatingSessionFactory</code> can be used in conjunction with a <code class="literal">RotatingServerAdvice</code> to poll multiple servers; see <a class="xref" href="#ftp-rotating-server-advice" title="18.6&nbsp;Inbound Channel Adapters: Polling Multiple Servers and Directories">Section&nbsp;18.6, &#8220;Inbound Channel Adapters: Polling Multiple Servers and Directories&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="ftp-inbound" href="#ftp-inbound"></a>18.4&nbsp;FTP Inbound Channel Adapter</h2></div></div></div>

<p>The FTP inbound channel adapter is a special listener that connects to the FTP server and listens for the remote directory events (for example, new file created) at which point it initiates a file transfer.
The following example shows how to configure an <code class="literal">inbound-channel-adapter</code>:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-ftp:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"ftpInbound"</span>
    <span class="hl-attribute">channel</span>=<span class="hl-value">"ftpChannel"</span>
    <span class="hl-attribute">session-factory</span>=<span class="hl-value">"ftpSessionFactory"</span>
    <span class="hl-attribute">auto-create-local-directory</span>=<span class="hl-value">"true"</span>
    <span class="hl-attribute">delete-remote-files</span>=<span class="hl-value">"true"</span>
    <span class="hl-attribute">filename-pattern</span>=<span class="hl-value">"*.txt"</span>
    <span class="hl-attribute">remote-directory</span>=<span class="hl-value">"some/remote/path"</span>
    <span class="hl-attribute">remote-file-separator</span>=<span class="hl-value">"/"</span>
    <span class="hl-attribute">preserve-timestamp</span>=<span class="hl-value">"true"</span>
    <span class="hl-attribute">local-filename-generator-expression</span>=<span class="hl-value">"#this.toUpperCase() + '.a'"</span>
    <span class="hl-attribute">scanner</span>=<span class="hl-value">"myDirScanner"</span>
    <span class="hl-attribute">local-filter</span>=<span class="hl-value">"myFilter"</span>
    <span class="hl-attribute">temporary-file-suffix</span>=<span class="hl-value">".writing"</span>
    <span class="hl-attribute">max-fetch-size</span>=<span class="hl-value">"-1"</span>
    <span class="hl-attribute">local-directory</span>=<span class="hl-value">"."</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"1000"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-ftp:inbound-channel-adapter&gt;</span></pre>
</div>
<p>As the preceding configuration shows, you can configure an FTP inbound channel adapter by using the <code class="literal">inbound-channel-adapter</code> element while also providing values for various attributes, such as <code class="literal">local-directory</code>, <code class="literal">filename-pattern</code> (which is based on simple pattern matching, not regular expressions), and the reference to a <code class="literal">session-factory</code>.</p>
<p>By default, the transferred file carries the same name as the original file.
If you want to override this behavior, you can set the <code class="literal">local-filename-generator-expression</code> attribute, which lets you provide a SpEL expression to generate the name of the local file.
Unlike outbound gateways and adapters, where the root object of the SpEL evaluation context is a <code class="literal">Message</code>, this inbound adapter does not yet have the message at the time of evaluation, since that&#8217;s what it ultimately generates with the transferred file as its payload.
Consequently, the root object of the SpEL evaluation context is the original name of the remote file (a <code class="literal">String</code>).</p>
<p>The inbound channel adapter first retrieves the <code class="literal">File</code> object for a local directory and then emits each file according to the poller configuration.
Starting with version 5.0, you can now limit the number of files fetched from the FTP server when new file retrievals are needed.
This can be beneficial when the target files are very large or when you run in a clustered system with a persistent file list filter, discussed later.
Use <code class="literal">max-fetch-size</code> for this purpose.
A negative value (the default) means no limit and all matching files are retrieved.
See <a class="xref" href="#ftp-max-fetch" title="18.7&nbsp;Inbound Channel Adapters: Controlling Remote File Fetching">Section&nbsp;18.7, &#8220;Inbound Channel Adapters: Controlling Remote File Fetching&#8221;</a> for more information.
Since version 5.0, you can also provide a custom <code class="literal">DirectoryScanner</code> implementation to the <code class="literal">inbound-channel-adapter</code> by setting the <code class="literal">scanner</code> attribute.</p>
<p>Starting with Spring Integration 3.0, you can specify the <code class="literal">preserve-timestamp</code> attribute (its default is <code class="literal">false</code>).
When <code class="literal">true</code>, the local file&#8217;s modified timestamp is set to the value retrieved from the server.
Otherwise, it is set to the current time.</p>
<p>Starting with version 4.2, you can specify <code class="literal">remote-directory-expression</code> instead of <code class="literal">remote-directory</code>, letting you dynamically determine the directory on each poll&#8201;&#8212;&#8201;for example, <code class="literal">remote-directory-expression="@myBean.determineRemoteDir()"</code>.</p>
<p>Starting with version 4.3, you can omit the <code class="literal">remote-directory</code> and <code class="literal">remote-directory-expression</code> attributes.
They default to <code class="literal">null</code>.
In this case, according to the FTP protocol, the client working directory is used as the default remote directory.</p>
<p>Sometimes, file filtering based on the simple pattern specified with the <code class="literal">filename-pattern</code> attribute might not suffice.
If this is the case, you can use the <code class="literal">filename-regex</code> attribute to specify a regular expression (such as <code class="literal">filename-regex=".*\.test$"</code>).
Also, if you need complete control, you can use the <code class="literal">filter</code> attribute and provide a reference to any custom implementation of the <code class="literal">o.s.i.file.filters.FileListFilter</code>, a strategy interface for filtering a list of files.
This filter determines which remote files are retrieved.
You can also combine a pattern-based filter with other filters (such as an <code class="literal">AcceptOnceFileListFilter</code> to avoid synchronizing files that have previously been fetched) by using a <code class="literal">CompositeFileListFilter</code>.</p>
<p>The <code class="literal">AcceptOnceFileListFilter</code> stores its state in memory.
If you wish the state to survive a system restart, consider using the <code class="literal">FtpPersistentAcceptOnceFileListFilter</code> instead.
This filter stores the accepted file names in an instance of the <code class="literal">MetadataStore</code> strategy (see <a class="xref" href="#metadata-store" title="12.5&nbsp;Metadata Store">Section&nbsp;12.5, &#8220;Metadata Store&#8221;</a>).
This filter matches on the filename and the remote modified time.</p>
<p>Since version 4.0, this filter requires a <code class="literal">ConcurrentMetadataStore</code>.
When used with a shared data store (such as <code class="literal">Redis</code> with the <code class="literal">RedisMetadataStore</code>), it lets filter keys be shared across multiple application or server instances.</p>
<p>Starting with version 5.0, the <code class="literal">FtpPersistentAcceptOnceFileListFilter</code> with in-memory <code class="literal">SimpleMetadataStore</code> is applied by default for the <code class="literal">FtpInboundFileSynchronizer</code>.
This filter is also applied with the <code class="literal">regex</code> or <code class="literal">pattern</code> option in the XML configuration as well as with <code class="literal">FtpInboundChannelAdapterSpec</code> in the Java DSL.
Any other use cases can be managed with <code class="literal">CompositeFileListFilter</code> (or <code class="literal">ChainFileListFilter</code>).</p>
<p>The preceding discussion refers to filtering the files before retrieving them.
Once the files have been retrieved, an additional filter is applied to the files on the file system.
By default, this is an <code class="literal">AcceptOnceFileListFilter</code> which, as discussed earlier, retains state in memory and does not consider the file&#8217;s modified time.
Unless your application removes files after processing, the adapter will re-process the files on disk by default after an application restart.</p>
<p>Also, if you configure the <code class="literal">filter</code> to use a <code class="literal">FtpPersistentAcceptOnceFileListFilter</code> and the remote file timestamp changes (causing it to be re-fetched), the default local filter does not let this new file be processed.</p>
<p>You can use the <code class="literal">local-filter</code> attribute to configure the behavior of the local file system filter.
Starting with version 4.3.8, a <code class="literal">FileSystemPersistentAcceptOnceFileListFilter</code> is configured by default.
This filter stores the accepted file names and modified timestamp in an instance of the <code class="literal">MetadataStore</code> strategy (see <a class="xref" href="#metadata-store" title="12.5&nbsp;Metadata Store">Section&nbsp;12.5, &#8220;Metadata Store&#8221;</a>) and detects changes to the local file modified time.
The default <code class="literal">MetadataStore</code> is a <code class="literal">SimpleMetadataStore</code>, which stores state in memory.</p>
<p>Since version 4.1.5, these filters have a new property (<code class="literal">flushOnUpdate</code>) that causes them to flush the
metadata store on every update (if the store implements <code class="literal">Flushable</code>).</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Further, if you use a distributed <code class="literal">MetadataStore</code> (such as <a class="link" href="#redis-metadata-store" title="27.4&nbsp;Redis Metadata Store">Redis</a> or <a class="link" href="#gemfire-metadata-store" title="19.6&nbsp;Gemfire Metadata Store">GemFire</a>), you can have multiple instances of the same adapter or application and be sure that each file is processed only once.</p>
</td></tr></table></div>
<p>The actual local filter is a <code class="literal">CompositeFileListFilter</code> that contains the supplied filter and a pattern filter that prevents processing files that are in the process of being downloaded (based on the <code class="literal">temporary-file-suffix</code>).
Files are downloaded with this suffix (the default is <code class="literal">.writing</code>), and the file is renamed to its final name when the transfer is complete, making it <span class="emphasis"><em>visible</em></span> to the filter.</p>
<p>The <code class="literal">remote-file-separator</code> attribute lets you configure a file separator character to use if the default <span class="emphasis"><em>/</em></span> is not applicable for your particular environment.</p>
<p>See the <a class="ulink" href="https://github.com/spring-projects/spring-integration/tree/master/spring-integration-core/src/main/resources/org/springframework/integration/config" target="_top">schema</a> for more details on these attributes.</p>
<p>You should also understand that the FTP inbound channel adapter is a polling consumer.
Therefore, you must configure a poller (by using either a global default or a local sub-element).
Once a file has been transferred, a message with a <code class="literal">java.io.File</code> as its payload is generated and sent to the channel identified by the <code class="literal">channel</code> attribute.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_more_on_file_filtering_and_incomplete_files" href="#_more_on_file_filtering_and_incomplete_files"></a>18.4.1&nbsp;More on File Filtering and Incomplete Files</h3></div></div></div>

<p>Sometimes the file that just appeared in the monitored (remote) directory is not complete.
Typically, such a file is written with a temporary extension (such as <code class="literal">somefile.txt.writing</code>) and is then renamed once the writing process finishes.
In most cases, you are only interested in files that are complete and would like to filter for only files that are complete.
To handle these scenarios, you can use the filtering support provided by the <code class="literal">filename-pattern</code>, <code class="literal">filename-regex</code>, and <code class="literal">filter</code> attributes.
The following example uses a custom filter implementation:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-ftp:inbound-channel-adapter</span>
    <span class="hl-attribute">channel</span>=<span class="hl-value">"ftpChannel"</span>
    <span class="hl-attribute">session-factory</span>=<span class="hl-value">"ftpSessionFactory"</span>
    <span class="hl-attribute">filter</span>=<span class="hl-value">"customFilter"</span>
    <span class="hl-attribute">local-directory</span>=<span class="hl-value">"file:/my_transfers"</span><span class="hl-tag">&gt;</span>
    remote-directory="some/remote/path"
    <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"1000"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-ftp:inbound-channel-adapter&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"customFilter"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.example.CustomFilter"</span><span class="hl-tag">/&gt;</span></pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_poller_configuration_notes_for_the_inbound_ftp_adapter" href="#_poller_configuration_notes_for_the_inbound_ftp_adapter"></a>18.4.2&nbsp;Poller Configuration Notes for the Inbound FTP Adapter</h3></div></div></div>

<p>The job of the inbound FTP adapter consists of two tasks:</p>
<div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
Communicate with a remote server in order to transfer files from a remote directory to a local directory.
</li><li class="listitem">
For each transferred file, generate a message with that file as a payload and send it to the channel identified by the <span class="emphasis"><em>channel</em></span> attribute.
That is why they are called "<span class="emphasis"><em>channeladapters</em></span>" rather than just "<span class="emphasis"><em>adapters</em></span>".
The main job of such an adapter is to generate a message to send to a message channel.
Essentially, the second task takes precedence in such a way that, if your local directory already has one or more files, it first generates messages from those.
Only when all local files have been processed does it initiate the remote communication to retrieve more files.
</li></ol></div>
<p>Also, when configuring a trigger on the poller, you should pay close attention to the <code class="literal">max-messages-per-poll</code> attribute.
Its default value is <code class="literal">1</code> for all <code class="literal">SourcePollingChannelAdapter</code> instances (including FTP).
This means that, as soon as one file is processed, it waits for the next execution time as determined by your trigger configuration.
If you happened to have one or more files sitting in the <code class="literal">local-directory</code>, it would process those files before it would initiate communication with the remote FTP server.
Also, if the <code class="literal">max-messages-per-poll</code> is set to <code class="literal">1</code> (the default), it processes only one file at a time with intervals as defined by your trigger, essentially working as "<code class="literal">one-poll === one-file</code>".</p>
<p>For typical file-transfer use cases, you most likely want the opposite behavior: to process all the files you can for each poll and only then wait for the next poll.
If that is the case, set <code class="literal">max-messages-per-poll</code> to -1.
Then, on each poll, the adapter tries to generate as many messages as it possibly can.
In other words, it processes everything in the local directory, and then it connects to the remote directory to transfer everything that is available there to be processed locally.
Only then is the poll operation considered complete, and the poller waits for the next execution time.</p>
<p>You can alternatively set the <span class="emphasis"><em>max-messages-per-poll</em></span> value to a positive value that indicates the upward limit of messages to be created from files with each poll.
For example, a value of <code class="literal">10</code> means that, on each poll, it tries to process no more than ten files.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_recovering_from_failures" href="#_recovering_from_failures"></a>18.4.3&nbsp;Recovering from Failures</h3></div></div></div>

<p>It is important to understand the architecture of the adapter.
There is a file synchronizer that fetches the files and a <code class="literal">FileReadingMessageSource</code> that emits a message for each
synchronized file.
As discussed earlier, two filters are involved.
The <code class="literal">filter</code> attribute (and patterns) refers to the remote (FTP) file list, to avoid fetching files that have already
been fetched.
The <code class="literal">local-filter</code> is used by the <code class="literal">FileReadingMessageSource</code> to determine which files are to be sent as messages.</p>
<p>The synchronizer lists the remote files and consults its filter.
The files are then transferred.
If an IO error occurs during file transfer, any files that have already been added to the filter are removed so that they
are eligible to be re-fetched on the next poll.
This only applies if the filter implements <code class="literal">ReversibleFileListFilter</code> (such as the <code class="literal">AcceptOnceFileListFilter</code>).</p>
<p>If, after synchronizing the files, an error occurs on the downstream flow processing a file, no automatic rollback of the filter occurs, so the failed file is not reprocessed by default.</p>
<p>If you wish to reprocess such files after a failure, you can use configuration similar to the following to facilitate
the removal of the failed file from the filter:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-ftp:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"ftpAdapter"</span>
        <span class="hl-attribute">session-factory</span>=<span class="hl-value">"ftpSessionFactory"</span>
        <span class="hl-attribute">channel</span>=<span class="hl-value">"requestChannel"</span>
        <span class="hl-attribute">remote-directory-expression</span>=<span class="hl-value">"'/sftpSource'"</span>
        <span class="hl-attribute">local-directory</span>=<span class="hl-value">"file:myLocalDir"</span>
        <span class="hl-attribute">auto-create-local-directory</span>=<span class="hl-value">"true"</span>
        <span class="hl-attribute">filename-pattern</span>=<span class="hl-value">"*.txt"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"1000"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;int:transactional</span> <span class="hl-attribute">synchronization-factory</span>=<span class="hl-value">"syncFactory"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;/int:poller&gt;</span>
<span class="hl-tag">&lt;/int-ftp:inbound-channel-adapter&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"acceptOnceFilter"</span>
    <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.file.filters.AcceptOnceFileListFilter"</span><span class="hl-tag"> /&gt;</span>

<span class="hl-tag">&lt;int:transaction-synchronization-factory</span> <span class="hl-attribute">id</span>=<span class="hl-value">"syncFactory"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:after-rollback</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"payload.delete()"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/int:transaction-synchronization-factory&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"transactionManager"</span>
    <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.transaction.PseudoTransactionManager"</span><span class="hl-tag"> /&gt;</span></pre>
</div>
<p>The preceding configuration works for any <code class="literal">ResettableFileListFilter</code>.</p>
<p>Starting with version 5.0, the inbound channel adapter can build sub-directories locally that correspond to the generated local file name.
That can be a remote sub-path as well.
To be able to read a local directory recursively for modification according to the hierarchy support, you can now supply an internal <code class="literal">FileReadingMessageSource</code> with a new <code class="literal">RecursiveDirectoryScanner</code> based on the <code class="literal">Files.walk()</code> algorithm.
See <a class="ulink" href="https://docs.spring.io/spring-integration/api/org/springframework/integration/file/remote/synchronizer/AbstractInboundFileSynchronizingMessageSource.html#setScanner" target="_top"><code class="literal">AbstractInboundFileSynchronizingMessageSource.setScanner()</code></a> for more information.
Also, you can now switch the <code class="literal">AbstractInboundFileSynchronizingMessageSource</code> to the <code class="literal">WatchService</code>-based <code class="literal">DirectoryScanner</code> by using <code class="literal">setUseWatchService()</code> option.
It is also configured for all the <code class="literal">WatchEventType</code> instances to react to any modifications in local directory.
The reprocessing sample shown earlier is based on the built-in functionality of the <code class="literal">FileReadingMessageSource.WatchServiceDirectoryScanner</code> to perform <code class="literal">ResettableFileListFilter.remove()</code> when the file is deleted (<code class="literal">StandardWatchEventKinds.ENTRY_DELETE</code>) from the local directory.
See <a class="xref" href="#watch-service-directory-scanner" title="17.1.4&nbsp;WatchServiceDirectoryScanner">Section&nbsp;17.1.4, &#8220;<code class="literal">WatchServiceDirectoryScanner</code>&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_with_java_configuration_10" href="#_configuring_with_java_configuration_10"></a>18.4.4&nbsp;Configuring with Java Configuration</h3></div></div></div>

<p>The following Spring Boot application show an example of how to configure the inbound adapter with Java configuration:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@SpringBootApplication</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> FtpJavaApplication {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
        <span class="hl-keyword">new</span> SpringApplicationBuilder(FtpJavaApplication.<span class="hl-keyword">class</span>)
            .web(false)
            .run(args);
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> SessionFactory&lt;FTPFile&gt; ftpSessionFactory() {
        DefaultFtpSessionFactory sf = <span class="hl-keyword">new</span> DefaultFtpSessionFactory();
        sf.setHost(<span class="hl-string">"localhost"</span>);
        sf.setPort(port);
        sf.setUsername(<span class="hl-string">"foo"</span>);
        sf.setPassword(<span class="hl-string">"foo"</span>);
        sf.setTestSession(true);
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> CachingSessionFactory&lt;FTPFile&gt;(sf);
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> FtpInboundFileSynchronizer ftpInboundFileSynchronizer() {
        FtpInboundFileSynchronizer fileSynchronizer = <span class="hl-keyword">new</span> FtpInboundFileSynchronizer(ftpSessionFactory());
        fileSynchronizer.setDeleteRemoteFiles(false);
        fileSynchronizer.setRemoteDirectory(<span class="hl-string">"foo"</span>);
        fileSynchronizer.setFilter(<span class="hl-keyword">new</span> FtpSimplePatternFileListFilter(<span class="hl-string">"*.xml"</span>));
        <span class="hl-keyword">return</span> fileSynchronizer;
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <em><span class="hl-annotation" style="color: gray">@InboundChannelAdapter(channel = "ftpChannel", poller = @Poller(fixedDelay = "5000"))</span></em>
    <span class="hl-keyword">public</span> MessageSource&lt;File&gt; ftpMessageSource() {
        FtpInboundFileSynchronizingMessageSource source =
                <span class="hl-keyword">new</span> FtpInboundFileSynchronizingMessageSource(ftpInboundFileSynchronizer());
        source.setLocalDirectory(<span class="hl-keyword">new</span> File(<span class="hl-string">"ftp-inbound"</span>));
        source.setAutoCreateLocalDirectory(true);
        source.setLocalFilter(<span class="hl-keyword">new</span> AcceptOnceFileListFilter&lt;File&gt;());
        source.setMaxFetchSize(<span class="hl-number">1</span>);
        <span class="hl-keyword">return</span> source;
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "ftpChannel")</span></em>
    <span class="hl-keyword">public</span> MessageHandler handler() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> MessageHandler() {

            <em><span class="hl-annotation" style="color: gray">@Override</span></em>
            <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> handleMessage(Message&lt;?&gt; message) <span class="hl-keyword">throws</span> MessagingException {
                System.out.println(message.getPayload());
            }

        };
    }

}</pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_with_the_java_dsl_11" href="#_configuring_with_the_java_dsl_11"></a>18.4.5&nbsp;Configuring with the Java DSL</h3></div></div></div>

<p>The following Spring Boot application shows an example of how to configure the inbound adapter with the Java DSL:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@SpringBootApplication</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> FtpJavaApplication {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
        <span class="hl-keyword">new</span> SpringApplicationBuilder(FtpJavaApplication.<span class="hl-keyword">class</span>)
            .web(false)
            .run(args);
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> IntegrationFlow ftpInboundFlow() {
        <span class="hl-keyword">return</span> IntegrationFlows
            .from(s -&gt; s.ftp(<span class="hl-keyword">this</span>.ftpSessionFactory)
                    .preserveTimestamp(true)
                    .remoteDirectory(<span class="hl-string">"foo"</span>)
                    .regexFilter(<span class="hl-string">".*\\.txt$"</span>)
                    .localFilename(f -&gt; f.toUpperCase() + <span class="hl-string">".a"</span>)
                    .localDirectory(<span class="hl-keyword">new</span> File(<span class="hl-string">"d:\\ftp_files"</span>)),
                e -&gt; e.id(<span class="hl-string">"ftpInboundAdapter"</span>)
                    .autoStartup(true)
                    .poller(Pollers.fixedDelay(<span class="hl-number">5000</span>)))
            .handle(m -&gt; System.out.println(m.getPayload()))
            .get();
    }
}</pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="ftp-incomplete" href="#ftp-incomplete"></a>18.4.6&nbsp;Dealing With Incomplete Data</h3></div></div></div>

<p>See <a class="xref" href="#file-incomplete" title="17.1.9&nbsp;Dealing With Incomplete Data">Section&nbsp;17.1.9, &#8220;Dealing With Incomplete Data&#8221;</a>.</p>
<p>The <code class="literal">FtpSystemMarkerFilePresentFileListFilter</code> is provided to filter remote files that do not have a corresponding marker file on the remote system.
See the <a class="ulink" href="https://docs.spring.io/spring-integration/api/org/springframework/integration/ftp/filters/FtpSystemMarkerFilePresentFileListFilter.html" target="_top">Javadoc</a> (and browse to the parent classes) for configuration information.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="ftp-streaming" href="#ftp-streaming"></a>18.5&nbsp;FTP Streaming Inbound Channel Adapter</h2></div></div></div>

<p>Version 4.3 introduced the streaming inbound channel adapter.
This adapter produces message with payloads of type <code class="literal">InputStream</code>, letting files be fetched without writing to the
local file system.
Since the session remains open, the consuming application is responsible for closing the session when the file has been
consumed.
The session is provided in the <code class="literal">closeableResource</code> header (<code class="literal">IntegrationMessageHeaderAccessor.CLOSEABLE_RESOURCE</code>).
Standard framework components, such as the <code class="literal">FileSplitter</code> and <code class="literal">StreamTransformer</code>, automatically close the session.
See <a class="xref" href="#file-splitter" title="17.4&nbsp;File Splitter">Section&nbsp;17.4, &#8220;File Splitter&#8221;</a> and <a class="xref" href="#stream-transformer" title="Stream Transformer">the section called &#8220;Stream Transformer&#8221;</a> for more information about these components.
The follwoing example shows how to configure an <code class="literal">inbound-streaming-channel-adapter</code>:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-ftp:inbound-streaming-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"ftpInbound"</span>
            <span class="hl-attribute">channel</span>=<span class="hl-value">"ftpChannel"</span>
            <span class="hl-attribute">session-factory</span>=<span class="hl-value">"sessionFactory"</span>
            <span class="hl-attribute">filename-pattern</span>=<span class="hl-value">"*.txt"</span>
            <span class="hl-attribute">filename-regex</span>=<span class="hl-value">".*\.txt"</span>
            <span class="hl-attribute">filter</span>=<span class="hl-value">"filter"</span>
            <span class="hl-attribute">filter-expression</span>=<span class="hl-value">"@myFilterBean.check(#root)"</span>
            <span class="hl-attribute">remote-file-separator</span>=<span class="hl-value">"/"</span>
            <span class="hl-attribute">comparator</span>=<span class="hl-value">"comparator"</span>
            <span class="hl-attribute">max-fetch-size</span>=<span class="hl-value">"1"</span>
            <span class="hl-attribute">remote-directory-expression</span>=<span class="hl-value">"'foo/bar'"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"1000"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/int-ftp:inbound-streaming-channel-adapter&gt;</span></pre>
</div>
<p>Only one of <code class="literal">filename-pattern</code>, <code class="literal">filename-regex</code>, <code class="literal">filter</code>, or <code class="literal">filter-expression</code> is allowed.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Starting with version 5.0, by default, the <code class="literal">FtpStreamingMessageSource</code> adapter prevents duplicates for remote files with <code class="literal">FtpPersistentAcceptOnceFileListFilter</code> based on the in-memory <code class="literal">SimpleMetadataStore</code>.
By default, this filter is also applied with the filename pattern (or regex).
If you need to allow duplicates, you can use <code class="literal">AcceptAllFileListFilter</code>.
Any other use cases can be handled by <code class="literal">CompositeFileListFilter</code> (or <code class="literal">ChainFileListFilter</code>).
The Java configuration (<a class="link" href="#ftp-streaming-java" title="18.5.1&nbsp;Configuring with Java Configuration">later in the document</a>) shows one technique to remove the remote file after processing to avoid duplicates.</p>
</td></tr></table></div>
<p>Use the <code class="literal">max-fetch-size</code> attribute to limit the number of files fetched on each poll when a fetch is necessary.
Set it to <code class="literal">1</code> and use a persistent filter when running in a clustered environment.
See <a class="xref" href="#ftp-max-fetch" title="18.7&nbsp;Inbound Channel Adapters: Controlling Remote File Fetching">Section&nbsp;18.7, &#8220;Inbound Channel Adapters: Controlling Remote File Fetching&#8221;</a> for more information.</p>
<p>The adapter puts the remote directory and file name in the <code class="literal">FileHeaders.REMOTE_DIRECTORY</code> and <code class="literal">FileHeaders.REMOTE_FILE</code> headers, respectively.
Starting with version 5.0, the <code class="literal">FileHeaders.REMOTE_FILE_INFO</code> header provides additional remote file information (represented in JSON by default).
If you set the <code class="literal">fileInfoJson</code> property on the <code class="literal">FtpStreamingMessageSource</code> to <code class="literal">false</code>, the header contains an <code class="literal">FtpFileInfo</code> object.
The <code class="literal">FTPFile</code> object provided by the underlying Apache Net library can be accessed by using the <code class="literal">FtpFileInfo.getFileInfo()</code> method.
The <code class="literal">fileInfoJson</code> property is not available when you use XML configuration, but you can set it by injecting the <code class="literal">FtpStreamingMessageSource</code> into one of your configuration classes.</p>
<p>Starting with version 5.1, the generic type of the <code class="literal">comparator</code> is <code class="literal">FTPFile</code>.
Previously, it was <code class="literal">AbstractFileInfo&lt;FTPFile&gt;</code>.
This is because the sort is now performed earlier in the processing, before filtering and applying <code class="literal">maxFetch</code>.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="ftp-streaming-java" href="#ftp-streaming-java"></a>18.5.1&nbsp;Configuring with Java Configuration</h3></div></div></div>

<p>The following Spring Boot application shows an example of how to configure the inbound adapter with Java configuration:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@SpringBootApplication</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> FtpJavaApplication {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
        <span class="hl-keyword">new</span> SpringApplicationBuilder(FtpJavaApplication.<span class="hl-keyword">class</span>)
            .web(false)
            .run(args);
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <em><span class="hl-annotation" style="color: gray">@InboundChannelAdapter(channel = "stream")</span></em>
    <span class="hl-keyword">public</span> MessageSource&lt;InputStream&gt; ftpMessageSource() {
        FtpStreamingMessageSource messageSource = <span class="hl-keyword">new</span> FtpStreamingMessageSource(template());
        messageSource.setRemoteDirectory(<span class="hl-string">"ftpSource/"</span>);
        messageSource.setFilter(<span class="hl-keyword">new</span> AcceptAllFileListFilter&lt;&gt;());
        messageSource.setMaxFetchSize(<span class="hl-number">1</span>);
        <span class="hl-keyword">return</span> messageSource;
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <em><span class="hl-annotation" style="color: gray">@Transformer(inputChannel = "stream", outputChannel = "data")</span></em>
    <span class="hl-keyword">public</span> org.springframework.integration.transformer.Transformer transformer() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> StreamTransformer(<span class="hl-string">"UTF-8"</span>);
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> FtpRemoteFileTemplate template() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> FtpRemoteFileTemplate(ftpSessionFactory());
    }

    <em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "data", adviceChain = "after")</span></em>
    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> MessageHandler handle() {
        <span class="hl-keyword">return</span> System.out::println;
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> ExpressionEvaluatingRequestHandlerAdvice after() {
        ExpressionEvaluatingRequestHandlerAdvice advice = <span class="hl-keyword">new</span> ExpressionEvaluatingRequestHandlerAdvice();
        advice.setOnSuccessExpression(
                <span class="hl-string">"@template.remove(headers['file_remoteDirectory'] + headers['file_remoteFile'])"</span>);
        advice.setPropagateEvaluationFailures(true);
        <span class="hl-keyword">return</span> advice;
    }

}</pre>
</div>
<p>Notice that, in this example, the message handler downstream of the transformer has an advice that removes the remote file after processing.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="ftp-rotating-server-advice" href="#ftp-rotating-server-advice"></a>18.6&nbsp;Inbound Channel Adapters: Polling Multiple Servers and Directories</h2></div></div></div>

<p>Starting with <span class="emphasis"><em>version 5.0.7</em></span>, the <code class="literal">RotatingServerAdvice</code> is available; when configured as a poller advice, the inbound adapters can poll multiple servers and directories.
Configure the advice and add it to the poller&#8217;s advice chain as normal.
A <code class="literal">DelegatingSessionFactory</code> is used to select the server see <a class="xref" href="#ftp-dsf" title="18.3&nbsp;Delegating Session Factory">Section&nbsp;18.3, &#8220;Delegating Session Factory&#8221;</a> for more information.
The advice configuration consists of a list of <code class="literal">RotatingServerAdvice.KeyDirectory</code> objects.</p>
<p>
<b>Example.&nbsp;</b>

</p><pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> RotatingServerAdvice advice() {
    List&lt;KeyDirectory&gt; keyDirectories = <span class="hl-keyword">new</span> ArrayList&lt;&gt;();
    keyDirectories.add(<span class="hl-keyword">new</span> KeyDirectory(<span class="hl-string">"one"</span>, <span class="hl-string">"foo"</span>));
    keyDirectories.add(<span class="hl-keyword">new</span> KeyDirectory(<span class="hl-string">"one"</span>, <span class="hl-string">"bar"</span>));
    keyDirectories.add(<span class="hl-keyword">new</span> KeyDirectory(<span class="hl-string">"two"</span>, <span class="hl-string">"baz"</span>));
    keyDirectories.add(<span class="hl-keyword">new</span> KeyDirectory(<span class="hl-string">"two"</span>, <span class="hl-string">"qux"</span>));
    keyDirectories.add(<span class="hl-keyword">new</span> KeyDirectory(<span class="hl-string">"three"</span>, <span class="hl-string">"fiz"</span>));
    keyDirectories.add(<span class="hl-keyword">new</span> KeyDirectory(<span class="hl-string">"three"</span>, <span class="hl-string">"buz"</span>));
    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> RotatingServerAdvice(delegatingSf(), keyDirectories);
}</pre><p>

</p>
<p>This advice will poll directory <code class="literal">foo</code> on server <code class="literal">one</code> until no new files exist then move to directory <code class="literal">bar</code> and then directory <code class="literal">baz</code> on server <code class="literal">two</code>, etc.</p>
<p>This default behavior can be modified with the <code class="literal">fair</code> constructor arg:</p>
<p>
<b>fair.&nbsp;</b>

</p><pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> RotatingServerAdvice advice() {
    ...
    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> RotatingServerAdvice(delegatingSf(), keyDirectories, true);
}</pre><p>

</p>
<p>In this case, the advice will move to the next server/directory regardless of whether the previous poll returned a file.</p>
<p>Alternatively, you can provide your own <code class="literal">RotatingServerAdvice.RotationPolicy</code> to reconfigure the message source as needed:</p>
<p>
<b>policy.&nbsp;</b>

</p><pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> RotationPolicy {

    <span class="hl-keyword">void</span> beforeReceive(MessageSource&lt;?&gt; source);

    <span class="hl-keyword">void</span> afterReceive(<span class="hl-keyword">boolean</span> messageReceived, MessageSource&lt;?&gt; source);

}</pre><p>

</p>
<p>and</p>
<p>
<b>custom.&nbsp;</b>

</p><pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> RotatingServerAdvice advice() {
    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> RotatingServerAdvice(myRotationPolicy());
}</pre><p>

</p>
<p>The <code class="literal">local-filename-generator-expression</code> attribute (<code class="literal">localFilenameGeneratorExpression</code> on the synchronizer) can now contain the <code class="literal">#remoteDirectory</code> variable.
This allows files retrieved from different directories to be downloaded to similar directories locally:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> IntegrationFlow flow() {
    <span class="hl-keyword">return</span> IntegrationFlows.from(Ftp.inboundAdapter(sf())
                    .filter(<span class="hl-keyword">new</span> FtpPersistentAcceptOnceFileListFilter(<span class="hl-keyword">new</span> SimpleMetadataStore(), <span class="hl-string">"rotate"</span>))
                    .localDirectory(<span class="hl-keyword">new</span> File(tmpDir))
                    .localFilenameExpression(<span class="hl-string">"#remoteDirectory + T(java.io.File).separator + #root"</span>)
                    .remoteDirectory(<span class="hl-string">"."</span>),
                e -&gt; e.poller(Pollers.fixedDelay(<span class="hl-number">1</span>).advice(advice())))
            .channel(MessageChannels.queue(<span class="hl-string">"files"</span>))
            .get();
}</pre>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Do not configure a <code class="literal">TaskExecutor</code> on the poller when using this advice; see <a class="xref" href="#conditional-pollers" title="6.2.4&nbsp;Conditional Pollers for Message Sources">Section&nbsp;6.2.4, &#8220;Conditional Pollers for Message Sources&#8221;</a> for more information.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="ftp-max-fetch" href="#ftp-max-fetch"></a>18.7&nbsp;Inbound Channel Adapters: Controlling Remote File Fetching</h2></div></div></div>

<p>There are two properties that you should consider when you configure inbound channel adapters.
<code class="literal">max-messages-per-poll</code>, as with all pollers, can be used to limit the number of messages emitted on each poll (if more than the configured value are ready).
<code class="literal">max-fetch-size</code> (since version 5.0) can limit the number of files retrieved from the remote server at one time.</p>
<p>The following scenarios assume the starting state is an empty local directory:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">max-messages-per-poll=2</code> and <code class="literal">max-fetch-size=1</code>: The adapter fetches one file, emits it, fetches the next file, emits it, and then sleeps until the next poll.
</li><li class="listitem">
<code class="literal">max-messages-per-poll=2</code> and <code class="literal">max-fetch-size=2</code>): The adapter fetches both files and then emits each one.
</li><li class="listitem">
<code class="literal">max-messages-per-poll=2</code> and <code class="literal">max-fetch-size=4</code>: The adapter fetches up to four files (if available) and emits the first two (if there are at least two).
The next two files are emitted on the next poll.
</li><li class="listitem">
<code class="literal">max-messages-per-poll=2</code> and <code class="literal">max-fetch-size</code> not specified: The adapter fetches all remote files and emits the first two (if there are at least two).
The subsequent files are emitted on subsequent polls (two at a time).
When all files are consumed, the remote fetch is attempted again, to pick up any new files.
</li></ul></div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>When you deploy multiple instances of an application, we recommend a small <code class="literal">max-fetch-size</code>, to avoid one instance "<code class="literal">grabbing</code>" all the files and starving other instances.</p>
</td></tr></table></div>
<p>Another use for <code class="literal">max-fetch-size</code> is if you want to stop fetching remote files but continue to process files that have already been fetched.
Setting the <code class="literal">maxFetchSize</code> property on the <code class="literal">MessageSource</code> (programmatically, with JMX, or with a <a class="link" href="#control-bus" title="12.6&nbsp;Control Bus">control bus</a>) effectively stops the adapter from fetching more files but lets the poller continue to emit messages for files that have previously been fetched.
If the poller is active when the property is changed, the change takes effect on the next poll.</p>
<p>Starting with version 5.1, the synchronizer can be provided with a <code class="literal">Comparator&lt;FTPFile&gt;</code>.
This is useful when restricting the number of files fetched with <code class="literal">maxFetchSize</code>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="ftp-outbound" href="#ftp-outbound"></a>18.8&nbsp;FTP Outbound Channel Adapter</h2></div></div></div>

<p>The FTP outbound channel adapter relies on a <code class="literal">MessageHandler</code> implementation that connects to the FTP server and initiates an FTP transfer for every file it receives in the payload of incoming messages.
It also supports several representations of a file, so you are not limited only to <code class="literal">java.io.File</code>-typed payloads.
The FTP outbound channel adapter supports the following payloads:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">java.io.File</code>: The actual file object
</li><li class="listitem">
<code class="literal">byte[]</code>: A byte array that represents the file contents
</li><li class="listitem">
<code class="literal">java.lang.String</code>: Text that represents the file contents.
</li></ul></div>
<p>The following example shows how to configure an <code class="literal">outbound-channel-adapter</code>:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-ftp:outbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"ftpOutbound"</span>
    <span class="hl-attribute">channel</span>=<span class="hl-value">"ftpChannel"</span>
    <span class="hl-attribute">session-factory</span>=<span class="hl-value">"ftpSessionFactory"</span>
    <span class="hl-attribute">charset</span>=<span class="hl-value">"UTF-8"</span>
    <span class="hl-attribute">remote-file-separator</span>=<span class="hl-value">"/"</span>
    <span class="hl-attribute">auto-create-directory</span>=<span class="hl-value">"true"</span>
    <span class="hl-attribute">remote-directory-expression</span>=<span class="hl-value">"headers['remote_dir']"</span>
    <span class="hl-attribute">temporary-remote-directory-expression</span>=<span class="hl-value">"headers['temp_remote_dir']"</span>
    <span class="hl-attribute">filename-generator</span>=<span class="hl-value">"fileNameGenerator"</span>
    <span class="hl-attribute">use-temporary-filename</span>=<span class="hl-value">"true"</span>
    <span class="hl-attribute">mode</span>=<span class="hl-value">"REPLACE"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>The preceding configuration shows how you can configure an FTP outbound channel adapter by using the <code class="literal">outbound-channel-adapter</code> element while also providing values for various attributes, such as <code class="literal">filename-generator</code> (an implementation of the <code class="literal">o.s.i.file.FileNameGenerator</code> strategy interface), a reference to a <code class="literal">session-factory</code>, and other attributes.
You can also see some examples of <code class="literal">*expression</code> attributes that let you use SpEL to configure settings such as <code class="literal">remote-directory-expression</code>, <code class="literal">temporary-remote-directory-expression</code>, and <code class="literal">remote-filename-generator-expression</code> (a SpEL alternative to <code class="literal">filename-generator</code>, shown in the preceding example).
As with any component that allows the usage of SpEL, access to the payload and the message Headers is available through the <span class="emphasis"><em>payload</em></span> and <span class="emphasis"><em>headers</em></span> variables.
See the <a class="ulink" href="https://github.com/spring-projects/spring-integration/tree/master/spring-integration-core/src/main/resources/org/springframework/integration/config" target="_top">schema</a> for more details on the available attributes.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>By default,  if no file name generator is specified, Spring Integration uses <code class="literal">o.s.i.file.DefaultFileNameGenerator</code>.
<code class="literal">DefaultFileNameGenerator</code> determines the file name based on the value of the <code class="literal">file_name</code> header (if it exists) in the <code class="literal">MessageHeaders</code>, or, if the payload of the Message is already a <code class="literal">java.io.File</code>, it uses the original name of that file.</p>
</td></tr></table></div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Defining certain values (such as <code class="literal">remote-directory</code>) might be platform- or FTP server-dependent.
For example, as was reported on <a class="ulink" href="http://forum.springsource.org/showthread.php?p=333478&amp;posted=1#post333478" target="_top">http://forum.springsource.org/showthread.php?p=333478&amp;posted=1#post333478</a>, on some platforms, you must add a slash to the end of the directory definition (for example, <code class="literal">remote-directory="/thing1/thing2/"</code> instead of <code class="literal">remote-directory="/thing1/thing2"</code>).</p>
</td></tr></table></div>
<p>Starting with version 4.1, you can specify the <code class="literal">mode</code> when transferring the file.
By default, an existing file is overwritten.
The modes are defined by the <code class="literal">FileExistsMode</code> enumeration, which includes the following values:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">REPLACE</code> (default)
*<code class="literal">APPEND</code>
</li><li class="listitem">
<code class="literal">IGNORE</code>
</li><li class="listitem">
<code class="literal">FAIL</code>
</li></ul></div>
<p><code class="literal">IGNORE</code> and <code class="literal">FAIL</code> do not transfer the file.
<code class="literal">FAIL</code> causes an exception to be thrown, while <code class="literal">IGNORE</code> silently ignores the transfer (although a <code class="literal">DEBUG</code> log entry is produced).</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_avoiding_partially_written_files" href="#_avoiding_partially_written_files"></a>18.8.1&nbsp;Avoiding Partially Written Files</h3></div></div></div>

<p>One of the common problems that arises when dealing with file transfers is the possibility of processing a partial file.
That is, a file might appear in the file system before its transfer is actually complete.</p>
<p>To deal with this issue, Spring Integration FTP adapters use a common algorithm: Files are transferred under a temporary name and then renamed once they are fully transferred.</p>
<p>By default, every file that is in the process of being transferred appears in the file system with an additional suffix, which, by default, is <code class="literal">.writing</code>.
You can change this suffix by setting the <code class="literal">temporary-file-suffix</code> attribute.</p>
<p>However, there may be situations where you do not want to use this technique (for example, if the server does not permit renaming files).
For situations like this, you can disable this feature by setting <code class="literal">use-temporary-file-name</code> to <code class="literal">false</code> (the default is <code class="literal">true</code>).
When this attribute is <code class="literal">false</code>, the file is written with its final name and the consuming application needs some other mechanism to detect that the file is completely uploaded before accessing it.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_with_java_configuration_11" href="#_configuring_with_java_configuration_11"></a>18.8.2&nbsp;Configuring with Java Configuration</h3></div></div></div>

<p>The following Spring Boot application shows an example of how to configure the outbound adapter with Java configuration:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@SpringBootApplication</span></em>
<em><span class="hl-annotation" style="color: gray">@IntegrationComponentScan</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> FtpJavaApplication {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
        ConfigurableApplicationContext context =
                    <span class="hl-keyword">new</span> SpringApplicationBuilder(FtpJavaApplication.<span class="hl-keyword">class</span>)
                        .web(false)
                        .run(args);
        MyGateway gateway = context.getBean(MyGateway.<span class="hl-keyword">class</span>);
        gateway.sendToFtp(<span class="hl-keyword">new</span> File(<span class="hl-string">"/foo/bar.txt"</span>));
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> SessionFactory&lt;FTPFile&gt; ftpSessionFactory() {
        DefaultFtpSessionFactory sf = <span class="hl-keyword">new</span> DefaultFtpSessionFactory();
        sf.setHost(<span class="hl-string">"localhost"</span>);
        sf.setPort(port);
        sf.setUsername(<span class="hl-string">"foo"</span>);
        sf.setPassword(<span class="hl-string">"foo"</span>);
        sf.setTestSession(true);
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> CachingSessionFactory&lt;FTPFile&gt;(sf);
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "ftpChannel")</span></em>
    <span class="hl-keyword">public</span> MessageHandler handler() {
        FtpMessageHandler handler = <span class="hl-keyword">new</span> FtpMessageHandler(ftpSessionFactory());
        handler.setRemoteDirectoryExpressionString(<span class="hl-string">"headers['remote-target-dir']"</span>);
        handler.setFileNameGenerator(<span class="hl-keyword">new</span> FileNameGenerator() {

            <em><span class="hl-annotation" style="color: gray">@Override</span></em>
            <span class="hl-keyword">public</span> String generateFileName(Message&lt;?&gt; message) {
                 <span class="hl-keyword">return</span> <span class="hl-string">"handlerContent.test"</span>;
            }

        });
        <span class="hl-keyword">return</span> handler;
    }

    <em><span class="hl-annotation" style="color: gray">@MessagingGateway</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> MyGateway {

         <em><span class="hl-annotation" style="color: gray">@Gateway(requestChannel = "toFtpChannel")</span></em>
         <span class="hl-keyword">void</span> sendToFtp(File file);

    }
}</pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_with_the_java_dsl_12" href="#_configuring_with_the_java_dsl_12"></a>18.8.3&nbsp;Configuring with the Java DSL</h3></div></div></div>

<p>The following Spring Boot application shows an example of how to configure the outbound adapter using the Java DSL:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@SpringBootApplication</span></em>
<em><span class="hl-annotation" style="color: gray">@IntegrationComponentScan</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> FtpJavaApplication {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
        ConfigurableApplicationContext context =
            <span class="hl-keyword">new</span> SpringApplicationBuilder(FtpJavaApplication.<span class="hl-keyword">class</span>)
                .web(false)
                .run(args);
        MyGateway gateway = context.getBean(MyGateway.<span class="hl-keyword">class</span>);
        gateway.sendToFtp(<span class="hl-keyword">new</span> File(<span class="hl-string">"/foo/bar.txt"</span>));
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> SessionFactory&lt;FTPFile&gt; ftpSessionFactory() {
        DefaultFtpSessionFactory sf = <span class="hl-keyword">new</span> DefaultFtpSessionFactory();
        sf.setHost(<span class="hl-string">"localhost"</span>);
        sf.setPort(port);
        sf.setUsername(<span class="hl-string">"foo"</span>);
        sf.setPassword(<span class="hl-string">"foo"</span>);
        sf.setTestSession(true);
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> CachingSessionFactory&lt;FTPFile&gt;(sf);
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> IntegrationFlow ftpOutboundFlow() {
        <span class="hl-keyword">return</span> IntegrationFlows.from(<span class="hl-string">"toFtpChannel"</span>)
                .handle(Ftp.outboundAdapter(ftpSessionFactory(), FileExistsMode.FAIL)
                        .useTemporaryFileName(false)
                        .fileNameExpression(<span class="hl-string">"headers['"</span> + FileHeaders.FILENAME + <span class="hl-string">"']"</span>)
                        .remoteDirectory(<span class="hl-keyword">this</span>.ftpServer.getTargetFtpDirectory().getName())
                ).get();
    }

    <em><span class="hl-annotation" style="color: gray">@MessagingGateway</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> MyGateway {

         <em><span class="hl-annotation" style="color: gray">@Gateway(requestChannel = "toFtpChannel")</span></em>
         <span class="hl-keyword">void</span> sendToFtp(File file);

    }

}</pre>
</div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="ftp-outbound-gateway" href="#ftp-outbound-gateway"></a>18.9&nbsp;FTP Outbound Gateway</h2></div></div></div>

<p>The FTP outbound gateway provides a limited set of commands to interact with a remote FTP or FTPS server.
The supported commands are:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">ls</code> (list files)
</li><li class="listitem">
<code class="literal">nlst</code> (list file names)
</li><li class="listitem">
<code class="literal">get</code> (retrieve file)
</li><li class="listitem">
<code class="literal">mget</code> (retrieve file(s))
</li><li class="listitem">
<code class="literal">rm</code> (remove file(s))
</li><li class="listitem">
<code class="literal">mv</code> (move/rename file)
</li><li class="listitem">
<code class="literal">put</code> (send file)
</li><li class="listitem">
<code class="literal">mput</code> (send multiple files)
</li></ul></div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="ftp-using-ls" href="#ftp-using-ls"></a>18.9.1&nbsp;Using the <code class="literal">ls</code> Command</h3></div></div></div>

<p><code class="literal">ls</code> lists remote files and supports the following options:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">-1</code>: Retrieve a list of file names.
The default is to retrieve a list of <code class="literal">FileInfo</code> objects.
</li><li class="listitem">
<code class="literal">-a</code>: Include all files (including those starting with <span class="emphasis"><em>.</em></span>)
</li><li class="listitem">
<code class="literal">-f</code>: Do not sort the list
</li><li class="listitem">
<code class="literal">-dirs</code>: Include directories (they are excluded by default)
</li><li class="listitem">
<code class="literal">-links</code>: Include symbolic links (they are excluded by default)
</li><li class="listitem">
<code class="literal">-R</code>: List the remote directory recursively
</li></ul></div>
<p>In addition, filename filtering is provided, in the same manner as the <code class="literal">inbound-channel-adapter</code>.
See <a class="xref" href="#ftp-inbound" title="18.4&nbsp;FTP Inbound Channel Adapter">Section&nbsp;18.4, &#8220;FTP Inbound Channel Adapter&#8221;</a>.</p>
<p>The message payload resulting from an <code class="literal">ls</code> operation is a list of file names or a list of <code class="literal">FileInfo</code> objects.
These objects provide information such as modified time, permissions, and other details.</p>
<p>The remote directory that the <code class="literal">ls</code> command acted on is provided in the <code class="literal">file_remoteDirectory</code> header.</p>
<p>When using the recursive option (<code class="literal">-R</code>), the <code class="literal">fileName</code> includes any subdirectory elements, representing a relative path to the file (relative to the remote directory).
If the <code class="literal">-dirs</code> option is included, each recursive directory is also returned as an element in the list.
In this case, it is recommended that you not use the <code class="literal">-1</code> option, because you would not be able to distinguish files from directories, which you can do with the <code class="literal">FileInfo</code> objects.</p>
<p>Starting with version 4.3, the <code class="literal">FtpSession</code> supports <code class="literal">null</code> for the <code class="literal">list()</code> and <code class="literal">listNames()</code> methods.
Therefore, you can omit the <code class="literal">expression</code> attribute.
For convenience, Java configuration has two constructors that do not have an <code class="literal">expression</code> argument.
or <code class="literal">LS</code>, <code class="literal">NLST</code>, <code class="literal">PUT</code> and <code class="literal">MPUT</code> commands, <code class="literal">null</code> is treated as the client working directory, according to the FTP protocol.
All other commands must be supplied with the <code class="literal">expression</code> to evaluate the remote path against the request message.
You can set the working directory with the <code class="literal">FTPClient.changeWorkingDirectory()</code> function when you extend the <code class="literal">DefaultFtpSessionFactory</code> and implement the <code class="literal">postProcessClientAfterConnect()</code> callback.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_using_the_literal_nlst_literal_command" href="#_using_the_literal_nlst_literal_command"></a>18.9.2&nbsp;Using the <code class="literal">nlst</code> Command</h3></div></div></div>

<p>Version 5 introduced support for the <code class="literal">nlst</code> command.</p>
<p><code class="literal">nlst</code> lists remote file names and supports only one option:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">-f</code>: Do not sort the list
</li></ul></div>
<p>The message payload resulting from an <code class="literal">nlst</code> operation is a list of file names.</p>
<p>The remote directory that the <code class="literal">nlst</code> command acted on is provided in the <code class="literal">file_remoteDirectory</code> header.</p>
<p>Unlike the <code class="literal">-1</code> option for the <a class="link" href="#ftp-using-ls" title="18.9.1&nbsp;Using the ls Command"><code class="literal">ls</code> command</a>, which uses the <code class="literal">LIST</code> command, the <code class="literal">nlst</code> command sends an <code class="literal">NLST</code> command to the target FTP server.
This command is useful when the server does not support <code class="literal">LIST</code> (due to security restrictions, for example).
The result of the <code class="literal">nlst</code> operation is the names without other detail.
Therefore, the framework cannot determine if an entity is a directory, to perform filtering or recursive listing, for example.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_using_the_literal_get_literal_command" href="#_using_the_literal_get_literal_command"></a>18.9.3&nbsp;Using the <code class="literal">get</code> Command</h3></div></div></div>

<p><code class="literal">get</code> retrieves a remote file.
It supports the following option:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">-P</code>: Preserve the timestamp of the remote file.
</li><li class="listitem">
<code class="literal">-stream</code>: Retrieve the remote file as a stream.
</li><li class="listitem">
<code class="literal">-D</code>: Delete the remote file after successful transfer.
The remote file is not deleted if the transfer is ignored, because the <code class="literal">FileExistsMode</code> is <code class="literal">IGNORE</code> and the local file already exists.
</li></ul></div>
<p>The <code class="literal">file_remoteDirectory</code> header provides the remote directory name, and the <code class="literal">file_remoteFile</code> header provides the file name.</p>
<p>The message payload resulting from a <code class="literal">get</code> operation is a <code class="literal">File</code> object that represents the retrieved file or an <code class="literal">InputStream</code> when you use the <code class="literal">-stream</code> option.
The <code class="literal">-stream</code> option allows retrieving the file as a stream.
For text files, a common use case is to combine this operation with a <a class="link" href="#file-splitter" title="17.4&nbsp;File Splitter">file splitter</a> or a <a class="link" href="#stream-transformer" title="Stream Transformer">stream transformer</a>.
When consuming remote files as streams, you are responsible for closing the <code class="literal">Session</code> after the stream is consumed.
For convenience, the <code class="literal">Session</code> is provided in the <code class="literal">closeableResource</code> header, which you can access with a convenience method on <code class="literal">IntegrationMessageHeaderAccessor</code>
The following example shows how to do use the covenience method:</p>
<div class="informalexample">
<pre class="programlisting">Closeable closeable = <span class="hl-keyword">new</span> IntegrationMessageHeaderAccessor(message).getCloseableResource();
<span class="hl-keyword">if</span> (closeable != null) {
    closeable.close();
}</pre>
</div>
<p>Framework components such as the <a class="link" href="#file-splitter" title="17.4&nbsp;File Splitter">file splitter</a> and the <a class="link" href="#stream-transformer" title="Stream Transformer">stream transformer</a> automatically close the session after the data is transferred.</p>
<p>The following example shows how to consume a file as a stream:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-ftp:outbound-gateway</span> <span class="hl-attribute">session-factory</span>=<span class="hl-value">"ftpSessionFactory"</span>
                            <span class="hl-attribute">request-channel</span>=<span class="hl-value">"inboundGetStream"</span>
                            <span class="hl-attribute">command</span>=<span class="hl-value">"get"</span>
                            <span class="hl-attribute">command-options</span>=<span class="hl-value">"-stream"</span>
                            <span class="hl-attribute">expression</span>=<span class="hl-value">"payload"</span>
                            <span class="hl-attribute">remote-directory</span>=<span class="hl-value">"ftpTarget"</span>
                            <span class="hl-attribute">reply-channel</span>=<span class="hl-value">"stream"</span><span class="hl-tag"> /&gt;</span>

<span class="hl-tag">&lt;int-file:splitter</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"stream"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"lines"</span><span class="hl-tag"> /&gt;</span></pre>
</div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>If you consume the input stream in a custom component, you must close the <code class="literal">Session</code>.
You can do so either in your custom code or by routing a copy of the message to a <code class="literal">service-activator</code> and using SpEL, as the following example shows:</p>
</td></tr></table></div>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:service-activator</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"closeSession"</span>
    <span class="hl-attribute">expression</span>=<span class="hl-value">"headers['closeableResource'].close()"</span><span class="hl-tag"> /&gt;</span></pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_using_the_literal_mget_literal_command" href="#_using_the_literal_mget_literal_command"></a>18.9.4&nbsp;Using the <code class="literal">mget</code> Command</h3></div></div></div>

<p><code class="literal">mget</code> retrieves multiple remote files based on a pattern and supports the following options:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">-P</code>: Preserve the timestamps of the remote files.
</li><li class="listitem">
<code class="literal">-R</code>: Retrieve the entire directory tree recursively.
</li><li class="listitem">
<code class="literal">-x</code>: Throw an exception if no files match the pattern (otherwise an empty list is returned).
</li><li class="listitem">
<code class="literal">-D</code>: Delete each remote file after successful transfer.
The remote file is not deleted if the transfer is ignored, because the <code class="literal">FileExistsMode</code> is <code class="literal">IGNORE</code> and the local file already exists.
</li></ul></div>
<p>The message payload resulting from an <code class="literal">mget</code> operation is a <code class="literal">List&lt;File&gt;</code> object (that is, a <code class="literal">List</code> of <code class="literal">File</code> objects, each representing a retrieved file).</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Starting with version 5.0, if the <code class="literal">FileExistsMode</code> is <code class="literal">IGNORE</code>, the payload of the output message no longer contains files that were not fetched due to the file already existing.
Previously, the list contained all files, including those that already existed.</p>
</td></tr></table></div>
<p>The expression used to determine the remote path should produce a result that ends with <code class="literal">*</code> - e.g. <code class="literal">somedir/*</code> will fetch the complete tree under <code class="literal">somedir</code>.</p>
<p>Starting with version 5.0, a recursive <code class="literal">mget</code>, combined with the new <code class="literal">FileExistsMode.REPLACE_IF_MODIFIED</code> mode, can be used to periodically synchronize an entire remote directory tree locally.
This mode replaces the local file&#8217;s last modified timestamp with the remote timestamp, regardless of the <code class="literal">-P</code> (preserve timestamp) option.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important: Using recursion (-R)"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Using recursion (<code class="literal">-R</code>)</th></tr><tr><td align="left" valign="top">

<p>The pattern is ignored, and <code class="literal">*</code> is assumed.
By default, the entire remote tree is retrieved.
However, files in the tree can be filtered, by providing a <code class="literal">FileListFilter</code>.
Directories in the tree can also be filtered this way.
A <code class="literal">FileListFilter</code> can be provided by reference, by <code class="literal">filename-pattern</code>, or by <code class="literal">filename-regex</code> attributes.
For example, <code class="literal">filename-regex="(subDir|.*1.txt)"</code> retrieves all files ending with <code class="literal">1.txt</code> in the remote directory and the <code class="literal">subDir</code> child directory.
However, the next example shows an alternative, which version 5.0 made available.</p>
<p>If a subdirectory is filtered, no additional traversal of that subdirectory is performed.</p>
<p>The <code class="literal">-dirs</code> option is not allowed (the recursive <code class="literal">mget</code> uses the recursive <code class="literal">ls</code> to obtain the directory tree, so the directories themselves cannot be included in the list).</p>
<p>Typically, you would use the <code class="literal">#remoteDirectory</code> variable in the <code class="literal">local-directory-expression</code> so that the remote directory structure is retained locally.</p>
</td></tr></table></div>
<p>Starting with version 5.0, the <code class="literal">FtpSimplePatternFileListFilter</code> and <code class="literal">FtpRegexPatternFileListFilter</code> can be configured to always pass directories by setting the <code class="literal">alwaysAcceptDirectories</code> property to <code class="literal">true</code>.
Doing so allows recursion for a simple pattern, as the following examples show:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"starDotTxtFilter"</span>
        <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.ftp.filters.FtpSimplePatternFileListFilter"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"*.txt"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"alwaysAcceptDirectories"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"true"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"dotStarDotTxtFilter"</span>
            <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.ftp.filters.FtpRegexPatternFileListFilter"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"^.*\.txt$"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"alwaysAcceptDirectories"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"true"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
</div>
<p>Once you have defined filters such as those in the preceding example, you can use one by setting the <code class="literal">filter</code> property on the gateway.</p>
<p>See also <a class="xref" href="#ftp-partial" title="18.9.11&nbsp;Outbound Gateway Partial Success (mget and mput)">Section&nbsp;18.9.11, &#8220;Outbound Gateway Partial Success (<code class="literal">mget</code> and <code class="literal">mput</code>)&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="ftp-put-command" href="#ftp-put-command"></a>18.9.5&nbsp;Using the <code class="literal">put</code> Command</h3></div></div></div>

<p>The <code class="literal">put</code> commad sends a file to the remote server.
The payload of the message can be a <code class="literal">java.io.File</code>, a <code class="literal">byte[]</code>, or a <code class="literal">String</code>.
A <code class="literal">remote-filename-generator</code> (or expression) is used to name the remote file.
Other available attributes include <code class="literal">remote-directory</code>, <code class="literal">temporary-remote-directory</code>, and their <code class="literal">*-expression</code> equivalents: <code class="literal">use-temporary-file-name</code> and <code class="literal">auto-create-directory</code>.
See the <a class="ulink" href="https://github.com/spring-projects/spring-integration/tree/master/spring-integration-core/src/main/resources/org/springframework/integration/config" target="_top">schema</a> documentation for more information.</p>
<p>The message payload resulting from a <code class="literal">put</code> operation is a <code class="literal">String</code> that represents the full path of the file on the server after transfer.</p>
<p>Using the <code class="literal">mput</code> Command</p>
<p>The <code class="literal">mput</code> sends multiple files to the server and supports only one option:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">-R</code>: Recursive.
Send all files (possibly filtered) in the directory and its subdirectories.
</li></ul></div>
<p>The message payload must be a <code class="literal">java.io.File</code> (or <code class="literal">String</code>) that represents a local directory.
Since version 5.1, a collection of <code class="literal">File</code> or <code class="literal">String</code> is also supported.</p>
<p>This command supports the same attributes as the <a class="link" href="#ftp-put-command" title="18.9.5&nbsp;Using the put Command"><code class="literal">put</code> command</a>.
In addition, files in the local directory can be filtered with one of <code class="literal">mput-pattern</code>, <code class="literal">mput-regex</code>, <code class="literal">mput-filter</code>, or <code class="literal">mput-filter-expression</code>.
The filter works with recursion, as long as the subdirectories themselves pass the filter.
Subdirectories that do not pass the filter are not recursed.</p>
<p>The message payload resulting from an <code class="literal">mget</code> operation is a <code class="literal">List&lt;String&gt;</code> object (that is, a <code class="literal">List</code> of remote file paths that result from the transfer).</p>
<p>See also <a class="xref" href="#ftp-partial" title="18.9.11&nbsp;Outbound Gateway Partial Success (mget and mput)">Section&nbsp;18.9.11, &#8220;Outbound Gateway Partial Success (<code class="literal">mget</code> and <code class="literal">mput</code>)&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_using_the_literal_rm_literal_command" href="#_using_the_literal_rm_literal_command"></a>18.9.6&nbsp;Using the <code class="literal">rm</code> Command</h3></div></div></div>

<p>The <code class="literal">rm</code> command removes files.</p>
<p>The <code class="literal">rm</code> command has no options.</p>
<p>The message payload resulting from an <code class="literal">rm</code> operation is <code class="literal">Boolean.TRUE</code> if the remove was successful or <code class="literal">Boolean.FALSE</code> otherwise.
The <code class="literal">file_remoteDirectory</code> header provides the remote directory, and the <code class="literal">file_remoteFile</code> header provides the file name.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_using_the_literal_mv_literal_command" href="#_using_the_literal_mv_literal_command"></a>18.9.7&nbsp;Using the <code class="literal">mv</code> Command</h3></div></div></div>

<p>The <code class="literal">mv</code> command moves files</p>
<p>The <code class="literal">mv</code> command has no options.</p>
<p>The <code class="literal">expression</code> attribute defines the "<code class="literal">from</code>" path and the <code class="literal">rename-expression</code> attribute defines the "<code class="literal">to</code>" path.
By default, the <code class="literal">rename-expression</code> is <code class="literal">headers['file_renameTo']</code>.
This expression must not evaluate to null or an empty <code class="literal">String</code>.
If necessary, any necessary remote directories are created.
The payload of the result message is <code class="literal">Boolean.TRUE</code>.
The <code class="literal">file_remoteDirectory</code> header provides the original remote directory, and <code class="literal">file_remoteFile</code> header provides the file name.
The new path is in the <code class="literal">file_renameTo</code> header.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_additional_information_about_ftp_outbound_gateway_commands" href="#_additional_information_about_ftp_outbound_gateway_commands"></a>18.9.8&nbsp;Additional Information about FTP Outbound Gateway Commands</h3></div></div></div>

<p>The <code class="literal">get</code> and <code class="literal">mget</code> commands support the <code class="literal">local-filename-generator-expression</code> attribute.
It defines a SpEL expression to generate the name of local files during the transfer.
The root object of the evaluation context is the request message. The <code class="literal">remoteFileName</code> variable, which is particularly useful for <code class="literal">mget</code>, is also available&#8201;&#8212;&#8201;for example, <code class="literal">local-filename-generator-expression="#remoteFileName.toUpperCase() + headers.something"</code>.</p>
<p>The <code class="literal">get</code> and <code class="literal">mget</code> commands support the <code class="literal">local-directory-expression</code> attribute.
It defines a SpEL expression to generate the name of local directories during the transfer.
The root object of the evaluation context is the request message but. The <code class="literal">remoteDirectory</code> variable, which is particularly useful for <code class="literal">mget</code>, is also available&#8201;&#8212;&#8201;for example: <code class="literal">local-directory-expression="'/tmp/local/' + #remoteDirectory.toUpperCase() + headers.something"</code>.
This attribute is mutually exclusive with the <code class="literal">local-directory</code> attribute.</p>
<p>For all commands, the <span class="emphasis"><em>expression</em></span> property of the gateway provides the path on which the command acts.
For the <code class="literal">mget</code> command, the expression might evaluate to <span class="emphasis"><em><span class="strong"><strong></strong></span>, meaning to retrieve all files, or <span class="emphasis"><em>somedirectory/</em></span></em></span>, and so on.</p>
<p>The following example shows a gateway configured for an <code class="literal">ls</code> command:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-ftp:outbound-gateway</span> <span class="hl-attribute">id</span>=<span class="hl-value">"gateway1"</span>
    <span class="hl-attribute">session-factory</span>=<span class="hl-value">"ftpSessionFactory"</span>
    <span class="hl-attribute">request-channel</span>=<span class="hl-value">"inbound1"</span>
    <span class="hl-attribute">command</span>=<span class="hl-value">"ls"</span>
    <span class="hl-attribute">command-options</span>=<span class="hl-value">"-1"</span>
    <span class="hl-attribute">expression</span>=<span class="hl-value">"payload"</span>
    <span class="hl-attribute">reply-channel</span>=<span class="hl-value">"toSplitter"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>The payload of the message sent to the <code class="literal">toSplitter</code> channel is a list of <code class="literal">String</code> objects that each contain the name of a file.
If the <code class="literal">command-options</code> attribute was omitted, it holds <code class="literal">FileInfo</code> objects.
It uses space-delimited options&#8201;&#8212;&#8201;for example, <code class="literal">command-options="-1 -dirs -links"</code>.</p>
<p>Starting with version 4.2, the <code class="literal">GET</code>, <code class="literal">MGET</code>, <code class="literal">PUT</code> and <code class="literal">MPUT</code> commands support a <code class="literal">FileExistsMode</code> property (<code class="literal">mode</code>
when using the namespace support). This affects the behavior when the local file exists (<code class="literal">GET</code> and <code class="literal">MGET</code>) or the remote
file exists (<code class="literal">PUT</code> and <code class="literal">MPUT</code>). Supported modes are <code class="literal">REPLACE</code>, <code class="literal">APPEND</code>, <code class="literal">FAIL</code>, and <code class="literal">IGNORE</code>.
For backwards compatibility, the default mode for <code class="literal">PUT</code> and <code class="literal">MPUT</code> operations is <code class="literal">REPLACE</code>. For <code class="literal">GET</code> and <code class="literal">MGET</code>
operations, the default is <code class="literal">FAIL</code>.</p>
<p>Starting with version 5.0, the <code class="literal">setWorkingDirExpression()</code> (<code class="literal">working-dir-expression</code> in XML) option is provided on the <code class="literal">FtpOutboundGateway</code> (<code class="literal">&lt;int-ftp:outbound-gateway&gt;</code> in XML).
It lets you change the client working directory at runtime.
The expression is evaluated against the request message.
The previous working directory is restored after each gateway operation.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_with_java_configuration_12" href="#_configuring_with_java_configuration_12"></a>18.9.9&nbsp;Configuring with Java Configuration</h3></div></div></div>

<p>The following Spring Boot application shows an example of how to configure the outbound gateway with Java configuration:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@SpringBootApplication</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> FtpJavaApplication {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
        <span class="hl-keyword">new</span> SpringApplicationBuilder(FtpJavaApplication.<span class="hl-keyword">class</span>)
            .web(false)
            .run(args);
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> SessionFactory&lt;FTPFile&gt; ftpSessionFactory() {
        DefaultFtpSessionFactory sf = <span class="hl-keyword">new</span> DefaultFtpSessionFactory();
        sf.setHost(<span class="hl-string">"localhost"</span>);
        sf.setPort(port);
        sf.setUsername(<span class="hl-string">"foo"</span>);
        sf.setPassword(<span class="hl-string">"foo"</span>);
        sf.setTestSession(true);
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> CachingSessionFactory&lt;FTPFile&gt;(sf);
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "ftpChannel")</span></em>
    <span class="hl-keyword">public</span> MessageHandler handler() {
        FtpOutboundGateway ftpOutboundGateway =
                          <span class="hl-keyword">new</span> FtpOutboundGateway(ftpSessionFactory(), <span class="hl-string">"ls"</span>, <span class="hl-string">"'my_remote_dir/'"</span>);
        ftpOutboundGateway.setOutputChannelName(<span class="hl-string">"lsReplyChannel"</span>);
        <span class="hl-keyword">return</span> ftpOutboundGateway;
    }

}</pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_with_the_java_dsl_13" href="#_configuring_with_the_java_dsl_13"></a>18.9.10&nbsp;Configuring with the Java DSL</h3></div></div></div>

<p>The following Spring Boot application shows an example of how to configure the outbound gateway with the Java DSL:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@SpringBootApplication</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> FtpJavaApplication {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
        <span class="hl-keyword">new</span> SpringApplicationBuilder(FtpJavaApplication.<span class="hl-keyword">class</span>)
            .web(false)
            .run(args);
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> SessionFactory&lt;FTPFile&gt; ftpSessionFactory() {
        DefaultFtpSessionFactory sf = <span class="hl-keyword">new</span> DefaultFtpSessionFactory();
        sf.setHost(<span class="hl-string">"localhost"</span>);
        sf.setPort(port);
        sf.setUsername(<span class="hl-string">"foo"</span>);
        sf.setPassword(<span class="hl-string">"foo"</span>);
        sf.setTestSession(true);
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> CachingSessionFactory&lt;FTPFile&gt;(sf);
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> FtpOutboundGatewaySpec ftpOutboundGateway() {
        <span class="hl-keyword">return</span> Ftp.outboundGateway(ftpSessionFactory(),
            AbstractRemoteFileOutboundGateway.Command.MGET, <span class="hl-string">"payload"</span>)
            .options(AbstractRemoteFileOutboundGateway.Option.RECURSIVE)
            .regexFileNameFilter(<span class="hl-string">"(subFtpSource|.*1.txt)"</span>)
            .localDirectoryExpression(<span class="hl-string">"'localDirectory/' + #remoteDirectory"</span>)
            .localFilenameExpression(<span class="hl-string">"#remoteFileName.replaceFirst('ftpSource', 'localTarget')"</span>);
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> IntegrationFlow ftpMGetFlow(AbstractRemoteFileOutboundGateway&lt;FTPFile&gt; ftpOutboundGateway) {
        <span class="hl-keyword">return</span> f -&gt; f
            .handle(ftpOutboundGateway)
            .channel(c -&gt; c.queue(<span class="hl-string">"remoteFileOutputChannel"</span>));
    }

}</pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="ftp-partial" href="#ftp-partial"></a>18.9.11&nbsp;Outbound Gateway Partial Success (<code class="literal">mget</code> and <code class="literal">mput</code>)</h3></div></div></div>

<p>When you perform operations on multiple files (by using <code class="literal">mget</code> and <code class="literal">mput</code>), an exception can occur some time after one or more files have been transferred.
In this case (starting with version 4.2), a <code class="literal">PartialSuccessException</code> is thrown.
As well as the usual <code class="literal">MessagingException</code> properties (<code class="literal">failedMessage</code> and <code class="literal">cause</code>), this exception has two additional
properties:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">partialResults</code>: The successful transfer results.
</li><li class="listitem">
<code class="literal">derivedInput</code>: The list of files generated from the request message (for example, local files to transfer for an <code class="literal">mput</code>).
</li></ul></div>
<p>These attributes let you determine which files were successfully transferred and which were not.</p>
<p>In the case of a recursive <code class="literal">mput</code>, the <code class="literal">PartialSuccessException</code> may have nested <code class="literal">PartialSuccessException</code> occurrences.</p>
<p>Consider the following directory structure:</p>
<div class="informalexample">
<pre class="screen">root/
|- file1.txt
|- subdir/
   | - file2.txt
   | - file3.txt
|- zoo.txt</pre>
</div>
<p>If the exception occurs on <code class="literal">file3.txt</code>, the <code class="literal">PartialSuccessException</code> thrown by the gateway has <code class="literal">derivedInput</code>
of <code class="literal">file1.txt</code>, <code class="literal">subdir</code>, and <code class="literal">zoo.txt</code> and <code class="literal">partialResults</code> of <code class="literal">file1.txt</code>.
Its <code class="literal">cause</code> is another <code class="literal">PartialSuccessException</code> with <code class="literal">derivedInput</code> of <code class="literal">file2.txt</code> and <code class="literal">file3.txt</code> and
<code class="literal">partialResults</code> of <code class="literal">file2.txt</code>.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="ftp-session-caching" href="#ftp-session-caching"></a>18.10&nbsp;FTP Session Caching</h2></div></div></div>

<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Starting with Spring Integration 3.0, sessions are no longer cached by default.
The <code class="literal">cache-sessions</code> attribute is no longer supported on endpoints.
You must use a <code class="literal">CachingSessionFactory</code> (shown in the next example) if you wish to cache sessions.</p>
</td></tr></table></div>
<p>In versions prior to 3.0, the sessions were automatically cached by default.
A <code class="literal">cache-sessions</code> attribute was available for disabling the auto caching, but that solution did not provide a way to configure other session caching attributes.
For example, you could not limit the number of sessions created.
To support that requirement and other configuration options, a <code class="literal">CachingSessionFactory</code> was added.
It provides <code class="literal">sessionCacheSize</code> and <code class="literal">sessionWaitTimeout</code> properties.
The <code class="literal">sessionCacheSize</code> property controls how many active sessions the factory maintains in its cache (the default is unbounded).
If the <code class="literal">sessionCacheSize</code> threshold has been reached, any attempt to acquire another session blocks until either one of the cached sessions becomes available or until the wait time for a session expires (the default wait time is <code class="literal">Integer.MAX_VALUE</code>).
The <code class="literal">sessionWaitTimeout</code> property configures that value.</p>
<p>If you want your sessions to be cached, configure your default session factory as described earlier and then wrap it in an instance of <code class="literal">CachingSessionFactory</code>, where you can provide those additional properties.
The following example shows how to do so:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"ftpSessionFactory"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.ftp.session.DefaultFtpSessionFactory"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"host"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"localhost"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"cachingSessionFactory"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.file.remote.session.CachingSessionFactory"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"ftpSessionFactory"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"10"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"sessionWaitTimeout"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"1000"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
</div>
<p>The preceding example shows a <code class="literal">CachingSessionFactory</code> created with the <code class="literal">sessionCacheSize</code> set to <code class="literal">10</code> and the
<code class="literal">sessionWaitTimeout</code> set to one second (its value is in milliseconds).</p>
<p>Starting with Spring Integration 3.0, the <code class="literal">CachingConnectionFactory</code> provides a <code class="literal">resetCache()</code> method.
When invoked, all idle sessions are immediately closed and in-use sessions are closed when they are returned to the cache.
New requests for sessions establish new sessions as necessary.</p>
<p>Starting with version 5.1, the <code class="literal">CachingSessionFactory</code> has a new property <code class="literal">testSession</code>.
When true, the session will be tested by sending a NOOP command to ensure it is still active; if not, it will be removed from the cache; a new session is created if no active sessions are in the cache.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="ftp-rft" href="#ftp-rft"></a>18.11&nbsp;Using <code class="literal">RemoteFileTemplate</code></h2></div></div></div>

<p>Starting with Spring Integration 3.0, a new abstraction is provided over the <code class="literal">FtpSession</code> object.
The template provides methods to send, retrieve (as an <code class="literal">InputStream</code>), remove, and rename files.
In addition an <code class="literal">execute</code> method is provided allowing the caller to execute multiple operations on the session.
In all cases, the template takes care of reliably closing the session.
For more information, see the
<a class="ulink" href="http://docs.spring.io/spring-integration/api/org/springframework/integration/file/remote/RemoteFileTemplate.html" target="_top">Javadoc for <code class="literal">RemoteFileTemplate</code></a>.
There is a subclass for FTP: <code class="literal">FtpRemoteFileTemplate</code>.</p>
<p>Version 4.1 added added additional methods, including <code class="literal">getClientInstance()</code>, which provides access to the underlying <code class="literal">FTPClient</code> and thus gives you access to low-level APIs.</p>
<p>Not all FTP servers properly implement the <code class="literal">STAT &lt;path&gt;</code> command.
Some return a positive result for a non-existent path.
The <code class="literal">NLST</code> command reliably returns the name when the path is a file and it exists.
However, this does not support checking that an empty directory exists since <code class="literal">NLST</code> always returns an empty list when the path is a directory.
Since the template does not know whether the path represents a directory, it has to perform additional checks when the path does not appear to exist (when using <code class="literal">NLST</code>).
This adds overhead, requiring several requests to the server.
Starting with version 4.1.9, the <code class="literal">FtpRemoteFileTemplate</code> provides the <code class="literal">FtpRemoteFileTemplate.ExistsMode</code> property, which has the following options:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">STAT</code>: Perform the <code class="literal">STAT</code> FTP command (<code class="literal">FTPClient.getStatus(path)</code>) to check the path existence.
This is the default and requires that your FTP server properly support the <code class="literal">STAT</code> command (with a path).
</li><li class="listitem">
<code class="literal">NLST</code>: Perform the <code class="literal">NLST</code> FTP command&#8201;&#8212;&#8201;<code class="literal">FTPClient.listName(path)</code>.
Use this if you are testing for a path that is a full path to a file.
It does not work for empty directories.
</li><li class="listitem">
<code class="literal">NLST_AND_DIRS</code>:  Perform the <code class="literal">NLST</code> command first and, if it returns no files, fall back to a technique that temporarily switches the working directory by using <code class="literal">FTPClient.changeWorkingDirectory(path)</code>.
See <a class="ulink" href="https://docs.spring.io/spring-integration/api/org/springframework/integration/ftp/session/FtpSession.html#exists" target="_top"><code class="literal">FtpSession.exists()</code></a> for more information.
</li></ul></div>
<p>Since we know that the <code class="literal">FileExistsMode.FAIL</code> case is always only looking for a file (and not a directory), we safely use <code class="literal">NLST</code> mode for the <code class="literal">FtpMessageHandler</code> and <code class="literal">FtpOutboundGateway</code> components.</p>
<p>For any other cases, the <code class="literal">FtpRemoteFileTemplate</code> can be extended to implement custom logic in the overridden <code class="literal">exist()</code> method.</p>
<p>Starting with version 5.0, the new <code class="literal">RemoteFileOperations.invoke(OperationsCallback&lt;F, T&gt; action)</code> method is available.
This method lets several <code class="literal">RemoteFileOperations</code> calls be called in the scope of the same, thread-bounded, <code class="literal">Session</code>.
This is useful when you need to perform several high-level operations of the <code class="literal">RemoteFileTemplate</code> as one unit of work.
For example, <code class="literal">AbstractRemoteFileOutboundGateway</code> uses it with the <code class="literal">mput</code> command implementation, where we perform a <code class="literal">put</code> operation for each file in the provided directory and recursively for its sub-directories.
See the <a class="ulink" href="https://docs.spring.io/spring-integration/api/org/springframework/integration/file/remote/RemoteFileOperations.html#invoke" target="_top">Javadoc</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="ftp-session-callback" href="#ftp-session-callback"></a>18.12&nbsp;Using <code class="literal">MessageSessionCallback</code></h2></div></div></div>

<p>Starting with Spring Integration 4.2, you can use a <code class="literal">MessageSessionCallback&lt;F, T&gt;</code> implementation with the
<code class="literal">&lt;int-ftp:outbound-gateway/&gt;</code> (<code class="literal">FtpOutboundGateway</code> in Java) to perform any operations on the <code class="literal">Session&lt;FTPFile&gt;</code> with
the <code class="literal">requestMessage</code> context.
It can be used for any non-standard or low-level FTP operations and allows access from an integration flow definition and functional interface (Lambda) implementation injection, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "ftpChannel")</span></em>
<span class="hl-keyword">public</span> MessageHandler ftpOutboundGateway(SessionFactory&lt;FTPFile&gt; sessionFactory) {
    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> FtpOutboundGateway(sessionFactory,
         (session, requestMessage) -&gt; session.list(requestMessage.getPayload()));
}</pre>
</div>
<p>Another example might be to pre- or post-process the file data being sent or retrieved.</p>
<p>When using XML configuration, the <code class="literal">&lt;int-ftp:outbound-gateway/&gt;</code> provides a <code class="literal">session-callback</code> attribute to let you specify the <code class="literal">MessageSessionCallback</code> bean name.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The <code class="literal">session-callback</code> is mutually exclusive with the <code class="literal">command</code> and <code class="literal">expression</code> attributes.
When configuring with Java, different constructors are available in the <a class="ulink" href="https://docs.spring.io/spring-integration/api/org/springframework/integration/ftp/gateway/FtpOutboundGateway.html" target="_top"><code class="literal">FtpOutboundGateway</code></a> class.</p>
</td></tr></table></div>
</div>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="gemfire" href="#gemfire"></a>19.&nbsp;Pivotal GemFire and Apache Geode Support</h2></div></div></div>

<p>Spring Integration provides support for Pivotal GemFire and Apache Geode.</p>
<p>You need to include this dependency into your project:</p>
<div class="informalexample">
<p>
<b>Maven.&nbsp;</b>

</p><pre class="programlisting"><span class="hl-tag">&lt;dependency&gt;</span>
    <span class="hl-tag">&lt;groupId&gt;</span>org.springframework.integration<span class="hl-tag">&lt;/groupId&gt;</span>
    <span class="hl-tag">&lt;artifactId&gt;</span>spring-integration-gemfire<span class="hl-tag">&lt;/artifactId&gt;</span>
    <span class="hl-tag">&lt;version&gt;</span>5.1.2.RELEASE<span class="hl-tag">&lt;/version&gt;</span>
<span class="hl-tag">&lt;/dependency&gt;</span></pre><p>

</p>
<p>
<b>Gradle.&nbsp;</b>

</p><pre class="programlisting">compile <span class="hl-string">"org.springframework.integration:spring-integration-gemfire:5.1.2.RELEASE"</span></pre><p>

</p>
</div>
<p>GemFire is a distributed data management platform that provides a key-value data grid along with advanced distributed system features, such as event processing, continuous querying, and remote function execution.
This guide assumes some familiarity with the commercial <a class="ulink" href="https://pivotal.io/pivotal-gemfire" target="_top">Pivotal GemFire</a> or Open Source <a class="ulink" href="http://geode.apache.org" target="_top">Apache Geode</a>.</p>
<p>Spring integration provides support for GemFire by implementing inbound adapters for entry and continuous query events, an outbound adapter to write entries to the cache, and message and metadata stores and <code class="literal">GemfireLockRegistry</code> implementations.
Spring integration leverages the <a class="ulink" href="http://projects.spring.io/spring-data-gemfire" target="_top">Spring Data for Pivotal GemFire</a> project, providing a thin wrapper over its components.</p>
<p>Starting with version 5.1, the Spring Integration GemFire module uses the <a class="ulink" href="https://github.com/spring-projects/spring-data-geode" target="_top">Spring Data for Apache Geode</a> transitive dependency by default.
To switch to the commercial Pivotal GemFire-based Spring Data for Pivotal GemFire, exclude <code class="literal">spring-data-geode</code> from dependencies and add <code class="literal">spring-data-gemfire</code>, as the following Maven snippet shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;dependency&gt;</span>
    <span class="hl-tag">&lt;groupId&gt;</span>org.springframework.integration<span class="hl-tag">&lt;/groupId&gt;</span>
    <span class="hl-tag">&lt;artifactId&gt;</span>spring-integration-gemfire<span class="hl-tag">&lt;/artifactId&gt;</span>
    <span class="hl-tag">&lt;exclusions&gt;</span>
        <span class="hl-tag">&lt;exclusion&gt;</span>
            <span class="hl-tag">&lt;groupId&gt;</span>org.springframework.data<span class="hl-tag">&lt;/groupId&gt;</span>
            <span class="hl-tag">&lt;artifactId&gt;</span>spring-data-geode<span class="hl-tag">&lt;/artifactId&gt;</span>
        <span class="hl-tag">&lt;/exclusion&gt;</span>
    <span class="hl-tag">&lt;/exclusions&gt;</span>
<span class="hl-tag">&lt;/dependency&gt;</span>

<span class="hl-tag">&lt;dependency&gt;</span>
    <span class="hl-tag">&lt;groupId&gt;</span>org.springframework.data<span class="hl-tag">&lt;/groupId&gt;</span>
    <span class="hl-tag">&lt;artifactId&gt;</span>spring-data-gemfire<span class="hl-tag">&lt;/artifactId&gt;</span>
<span class="hl-tag">&lt;/dependency&gt;</span></pre>
</div>
<p>To configure the <span class="emphasis"><em>int-gfe</em></span> namespace, include the following elements within the headers of your XML configuration file:</p>
<div class="informalexample">
<pre class="programlisting">xmlns:int-gfe="http://www.springframework.org/schema/integration/gemfire"
xsi:schemaLocation="http://www.springframework.org/schema/integration/gemfire
	http://www.springframework.org/schema/integration/gemfire/spring-integration-gemfire.xsd"</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="gemfire-inbound" href="#gemfire-inbound"></a>19.1&nbsp;Inbound Channel Adapter</h2></div></div></div>

<p>The inbound channel adapter produces messages on a channel when triggered by a GemFire <code class="literal">EntryEvent</code>.
GemFire generates events whenever an entry is <code class="literal">CREATED</code>, <code class="literal">UPDATED</code>, <code class="literal">DESTROYED</code>, or <code class="literal">INVALIDATED</code> in the associated region.
The inbound channel adapter lets you filter on a subset of these events.
For example, you may want to produce messages only in response to an entry being created.
In addition, the inbound channel adapter can evaluate a SpEL expression if, for example, you want your message payload to contain an event property such as the new entry value.
The following example shows how to configure an inbound channel adapter with a SpEL language (in the <code class="literal">expression</code> attribute):</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;gfe:cache/&gt;</span>
<span class="hl-tag">&lt;gfe:replicated-region</span> <span class="hl-attribute">id</span>=<span class="hl-value">"region"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;int-gfe:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"inputChannel"</span> <span class="hl-attribute">region</span>=<span class="hl-value">"region"</span>
    <span class="hl-attribute">cache-events</span>=<span class="hl-value">"CREATED"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"newValue"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>The preceding configuration creates a GemFire <code class="literal">Cache</code> and <code class="literal">Region</code> by using Spring GemFire&#8217;s <span class="emphasis"><em>gfe</em></span> namespace.
The <code class="literal">inbound-channel-adapter</code> element requires a reference to the GemFire region on which the adapter listens for events.
Optional attributes include <code class="literal">cache-events</code>, which can contain a comma-separated list of event types for which a message is produced on the input channel.
By default, <code class="literal">CREATED</code> and <code class="literal">UPDATED</code> are enabled.
If no <code class="literal">channel</code> attribute is provided, the channel is created from the <code class="literal">id</code> attribute.
This adapter also supports an <code class="literal">error-channel</code>.
The GemFire <a class="ulink" href="https://geode.apache.org/releases/latest/javadoc/org/apache/geode/cache/EntryEvent.html" target="_top"><code class="literal">EntryEvent</code></a> is the <code class="literal">#root</code> object of the <code class="literal">expression</code> evaluation.
The following example shows an expression that replaces a value for a key:</p>
<div class="informalexample">
<pre class="screen">expression="new something.MyEvent(key, oldValue, newValue)"</pre>
</div>
<p>If the <code class="literal">expression</code> attribute is not provided, the message payload is the GemFire <code class="literal">EntryEvent</code> itself.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>This adapter conforms to Spring Integration conventions.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="gemfire-cq" href="#gemfire-cq"></a>19.2&nbsp;Continuous Query Inbound Channel Adapter</h2></div></div></div>

<p>The continuous query inbound channel adapter produces messages on a channel when triggered by a GemFire continuous query or <code class="literal">CqEvent</code> event.
In release <code class="literal">1.1</code>, Spring Data introduced continuous query support, including <code class="literal">ContinuousQueryListenerContainer</code>, which provides a nice abstraction over the GemFire native API.
This adapter requires a reference to a <code class="literal">ContinuousQueryListenerContainer</code> instance, creates a listener for a given <code class="literal">query</code>, and executes the query.
The continuous query acts as an event source that fires whenever its result set changes state.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>GemFire queries are written in OQL and are scoped to the entire cache (not just one region).
Additionally, continuous queries require a remote (that is, running in a separate process or remote host) cache server.
See the <a class="ulink" href="http://gemfire82.docs.pivotal.io/docs-gemfire/gemfire_nativeclient/continuous-querying/continuous-querying.html" target="_top">GemFire documentation</a> for more information on implementing continuous queries.</p>
</td></tr></table></div>
<p>The following configuration creates a GemFire client cache (recall that a remote cache server is required for this implementation and its address is configured as a child element of the pool), a client region, and a <code class="literal">ContinuousQueryListenerContainer</code> that uses Spring Data:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;gfe:client-cache</span> <span class="hl-attribute">id</span>=<span class="hl-value">"client-cache"</span> <span class="hl-attribute">pool-name</span>=<span class="hl-value">"client-pool"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;gfe:pool</span> <span class="hl-attribute">id</span>=<span class="hl-value">"client-pool"</span> <span class="hl-attribute">subscription-enabled</span>=<span class="hl-value">"true"</span><span class="hl-tag"> &gt;</span>
    <span class="hl-comment">&lt;!--configure server or locator here required to address the cache server --&gt;</span>
<span class="hl-tag">&lt;/gfe:pool&gt;</span>

<span class="hl-tag">&lt;gfe:client-region</span> <span class="hl-attribute">id</span>=<span class="hl-value">"test"</span> <span class="hl-attribute">cache-ref</span>=<span class="hl-value">"client-cache"</span> <span class="hl-attribute">pool-name</span>=<span class="hl-value">"client-pool"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;gfe:cq-listener-container</span> <span class="hl-attribute">id</span>=<span class="hl-value">"queryListenerContainer"</span> <span class="hl-attribute">cache</span>=<span class="hl-value">"client-cache"</span>
    <span class="hl-attribute">pool-name</span>=<span class="hl-value">"client-pool"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int-gfe:cq-inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"inputChannel"</span>
    <span class="hl-attribute">cq-listener-container</span>=<span class="hl-value">"queryListenerContainer"</span>
    <span class="hl-attribute">query</span>=<span class="hl-value">"select * from /test"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>The continuous query inbound channel adapter requires a <code class="literal">cq-listener-container</code> attribute, which must contain a reference to the <code class="literal">ContinuousQueryListenerContainer</code>.
Optionally, it accepts an <code class="literal">expression</code> attribute that uses SpEL to transform the <code class="literal">CqEvent</code> or extract an individual property as needed.
The <code class="literal">cq-inbound-channel-adapter</code> provides a <code class="literal">query-events</code> attribute that contains a comma-separated list of event types for which a message is produced on the input channel.
The available event types are <code class="literal">CREATED</code>, <code class="literal">UPDATED</code>, <code class="literal">DESTROYED</code>, <code class="literal">REGION_DESTROYED</code>, and <code class="literal">REGION_INVALIDATED</code>.
By default, <code class="literal">CREATED</code> and <code class="literal">UPDATED</code> are enabled.
Additional optional attributes include <code class="literal">query-name</code> (which provides an optional query name), <code class="literal">expression</code> (which works as described in the preceding section), and <code class="literal">durable</code> (a boolean value indicating if the query is durable&#8201;&#8212;&#8201;it is false by default).
If you do not provide a <code class="literal">channel</code>, the channel is created from the <code class="literal">id</code> attribute.
This adapter also supports an <code class="literal">error-channel</code>.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>This adapter conforms to Spring Integration conventions.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="gemfire-outbound" href="#gemfire-outbound"></a>19.3&nbsp;Outbound Channel Adapter</h2></div></div></div>

<p>The outbound channel adapter writes cache entries that are mapped from the message payload.
In its simplest form, it expects a payload of type <code class="literal">java.util.Map</code> and puts the map entries into its configured region.
The following example shows how to configure an outbound channel adapter:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-gfe:outbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"cacheChannel"</span> <span class="hl-attribute">region</span>=<span class="hl-value">"region"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>Given the preceding configuration, an exception is thrown if the payload is not a <code class="literal">Map</code>.
Additionally, you can configure the outbound channel adapter to create a map of cache entries by using SpEL.
The following example shows how to do so:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-gfe:outbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"cacheChannel"</span> <span class="hl-attribute">region</span>=<span class="hl-value">"region"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int-gfe:cache-entries&gt;</span>
        <span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"payload.toUpperCase()"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"payload.toLowerCase()"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"'thing1'"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"'thing2'"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/int-gfe:cache-entries&gt;</span>
<span class="hl-tag">&lt;/int-gfe:outbound-channel-adapter&gt;</span></pre>
</div>
<p>In the preceding configuration, the inner element (<code class="literal">cache-entries</code>) is semantically equivalent to a Spring <span class="emphasis"><em>map</em></span> element.
The adapter interprets the <code class="literal">key</code> and <code class="literal">value</code> attributes as SpEL expressions with the message as the evaluation context.
Note that this can contain arbitrary cache entries (not only those derived from the message) and that literal values must be enclosed in single quotes.
In the preceding example, if the message sent to <code class="literal">cacheChannel</code> has a <code class="literal">String</code> payload with a value <code class="literal">Hello</code>, two entries (<code class="literal">[HELLO:hello, thing1:thing2]</code>) are written (either created or updated) in the cache region.
This adapter also supports the <code class="literal">order</code> attribute, which may be useful if it is bound to a <code class="literal">PublishSubscribeChannel</code>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="gemfire-message-store" href="#gemfire-message-store"></a>19.4&nbsp;Gemfire Message Store</h2></div></div></div>

<p>As described in EIP, a <a class="ulink" href="http://www.eaipatterns.com/MessageStore.html" target="_top">message store</a> lets you persist messages.
This can be useful when dealing with components that have a capability to buffer messages (<code class="literal">QueueChannel</code>, <code class="literal">Aggregator</code>, <code class="literal">Resequencer</code>, and others) if reliability is a concern.
In Spring Integration, the <code class="literal">MessageStore</code> strategy interface also provides the foundation for the <a class="ulink" href="http://www.eaipatterns.com/StoreInLibrary.html" target="_top">claim check</a> pattern, which is described in EIP as well.</p>
<p>Spring Integration&#8217;s Gemfire module provides <code class="literal">GemfireMessageStore</code>, which is an implementation of both the the <code class="literal">MessageStore</code> strategy (mainly used by the <code class="literal">QueueChannel</code> and <code class="literal">ClaimCheck</code> patterns) and the <code class="literal">MessageGroupStore</code> strategy (mainly used by the <code class="literal">Aggregator</code> and <code class="literal">Resequencer</code> patterns).</p>
<p>The following example configures the cache and region by using the <code class="literal">spring-gemfire</code> namespace (not to be confused with the <code class="literal">spring-integration-gemfire</code> namespace):</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"gemfireMessageStore"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.gemfire.store.GemfireMessageStore"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"myRegion"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;gfe:cache/&gt;</span>

<span class="hl-tag">&lt;gfe:replicated-region</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myRegion"</span><span class="hl-tag">/&gt;</span>


<span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"somePersistentQueueChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:queue</span> <span class="hl-attribute">message-store</span>=<span class="hl-value">"gemfireMessageStore"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;int:channel&gt;</span>

<span class="hl-tag">&lt;int:aggregator</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"inputChannel"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"outputChannel"</span>
    <span class="hl-attribute">message-store</span>=<span class="hl-value">"gemfireMessageStore"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>Often, it is desirable for the message store to be maintained in one or more remote cache servers in a client-server configuration.
In this case, you should configure a client cache, a client region, and a client pool and inject the region into the <code class="literal">MessageStore</code>.
The following example shows how to do so:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"gemfireMessageStore"</span>
    <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.gemfire.store.GemfireMessageStore"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"myRegion"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;gfe:client-cache/&gt;</span>

<span class="hl-tag">&lt;gfe:client-region</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myRegion"</span> <span class="hl-attribute">shortcut</span>=<span class="hl-value">"PROXY"</span> <span class="hl-attribute">pool-name</span>=<span class="hl-value">"messageStorePool"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;gfe:pool</span> <span class="hl-attribute">id</span>=<span class="hl-value">"messageStorePool"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;gfe:server</span> <span class="hl-attribute">host</span>=<span class="hl-value">"localhost"</span> <span class="hl-attribute">port</span>=<span class="hl-value">"40404"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/gfe:pool&gt;</span></pre>
</div>
<p>Note that the <code class="literal">pool</code> element is configured with the address of a cache server (you can substitute a locator here).
The region is configured as a <span class="emphasis"><em>PROXY</em></span> so that no data is stored locally.
The region&#8217;s <code class="literal">id</code> corresponds to a region with the same name in the cache server.</p>
<p>Starting with version 4.3.12, the <code class="literal">GemfireMessageStore</code> supports the key <code class="literal">prefix</code> option to allow distinguishing between instances of the store on the same GemFire region.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="gemfire-lock-registry" href="#gemfire-lock-registry"></a>19.5&nbsp;Gemfire Lock Registry</h2></div></div></div>

<p>Starting with version 4.0, the <code class="literal">GemfireLockRegistry</code> is available.
Certain components (for example, the aggregator and the resequencer) use a lock obtained from a <code class="literal">LockRegistry</code> instance to ensure that only one thread is manipulating a group at any given time.
The <code class="literal">DefaultLockRegistry</code> performs this function within a single component.
You can now configure an external lock registry on these components.
When you use a shared <code class="literal">MessageGroupStore</code> with the <code class="literal">GemfireLockRegistry</code>, it can provide this functionality across multiple application instances, such that only one instance can manipulate the group at a time.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>One of the <code class="literal">GemfireLockRegistry</code> constructors requires a <code class="literal">Region</code> as an argument.
It is used to obtain a <code class="literal">Lock</code> from the <code class="literal">getDistributedLock()</code> method.
This operation requires <code class="literal">GLOBAL</code> scope for the <code class="literal">Region</code>.
Another constructor requires a <code class="literal">Cache</code>, and the <code class="literal">Region</code> is created with <code class="literal">GLOBAL</code> scope and with the name, <code class="literal">LockRegistry</code>.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="gemfire-metadata-store" href="#gemfire-metadata-store"></a>19.6&nbsp;Gemfire Metadata Store</h2></div></div></div>

<p>Version 4.0 introduced a new Gemfire-based <code class="literal">MetadataStore</code> (<a class="xref" href="#metadata-store" title="12.5&nbsp;Metadata Store">Section&nbsp;12.5, &#8220;Metadata Store&#8221;</a>) implementation.
You can use the <code class="literal">GemfireMetadataStore</code> to maintain metadata state across application restarts.
This new <code class="literal">MetadataStore</code> implementation can be used with adapters such as:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="xref" href="#feed-inbound-channel-adapter" title="16.1&nbsp;Feed Inbound Channel Adapter">Section&nbsp;16.1, &#8220;Feed Inbound Channel Adapter&#8221;</a>
</li><li class="listitem">
<a class="xref" href="#file-reading" title="17.1&nbsp;Reading Files">Section&nbsp;17.1, &#8220;Reading Files&#8221;</a>
</li><li class="listitem">
<a class="xref" href="#ftp-inbound" title="18.4&nbsp;FTP Inbound Channel Adapter">Section&nbsp;18.4, &#8220;FTP Inbound Channel Adapter&#8221;</a>
</li><li class="listitem">
<a class="xref" href="#sftp-inbound" title="30.6&nbsp;SFTP Inbound Channel Adapter">Section&nbsp;30.6, &#8220;SFTP Inbound Channel Adapter&#8221;</a>
</li></ul></div>
<p>To get these adapters to use the new <code class="literal">GemfireMetadataStore</code>, declare a Spring bean with a bean name of <code class="literal">metadataStore</code>.
The feed inbound channel adapter automatically picks up and use the declared <code class="literal">GemfireMetadataStore</code>.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The <code class="literal">GemfireMetadataStore</code> also implements <code class="literal">ConcurrentMetadataStore</code>, letting it be reliably shared across multiple application instances, where only one instance can store or modify a key&#8217;s value.
These methods give various levels of concurrency guarantees based on the scope and data policy of the region.
They are implemented in the peer cache and client-server cache but are disallowed in peer regions that have <code class="literal">NORMAL</code> or <code class="literal">EMPTY</code> data policies.</p>
</td></tr></table></div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Since version 5.0, the <code class="literal">GemfireMetadataStore</code> also implements <code class="literal">ListenableMetadataStore</code>, which lets you listen to cache events by providing <code class="literal">MetadataStoreListener</code> instances to the store, as the following example shows:</p>
</td></tr></table></div>
<div class="informalexample">
<pre class="programlisting">GemfireMetadataStore metadataStore = <span class="hl-keyword">new</span> GemfireMetadataStore(cache);
metadataStore.addListener(<span class="hl-keyword">new</span> MetadataStoreListenerAdapter() {

    <em><span class="hl-annotation" style="color: gray">@Override</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> onAdd(String key, String value) {
         ...
    }

});</pre>
</div>
</div>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="http" href="#http"></a>20.&nbsp;HTTP Support</h2></div></div></div>

<p>Spring Integration&#8217;s HTTP support allows for the running of HTTP requests and the processing of inbound HTTP requests.
The HTTP support consists of the following gateway implementations: <code class="literal">HttpInboundEndpoint</code> and <code class="literal">HttpRequestExecutingMessageHandler</code>.
See also <a class="xref" href="#webflux" title="35.&nbsp;WebFlux Support">Chapter&nbsp;35, <i>WebFlux Support</i></a>.</p>
<p>You need to include this dependency into your project:</p>
<div class="informalexample">
<p>
<b>Maven.&nbsp;</b>

</p><pre class="programlisting"><span class="hl-tag">&lt;dependency&gt;</span>
    <span class="hl-tag">&lt;groupId&gt;</span>org.springframework.integration<span class="hl-tag">&lt;/groupId&gt;</span>
    <span class="hl-tag">&lt;artifactId&gt;</span>spring-integration-http<span class="hl-tag">&lt;/artifactId&gt;</span>
    <span class="hl-tag">&lt;version&gt;</span>5.1.2.RELEASE<span class="hl-tag">&lt;/version&gt;</span>
<span class="hl-tag">&lt;/dependency&gt;</span></pre><p>

</p>
<p>
<b>Gradle.&nbsp;</b>

</p><pre class="programlisting">compile <span class="hl-string">"org.springframework.integration:spring-integration-http:5.1.2.RELEASE"</span></pre><p>

</p>
</div>
<p>The <code class="literal">javax.servlet:javax.servlet-api</code> dependency must be provided on the target Servlet container.</p>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="http-inbound" href="#http-inbound"></a>20.1&nbsp;Http Inbound Components</h2></div></div></div>

<p>To receive messages over HTTP, you need to use an HTTP inbound channel adapter or an HTTP inbound gateway.
To support the HTTP inbound adapters, they need to be deployed within a servlet container such as <a class="ulink" href="http://tomcat.apache.org/" target="_top">Apache Tomcat</a> or <a class="ulink" href="http://www.eclipse.org/jetty/" target="_top">Jetty</a>.
The easiest way to do this is to use Spring&#8217;s
<a class="ulink" href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/web/context/support/HttpRequestHandlerServlet.html" target="_top"><code class="literal">HttpRequestHandlerServlet</code></a>, by providing the following servlet definition in the <code class="literal">web.xml</code> file:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;servlet&gt;</span>
    <span class="hl-tag">&lt;servlet-name&gt;</span>inboundGateway<span class="hl-tag">&lt;/servlet-name&gt;</span>
    <span class="hl-tag">&lt;servlet-class&gt;</span>o.s.web.context.support.HttpRequestHandlerServlet<span class="hl-tag">&lt;/servlet-class&gt;</span>
<span class="hl-tag">&lt;/servlet&gt;</span></pre>
</div>
<p>Notice that the servlet name matches the bean name.
For more information on using the <code class="literal">HttpRequestHandlerServlet</code>, see
<a class="ulink" href="http://docs.spring.io/spring/docs/current/spring-framework-reference/html/remoting.html" target="_top">Remoting and web services using Spring</a>,
which is part of the Spring Framework Reference documentation.</p>
<p>If you are running within a Spring MVC application, then the aforementioned explicit servlet definition is not necessary.
In that case, the bean name for your gateway can be matched against the URL path as you would for a Spring MVC Controller bean.
For more information, see
<a class="ulink" href="http://docs.spring.io/spring/docs/current/spring-framework-reference/html/mvc.html" target="_top">Web MVC framework</a>, which is part of the Spring Framework Reference documentation.</p>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>For a sample application and the corresponding configuration, see the <a class="ulink" href="https://github.com/spring-projects/spring-integration-samples" target="_top">Spring Integration Samples</a> repository.
It contains the <a class="ulink" href="https://github.com/spring-projects/spring-integration-samples/tree/master/basic/http" target="_top">HTTP sample</a> application, which demonstrates Spring Integration&#8217;s HTTP support.</p>
</td></tr></table></div>
<p>The following example bean defines an HTTP inbound endpoint:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"httpInbound"</span>
  <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.http.inbound.HttpRequestHandlingMessagingGateway"</span><span class="hl-tag">&gt;</span>
  <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"requestChannel"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"httpRequestChannel"</span><span class="hl-tag"> /&gt;</span>
  <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"replyChannel"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"httpReplyChannel"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
</div>
<p>The <code class="literal">HttpRequestHandlingMessagingGateway</code> accepts a list of <code class="literal">HttpMessageConverter</code> instances or else relies on a default list.
The converters allow customization of the mapping from <code class="literal">HttpServletRequest</code> to <code class="literal">Message</code>.
The default converters encapsulate simple strategies, which (for example) create a <code class="literal">String</code> message for a <code class="literal">POST</code> request where the content type starts with <code class="literal">text</code>. See the <a class="ulink" href="https://docs.spring.io/spring-integration/api/index.html" target="_top">Javadoc</a> for full details.
An additional flag (<code class="literal">mergeWithDefaultConverters</code>) can be set along with the list of custom <code class="literal">HttpMessageConverter</code> to add the default converters after the custom converters.
By default, this flag is set to <code class="literal">false</code>, meaning that the custom converters replace the default list.</p>
<p>The message conversion process uses the (optional) <code class="literal">requestPayloadType</code> property and the incoming <code class="literal">Content-Type</code> header.
Starting with version 4.3, if a request has no content type header, <code class="literal">application/octet-stream</code> is assumed, as
recommended by <code class="literal">RFC 2616</code>.
Previously, the body of such messages was ignored.</p>
<p>Spring Integration 2.0 implemented multipart file support.
If the request has been wrapped as a <code class="literal">MultipartHttpServletRequest</code>, when you use the default converters, that request is converted to a <code class="literal">Message</code> payload that is a <code class="literal">MultiValueMap</code> containing values that may be byte arrays, strings, or instances of Spring&#8217;s <code class="literal">MultipartFile</code>, depending on the content type of the individual parts.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The HTTP inbound endpoint locates a <code class="literal">MultipartResolver</code> in the context if one has a bean name of <code class="literal">multipartResolver</code> (the same name expected by Spring&#8217;s <code class="literal">DispatcherServlet</code>).
If it does locate that bean, the support for multipart files is enabled on the inbound request mapper.
Otherwise, it fails when it tries to map a multipart file request to a Spring Integration <code class="literal">Message</code>.
For more on Spring&#8217;s support for <code class="literal">MultipartResolver</code>, see the <a class="ulink" href="http://docs.spring.io/spring/docs/current/spring-framework-reference/html/mvc.html#mvc-multipart" target="_top">Spring Reference Manual</a>.</p>
</td></tr></table></div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>If you wish to proxy a <code class="literal">multipart/form-data</code> to another server, it may be better to keep it in raw form.
To handle this situation, do not add the <code class="literal">multipartResolver</code> bean to the context.
Configure the endpoint to expect a <code class="literal">byte[]</code> request, customize the message converters to include a <code class="literal">ByteArrayHttpMessageConverter</code>, and disable the default multipart converter.
You may need some other converters for the replies.
The following example shows such an arrangement:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int-http:inbound-gateway</span>
                  <span class="hl-attribute">channel</span>=<span class="hl-value">"receiveChannel"</span>
                  <span class="hl-attribute">path</span>=<span class="hl-value">"/inboundAdapter.htm"</span>
                  <span class="hl-attribute">request-payload-type</span>=<span class="hl-value">"byte[]"</span>
                  <span class="hl-attribute">message-converters</span>=<span class="hl-value">"converters"</span>
                  <span class="hl-attribute">merge-with-default-converters</span>=<span class="hl-value">"false"</span>
                  <span class="hl-attribute">supported-methods</span>=<span class="hl-value">"POST"</span><span class="hl-tag"> /&gt;</span>

<span class="hl-tag">&lt;util:list</span> <span class="hl-attribute">id</span>=<span class="hl-value">"converters"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;beans:bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.http.converter.ByteArrayHttpMessageConverter"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;beans:bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.http.converter.StringHttpMessageConverter"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;beans:bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.http.converter.json.MappingJackson2HttpMessageConverter"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/util:list&gt;</span></pre>
</td></tr></table></div>
<p>When you send a response to the client, you have a number of ways to customize the behavior of the gateway.
By default, the gateway acknowledges that the request was received by sending a <code class="literal">200</code> status code back.
It is possible to customize this response by providing a <span class="emphasis"><em>viewName</em></span> to be resolved by the Spring MVC <code class="literal">ViewResolver</code>.
If the gateway should expect a reply to the <code class="literal">Message</code>, you can set the <code class="literal">expectReply</code> flag (constructor argument) to cause the gateway to wait for a reply <code class="literal">Message</code> before creating an HTTP response.
The following example configures a gateway to serve as a Spring MVC Controller with a view name:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"httpInbound"</span>
  <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.http.inbound.HttpRequestHandlingController"</span><span class="hl-tag">&gt;</span>
  <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"true"</span><span class="hl-tag"> /&gt;</span> <span class="hl-comment">&lt;!-- indicates that a reply is expected --&gt;</span>
  <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"requestChannel"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"httpRequestChannel"</span><span class="hl-tag"> /&gt;</span>
  <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"replyChannel"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"httpReplyChannel"</span><span class="hl-tag"> /&gt;</span>
  <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"viewName"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"jsonView"</span><span class="hl-tag"> /&gt;</span>
  <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"supportedMethodNames"</span><span class="hl-tag"> &gt;</span>
    <span class="hl-tag">&lt;list&gt;</span>
      <span class="hl-tag">&lt;value&gt;</span>GET<span class="hl-tag">&lt;/value&gt;</span>
      <span class="hl-tag">&lt;value&gt;</span>DELETE<span class="hl-tag">&lt;/value&gt;</span>
    <span class="hl-tag">&lt;/list&gt;</span>
  <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
<p>Because of the <code class="literal">constructor-arg</code> value of <code class="literal">true</code>, it waits for a reply.
The preceding example also shows how to customize the HTTP methods accepted by the gateway, which are <code class="literal">POST</code> and <code class="literal">GET</code> by default.</p>
<p>The reply message is available in the model map.
By default, the key for that map entry is <span class="emphasis"><em>reply</em></span>, but you can override this default by setting the <span class="emphasis"><em>replyKey</em></span> property on the endpoint&#8217;s configuration.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="http-outbound" href="#http-outbound"></a>20.2&nbsp;HTTP Outbound Components</h2></div></div></div>

<p>This section describes Spring Integration&#8217;s HTTP outbound components</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_using_literal_httprequestexecutingmessagehandler_literal" href="#_using_literal_httprequestexecutingmessagehandler_literal"></a>20.2.1&nbsp;Using <code class="literal">HttpRequestExecutingMessageHandler</code></h3></div></div></div>

<p>To configure the <code class="literal">HttpRequestExecutingMessageHandler</code>, write a bean definition similar to the following:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"httpOutbound"</span>
  <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.http.outbound.HttpRequestExecutingMessageHandler"</span><span class="hl-tag">&gt;</span>
  <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"http://localhost:8080/example"</span><span class="hl-tag"> /&gt;</span>
  <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"outputChannel"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"responseChannel"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
</div>
<p>This bean definition runs HTTP requests by delegating to a <code class="literal">RestTemplate</code>.
That template, in turn, delegates to a list of <code class="literal">HttpMessageConverter</code> instances to generate the HTTP request body from the <code class="literal">Message</code> payload.
You can configure those converters as well as the <code class="literal">ClientHttpRequestFactory</code> instance to use, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"httpOutbound"</span>
  <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.http.outbound.HttpRequestExecutingMessageHandler"</span><span class="hl-tag">&gt;</span>
  <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"http://localhost:8080/example"</span><span class="hl-tag"> /&gt;</span>
  <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"outputChannel"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"responseChannel"</span><span class="hl-tag"> /&gt;</span>
  <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"messageConverters"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"messageConverterList"</span><span class="hl-tag"> /&gt;</span>
  <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"requestFactory"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"customRequestFactory"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
</div>
<p>By default, the HTTP request is generated by using an instance of <code class="literal">SimpleClientHttpRequestFactory</code>, which uses the JDK <code class="literal">HttpURLConnection</code>.
Use of the Apache Commons HTTP Client is also supported through <code class="literal">CommonsClientHttpRequestFactory</code>, which you can inject (as shown earlier).</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>For the outbound gateway, the reply message produced by the gateway contains all the message headers that are present in the request message.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_using_cookies" href="#_using_cookies"></a>20.2.2&nbsp;Using Cookies</h3></div></div></div>

<p>Basic cookie support is provided by the <code class="literal">transfer-cookies</code> attribute on the outbound gateway.
When set to <code class="literal">true</code> (the default is <code class="literal">false</code>), a <code class="literal">Set-Cookie</code> header received from the server in a response is converted to <code class="literal">Cookie</code> in the reply message.
This header is then used on subsequent sends.
This enables simple stateful interactions, such as the following:</p>
<p><code class="literal">...-&gt;logonGateway-&gt;...-&gt;doWorkGateway-&gt;...-&gt;logoffGateway-&gt;...</code></p>
<p>If <code class="literal">transfer-cookies</code> is <code class="literal">false</code>, any <code class="literal">Set-Cookie</code> header received remains as <code class="literal">Set-Cookie</code> in the reply message and is dropped on subsequent sends.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note: Empty Response Bodies"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Empty Response Bodies</th></tr><tr><td align="left" valign="top">

<p>HTTP is a request-response protocol.
However, the response may not have a body, only headers.
In this case, the <code class="literal">HttpRequestExecutingMessageHandler</code> produces a reply <code class="literal">Message</code> with the payload being an <code class="literal">org.springframework.http.ResponseEntity</code>, regardless of any provided <code class="literal">expected-response-type</code>.
According to the <a class="ulink" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html" target="_top">HTTP RFC Status Code Definitions</a>, there are many statuses that mandate that a response must not contain a message-body (for example,
<code class="literal">204 No Content</code>).
There are also cases where calls to the same URL might or might not return a response body.
For example, the first request to an HTTP resource returns content, but the second does not (returning a <code class="literal">304 Not Modified</code>).
In all cases, however, the <code class="literal">http_statusCode</code> message header is populated.
This can be used in some routing logic after the HTTP outbound gateway.
You could also use a`&lt;payload-type-router/&gt;` to route messages with a <code class="literal">ResponseEntity</code> to a different flow than that used for responses with a body.</p>
</td></tr></table></div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note: expected-response-type"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">expected-response-type</th></tr><tr><td align="left" valign="top">

<p>Further to the preceding note about empty response bodies, if a response does contain a body, you must provide an appropriate <code class="literal">expected-response-type</code> attribute or, again, you receive a <code class="literal">ResponseEntity</code> with no body.
The <code class="literal">expected-response-type</code> must be compatible with the (configured or default) <code class="literal">HttpMessageConverter</code> instances and the <code class="literal">Content-Type</code> header in the response.
This can be an abstract class or even an interface (such as <code class="literal">java.io.Serializable</code> when you use Java serialization and <code class="literal">Content-Type: application/x-java-serialized-object</code>).</p>
</td></tr></table></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="http-namespace" href="#http-namespace"></a>20.3&nbsp;HTTP Namespace Support</h2></div></div></div>

<p>Spring Integration provides an <code class="literal">http</code> namespace and the corresponding schema definition.
To include it in your configuration, provide the following namespace declaration in your application context configuration file:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
  <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
  <span class="hl-attribute">xmlns:int</span>=<span class="hl-value">"http://www.springframework.org/schema/integration"</span>
  <span class="hl-attribute">xmlns:int-http</span>=<span class="hl-value">"http://www.springframework.org/schema/integration/http"</span>
  <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"
    http://www.springframework.org/schema/beans
    http://www.springframework.org/schema/beans/spring-beans.xsd
    http://www.springframework.org/schema/integration
    http://www.springframework.org/schema/integration/spring-integration.xsd
    http://www.springframework.org/schema/integration/http
    http://www.springframework.org/schema/integration/http/spring-integration-http.xsd"</span><span class="hl-tag">&gt;</span>
    ...
<span class="hl-tag">&lt;/beans&gt;</span></pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_inbound_2" href="#_inbound_2"></a>20.3.1&nbsp;Inbound</h3></div></div></div>

<p>The XML namespace provides two components for handling HTTP inbound requests: <code class="literal">inbound-channel-adapter</code> and <code class="literal">inbound-gateway</code>.
In order to process requests without returning a dedicated response, use the <code class="literal">inbound-channel-adapter</code>.
The following example shows how to configure one:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-http:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"httpChannelAdapter"</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"requests"</span>
    <span class="hl-attribute">supported-methods</span>=<span class="hl-value">"PUT, DELETE"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>To process requests that do expect a response, use an <code class="literal">inbound-gateway</code>.
The following example shows how to configure one:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-http:inbound-gateway</span> <span class="hl-attribute">id</span>=<span class="hl-value">"inboundGateway"</span>
    <span class="hl-attribute">request-channel</span>=<span class="hl-value">"requests"</span>
    <span class="hl-attribute">reply-channel</span>=<span class="hl-value">"responses"</span><span class="hl-tag">/&gt;</span></pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="http-request-mapping" href="#http-request-mapping"></a>20.3.2&nbsp;Request Mapping Support</h3></div></div></div>

<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Spring Integration 3.0 improved the REST support by introducing the <a class="ulink" href="http://static.springsource.org/spring-integration/api/org/springframework/integration/http/inbound/IntegrationRequestMappingHandlerMapping.html" target="_top"><code class="literal">IntegrationRequestMappingHandlerMapping</code></a>.
The implementation relies on the enhanced REST support provided by Spring Framework 3.1 or higher.</p>
</td></tr></table></div>
<p>The parsing of the HTTP inbound gateway or the HTTP inbound channel adapter registers an <code class="literal">integrationRequestMappingHandlerMapping</code> bean of type <a class="ulink" href="http://static.springsource.org/spring-integration/api/org/springframework/integration/http/inbound/IntegrationRequestMappingHandlerMapping.html" target="_top"><code class="literal">IntegrationRequestMappingHandlerMapping</code></a>, in case one is not yet registered.
This particular implementation of the <a class="ulink" href="http://static.springsource.org/spring/docs/current/javadoc-api/org/springframework/web/servlet/HandlerMapping.html" target="_top"><code class="literal">HandlerMapping</code></a> delegates its logic to <a class="ulink" href="http://static.springsource.org/spring/docs/current/javadoc-api/org/springframework/web/servlet/mvc/method/RequestMappingInfoHandlerMapping.html" target="_top"><code class="literal">RequestMappingInfoHandlerMapping</code></a>.
The implementation provides functionality similar to the <a class="ulink" href="http://static.springsource.org/spring/docs/current/javadoc-api/org/springframework/web/bind/annotation/RequestMapping.html" target="_top"><code class="literal">org.springframework.web.bind.annotation.RequestMapping</code></a> annotation in Spring MVC.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>For more information, see <a class="ulink" href="http://static.springsource.org/spring/docs/current/spring-framework-reference/html/mvc.html#mvc-ann-requestmapping" target="_top">Mapping Requests With <code class="literal">@RequestMapping</code></a>.</p>
</td></tr></table></div>
<p>For this purpose, Spring Integration 3.0 introduces the <code class="literal">&lt;request-mapping&gt;</code> element.
You can add this optional element to <code class="literal">&lt;http:inbound-channel-adapter&gt;</code> and <code class="literal">&lt;http:inbound-gateway&gt;</code>.
It works in conjunction with the <code class="literal">path</code> and <code class="literal">supported-methods</code> attributes.
The following example shows how to configure it on an inbound gateway:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;inbound-gateway</span> <span class="hl-attribute">id</span>=<span class="hl-value">"inboundController"</span>
    <span class="hl-attribute">request-channel</span>=<span class="hl-value">"requests"</span>
    <span class="hl-attribute">reply-channel</span>=<span class="hl-value">"responses"</span>
    <span class="hl-attribute">path</span>=<span class="hl-value">"/foo/{fooId}"</span>
    <span class="hl-attribute">supported-methods</span>=<span class="hl-value">"GET"</span>
    <span class="hl-attribute">view-name</span>=<span class="hl-value">"foo"</span>
    <span class="hl-attribute">error-code</span>=<span class="hl-value">"oops"</span><span class="hl-tag">&gt;</span>
   <span class="hl-tag">&lt;request-mapping</span> <span class="hl-attribute">headers</span>=<span class="hl-value">"User-Agent"</span>
     <span class="hl-attribute">params</span>=<span class="hl-value">"myParam=myValue"</span>
     <span class="hl-attribute">consumes</span>=<span class="hl-value">"application/json"</span>
     <span class="hl-attribute">produces</span>=<span class="hl-value">"!text/plain"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/inbound-gateway&gt;</span></pre>
</div>
<p>Based on the preceding configuration, the namespace parser creates an instance of the <code class="literal">IntegrationRequestMappingHandlerMapping</code> (if none exists) and an <code class="literal">HttpRequestHandlingController</code> bean and associates with it an instance of <a class="ulink" href="http://static.springsource.org/spring-integration/api/org/springframework/integration/http/inbound/RequestMapping.html" target="_top"><code class="literal">RequestMapping</code></a>. This <code class="literal">RequestMapping</code> instance is, in turn, converted to the Spring MVC <a class="ulink" href="http://static.springsource.org/spring/docs/current/javadoc-api/org/springframework/web/servlet/mvc/method/RequestMappingInfo.html" target="_top"><code class="literal">RequestMappingInfo</code></a>.</p>
<p>The <code class="literal">&lt;request-mapping&gt;</code> element provides the following attributes:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">headers</code>
</li><li class="listitem">
<code class="literal">params</code>
</li><li class="listitem">
<code class="literal">consumes</code>
</li><li class="listitem">
<code class="literal">produces</code>
</li></ul></div>
<p>With the <code class="literal">path</code> and <code class="literal">supported-methods</code> attributes of the <code class="literal">&lt;http:inbound-channel-adapter&gt;</code> or the <code class="literal">&lt;http:inbound-gateway&gt;</code>, <code class="literal">&lt;request-mapping&gt;</code> attributes translate directly into the respective options provided by the <code class="literal">org.springframework.web.bind.annotation.RequestMapping</code> annotation in Spring MVC.</p>
<p>The <code class="literal">&lt;request-mapping&gt;</code> element lets you configure several Spring Integration HTTP inbound endpoints to the same <code class="literal">path</code> (or even the same <code class="literal">supported-methods</code>) and lets you provide different downstream message flows based on incoming HTTP requests.</p>
<p>Alternatively, you can also declare only one HTTP inbound endpoint and apply routing and filtering logic within the Spring Integration flow to achieve the same result.
This lets you get the <code class="literal">Message</code> into the flow as early as possibly.
The following example shows how to do so:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-http:inbound-gateway</span> <span class="hl-attribute">request-channel</span>=<span class="hl-value">"httpMethodRouter"</span>
    <span class="hl-attribute">supported-methods</span>=<span class="hl-value">"GET,DELETE"</span>
    <span class="hl-attribute">path</span>=<span class="hl-value">"/process/{entId}"</span>
    <span class="hl-attribute">payload-expression</span>=<span class="hl-value">"#pathVariables.entId"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int:router</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"httpMethodRouter"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"headers.http_requestMethod"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:mapping</span> <span class="hl-attribute">value</span>=<span class="hl-value">"GET"</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"in1"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int:mapping</span> <span class="hl-attribute">value</span>=<span class="hl-value">"DELETE"</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"in2"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:router&gt;</span>

<span class="hl-tag">&lt;int:service-activator</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"in1"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"service"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"getEntity"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int:service-activator</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"in2"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"service"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"delete"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>For more information regarding handler mappings, see <a class="ulink" href="https://docs.spring.io/spring/docs/current/spring-framework-reference/web.html" target="_top">the Spring Framework Web Servlet documentation</a> or <a class="ulink" href="https://docs.spring.io/spring/docs/current/spring-framework-reference/web-reactive.html" target="_top">the Spring Framework Web Reactive documentation</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="http-cors" href="#http-cors"></a>20.3.3&nbsp;Cross-origin Resource Sharing (CORS) Support</h3></div></div></div>

<p>Starting with version 4.2, you can configure the <code class="literal">&lt;http:inbound-channel-adapter&gt;</code> and <code class="literal">&lt;http:inbound-gateway&gt;</code> with
a <code class="literal">&lt;cross-origin&gt;</code> element.
It represents the same options as Spring MVC&#8217;s <code class="literal">@CrossOrigin</code> for <code class="literal">@Controller</code> annotations and allows the configuration of cross-origin resource sharing (CORS) for Spring Integration HTTP endpoints:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">origin</code>: List of allowed origins.
<code class="literal">*</code> means that all origins are allowed.
These values are placed in the <code class="literal">Access-Control-Allow-Origin</code> header of both the pre-flight and actual responses.
The default value is <code class="literal">*</code>.
</li><li class="listitem">
<code class="literal">allowed-headers</code>: Indicates which request headers can be used during the actual request.
<code class="literal">*</code> means that all headers requested by the client are allowed.
This property controls the value of the pre-flight response&#8217;s <code class="literal">Access-Control-Allow-Headers</code> header.
The default value is <code class="literal">*</code>.
</li><li class="listitem">
<code class="literal">exposed-headers</code>: List of response headers that the user-agent lets the client access.
This property controls the value of the actual response&#8217;s <code class="literal">Access-Control-Expose-Headers</code> header.
</li><li class="listitem">
<code class="literal">method</code>: The HTTP request methods to allow: <code class="literal">GET</code>, <code class="literal">POST</code>, <code class="literal">HEAD</code>, <code class="literal">OPTIONS</code>, <code class="literal">PUT</code>, <code class="literal">PATCH</code>, <code class="literal">DELETE</code>, <code class="literal">TRACE</code>.
Methods specified here overrides those in <code class="literal">supported-methods</code>.
</li><li class="listitem">
<code class="literal">allow-credentials</code>: Set to <code class="literal">true</code> if the the browser should include any cookies associated to the domain of the request or <code class="literal">false</code> if it should not.
An empty string (<span class="emphasis"><em>""</em></span>) means undefined.
If <code class="literal">true</code>, the pre-flight response includes the <code class="literal">Access-Control-Allow-Credentials=true</code> header.
The default value is <code class="literal">true</code>.
</li><li class="listitem">
<code class="literal">max-age</code>: Controls the cache duration for pre-flight responses.
Setting this to a reasonable value can reduce the number of pre-flight request-response interactions required by the browser.
This property controls the value of the <code class="literal">Access-Control-Max-Age</code> header in the pre-flight response.
A value of <code class="literal">-1</code> means undefined.
The default value is 1800 seconds (30 minutes).
</li></ul></div>
<p>The CORS Java Configuration is represented by the <code class="literal">org.springframework.integration.http.inbound.CrossOrigin</code> class,
instances of which can be injected into the <code class="literal">HttpRequestHandlingEndpointSupport</code> beans.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="http-response-statuscode" href="#http-response-statuscode"></a>20.3.4&nbsp;Response Status Code</h3></div></div></div>

<p>Starting with version 4.1, you can configure the <code class="literal">&lt;http:inbound-channel-adapter&gt;</code> with a <code class="literal">status-code-expression</code> to override the default <code class="literal">200 OK</code> status.
The expression must return an object that can be converted to an <code class="literal">org.springframework.http.HttpStatus</code> enum value.
The <code class="literal">evaluationContext</code> has a <code class="literal">BeanResolver</code> and, starting with version 5.1, is supplied with the <code class="literal">RequestEntity&lt;?&gt;</code> as root object.
An example might be to resolve, at runtime, some scoped bean that returns a status code value.
However, most likely, it is set to a fixed value such as <code class="literal">status-code=expression="204"</code> (No Content), or <code class="literal">status-code-expression="T(org.springframework.http.HttpStatus).NO_CONTENT"</code>.
By default, <code class="literal">status-code-expression</code> is null, meaning that the normal <span class="emphasis"><em>200 OK</em></span> response status is returned.
Using the <code class="literal">RequestEntity&lt;?&gt;</code> as root object, the status code can be conditional e.g. on the request method, some header, URI content or even request body.
The following example shows how to set the status code to <code class="literal">ACCEPTED</code>:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;http:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"inboundController"</span>
       <span class="hl-attribute">channel</span>=<span class="hl-value">"requests"</span> <span class="hl-attribute">view-name</span>=<span class="hl-value">"foo"</span> <span class="hl-attribute">error-code</span>=<span class="hl-value">"oops"</span>
       <span class="hl-attribute">status-code-expression</span>=<span class="hl-value">"T(org.springframework.http.HttpStatus).ACCEPTED"</span><span class="hl-tag">&gt;</span>
   <span class="hl-tag">&lt;request-mapping</span> <span class="hl-attribute">headers</span>=<span class="hl-value">"BAR"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/http:inbound-channel-adapter&gt;</span></pre>
</div>
<p>The <code class="literal">&lt;http:inbound-gateway&gt;</code> resolves the <span class="emphasis"><em>status code</em></span> from the <code class="literal">http_statusCode</code> header of the reply <code class="literal">Message</code>.
Starting with version 4.2, the default response status code when no reply is received within the <code class="literal">reply-timeout</code>
is <code class="literal">500 Internal Server Error</code>.
There are two ways to modify this behavior:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Add a <code class="literal">reply-timeout-status-code-expression</code>. This has the same semantics as the <code class="literal">status-code-expression</code> on the inbound adapter.
</li><li class="listitem">
<p class="simpara">Add an <code class="literal">error-channel</code> and return an appropriate message with an HTTP status code header, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:chain</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"errors"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:header-enricher&gt;</span>
        <span class="hl-tag">&lt;int:header</span> <span class="hl-attribute">name</span>=<span class="hl-value">"http_statusCode"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"504"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;/int:header-enricher&gt;</span>
    <span class="hl-tag">&lt;int:transformer</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"payload.failedMessage"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/int:chain&gt;</span></pre>
</div>
</li></ul></div>
<p>The payload of the <code class="literal">ErrorMessage</code> is a <code class="literal">MessageTimeoutException</code>.
It must be transformed to something that can be converted by the gateway, such as a <code class="literal">String</code>.
A good candidate is the exception&#8217;s message property, which is the value used when you use the <code class="literal">expression</code> technique.</p>
<p>If the error flow times out after a main flow timeout, <code class="literal">500 Internal Server Error</code> is returned, or, if the
<code class="literal">reply-timeout-status-code-expression</code> is present, it is evaluated.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Previously, the default status code for a timeout was <code class="literal">200 OK</code>.
To restore that behavior, set <code class="literal">reply-timeout-status-code-expression="200"</code>.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_uri_template_variables_and_expressions" href="#_uri_template_variables_and_expressions"></a>20.3.5&nbsp;URI Template Variables and Expressions</h3></div></div></div>

<p>By using the <code class="literal">path</code> attribute in conjunction with the <code class="literal">payload-expression</code> attribute and the <code class="literal">header</code> element, you have a high degree of flexibility for mapping inbound request data.</p>
<p>In the following example configuration, an inbound channel adapter is configured to accept requests using the following URI:</p>
<div class="informalexample">
<pre class="screen">/first-name/{firstName}/last-name/{lastName}</pre>
</div>
<p>When you use the <code class="literal">payload-expression</code> attribute, the <code class="literal">{firstName}</code> URI template variable maps to be the <code class="literal">Message</code> payload, while the <code class="literal">{lastName}</code> URI template variable maps to the <code class="literal">lname</code> message header, as defined in the following example:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-http:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"inboundAdapterWithExpressions"</span>
    <span class="hl-attribute">path</span>=<span class="hl-value">"/first-name/{firstName}/last-name/{lastName}"</span>
    <span class="hl-attribute">channel</span>=<span class="hl-value">"requests"</span>
    <span class="hl-attribute">payload-expression</span>=<span class="hl-value">"#pathVariables.firstName"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int-http:header</span> <span class="hl-attribute">name</span>=<span class="hl-value">"lname"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"#pathVariables.lastName"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-http:inbound-channel-adapter&gt;</span></pre>
</div>
<p>For more information about URI template variables, see <a class="ulink" href="http://static.springsource.org/spring/docs/current/spring-framework-reference/html/mvc.html#mvc-ann-requestmapping-uri-templates" target="_top">uri template patterns</a> in the Spring Reference Manual.</p>
<p>Since Spring Integration 3.0, in addition to the existing <code class="literal">#pathVariables</code> and <code class="literal">#requestParams</code> variables being available in payload and header expressions, we added other useful expression variables:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">#requestParams</code>: The <code class="literal">MultiValueMap</code> from the <code class="literal">ServletRequest</code> <code class="literal">parameterMap</code>.
</li><li class="listitem">
<code class="literal">#pathVariables</code>: The <code class="literal">Map</code> from URI Template placeholders and their values.
</li><li class="listitem">
<code class="literal">#matrixVariables</code>: The <code class="literal">Map</code> of <code class="literal">MultiValueMap</code> according to the <a class="ulink" href="http://docs.spring.io/spring/docs/current/spring-framework-reference/html/mvc.html#mvc-ann-matrix-variables" target="_top">Spring MVC Specification</a>.
Note that <code class="literal">#matrixVariables</code> requires Spring MVC 3.2 or higher.
</li><li class="listitem">
<code class="literal">#requestAttributes</code>: The <code class="literal">org.springframework.web.context.request.RequestAttributes</code> associated with the current request.
</li><li class="listitem">
<code class="literal">#requestHeaders</code>: The <code class="literal">org.springframework.http.HttpHeaders</code> object from the current request.
</li><li class="listitem">
<code class="literal">#cookies</code>: The <code class="literal">Map&lt;String, Cookie&gt;</code> of <code class="literal">javax.servlet.http.Cookie</code> instances from the current request.
</li></ul></div>
<p>Note that all these values (and others) can be accessed within expressions in the downstream message flow through the <code class="literal">ThreadLocal</code> <code class="literal">org.springframework.web.context.request.RequestAttributes</code> variable, if that message flow is single-threaded and lives within the request thread.
The following example configures a transformer that uses an <code class="literal">expression</code> attribute:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-:transformer</span>
    <span class="hl-attribute">expression</span>=<span class="hl-value">"T(org.springframework.web.context.request.RequestContextHolder).
                  requestAttributes.request.queryString"</span><span class="hl-tag">/&gt;</span></pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_outbound_2" href="#_outbound_2"></a>20.3.6&nbsp;Outbound</h3></div></div></div>

<p>To configure the outbound gateway, you can use the namespace support.
The following code snippet shows the available configuration options for an outbound HTTP gateway:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-http:outbound-gateway</span> <span class="hl-attribute">id</span>=<span class="hl-value">"example"</span>
    <span class="hl-attribute">request-channel</span>=<span class="hl-value">"requests"</span>
    <span class="hl-attribute">url</span>=<span class="hl-value">"http://localhost/test"</span>
    <span class="hl-attribute">http-method</span>=<span class="hl-value">"POST"</span>
    <span class="hl-attribute">extract-request-payload</span>=<span class="hl-value">"false"</span>
    <span class="hl-attribute">expected-response-type</span>=<span class="hl-value">"java.lang.String"</span>
    <span class="hl-attribute">charset</span>=<span class="hl-value">"UTF-8"</span>
    <span class="hl-attribute">request-factory</span>=<span class="hl-value">"requestFactory"</span>
    <span class="hl-attribute">reply-timeout</span>=<span class="hl-value">"1234"</span>
    <span class="hl-attribute">reply-channel</span>=<span class="hl-value">"replies"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>Most importantly, notice that the <span class="emphasis"><em>http-method</em></span> and <span class="emphasis"><em>expected-response-type</em></span> attributes are provided.
Those are two of the most commonly configured values.
The default <code class="literal">http-method</code> is <code class="literal">POST</code>, and the default response type is null.
With a null response type, the payload of the reply <code class="literal">Message</code> contains the <code class="literal">ResponseEntity</code>, as long as its HTTP status is a success (non-successful status codes throw exceptions).
If you expect a different type, such as a <code class="literal">String</code>, provide that as a fully-qualified class name (<code class="literal">java.lang.String</code> in the preceding example).
See also the note about empty response bodies in <a class="xref" href="#http-outbound" title="20.2&nbsp;HTTP Outbound Components">Section&nbsp;20.2, &#8220;HTTP Outbound Components&#8221;</a>.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Beginning with Spring Integration 2.1, the <code class="literal">request-timeout</code> attribute of the HTTP outbound gateway was renamed to <code class="literal">reply-timeout</code> to better reflect its intent.</p>
</td></tr></table></div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Since Spring Integration 2.2, Java serialization over HTTP is no longer enabled by default.
Previously, when setting the <code class="literal">expected-response-type</code> attribute to a <code class="literal">Serializable</code> object, the <code class="literal">Accept</code> header was not properly set up.
Since Spring Integration 2.2, the <code class="literal">SerializingHttpMessageConverter</code> has now been updated to set the <code class="literal">Accept</code> header to <code class="literal">application/x-java-serialized-object</code>.</p>
<p>However, because this could cause incompatibility with existing applications, it was decided to no longer automatically add this converter to the HTTP endpoints.
If you wish to use Java serialization, you can add the <code class="literal">SerializingHttpMessageConverter</code> to the appropriate endpoints, by using the <code class="literal">message-converters</code> attribute (when you use XML configuration) or by using the <code class="literal">setMessageConverters()</code> method (in Java configuration).
Alternatively, you may wish to consider using JSON instead, which is enabled by having <a class="ulink" href="https://github.com/FasterXML/jackson" target="_top">the Jackson library</a> on the classpath.</p>
</td></tr></table></div>
<p>Beginning with Spring Integration 2.2, you can also determine the HTTP method dynamically by using SpEL and the <code class="literal">http-method-expression</code> attribute.
Note that this attribute is mutually exclusive with <code class="literal">http-method</code>. You can also use the <code class="literal">expected-response-type-expression</code> attribute instead of <code class="literal">expected-response-type</code> and provide any valid SpEL expression that determines the type of the response.
The following configuration example uses <code class="literal">expected-response-type-expression</code>:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-http:outbound-gateway</span> <span class="hl-attribute">id</span>=<span class="hl-value">"example"</span>
    <span class="hl-attribute">request-channel</span>=<span class="hl-value">"requests"</span>
    <span class="hl-attribute">url</span>=<span class="hl-value">"http://localhost/test"</span>
    <span class="hl-attribute">http-method-expression</span>=<span class="hl-value">"headers.httpMethod"</span>
    <span class="hl-attribute">extract-request-payload</span>=<span class="hl-value">"false"</span>
    <span class="hl-attribute">expected-response-type-expression</span>=<span class="hl-value">"payload"</span>
    <span class="hl-attribute">charset</span>=<span class="hl-value">"UTF-8"</span>
    <span class="hl-attribute">request-factory</span>=<span class="hl-value">"requestFactory"</span>
    <span class="hl-attribute">reply-timeout</span>=<span class="hl-value">"1234"</span>
    <span class="hl-attribute">reply-channel</span>=<span class="hl-value">"replies"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>If your outbound adapter is to be used in a unidirectional way, you can use an <code class="literal">outbound-channel-adapter</code> instead.
This means that a successful response executes without sending any messages to a reply channel.
In the case of any non-successful response status code, it throws an exception.
The configuration looks very similar to the gateway, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-http:outbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"example"</span>
    <span class="hl-attribute">url</span>=<span class="hl-value">"http://localhost/example"</span>
    <span class="hl-attribute">http-method</span>=<span class="hl-value">"GET"</span>
    <span class="hl-attribute">channel</span>=<span class="hl-value">"requests"</span>
    <span class="hl-attribute">charset</span>=<span class="hl-value">"UTF-8"</span>
    <span class="hl-attribute">extract-payload</span>=<span class="hl-value">"false"</span>
    <span class="hl-attribute">expected-response-type</span>=<span class="hl-value">"java.lang.String"</span>
    <span class="hl-attribute">request-factory</span>=<span class="hl-value">"someRequestFactory"</span>
    <span class="hl-attribute">order</span>=<span class="hl-value">"3"</span>
    <span class="hl-attribute">auto-startup</span>=<span class="hl-value">"false"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>To specify the URL, you can use either the <span class="emphasis"><em>url</em></span> attribute or the <span class="emphasis"><em>url-expression</em></span> attribute.
The <span class="emphasis"><em>url</em></span> attribute takes a simple string (with placeholders for URI variables, as described below).
The <span class="emphasis"><em>url-expression</em></span> is a SpEL expression, with the <code class="literal">Message</code> as the root object, which enables dynamic urls.
The URL that results from the expression evaluation can still have placeholders for URI variables.</p>
<p>In previous releases, some users used the place holders to replace the entire URL with a URI variable.
Changes in Spring 3.1 can cause some issues with escaped characters, such as <span class="emphasis"><em>?</em></span>.
For this reason, we recommend that, if you wish to generate the URL entirely at runtime, you use the <span class="emphasis"><em>url-expression</em></span> attribute.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="mapping-uri-variables" href="#mapping-uri-variables"></a>20.3.7&nbsp;Mapping URI Variables</h3></div></div></div>

<p>If your URL contains URI variables, you can map them by using the <code class="literal">uri-variable</code> element.
This element is available for the HTTP outbound gateway and the HTTP outbound channel adapter.
The following example maps the <code class="literal">zipCode</code> URI variable to an expression:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-http:outbound-gateway</span> <span class="hl-attribute">id</span>=<span class="hl-value">"trafficGateway"</span>
    <span class="hl-attribute">url</span>=<span class="hl-value">"http://local.yahooapis.com/trafficData?appid=YdnDemo&amp;amp;zip={zipCode}"</span>
    <span class="hl-attribute">request-channel</span>=<span class="hl-value">"trafficChannel"</span>
    <span class="hl-attribute">http-method</span>=<span class="hl-value">"GET"</span>
    <span class="hl-attribute">expected-response-type</span>=<span class="hl-value">"java.lang.String"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int-http:uri-variable</span> <span class="hl-attribute">name</span>=<span class="hl-value">"zipCode"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"payload.getZip()"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-http:outbound-gateway&gt;</span></pre>
</div>
<p>The <code class="literal">uri-variable</code> element defines two attributes: <code class="literal">name</code> and <code class="literal">expression</code>.
The <code class="literal">name</code> attribute identifies the name of the URI variable, while the <code class="literal">expression</code> attribute is used to set the actual value.
By using the <code class="literal">expression</code> attribute, you can leverage the full power of the Spring Expression Language (SpEL), which gives you full dynamic access to the message payload and the message headers.
For example, in the preceding configuration, the <code class="literal">getZip()</code> method is invoked on the payload object of the <code class="literal">Message</code> and the result of that method is used as the value of the URI variable named <span class="emphasis"><em>zipCode</em></span>.</p>
<p>Since Spring Integration 3.0, HTTP outbound endpoints support the <code class="literal">uri-variables-expression</code> attribute to specify an <code class="literal">expression</code> that should be evaluated, resulting in a <code class="literal">Map</code> of all URI variable placeholders within the URL template.
It provides a mechanism whereby you can use different variable expressions, based on the outbound message.
This attribute is mutually exclusive with the <code class="literal">&lt;uri-variable/&gt;</code> element.
The following example shows how to use the <code class="literal">uri-variables-expression</code> attribute:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-http:outbound-gateway</span>
     <span class="hl-attribute">url</span>=<span class="hl-value">"http://foo.host/{foo}/bars/{bar}"</span>
     <span class="hl-attribute">request-channel</span>=<span class="hl-value">"trafficChannel"</span>
     <span class="hl-attribute">http-method</span>=<span class="hl-value">"GET"</span>
     <span class="hl-attribute">uri-variables-expression</span>=<span class="hl-value">"@uriVariablesBean.populate(payload)"</span>
     <span class="hl-attribute">expected-response-type</span>=<span class="hl-value">"java.lang.String"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p><code class="literal">uriVariablesBean</code> might be defined as follows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> UriVariablesBean {
    <span class="hl-keyword">private</span> <span class="hl-keyword">static</span> <span class="hl-keyword">final</span> ExpressionParser EXPRESSION_PARSER = <span class="hl-keyword">new</span> SpelExpressionParser();

    <span class="hl-keyword">public</span> Map&lt;String, ?&gt; populate(Object payload) {
        Map&lt;String, Object&gt; variables = <span class="hl-keyword">new</span> HashMap&lt;String, Object&gt;();
        <span class="hl-keyword">if</span> (payload instanceOf String.<span class="hl-keyword">class</span>)) {
            variables.put(<span class="hl-string">"foo"</span>, <span class="hl-string">"foo"</span>));
        }
        <span class="hl-keyword">else</span> {
            variables.put(<span class="hl-string">"foo"</span>, EXPRESSION_PARSER.parseExpression(<span class="hl-string">"headers.bar"</span>));
        }
        <span class="hl-keyword">return</span> variables;
    }

}</pre>
</div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The <code class="literal">uri-variables-expression</code> must evaluate to a <code class="literal">Map</code>.
The values of the <code class="literal">Map</code> must be instances of <code class="literal">String</code> or <code class="literal">Expression</code>.
This <code class="literal">Map</code> is provided to an <code class="literal">ExpressionEvalMap</code> for further resolution of URI variable placeholders by using those expressions in the context of the outbound <code class="literal">Message</code>.</p>
</td></tr></table></div>
<p>IMPORTANT</p>
<div class="informalexample">
<p>The <code class="literal">uriVariablesExpression</code> property provides a very powerful mechanism for evaluating URI variables.
We anticipate that people mostly use simple expressions, such as the preceding example.
However, you can also configure something such as <code class="literal">"@uriVariablesBean.populate(#root)"</code> with an expression in the returned map being <code class="literal">variables.put("thing1", EXPRESSION_PARSER.parseExpression(message.getHeaders().get("thing2", String.class)));</code>, where the expression is dynamically provided in the message header named <code class="literal">thing2</code>.
Since the header may come from an untrusted source, the HTTP outbound endpoints use <code class="literal">SimpleEvaluationContext</code> when evaluating these expressions.
<code class="literal">SimpleEvaluationContext</code> uses only a subset of SpEL features.
If you trust your message sources and wish to use the restricted SpEL constructs, set the <code class="literal">trustedSpel</code> property of the outbound endpoint to <code class="literal">true</code>.</p>
</div>
<p>You can achieve scenarios that need to supply a dynamic set of URI variables on a per-message basis by using a custom <code class="literal">url-expression</code> and some utilities for building and encoding URL parameters.
The following example shows how to do so:</p>
<div class="informalexample">
<pre class="programlisting">url-expression="T(org.springframework.web.util.UriComponentsBuilder)
                           .fromHttpUrl('http://HOST:PORT/PATH')
                           .queryParams(payload)
                           .build()
                           .toUri()"</pre>
</div>
<p>The <code class="literal">queryParams()</code> method expects a <code class="literal">MultiValueMap&lt;String, String&gt;</code> as an argument, so you can build a real set of URL query parameters in advance, before performing the request.</p>
<p>The whole <code class="literal">queryString</code> can also be presented as a <code class="literal">uri-variable</code>, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-http:outbound-gateway</span> <span class="hl-attribute">id</span>=<span class="hl-value">"proxyGateway"</span> <span class="hl-attribute">request-channel</span>=<span class="hl-value">"testChannel"</span>
              <span class="hl-attribute">url</span>=<span class="hl-value">"http://testServer/test?{queryString}"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int-http:uri-variable</span> <span class="hl-attribute">name</span>=<span class="hl-value">"queryString"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"'a=A&amp;amp;b=B'"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-http:outbound-gateway&gt;</span></pre>
</div>
<p>In this case, you must manually provide the URL encoding.
For example, you can use the <code class="literal">org.apache.http.client.utils.URLEncodedUtils#format()</code> for this purpose.
As mentioned earlier, a manually built <code class="literal">MultiValueMap&lt;String, String&gt;</code> can be converted to the the <code class="literal">List&lt;NameValuePair&gt;</code> <code class="literal">format()</code> method argument by using the following Java Streams snippet:</p>
<div class="informalexample">
<pre class="programlisting">List&lt;NameValuePair&gt; nameValuePairs =
    params.entrySet()
            .stream()
            .flatMap(e -&gt; e
                    .getValue()
                    .stream()
                    .map(v -&gt; <span class="hl-keyword">new</span> BasicNameValuePair(e.getKey(), v)))
            .collect(Collectors.toList());</pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_controlling_uri_encoding" href="#_controlling_uri_encoding"></a>20.3.8&nbsp;Controlling URI Encoding</h3></div></div></div>

<p>By default, the URL string is encoded (see <a class="ulink" href="http://static.springsource.org/spring/docs/current/javadoc-api/org/springframework/web/util/UriComponentsBuilder.html" target="_top"><code class="literal">UriComponentsBuilder</code></a>) to the URI object before sending the request.
In some scenarios with a non-standard URI (such as the RabbitMQ REST API), it is undesirable to perform the encoding.
The <code class="literal">&lt;http:outbound-gateway/&gt;</code> and <code class="literal">&lt;http:outbound-channel-adapter/&gt;</code> provide an <code class="literal">encode-uri</code> attribute.
To disable encoding the URL, set this attribute to <code class="literal">false</code> (by default, it is <code class="literal">true</code>).
If you wish to partially encode some of the URL, use an <code class="literal">expression</code> within a <code class="literal">&lt;uri-variable/&gt;</code>, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;http:outbound-gateway</span> <span class="hl-attribute">url</span>=<span class="hl-value">"http://somehost/%2f/fooApps?bar={param}"</span> <span class="hl-attribute">encode-uri</span>=<span class="hl-value">"false"</span><span class="hl-tag">&gt;</span>
          <span class="hl-tag">&lt;http:uri-variable</span> <span class="hl-attribute">name</span>=<span class="hl-value">"param"</span>
            <span class="hl-attribute">expression</span>=<span class="hl-value">"T(org.apache.commons.httpclient.util.URIUtil)
                                             .encodeWithinQuery('Hello World!')"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/http:outbound-gateway&gt;</span></pre>
</div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="http-java-config" href="#http-java-config"></a>20.4&nbsp;Configuring HTTP Endpoints with Java</h2></div></div></div>

<p>The following example shows how to configure an inbound gateway with Java:</p>
<div class="example"><a name="d5e15037" href="#d5e15037"></a><p class="title"><b>Example&nbsp;20.1.&nbsp;Inbound Gateway Using Java Configuration</b></p><div class="example-contents">

<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> HttpRequestHandlingMessagingGateway inbound() {
    HttpRequestHandlingMessagingGateway gateway =
        <span class="hl-keyword">new</span> HttpRequestHandlingMessagingGateway(true);
    gateway.setRequestMapping(mapping());
    gateway.setRequestPayloadType(String.<span class="hl-keyword">class</span>);
    gateway.setRequestChannelName(<span class="hl-string">"httpRequest"</span>);
    <span class="hl-keyword">return</span> gateway;
}

<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> RequestMapping mapping() {
    RequestMapping requestMapping = <span class="hl-keyword">new</span> RequestMapping();
    requestMapping.setPathPatterns(<span class="hl-string">"/foo"</span>);
    requestMapping.setMethods(HttpMethod.POST);
    <span class="hl-keyword">return</span> requestMapping;
}</pre>
</div></div><br class="example-break">
<p>The following example shows how to configure an inbound gateway with the Java DSL:</p>
<div class="example"><a name="d5e15041" href="#d5e15041"></a><p class="title"><b>Example&nbsp;20.2.&nbsp;Inbound Gateway Using the Java DSL</b></p><div class="example-contents">

<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> IntegrationFlow inbound() {
    <span class="hl-keyword">return</span> IntegrationFlows.from(Http.inboundGateway(<span class="hl-string">"/foo"</span>)
            .requestMapping(m -&gt; m.methods(HttpMethod.POST))
            .requestPayloadType(String.<span class="hl-keyword">class</span>))
        .channel(<span class="hl-string">"httpRequest"</span>)
        .get();
}</pre>
</div></div><br class="example-break">
<p>The following example shows how to configure an outbound gateway with Java:</p>
<div class="example"><a name="d5e15045" href="#d5e15045"></a><p class="title"><b>Example&nbsp;20.3.&nbsp;Outbound Gateway Using Java Configuration</b></p><div class="example-contents">

<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "httpOutRequest")</span></em>
<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> HttpRequestExecutingMessageHandler outbound() {
    HttpRequestExecutingMessageHandler handler =
        <span class="hl-keyword">new</span> HttpRequestExecutingMessageHandler(<span class="hl-string">"http://localhost:8080/foo"</span>);
    handler.setHttpMethod(HttpMethod.POST);
    handler.setExpectedResponseType(String.<span class="hl-keyword">class</span>);
    <span class="hl-keyword">return</span> handler;
}</pre>
</div></div><br class="example-break">
<p>The following example shows how to configure an outbound gateway with the Java DSL:</p>
<div class="example"><a name="d5e15049" href="#d5e15049"></a><p class="title"><b>Example&nbsp;20.4.&nbsp;Outbound Gateway Using the Java DSL</b></p><div class="example-contents">

<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> IntegrationFlow outbound() {
    <span class="hl-keyword">return</span> IntegrationFlows.from(<span class="hl-string">"httpOutRequest"</span>)
        .handle(Http.outboundGateway(<span class="hl-string">"http://localhost:8080/foo"</span>)
            .httpMethod(HttpMethod.POST)
            .expectedResponseType(String.<span class="hl-keyword">class</span>))
        .get();
}</pre>
</div></div><br class="example-break">
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="http-timeout" href="#http-timeout"></a>20.5&nbsp;Timeout Handling</h2></div></div></div>

<p>In the context of HTTP components, there are two timing areas that have to be considered:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Timeouts when interacting with Spring Integration Channels
</li><li class="listitem">
Timeouts when interacting with a remote HTTP server
</li></ul></div>
<p>The components interact with message channels, for which timeouts can be specified.
For example, an HTTP Inbound Gateway forwards messages received from connected HTTP Clients to a message channel (which uses a request timeout) and consequently the HTTP Inbound Gateway receives a reply message from the reply channel (which uses a reply timeout) that is used to generate the HTTP Response.
The following illustration offers a visual explanation:</p>
<div class="figure"><a name="d5e15061" href="#d5e15061"></a><p class="title"><b>Figure&nbsp;20.1.&nbsp;How timeout settings apply to an HTTP Inbound Gateway</b></p><div class="figure-contents">

<div class="mediaobject" align="center"><img src="images/http-inbound-gateway.png" align="middle" alt="http inbound gateway"></div>
</div></div><br class="figure-break">
<p>For outbound endpoints, we need to consider how timing works while interacting with the remote server.
The following image shows this scenario:</p>
<div class="figure"><a name="d5e15069" href="#d5e15069"></a><p class="title"><b>Figure&nbsp;20.2.&nbsp;How timeout settings apply to an HTTP Outbound Gateway</b></p><div class="figure-contents">

<div class="mediaobject" align="center"><img src="images/http-outbound-gateway.png" align="middle" alt="http outbound gateway"></div>
</div></div><br class="figure-break">
<p>You may want to configure the HTTP related timeout behavior, when making active HTTP requests by using the HTTP outbound gateway or the HTTP outbound channel adapter.
In those instances, these two components use Spring&#8217;s
<a class="ulink" href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/web/client/RestTemplate.html" target="_top"><code class="literal">RestTemplate</code></a> support to execute HTTP requests.</p>
<p>To configure timeouts for the HTTP outbound gateway and the HTTP outbound channel adapter, you can either reference a <code class="literal">RestTemplate</code> bean directly (by using the <code class="literal">rest-template</code> attribute) or you can provide a reference to a <a class="ulink" href="http://static.springsource.org/spring/docs/current/javadoc-api/org/springframework/http/client/ClientHttpRequestFactory.html" target="_top"><code class="literal">ClientHttpRequestFactory</code></a> bean (by using the <code class="literal">request-factory</code> attribute).
Spring provides the following implementations of the <code class="literal">ClientHttpRequestFactory</code> interface:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="ulink" href="http://static.springsource.org/spring/docs/current/javadoc-api/org/springframework/http/client/SimpleClientHttpRequestFactory.html" target="_top"><code class="literal">SimpleClientHttpRequestFactory</code></a>: Uses standard J2SE facilities for making HTTP Requests
</li><li class="listitem">
<a class="ulink" href="http://static.springsource.org/spring/docs/current/javadoc-api/org/springframework/http/client/HttpComponentsClientHttpRequestFactory.html" target="_top"><code class="literal">HttpComponentsClientHttpRequestFactory</code></a>: Uses <a class="ulink" href="http://hc.apache.org/httpcomponents-client-ga/" target="_top">Apache HttpComponents HttpClient</a> (since Spring 3.1)
</li></ul></div>
<p>If you do not explicitly configure the <code class="literal">request-factory</code> or <code class="literal">rest-template</code> attribute, a default <code class="literal">RestTemplate</code> (which uses a <code class="literal">SimpleClientHttpRequestFactory</code>) is instantiated.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>With some JVM implementations, the handling of timeouts by the <code class="literal">URLConnection</code> class may not be consistent.</p>
<p>For example, from the Java&#8482; Platform, Standard Edition 6 API Specification on <code class="literal">setConnectTimeout</code>:</p>
<div class="blockquote"><blockquote class="blockquote">
<p>Some non-standard implementation of this method may ignore the specified timeout.
To see the connect timeout set, please call getConnectTimeout().</p>
</blockquote></div>
<p>If you have specific needs, you should test your timeouts.
Consider using the <code class="literal">HttpComponentsClientHttpRequestFactory</code>, which, in turn, uses <a class="ulink" href="http://hc.apache.org/httpcomponents-client-ga/" target="_top">Apache HttpComponents HttpClient</a> rather than relying on implementations provided by a JVM.</p>
</td></tr></table></div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>When you use the Apache HttpComponents HttpClient with a pooling connection manager, you should be aware that, by default, the connection manager creates no more than two concurrent connections per given route and no more than 20 connections in total.
For many real-world applications, these limits may prove to be too constraining.
See the <a class="ulink" href="http://hc.apache.org/httpcomponents-client-ga/" target="_top">Apache documentation</a> for information about configuring this important component.</p>
</td></tr></table></div>
<p>The following example configures an HTTP outbound gateway by using a <code class="literal">SimpleClientHttpRequestFactory</code> that is configured with connect and read timeouts of 5 seconds, respectively:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-http:outbound-gateway</span> <span class="hl-attribute">url</span>=<span class="hl-value">"http://www.google.com/ig/api?weather={city}"</span>
                           <span class="hl-attribute">http-method</span>=<span class="hl-value">"GET"</span>
                           <span class="hl-attribute">expected-response-type</span>=<span class="hl-value">"java.lang.String"</span>
                           <span class="hl-attribute">request-factory</span>=<span class="hl-value">"requestFactory"</span>
                           <span class="hl-attribute">request-channel</span>=<span class="hl-value">"requestChannel"</span>
                           <span class="hl-attribute">reply-channel</span>=<span class="hl-value">"replyChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int-http:uri-variable</span> <span class="hl-attribute">name</span>=<span class="hl-value">"city"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"payload"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-http:outbound-gateway&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"requestFactory"</span>
      <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.http.client.SimpleClientHttpRequestFactory"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"connectTimeout"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"5000"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"readTimeout"</span>    <span class="hl-attribute">value</span>=<span class="hl-value">"5000"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
</div>
<p><span class="emphasis"><em>HTTP Outbound Gateway</em></span></p>
<p>For the <span class="emphasis"><em>HTTP Outbound Gateway</em></span>, the XML Schema defines only the <span class="emphasis"><em>reply-timeout</em></span>.
The <span class="emphasis"><em>reply-timeout</em></span> maps to the <span class="emphasis"><em>sendTimeout</em></span> property of the <span class="emphasis"><em>org.springframework.integration.http.outbound.HttpRequestExecutingMessageHandler</em></span> class.
More precisely, the property is set on the extended <code class="literal">AbstractReplyProducingMessageHandler</code> class, which ultimately sets the property on the <code class="literal">MessagingTemplate</code>.</p>
<p>The value of the <span class="emphasis"><em>sendTimeout</em></span> property defaults to "-1" and will be applied to the connected <code class="literal">MessageChannel</code>.
This means, that depending on the implementation, the Message Channel&#8217;s <span class="emphasis"><em>send</em></span> method may block indefinitely.
Furthermore, the <span class="emphasis"><em>sendTimeout</em></span> property is only used, when the actual MessageChannel implementation has a blocking send (such as <span class="emphasis"><em>full</em></span> bounded QueueChannel).</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_http_inbound_gateway" href="#_http_inbound_gateway"></a>20.5.1&nbsp;HTTP Inbound Gateway</h3></div></div></div>

<p>For the HTTP inbound gateway, the XML Schema defines the <code class="literal">request-timeout</code> attribute, which is used to set the <code class="literal">requestTimeout</code> property on the <code class="literal">HttpRequestHandlingMessagingGateway</code> class (on the extended <code class="literal">MessagingGatewaySupport</code> class).
You can also use the <code class="literal">reply-timeout</code> attribute to map to the <code class="literal">replyTimeout</code> property on the same class.</p>
<p>The default for both timeout properties is <code class="literal">1000ms</code> (one thousand milliseconds or one second).
Ultimately, the <code class="literal">request-timeout</code> property is used to set the <code class="literal">sendTimeout</code> on the <code class="literal">MessagingTemplate</code> instance.
The <code class="literal">replyTimeout</code> property, on the other hand, is used to set the <code class="literal">receiveTimeout</code> property on the <code class="literal">MessagingTemplate</code> instance.</p>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>To simulate connection timeouts, you can connect to a non-routable IP address, such as 10.255.255.10.</p>
</td></tr></table></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="http-proxy" href="#http-proxy"></a>20.6&nbsp;HTTP Proxy configuration</h2></div></div></div>

<p>If you are behind a proxy and need to configure proxy settings for HTTP outbound adapters or gateways, you can apply one of two approaches.
In most cases, you can rely on the standard Java system properties that control the proxy settings.
Otherwise, you can explicitly configure a Spring bean for the HTTP client request factory instance.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_standard_java_proxy_configuration" href="#_standard_java_proxy_configuration"></a>20.6.1&nbsp;Standard Java Proxy configuration</h3></div></div></div>

<p>You can set three system properties to configure the proxy settings that are used by the HTTP protocol handler:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">http.proxyHost</code>: The host name of the proxy server.
</li><li class="listitem">
<code class="literal">http.proxyPort</code>: The port number (the default is <code class="literal">80</code>).
</li><li class="listitem">
<code class="literal">http.nonProxyHosts</code>: A list of hosts that should be reached directly, bypassing the proxy.
This is a list of patterns separated by <code class="literal">|</code>.
The patterns may start or end with a <code class="literal">*</code> for wildcards.
Any host that matches one of these patterns is reached through a direct connection instead of through a proxy.
</li></ul></div>
<p>For HTTPS, the following properties are available:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">https.proxyHost</code>: The host name of the proxy server.
</li><li class="listitem">
<code class="literal">https.proxyPort</code>: The port number, the default value being 80.
</li></ul></div>
<p>For more information, see <a class="ulink" href="http://download.oracle.com/javase/6/docs/technotes/guides/net/proxies.html" target="_top">http://download.oracle.com/javase/6/docs/technotes/guides/net/proxies.html</a></p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_spring_s_literal_simpleclienthttprequestfactory_literal" href="#_spring_s_literal_simpleclienthttprequestfactory_literal"></a>20.6.2&nbsp;Spring&#8217;s <code class="literal">SimpleClientHttpRequestFactory</code></h3></div></div></div>

<p>If you need more explicit control over the proxy configuration, you can use Spring&#8217;s <code class="literal">SimpleClientHttpRequestFactory</code> and configure its <span class="emphasis"><em>proxy</em></span> property, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"requestFactory"</span>
    <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.http.client.SimpleClientHttpRequestFactory"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"proxy"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"proxy"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"java.net.Proxy"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;constructor-arg&gt;</span>
                <span class="hl-tag">&lt;util:constant</span> <span class="hl-attribute">static-field</span>=<span class="hl-value">"java.net.Proxy.Type.HTTP"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;/constructor-arg&gt;</span>
            <span class="hl-tag">&lt;constructor-arg&gt;</span>
                <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"java.net.InetSocketAddress"</span><span class="hl-tag">&gt;</span>
                    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"123.0.0.1"</span><span class="hl-tag">/&gt;</span>
                    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"8080"</span><span class="hl-tag">/&gt;</span>
                <span class="hl-tag">&lt;/bean&gt;</span>
            <span class="hl-tag">&lt;/constructor-arg&gt;</span>
        <span class="hl-tag">&lt;/bean&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
</div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="http-header-mapping" href="#http-header-mapping"></a>20.7&nbsp;HTTP Header Mappings</h2></div></div></div>

<p>Spring Integration provides support for HTTP header mapping for both HTTP Request and HTTP Responses.</p>
<p>By default, all standard <a class="ulink" href="http://en.wikipedia.org/wiki/List_of_HTTP_header_fields" target="_top">HTTP headers</a> are mapped from the message to HTTP request or response headers without further configuration.
However, if you do need further customization, you can provide additional configuration by taking advantage of the namespace support.
You can provide a comma-separated list of header names, and you can include simple patterns with the <span class="emphasis"><em>*</em></span> character acting as a wildcard.
Provide such values overrides the default behavior.
Basically, it assumes you are in complete control at that point.
However, if you do want to include all of the standard HTTP headers, you can use the shortcut patterns: <code class="literal">HTTP_REQUEST_HEADERS</code> and <code class="literal">HTTP_RESPONSE_HEADERS</code>.
The following listing shows two examples (the first of which uses a wildcard):</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-http:outbound-gateway</span> <span class="hl-attribute">id</span>=<span class="hl-value">"httpGateway"</span>
    <span class="hl-attribute">url</span>=<span class="hl-value">"http://localhost/test2"</span>
    <span class="hl-attribute">mapped-request-headers</span>=<span class="hl-value">"thing1, thing2"</span>
    <span class="hl-attribute">mapped-response-headers</span>=<span class="hl-value">"X-*, HTTP_RESPONSE_HEADERS"</span>
    <span class="hl-attribute">channel</span>=<span class="hl-value">"someChannel"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int-http:outbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"httpAdapter"</span>
    <span class="hl-attribute">url</span>=<span class="hl-value">"http://localhost/test2"</span>
    <span class="hl-attribute">mapped-request-headers</span>=<span class="hl-value">"thing1, thing2, HTTP_REQUEST_HEADERS"</span>
    <span class="hl-attribute">channel</span>=<span class="hl-value">"someChannel"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>The adapters and gateways use the <code class="literal">DefaultHttpHeaderMapper</code>, which now provides two static factory methods for inbound and outbound adapters so that the proper direction can be applied (mapping HTTP requests and responses either in or out, as appropriate).</p>
<p>If you need further customization, you can also configure a <code class="literal">DefaultHttpHeaderMapper</code> independently and inject it into the adapter through the <code class="literal">header-mapper</code> attribute.</p>
<p>Before version 5.0, the <code class="literal">DefaultHttpHeaderMapper</code> the default prefix for user-defined, non-standard HTTP headers was <code class="literal">X-</code>.
Version 5.0 changed the default prefix to an empty string.
According to <a class="ulink" href="https://tools.ietf.org/html/rfc6648" target="_top">RFC-6648</a>, the use of such prefixes is now discouraged.
You can still customize this option by setting the <code class="literal">DefaultHttpHeaderMapper.setUserDefinedHeaderPrefix()</code> property.
The following example configures a header mapper for an HTTP gateway:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-http:outbound-gateway</span> <span class="hl-attribute">id</span>=<span class="hl-value">"httpGateway"</span>
    <span class="hl-attribute">url</span>=<span class="hl-value">"http://localhost/test2"</span>
    <span class="hl-attribute">header-mapper</span>=<span class="hl-value">"headerMapper"</span>
    <span class="hl-attribute">channel</span>=<span class="hl-value">"someChannel"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"headerMapper"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.http.support.DefaultHttpHeaderMapper"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"inboundHeaderNames"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"thing1*, *thing2, thing3"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"outboundHeaderNames"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"a*b, d"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
</div>
<p>If you need to do something other than what the <code class="literal">DefaultHttpHeaderMapper</code> supports, you can implement the <code class="literal">HeaderMapper</code> strategy interface directly and provide a reference to your implementation.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="int-graph-controller" href="#int-graph-controller"></a>20.8&nbsp;Integration Graph Controller</h2></div></div></div>

<p>Starting with version 4.3, the HTTP module provides an <code class="literal">@EnableIntegrationGraphController</code> configuration class annotation and an <code class="literal">&lt;int-http:graph-controller/&gt;</code> XML element to expose the <code class="literal">IntegrationGraphServer</code> as a REST service.
See <a class="xref" href="#integration-graph" title="12.8&nbsp;Integration Graph">Section&nbsp;12.8, &#8220;Integration Graph&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="http-samples" href="#http-samples"></a>20.9&nbsp;HTTP Samples</h2></div></div></div>

<p>This section wraps up our coverage of Spring Integration&#8217;s HTTP support with a few examples.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="multipart-rest-inbound" href="#multipart-rest-inbound"></a>20.9.1&nbsp;Multipart HTTP Request&#8201;&#8212;&#8201;RestTemplate (Client) and Http Inbound Gateway (Server)</h3></div></div></div>

<p>This example shows how simple it is to send a multipart HTTP request with Spring&#8217;s <code class="literal">RestTemplate</code> and receive it with a Spring Integration HTTP inbound adapter.
We create a <code class="literal">MultiValueMap</code> and populate it with multipart data.
The <code class="literal">RestTemplate</code> takes care of the rest (no pun intended) by converting it to&nbsp;a <code class="literal">MultipartHttpServletRequest</code>.&nbsp;
This particular client sends a multipart HTTP Request that contains the name of the company and an image file (the company logo).
The following listing shows the example:</p>
<div class="informalexample">
<pre class="programlisting">RestTemplate template =&nbsp;<span class="hl-keyword">new</span>&nbsp;RestTemplate();
String uri =&nbsp;<span class="hl-string">"http://localhost:8080/multipart-http/inboundAdapter.htm"</span>;
Resource s2logo =&nbsp;
   <span class="hl-keyword">new</span>&nbsp;ClassPathResource(<span class="hl-string">"org/springframework/samples/multipart/spring09_logo.png"</span>);
MultiValueMap map =&nbsp;<span class="hl-keyword">new</span>&nbsp;LinkedMultiValueMap();
map.add(<span class="hl-string">"company"</span>,&nbsp;<span class="hl-string">"SpringSource"</span>);
map.add(<span class="hl-string">"company-logo"</span>, s2logo);
HttpHeaders headers =&nbsp;<span class="hl-keyword">new</span>&nbsp;HttpHeaders();
headers.setContentType(<span class="hl-keyword">new</span>&nbsp;MediaType(<span class="hl-string">"multipart"</span>,&nbsp;<span class="hl-string">"form-data"</span>));
HttpEntity request =&nbsp;<span class="hl-keyword">new</span>&nbsp;HttpEntity(map, headers);
ResponseEntity&lt;?&gt; httpResponse = template.exchange(uri, HttpMethod.POST, request,&nbsp;null);</pre>
</div>
<p>That is all we need for the client.</p>
<p>On the server side, we have the following configuration:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-http:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"httpInboundAdapter"</span>
    <span class="hl-attribute">channel</span>=<span class="hl-value">"receiveChannel"</span>
    <span class="hl-attribute">path</span>=<span class="hl-value">"/inboundAdapter.htm"</span>
    <span class="hl-attribute">supported-methods</span>=<span class="hl-value">"GET, POST"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"receiveChannel"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int:service-activator</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"receiveChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.samples.multipart.MultipartReceiver"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:service-activator&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"multipartResolver"</span>
    <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.web.multipart.commons.CommonsMultipartResolver"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>The <span class="emphasis"><em>httpInboundAdapter</em></span> receives the request and converts it to a <code class="literal">Message</code> with a payload that is a&nbsp;<code class="literal">LinkedMultiValueMap</code>.
We then parse that in the <span class="emphasis"><em>multipartReceiver</em></span> service-activator, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">void</span> receive(LinkedMultiValueMap&lt;String, Object&gt; multipartRequest){
    System.out.println(<span class="hl-string">"### Successfully received multipart request ###"</span>);
    <span class="hl-keyword">for</span> (String elementName : multipartRequest.keySet()) {
        <span class="hl-keyword">if</span> (elementName.equals(<span class="hl-string">"company"</span>)){
            System.out.println(<span class="hl-string">"\t"</span> + elementName + <span class="hl-string">" - "</span> +
                ((String[]) multipartRequest.getFirst(<span class="hl-string">"company"</span>))[<span class="hl-number">0</span>]);
        }
        <span class="hl-keyword">else</span> <span class="hl-keyword">if</span> (elementName.equals(<span class="hl-string">"company-logo"</span>)){
            System.out.println(<span class="hl-string">"\t"</span> + elementName + <span class="hl-string">" - as UploadedMultipartFile: "</span> +
                ((UploadedMultipartFile) multipartRequest
                    .getFirst(<span class="hl-string">"company-logo"</span>)).getOriginalFilename());
        }
    }
}</pre>
</div>
<p>You should see the following output:</p>
<div class="informalexample">
<pre class="programlisting">### Successfully received multipart request ###
   company - SpringSource
   company-logo - as UploadedMultipartFile: spring09_logo.png</pre>
</div>
</div>
</div>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="jdbc" href="#jdbc"></a>21.&nbsp;JDBC Support</h2></div></div></div>

<p>Spring Integration provides channel adapters for receiving and sending messages by using database queries.
Through those adapters, Spring Integration supports not only plain JDBC SQL queries but also stored procedure and stored function calls.</p>
<p>You need to include this dependency into your project:</p>
<div class="informalexample">
<p>
<b>Maven.&nbsp;</b>

</p><pre class="programlisting"><span class="hl-tag">&lt;dependency&gt;</span>
    <span class="hl-tag">&lt;groupId&gt;</span>org.springframework.integration<span class="hl-tag">&lt;/groupId&gt;</span>
    <span class="hl-tag">&lt;artifactId&gt;</span>spring-integration-jdbc<span class="hl-tag">&lt;/artifactId&gt;</span>
    <span class="hl-tag">&lt;version&gt;</span>5.1.2.RELEASE<span class="hl-tag">&lt;/version&gt;</span>
<span class="hl-tag">&lt;/dependency&gt;</span></pre><p>

</p>
<p>
<b>Gradle.&nbsp;</b>

</p><pre class="programlisting">compile <span class="hl-string">"org.springframework.integration:spring-integration-jdbc:5.1.2.RELEASE"</span></pre><p>

</p>
</div>
<p>By default, the following JDBC components are available:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="#jdbc-inbound-channel-adapter" title="21.1&nbsp;Inbound Channel Adapter">Inbound Channel Adapter</a>
</li><li class="listitem">
<a class="link" href="#jdbc-outbound-channel-adapter" title="21.2&nbsp;Outbound Channel Adapter">Outbound Channel Adapter</a>
</li><li class="listitem">
<a class="link" href="#jdbc-outbound-gateway" title="21.3&nbsp;Outbound Gateway">Outbound Gateway</a>
</li><li class="listitem">
<a class="link" href="#stored-procedure-inbound-channel-adapter" title="21.5.6&nbsp;Stored Procedure Inbound Channel Adapter">Stored Procedure Inbound Channel Adapter</a>
</li><li class="listitem">
<a class="link" href="#stored-procedure-outbound-channel-adapter" title="21.5.7&nbsp;Stored Procedure Outbound Channel Adapter">Stored Procedure Outbound Channel Adapter</a>
</li><li class="listitem">
<a class="link" href="#stored-procedure-outbound-gateway" title="21.5.8&nbsp;Stored Procedure Outbound Gateway">Stored Procedure Outbound Gateway</a>
</li></ul></div>
<p>The Spring Integration JDBC Module also provides a <a class="link" href="#jdbc-message-store" title="21.4&nbsp;JDBC Message Store">JDBC Message Store</a>.</p>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jdbc-inbound-channel-adapter" href="#jdbc-inbound-channel-adapter"></a>21.1&nbsp;Inbound Channel Adapter</h2></div></div></div>

<p>The main function of an inbound channel adapter is to execute a SQL <code class="literal">SELECT</code> query and turn the result set into a message.
The message payload is the whole result set (expressed as a <code class="literal">List</code>), and the types of the items in the list depend on the row-mapping strategy.
The default strategy is a generic mapper that returns a <code class="literal">Map</code> for each row in the query result.
Optionally, you can change this by adding a reference to a <code class="literal">RowMapper</code> instance (see the <a class="ulink" href="https://docs.spring.io/spring/docs/current/spring-framework-reference/html/jdbc.html" target="_top">Spring JDBC</a> documentation for more detailed information about row mapping).</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>If you want to convert rows in the <code class="literal">SELECT</code> query result to individual messages, you can use a downstream splitter.</p>
</td></tr></table></div>
<p>The inbound adapter also requires a reference to either a <code class="literal">JdbcTemplate</code> instance or a <code class="literal">DataSource</code>.</p>
<p>As well as the <code class="literal">SELECT</code> statement to generate the messages, the adapter also has an <code class="literal">UPDATE</code> statement that marks the records as processed so that they do not show up in the next poll.
The update can be parameterized by the list of IDs from the original select.
By default, this is done through a naming convention (a column in the input result set called <code class="literal">id</code> is translated into a list in the parameter map for the update called <code class="literal">id</code>).
The following example defines an inbound channel adapter with an update query and a <code class="literal">DataSource</code> reference.</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-jdbc:inbound-channel-adapter</span> <span class="hl-attribute">query</span>=<span class="hl-value">"select * from item where status=2"</span>
    <span class="hl-attribute">channel</span>=<span class="hl-value">"target"</span> <span class="hl-attribute">data-source</span>=<span class="hl-value">"dataSource"</span>
    <span class="hl-attribute">update</span>=<span class="hl-value">"update item set status=10 where id in (:id)"</span><span class="hl-tag"> /&gt;</span></pre>
</div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The parameters in the update query are specified with a colon (<code class="literal">:</code>) prefix to the name of a parameter (which, in the preceding example, is an expression to be applied to each of the rows in the polled result set).
This is a standard feature of the named parameter JDBC support in Spring JDBC, combined with a convention (projection onto the polled result list) adopted in Spring Integration.
The underlying Spring JDBC features limit the available expressions (for example, most special characters other than a period are disallowed), but since the target is usually a list of objects (possibly a list of one) that are addressable by bean paths this is not unduly restrictive.</p>
</td></tr></table></div>
<p>To change the parameter generation strategy, you can inject a <code class="literal">SqlParameterSourceFactory</code> into the adapter to override the default behavior (the adapter has a <code class="literal">sql-parameter-source-factory</code> attribute).
Spring Integration provides <code class="literal">ExpressionEvaluatingSqlParameterSourceFactory</code>, which creates a SpEL-based parameter source, with the results of the query as the <code class="literal">#root</code> object.
(If <code class="literal">update-per-row</code> is true, the root object is the row).
If the same parameter name appears multiple times in the update query, it is evaluated only once, and its result is cached.</p>
<p>You can also use a parameter source for the select query.
In this case, since there is no "<code class="literal">result</code>" object to evaluate against, a single parameter source is used each time (rather than using a parameter source factory).
Starting with version 4.0, you can use Spring to create a SpEL based parameter source, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-jdbc:inbound-channel-adapter</span> <span class="hl-attribute">query</span>=<span class="hl-value">"select * from item where status=:status"</span>
	<span class="hl-attribute">channel</span>=<span class="hl-value">"target"</span> <span class="hl-attribute">data-source</span>=<span class="hl-value">"dataSource"</span>
	<span class="hl-attribute">select-sql-parameter-source</span>=<span class="hl-value">"parameterSource"</span><span class="hl-tag"> /&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"parameterSource"</span> <span class="hl-attribute">factory-bean</span>=<span class="hl-value">"parameterSourceFactory"</span>
			<span class="hl-attribute">factory-method</span>=<span class="hl-value">"createParameterSourceNoCache"</span><span class="hl-tag">&gt;</span>
	<span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">""</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"parameterSourceFactory"</span>
		<span class="hl-attribute">class</span>=<span class="hl-value">"o.s.integration.jdbc.ExpressionEvaluatingSqlParameterSourceFactory"</span><span class="hl-tag">&gt;</span>
	<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"parameterExpressions"</span><span class="hl-tag">&gt;</span>
		<span class="hl-tag">&lt;map&gt;</span>
			<span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"status"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"@statusBean.which()"</span><span class="hl-tag"> /&gt;</span>
		<span class="hl-tag">&lt;/map&gt;</span>
	<span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"statusBean"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"foo.StatusDetermination"</span><span class="hl-tag"> /&gt;</span></pre>
</div>
<p>The <code class="literal">value</code> in each parameter expression can be any valid SpEL expression.
The <code class="literal">#root</code> object for the expression evaluation is the constructor argument defined on the <code class="literal">parameterSource</code> bean.
It is static for all evaluations (in the preceding example, an empty <code class="literal">String</code>).</p>
<p>Starting with version 5.0, you ca supply <code class="literal">ExpressionEvaluatingSqlParameterSourceFactory</code> with <code class="literal">sqlParameterTypes</code> to specify the target SQL type for the particular parameter.</p>
<p>The following example provides SQL types for the parameters being used in the query:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-jdbc:inbound-channel-adapter</span> <span class="hl-attribute">query</span>=<span class="hl-value">"select * from item where status=:status"</span>
    <span class="hl-attribute">channel</span>=<span class="hl-value">"target"</span> <span class="hl-attribute">data-source</span>=<span class="hl-value">"dataSource"</span>
    <span class="hl-attribute">select-sql-parameter-source</span>=<span class="hl-value">"parameterSource"</span><span class="hl-tag"> /&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"parameterSource"</span> <span class="hl-attribute">factory-bean</span>=<span class="hl-value">"parameterSourceFactory"</span>
            <span class="hl-attribute">factory-method</span>=<span class="hl-value">"createParameterSourceNoCache"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">""</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"parameterSourceFactory"</span>
        <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.integration.jdbc.ExpressionEvaluatingSqlParameterSourceFactory"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"sqlParameterTypes"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;map&gt;</span>
            <span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"status"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"#{ T(java.sql.Types).BINARY}"</span><span class="hl-tag"> /&gt;</span>
        <span class="hl-tag">&lt;/map&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
</div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Use the <code class="literal">createParameterSourceNoCache</code> factory method.
Otherwise, the parameter source caches the result of the evaluation.
Also note that, because caching is disabled, if the same parameter name appears in the select query multiple times, it is re-evaluated for each occurrence.</p>
</td></tr></table></div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jdbc-polling-transactions" href="#jdbc-polling-transactions"></a>21.1.1&nbsp;Polling and Transactions</h3></div></div></div>

<p>The inbound adapter accepts a regular Spring Integration poller as a child element.
Consequently, the frequency of the polling can be controlled (among other uses).
An important feature of the poller for JDBC usage is the option to wrap the poll operation in a transaction, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-jdbc:inbound-channel-adapter</span> <span class="hl-attribute">query</span>=<span class="hl-value">"..."</span>
        <span class="hl-attribute">channel</span>=<span class="hl-value">"target"</span> <span class="hl-attribute">data-source</span>=<span class="hl-value">"dataSource"</span> <span class="hl-attribute">update</span>=<span class="hl-value">"..."</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"1000"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;int:transactional/&gt;</span>
    <span class="hl-tag">&lt;/int:poller&gt;</span>
<span class="hl-tag">&lt;/int-jdbc:inbound-channel-adapter&gt;</span></pre>
</div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>If you do not explicitly specify a poller, a default value is used.
As is normal with Spring Integration, it can be defined as a top-level bean).</p>
</td></tr></table></div>
<p>In the preceding example, the database is polled every 1000 milliseconds (or once a second), and the update and select queries are both executed in the same transaction.
The transaction manager configuration is not shown.
However, as long as it is aware of the data source,  the poll is transactional.
A common use case is for the downstream channels to be direct channels (the default), so that the endpoints are invoked in the same thread and, hence, the same transaction.
That way, if any of them fail, the transaction rolls back and the input data is reverted to its original state.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jdbc-max-rows-versus-max-messages-per-poll" href="#jdbc-max-rows-versus-max-messages-per-poll"></a>21.1.2&nbsp;<code class="literal">max-rows</code> Versus <code class="literal">max-messages-per-poll</code></h3></div></div></div>

<p>The JDBC inbound channel adapter defines an attribute called <code class="literal">max-rows</code>.
When you specify the adapter&#8217;s poller, you can also define a property called <code class="literal">max-messages-per-poll</code>.
While these two attributes look similar, their meaning is quite different.</p>
<p><code class="literal">max-messages-per-poll</code> specifies the number of times the query is executed per polling interval, whereas <code class="literal">max-rows</code> specifies the number of rows returned for each execution.</p>
<p>Under normal circumstances, you would likely not want to set the poller&#8217;s <code class="literal">max-messages-per-poll</code> property when you use the JDBC inbound channel adapter.
Its default value is <code class="literal">1</code>, which means that the JDBC inbound channel adapter&#8217;s <a class="ulink" href="https://docs.spring.io/spring-integration/api/org/springframework/integration/jdbc/JdbcPollingChannelAdapter.html#receive()" target="_top"><code class="literal">receive()</code></a> method is executed exactly once for each poll interval.</p>
<p>Setting the <code class="literal">max-messages-per-poll</code> attribute to a larger value means that the query is executed that many times back to back.
For more information regarding the <code class="literal">max-messages-per-poll</code> attribute, see <a class="xref" href="#channel-adapter-namespace-inbound" title="6.3.1&nbsp;Configuring An Inbound Channel Adapter">Section&nbsp;6.3.1, &#8220;Configuring An Inbound Channel Adapter&#8221;</a>.</p>
<p>In contrast, the <code class="literal">max-rows</code> attribute, if greater than <code class="literal">0</code>, specifies the maximum number of rows to be used from the query result set created by the <code class="literal">receive()</code> method.
If the attribute is set to <code class="literal">0</code>, all rows are included in the resulting message.
The attribute defaults to <code class="literal">0</code>.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>It is recommended to use result set limiting via vendor-specific query options, for example MySQL <code class="literal">LIMIT</code> or SQL Server <code class="literal">TOP</code> or Oracle&#8217;s <code class="literal">ROWNUM</code>.
See the particular vendor documentation for more information.</p>
</td></tr></table></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jdbc-outbound-channel-adapter" href="#jdbc-outbound-channel-adapter"></a>21.2&nbsp;Outbound Channel Adapter</h2></div></div></div>

<p>The outbound channel adapter is the inverse of the inbound: its role is to handle a message and use it to execute a SQL query.
By default, the message payload and headers are available as input parameters to the query, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-jdbc:outbound-channel-adapter</span>
    <span class="hl-attribute">query</span>=<span class="hl-value">"insert into foos (id, status, name) values (:headers[id], 0, :payload[something])"</span>
    <span class="hl-attribute">data-source</span>=<span class="hl-value">"dataSource"</span>
    <span class="hl-attribute">channel</span>=<span class="hl-value">"input"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>In the preceding example, messages arriving on the channel labelled <code class="literal">input</code> have a payload of a map with a key of <code class="literal">something</code>, so the <code class="literal">[]</code> operator dereferences that value from the map.
The headers are also accessed as a map.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The parameters in the preceding query are bean property expressions on the incoming message (not SpEL expressions).
This behavior is part of the <code class="literal">SqlParameterSource</code>, which is the default source created by the outbound adapter.
You can inject a different <code class="literal">SqlParameterSourceFactory</code> to get different behavior.</p>
</td></tr></table></div>
<p>The outbound adapter requires a reference to either a <code class="literal">DataSource</code> or a <code class="literal">JdbcTemplate</code>.
You can also inject a <code class="literal">SqlParameterSourceFactory</code> to control the binding of each incoming message to a query.</p>
<p>If the input channel is a direct channel, the outbound adapter runs its query in the same thread and, therefore, the same transaction (if there is one) as the sender of the message.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_passing_parameters_by_using_spel_expressions" href="#_passing_parameters_by_using_spel_expressions"></a>21.2.1&nbsp;Passing Parameters by Using SpEL Expressions</h3></div></div></div>

<p>A common requirement for most JDBC channel adapters is to pass parameters as part of SQL queries or stored procedures or functions.
As mentioned earlier, these parameters are by default bean property expressions, not SpEL expressions.
However, if you need to pass SpEL expression as parameters, you must explicitly inject a <code class="literal">SqlParameterSourceFactory</code>.</p>
<p>The following example uses a <code class="literal">ExpressionEvaluatingSqlParameterSourceFactory</code> to achieve that requirement:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;jdbc:outbound-channel-adapter</span> <span class="hl-attribute">data-source</span>=<span class="hl-value">"dataSource"</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"input"</span>
    <span class="hl-attribute">query</span>=<span class="hl-value">"insert into MESSAGES (MESSAGE_ID,PAYLOAD,CREATED_DATE)     \
    values (:id, :payload, :createdDate)"</span>
    <span class="hl-attribute">sql-parameter-source-factory</span>=<span class="hl-value">"spelSource"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"spelSource"</span>
      <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.integration.jdbc.ExpressionEvaluatingSqlParameterSourceFactory"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"parameterExpressions"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;map&gt;</span>
            <span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"id"</span>          <span class="hl-attribute">value</span>=<span class="hl-value">"headers['id'].toString()"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"createdDate"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"new java.util.Date()"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"payload"</span>     <span class="hl-attribute">value</span>=<span class="hl-value">"payload"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/map&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
</div>
<p>For further information, see <a class="xref" href="#sp-defining-parameter-sources" title="21.5.5&nbsp;Defining Parameter Sources">Section&nbsp;21.5.5, &#8220;Defining Parameter Sources&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_using_the_literal_preparedstatement_literal_callback" href="#_using_the_literal_preparedstatement_literal_callback"></a>21.2.2&nbsp;Using the <code class="literal">PreparedStatement</code> Callback</h3></div></div></div>

<p>Sometimes, the flexibility and loose-coupling of <code class="literal">SqlParameterSourceFactory</code> does not do what we need for the target <code class="literal">PreparedStatement</code> or we need to do some low-level JDBC work.
The Spring JDBC module provides APIs to configure the execution environment (such as <code class="literal">ConnectionCallback</code> or <code class="literal">PreparedStatementCreator</code>) and manipulate parameter values (such as <code class="literal">SqlParameterSource</code>).
It can even access APIs for low-level operations, such as <code class="literal">StatementCallback</code>.</p>
<p>Starting with Spring Integration 4.2, <code class="literal">MessagePreparedStatementSetter</code> allows the specification of parameters on the <code class="literal">PreparedStatement</code> manually, in the <code class="literal">requestMessage</code> context.
This class plays exactly the same role as <code class="literal">PreparedStatementSetter</code> in the standard Spring JDBC API.
Actually, it is invoked directly from an inline <code class="literal">PreparedStatementSetter</code> implementation when the <code class="literal">JdbcMessageHandler</code> invokes <code class="literal">execute</code> on the <code class="literal">JdbcTemplate</code>.</p>
<p>This functional interface option is mutually exclusive with <code class="literal">sqlParameterSourceFactory</code> and can be used as a more powerful alternative to populate parameters of the <code class="literal">PreparedStatement</code> from the <code class="literal">requestMessage</code>.
For example, it is useful when we need to store <code class="literal">File</code> data to the DataBase <code class="literal">BLOB</code> column in a streaming manner.
The following example shows how to do so:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "storeFileChannel")</span></em>
<span class="hl-keyword">public</span> MessageHandler jdbcMessageHandler(DataSource dataSource) {
    JdbcMessageHandler jdbcMessageHandler = <span class="hl-keyword">new</span> JdbcMessageHandler(dataSource,
            <span class="hl-string">"INSERT INTO imagedb (image_name, content, description) VALUES (?, ?, ?)"</span>);
    jdbcMessageHandler.setPreparedStatementSetter((ps, m) -&gt; {
        ps.setString(<span class="hl-number">1</span>, m.getHeaders().get(FileHeaders.FILENAME));
        <span class="hl-keyword">try</span> (FileInputStream inputStream = <span class="hl-keyword">new</span> FileInputStream((File) m.getPayload()); ) {
            ps.setBlob(<span class="hl-number">2</span>, inputStream);
        }
        <span class="hl-keyword">catch</span> (Exception e) {
            <span class="hl-keyword">throw</span> <span class="hl-keyword">new</span> MessageHandlingException(m, e);
        }
        ps.setClob(<span class="hl-number">3</span>, <span class="hl-keyword">new</span> StringReader(m.getHeaders().get(<span class="hl-string">"description"</span>, String.<span class="hl-keyword">class</span>)));
    });
    <span class="hl-keyword">return</span> jdbcMessageHandler;
}</pre>
</div>
<p>From the XML configuration perspective, the <code class="literal">prepared-statement-setter</code> attribute is available on the <code class="literal">&lt;int-jdbc:outbound-channel-adapter&gt;</code> component.
It lets you specify a <code class="literal">MessagePreparedStatementSetter</code> bean reference.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_batch_update" href="#_batch_update"></a>21.2.3&nbsp;Batch Update</h3></div></div></div>

<p>Starting with version 5.1, the <code class="literal">JdbcMessageHandler</code> performs a <code class="literal">JdbcOperations.batchUpdate()</code> if the payload of the request message is an <code class="literal">Iterable</code> instance.
Each element of the <code class="literal">Iterable</code> is wrapped to a <code class="literal">Message</code> with the headers from the request message.
In the case of regular <code class="literal">SqlParameterSourceFactory</code>-based configuration these messages are used to build an <code class="literal">SqlParameterSource[]</code> for an argument used in the mentioned <code class="literal">JdbcOperations.batchUpdate()</code> function.
When a <code class="literal">MessagePreparedStatementSetter</code> configuration is applied, a <code class="literal">BatchPreparedStatementSetter</code> variant is used to iterate over those messages for each item and the provided <code class="literal">MessagePreparedStatementSetter</code> is called against them.
The batch update is not supported when <code class="literal">keysGenerated</code> mode is selected.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jdbc-outbound-gateway" href="#jdbc-outbound-gateway"></a>21.3&nbsp;Outbound Gateway</h2></div></div></div>

<p>The outbound gateway is like a combination of the outbound and inbound adapters: Its role is to handle a message and use it to execute a SQL query and then respond with the result by sending it to a reply channel.
By default, the message payload and headers are available as input parameters to the query, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-jdbc:outbound-gateway</span>
    <span class="hl-attribute">update</span>=<span class="hl-value">"insert into mythings (id, status, name) values (:headers[id], 0, :payload[thing])"</span>
    <span class="hl-attribute">request-channel</span>=<span class="hl-value">"input"</span> <span class="hl-attribute">reply-channel</span>=<span class="hl-value">"output"</span> <span class="hl-attribute">data-source</span>=<span class="hl-value">"dataSource"</span><span class="hl-tag"> /&gt;</span></pre>
</div>
<p>The result of the preceding example is to insert a record into the <code class="literal">mythings</code> table and return a message that indicates the number of rows affected (the payload is a map: <code class="literal">{UPDATED=1}</code>) to the output channel .</p>
<p>If the update query is an insert with auto-generated keys, you can populate the reply message with the generated keys by adding <code class="literal">keys-generated="true"</code> to the preceding example (this is not the default because it is not supported by some database platforms).
The following example shows the changed configuration:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-jdbc:outbound-gateway</span>
    <span class="hl-attribute">update</span>=<span class="hl-value">"insert into mythings (status, name) values (0, :payload[thing])"</span>
    <span class="hl-attribute">request-channel</span>=<span class="hl-value">"input"</span> <span class="hl-attribute">reply-channel</span>=<span class="hl-value">"output"</span> <span class="hl-attribute">data-source</span>=<span class="hl-value">"dataSource"</span>
    <span class="hl-attribute">keys-generated</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>Instead of the update count or the generated keys, you can also provide a select query to execute and generate a reply message from the result (such as the inbound adapter), as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-jdbc:outbound-gateway</span>
    <span class="hl-attribute">update</span>=<span class="hl-value">"insert into foos (id, status, name) values (:headers[id], 0, :payload[foo])"</span>
    <span class="hl-attribute">query</span>=<span class="hl-value">"select * from foos where id=:headers[$id]"</span>
    <span class="hl-attribute">request-channel</span>=<span class="hl-value">"input"</span> <span class="hl-attribute">reply-channel</span>=<span class="hl-value">"output"</span> <span class="hl-attribute">data-source</span>=<span class="hl-value">"dataSource"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>Since Spring Integration 2.2, the update SQL query is no longer mandatory.
You can now provide only a select query, by using either the <code class="literal">query</code> attribute or the <code class="literal">query</code> element.
This is extremely useful if you need to actively retrieve data by using, for example, a generic gateway or a payload enricher.
The reply message is then generated from the result (similar to how the inbound adapter works) and passed to the reply channel.
The following example show to use the <code class="literal">query</code> attribute:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-jdbc:outbound-gateway</span>
    <span class="hl-attribute">query</span>=<span class="hl-value">"select * from foos where id=:headers[id]"</span>
    <span class="hl-attribute">request-channel</span>=<span class="hl-value">"input"</span>
    <span class="hl-attribute">reply-channel</span>=<span class="hl-value">"output"</span>
    <span class="hl-attribute">data-source</span>=<span class="hl-value">"dataSource"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>By default, the component for the <code class="literal">SELECT</code> query returns only one (the first) row from the cursor.
You can adjust this behavior with the <code class="literal">max-rows</code> option.
If you need to return all the rows from the SELECT, consider specifying <code class="literal">max-rows="0"</code>.</p>
</td></tr></table></div>
<p>As with the channel adapters, you can also provide <code class="literal">SqlParameterSourceFactory</code> instances for request and reply.
The default is the same as for the outbound adapter, so the request message is available as the root of an expression.
If <code class="literal">keys-generated="true"</code>, the root of the expression is the generated keys (a map if there is only one or a list of maps if multi-valued).</p>
<p>The outbound gateway requires a reference to either a <code class="literal">DataSource</code> or a <code class="literal">JdbcTemplate</code>.
It can also have a <code class="literal">SqlParameterSourceFactory</code> injected to control the binding of the incoming message to the query.</p>
<p>Starting with the version 4.2, the <code class="literal">request-prepared-statement-setter</code> attribute is available on the <code class="literal">&lt;int-jdbc:outbound-gateway&gt;</code> as an alternative to <code class="literal">request-sql-parameter-source-factory</code>.
It lets you specify a <code class="literal">MessagePreparedStatementSetter</code> bean reference, which implements more sophisticated <code class="literal">PreparedStatement</code> preparation before its execution.</p>
<p>See <a class="xref" href="#jdbc-outbound-channel-adapter" title="21.2&nbsp;Outbound Channel Adapter">Section&nbsp;21.2, &#8220;Outbound Channel Adapter&#8221;</a> for more information about <code class="literal">MessagePreparedStatementSetter</code>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jdbc-message-store" href="#jdbc-message-store"></a>21.4&nbsp;JDBC Message Store</h2></div></div></div>

<p>Spring Integration provides two JDBC specific message store implementations.
The <code class="literal">JdbcMessageStore</code> is suitable for use with aggregators and the claim check pattern.
The <code class="literal">JdbcChannelMessageStore</code> implementation provides a more targeted and scalable implementation specifically for message channel.</p>
<p>Note that you can use a <code class="literal">JdbcMessageStore</code> to back a message channel, <code class="literal">JdbcChannelMessageStore</code> is optimized for that purpose.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Starting with versions 5.0.11, 5.1.2, the indexes for the <code class="literal">JdbcChannelMessageStore</code> have been optimized.
If you have large message groups in such a store, you may wish to alter the indexes.
Furthermore, the index for <code class="literal">PriorityChannel</code> is commented out because it is not needed unless you are using such channels backed by JDBC.</p>
</td></tr></table></div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>When using the <code class="literal">OracleChannelMessageStoreQueryProvider</code>, the priority channel index <span class="strong"><strong>must</strong></span> be added because it is included in a hint in the query.</p>
</td></tr></table></div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_initializing_the_database" href="#_initializing_the_database"></a>21.4.1&nbsp;Initializing the Database</h3></div></div></div>

<p>Before starting to use JDBC message store components, you should provision a target database with the appropriate objects.</p>
<p>Spring Integration ships with some sample scripts that can be used to initialize a database.
In the <code class="literal">spring-integration-jdbc</code> JAR file, you can find scripts in the <code class="literal">org.springframework.integration.jdbc</code> package.
It provides an example create and an example drop script for a range of common database platforms.
A common way to use these scripts is to reference them in a <a class="ulink" href="https://docs.spring.io/spring/docs/current/spring-framework-reference/html/jdbc.html#jdbc-intializing-datasource" target="_top">Spring JDBC data source initializer</a>.
Note that the scripts are provided as samples and as specifications of the the required table and column names.
You may find that you need to enhance them for production use (for, example, by adding index declarations).</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jdbc-message-store-generic" href="#jdbc-message-store-generic"></a>21.4.2&nbsp;The Generic JDBC Message Store</h3></div></div></div>

<p>The JDBC module provides an implementation of the Spring Integration <code class="literal">MessageStore</code> (important in the claim check pattern) and <code class="literal">MessageGroupStore</code> (important in stateful patterns such as an aggregator) backed by a database.
Both interfaces are implemented by the <code class="literal">JdbcMessageStore</code>, and there is support for configuring store instances in XML, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-jdbc:message-store</span> <span class="hl-attribute">id</span>=<span class="hl-value">"messageStore"</span> <span class="hl-attribute">data-source</span>=<span class="hl-value">"dataSource"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>You can specify a <code class="literal">JdbcTemplate</code> instead of a <code class="literal">DataSource</code>.</p>
<p>The following example shows some other optional attributes:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-jdbc:message-store</span> <span class="hl-attribute">id</span>=<span class="hl-value">"messageStore"</span> <span class="hl-attribute">data-source</span>=<span class="hl-value">"dataSource"</span>
    <span class="hl-attribute">lob-handler</span>=<span class="hl-value">"lobHandler"</span> <span class="hl-attribute">table-prefix</span>=<span class="hl-value">"MY_INT_"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>In the preceding example, we have specified a <code class="literal">LobHandler</code> for dealing with messages as large objects (which is often necessary for Oracle) and a prefix for the table names in the queries generated by the store.
The table name prefix defaults to <code class="literal">INT_</code>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jdbc-message-store-channels" href="#jdbc-message-store-channels"></a>21.4.3&nbsp;Backing Message Channels</h3></div></div></div>

<p>If you intend to backing message channels with JDBC, we recommend using the <code class="literal">JdbcChannelMessageStore</code> implementation.
It works only in conjunction with Message Channels.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_supported_databases" href="#_supported_databases"></a>Supported Databases</h4></div></div></div>

<p>The <code class="literal">JdbcChannelMessageStore</code> uses database-specific SQL queries to retrieve messages from the database.
Therefore, you must set the <code class="literal">ChannelMessageStoreQueryProvider</code> property on the <code class="literal">JdbcChannelMessageStore</code>.
This <code class="literal">channelMessageStoreQueryProvider</code> provides the SQL queries for the particular database you specify.
Spring Integration provides support for the following relational databases:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
PostgreSQL
</li><li class="listitem">
HSQLDB
</li><li class="listitem">
MySQL
</li><li class="listitem">
Oracle
</li><li class="listitem">
Derby
</li><li class="listitem">
H2
</li><li class="listitem">
SqlServer
</li><li class="listitem">
Sybase
</li><li class="listitem">
DB2
</li></ul></div>
<p>If your database is not listed, you can extend the <code class="literal">AbstractChannelMessageStoreQueryProvider</code> class and provide your own custom queries.</p>
<p>Version 4.0 added the <code class="literal">MESSAGE_SEQUENCE</code> column to the table to ensure first-in-first-out (FIFO) queueing even when messages are stored in the same millisecond.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_custom_message_insertion" href="#_custom_message_insertion"></a>Custom Message Insertion</h4></div></div></div>

<p>Since version 5.0, by overloading the <code class="literal">ChannelMessageStorePreparedStatementSetter</code> class, you can provide a custom implementation for message insertion in the <code class="literal">JdbcChannelMessageStore</code>.
You can use it to set different columns or change the table structure or serialization strategy.
For example, instead of default serialization to <code class="literal">byte[]</code>, you can store its structure as a JSON string.</p>
<p>The following example uses the default implementation of <code class="literal">setValues</code> to store common columns and overrides the behavior to store the message payload as a <code class="literal">varchar</code>:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> JsonPreparedStatementSetter <span class="hl-keyword">extends</span> ChannelMessageStorePreparedStatementSetter {

    <span class="hl-keyword">public</span> JsonPreparedStatementSetter() {
        <span class="hl-keyword">super</span>();
    }

    <em><span class="hl-annotation" style="color: gray">@Override</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setValues(PreparedStatement preparedStatement, Message&lt;?&gt; requestMessage,
        Object groupId, String region, 	<span class="hl-keyword">boolean</span> priorityEnabled) <span class="hl-keyword">throws</span> SQLException {
        <span class="hl-comment">// Populate common columns</span>
        <span class="hl-keyword">super</span>.setValues(preparedStatement, requestMessage, groupId, region, priorityEnabled);
        <span class="hl-comment">// Store message payload as varchar</span>
        preparedStatement.setString(<span class="hl-number">6</span>, requestMessage.getPayload().toString());
    }
}</pre>
</div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Generally, we do not recommend using a relational database for queuing.
Instead, if possible, consider using either JMS- or AMQP-backed channels instead.
For further reference, see the following resources:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="ulink" href="https://www.engineyard.com/blog/2011/5-subtle-ways-youre-using-mysql-as-a-queue-and-why-itll-bite-you/" target="_top">5 subtle ways you&#8217;re using MySQL as a queue, and why it&#8217;ll bite you</a>.
</li><li class="listitem">
<a class="ulink" href="https://mikehadlow.blogspot.com/2012/04/database-as-queue-anti-pattern.html" target="_top">The Database As Queue Anti-Pattern</a>.
</li></ul></div>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_concurrent_polling" href="#_concurrent_polling"></a>Concurrent Polling</h4></div></div></div>

<p>When polling a message channel, you have the option to configure the associated <code class="literal">Poller</code> with a <code class="literal">TaskExecutor</code> reference.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Keep in mind, though, that if you use a JDBC backed message channel and you plan to poll the channel and consequently the message store transactionally with multiple threads, you should ensure that you use a relational database that supports <a class="ulink" href="https://en.wikipedia.org/wiki/Multiversion_concurrency_control" target="_top">Multiversion Concurrency Control</a> (MVCC).
Otherwise, locking may be an issue and the performance, when using multiple threads, may not materialize as expected.
For example, Apache Derby is problematic in that regard.</p>
<p>To achieve better JDBC queue throughput and avoid issues when different threads may poll the same <code class="literal">Message</code> from the queue, it is <span class="strong"><strong>important</strong></span> to set the <code class="literal">usingIdCache</code> property of <code class="literal">JdbcChannelMessageStore</code> to <code class="literal">true</code> when using databases that do not support MVCC.
The following example shows how to do so:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"queryProvider"</span>
    <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.jdbc.store.channel.PostgresChannelMessageStoreQueryProvider"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int:transaction-synchronization-factory</span> <span class="hl-attribute">id</span>=<span class="hl-value">"syncFactory"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:after-commit</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"@store.removeFromIdCache(headers.id.toString())"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;int:after-rollback</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"@store.removeFromIdCache(headers.id.toString())"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:transaction-synchronization-factory&gt;</span>

<span class="hl-tag">&lt;task:executor</span> <span class="hl-attribute">id</span>=<span class="hl-value">"pool"</span> <span class="hl-attribute">pool-size</span>=<span class="hl-value">"10"</span>
    <span class="hl-attribute">queue-capacity</span>=<span class="hl-value">"10"</span> <span class="hl-attribute">rejection-policy</span>=<span class="hl-value">"CALLER_RUNS"</span><span class="hl-tag"> /&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"store"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.jdbc.store.JdbcChannelMessageStore"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"dataSource"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"dataSource"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"channelMessageStoreQueryProvider"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"queryProvider"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"region"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"TX_TIMEOUT"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"usingIdCache"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"inputChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:queue</span> <span class="hl-attribute">message-store</span>=<span class="hl-value">"store"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:channel&gt;</span>

<span class="hl-tag">&lt;int:bridge</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"inputChannel"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"outputChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">fixed-delay</span>=<span class="hl-value">"500"</span> <span class="hl-attribute">receive-timeout</span>=<span class="hl-value">"500"</span>
        <span class="hl-attribute">max-messages-per-poll</span>=<span class="hl-value">"1"</span> <span class="hl-attribute">task-executor</span>=<span class="hl-value">"pool"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;int:transactional</span> <span class="hl-attribute">propagation</span>=<span class="hl-value">"REQUIRED"</span> <span class="hl-attribute">synchronization-factory</span>=<span class="hl-value">"syncFactory"</span>
        <span class="hl-attribute">isolation</span>=<span class="hl-value">"READ_COMMITTED"</span> <span class="hl-attribute">transaction-manager</span>=<span class="hl-value">"transactionManager"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;/int:poller&gt;</span>
<span class="hl-tag">&lt;/int:bridge&gt;</span>

<span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"outputChannel"</span><span class="hl-tag"> /&gt;</span></pre>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_priority_channel" href="#_priority_channel"></a>Priority Channel</h4></div></div></div>

<p>Starting with version 4.0, <code class="literal">JdbcChannelMessageStore</code> implements <code class="literal">PriorityCapableChannelMessageStore</code> and provides the <code class="literal">priorityEnabled</code> option, letting it be used as a <code class="literal">message-store</code> reference for <code class="literal">priority-queue</code> instances.
For this purpose, the <code class="literal">INT_CHANNEL_MESSAGE</code> table has a <code class="literal">MESSAGE_PRIORITY</code> column to store the value of <code class="literal">PRIORITY</code> message headers.
In addition, a new <code class="literal">MESSAGE_SEQUENCE</code> column lets us achieve a robust first-in-first-out (FIFO) polling mechanism, even when multiple messages are stored with the same priority in the same millisecond.
Messages are polled (selected) from the database with <code class="literal">order by MESSAGE_PRIORITY DESC NULLS LAST, CREATED_DATE, MESSAGE_SEQUENCE</code>.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>We do not recommend using the same <code class="literal">JdbcChannelMessageStore</code> bean for priority and non-priority queue channels, because the <code class="literal">priorityEnabled</code> option applies to the entire store and proper FIFO queue semantics are not retained for the queue channel.
However, the same <code class="literal">INT_CHANNEL_MESSAGE</code> table (and even <code class="literal">region</code>) can be used for both <code class="literal">JdbcChannelMessageStore</code> types.
To configure that scenario, you can extend one message store bean from the other, as the following example shows:</p>
</td></tr></table></div>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"channelStore"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.jdbc.store.JdbcChannelMessageStore"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"dataSource"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"dataSource"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"channelMessageStoreQueryProvider"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"queryProvider"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"queueChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:queue</span> <span class="hl-attribute">message-store</span>=<span class="hl-value">"channelStore"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:channel&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"priorityStore"</span> <span class="hl-attribute">parent</span>=<span class="hl-value">"channelStore"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"priorityEnabled"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"priorityChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:priority-queue</span> <span class="hl-attribute">message-store</span>=<span class="hl-value">"priorityStore"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:channel&gt;</span></pre>
</div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_partitioning_a_message_store" href="#_partitioning_a_message_store"></a>21.4.4&nbsp;Partitioning a Message Store</h3></div></div></div>

<p>It is common to use a <code class="literal">JdbcMessageStore</code> as a global store for a group of applications or nodes in the same application.
To provide some protection against name clashes and to give control over the database meta-data configuration, the message store lets the tables be partitioned in two ways.
One way is to use separate table names, by changing the prefix (as <a class="link" href="#jdbc-message-store-generic" title="21.4.2&nbsp;The Generic JDBC Message Store">described earlier</a>).
The other way is to specify a <code class="literal">region</code> name for partitioning data within a single table.
An important use case for the second approach is when the <code class="literal">MessageStore</code> is managing persistent queues that back a Spring Integration Message Channel.
The message data for a persistent channel is keyed in the store on the channel name.
Consequently, if the channel names are not globally unique, the channels can pick up data that is not intended for them.
To avoid this danger, you can use the message store <code class="literal">region</code> to keep data separate for different physical channels that have the same logical name.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="stored-procedures" href="#stored-procedures"></a>21.5&nbsp;Stored Procedures</h2></div></div></div>

<p>In certain situations, plain JDBC support is not sufficient.
Maybe you deal with legacy relational database schemas or you have complex data processing needs, but, ultimately, you have to use <a class="ulink" href="https://en.wikipedia.org/wiki/Stored_procedure" target="_top">stored procedures</a> or stored functions.
Since Spring Integration 2.1, we provide three components to execute stored procedures or stored functions:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Stored Procedures Inbound Channel Adapter
</li><li class="listitem">
Stored Procedures Outbound Channel Adapter
</li><li class="listitem">
Stored Procedures Outbound Gateway
</li></ul></div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="sp-supported-databases" href="#sp-supported-databases"></a>21.5.1&nbsp;Supported Databases</h3></div></div></div>

<p>In order to enable calls to stored procedures and stored functions, the stored procedure components use the <a class="ulink" href="https://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/jdbc/core/simple/SimpleJdbcCall.html" target="_top"><code class="literal">org.springframework.jdbc.core.simple.SimpleJdbcCall</code></a> class.
Consequently, the following databases are fully supported for executing stored procedures:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Apache Derby
</li><li class="listitem">
DB2
</li><li class="listitem">
MySQL
</li><li class="listitem">
Microsoft SQL Server
</li><li class="listitem">
Oracle
</li><li class="listitem">
PostgreSQL
</li><li class="listitem">
Sybase
</li></ul></div>
<p>If you want to execute stored functions instead, the following databases are fully supported:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
MySQL
</li><li class="listitem">
Microsoft SQL Server
</li><li class="listitem">
Oracle
</li><li class="listitem">
PostgreSQL
</li></ul></div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Even though your particular database may not be fully supported, chances are that you can use the stored procedure Spring Integration components quite successfully anyway, provided your RDBMS supports stored procedures or stored functions.</p>
<p>As a matter of fact, some of the provided integration tests use the <a class="ulink" href="http://www.h2database.com/" target="_top">H2 database</a>.
Nevertheless, it is very important to thoroughly test those usage scenarios.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="sp-configuration" href="#sp-configuration"></a>21.5.2&nbsp;Configuration</h3></div></div></div>

<p>The stored procedure components provide full XML Namespace support, and configuring the components is similar as for the general purpose JDBC components discussed earlier.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="sp-common-config-params" href="#sp-common-config-params"></a>21.5.3&nbsp;Common Configuration Attributes</h3></div></div></div>

<p>All stored procedure components share certain configuration parameters:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">auto-startup</code>: Lifecycle attribute signaling whether this component should be started during application context startup.
It defaults to <code class="literal">true</code>.
Optional.
</li><li class="listitem">
<code class="literal">data-source</code>: Reference to a <code class="literal">javax.sql.DataSource</code>, which is used to access the database.
Required.
</li><li class="listitem">
<code class="literal">id</code>:  Identifies the underlying Spring bean definition, which is an instance of either <code class="literal">EventDrivenConsumer</code> or <code class="literal">PollingConsumer</code>, depending on whether the outbound channel adapter&#8217;s <code class="literal">channel</code> attribute references a <code class="literal">SubscribableChannel</code> or a <code class="literal">PollableChannel</code>.
Optional.
</li><li class="listitem">
<p class="simpara"><code class="literal">ignore-column-meta-data</code>:  For fully supported databases, the underlying <a class="ulink" href="https://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/jdbc/core/simple/SimpleJdbcCall.html" target="_top"><code class="literal">SimpleJdbcCall</code></a> class can automatically retrieve the parameter information for the stored procedure or stored function from the JDBC metadata.</p>
<p class="simpara">However, if the database does not support metadata lookups or if you need to provide customized parameter definitions, this flag can be set to <code class="literal">true</code>.
It defaults to <code class="literal">false</code>.
Optional.</p>
</li><li class="listitem">
<code class="literal">is-function</code>:  If <code class="literal">true</code>, a SQL Function is called.
In that case, the <code class="literal">stored-procedure-name</code> or <code class="literal">stored-procedure-name-expression</code> attributes define the name of the called function.
It defaults to <code class="literal">false</code>.
Optional.
</li><li class="listitem">
<code class="literal">stored-procedure-name</code>: This attribute specifies the name of the stored procedure.
If the <code class="literal">is-function</code> attribute is set to <code class="literal">true</code>, this attribute specifies the function name instead.
Either this property or <code class="literal">stored-procedure-name-expression</code> must be specified.
</li><li class="listitem">
<p class="simpara"><code class="literal">stored-procedure-name-expression</code>: This attribute specifies the name of the stored procedure by using a SpEL expression.
By using SpEL, you have access to the full message (if available), including its headers and payload.
You can use this attribute to invoke different stored procedures at runtime.
For example, you can provide stored procedure names that you would like to execute as a message header.
The expression must resolve to a <code class="literal">String</code>.</p>
<p class="simpara">If the <code class="literal">is-function</code> attribute is set to <code class="literal">true</code>, this attribute specifies a stored function.
Either this property or <code class="literal">stored-procedure-name</code> must be specified.</p>
</li><li class="listitem">
<p class="simpara"><code class="literal">jdbc-call-operations-cache-size</code>: Defines the maximum number of cached <code class="literal">SimpleJdbcCallOperations</code> instances.
Basically, for each stored procedure name, a new <a class="ulink" href="https://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/jdbc/core/simple/SimpleJdbcCallOperations.html" target="_top"><code class="literal">SimpleJdbcCallOperations</code></a> instance is created that, in return, is cached.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Spring Integration 2.2 added the <code class="literal">stored-procedure-name-expression</code> attribute and the <code class="literal">jdbc-call-operations-cache-size</code> attribute.</p>
</td></tr></table></div>
<p class="simpara">The default cache size is <code class="literal">10</code>.
A value of <code class="literal">0</code> disables caching.
Negative values are not permitted.</p>
<p class="simpara">If you enable JMX, statistical information about the <code class="literal">jdbc-call-operations-cache</code> is exposed as an MBean.
See <a class="xref" href="#jmx-mbean-exporter" title="12.2.7&nbsp;MBean Exporter">Section&nbsp;12.2.7, &#8220;MBean Exporter&#8221;</a> for more information.</p>
</li><li class="listitem">
<p class="simpara"><code class="literal">sql-parameter-source-factory</code>: (Not available for the stored procedure inbound channel adapter.)
Reference to a <code class="literal">SqlParameterSourceFactory</code>.
By default, bean properties of the passed in <code class="literal">Message</code> payload are used as a source for the stored procedure&#8217;s input parameters by using a <code class="literal">BeanPropertySqlParameterSourceFactory</code>.</p>
<p class="simpara">This may suffice for basic use cases.
For more sophisticated options, consider passing in one or more <code class="literal">ProcedureParameter</code> values.
See <a class="xref" href="#sp-defining-parameter-sources" title="21.5.5&nbsp;Defining Parameter Sources">Section&nbsp;21.5.5, &#8220;Defining Parameter Sources&#8221;</a>.
Optional.</p>
</li><li class="listitem">
<p class="simpara"><code class="literal">use-payload-as-parameter-source</code>: (Not available for the stored procedure inbound channel adapter.)
If set to <code class="literal">true</code>, the payload of the <code class="literal">Message</code> is used as a source for providing parameters.
If set to <code class="literal">false</code>, however, the entire <code class="literal">Message</code> is available as a source for parameters.</p>
<p class="simpara">If no procedure parameters are passed in, this property defaults to <code class="literal">true</code>.
This means that, by using a default <code class="literal">BeanPropertySqlParameterSourceFactory</code>, the bean properties of the payload are used as a source for parameter values for the stored procedure or stored function.</p>
<p class="simpara">However, if procedure parameters are passed in, this property (by default) evaluates to <code class="literal">false</code>.
<code class="literal">ProcedureParameter</code> lets SpEL Expressions be provided.
Therefore, it is highly beneficial to have access to the entire <code class="literal">Message</code>.
The property is set on the underlying <code class="literal">StoredProcExecutor</code>.
Optional.</p>
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="sp-common-config-subelements" href="#sp-common-config-subelements"></a>21.5.4&nbsp;Common Configuration Sub-Elements</h3></div></div></div>

<p>The stored procedure components share a common set of child elements that you can use to define and pass parameters to stored procedures or stored functions.
The following elements are available:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">parameter</code>
</li><li class="listitem">
<code class="literal">returning-resultset</code>
</li><li class="listitem">
<code class="literal">sql-parameter-definition</code>
</li><li class="listitem">
<code class="literal">poller</code>
</li><li class="listitem">
<p class="simpara"><code class="literal">parameter</code>: Provides a mechanism to provide stored procedure parameters.
Parameters can be either static or provided by using a SpEL Expressions.</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-jdbc:parameter</span> <span class="hl-attribute">name</span>=<span class="hl-value">""</span>         <a name="CO25-1" href="#CO25-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
                    type=""         <a name="CO25-2" href="#CO25-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
                    value=""/&gt;      <a name="CO25-3" href="#CO25-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>

<span class="hl-tag">&lt;int-jdbc:parameter</span> <span class="hl-attribute">name</span>=<span class="hl-value">""</span>
                    <span class="hl-attribute">expression</span>=<span class="hl-value">""</span><span class="hl-tag">/&gt;</span> <a name="CO25-4" href="#CO25-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span></pre>
<p>+
&lt;1&gt; The name of the parameter to be passed into the Stored Procedure or Stored Function.
Required.
&lt;2&gt; This attribute specifies the type of the value.
If nothing is provided, this attribute defaults to <code class="literal">java.lang.String</code>.
This attribute is used only when the <code class="literal">value</code> attribute is used.
Optional.
&lt;3&gt; The value of the parameter.
You must provide either this attribute or the <code class="literal">expression</code> attribute.
Optional.
&lt;4&gt; Instead of the <code class="literal">value</code> attribute, you can specify a SpEL expression for passing the value of the parameter.
If you specify the <code class="literal">expression</code>, the <code class="literal">value</code> attribute is not allowed.
Optional.</p>
</div>
<p class="simpara">Optional.</p>
</li><li class="listitem">
<p class="simpara"><code class="literal">returning-resultset</code>: Stored procedures may return multiple result sets.
By setting one or more <code class="literal">returning-resultset</code> elements, you can specify <code class="literal">RowMappers</code> to convert each returned <code class="literal">ResultSet</code> to meaningful objects.
Optional.</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-jdbc:returning-resultset</span> <span class="hl-attribute">name</span>=<span class="hl-value">""</span> <span class="hl-attribute">row-mapper</span>=<span class="hl-value">""</span><span class="hl-tag"> /&gt;</span></pre>
</div>
</li><li class="listitem">
<p class="simpara"><code class="literal">sql-parameter-definition</code>: If you use a database that is fully supported, you typically do not have to specify the stored procedure parameter definitions.
Instead, those parameters can be automatically derived from the JDBC metadata.
However, if you use databases that are not fully supported, you must set those parameters explicitly by using the <code class="literal">sql-parameter-definition</code> element.</p>
<p class="simpara">You can also choose to turn off any processing of parameter metadata information obtained through JDBC by using the <code class="literal">ignore-column-meta-data</code> attribute.</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-jdbc:sql-parameter-definition</span>
                                   <span class="hl-attribute">name</span>=<span class="hl-value">""</span>                           <a name="CO25-5" href="#CO25-5"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
                                   direction="IN"                    <a name="CO25-6" href="#CO25-6"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
                                   type="STRING"                     <a name="CO25-7" href="#CO25-7"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
                                   scale="5"                         <a name="CO25-8" href="#CO25-8"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
                                   type-name="FOO_STRUCT"            <a name="CO25-9" href="#CO25-9"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
                                   return-type="fooSqlReturnType"/&gt;  <a name="CO25-10" href="#CO25-10"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO25-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> <a href="#CO25-5"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Specifies the name of the SQL parameter.
Required.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO25-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> <a href="#CO25-6"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Specifies the direction of the SQL parameter definition.
Defaults to <code class="literal">IN</code>.
Valid values are: <code class="literal">IN</code>, <code class="literal">OUT</code>, and <code class="literal">INOUT</code>.
If your procedure is returning result sets, use the <code class="literal">returning-resultset</code> element.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO25-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> <a href="#CO25-7"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The SQL type used for this SQL parameter definition.
Translates into an integer value, as defined by <code class="literal">java.sql.Types</code>.
Alternatively, you can provide the integer value as well.
If this attribute is not explicitly set, it defaults to <span class="emphasis"><em>VARCHAR</em></span>.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO25-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> <a href="#CO25-8"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The scale of the SQL parameter.
Only used for numeric and decimal parameters.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO25-9"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The <code class="literal">typeName</code> for types that are user-named, such as: <code class="literal">STRUCT</code>, <code class="literal">DISTINCT</code>, <code class="literal">JAVA_OBJECT</code>, and named array types.
This attribute is mutually exclusive with the <code class="literal">scale</code> attribute.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO25-10"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The reference to a custom value handler for complex types.
An implementation of <a class="ulink" href="https://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/jdbc/core/SqlReturnType.html" target="_top"><code class="literal">SqlReturnType</code></a>.
This attribute is mutually exclusive with the <code class="literal">scale</code> attribute and is only applicable for OUT and INOUT parameters.
Optional.</p>
</td></tr></table></div>
</div>
</li><li class="listitem">
<code class="literal">poller</code>: Lets you configure a message poller if this endpoint is a <code class="literal">PollingConsumer</code>.
Optional.
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="sp-defining-parameter-sources" href="#sp-defining-parameter-sources"></a>21.5.5&nbsp;Defining Parameter Sources</h3></div></div></div>

<p>Parameter sources govern the techniques of retrieving and mapping the Spring Integration message properties to the relevant stored procedure input parameters.</p>
<p>The stored procedure components follow certain rules.
By default, the bean properties of the <code class="literal">Message</code> payload are used as a source for the stored procedure&#8217;s input parameters.
In that case, a <code class="literal">BeanPropertySqlParameterSourceFactory</code> is used.
This may suffice for basic use cases.
The next example illustrates that default behavior.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>For the "<code class="literal">automatic</code>" lookup of bean properties by using the <code class="literal">BeanPropertySqlParameterSourceFactory</code> to work, your bean properties must be defined in lower case.
This is due to the fact that in <code class="literal">org.springframework.jdbc.core.metadata.CallMetaDataContext</code> (the Java method is <code class="literal">matchInParameterValuesWithCallParameters()</code>), the retrieved stored procedure parameter declarations are converted to lower case.
As a result, if you have camel-case bean properties (such as <code class="literal">lastName</code>), the lookup fails.
In that case, provide an explicit <code class="literal">ProcedureParameter</code>.</p>
</td></tr></table></div>
<p>Suppose we have a payload that consists of a simple bean with the following three properties: <code class="literal">id</code>, <code class="literal">name</code>, and <code class="literal">description</code>.
Furthermore, we have a simplistic Stored Procedure called <code class="literal">INSERT_COFFEE</code> that accepts three input parameters: <code class="literal">id</code>, <code class="literal">name</code>, and <code class="literal">description</code>.
We also use a fully supported database.
In that case, the following configuration for a stored procedure outbound adapter suffices:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-jdbc:stored-proc-outbound-channel-adapter</span> <span class="hl-attribute">data-source</span>=<span class="hl-value">"dataSource"</span>
    <span class="hl-attribute">channel</span>=<span class="hl-value">"insertCoffeeProcedureRequestChannel"</span>
    <span class="hl-attribute">stored-procedure-name</span>=<span class="hl-value">"INSERT_COFFEE"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>For more sophisticated options, consider passing in one or more <code class="literal">ProcedureParameter</code> values.</p>
<p>If you do provide <code class="literal">ProcedureParameter</code> values explicitly, by default, an <code class="literal">ExpressionEvaluatingSqlParameterSourceFactory</code> is used for parameter processing, to enable the full power of SpEL expressions.</p>
<p>If you need even more control over how parameters are retrieved, consider passing in a custom implementation of <code class="literal">SqlParameterSourceFactory</code> by using the <code class="literal">sql-parameter-source-factory</code> attribute.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="stored-procedure-inbound-channel-adapter" href="#stored-procedure-inbound-channel-adapter"></a>21.5.6&nbsp;Stored Procedure Inbound Channel Adapter</h3></div></div></div>

<p>The following listing calls out the attributes that matter for a stored procedure inbound channel adapter:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-jdbc:stored-proc-inbound-channel-adapter</span>
                                   <span class="hl-attribute">channel</span>=<span class="hl-value">""</span>                                    <a name="CO26-1" href="#CO26-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
                                   stored-procedure-name=""
                                   data-source=""
                                   auto-startup="true"
                                   id=""
                                   ignore-column-meta-data="false"
                                   is-function="false"
                                   skip-undeclared-results=""                    <a name="CO26-2" href="#CO26-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
                                   return-value-required="false"                 <a name="CO26-3" href="#CO26-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
    <span class="hl-tag">&lt;int:poller/&gt;</span>
    <span class="hl-tag">&lt;int-jdbc:sql-parameter-definition</span> <span class="hl-attribute">name</span>=<span class="hl-value">""</span> <span class="hl-attribute">direction</span>=<span class="hl-value">"IN"</span>
                                               <span class="hl-attribute">type</span>=<span class="hl-value">"STRING"</span>
                                               <span class="hl-attribute">scale</span>=<span class="hl-value">""</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int-jdbc:parameter</span> <span class="hl-attribute">name</span>=<span class="hl-value">""</span> <span class="hl-attribute">type</span>=<span class="hl-value">""</span> <span class="hl-attribute">value</span>=<span class="hl-value">""</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int-jdbc:parameter</span> <span class="hl-attribute">name</span>=<span class="hl-value">""</span> <span class="hl-attribute">expression</span>=<span class="hl-value">""</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int-jdbc:returning-resultset</span> <span class="hl-attribute">name</span>=<span class="hl-value">""</span> <span class="hl-attribute">row-mapper</span>=<span class="hl-value">""</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/int-jdbc:stored-proc-inbound-channel-adapter&gt;</span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO26-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Channel to which polled messages are sent.
If the stored procedure or function does not return any data, the payload of the <code class="literal">Message</code> is null.
Required.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO26-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>If this attribute is set to <code class="literal">true</code>, all results from a stored procedure call that do not have a corresponding <code class="literal">SqlOutParameter</code> declaration are bypassed.
For example, stored procedures can return an update count value, even though your stored procedure declared only a single result parameter.
The exact behavior depends on the database implementation.
The value is set on the underlying <code class="literal">JdbcTemplate</code>.
The value defaults to <code class="literal">true</code>.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO26-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Indicates whether this procedure&#8217;s return value should be included.
Since Spring Integration 3.0.
Optional.</p>
</td></tr></table></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="stored-procedure-outbound-channel-adapter" href="#stored-procedure-outbound-channel-adapter"></a>21.5.7&nbsp;Stored Procedure Outbound Channel Adapter</h3></div></div></div>

<p>The following listing calls out the attributes that matter for a stored procedure outbound channel adapter:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-jdbc:stored-proc-outbound-channel-adapter</span> <span class="hl-attribute">channel</span>=<span class="hl-value">""</span>                        <a name="CO27-1" href="#CO27-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
                                               stored-procedure-name=""
                                               data-source=""
                                               auto-startup="true"
                                               id=""
                                               ignore-column-meta-data="false"
                                               order=""                          <a name="CO27-2" href="#CO27-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
                                               sql-parameter-source-factory=""
                                               use-payload-as-parameter-source=""&gt;
    <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">""</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int-jdbc:sql-parameter-definition</span> <span class="hl-attribute">name</span>=<span class="hl-value">""</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int-jdbc:parameter</span> <span class="hl-attribute">name</span>=<span class="hl-value">""</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;/int-jdbc:stored-proc-outbound-channel-adapter&gt;</span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO27-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The receiving message channel of this endpoint.
Required.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO27-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Specifies the order for invocation when this endpoint is connected as a subscriber to a channel.
This is particularly relevant when that channel is using a <code class="literal">failover</code> dispatching strategy.
It has no effect when this endpoint is itself a polling consumer for a channel with a queue.
Optional.</p>
</td></tr></table></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="stored-procedure-outbound-gateway" href="#stored-procedure-outbound-gateway"></a>21.5.8&nbsp;Stored Procedure Outbound Gateway</h3></div></div></div>

<p>The following listing calls out the attributes that matter for a stored procedure outbound channel adapter:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-jdbc:stored-proc-outbound-gateway</span> <span class="hl-attribute">request-channel</span>=<span class="hl-value">""</span>                        <a name="CO28-1" href="#CO28-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
                                       stored-procedure-name=""
                                       data-source=""
                                   auto-startup="true"
                                   id=""
                                   ignore-column-meta-data="false"
                                   is-function="false"
                                   order=""
                                   reply-channel=""                              <a name="CO28-2" href="#CO28-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
                                   reply-timeout=""                              <a name="CO28-3" href="#CO28-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
                                   return-value-required="false"                 <a name="CO28-4" href="#CO28-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
                                   skip-undeclared-results=""                    <a name="CO28-5" href="#CO28-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
                                   sql-parameter-source-factory=""
                                   use-payload-as-parameter-source=""&gt;
<span class="hl-tag">&lt;int-jdbc:sql-parameter-definition</span> <span class="hl-attribute">name</span>=<span class="hl-value">""</span> <span class="hl-attribute">direction</span>=<span class="hl-value">"IN"</span>
                                   <span class="hl-attribute">type</span>=<span class="hl-value">""</span>
                                   <span class="hl-attribute">scale</span>=<span class="hl-value">"10"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;int-jdbc:sql-parameter-definition</span> <span class="hl-attribute">name</span>=<span class="hl-value">""</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;int-jdbc:parameter</span> <span class="hl-attribute">name</span>=<span class="hl-value">""</span> <span class="hl-attribute">type</span>=<span class="hl-value">""</span> <span class="hl-attribute">value</span>=<span class="hl-value">""</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;int-jdbc:parameter</span> <span class="hl-attribute">name</span>=<span class="hl-value">""</span> <span class="hl-attribute">expression</span>=<span class="hl-value">""</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;int-jdbc:returning-resultset</span> <span class="hl-attribute">name</span>=<span class="hl-value">""</span> <span class="hl-attribute">row-mapper</span>=<span class="hl-value">""</span><span class="hl-tag"> /&gt;</span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO28-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The receiving message channel of this endpoint.
Required.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO28-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Message channel to which replies should be sent after receiving the database response.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO28-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Lets you specify how long this gateway waits for the reply message to be sent successfully before throwing an exception.
Keep in mind that, when sending to a <code class="literal">DirectChannel</code>, the invocation occurs in the sender&#8217;s thread.
Consequently, the failing of the send operation may be caused by other components further downstream.
By default, the gateway waits indefinitely.
The value is specified in milliseconds.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO28-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Indicates whether this procedure&#8217;s return value should be included.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO28-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>If the <code class="literal">skip-undeclared-results</code> attribute is set to <code class="literal">true</code>, all results from a stored procedure call that do not have a corresponding <code class="literal">SqlOutParameter</code> declaration are bypassed.
For example, stored procedures may return an update count value, even though your stored procedure only declared a single result parameter.
The exact behavior depends on the database.
The value is set on the underlying <code class="literal">JdbcTemplate</code>.
The value defaults to <code class="literal">true</code>.
Optional.</p>
</td></tr></table></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="sp-examples" href="#sp-examples"></a>21.5.9&nbsp;Examples</h3></div></div></div>

<p>This section contains two examples that call <a class="ulink" href="https://db.apache.org/derby/" target="_top">Apache Derby</a> stored procedures.
The first procedure calls a stored procedure that returns a <code class="literal">ResultSet</code>.
By using a <code class="literal">RowMapper</code>, the data is converted into a domain object, which then becomes the Spring Integration message payload.</p>
<p>In the second sample, we call a stored procedure that uses output parameters to return data instead.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Have a look at the <a class="ulink" href="https://github.com/spring-projects/spring-integration-samples" target="_top">Spring Integration Samples project</a>.</p>
<p>The project contains the Apache Derby example referenced here, as well as instructions on how to run it.
The Spring Integration Samples project also provides an <a class="ulink" href="https://github.com/spring-projects/spring-integration-samples/tree/master/intermediate/stored-procedures-oracle" target="_top">example</a> of using Oracle stored procedures.</p>
</td></tr></table></div>
<p>In the first example, we call a stored procedure named <code class="literal">FIND_ALL_COFFEE_BEVERAGES</code> that does not define any input parameters but that returns a <code class="literal">ResultSet</code>.</p>
<p>In Apache Derby, stored procedures are implemented in Java.
The following listing shows the method signature:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> findAllCoffeeBeverages(ResultSet[] coffeeBeverages)
            <span class="hl-keyword">throws</span> SQLException {
    ...
}</pre>
</div>
<p>The following listing shows the corresponding SQL:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">CREATE</span> <span class="hl-keyword">PROCEDURE</span> FIND_ALL_COFFEE_BEVERAGES() \
<span class="hl-keyword">PARAMETER</span> <span class="hl-keyword">STYLE</span> JAVA <span class="hl-keyword">LANGUAGE</span> JAVA <span class="hl-keyword">MODIFIES</span> <span class="hl-keyword">SQL</span> <span class="hl-keyword">DATA</span> <span class="hl-keyword">DYNAMIC</span> <span class="hl-keyword">RESULT</span> <span class="hl-keyword">SETS</span> <span class="hl-number">1</span> \
<span class="hl-keyword">EXTERNAL</span> <span class="hl-keyword">NAME</span> <span class="hl-string">'o.s.i.jdbc.storedproc.derby.DerbyStoredProcedures.findAllCoffeeBeverages'</span>;</pre>
</div>
<p>In Spring Integration, you can now call this stored procedure by using, for example, a <code class="literal">stored-proc-outbound-gateway</code>, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-jdbc:stored-proc-outbound-gateway</span> <span class="hl-attribute">id</span>=<span class="hl-value">"outbound-gateway-storedproc-find-all"</span>
                                       <span class="hl-attribute">data-source</span>=<span class="hl-value">"dataSource"</span>
                                       <span class="hl-attribute">request-channel</span>=<span class="hl-value">"findAllProcedureRequestChannel"</span>
                                       <span class="hl-attribute">expect-single-result</span>=<span class="hl-value">"true"</span>
                                       <span class="hl-attribute">stored-procedure-name</span>=<span class="hl-value">"FIND_ALL_COFFEE_BEVERAGES"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;int-jdbc:returning-resultset</span> <span class="hl-attribute">name</span>=<span class="hl-value">"coffeeBeverages"</span>
    <span class="hl-attribute">row-mapper</span>=<span class="hl-value">"org.springframework.integration.support.CoffeBeverageMapper"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-jdbc:stored-proc-outbound-gateway&gt;</span></pre>
</div>
<p>In the second example, we call a stored procedure named <code class="literal">FIND_COFFEE</code> that has one input parameter.
Instead of returning a <code class="literal">ResultSet</code>, it uses an output parameter.
The following example shows the method signature:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> findCoffee(<span class="hl-keyword">int</span> coffeeId, String[] coffeeDescription)
            <span class="hl-keyword">throws</span> SQLException {
    ...
}</pre>
</div>
<p>The following listing shows the corresponding SQL:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">CREATE</span> <span class="hl-keyword">PROCEDURE</span> FIND_COFFEE(<span class="hl-keyword">IN</span> ID <span class="hl-keyword">INTEGER</span>, <span class="hl-keyword">OUT</span> COFFEE_DESCRIPTION <span class="hl-keyword">VARCHAR</span>(<span class="hl-number">200</span>)) \
<span class="hl-keyword">PARAMETER</span> <span class="hl-keyword">STYLE</span> JAVA <span class="hl-keyword">LANGUAGE</span> JAVA <span class="hl-keyword">EXTERNAL</span> <span class="hl-keyword">NAME</span> \
<span class="hl-string">'org.springframework.integration.jdbc.storedproc.derby.DerbyStoredProcedures.findCoffee'</span>;</pre>
</div>
<p>In Spring Integration, you can now call this Stored Procedure by using, for example, a <code class="literal">stored-proc-outbound-gateway</code>, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-jdbc:stored-proc-outbound-gateway</span> <span class="hl-attribute">id</span>=<span class="hl-value">"outbound-gateway-storedproc-find-coffee"</span>
                                       <span class="hl-attribute">data-source</span>=<span class="hl-value">"dataSource"</span>
                                       <span class="hl-attribute">request-channel</span>=<span class="hl-value">"findCoffeeProcedureRequestChannel"</span>
                                       <span class="hl-attribute">skip-undeclared-results</span>=<span class="hl-value">"true"</span>
                                       <span class="hl-attribute">stored-procedure-name</span>=<span class="hl-value">"FIND_COFFEE"</span>
                                       <span class="hl-attribute">expect-single-result</span>=<span class="hl-value">"true"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int-jdbc:parameter</span> <span class="hl-attribute">name</span>=<span class="hl-value">"ID"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"payload"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/int-jdbc:stored-proc-outbound-gateway&gt;</span></pre>
</div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jdbc-lock-registry" href="#jdbc-lock-registry"></a>21.6&nbsp;JDBC Lock Registry</h2></div></div></div>

<p>Version 4.3 introduced the <code class="literal">JdbcLockRegistry</code>.
Certain components (for example, aggregator and resequencer) use a lock obtained from a <code class="literal">LockRegistry</code> instance to ensure that only one thread manipulates a group at a time.
The <code class="literal">DefaultLockRegistry</code> performs this function within a single component.
You can now configure an external lock registry on these components.
When used with a shared <code class="literal">MessageGroupStore</code>, you can use the <code class="literal">JdbcLockRegistry</code> to provide this functionality across multiple application instances, such that only one instance can manipulate the group at a time.</p>
<p>When a lock is released by a local thread, another local thread can generally acquire the lock immediately.
If a lock is released by a thread that uses a different registry instance, it can take up to 100ms to acquire the lock.</p>
<p>The <code class="literal">JdbcLockRegistry</code> is based on the <code class="literal">LockRepository</code> abstraction, which has a <code class="literal">DefaultLockRepository</code> implementation.
The database schema scripts are located in the <code class="literal">org.springframework.integration.jdbc</code> package, which is divided for the particular RDBMS vendors.
For example, the following listing shows the H2 DDL for the lock table:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">CREATE</span> <span class="hl-keyword">TABLE</span> INT_LOCK  (
    LOCK_KEY <span class="hl-keyword">CHAR</span>(<span class="hl-number">36</span>),
    REGION <span class="hl-keyword">VARCHAR</span>(<span class="hl-number">100</span>),
    CLIENT_ID <span class="hl-keyword">CHAR</span>(<span class="hl-number">36</span>),
    CREATED_DATE <span class="hl-keyword">TIMESTAMP</span> <span class="hl-keyword">NOT</span> <span class="hl-keyword">NULL</span>,
    <span class="hl-keyword">constraint</span> LOCK_PK <span class="hl-keyword">primary</span> <span class="hl-keyword">key</span> (LOCK_KEY, REGION)
);</pre>
</div>
<p>The <code class="literal">INT_</code> can be changed according to the target database design requirements.
Therefore, you must use <code class="literal">prefix</code> property on the <code class="literal">DefaultLockRepository</code> bean definition.</p>
<p>Sometimes, one application has moved to such a state that it cannot release the distributed lock and remove the particular record in the database.
For this purpose, such dead locks can be expired by the other application on the next locking invocation.
The <code class="literal">timeToLive</code> (TTL) option on the <code class="literal">DefaultLockRepository</code> is provided for this purpose.
You may also want to specify <code class="literal">CLIENT_ID</code> for the locks stored for a given <code class="literal">DefaultLockRepository</code> instance.
If so, you can specify the <code class="literal">id</code> to be associated with the <code class="literal">DefaultLockRepository</code> as a constructor parameter.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jdbc-metadata-store" href="#jdbc-metadata-store"></a>21.7&nbsp;JDBC Metadata Store</h2></div></div></div>

<p>Version 5.0 introduced the JDBC <code class="literal">MetadataStore</code> (see <a class="xref" href="#metadata-store" title="12.5&nbsp;Metadata Store">Section&nbsp;12.5, &#8220;Metadata Store&#8221;</a>) implementation.
You can use the <code class="literal">JdbcMetadataStore</code> to maintain the metadata state across application restarts.
This <code class="literal">MetadataStore</code> implementation can be used with adapters such as the following:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="#feed-inbound-channel-adapter" title="16.1&nbsp;Feed Inbound Channel Adapter">Feed inbound channel adapters</a>
</li><li class="listitem">
<a class="link" href="#file-reading" title="17.1&nbsp;Reading Files">files</a>
</li><li class="listitem">
<a class="link" href="#ftp-inbound" title="18.4&nbsp;FTP Inbound Channel Adapter">FTP inbound channel adapters</a>
</li><li class="listitem">
<a class="link" href="#sftp-inbound" title="30.6&nbsp;SFTP Inbound Channel Adapter">SFTP inbound channel adapters</a>
</li></ul></div>
<p>To configure these adapters to use the <code class="literal">JdbcMetadataStore</code>, declare a Spring bean by using a bean name of <code class="literal">metadataStore</code>.
The Feed inbound channel adapter and the feed inbound channel adapter both automatically pick up and use the declared <code class="literal">JdbcMetadataStore</code>, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> MetadataStore metadataStore(DataSource dataSource) {
    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> JdbcMetadataStore(dataSource);
}</pre>
</div>
<p>The <code class="literal">org.springframework.integration.jdbc</code> package has Database schema scripts for several RDMBS vendors.
For example, the following listing shows the H2 DDL for the metadata table:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">CREATE</span> <span class="hl-keyword">TABLE</span> INT_METADATA_STORE  (
	METADATA_KEY <span class="hl-keyword">VARCHAR</span>(<span class="hl-number">255</span>) <span class="hl-keyword">NOT</span> <span class="hl-keyword">NULL</span>,
	METADATA_VALUE <span class="hl-keyword">VARCHAR</span>(<span class="hl-number">4000</span>),
	REGION <span class="hl-keyword">VARCHAR</span>(<span class="hl-number">100</span>) <span class="hl-keyword">NOT</span> <span class="hl-keyword">NULL</span>,
	<span class="hl-keyword">constraint</span> METADATA_STORE <span class="hl-keyword">primary</span> <span class="hl-keyword">key</span> (METADATA_KEY, REGION)
);</pre>
</div>
<p>You can change the <code class="literal">INT_</code> prefix to match the target database design requirements.
You can also configure <code class="literal">JdbcMetadataStore</code> to use the custom prefix.</p>
<p>The <code class="literal">JdbcMetadataStore</code> implements <code class="literal">ConcurrentMetadataStore</code>, letting it be reliably shared across multiple application instances, where only one instance can store or modify a key&#8217;s value.
All of these operations are atomic, thanks to transaction guarantees.</p>
<p>Transaction management must use <code class="literal">JdbcMetadataStore</code>.
Inbound channel adapters can be supplied with a reference to the <code class="literal">TransactionManager</code> in the poller configuration.
Unlike non-transactional <code class="literal">MetadataStore</code> implementations, with <code class="literal">JdbcMetadataStore</code>, the entry appears in the target table only after the transaction commits.
When a rollback occurs, no entries are added to the <code class="literal">INT_METADATA_STORE</code> table.</p>
<p>Since version 5.0.7, you can configure the <code class="literal">JdbcMetadataStore</code> with the RDBMS vendor-specific <code class="literal">lockHint</code> option for lock-based queries on metadata store entries.
By default, it is <code class="literal">FOR UPDATE</code> and can be configured with an empty string if the target database does not support row locking functionality.
Consult with your vendor for particular and possible hints in the <code class="literal">SELECT</code> expression for locking rows before updates.</p>
</div>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="jpa" href="#jpa"></a>22.&nbsp;JPA Support</h2></div></div></div>

<p>Spring Integration&#8217;s JPA (Java Persistence API) module provides components for performing various database operations using JPA.</p>
<p>You need to include this dependency into your project:</p>
<div class="informalexample">
<p>
<b>Maven.&nbsp;</b>

</p><pre class="programlisting"><span class="hl-tag">&lt;dependency&gt;</span>
    <span class="hl-tag">&lt;groupId&gt;</span>org.springframework.integration<span class="hl-tag">&lt;/groupId&gt;</span>
    <span class="hl-tag">&lt;artifactId&gt;</span>spring-integration-jpa<span class="hl-tag">&lt;/artifactId&gt;</span>
    <span class="hl-tag">&lt;version&gt;</span>5.1.2.RELEASE<span class="hl-tag">&lt;/version&gt;</span>
<span class="hl-tag">&lt;/dependency&gt;</span></pre><p>

</p>
<p>
<b>Gradle.&nbsp;</b>

</p><pre class="programlisting">compile <span class="hl-string">"org.springframework.integration:spring-integration-jpa:5.1.2.RELEASE"</span></pre><p>

</p>
</div>
<p>The JPA API must be included via some vendor-specific implementation, e.g. Hibernate ORM Framework.</p>
<p>The following components are provided:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="#jpa-inbound-channel-adapter" title="22.5&nbsp;Inbound Channel Adapter">Inbound channel adapter</a>
</li><li class="listitem">
<a class="link" href="#jpa-outbound-channel-adapter" title="22.6&nbsp;Outbound Channel Adapter">Outbound channel adapter</a>
</li><li class="listitem">
<a class="link" href="#jpa-updating-outbound-gateway" title="22.7.2&nbsp;Updating Outbound Gateway">Updating outbound gateway</a>
</li><li class="listitem">
<a class="link" href="#jpa-retrieving-outbound-gateway" title="22.7.5&nbsp;Retrieving Outbound Gateway">Retrieving outbound gateway</a>
</li></ul></div>
<p>These components can be used to perform <code class="literal">select</code>, <code class="literal">create</code>, <code class="literal">update</code>, and <code class="literal">delete</code> operations on the target databases by sending and receiving messages to them.</p>
<p>The JPA inbound channel adapter lets you poll and retrieve (<code class="literal">select</code>) data from the database by using JPA, whereas the JPA outbound channel adapter lets you create, update, and delete entities.</p>
<p>You can use outbound gateways for JPA to persist entities to the database, letting you continue the flow and execute further components downstream.
Similarly, you can use an outbound gateway to retrieve entities from the database.</p>
<p>For example, you may use the outbound gateway, which receives a <code class="literal">Message</code> with a <code class="literal">userId</code> as payload on its request channel, to query the database, retrieve the user entity, and pass it downstream for further processing.</p>
<p>Recognizing these semantic differences, Spring Integration provides two separate JPA outbound gateways:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Retrieving outbound gateway
</li><li class="listitem">
Updating outbound gateway
</li></ul></div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_functionality" href="#_functionality"></a>22.1&nbsp;Functionality</h2></div></div></div>

<p>All JPA components perform their respective JPA operations by using one of the following:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Entity classes
</li><li class="listitem">
Java Persistence Query Language (JPQL) for update, select and delete (JPQL does not support inserts)
</li><li class="listitem">
Native Query
</li><li class="listitem">
Named Query
</li></ul></div>
<p>The following sections describe each of these components in more detail.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jpa-supported-persistence-providers" href="#jpa-supported-persistence-providers"></a>22.2&nbsp;Supported Persistence Providers</h2></div></div></div>

<p>The Spring Integration JPA support has been tested against the following persistence providers:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Hibernate
</li><li class="listitem">
EclipseLink
</li></ul></div>
<p>When using a persistence provider, you should ensure that the provider is compatible with JPA 2.1.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jpa-java-implementation" href="#jpa-java-implementation"></a>22.3&nbsp;Java Implementation</h2></div></div></div>

<p>Each of the provided components uses the <code class="literal">o.s.i.jpa.core.JpaExecutor</code> class, which, in turn, uses an implementation of the <code class="literal">o.s.i.jpa.core.JpaOperations</code> interface.
<code class="literal">JpaOperations</code> operates like a typical Data Access Object (DAO) and provides methods such as find, persist, executeUpdate, and so on.
For most use cases, the default implementation (<code class="literal">o.s.i.jpa.core.DefaultJpaOperations</code>) should be sufficient.
However, you can specify your own implementation if you require custom behavior.</p>
<p>To initialize a <code class="literal">JpaExecutor</code>, you must use one of the constructors that accept one of:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
EntityManagerFactory
</li><li class="listitem">
EntityManager
</li><li class="listitem">
JpaOperations
</li></ul></div>
<p>The following example shows how to initialize a <code class="literal">JpaExecutor</code> with an <code class="literal">entityManagerFactory</code> and use it in an outbound gateway:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> JpaExecutor jpaExecutor() {
    JpaExecutor executor = <span class="hl-keyword">new</span> JpaExecutor(<span class="hl-keyword">this</span>.entityManagerFactory);
    executor.setJpaParameters(Collections.singletonList(<span class="hl-keyword">new</span> JpaParameter(<span class="hl-string">"firstName"</span>, null, <span class="hl-string">"#this"</span>)));
    executor.setUsePayloadAsParameterSource(true);
    executor.setExpectSingleResult(true);
    <span class="hl-keyword">return</span> executor;
}

<em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "getEntityChannel")</span></em>
<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> MessageHandler retrievingJpaGateway() {
    JpaOutboundGateway gateway = <span class="hl-keyword">new</span> JpaOutboundGateway(jpaExecutor());
    gateway.setGatewayType(OutboundGatewayType.RETRIEVING);
    gateway.setOutputChannelName(<span class="hl-string">"resultsChannel"</span>);
    <span class="hl-keyword">return</span> gateway;
}</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jpa-namespace-support" href="#jpa-namespace-support"></a>22.4&nbsp;Namespace Support</h2></div></div></div>

<p>When using XML namespace support, the underlying parser classes instantiate the relevant Java classes for you.
Thus, you typically need not deal with the inner workings of the JPA adapter.
This section documents the XML namespace support provided by Spring Integration and shows you how to use the XML Namespace support to configure the JPA components.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jpa-namespace-support-common-attributes" href="#jpa-namespace-support-common-attributes"></a>22.4.1&nbsp;Common XML Namespace Configuration Attributes</h3></div></div></div>

<p>Certain configuration parameters are shared by all JPA components:</p>
<div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">auto-startup</code></span></dt><dd>
Lifecycle attribute that signals whether this component should be started during application context startup.
Defaults to <code class="literal">true</code>.
Optional.
</dd><dt><span class="term"><code class="literal">id</code></span></dt><dd>
Identifies the underlying Spring bean definition, which is an instance of either <code class="literal">EventDrivenConsumer</code> or <code class="literal">PollingConsumer</code>.
Optional.
</dd><dt><span class="term"><code class="literal">entity-manager-factory</code></span></dt><dd>
The reference to the JPA entity manager factory that the adapter uses to create the <code class="literal">EntityManager</code>.
You must provide this attribute, the <code class="literal">entity-manager</code> attribute, or the <code class="literal">jpa-operations</code> attribute.
</dd><dt><span class="term"><code class="literal">entity-manager</code></span></dt><dd>
<p class="simpara">The reference to the JPA Entity Manager that the component uses.
You must provide this attribute, the <code class="literal">entity-manager-factory</code> attribute, or the <code class="literal">jpa-operations</code> attribute.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Usually, your Spring application context defines only a JPA entity manager factory, and the <code class="literal">EntityManager</code> is injected by using the <code class="literal">@PersistenceContext</code> annotation.
This approach does not apply for the Spring Integration JPA components.
Usually, injecting the JPA entity manager factory is best, but, when you want to inject an <code class="literal">EntityManager</code> explicitly, you have to define a <code class="literal">SharedEntityManagerBean</code>.
For more information, see the relevant <a class="ulink" href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/orm/jpa/support/SharedEntityManagerBean.html" target="_top">Javadoc</a>.</p>
</td></tr></table></div>
<p class="simpara">The following example shows how to explicitly include an entity manager factory:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"entityManager"</span>
      <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.orm.jpa.support.SharedEntityManagerBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"entityManagerFactory"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"entityManagerFactoryBean"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
</div>
</dd><dt><span class="term"><code class="literal">jpa-operations</code></span></dt><dd>
A reference to a bean that implements the <code class="literal">JpaOperations</code> interface.
In rare cases, it might be advisable to provide your own implementation of the <code class="literal">JpaOperations</code> interface instead of relying on the default implementation (<code class="literal">org.springframework.integration.jpa.core.DefaultJpaOperations</code>).
If you use the <code class="literal">jpa-operations</code> attribute, you must not provide the JPA entity manager or JPA entity manager factory, because <code class="literal">JpaOperations</code> wraps the necessary datasource.
</dd><dt><span class="term"><code class="literal">entity-class</code></span></dt><dd>
<p class="simpara">The fully qualified name of the entity class.
The exact semantics of this attribute vary, depending on whether we are performing a persist or update operation or whether we are retrieving objects from the database.</p>
<p class="simpara">When retrieving data, you can specify the <code class="literal">entity-class</code> attribute to indicate that you would like to retrieve objects of this type from the database.
In that case, you must not define any of the query attributes (<code class="literal">jpa-query</code>, <code class="literal">native-query</code>, or <code class="literal">named-query</code>).</p>
<p class="simpara">When persisting data, the <code class="literal">entity-class</code> attribute indicates the type of object to persist.
If not specified (for persist operations) the entity class is automatically retrieved from the message&#8217;s payload.</p>
</dd><dt><span class="term"><code class="literal">jpa-query</code></span></dt><dd>
Defines the JPA query (Java Persistence Query Language) to be used.
</dd><dt><span class="term"><code class="literal">native-query</code></span></dt><dd>
Defines the native SQL query to be used.
</dd><dt><span class="term"><code class="literal">named-query</code></span></dt><dd>
Refers to a named query.
A named query can be defined in either Native SQL or JPAQL, but the underlying JPA persistence provider handles that distinction internally.
</dd></dl></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jpa-parameters" href="#jpa-parameters"></a>22.4.2&nbsp;Providing JPA Query Parameters</h3></div></div></div>

<p>To provide parameters, you can use the <code class="literal">parameter</code> XML element.
It has a mechanism that lets you provide parameters for queries that are based on either the Java Persistence Query Language (JPQL) or native SQL queries.
You can also provide parameters for named queries.</p>
<div class="variablelist"><dl class="variablelist"><dt><span class="term">Expression-based Parameters</span></dt><dd>
<p class="simpara">The following example shows how to set an expression-based parameter:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-jpa:parameter</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"payload.name"</span> <span class="hl-attribute">name</span>=<span class="hl-value">"firstName"</span><span class="hl-tag">/&gt;</span></pre>
</div>
</dd><dt><span class="term">Value-based Parameters</span></dt><dd>
<p class="simpara">The following example shows how to set an value-based parameter:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-jpa:parameter</span> <span class="hl-attribute">name</span>=<span class="hl-value">"name"</span> <span class="hl-attribute">type</span>=<span class="hl-value">"java.lang.String"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"myName"</span><span class="hl-tag">/&gt;</span></pre>
</div>
</dd><dt><span class="term">Positional Parameters</span></dt><dd>
<p class="simpara">The following example shows how to set an expression-based parameter:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-jpa:parameter</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"payload.name"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;int-jpa:parameter</span> <span class="hl-attribute">type</span>=<span class="hl-value">"java.lang.Integer"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"21"</span><span class="hl-tag">/&gt;</span></pre>
</div>
</dd></dl></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jpa-transactions" href="#jpa-transactions"></a>22.4.3&nbsp;Transaction Handling</h3></div></div></div>

<p>All JPA operations (such as <code class="literal">INSERT</code>, <code class="literal">UPDATE</code>, and <code class="literal">DELETE</code>) require a transaction to be active whenever they are performed.
For inbound channel adapters, you need do nothing special.
It works similarly to the way we configure transaction managers with pollers that are used with other inbound channel adapters.
The following XML example configures a transaction manager that uses a poller with an inbound channel adapter:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-jpa:inbound-channel-adapter</span>
    <span class="hl-attribute">channel</span>=<span class="hl-value">"inboundChannelAdapterOne"</span>
    <span class="hl-attribute">entity-manager</span>=<span class="hl-value">"em"</span>
    <span class="hl-attribute">auto-startup</span>=<span class="hl-value">"true"</span>
    <span class="hl-attribute">jpa-query</span>=<span class="hl-value">"select s from Student s"</span>
    <span class="hl-attribute">expect-single-result</span>=<span class="hl-value">"true"</span>
    <span class="hl-attribute">delete-after-poll</span>=<span class="hl-value">"true"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"2000"</span><span class="hl-tag"> &gt;</span>
        <span class="hl-tag">&lt;int:transactional</span> <span class="hl-attribute">propagation</span>=<span class="hl-value">"REQUIRED"</span>
            <span class="hl-attribute">transaction-manager</span>=<span class="hl-value">"transactionManager"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/int:poller&gt;</span>
<span class="hl-tag">&lt;/int-jpa:inbound-channel-adapter&gt;</span></pre>
</div>
<p>However, you may need to specifically start a transaction when using an outbound channel adapter or gateway.
If a <code class="literal">DirectChannel</code> is an input channel for the outbound adapter or gateway and if the transaction is active in the current thread of execution, the JPA operation is performed in the same transaction context.
You can also configure this JPA operation to run as a new transaction, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-jpa:outbound-gateway</span>
    <span class="hl-attribute">request-channel</span>=<span class="hl-value">"namedQueryRequestChannel"</span>
    <span class="hl-attribute">reply-channel</span>=<span class="hl-value">"namedQueryResponseChannel"</span>
    <span class="hl-attribute">named-query</span>=<span class="hl-value">"updateStudentByRollNumber"</span>
    <span class="hl-attribute">entity-manager</span>=<span class="hl-value">"em"</span>
    <span class="hl-attribute">gateway-type</span>=<span class="hl-value">"UPDATING"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int-jpa:parameter</span> <span class="hl-attribute">name</span>=<span class="hl-value">"lastName"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"payload"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int-jpa:parameter</span> <span class="hl-attribute">name</span>=<span class="hl-value">"rollNumber"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"headers['rollNumber']"</span><span class="hl-tag">/&gt;</span>
		<span class="hl-tag">&lt;int-jpa:transactional</span> <span class="hl-attribute">propagation</span>=<span class="hl-value">"REQUIRES_NEW"</span>
        <span class="hl-attribute">transaction-manager</span>=<span class="hl-value">"transactionManager"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-jpa:outbound-gateway&gt;</span></pre>
</div>
<p>In the preceding example, the transactional element of the outbound gateway or adapter specifies the transaction attributes.
It is optional to define this child element if you have <code class="literal">DirectChannel</code> as an input channel to the adapter and you want the adapter to execute the operations in the same transaction context as the caller.
If, however, you use an <code class="literal">ExecutorChannel</code>, you must have the <code class="literal">transactional</code> element, because the invoking client&#8217;s transaction context is not propagated.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Unlike the <code class="literal">transactional</code> element of the poller, which is defined in Spring Integration&#8217;s namespace, the <code class="literal">transactional</code> element for the outbound gateway or adapter is defined in the JPA namespace.</p>
</td></tr></table></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jpa-inbound-channel-adapter" href="#jpa-inbound-channel-adapter"></a>22.5&nbsp;Inbound Channel Adapter</h2></div></div></div>

<p>An inbound channel adapter is used to execute a select query over the database using JPA QL and return the result.
The message payload is either a single entity or a <code class="literal">List</code> of entities.
The following XML configures an <code class="literal">inbound-channel-adapter</code>:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-jpa:inbound-channel-adapter</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"inboundChannelAdapterOne"</span>  <a name="CO29-1" href="#CO29-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
                    entity-manager="em"                              <a name="CO29-2" href="#CO29-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
                    auto-startup="true"                              <a name="CO29-3" href="#CO29-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
                    query="select s from Student s"                  <a name="CO29-4" href="#CO29-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
                    expect-single-result="true"                      <a name="CO29-5" href="#CO29-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
                    max-results=""                                   <a name="CO29-6" href="#CO29-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>
                    max-results-expression=""                        <a name="CO29-7" href="#CO29-7"></a><span><img src="images/callouts/7.png" alt="7" border="0"></span>
                    delete-after-poll="true"                         <a name="CO29-8" href="#CO29-8"></a><span><img src="images/callouts/8.png" alt="8" border="0"></span>
                    flush-after-delete="true"&gt;                       <a name="CO29-9" href="#CO29-9"></a><span><img src="images/callouts/9.png" alt="9" border="0"></span>
    <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"2000"</span><span class="hl-tag"> &gt;</span>
      <span class="hl-tag">&lt;int:transactional</span> <span class="hl-attribute">propagation</span>=<span class="hl-value">"REQUIRED"</span> <span class="hl-attribute">transaction-manager</span>=<span class="hl-value">"transactionManager"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/int:poller&gt;</span>
<span class="hl-tag">&lt;/int-jpa:inbound-channel-adapter&gt;</span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO29-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The channel over which the <code class="literal">inbound-channel-adapter</code> puts the messages (with the payload) after executing the JPA QL in the <code class="literal">query</code> attribute.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO29-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The <code class="literal">EntityManager</code> instance used to perform the required JPA operations.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO29-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Attribute signaling whether the component should automatically start when the application context starts.
The value defaults to <code class="literal">true</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO29-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The JPA QL whose result are sent out as the payload of the message</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO29-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>This attribute tells whether the JPQL query gives a single entity in the result or a <code class="literal">List</code> of entities.
If the value is set to <code class="literal">true</code>, the single entity is sent as the payload of the message.
If, however, multiple results are returned after setting this to <code class="literal">true</code>, a <code class="literal">MessagingException</code> is thrown.
The value defaults to <code class="literal">false</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO29-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>This non-zero, non-negative integer value tells the adapter not to select more than the given number of rows on execution of the select operation.
By default, if this attribute is not set, all possible records are selected by the query.
This attribute is mutually exclusive with <code class="literal">max-results-expression</code>.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO29-7"><span><img src="images/callouts/7.png" alt="7" border="0"></span></a> </p></td><td valign="top" align="left">
<p>An expression that is evaluated to find the maximum number of results in a result set.
Mutually exclusive with <code class="literal">max-results</code>.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO29-8"><span><img src="images/callouts/8.png" alt="8" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Set this value to <code class="literal">true</code> if you want to delete the rows received after execution of the query.
You must ensure that the component operates as part of a transaction.
Otherwise, you may encounter an exception such as: <code class="literal">java.lang.IllegalArgumentException: Removing a detached instance ...</code></p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO29-9"><span><img src="images/callouts/9.png" alt="9" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Set this value to <code class="literal">true</code> if you want to flush the persistence context immediately after deleting received entities and if you do not want to rely on the <code class="literal">flushMode</code> of the <code class="literal">EntityManager</code>.
The value defaults to <code class="literal">false</code>.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jpaInboundChannelAdapterParameters" href="#jpaInboundChannelAdapterParameters"></a>22.5.1&nbsp;Configuration Parameter Reference</h3></div></div></div>

<p>The following listing shows all the values that can be set for an <code class="literal">inbound-channel-adapter</code>:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-jpa:inbound-channel-adapter</span>
  <span class="hl-attribute">auto-startup</span>=<span class="hl-value">"true"</span>           <a name="CO30-1" href="#CO30-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
  channel=""                    <a name="CO30-2" href="#CO30-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
  delete-after-poll="false"     <a name="CO30-3" href="#CO30-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
  delete-per-row="false"        <a name="CO30-4" href="#CO30-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
  entity-class=""               <a name="CO30-5" href="#CO30-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
  entity-manager=""             <a name="CO30-6" href="#CO30-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>
  entity-manager-factory=""     <a name="CO30-7" href="#CO30-7"></a><span><img src="images/callouts/7.png" alt="7" border="0"></span>
  expect-single-result="false"  <a name="CO30-8" href="#CO30-8"></a><span><img src="images/callouts/8.png" alt="8" border="0"></span>
  id=""
  jpa-operations=""             <a name="CO30-9" href="#CO30-9"></a><span><img src="images/callouts/9.png" alt="9" border="0"></span>
  jpa-query=""                  <a name="CO30-10" href="#CO30-10"></a><span><img src="images/callouts/10.png" alt="10" border="0"></span>
  named-query=""                <a name="CO30-11" href="#CO30-11"></a><span><img src="images/callouts/11.png" alt="11" border="0"></span>
  native-query=""               <a name="CO30-12" href="#CO30-12"></a><span><img src="images/callouts/12.png" alt="12" border="0"></span>
  parameter-source=""           <a name="CO30-13" href="#CO30-13"></a><span><img src="images/callouts/13.png" alt="13" border="0"></span>
  send-timeout=""&gt;              <a name="CO30-14" href="#CO30-14"></a><span><img src="images/callouts/14.png" alt="14" border="0"></span>
  <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"myPoller"</span><span class="hl-tag">/&gt;</span>
 <span class="hl-tag">&lt;/int-jpa:inbound-channel-adapter&gt;</span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO30-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>This lifecycle attribute signals whether this component should automatically start when the application context starts.
This attribute defaults to <code class="literal">true</code>.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO30-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The channel to which the adapter sends a message with the payload from performing the desired JPA operation.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO30-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A boolean flag that indicates whether to delete the selected records after they have been polled by the adapter.
By default, the value is <code class="literal">false</code> (that is, the records are not deleted).
You must ensure that the component operates as part of a transaction.
Otherwise, you may encounter an exception, such as: <code class="literal">java.lang.IllegalArgumentException: Removing a detached instance ...</code>.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO30-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A boolean flag that indicates whether the records can be deleted in bulk or must be deleted one record at a time.
By default the value is <code class="literal">false</code> (that is, the records can be bulk-deleted).
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO30-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The fully qualified name of the entity class to be queried from the database.
The adapter automatically builds a JPA Query based on the entity class name.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO30-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>An instance of <code class="literal">javax.persistence.EntityManager</code> used to perform the JPA operations.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO30-7"><span><img src="images/callouts/7.png" alt="7" border="0"></span></a> </p></td><td valign="top" align="left">
<p>An instance of <code class="literal">javax.persistence.EntityManagerFactory</code> used to obtain an instance of <code class="literal">javax.persistence.EntityManager</code> that performs the JPA operations.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO30-8"><span><img src="images/callouts/8.png" alt="8" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A boolean flag indicating whether the select operation is expected to return a single result or a <code class="literal">List</code> of results.
If this flag is set to <code class="literal">true</code>, the single entity selected is sent as the payload of the message.
If multiple entities are returned, an exception is thrown.
If <code class="literal">false</code>, the <code class="literal">List</code> of entities is sent as the payload of the message.
The value defaults to <code class="literal">false</code>.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO30-9"><span><img src="images/callouts/9.png" alt="9" border="0"></span></a> </p></td><td valign="top" align="left">
<p>An implementation of <code class="literal">org.springframework.integration.jpa.core.JpaOperations</code> used to perform the JPA operations.
We recommend not providing an implementation of your own but using the default <code class="literal">org.springframework.integration.jpa.core.DefaultJpaOperations</code> implementation.
You can use any of the <code class="literal">entity-manager</code>, <code class="literal">entity-manager-factory</code>, or <code class="literal">jpa-operations</code> attributes.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO30-10"><span><img src="images/callouts/10.png" alt="10" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The JPA QL to be executed by this adapter.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO30-11"><span><img src="images/callouts/11.png" alt="11" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The named query that needs to be executed by this adapter.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO30-12"><span><img src="images/callouts/12.png" alt="12" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The native query executed by this adapter.
You can use any of the <code class="literal">jpa-query</code>, <code class="literal">named-query</code>, <code class="literal">entity-class</code>, or <code class="literal">native-query</code> attributes.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO30-13"><span><img src="images/callouts/13.png" alt="13" border="0"></span></a> </p></td><td valign="top" align="left">
<p>An implementation of <code class="literal">o.s.i.jpa.support.parametersource.ParameterSource</code> used to resolve the values of the parameters in the query.
Ignored if the <code class="literal">entity-class</code> attribute has a value.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO30-14"><span><img src="images/callouts/14.png" alt="14" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Maximum amount of time (in milliseconds) to wait when sending a message to the channel.
Optional.</p>
</td></tr></table></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_with_java_configuration_13" href="#_configuring_with_java_configuration_13"></a>22.5.2&nbsp;Configuring with Java Configuration</h3></div></div></div>

<p>The following Spring Boot application shows an example of how to configure the inbound adapter with Java:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@SpringBootApplication</span></em>
<em><span class="hl-annotation" style="color: gray">@EntityScan(basePackageClasses = StudentDomain.class)</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> JpaJavaApplication {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
        <span class="hl-keyword">new</span> SpringApplicationBuilder(JpaJavaApplication.<span class="hl-keyword">class</span>)
            .web(false)
            .run(args);
    }

    <em><span class="hl-annotation" style="color: gray">@Autowired</span></em>
    <span class="hl-keyword">private</span> EntityManagerFactory entityManagerFactory;

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> JpaExecutor jpaExecutor() {
        JpaExecutor executor = <span class="hl-keyword">new</span> JpaExecutor(<span class="hl-keyword">this</span>.entityManagerFactory);
        jpaExecutor.setJpaQuery(<span class="hl-string">"from Student"</span>);
        <span class="hl-keyword">return</span> executor;
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <em><span class="hl-annotation" style="color: gray">@InboundChannelAdapter(channel = "jpaInputChannel",
                     poller = @Poller(fixedDelay = "${poller.interval}"))</span></em>
    <span class="hl-keyword">public</span> MessageSource&lt;?&gt; jpaInbound() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> JpaPollingChannelAdapter(jpaExecutor());
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "jpaInputChannel")</span></em>
    <span class="hl-keyword">public</span> MessageHandler handler() {
        <span class="hl-keyword">return</span> message -&gt; System.out.println(message.getPayload());
    }

}</pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_with_the_java_dsl_14" href="#_configuring_with_the_java_dsl_14"></a>22.5.3&nbsp;Configuring with the Java DSL</h3></div></div></div>

<p>The following Spring Boot application shows an example of how to configure the inbound adapter with the Java DSL:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@SpringBootApplication</span></em>
<em><span class="hl-annotation" style="color: gray">@EntityScan(basePackageClasses = StudentDomain.class)</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> JpaJavaApplication {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
        <span class="hl-keyword">new</span> SpringApplicationBuilder(JpaJavaApplication.<span class="hl-keyword">class</span>)
            .web(false)
            .run(args);
    }

    <em><span class="hl-annotation" style="color: gray">@Autowired</span></em>
    <span class="hl-keyword">private</span> EntityManagerFactory entityManagerFactory;

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> IntegrationFlow pollingAdapterFlow() {
        <span class="hl-keyword">return</span> IntegrationFlows
            .from(Jpa.inboundAdapter(<span class="hl-keyword">this</span>.entityManagerFactory)
                        .entityClass(StudentDomain.<span class="hl-keyword">class</span>)
                        .maxResults(<span class="hl-number">1</span>)
                        .expectSingleResult(true),
                e -&gt; e.poller(p -&gt; p.trigger(<span class="hl-keyword">new</span> OnlyOnceTrigger())))
            .channel(c -&gt; c.queue(<span class="hl-string">"pollingResults"</span>))
            .get();
    }

}</pre>
</div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jpa-outbound-channel-adapter" href="#jpa-outbound-channel-adapter"></a>22.6&nbsp;Outbound Channel Adapter</h2></div></div></div>

<p>The JPA outbound channel adapter lets you accept messages over a request channel.
The payload can either be used as the entity to be persisted or used with the headers in the parameter expressions for a JPQL query.
The following sections cover the possible ways of performing these operations.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jpa-outbound-channel-adapter-entity-class" href="#jpa-outbound-channel-adapter-entity-class"></a>22.6.1&nbsp;Using an Entity Class</h3></div></div></div>

<p>The following XML configures the outbound channel adapter to persist an entity to the database:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-jpa:outbound-channel-adapter</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"entityTypeChannel"</span>               <a name="CO31-1" href="#CO31-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
    entity-class="org.springframework.integration.jpa.test.entity.Student"  <a name="CO31-2" href="#CO31-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
    persist-mode="PERSIST"                                                  <a name="CO31-3" href="#CO31-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
    entity-manager="em"/ &gt;                                                  <a name="CO31-4" href="#CO31-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO31-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The channel over which a valid JPA entity is sent to the JPA outbound channel adapter.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO31-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The fully qualified name of the entity class accepted by the adapter to be persisted in the database.
You can actually leave off this attribute in most cases as the adapter can determine the entity class automatically from the Spring Integration message payload.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO31-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The operation to be done by the adapter.
The valid values are <code class="literal">PERSIST</code>, <code class="literal">MERGE</code>, and <code class="literal">DELETE</code>.
The default value is <code class="literal">MERGE</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO31-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The JPA entity manager to be used.</p>
</td></tr></table></div>
</div>
<p>These four attributes of the <code class="literal">outbound-channel-adapter</code> configure it to accept entities over the input channel and process them to <code class="literal">PERSIST</code>, <code class="literal">MERGE</code>, or <code class="literal">DELETE</code> the entities from the underlying data source.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>As of Spring Integration 3.0, payloads to <code class="literal">PERSIST</code> or <code class="literal">MERGE</code> can also be of type <code class="literal">http://docs.oracle.com/javase/7/docs/api/java/lang/Iterable.html[java.lang.Iterable]</code>.
In that case, each object returned by the <code class="literal">Iterable</code> is treated as an entity and persisted or merged using the underlying <code class="literal">EntityManager</code>.
Null values returned by the iterator are ignored.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jpa-using-jpaql" href="#jpa-using-jpaql"></a>22.6.2&nbsp;Using JPA Query Language (JPA QL)</h3></div></div></div>

<p>The <a class="link" href="#jpa-outbound-channel-adapter-entity-class" title="22.6.1&nbsp;Using an Entity Class">previous section</a> showed how to perform a <code class="literal">PERSIST</code> action by using an entity.
This section shows how to use an outbound channel adapter with JPA QL.</p>
<p>The following XML configures the outbound channel adapter to persist an entity to the database:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-jpa:outbound-channel-adapter</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"jpaQlChannel"</span>                                      <a name="CO32-1" href="#CO32-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
  jpa-query="update Student s set s.firstName = :firstName where s.rollNumber = :rollNumber"  <a name="CO32-2" href="#CO32-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
  entity-manager="em"&gt;                                                                        <a name="CO32-3" href="#CO32-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
    <span class="hl-tag">&lt;int-jpa:parameter</span> <span class="hl-attribute">name</span>=<span class="hl-value">"firstName"</span>  <span class="hl-attribute">expression</span>=<span class="hl-value">"payload['firstName']"</span><span class="hl-tag">/&gt;</span>                  <a name="CO32-4" href="#CO32-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
    <span class="hl-tag">&lt;int-jpa:parameter</span> <span class="hl-attribute">name</span>=<span class="hl-value">"rollNumber"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"payload['rollNumber']"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-jpa:outbound-channel-adapter&gt;</span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO32-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The input channel over which the message is sent to the outbound channel adapter.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO32-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The JPA QL to execute.
This query may contain parameters that are evaluated by using the <code class="literal">parameter</code> element.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO32-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The entity manager used by the adapter to perform the JPA operations.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO32-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The elements (one for each parameter) used to define the value of the parameter names for the JPA QL specified in the <code class="literal">query</code> attribute.</p>
</td></tr></table></div>
</div>
<p>The <code class="literal">parameter</code> element accepts an attribute whose <code class="literal">name</code> corresponds to the named parameter specified in the provided JPA QL (point 2 in the preceding example).
The value of the parameter can either be static or be derived by using an expression.
The static value and the expression to derive the value are specified using the <code class="literal">value</code> and <code class="literal">expression</code> attributes, respectively.
These attributes are mutually exclusive.</p>
<p>If the <code class="literal">value</code> attribute is specified, you can provide an optional <code class="literal">type</code> attribute.
The value of this attribute is the fully qualified name of the class whose value is represented by the <code class="literal">value</code> attribute.
By default, the type is assumed to be a <code class="literal">java.lang.String</code>.
The following example shows how to define a JPA parameter:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-jpa:outbound-channel-adapter</span> <span class="hl-attribute">...</span><span class="hl-tag">
&gt;</span>
    <span class="hl-tag">&lt;int-jpa:parameter</span> <span class="hl-attribute">name</span>=<span class="hl-value">"level"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"2"</span> <span class="hl-attribute">type</span>=<span class="hl-value">"java.lang.Integer"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int-jpa:parameter</span> <span class="hl-attribute">name</span>=<span class="hl-value">"name"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"payload['name']"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-jpa:outbound-channel-adapter&gt;</span></pre>
</div>
<p>As the preceding example shows, you can use multiple <code class="literal">parameter</code> elements within an outbound channel adapter element and define some parameters by using expressions and others with static values.
However, take care not to specify the same parameter name multiple times.
You should provide one <code class="literal">parameter</code> element for each named parameter specified in the JPA query.
For example, we specify two parameters: <code class="literal">level</code> and <code class="literal">name</code>.
The <code class="literal">level</code> attribute is a static value of type <code class="literal">java.lang.Integer</code>, while the <code class="literal">name</code> attribute is derived from the payload of the message.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Though specifying <code class="literal">select</code> is valid for JPA QL, it makes no sense to do so.
Outbound channel adapters do not return any result.
If you want to select some values, consider using the outbound gateway instead.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jpa-using-native-queries" href="#jpa-using-native-queries"></a>22.6.3&nbsp;Using Native Queries</h3></div></div></div>

<p>This section describes how to use native queries to perform operations with the JPA outbound channel adapter.
Using native queries is similar to using JPA QL, except that the queries are native database queries.
By using native queries, we lose database vendor independence, which we get using JPA QL.</p>
<p>One of the things we can achieve by using native queries is to perform database inserts, which is not possible with JPA QL.
(To perform inserts, we send JPA entities to the channel adapter, as <a class="link" href="#jpa-outbound-channel-adapter-entity-class" title="22.6.1&nbsp;Using an Entity Class">described earlier</a>).
Below is a small xml fragment that demonstrates the use of native query to insert values in a table.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Named parameters may not be supported by your JPA provider in conjunction with native SQL queries.
While they work fine with Hibernate, OpenJPA and EclipseLink do not support them. See <a class="ulink" href="https://issues.apache.org/jira/browse/OPENJPA-111" target="_top">https://issues.apache.org/jira/browse/OPENJPA-111</a>. Section 3.8.12 of the JPA 2.0 spec states: "<code class="literal">Only positional parameter binding and positional access to result items may be portably used for native queries.</code>"</p>
</td></tr></table></div>
<p>The following example configures an outbound-channel-adapter with a native query:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-jpa:outbound-channel-adapter</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"nativeQlChannel"</span>
  <span class="hl-attribute">native-query</span>=<span class="hl-value">"insert into STUDENT_TABLE(FIRST_NAME,LAST_UPDATED) values (:lastName,:lastUpdated)"</span>  <a name="CO33-1" href="#CO33-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
  entity-manager="em"&gt;
    <span class="hl-tag">&lt;int-jpa:parameter</span> <span class="hl-attribute">name</span>=<span class="hl-value">"lastName"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"payload['updatedLastName']"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int-jpa:parameter</span> <span class="hl-attribute">name</span>=<span class="hl-value">"lastUpdated"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"new java.util.Date()"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-jpa:outbound-channel-adapter&gt;</span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO33-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The native query executed by this outbound channel adapter.</p>
</td></tr></table></div>
</div>
<p>Note that the other attributes (such as <code class="literal">channel</code> and <code class="literal">entity-manager</code>) and the <code class="literal">parameter</code> element have the same semantics as they do for JPA QL.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_using_named_queries" href="#_using_named_queries"></a>22.6.4&nbsp;Using Named Queries</h3></div></div></div>

<p>Using named queries is similar to using <a class="link" href="#jpa-using-jpaql" title="22.6.2&nbsp;Using JPA Query Language (JPA QL)">JPA QL</a> or a <a class="link" href="#jpa-using-native-queries" title="22.6.3&nbsp;Using Native Queries">native query</a>, except that we specify a named query instead of a query.
First, we cover how to define a JPA named query. Then we cover how to declare an outbound channel adapter to work with a named query.
If we have an entity called <code class="literal">Student</code>, we can use annotations on the <code class="literal">Student</code> class to define two named queries: <code class="literal">selectStudent</code> and <code class="literal">updateStudent</code>.
The following example shows how to do so:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Entity</span></em>
<em><span class="hl-annotation" style="color: gray">@Table(name="Student")</span></em>
<em><span class="hl-annotation" style="color: gray">@NamedQueries({
    @NamedQuery(name="selectStudent",
        query="select s from Student s where s.lastName = 'Last One'"),
    @NamedQuery(name="updateStudent",
        query="update Student s set s.lastName = :lastName,
               lastUpdated = :lastUpdated where s.id in (select max(a.id) from Student a)")
})</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> Student {

...
}</pre>
</div>
<p>Alternatively, you can use orm.xml to define named queries as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;entity-mappings</span> <span class="hl-attribute">...&gt;</span>
    <span class="hl-attribute">...</span>
    <span class="hl-attribute">&lt;named-query</span> <span class="hl-attribute">name</span>=<span class="hl-value">"selectStudent"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;query&gt;</span>select s from Student s where s.lastName = 'Last One'<span class="hl-tag">&lt;/query&gt;</span>
    <span class="hl-tag">&lt;/named-query&gt;</span>
<span class="hl-tag">&lt;/entity-mappings&gt;</span></pre>
</div>
<p>Now that we have shown how to define named queries by using annotations or by using <code class="literal">orm.xml</code>, we now show a small XML fragment that defines an <code class="literal">outbound-channel-adapter</code> by using a named query, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-jpa:outbound-channel-adapter</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"namedQueryChannel"</span>
            <span class="hl-attribute">named-query</span>=<span class="hl-value">"updateStudent"</span>	 <a name="CO34-1" href="#CO34-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
            entity-manager="em"&gt;
        <span class="hl-tag">&lt;int-jpa:parameter</span> <span class="hl-attribute">name</span>=<span class="hl-value">"lastName"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"payload['updatedLastName']"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;int-jpa:parameter</span> <span class="hl-attribute">name</span>=<span class="hl-value">"lastUpdated"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"new java.util.Date()"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-jpa:outbound-channel-adapter&gt;</span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO34-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The named query that we want the adapter to execute when it receives a message over the channel.</p>
</td></tr></table></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jpaOutboundChannelAdapterParameters" href="#jpaOutboundChannelAdapterParameters"></a>22.6.5&nbsp;Configuration Parameter Reference</h3></div></div></div>

<p>The following listing shows all the attributes that you can set on an outbound channel adapter:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-jpa:outbound-channel-adapter</span>
  <span class="hl-attribute">auto-startup</span>=<span class="hl-value">"true"</span>  <a name="CO35-1" href="#CO35-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
  channel=""  <a name="CO35-2" href="#CO35-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
  entity-class=""  <a name="CO35-3" href="#CO35-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
  entity-manager=""  <a name="CO35-4" href="#CO35-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
  entity-manager-factory=""  <a name="CO35-5" href="#CO35-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
  id=""
  jpa-operations=""  <a name="CO35-6" href="#CO35-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>
  jpa-query=""  <a name="CO35-7" href="#CO35-7"></a><span><img src="images/callouts/7.png" alt="7" border="0"></span>
  named-query=""  <a name="CO35-8" href="#CO35-8"></a><span><img src="images/callouts/8.png" alt="8" border="0"></span>
  native-query=""  <a name="CO35-9" href="#CO35-9"></a><span><img src="images/callouts/9.png" alt="9" border="0"></span>
  order=""  <a name="CO35-10" href="#CO35-10"></a><span><img src="images/callouts/10.png" alt="10" border="0"></span>
  parameter-source-factory=""   <a name="CO35-11" href="#CO35-11"></a><span><img src="images/callouts/11.png" alt="11" border="0"></span>
  persist-mode="MERGE"   <a name="CO35-12" href="#CO35-12"></a><span><img src="images/callouts/12.png" alt="12" border="0"></span>
  flush="true"   <a name="CO35-13" href="#CO35-13"></a><span><img src="images/callouts/13.png" alt="13" border="0"></span>
  flush-size="10"   <a name="CO35-14" href="#CO35-14"></a><span><img src="images/callouts/14.png" alt="14" border="0"></span>
  clear-on-flush="true"   <a name="CO35-15" href="#CO35-15"></a><span><img src="images/callouts/15.png" alt="15" border="0"></span>
  use-payload-as-parameter-source="true"   <a name="CO35-16" href="#CO35-16"></a>(16)
	<span class="hl-tag">&lt;int:poller/&gt;</span>
	<span class="hl-tag">&lt;int-jpa:transactional/&gt;</span>    <a name="CO35-17" href="#CO35-17"></a>(17)
	<span class="hl-tag">&lt;int-jpa:parameter/&gt;</span>    <a name="CO35-18" href="#CO35-18"></a>(18)
<span class="hl-tag">&lt;/int-jpa:outbound-channel-adapter&gt;</span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO35-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Lifecycle attribute signaling whether this component should start during application context startup.
It defaults to <code class="literal">true</code>.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO35-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The channel from which the outbound adapter receives messages for performing the desired operation.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO35-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The fully qualified name of the entity class for the JPA Operation.
The <code class="literal">entity-class</code>, <code class="literal">query</code>, and <code class="literal">named-query</code> attributes are mutually exclusive.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO35-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>An instance of <code class="literal">javax.persistence.EntityManager</code> used to perform the JPA operations.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO35-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>An instance of <code class="literal">javax.persistence.EntityManagerFactory</code> used to obtain an instance of <code class="literal">javax.persistence.EntityManager</code>, which performs the JPA operations.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO35-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>An implementation of <code class="literal">org.springframework.integration.jpa.core.JpaOperations</code> used to perform the JPA operations.
We recommend not providing an implementation of your own but using the default <code class="literal">org.springframework.integration.jpa.core.DefaultJpaOperations</code> implementation.
You can use any one of the <code class="literal">entity-manager</code>, <code class="literal">entity-manager-factory</code>, or <code class="literal">jpa-operations</code> attributes.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO35-7"><span><img src="images/callouts/7.png" alt="7" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The JPA QL to be executed by this adapter.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO35-8"><span><img src="images/callouts/8.png" alt="8" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The named query that needs to be executed by this adapter.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO35-9"><span><img src="images/callouts/9.png" alt="9" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The native query to be executed by this adapter.
You can use any one of the <code class="literal">jpa-query</code>, <code class="literal">named-query</code>, or <code class="literal">native-query</code> attributes.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO35-10"><span><img src="images/callouts/10.png" alt="10" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The order for this consumer when multiple consumers are registered, thereby managing load-balancing and failover.
It defaults to <code class="literal">Ordered.LOWEST_PRECEDENCE</code>.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO35-11"><span><img src="images/callouts/11.png" alt="11" border="0"></span></a> </p></td><td valign="top" align="left">
<p>An instance of <code class="literal">o.s.i.jpa.support.parametersource.ParameterSourceFactory</code> used to get an instance of <code class="literal">o.s.i.jpa.support.parametersource.ParameterSource</code>, which is used to resolve the values of the parameters in the query.
Ignored if you perform operations by using a JPA entity.
The <code class="literal">parameter</code> sub-elements are mutually exclusive with the <code class="literal">parameter-source-factory</code> attribute and must be configured on the provided <code class="literal">ParameterSourceFactory</code>.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO35-12"><span><img src="images/callouts/12.png" alt="12" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Accepts one of the following: <code class="literal">PERSIST</code>, <code class="literal">MERGE</code>, or <code class="literal">DELETE</code>.
Indicates the operation that the adapter needs to perform.
Relevant only if you use an entity for JPA operations.
Ignored if you provide JPA QL, a named query, or a native query.
It defaults to <code class="literal">MERGE</code>.
Optional.
As of Spring Integration 3.0, payloads to persist or merge can also be of type <code class="literal">http://docs.oracle.com/javase/7/docs/api/java/lang/Iterable.html[java.lang.Iterable]</code>.
In that case, each object returned by the <code class="literal">Iterable</code> is treated as an entity and persisted or merged by using the underlying <code class="literal">EntityManager</code>.
Null values returned by the iterator are ignored.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO35-13"><span><img src="images/callouts/13.png" alt="13" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Set this value to <code class="literal">true</code> if you want to flush the persistence context immediately after persist, merge, or delete operations and do not want to rely on the <code class="literal">flushMode</code> of the <code class="literal">EntityManager</code>.
It defaults to <code class="literal">false</code>.
Applies only if you did not specify the <code class="literal">flush-size</code> attribute.
If this attribute is set to <code class="literal">true</code>, <code class="literal">flush-size</code> is implicitly set to <code class="literal">1</code>, if no other value configured it.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO35-14"><span><img src="images/callouts/14.png" alt="14" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Set this attribute to a value greater than <span class="emphasis"><em>0</em></span> if you want to flush the persistence context immediately after persist, merge or delete operations and do not want to rely on the the <code class="literal">flushMode</code> of the <code class="literal">EntityManager</code>.
The default value is set to <code class="literal">0</code>, which means "<span class="emphasis"><em>no flush</em></span>".
This attribute is geared towards messages with <code class="literal">Iterable</code> payloads.
For instance, if <code class="literal">flush-size</code> is set to <code class="literal">3</code>, then <code class="literal">entityManager.flush()</code> is called after every third entity.
Furthermore, <code class="literal">entityManager.flush()</code> is called once more after the entire loop.
If the <span class="emphasis"><em>flush-size</em></span> attribute is specified with a value greater than <span class="emphasis"><em>0</em></span>, you need not configure the <code class="literal">flush</code> attribute.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO35-15"><span><img src="images/callouts/15.png" alt="15" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Set this value to <span class="emphasis"><em>true</em></span> if you want to clear the persistence context immediately after each flush operation.
The attribute&#8217;s value is applied only if the <code class="literal">flush</code> attribute is set to <code class="literal">true</code> or if the <code class="literal">flush-size</code> attribute is set to a value greater than <code class="literal">0</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO35-16">(16)</a> </p></td><td valign="top" align="left">
<p>If set to <code class="literal">true</code>, the payload of the message is used as a source for parameters.
If set to <code class="literal">false</code>, however, the entire <code class="literal">Message</code> is available as a source for parameters.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO35-17">(17)</a> </p></td><td valign="top" align="left">
<p>Defines the transaction management attributes and the reference to the transaction manager to be used by the JPA adapter.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO35-18">(18)</a> </p></td><td valign="top" align="left">
<p>One or more <code class="literal">parameter</code> attributes&#8201;&#8212;&#8201;one for each parameter used in the query.
The value or expression is evaluated to compute the value of the parameter.
Optional.</p>
</td></tr></table></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_with_java_configuration_14" href="#_configuring_with_java_configuration_14"></a>22.6.6&nbsp;Configuring with Java Configuration</h3></div></div></div>

<p>The following Spring Boot application shows an example of how to configure the outbound adapter with Java:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@SpringBootApplication</span></em>
<em><span class="hl-annotation" style="color: gray">@EntityScan(basePackageClasses = StudentDomain.class)</span></em>
<em><span class="hl-annotation" style="color: gray">@IntegrationComponentScan</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> JpaJavaApplication {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
        <span class="hl-keyword">new</span> SpringApplicationBuilder(JpaJavaApplication.<span class="hl-keyword">class</span>)
            .web(false)
            .run(args);
    }

    <em><span class="hl-annotation" style="color: gray">@Autowired</span></em>
    <span class="hl-keyword">private</span> EntityManagerFactory entityManagerFactory;

    <em><span class="hl-annotation" style="color: gray">@MessagingGateway</span></em>
    <span class="hl-keyword">interface</span> JpaGateway {

       <em><span class="hl-annotation" style="color: gray">@Gateway(requestChannel = "jpaPersistChannel")</span></em>
       <em><span class="hl-annotation" style="color: gray">@Transactional</span></em>
       <span class="hl-keyword">void</span> persistStudent(StudentDomain payload);

    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> JpaExecutor jpaExecutor() {
        JpaExecutor executor = <span class="hl-keyword">new</span> JpaExecutor(<span class="hl-keyword">this</span>.entityManagerFactory);
        jpaExecutor.setEntityClass(StudentDomain.<span class="hl-keyword">class</span>);
        jpaExecutor.setPersistMode(PersistMode.PERSIST);
        <span class="hl-keyword">return</span> executor;
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <em><span class="hl-annotation" style="color: gray">@ServiceActivator(channel = "jpaPersistChannel")</span></em>
    <span class="hl-keyword">public</span> MessageHandler jpaOutbound() {
        JpaOutboundGateway adapter = <span class="hl-keyword">new</span> JpaOutboundGateway(jpaExecutor());
        adapter.setProducesReply(false);
        <span class="hl-keyword">return</span> adapter;
    }

}</pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_with_the_java_dsl_15" href="#_configuring_with_the_java_dsl_15"></a>22.6.7&nbsp;Configuring with the Java DSL</h3></div></div></div>

<p>The following Spring Boot application shows an example of how to configure the outbound adapter with the Java DSL:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@SpringBootApplication</span></em>
<em><span class="hl-annotation" style="color: gray">@EntityScan(basePackageClasses = StudentDomain.class)</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> JpaJavaApplication {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
        <span class="hl-keyword">new</span> SpringApplicationBuilder(JpaJavaApplication.<span class="hl-keyword">class</span>)
            .web(false)
            .run(args);
    }

    <em><span class="hl-annotation" style="color: gray">@Autowired</span></em>
    <span class="hl-keyword">private</span> EntityManagerFactory entityManagerFactory;

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> IntegrationFlow outboundAdapterFlow() {
        <span class="hl-keyword">return</span> f -&gt; f
                .handle(Jpa.outboundAdapter(<span class="hl-keyword">this</span>.entityManagerFactory)
                                .entityClass(StudentDomain.<span class="hl-keyword">class</span>)
                                .persistMode(PersistMode.PERSIST),
                        e -&gt; e.transactional());
    }

}</pre>
</div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jpa-outbound-gateways" href="#jpa-outbound-gateways"></a>22.7&nbsp;Outbound Gateways</h2></div></div></div>

<p>The JPA inbound channel adapter lets you poll a database to retrieve one or more JPA entities.
The retrieved data is consequently used to start a Spring Integration flow that uses the retrieved data as message payload.</p>
<p>Additionally, you can use JPA outbound channel adapters at the end of your flow in order to persist data, essentially terminating the flow at the end of the persistence operation.</p>
<p>However, how can you execute JPA persistence operations in the middle of a flow? For example, you may have business data that you are processing in your Spring Integration message flow and that you would like to persist, yet you still need to use other components further downstream.
Alternatively, instead of polling the database using a poller, you need to execute JPQL queries and actively retrieve data, which is then processed in subsequent components within your flow.</p>
<p>This is where JPA Outbound Gateways come into play.
They give you the ability to persist data as well as retrieving data.
To facilitate these uses, Spring Integration provides two types of JPA outbound gateways:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Updating outbound gateway
</li><li class="listitem">
Retrieving outbound gateway
</li></ul></div>
<p>Whenever the outbound gateway is used to perform an action that saves, updates, or solely deletes some records in the database, you need to use an updating outbound gateway.
If, for example, you use an <code class="literal">entity</code> to persist it, a merged and persisted entity is returned as a result.
In other cases, the number of records affected (updated or deleted) is returned instead.</p>
<p>When retrieving (selecting) data from the database, we use a retrieving outbound gateway.
With a retrieving outbound gateway, we can use JPQL, Named Queries (native or JPQL-based), or Native Queries (SQL) for selecting the data and retrieving the results.</p>
<p>An updating outbound gateway is functionally similar to an outbound channel adapter, except that an updating outbound gateway sends a result to the gateway&#8217;s reply channel after performing the JPA operation.</p>
<p>A retrieving outbound gateway is similar to an inbound channel adapter.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>We recommend you first read the <a class="xref" href="#jpa-outbound-channel-adapter" title="22.6&nbsp;Outbound Channel Adapter">Section&nbsp;22.6, &#8220;Outbound Channel Adapter&#8221;</a> section and the <a class="xref" href="#jpa-inbound-channel-adapter" title="22.5&nbsp;Inbound Channel Adapter">Section&nbsp;22.5, &#8220;Inbound Channel Adapter&#8221;</a> sections earlier in this chapter, as most of the common concepts are explained there.</p>
</td></tr></table></div>
<p>This similarity was the main factor to use the central <code class="literal">JpaExecutor</code> class to unify common functionality as much as possible.</p>
<p>Common for all JPA outbound gateways and similar to the <code class="literal">outbound-channel-adapter</code>, we can use for performing various JPA operations:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Entity classes
</li><li class="listitem">
JPA Query Language (JPQL)
</li><li class="listitem">
Native query
</li><li class="listitem">
Named query
</li></ul></div>
<p>For configuration examples see <a class="xref" href="#outboundGatewaySamples" title="22.7.8&nbsp;JPA Outbound Gateway Samples">Section&nbsp;22.7.8, &#8220;JPA Outbound Gateway Samples&#8221;</a>.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jpa-outbound-gateway-common-parameters" href="#jpa-outbound-gateway-common-parameters"></a>22.7.1&nbsp;Common Configuration Parameters</h3></div></div></div>

<p>JPA Outbound Gateways always have access to the Spring Integration <code class="literal">Message</code> as input.
Consequently, the following parameters is available:</p>
<div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">parameter-source-factory</code></span></dt><dd>
An instance of <code class="literal">o.s.i.jpa.support.parametersource.ParameterSourceFactory</code> used to get an instance of <code class="literal">o.s.i.jpa.support.parametersource.ParameterSource</code>.
The <code class="literal">ParameterSource</code> is used to resolve the values of the parameters provided in the query.
If you perform operations by using a JPA entity, the <code class="literal">parameter-source-factory</code> attribute is ignored.
The <code class="literal">parameter</code> sub-elements are mutually exclusive with the <code class="literal">parameter-source-factory</code> and they have to be configured on the provided <code class="literal">ParameterSourceFactory</code>.
Optional.
</dd><dt><span class="term"><code class="literal">use-payload-as-parameter-source</code></span></dt><dd>
If set to <code class="literal">true</code>, the payload of the <code class="literal">Message</code> is used as a source for parameters.
If set to <code class="literal">false</code>, the entire <code class="literal">Message</code> is available as a source for parameters.
If no JPA Parameters are passed in, this property defaults to <code class="literal">true</code>.
This means that, if you use a default <code class="literal">BeanPropertyParameterSourceFactory</code>, the bean properties of the payload are used as a source for parameter values for the JPA query.
However, if JPA Parameters are passed in, this property, by default, evaluates to <code class="literal">false</code>.
The reason is that JPA Parameters let you provide SpEL Expressions.
Therefore, it is highly beneficial to have access to the entire <code class="literal">Message</code>, including the headers.
Optional.
</dd></dl></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jpa-updating-outbound-gateway" href="#jpa-updating-outbound-gateway"></a>22.7.2&nbsp;Updating Outbound Gateway</h3></div></div></div>

<p>The following listing shows all the attributes that you can set on an updating-outbound-gateway and describes the key attributes:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-jpa:updating-outbound-gateway</span> <span class="hl-attribute">request-channel</span>=<span class="hl-value">""</span>  <a name="CO36-1" href="#CO36-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
    auto-startup="true"
    entity-class=""
    entity-manager=""
    entity-manager-factory=""
    id=""
    jpa-operations=""
    jpa-query=""
    named-query=""
    native-query=""
    order=""
    parameter-source-factory=""
    persist-mode="MERGE"
    reply-channel=""  <a name="CO36-2" href="#CO36-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
    reply-timeout=""  <a name="CO36-3" href="#CO36-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
    use-payload-as-parameter-source="true"&gt;

    <span class="hl-tag">&lt;int:poller/&gt;</span>
    <span class="hl-tag">&lt;int-jpa:transactional/&gt;</span>

    <span class="hl-tag">&lt;int-jpa:parameter</span> <span class="hl-attribute">name</span>=<span class="hl-value">""</span> <span class="hl-attribute">type</span>=<span class="hl-value">""</span> <span class="hl-attribute">value</span>=<span class="hl-value">""</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int-jpa:parameter</span> <span class="hl-attribute">name</span>=<span class="hl-value">""</span> <span class="hl-attribute">expression</span>=<span class="hl-value">""</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-jpa:updating-outbound-gateway&gt;</span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO36-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The channel from which the outbound gateway receives messages for performing the desired operation.
This attribute is similar to the <code class="literal">channel</code> attribute of the <code class="literal">outbound-channel-adapter</code>.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO36-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The channel to which the gateway send the response after performing the required JPA operation.
If this attribute is not defined, the request message must have a <code class="literal">replyChannel</code> header.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO36-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Specifies the time the gateway waits to send the result to the reply channel.
Only applies when the reply channel itself might block the send operation (for example, a bounded <code class="literal">QueueChannel</code> that is currently full).
By default, the gateway waits indefinitely.
The value is specified in milliseconds.
Optional.</p>
</td></tr></table></div>
</div>
<p>The remaining attributes are described earlier in this chapter. See <a class="xref" href="#jpaInboundChannelAdapterParameters" title="22.5.1&nbsp;Configuration Parameter Reference">Section&nbsp;22.5.1, &#8220;Configuration Parameter Reference&#8221;</a> and <a class="xref" href="#jpaOutboundChannelAdapterParameters" title="22.6.5&nbsp;Configuration Parameter Reference">Section&nbsp;22.6.5, &#8220;Configuration Parameter Reference&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_with_java_configuration_15" href="#_configuring_with_java_configuration_15"></a>22.7.3&nbsp;Configuring with Java Configuration</h3></div></div></div>

<p>The following Spring Boot application shows an example of how configure the outbound adapter with Java:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@SpringBootApplication</span></em>
<em><span class="hl-annotation" style="color: gray">@EntityScan(basePackageClasses = StudentDomain.class)</span></em>
<em><span class="hl-annotation" style="color: gray">@IntegrationComponentScan</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> JpaJavaApplication {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
        <span class="hl-keyword">new</span> SpringApplicationBuilder(JpaJavaApplication.<span class="hl-keyword">class</span>)
            .web(false)
            .run(args);
    }

    <em><span class="hl-annotation" style="color: gray">@Autowired</span></em>
    <span class="hl-keyword">private</span> EntityManagerFactory entityManagerFactory;

    <em><span class="hl-annotation" style="color: gray">@MessagingGateway</span></em>
    <span class="hl-keyword">interface</span> JpaGateway {

       <em><span class="hl-annotation" style="color: gray">@Gateway(requestChannel = "jpaUpdateChannel")</span></em>
       <em><span class="hl-annotation" style="color: gray">@Transactional</span></em>
       <span class="hl-keyword">void</span> updateStudent(StudentDomain payload);

    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <em><span class="hl-annotation" style="color: gray">@ServiceActivator(channel = "jpaUpdateChannel")</span></em>
    <span class="hl-keyword">public</span> MessageHandler jpaOutbound() {
        JpaOutboundGateway adapter =
               <span class="hl-keyword">new</span> JpaOutboundGateway(<span class="hl-keyword">new</span> JpaExecutor(<span class="hl-keyword">this</span>.entityManagerFactory));
        adapter.setOutputChannelName(<span class="hl-string">"updateResults"</span>);
        <span class="hl-keyword">return</span> adapter;
    }

}</pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_with_the_java_dsl_16" href="#_configuring_with_the_java_dsl_16"></a>22.7.4&nbsp;Configuring with the Java DSL</h3></div></div></div>

<p>The following Spring Boot application shows an example of how to configure the outbound adapter using the Java DSL:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@SpringBootApplication</span></em>
<em><span class="hl-annotation" style="color: gray">@EntityScan(basePackageClasses = StudentDomain.class)</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> JpaJavaApplication {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
        <span class="hl-keyword">new</span> SpringApplicationBuilder(JpaJavaApplication.<span class="hl-keyword">class</span>)
            .web(false)
            .run(args);
    }

    <em><span class="hl-annotation" style="color: gray">@Autowired</span></em>
    <span class="hl-keyword">private</span> EntityManagerFactory entityManagerFactory;

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> IntegrationFlow updatingGatewayFlow() {
        <span class="hl-keyword">return</span> f -&gt; f
                .handle(Jpa.updatingGateway(<span class="hl-keyword">this</span>.entityManagerFactory),
                        e -&gt; e.transactional(true))
                .channel(c -&gt; c.queue(<span class="hl-string">"updateResults"</span>));
    }

}</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jpa-retrieving-outbound-gateway" href="#jpa-retrieving-outbound-gateway"></a>22.7.5&nbsp;Retrieving Outbound Gateway</h3></div></div></div>

<p>The following example shows all the attributes that you can set on a retrieving outbound gateway and describes the key attributes:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-jpa:retrieving-outbound-gateway</span> <span class="hl-attribute">request-channel</span>=<span class="hl-value">""</span>
    <span class="hl-attribute">auto-startup</span>=<span class="hl-value">"true"</span>
    <span class="hl-attribute">delete-after-poll</span>=<span class="hl-value">"false"</span>
    <span class="hl-attribute">delete-in-batch</span>=<span class="hl-value">"false"</span>
    <span class="hl-attribute">entity-class</span>=<span class="hl-value">""</span>
    <span class="hl-attribute">id-expression</span>=<span class="hl-value">""</span>              <a name="CO37-1" href="#CO37-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
    entity-manager=""
    entity-manager-factory=""
    expect-single-result="false"  <a name="CO37-2" href="#CO37-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
    id=""
    jpa-operations=""
    jpa-query=""
    max-results=""                <a name="CO37-3" href="#CO37-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
    max-results-expression=""     <a name="CO37-4" href="#CO37-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
    first-result=""               <a name="CO37-5" href="#CO37-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
    first-result-expression=""    <a name="CO37-6" href="#CO37-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>
    named-query=""
    native-query=""
    order=""
    parameter-source-factory=""
    reply-channel=""
    reply-timeout=""
    use-payload-as-parameter-source="true"&gt;
    <span class="hl-tag">&lt;int:poller&gt;</span><span class="hl-tag">&lt;/int:poller&gt;</span>
    <span class="hl-tag">&lt;int-jpa:transactional/&gt;</span>

    <span class="hl-tag">&lt;int-jpa:parameter</span> <span class="hl-attribute">name</span>=<span class="hl-value">""</span> <span class="hl-attribute">type</span>=<span class="hl-value">""</span> <span class="hl-attribute">value</span>=<span class="hl-value">""</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int-jpa:parameter</span> <span class="hl-attribute">name</span>=<span class="hl-value">""</span> <span class="hl-attribute">expression</span>=<span class="hl-value">""</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-jpa:retrieving-outbound-gateway&gt;</span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO37-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>(Since Spring Integration 4.0) The SpEL expression that determines the <code class="literal">primaryKey</code> value for <code class="literal">EntityManager.find(Class entityClass, Object primaryKey)</code> method against the <code class="literal">requestMessage</code> as the root object of evaluation context.
The <code class="literal">entityClass</code> argument is determined from the <code class="literal">entity-class</code> attribute, if present.
Otherwise, it is determined from the <code class="literal">payload</code> class.
All other attributes are disallowed if you use <code class="literal">id-expression</code>.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO37-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A boolean flag indicating whether the select operation is expected to return a single result or a <code class="literal">List</code> of results.
If this flag is set to <code class="literal">true</code>, a single entity is sent as the payload of the message.
If multiple entities are returned, an exception is thrown.
If <code class="literal">false</code>, the <code class="literal">List</code> of entities is sent as the payload of the message.
It defaults to <code class="literal">false</code>.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO37-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>This non-zero, non-negative integer value tells the adapter not to select more than the specified number of rows on execution of the select operation.
By default, if this attribute is not set, all the possible records are selected by given query.
This attribute is mutually exclusive with <code class="literal">max-results-expression</code>.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO37-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>An expression that can be used to find the maximum number of results in a result set.
It is mutually exclusive with <code class="literal">max-results</code>.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO37-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>This non-zero, non-negative integer value tells the adapter the first record from which results are to be retrieved.
This attribute is mutually exclusive with <code class="literal">first-result-expression</code>.
Version 3.0 introduced this attribute.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO37-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>This expression is evaluated against the message, to find the position of the first record in the result set.
This attribute is mutually exclusive to <code class="literal">first-result</code>.
Version 3.0 introduced this attribute.
Optional.</p>
</td></tr></table></div>
</div>
<p>The remaining attributes are described earlier in this chapter.
See <a class="xref" href="#jpaInboundChannelAdapterParameters" title="22.5.1&nbsp;Configuration Parameter Reference">Section&nbsp;22.5.1, &#8220;Configuration Parameter Reference&#8221;</a> and <a class="xref" href="#jpaOutboundChannelAdapterParameters" title="22.6.5&nbsp;Configuration Parameter Reference">Section&nbsp;22.6.5, &#8220;Configuration Parameter Reference&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_with_java_configuration_16" href="#_configuring_with_java_configuration_16"></a>22.7.6&nbsp;Configuring with Java Configuration</h3></div></div></div>

<p>The following Spring Boot application shows an example of how configure the outbound adapter with Java:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@SpringBootApplication</span></em>
<em><span class="hl-annotation" style="color: gray">@EntityScan(basePackageClasses = StudentDomain.class)</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> JpaJavaApplication {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
        <span class="hl-keyword">new</span> SpringApplicationBuilder(JpaJavaApplication.<span class="hl-keyword">class</span>)
            .web(false)
            .run(args);
    }

    <em><span class="hl-annotation" style="color: gray">@Autowired</span></em>
    <span class="hl-keyword">private</span> EntityManagerFactory entityManagerFactory;


    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> JpaExecutor jpaExecutor() {
        JpaExecutor executor = <span class="hl-keyword">new</span> JpaExecutor(<span class="hl-keyword">this</span>.entityManagerFactory);
        jpaExecutor.setJpaQuery(<span class="hl-string">"from Student s where s.id = :id"</span>);
        executor.setJpaParameters(Collections.singletonList(<span class="hl-keyword">new</span> JpaParameter(<span class="hl-string">"id"</span>, null, <span class="hl-string">"payload"</span>)));
        jpaExecutor.setExpectSingleResult(true);
        <span class="hl-keyword">return</span> executor;
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <em><span class="hl-annotation" style="color: gray">@ServiceActivator(channel = "jpaRetrievingChannel")</span></em>
    <span class="hl-keyword">public</span> MessageHandler jpaOutbound() {
        JpaOutboundGateway adapter = <span class="hl-keyword">new</span> JpaOutboundGateway(jpaExecutor());
        adapter.setOutputChannelName(<span class="hl-string">"retrieveResults"</span>);
        adapter.setGatewayType(OutboundGatewayType.RETRIEVING);
        <span class="hl-keyword">return</span> adapter;
    }

}</pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_with_the_java_dsl_17" href="#_configuring_with_the_java_dsl_17"></a>22.7.7&nbsp;Configuring with the Java DSL</h3></div></div></div>

<p>The following Spring Boot application shows an example of how to configure the outbound adapter with the Java DSL:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@SpringBootApplication</span></em>
<em><span class="hl-annotation" style="color: gray">@EntityScan(basePackageClasses = StudentDomain.class)</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> JpaJavaApplication {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
        <span class="hl-keyword">new</span> SpringApplicationBuilder(JpaJavaApplication.<span class="hl-keyword">class</span>)
            .web(false)
            .run(args);
    }

    <em><span class="hl-annotation" style="color: gray">@Autowired</span></em>
    <span class="hl-keyword">private</span> EntityManagerFactory entityManagerFactory;

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> IntegrationFlow retrievingGatewayFlow() {
        <span class="hl-keyword">return</span> f -&gt; f
                .handle(Jpa.retrievingGateway(<span class="hl-keyword">this</span>.entityManagerFactory)
                       .jpaQuery(<span class="hl-string">"from Student s where s.id = :id"</span>)
                       .expectSingleResult(true)
                       .parameterExpression(<span class="hl-string">"id"</span>, <span class="hl-string">"payload"</span>))
                .channel(c -&gt; c.queue(<span class="hl-string">"retrieveResults"</span>));
    }

}</pre>
</div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>When you choose to delete entities upon retrieval and you have retrieved a collection of entities, by default, entities are deleted on a per-entity basis.
This may cause performance issues.</p>
<p>Alternatively, you can set attribute <code class="literal">deleteInBatch</code> to <code class="literal">true</code>, which performs a batch delete.
However, the limitation of doing so is that cascading deletes are not supported.</p>
<p>JSR 317: Java&#8482; Persistence 2.0 states in chapter 4.10, "<code class="literal">Bulk Update and Delete Operations</code>" that:</p>
<p>"<code class="literal">A delete operation only applies to entities of the specified class and its subclasses.
It does not cascade to related entities.</code>"</p>
<p>For more information, see <a class="ulink" href="http://jcp.org/en/jsr/detail?id=317" target="_top">JSR 317: Java&#8482; Persistence 2.0</a></p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="outboundGatewaySamples" href="#outboundGatewaySamples"></a>22.7.8&nbsp;JPA Outbound Gateway Samples</h3></div></div></div>

<p>This section contains various examples of using the updating outbound gateway and the retrieving outbound gateway:</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_update_by_using_an_entity_class" href="#_update_by_using_an_entity_class"></a>Update by Using an Entity Class</h4></div></div></div>

<p>In the following example, an updating outbound gateway is persisted by using the <code class="literal">org.springframework.integration.jpa.test.entity.Student</code> entity class as a JPA defining parameter:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-jpa:updating-outbound-gateway</span> <span class="hl-attribute">request-channel</span>=<span class="hl-value">"entityRequestChannel"</span>  <a name="CO38-1" href="#CO38-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
    reply-channel="entityResponseChannel"  <a name="CO38-2" href="#CO38-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
    entity-class="org.springframework.integration.jpa.test.entity.Student"
    entity-manager="em"/&gt;</pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO38-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>This is the request channel for the outbound gateway.
It is similar to the <code class="literal">channel</code> attribute of the <code class="literal">outbound-channel-adapter</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO38-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>This is where a gateway differs from an outbound adapter.
This is the channel over which the reply from the JPA operation is received.
If, however, you are not interested in the reply received and want only to perform the operation, using a JPA <code class="literal">outbound-channel-adapter</code> is the appropriate choice.
In this example, where we use an entity class, the reply is the entity object that was created or merged as a result of the JPA operation.</p>
</td></tr></table></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_update_using_jpql" href="#_update_using_jpql"></a>Update using JPQL</h4></div></div></div>

<p>The following example updates an entity by using the Java Persistence Query Language (JPQL),
which mandates using an updating outbound gateway:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-jpa:updating-outbound-gateway</span> <span class="hl-attribute">request-channel</span>=<span class="hl-value">"jpaqlRequestChannel"</span>
  <span class="hl-attribute">reply-channel</span>=<span class="hl-value">"jpaqlResponseChannel"</span>
  <span class="hl-attribute">jpa-query</span>=<span class="hl-value">"update Student s set s.lastName = :lastName where s.rollNumber = :rollNumber"</span>  <a name="CO39-1" href="#CO39-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
  entity-manager="em"&gt;
    <span class="hl-tag">&lt;int-jpa:parameter</span> <span class="hl-attribute">name</span>=<span class="hl-value">"lastName"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"payload"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int-jpa:parameter</span> <span class="hl-attribute">name</span>=<span class="hl-value">"rollNumber"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"headers['rollNumber']"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-jpa:updating-outbound-gateway&gt;</span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO39-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The JPQL query that the gateway executes.
Since we used updating outbound gateway, only <code class="literal">update</code> and <code class="literal">delete</code> JPQL queries would be sensible choices.</p>
</td></tr></table></div>
</div>
<p>When you send a message with a <code class="literal">String</code> payload that also contains a header called <code class="literal">rollNumber</code> with a <code class="literal">long</code> value, the last name of the student with the specified roll number is updated to the value in the message payload.
When using an updating gateway, the return value is always an integer value, which denotes the number of records affected by execution of the JPA QL.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_retrieving_an_entity_using_jpql" href="#_retrieving_an_entity_using_jpql"></a>Retrieving an Entity using JPQL</h4></div></div></div>

<p>The following example uses a retrieving outbound gateway and JPQL to retrieve (select) one or more entities from the database:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-jpa:retrieving-outbound-gateway</span> <span class="hl-attribute">request-channel</span>=<span class="hl-value">"retrievingGatewayReqChannel"</span>
    <span class="hl-attribute">reply-channel</span>=<span class="hl-value">"retrievingGatewayReplyChannel"</span>
    <span class="hl-attribute">jpa-query</span>=<span class="hl-value">"select s from Student s where s.firstName = :firstName and s.lastName = :lastName"</span>
    <span class="hl-attribute">entity-manager</span>=<span class="hl-value">"em"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int-jpa:parameter</span> <span class="hl-attribute">name</span>=<span class="hl-value">"firstName"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"payload"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int-jpa:parameter</span> <span class="hl-attribute">name</span>=<span class="hl-value">"lastName"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"headers['lastName']"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-jpa:outbound-gateway&gt;</span></pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_retrieving_an_entity_by_using_literal_id_expression_literal" href="#_retrieving_an_entity_by_using_literal_id_expression_literal"></a>Retrieving an Entity by Using <code class="literal">id-expression</code></h4></div></div></div>

<p>The following example uses a retrieving outbound gateway with <code class="literal">id-expression</code> to retrieve (find) one and only one entity from the database:
The <code class="literal">primaryKey</code> is the result of <code class="literal">id-expression</code> evaluation.
The <code class="literal">entityClass</code> is a class of Message <code class="literal">payload</code>.</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-jpa:retrieving-outbound-gateway</span>
	<span class="hl-attribute">request-channel</span>=<span class="hl-value">"retrievingGatewayReqChannel"</span>
    <span class="hl-attribute">reply-channel</span>=<span class="hl-value">"retrievingGatewayReplyChannel"</span>
    <span class="hl-attribute">id-expression</span>=<span class="hl-value">"payload.id"</span>
    <span class="hl-attribute">entity-manager</span>=<span class="hl-value">"em"</span><span class="hl-tag">/&gt;</span></pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_update_using_a_named_query" href="#_update_using_a_named_query"></a>Update using a Named Query</h4></div></div></div>

<p>Using a named query is basically the same as using a JPQL query directly.
The difference is that the <code class="literal">named-query</code> attribute is used instead, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-jpa:updating-outbound-gateway</span> <span class="hl-attribute">request-channel</span>=<span class="hl-value">"namedQueryRequestChannel"</span>
    <span class="hl-attribute">reply-channel</span>=<span class="hl-value">"namedQueryResponseChannel"</span>
    <span class="hl-attribute">named-query</span>=<span class="hl-value">"updateStudentByRollNumber"</span>
    <span class="hl-attribute">entity-manager</span>=<span class="hl-value">"em"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int-jpa:parameter</span> <span class="hl-attribute">name</span>=<span class="hl-value">"lastName"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"payload"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int-jpa:parameter</span> <span class="hl-attribute">name</span>=<span class="hl-value">"rollNumber"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"headers['rollNumber']"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-jpa:outbound-gateway&gt;</span></pre>
</div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>You can find a complete sample application that uses Spring Integration&#8217;s JPA adapter <a class="ulink" href="https://github.com/spring-projects/spring-integration-samples/tree/master/basic/jpa" target="_top">here</a>.</p>
</td></tr></table></div>
</div>
</div>
</div>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="jms" href="#jms"></a>23.&nbsp;JMS Support</h2></div></div></div>

<p>Spring Integration provides channel adapters for receiving and sending JMS messages.</p>
<p>You need to include this dependency into your project:</p>
<div class="informalexample">
<p>
<b>Maven.&nbsp;</b>

</p><pre class="programlisting"><span class="hl-tag">&lt;dependency&gt;</span>
    <span class="hl-tag">&lt;groupId&gt;</span>org.springframework.integration<span class="hl-tag">&lt;/groupId&gt;</span>
    <span class="hl-tag">&lt;artifactId&gt;</span>spring-integration-jms<span class="hl-tag">&lt;/artifactId&gt;</span>
    <span class="hl-tag">&lt;version&gt;</span>5.1.2.RELEASE<span class="hl-tag">&lt;/version&gt;</span>
<span class="hl-tag">&lt;/dependency&gt;</span></pre><p>

</p>
<p>
<b>Gradle.&nbsp;</b>

</p><pre class="programlisting">compile <span class="hl-string">"org.springframework.integration:spring-integration-jms:5.1.2.RELEASE"</span></pre><p>

</p>
</div>
<p>The <code class="literal">javax.jms:javax.jms-api</code> must be added explicitly via some JMS vendor-specific implementation, e.g. Apache ActiveMQ.</p>
<p>There are actually two JMS-based inbound Channel Adapters.
The first uses Spring&#8217;s <code class="literal">JmsTemplate</code> to receive based on a polling period.
The second is "<code class="literal">message-driven</code>" and relies on a Spring <code class="literal">MessageListener</code> container.
The outbound channel adapter uses the <code class="literal">JmsTemplate</code> to convert and send a JMS message on demand.</p>
<p>By using <code class="literal">JmsTemplate</code> and the <code class="literal">MessageListener</code> container, Spring Integration relies on Spring&#8217;s JMS support.
This is important to understand, since most of the attributes exposed on these adapters configure the underlying <code class="literal">JmsTemplate</code> and <code class="literal">MessageListener</code> container.
For more details about <code class="literal">JmsTemplate</code> and the <code class="literal">MessageListener</code> container, see the <a class="ulink" href="http://docs.spring.io/spring/docs/current/spring-framework-reference/html/jms.html" target="_top">Spring JMS documentation</a>.</p>
<p>Whereas the JMS channel adapters are intended for unidirectional messaging (send-only or receive-only), Spring Integration also provides inbound and outbound JMS Gateways for request and reply operations.
The inbound gateway relies on one of Spring&#8217;s <code class="literal">MessageListener</code> container implementations for message-driven reception.
It is also capable of sending a return value to the <code class="literal">reply-to</code> destination, as provided by the received message.
The outbound gateway sends a JMS message to a <code class="literal">request-destination</code> (or <code class="literal">request-destination-name</code> or <code class="literal">request-destination-expression</code>) and then receives a reply message.
You can explicitly configure the <code class="literal">reply-destination</code> reference (or <code class="literal">reply-destination-name</code> or <code class="literal">reply-destination-expression</code>).
Otherwise, the outbound gateway uses a JMS <a class="ulink" href="http://docs.oracle.com/javaee/6/api/javax/jms/TemporaryQueue.html" target="_top">TemporaryQueue</a>.</p>
<p>Prior to Spring Integration 2.2, if necessary, a <code class="literal">TemporaryQueue</code> was created (and removed) for each request or reply.
Beginning with Spring Integration 2.2, you can configure the outbound gateway to use a <code class="literal">MessageListener</code> container to receive replies instead of directly using a new (or cached) <code class="literal">Consumer</code> to receive the reply for each request.
When so configured, and no explicit reply destination is provided, a single <code class="literal">TemporaryQueue</code> is used for each gateway instead of one for each request.</p>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jms-inbound-channel-adapter" href="#jms-inbound-channel-adapter"></a>23.1&nbsp;Inbound Channel Adapter</h2></div></div></div>

<p>The inbound channel adapter requires a reference to either a single <code class="literal">JmsTemplate</code> instance or both a <code class="literal">ConnectionFactory</code> and a <code class="literal">Destination</code> (you can provide a <span class="emphasis"><em>destinationName</em></span> in place of the <span class="emphasis"><em>destination</em></span> reference).
The following example defines an inbound channel adapter with a <code class="literal">Destination</code> reference:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-jms:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"jmsIn"</span> <span class="hl-attribute">destination</span>=<span class="hl-value">"inQueue"</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"exampleChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"30000"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-jms:inbound-channel-adapter&gt;</span></pre>
</div>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>Notice from the preceding configuration that the <code class="literal">inbound-channel-adapter</code> is a polling consumer.
That means that it invokes <code class="literal">receive()</code> when triggered.
You should use this should only in situations where polling is done relatively infrequently and timeliness is not important.
For all other situations (a vast majority of JMS-based use-cases), the <code class="literal">message-driven-channel-adapter</code> (<a class="link" href="#jms-message-driven-channel-adapter" title="23.2&nbsp;Message-driven Channel Adapter">described later</a>) is a better option.</p>
</td></tr></table></div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>By default, all of the JMS adapters that require a reference to the <code class="literal">ConnectionFactory</code> automatically look for a bean named <code class="literal">jmsConnectionFactory</code>.
That is why you do not see a <code class="literal">connection-factory</code> attribute in many of the examples.
However, if your JMS <code class="literal">ConnectionFactory</code> has a different bean name, you need to provide that attribute.</p>
</td></tr></table></div>
<p>If <code class="literal">extract-payload</code> is set to <code class="literal">true</code> (the default), the received JMS Message is passed through the <code class="literal">MessageConverter</code>.
When relying on the default <code class="literal">SimpleMessageConverter</code>, this means that the resulting Spring Integration Message has the JMS message&#8217;s body as its payload.
A JMS <code class="literal">TextMessage</code> produces a string-based payload, a JMS <code class="literal">BytesMessage</code> produces a byte array payload, and the serializable instance of a JMS <code class="literal">ObjectMessage</code> becomes the Spring Integration message&#8217;s payload.
If you prefer to have the raw JMS message as the Spring Integration message&#8217;s payload, set <code class="literal">extract-payload</code> to <code class="literal">false</code>, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-jms:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"jmsIn"</span>
    <span class="hl-attribute">destination</span>=<span class="hl-value">"inQueue"</span>
    <span class="hl-attribute">channel</span>=<span class="hl-value">"exampleChannel"</span>
    <span class="hl-attribute">extract-payload</span>=<span class="hl-value">"false"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"30000"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-jms:inbound-channel-adapter&gt;</span></pre>
</div>
<p>Starting with version 5.0.8, a default value of the <code class="literal">receive-timeout</code> is <code class="literal">-1</code> (no wait) for the <code class="literal">org.springframework.jms.connection.CachingConnectionFactory</code> and <code class="literal">cacheConsumers</code>, otherwise it is 1 second.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jms-ib-transactions" href="#jms-ib-transactions"></a>23.1.1&nbsp;Transactions</h3></div></div></div>

<p>Starting with version 4.0, the inbound channel adapter supports the <code class="literal">session-transacted</code> attribute.
In earlier versions, you had to inject a <code class="literal">JmsTemplate</code> with <code class="literal">sessionTransacted</code> set to <code class="literal">true</code>.
(The adapter did let you set the <code class="literal">acknowledge</code> attribute to <code class="literal">transacted</code>, but this was incorrect and did not work).</p>
<p>Note, however, that setting <code class="literal">session-transacted</code> to <code class="literal">true</code> has little value, because the transaction is committed
immediately after the <code class="literal">receive()</code> operation and before the message is sent to the <code class="literal">channel</code>.</p>
<p>If you want the entire flow to be transactional (for example, if there is a downstream outbound channel adapter), you must use a <code class="literal">transactional</code> poller with a <code class="literal">JmsTransactionManager</code>.
Alternatively, consider using a <code class="literal">jms-message-driven-channel-adapter</code> with <code class="literal">acknowledge</code> set to <code class="literal">transacted</code> (the default).</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jms-message-driven-channel-adapter" href="#jms-message-driven-channel-adapter"></a>23.2&nbsp;Message-driven Channel Adapter</h2></div></div></div>

<p>The <code class="literal">message-driven-channel-adapter</code> requires a reference to either an instance of a Spring <code class="literal">MessageListener</code> container (any subclass of <code class="literal">AbstractMessageListenerContainer</code>) or both <code class="literal">ConnectionFactory</code> and <code class="literal">Destination</code> (a <span class="emphasis"><em>destinationName</em></span> can be provided in place of the <span class="emphasis"><em>destination</em></span> reference).
The following example defines a message-driven channel adapter with a <code class="literal">Destination</code> reference:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-jms:message-driven-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"jmsIn"</span> <span class="hl-attribute">destination</span>=<span class="hl-value">"inQueue"</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"exampleChannel"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The message-driven adapter also accepts several properties that pertain to the <code class="literal">MessageListener</code> container.
These values are considered only if you do not provide a <code class="literal">container</code> reference.
In that case, an instance of <code class="literal">DefaultMessageListenerContainer</code> is created and configured based on these properties.
For example, you can specify the <code class="literal">transaction-manager</code> reference, the <code class="literal">concurrent-consumers</code> value, and several other property references and values.
See the <a class="ulink" href="https://docs.spring.io/spring-integration/api/index.html" target="_top">Javadoc</a> and Spring Integration&#8217;s JMS schema (<code class="literal">spring-integration-jms.xsd</code>) for more details.</p>
<p>If you have a custom listener container implementation (usually a subclass of <code class="literal">DefaultMessageListenerContainer</code>), you can either provide a reference to an instance of it by using the <code class="literal">container</code> attribute or provide its fully qualified class name by using the <code class="literal">container-class</code> attribute.
In that case, the attributes on the adapter are transferred to an instance of your custom container.</p>
</td></tr></table></div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>You can&#8217;t use the Spring JMS namespace element <code class="literal">&lt;jms:listener-container/&gt;</code> to configure a container reference for the <code class="literal">&lt;int-jms:message-driven-channel-adapter&gt;</code> since that element doesn&#8217;t actually reference a container.
Each <code class="literal">&lt;jms:listener/&gt;</code> sub-element gets its own <code class="literal">DefaultMessageListenerContainer</code> (with shared attributes defined on the parent <code class="literal">&lt;jms:listener-container/&gt;</code> element).
You can give each listener sub-element an <code class="literal">id</code>, and use that to inject into the channel adapter, however, the <code class="literal">&lt;jms:/&gt;</code> namespace requires a real listener.
Since, for Spring Integration, the adapter itself needs to configure the listener, the configured listener will be overwritten.
If you go this route, you will see a warning for each adapter.</p>
<p>It is recommended to configure a regular <code class="literal">&lt;bean&gt;</code> for the <code class="literal">DefaultMessageListenerContainer</code> and use it as a reference in the channel adapter.</p>
</td></tr></table></div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Starting with version 4.2, the default <code class="literal">acknowledge</code> mode is <code class="literal">transacted</code>, unless you provide an external
container.
In that case, you should configure the container as needed.
We recommend using <code class="literal">transacted</code> with the <code class="literal">DefaultMessageListenerContainer</code> to avoid message loss.</p>
</td></tr></table></div>
<p>The <span class="emphasis"><em>extract-payload</em></span> property has the same effect, and its default value is <span class="emphasis"><em>true</em></span>.
The <code class="literal">poller</code> element is not applicable for a message-driven channel adapter, as it is actively invoked.
For most scenarios, the message-driven approach is better, since the messages are passed along to the <code class="literal">MessageChannel</code> as soon as they are received from the underlying JMS consumer.</p>
<p>Finally, the <code class="literal">&lt;message-driven-channel-adapter&gt;</code> element also accepts the <span class="emphasis"><em>error-channel</em></span> attribute.
This provides the same basic functionality, as described in <a class="xref" href="#gateway-proxy" title="10.4.1&nbsp;Enter the GatewayProxyFactoryBean">Section&nbsp;10.4.1, &#8220;Enter the <code class="literal">GatewayProxyFactoryBean</code>&#8221;</a>.
The following example shows how to set an error channel on a message-driven channel adapter:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-jms:message-driven-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"jmsIn"</span> <span class="hl-attribute">destination</span>=<span class="hl-value">"inQueue"</span>
    <span class="hl-attribute">channel</span>=<span class="hl-value">"exampleChannel"</span>
    <span class="hl-attribute">error-channel</span>=<span class="hl-value">"exampleErrorChannel"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>When comparing the preceding example to the generic gateway configuration or the JMS <span class="emphasis"><em>inbound-gateway</em></span> that we discuss later, the key difference is that we are in a one-way flow, since this is a <span class="emphasis"><em>channel-adapter</em></span>, not a gateway.
Therefore, the flow downstream from the <span class="emphasis"><em>error-channel</em></span> should also be one-way.
For example, it could send to a logging handler or it could connect to a different JMS <code class="literal">&lt;outbound-channel-adapter&gt;</code> element.</p>
<p>When consuming from topics, set the <code class="literal">pub-sub-domain</code> attribute to true.
Set <code class="literal">subscription-durable</code> to <code class="literal">true</code> for a durable subscription or <code class="literal">subscription-shared</code> for a shared subscription (which requires a JMS 2.0 broker and has been available since version 4.2).
Use <code class="literal">subscription-name</code> to name the subscription.</p>
<p>Starting with version 5.1, when the endpoint is stopped while the application remains running, the underlying listener container is shut down, closing its shared connection and consumers.
Previously, the connection and consumers remained open.
To revert to the previous behavior, set the <code class="literal">shutdownContainerOnStop</code> on the <code class="literal">JmsMessageDrivenEndpoint</code> to <code class="literal">false</code>.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jms-md-conversion-errors" href="#jms-md-conversion-errors"></a>23.2.1&nbsp;Inbound Conversion Errors</h3></div></div></div>

<p>Starting with version 4.2, the <span class="emphasis"><em>error-channel</em></span> is used for the conversion errors, too.
Previously, if a JMS <code class="literal">&lt;message-driven-channel-adapter/&gt;</code> or <code class="literal">&lt;inbound-gateway/&gt;</code> could not deliver a message due to a conversion error, an exception would be thrown back to the container.
If the container is configured to use transactions, the message is rolled back and redelivered repeatedly.
The conversion process occurs before and during message construction so that such errors are not sent to the <span class="emphasis"><em>error-channel</em></span>.
Now such conversion exceptions result in an <code class="literal">ErrorMessage</code> being sent to the <span class="emphasis"><em>error-channel</em></span>, with the exception as the <code class="literal">payload</code>.
If you wish the transaction to roll back and you have an <span class="emphasis"><em>error-channel</em></span> defined, the integration flow on the <span class="emphasis"><em>error-channel</em></span> must re-throw the exception (or another exception).
If the error flow does not throw an exception, the transaction is committed and the message is removed.
If no <span class="emphasis"><em>error-channel</em></span> is defined, the exception is thrown back to the container, as before.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jms-outbound-channel-adapter" href="#jms-outbound-channel-adapter"></a>23.3&nbsp;Outbound Channel Adapter</h2></div></div></div>

<p>The <code class="literal">JmsSendingMessageHandler</code> implements the <code class="literal">MessageHandler</code> interface and is capable of converting Spring Integration <code class="literal">Messages</code> to JMS messages and then sending to a JMS destination.
It requires either a <code class="literal">jmsTemplate</code> reference or both <code class="literal">jmsConnectionFactory</code> and <code class="literal">destination</code> references (<code class="literal">destinationName</code> may be provided in place of <code class="literal">destination</code>).
As with the inbound channel adapter, the easiest way to configure this adapter is with the namespace support.
The following configuration produces an adapter that receives Spring Integration messages from the <code class="literal">exampleChannel</code>, converts those into JMS messages, and sends them to the JMS destination reference whose bean name is <code class="literal">outQueue</code>:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-jms:outbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"jmsOut"</span> <span class="hl-attribute">destination</span>=<span class="hl-value">"outQueue"</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"exampleChannel"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>As with the inbound channel adapters, there is an <span class="emphasis"><em>extract-payload</em></span> property.
However, the meaning is reversed for the outbound adapter.
Rather than applying to the JMS message, the boolean property applies to the Spring Integration message payload.
In other words, the decision is whether to pass the Spring Integration message itself as the JMS message body or to pass the Spring Integration message payload as the JMS message body.
The default value is <span class="emphasis"><em>true</em></span>.
Therefore, if you pass a Spring Integration message whose payload is a <code class="literal">String</code>, a JMS <code class="literal">TextMessage</code> is created.
If, on the other hand, you want to send the actual Spring Integration message to another system over JMS, set it to <span class="emphasis"><em>false</em></span>.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Regardless of the boolean value for payload extraction, the Spring Integration <code class="literal">MessageHeaders</code> map to JMS properties, as long as you rely on the default converter or provide a reference to another instance of <code class="literal">HeaderMappingMessageConverter</code>.
(The same holds true for <span class="emphasis"><em>inbound</em></span> adapters, except that, in those cases, the JMS properties map to Spring Integration <code class="literal">MessageHeaders</code>).</p>
</td></tr></table></div>
<p>Starting with version 5.1, the <code class="literal">&lt;int-jms:outbound-channel-adapter&gt;</code> (<code class="literal">JmsSendingMessageHandler</code>) can be configured with the <code class="literal">deliveryModeExpression</code> and <code class="literal">timeToLiveExpression</code> properties to evaluate an appropriate QoS values for JMS message to send at runtime against request Spring <code class="literal">Message</code>.
The new <code class="literal">setMapInboundDeliveryMode(true)</code> and <code class="literal">setMapInboundExpiration(true)</code> options of the <code class="literal">DefaultJmsHeaderMapper</code> may facilitate as a source of the information for the dynamic <code class="literal">deliveryMode</code> and <code class="literal">timeToLive</code> from message headers:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-jms:outbound-channel-adapter</span> <span class="hl-attribute">delivery-mode-expression</span>=<span class="hl-value">"headers.jms_deliveryMode"</span>
                        <span class="hl-attribute">time-to-live-expression</span>=<span class="hl-value">"headers.jms_expiration - T(System).currentTimeMillis()"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jms-ob-transactions" href="#jms-ob-transactions"></a>23.3.1&nbsp;Transactions</h3></div></div></div>

<p>Starting with version 4.0, the outbound channel adapter supports the <code class="literal">session-transacted</code> attribute.
In earlier versions, you had to inject a <code class="literal">JmsTemplate</code> with <code class="literal">sessionTransacted</code> set to <code class="literal">true</code>.
The attribute now sets the property on the built-in default <code class="literal">JmsTemplate</code>.
If a transaction exists (perhaps from an upstream <code class="literal">message-driven-channel-adapter</code>), the send operation is performed within the same transaction.
Otherwise, a new transaction is started.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jms-inbound-gateway" href="#jms-inbound-gateway"></a>23.4&nbsp;Inbound Gateway</h2></div></div></div>

<p>Spring Integration&#8217;s message-driven JMS inbound-gateway delegates to a <code class="literal">MessageListener</code> container, supports dynamically adjusting concurrent consumers, and can also handle replies.
The inbound gateway requires references to a <code class="literal">ConnectionFactory</code> and a request <code class="literal">Destination</code> (or <span class="emphasis"><em>requestDestinationName</em></span>).
The following example defines a JMS <code class="literal">inbound-gateway</code> that receives from the JMS queue referenced by the bean id, <code class="literal">inQueue</code>, and sends to the Spring Integration channel named <code class="literal">exampleChannel</code>:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-jms:inbound-gateway</span> <span class="hl-attribute">id</span>=<span class="hl-value">"jmsInGateway"</span>
    <span class="hl-attribute">request-destination</span>=<span class="hl-value">"inQueue"</span>
    <span class="hl-attribute">request-channel</span>=<span class="hl-value">"exampleChannel"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>Since the gateways provide request-reply behavior instead of unidirectional send or receive behavior, they also have two distinct properties for "<code class="literal">payload extraction</code>" (as <a class="link" href="#jms-inbound-channel-adapter" title="23.1&nbsp;Inbound Channel Adapter">discussed earlier</a> for the channel adapters' <span class="emphasis"><em>extract-payload</em></span> setting).
For an inbound gateway, the <span class="emphasis"><em>extract-request-payload</em></span> property determines whether the received JMS Message body is extracted.
If <span class="emphasis"><em>false</em></span>, the JMS message itself becomes the Spring Integration message payload.
The default is <span class="emphasis"><em>true</em></span>.</p>
<p>Similarly, for an inbound-gateway, the <span class="emphasis"><em>extract-reply-payload</em></span> property applies to the Spring Integration message that is to be converted into a reply JMS Message.
If you want to pass the whole Spring Integration message (as the body of a JMS ObjectMessage), set value this to <span class="emphasis"><em>false</em></span>.
By default, it is also <span class="emphasis"><em>true</em></span> that the Spring Integration message payload is converted into a JMS Message (for example, a
<code class="literal">String</code> payload becomes a JMS TextMessage).</p>
<p>As with anything else, gateway invocation might result in error.
By default, a producer is not notified of the errors that might have occurred on the consumer side and times out waiting for the reply.
However, there might be times when you want to communicate an error condition back to the consumer (in other words, you might want to treat the exception as a valid reply by mapping it to a message).
To accomplish this, JMS inbound gateway provides support for a message channel to which errors can be sent for processing, potentially resulting in a reply message payload that conforms to some contract that defines what a caller may expect as an "<code class="literal">error</code>" reply.
You can use the error-channel attribute to configure such a channel, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-jms:inbound-gateway</span> <span class="hl-attribute">request-destination</span>=<span class="hl-value">"requestQueue"</span>
          <span class="hl-attribute">request-channel</span>=<span class="hl-value">"jmsInputChannel"</span>
          <span class="hl-attribute">error-channel</span>=<span class="hl-value">"errorTransformationChannel"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int:transformer</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"exceptionTransformationChannel"</span>
        <span class="hl-attribute">ref</span>=<span class="hl-value">"exceptionTransformer"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"createErrorResponse"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>You might notice that this example looks very similar to that included within <a class="xref" href="#gateway-proxy" title="10.4.1&nbsp;Enter the GatewayProxyFactoryBean">Section&nbsp;10.4.1, &#8220;Enter the <code class="literal">GatewayProxyFactoryBean</code>&#8221;</a>.
The same idea applies here: The <code class="literal">exceptionTransformer</code> could be a POJO that creates error-response objects, you could reference the <code class="literal">nullChannel</code> to suppress the errors, or you could leave <span class="emphasis"><em>error-channel</em></span> out to let the exception propagate.</p>
<p>See <a class="xref" href="#jms-md-conversion-errors" title="23.2.1&nbsp;Inbound Conversion Errors">Section&nbsp;23.2.1, &#8220;Inbound Conversion Errors&#8221;</a>.</p>
<p>When consuming from topics, set the <code class="literal">pub-sub-domain</code> attribute to true.
Set <code class="literal">subscription-durable</code> to <code class="literal">true</code> for a durable subscription or <code class="literal">subscription-shared</code> for a shared subscription (requires a JMS 2.0 broker and has been available since version 4.2).
Use <code class="literal">subscription-name</code> to name the subscription.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Starting with version 4.2, the default <code class="literal">acknowledge</code> mode is <code class="literal">transacted</code>, unless an external container is provided.
In that case, you should configure the container as needed.
We recommend that you use <code class="literal">transacted</code> with the <code class="literal">DefaultMessageListenerContainer</code> to avoid message loss.</p>
</td></tr></table></div>
<p>Starting with version 5.1, when the endpoint is stopped while the application remains running, the underlying listener container is shut down, closing its shared connection and consumers.
Previously, the connection and consumers remained open.
To revert to the previous behavior, set the <code class="literal">shutdownContainerOnStop</code> on the <code class="literal">JmsInboundGateway</code> to <code class="literal">false</code>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jms-outbound-gateway" href="#jms-outbound-gateway"></a>23.5&nbsp;Outbound Gateway</h2></div></div></div>

<p>The outbound gateway creates JMS messages from Spring Integration messages and sends them to a <span class="emphasis"><em>request-destination</em></span>.
It thens handle the JMS reply message either by using a selector to receive from the <span class="emphasis"><em>reply-destination</em></span> that you configure or, if no <span class="emphasis"><em>reply-destination</em></span> is provided, by creating JMS <code class="literal">TemporaryQueue</code> instances.</p>
<div class="caution" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Caution"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Caution]" src="images/caution.png"></td><th align="left"><a name="jms-outbound-gateway-memory-caution" href="#jms-outbound-gateway-memory-caution"></a>Caution</th></tr><tr><td align="left" valign="top">
<p>Using a <code class="literal">reply-destination</code> (or <code class="literal">reply-destination-name</code>) together with a <code class="literal">CachingConnectionFactory</code> that has cacheConsumers set to <code class="literal">true</code> can cause out-of-memory conditions.
This is because each request gets a new consumer with a new selector (selecting on the <code class="literal">correlation-key</code> value or, when there is no <code class="literal">correlation-key</code>, on the sent JMSMessageID).
Given that these selectors are unique, they remain in the cache (unused) after the current request completes.</p>
<p>If you specify a reply destination, you are advised to not use cached consumers.
Alternatively, consider using a <code class="literal">&lt;reply-listener/&gt;</code> as <a class="link" href="#jms-outbound-gateway-reply-listener" title="23.5.1&nbsp;Using a <reply-listener/&gt;">described below</a>.</p>
</td></tr></table></div>
<p>The following example shows how to configure an outbound gateway:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-jms:outbound-gateway</span> <span class="hl-attribute">id</span>=<span class="hl-value">"jmsOutGateway"</span>
    <span class="hl-attribute">request-destination</span>=<span class="hl-value">"outQueue"</span>
    <span class="hl-attribute">request-channel</span>=<span class="hl-value">"outboundJmsRequests"</span>
    <span class="hl-attribute">reply-channel</span>=<span class="hl-value">"jmsReplies"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>The <span class="emphasis"><em>outbound-gateway</em></span> payload extraction properties are inversely related to those of the <span class="emphasis"><em>inbound-gateway</em></span> (see the <a class="link" href="#jms-message-driven-channel-adapter" title="23.2&nbsp;Message-driven Channel Adapter">earlier discussion</a>).
That means that the <span class="emphasis"><em>extract-request-payload</em></span> property value applies to the Spring Integration message being converted into a JMS message to be sent as a request.
The <span class="emphasis"><em>extract-reply-payload</em></span> property value applies to the JMS message received as a reply and is then converted into a Spring Integration message to be subsequently sent to the <span class="emphasis"><em>reply-channel</em></span>, as shown in the preceding configuration example.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jms-outbound-gateway-reply-listener" href="#jms-outbound-gateway-reply-listener"></a>23.5.1&nbsp;Using a <code class="literal">&lt;reply-listener/&gt;</code></h3></div></div></div>

<p>Spring Integration 2.2 introduced an alternative technique for handling replies.
If you add a <code class="literal">&lt;reply-listener/&gt;</code> child element to the gateway instead of creating a consumer for each reply, a <code class="literal">MessageListener</code> container is used to receive the replies and hand them over to the requesting thread.
This provides a number of performance benefits as well as alleviating the cached consumer memory utilization problem described in the <a class="link" href="#jms-outbound-gateway-memory-caution" title="Caution">earlier caution</a>.</p>
<p>When using a <code class="literal">&lt;reply-listener/&gt;</code> with an outbound gateway that has no <code class="literal">reply-destination</code>, instead of creating a <code class="literal">TemporaryQueue</code> for each request, a single <code class="literal">TemporaryQueue</code> is used.
(The gateway creates an additional <code class="literal">TemporaryQueue</code>, as necessary, if the connection to the broker is lost and recovered).</p>
<p>When using a <code class="literal">correlation-key</code>, multiple gateways can share the same reply destination, because the listener container uses a selector that is unique to each gateway.</p>
<div class="caution" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Caution"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Caution]" src="images/caution.png"></td><th align="left">Caution</th></tr><tr><td align="left" valign="top">
<p>If you specify a reply listener and specify a reply destination (or reply destination name) but provide no correlation key, the gateway logs a warning and falls back to pre-version 2.2 behavior.
This is because there is no way to configure a selector in this case.
Thus, there is no way to avoid a reply going to a different gateway that might be configured with the same reply destination.</p>
<p>Note that, in this situation, a new consumer is used for each request, and consumers can build up in memory as described in the caution above; therefore cached consumers should not be used in this case.</p>
</td></tr></table></div>
<p>The following example shows a reply listener with default attributes:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-jms:outbound-gateway</span> <span class="hl-attribute">id</span>=<span class="hl-value">"jmsOutGateway"</span>
        <span class="hl-attribute">request-destination</span>=<span class="hl-value">"outQueue"</span>
        <span class="hl-attribute">request-channel</span>=<span class="hl-value">"outboundJmsRequests"</span>
        <span class="hl-attribute">reply-channel</span>=<span class="hl-value">"jmsReplies"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int-jms:reply-listener /&gt;</span>
<span class="hl-tag">&lt;/int-jms-outbound-gateway&gt;</span></pre>
</div>
<p>The listener is very lightweight, and we anticipate that, in most cases, you need only a single consumer.
However, you can add attributes such as <code class="literal">concurrent-consumers</code>, <code class="literal">max-concurrent-consumers</code>, and others.
See the schema for a complete list of supported attributes, together with the <a class="ulink" href="http://docs.spring.io/spring/docs/current/spring-framework-reference/html/jms.html" target="_top">Spring JMS documentation</a> for their meanings.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_idle_reply_listeners" href="#_idle_reply_listeners"></a>23.5.2&nbsp;Idle Reply Listeners</h3></div></div></div>

<p>Starting with version 4.2, you can start the reply listener as needed (and stop it after an idle time) instead
of running for the duration of the gateway&#8217;s lifecycle.
This can be useful if you have many gateways in the application context where they are mostly idle.
One such situation is a context with many (inactive) partitioned <a class="ulink" href="http://projects.spring.io/spring-batch/" target="_top">Spring Batch</a>
jobs using Spring Integration and JMS for partition distribution.
If all the reply listeners are active, the JMS broker has an active consumer for each gateway.
By enabling the idle timeout, each consumer exists only while the corresponding batch job is running (and
for a short time after it finishes).</p>
<p>See <code class="literal">idle-reply-listener-timeout</code> in <a class="xref" href="#jms-og-attributes" title="23.5.5&nbsp;Attribute Reference">Section&nbsp;23.5.5, &#8220;Attribute Reference&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_gateway_reply_correlation" href="#_gateway_reply_correlation"></a>23.5.3&nbsp;Gateway Reply Correlation</h3></div></div></div>

<p>This section describes the mechanisms used for reply correlation (ensuring the originating gateway receives replies
to only its requests), depending on how the gateway is configured.
See <a class="xref" href="#jms-og-attributes" title="23.5.5&nbsp;Attribute Reference">Section&nbsp;23.5.5, &#8220;Attribute Reference&#8221;</a> for complete description of the attributes discussed here.</p>
<p>The following list describes the various scenarios (the numbers are for identification&#8201;&#8212;&#8201;order does not matter):</p>
<div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
<p class="simpara">No <code class="literal">reply-destination*</code> properties and no <code class="literal">&lt;reply-listener&gt;</code></p>
<p class="simpara">A <code class="literal">TemporaryQueue</code> is created for each request and deleted when the request is complete (successfully or otherwise).
<code class="literal">correlation-key</code> is irrelevant.</p>
</li><li class="listitem">
<p class="simpara">A <code class="literal">reply-destination*</code> property is provided and neither a <code class="literal">&lt;reply-listener/&gt;</code> nor a <code class="literal">correlation-key</code> is provided</p>
<p class="simpara">The <code class="literal">JMSCorrelationID</code> equal to the outgoing message IS is used as a message selector for the consumer:</p>
<p class="simpara"><code class="literal">messageSelector = "JMSCorrelationID = '" + messageId + "'"</code></p>
<p class="simpara">The responding system is expected to return the inbound <code class="literal">JMSMessageID</code> in the reply <code class="literal">JMSCorrelationID</code>.
This is a common pattern and is implemented by the Spring Integration inbound gateway as well as Spring&#8217;s <code class="literal">MessageListenerAdapter</code> for message-driven POJOs.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>When you use this configuration, you should not use a topic for replies.
The reply may be lost.</p>
</td></tr></table></div>
</li><li class="listitem">
<p class="simpara">A <code class="literal">reply-destination*</code> property is provided, no <code class="literal">&lt;reply-listener/&gt;</code> is provided, and <code class="literal">correlation-key="JMSCorrelationID"</code></p>
<p class="simpara">The gateway generates a unique correlation IS and inserts it in the <code class="literal">JMSCorrelationID</code> header.
The message selector is:</p>
<p class="simpara"><code class="literal">messageSelector = "JMSCorrelationID = '" + uniqueId + "'"</code></p>
<p class="simpara">The responding system is expected to return the inbound <code class="literal">JMSCorrelationID</code> in the reply <code class="literal">JMSCorrelationID</code>.
This is a common pattern and is implemented by the Spring Integration inbound gateway as well as Spring&#8217;s <code class="literal">MessageListenerAdapter</code> for message-driven POJOs.</p>
</li><li class="listitem">
<p class="simpara">A <code class="literal">reply-destination*</code> property is provided, no <code class="literal">&lt;reply-listener/&gt;</code> is provided, and <code class="literal">correlation-key="myCorrelationHeader"</code></p>
<p class="simpara">The gateway generates a unique correlation ID and inserts it in the <code class="literal">myCorrelationHeader</code> message property.
The <code class="literal">correlation-key</code> can be any user-defined value.
The message selector is:</p>
<p class="simpara"><code class="literal">messageSelector = "myCorrelationHeader = '" + uniqueId + "'"</code></p>
<p class="simpara">The responding system is expected to return the inbound <code class="literal">myCorrelationHeader</code> in the reply <code class="literal">myCorrelationHeader</code>.</p>
</li><li class="listitem">
<p class="simpara">A <code class="literal">reply-destination*</code> property is provided, no <code class="literal">&lt;reply-listener/&gt;</code> is provided, and <code class="literal">correlation-key="JMSCorrelationID*"</code>::
(Note the <code class="literal">*</code> in the correlation key.)</p>
<p class="simpara">The gateway uses the value in the <code class="literal">jms_correlationId</code> header (if present) from the request message and inserts it in
the <code class="literal">JMSCorrelationID</code> header.
The message selector is:</p>
<p class="simpara"><code class="literal">messageSelector = "JMSCorrelationID = '" + headers['jms_correlationId'] + "'"</code></p>
<p class="simpara">The user must ensure this value is unique.</p>
<p class="simpara">If the header does not exist, the gateway behaves as in <code class="literal">3</code>.</p>
<p class="simpara">The responding system is expected to return the inbound <code class="literal">JMSCorrelationID</code> in the reply <code class="literal">JMSCorrelationID</code>.
This is a common pattern and is implemented by the Spring Integration inbound gateway as well as Spring&#8217;s <code class="literal">MessageListenerAdapter</code> for message-driven POJOs.</p>
</li><li class="listitem">
<p class="simpara">No <code class="literal">reply-destination*</code> properties is provided, and a <code class="literal">&lt;reply-listener&gt;</code> is provided</p>
<p class="simpara">A temporary queue is created and used for all replies from this gateway instance.
No correlation data is needed in the message, but the outgoing <code class="literal">JMSMessageID</code> is used internally in the gateway to direct the reply to the correct requesting thread.</p>
</li><li class="listitem">
<p class="simpara">A <code class="literal">reply-destination*</code> property is provided, a <code class="literal">&lt;reply-listener&gt;</code> is provided, and no <code class="literal">correlation-key</code> is provided</p>
<p class="simpara">Not allowed.</p>
<p class="simpara">The <code class="literal">&lt;reply-listener/&gt;</code> configuration is ignored, and the gateway behaves as in <code class="literal">2</code>.
A warning log message is written to indicate this situation.</p>
</li><li class="listitem">
<p class="simpara">A <code class="literal">reply-destination*</code> property is provided, a <code class="literal">&lt;reply-listener&gt;</code> is provided, and <code class="literal">correlation-key="JMSCorrelationID"</code></p>
<p class="simpara">The gateway has a unique correlation ID and inserts it, together with an incrementing value in the <code class="literal">JMSCorrelationID</code> header (<code class="literal">gatewayId + "_" + ++seq</code>).
The message selector is:</p>
<p class="simpara"><code class="literal">messageSelector = "JMSCorrelationID LIKE '" + gatewayId%'"</code></p>
<p class="simpara">The responding system is expected to return the inbound <code class="literal">JMSCorrelationID</code> in the reply <code class="literal">JMSCorrelationID</code>.
This is a common pattern and is implemented by the Spring Integration inbound gateway as well as Spring&#8217;s <code class="literal">MessageListenerAdapter</code> for message-driven POJOs.
Since each gateway has a unique ID, each instance gets only its own replies.
The complete correlation data is used to route the reply to the correct requesting thread.</p>
</li><li class="listitem">
<p class="simpara">A <code class="literal">reply-destination*</code> property is provided a <code class="literal">&lt;reply-listener/&gt;</code> is provided, and <code class="literal">correlation-key="myCorrelationHeader"</code></p>
<p class="simpara">The gateway has a unique correlation ID and inserts it, together with an incrementing value in the <code class="literal">myCorrelationHeader</code>
property (<code class="literal">gatewayId + "_" + ++seq</code>).
The <code class="literal">correlation-key</code> can be any user-defined value.
The message selector is:</p>
<p class="simpara"><code class="literal">messageSelector = "myCorrelationHeader LIKE '" + gatewayId%'"</code></p>
<p class="simpara">The responding system is expected to return the inbound <code class="literal">myCorrelationHeader</code> in the reply <code class="literal">myCorrelationHeader</code>.
Since each gateway has a unique ID, each instance only gets its own replies.
The complete correlation data is used to route the reply to the correct requesting thread.</p>
</li><li class="listitem">
<p class="simpara">A <code class="literal">reply-destination*</code> property is provided, a <code class="literal">&lt;reply-listener/&gt;</code> is provided, and <code class="literal">correlation-key="JMSCorrelationID*"</code>*</p>
<p class="simpara">(Note the <code class="literal">*</code> in the correlation key)</p>
<p class="simpara">Not allowed.</p>
<p class="simpara">User-supplied correlation IDs are not permitted with a reply listener.
The gateway does not initialize with this configuration.</p>
</li></ol></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jms-async-gateway" href="#jms-async-gateway"></a>23.5.4&nbsp;Async Gateway</h3></div></div></div>

<p>Starting with version 4.3, you can now specify <code class="literal">async="true"</code> (or <code class="literal">setAsync(true)</code> in Java) when configuring the outbound
gateway.</p>
<p>By default, when a request is sent to the gateway, the requesting thread is suspended until the reply is received.
The flow then continues on that thread.
If <code class="literal">async</code> is <code class="literal">true</code>, the requesting thread is released immediately after the send completes, and the reply is returned
(and the flow continues) on the listener container thread.
This can be useful when the gateway is invoked on a poller thread.
The thread is released and is available for other tasks within the framework.</p>
<p><code class="literal">async</code> requires a <code class="literal">&lt;reply-listener/&gt;</code> (or <code class="literal">setUseReplyContainer(true)</code> when using Java configuration).
It also requires a <code class="literal">correlationKey</code> (usually <code class="literal">JMSCorrelationID</code>) to be specified.
If either of these conditions are not met, <code class="literal">async</code> is ignored.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="jms-og-attributes" href="#jms-og-attributes"></a>23.5.5&nbsp;Attribute Reference</h3></div></div></div>

<p>The following listing shows all the available attributes for an <code class="literal">outbound-gateway</code>:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-jms:outbound-gateway</span>
    <span class="hl-attribute">connection-factory</span>=<span class="hl-value">"connectionFactory"</span> <a name="CO40-1" href="#CO40-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
    correlation-key="" <a name="CO40-2" href="#CO40-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
    delivery-persistent="" <a name="CO40-3" href="#CO40-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
    destination-resolver="" <a name="CO40-4" href="#CO40-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
    explicit-qos-enabled="" <a name="CO40-5" href="#CO40-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
    extract-reply-payload="true" <a name="CO40-6" href="#CO40-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>
    extract-request-payload="true" <a name="CO40-7" href="#CO40-7"></a><span><img src="images/callouts/7.png" alt="7" border="0"></span>
    header-mapper="" <a name="CO40-8" href="#CO40-8"></a><span><img src="images/callouts/8.png" alt="8" border="0"></span>
    message-converter="" <a name="CO40-9" href="#CO40-9"></a><span><img src="images/callouts/9.png" alt="9" border="0"></span>
    priority="" <a name="CO40-10" href="#CO40-10"></a><span><img src="images/callouts/10.png" alt="10" border="0"></span>
    receive-timeout="" <a name="CO40-11" href="#CO40-11"></a><span><img src="images/callouts/11.png" alt="11" border="0"></span>
    reply-channel="" <a name="CO40-12" href="#CO40-12"></a><span><img src="images/callouts/12.png" alt="12" border="0"></span>
    reply-destination="" <a name="CO40-13" href="#CO40-13"></a><span><img src="images/callouts/13.png" alt="13" border="0"></span>
    reply-destination-expression="" <a name="CO40-14" href="#CO40-14"></a><span><img src="images/callouts/14.png" alt="14" border="0"></span>
    reply-destination-name="" <a name="CO40-15" href="#CO40-15"></a><span><img src="images/callouts/15.png" alt="15" border="0"></span>
    reply-pub-sub-domain="" <a name="CO40-16" href="#CO40-16"></a>(16)
    reply-timeout="" <a name="CO40-17" href="#CO40-17"></a>(17)
    request-channel="" <a name="CO40-18" href="#CO40-18"></a>(18)
    request-destination="" <a name="CO40-19" href="#CO40-19"></a>(19)
    request-destination-expression="" <a name="CO40-20" href="#CO40-20"></a>(20)
    request-destination-name="" <a name="CO40-21" href="#CO40-21"></a>(21)
    request-pub-sub-domain="" <a name="CO40-22" href="#CO40-22"></a>(22)
    time-to-live="" <a name="CO40-23" href="#CO40-23"></a>(23)
    requires-reply="" <a name="CO40-24" href="#CO40-24"></a>(24)
    idle-reply-listener-timeout="" <a name="CO40-25" href="#CO40-25"></a>(25)
    async=""&gt; <a name="CO40-26" href="#CO40-26"></a>(26)
  <span class="hl-tag">&lt;int-jms:reply-listener /&gt;</span> <a name="CO40-27" href="#CO40-27"></a>(27)
<span class="hl-tag">&lt;/int-jms:outbound-gateway&gt;</span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO40-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Reference to a <code class="literal">javax.jms.ConnectionFactory</code>.
The default <code class="literal">jmsConnectionFactory</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO40-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The name of a property that contains correlation data to correlate responses with replies.
If omitted, the gateway expects the responding system to return the value of the outbound <code class="literal">JMSMessageID</code> header in the <code class="literal">JMSCorrelationID</code> header.
If specified, the gateway generates a correlation ID and populates the specified property with it.
The responding system must echo back that value in the same property.
It can be set to <code class="literal">JMSCorrelationID</code>, in which case the standard header is used instead of a <code class="literal">String</code> property to hold the correlation data.
When you use a <code class="literal">&lt;reply-container/&gt;</code>, you must specify the <code class="literal">correlation-key</code> if you provide an explicit <code class="literal">reply-destination</code>.
Starting with version 4.0.1, this attribute also supports the value <code class="literal">JMSCorrelationID*</code>, which means that if the outbound message already has a <code class="literal">JMSCorrelationID</code> (mapped from the <code class="literal">jms_correlationId</code>) header, it is used instead of generating a new one.
Note, the <code class="literal">JMSCorrelationID*</code> key is not allowed when you use a <code class="literal">&lt;reply-container/&gt;</code>, because the container needs to set up a message selector during initialization.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>You should understand that the gateway has no way to ensure uniqueness, and unexpected side effects can occur if the provided correlation ID is not unique.</p>
</td></tr></table></div>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO40-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A boolean value indicating whether the delivery mode should be <code class="literal">DeliveryMode.PERSISTENT</code> (<code class="literal">true</code>) or <code class="literal">DeliveryMode.NON_PERSISTENT</code> (<code class="literal">false</code>).
This setting takes effect only if <code class="literal">explicit-qos-enabled</code> is <code class="literal">true</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO40-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A <code class="literal">DestinationResolver</code>.
The default is a <code class="literal">DynamicDestinationResolver</code>, which maps the destination name to a queue or topic of that name.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO40-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>When set to <code class="literal">true</code>, it enables the use of quality of service attributes: <code class="literal">priority</code>, <code class="literal">delivery-mode</code>, and <code class="literal">time-to-live</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO40-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>When set to <code class="literal">true</code> (the default), the payload of the Spring Integration reply message is created from the JMS Reply message&#8217;s body (by using the <code class="literal">MessageConverter</code>).
When set to <code class="literal">false</code>, the entire JMS message becomes the payload of the Spring Integration message.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO40-7"><span><img src="images/callouts/7.png" alt="7" border="0"></span></a> </p></td><td valign="top" align="left">
<p>When set to <code class="literal">true</code> (the default), the payload of the Spring Integration message is converted to a <code class="literal">JMSMessage</code> (by using the <code class="literal">MessageConverter</code>).
When set to <code class="literal">false</code>, the entire Spring Integration Message is converted to the <code class="literal">JMSMessage</code>.
In both cases, the Spring Integration message headers are mapped to JMS headers and properties by using the <code class="literal">HeaderMapper</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO40-8"><span><img src="images/callouts/8.png" alt="8" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A <code class="literal">HeaderMapper</code> used to map Spring Integration message headers to and from JMS message headers and properties.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO40-9"><span><img src="images/callouts/9.png" alt="9" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A reference to a <code class="literal">MessageConverter</code> for converting between JMS messages and the Spring Integration message payloads (or messages if <code class="literal">extract-request-payload</code> is <code class="literal">false</code>).
The default is a <code class="literal">SimpleMessageConverter</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO40-10"><span><img src="images/callouts/10.png" alt="10" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The default priority of request messages.
Overridden by the message priority header, if present.
Its range is <code class="literal">0</code> to <code class="literal">9</code>.
This setting takes effect only if <code class="literal">explicit-qos-enabled</code> is <code class="literal">true</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO40-11"><span><img src="images/callouts/11.png" alt="11" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The time (in milliseconds) to wait for a reply.
The default is <code class="literal">5000</code> (five seconds).</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO40-12"><span><img src="images/callouts/12.png" alt="12" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The channel to which the reply message is sent.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO40-13"><span><img src="images/callouts/13.png" alt="13" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A reference to a <code class="literal">Destination</code>, which is set as the <code class="literal">JMSReplyTo</code> header.
At most, only one of <code class="literal">reply-destination</code>, <code class="literal">reply-destination-expression</code>, or <code class="literal">reply-destination-name</code> is allowed.
If none is provided, a <code class="literal">TemporaryQueue</code> is used for replies to this gateway.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO40-14"><span><img src="images/callouts/14.png" alt="14" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A SpEL expression evaluating to a <code class="literal">Destination</code>, which will be set as the <code class="literal">JMSReplyTo</code> header.
The expression can result in a <code class="literal">Destination</code> object or a <code class="literal">String</code>.
It is used by the <code class="literal">DestinationResolver</code> to resolve the actual <code class="literal">Destination</code>.
At most, only one of <code class="literal">reply-destination</code>, <code class="literal">reply-destination-expression</code>, or <code class="literal">reply-destination-name</code> is allowed.
If none is provided, a <code class="literal">TemporaryQueue</code> is used for replies to this gateway.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO40-15"><span><img src="images/callouts/15.png" alt="15" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The name of the destination that is set as the JMSReplyTo header.
It is used by the <code class="literal">DestinationResolver</code> to resolve the actual <code class="literal">Destination</code>.
At most, only one of <code class="literal">reply-destination</code>, <code class="literal">reply-destination-expression</code>, or <code class="literal">reply-destination-name</code> is allowed.
If none is provided, a <code class="literal">TemporaryQueue</code> is used for replies to this gateway.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO40-16">(16)</a> </p></td><td valign="top" align="left">
<p>When set to <code class="literal">true</code>, it indicates that any reply <code class="literal">Destination</code> resolved by the <code class="literal">DestinationResolver</code> should be a <code class="literal">Topic</code> rather then a <code class="literal">Queue</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO40-17">(17)</a> </p></td><td valign="top" align="left">
<p>The time the gateway waits when sending the reply message to the <code class="literal">reply-channel</code>.
This only has an effect if the <code class="literal">reply-channel</code> can block&#8201;&#8212;&#8201;such as a <code class="literal">QueueChannel</code> with a capacity limit that is currently full.
The default is infinity.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO40-18">(18)</a> </p></td><td valign="top" align="left">
<p>The channel on which this gateway receives request messages.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO40-19">(19)</a> </p></td><td valign="top" align="left">
<p>A reference to a <code class="literal">Destination</code> to which request messages are sent.
One of <code class="literal">reply-destination</code>, <code class="literal">reply-destination-expression</code>, or <code class="literal">reply-destination-name</code> is required.
You can use only one of those three attributes.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO40-20">(20)</a> </p></td><td valign="top" align="left">
<p>A SpEL expression evaluating to a <code class="literal">Destination</code> to which request messages are sent.
The expression can result in a <code class="literal">Destination</code> object or a <code class="literal">String</code>.
It is used by the <code class="literal">DestinationResolver</code> to resolve the actual <code class="literal">Destination</code>.
Oneof <code class="literal">reply-destination</code>, <code class="literal">reply-destination-expression</code>, or <code class="literal">reply-destination-name</code> is required.
You can use only one of those three attributes.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO40-21">(21)</a> </p></td><td valign="top" align="left">
<p>The name of the destination to which request messages are sent.
It is used by the <code class="literal">DestinationResolver</code> to resolve the actual <code class="literal">Destination</code>.
One of <code class="literal">reply-destination</code>, <code class="literal">reply-destination-expression</code>, or <code class="literal">reply-destination-name</code> is required.
You can use only one of those three attributes.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO40-22">(22)</a> </p></td><td valign="top" align="left">
<p>When set to <code class="literal">true</code>, it indicates that any request <code class="literal">Destination</code> resolved by the <code class="literal">DestinationResolver</code> should be a <code class="literal">Topic</code> rather then a <code class="literal">Queue</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO40-23">(23)</a> </p></td><td valign="top" align="left">
<p>Specifies the message time to live.
This setting takes effect only if <code class="literal">explicit-qos-enabled</code> is <code class="literal">true</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO40-24">(24)</a> </p></td><td valign="top" align="left">
<p>Specifies whether this outbound gateway must return a non-null value.
By default, this value is <code class="literal">true</code>, and a <code class="literal">MessageTimeoutException</code> is thrown when the underlying service does not return a value after the <code class="literal">receive-timeout</code>.
Note that, if the service is never expected to return a reply, it would be better to use a <code class="literal">&lt;int-jms:outbound-channel-adapter/&gt;</code> instead of a <code class="literal">&lt;int-jms:outbound-gateway/&gt;</code> with <code class="literal">requires-reply="false"</code>.
With the latter, the sending thread is blocked, waiting for a reply for the <code class="literal">receive-timeout</code> period.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO40-25">(25)</a> </p></td><td valign="top" align="left">
<p>When you use a <code class="literal">&lt;reply-listener /&gt;</code>, its lifecycle (start and stop) matches that of the gateway by default.
When this value is greater than <code class="literal">0</code>, the container is started on demand (when a request is sent).
The container continues to run until at least this time elapses with no requests being received (and until no replies are outstanding).
The container is started again on the next request.
The stop time is a minimum and may actually be up to 1.5x this value.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO40-26">(26)</a> </p></td><td valign="top" align="left">
<p>See <a class="xref" href="#jms-async-gateway" title="23.5.4&nbsp;Async Gateway">Section&nbsp;23.5.4, &#8220;Async Gateway&#8221;</a>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO40-27">(27)</a> </p></td><td valign="top" align="left">
<p>When this element is included, replies are received by an asynchronous <code class="literal">MessageListenerContainer</code> rather than creating a consumer for each reply.
This can be more efficient in many cases.</p>
</td></tr></table></div>
</div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jms-header-mapping" href="#jms-header-mapping"></a>23.6&nbsp;Mapping Message Headers to and from JMS Message</h2></div></div></div>

<p>JMS messages can contain meta-information such as JMS API headers and simple properties.
You can map those to and from Spring Integration message headers by using <code class="literal">JmsHeaderMapper</code>.
The JMS API headers are passed to the appropriate setter methods (such as <code class="literal">setJMSReplyTo</code>), whereas other headers are copied to the general properties of the JMS Message.
JMS outbound gateway is bootstrapped with the default implementation of <code class="literal">JmsHeaderMapper</code>, which will map standard JMS API Headers as well as primitive or <code class="literal">String</code> message headers.
You could also provide a custom header mapper by using the <code class="literal">header-mapper</code> attribute of inbound and outbound gateways.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Since version 4.0, the <code class="literal">JMSPriority</code> header is mapped to the standard <code class="literal">priority</code> header for inbound messages.
(previously, the <code class="literal">priority</code> header was only used for outbound messages).
To revert to the previous behavior (that is, to not map the inbound priority), set the <code class="literal">mapInboundPriority</code> property of <code class="literal">DefaultJmsHeaderMapper</code> to <code class="literal">false</code>.</p>
</td></tr></table></div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Since version 4.3, the <code class="literal">DefaultJmsHeaderMapper</code> maps the standard <code class="literal">correlationId</code> header as a message
property by invoking its <code class="literal">toString()</code> method (<code class="literal">correlationId</code> is often a <code class="literal">UUID</code>, which is not supported by JMS).
On the inbound side, it is mapped as a <code class="literal">String</code>.
This is independent of the <code class="literal">jms_correlationId</code> header, which is mapped to and from the <code class="literal">JMSCorrelationID</code> header.
The <code class="literal">JMSCorrelationID</code> is generally used to correlate requests and replies, whereas the <code class="literal">correlationId</code> is often used to combine related messages into a group (such as with an aggregator or a resequencer).</p>
</td></tr></table></div>
<p>Starting with version 5.1, the <code class="literal">DefaultJmsHeaderMapper</code> can be configured for mapping inbound <code class="literal">JMSDeliveryMode</code> and <code class="literal">JMSExpiration</code> properties:
 ====
 [source,java]
 ----
 @Bean
 public DefaultJmsHeaderMapper jmsHeaderMapper() {
     DefaultJmsHeaderMapper mapper = new DefaultJmsHeaderMapper();
     mapper.setMapInboundDeliveryMode(true)
     mapper.setMapInboundExpiration(true)
     return mapper;
 }
 ----
 ====</p>
<p>These JMS properties are mapped to the <code class="literal">JmsHeaders.DELIVERY_MODE</code> and <code class="literal">JmsHeaders.EXPIRATION</code> Spring Message headers respectively.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jms-conversion-and-marshalling" href="#jms-conversion-and-marshalling"></a>23.7&nbsp;Message Conversion, Marshalling, and Unmarshalling</h2></div></div></div>

<p>If you need to convert the message, all JMS adapters and gateways let you provide a <code class="literal">MessageConverter</code> by setting the <code class="literal">message-converter</code> attribute.
To do so, provide the bean name of an instance of <code class="literal">MessageConverter</code> that is available within the same ApplicationContext.
Also, to provide some consistency with marshaller and unmarshaller interfaces, Spring provides <code class="literal">MarshallingMessageConverter</code>, which you can configure with your own custom marshallers and unmarshallers.
The following example shows how to do so</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-jms:inbound-gateway</span> <span class="hl-attribute">request-destination</span>=<span class="hl-value">"requestQueue"</span>
    <span class="hl-attribute">request-channel</span>=<span class="hl-value">"inbound-gateway-channel"</span>
    <span class="hl-attribute">message-converter</span>=<span class="hl-value">"marshallingMessageConverter"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"marshallingMessageConverter"</span>
    <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.jms.support.converter.MarshallingMessageConverter"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.bar.SampleMarshaller"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/constructor-arg&gt;</span>
    <span class="hl-tag">&lt;constructor-arg&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.bar.SampleUnmarshaller"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/constructor-arg&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
</div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>When you provide your own <code class="literal">MessageConverter</code> instance, it is still wrapped within the <code class="literal">HeaderMappingMessageConverter</code>.
This means that the <span class="emphasis"><em>extract-request-payload</em></span> and <span class="emphasis"><em>extract-reply-payload</em></span> properties can affect the actual objects passed to your converter.
The <code class="literal">HeaderMappingMessageConverter</code> itself delegates to a target <code class="literal">MessageConverter</code> while also mapping the Spring Integration <code class="literal">MessageHeaders</code> to JMS message properties and back again.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jms-channel" href="#jms-channel"></a>23.8&nbsp;JMS-backed Message Channels</h2></div></div></div>

<p>The channel adapters and gateways featured earlier are all intended for applications that integrate with other external systems.
The inbound options assume that some other system is sending JMS messages to the JMS destination, and the outbound options assume that some other system is receiving from the destination.
The other system may or may not be a Spring Integration application.
Of course, when sending a Spring Integration message instance as the body of the JMS message itself (with <span class="emphasis"><em>extract-payload</em></span> value set to <code class="literal">false</code>), it is assumed that the other system is based on Spring Integration.
However, that is by no means a requirement.
That flexibility is one of the benefits of using a message-based integration option with the abstraction of "<code class="literal">channels</code>"( or destinations in the case of JMS).</p>
<p>Sometimes, both the producer and consumer for a given JMS Destination are intended to be part of the same application, running within the same process.
You can accomplish this by using a pair of inbound and outbound channel adapters.
The problem with that approach is that you need two adapters, even though, conceptually, the goal is to have a single message channel.
A better option is supported as of Spring Integration version 2.0.
Now it is possible to define a single "<code class="literal">channel</code>" when using the JMS namespace, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-jms:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"jmsChannel"</span> <span class="hl-attribute">queue</span>=<span class="hl-value">"exampleQueue"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>The channel in the preceding example behaves much like a normal <code class="literal">&lt;channel/&gt;</code> element from the main Spring Integration namespace.
It can be referenced by both the <code class="literal">input-channel</code> and <code class="literal">output-channel</code> attributes of any endpoint.
The difference is that this channel is backed by a JMS Queue instance named <code class="literal">exampleQueue</code>.
This means that asynchronous messaging is possible between the producing and consuming endpoints.
However, unlike the simpler asynchronous message channels created by adding a <code class="literal">&lt;queue/&gt;</code> element within a non-JMS <code class="literal">&lt;channel/&gt;</code> element, the messages are not stored in an in-memory queue.
Instead, those messages are passed within a JMS message body, and the full power of the underlying JMS provider is then available for that channel.
Probably the most common rationale for using this alternative is to take advantage of the persistence made available by the store-and-forward approach of JMS messaging.</p>
<p>If configured properly, the JMS-backed message channel also supports transactions.
In other words, a producer would not actually write to a transactional JMS-backed channel if its send operation is part of a transaction that rolls back.
Likewise, a consumer would not physically remove a JMS message from the channel if the reception of that message is part of a transaction that rolls back.
Note that the producer and consumer transactions are separate in such a scenario.
This is significantly different than the propagation of a transactional context across a simple, synchronous <code class="literal">&lt;channel/&gt;</code> element that has no <code class="literal">&lt;queue/&gt;</code> child element.</p>
<p>Since the preceding example above references a JMS Queue instance, it acts as a point-to-point channel.
If, on the other hand, you need publish-subscribe behavior, you can use a separate element and reference a JMS Topic instead.
The following example shows how to do so:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-jms:publish-subscribe-channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"jmsChannel"</span> <span class="hl-attribute">topic</span>=<span class="hl-value">"exampleTopic"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>For either type of JMS-backed channel, the name of the destination may be provided instead of a reference, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-jms:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"jmsQueueChannel"</span> <span class="hl-attribute">queue-name</span>=<span class="hl-value">"exampleQueueName"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;jms:publish-subscribe-channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"jmsTopicChannel"</span> <span class="hl-attribute">topic-name</span>=<span class="hl-value">"exampleTopicName"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>In the preceding examples, the destination names are resolved by Spring&#8217;s default <code class="literal">DynamicDestinationResolver</code> implementation, but you could provide any implementation of the <code class="literal">DestinationResolver</code> interface.
Also, the JMS <code class="literal">ConnectionFactory</code> is a required property of the channel, but, by default, the expected bean name would be <code class="literal">jmsConnectionFactory</code>.
The following example provides both a custom instance for resolution of the JMS destination names and a different name for the <code class="literal">ConnectionFactory</code>:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-jms:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"jmsChannel"</span> <span class="hl-attribute">queue-name</span>=<span class="hl-value">"exampleQueueName"</span>
    <span class="hl-attribute">destination-resolver</span>=<span class="hl-value">"customDestinationResolver"</span>
    <span class="hl-attribute">connection-factory</span>=<span class="hl-value">"customConnectionFactory"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>For the <code class="literal">&lt;publish-subscribe-channel /&gt;</code>, set the <code class="literal">durable</code> attribute to <code class="literal">true</code> for a durable subscription or <code class="literal">subscription-shared</code> for a shared subscription (requires a JMS 2.0 broker and has been available since version 4.2).
Use <code class="literal">subscription</code> to name the subscription.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jms-selectors" href="#jms-selectors"></a>23.9&nbsp;Using JMS Message Selectors</h2></div></div></div>

<p>With JMS message selectors, you can filter <a class="ulink" href="http://docs.oracle.com/javaee/6/api/javax/jms/Message.html" target="_top">JMS Messages</a> based on JMS headers as well as JMS properties.
For example, if you want to listen to messages whose custom JMS header property, <code class="literal">myHeaderProperty</code>, equals <code class="literal">something</code>, you can specify the following expression:</p>
<div class="informalexample">
<pre class="programlisting">myHeaderProperty = 'something'</pre>
</div>
<p>Message selector expressions are a subset of the <a class="ulink" href="http://en.wikipedia.org/wiki/SQL-92" target="_top">SQL-92</a> conditional expression syntax and are defined as part of the <a class="ulink" href="http://download.oracle.com/otn-pub/jcp/7195-jms-1.1-fr-spec-oth-JSpec/jms-1_1-fr-spec.pdf" target="_top">Java Message Service</a> specification (Version 1.1, April 12, 2002).
Specifically, see chapter "3.8, Message Selection".
It contains a detailed explanation of the expressions syntax.</p>
<p>You can specify the JMS message <code class="literal">selector</code> attribute by using XML namespace configuration for the following Spring Integration JMS components:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
JMS Channel
</li><li class="listitem">
JMS Publish Subscribe Channel
</li><li class="listitem">
JMS Inbound Channel Adapter
</li><li class="listitem">
JMS Inbound Gateway
</li><li class="listitem">
JMS Message-driven Channel Adapter
</li></ul></div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>You cannot reference message body values by using JMS Message selectors.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jms-samples" href="#jms-samples"></a>23.10&nbsp;JMS Samples</h2></div></div></div>

<p>To experiment with these JMS adapters, check out the JMS samples available in the Spring Integration Samples Git repository at <a class="ulink" href="https://github.com/SpringSource/spring-integration-samples/tree/master/basic/jms" target="_top">https://github.com/SpringSource/spring-integration-samples/tree/master/basic/jms</a>.</p>
<p>That repository includes two samples.
One provides inbound and outbound channel adapters, and the other provides inbound and outbound gateways.
They are configured to run with an embedded <a class="ulink" href="http://activemq.apache.org/" target="_top">ActiveMQ</a> process, but you can modify the <a class="ulink" href="https://github.com/SpringSource/spring-integration-samples/blob/master/basic/jms/src/main/resources/META-INF/spring/integration/common.xml" target="_top">common.xml</a> Spring application context file of each sample to support either a different JMS provider or a standalone ActiveMQ process.</p>
<p>In other words, you can split the configuration so that the inbound and outbound adapters run in separate JVMs.
If you have ActiveMQ installed,  modify the <code class="literal">brokerURL</code> property within the common.xml file to use <code class="literal">tcp://localhost:61616</code> (instead of <code class="literal">vm://localhost</code>).
Both of the samples accept input from stdin and echo back to stdout.
Look at the configuration to see how these messages are routed over JMS.</p>
</div>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="mail" href="#mail"></a>24.&nbsp;Mail Support</h2></div></div></div>

<p>This section describes how to work with mail messages in Spring Integration.</p>
<p>You need to include this dependency into your project:</p>
<div class="informalexample">
<p>
<b>Maven.&nbsp;</b>

</p><pre class="programlisting"><span class="hl-tag">&lt;dependency&gt;</span>
    <span class="hl-tag">&lt;groupId&gt;</span>org.springframework.integration<span class="hl-tag">&lt;/groupId&gt;</span>
    <span class="hl-tag">&lt;artifactId&gt;</span>spring-integration-mail<span class="hl-tag">&lt;/artifactId&gt;</span>
    <span class="hl-tag">&lt;version&gt;</span>5.1.2.RELEASE<span class="hl-tag">&lt;/version&gt;</span>
<span class="hl-tag">&lt;/dependency&gt;</span></pre><p>

</p>
<p>
<b>Gradle.&nbsp;</b>

</p><pre class="programlisting">compile <span class="hl-string">"org.springframework.integration:spring-integration-mail:5.1.2.RELEASE"</span></pre><p>

</p>
</div>
<p>The <code class="literal">javax.mail:javax.mail-api</code> must be included via vendor-specific implementation.</p>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="mail-outbound" href="#mail-outbound"></a>24.1&nbsp;Mail-sending Channel Adapter</h2></div></div></div>

<p>Spring Integration provides support for outbound email with the <code class="literal">MailSendingMessageHandler</code>.
It delegates to a configured instance of Spring&#8217;s <code class="literal">JavaMailSender</code>, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"> JavaMailSender mailSender = context.getBean(<span class="hl-string">"mailSender"</span>, JavaMailSender.<span class="hl-keyword">class</span>);

 MailSendingMessageHandler mailSendingHandler = <span class="hl-keyword">new</span> MailSendingMessageHandler(mailSender);</pre>
</div>
<p><code class="literal">MailSendingMessageHandler</code> has various mapping strategies that use Spring&#8217;s <code class="literal">MailMessage</code> abstraction.
If the received message&#8217;s payload is already a <code class="literal">MailMessage</code> instance, it is sent directly.
Therefore, we generally recommend that you precede this consumer with a transformer for non-trivial <code class="literal">MailMessage</code> construction requirements.
However, Spring Integration supports a few simple message mapping strategies.
For example, if the message payload is a byte array, that is mapped to an attachment.
For simple text-based emails, you can provide a string-based message payload.
In that case, a <code class="literal">MailMessage</code> is created with that <code class="literal">String</code> as the text content.
If you work with a message payload type whose <code class="literal">toString()</code> method returns appropriate mail text content, consider adding Spring Integration&#8217;s <code class="literal">ObjectToStringTransformer</code> prior to the outbound mail adapter (see the example in <a class="xref" href="#transformer-namespace" title="9.1.1&nbsp;Configuring a Transformer with XML">Section&nbsp;9.1.1, &#8220;Configuring a Transformer with XML&#8221;</a> for more detail).</p>
<p>You can also configure the outbound <code class="literal">MailMessage</code> with certain values from <code class="literal">MessageHeaders</code>.
If available, values are mapped to the outbound mail&#8217;s properties, such as the recipients (To, Cc, and BCc), the from, the reply-to, and the subject.
The header names are defined by the following constants:</p>
<div class="informalexample">
<pre class="programlisting"> MailHeaders.SUBJECT
 MailHeaders.TO
 MailHeaders.CC
 MailHeaders.BCC
 MailHeaders.FROM
 MailHeaders.REPLY_TO</pre>
</div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p><code class="literal">MailHeaders</code> also lets you override corresponding <code class="literal">MailMessage</code> values.
For example, if <code class="literal">MailMessage.to</code> is set to <span class="emphasis"><em>thing1@things.com</em></span> and the <code class="literal">MailHeaders.TO</code> message header is provided, it takes precedence and overrides the corresponding value in <code class="literal">MailMessage</code>.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="mail-inbound" href="#mail-inbound"></a>24.2&nbsp;Mail-receiving Channel Adapter</h2></div></div></div>

<p>Spring Integration also provides support for inbound email with the <code class="literal">MailReceivingMessageSource</code>.
It delegates to a configured instance of Spring Integration&#8217;s own <code class="literal">MailReceiver</code> interface.
There are two implementations: <code class="literal">Pop3MailReceiver</code> and <code class="literal">ImapMailReceiver</code>.
The easiest way to instantiate either of these is by passing the <span class="emphasis"><em>uri</em></span> for a mail store to the receiver&#8217;s constructor, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting">MailReceiver receiver = <span class="hl-keyword">new</span> Pop3MailReceiver(<span class="hl-string">"pop3://usr:pwd@localhost/INBOX"</span>);</pre>
</div>
<p>Another option for receiving mail is the IMAP <code class="literal">idle</code> command (if supported by your mail server).
Spring Integration provides the <code class="literal">ImapIdleChannelAdapter</code>, which is itself a message-producing endpoint.
It delegates to an instance of the <code class="literal">ImapMailReceiver</code> but enables asynchronous reception of mail messages.
The next section has examples of configuring both types of inbound channel adapter with Spring Integration&#8217;s namespace support in the <span class="emphasis"><em>mail</em></span> schema.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left"><a name="imap-format-important" href="#imap-format-important"></a>Important</th></tr><tr><td align="left" valign="top">
<p>Normally, when the <code class="literal">IMAPMessage.getContent()</code> method is called, certain headers as well as the body are rendered (for a simple text email), as the following example shows:</p>
</td></tr></table></div>
<div class="informalexample">
<p></p>
<pre class="screen">To: thing1@things.com
From: thing2@morethings.com
Subject: Test Email

something</pre>
</div>
<p>With a simple <code class="literal">MimeMessage</code>, <code class="literal">getContent()</code> returns the mail body (<code class="literal">something</code> in the preceding example).</p>
<p>Starting with version 2.2, the framework eagerly fetches IMAP messages and exposes them as an internal subclass of <code class="literal">MimeMessage</code>.
This had the undesired side effect of changing the <code class="literal">getContent()</code> behavior.
This inconsistency was further exacerbated by the <a class="link" href="#mail-mapping" title="24.3&nbsp;Inbound Mail Message Mapping">Mail Mapping</a> enhancement introduced in version 4.3, because, when a header mapper was provided, the payload was rendered by the <code class="literal">IMAPMessage.getContent()</code> method.
This meant that the IMAP content differed, depending on whether or not a header mapper was provided.
Starting with version 5.0, messages originating from an IMAP source render the content in accordance with <code class="literal">IMAPMessage.getContent()</code> behavior, regardless of whether a header mapper is provided.
If you do not use a header mapper and you wish to revert to the previous behavior of rendering only the body, set the <code class="literal">simpleContent</code> boolean property on the mail receiver to <code class="literal">true</code>.
This property now controls the rendering regardless of whether a header mapper is used.
It now allows body-only rendering when a header mapper is provided.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="mail-mapping" href="#mail-mapping"></a>24.3&nbsp;Inbound Mail Message Mapping</h2></div></div></div>

<p>By default, the payload of messages produced by the inbound adapters is the raw <code class="literal">MimeMessage</code>.
You can use that object to interrogate the headers and content.
Starting with version 4.3, you can provide a <code class="literal">HeaderMapper&lt;MimeMessage&gt;</code> to map the headers to <code class="literal">MessageHeaders</code>.
For convenience, Spring Integration provides a <code class="literal">DefaultMailHeaderMapper</code> for this purpose.
It maps the following headers:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">mail_from</code>: A <code class="literal">String</code> representation of the <code class="literal">from</code> address.
</li><li class="listitem">
<code class="literal">mail_bcc</code>: A <code class="literal">String</code> array containing the <code class="literal">bcc</code> addresses.
</li><li class="listitem">
<code class="literal">mail_cc</code>: A <code class="literal">String</code> array containing the <code class="literal">cc</code> addresses.
</li><li class="listitem">
<code class="literal">mail_to</code>: A <code class="literal">String</code> array containing the <code class="literal">to</code> addresses.
</li><li class="listitem">
<code class="literal">mail_replyTo</code>: A <code class="literal">String</code> representation of the <code class="literal">replyTo</code> address.
</li><li class="listitem">
<code class="literal">mail_subject</code>: The mail subject.
</li><li class="listitem">
<code class="literal">mail_lineCount</code>: A line count (if available).
</li><li class="listitem">
<code class="literal">mail_receivedDate</code>: The received date (if available).
</li><li class="listitem">
<code class="literal">mail_size</code>: The mail size (if available).
</li><li class="listitem">
<code class="literal">mail_expunged</code>: A boolean indicating if the message is expunged.
</li><li class="listitem">
<code class="literal">mail_raw</code>: A <code class="literal">MultiValueMap</code> containing all the mail headers and their values.
</li><li class="listitem">
<code class="literal">mail_contentType</code>: The content type of the original mail message.
</li><li class="listitem">
<code class="literal">contentType</code>: The payload content type (see below).
</li></ul></div>
<p>When message mapping is enabled, the payload depends on the mail message and its implementation.
Email contents are usually rendered by a <code class="literal">DataHandler</code> within the <code class="literal">MimeMessage</code>.</p>
<p>For a <code class="literal">text/*</code> email, the payload is a <code class="literal">String</code> and the <code class="literal">contentType</code> header is the same as <code class="literal">mail_contentType</code>.</p>
<p>For a messages with embedded <code class="literal">javax.mail.Part</code> instances, the <code class="literal">DataHandler</code> usually renders a <code class="literal">Part</code> object.
These objects are not <code class="literal">Serializable</code> and are not suitable for serialization with alternative technologies such as <code class="literal">Kryo</code>.
For this reason, by default, when mapping is enabled, such payloads are rendered as a raw <code class="literal">byte[]</code> containing the <code class="literal">Part</code> data.
Examples of <code class="literal">Part</code> are <code class="literal">Message</code> and <code class="literal">Multipart</code>.
The <code class="literal">contentType</code> header is <code class="literal">application/octet-stream</code> in this case.
To change this behavior and receive a <code class="literal">Multipart</code> object payload, set <code class="literal">embeddedPartsAsBytes</code> to <code class="literal">false</code> on <code class="literal">MailReceiver</code>.
For content types that are unknown to the <code class="literal">DataHandler</code>, the contents are rendered as a <code class="literal">byte[]</code> with a <code class="literal">contentType</code> header of <code class="literal">application/octet-stream</code>.</p>
<p>When you do not provide a header mapper, the message payload is the <code class="literal">MimeMessage</code> presented by <code class="literal">javax.mail</code>.
The framework provides a <code class="literal">MailToStringTransformer</code> that you can use to convert the message by using a strategy to convert the mail contents to a <code class="literal">String</code>.
This is also available by using the XML namespace, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-mail:mail-to-string-transformer</span> <span class="hl-attribute">...</span><span class="hl-tag"> &gt;</span></pre>
</div>
<p>The following example does the same thing with Java configuration:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<em><span class="hl-annotation" style="color: gray">@Transformer(inputChannel="...", outputChannel="...")</span></em>
<span class="hl-keyword">public</span> Transformer transformer() {
    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> MailToStringTransformer();
}</pre>
</div>
<p>The following example does the same thing with the Java DSL:</p>
<div class="informalexample">
<pre class="programlisting">   ...
   .transform(Mail.toStringTransformer())
   ...</pre>
</div>
<p>Starting with version 4.3, the transformer handles embedded <code class="literal">Part</code> instances (as well as <code class="literal">Multipart</code> instances, which were handled previously).
The transformer is a subclass of <code class="literal">AbstractMailTransformer</code> that maps the address and subject headers from the preceding list.
If you wish to perform some other transformation on the message, consider subclassing <code class="literal">AbstractMailTransformer</code>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="mail-namespace" href="#mail-namespace"></a>24.4&nbsp;Mail Namespace Support</h2></div></div></div>

<p>Spring Integration provides a namespace for mail-related configuration.
To use it, configure the following schema locations:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/schema/beans"</span>
  <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
  <span class="hl-attribute">xmlns:int-mail</span>=<span class="hl-value">"http://www.springframework.org/schema/integration/mail"</span>
  <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"http://www.springframework.org/schema/beans
    http://www.springframework.org/schema/beans/spring-beans.xsd
    http://www.springframework.org/schema/integration/mail
    http://www.springframework.org/schema/integration/mail/spring-integration-mail.xsd"</span><span class="hl-tag">&gt;</span></pre>
</div>
<p>To configure an outbound channel adapter, provide the channel from which to receive and the MailSender, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-mail:outbound-channel-adapter</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"outboundMail"</span>
    <span class="hl-attribute">mail-sender</span>=<span class="hl-value">"mailSender"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>Alternatively, you can provide the host, username, and password, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-mail:outbound-channel-adapter</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"outboundMail"</span>
    <span class="hl-attribute">host</span>=<span class="hl-value">"somehost"</span> <span class="hl-attribute">username</span>=<span class="hl-value">"someuser"</span> <span class="hl-attribute">password</span>=<span class="hl-value">"somepassword"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>As with any outbound Channel Adapter, if the referenced channel is a <code class="literal">PollableChannel</code>, you should provide a <code class="literal">&lt;poller&gt;</code> element (see <a class="xref" href="#endpoint-namespace" title="10.1.4&nbsp;Endpoint Namespace Support">Section&nbsp;10.1.4, &#8220;Endpoint Namespace Support&#8221;</a>).</p>
</td></tr></table></div>
<p>When you use the namespace support, you can also use a <code class="literal">header-enricher</code> message transformer.
Doing so simplifies the application of the headers mentioned earlier to any message prior to sending to the mail outbound channel adapter.</p>
<p>The following example assumes the payload is a Java bean with appropriate getters for the specified properties, but you can use any SpEL expression:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-mail:header-enricher</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"expressionsInput"</span> <span class="hl-attribute">default-overwrite</span>=<span class="hl-value">"false"</span><span class="hl-tag">&gt;</span>
	<span class="hl-tag">&lt;int-mail:to</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"payload.to"</span><span class="hl-tag">/&gt;</span>
	<span class="hl-tag">&lt;int-mail:cc</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"payload.cc"</span><span class="hl-tag">/&gt;</span>
	<span class="hl-tag">&lt;int-mail:bcc</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"payload.bcc"</span><span class="hl-tag">/&gt;</span>
	<span class="hl-tag">&lt;int-mail:from</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"payload.from"</span><span class="hl-tag">/&gt;</span>
	<span class="hl-tag">&lt;int-mail:reply-to</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"payload.replyTo"</span><span class="hl-tag">/&gt;</span>
	<span class="hl-tag">&lt;int-mail:subject</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"payload.subject"</span> <span class="hl-attribute">overwrite</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-mail:header-enricher&gt;</span></pre>
</div>
<p>Alternatively, you can use the <code class="literal">value</code> attribute to specify a literal.
You also can specify <code class="literal">default-overwrite</code> and individual <code class="literal">overwrite</code> attributes to control the behavior with existing headers.</p>
<p>To configure an inbound channel adapter, you have the choice between polling or event-driven (assuming your mail server supports IMAP <code class="literal">idle</code>&#8201;&#8212;&#8201;if not, then polling is the only option).
A polling channel adapter requires the store URI and the channel to which to send inbound messages.
The URI may begin with <code class="literal">pop3</code> or <code class="literal">imap</code>.
The following example uses an <code class="literal">imap</code> URI:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-mail:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"imapAdapter"</span>
      <span class="hl-attribute">store-uri</span>=<span class="hl-value">"imaps://[username]:[password]@imap.gmail.com/INBOX"</span>
      <span class="hl-attribute">java-mail-properties</span>=<span class="hl-value">"javaMailProperties"</span>
      <span class="hl-attribute">channel</span>=<span class="hl-value">"receiveChannel"</span>
      <span class="hl-attribute">should-delete-messages</span>=<span class="hl-value">"true"</span>
      <span class="hl-attribute">should-mark-messages-as-read</span>=<span class="hl-value">"true"</span>
      <span class="hl-attribute">auto-startup</span>=<span class="hl-value">"true"</span><span class="hl-tag">&gt;</span>
      <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">max-messages-per-poll</span>=<span class="hl-value">"1"</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"5000"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-mail:inbound-channel-adapter&gt;</span></pre>
</div>
<p>If you do have IMAP <code class="literal">idle</code> support, you may want to configure the <code class="literal">imap-idle-channel-adapter</code> element instead.
Since the <code class="literal">idle</code> command enables event-driven notifications, no poller is necessary for this adapter.
It sends a message to the specified channel as soon as it receives the notification that new mail is available.
The following example configures an IMAP <code class="literal">idle</code> mail channel:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-mail:imap-idle-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"customAdapter"</span>
      <span class="hl-attribute">store-uri</span>=<span class="hl-value">"imaps://[username]:[password]@imap.gmail.com/INBOX"</span>
      <span class="hl-attribute">channel</span>=<span class="hl-value">"receiveChannel"</span>
      <span class="hl-attribute">auto-startup</span>=<span class="hl-value">"true"</span>
      <span class="hl-attribute">should-delete-messages</span>=<span class="hl-value">"false"</span>
      <span class="hl-attribute">should-mark-messages-as-read</span>=<span class="hl-value">"true"</span>
      <span class="hl-attribute">java-mail-properties</span>=<span class="hl-value">"javaMailProperties"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>You can provide <code class="literal">javaMailProperties</code> by creating and populating a regular <code class="literal">java.utils.Properties</code> object&#8201;&#8212;&#8201;for example, by using the <code class="literal">util</code> namespace provided by Spring.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>If your username contains the <span class="emphasis"><em>@</em></span> character, use <span class="emphasis"><em>%40</em></span> instead of <span class="emphasis"><em>@</em></span> to avoid parsing errors from the underlying JavaMail API.</p>
</td></tr></table></div>
<p>The following example shows how to configure a <code class="literal">java.util.Properties</code> object:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;util:properties</span> <span class="hl-attribute">id</span>=<span class="hl-value">"javaMailProperties"</span><span class="hl-tag">&gt;</span>
  <span class="hl-tag">&lt;prop</span> <span class="hl-attribute">key</span>=<span class="hl-value">"mail.imap.socketFactory.class"</span><span class="hl-tag">&gt;</span>javax.net.ssl.SSLSocketFactory<span class="hl-tag">&lt;/prop&gt;</span>
  <span class="hl-tag">&lt;prop</span> <span class="hl-attribute">key</span>=<span class="hl-value">"mail.imap.socketFactory.fallback"</span><span class="hl-tag">&gt;</span>false<span class="hl-tag">&lt;/prop&gt;</span>
  <span class="hl-tag">&lt;prop</span> <span class="hl-attribute">key</span>=<span class="hl-value">"mail.store.protocol"</span><span class="hl-tag">&gt;</span>imaps<span class="hl-tag">&lt;/prop&gt;</span>
  <span class="hl-tag">&lt;prop</span> <span class="hl-attribute">key</span>=<span class="hl-value">"mail.debug"</span><span class="hl-tag">&gt;</span>false<span class="hl-tag">&lt;/prop&gt;</span>
<span class="hl-tag">&lt;/util:properties&gt;</span></pre>
</div>
<p><a name="search-term" href="#search-term"></a>By default, the <code class="literal">ImapMailReceiver</code> searches for messages based on the default <code class="literal">SearchTerm</code>, which is all mail messages that:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Are RECENT (if supported)
</li><li class="listitem">
Are NOT ANSWERED
</li><li class="listitem">
Are NOT DELETED
</li><li class="listitem">
Are NOT SEEN
</li><li class="listitem">
hHave not been processed by this mail receiver (enabled by the use of the custom USER flag or simply NOT FLAGGED if not supported)
</li></ul></div>
<p>The custom user flag is <code class="literal">spring-integration-mail-adapter</code>, but you can configure it.
Since version 2.2, the <code class="literal">SearchTerm</code> used by the <code class="literal">ImapMailReceiver</code> is fully configurable with <code class="literal">SearchTermStrategy</code>,
which you can inject by using the <code class="literal">search-term-strategy</code> attribute.
<code class="literal">SearchTermStrategy</code> is a strategy interface with a single method that lets you create an instance of the <code class="literal">SearchTerm</code> used by the <code class="literal">ImapMailReceiver</code>.
The following listing shows the <code class="literal">SearchTermStrategy</code> interface:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> SearchTermStrategy {

    SearchTerm generateSearchTerm(Flags supportedFlags, Folder folder);

}</pre>
</div>
<p>The following example relies <code class="literal">TestSearchTermStrategy</code> rather than the default <code class="literal">SearchTermStrategy</code>:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;mail:imap-idle-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"customAdapter"</span>
			<span class="hl-attribute">store-uri</span>=<span class="hl-value">"imap:something"</span>
			<span class="hl-attribute">&#8230;</span>
			<span class="hl-attribute">search-term-strategy</span>=<span class="hl-value">"searchTermStrategy"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"searchTermStrategy"</span>
  <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.mail.config.ImapIdleChannelAdapterParserTests.TestSearchTermStrategy"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>See <a class="xref" href="#imap-seen" title="24.5&nbsp;Marking IMAP Messages When \Recent Is Not Supported">Section&nbsp;24.5, &#8220;Marking IMAP Messages When <code class="literal">\Recent</code> Is Not Supported&#8221;</a> for information about message flagging.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important: Important: IMAP PEEK"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left"><a name="imap-peek" href="#imap-peek"></a>Important: IMAP PEEK</th></tr><tr><td align="left" valign="top">

<p>Starting with version 4.1.1, the IMAP mail receiver uses the <code class="literal">mail.imap.peek</code> or <code class="literal">mail.imaps.peek</code> JavaMail property, if specified.
Previously, the receiver ignored the property and always set the <code class="literal">PEEK</code> flag.
Now, if you explicitly set this property to <code class="literal">false</code>, the message ise marked as <code class="literal">\Seen</code> regardless of the setting of <code class="literal">shouldMarkMessagesRead</code>.
If not specified, the previous behavior is retained (peek is <code class="literal">true</code>).</p>
</td></tr></table></div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_imap_literal_idle_literal_and_lost_connections" href="#_imap_literal_idle_literal_and_lost_connections"></a>24.4.1&nbsp;IMAP <code class="literal">idle</code> and Lost Connections</h3></div></div></div>

<p>When using an IMAP <code class="literal">idle</code> channel adapter, connections to the server may be lost (for example, through network failure) and, since the JavaMail documentation explicitly states that the actual IMAP API is experimental, it is important to understand the differences in the API and how to deal with them when configuring IMAP <code class="literal">idle</code> adapters.
Currently, Spring Integration mail adapters were tested with JavaMail 1.4.1 and JavaMail 1.4.3.
Depending on which one is used, you must pay special attention to some of the JavaMail properties that need to be set with regard to auto-reconnect.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The following behavior was observed with Gmail but should provide you with some tips on how to solve re-connect issue with other providers.
However feedback is always welcome.
Again, the following notes are based on Gmail.</p>
</td></tr></table></div>
<p>With JavaMail 1.4.1, if you set the <code class="literal">mail.imaps.timeout</code> property to a relatively short period of time (approximately 5 min in our testing), <code class="literal">IMAPFolder.idle()</code> throws <code class="literal">FolderClosedException</code> after this timeout.
However, if this property is not set (it should be indefinite) the  <code class="literal">IMAPFolder.idle()</code> method never returns and never throws an exception.
It does, however, reconnect automatically if the connection was lost for a short period of time (under 10 min in our testing).
However, if the connection was lost for a long period of time (over 10 min), <code class="literal">IMAPFolder.idle()</code>, does not throw <code class="literal">FolderClosedException</code> and does not re-establish the connection, and remains in the blocked state indefinitely, thus leaving you no possibility to reconnect without restarting the adapter.
Consequently, the only way to make re-connecting work with JavaMail 1.4.1 is to set the <code class="literal">mail.imaps.timeout</code> property explicitly to some value, but it also means that such value should be relatively short (under 10 min) and the connection should be re-established relatively quickly.
Again, it may be different with providers other than Gmail.
With JavaMail 1.4.3 introduced significant improvements to the API, ensuring that there is always a condition that forces the <code class="literal">IMAPFolder.idle()</code> method to return  <code class="literal">StoreClosedException</code> or <code class="literal">FolderClosedException</code> or to simply return, thus letting you proceed with auto-reconnecting.
Currently auto-reconnecting runs infinitely making attempts to reconnect every ten seconds.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>In both configurations, <code class="literal">channel</code> and <code class="literal">should-delete-messages</code> are required attributes.
You should understand why <code class="literal">should-delete-messages</code> is required.
The issue is with the POP3 protocol, which does not have any knowledge of messages that were read.
It can only know what has been read within a single session.
This means that, when your POP3 mail adapter runs, emails are successfully consumed as as they become available during each poll
and no single email message is delivered more then once.
However, as soon as you restart your adapter and begin a new session, all the email messages that might have been retrieved in the previous session are retrieved again.
That is the nature of POP3.
Some might argue that <code class="literal">should-delete-messages</code> should be <code class="literal">true</code> by default.
In other words, there are two valid and mutually exclusive use that make it very hard to pick a single best default.
You may want to configure your adapter as the only email receiver, in which case you want to be able to restart your adapter without fear that previously delivered messages are not delivered again.
In this case, setting <code class="literal">should-delete-messages</code> to <code class="literal">true</code> would make the most sense.
However, you may have another use case where you may want to have multiple adapters monitor email servers and their content.
In other words, you want to <span class="emphasis"><em>peek but not touch</em></span>.
Then setting <code class="literal">should-delete-messages</code> to <code class="literal">false</code> is much more appropriate.
So since it is hard to choose what should be the right default value for the <code class="literal">should-delete-messages</code> attribute, we made it a required attribute to be set by you.
Leaving it up to you also means that you are less likely to end up with unintended behavior.</p>
</td></tr></table></div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>When configuring a polling email adapter&#8217;s <code class="literal">should-mark-messages-as-read</code> attribute, you should be aware of the protocol you are configuring to retrieve messages.
For example, POP3 does not support this flag, which means setting it to either value has no effect, as messages are not marked as read.</p>
</td></tr></table></div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>You should understand that that these actions (marking messages read and deleting messages) are performed after the messages are received but before they are processed.
This can cause messages to be lost.</p>
<p>You may wish to consider using transaction synchronization instead.
See <a class="xref" href="#mail-tx-sync" title="24.7&nbsp;Transaction Synchronization">Section&nbsp;24.7, &#8220;Transaction Synchronization&#8221;</a>.</p>
</td></tr></table></div>
<p>The <code class="literal">&lt;imap-idle-channel-adapter/&gt;</code> also accepts the <span class="emphasis"><em>error-channel</em></span> attribute.
If a downstream exception is thrown and an <span class="emphasis"><em>error-channel</em></span> is specified, a <code class="literal">MessagingException</code> message containing the failed message and the original exception is sent to this channel.
Otherwise, if the downstream channels are synchronous, any such exception is logged as a warning by the channel adapter.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Beginning with the 3.0 release, the IMAP <code class="literal">idle</code> adapter emits application events (specifically <code class="literal">ImapIdleExceptionEvent</code> instances) when exceptions occur.
This allows applications to detect and act on those exceptions.
You can obtain the events by using an <code class="literal">&lt;int-event:inbound-channel-adapter&gt;</code> or any <code class="literal">ApplicationListener</code> configured to receive an <code class="literal">ImapIdleExceptionEvent</code> or one of its super classes.</p>
</td></tr></table></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="imap-seen" href="#imap-seen"></a>24.5&nbsp;Marking IMAP Messages When <code class="literal">\Recent</code> Is Not Supported</h2></div></div></div>

<p>If <code class="literal">shouldMarkMessagesAsRead</code> is true, the IMAP adapters set the <code class="literal">\Seen</code> flag.</p>
<p>In addition, when an email server does not support the <code class="literal">\Recent</code> flag, the IMAP adapters mark messages with a user flag (by default, <code class="literal">spring-integration-mail-adapter</code>), as long as the server supports user flags.
If not, <code class="literal">Flag.FLAGGED</code> is set to <code class="literal">true</code>.
These flags are applied regardless of the <code class="literal">shouldMarkMessagesRead</code> setting.</p>
<p>As discussed in <a class="xref" href="#search-term">Section&nbsp;24.4, &#8220;Mail Namespace Support&#8221;</a>, the default <code class="literal">SearchTermStrategy</code> ignore messages that are so flagged.</p>
<p>Starting with version 4.2.2, you can set the name of the user flag by using <code class="literal">setUserFlag</code> on the <code class="literal">MailReceiver</code>.
Doing so lets multiple receivers use a different flag (as long as the mail server supports user flags).
The <code class="literal">user-flag</code> attribute is available when configuring the adapter with the namespace.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="mail-filtering" href="#mail-filtering"></a>24.6&nbsp;Email Message Filtering</h2></div></div></div>

<p>Very often, you may encounter a requirement to filter incoming messages (for example, you want to read only emails that have <span class="emphasis"><em>Spring Integration</em></span> in the <code class="literal">Subject</code> line).
You can accomplish this by connecting an inbound mail adapter with an expression-based <code class="literal">Filter</code>.
Although it would work, there is a downside to this approach.
Since messages would be filtered after going through the inbound mail adapter, all such messages would be marked as read (<code class="literal">SEEN</code>) or unread (depending on the value of <code class="literal">should-mark-messages-as-read</code> attribute).
However, in reality, it be more useful to mark messages as <code class="literal">SEEN</code> only if they pass the filtering criteria.
This is similar to looking at your email client while scrolling through all the messages in the preview pane, but only flagging messages that were actually opened and read as <code class="literal">SEEN</code>.</p>
<p>Spring Integration 2.0.4 introduced the <code class="literal">mail-filter-expression</code> attribute on <code class="literal">inbound-channel-adapter</code> and <code class="literal">imap-idle-channel-adapter</code>.
This attribute lets you provide an expression that is a combination of SpEL and a regular expression.
For example if you would like to read only emails that contain <span class="emphasis"><em>Spring Integration</em></span> in the subject line, you would configure the <code class="literal">mail-filter-expression</code> attribute like as follows: <code class="literal">mail-filter-expression="subject matches '(?i).*Spring Integration.*"</code>.</p>
<p>Since <code class="literal">javax.mail.internet.MimeMessage</code> is the root context of the SpEL evaluation context, you can filter on any value available through <code class="literal">MimeMessage</code>, including the actual body of the message.
This one is particularly important, since reading the body of the message typically results in such messages being marked as <code class="literal">SEEN</code> by default.
However, since we now set the <code class="literal">PEEK</code> flag of every incoming message to <span class="emphasis"><em>true</em></span>, only messages that were explicitly marked as <code class="literal">SEEN</code> are marked as read.</p>
<p>So, in the following example, only messages that match the filter expression are output by this adapter and only those messages are marked as read:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-mail:imap-idle-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"customAdapter"</span>
	<span class="hl-attribute">store-uri</span>=<span class="hl-value">"imaps://some_google_address:${password}@imap.gmail.com/INBOX"</span>
	<span class="hl-attribute">channel</span>=<span class="hl-value">"receiveChannel"</span>
	<span class="hl-attribute">should-mark-messages-as-read</span>=<span class="hl-value">"true"</span>
	<span class="hl-attribute">java-mail-properties</span>=<span class="hl-value">"javaMailProperties"</span>
	<span class="hl-attribute">mail-filter-expression</span>=<span class="hl-value">"subject matches '(?i).*Spring Integration.*'"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>In the preceding example, thanks to the <code class="literal">mail-filter-expression</code> attribute, only messages that contain <span class="emphasis"><em>Spring Integration</em></span> in the subject line are produced by this adapter.</p>
<p>Another reasonable question is what happens on the next poll or idle event or what happens when such an adapter is restarted.
Can there be duplication of massages to be filtered? In other words, if, on the last retrieval where you had five new messages and only one passed the filter, what would happen with the other four?
Would they go through the filtering logic again on the next poll or idle? After all, they were not marked as <code class="literal">SEEN</code>.
The answer is no.
They would not be subject to duplicate processing due to another flag (<code class="literal">RECENT</code>) that is set by the email server and is used by the Spring Integration mail search filter.
Folder implementations set this flag to indicate that this message is new to this folder.
That is, it has arrived since the last time this folder was opened.
In other words, while our adapter may peek at the email, it also lets the email server know that such email was touched and should therefore be marked as <code class="literal">RECENT</code> by the email server.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="mail-tx-sync" href="#mail-tx-sync"></a>24.7&nbsp;Transaction Synchronization</h2></div></div></div>

<p>Transaction synchronization for inbound adapters lets you take different actions after a transaction commits or rolls back.
You can enable transaction synchronization by adding a <code class="literal">&lt;transactional/&gt;</code> element to the poller for the polled <code class="literal">&lt;inbound-adapter/&gt;</code> or to the <code class="literal">&lt;imap-idle-inbound-adapter/&gt;</code>.
Even if there is no <span class="emphasis"><em>real</em></span> transaction involved, you can still enable this feature by using a <code class="literal">PseudoTransactionManager</code> with the <code class="literal">&lt;transactional/&gt;</code> element.
For more information, see <a class="xref" href="#transaction-synchronization" title="C.3&nbsp;Transaction Synchronization">Section&nbsp;C.3, &#8220;Transaction Synchronization&#8221;</a>.</p>
<p>Because of the many different mail servers and specifically the limitations that some have, at this time we provide only a strategy for these transaction synchronizations.
You can send the messages to some other Spring Integration components or invoke a custom bean to perform some action.
For example, to move an IMAP message to a different folder after the transaction commits, you might use something similar to the following:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-mail:imap-idle-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"customAdapter"</span>
    <span class="hl-attribute">store-uri</span>=<span class="hl-value">"imaps://something.com:password@imap.something.com/INBOX"</span>
    <span class="hl-attribute">channel</span>=<span class="hl-value">"receiveChannel"</span>
    <span class="hl-attribute">auto-startup</span>=<span class="hl-value">"true"</span>
    <span class="hl-attribute">should-delete-messages</span>=<span class="hl-value">"false"</span>
    <span class="hl-attribute">java-mail-properties</span>=<span class="hl-value">"javaMailProperties"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:transactional</span> <span class="hl-attribute">synchronization-factory</span>=<span class="hl-value">"syncFactory"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-mail:imap-idle-channel-adapter&gt;</span>

<span class="hl-tag">&lt;int:transaction-synchronization-factory</span> <span class="hl-attribute">id</span>=<span class="hl-value">"syncFactory"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:after-commit</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"@syncProcessor.process(payload)"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:transaction-synchronization-factory&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"syncProcessor"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"thing1.thing2.Mover"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>The following example shows what the <code class="literal">Mover</code> class might look like:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> Mover {

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> process(MimeMessage message) <span class="hl-keyword">throws</span> Exception{
        Folder folder = message.getFolder();
        folder.open(Folder.READ_WRITE);
        String messageId = message.getMessageID();
        Message[] messages = folder.getMessages();
        FetchProfile contentsProfile = <span class="hl-keyword">new</span> FetchProfile();
        contentsProfile.add(FetchProfile.Item.ENVELOPE);
        contentsProfile.add(FetchProfile.Item.CONTENT_INFO);
        contentsProfile.add(FetchProfile.Item.FLAGS);
        folder.fetch(messages, contentsProfile);
        <span class="hl-comment">// find this message and mark for deletion</span>
        <span class="hl-keyword">for</span> (<span class="hl-keyword">int</span> i = <span class="hl-number">0</span>; i &lt; messages.length; i++) {
            <span class="hl-keyword">if</span> (((MimeMessage) messages[i]).getMessageID().equals(messageId)) {
                messages[i].setFlag(Flags.Flag.DELETED, true);
                <span class="hl-keyword">break</span>;
            }
        }

        Folder somethingFolder = store.getFolder(<span class="hl-string">"SOMETHING"</span>));
        somethingFolder.appendMessages(<span class="hl-keyword">new</span> MimeMessage[]{message});
        folder.expunge();
        folder.close(true);
        somethingFolder.close(false);
    }
}</pre>
</div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>For the message to be still available for manipulation after the transaction, <span class="emphasis"><em>should-delete-messages</em></span> must be set to <span class="emphasis"><em>false</em></span>.</p>
</td></tr></table></div>
</div>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="mongodb" href="#mongodb"></a>25.&nbsp;MongoDb Support</h2></div></div></div>

<p>Version 2.1 introduced support for <a class="ulink" href="http://www.mongodb.org/" target="_top">MongoDB</a>: a "<code class="literal">high-performance, open source, document-oriented database</code>".</p>
<p>You need to include this dependency into your project:</p>
<div class="informalexample">
<p>
<b>Maven.&nbsp;</b>

</p><pre class="programlisting"><span class="hl-tag">&lt;dependency&gt;</span>
    <span class="hl-tag">&lt;groupId&gt;</span>org.springframework.integration<span class="hl-tag">&lt;/groupId&gt;</span>
    <span class="hl-tag">&lt;artifactId&gt;</span>spring-integration-mongodb<span class="hl-tag">&lt;/artifactId&gt;</span>
    <span class="hl-tag">&lt;version&gt;</span>5.1.2.RELEASE<span class="hl-tag">&lt;/version&gt;</span>
<span class="hl-tag">&lt;/dependency&gt;</span></pre><p>

</p>
<p>
<b>Gradle.&nbsp;</b>

</p><pre class="programlisting">compile <span class="hl-string">"org.springframework.integration:spring-integration-mongodb:5.1.2.RELEASE"</span></pre><p>

</p>
</div>
<p>To download, install, and run MongoDB, see the <a class="ulink" href="http://www.mongodb.org/downloads" target="_top">MongoDB documentation</a>.</p>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="mongodb-connection" href="#mongodb-connection"></a>25.1&nbsp;Connecting to MongoDb</h2></div></div></div>

<p>To begin interacting with MongoDB, you first need to connect to it.
Spring Integration builds on the support provided by another Spring project, <a class="ulink" href="http://projects.spring.io/spring-data-mongodb/" target="_top">Spring Data MongoDB</a>.
It provides a factory class called <code class="literal">MongoDbFactory</code>, which simplifies integration with the MongoDB Client API.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_using_literal_mongodbfactory_literal" href="#_using_literal_mongodbfactory_literal"></a>25.1.1&nbsp;Using <code class="literal">MongoDbFactory</code></h3></div></div></div>

<p>To connect to MongoDB you can use an implementation of the <code class="literal">MongoDbFactory</code> interface.
The following listing shows the <code class="literal">MongoDbFactory</code> interface:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> MongoDbFactory {

    <strong class="hl-tag" style="color: blue">/**
     * Creates a default {@link DB} instance.
     *
     * @return the DB instance
     * @throws DataAccessException
     */</strong>
    DB getDb() <span class="hl-keyword">throws</span> DataAccessException;

    <strong class="hl-tag" style="color: blue">/**
     * Creates a {@link DB} instance to access the database with the given name.
     *
     * @param dbName must not be {@literal null} or empty.
     *
     * @return the DB instance
     * @throws DataAccessException
     */</strong>
    DB getDb(String dbName) <span class="hl-keyword">throws</span> DataAccessException;
}</pre>
</div>
<p>The following example shows how to use <code class="literal">SimpleMongoDbFactory</code>, the out-of-the-box implementation, in Java:</p>
<div class="informalexample">
<pre class="programlisting">MongoDbFactory mongoDbFactory = <span class="hl-keyword">new</span> SimpleMongoDbFactory(<span class="hl-keyword">new</span> Mongo(), <span class="hl-string">"test"</span>);</pre>
</div>
<p>The following example shows how to use <code class="literal">SimpleMongoDbFactory</code> in XML configuration:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"mongoDbFactory"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.data.mongodb.core.SimpleMongoDbFactory"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.mongodb.Mongo"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/constructor-arg&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"test"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
</div>
<p><code class="literal">SimpleMongoDbFactory</code> takes two arguments: a <code class="literal">Mongo</code> instance and a <code class="literal">String</code> that specifies the name of the database.
If you need to configure properties such as <code class="literal">host</code>, <code class="literal">port</code>, and others, you can pass those by using one of the constructors provided by the underlying <code class="literal">Mongo</code> class.
For more information on how to configure MongoDB, see the <a class="ulink" href="http://docs.spring.io/spring-data/data-mongo/docs/current/reference/html/" target="_top">Spring-Data-MongoDB</a> reference.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="mongodb-message-store" href="#mongodb-message-store"></a>25.2&nbsp;MongoDB Message Store</h2></div></div></div>

<p>As described in the <span class="emphasis"><em>Enterprise Integration Patterns</em></span> (EIP) book, a <a class="ulink" href="http://www.eaipatterns.com/MessageStore.html" target="_top">Message Store</a> lets you persist messages.
Doing so can be useful when dealing with components that have the ability to buffer messages (<code class="literal">QueueChannel</code>, <code class="literal">aggregator</code>, <code class="literal">resequencer</code>, and others.) if reliability is a concern.
In Spring Integration, the <code class="literal">MessageStore</code> strategy also provides the foundation for the <a class="ulink" href="http://www.eaipatterns.com/StoreInLibrary.html" target="_top">claim check</a> pattern, which is described in EIP as well.</p>
<p>Spring Integration&#8217;s MongoDB module provides the <code class="literal">MongoDbMessageStore</code>, which is an implementation of both the <code class="literal">MessageStore</code> strategy (mainly used by the claim check pattern) and the <code class="literal">MessageGroupStore</code> strategy (mainly used by the aggregator and resequencer patterns).</p>
<p>The following example configures a <code class="literal">MongoDbMessageStore</code> to use a <code class="literal">QueueChannel</code> and an <code class="literal">aggregator</code>:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"mongoDbMessageStore"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.mongodb.store.MongoDbMessageStore"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"mongoDbFactory"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"somePersistentQueueChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:queue</span> <span class="hl-attribute">message-store</span>=<span class="hl-value">"mongoDbMessageStore"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;int:channel&gt;</span>

<span class="hl-tag">&lt;int:aggregator</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"inputChannel"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"outputChannel"</span>
         <span class="hl-attribute">message-store</span>=<span class="hl-value">"mongoDbMessageStore"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>The preceding example is a simple bean configuration, and it expects a <code class="literal">MongoDbFactory</code> as a constructor argument.</p>
<p>The <code class="literal">MongoDbMessageStore</code> expands the <code class="literal">Message</code> as a Mongo document with all nested properties by using the Spring Data Mongo mapping mechanism.
It is useful when you need to have access to the <code class="literal">payload</code> or <code class="literal">headers</code> for auditing or analytics&#8201;&#8212;&#8201;for example, against stored messages.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>The <code class="literal">MongoDbMessageStore</code> uses a custom <code class="literal">MappingMongoConverter</code> implementation to store <code class="literal">Message</code> instances as MongoDB documents, and there are some limitations for the properties (<code class="literal">payload</code> and <code class="literal">header</code> values) of the <code class="literal">Message</code>.
For example, there is no ability to configure custom converters for complex domain <code class="literal">payload</code> instances or <code class="literal">header</code> values.
There is also no way to provide a custom <code class="literal">MongoTemplate</code> (or <code class="literal">MappingMongoConverter</code>).
To achieve these capabilities, an alternative MongoDB <code class="literal">MessageStore</code> implementation has been introduced (we describe it next).</p>
</td></tr></table></div>
<p>Spring Integration 3.0 introduced the <code class="literal">ConfigurableMongoDbMessageStore</code>. It implements both the <code class="literal">MessageStore</code> and <code class="literal">MessageGroupStore</code> interfaces.
This class can receive, as a constructor argument, a <code class="literal">MongoTemplate</code>, with which you can, for example, configure a custom <code class="literal">WriteConcern</code>.
Another constructor requires a <code class="literal">MappingMongoConverter</code> and a <code class="literal">MongoDbFactory</code>, which lets you provide some custom conversions for <code class="literal">Message</code> instances and their properties.
Note that, by default, the <code class="literal">ConfigurableMongoDbMessageStore</code> uses standard Java serialization to write and read <code class="literal">Message</code> instances to and from MongoDB (see <code class="literal">MongoDbMessageBytesConverter</code>) and relies on default values for other properties from <code class="literal">MongoTemplate</code>.
It builds a <code class="literal">MongoTemplate</code> from the provided <code class="literal">MongoDbFactory</code> and <code class="literal">MappingMongoConverter</code>.
The default name for the collection stored by the <code class="literal">ConfigurableMongoDbMessageStore</code> is <code class="literal">configurableStoreMessages</code>.
We recommend using this implementation to create robust and flexible solutions when messages contain complex data types.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="mongodb-priority-channel-message-store" href="#mongodb-priority-channel-message-store"></a>25.2.1&nbsp;MongoDB Channel Message Store</h3></div></div></div>

<p>Version 4.0 introduced the new <code class="literal">MongoDbChannelMessageStore</code>.
It is an optimized <code class="literal">MessageGroupStore</code> for use in <code class="literal">QueueChannel</code> instances.
With <code class="literal">priorityEnabled = true</code>, you can use it in <code class="literal">&lt;int:priority-queue&gt;</code> instances to achieve priority-order polling for persisted messages.
The priority MongoDB document field is populated from the <code class="literal">IntegrationMessageHeaderAccessor.PRIORITY</code> (<code class="literal">priority</code>) message header.</p>
<p>In addition, all MongoDB <code class="literal">MessageStore</code> instances now have a <code class="literal">sequence</code> field for <code class="literal">MessageGroup</code> documents.
The <code class="literal">sequence</code> value is the result of an <code class="literal">$inc</code> operation for a simple <code class="literal">sequence</code> document from the same collection, which is created on demand.
The <code class="literal">sequence</code> field is used in <code class="literal">poll</code> operations to provide first-in-first-out (FIFO) message order (within priority, if configured) when messages are stored within the same millisecond.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>We do not recommend using the same <code class="literal">MongoDbChannelMessageStore</code> bean for priority and non-priority, because the <code class="literal">priorityEnabled</code> option applies to the entire store.
However, the same <code class="literal">collection</code> can be used for both <code class="literal">MongoDbChannelMessageStore</code> types, because message polling from the store is sorted and uses indexes.
To configure that scenario, you can extend one message store bean from the other, as the following example shows:</p>
</td></tr></table></div>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"channelStore"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.mongodb.store.MongoDbChannelMessageStore"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">name</span>=<span class="hl-value">"mongoDbFactory"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"mongoDbFactory"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"queueChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:queue</span> <span class="hl-attribute">message-store</span>=<span class="hl-value">"store"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:channel&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"priorityStore"</span> <span class="hl-attribute">parent</span>=<span class="hl-value">"channelStore"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"priorityEnabled"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"priorityChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:priority-queue</span> <span class="hl-attribute">message-store</span>=<span class="hl-value">"priorityStore"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:channel&gt;</span></pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="mongodb-metadata-store" href="#mongodb-metadata-store"></a>25.2.2&nbsp;MongoDB Metadata Store</h3></div></div></div>

<p>Spring Integration 4.2 introduced a new MongoDB-based <code class="literal">MetadataStore</code> (see <a class="xref" href="#metadata-store" title="12.5&nbsp;Metadata Store">Section&nbsp;12.5, &#8220;Metadata Store&#8221;</a>) implementation.
You can use the <code class="literal">MongoDbMetadataStore</code> to maintain metadata state across application restarts.
You can use this new <code class="literal">MetadataStore</code> implementation with adapters such as:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="#feed-inbound-channel-adapter" title="16.1&nbsp;Feed Inbound Channel Adapter">Feed</a>
</li><li class="listitem">
<a class="link" href="#file-reading" title="17.1&nbsp;Reading Files">File</a>
</li><li class="listitem">
<a class="link" href="#ftp-inbound" title="18.4&nbsp;FTP Inbound Channel Adapter">FTP</a>
</li><li class="listitem">
<a class="link" href="#sftp-inbound" title="30.6&nbsp;SFTP Inbound Channel Adapter">SFTP</a>
</li></ul></div>
<p>To instruct these adapters to use the new <code class="literal">MongoDbMetadataStore</code>, declare a Spring bean with a bean name of <code class="literal">metadataStore</code>.
The feed inbound channel adapter automatically picks up and use the declared <code class="literal">MongoDbMetadataStore</code>.
The following example shows how to declare a bean with a name of <code class="literal">metadataStore</code>:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> MetadataStore metadataStore(MongoDbFactory factory) {
    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> MongoDbMetadataStore(factory, <span class="hl-string">"integrationMetadataStore"</span>);
}</pre>
</div>
<p>The <code class="literal">MongoDbMetadataStore</code> also implements <code class="literal">ConcurrentMetadataStore</code>, letting it be reliably shared across multiple application instances, where only one instance is allowed to store or modify a key&#8217;s value.
All these operations are atomic, thanks to MongoDB guarantees.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="mongodb-inbound-channel-adapter" href="#mongodb-inbound-channel-adapter"></a>25.3&nbsp;MongoDB Inbound Channel Adapter</h2></div></div></div>

<p>The MongoDB inbound channel adapter is a polling consumer that reads data from MongoDB and sends it as a <code class="literal">Message</code> payload.
The following example shows how to configure a MongoDB inbound channel adapter:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-mongodb:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"mongoInboundAdapter"</span>
       <span class="hl-attribute">channel</span>=<span class="hl-value">"replyChannel"</span>
       <span class="hl-attribute">query</span>=<span class="hl-value">"{'name' : 'Bob'}"</span>
       <span class="hl-attribute">entity-class</span>=<span class="hl-value">"java.lang.Object"</span>
       <span class="hl-attribute">auto-startup</span>=<span class="hl-value">"false"</span><span class="hl-tag">&gt;</span>
		<span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"100"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-mongodb:inbound-channel-adapter&gt;</span></pre>
</div>
<p>As the preceding configuration shows, you configure a MongoDb inbound channel adapter by using the <code class="literal">inbound-channel-adapter</code> element and providing values for various attributes, such as:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">query</code>: A JSON query (see <a class="ulink" href="http://www.mongodb.org/display/DOCS/Querying" target="_top">MongoDB Querying</a>)
</li><li class="listitem">
<code class="literal">query-expression</code>: A SpEL expression that is evaluated to a JSON query string (as the <code class="literal">query</code> attribute above) or to an instance of <code class="literal">o.s.data.mongodb.core.query.Query</code>.
Mutually exclusive with the <code class="literal">query</code> attribute.
</li><li class="listitem">
<code class="literal">entity-class</code>: The type of the payload object. If not supplied, a <code class="literal">com.mongodb.DBObject</code> is returned.
</li><li class="listitem">
<code class="literal">collection-name</code> or <code class="literal">collection-name-expression</code>: Identifies the name of the MongoDB collection to use.
</li><li class="listitem">
<code class="literal">mongodb-factory</code>: Reference to an instance of <code class="literal">o.s.data.mongodb.MongoDbFactory</code>
</li><li class="listitem">
<code class="literal">mongo-template</code>: Reference to an instance of <code class="literal">o.s.data.mongodb.core.MongoTemplate</code>
</li><li class="listitem">
Other attributes that are common across all other inbound adapters (such as <span class="emphasis"><em>channel</em></span>).
</li></ul></div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>You cannot set both <code class="literal">mongo-template</code> and <code class="literal">mongodb-factory</code>.</p>
</td></tr></table></div>
<p>The preceding example is relatively simple and static, since it has a literal value for the <code class="literal">query</code> and uses the default name for a <code class="literal">collection</code>.
Sometimes, you may need to change those values at runtime, based on some condition.
To do so, use their <code class="literal">-expression</code> equivalents (<code class="literal">query-expression</code> and <code class="literal">collection-name-expression</code>), where the provided expression can be any valid SpEL expression.</p>
<p>Also, you may wish to do some post-processing to the successfully processed data that was read from the MongoDB.
For example; you may want to move or remove a document after it has been processed.
You can do so by using that transaction synchronization feature Spring Integration 2.2 added, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-mongodb:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"mongoInboundAdapter"</span>
    <span class="hl-attribute">channel</span>=<span class="hl-value">"replyChannel"</span>
    <span class="hl-attribute">query-expression</span>=<span class="hl-value">"new BasicQuery('{''name'' : ''Bob''}').limit(100)"</span>
    <span class="hl-attribute">entity-class</span>=<span class="hl-value">"java.lang.Object"</span>
    <span class="hl-attribute">auto-startup</span>=<span class="hl-value">"false"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"200"</span> <span class="hl-attribute">max-messages-per-poll</span>=<span class="hl-value">"1"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;int:transactional</span> <span class="hl-attribute">synchronization-factory</span>=<span class="hl-value">"syncFactory"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/int:poller&gt;</span>
<span class="hl-tag">&lt;/int-mongodb:inbound-channel-adapter&gt;</span>

<span class="hl-tag">&lt;int:transaction-synchronization-factory</span> <span class="hl-attribute">id</span>=<span class="hl-value">"syncFactory"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:after-commit</span>
        <span class="hl-attribute">expression</span>=<span class="hl-value">"@documentCleaner.remove(#mongoTemplate, payload, headers.mongo_collectionName)"</span>
        <span class="hl-attribute">channe</span>=<span class="hl-value">"someChannel"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:transaction-synchronization-factory&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"documentCleaner"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"thing1.thing2.DocumentCleaner"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"transactionManager"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.transaction.PseudoTransactionManager"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>The following example shows the <code class="literal">DocumentCleaner</code> referenced in the preceding example:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> DocumentCleaner {
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> remove(MongoOperations mongoOperations, Object target, String collectionName) {
        <span class="hl-keyword">if</span> (target <span class="hl-keyword">instanceof</span> List&lt;?&gt;){
            List&lt;?&gt; documents = (List&lt;?&gt;) target;
            <span class="hl-keyword">for</span> (Object document : documents) {
                mongoOperations.remove(<span class="hl-keyword">new</span> BasicQuery(JSON.serialize(document)), collectionName);
            }
        }
    }
}</pre>
</div>
<p>You can declare your poller to be transactional by using the <code class="literal">transactional</code> element.
This element can reference a real transaction manager (for example, if some other part of your flow invokes JDBC).
If you do not have a "<code class="literal">real</code>" transaction, you can use an instance of <code class="literal">o.s.i.transaction.PseudoTransactionManager</code>, which is an implementation of Spring&#8217;s <code class="literal">PlatformTransactionManager</code> and enables the use of the transaction synchronization features of the Mongo adapter when there is no actual transaction.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Doing so does not make MongoDB itself transactional. It lets the synchronization of actions be taken before or after success (commit) or after failure (rollback).</p>
</td></tr></table></div>
<p>Once your poller is transactional, you can set an instance of the <code class="literal">o.s.i.transaction.TransactionSynchronizationFactory</code> on the <code class="literal">transactional</code> element.
<code class="literal">TransactionSynchronizationFactory</code> creates an instance of the <code class="literal">TransactionSynchronization</code>.
For your convenience, we have exposed a default SpEL-based <code class="literal">TransactionSynchronizationFactory</code> that lets you configure SpEL expressions, with their execution being coordinated (synchronized) with a transaction.
Expressions for before-commit, after-commit, and after-rollback events are supported, together with a channel for each event where the evaluation result (if any) is sent.
For each child element, you can specify <code class="literal">expression</code> and <code class="literal">channel</code> attributes.
If only the <code class="literal">channel</code> attribute is present, the received message is sent there as part of the particular synchronization scenario.
If only the <code class="literal">expression</code> attribute is present and the result of an expression is a non-null value, a message with the result as the payload is generated and sent to a default channel (<code class="literal">NullChannel</code>) and appears in the logs (on the <code class="literal">DEBUG</code> level).
If you want the evaluation result to go to a specific channel, add a <code class="literal">channel</code> attribute.
If the result of an expression is null or void, no message is generated.</p>
<p>For more information about transaction synchronization, see <a class="xref" href="#transaction-synchronization" title="C.3&nbsp;Transaction Synchronization">Section&nbsp;C.3, &#8220;Transaction Synchronization&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="mongodb-outbound-channel-adapter" href="#mongodb-outbound-channel-adapter"></a>25.4&nbsp;MongoDB Outbound Channel Adapter</h2></div></div></div>

<p>The MongoDB outbound channel adapter lets you write the message payload to a MongoDB document store, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-mongodb:outbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"fullConfigWithCollectionExpression"</span>
	<span class="hl-attribute">collection-name</span>=<span class="hl-value">"myCollection"</span>
	<span class="hl-attribute">mongo-converter</span>=<span class="hl-value">"mongoConverter"</span>
	<span class="hl-attribute">mongodb-factory</span>=<span class="hl-value">"mongoDbFactory"</span><span class="hl-tag"> /&gt;</span></pre>
</div>
<p>As the preceding configuration shows, you can configure a MongoDB outbound channel adapter by using the <code class="literal">outbound-channel-adapter</code> element, providing values for various attributes, such as:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">collection-name</code> or <code class="literal">collection-name-expression</code>: Identifies the name of the MongoDb collection to use.
</li><li class="listitem">
<code class="literal">mongo-converter</code>: Reference to an instance of <code class="literal">o.s.data.mongodb.core.convert.MongoConverter</code> that assists with converting a raw Java object to a JSON document representation.
</li><li class="listitem">
<code class="literal">mongodb-factory</code>: Reference to an instance of <code class="literal">o.s.data.mongodb.MongoDbFactory</code>.
</li><li class="listitem">
<code class="literal">mongo-template</code>: Reference to an instance of <code class="literal">o.s.data.mongodb.core.MongoTemplate</code>.
NOTE: you can not have both mongo-template and mongodb-factory set.
</li><li class="listitem">
Other attributes that are common across all other inbound adapters (such as <span class="emphasis"><em>channel</em></span>).
</li></ul></div>
<p>The preceding example is relatively simple and static, since it has a literal value for the <code class="literal">collection-name</code>.
Sometimes, you may need to change this value at runtime, based on some condition.
To do that,  use <code class="literal">collection-name-expression</code>, where the provided expression is any valid SpEL expression.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="mongodb-outbound-gateway" href="#mongodb-outbound-gateway"></a>25.5&nbsp;MongoDB Outbound Gateway</h2></div></div></div>

<p>Version 5.0 introduced the MongoDB outbound gateway.
It allows you query a database by sending a message to its request channel.
The gateway then send the response to the reply channel.
You can use the message payload and headers to specify the query and the collection name, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-mongodb:outbound-gateway</span> <span class="hl-attribute">id</span>=<span class="hl-value">"gatewayQuery"</span>
    <span class="hl-attribute">mongodb-factory</span>=<span class="hl-value">"mongoDbFactory"</span>
    <span class="hl-attribute">mongo-converter</span>=<span class="hl-value">"mongoConverter"</span>
    <span class="hl-attribute">query</span>=<span class="hl-value">"{firstName: 'Bob'}"</span>
    <span class="hl-attribute">collection-name</span>=<span class="hl-value">"myCollection"</span>
    <span class="hl-attribute">request-channel</span>=<span class="hl-value">"in"</span>
    <span class="hl-attribute">reply-channel</span>=<span class="hl-value">"out"</span>
    <span class="hl-attribute">entity-class</span>=<span class="hl-value">"org.springframework.integration.mongodb.test.entity$Person"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>You can use the following attributes with a MongoDB outbound Gateway:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">collection-name</code> or <code class="literal">collection-name-expression</code>: Identifies the name of the MongoDB collection to use.
</li><li class="listitem">
<code class="literal">mongo-converter</code>: Reference to an instance of <code class="literal">o.s.data.mongodb.core.convert.MongoConverter</code> that assists with converting a raw Java object to a JSON document representation.
</li><li class="listitem">
<code class="literal">mongodb-factory</code>: Reference to an instance of <code class="literal">o.s.data.mongodb.MongoDbFactory</code>.
</li><li class="listitem">
<code class="literal">mongo-template</code>: Reference to an instance of <code class="literal">o.s.data.mongodb.core.MongoTemplate</code>.
NOTE: you can not set both <code class="literal">mongo-template</code> and <code class="literal">mongodb-factory</code>.
</li><li class="listitem">
<code class="literal">entity-class</code>: The fully qualified name of the entity class to be passed to the <code class="literal">find(..)</code> and <code class="literal">findOne(..)</code> methods in MongoTemplate.
If this attribute is not provided, the default value is <code class="literal">org.bson.Document</code>.
</li><li class="listitem">
<code class="literal">query</code> or <code class="literal">query-expression</code>: Specifies the MongoDB query.
See the <a class="ulink" href="http://www.mongodb.org/display/DOCS/Querying" target="_top">MongoDB documentation</a> for more query samples.
</li><li class="listitem">
<code class="literal">collection-callback</code>: Reference to an instance of <code class="literal">org.springframework.data.mongodb.core.CollectionCallback</code>.
Preferable an instance of <code class="literal">org.springframework.integration.mongodb.outbound.MessageCollectionCallback</code> since 5.0.11 with the request message context.
See its Javadocs for more information.
NOTE: You can not have both <code class="literal">collection-callback</code> and any of the query attributes.
</li></ul></div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_with_java_configuration_17" href="#_configuring_with_java_configuration_17"></a>25.5.1&nbsp;Configuring with Java Configuration</h3></div></div></div>

<p>The following Spring Boot application shows an example of how to configure the outbound gateway with Java configuration:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@SpringBootApplication</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MongoDbJavaApplication {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
        <span class="hl-keyword">new</span> SpringApplicationBuilder(MongoDbJavaApplication.<span class="hl-keyword">class</span>)
            .web(false)
            .run(args);
    }

    <em><span class="hl-annotation" style="color: gray">@Autowired</span></em>
    <span class="hl-keyword">private</span> MongoDbFactory mongoDbFactory;

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "requestChannel")</span></em>
    <span class="hl-keyword">public</span> MessageHandler mongoDbOutboundGateway() {
        MongoDbOutboundGateway gateway = <span class="hl-keyword">new</span> MongoDbOutboundGateway(<span class="hl-keyword">this</span>.mongoDbFactory);
        gateway.setCollectionNameExpressionString(<span class="hl-string">"'myCollection'"</span>);
        gateway.setQueryExpressionString(<span class="hl-string">"'{''name'' : ''Bob''}'"</span>);
        gateway.setExpectSingleResult(true);
        gateway.setEntityClass(Person.<span class="hl-keyword">class</span>);
        gateway.setOutputChannelName(<span class="hl-string">"replyChannel"</span>);
        <span class="hl-keyword">return</span> gateway;
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "replyChannel")</span></em>
    <span class="hl-keyword">public</span> MessageHandler handler() {
        <span class="hl-keyword">return</span> message -&gt; System.out.println(message.getPayload());
    }
}</pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_with_the_java_dsl_18" href="#_configuring_with_the_java_dsl_18"></a>25.5.2&nbsp;Configuring with the Java DSL</h3></div></div></div>

<p>The following Spring Boot application show an example of how to configure the outbound gateway with the Java DSL:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@SpringBootApplication</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MongoDbJavaApplication {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
        <span class="hl-keyword">new</span> SpringApplicationBuilder(MongoDbJavaApplication.<span class="hl-keyword">class</span>)
            .web(false)
            .run(args);
    }

    <em><span class="hl-annotation" style="color: gray">@Autowired</span></em>
    <span class="hl-keyword">private</span> MongoDbFactory;

    <em><span class="hl-annotation" style="color: gray">@Autowired</span></em>
    <span class="hl-keyword">private</span> MongoConverter;


    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> IntegrationFlow gatewaySingleQueryFlow() {
        <span class="hl-keyword">return</span> f -&gt; f
                .handle(queryOutboundGateway())
                .channel(c -&gt; c.queue(<span class="hl-string">"retrieveResults"</span>));
    }

    <span class="hl-keyword">private</span> MongoDbOutboundGatewaySpec queryOutboundGateway() {
        <span class="hl-keyword">return</span> MongoDb.outboundGateway(<span class="hl-keyword">this</span>.mongoDbFactory, <span class="hl-keyword">this</span>.mongoConverter)
                .query(<span class="hl-string">"{name : 'Bob'}"</span>)
                .collectionNameFunction(m -&gt; m.getHeaders().get(<span class="hl-string">"collection"</span>))
                .expectSingleResult(true)
                .entityClass(Person.<span class="hl-keyword">class</span>);
    }

}</pre>
</div>
<p>As an alternate to the <code class="literal">query</code> and <code class="literal">query-expression</code> properties, you can specify other database operations by using the <code class="literal">collectionCallback</code> property as a reference to the <code class="literal">MessageCollectionCallback</code> functional interface implementation.
The following example specifies a count operation:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">private</span> MongoDbOutboundGatewaySpec collectionCallbackOutboundGateway() {
    <span class="hl-keyword">return</span> MongoDb.outboundGateway(<span class="hl-keyword">this</span>.mongoDbFactory, <span class="hl-keyword">this</span>.mongoConverter)
            .collectionCallback((collection, requestMessage) -&gt; collection.count())
            .collectionName(<span class="hl-string">"myCollection"</span>);
    }</pre>
</div>
</div>
</div>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="mqtt" href="#mqtt"></a>26.&nbsp;MQTT Support</h2></div></div></div>

<p>Spring Integration provides inbound and outbound channel adapters to support the Message Queueing Telemetry Transport (MQTT) protocol.</p>
<p>You need to include this dependency into your project:</p>
<div class="informalexample">
<p>
<b>Maven.&nbsp;</b>

</p><pre class="programlisting"><span class="hl-tag">&lt;dependency&gt;</span>
    <span class="hl-tag">&lt;groupId&gt;</span>org.springframework.integration<span class="hl-tag">&lt;/groupId&gt;</span>
    <span class="hl-tag">&lt;artifactId&gt;</span>spring-integration-mqtt<span class="hl-tag">&lt;/artifactId&gt;</span>
    <span class="hl-tag">&lt;version&gt;</span>5.1.2.RELEASE<span class="hl-tag">&lt;/version&gt;</span>
<span class="hl-tag">&lt;/dependency&gt;</span></pre><p>

</p>
<p>
<b>Gradle.&nbsp;</b>

</p><pre class="programlisting">compile <span class="hl-string">"org.springframework.integration:spring-integration-mqtt:5.1.2.RELEASE"</span></pre><p>

</p>
</div>
<p>The current implementation uses the <a class="ulink" href="http://www.eclipse.org/paho/" target="_top">Eclipse Paho MQTT Client</a> library.</p>
<p>Configuration of both adapters is achieved using the <code class="literal">DefaultMqttPahoClientFactory</code>.
Refer to the Paho documentation for more information about configuration options.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>We recommend configuring an <code class="literal">MqttConnectOptions</code> object and injecting it into the factory, instead of setting the (deprecated) options on the factory itself.</p>
</td></tr></table></div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="mqtt-inbound" href="#mqtt-inbound"></a>26.1&nbsp;Inbound (Message-driven) Channel Adapter</h2></div></div></div>

<p>The inbound channel adapter is implemented by the <code class="literal">MqttPahoMessageDrivenChannelAdapter</code>.
For convenience, you can configure it by using the namespace.
A minimal configuration might be as follows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"clientFactory"</span>
        <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.mqtt.core.DefaultMqttPahoClientFactory"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"connectionOptions"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.eclipse.paho.client.mqttv3.MqttConnectOptions"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"userName"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"${mqtt.username}"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"password"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"${mqtt.password}"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/bean&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;int-mqtt:message-driven-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"mqttInbound"</span>
    <span class="hl-attribute">client-id</span>=<span class="hl-value">"${mqtt.default.client.id}.src"</span>
    <span class="hl-attribute">url</span>=<span class="hl-value">"${mqtt.url}"</span>
    <span class="hl-attribute">topics</span>=<span class="hl-value">"sometopic"</span>
    <span class="hl-attribute">client-factory</span>=<span class="hl-value">"clientFactory"</span>
    <span class="hl-attribute">channel</span>=<span class="hl-value">"output"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>The following listing shows the available attributes:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-mqtt:message-driven-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"oneTopicAdapter"</span>
    <span class="hl-attribute">client-id</span>=<span class="hl-value">"foo"</span>  <a name="CO41-1" href="#CO41-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
    url="tcp://localhost:1883"  <a name="CO41-2" href="#CO41-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
    topics="bar,baz"  <a name="CO41-3" href="#CO41-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
    qos="1,2"  <a name="CO41-4" href="#CO41-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
    converter="myConverter"  <a name="CO41-5" href="#CO41-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
    client-factory="clientFactory"  <a name="CO41-6" href="#CO41-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>
    send-timeout="123"  <a name="CO41-7" href="#CO41-7"></a><span><img src="images/callouts/7.png" alt="7" border="0"></span>
    error-channel="errors"  <a name="CO41-8" href="#CO41-8"></a><span><img src="images/callouts/8.png" alt="8" border="0"></span>
    recovery-interval="10000"  <a name="CO41-9" href="#CO41-9"></a><span><img src="images/callouts/9.png" alt="9" border="0"></span>
    channel="out" /&gt;</pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO41-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The client ID.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO41-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The broker URL.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO41-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A comma-separated list of topics from which this adapter receives messages.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO41-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A comma-separated list of QoS values.
It can be a single value that is applied to all topics or a value for each topic (in which case, the lists must be the same length).</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO41-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>An <code class="literal">MqttMessageConverter</code> (optional).
By default, the default <code class="literal">DefaultPahoMessageConverter</code> produces a message with a <code class="literal">String</code> payload with the following headers:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">mqtt_topic</code>: The topic from which the message was received
</li><li class="listitem">
<code class="literal">mqtt_duplicate</code>: <code class="literal">true</code> if the message is a duplicate
</li><li class="listitem">
<code class="literal">mqtt_qos</code>: The quality of service
You can configure the <code class="literal">DefaultPahoMessageConverter</code> to return the raw <code class="literal">byte[]</code> in the payload by declaring it as a <code class="literal">&lt;bean/&gt;</code> and setting the <code class="literal">payloadAsBytes</code> property to <code class="literal">true</code>.
</li></ul></div>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO41-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The client factory.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO41-7"><span><img src="images/callouts/7.png" alt="7" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The send timeout.
It applies only if the channel might block (such as a bounded <code class="literal">QueueChannel</code> that is currently full).</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO41-8"><span><img src="images/callouts/8.png" alt="8" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The error channel.
Downstream exceptions are sent to this channel, if supplied, in an <code class="literal">ErrorMessage</code>.
The payload is a <code class="literal">MessagingException</code> that contains the failed message and cause.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO41-9"><span><img src="images/callouts/9.png" alt="9" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The recovery interval.
It controls the interval at which the adapter attempts to reconnect after a failure. It defaults to <code class="literal">10000ms</code> (ten seconds).</p>
</td></tr></table></div>
</div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Starting with version 4.1, you can omit the URL.
Instead, you can provide the server URIs in the <code class="literal">serverURIs</code> property of the <code class="literal">DefaultMqttPahoClientFactory</code>.
Doing so enables, for example, connection to a highly available (HA) cluster.</p>
</td></tr></table></div>
<p>Starting with version 4.2.2, an <code class="literal">MqttSubscribedEvent</code> is published when the adapter successfully subscribes to the topics.
<code class="literal">MqttConnectionFailedEvent</code> events are published when the connection or subscription fails.
These events can be received by a bean that implements <code class="literal">ApplicationListener</code>.</p>
<p>Also, a new property called <code class="literal">recoveryInterval</code> controls the interval at which the adapter attempts to reconnect after a failure.
It defaults to <code class="literal">10000ms</code> (ten seconds).</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Prior to version 4.2.3, the client always unsubscribed when the adapter was stopped.
This was incorrect because, if the client QOS is greater than 0, we need to keep the subscription active so that messages arriving
while the adapter is stopped are delivered on the next start.
This also requires setting the <code class="literal">cleanSession</code> property on the client factory to <code class="literal">false</code>.
It defaults to <code class="literal">true</code>.</p>
<p>Starting with version 4.2.3, the adapter does not unsubscribe (by default) if the <code class="literal">cleanSession</code> property is <code class="literal">false</code>.</p>
<p>This behavior can be overridden by setting the <code class="literal">consumerCloseAction</code> property on the factory.
It can have values: <code class="literal">UNSUBSCRIBE_ALWAYS</code>, <code class="literal">UNSUBSCRIBE_NEVER</code>, and <code class="literal">UNSUBSCRIBE_CLEAN</code>.
The latter (the default) unsubscribes only if the <code class="literal">cleanSession</code> property is <code class="literal">true</code>.</p>
<p>To revert to the pre-4.2.3 behavior, use <code class="literal">UNSUBSCRIBE_ALWAYS</code>.</p>
</td></tr></table></div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Starting with version 5.0, the <code class="literal">topic</code>, <code class="literal">qos</code>, and <code class="literal">retained</code> properties are mapped to <code class="literal">.RECEIVED_...</code> headers (<code class="literal">MqttHeaders.RECEIVED_TOPIC</code>, <code class="literal">MqttHeaders.RECEIVED_QOS</code>, and <code class="literal">MqttHeaders.RECEIVED_RETAINED</code>), to avoid inadvertent propagation to an outbound message that (by default) uses the <code class="literal">MqttHeaders.TOPIC</code>, <code class="literal">MqttHeaders.QOS</code>, and <code class="literal">MqttHeaders.RETAINED</code> headers.</p>
</td></tr></table></div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_adding_and_removing_topics_at_runtime" href="#_adding_and_removing_topics_at_runtime"></a>26.1.1&nbsp;Adding and Removing Topics at Runtime</h3></div></div></div>

<p>Starting with version 4.1, you can programmatically change the topics to which the adapter is subscribed.
Spring Integration provides the  <code class="literal">addTopic()</code> and <code class="literal">removeTopic()</code> methods.
When adding topics, you can optionally specify the <code class="literal">QoS</code> (default: 1).
You can also modify the topics by sending an appropriate message to a <code class="literal">&lt;control-bus/&gt;</code> with an appropriate payload&#8201;&#8212;&#8201;for example: <code class="literal">"myMqttAdapter.addTopic('foo', 1)"</code>.</p>
<p>Stopping and starting the adapter has no effect on the topic list (it does not revert to the original settings in the configuration).
The changes are not retained beyond the life cycle of the application context.
A new application context reverts to the configured settings.</p>
<p>Changing the topics while the adapter is stopped (or disconnected from the broker) takes effect the next time a connection is established.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_with_java_configuration_18" href="#_configuring_with_java_configuration_18"></a>26.1.2&nbsp;Configuring with Java Configuration</h3></div></div></div>

<p>The following Spring Boot application shows an example of how to configure the inbound adapter with Java configuration:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@SpringBootApplication</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MqttJavaApplication {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
        <span class="hl-keyword">new</span> SpringApplicationBuilder(MqttJavaApplication.<span class="hl-keyword">class</span>)
                .web(false)
                .run(args);
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> MessageChannel mqttInputChannel() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> DirectChannel();
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> MessageProducer inbound() {
        MqttPahoMessageDrivenChannelAdapter adapter =
                <span class="hl-keyword">new</span> MqttPahoMessageDrivenChannelAdapter(<span class="hl-string">"tcp://localhost:1883"</span>, <span class="hl-string">"testClient"</span>,
                                                 <span class="hl-string">"topic1"</span>, <span class="hl-string">"topic2"</span>);
        adapter.setCompletionTimeout(<span class="hl-number">5000</span>);
        adapter.setConverter(<span class="hl-keyword">new</span> DefaultPahoMessageConverter());
        adapter.setQos(<span class="hl-number">1</span>);
        adapter.setOutputChannel(mqttInputChannel());
        <span class="hl-keyword">return</span> adapter;
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "mqttInputChannel")</span></em>
    <span class="hl-keyword">public</span> MessageHandler handler() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> MessageHandler() {

            <em><span class="hl-annotation" style="color: gray">@Override</span></em>
            <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> handleMessage(Message&lt;?&gt; message) <span class="hl-keyword">throws</span> MessagingException {
                System.out.println(message.getPayload());
            }

        };
    }

}</pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_with_the_java_dsl_19" href="#_configuring_with_the_java_dsl_19"></a>26.1.3&nbsp;Configuring with the Java DSL</h3></div></div></div>

<p>The following Spring Boot application provides an example of configuring the inbound adapter with the Java DSL:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@SpringBootApplication</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MqttJavaApplication {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
        <span class="hl-keyword">new</span> SpringApplicationBuilder(MqttJavaApplication.<span class="hl-keyword">class</span>)
            .web(false)
            .run(args);
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> IntegrationFlow mqttInbound() {
        <span class="hl-keyword">return</span> IntegrationFlows.from(
                         <span class="hl-keyword">new</span> MqttPahoMessageDrivenChannelAdapter(<span class="hl-string">"tcp://localhost:1883"</span>,
                                        <span class="hl-string">"testClient"</span>, <span class="hl-string">"topic1"</span>, <span class="hl-string">"topic2"</span>);)
                .handle(m -&gt; System.out.println(m.getPayload()))
                .get();
    }

}</pre>
</div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="mqtt-outbound" href="#mqtt-outbound"></a>26.2&nbsp;Outbound Channel Adapter</h2></div></div></div>

<p>The outbound channel adapter is implemented by the <code class="literal">MqttPahoMessageHandler</code>, which is wrapped in a <code class="literal">ConsumerEndpoint</code>.
For convenience, you can configure it by using the namespace.</p>
<p>Starting with version 4.1, the adapter supports asynchronous send operations, avoiding blocking until the delivery is confirmed.
You can emit application events to enable applications to confirm delivery if desired.</p>
<p>The following listing shows the attributes available for an outbound channel adapter:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-mqtt:outbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"withConverter"</span>
    <span class="hl-attribute">client-id</span>=<span class="hl-value">"foo"</span>  <a name="CO42-1" href="#CO42-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
    url="tcp://localhost:1883"  <a name="CO42-2" href="#CO42-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
    converter="myConverter"  <a name="CO42-3" href="#CO42-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
    client-factory="clientFactory"  <a name="CO42-4" href="#CO42-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
    default-qos="1"  <a name="CO42-5" href="#CO42-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
    qos-expression="" <a name="CO42-6" href="#CO42-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>
    default-retained="true"  <a name="CO42-7" href="#CO42-7"></a><span><img src="images/callouts/7.png" alt="7" border="0"></span>
    retained-expression="" <a name="CO42-8" href="#CO42-8"></a><span><img src="images/callouts/8.png" alt="8" border="0"></span>
    default-topic="bar"  <a name="CO42-9" href="#CO42-9"></a><span><img src="images/callouts/9.png" alt="9" border="0"></span>
    topic-expression="" <a name="CO42-10" href="#CO42-10"></a><span><img src="images/callouts/10.png" alt="10" border="0"></span>
    async="false"  <a name="CO42-11" href="#CO42-11"></a><span><img src="images/callouts/11.png" alt="11" border="0"></span>
    async-events="false"  <a name="CO42-12" href="#CO42-12"></a><span><img src="images/callouts/12.png" alt="12" border="0"></span>
    channel="target" /&gt;</pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO42-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The client ID.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO42-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The broker URL.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO42-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>An <code class="literal">MqttMessageConverter</code> (optional).
The default <code class="literal">DefaultPahoMessageConverter</code> recognizes the following headers:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">mqtt_topic</code>: The topic to which the message will be sent
</li><li class="listitem">
<code class="literal">mqtt_retained</code>: <code class="literal">true</code> if the message is to be retained
</li><li class="listitem">
<code class="literal">mqtt_qos</code>: The quality of service
</li></ul></div>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO42-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The client factory.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO42-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The default quality of service. It is used if no <code class="literal">mqtt_qos</code> header is found or the <code class="literal">qos-expression</code> returns <code class="literal">null</code>.
It is not used if you supply a custom <code class="literal">converter</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO42-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>An expression to evaluate to determine the qos.
The default is <code class="literal">headers[mqtt_qos]</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO42-7"><span><img src="images/callouts/7.png" alt="7" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The default value of the retained flag. It is used if no <code class="literal">mqtt_retained</code> header is found.
It is not used if a custom <code class="literal">converter</code> is supplied.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO42-8"><span><img src="images/callouts/8.png" alt="8" border="0"></span></a> </p></td><td valign="top" align="left">
<p>An expression to evaluate to determine the retained boolean.
The default is <code class="literal">headers[mqtt_retained]</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO42-9"><span><img src="images/callouts/9.png" alt="9" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The default topic to which the message is sent (used if no <code class="literal">mqtt_topic</code> header is found).</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO42-10"><span><img src="images/callouts/10.png" alt="10" border="0"></span></a> </p></td><td valign="top" align="left">
<p>An expression to evaluate to determine the destination topic.
The default is <code class="literal">headers['topic']</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO42-11"><span><img src="images/callouts/11.png" alt="11" border="0"></span></a> </p></td><td valign="top" align="left">
<p>When <code class="literal">true</code>, the caller does not block. Rather, it waits for delivery confirmation when a message is sent.
The default is <code class="literal">false</code> (the send blocks until delivery is confirmed).</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO42-12"><span><img src="images/callouts/12.png" alt="12" border="0"></span></a> </p></td><td valign="top" align="left">
<p>When <code class="literal">async</code> and <code class="literal">async-events</code> are both <code class="literal">true</code>, an <code class="literal">MqttMessageSentEvent</code> is emitted.
It contains the message, the topic, the <code class="literal">messageId</code> generated by the client library, the <code class="literal">clientId</code>, and the <code class="literal">clientInstance</code> (incremented each time the client is connected).
When the delivery is confirmed by the client library, an <code class="literal">MqttMessageDeliveredEvent</code> is emitted.
It contains the the <code class="literal">messageId</code>, the <code class="literal">clientId</code>, and the <code class="literal">clientInstance</code>, enabling delivery to be correlated with the send.
Any <code class="literal">ApplicationListener</code> or an event inbound channel adapter can received these events.
Note that it is possible for the <code class="literal">MqttMessageDeliveredEvent</code> to be received before the <code class="literal">MqttMessageSentEvent</code>.
The default is <code class="literal">false</code>.</p>
</td></tr></table></div>
</div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Starting with version 4.1, the URL can be omitted. Instead, the server URIs can be provided in the <code class="literal">serverURIs</code> property of the <code class="literal">DefaultMqttPahoClientFactory</code>.
This enables, for example, connection to a highly available (HA) cluster.</p>
</td></tr></table></div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_with_java_configuration_19" href="#_configuring_with_java_configuration_19"></a>26.2.1&nbsp;Configuring with Java Configuration</h3></div></div></div>

<p>The following Spring Boot application show an example of how to configure the outbound adapter with Java configuration:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@SpringBootApplication</span></em>
<em><span class="hl-annotation" style="color: gray">@IntegrationComponentScan</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MqttJavaApplication {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
        ConfigurableApplicationContext context =
                <span class="hl-keyword">new</span> SpringApplicationBuilder(MqttJavaApplication.<span class="hl-keyword">class</span>)
                        .web(false)
                        .run(args);
        MyGateway gateway = context.getBean(MyGateway.<span class="hl-keyword">class</span>);
        gateway.sendToMqtt(<span class="hl-string">"foo"</span>);
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> MqttPahoClientFactory mqttClientFactory() {
        DefaultMqttPahoClientFactory factory = <span class="hl-keyword">new</span> DefaultMqttPahoClientFactory();
        MqttConnectOptions options = <span class="hl-keyword">new</span> MqttConnectOptions();
        options.setServerURIs(<span class="hl-keyword">new</span> String[] { <span class="hl-string">"tcp://host1:1883"</span>, <span class="hl-string">"tcp://host2:1883"</span> });
        options.setUserName(<span class="hl-string">"username"</span>);
        options.setPassword(<span class="hl-string">"password"</span>.toCharArray());
        factory.setConnectionOptions(options);
        <span class="hl-keyword">return</span> factory;
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "mqttOutboundChannel")</span></em>
    <span class="hl-keyword">public</span> MessageHandler mqttOutbound() {
        MqttPahoMessageHandler messageHandler =
                       <span class="hl-keyword">new</span> MqttPahoMessageHandler(<span class="hl-string">"testClient"</span>, mqttClientFactory());
        messageHandler.setAsync(true);
        messageHandler.setDefaultTopic(<span class="hl-string">"testTopic"</span>);
        <span class="hl-keyword">return</span> messageHandler;
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> MessageChannel mqttOutboundChannel() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> DirectChannel();
    }

    <em><span class="hl-annotation" style="color: gray">@MessagingGateway(defaultRequestChannel = "mqttOutboundChannel")</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> MyGateway {

        <span class="hl-keyword">void</span> sendToMqtt(String data);

    }

}</pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_with_the_java_dsl_20" href="#_configuring_with_the_java_dsl_20"></a>26.2.2&nbsp;Configuring with the Java DSL</h3></div></div></div>

<p>The following Spring Boot application provides an example of configuring the outbound adapter with the Java DSL:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@SpringBootApplication</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MqttJavaApplication {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
        <span class="hl-keyword">new</span> SpringApplicationBuilder(MqttJavaApplication.<span class="hl-keyword">class</span>)
            .web(false)
            .run(args);
    }

   	<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
   	<span class="hl-keyword">public</span> IntegrationFlow mqttOutboundFlow() {
   	    <span class="hl-keyword">return</span> f -&gt; f.handle(<span class="hl-keyword">new</span> MqttPahoMessageHandler(<span class="hl-string">"tcp://host1:1883"</span>, <span class="hl-string">"someMqttClient"</span>));
    }

}</pre>
</div>
</div>
</div>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="redis" href="#redis"></a>27.&nbsp;Redis Support</h2></div></div></div>

<p>Spring Integration 2.1 introduced support for <a class="ulink" href="http://redis.io/" target="_top">Redis</a>: "<code class="literal">an open source advanced key-value store</code>".
This support comes in the form of a Redis-based <code class="literal">MessageStore</code> as well as publish-subscribe messaging adapters that are supported by Redis through its <a class="ulink" href="http://redis.io/topics/pubsub" target="_top"><code class="literal">PUBLISH</code>, <code class="literal">SUBSCRIBE</code>, and <code class="literal">UNSUBSCRIBE</code></a> commands.</p>
<p>You need to include this dependency into your project:</p>
<div class="informalexample">
<p>
<b>Maven.&nbsp;</b>

</p><pre class="programlisting"><span class="hl-tag">&lt;dependency&gt;</span>
    <span class="hl-tag">&lt;groupId&gt;</span>org.springframework.integration<span class="hl-tag">&lt;/groupId&gt;</span>
    <span class="hl-tag">&lt;artifactId&gt;</span>spring-integration-redis<span class="hl-tag">&lt;/artifactId&gt;</span>
    <span class="hl-tag">&lt;version&gt;</span>5.1.2.RELEASE<span class="hl-tag">&lt;/version&gt;</span>
<span class="hl-tag">&lt;/dependency&gt;</span></pre><p>

</p>
<p>
<b>Gradle.&nbsp;</b>

</p><pre class="programlisting">compile <span class="hl-string">"org.springframework.integration:spring-integration-redis:5.1.2.RELEASE"</span></pre><p>

</p>
</div>
<p>You also need to include Redis client dependency, e.g. Lettuce.</p>
<p>To download, install, and run Redis, see the <a class="ulink" href="http://redis.io/download" target="_top">Redis documentation</a>.</p>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="redis-connection" href="#redis-connection"></a>27.1&nbsp;Connecting to Redis</h2></div></div></div>

<p>To begin interacting with Redis, you first need to connect to it.
Spring Integration uses support provided by another Spring project, <a class="ulink" href="https://github.com/SpringSource/spring-data-redis" target="_top">Spring Data Redis</a>, which provides typical Spring constructs: <code class="literal">ConnectionFactory</code> and <code class="literal">Template</code>.
Those abstractions simplify integration with several Redis client Java APIs.
Currently Spring Data Redis supports <a class="ulink" href="https://github.com/xetorthio/jedis" target="_top">Jedis</a> and <a class="ulink" href="https://lettuce.io/" target="_top">Lettuce</a>.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_using_literal_redisconnectionfactory_literal" href="#_using_literal_redisconnectionfactory_literal"></a>27.1.1&nbsp;Using <code class="literal">RedisConnectionFactory</code></h3></div></div></div>

<p>To connect to Redis, you can use one of the implementations of the <code class="literal">RedisConnectionFactory</code> interface.
The following listing shows the interface definition:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> RedisConnectionFactory <span class="hl-keyword">extends</span> PersistenceExceptionTranslator {

    <strong class="hl-tag" style="color: blue">/**
     * Provides a suitable connection for interacting with Redis.
     * @return connection for interacting with Redis.
     */</strong>
    RedisConnection getConnection();
}</pre>
</div>
<p>The following example shows how to create a <code class="literal">LettuceConnectionFactory</code> in Java:</p>
<div class="informalexample">
<pre class="programlisting">LettuceConnectionFactory cf = <span class="hl-keyword">new</span> LettuceConnectionFactory();
cf.afterPropertiesSet();</pre>
</div>
<p>The following example shows how to create a <code class="literal">LettuceConnectionFactory</code> in Spring&#8217;s XML configuration:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"redisConnectionFactory"</span>
    <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.data.redis.connection.lettuce.LettuceConnectionFactory"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"port"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"7379"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
</div>
<p>The implementations of <code class="literal">RedisConnectionFactory</code> provide a set of properties, such as port and host, that you can set if needed.
Once you have an instance of <code class="literal">RedisConnectionFactory</code>, you can create an instance of <code class="literal">RedisTemplate</code> and inject it with the <code class="literal">RedisConnectionFactory</code>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_using_literal_redistemplate_literal" href="#_using_literal_redistemplate_literal"></a>27.1.2&nbsp;Using <code class="literal">RedisTemplate</code></h3></div></div></div>

<p>As with other template classes in Spring (such as <code class="literal">JdbcTemplate</code> and <code class="literal">JmsTemplate</code>) <code class="literal">RedisTemplate</code> is a helper class that simplifies Redis data access code.
For more information about <code class="literal">RedisTemplate</code> and its variations (such as <code class="literal">StringRedisTemplate</code>) see the <a class="ulink" href="https://docs.spring.io/spring-data/data-redis/docs/current/reference/html/" target="_top">Spring Data Redis documentation</a>.</p>
<p>The following example shows how to create an instance of <code class="literal">RedisTemplate</code> in Java:</p>
<div class="informalexample">
<pre class="programlisting">RedisTemplate rt = <span class="hl-keyword">new</span> RedisTemplate&lt;String, Object&gt;();
rt.setConnectionFactory(redisConnectionFactory);</pre>
</div>
<p>The following example shows how to create an instance of <code class="literal">RedisTemplate</code> in Spring&#8217;s XML configuration:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"redisTemplate"</span>
         <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.data.redis.core.RedisTemplate"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"connectionFactory"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"redisConnectionFactory"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
</div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="redis-messages" href="#redis-messages"></a>27.2&nbsp;Messaging with Redis</h2></div></div></div>

<p>As mentioned in <a class="link" href="#redis" title="27.&nbsp;Redis Support">the introduction</a>, Redis provides support for publish-subscribe messaging through its <code class="literal">PUBLISH</code>, <code class="literal">SUBSCRIBE</code>, and <code class="literal">UNSUBSCRIBE</code> commands.
As with JMS and AMQP, Spring Integration provides message channels and adapters for sending and receiving messages through Redis.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="redis-pub-sub-channel" href="#redis-pub-sub-channel"></a>27.2.1&nbsp;Redis Publish/Subscribe channel</h3></div></div></div>

<p>Similarly to JMS, there are cases where both the producer and consumer are intended to be part of the same application, running within the same process.
You can accomplished this by using a pair of inbound and outbound channel adapters.
However, as with Spring Integration&#8217;s JMS support, there is a simpler way to address this use case.
You can create a publish-subscribe channel, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-redis:publish-subscribe-channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"redisChannel"</span> <span class="hl-attribute">topic-name</span>=<span class="hl-value">"si.test.topic"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>A <code class="literal">publish-subscribe-channel</code> behaves much like a normal <code class="literal">&lt;publish-subscribe-channel/&gt;</code> element from the main Spring Integration namespace.
It can be referenced by both the <code class="literal">input-channel</code> and the <code class="literal">output-channel</code> attributes of any endpoint.
The difference is that this channel is backed by a Redis topic name: a <code class="literal">String</code> value specified by the <code class="literal">topic-name</code> attribute.
However, unlike JMS, this topic does not have to be created in advance or even auto-created by Redis.
In Redis, topics are simple <code class="literal">String</code> values that play the role of an address.
The producer and consumer can communicate by using the same <code class="literal">String</code> value as their topic name.
A simple subscription to this channel means that asynchronous publish-subscribe messaging is possible between the producing and consuming endpoints.
However, unlike the asynchronous message channels created by adding a <code class="literal">&lt;queue/&gt;</code> element within a simple Spring Integration <code class="literal">&lt;channel/&gt;</code> element, the messages are not stored in an in-memory queue.
Instead, those messages are passed through Redis, which lets you rely on its support for persistence and clustering as well as its interoperability with other non-Java platforms.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="redis-inbound-channel-adapter" href="#redis-inbound-channel-adapter"></a>27.2.2&nbsp;Redis Inbound Channel Adapter</h3></div></div></div>

<p>The Redis inbound channel adapter (<code class="literal">RedisInboundChannelAdapter</code>) adapts incoming Redis messages into Spring messages in the same way as other inbound adapters.
It receives platform-specific messages (Redis in this case) and converts them to Spring messages by using a <code class="literal">MessageConverter</code> strategy.
The following example shows how to configure a Redis inbound channel adapter:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-redis:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"redisAdapter"</span>
       <span class="hl-attribute">topics</span>=<span class="hl-value">"thing1, thing2"</span>
       <span class="hl-attribute">channel</span>=<span class="hl-value">"receiveChannel"</span>
       <span class="hl-attribute">error-channel</span>=<span class="hl-value">"testErrorChannel"</span>
       <span class="hl-attribute">message-converter</span>=<span class="hl-value">"testConverter"</span><span class="hl-tag"> /&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"redisConnectionFactory"</span>
    <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.data.redis.connection.lettuce.LettuceConnectionFactory"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"port"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"7379"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"testConverter"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"things.something.SampleMessageConverter"</span><span class="hl-tag"> /&gt;</span></pre>
</div>
<p>The preceding example shows a simple but complete configuration of a Redis inbound channel adapter.
Note that the preceding configuration relies on the familiar Spring paradigm of auto-discovering certain beans.
In this case, the <code class="literal">redisConnectionFactory</code> is implicitly injected into the adapter.
You can specify it explicitly by using the <code class="literal">connection-factory</code> attribute instead.</p>
<p>Also, note that the preceding configuration injects the adapter with a custom <code class="literal">MessageConverter</code>.
The approach is similar to JMS, where <code class="literal">MessageConverter</code> instances are used to convert between Redis messages and the Spring Integration message payloads.
The default is a <code class="literal">SimpleMessageConverter</code>.</p>
<p>Inbound adapters can subscribe to multiple topic names, hence the comma-separated set of values in the <code class="literal">topics</code> attribute.</p>
<p>Since version 3.0, the inbound adapter, in addition to the existing <code class="literal">topics</code> attribute, now has the <code class="literal">topic-patterns</code> attribute.
This attribute contains a comma-separated set of Redis topic patterns.
For more information regarding Redis publish-subscribe, see <a class="ulink" href="http://redis.io/topics/pubsub" target="_top">Redis Pub/Sub</a>.</p>
<p>Inbound adapters can use a <code class="literal">RedisSerializer</code> to deserialize the body of Redis messages.
The <code class="literal">serializer</code> attribute of the <code class="literal">&lt;int-redis:inbound-channel-adapter&gt;</code> can be set to an empty string, which results in a <code class="literal">null</code> value for the <code class="literal">RedisSerializer</code> property.
In this case, the raw <code class="literal">byte[]</code> bodies of Redis messages are provided as the message payloads.</p>
<p>Since version 5.0, you can provide an <code class="literal">Executor</code> instance to the inbound adapter by using the <code class="literal">task-executor</code> attribute of the <code class="literal">&lt;int-redis:inbound-channel-adapter&gt;</code>.
Also, the received Spring Integration messages now have the <code class="literal">RedisHeaders.MESSAGE_SOURCE</code> header to indicate the source of the published message: topic or pattern.
You can use this downstream for routing logic.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="redis-outbound-channel-adapter" href="#redis-outbound-channel-adapter"></a>27.2.3&nbsp;Redis Outbound Channel Adapter</h3></div></div></div>

<p>The Redis outbound channel adapter adapts outgoing Spring Integration messages into Redis messages in the same way as other outbound adapters.
It receives Spring Integration messages and converts them to platform-specific messages (Redis in this case) by using a <code class="literal">MessageConverter</code> strategy.
The following example shows how to configure a Redis outbound channel adapter:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-redis:outbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"outboundAdapter"</span>
    <span class="hl-attribute">channel</span>=<span class="hl-value">"sendChannel"</span>
    <span class="hl-attribute">topic</span>=<span class="hl-value">"thing1"</span>
    <span class="hl-attribute">message-converter</span>=<span class="hl-value">"testConverter"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"redisConnectionFactory"</span>
    <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.data.redis.connection.lettuce.LettuceConnectionFactory"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"port"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"7379"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"testConverter"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"things.something.SampleMessageConverter"</span><span class="hl-tag"> /&gt;</span></pre>
</div>
<p>The configuration parallels the Redis inbound channel adapter.
The adapter is implicitly injected with a <code class="literal">RedisConnectionFactory</code>, which is defined with <code class="literal">redisConnectionFactory</code> as its bean name.
This example also includes the optional (and custom) <code class="literal">MessageConverter</code> (the <code class="literal">testConverter</code> bean).</p>
<p>Since Spring Integration 3.0, the <code class="literal">&lt;int-redis:outbound-channel-adapter&gt;</code> offers an alternative to the <code class="literal">topic</code> attribute: You can use the <code class="literal">topic-expression</code> attribute to determine the Redis topic for the message at runtime.
These attributes are mutually exclusive.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="redis-queue-inbound-channel-adapter" href="#redis-queue-inbound-channel-adapter"></a>27.2.4&nbsp;Redis Queue Inbound Channel Adapter</h3></div></div></div>

<p>Spring Integration 3.0 introduced a queue inbound channel adapter to "<code class="literal">pop</code>" messages from a Redis list. By default, it uses "<code class="literal">right pop</code>", but you can configure it to use "<code class="literal">left pop</code>" instead.
The adapter is message-driven.
It uses an internal listener thread and does not use a poller.</p>
<p>The following listing shows all the available attributes for <code class="literal">queue-inbound-channel-adapter</code>:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-redis:queue-inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">""</span>  <a name="CO43-1" href="#CO43-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
                    channel=""  <a name="CO43-2" href="#CO43-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
                    auto-startup=""  <a name="CO43-3" href="#CO43-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
                    phase=""  <a name="CO43-4" href="#CO43-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
                    connection-factory=""  <a name="CO43-5" href="#CO43-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
                    queue=""  <a name="CO43-6" href="#CO43-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>
                    error-channel=""  <a name="CO43-7" href="#CO43-7"></a><span><img src="images/callouts/7.png" alt="7" border="0"></span>
                    serializer=""  <a name="CO43-8" href="#CO43-8"></a><span><img src="images/callouts/8.png" alt="8" border="0"></span>
                    receive-timeout=""  <a name="CO43-9" href="#CO43-9"></a><span><img src="images/callouts/9.png" alt="9" border="0"></span>
                    recovery-interval=""  <a name="CO43-10" href="#CO43-10"></a><span><img src="images/callouts/10.png" alt="10" border="0"></span>
                    expect-message=""  <a name="CO43-11" href="#CO43-11"></a><span><img src="images/callouts/11.png" alt="11" border="0"></span>
                    task-executor=""  <a name="CO43-12" href="#CO43-12"></a><span><img src="images/callouts/12.png" alt="12" border="0"></span>
                    right-pop=""/&gt;  <a name="CO43-13" href="#CO43-13"></a><span><img src="images/callouts/13.png" alt="13" border="0"></span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO43-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The component bean name.
If you do not provide the <code class="literal">channel</code> attribute, a <code class="literal">DirectChannel</code> is created and registered in the application context with this <code class="literal">id</code> attribute as the bean name.
In this case, the endpoint itself is registered with the bean name <code class="literal">id</code> plus <code class="literal">.adapter</code>.
(If the bean name were <code class="literal">thing1</code>, the endpoint is registered as <code class="literal">thing1.adapter</code>.)</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO43-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The <code class="literal">MessageChannel</code> to which to send <code class="literal">Message</code> instances from this Endpoint.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO43-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A <code class="literal">SmartLifecycle</code> attribute to specify whether this endpoint should start automatically after the application context start or not.
It defaults to <code class="literal">true</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO43-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A <code class="literal">SmartLifecycle</code> attribute to specify the phase in which this endpoint is started.
It defaults to <code class="literal">0</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO43-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A reference to a <code class="literal">RedisConnectionFactory</code> bean.
It defaults to <code class="literal">redisConnectionFactory</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO43-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The name of the Redis list on which the queue-based <span class="emphasis"><em>pop</em></span> operation is performed to get Redis messages.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO43-7"><span><img src="images/callouts/7.png" alt="7" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The <code class="literal">MessageChannel</code> to which to send <code class="literal">ErrorMessage</code> instances when exceptions are received from the listening task of the endpoint.
By default, the underlying <code class="literal">MessagePublishingErrorHandler</code> uses the default <code class="literal">errorChannel</code> from the application context.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO43-8"><span><img src="images/callouts/8.png" alt="8" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The <code class="literal">RedisSerializer</code> bean reference.
It can be an empty string, which means <span class="emphasis"><em>no serializer</em></span>.
In this case, the raw <code class="literal">byte[]</code> from the inbound Redis message is sent to the <code class="literal">channel</code> as the <code class="literal">Message</code> payload.
By default it is a <code class="literal">JdkSerializationRedisSerializer</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO43-9"><span><img src="images/callouts/9.png" alt="9" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The timeout in milliseconds for <span class="emphasis"><em>pop</em></span> operation to wait for a Redis message from the queue.
The default is 1 second.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO43-10"><span><img src="images/callouts/10.png" alt="10" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The time in milliseconds for which the listener task should sleep after exceptions on the <span class="emphasis"><em>pop</em></span> operation, before restarting the listener task.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO43-11"><span><img src="images/callouts/11.png" alt="11" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Specifies whether this endpoint expects data from the Redis queue to contain entire <code class="literal">Message</code> instances.
If this attribute is set to <code class="literal">true</code>, the <code class="literal">serializer</code> cannot be an empty string, because messages require some form of deserialization (JDK serialization by default).
Its default is <code class="literal">false</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO43-12"><span><img src="images/callouts/12.png" alt="12" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A reference to a Spring <code class="literal">TaskExecutor</code> (or standard JDK 1.5+ <code class="literal">Executor</code>) bean.
It is used for the underlying listening task.
It defaults to a <code class="literal">SimpleAsyncTaskExecutor</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO43-13"><span><img src="images/callouts/13.png" alt="13" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Specifies whether this endpoint should use "<code class="literal">right pop</code>" (when <code class="literal">true</code>) or "<code class="literal">left pop</code>" (when <code class="literal">false</code>) to read messages from the Redis list.
If <code class="literal">true</code>, the Redis List acts as a <code class="literal">FIFO</code> queue when used with a default Redis queue outbound channel adapter. Set it to <code class="literal">false</code> to use with software that writes to the list with "<code class="literal">right push</code>" or to achieve a stack-like message order.
Its default is <code class="literal">true</code>.
Since version 4.3.</p>
</td></tr></table></div>
</div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>The <code class="literal">task-executor</code> has to be configured with more than one thread for processing; otherwise there is a possible deadlock when the <code class="literal">RedisQueueMessageDrivenEndpoint</code> tries to restart the listener task after an error.
The <code class="literal">errorChannel</code> can be used to process those errors, to avoid restarts, but it preferable to not expose your application to the possible deadlock situation.
See Spring Framework <a class="ulink" href="https://docs.spring.io/spring/docs/current/spring-framework-reference/integration.html#scheduling-task-executor-types" target="_top">Reference Manual</a> for possible <code class="literal">TaskExecutor</code> implementations.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="redis-queue-outbound-channel-adapter" href="#redis-queue-outbound-channel-adapter"></a>27.2.5&nbsp;Redis Queue Outbound Channel Adapter</h3></div></div></div>

<p>Spring Integration 3.0 introduced a queue outbound channel adapter to "<code class="literal">push</code>" to a Redis list from Spring Integration messages.
By default, it uses "<code class="literal">left push</code>", but you can configure it to use "<code class="literal">right push</code>" instead.
The following listing shows all the available attributes for a Redis <code class="literal">queue-outbound-channel-adapter</code>:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-redis:queue-outbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">""</span>  <a name="CO44-1" href="#CO44-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
                    channel=""  <a name="CO44-2" href="#CO44-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
                    connection-factory=""  <a name="CO44-3" href="#CO44-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
                    queue=""  <a name="CO44-4" href="#CO44-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
                    queue-expression=""  <a name="CO44-5" href="#CO44-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
                    serializer=""  <a name="CO44-6" href="#CO44-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>
                    extract-payload=""  <a name="CO44-7" href="#CO44-7"></a><span><img src="images/callouts/7.png" alt="7" border="0"></span>
                    left-push=""/&gt;  <a name="CO44-8" href="#CO44-8"></a><span><img src="images/callouts/8.png" alt="8" border="0"></span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO44-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The component bean name.
If you do not provide the <code class="literal">channel</code> attribute, a <code class="literal">DirectChannel</code> is created and registered in the application context with this <code class="literal">id</code> attribute as the bean name.
In this case, the endpoint is registered with a bean name of <code class="literal">id</code> plus <code class="literal">.adapter</code>.
(If the bean name were <code class="literal">thing1</code>, the endpoint is registered as <code class="literal">thing1.adapter</code>.)</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO44-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The <code class="literal">MessageChannel</code> from which this endpoint receives <code class="literal">Message</code> instances.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO44-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A reference to a <code class="literal">RedisConnectionFactory</code> bean.
It defaults to <code class="literal">redisConnectionFactory</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO44-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The name of the Redis list on which the queue-based <span class="emphasis"><em>push</em></span> operation is performed to send Redis messages.
This attribute is mutually exclusive with <code class="literal">queue-expression</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO44-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A SpEL <code class="literal">Expression</code> to determine the name of the Redis list.
It uses the incoming <code class="literal">Message</code> at runtime as the <code class="literal">#root</code> variable.
This attribute is mutually exclusive with <code class="literal">queue</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO44-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A <code class="literal">RedisSerializer</code> bean reference.
It defaults to a <code class="literal">JdkSerializationRedisSerializer</code>.
However, for <code class="literal">String</code> payloads, a <code class="literal">StringRedisSerializer</code> is used, if a <code class="literal">serializer</code> reference is not provided.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO44-7"><span><img src="images/callouts/7.png" alt="7" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Specifies whether this endpoint should send only the payload or the entire <code class="literal">Message</code> to the Redis queue.
It defaults to <code class="literal">true</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO44-8"><span><img src="images/callouts/8.png" alt="8" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Specifies whether this endpoint should use "<code class="literal">left push</code>" (when <code class="literal">true</code>) or "<code class="literal">right push</code>" (when <code class="literal">false</code>) to write messages to the Redis list.
If <code class="literal">true</code>, the Redis list acts as a <code class="literal">FIFO</code> queue when used with a default Redis queue inbound channel adapter.
Set it to <code class="literal">false</code> to use with software that reads from the list with "<code class="literal">left pop</code>" or to achieve a stack-like message order.
It defaults to <code class="literal">true</code>.
Since version 4.3.</p>
</td></tr></table></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="redis-application-events" href="#redis-application-events"></a>27.2.6&nbsp;Redis Application Events</h3></div></div></div>

<p>Since Spring Integration 3.0, the Redis module provides an implementation of <code class="literal">IntegrationEvent</code>, which, in turn, is a <code class="literal">org.springframework.context.ApplicationEvent</code>.
The <code class="literal">RedisExceptionEvent</code> encapsulates exceptions from Redis operations (with the endpoint being the "<code class="literal">source</code>" of the event).
For example, the <code class="literal">&lt;int-redis:queue-inbound-channel-adapter/&gt;</code> emits those events after catching exceptions from the <code class="literal">BoundListOperations.rightPop</code> operation.
The exception may be any generic <code class="literal">org.springframework.data.redis.RedisSystemException</code> or a <code class="literal">org.springframework.data.redis.RedisConnectionFailureException</code>.
Handling these events with an <code class="literal">&lt;int-event:inbound-channel-adapter/&gt;</code> can be useful to determine problems with background Redis tasks and to take administrative actions.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="redis-message-store" href="#redis-message-store"></a>27.3&nbsp;Redis Message Store</h2></div></div></div>

<p>As described in the <span class="emphasis"><em>Enterprise Integration Patterns</em></span> (EIP) book, a <a class="ulink" href="http://www.eaipatterns.com/MessageStore.html" target="_top">message store</a> lets you persist messages.
This can be useful when dealing with components that have a capability to buffer messages (aggregator, resequencer, and others) when reliability is a concern.
In Spring Integration, the <code class="literal">MessageStore</code> strategy also provides the foundation for the <a class="ulink" href="http://www.eaipatterns.com/StoreInLibrary.html" target="_top">claim check</a> pattern, which is described in EIP as well.</p>
<p>Spring Integration&#8217;s Redis module provides the <code class="literal">RedisMessageStore</code>.
The following example shows how to use it with a aggregator:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"redisMessageStore"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.redis.store.RedisMessageStore"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"redisConnectionFactory"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;int:aggregator</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"inputChannel"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"outputChannel"</span>
         <span class="hl-attribute">message-store</span>=<span class="hl-value">"redisMessageStore"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>The preceding example is a bean configuration, and it expects a <code class="literal">RedisConnectionFactory</code> as a constructor argument.</p>
<p>By default, the <code class="literal">RedisMessageStore</code> uses Java serialization to serialize the message.
However, if you want to use a different serialization technique (such as JSON), you can provide your own serializer by setting the <code class="literal">valueSerializer</code> property of the <code class="literal">RedisMessageStore</code>.</p>
<p>Starting with version 4.3.10, the Framework provides Jackson serializer and deserializer implementations for <code class="literal">Message</code> instances and <code class="literal">MessageHeaders</code> instances&#8201;&#8212;&#8201;<code class="literal">MessageJacksonDeserializer</code> and <code class="literal">MessageHeadersJacksonSerializer</code>, respectively.
They have to be configured with the <code class="literal">SimpleModule</code> options for the <code class="literal">ObjectMapper</code>.
In addition, you should set <code class="literal">enableDefaultTyping</code> on the <code class="literal">ObjectMapper</code> to add type information for each serialized complex object.
That type information is then used during deserialization.
The framework provides a utility method called <code class="literal">JacksonJsonUtils.messagingAwareMapper()</code>, which is already supplied with all the previously mentioned properties and serializers.
To manage JSON serialization in the <code class="literal">RedisMessageStore</code>, you must configure it in a fashion similar to the following example:</p>
<div class="informalexample">
<pre class="programlisting">RedisMessageStore store = <span class="hl-keyword">new</span> RedisMessageStore(redisConnectionFactory);
ObjectMapper mapper = JacksonJsonUtils.messagingAwareMapper();
RedisSerializer&lt;Object&gt; serializer = <span class="hl-keyword">new</span> GenericJackson2JsonRedisSerializer(mapper);
store.setValueSerializer(serializer);</pre>
</div>
<p>Starting with version 4.3.12, <code class="literal">RedisMessageStore</code> supports the <code class="literal">prefix</code> option to allow distinguishing between instances of the store on the same Redis server.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="redis-cms" href="#redis-cms"></a>27.3.1&nbsp;Redis Channel Message Stores</h3></div></div></div>

<p>The <code class="literal">RedisMessageStore</code> <a class="link" href="#redis-message-store" title="27.3&nbsp;Redis Message Store">shown earlier</a> maintains each group as a value under a single key (the group ID).
While you can use this to back a <code class="literal">QueueChannel</code> for persistence, a specialized <code class="literal">RedisChannelMessageStore</code> is provided for that purpose (since version 4.0).
This store uses a <code class="literal">LIST</code> for each channel, <code class="literal">LPUSH</code> when sending messages, and <code class="literal">RPOP</code> when receiving messages.
By default, this store also uses JDK serialization, but you can modify the value serializer, as <a class="link" href="#redis-message-store" title="27.3&nbsp;Redis Message Store">described earlier</a>.</p>
<p>We recommend using this store backing channels, instead of using the general <code class="literal">RedisMessageStore</code>.
The following example defines a Redis message store and uses it in a channel with a queue:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"redisMessageStore"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.redis.store.RedisChannelMessageStore"</span><span class="hl-tag">&gt;</span>
	<span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"redisConnectionFactory"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"somePersistentQueueChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:queue</span> <span class="hl-attribute">message-store</span>=<span class="hl-value">"redisMessageStore"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;int:channel&gt;</span></pre>
</div>
<p>The keys used to store the data have the form: <code class="literal">&lt;storeBeanName&gt;:&lt;channelId&gt;</code> (in the preceding example, <code class="literal">redisMessageStore:somePersistentQueueChannel</code>).</p>
<p>In addition, a subclass <code class="literal">RedisChannelPriorityMessageStore</code> is also provided.
When you use this with a <code class="literal">QueueChannel</code>, the messages are received in (FIFO) priority order.
It uses the standard <code class="literal">IntegrationMessageHeaderAccessor.PRIORITY</code> header and supports priority values (<code class="literal">0 - 9</code>).
Messages with other priorities (and messages with no priority) are retrieved in FIFO order after any messages with priority.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>These stores implement only <code class="literal">BasicMessageGroupStore</code> and do not implement <code class="literal">MessageGroupStore</code>.
They can be used only for situations such as backing a <code class="literal">QueueChannel</code>.</p>
</td></tr></table></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="redis-metadata-store" href="#redis-metadata-store"></a>27.4&nbsp;Redis Metadata Store</h2></div></div></div>

<p>Spring Integration 3.0 introduced a new Redis-based <a class="ulink" href="http://docs.spring.io/spring-integration/docs/latest-ga/api/org/springframework/integration/metadata/MetadataStore.html" target="_top"><code class="literal">MetadataStore</code></a> (see <a class="xref" href="#metadata-store" title="12.5&nbsp;Metadata Store">Section&nbsp;12.5, &#8220;Metadata Store&#8221;</a>) implementation.
You can use the <code class="literal">RedisMetadataStore</code> to maintain the state of a <code class="literal">MetadataStore</code> across application restarts.
You can use this new <code class="literal">MetadataStore</code> implementation with adapters such as:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="#feed-inbound-channel-adapter" title="16.1&nbsp;Feed Inbound Channel Adapter">Feed</a>
</li><li class="listitem">
<a class="link" href="#file-reading" title="17.1&nbsp;Reading Files">File</a>
</li><li class="listitem">
<a class="link" href="#ftp-inbound" title="18.4&nbsp;FTP Inbound Channel Adapter">FTP</a>
</li><li class="listitem">
<a class="link" href="#sftp-inbound" title="30.6&nbsp;SFTP Inbound Channel Adapter">SFTP</a>
</li></ul></div>
<p>To instruct these adapters to use the new <code class="literal">RedisMetadataStore</code>, declare a Spring bean named <code class="literal">metadataStore</code>.
The Feed inbound channel adapter and the feed inbound channel adapter both automatically pick up and use the declared <code class="literal">RedisMetadataStore</code>.
The following example shows how to declare such a bean:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">name</span>=<span class="hl-value">"metadataStore"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.redis.store.metadata.RedisMetadataStore"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">name</span>=<span class="hl-value">"connectionFactory"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"redisConnectionFactory"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
</div>
<p>The <code class="literal">RedisMetadataStore</code> is backed by <a class="ulink" href="http://docs.spring.io/spring-data/data-redis/docs/current/api/org/springframework/data/redis/support/collections/RedisProperties.html" target="_top"><code class="literal">RedisProperties</code></a>.
Interaction with it uses <a class="ulink" href="http://docs.spring.io/spring-data/data-redis/docs/current/api/org/springframework/data/redis/core/BoundHashOperations.html" target="_top"><code class="literal">BoundHashOperations</code></a>, which, in turn, requires a <code class="literal">key</code> for the entire <code class="literal">Properties</code> store.
In the case of the <code class="literal">MetadataStore</code>, this <code class="literal">key</code> plays the role of a region, which is useful in a distributed environment, when several applications use the same Redis server.
By default, this <code class="literal">key</code> has a value of <code class="literal">MetaData</code>.</p>
<p>Starting with version 4.0, this store implements <code class="literal">ConcurrentMetadataStore</code>, letting it be reliably shared across multiple application instances where only one instance is allowed to store or modify a key&#8217;s value.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>You cannot use the <code class="literal">RedisMetadataStore.replace()</code> (for example, in the <code class="literal">AbstractPersistentAcceptOnceFileListFilter</code>) with a Redis cluster, since the <code class="literal">WATCH</code> command for atomicity is not currently supported.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="redis-store-inbound-channel-adapter" href="#redis-store-inbound-channel-adapter"></a>27.5&nbsp;Redis Store Inbound Channel Adapter</h2></div></div></div>

<p>The Redis store inbound channel adapter is a polling consumer that reads data from a Redis collection and sends it as a <code class="literal">Message</code> payload.
The following example shows how to configure a Redis store inbound channel adapter:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-redis:store-inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"listAdapter"</span>
    <span class="hl-attribute">connection-factory</span>=<span class="hl-value">"redisConnectionFactory"</span>
    <span class="hl-attribute">key</span>=<span class="hl-value">"myCollection"</span>
    <span class="hl-attribute">channel</span>=<span class="hl-value">"redisChannel"</span>
    <span class="hl-attribute">collection-type</span>=<span class="hl-value">"LIST"</span><span class="hl-tag"> &gt;</span>
    <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"2000"</span> <span class="hl-attribute">max-messages-per-poll</span>=<span class="hl-value">"10"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-redis:store-inbound-channel-adapter&gt;</span></pre>
</div>
<p>The preceding example shows how to configure a Redis store inbound channel adapter by using the <code class="literal">store-inbound-channel-adapter</code> element, providing values for various attributes, such as:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">key</code> or <code class="literal">key-expression</code>: The name of the key for the collection being used.
</li><li class="listitem">
<code class="literal">collection-type</code>: An enumeration of the collection types supported by this adapter.
The supported Collections are <code class="literal">LIST</code>, <code class="literal">SET</code>, <code class="literal">ZSET</code>, <code class="literal">PROPERTIES</code>, and <code class="literal">MAP</code>.
</li><li class="listitem">
<code class="literal">connection-factory</code>: Reference to an instance of <code class="literal">o.s.data.redis.connection.RedisConnectionFactory</code>.
</li><li class="listitem">
<code class="literal">redis-template</code>: Reference to an instance of <code class="literal">o.s.data.redis.core.RedisTemplate</code>.
</li><li class="listitem">
Other attributes that are common across all other inbound adapters (such as <span class="emphasis"><em>channel</em></span>).
</li></ul></div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>You cannot set both <code class="literal">redis-template</code> and <code class="literal">connection-factory</code>.</p>
</td></tr></table></div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>By default, the adapter uses a <code class="literal">StringRedisTemplate</code>.
This uses <code class="literal">StringRedisSerializer</code> instances for keys, values, hash keys, and hash values.
If your Redis store contains objects that are serialized with other techniques, you must supply a <code class="literal">RedisTemplate</code> configured with appropriate serializers.
For example, if the store is written to using a Redis store outbound adapter that has its <code class="literal">extract-payload-elements</code> set to <code class="literal">false</code>, you must provide a <code class="literal">RedisTemplate</code> configured as follows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"redisTemplate"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.data.redis.core.RedisTemplate"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"connectionFactory"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"redisConnectionFactory"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"keySerializer"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.data.redis.serializer.StringRedisSerializer"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"hashKeySerializer"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.data.redis.serializer.StringRedisSerializer"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
</div>
<p>Th <code class="literal">RedisTemplate</code> uses <code class="literal">String</code> serializers for keys and hash keys and the default JDK Serialization serializers for values and hash values.</p>
</td></tr></table></div>
<p>Because it has a literal value for the <code class="literal">key</code>, the preceding example is relatively simple and static.
Sometimes, you may need to change the value of the key at runtime based on some condition.
To do so, use <code class="literal">key-expression</code> instead, where the provided expression can be any valid SpEL expression.</p>
<p>Also, you may wish to perform some post-processing on the successfully processed data that was read from the Redis collection.
For example, you may want to move or remove the value after its been processed.
You can do so by using the transaction synchronization feature that was added with Spring Integration 2.2.
The following example uses <code class="literal">key-expression</code> and transaction synchronization:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-redis:store-inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"zsetAdapterWithSingleScoreAndSynchronization"</span>
        <span class="hl-attribute">connection-factory</span>=<span class="hl-value">"redisConnectionFactory"</span>
        <span class="hl-attribute">key-expression</span>=<span class="hl-value">"'presidents'"</span>
        <span class="hl-attribute">channel</span>=<span class="hl-value">"otherRedisChannel"</span>
        <span class="hl-attribute">auto-startup</span>=<span class="hl-value">"false"</span>
        <span class="hl-attribute">collection-type</span>=<span class="hl-value">"ZSET"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"1000"</span> <span class="hl-attribute">max-messages-per-poll</span>=<span class="hl-value">"2"</span><span class="hl-tag">&gt;</span>
                <span class="hl-tag">&lt;int:transactional</span> <span class="hl-attribute">synchronization-factory</span>=<span class="hl-value">"syncFactory"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;/int:poller&gt;</span>
<span class="hl-tag">&lt;/int-redis:store-inbound-channel-adapter&gt;</span>

<span class="hl-tag">&lt;int:transaction-synchronization-factory</span> <span class="hl-attribute">id</span>=<span class="hl-value">"syncFactory"</span><span class="hl-tag">&gt;</span>
	<span class="hl-tag">&lt;int:after-commit</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"payload.removeByScore(18, 18)"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:transaction-synchronization-factory&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"transactionManager"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.transaction.PseudoTransactionManager"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>You can declare your poller to be transactional by using a <code class="literal">transactional</code> element.
This element can reference a real transaction manager (for example, if some other part of your flow invokes JDBC).
If you do not have a "<code class="literal">real</code>" transaction, you can use an <code class="literal">o.s.i.transaction.PseudoTransactionManager</code>, which is an implementation of Spring&#8217;s <code class="literal">PlatformTransactionManager</code> and enables the use of the transaction synchronization features of the Redis adapter when there is no actual transaction.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>This does not make the Redis activities themselves transactional. It lets the synchronization of actions be taken before or after success (commit) or after failure (rollback).</p>
</td></tr></table></div>
<p>Once your poller is transactional, you can set an instance of the <code class="literal">o.s.i.transaction.TransactionSynchronizationFactory</code> on the <code class="literal">transactional</code> element.
<code class="literal">TransactionSynchronizationFactory</code> creates an instance of the <code class="literal">TransactionSynchronization</code>.
For your convenience, we have exposed a default SpEL-based <code class="literal">TransactionSynchronizationFactory</code>, which lets you configure SpEL expressions, with their execution being coordinated (synchronized) with a transaction.
Expressions for before-commit, after-commit, and after-rollback are supported, together with channels (one for each kind of event) where the evaluation result (if any) is sent.
For each child element, you can specify <code class="literal">expression</code> and <code class="literal">channel</code> attributes.
If only the <code class="literal">channel</code> attribute is present, the received message is sent there as part of the particular synchronization scenario.
If only the <code class="literal">expression</code> attribute is present and the result of an expression is a non-null value, a message with the result as the payload is generated and sent to a default channel (<code class="literal">NullChannel</code>) and appears in the logs (at the <code class="literal">DEBUG</code> level).
If you want the evaluation result to go to a specific channel, add a <code class="literal">channel</code> attribute.
If the result of an expression is null or void, no message is generated.</p>
<p>For more information about transaction synchronization, see <a class="xref" href="#transaction-synchronization" title="C.3&nbsp;Transaction Synchronization">Section&nbsp;C.3, &#8220;Transaction Synchronization&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="redis-store-outbound-channel-adapter" href="#redis-store-outbound-channel-adapter"></a>27.6&nbsp;RedisStore Outbound Channel Adapter</h2></div></div></div>

<p>The RedisStore outbound channel adapter lets you write a message payload to a Redis collection, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-redis:store-outbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"redisListAdapter"</span>
          <span class="hl-attribute">collection-type</span>=<span class="hl-value">"LIST"</span>
          <span class="hl-attribute">channel</span>=<span class="hl-value">"requestChannel"</span>
          <span class="hl-attribute">key</span>=<span class="hl-value">"myCollection"</span><span class="hl-tag"> /&gt;</span></pre>
</div>
<p>The preceding configuration a Redis store outbound channel adapter by using the <code class="literal">store-inbound-channel-adapter</code> element.
It provides values for various attributes, such as:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">key</code> or <code class="literal">key-expression</code>: The name of the key for the collection being used.
</li><li class="listitem">
<code class="literal">extract-payload-elements</code>: If set to <code class="literal">true</code> (the default) and the payload is an instance of a "<code class="literal">multi-value</code>" object (that is, a <code class="literal">Collection</code> or a <code class="literal">Map</code>), it is stored by using "<code class="literal">addAll</code>" and "<code class="literal">putAll</code>" semantics.
Otherwise, if set to <code class="literal">false</code>, the payload is stored as a single entry regardless of its type.
If the payload is not an instance of a "<code class="literal">multi-value</code>" object, the value of this attribute is ignored and the payload is always stored as a single entry.
</li><li class="listitem">
<code class="literal">collection-type</code>: An enumeration of the <code class="literal">Collection</code> types supported by this adapter.
The supported Collections are <code class="literal">LIST</code>, <code class="literal">SET</code>, <code class="literal">ZSET</code>, <code class="literal">PROPERTIES</code>, and <code class="literal">MAP</code>.
</li><li class="listitem">
<code class="literal">map-key-expression</code>: SpEL expression that returns the name of the key for the entry being stored.
It applies only if the <code class="literal">collection-type</code> is <code class="literal">MAP</code> or <code class="literal">PROPERTIES</code> and <span class="emphasis"><em>extract-payload-elements</em></span> is false.
</li><li class="listitem">
<code class="literal">connection-factory</code>: Reference to an instance of <code class="literal">o.s.data.redis.connection.RedisConnectionFactory</code>.
</li><li class="listitem">
<code class="literal">redis-template</code>: Reference to an instance of <code class="literal">o.s.data.redis.core.RedisTemplate</code>.
</li><li class="listitem">
Other attributes that are common across all other inbound adapters (such as <span class="emphasis"><em>channel</em></span>).
</li></ul></div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>You cannot set both <code class="literal">redis-template</code> and <code class="literal">connection-factory</code>.</p>
</td></tr></table></div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>By default, the adapter uses a <code class="literal">StringRedisTemplate</code>.
This uses <code class="literal">StringRedisSerializer</code> instances for keys, values, hash keys, and hash values.
However, if <code class="literal">extract-payload-elements</code> is set to <code class="literal">false</code>, a <code class="literal">RedisTemplate</code> that has <code class="literal">StringRedisSerializer</code> instances for keys and hash keys and <code class="literal">JdkSerializationRedisSerializer</code> instances s for values and hash values will be used.
With the JDK serializer, it is important to understand that Java serialization is used for all values, regardless of whether the value is actually a collection or not.
If you need more control over the serialization of values, consider providing your own <code class="literal">RedisTemplate</code> rather than relying upon these defaults.</p>
</td></tr></table></div>
<p>Because it has literal values for the <code class="literal">key</code> and other attributes, the preceding example is relatively simple and static.
Sometimes, you may need to change the values dynamically at runtime based on some condition.
To do so, use their <code class="literal">-expression</code> equivalents (<code class="literal">key-expression</code>, <code class="literal">map-key-expression</code>, and so on), where the provided expression can be any valid SpEL expression.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="redis-outbound-gateway" href="#redis-outbound-gateway"></a>27.7&nbsp;Redis Outbound Command Gateway</h2></div></div></div>

<p>Spring Integration 4.0 introduced the Redis command gateway to let you perform any standard Redis command by using the generic <code class="literal">RedisConnection#execute</code> method.
The following listing shows the available attributes for the Redis outbound gateway:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-redis:outbound-gateway</span>
        <span class="hl-attribute">request-channel</span>=<span class="hl-value">""</span>  <a name="CO45-1" href="#CO45-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
        reply-channel=""  <a name="CO45-2" href="#CO45-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
        requires-reply=""  <a name="CO45-3" href="#CO45-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
        reply-timeout=""  <a name="CO45-4" href="#CO45-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
        connection-factory=""  <a name="CO45-5" href="#CO45-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
        redis-template=""  <a name="CO45-6" href="#CO45-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>
        arguments-serializer=""  <a name="CO45-7" href="#CO45-7"></a><span><img src="images/callouts/7.png" alt="7" border="0"></span>
        command-expression=""  <a name="CO45-8" href="#CO45-8"></a><span><img src="images/callouts/8.png" alt="8" border="0"></span>
        argument-expressions=""  <a name="CO45-9" href="#CO45-9"></a><span><img src="images/callouts/9.png" alt="9" border="0"></span>
        use-command-variable=""  <a name="CO45-10" href="#CO45-10"></a><span><img src="images/callouts/10.png" alt="10" border="0"></span>
        arguments-strategy="" /&gt; <a name="CO45-11" href="#CO45-11"></a><span><img src="images/callouts/11.png" alt="11" border="0"></span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO45-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The <code class="literal">MessageChannel</code> from which this endpoint receives <code class="literal">Message</code> instances.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO45-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The <code class="literal">MessageChannel</code> where this endpoint sends reply <code class="literal">Message</code> instances.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO45-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Specifies whether this outbound gateway must return a non-null value.
It defaults to <code class="literal">true</code>.
A <code class="literal">ReplyRequiredException</code> is thrown when Redis returns a <code class="literal">null</code> value.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO45-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The timeout (in milliseconds) to wait until the reply message is sent.
It is typically applied for queue-based limited reply-channels.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO45-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A reference to a <code class="literal">RedisConnectionFactory</code> bean.
It defaults to <code class="literal">redisConnectionFactory</code>.
It is mutually exclusive with <span class="emphasis"><em>redis-template</em></span> attribute.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO45-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A reference to a <code class="literal">RedisTemplate</code> bean.
It is mutually exclusive with <span class="emphasis"><em>connection-factory</em></span> attribute.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO45-7"><span><img src="images/callouts/7.png" alt="7" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A reference to an instance of <code class="literal">org.springframework.data.redis.serializer.RedisSerializer</code>.
It is used to serialize each command argument to byte[], if necessary.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO45-8"><span><img src="images/callouts/8.png" alt="8" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The SpEL expression that returns the command key.
It defaults to the <code class="literal">redis_command</code> message header.
It must not evaluate to <code class="literal">null</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO45-9"><span><img src="images/callouts/9.png" alt="9" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Comma-separated SpEL expressions that are evaluated as command arguments.
Mutually exclusive with the <code class="literal">arguments-strategy</code> attribute.
If you provide neither attribute, the <code class="literal">payload</code> is used as the command arguments.
The argument expressions can evaluate to <span class="emphasis"><em>null</em></span> to support a variable number of arguments.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO45-10"><span><img src="images/callouts/10.png" alt="10" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A <code class="literal">boolean</code> flag to specify whether the evaluated Redis command string is made available as the <code class="literal">#cmd</code> variable in the expression evaluation context in the <code class="literal">o.s.i.redis.outbound.ExpressionArgumentsStrategy</code> when <code class="literal">argument-expressions</code> is configured.
Otherwise this attribute is ignored.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO45-11"><span><img src="images/callouts/11.png" alt="11" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Reference to an instance of <code class="literal">o.s.i.redis.outbound.ArgumentsStrategy</code>.
It is mutually exclusive with <code class="literal">argument-expressions</code> attribute.
If you provide neither attribute, the <code class="literal">payload</code> is used as the command arguments.</p>
</td></tr></table></div>
</div>
<p>You can use the <code class="literal">&lt;int-redis:outbound-gateway&gt;</code> as a common component to perform any desired Redis operation.
For example, the following examlpe shows how to get incremented values from Redis atomic number:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-redis:outbound-gateway</span> <span class="hl-attribute">request-channel</span>=<span class="hl-value">"requestChannel"</span>
    <span class="hl-attribute">reply-channel</span>=<span class="hl-value">"replyChannel"</span>
    <span class="hl-attribute">command-expression</span>=<span class="hl-value">"'INCR'"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>The <code class="literal">Message</code> payload should have a name of <code class="literal">redisCounter</code>, which may be provided by <code class="literal">org.springframework.data.redis.support.atomic.RedisAtomicInteger</code> bean definition.</p>
<p>The <code class="literal">RedisConnection#execute</code> method has a generic <code class="literal">Object</code> as its return type.
Real result depends on command type.
For example, <code class="literal">MGET</code> returns a <code class="literal">List&lt;byte[]&gt;</code>.
For more information about commands, their arguments and result type, see <a class="ulink" href="http://redis.io/commands" target="_top">Redis Specification</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="redis-queue-outbound-gateway" href="#redis-queue-outbound-gateway"></a>27.8&nbsp;Redis Queue Outbound Gateway</h2></div></div></div>

<p>Spring Integration introduced the Redis queue outbound gateway to perform request and reply scenarios.
It pushes a conversation <code class="literal">UUID</code> to the provided <code class="literal">queue</code>, pushes the value with that <code class="literal">UUID</code> as its key to a Redis list, and waits for the reply from a Redis list with a key of <code class="literal">UUID' plus '.reply</code>.
A different UUID is used for each interaction.
The following listing shows the available attributes for a Redis outbound gateway:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-redis:queue-outbound-gateway</span>
        <span class="hl-attribute">request-channel</span>=<span class="hl-value">""</span>  <a name="CO46-1" href="#CO46-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
        reply-channel=""  <a name="CO46-2" href="#CO46-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
        requires-reply=""  <a name="CO46-3" href="#CO46-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
        reply-timeout=""  <a name="CO46-4" href="#CO46-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
        connection-factory=""  <a name="CO46-5" href="#CO46-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
        queue=""  <a name="CO46-6" href="#CO46-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>
        order=""  <a name="CO46-7" href="#CO46-7"></a><span><img src="images/callouts/7.png" alt="7" border="0"></span>
        serializer=""  <a name="CO46-8" href="#CO46-8"></a><span><img src="images/callouts/8.png" alt="8" border="0"></span>
        extract-payload=""/&gt;  <a name="CO46-9" href="#CO46-9"></a><span><img src="images/callouts/9.png" alt="9" border="0"></span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO46-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The <code class="literal">MessageChannel</code> from which this endpoint receives <code class="literal">Message</code> instances.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO46-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The <code class="literal">MessageChannel</code> where this endpoint sends reply <code class="literal">Message</code> instances.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO46-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Specifies whether this outbound gateway must return a non-null value.
This value is <code class="literal">false</code> by default.
Otherwise, a <code class="literal">ReplyRequiredException</code> is thrown when Redis returns a <code class="literal">null</code> value.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO46-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The timeout (in milliseconds) to wait until the reply message is sent.
It is typically applied for queue-based limited reply-channels.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO46-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A reference to a <code class="literal">RedisConnectionFactory</code> bean.
It defaults to <code class="literal">redisConnectionFactory</code>.
It is mutually exclusive with the <span class="emphasis"><em>redis-template</em></span> attribute.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO46-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The name of the Redis list to which the outbound gateway sends a conversation <code class="literal">UUID</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO46-7"><span><img src="images/callouts/7.png" alt="7" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The order of this outbound gateway when multiple gateways are registered.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO46-8"><span><img src="images/callouts/8.png" alt="8" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The <code class="literal">RedisSerializer</code> bean reference.
It can be an empty string, which means "<code class="literal">no serializer</code>".
In this case, the raw <code class="literal">byte[]</code> from the inbound Redis message is sent to the <code class="literal">channel</code> as the <code class="literal">Message</code> payload.
By default, it is a <code class="literal">JdkSerializationRedisSerializer</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO46-9"><span><img src="images/callouts/9.png" alt="9" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Specifies whether this endpoint expects data from the Redis queue to contain entire <code class="literal">Message</code> instances.
If this attribute is set to <code class="literal">true</code>, the <code class="literal">serializer</code> cannot be an empty string, because messages require some form of deserialization (JDK serialization by default).</p>
</td></tr></table></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="redis-queue-inbound-gateway" href="#redis-queue-inbound-gateway"></a>27.9&nbsp;Redis Queue Inbound Gateway</h2></div></div></div>

<p>Spring Integration 4.1 introduced the Redis queue inbound gateway to perform request and reply scenarios.
It pops a conversation <code class="literal">UUID</code> from the provided <code class="literal">queue</code>, pops the value with that <code class="literal">UUID</code> as its key from the Redis list, and pushes the reply to the Redis list with a key of <code class="literal">UUID</code> plus <code class="literal">.reply</code>.
The following listing shows the available attributes for a Redis queue inbound gateway:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-redis:queue-inbound-gateway</span>
        <span class="hl-attribute">request-channel</span>=<span class="hl-value">""</span>  <a name="CO47-1" href="#CO47-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
        reply-channel=""  <a name="CO47-2" href="#CO47-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
        executor=""  <a name="CO47-3" href="#CO47-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
        reply-timeout=""  <a name="CO47-4" href="#CO47-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
        connection-factory=""  <a name="CO47-5" href="#CO47-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
        queue=""  <a name="CO47-6" href="#CO47-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>
        order=""  <a name="CO47-7" href="#CO47-7"></a><span><img src="images/callouts/7.png" alt="7" border="0"></span>
        serializer=""  <a name="CO47-8" href="#CO47-8"></a><span><img src="images/callouts/8.png" alt="8" border="0"></span>
        receive-timeout=""  <a name="CO47-9" href="#CO47-9"></a><span><img src="images/callouts/9.png" alt="9" border="0"></span>
        expect-message=""  <a name="CO47-10" href="#CO47-10"></a><span><img src="images/callouts/10.png" alt="10" border="0"></span>
        recovery-interval=""/&gt;  <a name="CO47-11" href="#CO47-11"></a><span><img src="images/callouts/11.png" alt="11" border="0"></span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO47-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The <code class="literal">MessageChannel</code> from which this endpoint receives <code class="literal">Message</code> instances.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO47-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The <code class="literal">MessageChannel</code> where this endpoint sends reply <code class="literal">Message</code> instances.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO47-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A reference to a Spring <code class="literal">TaskExecutor</code> (or a standard JDK 1.5+ <code class="literal">Executor</code>) bean.
It is used for the underlying listening task.
It defaults to a <code class="literal">SimpleAsyncTaskExecutor</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO47-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The timeout (in milliseconds) to wait until the reply message is sent.
It is typically applied for queue-based limited reply-channels.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO47-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A reference to a <code class="literal">RedisConnectionFactory</code> bean.
It defaults to <code class="literal">redisConnectionFactory</code>.
It is mutually exclusive with <span class="emphasis"><em>redis-template</em></span> attribute.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO47-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The name of the Redis list for the conversation <code class="literal">UUID</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO47-7"><span><img src="images/callouts/7.png" alt="7" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The order of this inbound gateway when multiple gateways are registered.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO47-8"><span><img src="images/callouts/8.png" alt="8" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The <code class="literal">RedisSerializer</code> bean reference.
It can be an empty string, which means "<code class="literal">no serializer</code>".
In this case, the raw <code class="literal">byte[]</code> from the inbound Redis message is sent to the <code class="literal">channel</code> as the <code class="literal">Message</code> payload.
It default to a <code class="literal">JdkSerializationRedisSerializer</code>.
(Note that, in releases before version 4.3, it was a <code class="literal">StringRedisSerializer</code> by default.
To restore that behavior, provide a reference to a <code class="literal">StringRedisSerializer</code>).</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO47-9"><span><img src="images/callouts/9.png" alt="9" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The timeout (in milliseconds) to wait until the receive message is fetched.
It is typically applied for queue-based limited request-channels.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO47-10"><span><img src="images/callouts/10.png" alt="10" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Specifies whether this endpoint expects data from the Redis queue to contain entire <code class="literal">Message</code> instances.
If this attribute is set to <code class="literal">true</code>, the <code class="literal">serializer</code> cannot be an empty string, because messages require some form of deserialization (JDK serialization by default).</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO47-11"><span><img src="images/callouts/11.png" alt="11" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The time (in milliseconds) the listener task should sleep after exceptions on the "<code class="literal">right pop</code>" operation before restarting the listener task.</p>
</td></tr></table></div>
</div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>The <code class="literal">task-executor</code> has to be configured with more than one thread for processing; otherwise there is a possible deadlock when the <code class="literal">RedisQueueMessageDrivenEndpoint</code> tries to restart the listener task after an error.
The <code class="literal">errorChannel</code> can be used to process those errors, to avoid restarts, but it preferable to not expose your application to the possible deadlock situation.
See Spring Framework <a class="ulink" href="https://docs.spring.io/spring/docs/current/spring-framework-reference/integration.html#scheduling-task-executor-types" target="_top">Reference Manual</a> for possible <code class="literal">TaskExecutor</code> implementations.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="redis-lock-registry" href="#redis-lock-registry"></a>27.10&nbsp;Redis Lock Registry</h2></div></div></div>

<p>Spring Integration 4.0 introduced the <code class="literal">RedisLockRegistry</code>.
Certain components (for example, aggregator and resequencer) use a lock obtained from a <code class="literal">LockRegistry</code> instance to ensure that only one thread manipulates a group at a time.
The <code class="literal">DefaultLockRegistry</code> performs this function within a single component.
You can now configure an external lock registry on these components.
When you use it with a shared <code class="literal">MessageGroupStore</code>, you can use the <code class="literal">RedisLockRegistry</code> to provide this functionality across multiple application instances, such that only one instance can manipulate the group at a time.</p>
<p>When a lock is released by a local thread, another local thread can generally acquire the lock immediately.
If a lock is released by a thread using a different registry instance, it can take up to 100ms to acquire the lock.</p>
<p>To avoid "<code class="literal">hung</code>" locks (when a server fails), the locks in this registry are expired after a default 60 seconds, but you can configure this value on the registry.
Locks are normally held for a much smaller time.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Because the keys can expire, an attempt to unlock an expired lock results in an exception being thrown.
However, the resources protected by such a lock may have been compromised, so such exceptions should be considered to be severe.
You should set the expiry at a large enough value to prevent this condition, but set it low enough that the lock can be recovered after a server failure in a reasonable amount of time.</p>
</td></tr></table></div>
<p>Starting with version 5.0, the <code class="literal">RedisLockRegistry</code> implements <code class="literal">ExpirableLockRegistry</code>, which removes locks last acquired more than <code class="literal">age</code> ago and that are not currently locked.</p>
</div>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="resource" href="#resource"></a>28.&nbsp;Resource Support</h2></div></div></div>

<p>The resource inbound channel adapter builds upon Spring&#8217;s <code class="literal">Resource</code> abstraction to support greater flexibility across a variety of actual types of underlying resources, such as a file, a URL, or a class path resource.
Therefore, it is similar to but more generic than the file inbound channel adapter.</p>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="resource-inbound-channel-adapter" href="#resource-inbound-channel-adapter"></a>28.1&nbsp;Resource Inbound Channel Adapter</h2></div></div></div>

<p>The resource inbound channel adapter is a polling adapter that creates a <code class="literal">Message</code> whose payload is a collection of <code class="literal">Resource</code> objects.</p>
<p><code class="literal">Resource</code> objects are resolved based on the pattern specified by the <code class="literal">pattern</code> attribute.
The collection of resolved <code class="literal">Resource</code> objects is then sent as a payload within a <code class="literal">Message</code> to the adapter&#8217;s channel.
That is one major difference between resource inbound channel adapter and file inbound channel adapter: The latter buffers <code class="literal">File</code> objects and sends a single <code class="literal">File</code> object per <code class="literal">Message</code>.</p>
<p>The following example shows a simple configuration that finds all files that end with the <span class="emphasis"><em>properties</em></span> extension in the <code class="literal">things.thing1</code> package available on the classpath and sends them as the payload of a <code class="literal">Message</code> to the channel named <span class="emphasis"><em><code class="literal">resultChannel</code></em></span>:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:resource-inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"resourceAdapter"</span>
               <span class="hl-attribute">channel</span>=<span class="hl-value">"resultChannel"</span>
               <span class="hl-attribute">pattern</span>=<span class="hl-value">"classpath:things/thing1/*.properties"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"1000"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:resource-inbound-channel-adapter&gt;</span></pre>
</div>
<p>The resource inbound channel adapter relies on the <code class="literal">org.springframework.core.io.support.ResourcePatternResolver</code> strategy interface to resolve the provided pattern.
It defaults to an instance of the current <code class="literal">ApplicationContext</code>.
However, you can provide a reference to an instance of your own implementation of <code class="literal">ResourcePatternResolver</code> by setting the <code class="literal">pattern-resolver</code> attribute, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:resource-inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"resourceAdapter"</span>
               <span class="hl-attribute">channel</span>=<span class="hl-value">"resultChannel"</span>
               <span class="hl-attribute">pattern</span>=<span class="hl-value">"classpath:things/thing1/*.properties"</span>
               <span class="hl-attribute">pattern-resolver</span>=<span class="hl-value">"myPatternResolver"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"1000"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:resource-inbound-channel-adapter&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myPatternResolver"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.example.MyPatternResolver"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>You may have a use case where you need to further filter the collection of resources resolved by the <code class="literal">ResourcePatternResolver</code>.
For example, you may want to prevent resources that were already resolved from appearing in a collection of resolved resources ever again.
On the other hand, your resources might be updated rather often and you <span class="emphasis"><em>do</em></span> want them to be picked up again.
In other words, both defining an additional filter and disabling filtering altogether are valid use cases.
You can provide your own implementation of the <code class="literal">org.springframework.integration.util.CollectionFilter</code> strategy interface, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> CollectionFilter&lt;T&gt; {

    Collection&lt;T&gt; filter(Collection&lt;T&gt; unfilteredElements);

}</pre>
</div>
<p>The <code class="literal">CollectionFilter</code> receives a collection of un-filtered elements (which are <code class="literal">Resource</code> objects in the preceding example), and it returns a collection of filtered elements of that same type.</p>
<p>If you define the adapter with XML but you do not specify a filter reference, the resource inbound channel adapter uses a default implementation of <code class="literal">CollectionFilter</code>.
The implementation class of that default filter is <code class="literal">org.springframework.integration.util.AcceptOnceCollectionFilter</code>.
It remembers the elements passed in the previous invocation in order to avoid returning those elements more than once.</p>
<p>To inject your own implementation of <code class="literal">CollectionFilter</code> instead, use the <code class="literal">filter</code> attribute, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:resource-inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"resourceAdapter"</span>
               <span class="hl-attribute">channel</span>=<span class="hl-value">"resultChannel"</span>
               <span class="hl-attribute">pattern</span>=<span class="hl-value">"classpath:things/thing1/*.properties"</span>
               <span class="hl-attribute">filter</span>=<span class="hl-value">"myFilter"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"1000"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:resource-inbound-channel-adapter&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myFilter"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.example.MyFilter"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>If you do not need any filtering and want to disable even the default <code class="literal">CollectionFilter</code> strategy, provide an empty value for the filter attribute (for example, <code class="literal">filter=""</code>)</p>
</div>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="rmi" href="#rmi"></a>29.&nbsp;RMI Support</h2></div></div></div>

<p>This chapter explains how to use channel adapters that are specific to RMI (Remote Method Invocation) to distribute a system over multiple JVMs.
The first section deals with sending messages over RMI.
The second section shows how to receive messages over RMI.
The last section shows how to define RMI channel adapters by using the namespace support.</p>
<p>You need to include this dependency into your project:</p>
<div class="informalexample">
<p>
<b>Maven.&nbsp;</b>

</p><pre class="programlisting"><span class="hl-tag">&lt;dependency&gt;</span>
    <span class="hl-tag">&lt;groupId&gt;</span>org.springframework.integration<span class="hl-tag">&lt;/groupId&gt;</span>
    <span class="hl-tag">&lt;artifactId&gt;</span>spring-integration-rmi<span class="hl-tag">&lt;/artifactId&gt;</span>
    <span class="hl-tag">&lt;version&gt;</span>5.1.2.RELEASE<span class="hl-tag">&lt;/version&gt;</span>
<span class="hl-tag">&lt;/dependency&gt;</span></pre><p>

</p>
<p>
<b>Gradle.&nbsp;</b>

</p><pre class="programlisting">compile <span class="hl-string">"org.springframework.integration:spring-integration-rmi:5.1.2.RELEASE"</span></pre><p>

</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="rmi-outbound" href="#rmi-outbound"></a>29.1&nbsp;Outbound RMI</h2></div></div></div>

<p>To send messages from a channel over RMI, you can define an <code class="literal">RmiOutboundGateway</code>.
This gateway uses Spring&#8217;s <code class="literal">RmiProxyFactoryBean</code> internally to create a proxy for a remote gateway.
Note that, to invoke a remote interface that does not use Spring Integration, you should use a service activator in combination with Spring&#8217;s RmiProxyFactoryBean.</p>
<p>To configure the outbound gateway, you can write a bean definition similar the following:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"rmiOutGateway"</span> <span class="hl-attribute">class</span>=<span class="hl-value">org.spf.integration.rmi.RmiOutboundGateway</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"rmi://host"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"replyChannel"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"replies"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="rmi-inbound" href="#rmi-inbound"></a>29.2&nbsp;Inbound RMI</h2></div></div></div>

<p>To receive messages over RMI, you need to use an <code class="literal">RmiInboundGateway</code>.
You can configure the gateway as shown in the following example:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"rmiInGateway"</span> <span class="hl-attribute">class</span>=<span class="hl-value">org.spf.integration.rmi.RmiInboundGateway</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"requestChannel"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"requests"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
</div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>If you use an <code class="literal">errorChannel</code> on an inbound gateway, it the error flow normally returns a result or throws an exception.
This is because it is likely that there is a corresponding outbound gateway waiting for a response of some kind.
Consuming a message on the error flow and not replying results in no reply for the inbound gateway.
Exceptions (on the main flow when there is no <code class="literal">errorChannel</code> or on the error flow) propagate to the corresponding inbound gateway.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="rmi-namespace" href="#rmi-namespace"></a>29.3&nbsp;RMI namespace support</h2></div></div></div>

<p>To configure the inbound gateway, you can use the namespace support for it.
The following code snippet shows the different configuration options that are supported:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-rmi:inbound-gateway</span> <span class="hl-attribute">id</span>=<span class="hl-value">"gatewayWithDefaults"</span> <span class="hl-attribute">request-channel</span>=<span class="hl-value">"testChannel"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int-rmi:inbound-gateway</span> <span class="hl-attribute">id</span>=<span class="hl-value">"gatewayWithCustomProperties"</span> <span class="hl-attribute">request-channel</span>=<span class="hl-value">"testChannel"</span>
    <span class="hl-attribute">expect-reply</span>=<span class="hl-value">"false"</span> <span class="hl-attribute">request-timeout</span>=<span class="hl-value">"123"</span> <span class="hl-attribute">reply-timeout</span>=<span class="hl-value">"456"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int-rmi:inbound-gateway</span> <span class="hl-attribute">id</span>=<span class="hl-value">"gatewayWithHost"</span> <span class="hl-attribute">request-channel</span>=<span class="hl-value">"testChannel"</span>
    <span class="hl-attribute">registry-host</span>=<span class="hl-value">"localhost"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int-rmi:inbound-gateway</span> <span class="hl-attribute">id</span>=<span class="hl-value">"gatewayWithPort"</span> <span class="hl-attribute">request-channel</span>=<span class="hl-value">"testChannel"</span>
    <span class="hl-attribute">registry-port</span>=<span class="hl-value">"1234"</span> <span class="hl-attribute">error-channel</span>=<span class="hl-value">"rmiErrorChannel"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int-rmi:inbound-gateway</span> <span class="hl-attribute">id</span>=<span class="hl-value">"gatewayWithExecutorRef"</span> <span class="hl-attribute">request-channel</span>=<span class="hl-value">"testChannel"</span>
    <span class="hl-attribute">remote-invocation-executor</span>=<span class="hl-value">"invocationExecutor"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>You can also use the namespace support to configure the outbound gateway.
The following code snippet shows the different configuration for an outbound RMI gateway:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-rmi:outbound-gateway</span> <span class="hl-attribute">id</span>=<span class="hl-value">"gateway"</span>
    <span class="hl-attribute">request-channel</span>=<span class="hl-value">"localChannel"</span>
    <span class="hl-attribute">remote-channel</span>=<span class="hl-value">"testChannel"</span>
    <span class="hl-attribute">host</span>=<span class="hl-value">"localhost"</span><span class="hl-tag">/&gt;</span></pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_configuring_with_java_configuration_20" href="#_configuring_with_java_configuration_20"></a>29.4&nbsp;Configuring with Java Configuration</h2></div></div></div>

<p>The following example shows how to configure an inbound gateway and an outbound gateway with Java:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> RmiInboundGateway inbound() {
    RmiInboundGateway gateway = <span class="hl-keyword">new</span> RmiInboundGateway();
    gateway.setRequestChannel(requestChannel());
    gateway.setRegistryHost(<span class="hl-string">"host"</span>);
    gateway.setRegistryPort(port);
    <span class="hl-keyword">return</span> gateway;
}

<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel="inChannel")</span></em>
<span class="hl-keyword">public</span> RmiOutboundGateway outbound() {
    RmiOutboundGateway gateway = <span class="hl-keyword">new</span> RmiOutboundGateway(<span class="hl-string">"rmi://host:port/"</span>
        + RmiInboundGateway.SERVICE_NAME_PREFIX + <span class="hl-string">"remoteChannelName"</span>);
    <span class="hl-keyword">return</span> gateway;
}</pre>
</div>
<p>As of version 4.3, the outbound gateway has a second constructor that takes an <code class="literal">RmiProxyFactoryBeanConfigurer</code> instance, along with the service url argument.
It allows further configuration before the proxy is created&#8201;&#8212;&#8201;for example, to inject a Spring Security <code class="literal">ContextPropagatingRemoteInvocationFactory</code>, as the following example shows:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel="inChannel")</span></em>
<span class="hl-keyword">public</span> RmiOutboundGateway outbound() {
    RmiOutboundGateway gateway = <span class="hl-keyword">new</span> RmiOutboundGateway(<span class="hl-string">"rmi://host:port/"</span>
                + RmiInboundGateway.SERVICE_NAME_PREFIX + <span class="hl-string">"remoteChannelName"</span>,
        pfb -&gt; {
            pfb.setRemoteInvocationFactory(<span class="hl-keyword">new</span> ContextPropagatingRemoteInvocationFactory());
        });
    <span class="hl-keyword">return</span> gateway;
}</pre>
<p>Starting with version 5.0, you can set this with the XML namespace by using the <code class="literal">configurer</code> attribute.</p>
</div>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="sftp" href="#sftp"></a>30.&nbsp;SFTP Adapters</h2></div></div></div>

<p>Spring Integration provides support for file transfer operations over SFTP.</p>
<p>The Secure File Transfer Protocol (SFTP) is a network protocol that lets you transfer files between two computers on the Internet over any reliable stream.</p>
<p>The SFTP protocol requires a secure channel, such as SSH, and visibility to a client&#8217;s identity throughout the SFTP session.</p>
<p>Spring Integration supports sending and receiving files over SFTP by providing three client side endpoints: inbound channel adapter, outbound channel adapter, and outbound gateway.
It also provides convenient namespace configuration to define these client components.</p>
<p>You need to include this dependency into your project:</p>
<div class="informalexample">
<p>
<b>Maven.&nbsp;</b>

</p><pre class="programlisting"><span class="hl-tag">&lt;dependency&gt;</span>
    <span class="hl-tag">&lt;groupId&gt;</span>org.springframework.integration<span class="hl-tag">&lt;/groupId&gt;</span>
    <span class="hl-tag">&lt;artifactId&gt;</span>spring-integration-sftp<span class="hl-tag">&lt;/artifactId&gt;</span>
    <span class="hl-tag">&lt;version&gt;</span>5.1.2.RELEASE<span class="hl-tag">&lt;/version&gt;</span>
<span class="hl-tag">&lt;/dependency&gt;</span></pre><p>

</p>
<p>
<b>Gradle.&nbsp;</b>

</p><pre class="programlisting">compile <span class="hl-string">"org.springframework.integration:spring-integration-sftp:5.1.2.RELEASE"</span></pre><p>

</p>
</div>
<p>To include the SFTP namespace in your xml configuration, include the following attributes on the root element:</p>
<div class="informalexample">
<pre class="programlisting">xmlns:int-sftp="http://www.springframework.org/schema/integration/sftp"
xsi:schemaLocation="http://www.springframework.org/schema/integration/sftp
    http://www.springframework.org/schema/integration/sftp/spring-integration-sftp.xsd"</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="sftp-session-factory" href="#sftp-session-factory"></a>30.1&nbsp;SFTP Session Factory</h2></div></div></div>

<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>As of version 3.0, sessions are no longer cached by default.
See <a class="xref" href="#sftp-session-caching" title="30.4&nbsp;SFTP Session Caching">Section&nbsp;30.4, &#8220;SFTP Session Caching&#8221;</a>.</p>
</td></tr></table></div>
<p>Before configuring SFTP adapters, you must configure an SFTP session factory.
You can configure the SFTP session factory with a regular bean definition, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;beans:bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"sftpSessionFactory"</span>
    <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.sftp.session.DefaultSftpSessionFactory"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;beans:property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"host"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"localhost"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;beans:property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"privateKey"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"classpath:META-INF/keys/sftpTest"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;beans:property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"privateKeyPassphrase"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"springIntegration"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;beans:property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"port"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"22"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;beans:property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"user"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"kermit"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/beans:bean&gt;</span></pre>
</div>
<p>Every time an adapter requests a session object from its <code class="literal">SessionFactory</code>, a new SFTP session is created.
Under the covers, the SFTP Session Factory relies on the <a class="ulink" href="http://www.jcraft.com/jsch/" target="_top">JSch</a> library to provide the SFTP capabilities.</p>
<p>However, Spring Integration also supports the caching of SFTP sessions.
See <a class="xref" href="#sftp-session-caching" title="30.4&nbsp;SFTP Session Caching">Section&nbsp;30.4, &#8220;SFTP Session Caching&#8221;</a> for more information.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>JSch supports multiple channels (operations) over a connection to the server.
By default, the Spring Integration session factory uses a separate physical connection for each channel.
Since Spring Integration 3.0, you can configure the session factory (using a boolean constructor arg - default <code class="literal">false</code>) to use a single connection to the server and create multiple <code class="literal">JSch</code> channels on that single connection.</p>
<p>When using this feature, you must wrap the session factory in a caching session factory, as <a class="link" href="#sftp-session-caching" title="30.4&nbsp;SFTP Session Caching">described later</a>, so that the connection is not physically closed when an operation completes.</p>
<p>If the cache is reset, the session is disconnected only when the last channel is closed.</p>
<p>The connection is refreshed if it is found to be disconnected when a new operation obtains a session.</p>
</td></tr></table></div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>If you experience connectivity problems and would like to trace session creation and see which sessions are polled, you may enable tracing by setting the logger to <code class="literal">TRACE</code> level (for example, <code class="literal">log4j.category.org.springframework.integration.sftp=TRACE</code>).
See <a class="xref" href="#sftp-jsch-logging" title="30.12&nbsp;SFTP/JSCH Logging">Section&nbsp;30.12, &#8220;SFTP/JSCH Logging&#8221;</a>.</p>
</td></tr></table></div>
<p>Now all you need to do is inject this SFTP session factory into your adapters.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>A more practical way to provide values for the SFTP session factory is to use Spring&#8217;s <a class="ulink" href="http://static.springsource.org/spring/docs/current/spring-framework-reference/html/beans.html#beans-factory-placeholderconfigurer" target="_top">property placeholder support</a>.</p>
</td></tr></table></div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="sftp-session-factory-properties" href="#sftp-session-factory-properties"></a>30.1.1&nbsp;Configuration Properties</h3></div></div></div>

<p>The following list describes all the properties that are exposed by the <a class="ulink" href="http://static.springsource.org/spring-integration/api/org/springframework/integration/sftp/session/DefaultSftpSessionFactory.html" target="_top"><code class="literal">DefaultSftpSessionFactory</code></a>.</p>
<p><code class="literal">isSharedSession</code> (constructor argument)::When <code class="literal">true</code>, a single connection is used, and <code class="literal">JSch Channels</code> are multiplexed.
It defaults to <code class="literal">false</code>.</p>
<p><code class="literal">clientVersion</code>::Lets you set the client version property.
It&#8217;s default depends on the underlying JSch version but it will look like:_SSH-2.0-JSCH-0.1.45_</p>
<p><code class="literal">enableDaemonThread</code>::If <code class="literal">true</code>, all threads are daemon threads.
If set to <code class="literal">false</code>, normal non-daemon threads are used instead.
This property is set on the underlying <a class="ulink" href="http://epaul.github.io/jsch-documentation/javadoc/com/jcraft/jsch/Session.html" target="_top">session</a>.
There, this property defaults to <code class="literal">false</code>.</p>
<p><code class="literal">host</code>::The URL of the host to which you want to connect.
Required.</p>
<p><code class="literal">hostKeyAlias</code>::Sets the host key alias, which is used when comparing the host key to the known hosts list.</p>
<p><code class="literal">knownHosts</code>::Specifies the filename that used for a host key repository.
The file has the same format as OpenSSH&#8217;s <code class="literal">known_hosts</code> file and is required and must be pre-populated if <code class="literal">allowUnknownKeys</code> is false.</p>
<p><code class="literal">password</code>::The password to authenticate against the remote host.
If a password is not provided, then the <code class="literal">privateKey</code> property is required.
It is not allowed if you set <code class="literal">userInfo</code>.
The password is obtained from that object.</p>
<p><code class="literal">port</code>::The port over which the SFTP connection shall be established.
If not specified, this value defaults to <code class="literal">22</code>.
If specified, this properties must be a positive number.</p>
<p><code class="literal">privateKey</code>::Lets you set a <a class="ulink" href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/core/io/Resource.html" target="_top">resource</a> that represents the location of the private key used for authenticating against the remote host.
If the <code class="literal">privateKey</code> is not provided, then the <code class="literal">password</code> property is required.</p>
<p><code class="literal">privateKeyPassphrase</code>::The password for the private key.
If you set <code class="literal">userInfo</code>, <code class="literal">privateKeyPassphrase</code> is not allowed .
The passphrase is obtained from that object.
Optional.</p>
<p><code class="literal">proxy</code>::Allows for specifying a JSch-based <a class="ulink" href="http://epaul.github.com/jsch-documentation/javadoc/com/jcraft/jsch/Proxy.html" target="_top">proxy</a>.
If set, the proxy object is used to create the connection to the remote host through the proxy.
See <a class="xref" href="#sftp-proxy-factory-bean" title="30.2&nbsp;Proxy Factory Bean">Section&nbsp;30.2, &#8220;Proxy Factory Bean&#8221;</a> for a convenient way to configure the proxy.</p>
<p><code class="literal">serverAliveCountMax</code>::Specifies the number of server-alive messages, which are sent without any reply from the server before disconnecting.
If not set, this property defaults to <code class="literal">1</code>.</p>
<p><code class="literal">serverAliveInterval</code>::Sets the timeout interval (in milliseconds) before a server-alive message is sent, in case no message is received from the server.</p>
<p><code class="literal">sessionConfig</code>::By using <code class="literal">Properties</code>, you can set additional configuration setting on the underlying JSch Session.</p>
<p><code class="literal">socketFactory</code>:Lets you pass in a <a class="ulink" href="http://epaul.github.com/jsch-documentation/javadoc/com/jcraft/jsch/SocketFactory.html" target="_top"><code class="literal">SocketFactory</code></a>.
The socket factory is used to create a socket to the target host.
When a proxy is used, the socket factory is passed to the proxy.
By default, plain TCP sockets are used.</p>
<p><code class="literal">timeout</code>::The timeout property is used as the socket timeout parameter, as well as the default connection timeout.
Defaults to <code class="literal">0</code>, which means, that no timeout will occur.</p>
<p><code class="literal">user</code>::The remote user to use.
Required.</p>
<p><a name="sftp-unk-keys" href="#sftp-unk-keys"></a><code class="literal">allowUnknownKeys</code>::Set to <code class="literal">true</code> to allow connections to hosts with unknown (or changed) keys.
Its default is <span class="emphasis"><em>false</em></span>.
It is applied only if no <code class="literal">userInfo</code> is provided.
If <code class="literal">false</code>, a pre-populated <code class="literal">knownHosts</code> file is required.</p>
<p><code class="literal">userInfo</code>::Set a custom <code class="literal">UserInfo</code> to be used during authentication.
In particular, <code class="literal">promptYesNo()</code> is invoked when an unknown (or changed) host key is received.
See also <a class="link" href="#sftp-unk-keys"><code class="literal">allowUnknownKeys</code></a>.
When you provide a <code class="literal">UserInfo</code>, the <code class="literal">password</code> and private key <code class="literal">passphrase</code> are obtained from it, and you cannot set discrete
<code class="literal">password</code> and <code class="literal">privateKeyPassprase</code> properties.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="sftp-proxy-factory-bean" href="#sftp-proxy-factory-bean"></a>30.2&nbsp;Proxy Factory Bean</h2></div></div></div>

<p><code class="literal">Jsch</code> provides a mechanism to connect to the server over an HTTP or SOCKS proxy.
To use this feature, configure the <code class="literal">Proxy</code> and provide a reference to the <code class="literal">DefaultSftpSessionFactory</code>, as discussed
earlier.
Three implementations are provided by <code class="literal">Jsch</code>: <code class="literal">HTTP</code>, <code class="literal">SOCKS4</code>, and <code class="literal">SOCKS5</code>.
Spring Integration 4.3 introduced a <code class="literal">FactoryBean</code>, easing configuration of these proxies by allowing property
injection, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"proxySocks5"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.sftp.session.JschProxyFactoryBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"SOCKS5"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"${sftp.proxy.address}"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"${sftp.proxy.port}"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"${sftp.proxy.user}"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"${sftp.proxy.pw}"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"sessionFactory"</span>
          <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.sftp.session.DefaultSftpSessionFactory"</span><span class="hl-tag"> &gt;</span>
    ...
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"proxy"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"proxySocks5"</span><span class="hl-tag"> /&gt;</span>
    ...
<span class="hl-tag">&lt;/bean&gt;</span></pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="sftp-dsf" href="#sftp-dsf"></a>30.3&nbsp;Delegating Session Factory</h2></div></div></div>

<p>Version 4.2 introduced the <code class="literal">DelegatingSessionFactory</code>, which allows the selection of the actual session factory at
runtime.
Prior to invoking the FTP endpoint, you can call <code class="literal">setThreadKey()</code> on the factory to associate a key with the current thread.
That key is then used to look up the actual session factory to be used.
You can clear the key by calling <code class="literal">clearThreadKey()</code> after use.</p>
<p>We added convenience methods so that you can more easily do so from a message flow, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"dsf"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.file.remote.session.DelegatingSessionFactory"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.file.remote.session.DefaultSessionFactoryLocator"</span><span class="hl-tag">&gt;</span>
            <span class="hl-comment">&lt;!-- delegate factories here --&gt;</span>
        <span class="hl-tag">&lt;/bean&gt;</span>
    <span class="hl-tag">&lt;/constructor-arg&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;int:service-activator</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"in"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"c1"</span>
        <span class="hl-attribute">expression</span>=<span class="hl-value">"@dsf.setThreadKey(#root, headers['factoryToUse'])"</span><span class="hl-tag"> /&gt;</span>

<span class="hl-tag">&lt;int-sftp:outbound-gateway</span> <span class="hl-attribute">request-channel</span>=<span class="hl-value">"c1"</span> <span class="hl-attribute">reply-channel</span>=<span class="hl-value">"c2"</span> <span class="hl-attribute">...</span><span class="hl-tag"> /&gt;</span>

<span class="hl-tag">&lt;int:service-activator</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"c2"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"out"</span>
        <span class="hl-attribute">expression</span>=<span class="hl-value">"@dsf.clearThreadKey(#root)"</span><span class="hl-tag"> /&gt;</span></pre>
</div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>When using session caching (see <a class="xref" href="#sftp-session-caching" title="30.4&nbsp;SFTP Session Caching">Section&nbsp;30.4, &#8220;SFTP Session Caching&#8221;</a>), each of the delegates should be cached.
You cannot cache the <code class="literal">DelegatingSessionFactory</code> itself.</p>
</td></tr></table></div>
<p>Starting with <span class="emphasis"><em>version 5.0.7</em></span>, the <code class="literal">DelegatingSessionFactory</code> can be used in conjunction with a <code class="literal">RotatingServerAdvice</code> to poll multiple servers; see <a class="xref" href="#sftp-rotating-server-advice" title="30.8&nbsp;Inbound Channel Adapters: Polling Multiple Servers and Directories">Section&nbsp;30.8, &#8220;Inbound Channel Adapters: Polling Multiple Servers and Directories&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="sftp-session-caching" href="#sftp-session-caching"></a>30.4&nbsp;SFTP Session Caching</h2></div></div></div>

<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Starting with Spring Integration version 3.0, sessions are no longer cached by default.
The <code class="literal">cache-sessions</code> attribute is no longer supported on endpoints.
If you wish to cache sessions, you must use a <code class="literal">CachingSessionFactory</code> (see the next example).</p>
</td></tr></table></div>
<p>In versions prior to 3.0, the sessions were automatically cached by default.
A <code class="literal">cache-sessions</code> attribute was available for disabling the auto caching, but that solution did not provide a way to configure other session-caching attributes.
For example, you could not limit on the number of sessions created.
To support that requirement and other configuration options, we added a <code class="literal">CachingSessionFactory</code>.
It provides <code class="literal">sessionCacheSize</code> and <code class="literal">sessionWaitTimeout</code> properties.
As its name suggests, the <code class="literal">sessionCacheSize</code> property controls how many active sessions the factory maintains in its cache (the default is unbounded).
If the <code class="literal">sessionCacheSize</code> threshold has been reached, any attempt to acquire another session blocks until either one of the cached sessions becomes available or until the wait time for a session expires (the default wait time is <code class="literal">Integer.MAX_VALUE</code>).
The <code class="literal">sessionWaitTimeout</code> property enables configuration of the wait time.</p>
<p>If you want your sessions to be cached, configure your default session factory (as <a class="link" href="#sftp-session-factory" title="30.1&nbsp;SFTP Session Factory">described earlier</a>) and then wrap it in an instance of <code class="literal">CachingSessionFactory</code> where you may provide those additional properties.
The following example shows how to do so:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"sftpSessionFactory"</span>
    <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.sftp.session.DefaultSftpSessionFactory"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"host"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"localhost"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"cachingSessionFactory"</span>
    <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.file.remote.session.CachingSessionFactory"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"sftpSessionFactory"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"10"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"sessionWaitTimeout"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"1000"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
<p>The preceding example creates a <code class="literal">CachingSessionFactory</code> with its <code class="literal">sessionCacheSize</code> set to <code class="literal">10</code> and its <code class="literal">sessionWaitTimeout</code> set to one second (1000 milliseconds).</p>
<p>Starting with Spring Integration version 3.0, the <code class="literal">CachingConnectionFactory</code> provides a <code class="literal">resetCache()</code> method.
When invoked, all idle sessions are immediately closed and in-use sessions are closed when they are returned to the cache.
When using <code class="literal">isSharedSession=true</code>, the channel is closed and the shared session is closed only when the last channel is closed.
New requests for sessions establish new sessions as necessary.</p>
<p>Starting with version 5.1, the <code class="literal">CachingSessionFactory</code> has a new property <code class="literal">testSession</code>.
When true, the session will be tested by performing a <code class="literal">stat(getHome())</code> command to ensure it is still active; if not, it will be removed from the cache; a new session is created if no active sessions are in the cache.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="sftp-rft" href="#sftp-rft"></a>30.5&nbsp;Using <code class="literal">RemoteFileTemplate</code></h2></div></div></div>

<p>Spring Integration version 3.0 provides a new abstraction over the <code class="literal">SftpSession</code> object.
The template provides methods to send, retrieve (as an <code class="literal">InputStream</code>), remove, and rename files.
In addition, we provide an <code class="literal">execute</code> method to let the caller run multiple operations on the session.
In all cases, the template takes care of reliably closing the session.
For more information, see the <a class="ulink" href="http://docs.spring.io/spring-integration/api/org/springframework/integration/file/remote/RemoteFileTemplate.html" target="_top">Javadoc for <code class="literal">RemoteFileTemplate</code></a> There is a subclass for SFTP: <a class="ulink" href="https://docs.spring.io/spring-integration/api/org/springframework/integration/sftp/session/SftpRemoteFileTemplate.html" target="_top"><code class="literal">SftpRemoteFileTemplate</code></a>.</p>
<p>We added additional methods in version 4.1, including <code class="literal">getClientInstance()</code>.
It provides access to the underlying <code class="literal">ChannelSftp</code>, which enables access to low-level APIs.</p>
<p>Version 5.0 introduced the <code class="literal">RemoteFileOperations.invoke(OperationsCallback&lt;F, T&gt; action)</code> method.
This method lets several <code class="literal">RemoteFileOperations</code> calls be called in the scope of the same thread-bounded <code class="literal">Session</code>.
This is useful when you need to perform several high-level operations of the <code class="literal">RemoteFileTemplate</code> as one unit of work.
For example, <code class="literal">AbstractRemoteFileOutboundGateway</code> uses it with the <code class="literal">mput</code> command implementation, where we perform a <code class="literal">put</code> operation for each file in the provided directory and recursively for its sub-directories.
See the <a class="ulink" href="https://docs.spring.io/spring-integration/api/org/springframework/integration/file/remote/RemoteFileTemplate.html#invoke-org.springframework.integration.file.remote.OperationsCallback-" target="_top">Javadoc</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="sftp-inbound" href="#sftp-inbound"></a>30.6&nbsp;SFTP Inbound Channel Adapter</h2></div></div></div>

<p>The SFTP inbound channel adapter is a special listener that connects to the server and listens for the remote directory events (such as a new file being created), at which point it initiates a file transfer.
The following example shows how to configure an SFTP inbound channel adapter:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-sftp:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"sftpAdapterAutoCreate"</span>
              <span class="hl-attribute">session-factory</span>=<span class="hl-value">"sftpSessionFactory"</span>
            <span class="hl-attribute">channel</span>=<span class="hl-value">"requestChannel"</span>
            <span class="hl-attribute">filename-pattern</span>=<span class="hl-value">"*.txt"</span>
            <span class="hl-attribute">remote-directory</span>=<span class="hl-value">"/foo/bar"</span>
            <span class="hl-attribute">preserve-timestamp</span>=<span class="hl-value">"true"</span>
            <span class="hl-attribute">local-directory</span>=<span class="hl-value">"file:target/foo"</span>
            <span class="hl-attribute">auto-create-local-directory</span>=<span class="hl-value">"true"</span>
            <span class="hl-attribute">local-filename-generator-expression</span>=<span class="hl-value">"#this.toUpperCase() + '.a'"</span>
            <span class="hl-attribute">scanner</span>=<span class="hl-value">"myDirScanner"</span>
            <span class="hl-attribute">local-filter</span>=<span class="hl-value">"myFilter"</span>
            <span class="hl-attribute">temporary-file-suffix</span>=<span class="hl-value">".writing"</span>
            <span class="hl-attribute">max-fetch-size</span>=<span class="hl-value">"-1"</span>
            <span class="hl-attribute">delete-remote-files</span>=<span class="hl-value">"false"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"1000"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-sftp:inbound-channel-adapter&gt;</span></pre>
</div>
<p>The preceding configuration example shows how to provide values for various attributes, including the following:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">local-directory</code>: The location to which files are going to be transferred
</li><li class="listitem">
<code class="literal">remote-directory</code>: The remote source directory from which files are going to be transferred
</li><li class="listitem">
<code class="literal">session-factory</code>: A reference to the bean we configured earlier
</li></ul></div>
<p>By default, the transferred file carries the same name as the original file.
If you want to override this behavior, you can set the <code class="literal">local-filename-generator-expression</code> attribute, which lets you provide a SpEL expression to generate the name of the local file.
Unlike outbound gateways and adapters, where the root object of the SpEL evaluation context is a <code class="literal">Message</code>, this inbound adapter does not yet have the message at the time of evaluation, since that is what it ultimately generates with the transferred file as its payload.
Consequently, the root object of the SpEL evaluation context is the original name of the remote file (a <code class="literal">String</code>).</p>
<p>The inbound channel adapter first retrieves the file to a local directory and then emits each file according to the poller configuration.
Starting with version 5.0, you can limit the number of files fetched from the FTP server when new file retrievals are needed.
This can be beneficial when the target files are large or when running in a clustered system with a persistent file list filter, discussed later in this section.
Use <code class="literal">max-fetch-size</code> for this purpose.
A negative value (the default) means no limit and all matching files are retrieved.
See <a class="xref" href="#sftp-max-fetch" title="30.9&nbsp;Inbound Channel Adapters: Controlling Remote File Fetching">Section&nbsp;30.9, &#8220;Inbound Channel Adapters: Controlling Remote File Fetching&#8221;</a> for more information.
Since version 5.0, you can also provide a custom <code class="literal">DirectoryScanner</code> implementation to the <code class="literal">inbound-channel-adapter</code> by setting the <code class="literal">scanner</code> attribute.</p>
<p>Starting with Spring Integration 3.0, you can specify the <code class="literal">preserve-timestamp</code> attribute (the default is <code class="literal">false</code>).
When <code class="literal">true</code>, the local file&#8217;s modified timestamp is set to the value retrieved from the server.
Otherwise, it is set to the current time.</p>
<p>Starting with version 4.2, you can specify <code class="literal">remote-directory-expression</code> instead of <code class="literal">remote-directory</code>, which lets
you dynamically determine the directory on each poll&#8201;&#8212;&#8201;for example, <code class="literal">remote-directory-expression="@myBean.determineRemoteDir()"</code>.</p>
<p>Sometimes, file filtering based on the simple pattern specified via <code class="literal">filename-pattern</code> attribute might not suffice.
If this is the case, you can use the <code class="literal">filename-regex</code> attribute to specify a regular expression (for example, <code class="literal">filename-regex=".*\.test$"</code>).
If you need complete control, you can use the <code class="literal">filter</code> attribute to provide a reference to a custom implementation of the <code class="literal">org.springframework.integration.file.filters.FileListFilter</code>, which is a strategy interface for filtering a list of files.
This filter determines which remote files are retrieved.
You can also combine a pattern-based filter with other filters (such as an <code class="literal">AcceptOnceFileListFilter</code>, to avoid synchronizing files that have previously been fetched) by using a <code class="literal">CompositeFileListFilter</code>.</p>
<p>The <code class="literal">AcceptOnceFileListFilter</code> stores its state in memory.
If you wish the state to survive a system restart, consider using the <code class="literal">SftpPersistentAcceptOnceFileListFilter</code> instead.
This filter stores the accepted file names in an instance of the <code class="literal">MetadataStore</code> strategy (see <a class="xref" href="#metadata-store" title="12.5&nbsp;Metadata Store">Section&nbsp;12.5, &#8220;Metadata Store&#8221;</a>).
This filter matches on the filename and the remote modified time.</p>
<p>Since version 4.0, this filter requires a <code class="literal">ConcurrentMetadataStore</code>.
When used with a shared data store (such as <code class="literal">Redis</code> with the <code class="literal">RedisMetadataStore</code>), this lets filter keys be shared across multiple application or server instances.</p>
<p>Starting with version 5.0, the <code class="literal">SftpPersistentAcceptOnceFileListFilter</code> with an in-memory <code class="literal">SimpleMetadataStore</code> is applied by default for the <code class="literal">SftpInboundFileSynchronizer</code>.
This filter is also applied, together with the <code class="literal">regex</code> or <code class="literal">pattern</code> option in the XML configuration, as well as through <code class="literal">FtpInboundChannelAdapterSpec</code> in Java DSL.
You can handle any other use-cases by using <code class="literal">CompositeFileListFilter</code> (or <code class="literal">ChainFileListFilter</code>).</p>
<p>The above discussion refers to filtering the files before retrieving them.
Once the files have been retrieved, an additional filter is applied to the files on the file system.
By default, this is an`AcceptOnceFileListFilter`, which, as discussed in this section, retains state in memory and does not consider the file&#8217;s modified time.
Unless your application removes files after processing, the adapter re-processes the files on disk by default after an application restart.</p>
<p>Also, if you configure the <code class="literal">filter</code> to use a <code class="literal">FtpPersistentAcceptOnceFileListFilter</code> and the remote file timestamp changes (causing it to be re-fetched), the default local filter does not allow this new file to be processed.</p>
<p>You can use the <code class="literal">local-filter</code> attribute to configure the behavior of the local file system filter.
Starting with version 4.3.8, a <code class="literal">FileSystemPersistentAcceptOnceFileListFilter</code> is configured by default.
This filter stores the accepted file names and modified timestamp in an instance of the <code class="literal">MetadataStore</code> strategy (see <a class="xref" href="#metadata-store" title="12.5&nbsp;Metadata Store">Section&nbsp;12.5, &#8220;Metadata Store&#8221;</a>) and detects changes to the local file modified time.
The default <code class="literal">MetadataStore</code> is a <code class="literal">SimpleMetadataStore</code> that stores state in memory.</p>
<p>Since version 4.1.5, these filters have a new property called <code class="literal">flushOnUpdate</code>, which causes them to flush the
metadata store on every update (if the store implements <code class="literal">Flushable</code>).</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Further, if you use a distributed <code class="literal">MetadataStore</code> (such as <a class="xref" href="#redis-metadata-store" title="27.4&nbsp;Redis Metadata Store">Section&nbsp;27.4, &#8220;Redis Metadata Store&#8221;</a> or <a class="xref" href="#gemfire-metadata-store" title="19.6&nbsp;Gemfire Metadata Store">Section&nbsp;19.6, &#8220;Gemfire Metadata Store&#8221;</a>), you can have multiple instances of the same adapter or application and be sure that one and only one instance processes a file.</p>
</td></tr></table></div>
<p>The actual local filter is a <code class="literal">CompositeFileListFilter</code> that contains the supplied filter and a pattern filter that prevents processing files that are in the process of being downloaded (based on the <code class="literal">temporary-file-suffix</code>).
Files are downloaded with this suffix (the default is <code class="literal">.writing</code>), and the files are renamed to their final names when the transfer is complete, making them <span class="emphasis"><em>visible</em></span> to the filter.</p>
<p>See the <a class="ulink" href="https://github.com/spring-projects/spring-integration/tree/master/spring-integration-core/src/main/resources/org/springframework/integration/config" target="_top">schema</a> for more detail on these attributes.</p>
<p>SFTP inbound channel adapter is a polling consumer.
Therefore, you must configure a poller (either a global default or a local element).
Once the file has been transferred to a local directory, a message with <code class="literal">java.io.File</code> as its payload type is generated and sent to the channel identified by the <code class="literal">channel</code> attribute.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_more_on_file_filtering_and_large_files" href="#_more_on_file_filtering_and_large_files"></a>30.6.1&nbsp;More on File Filtering and Large Files</h3></div></div></div>

<p>Sometimes, a file that just appeared in the monitored (remote) directory is not complete.
Typically such a file is written with some temporary extension (such as <code class="literal">.writing</code> on a file named <code class="literal">something.txt.writing</code>) and then renamed after the writing process completes.
In most cases, developers are interested only in files that are complete and would like to filter only those files.
To handle these scenarios, you can use the filtering support provided by the <code class="literal">filename-pattern</code>, <code class="literal">filename-regex</code>, and <code class="literal">filter</code> attributes.
If you need a custom filter implementation, you can include a reference in your adapter by setting the <code class="literal">filter</code> attribute.
The following example shows how to do so:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-sftp:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"sftpInbondAdapter"</span>
            <span class="hl-attribute">channel</span>=<span class="hl-value">"receiveChannel"</span>
            <span class="hl-attribute">session-factory</span>=<span class="hl-value">"sftpSessionFactory"</span>
            <span class="hl-attribute">filter</span>=<span class="hl-value">"customFilter"</span>
            <span class="hl-attribute">local-directory</span>=<span class="hl-value">"file:/local-test-dir"</span>
            <span class="hl-attribute">remote-directory</span>=<span class="hl-value">"/remote-test-dir"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"1000"</span> <span class="hl-attribute">max-messages-per-poll</span>=<span class="hl-value">"10"</span> <span class="hl-attribute">task-executor</span>=<span class="hl-value">"executor"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-sftp:inbound-channel-adapter&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"customFilter"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.foo.CustomFilter"</span><span class="hl-tag">/&gt;</span></pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_recovering_from_failures_2" href="#_recovering_from_failures_2"></a>30.6.2&nbsp;Recovering from Failures</h3></div></div></div>

<p>You should understand the architecture of the adapter.
A file synchronizer fetches the files, and a <code class="literal">FileReadingMessageSource</code> emits a message for each synchronized file.
As <a class="link" href="#sftp-inbound" title="30.6&nbsp;SFTP Inbound Channel Adapter">discussed earlier</a>, two filters are involved.
The <code class="literal">filter</code> attribute (and patterns) refers to the remote (SFTP) file list, to avoid fetching files that have already
been fetched.
the <code class="literal">FileReadingMessageSource</code> uses the <code class="literal">local-filter</code> to determine which files are to be sent as messages.</p>
<p>The synchronizer lists the remote files and consults its filter.
The files are then transferred.
If an IO error occurs during file transfer, any files that have already been added to the filter are removed so that they
are eligible to be re-fetched on the next poll.
This applies only if the filter implements <code class="literal">ReversibleFileListFilter</code> (such as the <code class="literal">AcceptOnceFileListFilter</code>).</p>
<p>If, after synchronizing the files, an error occurs on the downstream flow processing a file, no automatic rollback of the filter occurs, so the failed file is not reprocessed by default.</p>
<p>If you wish to reprocess such files after a failure, you can use a configuration similar to the following to facilitate
the removal of the failed file from the filter:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-sftp:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"sftpAdapter"</span>
        <span class="hl-attribute">session-factory</span>=<span class="hl-value">"sftpSessionFactory"</span>
        <span class="hl-attribute">channel</span>=<span class="hl-value">"requestChannel"</span>
        <span class="hl-attribute">remote-directory-expression</span>=<span class="hl-value">"'/sftpSource'"</span>
        <span class="hl-attribute">local-directory</span>=<span class="hl-value">"file:myLocalDir"</span>
        <span class="hl-attribute">auto-create-local-directory</span>=<span class="hl-value">"true"</span>
        <span class="hl-attribute">filename-pattern</span>=<span class="hl-value">"*.txt"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"1000"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;int:transactional</span> <span class="hl-attribute">synchronization-factory</span>=<span class="hl-value">"syncFactory"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;/int:poller&gt;</span>
<span class="hl-tag">&lt;/int-sftp:inbound-channel-adapter&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"acceptOnceFilter"</span>
    <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.file.filters.AcceptOnceFileListFilter"</span><span class="hl-tag"> /&gt;</span>

<span class="hl-tag">&lt;int:transaction-synchronization-factory</span> <span class="hl-attribute">id</span>=<span class="hl-value">"syncFactory"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:after-rollback</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"payload.delete()"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/int:transaction-synchronization-factory&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"transactionManager"</span>
    <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.transaction.PseudoTransactionManager"</span><span class="hl-tag"> /&gt;</span></pre>
</div>
<p>The preceding configuration works for any <code class="literal">ResettableFileListFilter</code>.</p>
<p>Starting with version 5.0, the inbound channel adapter can build sub-directories locally, according to the generated local file name.
That can be a remote sub-path as well.
To be able to read a local directory recursively for modification according to the hierarchy support, you can now supply an internal <code class="literal">FileReadingMessageSource</code> with a new <code class="literal">RecursiveDirectoryScanner</code> based on the <code class="literal">Files.walk()</code> algorithm.
See <a class="ulink" href="https://docs.spring.io/spring-integration/api/org/springframework/integration/file/remote/synchronizer/AbstractInboundFileSynchronizingMessageSource.html#setScanner-org.springframework.integration.file.DirectoryScanner" target="_top">https://docs.spring.io/spring-integration/api/org/springframework/integration/file/remote/synchronizer/AbstractInboundFileSynchronizingMessageSource.html#setScanner-org.springframework.integration.file.DirectoryScanner</a>[<code class="literal">AbstractInboundFileSynchronizingMessageSource.setScanner()]</code> for more information.
Also, you can now switch the <code class="literal">AbstractInboundFileSynchronizingMessageSource</code> to the <code class="literal">WatchService</code>-based <code class="literal">DirectoryScanner</code> by using <code class="literal">setUseWatchService()</code> option.
It is also configured for all the <code class="literal">WatchEventType</code> instances to react for any modifications in local directory.
The reprocessing sample shown earlier is based on the built-in functionality of the <code class="literal">FileReadingMessageSource.WatchServiceDirectoryScanner</code>, which uses <code class="literal">ResettableFileListFilter.remove()</code> when the file is deleted (<code class="literal">StandardWatchEventKinds.ENTRY_DELETE</code>) from the local directory.
See <a class="xref" href="#watch-service-directory-scanner" title="17.1.4&nbsp;WatchServiceDirectoryScanner">Section&nbsp;17.1.4, &#8220;<code class="literal">WatchServiceDirectoryScanner</code>&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_with_java_configuration_21" href="#_configuring_with_java_configuration_21"></a>30.6.3&nbsp;Configuring with Java Configuration</h3></div></div></div>

<p>The following Spring Boot application shows an example of how to configure the inbound adapter with Java:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@SpringBootApplication</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> SftpJavaApplication {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
        <span class="hl-keyword">new</span> SpringApplicationBuilder(SftpJavaApplication.<span class="hl-keyword">class</span>)
            .web(false)
            .run(args);
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> SessionFactory&lt;LsEntry&gt; sftpSessionFactory() {
        DefaultSftpSessionFactory factory = <span class="hl-keyword">new</span> DefaultSftpSessionFactory(true);
        factory.setHost(<span class="hl-string">"localhost"</span>);
        factory.setPort(port);
        factory.setUser(<span class="hl-string">"foo"</span>);
        factory.setPassword(<span class="hl-string">"foo"</span>);
        factory.setAllowUnknownKeys(true);
        factory.setTestSession(true);
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> CachingSessionFactory&lt;LsEntry&gt;(factory);
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> SftpInboundFileSynchronizer sftpInboundFileSynchronizer() {
        SftpInboundFileSynchronizer fileSynchronizer = <span class="hl-keyword">new</span> SftpInboundFileSynchronizer(sftpSessionFactory());
        fileSynchronizer.setDeleteRemoteFiles(false);
        fileSynchronizer.setRemoteDirectory(<span class="hl-string">"foo"</span>);
        fileSynchronizer.setFilter(<span class="hl-keyword">new</span> SftpSimplePatternFileListFilter(<span class="hl-string">"*.xml"</span>));
        <span class="hl-keyword">return</span> fileSynchronizer;
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <em><span class="hl-annotation" style="color: gray">@InboundChannelAdapter(channel = "sftpChannel", poller = @Poller(fixedDelay = "5000"))</span></em>
    <span class="hl-keyword">public</span> MessageSource&lt;File&gt; sftpMessageSource() {
        SftpInboundFileSynchronizingMessageSource source =
                <span class="hl-keyword">new</span> SftpInboundFileSynchronizingMessageSource(sftpInboundFileSynchronizer());
        source.setLocalDirectory(<span class="hl-keyword">new</span> File(<span class="hl-string">"sftp-inbound"</span>));
        source.setAutoCreateLocalDirectory(true);
        source.setLocalFilter(<span class="hl-keyword">new</span> AcceptOnceFileListFilter&lt;File&gt;());
        source.setMaxFetchSize(<span class="hl-number">1</span>);
        <span class="hl-keyword">return</span> source;
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "sftpChannel")</span></em>
    <span class="hl-keyword">public</span> MessageHandler handler() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> MessageHandler() {

            <em><span class="hl-annotation" style="color: gray">@Override</span></em>
            <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> handleMessage(Message&lt;?&gt; message) <span class="hl-keyword">throws</span> MessagingException {
                System.out.println(message.getPayload());
            }

        };
    }

}</pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_with_the_java_dsl_21" href="#_configuring_with_the_java_dsl_21"></a>30.6.4&nbsp;Configuring with the Java DSL</h3></div></div></div>

<p>The following Spring Boot application shows an example of how to configure the inbound adapter with the Java DSL:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@SpringBootApplication</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> SftpJavaApplication {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
        <span class="hl-keyword">new</span> SpringApplicationBuilder(SftpJavaApplication.<span class="hl-keyword">class</span>)
            .web(false)
            .run(args);
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> IntegrationFlow sftpInboundFlow() {
        <span class="hl-keyword">return</span> IntegrationFlows
            .from(s -&gt; s.sftp(<span class="hl-keyword">this</span>.sftpSessionFactory)
                    .preserveTimestamp(true)
                    .remoteDirectory(<span class="hl-string">"foo"</span>)
                    .regexFilter(<span class="hl-string">".*\\.txt$"</span>)
                    .localFilenameExpression(<span class="hl-string">"#this.toUpperCase() + '.a'"</span>)
                    .localDirectory(<span class="hl-keyword">new</span> File(<span class="hl-string">"sftp-inbound"</span>)),
                 e -&gt; e.id(<span class="hl-string">"sftpInboundAdapter"</span>)
                    .autoStartup(true)
                    .poller(Pollers.fixedDelay(<span class="hl-number">5000</span>)))
            .handle(m -&gt; System.out.println(m.getPayload()))
            .get();
    }
}</pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="sftp-incomplete" href="#sftp-incomplete"></a>30.6.5&nbsp;Dealing With Incomplete Data</h3></div></div></div>

<p>See <a class="xref" href="#file-incomplete" title="17.1.9&nbsp;Dealing With Incomplete Data">Section&nbsp;17.1.9, &#8220;Dealing With Incomplete Data&#8221;</a>.</p>
<p>The <code class="literal">SftpSystemMarkerFilePresentFileListFilter</code> is provided to filter remote files that don&#8217;t have the corresponding marker file on the remote system.
See the <a class="ulink" href="https://docs.spring.io/spring-integration/api/org/springframework/integration/sftp/filters/SftpSystemMarkerFilePresentFileListFilter.html" target="_top">Javadoc</a> for configuration information.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="sftp-streaming" href="#sftp-streaming"></a>30.7&nbsp;SFTP Streaming Inbound Channel Adapter</h2></div></div></div>

<p>Version 4.3 introduced the streaming inbound channel adapter.
This adapter produces message with payloads of type <code class="literal">InputStream</code>, letting you fetch files without writing to the local file system.
Since the session remains open, the consuming application is responsible for closing the session when the file has been consumed.
The session is provided in the <code class="literal">closeableResource</code> header (<code class="literal">IntegrationMessageHeaderAccessor.CLOSEABLE_RESOURCE</code>).
Standard framework components, such as the <code class="literal">FileSplitter</code> and <code class="literal">StreamTransformer</code>, automatically close the session.
See <a class="xref" href="#file-splitter" title="17.4&nbsp;File Splitter">Section&nbsp;17.4, &#8220;File Splitter&#8221;</a> and <a class="xref" href="#stream-transformer" title="Stream Transformer">the section called &#8220;Stream Transformer&#8221;</a> for more information about these components.
The following example shows how to configure an SFTP streaming inbound channel adapter:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-sftp:inbound-streaming-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"ftpInbound"</span>
            <span class="hl-attribute">channel</span>=<span class="hl-value">"ftpChannel"</span>
            <span class="hl-attribute">session-factory</span>=<span class="hl-value">"sessionFactory"</span>
            <span class="hl-attribute">filename-pattern</span>=<span class="hl-value">"*.txt"</span>
            <span class="hl-attribute">filename-regex</span>=<span class="hl-value">".*\.txt"</span>
            <span class="hl-attribute">filter</span>=<span class="hl-value">"filter"</span>
            <span class="hl-attribute">filter-expression</span>=<span class="hl-value">"@myFilterBean.check(#root)"</span>
            <span class="hl-attribute">remote-file-separator</span>=<span class="hl-value">"/"</span>
            <span class="hl-attribute">comparator</span>=<span class="hl-value">"comparator"</span>
            <span class="hl-attribute">max-fetch-size</span>=<span class="hl-value">"1"</span>
            <span class="hl-attribute">remote-directory-expression</span>=<span class="hl-value">"'foo/bar'"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"1000"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/int-sftp:inbound-streaming-channel-adapter&gt;</span></pre>
</div>
<p>You can use only one of <code class="literal">filename-pattern</code>, <code class="literal">filename-regex</code>, <code class="literal">filter</code>, or <code class="literal">filter-expression</code>.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Starting with version 5.0, by default, the <code class="literal">SftpStreamingMessageSource</code> adapter prevents duplicates for remote files by using <code class="literal">SftpPersistentAcceptOnceFileListFilter</code> based on the in-memory <code class="literal">SimpleMetadataStore</code>.
By default, this filter is also applied together with the filename pattern (or regex) as well.
If you need to allow duplicates, you can use the <code class="literal">AcceptAllFileListFilter</code>.
You can handle any other use cases by using <code class="literal">CompositeFileListFilter</code> (or <code class="literal">ChainFileListFilter</code>).
The Java configuration <a class="link" href="#sftp-streaming-java-config" title="30.7.1&nbsp;Configuring with Java Configuration">shown later</a> shows one technique to remove the remote file after processing, avoiding duplicates.</p>
</td></tr></table></div>
<p>You can use the <code class="literal">max-fetch-size</code> attribute to limit the number of files fetched on each poll when a fetch is necessary.
Set it to <code class="literal">1</code> and use a persistent filter when running in a clustered environment.
See <a class="xref" href="#sftp-max-fetch" title="30.9&nbsp;Inbound Channel Adapters: Controlling Remote File Fetching">Section&nbsp;30.9, &#8220;Inbound Channel Adapters: Controlling Remote File Fetching&#8221;</a> for more information.</p>
<p>The adapter puts the remote directory and the file name in headers (<code class="literal">FileHeaders.REMOTE_DIRECTORY</code> and <code class="literal">FileHeaders.REMOTE_FILE</code>, respectively).
Starting with version 5.0, the <code class="literal">FileHeaders.REMOTE_FILE_INFO</code> header provides additional remote file information (in JSON).
If you set the <code class="literal">fileInfoJson</code> property on the <code class="literal">SftpStreamingMessageSource</code> to <code class="literal">false</code>, the header contains an <code class="literal">SftpFileInfo</code> object.
You can access the <code class="literal">LsEntry</code> object provided by the underlying Jsch library by using the <code class="literal">SftpFileInfo.getFileInfo()</code> method.
The <code class="literal">fileInfoJson</code> property is not available when you use XML configuration, but you can set it by injecting the <code class="literal">SftpStreamingMessageSource</code> into one of your configuration classes.</p>
<p>Starting with version 5.1, the generic type of the <code class="literal">comparator</code> is <code class="literal">LsEntry</code>.
Previously, it was <code class="literal">AbstractFileInfo&lt;LsEntry&gt;</code>.
This is because the sort is now performed earlier in the processing, before filtering and applying <code class="literal">maxFetch</code>.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="sftp-streaming-java-config" href="#sftp-streaming-java-config"></a>30.7.1&nbsp;Configuring with Java Configuration</h3></div></div></div>

<p>The following Spring Boot application shows an example of how to configure the inbound adapter with Java:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@SpringBootApplication</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> SftpJavaApplication {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
        <span class="hl-keyword">new</span> SpringApplicationBuilder(SftpJavaApplication.<span class="hl-keyword">class</span>)
            .web(false)
            .run(args);
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <em><span class="hl-annotation" style="color: gray">@InboundChannelAdapter(channel = "stream")</span></em>
    <span class="hl-keyword">public</span> MessageSource&lt;InputStream&gt; ftpMessageSource() {
        SftpStreamingMessageSource messageSource = <span class="hl-keyword">new</span> SftpStreamingMessageSource(template());
        messageSource.setRemoteDirectory(<span class="hl-string">"sftpSource/"</span>);
        messageSource.setFilter(<span class="hl-keyword">new</span> AcceptAllFileListFilter&lt;&gt;());
        messageSource.setMaxFetchSize(<span class="hl-number">1</span>);
        <span class="hl-keyword">return</span> messageSource;
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <em><span class="hl-annotation" style="color: gray">@Transformer(inputChannel = "stream", outputChannel = "data")</span></em>
    <span class="hl-keyword">public</span> org.springframework.integration.transformer.Transformer transformer() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> StreamTransformer(<span class="hl-string">"UTF-8"</span>);
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> SftpRemoteFileTemplate template() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> SftpRemoteFileTemplate(sftpSessionFactory());
    }

    <em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "data", adviceChain = "after")</span></em>
    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> MessageHandler handle() {
        <span class="hl-keyword">return</span> System.out::println;
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> ExpressionEvaluatingRequestHandlerAdvice after() {
        ExpressionEvaluatingRequestHandlerAdvice advice = <span class="hl-keyword">new</span> ExpressionEvaluatingRequestHandlerAdvice();
        advice.setOnSuccessExpression(
                <span class="hl-string">"@template.remove(headers['file_remoteDirectory'] + headers['file_remoteFile'])"</span>);
        advice.setPropagateEvaluationFailures(true);
        <span class="hl-keyword">return</span> advice;
    }

}</pre>
</div>
<p>Notice that, in this example, the message handler downstream of the transformer has an advice that removes the remote file after processing.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="sftp-rotating-server-advice" href="#sftp-rotating-server-advice"></a>30.8&nbsp;Inbound Channel Adapters: Polling Multiple Servers and Directories</h2></div></div></div>

<p>Starting with <span class="emphasis"><em>version 5.0.7</em></span>, the <code class="literal">RotatingServerAdvice</code> is available; when configured as a poller advice, the inbound adapters can poll multiple servers and directories.
Configure the advice and add it to the poller&#8217;s advice chain as normal.
A <code class="literal">DelegatingSessionFactory</code> is used to select the server see <a class="xref" href="#ftp-dsf" title="18.3&nbsp;Delegating Session Factory">Section&nbsp;18.3, &#8220;Delegating Session Factory&#8221;</a> for more information.
The advice configuration consists of a list of <code class="literal">RotatingServerAdvice.KeyDirectory</code> objects.</p>
<p>
<b>Example.&nbsp;</b>

</p><pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> RotatingServerAdvice advice() {
    List&lt;KeyDirectory&gt; keyDirectories = <span class="hl-keyword">new</span> ArrayList&lt;&gt;();
    keyDirectories.add(<span class="hl-keyword">new</span> KeyDirectory(<span class="hl-string">"one"</span>, <span class="hl-string">"foo"</span>));
    keyDirectories.add(<span class="hl-keyword">new</span> KeyDirectory(<span class="hl-string">"one"</span>, <span class="hl-string">"bar"</span>));
    keyDirectories.add(<span class="hl-keyword">new</span> KeyDirectory(<span class="hl-string">"two"</span>, <span class="hl-string">"baz"</span>));
    keyDirectories.add(<span class="hl-keyword">new</span> KeyDirectory(<span class="hl-string">"two"</span>, <span class="hl-string">"qux"</span>));
    keyDirectories.add(<span class="hl-keyword">new</span> KeyDirectory(<span class="hl-string">"three"</span>, <span class="hl-string">"fiz"</span>));
    keyDirectories.add(<span class="hl-keyword">new</span> KeyDirectory(<span class="hl-string">"three"</span>, <span class="hl-string">"buz"</span>));
    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> RotatingServerAdvice(delegatingSf(), keyDirectories);
}</pre><p>

</p>
<p>This advice will poll directory <code class="literal">foo</code> on server <code class="literal">one</code> until no new files exist then move to directory <code class="literal">bar</code> and then directory <code class="literal">baz</code> on server <code class="literal">two</code>, etc.</p>
<p>This default behavior can be modified with the <code class="literal">fair</code> constructor arg:</p>
<p>
<b>fair.&nbsp;</b>

</p><pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> RotatingServerAdvice advice() {
    ...
    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> RotatingServerAdvice(delegatingSf(), keyDirectories, true);
}</pre><p>

</p>
<p>In this case, the advice will move to the next server/directory regardless of whether the previous poll returned a file.</p>
<p>Alternatively, you can provide your own <code class="literal">RotatingServerAdvice.RotationPolicy</code> to reconfigure the message source as needed:</p>
<p>
<b>policy.&nbsp;</b>

</p><pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> RotationPolicy {

    <span class="hl-keyword">void</span> beforeReceive(MessageSource&lt;?&gt; source);

    <span class="hl-keyword">void</span> afterReceive(<span class="hl-keyword">boolean</span> messageReceived, MessageSource&lt;?&gt; source);

}</pre><p>

</p>
<p>and</p>
<p>
<b>custom.&nbsp;</b>

</p><pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> RotatingServerAdvice advice() {
    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> RotatingServerAdvice(myRotationPolicy());
}</pre><p>

</p>
<p>The <code class="literal">local-filename-generator-expression</code> attribute (<code class="literal">localFilenameGeneratorExpression</code> on the synchronizer) can now contain the <code class="literal">#remoteDirectory</code> variable.
This allows files retrieved from different directories to be downloaded to similar directories locally:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> IntegrationFlow flow() {
    <span class="hl-keyword">return</span> IntegrationFlows.from(Ftp.inboundAdapter(sf())
                    .filter(<span class="hl-keyword">new</span> FtpPersistentAcceptOnceFileListFilter(<span class="hl-keyword">new</span> SimpleMetadataStore(), <span class="hl-string">"rotate"</span>))
                    .localDirectory(<span class="hl-keyword">new</span> File(tmpDir))
                    .localFilenameExpression(<span class="hl-string">"#remoteDirectory + T(java.io.File).separator + #root"</span>)
                    .remoteDirectory(<span class="hl-string">"."</span>),
                e -&gt; e.poller(Pollers.fixedDelay(<span class="hl-number">1</span>).advice(advice())))
            .channel(MessageChannels.queue(<span class="hl-string">"files"</span>))
            .get();
}</pre>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Do not configure a <code class="literal">TaskExecutor</code> on the poller when using this advice; see <a class="xref" href="#conditional-pollers" title="6.2.4&nbsp;Conditional Pollers for Message Sources">Section&nbsp;6.2.4, &#8220;Conditional Pollers for Message Sources&#8221;</a> for more information.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="sftp-max-fetch" href="#sftp-max-fetch"></a>30.9&nbsp;Inbound Channel Adapters: Controlling Remote File Fetching</h2></div></div></div>

<p>You should consider two properties when configuring inbound channel adapters.
<code class="literal">max-messages-per-poll</code>, as with all pollers, can be used to limit the number of messages emitted on each poll (if more than the configured value are ready).
<code class="literal">max-fetch-size</code> (since version 5.0) can limit the number of files retrieved from the remote server at a time.</p>
<p>The following scenarios assume the starting state is an empty local directory:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">max-messages-per-poll=2</code> and <code class="literal">max-fetch-size=1</code>: The adapter fetches one file, emits it, fetches the next file, and emit it.
Then it sleeps until the next poll.
</li><li class="listitem">
<code class="literal">max-messages-per-poll=2</code> and <code class="literal">max-fetch-size=2</code>): The adapter fetch both files and then emits each one.
</li><li class="listitem">
<code class="literal">max-messages-per-poll=2</code> and <code class="literal">max-fetch-size=4</code>: The adapter fetches up to 4 files (if available) and emits the first two (if there are at least two).
The next two files will be emitted on the next poll.
</li><li class="listitem">
<code class="literal">max-messages-per-poll=2</code> and <code class="literal">max-fetch-size</code> not specified: The adapter fetches all remote files and emits the first two (if there are at least two).
The subsequent files are emitted on subsequent polls (two at a time).
When all are consumed, the remote fetch is attempted again, to pick up any new files.
</li></ul></div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>When you deploy multiple instances of an application, we recommend setting a small <code class="literal">max-fetch-size</code>, to avoid one instance "<code class="literal">grabbing</code>" all the files and starving other instances.</p>
</td></tr></table></div>
<p>Another use for <code class="literal">max-fetch-size</code> is when you want to stop fetching remote files but continue to process files that have already been fetched.
Setting the <code class="literal">maxFetchSize</code> property on the <code class="literal">MessageSource</code> (programmatically, via JMX, or via a <a class="link" href="#control-bus" title="12.6&nbsp;Control Bus">control bus</a>) effectively stops the adapter from fetching more files but lets the poller continue to emit messages for files that have previously been fetched.
If the poller is active when the property is changed, the change takes effect on the next poll.</p>
<p>Starting with version 5.1, the synchronizer can be provided with a <code class="literal">Comparator&lt;LsEntry&gt;</code>.
This is useful when restricting the number of files fetched with <code class="literal">maxFetchSize</code>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="sftp-outbound" href="#sftp-outbound"></a>30.10&nbsp;SFTP Outbound Channel Adapter</h2></div></div></div>

<p>The SFTP outbound channel adapter is a special <code class="literal">MessageHandler</code> that connects to the remote directory and initiates a file transfer for every file it receives as the payload of an incoming <code class="literal">Message</code>.
It also supports several representations of the file so that you are not limited to the <code class="literal">File</code> object.
Similar to the FTP outbound adapter, the SFTP outbound channel adapter supports the following payloads:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">java.io.File</code>: The actual file object
</li><li class="listitem">
<code class="literal">byte[]</code>: A byte array that represents the file contents
</li><li class="listitem">
<code class="literal">java.lang.String</code>: Text that represents the file contents
</li></ul></div>
<p>The following example shows how to configure an SFTP outbound channel adapter:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-sftp:outbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"sftpOutboundAdapter"</span>
    <span class="hl-attribute">session-factory</span>=<span class="hl-value">"sftpSessionFactory"</span>
    <span class="hl-attribute">channel</span>=<span class="hl-value">"inputChannel"</span>
    <span class="hl-attribute">charset</span>=<span class="hl-value">"UTF-8"</span>
    <span class="hl-attribute">remote-file-separator</span>=<span class="hl-value">"/"</span>
    <span class="hl-attribute">remote-directory</span>=<span class="hl-value">"foo/bar"</span>
    <span class="hl-attribute">remote-filename-generator-expression</span>=<span class="hl-value">"payload.getName() + '-mysuffix'"</span>
    <span class="hl-attribute">filename-generator</span>=<span class="hl-value">"fileNameGenerator"</span>
    <span class="hl-attribute">use-temporary-filename</span>=<span class="hl-value">"true"</span>
    <span class="hl-attribute">chmod</span>=<span class="hl-value">"600"</span>
    <span class="hl-attribute">mode</span>=<span class="hl-value">"REPLACE"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>See the <a class="ulink" href="https://github.com/spring-projects/spring-integration/tree/master/spring-integration-core/src/main/resources/org/springframework/integration/config" target="_top">schema</a> for more detail on these attributes.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_spel_and_the_sftp_outbound_adapter" href="#_spel_and_the_sftp_outbound_adapter"></a>30.10.1&nbsp;SpEL and the SFTP Outbound Adapter</h3></div></div></div>

<p>As with many other components in Spring Integration, you can use the Spring Expression Language (SpEL) when you configure an SFTP outbound channel adapter by specifying two attributes: <code class="literal">remote-directory-expression</code> and <code class="literal">remote-filename-generator-expression</code> (<a class="link" href="#sftp-inbound" title="30.6&nbsp;SFTP Inbound Channel Adapter">described earlier</a>).
The expression evaluation context has the message as its root object, which lets you use expressions that can dynamically compute the file name or the existing directory path based on the data in the message (from either the <span class="emphasis"><em>payload</em></span> or the <span class="emphasis"><em>headers</em></span>).
In the preceding example, we define the <code class="literal">remote-filename-generator-expression</code> attribute with an expression value that computes the file name based on its original name while also appending a suffix: <span class="emphasis"><em>-mysuffix</em></span>.</p>
<p>Starting with version 4.1, you can specify the <code class="literal">mode</code> when you transferring the file.
By default, an existing file is overwritten.
The modes are defined by the <code class="literal">FileExistsMode</code> enumeration, which has the following values: <code class="literal">REPLACE</code> (default), <code class="literal">APPEND</code>, <code class="literal">IGNORE</code>, and <code class="literal">FAIL</code>.
With <code class="literal">IGNORE</code> and <code class="literal">FAIL</code>, the file is not transferred.
<code class="literal">FAIL</code> causes an exception to be thrown, while <code class="literal">IGNORE</code> silently ignores the transfer (although a <code class="literal">DEBUG</code> log entry is produced).</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_avoiding_partially_written_files_2" href="#_avoiding_partially_written_files_2"></a>30.10.2&nbsp;Avoiding Partially Written Files</h3></div></div></div>

<p>One of the common problems when dealing with file transfers is the possibility of processing a partial file.
A file might appear in the file system before its transfer is actually complete.</p>
<p>To deal with this issue, Spring Integration SFTP adapters use a common algorithm in which files are transferred under a temporary name and than renamed once they are fully transferred.</p>
<p>By default, every file that is in the process of being transferred appear in the file system with an additional suffix, which, by default, is <code class="literal">.writing</code>.
You can change by setting the <code class="literal">temporary-file-suffix</code> attribute.</p>
<p>However, there may be situations where you do not want to use this technique (for example, if the server does not permit renaming files).
For situations like this, you can disable this feature by setting <code class="literal">use-temporary-file-name</code> to <code class="literal">false</code> (the default is <code class="literal">true</code>).
When this attribute is <code class="literal">false</code>, the file is written with its final name, and the consuming application needs some other mechanism to detect that the file is completely uploaded before accessing it.</p>
<p>Version 4.3 introduced the <code class="literal">chmod</code> attribute, which you can use to change the remote file permissions after upload.
You can use the conventional Unix octal format (for example, <code class="literal">600</code> allows read-write for the file owner only).
When configuring the adapter using java, you can use <code class="literal">setChmodOctal("600")</code> or <code class="literal">setChmodDecimal(384)</code>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_with_java_configuration_22" href="#_configuring_with_java_configuration_22"></a>30.10.3&nbsp;Configuring with Java Configuration</h3></div></div></div>

<p>The following Spring Boot application shows an example of how to configure the outbound adapter with Java:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@SpringBootApplication</span></em>
<em><span class="hl-annotation" style="color: gray">@IntegrationComponentScan</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> SftpJavaApplication {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
        ConfigurableApplicationContext context =
                    <span class="hl-keyword">new</span> SpringApplicationBuilder(SftpJavaApplication.<span class="hl-keyword">class</span>)
                        .web(false)
                        .run(args);
        MyGateway gateway = context.getBean(MyGateway.<span class="hl-keyword">class</span>);
        gateway.sendToSftp(<span class="hl-keyword">new</span> File(<span class="hl-string">"/foo/bar.txt"</span>));
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> SessionFactory&lt;LsEntry&gt; sftpSessionFactory() {
        DefaultSftpSessionFactory factory = <span class="hl-keyword">new</span> DefaultSftpSessionFactory(true);
        factory.setHost(<span class="hl-string">"localhost"</span>);
        factory.setPort(port);
        factory.setUser(<span class="hl-string">"foo"</span>);
        factory.setPassword(<span class="hl-string">"foo"</span>);
        factory.setAllowUnknownKeys(true);
        factory.setTestSession(true);
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> CachingSessionFactory&lt;LsEntry&gt;(factory);
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "toSftpChannel")</span></em>
    <span class="hl-keyword">public</span> MessageHandler handler() {
        SftpMessageHandler handler = <span class="hl-keyword">new</span> SftpMessageHandler(sftpSessionFactory());
        handler.setRemoteDirectoryExpressionString(<span class="hl-string">"headers['remote-target-dir']"</span>);
        handler.setFileNameGenerator(<span class="hl-keyword">new</span> FileNameGenerator() {

            <em><span class="hl-annotation" style="color: gray">@Override</span></em>
            <span class="hl-keyword">public</span> String generateFileName(Message&lt;?&gt; message) {
                 <span class="hl-keyword">return</span> <span class="hl-string">"handlerContent.test"</span>;
            }

        });
        <span class="hl-keyword">return</span> handler;
    }

    <em><span class="hl-annotation" style="color: gray">@MessagingGateway</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> MyGateway {

         <em><span class="hl-annotation" style="color: gray">@Gateway(requestChannel = "toSftpChannel")</span></em>
         <span class="hl-keyword">void</span> sendToSftp(File file);

    }
}</pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_with_the_java_dsl_22" href="#_configuring_with_the_java_dsl_22"></a>30.10.4&nbsp;Configuring with the Java DSL</h3></div></div></div>

<p>The following Spring Boot application shows an example of how to configure the outbound adapter with the Java DSL:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@SpringBootApplication</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> SftpJavaApplication {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
        <span class="hl-keyword">new</span> SpringApplicationBuilder(SftpJavaApplication.<span class="hl-keyword">class</span>)
            .web(false)
            .run(args);
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> IntegrationFlow sftpOutboundFlow() {
        <span class="hl-keyword">return</span> IntegrationFlows.from(<span class="hl-string">"toSftpChannel"</span>)
            .handle(Sftp.outboundAdapter(<span class="hl-keyword">this</span>.sftpSessionFactory, FileExistsMode.FAIL)
                         .useTemporaryFileName(false)
                         .remoteDirectory(<span class="hl-string">"/foo"</span>)
            ).get();
    }

}</pre>
</div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="sftp-outbound-gateway" href="#sftp-outbound-gateway"></a>30.11&nbsp;SFTP Outbound Gateway</h2></div></div></div>

<p>The SFTP outbound gateway provides a limited set of commands that let you interact with a remote SFTP server:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">ls</code> (list files)
</li><li class="listitem">
<code class="literal">nlst</code> (list file names)
</li><li class="listitem">
<code class="literal">get</code> (retrieve a file)
</li><li class="listitem">
<code class="literal">mget</code> (retrieve multiple files)
</li><li class="listitem">
<code class="literal">rm</code> (remove file(s))
</li><li class="listitem">
<code class="literal">mv</code> (move and rename file)
</li><li class="listitem">
<code class="literal">put</code> (send a file)
</li><li class="listitem">
<code class="literal">mput</code> (send multiple files)
</li></ul></div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_using_the_literal_ls_literal_command" href="#_using_the_literal_ls_literal_command"></a>30.11.1&nbsp;Using the <code class="literal">ls</code> Command</h3></div></div></div>

<p><code class="literal">ls</code> lists remote files and supports the following options:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">-1</code>: Retrieve a list of filenames.
The default is to retrieve a list of <code class="literal">FileInfo</code> objects
</li><li class="listitem">
<code class="literal">-a</code>: Include all files (including those starting with <span class="emphasis"><em>.</em></span>)
</li><li class="listitem">
<code class="literal">-f</code>: Do not sort the list
</li><li class="listitem">
<code class="literal">-dirs</code>: Include directories (excluded by default)
</li><li class="listitem">
<code class="literal">-links</code>: Include symbolic links (excluded by default)
</li><li class="listitem">
<code class="literal">-R</code>: List the remote directory recursively
</li></ul></div>
<p>In addition, filename filtering is provided in the same manner as the <code class="literal">inbound-channel-adapter</code>.</p>
<p>The message payload resulting from an <code class="literal">ls</code> operation is a list of file names or a list of <code class="literal">FileInfo</code> objects (depending on whether you usr the <code class="literal">-1</code> switch).
These objects provide information such as modified time, permissions, and others.</p>
<p>The remote directory that the <code class="literal">ls</code> command acted on is provided in the <code class="literal">file_remoteDirectory</code> header.</p>
<p>When using the recursive option (<code class="literal">-R</code>), the <code class="literal">fileName</code> includes any subdirectory elements and represents the relative path to the file (relative to the remote directory).
If you use the <code class="literal">-dirs</code> option, each recursive directory is also returned as an element in the list.
In this case, we recommend that you not use the <code class="literal">-1</code> option, because you would not be able to distinguish files from directories, which you can do when you use <code class="literal">FileInfo</code> objects.</p>
<p>Using <code class="literal">nlst</code> Command</p>
<p>Version 5 introduced support for the <code class="literal">nlst</code> command.</p>
<p><code class="literal">nlst</code> lists remote file names and supports only one option:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">-f</code>: Do not sort the list
</li></ul></div>
<p>The message payload resulting from an <code class="literal">nlst</code> operation is a list of file names.</p>
<p>The <code class="literal">file_remoteDirectory</code> header holds the remote directory on which the <code class="literal">nlst</code> command acted.</p>
<p>The SFTP protocol does not provide the ability to list names.
This command is the equivalent of the <code class="literal">ls</code> command with the <code class="literal">-1</code> option and is added here for convenience.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_using_the_literal_get_literal_command_2" href="#_using_the_literal_get_literal_command_2"></a>30.11.2&nbsp;Using the <code class="literal">get</code> Command</h3></div></div></div>

<p><code class="literal">get</code> retrieves a remote file and supports the following options:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">-P</code>: Preserve the timestamp of the remote file.
</li><li class="listitem">
<code class="literal">-stream</code>: Retrieve the remote file as a stream.
</li><li class="listitem">
<code class="literal">-D</code>: Delete the remote file after successful transfer.
The remote file is not deleted if the transfer is ignored, because the <code class="literal">FileExistsMode</code> is <code class="literal">IGNORE</code> and the local file already exists.
</li></ul></div>
<p>The <code class="literal">file_remoteDirectory</code> header holds the remote directory, and the <code class="literal">file_remoteFile</code> header holds the filename.</p>
<p>The message payload resulting from a <code class="literal">get</code> operation is a <code class="literal">File</code> object representing the retrieved file.
If you use the <code class="literal">-stream</code> option, the payload is an <code class="literal">InputStream</code> rather than a <code class="literal">File</code>.
For text files, a common use case is to combine this operation with a <a class="link" href="#file-splitter" title="17.4&nbsp;File Splitter">file splitter</a> or a
<a class="link" href="#stream-transformer" title="Stream Transformer">stream transformer</a>.
When consuming remote files as streams, you are responsible for closing the <code class="literal">Session</code> after the stream is consumed.
For convenience, the <code class="literal">Session</code> is provided in the <code class="literal">closeableResource</code> header, and <code class="literal">IntegrationMessageHeaderAccessor</code> offers convenience method:</p>
<div class="informalexample">
<pre class="programlisting">Closeable closeable = <span class="hl-keyword">new</span> IntegrationMessageHeaderAccessor(message).getCloseableResource();
<span class="hl-keyword">if</span> (closeable != null) {
    closeable.close();
}</pre>
</div>
<p>Framework components, such as the <a class="link" href="#file-splitter" title="17.4&nbsp;File Splitter">File Splitter</a> and <a class="link" href="#stream-transformer" title="Stream Transformer">Stream Transformer</a>,
automatically close the session after the data is transferred.</p>
<p>The following example shows how to consume a file as a stream:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-sftp:outbound-gateway</span> <span class="hl-attribute">session-factory</span>=<span class="hl-value">"ftpSessionFactory"</span>
                            <span class="hl-attribute">request-channel</span>=<span class="hl-value">"inboundGetStream"</span>
                            <span class="hl-attribute">command</span>=<span class="hl-value">"get"</span>
                            <span class="hl-attribute">command-options</span>=<span class="hl-value">"-stream"</span>
                            <span class="hl-attribute">expression</span>=<span class="hl-value">"payload"</span>
                            <span class="hl-attribute">remote-directory</span>=<span class="hl-value">"ftpTarget"</span>
                            <span class="hl-attribute">reply-channel</span>=<span class="hl-value">"stream"</span><span class="hl-tag"> /&gt;</span>

<span class="hl-tag">&lt;int-file:splitter</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"stream"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"lines"</span><span class="hl-tag"> /&gt;</span></pre>
</div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>If you consume the input stream in a custom component, you must close the <code class="literal">Session</code>.
You can either do that in your custom code or route a copy of the message to a <code class="literal">service-activator</code> and use SpEL, as the following example shows:</p>
</td></tr></table></div>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:service-activator</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"closeSession"</span>
    <span class="hl-attribute">expression</span>=<span class="hl-value">"headers['closeableResource'].close()"</span><span class="hl-tag"> /&gt;</span></pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_using_the_literal_mget_literal_command_2" href="#_using_the_literal_mget_literal_command_2"></a>30.11.3&nbsp;Using the <code class="literal">mget</code> Command</h3></div></div></div>

<p><code class="literal">mget</code> retrieves multiple remote files based on a pattern and supports the following options:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">-P</code>: Preserve the timestamps of the remote files.
</li><li class="listitem">
<code class="literal">-R</code>: Retrieve the entire directory tree recursively.
</li><li class="listitem">
<code class="literal">-x</code>: Throw an exception if no files match the pattern (otherwise, an empty list is returned).
</li><li class="listitem">
<code class="literal">-D</code>: Delete each remote file after successful transfer.
If the transfer is ignored, the remote file is not deleted, because the <code class="literal">FileExistsMode</code> is <code class="literal">IGNORE</code> and the local file already exists.
</li></ul></div>
<p>The message payload resulting from an <code class="literal">mget</code> operation is a <code class="literal">List&lt;File&gt;</code> object (that is, a <code class="literal">List</code> of <code class="literal">File</code> objects, each representing a retrieved file).</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Starting with version 5.0, if the <code class="literal">FileExistsMode</code> is <code class="literal">IGNORE</code>, the payload of the output message no longer contain files that were not fetched due to the file already existing.
Previously, the array contained all files, including those that already existed.</p>
</td></tr></table></div>
<p>The expression you use determine the remote path should produce a result that ends with <code class="literal">*</code> for example <code class="literal">myfiles/*</code> fetches the complete tree under <code class="literal">myfiles</code>.</p>
<p>Starting with version 5.0, you can use a recursive <code class="literal">MGET</code>, combined with the <code class="literal">FileExistsMode.REPLACE_IF_MODIFIED</code> mode, to periodically synchronize an entire remote directory tree locally.
This mode sets the local file&#8217;s last modified timestamp to the remote file&#8217;s timestamp, regardless of the <code class="literal">-P</code> (preserve timestamp) option.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important: Notes for when using recursion (-R)"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Notes for when using recursion (<code class="literal">-R</code>)</th></tr><tr><td align="left" valign="top">

<p>The pattern is ignored and <code class="literal">*</code> is assumed.
By default, the entire remote tree is retrieved.
However, you can filter files in the tree by providing a <code class="literal">FileListFilter</code>.
You can also filter directories in the tree this way.
A <code class="literal">FileListFilter</code> can be provided by reference or by <code class="literal">filename-pattern</code> or <code class="literal">filename-regex</code> attributes.
For example, <code class="literal">filename-regex="(subDir|.*1.txt)"</code> retrieves all files ending with <code class="literal">1.txt</code> in the remote directory and the subdirectory <code class="literal">subDir</code>.
However, we describe an alternative available after this note.</p>
<p>If you filter a subdirectory, no additional traversal of that subdirectory is performed.</p>
<p>The <code class="literal">-dirs</code> option is not allowed (the recursive <code class="literal">mget</code> uses the recursive <code class="literal">ls</code> to obtain the directory tree and the directories themselves cannot be included in the list).</p>
<p>Typically, you would use the <code class="literal">#remoteDirectory</code> variable in the <code class="literal">local-directory-expression</code> so that the remote directory structure is retained locally.</p>
</td></tr></table></div>
<p>Starting with version 5.0, you can configure the <code class="literal">SftpSimplePatternFileListFilter</code> and <code class="literal">SftpRegexPatternFileListFilter</code> to always pass directories by setting the <code class="literal">alwaysAcceptDirectorties</code> to <code class="literal">true</code>.
Doing so allows recursion for a simple pattern, as the following examples show:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"starDotTxtFilter"</span>
            <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.sftp.filters.SftpSimplePatternFileListFilter"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"*.txt"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"alwaysAcceptDirectories"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"true"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"dotStarDotTxtFilter"</span>
            <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.sftp.filters.SftpRegexPatternFileListFilter"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"^.*\.txt$"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"alwaysAcceptDirectories"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"true"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
</div>
<p>You can provide one of these filters by using the <code class="literal">filter</code> property on the gateway.</p>
<p>See also <a class="xref" href="#sftp-partial" title="30.11.10&nbsp;Outbound Gateway Partial Success (mget and mput)">Section&nbsp;30.11.10, &#8220;Outbound Gateway Partial Success (<code class="literal">mget</code> and <code class="literal">mput</code>)&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="sftp-put-command" href="#sftp-put-command"></a>30.11.4&nbsp;Using the <code class="literal">put</code> Command</h3></div></div></div>

<p><code class="literal">put</code> sends a file to the remote server.
The payload of the message can be a <code class="literal">java.io.File</code>, a <code class="literal">byte[]</code>, or a <code class="literal">String</code>.
A <code class="literal">remote-filename-generator</code> (or expression) is used to name the remote file.
Other available attributes include <code class="literal">remote-directory</code>, <code class="literal">temporary-remote-directory</code> and their <code class="literal">*-expression</code> equivalents: <code class="literal">use-temporary-file-name</code> and <code class="literal">auto-create-directory</code>.
See the <a class="ulink" href="https://github.com/spring-projects/spring-integration/tree/master/spring-integration-core/src/main/resources/org/springframework/integration/config" target="_top">schema documentation</a> for more information.</p>
<p>The message payload resulting from a <code class="literal">put</code> operation is a <code class="literal">String</code> that contains the full path of the file on the server after transfer.</p>
<p>Version 4.3 introduced the <code class="literal">chmod</code> attribute, which changes the remote file permissions after upload.
You can use the conventional Unix octal format (for example, <code class="literal">600</code> allows read-write for the file owner only).
When configuring the adapter using java, you can use <code class="literal">setChmod(0600)</code>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_using_the_literal_mput_literal_command" href="#_using_the_literal_mput_literal_command"></a>30.11.5&nbsp;Using the <code class="literal">mput</code> Command</h3></div></div></div>

<p><code class="literal">mput</code> sends multiple files to the server and supports the following option:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">-R</code>: Recursive&#8201;&#8212;&#8201;send all files (possibly filtered) in the directory and subdirectories
</li></ul></div>
<p>The message payload must be a <code class="literal">java.io.File</code> (or <code class="literal">String</code>) that represents a local directory.
Since version 5.1, a collection of <code class="literal">File</code> or <code class="literal">String</code> is also supported.</p>
<p>The same attributes as the <a class="link" href="#sftp-put-command" title="30.11.4&nbsp;Using the put Command"><code class="literal">put</code> command</a> are supported.
In addition, you can filter files in the local directory with one of <code class="literal">mput-pattern</code>, <code class="literal">mput-regex</code>, <code class="literal">mput-filter</code>, or <code class="literal">mput-filter-expression</code>.
The filter works with recursion, as long as the subdirectories themselves pass the filter.
Subdirectories that do not pass the filter are not recursed.</p>
<p>The message payload resulting from an <code class="literal">mget</code> operation is a <code class="literal">List&lt;String&gt;</code> object (that is, a <code class="literal">List</code> of remote file paths resulting from the transfer).</p>
<p>See also <a class="xref" href="#sftp-partial" title="30.11.10&nbsp;Outbound Gateway Partial Success (mget and mput)">Section&nbsp;30.11.10, &#8220;Outbound Gateway Partial Success (<code class="literal">mget</code> and <code class="literal">mput</code>)&#8221;</a>.</p>
<p>Version 4.3 introduced the <code class="literal">chmod</code> attribute, which lets you change the remote file permissions after upload.
You can use the conventional Unix octal format (for example, <code class="literal">600</code> allows read-write for the file owner only).
When configuring the adapter with Java, you can use <code class="literal">setChmodOctal("600")</code> or <code class="literal">setChmodDecimal(384)</code>.</p>
<p>Using the <code class="literal">rm</code> Command</p>
<p>The <code class="literal">rm</code> command has no options.</p>
<p>If the remove operation was successful, the resulting message payload is <code class="literal">Boolean.TRUE</code>. Otherwise, the message payload is <code class="literal">Boolean.FALSE</code>.
The <code class="literal">file_remoteDirectory</code> header holds the remote directory, and the <code class="literal">file_remoteFile</code> header holds the file name.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_using_the_literal_mv_literal_command_2" href="#_using_the_literal_mv_literal_command_2"></a>30.11.6&nbsp;Using the <code class="literal">mv</code> Command</h3></div></div></div>

<p>The <code class="literal">mv</code> command has no options.</p>
<p>The <code class="literal">expression</code> attribute defines the "<code class="literal">from</code>" path, and the <code class="literal">rename-expression</code> attribute defines the "<code class="literal">to</code>" path.
By default, the <code class="literal">rename-expression</code> is <code class="literal">headers['file_renameTo']</code>.
This expression must not evaluate to null or an empty <code class="literal">String</code>.
If necessary, any remote directories needed are created.
The payload of the result message is <code class="literal">Boolean.TRUE</code>.
The the <code class="literal">file_remoteDirectory</code> header holds the original remote directory, and the <code class="literal">file_remoteFile</code> header holds the filename.
The <code class="literal">file_renameTo</code> header holds the new path.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_additional_command_information" href="#_additional_command_information"></a>30.11.7&nbsp;Additional Command Information</h3></div></div></div>

<p>The <code class="literal">get</code> and <code class="literal">mget</code> commands support the <code class="literal">local-filename-generator-expression</code> attribute.
It defines a SpEL expression to generate the names of local files during the transfer.
The root object of the evaluation context is the request message.
The <code class="literal">remoteFileName</code> variable is also available.
It is particularly useful for <code class="literal">mget</code> (for example: <code class="literal">local-filename-generator-expression="#remoteFileName.toUpperCase() + headers.foo"</code>).</p>
<p>The <code class="literal">get</code> and <code class="literal">mget</code> commands support the <code class="literal">local-directory-expression</code> attribute.
It defines a SpEL expression to generate the names of local directories during the transfer.
The root object of the evaluation context is the request message.
The <code class="literal">remoteDirectory</code> variable is also available.
It is particularly useful for mget (for example: <code class="literal">local-directory-expression="'/tmp/local/' + #remoteDirectory.toUpperCase() + headers.myheader"</code>).
This attribute is mutually exclusive with the <code class="literal">local-directory</code> attribute.</p>
<p>For all commands, the <span class="emphasis"><em>expression</em></span> property of the gateway holds the path on which the command acts.
For the <code class="literal">mget</code> command, the expression might evaluate to <span class="emphasis"><em><span class="strong"><strong></strong></span>, meaning to retrieve all files, <span class="emphasis"><em>somedirectory/</em></span></em></span>, and other values that end with <code class="literal">*</code>.</p>
<p>The following example shows a gateway configured for an <code class="literal">ls</code> command:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-ftp:outbound-gateway</span> <span class="hl-attribute">id</span>=<span class="hl-value">"gateway1"</span>
        <span class="hl-attribute">session-factory</span>=<span class="hl-value">"ftpSessionFactory"</span>
        <span class="hl-attribute">request-channel</span>=<span class="hl-value">"inbound1"</span>
        <span class="hl-attribute">command</span>=<span class="hl-value">"ls"</span>
        <span class="hl-attribute">command-options</span>=<span class="hl-value">"-1"</span>
        <span class="hl-attribute">expression</span>=<span class="hl-value">"payload"</span>
        <span class="hl-attribute">reply-channel</span>=<span class="hl-value">"toSplitter"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>The payload of the message sent to the <code class="literal">toSplitter</code> channel is a list of <code class="literal">String</code> objects, each of which contains the name of a file.
If you omitted <code class="literal">command-options="-1"</code>, the payload would be a list of <code class="literal">FileInfo</code> objects.
You can provide options as a space-delimited list (for example, <code class="literal">command-options="-1 -dirs -links"</code>).</p>
<p>Starting with version 4.2, the <code class="literal">GET</code>, <code class="literal">MGET</code>, <code class="literal">PUT</code>, and <code class="literal">MPUT</code> commands support a <code class="literal">FileExistsMode</code> property (<code class="literal">mode</code>
when using the namespace support). This affects the behavior when the local file exists (<code class="literal">GET</code> and <code class="literal">MGET</code>) or the remote
file exists (<code class="literal">PUT</code> and <code class="literal">MPUT</code>). The supported modes are <code class="literal">REPLACE</code>, <code class="literal">APPEND</code>, <code class="literal">FAIL</code>, and <code class="literal">IGNORE</code>.
For backwards compatibility, the default mode for <code class="literal">PUT</code> and <code class="literal">MPUT</code> operations is <code class="literal">REPLACE</code>. For <code class="literal">GET</code> and <code class="literal">MGET</code>
operations, the default is <code class="literal">FAIL</code>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_with_java_configuration_23" href="#_configuring_with_java_configuration_23"></a>30.11.8&nbsp;Configuring with Java Configuration</h3></div></div></div>

<p>The following Spring Boot application shows an example of how to configure the outbound gateway with Java:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@SpringBootApplication</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> SftpJavaApplication {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
        <span class="hl-keyword">new</span> SpringApplicationBuilder(SftpJavaApplication.<span class="hl-keyword">class</span>)
            .web(false)
            .run(args);
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "sftpChannel")</span></em>
    <span class="hl-keyword">public</span> MessageHandler handler() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> SftpOutboundGateway(ftpSessionFactory(), <span class="hl-string">"ls"</span>, <span class="hl-string">"'my_remote_dir/'"</span>);
    }

}</pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuring_with_the_java_dsl_23" href="#_configuring_with_the_java_dsl_23"></a>30.11.9&nbsp;Configuring with the Java DSL</h3></div></div></div>

<p>The following Spring Boot application shows an example of how to configure the outbound gateway with the Java DSL:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@SpringBootApplication</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> SftpJavaApplication {

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
        <span class="hl-keyword">new</span> SpringApplicationBuilder(SftpJavaApplication.<span class="hl-keyword">class</span>)
            .web(false)
            .run(args);
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> SessionFactory&lt;LsEntry&gt; sftpSessionFactory() {
        DefaultFtpSessionFactory sf = <span class="hl-keyword">new</span> DefaultFtpSessionFactory();
        sf.setHost(<span class="hl-string">"localhost"</span>);
        sf.setPort(port);
        sf.setUsername(<span class="hl-string">"foo"</span>);
        sf.setPassword(<span class="hl-string">"foo"</span>);
        factory.setTestSession(true);
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> CachingSessionFactory&lt;LsEntry&gt;(sf);
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> QueueChannelSpec remoteFileOutputChannel() {
        <span class="hl-keyword">return</span> MessageChannels.queue();
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> IntegrationFlow sftpMGetFlow() {
        <span class="hl-keyword">return</span> IntegrationFlows.from(<span class="hl-string">"sftpMgetInputChannel"</span>)
            .handleWithAdapter(h -&gt;
                h.sftpGateway(sftpSessionFactory(), AbstractRemoteFileOutboundGateway.Command.MGET,
                    <span class="hl-string">"payload"</span>)
                    .options(AbstractRemoteFileOutboundGateway.Option.RECURSIVE)
                    .regexFileNameFilter(<span class="hl-string">"(subSftpSource|.*1.txt)"</span>)
                    .localDirectoryExpression(<span class="hl-string">"'myDir/' + #remoteDirectory"</span>)
                    .localFilenameExpression(<span class="hl-string">"#remoteFileName.replaceFirst('sftpSource', 'localTarget')"</span>))
            .channel(<span class="hl-string">"remoteFileOutputChannel"</span>)
            .get();
    }

}</pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="sftp-partial" href="#sftp-partial"></a>30.11.10&nbsp;Outbound Gateway Partial Success (<code class="literal">mget</code> and <code class="literal">mput</code>)</h3></div></div></div>

<p>When performing operations on multiple files (by using <code class="literal">mget</code> and <code class="literal">mput</code>) an exception can occur some time after one or more files have been transferred.
In this case (starting with version 4.2), a <code class="literal">PartialSuccessException</code> is thrown.
As well as the usual <code class="literal">MessagingException</code> properties (<code class="literal">failedMessage</code> and <code class="literal">cause</code>), this exception has two additional
properties:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">partialResults</code>: The successful transfer results.
</li><li class="listitem">
<code class="literal">derivedInput</code>: The list of files generated from the request message (such as local files to transfer for an <code class="literal">mput</code>).
</li></ul></div>
<p>These attributes let you determine which files were successfully transferred and which were not.</p>
<p>In the case of a recursive <code class="literal">mput</code>, the <code class="literal">PartialSuccessException</code> may have nested <code class="literal">PartialSuccessException</code> instances.</p>
<p>Consider the following directory structure:</p>
<div class="informalexample">
<pre class="screen">root/
|- file1.txt
|- subdir/
   | - file2.txt
   | - file3.txt
|- zoo.txt</pre>
</div>
<p>If the exception occurs on <code class="literal">file3.txt</code>, the <code class="literal">PartialSuccessException</code> thrown by the gateway has <code class="literal">derivedInput</code> of <code class="literal">file1.txt</code>, <code class="literal">subdir</code>, and <code class="literal">zoo.txt</code> and <code class="literal">partialResults</code> of <code class="literal">file1.txt</code>.
Its <code class="literal">cause</code> is another <code class="literal">PartialSuccessException</code> with <code class="literal">derivedInput</code> of <code class="literal">file2.txt</code> and <code class="literal">file3.txt</code> and <code class="literal">partialResults</code> of <code class="literal">file2.txt</code>.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="sftp-jsch-logging" href="#sftp-jsch-logging"></a>30.12&nbsp;SFTP/JSCH Logging</h2></div></div></div>

<p>Since we use JSch libraries (<a class="ulink" href="http://www.jcraft.com/jsch/" target="_top">http://www.jcraft.com/jsch/</a>) to provide SFTP support, you may at times require more information from the JSch API itself, especially if something is not working properly (such as authentication exceptions).
Unfortunately JSch does not use <code class="literal">commons-logging</code> but instead relies on custom implementations of their <code class="literal">com.jcraft.jsch.Logger</code> interface.
As of Spring Integration 2.0.1, we have implemented this interface.
So now, to enable JSch logging, you can configure your logger the way you usually do.
For example, the following example is valid configuration of a logger that uses Log4J:</p>
<div class="informalexample">
<pre class="programlisting">log4j.category.com.jcraft.jsch=DEBUG</pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="sftp-session-callback" href="#sftp-session-callback"></a>30.13&nbsp;MessageSessionCallback</h2></div></div></div>

<p>Starting with Spring Integration version 4.2, you can use a <code class="literal">MessageSessionCallback&lt;F, T&gt;</code> implementation with the <code class="literal">&lt;int-sftp:outbound-gateway/&gt;</code> (<code class="literal">SftpOutboundGateway</code>) to perform any operation on the <code class="literal">Session&lt;LsEntry&gt;</code> with the <code class="literal">requestMessage</code> context.
You can use it for any non-standard or low-level FTP operation (or several), such as allowing access from an integration flow definition, or functional interface (lambda) implementation injection.
The following example uses a lambda:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "sftpChannel")</span></em>
<span class="hl-keyword">public</span> MessageHandler sftpOutboundGateway(SessionFactory&lt;ChannelSftp.LsEntry&gt; sessionFactory) {
    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> SftpOutboundGateway(sessionFactory,
         (session, requestMessage) -&gt; session.list(requestMessage.getPayload()));
}</pre>
</div>
<p>Another example might be to pre- or post-process the file data being sent or retrieved.</p>
<p>When using XML configuration, the <code class="literal">&lt;int-sftp:outbound-gateway/&gt;</code> provides a <code class="literal">session-callback</code> attribute that lets you specify the <code class="literal">MessageSessionCallback</code> bean name.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The <code class="literal">session-callback</code> is mutually exclusive with the <code class="literal">command</code> and <code class="literal">expression</code> attributes.
When configuring with Java, the <code class="literal">SftpOutboundGateway</code> class offers different constructors.</p>
</td></tr></table></div>
</div>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="stomp" href="#stomp"></a>31.&nbsp;STOMP Support</h2></div></div></div>

<p>Spring Integration version 4.2 introduced STOMP (Simple Text Orientated Messaging Protocol) client support.
It is based on the architecture, infrastructure, and API from the Spring Framework&#8217;s messaging module, stomp package.
Spring Integration uses many of Spring STOMP components (such as <code class="literal">StompSession</code> and <code class="literal">StompClientSupport</code>).
For more information, see the <a class="ulink" href="http://docs.spring.io/spring/docs/current/spring-framework-reference/html/websocket.html#websocket-stomp-client" target="_top">Spring Framework STOMP Support</a> chapter in the Spring Framework reference manual.</p>
<p>You need to include this dependency into your project:</p>
<div class="informalexample">
<p>
<b>Maven.&nbsp;</b>

</p><pre class="programlisting"><span class="hl-tag">&lt;dependency&gt;</span>
    <span class="hl-tag">&lt;groupId&gt;</span>org.springframework.integration<span class="hl-tag">&lt;/groupId&gt;</span>
    <span class="hl-tag">&lt;artifactId&gt;</span>spring-integration-stomp<span class="hl-tag">&lt;/artifactId&gt;</span>
    <span class="hl-tag">&lt;version&gt;</span>5.1.2.RELEASE<span class="hl-tag">&lt;/version&gt;</span>
<span class="hl-tag">&lt;/dependency&gt;</span></pre><p>

</p>
<p>
<b>Gradle.&nbsp;</b>

</p><pre class="programlisting">compile <span class="hl-string">"org.springframework.integration:spring-integration-stomp:5.1.2.RELEASE"</span></pre><p>

</p>
</div>
<p>For server side components you need to add a <code class="literal">org.springframework:spring-websocket</code> and/or <code class="literal">io.projectreactor.netty:reactor-netty</code> dependencies.</p>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="stomp-overview" href="#stomp-overview"></a>31.1&nbsp;Overview</h2></div></div></div>

<p>To configure STOMP, you should start with the STOMP client object.
The Spring Framework provides the following implementations:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">WebSocketStompClient</code>: Built on the Spring WebSocket API with support for standard JSR-356 WebSocket, Jetty 9, and SockJS for HTTP-based WebSocket emulation with SockJS Client.
</li><li class="listitem">
<code class="literal">ReactorNettyTcpStompClient</code>: Built on <code class="literal">ReactorNettyTcpClient</code> from the <code class="literal">reactor-netty</code> project.
</li></ul></div>
<p>You can provide any other <code class="literal">StompClientSupport</code> implementation.
See the <a class="ulink" href="https://docs.spring.io/spring-integration/api/" target="_top">Javadoc</a> of those classes.</p>
<p>The <code class="literal">StompClientSupport</code> class is designed as a <span class="emphasis"><em>factory</em></span> to produce a <code class="literal">StompSession</code> for the provided <code class="literal">StompSessionHandler</code> and all the remaining work is done through the <span class="emphasis"><em>callbacks</em></span> to that <code class="literal">StompSessionHandler</code> and <code class="literal">StompSession</code> abstraction.
With the Spring Integration <span class="emphasis"><em>adapter</em></span> abstraction, we need to provide some managed shared object to represent our application as a STOMP client with its unique session.
For this purpose, Spring Integration provides the <code class="literal">StompSessionManager</code> abstraction to manage the <span class="emphasis"><em>single</em></span> <code class="literal">StompSession</code> between any provided <code class="literal">StompSessionHandler</code>.
This allows the use of <span class="emphasis"><em>inbound</em></span> or <span class="emphasis"><em>outbound</em></span> channel adapters (or both) for the particular STOMP Broker.
See <code class="literal">StompSessionManager</code> (and its implementations) JavaDocs for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="stomp-inbound-adapter" href="#stomp-inbound-adapter"></a>31.2&nbsp;STOMP Inbound Channel Adapter</h2></div></div></div>

<p>The <code class="literal">StompInboundChannelAdapter</code> is a one-stop <code class="literal">MessageProducer</code> component that subscribes your Spring Integration application to the provided STOMP destinations and receives messages from them (converted from the STOMP frames by using the provided <code class="literal">MessageConverter</code> on the connected <code class="literal">StompSession</code>).
You can change the destinations (and therefore STOMP subscriptions) at runtime by using appropriate <code class="literal">@ManagedOperation</code> annotations on the <code class="literal">StompInboundChannelAdapter</code>.</p>
<p>For more configuration options, see <a class="xref" href="#stomp-namespace" title="31.7&nbsp;STOMP Namespace Support">Section&nbsp;31.7, &#8220;STOMP Namespace Support&#8221;</a> and the <code class="literal">StompInboundChannelAdapter</code> <a class="ulink" href="https://docs.spring.io/spring-integration/api/org/springframework/integration/stomp/inbound/StompInboundChannelAdapter.html" target="_top">Javadoc</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="stomp-outbound-adapter" href="#stomp-outbound-adapter"></a>31.3&nbsp;STOMP Outbound Channel Adapter</h2></div></div></div>

<p>The <code class="literal">StompMessageHandler</code> is the <code class="literal">MessageHandler</code> for the <code class="literal">&lt;int-stomp:outbound-channel-adapter&gt;</code> and is used to send the outgoing <code class="literal">Message&lt;?&gt;</code> instances to the STOMP <code class="literal">destination</code> (pre-configured or determined at runtime with a SpEL expression) through the <code class="literal">StompSession</code> (which is provided by the shared <code class="literal">StompSessionManager</code>).</p>
<p>For more configuration options see <a class="xref" href="#stomp-namespace" title="31.7&nbsp;STOMP Namespace Support">Section&nbsp;31.7, &#8220;STOMP Namespace Support&#8221;</a> and the <code class="literal">StompMessageHandler</code> <a class="ulink" href="https://docs.spring.io/spring-integration/api/org/springframework/integration/stomp/outbound/StompMessageHandler.html" target="_top">Javadoc</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="stomp-headers" href="#stomp-headers"></a>31.4&nbsp;STOMP Headers Mapping</h2></div></div></div>

<p>The STOMP protocol provides headers as part of its frame.
The entire structure of the STOMP frame has the following format:</p>
<div class="informalexample">
<pre class="screen">....
COMMAND
header1:value1
header2:value2

Body^@
....</pre>
</div>
<p>Spring Framework provides <code class="literal">StompHeaders</code> to represent these headers.
See the <a class="ulink" href="https://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/messaging/simp/stomp/StompHeaders.html" target="_top">Javadoc</a> for more details.
STOMP frames are converted to and from <code class="literal">Message&lt;?&gt;</code> instances and these headers are mapped to and from <code class="literal">MessageHeaders</code> instances.
Spring Integration provides a default <code class="literal">HeaderMapper</code> implementation for the STOMP adapters.
The implementation is <code class="literal">StompHeaderMapper</code>.
It provides <code class="literal">fromHeaders()</code> and <code class="literal">toHeaders()</code> operations for the inbound and outbound adapters, respectively.</p>
<p>As with many other Spring Integration modules, the <code class="literal">IntegrationStompHeaders</code> class has been introduced to map standard STOMP headers to <code class="literal">MessageHeaders</code>, with <code class="literal">stomp_</code> as the header name prefix.
In addition, all <code class="literal">MessageHeaders</code> instances with that prefix are mapped to the <code class="literal">StompHeaders</code> when sending to a destination.</p>
<p>For more information, see the <a class="ulink" href="https://docs.spring.io/spring-integration/api/" target="_top">Javadoc</a> for those classes and the <code class="literal">mapped-headers</code> attribute description in the <a class="xref" href="#stomp-namespace" title="31.7&nbsp;STOMP Namespace Support">Section&nbsp;31.7, &#8220;STOMP Namespace Support&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="stomp-events" href="#stomp-events"></a>31.5&nbsp;STOMP Integration Events</h2></div></div></div>

<p>Many STOMP operations are asynchronous, including error handling.
For example, STOMP has a <code class="literal">RECEIPT</code> server frame that it returns when a client frame has requested one by adding the <code class="literal">RECEIPT</code> header.
To provide access to these asynchronous events, Spring Integration emits <code class="literal">StompIntegrationEvent</code> instances, which you can obtain by implementing an <code class="literal">ApplicationListener</code> or by using an <code class="literal">&lt;int-event:inbound-channel-adapter&gt;</code> (see <a class="xref" href="#appevent-inbound" title="15.1&nbsp;Receiving Spring Application Events">Section&nbsp;15.1, &#8220;Receiving Spring Application Events&#8221;</a>).</p>
<p>Specifically, a <code class="literal">StompExceptionEvent</code> is emitted from the <code class="literal">AbstractStompSessionManager</code> when a <code class="literal">stompSessionListenableFuture</code> receives <code class="literal">onFailure()</code> due to failure to connect to STOMP broker.
Another example is the <code class="literal">StompMessageHandler</code>.
It processes <code class="literal">ERROR</code> STOMP frames, which are server responses to improper (unaccepted) messages sent by this <code class="literal">StompMessageHandler</code>.</p>
<p>The <code class="literal">StompMessageHandler</code> emits <code class="literal">StompReceiptEvent</code> as a part of <code class="literal">StompSession.Receiptable</code> callbacks in the asynchronous answers for the messages sent to the <code class="literal">StompSession</code>.
The <code class="literal">StompReceiptEvent</code> can be positive or negative, depending on whether or not the <code class="literal">RECEIPT</code> frame was received from the server within the <code class="literal">receiptTimeLimit</code> period, which you can configure on the <code class="literal">StompClientSupport</code> instance.
It defaults to <code class="literal">15 * 1000</code> (in milliseconds, so 15 seconds).</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The <code class="literal">StompSession.Receiptable</code> callbacks are added only if the <code class="literal">RECEIPT</code> STOMP header of the message to send is not <code class="literal">null</code>.
You can enable automatic <code class="literal">RECEIPT</code> header generation on the <code class="literal">StompSession</code> through its <code class="literal">autoReceipt</code> option and on the <code class="literal">StompSessionManager</code> respectively.</p>
</td></tr></table></div>
<p>See <a class="xref" href="#stomp-java-config" title="31.6&nbsp;STOMP Adapters Java Configuration">Section&nbsp;31.6, &#8220;STOMP Adapters Java Configuration&#8221;</a> for more information how to configure Spring Integration to accept those <code class="literal">ApplicationEvent</code> instances.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="stomp-java-config" href="#stomp-java-config"></a>31.6&nbsp;STOMP Adapters Java Configuration</h2></div></div></div>

<p>The following example shows a comprehensive Java configuration for STOMP adapters:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Configuration</span></em>
<em><span class="hl-annotation" style="color: gray">@EnableIntegration</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> StompConfiguration {

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> ReactorNettyTcpStompClient stompClient() {
        ReactorNettyTcpStompClient stompClient = <span class="hl-keyword">new</span> ReactorNettyTcpStompClient(<span class="hl-string">"127.0.0.1"</span>, <span class="hl-number">61613</span>);
        stompClient.setMessageConverter(<span class="hl-keyword">new</span> PassThruMessageConverter());
        ThreadPoolTaskScheduler taskScheduler = <span class="hl-keyword">new</span> ThreadPoolTaskScheduler();
        taskScheduler.afterPropertiesSet();
        stompClient.setTaskScheduler(taskScheduler);
        stompClient.setReceiptTimeLimit(<span class="hl-number">5000</span>);
        <span class="hl-keyword">return</span> stompClient;
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> StompSessionManager stompSessionManager() {
        ReactorNettyTcpStompSessionManager stompSessionManager = <span class="hl-keyword">new</span> ReactorNettyTcpStompSessionManager(stompClient());
        stompSessionManager.setAutoReceipt(true);
        <span class="hl-keyword">return</span> stompSessionManager;
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> PollableChannel stompInputChannel() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> QueueChannel();
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> StompInboundChannelAdapter stompInboundChannelAdapter() {
        StompInboundChannelAdapter adapter =
        		<span class="hl-keyword">new</span> StompInboundChannelAdapter(stompSessionManager(), <span class="hl-string">"/topic/myTopic"</span>);
        adapter.setOutputChannel(stompInputChannel());
        <span class="hl-keyword">return</span> adapter;
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "stompOutputChannel")</span></em>
    <span class="hl-keyword">public</span> MessageHandler stompMessageHandler() {
        StompMessageHandler handler = <span class="hl-keyword">new</span> StompMessageHandler(stompSessionManager());
        handler.setDestination(<span class="hl-string">"/topic/myTopic"</span>);
        <span class="hl-keyword">return</span> handler;
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> PollableChannel stompEvents() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> QueueChannel();
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> ApplicationListener&lt;ApplicationEvent&gt; stompEventListener() {
        ApplicationEventListeningMessageProducer producer = <span class="hl-keyword">new</span> ApplicationEventListeningMessageProducer();
        producer.setEventTypes(StompIntegrationEvent.<span class="hl-keyword">class</span>);
        producer.setOutputChannel(stompEvents());
        <span class="hl-keyword">return</span> producer;
    }

}</pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="stomp-namespace" href="#stomp-namespace"></a>31.7&nbsp;STOMP Namespace Support</h2></div></div></div>

<p>The Spring Integration STOMP namespace implements the inbound and outbound channel adapter components.
To include it in your configuration, provide the following namespace declaration in your application context configuration file:</p>
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
  <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
  <span class="hl-attribute">xmlns:int</span>=<span class="hl-value">"http://www.springframework.org/schema/integration"</span>
  <span class="hl-attribute">xmlns:int-stomp</span>=<span class="hl-value">"http://www.springframework.org/schema/integration/stomp"</span>
  <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"
    http://www.springframework.org/schema/beans
    http://www.springframework.org/schema/beans/spring-beans.xsd
    http://www.springframework.org/schema/integration
    http://www.springframework.org/schema/integration/spring-integration.xsd
    http://www.springframework.org/schema/integration/stomp
    http://www.springframework.org/schema/integration/stomp/spring-integration-stomp.xsd"</span><span class="hl-tag">&gt;</span>
    ...
<span class="hl-tag">&lt;/beans&gt;</span></pre>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="stomp-outbound-channel-adapter" href="#stomp-outbound-channel-adapter"></a>31.7.1&nbsp;Understanding the <code class="literal">&lt;int-stomp:outbound-channel-adapter&gt;</code> Element</h3></div></div></div>

<p>The following listing shows the available attributes for the STOMP outbound channel adapter:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-stomp:outbound-channel-adapter</span>
                           <span class="hl-attribute">id</span>=<span class="hl-value">""</span>                      <a name="CO48-1" href="#CO48-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
                           channel=""                 <a name="CO48-2" href="#CO48-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
                           stomp-session-manager=""   <a name="CO48-3" href="#CO48-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
                           header-mapper=""           <a name="CO48-4" href="#CO48-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
                           mapped-headers=""          <a name="CO48-5" href="#CO48-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
                           destination=""             <a name="CO48-6" href="#CO48-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>
                           destination-expression=""  <a name="CO48-7" href="#CO48-7"></a><span><img src="images/callouts/7.png" alt="7" border="0"></span>
                           auto-startup=""            <a name="CO48-8" href="#CO48-8"></a><span><img src="images/callouts/8.png" alt="8" border="0"></span>
                           phase=""/&gt;                 <a name="CO48-9" href="#CO48-9"></a><span><img src="images/callouts/9.png" alt="9" border="0"></span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO48-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The component bean name.
The <code class="literal">MessageHandler</code> is registered with a bean alias of <code class="literal">id</code> plus <code class="literal">.handler</code>.
If you do not set the <code class="literal">channel</code> attribute, a <code class="literal">DirectChannel</code> is created and registered in the application context with the value of this <code class="literal">id</code> attribute as the bean name.
In this case, the endpoint is registered with a bean name <code class="literal">id</code> plus <code class="literal">.adapter</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO48-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Identifies the channel attached to this adapter if <code class="literal">id</code> is present.
See <code class="literal">id</code>.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO48-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Reference to a <code class="literal">StompSessionManager</code> bean, which encapsulates the low-level connection and <code class="literal">StompSession</code> handling operations.
Required.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO48-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Reference to a bean that implements <code class="literal">HeaderMapper&lt;StompHeaders&gt;</code>, which maps Spring Integration <code class="literal">MessageHeaders</code> to and from
STOMP frame headers.
It is mutually exclusive with <code class="literal">mapped-headers</code>.
It defaults to <code class="literal">StompHeaderMapper</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO48-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Comma-separated list of names of STOMP Headers to be mapped to the STOMP frame headers.
It can be provided only if the <code class="literal">header-mapper</code> reference is not set.
The values in this list can also be simple patterns to be matched against the header names (such as <code class="literal">myheader*</code> or <code class="literal">*myheader</code>).
A special token (<code class="literal">STOMP_OUTBOUND_HEADERS</code>) represents all the standard STOMP headers (content-length, receipt, heart-beat, and so on).
They are included by default.
If you want to add your own headers and want the standard headers to also be mapped, you must include this token or provide your own <code class="literal">HeaderMapper</code> implementation by using <code class="literal">header-mapper</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO48-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Name of the destination to which STOMP Messages are sent.
It is mutually exclusive with the <code class="literal">destination-expression</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO48-7"><span><img src="images/callouts/7.png" alt="7" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A SpEL expression to be evaluated at runtime against each Spring Integration <code class="literal">Message</code> as the root object.
It is mutually exclusive with the <code class="literal">destination</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO48-8"><span><img src="images/callouts/8.png" alt="8" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Boolean value indicating whether this endpoint should start automatically.
It defaults to <code class="literal">true</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO48-9"><span><img src="images/callouts/9.png" alt="9" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The lifecycle phase within which this endpoint should start and stop.
The lower the value, the earlier this endpoint starts and the later it stops.
The default is <code class="literal">Integer.MIN_VALUE</code>.
Values can be negative.
See <a class="ulink" href="https://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/context/SmartLifecycle.html" target="_top"><code class="literal">SmartLifeCycle</code></a>.</p>
</td></tr></table></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_understanding_the_literal_int_stomp_inbound_channel_adapter_literal_element" href="#_understanding_the_literal_int_stomp_inbound_channel_adapter_literal_element"></a>31.7.2&nbsp;Understanding the <code class="literal">&lt;int-stomp:inbound-channel-adapter&gt;</code> Element</h3></div></div></div>

<p>The following listing shows the available attributes for the STOMP inbound channel adapter:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-stomp:inbound-channel-adapter</span>
                           <span class="hl-attribute">id</span>=<span class="hl-value">""</span>                     <a name="CO49-1" href="#CO49-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
                           channel=""                <a name="CO49-2" href="#CO49-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
                           error-channel=""          <a name="CO49-3" href="#CO49-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
                           stomp-session-manager=""  <a name="CO49-4" href="#CO49-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
                           header-mapper=""          <a name="CO49-5" href="#CO49-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
                           mapped-headers=""         <a name="CO49-6" href="#CO49-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>
                           destinations=""           <a name="CO49-7" href="#CO49-7"></a><span><img src="images/callouts/7.png" alt="7" border="0"></span>
                           send-timeout=""           <a name="CO49-8" href="#CO49-8"></a><span><img src="images/callouts/8.png" alt="8" border="0"></span>
                           payload-type=""           <a name="CO49-9" href="#CO49-9"></a><span><img src="images/callouts/9.png" alt="9" border="0"></span>
                           auto-startup=""           <a name="CO49-10" href="#CO49-10"></a><span><img src="images/callouts/10.png" alt="10" border="0"></span>
                           phase=""/&gt;                <a name="CO49-11" href="#CO49-11"></a><span><img src="images/callouts/11.png" alt="11" border="0"></span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO49-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The component bean name.
If you do not set the <code class="literal">channel</code> attribute, a <code class="literal">DirectChannel</code> is created and registered in the application context with the value of this <code class="literal">id</code> attribute as the bean name.
In this case, the endpoint is registered with the bean name <code class="literal">id</code> plus <code class="literal">.adapter</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO49-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Identifies the channel attached to this adapter.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO49-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The <code class="literal">MessageChannel</code> bean reference to which <code class="literal">ErrorMessage</code> instances should be sent.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO49-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>See the same option on the <a class="link" href="#stomp-outbound-channel-adapter" title="31.7.1&nbsp;Understanding the <int-stomp:outbound-channel-adapter&gt; Element"><code class="literal">&lt;int-stomp:outbound-channel-adapter&gt;</code></a>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO49-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Comma-separated list of names of STOMP Headers to be mapped from the STOMP frame headers.
You can only provide this if the <code class="literal">header-mapper</code> reference is not set.
The values in this list can also be simple patterns to be matched against the header names (for example, <code class="literal">myheader*</code> or <code class="literal">*myheader</code>).
A special token (<code class="literal">STOMP_INBOUND_HEADERS</code>) represents all the standard STOMP headers (content-length, receipt, heart-beat, and so on).
They are included by default.
If you want to add your own headers and want the standard headers to also be mapped, you must also include this token or provide your own <code class="literal">HeaderMapper</code> implementation using <code class="literal">header-mapper</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO49-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>See the same option on the <a class="link" href="#stomp-outbound-channel-adapter" title="31.7.1&nbsp;Understanding the <int-stomp:outbound-channel-adapter&gt; Element"><code class="literal">&lt;int-stomp:outbound-channel-adapter&gt;</code></a>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO49-7"><span><img src="images/callouts/7.png" alt="7" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Comma-separated list of STOMP destination names to subscribe.
The list of destinations (and therefore subscriptions) can be modified at runtime through the <code class="literal">addDestination()</code> and <code class="literal">removeDestination()</code> <code class="literal">@ManagedOperation</code> annotations.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO49-8"><span><img src="images/callouts/8.png" alt="8" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Maximum amount of time (in milliseconds) to wait when sending a message to the channel if the channel can block.
For example, a <code class="literal">QueueChannel</code> can block until space is available if its maximum capacity has been reached.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO49-9"><span><img src="images/callouts/9.png" alt="9" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Fully qualified name of the Java type for the target <code class="literal">payload</code> to convert from the incoming STOMP frame.
It defaults to <code class="literal">String.class</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO49-10"><span><img src="images/callouts/10.png" alt="10" border="0"></span></a> </p></td><td valign="top" align="left">
<p>See the same option on the <a class="link" href="#stomp-outbound-channel-adapter" title="31.7.1&nbsp;Understanding the <int-stomp:outbound-channel-adapter&gt; Element"><code class="literal">&lt;int-stomp:outbound-channel-adapter&gt;</code></a>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO49-11"><span><img src="images/callouts/11.png" alt="11" border="0"></span></a> </p></td><td valign="top" align="left">
<p>See the same option on the <a class="link" href="#stomp-outbound-channel-adapter" title="31.7.1&nbsp;Understanding the <int-stomp:outbound-channel-adapter&gt; Element"><code class="literal">&lt;int-stomp:outbound-channel-adapter&gt;</code></a>.</p>
</td></tr></table></div>
</div>
</div>
</div>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="stream" href="#stream"></a>32.&nbsp;Stream Support</h2></div></div></div>

<p>In many cases, application data is obtained from a stream.
It is not recommended to send a reference to a stream as a message payload to a consumer.
Instead, messages are created from data that is read from an input stream, and message payloads are written to an output stream one by one.</p>
<p>You need to include this dependency into your project:</p>
<div class="informalexample">
<p>
<b>Maven.&nbsp;</b>

</p><pre class="programlisting"><span class="hl-tag">&lt;dependency&gt;</span>
    <span class="hl-tag">&lt;groupId&gt;</span>org.springframework.integration<span class="hl-tag">&lt;/groupId&gt;</span>
    <span class="hl-tag">&lt;artifactId&gt;</span>spring-integration-stream<span class="hl-tag">&lt;/artifactId&gt;</span>
    <span class="hl-tag">&lt;version&gt;</span>5.1.2.RELEASE<span class="hl-tag">&lt;/version&gt;</span>
<span class="hl-tag">&lt;/dependency&gt;</span></pre><p>

</p>
<p>
<b>Gradle.&nbsp;</b>

</p><pre class="programlisting">compile <span class="hl-string">"org.springframework.integration:spring-integration-stream:5.1.2.RELEASE"</span></pre><p>

</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="stream-reading" href="#stream-reading"></a>32.1&nbsp;Reading from Streams</h2></div></div></div>

<p>Spring Integration provides two adapters for streams.
Both <code class="literal">ByteStreamReadingMessageSource</code> and <code class="literal">CharacterStreamReadingMessageSource</code> implement <code class="literal">MessageSource</code>.
By configuring one of these within a channel-adapter element, the polling period can be configured and the message bus can automatically detect and schedule them.
The byte stream version requires an <code class="literal">InputStream</code>, and the character stream version requires a <code class="literal">Reader</code> as the single constructor argument.
The <code class="literal">ByteStreamReadingMessageSource</code> also accepts the <span class="emphasis"><em>bytesPerMessage</em></span> property to determine how many bytes it tries to read into each <code class="literal">Message</code>.
The default value is 1024.
The following example creates an input stream that creates messages that each contain 2048 bytes:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.stream.ByteStreamReadingMessageSource"</span><span class="hl-tag">&gt;</span>
  <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"someInputStream"</span><span class="hl-tag">/&gt;</span>
  <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"bytesPerMessage"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"2048"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.stream.CharacterStreamReadingMessageSource"</span><span class="hl-tag">&gt;</span>
  <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"someReader"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
</div>
<p>The <code class="literal">CharacterStreamReadingMessageSource</code> wraps the reader in a <code class="literal">BufferedReader</code> (if it is not one already).
You can set the buffer size used by the buffered reader in the second constructor argument.
Starting with version 5.0, a third constructor argument (<code class="literal">blockToDetectEOF</code>) controls the behavior of the <code class="literal">CharacterStreamReadingMessageSource</code>.
When <code class="literal">false</code> (the default), the <code class="literal">receive()</code> method checks whether the reader is <code class="literal">ready()</code> and returns null if not.
EOF (end of file) is not detected in this case.
When <code class="literal">true</code>, the <code class="literal">receive()</code> method blocks until data is available or EOF is detected on the underlying stream.
When EOF is detected, a <code class="literal">StreamClosedEvent</code> (application event) is published.
You can consume this event with a bean that implements <code class="literal">ApplicationListener&lt;StreamClosedEvent&gt;</code>.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>To facilitate EOF detection, the poller thread blocks in the <code class="literal">receive()</code> method until either data arrives or EOF is detected.</p>
</td></tr></table></div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>The poller continues to publish an event on each poll once EOF has been detected.
The application listener can stop the adapter to prevent this.
The event is published on the poller thread.
Stopping the adapter causes the thread to be interrupted.
If you intend to perform some interruptible task after stopping the adapter, you must either perform the <code class="literal">stop()</code> on a different thread or use a different thread for those downstream activities.
Note that sending to a <code class="literal">QueueChannel</code> is interruptible, so, if you wish to send a message from the listener, do it before stopping the adapter.</p>
</td></tr></table></div>
<p>This facilitates "<code class="literal">piping</code>" or redirecting data to <code class="literal">stdin</code>, as the following two examples shows:</p>
<div class="informalexample">
<pre class="screen">cat myfile.txt | java -jar my.jar</pre>
<pre class="screen">java -jar my.jar &lt; foo.txt</pre>
</div>
<p>This approach lets the application terminate when the pipe is closed.</p>
<p>Four convenient factory methods are available:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">final</span> CharacterStreamReadingMessageSource stdin() { ... }

<span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">final</span> CharacterStreamReadingMessageSource stdin(String charsetName) { ... }

<span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">final</span> CharacterStreamReadingMessageSource stdinPipe() { ... }

<span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">final</span> CharacterStreamReadingMessageSource stdinPipe(String charsetName) { ... }</pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="stream-writing" href="#stream-writing"></a>32.2&nbsp;Writing to Streams</h2></div></div></div>

<p>For target streams, you can use either of two implementations: <code class="literal">ByteStreamWritingMessageHandler</code> or <code class="literal">CharacterStreamWritingMessageHandler</code>.
Each requires a single constructor argument (<code class="literal">OutputStream</code> for byte streams or <code class="literal">Writer</code> for character streams), and each provides a second constructor that adds the optional <span class="emphasis"><em>bufferSize</em></span>.
Since both of these ultimately implement the <code class="literal">MessageHandler</code> interface, you can reference them from a <code class="literal">channel-adapter</code> configuration, as described in <a class="xref" href="#channel-adapter" title="6.3&nbsp;Channel Adapter">Section&nbsp;6.3, &#8220;Channel Adapter&#8221;</a>.</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.stream.ByteStreamWritingMessageHandler"</span><span class="hl-tag">&gt;</span>
  <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"someOutputStream"</span><span class="hl-tag">/&gt;</span>
  <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"1024"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.stream.CharacterStreamWritingMessageHandler"</span><span class="hl-tag">&gt;</span>
  <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"someWriter"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="stream-namespace" href="#stream-namespace"></a>32.3&nbsp;Stream Namespace Support</h2></div></div></div>

<p>Spring Integration defines a namespace to reduce the configuration needed for stream-related channel adapters.
The following schema locations are needed to use it:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans:beans</span> <span class="hl-attribute">xmlns:int-stream</span>=<span class="hl-value">"http://www.springframework.org/schema/integration/stream"</span>
  <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
  <span class="hl-attribute">xmlns:beans</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
  <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"http://www.springframework.org/schema/beans
      http://www.springframework.org/schema/beans/spring-beans.xsd
      http://www.springframework.org/schema/integration/stream
      http://www.springframework.org/schema/integration/stream/spring-integration-stream.xsd"</span><span class="hl-tag">&gt;</span></pre>
</div>
<p>The following code snippet shows the different configuration options that are supported to configure the inbound channel adapter:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-stream:stdin-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"adapterWithDefaultCharset"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int-stream:stdin-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"adapterWithProvidedCharset"</span> <span class="hl-attribute">charset</span>=<span class="hl-value">"UTF-8"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>Starting with version 5.0, you can set the <code class="literal">detect-eof</code> attribute, which sets the <code class="literal">blockToDetectEOF</code> property.
See <a class="xref" href="#stream-reading" title="32.1&nbsp;Reading from Streams">Section&nbsp;32.1, &#8220;Reading from Streams&#8221;</a> for more information.</p>
<p>To configure the outbound channel adapter, you can use the namespace support as well.
The following example shows the different configuration for an outbound channel adapters:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-stream:stdout-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"stdoutAdapterWithDefaultCharset"</span>
    <span class="hl-attribute">channel</span>=<span class="hl-value">"testChannel"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int-stream:stdout-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"stdoutAdapterWithProvidedCharset"</span> <span class="hl-attribute">charset</span>=<span class="hl-value">"UTF-8"</span>
    <span class="hl-attribute">channel</span>=<span class="hl-value">"testChannel"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int-stream:stderr-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"stderrAdapter"</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"testChannel"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int-stream:stdout-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"newlineAdapter"</span> <span class="hl-attribute">append-newline</span>=<span class="hl-value">"true"</span>
    <span class="hl-attribute">channel</span>=<span class="hl-value">"testChannel"</span><span class="hl-tag">/&gt;</span></pre>
</div>
</div>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="syslog" href="#syslog"></a>33.&nbsp;Syslog Support</h2></div></div></div>

<p>Spring Integration 2.2 introduced the syslog transformer: <code class="literal">SyslogToMapTransformer</code>.</p>
<p>You need to include this dependency into your project:</p>
<div class="informalexample">
<p>
<b>Maven.&nbsp;</b>

</p><pre class="programlisting"><span class="hl-tag">&lt;dependency&gt;</span>
    <span class="hl-tag">&lt;groupId&gt;</span>org.springframework.integration<span class="hl-tag">&lt;/groupId&gt;</span>
    <span class="hl-tag">&lt;artifactId&gt;</span>spring-integration-syslog<span class="hl-tag">&lt;/artifactId&gt;</span>
    <span class="hl-tag">&lt;version&gt;</span>5.1.2.RELEASE<span class="hl-tag">&lt;/version&gt;</span>
<span class="hl-tag">&lt;/dependency&gt;</span></pre><p>

</p>
<p>
<b>Gradle.&nbsp;</b>

</p><pre class="programlisting">compile <span class="hl-string">"org.springframework.integration:spring-integration-syslog:5.1.2.RELEASE"</span></pre><p>

</p>
</div>
<p>This transformer, together with a <code class="literal">UDP</code> or <code class="literal">TCP</code> inbound adapter, could be used to receive and analyze syslog records from other hosts.
The transformer creates a message payload that contains a map of the elements from the syslog message.</p>
<p>Spring Integration 3.0 introduced convenient namespace support for configuring a syslog inbound adapter in a single element.</p>
<p>Starting with version 4.1.1, the framework now supports the extended syslog format, as specified in <a class="ulink" href="https://tools.ietf.org/html/rfc5424" target="_top">RFC 5424&gt;</a>.
In addition, when using TCP and RFC5424, both <code class="literal">octet counting</code> and <code class="literal">non-transparent framing</code> described in <a class="ulink" href="https://tools.ietf.org/html/rfc6587" target="_top">RFC 6587</a> are supported.</p>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="syslog-inbound-adapter" href="#syslog-inbound-adapter"></a>33.1&nbsp;Syslog Inbound Channel Adapter</h2></div></div></div>

<p>This element encompasses a <code class="literal">UDP</code> or <code class="literal">TCP</code> inbound channel adapter and a <code class="literal">MessageConverter</code> to convert the syslog message to a Spring Integration message.
The <code class="literal">DefaultMessageConverter</code> delegates to the <code class="literal">SyslogToMapTransformer</code>, creating a message with its payload being the <code class="literal">Map</code> of syslog fields.
In addition, all fields except the message are also made available as headers in the message and are prefixed with <code class="literal">syslog_</code>.
In this mode, only <a class="ulink" href="https://tools.ietf.org/html/rfc3164" target="_top">RFC 3164</a> (BSD) syslogs are supported.</p>
<p>Since version 4.1, the <code class="literal">DefaultMessageConverter</code> has a property called <code class="literal">asMap</code> (the default is <code class="literal">true</code>).
When it is <code class="literal">false</code>, the converter leaves the message payload as the original complete syslog message (in a <code class="literal">byte[]</code>) while still setting the headers.</p>
<p>Since version 4.1.1, RFC 5424 is also supported, by using the <code class="literal">RFC5424MessageConverter</code>.
In this case, the fields are not copied as headers, unless <code class="literal">asMap</code> is set to <code class="literal">false</code>, in which case the original message is the payload and the decoded fields are headers.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>To use RFC 5424 with a TCP transport, you must provide additional configuration to enable the different framing techniques described in RFC 6587.
The adapter needs a TCP connection factory that is configured with a <code class="literal">RFC6587SyslogDeserializer</code>.
By default, this deserializer handles <code class="literal">octet counting</code> and <code class="literal">non-transparent framing</code> by using a linefeed (LF) to delimit syslog messages.
It uses a <code class="literal">ByteArrayLfSerializer</code> when <code class="literal">octet counting</code> is not detected.
To use different <code class="literal">non-transparent</code> framing, you can provide it with some other deserializer.
While the deserializer can support both <code class="literal">octet counting</code> and <code class="literal">non-transparent framing</code>, only one form of the latter is supported.
If <code class="literal">asMap</code> is <code class="literal">false</code> on the converter, you must set the <code class="literal">retainOriginal</code> constructor argument in the <code class="literal">RFC6587SyslogDeserializer</code>.</p>
</td></tr></table></div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="syslog-inbound-examplers" href="#syslog-inbound-examplers"></a>33.1.1&nbsp;Example Configuration</h3></div></div></div>

<p>The following example defines a <code class="literal">UDP</code> adapter that sends messages to the <code class="literal">syslogIn</code> channel (the adapter bean name is <code class="literal">syslogIn.adapter</code>):</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-syslog:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"syslogIn"</span> <span class="hl-attribute">port</span>=<span class="hl-value">"1514"</span><span class="hl-tag"> /&gt;</span></pre>
</div>
<p>The adapter listens on port <code class="literal">1514</code>.</p>
<p>The following example defines a <code class="literal">UDP</code> adapter that sends messages to the <code class="literal">fromSyslog</code> channel (the adapter bean name is <code class="literal">syslogIn</code>):</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-syslog:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"syslogIn"</span>
	<span class="hl-attribute">channel</span>=<span class="hl-value">"fromSyslog"</span> <span class="hl-attribute">port</span>=<span class="hl-value">"1514"</span><span class="hl-tag"> /&gt;</span></pre>
</div>
<p>The adapter listens on port <code class="literal">1514</code>.</p>
<p>The following example defines a <code class="literal">TCP</code> adapter that sends messages to channel <code class="literal">syslogIn</code> (the adapter bean name is <code class="literal">syslogIn.adapter</code>):</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-syslog:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"bar"</span> <span class="hl-attribute">protocol</span>=<span class="hl-value">"tcp"</span> <span class="hl-attribute">port</span>=<span class="hl-value">"1514"</span><span class="hl-tag"> /&gt;</span></pre>
</div>
<p>The adapter listens on port <code class="literal">1514</code>.</p>
<p>Note the addition of the <code class="literal">protocol</code> attribute.
This attribute can contain <code class="literal">udp</code> or <code class="literal">tcp</code>.
It defaults to <code class="literal">udp</code>.</p>
<p>The following example shows a <code class="literal">UDP</code> adapter that sends messages to channel <code class="literal">fromSyslog</code>:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-syslog:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"udpSyslog"</span>
	<span class="hl-attribute">channel</span>=<span class="hl-value">"fromSyslog"</span>
	<span class="hl-attribute">auto-startup</span>=<span class="hl-value">"false"</span>
	<span class="hl-attribute">phase</span>=<span class="hl-value">"10000"</span>
	<span class="hl-attribute">converter</span>=<span class="hl-value">"converter"</span>
	<span class="hl-attribute">send-timeout</span>=<span class="hl-value">"1000"</span>
	<span class="hl-attribute">error-channel</span>=<span class="hl-value">"errors"</span><span class="hl-tag">&gt;</span>
		<span class="hl-tag">&lt;int-syslog:udp-attributes</span> <span class="hl-attribute">port</span>=<span class="hl-value">"1514"</span> <span class="hl-attribute">lookup-host</span>=<span class="hl-value">"false"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/int-syslog:inbound-channel-adapter&gt;</span></pre>
</div>
<p>The preceding example also shows two <code class="literal">SmartLifecycle</code> attributes: <code class="literal">auto-startup</code> and <code class="literal">phase</code>.
It has a reference to a custom <code class="literal">org.springframework.integration.syslog.MessageConverter</code> with an ID of <code class="literal">converter</code> and an <code class="literal">error-channel</code>.
Also notice the <code class="literal">udp-attributes</code> child element.
You can set various UDP attributes here, as defined in <a class="xref" href="#ip-udp-ib-atts" title="Table&nbsp;34.2.&nbsp;UDP Inbound Channel Adapter Attributes">Table&nbsp;34.2, &#8220;UDP Inbound Channel Adapter Attributes&#8221;</a>.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>When you use the <code class="literal">udp-attributes</code> element, you must provide the <code class="literal">port</code> attribute there rather than on the <code class="literal">inbound-channel-adapter</code> element itself.</p>
</td></tr></table></div>
<p>The following example shows a <code class="literal">TCP</code> adapter that sends messages to channel <code class="literal">fromSyslog</code>:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-syslog:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"TcpSyslog"</span>
	<span class="hl-attribute">protocol</span>=<span class="hl-value">"tcp"</span>
	<span class="hl-attribute">channel</span>=<span class="hl-value">"fromSyslog"</span>
	<span class="hl-attribute">connection-factory</span>=<span class="hl-value">"cf"</span><span class="hl-tag"> /&gt;</span>

<span class="hl-tag">&lt;int-ip:tcp-connection-factory</span> <span class="hl-attribute">id</span>=<span class="hl-value">"cf"</span> <span class="hl-attribute">type</span>=<span class="hl-value">"server"</span> <span class="hl-attribute">port</span>=<span class="hl-value">"1514"</span><span class="hl-tag"> /&gt;</span></pre>
</div>
<p>It also shows how to reference an externally defined connection factory, which can be used for advanced configuration (socket keep-alive and other uses).
For more information, see <a class="xref" href="#tcp-connection-factories" title="34.3&nbsp;TCP Connection Factories">Section&nbsp;34.3, &#8220;TCP Connection Factories&#8221;</a>.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The externally configured <code class="literal">connection-factory</code> must be of type <code class="literal">server</code>, and the port is defined there rather than on the <code class="literal">inbound-channel-adapter</code> element itself.</p>
</td></tr></table></div>
<p>The following example shows a <code class="literal">TCP</code> adapter that sends messages to channel <code class="literal">fromSyslog</code>:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-syslog:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"rfc5424Tcp"</span>
	<span class="hl-attribute">protocol</span>=<span class="hl-value">"tcp"</span>
	<span class="hl-attribute">channel</span>=<span class="hl-value">"fromSyslog"</span>
	<span class="hl-attribute">connection-factory</span>=<span class="hl-value">"cf"</span>
	<span class="hl-attribute">converter</span>=<span class="hl-value">"rfc5424"</span><span class="hl-tag"> /&gt;</span>

<span class="hl-tag">&lt;int-ip:tcp-connection-factory</span> <span class="hl-attribute">id</span>=<span class="hl-value">"cf"</span>
	<span class="hl-attribute">using-nio</span>=<span class="hl-value">"true"</span>
	<span class="hl-attribute">type</span>=<span class="hl-value">"server"</span>
	<span class="hl-attribute">port</span>=<span class="hl-value">"1514"</span>
	<span class="hl-attribute">deserializer</span>=<span class="hl-value">"rfc6587"</span><span class="hl-tag"> /&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"rfc5424"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.syslog.RFC5424MessageConverter"</span><span class="hl-tag"> /&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"rfc6587"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.syslog.inbound.RFC6587SyslogDeserializer"</span><span class="hl-tag"> /&gt;</span></pre>
</div>
<p>The preceding example is configured to use the <code class="literal">RFC 5424</code> converter and is configured with a reference to an externally defined connection factory with the <code class="literal">RFC 6587</code> deserializer (required for RFC 5424).</p>
</div>
</div>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="ip" href="#ip"></a>34.&nbsp;TCP and UDP Support</h2></div></div></div>

<p>Spring Integration provides channel adapters for receiving and sending messages over internet protocols.
Both UDP (User Datagram Protocol) and TCP (Transmission Control Protocol) adapters are provided.
Each adapter provides for one-way communication over the underlying protocol.
In addition, Spring Integration provides simple inbound and outbound TCP gateways.
These are used when two-way communication is needed.</p>
<p>You need to include this dependency into your project:</p>
<div class="informalexample">
<p>
<b>Maven.&nbsp;</b>

</p><pre class="programlisting"><span class="hl-tag">&lt;dependency&gt;</span>
    <span class="hl-tag">&lt;groupId&gt;</span>org.springframework.integration<span class="hl-tag">&lt;/groupId&gt;</span>
    <span class="hl-tag">&lt;artifactId&gt;</span>spring-integration-ip<span class="hl-tag">&lt;/artifactId&gt;</span>
    <span class="hl-tag">&lt;version&gt;</span>5.1.2.RELEASE<span class="hl-tag">&lt;/version&gt;</span>
<span class="hl-tag">&lt;/dependency&gt;</span></pre><p>

</p>
<p>
<b>Gradle.&nbsp;</b>

</p><pre class="programlisting">compile <span class="hl-string">"org.springframework.integration:spring-integration-ip:5.1.2.RELEASE"</span></pre><p>

</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="ip-intro" href="#ip-intro"></a>34.1&nbsp;Introduction</h2></div></div></div>

<p>Two flavors each of UDP inbound and outbound channel adapters are provided:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">UnicastSendingMessageHandler</code> sends a datagram packet to a single destination.
</li><li class="listitem">
<code class="literal">UnicastReceivingChannelAdapter</code> receives incoming datagram packets.
</li><li class="listitem">
<code class="literal">MulticastSendingMessageHandler</code> sends (broadcasts) datagram packets to a multicast address.
</li><li class="listitem">
<code class="literal">MulticastReceivingChannelAdapter</code> receives incoming datagram packets by joining to a multicast address.
</li></ul></div>
<p>TCP inbound and outbound channel adapters are provided:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">TcpSendingMessageHandler</code> sends messages over TCP.
</li><li class="listitem">
<code class="literal">TcpReceivingChannelAdapter</code> receives messages over TCP.
</li></ul></div>
<p>An inbound TCP gateway is provided.
It allows for simple request-response processing.
While the gateway can support any number of connections, each connection can only be processed serially.
The thread that reads from the socket waits for, and sends, the response before reading again.
If the connection factory is configured for single use connections, the connection is closed after the socket times out.</p>
<p>An outbound TCP gateway is provided.
It allows for simple request-response processing.
If the associated connection factory is configured for single-use connections, a new connection is immediately created for each new request.
Otherwise, if the connection is in use, the calling thread blocks on the connection until either a response is received or a timeout or I/O error occurs.</p>
<p>The TCP and UDP inbound channel adapters and the TCP inbound gateway support the <code class="literal">error-channel</code> attribute.
This provides the same basic functionality as described in <a class="xref" href="#gateway-proxy" title="10.4.1&nbsp;Enter the GatewayProxyFactoryBean">Section&nbsp;10.4.1, &#8220;Enter the <code class="literal">GatewayProxyFactoryBean</code>&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="udp-adapters" href="#udp-adapters"></a>34.2&nbsp;UDP Adapters</h2></div></div></div>

<p>This section describes how to configure and use the UDP adapters.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_outbound_udp_adapters_xml_configuration" href="#_outbound_udp_adapters_xml_configuration"></a>34.2.1&nbsp;Outbound UDP Adapters (XML Configuration)</h3></div></div></div>

<p>The following example configures a UDP outbound channel adapter:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-ip:udp-outbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"udpOut"</span>
    <span class="hl-attribute">host</span>=<span class="hl-value">"somehost"</span>
    <span class="hl-attribute">port</span>=<span class="hl-value">"11111"</span>
    <span class="hl-attribute">multicast</span>=<span class="hl-value">"false"</span>
    <span class="hl-attribute">channel</span>=<span class="hl-value">"exampleChannel"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>When setting <code class="literal">multicast</code> to <code class="literal">true</code>, you should also provide the multicast address in the host attribute.</p>
</td></tr></table></div>
<p>UDP is an efficient but unreliable protocol.
Spring Integration adds two attributes to improve reliability: <code class="literal">check-length</code> and <code class="literal">acknowledge</code>.
When <code class="literal">check-length</code> is set to <code class="literal">true</code>, the adapter precedes the message data with a length field (four bytes in network byte order).
This enables the receiving side to verify the length of the packet received.
If a receiving system uses a buffer that is too short to contain the packet, the packet can be truncated.
The <code class="literal">length</code> header provides a mechanism to detect this.</p>
<p>Starting with version 4.3, you can set the <code class="literal">port</code> to <code class="literal">0</code>, in which case the operating system chooses the port.
The chosen port can be discovered by invoking <code class="literal">getPort()</code> after the adapter is started and <code class="literal">isListening()</code> returns <code class="literal">true</code>.</p>
<p>The preceding example shows an outbound channel adapter that adds length checking to the datagram packets:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-ip:udp-outbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"udpOut"</span>
    <span class="hl-attribute">host</span>=<span class="hl-value">"somehost"</span>
    <span class="hl-attribute">port</span>=<span class="hl-value">"11111"</span>
    <span class="hl-attribute">multicast</span>=<span class="hl-value">"false"</span>
    <span class="hl-attribute">check-length</span>=<span class="hl-value">"true"</span>
    <span class="hl-attribute">channel</span>=<span class="hl-value">"exampleChannel"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>The recipient of the packet must also be configured to expect a length to precede the actual data.
For a Spring Integration UDP inbound channel adapter, set its <code class="literal">check-length</code> attribute.</p>
</td></tr></table></div>
<p>The second reliability improvement allows an application-level acknowledgment protocol to be used.
The receiver must send an acknowledgment to the sender within a specified time.</p>
<p>The following example shows an outbound channel adapter that adds length checking to the datagram packets and waits for an acknowledgment:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-ip:udp-outbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"udpOut"</span>
    <span class="hl-attribute">host</span>=<span class="hl-value">"somehost"</span>
    <span class="hl-attribute">port</span>=<span class="hl-value">"11111"</span>
    <span class="hl-attribute">multicast</span>=<span class="hl-value">"false"</span>
    <span class="hl-attribute">check-length</span>=<span class="hl-value">"true"</span>
    <span class="hl-attribute">acknowledge</span>=<span class="hl-value">"true"</span>
    <span class="hl-attribute">ack-host</span>=<span class="hl-value">"thishost"</span>
    <span class="hl-attribute">ack-port</span>=<span class="hl-value">"22222"</span>
    <span class="hl-attribute">ack-timeout</span>=<span class="hl-value">"10000"</span>
    <span class="hl-attribute">channel</span>=<span class="hl-value">"exampleChannel"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>Setting <code class="literal">acknowledge</code> to <code class="literal">true</code> implies that the recipient of the packet can interpret the header added to the packet containing acknowledgment data (host and port).
Most likely, the recipient is a Spring Integration inbound channel adapter.</p>
</td></tr></table></div>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>When multicast is true, an additional attribute (<code class="literal">min-acks-for-success</code>) specifies how many acknowledgments must be received within the <code class="literal">ack-timeout</code>.</p>
</td></tr></table></div>
<p>Starting with version 4.3, you can set the <code class="literal">ackPort</code> to <code class="literal">0</code>, in which case the operating system chooses the port.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_outbound_udp_adapters_java_configuration" href="#_outbound_udp_adapters_java_configuration"></a>34.2.2&nbsp;Outbound UDP Adapters (Java Configuration)</h3></div></div></div>

<p>The following example shows how to configure an outbound UDP adapter with Java:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "udpOut")</span></em>
<span class="hl-keyword">public</span> UnicastSendingMessageHandler handler() {
	<span class="hl-keyword">return</span> <span class="hl-keyword">new</span> UnicastSendingMessageHandler(<span class="hl-string">"localhost"</span>, <span class="hl-number">11111</span>);
}</pre>
</div>
<p>(or <code class="literal">MulticastSendingChannelAdapter</code> for multicast).</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_outbound_udp_adapters_java_dsl_configuration" href="#_outbound_udp_adapters_java_dsl_configuration"></a>34.2.3&nbsp;Outbound UDP Adapters (Java DSL Configuration)</h3></div></div></div>

<p>The following example shows how to configure an outbound UDP adapter with the Java DSL:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> IntegrationFlow udpOutFlow() {
	<span class="hl-keyword">return</span> IntegrationFlows.from(<span class="hl-string">"udpOut"</span>)
			.handle(Udp.outboundAdapter(<span class="hl-string">"localhost"</span>, <span class="hl-number">1234</span>))
			.get();
}</pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_inbound_udp_adapters_xml_configuration" href="#_inbound_udp_adapters_xml_configuration"></a>34.2.4&nbsp;Inbound UDP Adapters (XML Configuration)</h3></div></div></div>

<p>The following example shows how to configure a basic unicast inbound udp channel adapter.</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-ip:udp-inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"udpReceiver"</span>
    <span class="hl-attribute">channel</span>=<span class="hl-value">"udpOutChannel"</span>
    <span class="hl-attribute">port</span>=<span class="hl-value">"11111"</span>
    <span class="hl-attribute">receive-buffer-size</span>=<span class="hl-value">"500"</span>
    <span class="hl-attribute">multicast</span>=<span class="hl-value">"false"</span>
    <span class="hl-attribute">check-length</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>The following example shows how to configure a basic multicast inbound udp channel adapter:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-ip:udp-inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"udpReceiver"</span>
    <span class="hl-attribute">channel</span>=<span class="hl-value">"udpOutChannel"</span>
    <span class="hl-attribute">port</span>=<span class="hl-value">"11111"</span>
    <span class="hl-attribute">receive-buffer-size</span>=<span class="hl-value">"500"</span>
    <span class="hl-attribute">multicast</span>=<span class="hl-value">"true"</span>
    <span class="hl-attribute">multicast-address</span>=<span class="hl-value">"225.6.7.8"</span>
    <span class="hl-attribute">check-length</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>By default, reverse DNS lookups are done on inbound packets to convert IP addresses to hostnames for use in message headers.
In environments where DNS is not configured, this can cause delays.
You can override this default behavior by setting the <code class="literal">lookup-host</code> attribute to <code class="literal">false</code>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_inbound_udp_adapters_java_configuration" href="#_inbound_udp_adapters_java_configuration"></a>34.2.5&nbsp;Inbound UDP Adapters (Java Configuration)</h3></div></div></div>

<p>The following example shows how to configure an inbound UDP adapter with Java:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> UnicastReceivingChannelAdapter udpIn() {
	UnicastReceivingChannelAdapter adapter = <span class="hl-keyword">new</span> UnicastReceivingChannelAdapter(<span class="hl-number">11111</span>);
	adapter.setOutputChannelName(<span class="hl-string">"udpChannel"</span>);
	<span class="hl-keyword">return</span> adapter;
}</pre>
<p>The following example shows how to configure an inbound UDP adapter with the Java DSL:</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_inbound_udp_adapters_java_dsl_configuration" href="#_inbound_udp_adapters_java_dsl_configuration"></a>34.2.6&nbsp;Inbound UDP Adapters (Java DSL Configuration)</h3></div></div></div>

<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> IntegrationFlow udpIn() {
	<span class="hl-keyword">return</span> IntegrationFlows.from(Udp.inboundAdapter(<span class="hl-number">11111</span>))
			.channel(<span class="hl-string">"udpChannel"</span>)
			.get();
}</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_server_listening_events" href="#_server_listening_events"></a>34.2.7&nbsp;Server Listening Events</h3></div></div></div>

<p>Starting with version 5.0.2, a <code class="literal">UdpServerListeningEvent</code> is emitted when an inbound adapter is started and has begun listening.
This is useful when the adapter is configured to listen on port 0, meaning that the operating system chooses the port.
It can also be used instead of polling <code class="literal">isListening()</code>, if you need to wait before starting some other process that will
connect to the socket.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_advanced_outbound_configuration" href="#_advanced_outbound_configuration"></a>34.2.8&nbsp;Advanced Outbound Configuration</h3></div></div></div>

<p>The <code class="literal">&lt;int-ip:udp-outbound-channel-adapter&gt;</code> (<code class="literal">UnicastSendingMessageHandler</code>) has <code class="literal">destination-expression</code> and <code class="literal">socket-expression</code> options.</p>
<p>You can use the <code class="literal">destination-expression</code> as a runtime alternative to the hardcoded <code class="literal">host</code>-<code class="literal">port</code> pair to determine the destination address for the outgoing datagram packet against a <code class="literal">requestMessage</code> (with the root object for the evaluation context).
The expression must evaluate to an <code class="literal">URI</code>, a <code class="literal">String</code> in the URI style (see <a class="ulink" href="http://www.ietf.org/rfc/rfc2396.txt" target="_top">RFC-2396</a>), or a <code class="literal">SocketAddress</code>.
You can also use the inbound <code class="literal">IpHeaders.PACKET_ADDRESS</code> header for this expression.
In the framework, the <code class="literal">DatagramPacketMessageMapper</code> populates this header when we receive datagrams in the <code class="literal">UnicastReceivingChannelAdapter</code> and convert them to messages.
The header value is exactly the result of <code class="literal">DatagramPacket.getSocketAddress()</code> of the incoming datagram.</p>
<p>With the <code class="literal">socket-expression</code>, the outbound channel adapter can use (for example) an inbound channel adapter socket to send datagrams through the same port which they were received.
It is useful in a scenario where our application works as a UDP server and clients operate behind network address translation (NAT).
This expression must evaluate to a <code class="literal">DatagramSocket</code>.
The <code class="literal">requestMessage</code> is used as the root object for the evaluation context.
You cannot use the <code class="literal">socket-expression</code> parameter with the <code class="literal">multicast</code> and <code class="literal">acknowledge</code> parameters.
The following example shows how to configure a UDP inbound channel adapter with a transformer that converts to upper case and uses a socket:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-ip:udp-inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"inbound"</span> <span class="hl-attribute">port</span>=<span class="hl-value">"0"</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"in"</span><span class="hl-tag"> /&gt;</span>

<span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"in"</span><span class="hl-tag"> /&gt;</span>

<span class="hl-tag">&lt;int:transformer</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"new String(payload).toUpperCase()"</span>
                       <span class="hl-attribute">input-channel</span>=<span class="hl-value">"in"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"out"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"out"</span><span class="hl-tag"> /&gt;</span>

<span class="hl-tag">&lt;int-ip:udp-outbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"outbound"</span>
                        <span class="hl-attribute">socket-expression</span>=<span class="hl-value">"@inbound.socket"</span>
                        <span class="hl-attribute">destination-expression</span>=<span class="hl-value">"headers['ip_packetAddress']"</span>
                        <span class="hl-attribute">channel</span>=<span class="hl-value">"out"</span><span class="hl-tag"> /&gt;</span></pre>
</div>
<p>The following example shows the equivalent configuration with the Java DSL:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> IntegrationFlow udpEchoUpcaseServer() {
	<span class="hl-keyword">return</span> IntegrationFlows.from(Udp.inboundAdapter(<span class="hl-number">11111</span>).id(<span class="hl-string">"udpIn"</span>))
			.&lt;<span class="hl-keyword">byte</span>[], String&gt;transform(p -&gt; <span class="hl-keyword">new</span> String(p).toUpperCase())
			.handle(Udp.outboundAdapter(<span class="hl-string">"headers['ip_packetAddress']"</span>)
					.socketExpression(<span class="hl-string">"@udpIn.socket"</span>))
			.get();
}</pre>
</div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="tcp-connection-factories" href="#tcp-connection-factories"></a>34.3&nbsp;TCP Connection Factories</h2></div></div></div>

<p>For TCP, the configuration of the underlying connection is provided by using a connection factory.
Two types of connection factory are provided: a client connection factory and a server connection factory.
Client connection factories establish outgoing connections.
Server connection factories listen for incoming connections.</p>
<p>An outbound channel adapter uses a client connection factory, but you can also provide a reference to a client connection factory to an inbound channel adapter.
That adapter receives any incoming messages that are received on connections created by the outbound adapter.</p>
<p>An inbound channel adapter or gateway uses a server connection factory.
(In fact, the connection factory cannot function without one).
You can also provide a reference to a server connection factory to an outbound adapter.
You can then use that adapter to send replies to incoming messages on the same connection.</p>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>Reply messages are routed to the connection only if the reply contains the <code class="literal">ip_connectionId</code> header that was inserted into the original message by the connection factory.</p>
</td></tr></table></div>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>This is the extent of message correlation performed when sharing connection factories between inbound and outbound adapters.
Such sharing allows for asynchronous two-way communication over TCP.
By default, only payload information is transferred using TCP.
Therefore, any message correlation must be performed by downstream components such as aggregators or other endpoints.
Support for transferring selected headers was introduced in version 3.0.
For more information, see <a class="xref" href="#ip-correlation" title="34.8&nbsp;TCP Message Correlation">Section&nbsp;34.8, &#8220;TCP Message Correlation&#8221;</a>.</p>
</td></tr></table></div>
<p>You may give  a reference to a connection factory to a maximum of one adapter of each type.</p>
<p>Spring Integration provides connection factories that use <code class="literal">java.net.Socket</code> and <code class="literal">java.nio.channel.SocketChannel</code>.</p>
<p>The following example shows a simple server connection factory that uses <code class="literal">java.net.Socket</code> connections:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-ip:tcp-connection-factory</span> <span class="hl-attribute">id</span>=<span class="hl-value">"server"</span>
    <span class="hl-attribute">type</span>=<span class="hl-value">"server"</span>
    <span class="hl-attribute">port</span>=<span class="hl-value">"1234"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>The following example shows a simple server connection factory that uses <code class="literal">java.nio.channel.SocketChannel</code> connections:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-ip:tcp-connection-factory</span> <span class="hl-attribute">id</span>=<span class="hl-value">"server"</span>
    <span class="hl-attribute">type</span>=<span class="hl-value">"server"</span>
    <span class="hl-attribute">port</span>=<span class="hl-value">"1234"</span>
    <span class="hl-attribute">using-nio</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Starting with Spring Integration version 4.2, if the server is configured to listen on a random port (by setting the port to <code class="literal">0</code>), you can get the actual port chosen by the OS by using <code class="literal">getPort()</code>.
Also, <code class="literal">getServerSocketAddress()</code> lets you get the complete <code class="literal">SocketAddress</code>.
See the <a class="ulink" href="https://docs.spring.io/spring-integration/api/org/springframework/integration/ip/tcp/connection/TcpServerConnectionFactory.html" target="_top">Javadoc for the <code class="literal">TcpServerConnectionFactory</code> interface</a> for more information.</p>
</td></tr></table></div>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-ip:tcp-connection-factory</span> <span class="hl-attribute">id</span>=<span class="hl-value">"client"</span>
    <span class="hl-attribute">type</span>=<span class="hl-value">"client"</span>
    <span class="hl-attribute">host</span>=<span class="hl-value">"localhost"</span>
    <span class="hl-attribute">port</span>=<span class="hl-value">"1234"</span>
    <span class="hl-attribute">single-use</span>=<span class="hl-value">"true"</span>
    <span class="hl-attribute">so-timeout</span>=<span class="hl-value">"10000"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>The following example shows a client connection factory that uses <code class="literal">java.net.Socket</code> connections and creates a new connection for each message:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-ip:tcp-connection-factory</span> <span class="hl-attribute">id</span>=<span class="hl-value">"client"</span>
    <span class="hl-attribute">type</span>=<span class="hl-value">"client"</span>
    <span class="hl-attribute">host</span>=<span class="hl-value">"localhost"</span>
    <span class="hl-attribute">port</span>=<span class="hl-value">"1234"</span>
    <span class="hl-attribute">single-use</span>=<span class="hl-value">"true"</span>
    <span class="hl-attribute">so-timeout</span>=<span class="hl-value">"10000"</span>
    <span class="hl-attribute">using-nio</span>=<span class="hl-value">true</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>TCP is a streaming protocol.
This means that some structure has to be provided to data transported over TCP so that the receiver can demarcate the data into discrete messages.
Connection factories are configured to use serializers and deserializers to convert between the message payload and the bits that are sent over TCP.
This is accomplished by providing a deserializer and a serializer for inbound and outbound messages, respectively.
Spring Integration provides a number of standard serializers and deserializers.</p>
<p><code class="literal">ByteArrayCrlfSerializer</code><sup>*</sup> converts a byte array to a stream of bytes followed by carriage return and linefeed characters (<code class="literal">\r\n</code>).
This is the default serializer (and deserializer) and can be used (for example) with telnet as a client.</p>
<p>The <code class="literal">ByteArraySingleTerminatorSerializer</code><sup>*</sup> converts a byte array to a stream of bytes followed by a single termination character (the default is <code class="literal">0x00</code>).</p>
<p>The <code class="literal">ByteArrayLfSerializer</code><sup>*</sup> converts a byte array to a stream of bytes followed by a single linefeed character (<code class="literal">0x0a</code>).</p>
<p>The <code class="literal">ByteArrayStxEtxSerializer</code><sup>*</sup> converts a byte array to a stream of bytes preceded by an STX (<code class="literal">0x02</code>) and followed by an ETX (<code class="literal">0x03</code>).</p>
<p>The <code class="literal">ByteArrayLengthHeaderSerializer</code> converts a byte array to a stream of bytes preceded by a binary length in network byte order (big endian).
This an efficient deserializer because it does not have to parse every byte to look for a termination character sequence.
It can also be used for payloads that contain binary data.
The preceding serializers support only text in the payload.
The default size of the length header is four bytes (an Integer), allowing for messages up to (2^31 - 1) bytes.
However, the <code class="literal">length</code> header can be a single byte (unsigned) for messages up to 255 bytes, or an unsigned short (2 bytes) for messages up to (2^16 - 1) bytes.
If you need any other format for the header, you can subclass <code class="literal">ByteArrayLengthHeaderSerializer</code> and provide implementations for the <code class="literal">readHeader</code> and <code class="literal">writeHeader</code> methods.
The absolute maximum data size is (2^31 - 1) bytes.</p>
<p>The <code class="literal">ByteArrayRawSerializer</code><sup>*</sup>, converts a byte array to a stream of bytes and adds no additional message demarcation data.
With this serializer (and deserializer), the end of a message is indicated by the client closing the socket in an orderly fashion.
When using this serializer, message reception hangs until the client closes the socket or a timeout occurs.
A timeout does not result in a message.
When this serializer is being used and the client is a Spring Integration application, the client must use a connection factory that is configured with <code class="literal">single-use="true"</code>.
Doing so causes the adapter to close the socket after sending the message.
The serializer does not, by itself, close the connection.
You should use this serializer only with the connection factories used by channel adapters (not gateways), and the connection factories should be used by either an inbound or outbound adapter but not both.
See also <code class="literal">ByteArrayElasticRawDeserializer</code>, later in this section.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Before version 4.2.2, when using non-blocking I/O (NIO), this serializer treated a timeout (during read) as an end of file, and the data read so far was emitted as a message.
This is unreliable and should not be used to delimit messages.
It now treats such conditions as an exception.
In the unlikely event that you use it this way, you can restore the previous behavior by setting the <code class="literal">treatTimeoutAsEndOfMessage</code> constructor argument to <code class="literal">true</code>.</p>
</td></tr></table></div>
<p>Each of these is a subclass of <code class="literal">AbstractByteArraySerializer</code>, which implements both <code class="literal">org.springframework.core.serializer.Serializer</code> and <code class="literal">org.springframework.core.serializer.Deserializer</code>.
For backwards compatibility, connections that use any subclass of <code class="literal">AbstractByteArraySerializer</code> for serialization also accept a <code class="literal">String</code> that is first converted to a byte array.
Each of these serializers and deserializers converts an input stream that contains the corresponding format to a byte array payload.</p>
<p>To avoid memory exhaustion due to a badly behaved client (one that does not adhere to the protocol of the configured serializer), these serializers impose a maximum message size.
If an incoming message exceeds this size, an exception is thrown.
The default maximum message size is 2048 bytes.
You can increase it by setting the <code class="literal">maxMessageSize</code> property.
If you use the default serializer or deserializer and wish to increase the maximum message size, you must declare the maximum message size as an explicit bean with the <code class="literal">maxMessageSize</code> property set and configure the connection factory to use that bean.</p>
<p>The classes marked with <sup>*</sup> earlier in this section use an intermediate buffer and copy the decoded data to a final buffer of the correct
size.
Starting with version 4.3, you can configure these buffers by setting a <code class="literal">poolSize</code> property to let these raw buffers be reused instead of being allocated and discarded for each message, which is the default behavior.
Setting the property to a negative value creates a pool that has no bounds.
If the pool is bounded, you can also set the <code class="literal">poolWaitTimeout</code> property (in milliseconds), after which an exception is thrown if no buffer becomes available.
It defaults to infinity.
Such an exception causes the socket to be closed.</p>
<p>If you wish to use the same mechanism in custom deserializers, you can extend <code class="literal">AbstractPooledBufferByteArraySerializer</code> (instead of its super class, <code class="literal">AbstractByteArraySerializer</code>) and implement <code class="literal">doDeserialize()</code> instead of <code class="literal">deserialize()</code>.
The buffer is automatically returned to the pool.
<code class="literal">AbstractPooledBufferByteArraySerializer</code> also provides a convenient utility method: <code class="literal">copyToSizedArray()</code>.</p>
<p>Version 5.0 added the <code class="literal">ByteArrayElasticRawDeserializer</code>.
This is similar to the deserializer side of <code class="literal">ByteArrayRawSerializer</code> above, except that it is not necessary to set a <code class="literal">maxMessageSize</code>.
Internally, it uses a <code class="literal">ByteArrayOutputStream</code> that lets the buffer grow as needed.
The client must close the socket in an orderly manner to signal end of message.</p>
<p>The <code class="literal">MapJsonSerializer</code> uses a Jackson <code class="literal">ObjectMapper</code> to convert between a <code class="literal">Map</code> and JSON.
You can use this serializer in conjunction with a <code class="literal">MessageConvertingTcpMessageMapper</code> and a <code class="literal">MapMessageConverter</code> to transfer selected headers and the payload in JSON.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The Jackson <code class="literal">ObjectMapper</code> cannot demarcate messages in the stream.
Therefore, the <code class="literal">MapJsonSerializer</code> needs to delegate to another serializer or deserializer to handle message demarcation.
By default, a <code class="literal">ByteArrayLfSerializer</code> is used, resulting in messages with a format of <code class="literal">&lt;json&gt;&lt;LF&gt;</code> on the wire, but you can configure it to use others instead. (The next example shows how to do so.)</p>
</td></tr></table></div>
<p>The final standard serializer is <code class="literal">org.springframework.core.serializer.DefaultSerializer</code>, which you can use to convert serializable objects with Java serialization.
<code class="literal">org.springframework.core.serializer.DefaultDeserializer</code> is provided for inbound deserialization of streams that contain serializable objects.</p>
<p>To implement a custom serializer and deserializer pair, implement the <code class="literal">org.springframework.core.serializer.Deserializer</code> and <code class="literal">org.springframework.core.serializer.Serializer</code> interfaces.</p>
<p>If you do not wish to use the default serializer and deserializer (<code class="literal">ByteArrayCrLfSerializer</code>), you must set the <code class="literal">serializer</code> and <code class="literal">deserializer</code> attributes on the connection factory.
The following example shows how to do so:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"javaSerializer"</span>
      <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.core.serializer.DefaultSerializer"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"javaDeserializer"</span>
      <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.core.serializer.DefaultDeserializer"</span><span class="hl-tag"> /&gt;</span>

<span class="hl-tag">&lt;int-ip:tcp-connection-factory</span> <span class="hl-attribute">id</span>=<span class="hl-value">"server"</span>
    <span class="hl-attribute">type</span>=<span class="hl-value">"server"</span>
    <span class="hl-attribute">port</span>=<span class="hl-value">"1234"</span>
    <span class="hl-attribute">deserializer</span>=<span class="hl-value">"javaDeserializer"</span>
    <span class="hl-attribute">serializer</span>=<span class="hl-value">"javaSerializer"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>A server connection factory that uses <code class="literal">java.net.Socket</code> connections and uses Java serialization on the wire.</p>
<p>For full details of the attributes available on connection factories, see <a class="link" href="#ip-annotation" title="34.14&nbsp;Annotation-Based Configuration">the reference</a> at the end of this section.</p>
<p>By default, reverse DNS lookups are done on inbound packets to convert IP addresses to hostnames for use in message headers.
In environments where DNS is not configured, this can cause connection delays.
You can override this default behavior by setting the <code class="literal">lookup-host</code> attribute to <code class="literal">false</code>.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>You can also modify the attributes of sockets and socket factories.
See <a class="xref" href="#ssl-tls" title="34.10&nbsp;SSL/TLS Support">Section&nbsp;34.10, &#8220;SSL/TLS Support&#8221;</a>.
As noted there, such modifications are possible whether or not SSL is being used.</p>
</td></tr></table></div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="caching-cf" href="#caching-cf"></a>34.3.1&nbsp;TCP Caching Client Connection Factory</h3></div></div></div>

<p>As <a class="link" href="#ip-intro" title="34.1&nbsp;Introduction">noted earlier</a>, TCP sockets can be <span class="emphasis"><em>single-use</em></span> (one request or response) or shared.
Shared sockets do not perform well with outbound gateways in high-volume environments, because the socket can only process one request or response at a time.</p>
<p>To improve performance, you can use collaborating channel adapters instead of gateways, but that requires application-level message correlation.
See <a class="xref" href="#ip-correlation" title="34.8&nbsp;TCP Message Correlation">Section&nbsp;34.8, &#8220;TCP Message Correlation&#8221;</a> for more information.</p>
<p>Spring Integration 2.2 introduced a caching client connection factory, which uses a pool of shared sockets, letting a gateway process multiple concurrent requests with a pool of shared connections.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="failover-cf" href="#failover-cf"></a>34.3.2&nbsp;TCP Failover Client Connection Factory</h3></div></div></div>

<p>You can configure a TCP connection factory that supports failover to one or more other servers.
When sending a message, the factory iterates over all its configured factories until either the message can be sent or no connection can be found.
Initially, the first factory in the configured list is used.
If a connection subsequently fails, the next factory becomes the current factory.
The following example shows how to configure a failover client connection factory:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"failCF"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.ip.tcp.connection.FailoverClientConnectionFactory"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg&gt;</span>
        <span class="hl-tag">&lt;list&gt;</span>
            <span class="hl-tag">&lt;ref</span> <span class="hl-attribute">bean</span>=<span class="hl-value">"clientFactory1"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;ref</span> <span class="hl-attribute">bean</span>=<span class="hl-value">"clientFactory2"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/list&gt;</span>
    <span class="hl-tag">&lt;/constructor-arg&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
</div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>When using the failover connection factory, the <code class="literal">singleUse</code> property must be consistent between the factory itself and the list of factories it is configured to use.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="tcp-affinity-cf" href="#tcp-affinity-cf"></a>34.3.3&nbsp;TCP Thread Affinity Connection Factory</h3></div></div></div>

<p>Spring Integration version 5.0 introduced this connection factory.
It binds a connection to the calling thread, and the same connection is reused each time that thread sends a message.
This continues until the connection is closed (by the server or the network) or until the thread calls the <code class="literal">releaseConnection()</code> method.
The connections themselves are provided by another client factory implementation, which must be configured to provide non-shared (single-use) connections so that each thread gets a connection.</p>
<p>The following example shows how to configure a TCP thread affinity connection factory:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> TcpNetClientConnectionFactory cf() {
    TcpNetClientConnectionFactory cf = <span class="hl-keyword">new</span> TcpNetClientConnectionFactory(<span class="hl-string">"localhost"</span>,
            Integer.parseInt(System.getProperty(PORT)));
    cf.setSingleUse(true);
    <span class="hl-keyword">return</span> cf;
}

<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> ThreadAffinityClientConnectionFactory tacf() {
    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> ThreadAffinityClientConnectionFactory(cf());
}

<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "out")</span></em>
<span class="hl-keyword">public</span> TcpOutboundGateway outGate() {
    TcpOutboundGateway outGate = <span class="hl-keyword">new</span> TcpOutboundGateway();
    outGate.setConnectionFactory(tacf());
    outGate.setReplyChannelName(<span class="hl-string">"toString"</span>);
    <span class="hl-keyword">return</span> outGate;
}</pre>
</div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="ip-interceptors" href="#ip-interceptors"></a>34.4&nbsp;TCP Connection Interceptors</h2></div></div></div>

<p>You can configure connection factories with a reference to a <code class="literal">TcpConnectionInterceptorFactoryChain</code>.
You can use interceptors to add behavior to connections, such as negotiation, security, and other options.
No interceptors are currently provided by the framework, but see <a class="ulink" href="https://github.com/spring-projects/spring-integration/blob/master/spring-integration-ip/src/test/java/org/springframework/integration/ip/tcp/InterceptedSharedConnectionTests.java" target="_top"><code class="literal">InterceptedSharedConnectionTests</code> in the source repository</a> for an example.</p>
<p>The <code class="literal">HelloWorldInterceptor</code> used in the test case works as follows:</p>
<p>The interceptor is first configured with a client connection factory.
When the first message is sent over an intercepted connection, the interceptor sends <span class="emphasis"><em>Hello</em></span> over the connection and expects to receive <span class="emphasis"><em>world!</em></span>.
When that occurs, the negotiation is complete and the original message is sent.
Further messages that use the same connection are sent without any additional negotiation.</p>
<p>When configured with a server connection factory, the interceptor requires the first message to be <span class="emphasis"><em>Hello</em></span> and, if it is, returns <span class="emphasis"><em>world!</em></span>.
Otherwise it throws an exception that causes the connection to be closed.</p>
<p>All <code class="literal">TcpConnection</code> methods are intercepted.
Interceptor instances are created for each connection by an interceptor factory.
If an interceptor is stateful, the factory should create a new instance for each connection.
If there is no state, the same interceptor can wrap each connection.
Interceptor factories are added to the configuration of an interceptor factory chain, which you can provide to a connection factory by setting the <code class="literal">interceptor-factory</code> attribute.
Interceptors must extend <code class="literal">TcpConnectionInterceptorSupport</code>.
Factories must implement the <code class="literal">TcpConnectionInterceptorFactory</code> interface.
<code class="literal">TcpConnectionInterceptorSupport</code> has passthrough methods.
By extending this class, you only need to implement those methods you wish to intercept.</p>
<p>The following example shows how to configure a connection interceptor factory chain:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"helloWorldInterceptorFactory"</span>
    <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.ip.tcp.connection.TcpConnectionInterceptorFactoryChain"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"interceptors"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;array&gt;</span>
            <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.ip.tcp.connection.HelloWorldInterceptorFactory"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/array&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;int-ip:tcp-connection-factory</span> <span class="hl-attribute">id</span>=<span class="hl-value">"server"</span>
    <span class="hl-attribute">type</span>=<span class="hl-value">"server"</span>
    <span class="hl-attribute">port</span>=<span class="hl-value">"12345"</span>
    <span class="hl-attribute">using-nio</span>=<span class="hl-value">"true"</span>
    <span class="hl-attribute">single-use</span>=<span class="hl-value">"true"</span>
    <span class="hl-attribute">interceptor-factory-chain</span>=<span class="hl-value">"helloWorldInterceptorFactory"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int-ip:tcp-connection-factory</span> <span class="hl-attribute">id</span>=<span class="hl-value">"client"</span>
    <span class="hl-attribute">type</span>=<span class="hl-value">"client"</span>
    <span class="hl-attribute">host</span>=<span class="hl-value">"localhost"</span>
    <span class="hl-attribute">port</span>=<span class="hl-value">"12345"</span>
    <span class="hl-attribute">single-use</span>=<span class="hl-value">"true"</span>
    <span class="hl-attribute">so-timeout</span>=<span class="hl-value">"100000"</span>
    <span class="hl-attribute">using-nio</span>=<span class="hl-value">"true"</span>
    <span class="hl-attribute">interceptor-factory-chain</span>=<span class="hl-value">"helloWorldInterceptorFactory"</span><span class="hl-tag">/&gt;</span></pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="tcp-events" href="#tcp-events"></a>34.5&nbsp;TCP Connection Events</h2></div></div></div>

<p>Beginning with version 3.0, changes to <code class="literal">TcpConnection</code> instances are reported by <code class="literal">TcpConnectionEvent</code> instances.
<code class="literal">TcpConnectionEvent</code> is a subclass of <code class="literal">ApplicationEvent</code> and can thus be received by any <code class="literal">ApplicationListener</code> defined in the <code class="literal">ApplicationContext</code>&#8201;&#8212;&#8201;for example <a class="link" href="#appevent-inbound" title="15.1&nbsp;Receiving Spring Application Events">an event inbound channel adapter</a>.</p>
<p><code class="literal">TcpConnectionEvents</code> have the following properties:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">connectionId</code>: The connection identifier, which you can use in a message header to send data to the connection.
</li><li class="listitem">
<code class="literal">connectionFactoryName</code>: The bean name of the connection factory to which the connection belongs.
</li><li class="listitem">
<code class="literal">throwable</code>: The <code class="literal">Throwable</code> (for <code class="literal">TcpConnectionExceptionEvent</code> events only).
</li><li class="listitem">
<code class="literal">source</code>: The <code class="literal">TcpConnection</code>. You can use this, for example, to determine the remote IP Address with <code class="literal">getHostAddress()</code> (cast required).
</li></ul></div>
<p>In addition, since version 4.0, the standard deserializers discussed in <a class="xref" href="#tcp-connection-factories" title="34.3&nbsp;TCP Connection Factories">Section&nbsp;34.3, &#8220;TCP Connection Factories&#8221;</a> now emit <code class="literal">TcpDeserializationExceptionEvent</code> instances when they encounter problems while decoding the data stream.
These events contain the exception, the buffer that was in the process of being built, and an offset into the buffer (if available) at the point where the exception occurred.
Applications can use a normal <code class="literal">ApplicationListener</code> or an <code class="literal">ApplicationEventListeningMessageProducer</code> (see <a class="xref" href="#appevent-inbound" title="15.1&nbsp;Receiving Spring Application Events">Section&nbsp;15.1, &#8220;Receiving Spring Application Events&#8221;</a>) to capture these events, allowing analysis of the problem.</p>
<p>Starting with versions 4.0.7 and 4.1.3, <code class="literal">TcpConnectionServerExceptionEvent</code> instances are published whenever an unexpected exception occurs on a server socket (such as a <code class="literal">BindException</code> when the server socket is in use).
These events have a reference to the connection factory and the cause.</p>
<p>Starting with version 4.2, <code class="literal">TcpConnectionFailedCorrelationEvent</code> instances are published whenever an endpoint (inbound gateway or
collaborating outbound channel adapter) receives a message that cannot be routed to a connection because the
<code class="literal">ip_connectionId</code> header is invalid.
Outbound gateways also publish this event when a late reply is received (the sender thread has timed out).
The event contains the connection ID as well as an exception in the <code class="literal">cause</code> property, which contains the failed message.</p>
<p>Starting with version 4.3, a <code class="literal">TcpConnectionServerListeningEvent</code> is emitted when a server connection factory is started.
This is useful when the factory is configured to listen on port 0, meaning that the operating system chooses the port.
It can also be used instead of polling <code class="literal">isListening()</code>, if you need to wait before starting some other process that connects to the socket.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>To avoid delaying the listening thread from accepting connections, the event is published on a separate thread.</p>
</td></tr></table></div>
<p>Starting with version 4.3.2, a <code class="literal">TcpConnectionFailedEvent</code> is emitted whenever a client connection cannot be created.
The source of the event is the connection factory, which you can use to determine the host and port to which the connection could not be established.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="tcp-adapters" href="#tcp-adapters"></a>34.6&nbsp;TCP Adapters</h2></div></div></div>

<p>TCP inbound and outbound channel adapters that use connection factories <a class="link" href="#tcp-events" title="34.5&nbsp;TCP Connection Events">mentioned earlier</a> are provided.
These adapters have two relevant attributes: <code class="literal">connection-factory</code> and <code class="literal">channel</code>.
The <code class="literal">connection-factory</code> attribute indicates which connection factory is to be used to manage connections for the adapter.
The <code class="literal">channel</code> attribute specifies the channel on which messages arrive at an outbound adapter and on which messages are placed by an inbound adapter.
While both inbound and outbound adapters can share a connection factory, server connection factories are always "<code class="literal">owned</code>" by an inbound adapter.
Client connection factories are always "<code class="literal">owned</code>" by an outbound adapter.
Only one adapter of each type may get a reference to a connection factory.
The following example shows how to define client and server TCP connection factories:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"javaSerializer"</span>
      <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.core.serializer.DefaultSerializer"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"javaDeserializer"</span>
      <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.core.serializer.DefaultDeserializer"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int-ip:tcp-connection-factory</span> <span class="hl-attribute">id</span>=<span class="hl-value">"server"</span>
    <span class="hl-attribute">type</span>=<span class="hl-value">"server"</span>
    <span class="hl-attribute">port</span>=<span class="hl-value">"1234"</span>
    <span class="hl-attribute">deserializer</span>=<span class="hl-value">"javaDeserializer"</span>
    <span class="hl-attribute">serializer</span>=<span class="hl-value">"javaSerializer"</span>
    <span class="hl-attribute">using-nio</span>=<span class="hl-value">"true"</span>
    <span class="hl-attribute">single-use</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int-ip:tcp-connection-factory</span> <span class="hl-attribute">id</span>=<span class="hl-value">"client"</span>
    <span class="hl-attribute">type</span>=<span class="hl-value">"client"</span>
    <span class="hl-attribute">host</span>=<span class="hl-value">"localhost"</span>
    <span class="hl-attribute">port</span>=<span class="hl-value">"#{server.port}"</span>
    <span class="hl-attribute">single-use</span>=<span class="hl-value">"true"</span>
    <span class="hl-attribute">so-timeout</span>=<span class="hl-value">"10000"</span>
    <span class="hl-attribute">deserializer</span>=<span class="hl-value">"javaDeserializer"</span>
    <span class="hl-attribute">serializer</span>=<span class="hl-value">"javaSerializer"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"input"</span><span class="hl-tag"> /&gt;</span>

<span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"replies"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:queue/&gt;</span>
<span class="hl-tag">&lt;/int:channel&gt;</span>

<span class="hl-tag">&lt;int-ip:tcp-outbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"outboundClient"</span>
    <span class="hl-attribute">channel</span>=<span class="hl-value">"input"</span>
    <span class="hl-attribute">connection-factory</span>=<span class="hl-value">"client"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int-ip:tcp-inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"inboundClient"</span>
    <span class="hl-attribute">channel</span>=<span class="hl-value">"replies"</span>
    <span class="hl-attribute">connection-factory</span>=<span class="hl-value">"client"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int-ip:tcp-inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"inboundServer"</span>
    <span class="hl-attribute">channel</span>=<span class="hl-value">"loop"</span>
    <span class="hl-attribute">connection-factory</span>=<span class="hl-value">"server"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int-ip:tcp-outbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"outboundServer"</span>
    <span class="hl-attribute">channel</span>=<span class="hl-value">"loop"</span>
    <span class="hl-attribute">connection-factory</span>=<span class="hl-value">"server"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"loop"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>In the preceding configuration, messages arriving in the <code class="literal">input</code> channel are serialized over connections created by <code class="literal">client</code> connection factory, received at the server, and placed on the <code class="literal">loop</code> channel.
Since <code class="literal">loop</code> is the input channel for <code class="literal">outboundServer</code>, the message is looped back over the same connection, received by <code class="literal">inboundClient</code>, and deposited in the <code class="literal">replies</code> channel.
Java serialization is used on the wire.</p>
<p>Normally, inbound adapters use a <code class="literal">type="server"</code> connection factory, which listens for incoming connection requests.
In some cases, you may want to establish the connection in reverse, such that the inbound adapter connects to an external server and then waits for inbound messages on that connection.</p>
<p>This topology is supported by setting <code class="literal">client-mode="true"</code> on the inbound adapter.
In this case, the connection factory must be of type <code class="literal">client</code> and must have <code class="literal">single-use</code> set to <code class="literal">false</code>.</p>
<p>Two additional attributes support this mechanism. <code class="literal">retry-interval</code> specifies (in milliseconds) how often the framework attempts to reconnect after a connection failure.
<code class="literal">scheduler</code> supplies a <code class="literal">TaskScheduler</code> to schedule the connection attempts and to test that the connection is still active.</p>
<p>If you don&#8217;t provide a scheduler, the framework&#8217;s default <a class="link" href="#namespace-taskscheduler" title="E.2&nbsp;Configuring the Task Scheduler">taskScheduler</a> bean is used.</p>
<p>For an outbound adapter, the connection is normally established when the first message is sent.
<code class="literal">client-mode="true"</code> on an outbound adapter causes the connection to be established when the adapter is started.
By default, adapters are automatically started.
Again, the connection factory must be of type <code class="literal">client</code> and have <code class="literal">single-use="false"</code>.
<code class="literal">retry-interval</code> and <code class="literal">scheduler</code> are also supported.
If a connection fails, it is re-established either by the scheduler or when the next message is sent.</p>
<p>For both inbound and outbound, if the adapter is started, you can force the adapter to establish a connection by sending a <code class="literal">&lt;control-bus /&gt;</code> command: <code class="literal">@adapter_id.retryConnection()</code>.
Then you can examine the current state with <code class="literal">@adapter_id.isClientModeConnected()</code>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="tcp-gateways" href="#tcp-gateways"></a>34.7&nbsp;TCP Gateways</h2></div></div></div>

<p>The inbound TCP gateway <code class="literal">TcpInboundGateway</code> and outbound TCP gateway <code class="literal">TcpOutboundGateway</code> use a server and client connection factory, respectively.
Each connection can process a single request or response at a time.</p>
<p>The inbound gateway, after constructing a message with the incoming payload and sending it to the <code class="literal">requestChannel</code>, waits for a response and sends the payload from the response message by writing it to the connection.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>For the inbound gateway, you must retain or populate, the <code class="literal">ip_connectionId</code> header, because it is used to correlate the message to a connection.
Messages that originate at the gateway automatically have the header set.
If the reply is constructed as a new message, you need to set the header.
The header value can be captured from the incoming message.</p>
</td></tr></table></div>
<p>As with inbound adapters, inbound gateways normally use a <code class="literal">type="server"</code> connection factory, which listens for incoming connection requests.
In some cases, you may want to establish the connection in reverse, such that the inbound gateway connects to an external server and then waits for and replies to inbound messages on that connection.</p>
<p>This topology is supported by using <code class="literal">client-mode="true"</code> on the inbound gateway.
In this case, the connection factory must be of type <code class="literal">client</code> and must have <code class="literal">single-use</code> set to <code class="literal">false</code>.</p>
<p>Two additional attributes support this mechanism.
<code class="literal">retry-interval</code> specifies (in milliseconds) how often the framework tries to reconnect after a connection failure.
<code class="literal">scheduler</code> supplies a <code class="literal">TaskScheduler</code> to schedule the connection attempts and to test that the connection is still active.</p>
<p>If the gateway is started, you may force the gateway to establish a connection by sending a &lt;control-bus /&gt; command: <code class="literal">@adapter_id.retryConnection()</code> and examine the current state with <code class="literal">@adapter_id.isClientModeConnected()</code>.</p>
<p>The outbound gateway, after sending a message over the connection, waits for a response, constructs a response message, and puts it on the reply channel.
Communications over the connections are single-threaded.
Only one message can be handled at a time.
If another thread attempts to send a message before the current response has been received, it blocks until any previous requests are complete (or time out).
If, however, the client connection factory is configured for single-use connections, each new request gets its own connection and is processed immediately.
The following example configures an inbound TCP gateway:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-ip:tcp-inbound-gateway</span> <span class="hl-attribute">id</span>=<span class="hl-value">"inGateway"</span>
    <span class="hl-attribute">request-channel</span>=<span class="hl-value">"tcpChannel"</span>
    <span class="hl-attribute">reply-channel</span>=<span class="hl-value">"replyChannel"</span>
    <span class="hl-attribute">connection-factory</span>=<span class="hl-value">"cfServer"</span>
    <span class="hl-attribute">reply-timeout</span>=<span class="hl-value">"10000"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>If a connection factory configured with the default serializer or deserializer is used, messages is <code class="literal">\r\n</code> delimited data and the gateway can be used by a simple client such as telnet.</p>
<p>The following example shows an outbound TCP gateway:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-ip:tcp-outbound-gateway</span> <span class="hl-attribute">id</span>=<span class="hl-value">"outGateway"</span>
    <span class="hl-attribute">request-channel</span>=<span class="hl-value">"tcpChannel"</span>
    <span class="hl-attribute">reply-channel</span>=<span class="hl-value">"replyChannel"</span>
    <span class="hl-attribute">connection-factory</span>=<span class="hl-value">"cfClient"</span>
    <span class="hl-attribute">request-timeout</span>=<span class="hl-value">"10000"</span>
    <span class="hl-attribute">remote-timeout</span>=<span class="hl-value">"10000"</span><span class="hl-tag">/&gt;</span> <span class="hl-comment">&lt;!-- or e.g.
remote-timeout-expression="headers['timeout']" --&gt;</span></pre>
</div>
<p><code class="literal">client-mode</code> is not currently available with the outbound gateway.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="ip-correlation" href="#ip-correlation"></a>34.8&nbsp;TCP Message Correlation</h2></div></div></div>

<p>One goal of the IP endpoints is to provide communication with systems other than Spring Integration applications.
For this reason, only message payloads are sent and received by default.
Since 3.0, you can transfer headers by using JSON, Java serialization, or custom serializers and deserializers.
See <a class="xref" href="#ip-headers" title="34.8.3&nbsp;Transferring Headers">Section&nbsp;34.8.3, &#8220;Transferring Headers&#8221;</a> for more information.
No message correlation is provided by the framework (except when using the gateways) or collaborating channel adapters on the server side.
<a class="link" href="#ip-collaborating-adapters" title="34.8.2&nbsp;Collaborating Outbound and Inbound Channel Adapters">Later in this document</a>, we discuss the various correlation techniques available to applications.
In most cases, this requires specific application-level correlation of messages, even when message payloads contain some natural correlation data (such as an order number).</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="ip-gateways" href="#ip-gateways"></a>34.8.1&nbsp;Gateways</h3></div></div></div>

<p>Gateways automatically correlate messages.
However, you should use an outbound gateway for relatively low-volume applications.
When you configure the connection factory to use a single shared connection for all message pairs (<span class="emphasis"><em>single-use="false"</em></span>), only one message can be processed at a time.
A new message has to wait until the reply to the previous message has been received.
When a connection factory is configured for each new message to use a new connection (<span class="emphasis"><em>single-use="true"</em></span>), this restriction does not apply.
While this setting can give higher throughput than a shared connection environment, it comes with the overhead of opening and closing a new connection for each message pair.</p>
<p>Therefore, for high-volume messages, consider using a collaborating pair of channel adapters.
However, to do so, you need to provide collaboration logic.</p>
<p>Another solution, introduced in Spring Integration 2.2, is to use a <code class="literal">CachingClientConnectionFactory</code>, which allows the use of a pool of shared connections.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="ip-collaborating-adapters" href="#ip-collaborating-adapters"></a>34.8.2&nbsp;Collaborating Outbound and Inbound Channel Adapters</h3></div></div></div>

<p>To achieve high-volume throughput (avoiding the pitfalls of using gateways, as <a class="link" href="#ip-gateways" title="34.8.1&nbsp;Gateways">mentioned earlier</a>) you can configure a pair of collaborating outbound and inbound channel adapters.
You can also use collaborating adapters (server-side or client-side) for totally asynchronous communication (rather than with request-reply semantics).
On the server side, message correlation is automatically handled by the adapters, because the inbound adapter adds a header that allows the outbound adapter to determine which connection to use when sending the reply message.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>On the server side, you must populate the <code class="literal">ip_connectionId</code> header, because it is used to correlate the message to a connection.
Messages that originate at the inbound adapter automatically have the header set.
If you wish to construct other messages to send, you need to set the header.
You can get the header value from an incoming message.</p>
</td></tr></table></div>
<p>On the client side, the application must provide its own correlation logic, if needed.
You can do so in a number of ways.</p>
<p>If the message payload has some natural correlation data (such as a transaction ID or an order number) and you have no need to retain any information (such as a reply channel header) from the original outbound message, the correlation is simple and would be done at the application level in any case.</p>
<p>If the message payload has some natural correlation data (such as a transaction ID or an order number), but you need to retain some information (such as a reply channel header) from the original outbound message, you can retain a copy of the original outbound message (perhaps by using a publish-subscribe channel) and use an aggregator to recombine the necessary data.</p>
<p>For either of the previous two scenarios, if the payload has no natural correlation data, you can provide a transformer upstream of the outbound channel adapter to enhance the payload with such data.
Such a transformer may transform the original payload to a new object that contains both the original payload and some subset of the message headers.
Of course, live objects (such as reply channels) from the headers cannot be included in the transformed payload.</p>
<p>If you choose such a strategy, you need to ensure the connection factory has an appropriate serializer-deserializer pair to handle such a payload (such as <code class="literal">DefaultSerializer</code> and <code class="literal">DefaultDeserializer</code>, which use java serialization, or a custom serializer and deserializer).
The <code class="literal">ByteArray*Serializer</code> options mentioned in <a class="xref" href="#tcp-connection-factories" title="34.3&nbsp;TCP Connection Factories">Section&nbsp;34.3, &#8220;TCP Connection Factories&#8221;</a>, including the default <code class="literal">ByteArrayCrLfSerializer</code>, do not support such payloads unless the transformed payload is a <code class="literal">String</code> or <code class="literal">byte[]</code>.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Before the 2.2 release, when collaborating channel adapters used a client connection factory, the <code class="literal">so-timeout</code> attribute defaulted to the default reply timeout (10 seconds).
This meant that, if no data were received by the inbound adapter for this period of time, the socket was closed.</p>
<p>This default behavior was not appropriate in a truly asynchronous environment, so it now defaults to an infinite timeout.
You can reinstate the previous default behavior by setting the <code class="literal">so-timeout</code> attribute on the client connection factory to 10000 milliseconds.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="ip-headers" href="#ip-headers"></a>34.8.3&nbsp;Transferring Headers</h3></div></div></div>

<p>TCP is a streaming protocol.
<code class="literal">Serializers</code> and <code class="literal">Deserializers</code> demarcate messages within the stream.
Prior to 3.0, only message payloads (<code class="literal">String</code> or <code class="literal">byte[]</code>) could be transferred over TCP.
Beginning with 3.0, you can transfer selected headers as well as the payload.
However, "<code class="literal">live</code>" objects, such as the <code class="literal">replyChannel</code> header, cannot be serialized.</p>
<p>Sending header information over TCP requires some additional configuration.</p>
<p>The first step is to provide the <code class="literal">ConnectionFactory</code> with a <code class="literal">MessageConvertingTcpMessageMapper</code> that uses the <code class="literal">mapper</code> attribute.
This mapper delegates to any <code class="literal">MessageConverter</code> implementation to convert the message to and from some object that can be serialized and deserialized by the configured <code class="literal">serializer</code> and <code class="literal">deserializer</code>.</p>
<p>Spring Integration provides a <code class="literal">MapMessageConverter</code>, which allows the specification of a list of headers that are added to a <code class="literal">Map</code> object, along with the payload.
The generated Map has two entries: <code class="literal">payload</code> and <code class="literal">headers</code>.
The <code class="literal">headers</code> entry is itself a <code class="literal">Map</code> and contains the selected headers.</p>
<p>The second step is to provide a serializer and a deserializer that can convert between a <code class="literal">Map</code> and some wire format.
This can be a custom <code class="literal">Serializer</code> or <code class="literal">Deserializer</code>, which you typically need if the peer system is not a Spring Integration application.</p>
<p>Spring Integration provides a <code class="literal">MapJsonSerializer</code> to convert a <code class="literal">Map</code> to and from JSON.
It uses a Spring Integration <code class="literal">JsonObjectMapper</code>.
You can provide a custom <code class="literal">JsonObjectMapper</code> if needed.
By default, the serializer inserts a linefeed (<code class="literal">0x0a</code>) character between objects.
See the <a class="ulink" href="https://docs.spring.io/spring-integration/api/org/springframework/integration/ip/tcp/serializer/MapJsonSerializer.html" target="_top">Javadoc</a> for more information.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The <code class="literal">JsonObjectMapper</code> uses whichever version of <code class="literal">Jackson</code> is on the classpath.</p>
</td></tr></table></div>
<p>You can also use standard Java serialization of the <code class="literal">Map</code>, by using the <code class="literal">DefaultSerializer</code> and <code class="literal">DefaultDeserializer</code>.</p>
<p>The following example shows the configuration of a connection factory that transfers the <code class="literal">correlationId</code>, <code class="literal">sequenceNumber</code>, and <code class="literal">sequenceSize</code> headers by using JSON:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-ip:tcp-connection-factory</span> <span class="hl-attribute">id</span>=<span class="hl-value">"client"</span>
    <span class="hl-attribute">type</span>=<span class="hl-value">"client"</span>
    <span class="hl-attribute">host</span>=<span class="hl-value">"localhost"</span>
    <span class="hl-attribute">port</span>=<span class="hl-value">"12345"</span>
    <span class="hl-attribute">mapper</span>=<span class="hl-value">"mapper"</span>
    <span class="hl-attribute">serializer</span>=<span class="hl-value">"jsonSerializer"</span>
    <span class="hl-attribute">deserializer</span>=<span class="hl-value">"jsonSerializer"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"mapper"</span>
      <span class="hl-attribute">class</span>=<span class="hl-value">"o.sf.integration.ip.tcp.connection.MessageConvertingTcpMessageMapper"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">name</span>=<span class="hl-value">"messageConverter"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.sf.integration.support.converter.MapMessageConverter"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"headerNames"</span><span class="hl-tag">&gt;</span>
                <span class="hl-tag">&lt;list&gt;</span>
                    <span class="hl-tag">&lt;value&gt;</span>correlationId<span class="hl-tag">&lt;/value&gt;</span>
                    <span class="hl-tag">&lt;value&gt;</span>sequenceNumber<span class="hl-tag">&lt;/value&gt;</span>
                    <span class="hl-tag">&lt;value&gt;</span>sequenceSize<span class="hl-tag">&lt;/value&gt;</span>
                <span class="hl-tag">&lt;/list&gt;</span>
            <span class="hl-tag">&lt;/property&gt;</span>
        <span class="hl-tag">&lt;/bean&gt;</span>
    <span class="hl-tag">&lt;/constructor-arg&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"jsonSerializer"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.sf.integration.ip.tcp.serializer.MapJsonSerializer"</span><span class="hl-tag"> /&gt;</span></pre>
</div>
<p>A message sent with the preceding configuration, with a payload of <span class="emphasis"><em>something</em></span> would appear on the wire as follows:</p>
<div class="informalexample">
<pre class="programlisting">{"headers":{"correlationId":"things","sequenceSize":5,"sequenceNumber":1},"payload":"something"}</pre>
</div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="note_nio" href="#note_nio"></a>34.9&nbsp;About Non-blocking I/O (NIO)</h2></div></div></div>

<p>Using NIO (see <code class="literal">using-nio</code> in <a class="xref" href="#ip-endpoint-reference" title="34.12&nbsp;IP Configuration Attributes">Section&nbsp;34.12, &#8220;IP Configuration Attributes&#8221;</a>) avoids dedicating a thread to read from each socket.
For a small number of sockets, you are likely to find that not using NIO, together with an asynchronous handoff (such as to a <code class="literal">QueueChannel</code>), performs as well as or better than using NIO.</p>
<p>You should consider using NIO when handling a large number of connections.
However, the use of NIO has some other ramifications.
A pool of threads (in the task executor) is shared across all the sockets.
Each incoming message is assembled and sent to the configured channel as a separate unit of work on a thread selected from that pool.
Two sequential messages arriving on the same socket might be processed by different threads.
This means that the order in which the messages are sent to the channel is indeterminate.
Strict ordering of the messages arriving on the socket is not maintained.</p>
<p>For some applications, this is not an issue.
For others, it is a problem.
If you require strict ordering, consider setting <code class="literal">using-nio</code> to <code class="literal">false</code> and using an asynchronous handoff.</p>
<p>Alternatively, you can insert a resequencer downstream of the inbound endpoint to return the messages to their proper sequence.
If you set <code class="literal">apply-sequence</code> to <code class="literal">true</code> on the connection factory, messages arriving on a TCP connection have <code class="literal">sequenceNumber</code> and <code class="literal">correlationId</code> headers set.
The resequencer uses these headers to return the messages to their proper sequence.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_pool_size" href="#_pool_size"></a>34.9.1&nbsp;Pool Size</h3></div></div></div>

<p>The pool size attribute is no longer used.
Previously, it specified the size of the default thread pool when a task-executor was not specified.
It was also used to set the connection backlog on server sockets.
The first function is no longer needed (see the next paragraph).
The second function is replaced by the <code class="literal">backlog</code> attribute.</p>
<p>Previously, when using a fixed thread pool task executor (which was the default) with NIO, it was possible to get a deadlock and processing would stop.
The problem occurred when a buffer was full, a thread reading from the socket was trying to add more data to the buffer, and no threads were available to make space in the buffer.
This only occurred with a very small pool size, but it could be possible under extreme conditions.
Since 2.2, two changes have eliminated this problem.
First, the default task executor is a cached thread pool executor.
Second, deadlock detection logic has been added such that, if thread starvation occurs, instead of deadlocking, an exception is thrown, thus releasing the deadlocked resources.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Now that the default task executor is unbounded, it is possible that an out-of-memory condition might occur with high rates of incoming messages, if message processing takes extended time.
If your application exhibits this type of behavior, you should use a pooled task executor with an appropriate pool size, but see <a class="link" href="#io-thread-pool-task-executor-caller-runs" title="34.9.2&nbsp;Thread Pool Task Executor with CALLER_RUNS Policy">the next section</a>.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="io-thread-pool-task-executor-caller-runs" href="#io-thread-pool-task-executor-caller-runs"></a>34.9.2&nbsp;Thread Pool Task Executor with <code class="literal">CALLER_RUNS</code> Policy</h3></div></div></div>

<p>You should keep in mind some important considerations when you use a fixed thread pool with the <code class="literal">CallerRunsPolicy</code> (<code class="literal">CALLER_RUNS</code> when using the <code class="literal">&lt;task/&gt;</code> namespace) and the queue capacity is small.</p>
<p>The following does not apply if you do not use a fixed thread pool.</p>
<p>With NIO connections, there are three distinct task types. The I/O selector processing is performed on one dedicated thread (detecting events, accepting new connections, and dispatching the I/O read operations to other threads by using the task executor).
When an I/O reader thread (to which the read operation is dispatched) reads data, it hands off to another thread to assemble the incoming message.
Large messages can take several reads to complete.
These "<code class="literal">assembler</code>" threads can block while waiting for data.
When a new read event occurs, the reader determines if this socket already has an assembler and, if not, runs a new one.
When the assembly process is complete, the assembler thread is returned to the pool.</p>
<p>This can cause a deadlock when the pool is exhausted, the <code class="literal">CALLER_RUNS</code> rejection policy is in use, and the task queue is full.
When the pool is empty and there is no room in the queue, the IO selector thread receives an <code class="literal">OP_READ</code> event and dispatches the read by using the executor.
The queue is full, so the selector thread itself starts the read process.
Now it detects that there is no assembler for this socket and, before it does the read, fires off an assembler.
Again, the queue is full, and the selector thread becomes the assembler.
The assembler is now blocked, waiting for the data to be read, which never happens.
The connection factory is now deadlocked because the selector thread cannot handle new events.</p>
<p>To avoid this deadlock, we must avoid the selector (or reader) threads performing the assembly task.
We want to use separate pools for the IO and assembly operations.</p>
<p>The framework provides a <code class="literal">CompositeExecutor</code>, which allows the configuration of two distinct executors: one for performing IO operations and one for message assembly.
In this environment, an IO thread can never become an assembler thread, and the deadlock cannot occur.</p>
<p>In addition, the task executors should be configured to use an <code class="literal">AbortPolicy</code> (<code class="literal">ABORT</code> when using <code class="literal">&lt;task&gt;</code>).
When an I/O task cannot be completed, it is deferred for a short time and continually retried until it can be completed and have an assembler allocated.
By default, the delay is 100ms, but you can change it by setting the <code class="literal">readDelay</code> property on the connection factory (<code class="literal">read-delay</code> when configuring with the XML namespace).</p>
<p>The following three examples shows how to configure the composite executor:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">private</span> CompositeExecutor compositeExecutor() {
    ThreadPoolTaskExecutor ioExec = <span class="hl-keyword">new</span> ThreadPoolTaskExecutor();
    ioExec.setCorePoolSize(<span class="hl-number">4</span>);
    ioExec.setMaxPoolSize(<span class="hl-number">10</span>);
    ioExec.setQueueCapacity(<span class="hl-number">0</span>);
    ioExec.setThreadNamePrefix(<span class="hl-string">"io-"</span>);
    ioExec.setRejectedExecutionHandler(<span class="hl-keyword">new</span> AbortPolicy());
    ioExec.initialize();
    ThreadPoolTaskExecutor assemblerExec = <span class="hl-keyword">new</span> ThreadPoolTaskExecutor();
    assemblerExec.setCorePoolSize(<span class="hl-number">4</span>);
    assemblerExec.setMaxPoolSize(<span class="hl-number">10</span>);
    assemblerExec.setQueueCapacity(<span class="hl-number">0</span>);
    assemblerExec.setThreadNamePrefix(<span class="hl-string">"assembler-"</span>);
    assemblerExec.setRejectedExecutionHandler(<span class="hl-keyword">new</span> AbortPolicy());
    assemblerExec.initialize();
    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> CompositeExecutor(ioExec, assemblerExec);
}</pre>
</div>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myTaskExecutor"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.util.CompositeExecutor"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"io"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"assembler"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;task:executor</span> <span class="hl-attribute">id</span>=<span class="hl-value">"io"</span> <span class="hl-attribute">pool-size</span>=<span class="hl-value">"4-10"</span> <span class="hl-attribute">queue-capacity</span>=<span class="hl-value">"0"</span> <span class="hl-attribute">rejection-policy</span>=<span class="hl-value">"ABORT"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;task:executor</span> <span class="hl-attribute">id</span>=<span class="hl-value">"assembler"</span> <span class="hl-attribute">pool-size</span>=<span class="hl-value">"4-10"</span> <span class="hl-attribute">queue-capacity</span>=<span class="hl-value">"0"</span> <span class="hl-attribute">rejection-policy</span>=<span class="hl-value">"ABORT"</span><span class="hl-tag"> /&gt;</span></pre>
</div>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myTaskExecutor"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.util.CompositeExecutor"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.scheduling.concurrent.ThreadPoolTaskExecutor"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"threadNamePrefix"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"io-"</span><span class="hl-tag"> /&gt;</span>
            <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"corePoolSize"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"4"</span><span class="hl-tag"> /&gt;</span>
            <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"maxPoolSize"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"8"</span><span class="hl-tag"> /&gt;</span>
            <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"queueCapacity"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"0"</span><span class="hl-tag"> /&gt;</span>
            <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"rejectedExecutionHandler"</span><span class="hl-tag">&gt;</span>
                <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"java.util.concurrent.ThreadPoolExecutor.AbortPolicy"</span><span class="hl-tag"> /&gt;</span>
            <span class="hl-tag">&lt;/property&gt;</span>
        <span class="hl-tag">&lt;/bean&gt;</span>
    <span class="hl-tag">&lt;/constructor-arg&gt;</span>
    <span class="hl-tag">&lt;constructor-arg&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.scheduling.concurrent.ThreadPoolTaskExecutor"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"threadNamePrefix"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"assembler-"</span><span class="hl-tag"> /&gt;</span>
            <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"corePoolSize"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"4"</span><span class="hl-tag"> /&gt;</span>
            <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"maxPoolSize"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"10"</span><span class="hl-tag"> /&gt;</span>
            <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"queueCapacity"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"0"</span><span class="hl-tag"> /&gt;</span>
            <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"rejectedExecutionHandler"</span><span class="hl-tag">&gt;</span>
                <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"java.util.concurrent.ThreadPoolExecutor.AbortPolicy"</span><span class="hl-tag"> /&gt;</span>
            <span class="hl-tag">&lt;/property&gt;</span>
        <span class="hl-tag">&lt;/bean&gt;</span>
    <span class="hl-tag">&lt;/constructor-arg&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
</div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="ssl-tls" href="#ssl-tls"></a>34.10&nbsp;SSL/TLS Support</h2></div></div></div>

<p>Secure Sockets Layer/Transport Layer Security is supported.
When using NIO, the JDK 5+ <code class="literal">SSLEngine</code> feature is used to handle handshaking after the connection is established.
When not using NIO, standard <code class="literal">SSLSocketFactory</code> and <code class="literal">SSLServerSocketFactory</code> objects are used to create connections.
A number of strategy interfaces are provided to allow significant customization.
The default implementations of these interfaces provide for the simplest way to get started with secure communications.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="ip-ssl-tls-getting-started" href="#ip-ssl-tls-getting-started"></a>34.10.1&nbsp;Getting Started</h3></div></div></div>

<p>Regardless of whether you use NIO, you need to configure the <code class="literal">ssl-context-support</code> attribute on the connection factory.
This attribute references a &lt;bean/&gt; definition that describes the location and passwords for the required key stores.</p>
<p>SSL/TLS peers require two keystores each:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
A keystore that contains private and public key pairs to identify the peer
</li><li class="listitem">
<p class="simpara">A truststore that contains the public keys for peers that are trusted.
See the documentation for the <code class="literal">keytool</code> utility provided with the JDK.
The essential steps are</p>
<div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
Create a new key pair and store it in a keystore.
</li><li class="listitem">
Export the public key.
</li><li class="listitem">
Import the public key into the peer&#8217;s truststore.
</li><li class="listitem">
Repeat for the other peer.
</li></ol></div>
</li></ul></div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>It is common in test cases to use the same key stores on both peers, but this should be avoided for production.</p>
</td></tr></table></div>
<p>After establishing the key stores, the next step is to indicate their locations to the <code class="literal">TcpSSLContextSupport</code> bean and provide a reference to that bean to the connection factory.</p>
<p>The following example configures an SSL connection:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"sslContextSupport"</span>
    <span class="hl-attribute">class</span>=<span class="hl-value">"o.sf.integration.ip.tcp.connection.support.DefaultTcpSSLContextSupport"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"client.ks"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"client.truststore.ks"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"secret"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"secret"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;ip:tcp-connection-factory</span> <span class="hl-attribute">id</span>=<span class="hl-value">"clientFactory"</span>
    <span class="hl-attribute">type</span>=<span class="hl-value">"client"</span>
    <span class="hl-attribute">host</span>=<span class="hl-value">"localhost"</span>
    <span class="hl-attribute">port</span>=<span class="hl-value">"1234"</span>
    <span class="hl-attribute">ssl-context-support</span>=<span class="hl-value">"sslContextSupport"</span><span class="hl-tag"> /&gt;</span></pre>
</div>
<p>The <code class="literal">DefaulTcpSSLContextSupport</code> class also has an optional <code class="literal">protocol</code> property, which can be <code class="literal">SSL</code> or <code class="literal">TLS</code> (the default).</p>
<p>The keystore file names (the first two constructor arguments) use the Spring <code class="literal">Resource</code> abstraction.
By default, the files are located on the classpath, but you can override this by using the <code class="literal">file:</code> prefix (to find the files on the filesystem instead).</p>
<p>Starting with version 4.3.6, when you use NIO, you can specify an <code class="literal">ssl-handshake-timeout</code> (in seconds) on the connection factory.
This timeout (the default is 30 seconds) is used during SSL handshake when waiting for data.
If the timeout is exceeded, the process is aborted and the socket is closed.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="tcp-ssl-host-verification" href="#tcp-ssl-host-verification"></a>34.10.2&nbsp;Host Verification</h3></div></div></div>

<p>Starting with version 5.0.8, you can configure whether or not to enable host verification.
Starting with version 5.1, it is enabled by default; the mechanism to disable it depends on whether or not you are using NIO.</p>
<p>Host verification is used to ensure the server you are connected to matches information in the certificate, even if the certificate is trusted.</p>
<p>When using NIO, configure the <code class="literal">DefaultTcpNioSSLConnectionSupport</code>, for example.</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> DefaultTcpNioSSLConnectionSupport connectionSupport() {
    DefaultTcpSSLContextSupport sslContextSupport = <span class="hl-keyword">new</span> DefaultTcpSSLContextSupport(<span class="hl-string">"test.ks"</span>,
            <span class="hl-string">"test.truststore.ks"</span>, <span class="hl-string">"secret"</span>, <span class="hl-string">"secret"</span>);
    sslContextSupport.setProtocol(<span class="hl-string">"SSL"</span>);
    DefaultTcpNioSSLConnectionSupport tcpNioConnectionSupport =
            <span class="hl-keyword">new</span> DefaultTcpNioSSLConnectionSupport(sslContextSupport, false);
    <span class="hl-keyword">return</span> tcpNioConnectionSupport;
}</pre>
</div>
<p>The second constructor argument disables host verification.
The <code class="literal">connectionSupport</code> bean is then injected into the NIO connection factory.</p>
<p>When not using NIO, the configuration is in the <code class="literal">TcpSocketSupport</code>:</p>
<div class="informalexample">
<pre class="programlisting">connectionFactory.setTcpSocketSupport(<span class="hl-keyword">new</span> DefaultTcpSocketSupport(false));</pre>
</div>
<p>Again, the constructor argument disables host verification.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="tcp-advanced-techniques" href="#tcp-advanced-techniques"></a>34.11&nbsp;Advanced Techniques</h2></div></div></div>

<p>This section covers advanced techniques that you may find to be helpful in certain situations.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_strategy_interfaces" href="#_strategy_interfaces"></a>34.11.1&nbsp;Strategy Interfaces</h3></div></div></div>

<p>In many cases, the configuration described earlier is all that is needed to enable secure communication over TCP/IP.
However, Spring Integration provides a number of strategy interfaces to allow customization and modification of socket factories and sockets:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">TcpSSLContextSupport</code>
</li><li class="listitem">
<code class="literal">TcpSocketFactorySupport</code>
</li><li class="listitem">
<code class="literal">TcpSocketSupport</code>
</li><li class="listitem">
<code class="literal">TcpNetConnectionSupport</code>
</li><li class="listitem">
<code class="literal">TcpNioConnectionSupport</code>
</li></ul></div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_the_literal_tcpsslcontextsupport_literal_strategy_interface" href="#_the_literal_tcpsslcontextsupport_literal_strategy_interface"></a>The <code class="literal">TcpSSLContextSupport</code> Strategy Interface</h4></div></div></div>

<p>The following listing shows the <code class="literal">TcpSSLContextSupport</code> strategy interface:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> TcpSSLContextSupport {

    SSLContext getSSLContext() <span class="hl-keyword">throws</span> Exception;

}</pre>
</div>
<p>Implementations of the <code class="literal">TcpSSLContextSupport</code> interface are responsible for creating an <code class="literal">SSLContext</code> object.
The implementation provided by the framework is the <code class="literal">DefaultTcpSSLContextSupport</code>, <a class="link" href="#ip-ssl-tls-getting-started" title="34.10.1&nbsp;Getting Started">described earlier</a>.
If you require different behavior, implement this interface and provide the connection factory with a reference to a bean of your class' implementation.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_the_literal_tcpsocketfactorysupport_literal_strategy_interface" href="#_the_literal_tcpsocketfactorysupport_literal_strategy_interface"></a>The <code class="literal">TcpSocketFactorySupport</code> Strategy Interface</h4></div></div></div>

<p>The following listing shows the definition of the <code class="literal">TcpSocketFactorySupport</code> strategy interface:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> TcpSocketFactorySupport {

    ServerSocketFactory getServerSocketFactory();

    SocketFactory getSocketFactory();

}</pre>
</div>
<p>Implementations of this interface are responsible for obtaining references to <code class="literal">ServerSocketFactory</code> and <code class="literal">SocketFactory</code>.
Two implementations are provided.
The first is <code class="literal">DefaultTcpNetSocketFactorySupport</code> for non-SSL sockets (when no <code class="literal">ssl-context-support</code> attribute is defined).
This uses the JDK&#8217;s default factories.
The second implementation is <code class="literal">DefaultTcpNetSSLSocketFactorySupport</code>.
By default, this is used when an <code class="literal">ssl-context-support</code> attribute is defined.
It uses the <code class="literal">SSLContext</code> created by that bean to create the socket factories.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>This interface applies only if <code class="literal">using-nio</code> is <code class="literal">false</code>.
NIO does not use socket factories.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_the_literal_tcpsocketsupport_literal_strategy_interface" href="#_the_literal_tcpsocketsupport_literal_strategy_interface"></a>The <code class="literal">TcpSocketSupport</code> Strategy Interface</h4></div></div></div>

<p>The following listing shows the definition of the <code class="literal">TcpSocketSupport</code> strategy interface:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> TcpSocketSupport {

    <span class="hl-keyword">void</span> postProcessServerSocket(ServerSocket serverSocket);

    <span class="hl-keyword">void</span> postProcessSocket(Socket socket);

}</pre>
</div>
<p>Implementations of this interface can modify sockets after they are created and after all configured attributes have been applied but before the sockets are used.
This applies whether you use NIO or not.
For example, you could use an implementation of this interface to modify the supported cipher suites on an SSL socket, or you could add a listener that gets notified after SSL handshaking is complete.
The sole implementation provided by the framework is the <code class="literal">DefaultTcpSocketSupport</code>, which does not modify the sockets in any way.</p>
<p>To supply your own implementation of <code class="literal">TcpSocketFactorySupport</code> or <code class="literal">TcpSocketSupport</code>, provide the connection factory with references to beans of your custom type by setting the <code class="literal">socket-factory-support</code> and <code class="literal">socket-support</code> attributes, respectively.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_the_literal_tcpnetconnectionsupport_literal_strategy_interface" href="#_the_literal_tcpnetconnectionsupport_literal_strategy_interface"></a>The <code class="literal">TcpNetConnectionSupport</code> Strategy Interface</h4></div></div></div>

<p>The following listing shows the definition of the <code class="literal">TcpNetConnectionSupport</code> strategy interface:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> TcpNetConnectionSupport {

	TcpNetConnection createNewConnection(Socket socket,
			<span class="hl-keyword">boolean</span> server, <span class="hl-keyword">boolean</span> lookupHost,
			ApplicationEventPublisher applicationEventPublisher,
			String connectionFactoryName) <span class="hl-keyword">throws</span> Exception;

}</pre>
</div>
<p>This interface is invoked to create objects of type <code class="literal">TcpNetConnection</code> (or its subclasses).
The framework provides a single implementation (<code class="literal">DefatulTcpNetConnectionSupport</code>), which, by default, creates simple <code class="literal">TcpNetConnection</code> objects.
It has two properties: <code class="literal">pushbackCapable</code> and <code class="literal">pushbackBufferSize</code>.
When push back is enabled, the implementation returns a subclass that wraps the connection&#8217;s <code class="literal">InputStream</code> in a <code class="literal">PushbackInputStream</code>.
Aligned with the <code class="literal">PushbackInputStream</code> default, the buffer size defaults to 1.
This lets deserializers "<code class="literal">unread</code>" (push back) bytes into the stream.
The following trivial example shows how it might be used in a delegating deserializer that "<code class="literal">peeks</code>" at the first byte to determine which deserializer to invoke:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> CompositeDeserializer <span class="hl-keyword">implements</span> Deserializer&lt;<span class="hl-keyword">byte</span>[]&gt; {

    <span class="hl-keyword">private</span> <span class="hl-keyword">final</span> ByteArrayStxEtxSerializer stxEtx = <span class="hl-keyword">new</span> ByteArrayStxEtxSerializer();

    <span class="hl-keyword">private</span> <span class="hl-keyword">final</span> ByteArrayCrLfSerializer crlf = <span class="hl-keyword">new</span> ByteArrayCrLfSerializer();

    <em><span class="hl-annotation" style="color: gray">@Override</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">byte</span>[] deserialize(InputStream inputStream) <span class="hl-keyword">throws</span> IOException {
        PushbackInputStream pbis = (PushbackInputStream) inputStream;
        <span class="hl-keyword">int</span> first = pbis.read();
        <span class="hl-keyword">if</span> (first &lt; <span class="hl-number">0</span>) {
            <span class="hl-keyword">throw</span> <span class="hl-keyword">new</span> SoftEndOfStreamException();
        }
        pbis.unread(first);
        <span class="hl-keyword">if</span> (first == ByteArrayStxEtxSerializer.STX) {
            <span class="hl-keyword">this</span>.receivedStxEtx = true;
            <span class="hl-keyword">return</span> <span class="hl-keyword">this</span>.stxEtx.deserialize(pbis);
        }
        <span class="hl-keyword">else</span> {
            <span class="hl-keyword">this</span>.receivedCrLf = true;
            <span class="hl-keyword">return</span> <span class="hl-keyword">this</span>.crlf.deserialize(pbis);
        }
    }

}</pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_the_literal_tcpnioconnectionsupport_literal_strategy_interface" href="#_the_literal_tcpnioconnectionsupport_literal_strategy_interface"></a>The <code class="literal">TcpNioConnectionSupport</code> Strategy Interface</h4></div></div></div>

<p>The following listing shows the definition of the <code class="literal">TcpNioConnectionSupport</code> strategy interface:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> TcpNioConnectionSupport {

    TcpNioConnection createNewConnection(SocketChannel socketChannel,
            <span class="hl-keyword">boolean</span> server, <span class="hl-keyword">boolean</span> lookupHost,
            ApplicationEventPublisher applicationEventPublisher,
            String connectionFactoryName) <span class="hl-keyword">throws</span> Exception;

}</pre>
</div>
<p>This interface is invoked to create <code class="literal">TcpNioConnection</code> objects (or objects from subclasses).
Spring Integration provides two implementations: <code class="literal">DefaultTcpNioSSLConnectionSupport</code> and <code class="literal">DefaultTcpNioConnectionSupport</code>.
Which one is  used depends on whether SSL is in use.
A common use case is to subclass <code class="literal">DefaultTcpNioSSLConnectionSupport</code> and override <code class="literal">postProcessSSLEngine</code>.
See the <a class="link" href="#ssl-client-authentication-example" title="34.11.2&nbsp;Example: Enabling SSL Client Authentication">SSL client authentication example</a>.
As with the <code class="literal">DefaultTcpNetConnectionSupport</code>, these implementations also support push back.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="ssl-client-authentication-example" href="#ssl-client-authentication-example"></a>34.11.2&nbsp;Example: Enabling SSL Client Authentication</h3></div></div></div>

<p>To enable client certificate authentication when you use SSL, the technique depends on whether you use NIO.
When you do not NIO , provide a custom <code class="literal">TcpSocketSupport</code> implementation to post-process the server socket:</p>
<div class="informalexample">
<pre class="programlisting">serverFactory.setTcpSocketSupport(<span class="hl-keyword">new</span> DefaultTcpSocketSupport() {

    <em><span class="hl-annotation" style="color: gray">@Override</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> postProcessServerSocket(ServerSocket serverSocket) {
        ((SSLServerSocket) serverSocket).setNeedClientAuth(true);
    }

});</pre>
</div>
<p>(When you use XML configuration, provide a reference to your bean by setting the <code class="literal">socket-support</code> attribute).</p>
<p>When you use NIO, provide a custom <code class="literal">TcpNioSslConnectionSupport</code> implementation to post-process the <code class="literal">SSLEngine</code>, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> DefaultTcpNioSSLConnectionSupport tcpNioConnectionSupport() {
    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> DefaultTcpNioSSLConnectionSupport(serverSslContextSupport) {

            <em><span class="hl-annotation" style="color: gray">@Override</span></em>
            <span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> postProcessSSLEngine(SSLEngine sslEngine) {
                sslEngine.setNeedClientAuth(true);
            }

    }
}

<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> TcpNioServerConnectionFactory server() {
    ...
    serverFactory.setTcpNioConnectionSupport(tcpNioConnectionSupport());
    ...
}</pre>
</div>
<p>(When you use XML configuration, since version 4.3.7, provide a reference to your bean by setting the <code class="literal">nio-connection-support</code> attribute).</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="ip-endpoint-reference" href="#ip-endpoint-reference"></a>34.12&nbsp;IP Configuration Attributes</h2></div></div></div>

<p>The following table describes attributes that you can set to configure IP connections:</p>
<div class="table"><a name="d5e21810" href="#d5e21810"></a><p class="title"><b>Table&nbsp;34.1.&nbsp;Connection Factory Attributes</b></p><div class="table-contents">

<table summary="Connection Factory Attributes" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"><col class="col_4"><col class="col_5"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Attribute Name</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">Client?</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">Server?</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Allowed Values</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Attribute Description</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">type</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>client, server</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Determines whether the connection factory is a client or a server.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">host</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>N</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The host name or IP address of the destination.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">port</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The port.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">serializer</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>An implementation of <code class="literal">Serializer</code> used to serialize the payload.
Defaults to <code class="literal">ByteArrayCrLfSerializer</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">deserializer</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>An implementation of <code class="literal">Deserializer</code> used to deserialize the payload.
Defaults to <code class="literal">ByteArrayCrLfSerializer</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">using-nio</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">true</code>, <code class="literal">false</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Whether or not connection uses NIO.
Refer to the <code class="literal">java.nio</code> package for more information.
See <a class="xref" href="#note_nio" title="34.9&nbsp;About Non-blocking I/O (NIO)">Section&nbsp;34.9, &#8220;About Non-blocking I/O (NIO)&#8221;</a>.
Default: <code class="literal">false</code>.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">using-direct-buffers</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>N</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">true</code>, <code class="literal">false</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>When using NIO, whether or not the connection uses direct buffers.
Refer to the <code class="literal">java.nio.ByteBuffer</code> documentation for more information.
Must be <code class="literal">false</code> if <code class="literal">using-nio</code> is <code class="literal">false</code>.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">apply-sequence</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">true</code>, <code class="literal">false</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>When you use NIO, it may be necessary to resequence messages.
When this attribute is set to <code class="literal">true</code>, <code class="literal">correlationId</code> and <code class="literal">sequenceNumber</code> headers are added to received messages.
See <a class="xref" href="#note_nio" title="34.9&nbsp;About Non-blocking I/O (NIO)">Section&nbsp;34.9, &#8220;About Non-blocking I/O (NIO)&#8221;</a>.
Default: <code class="literal">false</code>.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">so-timeout</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Defaults to <code class="literal">0</code> (infinity), except for server connection factories with <code class="literal">single-use="true"</code>.
In that case, it defaults to the default reply timeout (10 seconds).</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">so-send-buffer-size</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>See <code class="literal">java.net.Socket.</code>
<code class="literal">setSendBufferSize()</code>.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">so-receive-buffer-size</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>See <code class="literal">java.net.Socket.</code>
<code class="literal">setReceiveBufferSize()</code>.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">so-keep-alive</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">true</code>, <code class="literal">false</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>See <code class="literal">java.net.Socket.setKeepAlive()</code>.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">so-linger</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Sets <code class="literal">linger</code> to <code class="literal">true</code> with the supplied value.
See <code class="literal">java.net.Socket.setSoLinger()</code>.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">so-tcp-no-delay</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">true</code>, <code class="literal">false</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>See <code class="literal">java.net.Socket.setTcpNoDelay()</code>.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">so-traffic-class</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>See <code class="literal">java.net.Socket.</code>
<code class="literal">setTrafficClass()</code>.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">local-address</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>N</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>On a multi-homed system, specifies an IP address for the interface to which the socket is bound.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">task-executor</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Specifies a specific executor to be used for socket handling.
If not supplied, an internal cached thread executor is used.
Needed on some platforms that require the use of specific task executors, such as a <code class="literal">WorkManagerTaskExecutor</code>.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">single-use</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">true</code>, <code class="literal">false</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Specifies whether a connection can be used for multiple messages.
If <code class="literal">true</code>, a new connection is used for each message.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">pool-size</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>N</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>N</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>This attribute is no longer used.
For backward compatibility, it sets the backlog, but you should use <code class="literal">backlog</code> to specify the connection backlog in server factories.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">backlog</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>N</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Sets the connection backlog for server factories.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">lookup-host</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">true</code>, <code class="literal">false</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Specifies whether reverse lookups are done on IP addresses to convert to host names for use in message headers.
If false, the IP address is used instead.
Default: <code class="literal">true</code>.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">interceptor-factory-chain</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>See <a class="xref" href="#ip-interceptors" title="34.4&nbsp;TCP Connection Interceptors">Section&nbsp;34.4, &#8220;TCP Connection Interceptors&#8221;</a>.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">ssl-context-support</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>See <code class="literal">&lt;&lt;ssl-tls&gt;&gt;</code>.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">socket-factory-support</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>See <code class="literal">&lt;&lt;ssl-tls&gt;&gt;</code>.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">socket-support</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>See <a class="xref" href="#ssl-tls" title="34.10&nbsp;SSL/TLS Support">Section&nbsp;34.10, &#8220;SSL/TLS Support&#8221;</a>.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">nio-connection-support</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>See <a class="xref" href="#tcp-advanced-techniques" title="34.11&nbsp;Advanced Techniques">Section&nbsp;34.11, &#8220;Advanced Techniques&#8221;</a>.</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">read-delay</code></p></td><td style="border-right: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; " align="center" valign="top"><p>Y</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>long &gt; 0</p></td><td style="" align="left" valign="top"><p>The delay (in milliseconds) before retrying a read after the previous attempt failed due to insufficient threads.
Default: 100.
Only applies if <code class="literal">using-nio</code> is <code class="literal">true</code>.</p></td></tr></tbody></table>
</div></div><br class="table-break">
<p>The following table describes attributes that you can set to configure UDP inbound channel adapters:</p>
<div class="table"><a name="ip-udp-ib-atts" href="#ip-udp-ib-atts"></a><p class="title"><b>Table&nbsp;34.2.&nbsp;UDP Inbound Channel Adapter Attributes</b></p><div class="table-contents">

<table summary="UDP Inbound Channel Adapter Attributes" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Attribute Name</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">Allowed Values</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Attribute Description</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">port</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The port on which the adapter listens.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">multicast</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p><code class="literal">true</code>, <code class="literal">false</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Whether or not the UDP adapter uses multicast.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">multicast-address</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>When multicast is true, the multicast address to which the adapter joins.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">pool-size</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Specifies how many packets can be handled concurrently.
It only applies if task-executor is not configured.
Default: 5.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>task-executor</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Specifies a specific executor to be used for socket handling.
If not supplied, an internal pooled executor is used.
Needed on some platforms that require the use of specific task executors such as a <code class="literal">WorkManagerTaskExecutor</code>.
See pool-size for thread requirements.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">receive-buffer-size</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The size of the buffer used to receive <code class="literal">DatagramPackets</code>.
Usually set to the maximum transmission unit (MTU) size.
If a smaller buffer is used than the size of the sent packet, truncation can occur.
You can detect this by using the <code class="literal">check-length</code> attribute..</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">check-length</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p><code class="literal">true</code>, <code class="literal">false</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Whether or not a UDP adapter expects a data length field in the packet received.
Used to detect packet truncation.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">so-timeout</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>See the <code class="literal">setSoTimeout()</code> methods in <code class="literal">java.net.DatagramSocket</code> for more information.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">so-send-buffer-size</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Used for UDP acknowledgment packets.
See the setSendBufferSize() methods in <code class="literal">java.net.DatagramSocket</code> for more information.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">so-receive-buffer-size</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>See <code class="literal">java.net.DatagramSocket.setReceiveBufferSize()</code> for more information.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">local-address</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>On a multi-homed system, specifies an IP address for the interface to which the socket is bound.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">error-channel</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>If a downstream component throws an exception, the <code class="literal">MessagingException</code> message that contains the exception and failed message is sent to this channel.</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">lookup-host</code></p></td><td style="border-right: 0.5pt solid ; " align="center" valign="top"><p><code class="literal">true</code>, <code class="literal">false</code></p></td><td style="" align="left" valign="top"><p>Specifies whether reverse lookups are done on IP addresses to convert to host names for use in message headers.
If <code class="literal">false</code>, the IP address is used instead.
Default: <code class="literal">true</code>.</p></td></tr></tbody></table>
</div></div><br class="table-break">
<p>The following table describes attributes that you can set to configure UDP outbound channel adapters:</p>
<div class="table"><a name="d5e22309" href="#d5e22309"></a><p class="title"><b>Table&nbsp;34.3.&nbsp;UDP Outbound Channel Adapter Attributes</b></p><div class="table-contents">

<table summary="UDP Outbound Channel Adapter Attributes" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Attribute Name</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">Allowed Values</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Attribute Description</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">host</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The host name or ip address of the destination.
For multicast udp adapters, the multicast address.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">port</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The port on the destination.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">multicast</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p><code class="literal">true</code>, <code class="literal">false</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Whether or not the udp adapter uses multicast.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">acknowledge</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p><code class="literal">true</code>, <code class="literal">false</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Whether or not a UDP adapter requires an acknowledgment from the destination.
When enabled, it requires setting the following four attributes: <code class="literal">ack-host</code>, <code class="literal">ack-port</code>, <code class="literal">ack-timeout</code>, and <code class="literal">min-acks-for- success</code>.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">ack-host</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>When <code class="literal">acknowledge</code> is <code class="literal">true</code>, indicates the host or IP address to which the acknowledgment should be sent.
Usually the current host, but may be different&#8201;&#8212;&#8201;for example, when Network Address Translation (NAT) is being used.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">ack-port</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>When <code class="literal">acknowledge</code> is <code class="literal">true</code>, indicates the port to which the acknowledgment should be sent.
The adapter listens on this port for acknowledgments.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">ack-timeout</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>When <code class="literal">acknowledge</code> is <code class="literal">true</code>, indicates the time in milliseconds that the adapter waits for an acknowledgment.
If an acknowledgment is not received in time, the adapter throws an exception.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">min-acks-for- success</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Defaults to 1.
For multicast adapters, you can set this to a larger value, which requires acknowledgments from multiple destinations.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">check-length</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p><code class="literal">true</code>, <code class="literal">false</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Whether or not a UDP adapter includes a data length field in the packet sent to the destination.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">time-to-live</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>For multicast adapters, specifies the time-to-live attribute for the <code class="literal">MulticastSocket</code>.
Controls the scope of the multicasts.
Refer to the Java API documentation for more information.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">so-timeout</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>See <code class="literal">java.net.DatagramSocket</code> setSoTimeout() methods for more information.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">so-send-buffer-size</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>See the <code class="literal">setSendBufferSize()</code> methods in <code class="literal">java.net.DatagramSocket</code> for more information.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">so-receive-buffer-size</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Used for UDP acknowledgment packets.
See the <code class="literal">setReceiveBufferSize()</code> methods in <code class="literal">java.net.DatagramSocket</code> for more information.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>local-address</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>On a multi-homed system, for the UDP adapter, specifies an IP address for the interface to which the socket is bound for reply messages.
For a multicast adapter, it also determines which interface the multicast packets are sent over.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">task-executor</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Specifies a specific executor to be used for acknowledgment handling.
If not supplied, an internal single threaded executor is used.
Needed on some platforms that require the use of specific task executors, such as a <code class="literal">WorkManagerTaskExecutor</code>.
One thread is dedicated to handling acknowledgments (if the <code class="literal">acknowledge</code> option is true).</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">destination-expression</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p>SpEL expression</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>A SpEL expression to be evaluated to determine which <code class="literal">SocketAddress</code> to use as a destination address for the
outgoing UDP packets.</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">socket-expression</code></p></td><td style="border-right: 0.5pt solid ; " align="center" valign="top"><p>SpEL expression</p></td><td style="" align="left" valign="top"><p>A SpEL expression to be evaluated to determine which datagram socket use for sending outgoing UDP packets.</p></td></tr></tbody></table>
</div></div><br class="table-break">
<p>The following table describes attributes that you can set to configure TCP inbound channel adapters:</p>
<div class="table"><a name="d5e22470" href="#d5e22470"></a><p class="title"><b>Table&nbsp;34.4.&nbsp;TCP Inbound Channel Adapter Attributes</b></p><div class="table-contents">

<table summary="TCP Inbound Channel Adapter Attributes" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Attribute Name</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">Allowed Values</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Attribute Description</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">channel</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The channel to which inbound messages is sent.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">connection-factory</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>If the connection factory has a type of <code class="literal">server</code>, the factory is "<code class="literal">owned</code>" by this adapter.
If it has a type of <code class="literal">client</code>, it is "<code class="literal">owned</code>" by an outbound channel adapter, and this adapter receives any incoming messages on the connection created by the outbound adapter.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">error-channel</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>If an exception is thrown by a downstream component, the <code class="literal">MessagingException</code> message containing the exception and the failed message is sent to this channel.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">client-mode</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p><code class="literal">true</code>, <code class="literal">false</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>When <code class="literal">true</code>, the inbound adapter acts as a client with respect to establishing the connection and then receiving incoming messages on that connection.
Default: <code class="literal">false</code>.
See also <code class="literal">retry-interval</code> and <code class="literal">scheduler</code>.
The connection factory must be of type <code class="literal">client</code> and have <code class="literal">single-use</code> set to <code class="literal">false</code>.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">retry-interval</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>When in <code class="literal">client-mode</code>, specifies the number of milliseconds to wait between connection attempts or after a connection failure.
Default: 60000 (60 seconds).</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">scheduler</code></p></td><td style="border-right: 0.5pt solid ; " align="center" valign="top"><p><code class="literal">true</code>, <code class="literal">false</code></p></td><td style="" align="left" valign="top"><p>Specifies a <code class="literal">TaskScheduler</code> to use for managing the <code class="literal">client-mode</code> connection.
If not specified, it defaults to the global Spring Integration <code class="literal">taskScheduler</code> bean, which has a default pool size of 10.
See <a class="xref" href="#namespace-taskscheduler" title="E.2&nbsp;Configuring the Task Scheduler">Section&nbsp;E.2, &#8220;Configuring the Task Scheduler&#8221;</a>.</p></td></tr></tbody></table>
</div></div><br class="table-break">
<p>The following table describes attributes that you can set to configure TCP outbound channel adapters:</p>
<div class="table"><a name="d5e22548" href="#d5e22548"></a><p class="title"><b>Table&nbsp;34.5.&nbsp;TCP Outbound Channel Adapter Attributes</b></p><div class="table-contents">

<table summary="TCP Outbound Channel Adapter Attributes" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Attribute Name</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">Allowed Values</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Attribute Description</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">channel</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The channel on which outbound messages arrive.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">connection-factory</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>If the connection factory has a type of <code class="literal">client</code>, the factory is "<code class="literal">owned</code>" by this adapter.
If it has a type of <code class="literal">server</code>, it is "<code class="literal">owned</code>" by an inbound channel adapter, and this adapter tries to correlate messages to the connection on which an original inbound message was received.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">client-mode</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p><code class="literal">true</code>, <code class="literal">false</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>When <code class="literal">true</code>, the outbound adapter tries to establish the connection as soon as it is started.
When <code class="literal">false</code>, the connection is established when the first message is sent.
Default: <code class="literal">false</code>.
See also <code class="literal">retry-interval</code> and <code class="literal">scheduler</code>.
The connection factory must be of type <code class="literal">client</code> and have <code class="literal">single-use</code> set to <code class="literal">false</code>.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">retry-interval</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>When in <code class="literal">client-mode</code>, specifies the number of milliseconds to wait between connection attempts or after a connection failure.
Default: 60000 (60 seconds).</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">scheduler</code></p></td><td style="border-right: 0.5pt solid ; " align="center" valign="top"><p><code class="literal">true</code>, <code class="literal">false</code></p></td><td style="" align="left" valign="top"><p>Specifies a <code class="literal">TaskScheduler</code> to use for managing the <code class="literal">client-mode</code> connection.
If not specified, it defaults to the global Spring Integration <code class="literal">taskScheduler</code> bean, which has a default pool size of 10.
See <a class="xref" href="#namespace-taskscheduler" title="E.2&nbsp;Configuring the Task Scheduler">Section&nbsp;E.2, &#8220;Configuring the Task Scheduler&#8221;</a>.</p></td></tr></tbody></table>
</div></div><br class="table-break">
<p>The following table describes attributes that you can set to configure TCP inbound gateways:</p>
<div class="table"><a name="d5e22619" href="#d5e22619"></a><p class="title"><b>Table&nbsp;34.6.&nbsp;TCP Inbound Gateway Attributes</b></p><div class="table-contents">

<table summary="TCP Inbound Gateway Attributes" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Attribute Name</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">Allowed Values</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Attribute Description</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">connection-factory</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The connection factory must be of type server.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">request-channel</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The channel to which incoming messages are sent.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">reply-channel</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The channel on which reply messages may arrive.
Usually, replies arrive on a temporary reply channel added to the inbound message header.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">reply-timeout</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The time in milliseconds for which the gateway waits for a reply.
Default: 1000 (1 second).</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">error-channel</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>If an exception is thrown by a downstream component, the <code class="literal">MessagingException</code> message containing the exception and the failed message is sent to this channel.
Any reply from that flow is then returned as a response by the gateway.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">client-mode</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top"><p><code class="literal">true</code>, <code class="literal">false</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>When <code class="literal">true</code>, the inbound gateway acts as a client with respect to establishing the connection and then receiving (and replying to) incoming messages on that connection.
Default: false.
See also <code class="literal">retry-interval</code> and <code class="literal">scheduler</code>.
The connection factory must be of type <code class="literal">client</code> and have <code class="literal">single-use</code> set to <code class="literal">false</code>.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">retry-interval</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>When in <code class="literal">client-mode</code>, specifies the number of milliseconds to wait between connection attempts or after a connection failure.
Default: 60000 (60 seconds).</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">scheduler</code></p></td><td style="border-right: 0.5pt solid ; " align="center" valign="top"><p><code class="literal">true</code>, <code class="literal">false</code></p></td><td style="" align="left" valign="top"><p>Specifies a <code class="literal">TaskScheduler</code> to use for managing the <code class="literal">client-mode</code> connection.
If not specified, it defaults to the global Spring Integration <code class="literal">taskScheduler</code> bean, which has a default pool size of 10.
See <a class="xref" href="#namespace-taskscheduler" title="E.2&nbsp;Configuring the Task Scheduler">Section&nbsp;E.2, &#8220;Configuring the Task Scheduler&#8221;</a>.</p></td></tr></tbody></table>
</div></div><br class="table-break">
<p>The following table describes attributes that you can set to configure TCP outbound gateways:</p>
<div class="table"><a name="tcp-ob-gateway-attributes" href="#tcp-ob-gateway-attributes"></a><p class="title"><b>Table&nbsp;34.7.&nbsp;TCP Outbound Gateway Attributes</b></p><div class="table-contents">

<table summary="TCP Outbound Gateway Attributes" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Attribute Name</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">Allowed Values</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Attribute Description</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">connection-factory</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The connection factory must be of type <code class="literal">client</code>.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">request-channel</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The channel on which outgoing messages arrive.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">reply-channel</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Optional.
The channel to which reply messages are sent.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">remote-timeout</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The time in milliseconds for which the gateway waits for a reply from the remote system.
Mutually exclusive with <code class="literal">remote-timeout-expression</code>.
Default: 10000 (10 seconds).
Note: In versions prior to 4.2 this value defaulted to <code class="literal">reply-timeout</code> (if set).</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">remote-timeout-expression</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>A SpEL expression that is evaluated against the message to determine the time in milliseconds for which the gateway waits for a reply from the remote system.
Mutually exclusive with <code class="literal">remote-timeout</code>.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">request-timeout</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="center" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>If a single-use connection factory is not being used, the time in milliseconds for which the gateway waits to get access to the shared connection.</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">reply-timeout</code></p></td><td style="border-right: 0.5pt solid ; " align="center" valign="top">&nbsp;</td><td style="" align="left" valign="top"><p>The time in milliseconds for which the gateway waits when sending the reply to the reply-channel.
Only applies if the reply-channel might block (such as a bounded QueueChannel that is currently full).</p></td></tr></tbody></table>
</div></div><br class="table-break">
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="ip-msg-headers" href="#ip-msg-headers"></a>34.13&nbsp;IP Message Headers</h2></div></div></div>

<p>
<b>IP Message Headers.&nbsp;</b>
This module uses the following <code class="literal">MessageHeader</code> instances:
</p>
<div class="informaltable">
<table style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Header Name</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">IpHeaders Constant</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Description</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">ip_hostname</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">HOSTNAME</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The host name from which a TCP message or UDP packet was received.
If <code class="literal">lookupHost</code> is <code class="literal">false</code>, this contains the IP address.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">ip_address</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">IP_ADDRESS</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The IP address from which a TCP message or UDP packet was received.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">ip_port</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">PORT</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The remote port for a UDP packet.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>ip_localInetAddress</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">IP_LOCAL_ADDRESS</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The local <code class="literal">InetAddress</code> to which the socket is connected (since version 4.2.5).</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">ip_ackTo</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">ACKADDRESS</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The remote IP address to which UDP application-level acknowledgments are sent.
The framework includes acknowledgment information in the data packet.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">ip_ackId</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">ACK_ID</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>A correlation ID for UDP application-level acknowledgments.
The framework includes acknowledgment information in the data packet.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">ip_tcp_remotePort</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">REMOTE_PORT</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The remote port for a TCP connection.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">ip_connectionId</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">CONNECTION_ID</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>A unique identifier for a TCP connection.
Set by the framework for inbound messages.
When sending to a server-side inbound channel adapter or replying to an inbound gateway, this header is required so that the endpoint can determine the connection to which to send the message.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">ip_actualConnectionId</code></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">ACTUAL_CONNECTION_ID</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>For information only.
When using a cached or failover client connection factory, it contains the actual underlying connection ID.</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">contentType</code></p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">MessageHeaders.</code>
<code class="literal">CONTENT_TYPE</code></p></td><td style="" align="left" valign="top"><p>An optional content type for inbound messages
Described after this table.
Note that, unlike the other header constants, this constant is in the <code class="literal">MessageHeaders</code> class, not the <code class="literal">IpHeaders</code> class.</p></td></tr></tbody></table>
</div>
<p>For inbound messages, <code class="literal">ip_hostname</code>, <code class="literal">ip_address</code>, <code class="literal">ip_tcp_remotePort</code>, and <code class="literal">ip_connectionId</code> are mapped by the default
<code class="literal">TcpHeaderMapper</code>.
If you set the mapper&#8217;s <code class="literal">addContentTypeHeader</code> property to <code class="literal">true</code>, the mapper sets the <code class="literal">contentType</code> header (<code class="literal">application/octet-stream;charset="UTF-8"</code>, by default).
You can change the default by setting the <code class="literal">contentType</code> property.
You can add additional headers by subclassing <code class="literal">TcpHeaderMapper</code> and overriding the <code class="literal">supplyCustomHeaders</code> method.
For example, when you use SSL, you can add properties of the <code class="literal">SSLSession</code> by obtaining the session object from the
<code class="literal">TcpConnection</code> object, which is provided as an argument to the <code class="literal">supplyCustomHeaders</code> method.</p>
<p>For outbound messages, <code class="literal">String</code> payloads are converted to <code class="literal">byte[]</code> with the default (<code class="literal">UTF-8</code>) charset.
Set the <code class="literal">charset</code> property to change the default.</p>
<p>When customizing the mapper properties or subclassing, declare the mapper as a bean and provide an instance to the connection factory by using the <code class="literal">mapper</code> property</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="ip-annotation" href="#ip-annotation"></a>34.14&nbsp;Annotation-Based Configuration</h2></div></div></div>

<p>The following example from the samples repository shows some of the configuration options available when you use  annotations instead of XML:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@EnableIntegration</span></em> <a name="CO50-1" href="#CO50-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
<em><span class="hl-annotation" style="color: gray">@IntegrationComponentScan</span></em> <a name="CO50-2" href="#CO50-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
<em><span class="hl-annotation" style="color: gray">@Configuration</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">class</span> Config {

    <em><span class="hl-annotation" style="color: gray">@Value(${some.port})</span></em>
    <span class="hl-keyword">private</span> <span class="hl-keyword">int</span> port;

    <em><span class="hl-annotation" style="color: gray">@MessagingGateway(defaultRequestChannel="toTcp")</span></em> <a name="CO50-3" href="#CO50-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
    <span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> Gateway {

        String viaTcp(String in);

    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel="toTcp")</span></em> <a name="CO50-4" href="#CO50-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
    <span class="hl-keyword">public</span> MessageHandler tcpOutGate(AbstractClientConnectionFactory connectionFactory) {
        TcpOutboundGateway gate = <span class="hl-keyword">new</span> TcpOutboundGateway();
        gate.setConnectionFactory(connectionFactory);
        gate.setOutputChannelName(<span class="hl-string">"resultToString"</span>);
        <span class="hl-keyword">return</span> gate;
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em> <a name="CO50-5" href="#CO50-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
    <span class="hl-keyword">public</span> TcpInboundGateway tcpInGate(AbstractServerConnectionFactory connectionFactory)  {
        TcpInboundGateway inGate = <span class="hl-keyword">new</span> TcpInboundGateway();
        inGate.setConnectionFactory(connectionFactory);
        inGate.setRequestChannel(fromTcp());
        <span class="hl-keyword">return</span> inGate;
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> MessageChannel fromTcp() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> DirectChannel();
    }

    <em><span class="hl-annotation" style="color: gray">@MessageEndpoint</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">class</span> Echo { <a name="CO50-6" href="#CO50-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>

        <em><span class="hl-annotation" style="color: gray">@Transformer(inputChannel="fromTcp", outputChannel="toEcho")</span></em>
        <span class="hl-keyword">public</span> String convert(<span class="hl-keyword">byte</span>[] bytes) {
            <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> String(bytes);
        }

        <em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel="toEcho")</span></em>
        <span class="hl-keyword">public</span> String upCase(String in) {
            <span class="hl-keyword">return</span> in.toUpperCase();
        }

        <em><span class="hl-annotation" style="color: gray">@Transformer(inputChannel="resultToString")</span></em>
        <span class="hl-keyword">public</span> String convertResult(<span class="hl-keyword">byte</span>[] bytes) {
            <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> String(bytes);
        }

    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> AbstractClientConnectionFactory clientCF() { <a name="CO50-7" href="#CO50-7"></a><span><img src="images/callouts/7.png" alt="7" border="0"></span>
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> TcpNetClientConnectionFactory(<span class="hl-string">"localhost"</span>, <span class="hl-keyword">this</span>.port);
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> AbstractServerConnectionFactory serverCF() { <a name="CO50-8" href="#CO50-8"></a><span><img src="images/callouts/8.png" alt="8" border="0"></span>
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> TcpNetServerConnectionFactory(<span class="hl-keyword">this</span>.port);
    }

}</pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO50-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Standard Spring Integration annotation enabling the infrastructure for an integration application.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO50-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Searches for <code class="literal">@MessagingGateway</code> interfaces.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO50-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The entry point to the client-side of the flow. The calling application can use <code class="literal">@Autowired</code> for this <code class="literal">Gateway</code> bean
and invoke its method.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO50-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Outbound endpoints consist of a <code class="literal">MessageHandler</code> and a consumer that wraps it. In this scenario, the
<code class="literal">@ServiceActivator</code> configures the endpoint, according to the channel type.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO50-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Inbound endpoints (in the TCP/UDP module) are all message-driven and so only need to be declared as simple <code class="literal">@Bean</code> instances.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO50-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>This class provides a number of POJO methods for use in this sample flow (a <code class="literal">@Transformer</code> and <code class="literal">@ServiceActivator</code>
on the server side and a <code class="literal">@Transformer</code> on the client side).</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO50-7"><span><img src="images/callouts/7.png" alt="7" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The client-side connection factory.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO50-8"><span><img src="images/callouts/8.png" alt="8" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The server-side connection factory.</p>
</td></tr></table></div>
</div>
</div>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="webflux" href="#webflux"></a>35.&nbsp;WebFlux Support</h2></div></div></div>

<p>The WebFlux Spring Integration module (<code class="literal">spring-integration-webflux</code>) allows for the execution of HTTP requests and the processing of inbound HTTP requests in a reactive manner.</p>
<p>You need to include this dependency into your project:</p>
<div class="informalexample">
<p>
<b>Maven.&nbsp;</b>

</p><pre class="programlisting"><span class="hl-tag">&lt;dependency&gt;</span>
    <span class="hl-tag">&lt;groupId&gt;</span>org.springframework.integration<span class="hl-tag">&lt;/groupId&gt;</span>
    <span class="hl-tag">&lt;artifactId&gt;</span>spring-integration-webflux<span class="hl-tag">&lt;/artifactId&gt;</span>
    <span class="hl-tag">&lt;version&gt;</span>5.1.2.RELEASE<span class="hl-tag">&lt;/version&gt;</span>
<span class="hl-tag">&lt;/dependency&gt;</span></pre><p>

</p>
<p>
<b>Gradle.&nbsp;</b>

</p><pre class="programlisting">compile <span class="hl-string">"org.springframework.integration:spring-integration-webflux:5.1.2.RELEASE"</span></pre><p>

</p>
</div>
<p>The <code class="literal">io.projectreactor.netty:reactor-netty</code> dependency must be included in case of non-Servlet-based server configuration.</p>
<p>The WebFlux support consists of the following gateway implementations: <code class="literal">WebFluxInboundEndpoint</code> and <code class="literal">WebFluxRequestExecutingMessageHandler</code>.
The support is fully based on the Spring <a class="ulink" href="https://docs.spring.io/spring/docs/current/spring-framework-reference/web-reactive.html#spring-webflux" target="_top">WebFlux</a> and <a class="ulink" href="https://projectreactor.io/" target="_top">Project Reactor</a> foundations.
See <a class="xref" href="#http" title="20.&nbsp;HTTP Support">Chapter&nbsp;20, <i>HTTP Support</i></a> for more information, since many options are shared between reactive and regular HTTP components.</p>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="webflux-inbound" href="#webflux-inbound"></a>35.1&nbsp;WebFlux Inbound Components</h2></div></div></div>

<p>Starting with version 5.0, the <code class="literal">WebFluxInboundEndpoint</code> implementation of <code class="literal">WebHandler</code> is provided.
This component is similar to the MVC-based <code class="literal">HttpRequestHandlingEndpointSupport</code>, with which it shares some common options through the newly extracted <code class="literal">BaseHttpInboundEndpoint</code>.
It is used in the Spring WebFlux reactive environment (instead of MVC).
The following example shows a simple implementation of a WebFlux endpoint:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Configuration</span></em>
<em><span class="hl-annotation" style="color: gray">@EnableWebFlux</span></em>
<em><span class="hl-annotation" style="color: gray">@EnableIntegration</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ReactiveHttpConfiguration {

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> WebFluxInboundEndpoint simpleInboundEndpoint() {
        WebFluxInboundEndpoint endpoint = <span class="hl-keyword">new</span> WebFluxInboundEndpoint();
        RequestMapping requestMapping = <span class="hl-keyword">new</span> RequestMapping();
        requestMapping.setPathPatterns(<span class="hl-string">"/test"</span>);
        endpoint.setRequestMapping(requestMapping);
        endpoint.setRequestChannelName(<span class="hl-string">"serviceChannel"</span>);
        <span class="hl-keyword">return</span> endpoint;
    }

    <em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "serviceChannel")</span></em>
    String service() {
        <span class="hl-keyword">return</span> <span class="hl-string">"It works!"</span>;
    }

}</pre>
</div>
<p>The configuration is similar to the <code class="literal">HttpRequestHandlingEndpointSupport</code> (mentioned prior to the example), except that we use <code class="literal">@EnableWebFlux</code> to add the WebFlux infrastructure to our integration application.
Also, the <code class="literal">WebFluxInboundEndpoint</code> performs <code class="literal">sendAndReceive</code> operations to the downstream flow by using back-pressure, on-demand based capabilities, provided by the reactive HTTP server implementation.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The reply part is non-blocking as well and is based on the internal <code class="literal">FutureReplyChannel</code>, which is flat-mapped to a reply <code class="literal">Mono</code> for on-demand resolution.</p>
</td></tr></table></div>
<p>You can configure the <code class="literal">WebFluxInboundEndpoint</code> with a custom <code class="literal">ServerCodecConfigurer</code>, a <code class="literal">RequestedContentTypeResolver</code>, and even a <code class="literal">ReactiveAdapterRegistry</code>.
The latter provides a mechanism you can use to return a reply as any reactive type: Reactor <code class="literal">Flux</code>, RxJava <code class="literal">Observable</code>, <code class="literal">Flowable</code>, and others.
This way, we can implement <a class="ulink" href="https://en.wikipedia.org/wiki/Server-sent_events" target="_top">Server Sent Events</a> scenarios with Spring Integration components, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> IntegrationFlow sseFlow() {
    <span class="hl-keyword">return</span> IntegrationFlows
            .from(WebFlux.inboundGateway(<span class="hl-string">"/sse"</span>)
                    .requestMapping(m -&gt; m.produces(MediaType.TEXT_EVENT_STREAM_VALUE)))
            .handle((p, h) -&gt; Flux.just(<span class="hl-string">"foo"</span>, <span class="hl-string">"bar"</span>, <span class="hl-string">"baz"</span>))
            .get();
}</pre>
</div>
<p>See <a class="xref" href="#http-request-mapping" title="20.3.2&nbsp;Request Mapping Support">Section&nbsp;20.3.2, &#8220;Request Mapping Support&#8221;</a> and <a class="xref" href="#http-cors" title="20.3.3&nbsp;Cross-origin Resource Sharing (CORS) Support">Section&nbsp;20.3.3, &#8220;Cross-origin Resource Sharing (CORS) Support&#8221;</a> for more possible configuration options.</p>
<p>When the request body is empty or <code class="literal">payloadExpression</code> returns <code class="literal">null</code>, the request params (<code class="literal">MultiValueMap&lt;String, String&gt;</code>) is used for a <code class="literal">payload</code> of the target message to process.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="webflux-outbound" href="#webflux-outbound"></a>35.2&nbsp;WebFlux Outbound Components</h2></div></div></div>

<p>The <code class="literal">WebFluxRequestExecutingMessageHandler</code> (starting with version 5.0) implementation is similar to <code class="literal">HttpRequestExecutingMessageHandler</code>.
It uses a <code class="literal">WebClient</code> from the Spring Framework WebFlux module.
To configure it, define a bean similar to the following:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"httpReactiveOutbound"</span>
    <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.webflux.outbound.WebFluxRequestExecutingMessageHandler"</span><span class="hl-tag">&gt;</span>
     <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"http://localhost:8080/example"</span><span class="hl-tag"> /&gt;</span>
     <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"outputChannel"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"responseChannel"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
</div>
<p>You can configure a <code class="literal">WebClient</code> instance to use, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;beans:bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"webClient"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.web.reactive.function.client.WebClient"</span>
				<span class="hl-attribute">factory-method</span>=<span class="hl-value">"create"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"httpReactiveOutbound"</span>
    <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.webflux.outbound.WebFluxRequestExecutingMessageHandler"</span><span class="hl-tag">&gt;</span>
     <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"http://localhost:8080/example"</span><span class="hl-tag"> /&gt;</span>
     <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">re</span>=<span class="hl-value">"webClient"</span><span class="hl-tag"> /&gt;</span>
     <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"outputChannel"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"responseChannel"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
</div>
<p>The <code class="literal">WebClient</code> <code class="literal">exchange()</code> operation returns a <code class="literal">Mono&lt;ClientResponse&gt;</code>, which is mapped (by using several <code class="literal">Mono.map()</code> steps) to an <code class="literal">AbstractIntegrationMessageBuilder</code> as the output from the <code class="literal">WebFluxRequestExecutingMessageHandler</code>.
Together with the <code class="literal">ReactiveChannel</code> as an <code class="literal">outputChannel</code>, the <code class="literal">Mono&lt;ClientResponse&gt;</code> evaluation is deferred until a downstream subscription is made.
Otherwise, it is treated as an <code class="literal">async</code> mode, and the <code class="literal">Mono</code> response is adapted to a <code class="literal">SettableListenableFuture</code> for an asynchronous reply from the <code class="literal">WebFluxRequestExecutingMessageHandler</code>.
The target payload of the output message depends on the <code class="literal">WebFluxRequestExecutingMessageHandler</code> configuration.
The <code class="literal">setExpectedResponseType(Class&lt;?&gt;)</code> or <code class="literal">setExpectedResponseTypeExpression(Expression)</code> identifies the target type of the response body element conversion.
If <code class="literal">replyPayloadToFlux</code> is set to <code class="literal">true</code>, the response body is converted to a <code class="literal">Flux</code> with the provided <code class="literal">expectedResponseType</code> for each element, and this <code class="literal">Flux</code> is sent as the payload downstream.
Afterwards, you can use a <a class="link" href="#splitter" title="8.3&nbsp;Splitter">splitter</a> to iterate over this <code class="literal">Flux</code> in a reactive manner.</p>
<p>In addition a <code class="literal">BodyExtractor&lt;?, ClientHttpResponse&gt;</code> can be injected into the <code class="literal">WebFluxRequestExecutingMessageHandler</code> instead of the <code class="literal">expectedResponseType</code> and <code class="literal">replyPayloadToFlux</code> properties.
It can be used for low-level access to the <code class="literal">ClientHttpResponse</code> and more control over body and HTTP headers conversion.
Spring Integration provides <code class="literal">ClientHttpResponseBodyExtractor</code> as a identity function to produce (downstream) the whole <code class="literal">ClientHttpResponse</code> and any other possible custom logic.</p>
<p>See <a class="xref" href="#http-outbound" title="20.2&nbsp;HTTP Outbound Components">Section&nbsp;20.2, &#8220;HTTP Outbound Components&#8221;</a> for more possible configuration options.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="webflux-namespace" href="#webflux-namespace"></a>35.3&nbsp;WebFlux Namespace Support</h2></div></div></div>

<p>Spring Integration provides a <code class="literal">webflux</code> namespace and the corresponding schema definition.
To include it in your configuration, include the following namespace declaration in your application context configuration file:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
  <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
  <span class="hl-attribute">xmlns:int</span>=<span class="hl-value">"http://www.springframework.org/schema/integration"</span>
  <span class="hl-attribute">xmlns:int-webflux</span>=<span class="hl-value">"http://www.springframework.org/schema/integration/webflux"</span>
  <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"
    http://www.springframework.org/schema/beans
    http://www.springframework.org/schema/beans/spring-beans.xsd
    http://www.springframework.org/schema/integration
    http://www.springframework.org/schema/integration/spring-integration.xsd
    http://www.springframework.org/schema/integration/webflux
    http://www.springframework.org/schema/integration/webflux/spring-integration-webflux.xsd"</span><span class="hl-tag">&gt;</span>
    ...
<span class="hl-tag">&lt;/beans&gt;</span></pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_inbound_3" href="#_inbound_3"></a>35.3.1&nbsp;Inbound</h3></div></div></div>

<p>To configure Spring Integration WebFlux with XML, you caus use appropriate components from the <code class="literal">int-webflux</code> namespace: <code class="literal">inbound-channel-adapter</code> or <code class="literal">inbound-gateway</code>, corresponding to request and response requirements, respectively.
The following example shows how to configure both an inbound channel adapter and an inbound gateway:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"reactiveFullConfig"</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"requests"</span>
                         <span class="hl-attribute">path</span>=<span class="hl-value">"test1"</span>
                         <span class="hl-attribute">auto-startup</span>=<span class="hl-value">"false"</span>
                         <span class="hl-attribute">phase</span>=<span class="hl-value">"101"</span>
                         <span class="hl-attribute">request-payload-type</span>=<span class="hl-value">"byte[]"</span>
                         <span class="hl-attribute">error-channel</span>=<span class="hl-value">"errorChannel"</span>
                         <span class="hl-attribute">payload-expression</span>=<span class="hl-value">"payload"</span>
                         <span class="hl-attribute">supported-methods</span>=<span class="hl-value">"PUT"</span>
                         <span class="hl-attribute">status-code-expression</span>=<span class="hl-value">"'202'"</span>
                         <span class="hl-attribute">header-mapper</span>=<span class="hl-value">"headerMapper"</span>
                         <span class="hl-attribute">codec-configurer</span>=<span class="hl-value">"codecConfigurer"</span>
                         <span class="hl-attribute">reactive-adapter-registry</span>=<span class="hl-value">"reactiveAdapterRegistry"</span>
                         <span class="hl-attribute">requested-content-type-resolver</span>=<span class="hl-value">"requestedContentTypeResolver"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;request-mapping</span> <span class="hl-attribute">headers</span>=<span class="hl-value">"foo"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;cross-origin</span> <span class="hl-attribute">origin</span>=<span class="hl-value">"foo"</span>
                  <span class="hl-attribute">method</span>=<span class="hl-value">"PUT"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;header</span> <span class="hl-attribute">name</span>=<span class="hl-value">"foo"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"'foo'"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/inbound-channel-adapter&gt;</span>

<span class="hl-tag">&lt;inbound-gateway</span> <span class="hl-attribute">id</span>=<span class="hl-value">"reactiveFullConfig"</span> <span class="hl-attribute">request-channel</span>=<span class="hl-value">"requests"</span>
                 <span class="hl-attribute">path</span>=<span class="hl-value">"test1"</span>
                 <span class="hl-attribute">auto-startup</span>=<span class="hl-value">"false"</span>
                 <span class="hl-attribute">phase</span>=<span class="hl-value">"101"</span>
                 <span class="hl-attribute">request-payload-type</span>=<span class="hl-value">"byte[]"</span>
                 <span class="hl-attribute">error-channel</span>=<span class="hl-value">"errorChannel"</span>
                 <span class="hl-attribute">payload-expression</span>=<span class="hl-value">"payload"</span>
                 <span class="hl-attribute">supported-methods</span>=<span class="hl-value">"PUT"</span>
                 <span class="hl-attribute">reply-timeout-status-code-expression</span>=<span class="hl-value">"'504'"</span>
                 <span class="hl-attribute">header-mapper</span>=<span class="hl-value">"headerMapper"</span>
                 <span class="hl-attribute">codec-configurer</span>=<span class="hl-value">"codecConfigurer"</span>
                 <span class="hl-attribute">reactive-adapter-registry</span>=<span class="hl-value">"reactiveAdapterRegistry"</span>
                 <span class="hl-attribute">requested-content-type-resolver</span>=<span class="hl-value">"requestedContentTypeResolver"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;request-mapping</span> <span class="hl-attribute">headers</span>=<span class="hl-value">"foo"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;cross-origin</span> <span class="hl-attribute">origin</span>=<span class="hl-value">"foo"</span>
                  <span class="hl-attribute">method</span>=<span class="hl-value">"PUT"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;header</span> <span class="hl-attribute">name</span>=<span class="hl-value">"foo"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"'foo'"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/inbound-gateway&gt;</span></pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_outbound_3" href="#_outbound_3"></a>35.3.2&nbsp;Outbound</h3></div></div></div>

<p>If you want to execute the HTTP request in a reactive, non-blocking way, you can use the <code class="literal">outbound-gateway</code> or <code class="literal">outbound-channel-adapter</code>.
The following example shows how to configure both an outbound gateway and an outbound channel adapter:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-webflux:outbound-gateway</span> <span class="hl-attribute">id</span>=<span class="hl-value">"reactiveExample1"</span>
    <span class="hl-attribute">request-channel</span>=<span class="hl-value">"requests"</span>
    <span class="hl-attribute">url</span>=<span class="hl-value">"http://localhost/test"</span>
    <span class="hl-attribute">http-method-expression</span>=<span class="hl-value">"headers.httpMethod"</span>
    <span class="hl-attribute">extract-request-payload</span>=<span class="hl-value">"false"</span>
    <span class="hl-attribute">expected-response-type-expression</span>=<span class="hl-value">"payload"</span>
    <span class="hl-attribute">charset</span>=<span class="hl-value">"UTF-8"</span>
    <span class="hl-attribute">reply-timeout</span>=<span class="hl-value">"1234"</span>
    <span class="hl-attribute">reply-channel</span>=<span class="hl-value">"replies"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int-webflux:outbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"reactiveExample2"</span>
    <span class="hl-attribute">url</span>=<span class="hl-value">"http://localhost/example"</span>
    <span class="hl-attribute">http-method</span>=<span class="hl-value">"GET"</span>
    <span class="hl-attribute">channel</span>=<span class="hl-value">"requests"</span>
    <span class="hl-attribute">charset</span>=<span class="hl-value">"UTF-8"</span>
    <span class="hl-attribute">extract-payload</span>=<span class="hl-value">"false"</span>
    <span class="hl-attribute">expected-response-type</span>=<span class="hl-value">"java.lang.String"</span>
    <span class="hl-attribute">order</span>=<span class="hl-value">"3"</span>
    <span class="hl-attribute">auto-startup</span>=<span class="hl-value">"false"</span><span class="hl-tag">/&gt;</span></pre>
</div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="webflux-java-config" href="#webflux-java-config"></a>35.4&nbsp;Configuring WebFlux Endpoints with Java</h2></div></div></div>

<p>The following example shows how to configure a WebFlux inbound endpoint with Java:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> WebFluxInboundEndpoint jsonInboundEndpoint() {
    WebFluxInboundEndpoint endpoint = <span class="hl-keyword">new</span> WebFluxInboundEndpoint();
    RequestMapping requestMapping = <span class="hl-keyword">new</span> RequestMapping();
    requestMapping.setPathPatterns(<span class="hl-string">"/persons"</span>);
    endpoint.setRequestMapping(requestMapping);
    endpoint.setRequestChannel(fluxResultChannel());
    <span class="hl-keyword">return</span> endpoint;
}

<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> MessageChannel fluxResultChannel() {
    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> FluxMessageChannel();
}

<em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "fluxResultChannel")</span></em>
Flux&lt;Person&gt; getPersons() {
    <span class="hl-keyword">return</span> Flux.just(<span class="hl-keyword">new</span> Person(<span class="hl-string">"Jane"</span>), <span class="hl-keyword">new</span> Person(<span class="hl-string">"Jason"</span>), <span class="hl-keyword">new</span> Person(<span class="hl-string">"John"</span>));
}</pre>
</div>
<p>The following example shows how to configure a WebFlux inbound gateway with the Java DSL:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> IntegrationFlow inboundChannelAdapterFlow() {
    <span class="hl-keyword">return</span> IntegrationFlows
        .from(WebFlux.inboundChannelAdapter(<span class="hl-string">"/reactivePost"</span>)
            .requestMapping(m -&gt; m.methods(HttpMethod.POST))
            .requestPayloadType(ResolvableType.forClassWithGenerics(Flux.<span class="hl-keyword">class</span>, String.<span class="hl-keyword">class</span>))
            .statusCodeFunction(m -&gt; HttpStatus.ACCEPTED))
        .channel(c -&gt; c.queue(<span class="hl-string">"storeChannel"</span>))
        .get();
}</pre>
</div>
<p>The following example shows how to configure a WebFlux outbound gateway with Java:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "reactiveHttpOutRequest")</span></em>
<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> WebFluxRequestExecutingMessageHandler reactiveOutbound(WebClient client) {
    WebFluxRequestExecutingMessageHandler handler =
        <span class="hl-keyword">new</span> WebFluxRequestExecutingMessageHandler(<span class="hl-string">"http://localhost:8080/foo"</span>, client);
    handler.setHttpMethod(HttpMethod.POST);
    handler.setExpectedResponseType(String.<span class="hl-keyword">class</span>);
    <span class="hl-keyword">return</span> handler;
}</pre>
</div>
<p>The following example shows how to configure a WebFlux outbound gateway with the Java DSL:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> IntegrationFlow outboundReactive() {
    <span class="hl-keyword">return</span> f -&gt; f
        .handle(WebFlux.&lt;MultiValueMap&lt;String, String&gt;&gt;outboundGateway(m -&gt;
                UriComponentsBuilder.fromUriString(<span class="hl-string">"http://localhost:8080/foo"</span>)
                        .queryParams(m.getPayload())
                        .build()
                        .toUri())
                .httpMethod(HttpMethod.GET)
                .expectedResponseType(String.<span class="hl-keyword">class</span>));
}</pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="webflux-header-mapping" href="#webflux-header-mapping"></a>35.5&nbsp;WebFlux Header Mappings</h2></div></div></div>

<p>Since WebFlux components are fully based on the HTTP protocol, there is no difference in the HTTP headers mapping.
See <a class="xref" href="#http-header-mapping" title="20.7&nbsp;HTTP Header Mappings">Section&nbsp;20.7, &#8220;HTTP Header Mappings&#8221;</a> for more possible options and components to use for mapping headers.</p>
</div>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="web-sockets" href="#web-sockets"></a>36.&nbsp;WebSockets Support</h2></div></div></div>

<p>Starting with version 4.1, Spring Integration has WebSocket support.
It is based on the architecture, infrastructure, and API from the Spring Framework&#8217;s <code class="literal">web-socket</code> module.
Therefore, many of Spring WebSocket&#8217;s components (such as <code class="literal">SubProtocolHandler</code> or <code class="literal">WebSocketClient</code>) and configuration options (such as  <code class="literal">@EnableWebSocketMessageBroker</code>) can be reused within Spring Integration.
For more information, see the <a class="ulink" href="http://docs.spring.io/spring/docs/current/spring-framework-reference/html/#websocket" target="_top">Spring Framework WebSocket Support</a> chapter in the Spring Framework reference manual.</p>
<p>You need to include this dependency into your project:</p>
<div class="informalexample">
<p>
<b>Maven.&nbsp;</b>

</p><pre class="programlisting"><span class="hl-tag">&lt;dependency&gt;</span>
    <span class="hl-tag">&lt;groupId&gt;</span>org.springframework.integration<span class="hl-tag">&lt;/groupId&gt;</span>
    <span class="hl-tag">&lt;artifactId&gt;</span>spring-integration-websocket<span class="hl-tag">&lt;/artifactId&gt;</span>
    <span class="hl-tag">&lt;version&gt;</span>5.1.2.RELEASE<span class="hl-tag">&lt;/version&gt;</span>
<span class="hl-tag">&lt;/dependency&gt;</span></pre><p>

</p>
<p>
<b>Gradle.&nbsp;</b>

</p><pre class="programlisting">compile <span class="hl-string">"org.springframework.integration:spring-integration-websocket:5.1.2.RELEASE"</span></pre><p>

</p>
</div>
<p>For server side, the <code class="literal">org.springframework:spring-webmvc</code> dependency must be included explicitly.</p>
<p>The Spring Framework WebSocket infrastructure is based on the Spring messaging foundation and provides a basic messaging framework based on the same <code class="literal">MessageChannel</code> implementations and <code class="literal">MessageHandler</code> implementations that Spring Integration uses (and some POJO-method annotation mappings).
Consequently, Spring Integration can be directly involved in a WebSocket flow, even without WebSocket adapters.
For this purpose, you can configure a Spring Integration <code class="literal">@MessagingGateway</code> with appropriate annotations, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@MessagingGateway</span></em>
<em><span class="hl-annotation" style="color: gray">@Controller</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> WebSocketGateway {

    <em><span class="hl-annotation" style="color: gray">@MessageMapping("/greeting")</span></em>
    <em><span class="hl-annotation" style="color: gray">@SendToUser("/queue/answer")</span></em>
    <em><span class="hl-annotation" style="color: gray">@Gateway(requestChannel = "greetingChannel")</span></em>
    String greeting(String payload);

}</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="web-socket-overview" href="#web-socket-overview"></a>36.1&nbsp;Overview</h2></div></div></div>

<p>Since the WebSocket protocol is streaming by definition and we can send and receive messages to and from a WebSocket at the same time, we can deal with an appropriate <code class="literal">WebSocketSession</code>, regardless of being on the client or server side.
To encapsulate the connection management and <code class="literal">WebSocketSession</code> registry, the <code class="literal">IntegrationWebSocketContainer</code> is provided with <code class="literal">ClientWebSocketContainer</code> and <code class="literal">ServerWebSocketContainer</code> implementations.
Thanks to the <a class="ulink" href="https://www.jcp.org/en/jsr/detail?id=356" target="_top">WebSocket API</a> and its implementation in the Spring Framework (with many extensions), the same classes are used on the server side as well as the client side (from a Java perspective, of course).
Consequently, most connection and <code class="literal">WebSocketSession</code> registry options are the same on both sides.
That lets us reuse many configuration items and infrastructure hooks to build WebSocket applications on the server side as well as on the client side.
The following example shows how components can serve both purposes:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-comment">//Client side</span>
<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> WebSocketClient webSocketClient() {
    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> SockJsClient(Collections.singletonList(<span class="hl-keyword">new</span> WebSocketTransport(<span class="hl-keyword">new</span> JettyWebSocketClient())));
}

<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> IntegrationWebSocketContainer clientWebSocketContainer() {
    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> ClientWebSocketContainer(webSocketClient(), <span class="hl-string">"ws://my.server.com/endpoint"</span>);
}

<span class="hl-comment">//Server side</span>
<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> IntegrationWebSocketContainer serverWebSocketContainer() {
    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> ServerWebSocketContainer(<span class="hl-string">"/endpoint"</span>).withSockJs();
}</pre>
</div>
<p>The <code class="literal">IntegrationWebSocketContainer</code> is designed to achieve bidirectional messaging and can be shared between inbound and outbound channel adapters (see below), can be referenced from only one of them when using one-way (sending or receiving) WebSocket messaging.
It can be used without any channel adapter, but, in this case, <code class="literal">IntegrationWebSocketContainer</code> only plays a role as the <code class="literal">WebSocketSession</code> registry.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The <code class="literal">ServerWebSocketContainer</code> implements <code class="literal">WebSocketConfigurer</code> to register an internal <code class="literal">IntegrationWebSocketContainer.IntegrationWebSocketHandler</code> as an <code class="literal">Endpoint</code>.
It does so under the provided <code class="literal">paths</code> and other server WebSocket options (such as <code class="literal">HandshakeHandler</code> or <code class="literal">SockJS fallback</code>) within the <code class="literal">ServletWebSocketHandlerRegistry</code> for the target vendor WebSocket Container.
This registration is achieved with an infrastructural <code class="literal">WebSocketIntegrationConfigurationInitializer</code> component, which does the same as the <code class="literal">@EnableWebSocket</code> annotation.
This means that, by using <code class="literal">@EnableIntegration</code> (or any Spring Integration namespace in the application context), you can omit the <code class="literal">@EnableWebSocket</code> declaration, because the Spring Integration infrastructure detects all WebSocket endpoints.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="web-socket-inbound-adapter" href="#web-socket-inbound-adapter"></a>36.2&nbsp;WebSocket Inbound Channel Adapter</h2></div></div></div>

<p>The <code class="literal">WebSocketInboundChannelAdapter</code> implements the receiving part of <code class="literal">WebSocketSession</code> interaction.
You must supply it with a <code class="literal">IntegrationWebSocketContainer</code>, and the adapter registers itself as a <code class="literal">WebSocketListener</code> to handle incoming messages and <code class="literal">WebSocketSession</code> events.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Only one <code class="literal">WebSocketListener</code> can be registered in the <code class="literal">IntegrationWebSocketContainer</code>.</p>
</td></tr></table></div>
<p>For WebSocket subprotocols, the <code class="literal">WebSocketInboundChannelAdapter</code> can be configured with <code class="literal">SubProtocolHandlerRegistry</code> as the second constructor argument.
The adapter delegates to the <code class="literal">SubProtocolHandlerRegistry</code> to determine the appropriate <code class="literal">SubProtocolHandler</code> for the accepted <code class="literal">WebSocketSession</code> and to convert a <code class="literal">WebSocketMessage</code> to a <code class="literal">Message</code> according to the sub-protocol implementation.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>By default, the <code class="literal">WebSocketInboundChannelAdapter</code> relies only on the raw <code class="literal">PassThruSubProtocolHandler</code> implementation, which converts the <code class="literal">WebSocketMessage</code> to a <code class="literal">Message</code>.</p>
</td></tr></table></div>
<p>The <code class="literal">WebSocketInboundChannelAdapter</code> accepts and sends to the underlying integration flow only <code class="literal">Message</code> instances that have <code class="literal">SimpMessageType.MESSAGE</code> or an empty <code class="literal">simpMessageType</code> header.
All other <code class="literal">Message</code> types are handled through the <code class="literal">ApplicationEvent</code> instances emitted from a <code class="literal">SubProtocolHandler</code> implementation (such as
<code class="literal">StompSubProtocolHandler</code>).</p>
<p>On the server side, if the <code class="literal">@EnableWebSocketMessageBroker</code> configuration is present, you can configure <code class="literal">WebSocketInboundChannelAdapter</code> with the <code class="literal">useBroker = true</code> option.
In this case, all <code class="literal">non-MESSAGE</code> <code class="literal">Message</code> types are delegated to the provided <code class="literal">AbstractBrokerMessageHandler</code>.
In addition, if the broker relay is configured with destination prefixes, those messages that match the Broker destinations are routed to the <code class="literal">AbstractBrokerMessageHandler</code> instead of to the <code class="literal">outputChannel</code> of the <code class="literal">WebSocketInboundChannelAdapter</code>.</p>
<p>If <code class="literal">useBroker = false</code> and the received message is of the <code class="literal">SimpMessageType.CONNECT</code> type, the <code class="literal">WebSocketInboundChannelAdapter</code> immediately sends a <code class="literal">SimpMessageType.CONNECT_ACK</code> message to the <code class="literal">WebSocketSession</code> without sending it to the channel.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Spring&#8217;s WebSocket Support allows the configuration of only one broker relay.
Consequently, we do not require an <code class="literal">AbstractBrokerMessageHandler</code> reference.
It is detected in the Application Context.</p>
</td></tr></table></div>
<p>For more configuration options, see <a class="xref" href="#web-sockets-namespace" title="36.4&nbsp;WebSockets Namespace Support">Section&nbsp;36.4, &#8220;WebSockets Namespace Support&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="web-socket-outbound-adapter" href="#web-socket-outbound-adapter"></a>36.3&nbsp;WebSocket Outbound Channel Adapter</h2></div></div></div>

<p>The <code class="literal">WebSocketOutboundChannelAdapter</code>:</p>
<div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
Accepts Spring Integration messages from its <code class="literal">MessageChannel</code>
</li><li class="listitem">
Determines the <code class="literal">WebSocketSession</code> <code class="literal">id</code> from the <code class="literal">MessageHeaders</code>
</li><li class="listitem">
Retrieves the <code class="literal">WebSocketSession</code> from the provided <code class="literal">IntegrationWebSocketContainer</code>
</li><li class="listitem">
Delegates the conversion and sending of <code class="literal">WebSocketMessage</code> work to the appropriate <code class="literal">SubProtocolHandler</code> from the provided <code class="literal">SubProtocolHandlerRegistry</code>.
</li></ol></div>
<p>On the client side, the <code class="literal">WebSocketSession</code> <code class="literal">id</code> message header is not required, because <code class="literal">ClientWebSocketContainer</code> deals only with a single connection and its <code class="literal">WebSocketSession</code> respectively.</p>
<p>To use the STOMP subprotocol, you should configure this adapter with a <code class="literal">StompSubProtocolHandler</code>.
Then you can send any STOMP message type to this adapter, using <code class="literal">StompHeaderAccessor.create(StompCommand...)</code> and a <code class="literal">MessageBuilder</code>, or just using a <code class="literal">HeaderEnricher</code> (see <a class="xref" href="#header-enricher" title="9.2.1&nbsp;Header Enricher">Section&nbsp;9.2.1, &#8220;Header Enricher&#8221;</a>).</p>
<p>The rest of this chapter covers largely additional configuration options.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="web-sockets-namespace" href="#web-sockets-namespace"></a>36.4&nbsp;WebSockets Namespace Support</h2></div></div></div>

<p>The Spring Integration WebSocket namespace includes several components described in the remainder of this chapter.
To include it in your configuration, use the following namespace declaration in your application context configuration file:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
  <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
  <span class="hl-attribute">xmlns:int</span>=<span class="hl-value">"http://www.springframework.org/schema/integration"</span>
  <span class="hl-attribute">xmlns:int-websocket</span>=<span class="hl-value">"http://www.springframework.org/schema/integration/websocket"</span>
  <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"
    http://www.springframework.org/schema/beans
    http://www.springframework.org/schema/beans/spring-beans.xsd
    http://www.springframework.org/schema/integration
    http://www.springframework.org/schema/integration/spring-integration.xsd
    http://www.springframework.org/schema/integration/websocket
    http://www.springframework.org/schema/integration/websocket/spring-integration-websocket.xsd"</span><span class="hl-tag">&gt;</span>
    ...
<span class="hl-tag">&lt;/beans&gt;</span></pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="websocket-client-container-attributes" href="#websocket-client-container-attributes"></a>36.4.1&nbsp;<code class="literal">&lt;int-websocket:client-container&gt;</code> Attributes</h3></div></div></div>

<p>The following listing shows the attributes available for the <code class="literal">&lt;int-websocket:client-container&gt;</code> element:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-websocket:client-container</span>
                  <span class="hl-attribute">id</span>=<span class="hl-value">""</span>                        <a name="CO51-1" href="#CO51-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
                  client=""                    <a name="CO51-2" href="#CO51-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
                  uri=""                       <a name="CO51-3" href="#CO51-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
                  uri-variables=""             <a name="CO51-4" href="#CO51-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
                  origin=""                    <a name="CO51-5" href="#CO51-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
                  send-time-limit=""           <a name="CO51-6" href="#CO51-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>
                  send-buffer-size-limit=""    <a name="CO51-7" href="#CO51-7"></a><span><img src="images/callouts/7.png" alt="7" border="0"></span>
                  auto-startup=""              <a name="CO51-8" href="#CO51-8"></a><span><img src="images/callouts/8.png" alt="8" border="0"></span>
                  phase=""&gt;                    <a name="CO51-9" href="#CO51-9"></a><span><img src="images/callouts/9.png" alt="9" border="0"></span>
                <span class="hl-tag">&lt;int-websocket:http-headers&gt;</span>
                  <span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">""</span> <span class="hl-attribute">value</span>=<span class="hl-value">""</span><span class="hl-tag">/&gt;</span>
                <span class="hl-tag">&lt;/int-websocket:http-headers&gt;</span>  <a name="CO51-10" href="#CO51-10"></a><span><img src="images/callouts/10.png" alt="10" border="0"></span>
<span class="hl-tag">&lt;/int-websocket:client-container&gt;</span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO51-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The component bean name.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO51-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The <code class="literal">WebSocketClient</code> bean reference.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO51-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The <code class="literal">uri</code> or <code class="literal">uriTemplate</code> to the target WebSocket service.
If you use it as a <code class="literal">uriTemplate</code> with URI variable placeholders, the <code class="literal">uri-variables</code> attribute is required.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO51-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Comma-separated values for the URI variable placeholders within the <code class="literal">uri</code> attribute value.
The values are replaced into the placeholders according to their order in the <code class="literal">uri</code>.
See <a class="ulink" href="https://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/web/util/UriComponents.html#expand-java.lang.Object" target="_top"><code class="literal">UriComponents.expand(Object...uriVariableValues)</code></a>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO51-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The <code class="literal">Origin</code> Handshake HTTP header value.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO51-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The WebSocket session <span class="emphasis"><em>send</em></span> timeout limit.
Defaults to <code class="literal">10000</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO51-7"><span><img src="images/callouts/7.png" alt="7" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The WebSocket session <span class="emphasis"><em>send</em></span> message size limit.
Defaults to <code class="literal">524288</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO51-8"><span><img src="images/callouts/8.png" alt="8" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Boolean value indicating whether this endpoint should start automatically.
Defaults to <code class="literal">false</code>, assuming that this container is started from the <a class="link" href="#web-socket-inbound-adapter" title="36.2&nbsp;WebSocket Inbound Channel Adapter">WebSocket inbound adapter</a>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO51-9"><span><img src="images/callouts/9.png" alt="9" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The lifecycle phase within which this endpoint should start and stop.
The lower the value, the earlier this endpoint starts and the later it stops.
The default is <code class="literal">Integer.MAX_VALUE</code>.
Values can be negative.
See <a class="ulink" href="https://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/context/SmartLifecycle.html" target="_top"><code class="literal">SmartLifeCycle</code></a>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO51-10"><span><img src="images/callouts/10.png" alt="10" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A <code class="literal">Map</code> of <code class="literal">HttpHeaders</code> to be used with the Handshake request.</p>
</td></tr></table></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_literal_int_websocket_server_container_literal_attributes" href="#_literal_int_websocket_server_container_literal_attributes"></a>36.4.2&nbsp;<code class="literal">&lt;int-websocket:server-container&gt;</code> Attributes</h3></div></div></div>

<p>The following listing shows the attributes available for the <code class="literal">&lt;int-websocket:server-container&gt;</code> element:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-websocket:server-container</span>
          <span class="hl-attribute">id</span>=<span class="hl-value">""</span>                         <a name="CO52-1" href="#CO52-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
          path=""                       <a name="CO52-2" href="#CO52-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
          handshake-handler=""          <a name="CO52-3" href="#CO52-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
          handshake-interceptors=""     <a name="CO52-4" href="#CO52-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
          decorator-factories=""        <a name="CO52-5" href="#CO52-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
          send-time-limit=""            <a name="CO52-6" href="#CO52-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>
          send-buffer-size-limit=""     <a name="CO52-7" href="#CO52-7"></a><span><img src="images/callouts/7.png" alt="7" border="0"></span>
          allowed-origins=""&gt;           <a name="CO52-8" href="#CO52-8"></a><span><img src="images/callouts/8.png" alt="8" border="0"></span>
          <span class="hl-tag">&lt;int-websocket:sockjs</span>
            <span class="hl-attribute">client-library-url</span>=<span class="hl-value">""</span>       <a name="CO52-9" href="#CO52-9"></a><span><img src="images/callouts/9.png" alt="9" border="0"></span>
            stream-bytes-limit=""       <a name="CO52-10" href="#CO52-10"></a><span><img src="images/callouts/10.png" alt="10" border="0"></span>
            session-cookie-needed=""    <a name="CO52-11" href="#CO52-11"></a><span><img src="images/callouts/11.png" alt="11" border="0"></span>
            heartbeat-time=""           <a name="CO52-12" href="#CO52-12"></a><span><img src="images/callouts/12.png" alt="12" border="0"></span>
            disconnect-delay=""         <a name="CO52-13" href="#CO52-13"></a><span><img src="images/callouts/13.png" alt="13" border="0"></span>
            message-cache-size=""       <a name="CO52-14" href="#CO52-14"></a><span><img src="images/callouts/14.png" alt="14" border="0"></span>
            websocket-enabled=""        <a name="CO52-15" href="#CO52-15"></a><span><img src="images/callouts/15.png" alt="15" border="0"></span>
            scheduler=""                <a name="CO52-16" href="#CO52-16"></a>(16)
            message-codec=""            <a name="CO52-17" href="#CO52-17"></a>(17)
            transport-handlers=""       <a name="CO52-18" href="#CO52-18"></a>(18)
            suppress-cors="true"="" /&gt;  <a name="CO52-19" href="#CO52-19"></a>(19)
<span class="hl-tag">&lt;/int-websocket:server-container&gt;</span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO52-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The component bean name.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO52-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A path (or comma-separated paths) that maps a particular request to a <code class="literal">WebSocketHandler</code>.
Supports exact path mapping URIs (such as <code class="literal">/myPath</code>) and ant-style path patterns (such as <code class="literal">/myPath/**</code>).</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO52-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The <code class="literal">HandshakeHandler</code> bean reference.
Defaults to <code class="literal">DefaultHandshakeHandler</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO52-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>List of <code class="literal">HandshakeInterceptor</code> bean references.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO52-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>List of one or more factories (<code class="literal">WebSocketHandlerDecoratorFactory</code>) that decorate the handler used to process WebSocket messages.
This may be useful for some advanced use cases (for example, to allow Spring Security to forcibly close
the WebSocket session when the corresponding HTTP session expires).
See the <a class="ulink" href="http://docs.spring.io/spring-session/docs/current/reference/html5/#websocket" target="_top">Spring Session Project</a> for more information.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO52-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>See the same option on the <a class="link" href="#websocket-client-container-attributes" title="36.4.1&nbsp;<int-websocket:client-container&gt; Attributes"><code class="literal">&lt;int-websocket:client-container&gt;</code></a>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO52-7"><span><img src="images/callouts/7.png" alt="7" border="0"></span></a> </p></td><td valign="top" align="left">
<p>See the same option on the <a class="link" href="#websocket-client-container-attributes" title="36.4.1&nbsp;<int-websocket:client-container&gt; Attributes"><code class="literal">&lt;int-websocket:client-container&gt;</code></a>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO52-8"><span><img src="images/callouts/8.png" alt="8" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The allowed origin header values.
You can specify multiple origins as a comma-separated list.
This check is mostly designed for browser clients.
There is nothing preventing other types of client from modifying the origin header value.
When SockJS is enabled and allowed origins are restricted, transport types that do not use origin headers for cross-origin requests (<code class="literal">jsonp-polling</code>, <code class="literal">iframe-xhr-polling</code>, <code class="literal">iframe-eventsource</code>, and <code class="literal">iframe-htmlfile</code>) are disabled.
As a consequence, IE6 and IE7 are not supported, and IE8 and IE9 are supported only without cookies.
By default, all origins are allowed.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO52-9"><span><img src="images/callouts/9.png" alt="9" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Transports with no native cross-domain communication (such as <code class="literal">eventsource</code> and <code class="literal">htmlfile</code>) must get a simple page from the "<code class="literal">foreign</code>" domain in an invisible iframe so that code in the iframe can run from a domain local to the SockJS server.
Since the iframe needs to load the SockJS javascript client library, this property lets you specify the location from which to load it.
By default, it points to <code class="literal">https://d1fxtkz8shb9d2.cloudfront.net/sockjs-0.3.4.min.js</code>.
However, you can also set it to point to a URL served by the application.
Note that it is possible to specify a relative URL, in which case the URL must be relative to the iframe URL.
For example, assuming a SockJS endpoint mapped to <code class="literal">/sockjs</code> and the resulting iframe URL is <code class="literal">/sockjs/iframe.html</code>, the relative URL must start with "../../" to traverse up to the location above the SockJS mapping.
For prefix-based servlet mapping, you may need one more traversal.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO52-10"><span><img src="images/callouts/10.png" alt="10" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Minimum number of bytes that can be sent over a single HTTP streaming request before it is closed.
Defaults to <code class="literal">128K</code> (that is, 128*1024 or 131072 bytes).</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO52-11"><span><img src="images/callouts/11.png" alt="11" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The <code class="literal">cookie_needed</code> value in the response from the SockJs <code class="literal">/info</code> endpoint.
This property indicates whether a <code class="literal">JSESSIONID</code> cookie is required for the application to function correctly (for example, for load balancing or in Java Servlet containers for the use of an HTTP session).</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO52-12"><span><img src="images/callouts/12.png" alt="12" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The amount of time (in milliseconds) when the server has not sent any messages and after which the server should
send a heartbeat frame to the client in order to keep the connection from breaking.
The default value is <code class="literal">25,000</code> (25 seconds).</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO52-13"><span><img src="images/callouts/13.png" alt="13" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The amount of time (in milliseconds) before a client is considered disconnected after not having a receiving connection (that is, an active connection over which the server can send data to the client).
The default value is <code class="literal">5000</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO52-14"><span><img src="images/callouts/14.png" alt="14" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The number of server-to-client messages that a session can cache while waiting for the next HTTP polling request from the client.
The default size is <code class="literal">100</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO52-15"><span><img src="images/callouts/15.png" alt="15" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Some load balancers do not support WebSockets.
Set this option to <code class="literal">false</code> to disable the WebSocket transport on the server side.
The default value is <code class="literal">true</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO52-16">(16)</a> </p></td><td valign="top" align="left">
<p>The <code class="literal">TaskScheduler</code> bean reference.
A new <code class="literal">ThreadPoolTaskScheduler</code> instance is created if no value is provided.
This scheduler instance is used for scheduling heart-beat messages.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO52-17">(17)</a> </p></td><td valign="top" align="left">
<p>The <code class="literal">SockJsMessageCodec</code> bean reference to use for encoding and decoding SockJS messages.
By default, <code class="literal">Jackson2SockJsMessageCodec</code> is used, which requires the Jackson library to be present on the classpath.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO52-18">(18)</a> </p></td><td valign="top" align="left">
<p>List of <code class="literal">TransportHandler</code> bean references.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO52-19">(19)</a> </p></td><td valign="top" align="left">
<p>Whether to disable automatic addition of CORS headers for SockJS requests.
The default value is <code class="literal">false</code>.</p>
</td></tr></table></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="websocket-outbound-channel-adapter-attributes" href="#websocket-outbound-channel-adapter-attributes"></a>36.4.3&nbsp;<code class="literal">&lt;int-websocket:outbound-channel-adapter&gt;</code> Attributes</h3></div></div></div>

<p>The following listing shows the attributes available for the <code class="literal">&lt;int-websocket:outbound-channel-adapter&gt;</code> element:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-websocket:outbound-channel-adapter</span>
                          <span class="hl-attribute">id</span>=<span class="hl-value">""</span>                             <a name="CO53-1" href="#CO53-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
                          channel=""                        <a name="CO53-2" href="#CO53-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
                          container=""                      <a name="CO53-3" href="#CO53-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
                          default-protocol-handler=""       <a name="CO53-4" href="#CO53-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
                          protocol-handlers=""              <a name="CO53-5" href="#CO53-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
                          message-converters=""             <a name="CO53-6" href="#CO53-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>
                          merge-with-default-converters=""  <a name="CO53-7" href="#CO53-7"></a><span><img src="images/callouts/7.png" alt="7" border="0"></span>
                          auto-startup=""                   <a name="CO53-8" href="#CO53-8"></a><span><img src="images/callouts/8.png" alt="8" border="0"></span>
                          phase=""/&gt;                        <a name="CO53-9" href="#CO53-9"></a><span><img src="images/callouts/9.png" alt="9" border="0"></span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO53-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The component bean name.
If you do not provide the <code class="literal">channel</code> attribute, a <code class="literal">DirectChannel</code> is created and registered in the application context with this <code class="literal">id</code> attribute as the bean name.
In this case, the endpoint is registered with the bean name <code class="literal">id</code> plus <code class="literal">.adapter</code>.
And the <code class="literal">MessageHandler</code> is registered with the bean alias <code class="literal">id</code> plus <code class="literal">.handler</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO53-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Identifies the channel attached to this adapter.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO53-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The reference to the <code class="literal">IntegrationWebSocketContainer</code> bean, which encapsulates the low-level connection and <code class="literal">WebSocketSession</code> handling operations.
Required.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO53-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Optional reference to a <code class="literal">SubProtocolHandler</code> instance.
It is used when the client did not request a sub-protocol or it is a single protocol-handler.
If this reference or a <code class="literal">protocol-handlers</code> list is not provided, the <code class="literal">PassThruSubProtocolHandler</code> is used by default.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO53-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>List of <code class="literal">SubProtocolHandler</code> bean references for this channel adapter.
If you provide only a single bean reference and do not provide a <code class="literal">default-protocol-handler</code>, that single <code class="literal">SubProtocolHandler</code> is used as the <code class="literal">default-protocol-handler</code>.
If you do not set this attribute or <code class="literal">default-protocol-handler</code>, the <code class="literal">PassThruSubProtocolHandler</code> is used by default.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO53-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>List of <code class="literal">MessageConverter</code> bean references for this channel adapter.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO53-7"><span><img src="images/callouts/7.png" alt="7" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Boolean value indicating whether the default converters should be registered after any custom converters.
This flag is used only if <code class="literal">message-converters</code> is provided.
Otherwise, all default converters are registered.
Defaults to <code class="literal">false</code>.
The default converters are (in order): <code class="literal">StringMessageConverter</code>, <code class="literal">ByteArrayMessageConverter</code>, and <code class="literal">MappingJackson2MessageConverter</code> (if the Jackson library is present on the classpath).</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO53-8"><span><img src="images/callouts/8.png" alt="8" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Boolean value indicating whether this endpoint should start automatically.
Defaults to <code class="literal">true</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO53-9"><span><img src="images/callouts/9.png" alt="9" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The lifecycle phase within which this endpoint should start and stop.
The lower the value, the earlier this endpoint starts and the later it stops.
The default is <code class="literal">Integer.MIN_VALUE</code>.
Values can be negative.
See <a class="ulink" href="https://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/context/SmartLifecycle.html" target="_top"><code class="literal">SmartLifeCycle</code></a>.</p>
</td></tr></table></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_literal_int_websocket_inbound_channel_adapter_literal_attributes" href="#_literal_int_websocket_inbound_channel_adapter_literal_attributes"></a>36.4.4&nbsp;<code class="literal">&lt;int-websocket:inbound-channel-adapter&gt;</code> Attributes</h3></div></div></div>

<p>The following listing shows the attributes available for the <code class="literal">&lt;int-websocket:outbound-channel-adapter&gt;</code> element:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-websocket:inbound-channel-adapter</span>
                            <span class="hl-attribute">id</span>=<span class="hl-value">""</span>  <a name="CO54-1" href="#CO54-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
                            channel=""  <a name="CO54-2" href="#CO54-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
                            error-channel=""  <a name="CO54-3" href="#CO54-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
                            container=""  <a name="CO54-4" href="#CO54-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
                            default-protocol-handler=""  <a name="CO54-5" href="#CO54-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
                            protocol-handlers=""  <a name="CO54-6" href="#CO54-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>
                            message-converters=""  <a name="CO54-7" href="#CO54-7"></a><span><img src="images/callouts/7.png" alt="7" border="0"></span>
                            merge-with-default-converters=""  <a name="CO54-8" href="#CO54-8"></a><span><img src="images/callouts/8.png" alt="8" border="0"></span>
                            send-timeout=""  <a name="CO54-9" href="#CO54-9"></a><span><img src="images/callouts/9.png" alt="9" border="0"></span>
                            payload-type=""  <a name="CO54-10" href="#CO54-10"></a><span><img src="images/callouts/10.png" alt="10" border="0"></span>
                            use-broker=""  <a name="CO54-11" href="#CO54-11"></a><span><img src="images/callouts/11.png" alt="11" border="0"></span>
                            auto-startup=""  <a name="CO54-12" href="#CO54-12"></a><span><img src="images/callouts/12.png" alt="12" border="0"></span>
                            phase=""/&gt;  <a name="CO54-13" href="#CO54-13"></a><span><img src="images/callouts/13.png" alt="13" border="0"></span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO54-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The component bean name.
If you do not set the <code class="literal">channel</code> attribute, a <code class="literal">DirectChannel</code> is created and registered in the application context with this <code class="literal">id</code> attribute as the bean name.
In this case, the endpoint is registered with the bean name <code class="literal">id</code> plus <code class="literal">.adapter</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO54-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Identifies the channel attached to this adapter.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO54-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The <code class="literal">MessageChannel</code> bean reference to which the <code class="literal">ErrorMessage</code> instances should be sent.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO54-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>See the same option on the <a class="link" href="#websocket-outbound-channel-adapter-attributes" title="36.4.3&nbsp;<int-websocket:outbound-channel-adapter&gt; Attributes"><code class="literal">&lt;int-websocket:outbound-channel-adapter&gt;</code></a>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO54-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>See the same option on the <a class="link" href="#websocket-outbound-channel-adapter-attributes" title="36.4.3&nbsp;<int-websocket:outbound-channel-adapter&gt; Attributes"><code class="literal">&lt;int-websocket:outbound-channel-adapter&gt;</code></a>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO54-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>See the same option on the <a class="link" href="#websocket-outbound-channel-adapter-attributes" title="36.4.3&nbsp;<int-websocket:outbound-channel-adapter&gt; Attributes"><code class="literal">&lt;int-websocket:outbound-channel-adapter&gt;</code></a>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO54-7"><span><img src="images/callouts/7.png" alt="7" border="0"></span></a> </p></td><td valign="top" align="left">
<p>See the same option on the <a class="link" href="#websocket-outbound-channel-adapter-attributes" title="36.4.3&nbsp;<int-websocket:outbound-channel-adapter&gt; Attributes"><code class="literal">&lt;int-websocket:outbound-channel-adapter&gt;</code></a>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO54-8"><span><img src="images/callouts/8.png" alt="8" border="0"></span></a> </p></td><td valign="top" align="left">
<p>See the same option on the <a class="link" href="#websocket-outbound-channel-adapter-attributes" title="36.4.3&nbsp;<int-websocket:outbound-channel-adapter&gt; Attributes"><code class="literal">&lt;int-websocket:outbound-channel-adapter&gt;</code></a>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO54-9"><span><img src="images/callouts/9.png" alt="9" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Maximum amount of time (in milliseconds) to wait when sending a message to the channel if the channel can block.
For example, a <code class="literal">QueueChannel</code> can block until space is available if its maximum capacity has been reached.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO54-10"><span><img src="images/callouts/10.png" alt="10" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Fully qualified name of the Java type for the target <code class="literal">payload</code> to convert from the incoming <code class="literal">WebSocketMessage</code>.
Defaults to <code class="literal">java.lang.String</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO54-11"><span><img src="images/callouts/11.png" alt="11" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Indicates whether this adapter sends <code class="literal">non-MESSAGE</code> <code class="literal">WebSocketMessage</code> instances and messages with broker destinations to the <code class="literal">AbstractBrokerMessageHandler</code> from the application context.
When this attribute is <code class="literal">true</code>, the <code class="literal">Broker Relay</code> configuration is required.
This attribute is used only on the server side.
On the client side, it is ignored.
Defaults to <code class="literal">false</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO54-12"><span><img src="images/callouts/12.png" alt="12" border="0"></span></a> </p></td><td valign="top" align="left">
<p>See the same option on the <a class="link" href="#websocket-outbound-channel-adapter-attributes" title="36.4.3&nbsp;<int-websocket:outbound-channel-adapter&gt; Attributes"><code class="literal">&lt;int-websocket:outbound-channel-adapter&gt;</code></a>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO54-13"><span><img src="images/callouts/13.png" alt="13" border="0"></span></a> </p></td><td valign="top" align="left">
<p>See the same option on the <a class="link" href="#websocket-outbound-channel-adapter-attributes" title="36.4.3&nbsp;<int-websocket:outbound-channel-adapter&gt; Attributes"><code class="literal">&lt;int-websocket:outbound-channel-adapter&gt;</code></a>.</p>
</td></tr></table></div>
</div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="client-stomp-encoder" href="#client-stomp-encoder"></a>36.5&nbsp;Using <code class="literal">ClientStompEncoder</code></h2></div></div></div>

<p>Starting with version 4.3.13, Spring Integration provides <code class="literal">ClientStompEncoder</code> (as an extension of the standard <code class="literal">StompEncoder</code>) for use on the client side of WebSocket channel adapters.
For proper client side message preparation, you must inject an instance of the <code class="literal">ClientStompEncoder</code> into the <code class="literal">StompSubProtocolHandler</code>.
One problem with the default <code class="literal">StompSubProtocolHandler</code> is that it was designed for the server side, so it updates the <code class="literal">SEND</code> <code class="literal">stompCommand</code> header into <code class="literal">MESSAGE</code> (as required by the STOMP protocol for the server side).
If the client does not send its messages in the proper <code class="literal">SEND</code> web socket frame, some STOMP brokers do not accept them.
The purpose of the <code class="literal">ClientStompEncoder</code>, in this case, is to override the <code class="literal">stompCommand</code> header and set it to the <code class="literal">SEND</code> value before encoding the message to the <code class="literal">byte[]</code>.</p>
</div>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="ws" href="#ws"></a>37.&nbsp;Web Services Support</h2></div></div></div>

<p>This chapter describes Spring Integration&#8217;s support for web services, including:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="xref" href="#webservices-outbound" title="37.1&nbsp;Outbound Web Service Gateways">Section&nbsp;37.1, &#8220;Outbound Web Service Gateways&#8221;</a>
</li><li class="listitem">
<a class="xref" href="#webservices-inbound" title="37.2&nbsp;Inbound Web Service Gateways">Section&nbsp;37.2, &#8220;Inbound Web Service Gateways&#8221;</a>
</li><li class="listitem">
<a class="xref" href="#webservices-namespace" title="37.3&nbsp;Web Service Namespace Support">Section&nbsp;37.3, &#8220;Web Service Namespace Support&#8221;</a>
</li><li class="listitem">
<a class="xref" href="#outbound-uri" title="37.4&nbsp;Outbound URI Configuration">Section&nbsp;37.4, &#8220;Outbound URI Configuration&#8221;</a>
</li><li class="listitem">
<a class="xref" href="#ws-message-headers" title="37.5&nbsp;WS Message Headers">Section&nbsp;37.5, &#8220;WS Message Headers&#8221;</a>
</li><li class="listitem">
<a class="xref" href="#mtom-support" title="37.6&nbsp;MTOM Support">Section&nbsp;37.6, &#8220;MTOM Support&#8221;</a>
</li></ul></div>
<p>You need to include this dependency into your project:</p>
<div class="informalexample">
<p>
<b>Maven.&nbsp;</b>

</p><pre class="programlisting"><span class="hl-tag">&lt;dependency&gt;</span>
    <span class="hl-tag">&lt;groupId&gt;</span>org.springframework.integration<span class="hl-tag">&lt;/groupId&gt;</span>
    <span class="hl-tag">&lt;artifactId&gt;</span>spring-integration-ws<span class="hl-tag">&lt;/artifactId&gt;</span>
    <span class="hl-tag">&lt;version&gt;</span>5.1.2.RELEASE<span class="hl-tag">&lt;/version&gt;</span>
<span class="hl-tag">&lt;/dependency&gt;</span></pre><p>

</p>
<p>
<b>Gradle.&nbsp;</b>

</p><pre class="programlisting">compile <span class="hl-string">"org.springframework.integration:spring-integration-ws:5.1.2.RELEASE"</span></pre><p>

</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="webservices-outbound" href="#webservices-outbound"></a>37.1&nbsp;Outbound Web Service Gateways</h2></div></div></div>

<p>To invoke a web service when you send a message to a channel, you have two options, both of which build upon the <a class="ulink" href="http://projects.spring.io/spring-ws/" target="_top">Spring Web Services</a> project: <code class="literal">SimpleWebServiceOutboundGateway</code> and <code class="literal">MarshallingWebServiceOutboundGateway</code>.
The former accepts either a <code class="literal">String</code> or <code class="literal">javax.xml.transform.Source</code> as the message payload.
The latter supports any implementation of the <code class="literal">Marshaller</code> and <code class="literal">Unmarshaller</code> interfaces.
Both require a Spring Web Services <code class="literal">DestinationProvider</code>, to determine the URI of the web service to be called.
The following example shows both options for invoking a web service:</p>
<div class="informalexample">
<pre class="programlisting"> simpleGateway = <span class="hl-keyword">new</span> SimpleWebServiceOutboundGateway(destinationProvider);

 marshallingGateway = <span class="hl-keyword">new</span> MarshallingWebServiceOutboundGateway(destinationProvider, marshaller);</pre>
</div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>When using the namespace support (<a class="link" href="#webservices-namespace" title="37.3&nbsp;Web Service Namespace Support">described later</a>), you need only set a URI.
Internally, the parser configures a fixed URI <code class="literal">DestinationProvider</code> implementation.
If you need dynamic resolution of the URI at runtime, however, then the <code class="literal">DestinationProvider</code> can provide such behavior as looking up the URI from a registry.
See the Spring Web Services <a class="ulink" href="http://docs.spring.io/spring-ws/docs/current/api/org/springframework/ws/client/support/destination/DestinationProvider.html" target="_top"><code class="literal">DestinationProvider</code></a> Javadoc for more information about this strategy.</p>
</td></tr></table></div>
<p>Starting with version 5.0, you can supply the <code class="literal">SimpleWebServiceOutboundGateway</code> and <code class="literal">MarshallingWebServiceOutboundGateway</code> with an external <code class="literal">WebServiceTemplate</code> instance, which you can configure for any custom properties, including <code class="literal">checkConnectionForFault</code> (which allows your application to deal with non-conforming services).</p>
<p>For more detail on the inner workings, see the Spring Web Services reference guide&#8217;s chapter covering <a class="ulink" href="http://docs.spring.io/spring-ws/docs/current/reference/html/client.html" target="_top">client access</a> and the chapter covering <a class="ulink" href="http://docs.spring.io/spring/docs/current/spring-framework-reference/html/oxm.html" target="_top">Object/XML mapping</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="webservices-inbound" href="#webservices-inbound"></a>37.2&nbsp;Inbound Web Service Gateways</h2></div></div></div>

<p>To send a message to a channel upon receiving a web service invocation, you again have two options: <code class="literal">SimpleWebServiceInboundGateway</code> and <code class="literal">MarshallingWebServiceInboundGateway</code>.
The former extracts a <code class="literal">javax.xml.transform.Source</code> from the <code class="literal">WebServiceMessage</code> and sets it as the message payload.
The latter supports implementation of the <code class="literal">Marshaller</code> and <code class="literal">Unmarshaller</code> interfaces.
If the incoming web service message is a SOAP message, the SOAP action header is added to the headers of the <code class="literal">Message</code> that is forwarded onto the request channel.
The following example shows both options:</p>
<div class="informalexample">
<pre class="programlisting"> simpleGateway = <span class="hl-keyword">new</span> SimpleWebServiceInboundGateway();
 simpleGateway.setRequestChannel(forwardOntoThisChannel);
 simpleGateway.setReplyChannel(listenForResponseHere); <span class="hl-comment">//Optional</span>

 marshallingGateway = <span class="hl-keyword">new</span> MarshallingWebServiceInboundGateway(marshaller);
 <span class="hl-comment">//set request and optionally reply channel</span></pre>
</div>
<p>Both gateways implement the Spring Web Services <code class="literal">MessageEndpoint</code> interface, so they can be configured with a <code class="literal">MessageDispatcherServlet</code> as per standard Spring Web Services configuration.</p>
<p>For more detail on how to use these components, see the Spring Web Services reference guide&#8217;s chapter covering <a class="ulink" href="http://docs.spring.io/spring-ws/docs/current/reference/html/server.html" target="_top">creating a web service</a>.
The chapter covering <a class="ulink" href="http://docs.spring.io/spring/docs/current/spring-framework-reference/html/oxm.html" target="_top">Object/XML mapping</a> is also applicable again.</p>
<p>To add the <code class="literal">SimpleWebServiceInboundGateway</code> and <code class="literal">MarshallingWebServiceInboundGateway</code> configurations to the Spring WS infrastructure, you should add the <code class="literal">EndpointMapping</code> definition between <code class="literal">MessageDispatcherServlet</code> and the target <code class="literal">MessageEndpoint</code> implementations, as you would for a normal Spring WS application.
For this purpose (from the Spring Integration perspective), Spring WS provides the following convenient <code class="literal">EndpointMapping</code> implementations:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">o.s.ws.server.endpoint.mapping.UriEndpointMapping</code>
</li><li class="listitem">
<code class="literal">o.s.ws.server.endpoint.mapping.PayloadRootQNameEndpointMapping</code>
</li><li class="listitem">
<code class="literal">o.s.ws.soap.server.endpoint.mapping.SoapActionEndpointMapping</code>
</li><li class="listitem">
<code class="literal">o.s.ws.server.endpoint.mapping.XPathPayloadEndpointMapping</code>
</li></ul></div>
<p>You must specify the beans for these classes in the application context and reference the <code class="literal">SimpleWebServiceInboundGateway</code> and/or <code class="literal">MarshallingWebServiceInboundGateway</code> bean definitions according to the WS mapping algorithm.</p>
<p>See the <a class="ulink" href="http://docs.spring.io/spring-ws/docs/current/reference/html/server.html#server-endpoint-mapping" target="_top">endpoint mappings</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="webservices-namespace" href="#webservices-namespace"></a>37.3&nbsp;Web Service Namespace Support</h2></div></div></div>

<p>To configure an outbound web service gateway, use the <code class="literal">outbound-gateway</code> element from the <code class="literal">ws</code> namespace, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-ws:outbound-gateway</span> <span class="hl-attribute">id</span>=<span class="hl-value">"simpleGateway"</span>
                     <span class="hl-attribute">request-channel</span>=<span class="hl-value">"inputChannel"</span>
                     <span class="hl-attribute">uri</span>=<span class="hl-value">"http://example.org"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>This example does not provide a <span class="emphasis"><em>reply-channel</em></span>.
If the web service returns a non-empty response, the <code class="literal">Message</code> containing that response is sent to the reply channel defined in the request message&#8217;s <code class="literal">REPLY_CHANNEL</code> header.
If that is not available, a channel resolution exception is thrown.
If you want to send the reply to another channel instead, provide a <span class="emphasis"><em>reply-channel</em></span> attribute on the <span class="emphasis"><em>outbound-gateway</em></span> element.</p>
</td></tr></table></div>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>By default, when you invoke a web service that returns an empty response after using a String payload for the request <code class="literal">Message</code>, no reply <code class="literal">Message</code> is sent.
Therefore, you need not set a <span class="emphasis"><em>reply-channel</em></span> or have a <code class="literal">REPLY_CHANNEL</code> header in the request <code class="literal">Message</code>.
If you actually do want to receive the empty response as a <code class="literal">Message</code>, you can set the <span class="emphasis"><em>ignore-empty-responses</em></span> attribute to <code class="literal">false</code>.
Doing so works only for <code class="literal">String</code> objects, because using a <code class="literal">Source</code> or a <code class="literal">Document</code> object leads to a null response and consequently never generates a reply <code class="literal">Message</code>.</p>
</td></tr></table></div>
<p>To set up an inbound Web Service Gateway, use the <code class="literal">inbound-gateway</code> element, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-ws:inbound-gateway</span> <span class="hl-attribute">id</span>=<span class="hl-value">"simpleGateway"</span>
                    <span class="hl-attribute">request-channel</span>=<span class="hl-value">"inputChannel"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>To use Spring OXM marshallers or unmarshallers, you must provide bean references.
The following example shows how to provide a bean reference for an outbound marshalling gateway:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-ws:outbound-gateway</span> <span class="hl-attribute">id</span>=<span class="hl-value">"marshallingGateway"</span>
                     <span class="hl-attribute">request-channel</span>=<span class="hl-value">"requestChannel"</span>
                     <span class="hl-attribute">uri</span>=<span class="hl-value">"http://example.org"</span>
                     <span class="hl-attribute">marshaller</span>=<span class="hl-value">"someMarshaller"</span>
                     <span class="hl-attribute">unmarshaller</span>=<span class="hl-value">"someUnmarshaller"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>The following example shows how to provide a bean reference for an inbound marshalling gateway:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-ws:inbound-gateway</span> <span class="hl-attribute">id</span>=<span class="hl-value">"marshallingGateway"</span>
                    <span class="hl-attribute">request-channel</span>=<span class="hl-value">"requestChannel"</span>
                    <span class="hl-attribute">marshaller</span>=<span class="hl-value">"someMarshaller"</span>
                    <span class="hl-attribute">unmarshaller</span>=<span class="hl-value">"someUnmarshaller"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Most <code class="literal">Marshaller</code> implementations also implement the <code class="literal">Unmarshaller</code> interface.
When using such a <code class="literal">Marshaller</code>, only the <code class="literal">marshaller</code> attribute is necessary.
Even when using a <code class="literal">Marshaller</code>, you may also provide a reference for the <code class="literal">request-callback</code> on the outbound gateways.</p>
</td></tr></table></div>
<p>For either outbound gateway type, you can specify a <code class="literal">destination-provider</code> attribute instead of the <code class="literal">uri</code> (exactly one of them is required).
You can then reference any Spring Web Services <code class="literal">DestinationProvider</code> implementation (for example, to lookup the URI from a registry at runtime).</p>
<p>For either outbound gateway type, the <code class="literal">message-factory</code> attribute can also be configured with a reference to any Spring Web Services <code class="literal">WebServiceMessageFactory</code> implementation.</p>
<p>For the simple inbound gateway type, you can set the <code class="literal">extract-payload</code> attribute to <code class="literal">false</code> to forward the entire <code class="literal">WebServiceMessage</code> instead of just its payload as a <code class="literal">Message</code> to the request channel.
Doing so might be useful, for example, when a custom transformer works against the <code class="literal">WebServiceMessage</code> directly.</p>
<p>Starting with version 5.0, the <code class="literal">web-service-template</code> reference attribute lets you inject a <code class="literal">WebServiceTemplate</code> with any possible custom properties.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="outbound-uri" href="#outbound-uri"></a>37.4&nbsp;Outbound URI Configuration</h2></div></div></div>

<p>For all URI schemes supported by Spring Web Services (see <a class="ulink" href="http://docs.spring.io/spring-ws/docs/current/reference/html/client.html#client-transports" target="_top">URIs and Transports</a>) <code class="literal">&lt;uri-variable/&gt;</code> substitution is provided.
The following example shows how to define it:</p>
<pre class="programlisting"><span class="hl-tag">&lt;ws:outbound-gateway</span> <span class="hl-attribute">id</span>=<span class="hl-value">"gateway"</span> <span class="hl-attribute">request-channel</span>=<span class="hl-value">"input"</span>
        <span class="hl-attribute">uri</span>=<span class="hl-value">"http://springsource.org/{thing1}-{thing2}"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;ws:uri-variable</span> <span class="hl-attribute">name</span>=<span class="hl-value">"thing1"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"payload.substring(1,7)"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;ws:uri-variable</span> <span class="hl-attribute">name</span>=<span class="hl-value">"thing2"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"headers.x"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/ws:outbound-gateway&gt;</span>

<span class="hl-tag">&lt;ws:outbound-gateway</span> <span class="hl-attribute">request-channel</span>=<span class="hl-value">"inputJms"</span>
        <span class="hl-attribute">uri</span>=<span class="hl-value">"jms:{destination}?deliveryMode={deliveryMode}&amp;amp;priority={priority}"</span>
        <span class="hl-attribute">message-sender</span>=<span class="hl-value">"jmsMessageSender"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;ws:uri-variable</span> <span class="hl-attribute">name</span>=<span class="hl-value">"destination"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"headers.jmsQueue"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;ws:uri-variable</span> <span class="hl-attribute">name</span>=<span class="hl-value">"deliveryMode"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"headers.deliveryMode"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;ws:uri-variable</span> <span class="hl-attribute">name</span>=<span class="hl-value">"priority"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"headers.jms_priority"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/ws:outbound-gateway&gt;</span></pre>
<p>If you supply a <code class="literal">DestinationProvider</code>, variable substitution is not supported and a configuration error occurs if you provide variables.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_controlling_uri_encoding_2" href="#_controlling_uri_encoding_2"></a>37.4.1&nbsp;Controlling URI Encoding</h3></div></div></div>

<p>By default, the URL string is encoded (see <a class="ulink" href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/web/util/UriComponentsBuilder.html" target="_top"><code class="literal">UriComponentsBuilder</code></a>) to the URI object before sending the request.
In some scenarios with a non-standard URI, it is undesirable to perform the encoding.
Since version 4.1, the <code class="literal">&lt;ws:outbound-gateway/&gt;</code> element provides an <code class="literal">encode-uri</code> attribute.
To disable encoding the URL, set this attribute <code class="literal">false</code> (it defaults to <code class="literal">true</code>).
If you wish to partially encode some of the URL, you can do so by using an <code class="literal">expression</code> within a <code class="literal">&lt;uri-variable/&gt;</code>, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;ws:outbound-gateway</span> <span class="hl-attribute">url</span>=<span class="hl-value">"http://somehost/%2f/fooApps?bar={param}"</span> <span class="hl-attribute">encode-uri</span>=<span class="hl-value">"false"</span><span class="hl-tag">&gt;</span>
          <span class="hl-tag">&lt;http:uri-variable</span> <span class="hl-attribute">name</span>=<span class="hl-value">"param"</span>
            <span class="hl-attribute">expression</span>=<span class="hl-value">"T(org.apache.commons.httpclient.util.URIUtil)
                                             .encodeWithinQuery('Hello World!')"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/ws:outbound-gateway&gt;</span></pre>
</div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>If you set <code class="literal">DestinationProvider</code>, <code class="literal">encode-uri</code> is ignored.</p>
</td></tr></table></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="ws-message-headers" href="#ws-message-headers"></a>37.5&nbsp;WS Message Headers</h2></div></div></div>

<p>The Spring Integration web service gateways automatically map the SOAP action header.
By default, it is copied to and from Spring Integration <code class="literal">MessageHeaders</code> by using the <a class="ulink" href="http://docs.spring.io/spring-integration/api/org/springframework/integration/ws/DefaultSoapHeaderMapper.html" target="_top"><code class="literal">DefaultSoapHeaderMapper</code></a>.</p>
<p>You can pass in your own implementation of SOAP-specific header mappers, as the gateways have properties to support doing so.</p>
<p>Unless explicitly specified by the <code class="literal">requestHeaderNames</code> or <code class="literal">replyHeaderNames</code> properties of the <code class="literal">DefaultSoapHeaderMapper</code>, any user-defined SOAP headers are not copied to or from a SOAP Message.</p>
<p>When you use the XML namespace for configuration, you can set these properties by using the <code class="literal">mapped-request-headers</code> and <code class="literal">mapped-reply-headers</code> attributes, you can provide a custom mapper by setting the <code class="literal">header-mapper</code> attribute.</p>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>When mapping user-defined headers, the values can also contain simple wildcard patterns (such <code class="literal">myheader*</code> or <code class="literal">*myheader</code>).
For example, if you need to copy all user-defined headers, you can use the wildcard character: <code class="literal">*</code>.</p>
</td></tr></table></div>
<p>Starting with version 4.1, the <code class="literal">AbstractHeaderMapper</code> (a <code class="literal">DefaultSoapHeaderMapper</code> superclass) lets the <code class="literal">NON_STANDARD_HEADERS</code> token be configured for the <code class="literal">requestHeaderNames</code> and <code class="literal">replyHeaderNames</code> properties (in addition to existing <code class="literal">STANDARD_REQUEST_HEADERS</code> and <code class="literal">STANDARD_REPLY_HEADERS</code>) to map all user-defined headers.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Rather than using the wildcard (<code class="literal">*</code>), we recommend using the following combination : <code class="literal">STANDARD_REPLY_HEADERS, NON_STANDARD_HEADERS</code>.
Doing so avoids mapping <code class="literal">request</code> headers to the reply.</p>
</td></tr></table></div>
<p>Starting with version 4.3, you can negate patterns in the header mappings by preceding the pattern with <code class="literal">!</code>.
Negated patterns get priority, so a list such as <code class="literal">STANDARD_REQUEST_HEADERS,thing1,thing*,!thing2,!thing3,qux,!thing1</code> does not map <code class="literal">thing1</code>, <code class="literal">thing2</code>, or <code class="literal">thing3</code>. It does map the standard headers, <code class="literal">thing4</code>, and <code class="literal">qux</code>.
(Note that <code class="literal">thing1</code> is included in both non-negated and negated forms. Because negated values take precedence, <code class="literal">thing1</code> is not mapped.)</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>If you have a user-defined header that begins with <code class="literal">!</code> that you do wish to map, you can escape it with <code class="literal">\</code>, as follows: <code class="literal">STANDARD_REQUEST_HEADERS,\!myBangHeader</code>. <code class="literal">!myBangHeader</code> is then mapped.</p>
</td></tr></table></div>
<p>Inbound SOAP headers (request headers for the inbound gateway and reply headers for the outbound gateway) are mapped as <code class="literal">SoapHeaderElement</code> objects.
You can explore the contents by accessing the <code class="literal">Source</code>:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;soapenv:Envelope</span> <span class="hl-attribute">xmlns:soapenv</span>=<span class="hl-value">"http://schemas.xmlsoap.org/soap/envelope/"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;soapenv:Header&gt;</span>
        <span class="hl-tag">&lt;auth&gt;</span>
            <span class="hl-tag">&lt;username&gt;</span>user<span class="hl-tag">&lt;/username&gt;</span>
            <span class="hl-tag">&lt;password&gt;</span>pass<span class="hl-tag">&lt;/password&gt;</span>
        <span class="hl-tag">&lt;/auth&gt;</span>
        <span class="hl-tag">&lt;bar&gt;</span>BAR<span class="hl-tag">&lt;/bar&gt;</span>
        <span class="hl-tag">&lt;baz&gt;</span>BAZ<span class="hl-tag">&lt;/baz&gt;</span>
        <span class="hl-tag">&lt;qux&gt;</span>qux<span class="hl-tag">&lt;/qux&gt;</span>
    <span class="hl-tag">&lt;/soapenv:Header&gt;</span>
    <span class="hl-tag">&lt;soapenv:Body&gt;</span>
        ...
    <span class="hl-tag">&lt;/soapenv:Body&gt;</span>
<span class="hl-tag">&lt;/soapenv:Envelope&gt;</span></pre>
</div>
<p>If <code class="literal">mapped-request-headers</code> is <code class="literal">auth, ca*</code>, the <code class="literal">auth</code>, <code class="literal">cat</code>, and <code class="literal">can</code> headers are mapped, but <code class="literal">qux</code> is not mapped.</p>
<p>The following example shows how to get a value named <code class="literal">user</code> from a header named <code class="literal">auth</code>:</p>
<div class="informalexample">
<pre class="programlisting">...
SoapHeaderElement header = (SoapHeaderElement) headers.get(<span class="hl-string">"auth"</span>);
DOMSource source = (DOMSource) header.getSource();
NodeList nodeList = source.getNode().getChildNodes();
assertEquals(<span class="hl-string">"username"</span>, nodeList.item(<span class="hl-number">0</span>).getNodeName());
assertEquals(<span class="hl-string">"user"</span>, nodeList.item(<span class="hl-number">0</span>).getFirstChild().getNodeValue());
...</pre>
</div>
<p>Starting with version 5.0, the <code class="literal">DefaultSoapHeaderMapper</code> supports user-defined headers of type <code class="literal">javax.xml.transform.Source</code> and populates them as child nodes of the <code class="literal">&lt;soapenv:Header&gt;</code>.
The following example shows how to do so:</p>
<div class="informalexample">
<pre class="programlisting">Map&lt;String, Object&gt; headers = <span class="hl-keyword">new</span> HashMap&lt;&gt;();

String authXml =
     <span class="hl-string">"&lt;auth xmlns='http://test.auth.org'&gt;"</span>
           + <span class="hl-string">"&lt;username&gt;user&lt;/username&gt;"</span>
           + <span class="hl-string">"&lt;password&gt;pass&lt;/password&gt;"</span>
           + <span class="hl-string">"&lt;/auth&gt;"</span>;
headers.put(<span class="hl-string">"auth"</span>, <span class="hl-keyword">new</span> StringSource(authXml));
...
DefaultSoapHeaderMapper mapper = <span class="hl-keyword">new</span> DefaultSoapHeaderMapper();
mapper.setRequestHeaderNames(<span class="hl-string">"auth"</span>);</pre>
</div>
<p>The result of the preceding examples is the following SOAP envelope:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;soapenv:Envelope</span> <span class="hl-attribute">xmlns:soapenv</span>=<span class="hl-value">"http://schemas.xmlsoap.org/soap/envelope/"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;soapenv:Header&gt;</span>
        <span class="hl-tag">&lt;auth</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://test.auth.org"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;username&gt;</span>user<span class="hl-tag">&lt;/username&gt;</span>
            <span class="hl-tag">&lt;password&gt;</span>pass<span class="hl-tag">&lt;/password&gt;</span>
        <span class="hl-tag">&lt;/auth&gt;</span>
    <span class="hl-tag">&lt;/soapenv:Header&gt;</span>
    <span class="hl-tag">&lt;soapenv:Body&gt;</span>
        ...
    <span class="hl-tag">&lt;/soapenv:Body&gt;</span>
<span class="hl-tag">&lt;/soapenv:Envelope&gt;</span></pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="mtom-support" href="#mtom-support"></a>37.6&nbsp;MTOM Support</h2></div></div></div>

<p>The marshalling inbound and outbound web service gateways support attachments directly through built-in functionality of the marshaller (for example, <code class="literal">Jaxb2Marshaller</code> provides the <code class="literal">mtomEnabled</code> option).
Starting with version 5.0, the simple web service gateways can directly operate with inbound and outbound <code class="literal">MimeMessage</code> instances, which have an API to manipulate attachments.
When you need to send web service message with attachments (either a reply from a server or a client request) you should use the <code class="literal">WebServiceMessageFactory</code> directly and send a <code class="literal">WebServiceMessage</code> with attachments as a <code class="literal">payload</code> to the request or reply channel of the gateway.
The following example shows how to do so:</p>
<div class="informalexample">
<pre class="programlisting">WebServiceMessageFactory messageFactory = <span class="hl-keyword">new</span> SaajSoapMessageFactory(MessageFactory.newInstance());
MimeMessage webServiceMessage = (MimeMessage) messageFactory.createWebServiceMessage();

String request = <span class="hl-string">"&lt;test&gt;foo&lt;/test&gt;"</span>;

TransformerFactory transformerFactory = TransformerFactory.newInstance();
Transformer transformer = transformerFactory.newTransformer();
transformer.transform(<span class="hl-keyword">new</span> StringSource(request), webServiceMessage.getPayloadResult());

webServiceMessage.addAttachment(<span class="hl-string">"myAttachment"</span>, <span class="hl-keyword">new</span> ByteArrayResource(<span class="hl-string">"my_data"</span>.getBytes()), <span class="hl-string">"plain/text"</span>);

<span class="hl-keyword">this</span>.webServiceChannel.send(<span class="hl-keyword">new</span> GenericMessage&lt;&gt;(webServiceMessage));</pre>
</div>
</div>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="xml" href="#xml"></a>38.&nbsp;XML Support - Dealing with XML Payloads</h2></div></div></div>

<p>Spring Integration&#8217;s XML support extends the core of Spring Integration with the following components:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="#xml-transformation" title="38.2&nbsp;Transforming XML Payloads">Marshalling Transformer</a>
</li><li class="listitem">
<a class="link" href="#xml-transformation" title="38.2&nbsp;Transforming XML Payloads">Unmarshalling Transformer</a>
</li><li class="listitem">
<a class="link" href="#xml-transformation" title="38.2&nbsp;Transforming XML Payloads">XSLT Transformer</a>
</li><li class="listitem">
<a class="link" href="#xml-xpath-transformer" title="38.3&nbsp;Transforming XML Messages with XPath">XPath Transformer</a>
</li><li class="listitem">
<a class="link" href="#xml-xpath-splitting" title="38.4&nbsp;Splitting XML Messages">XPath Splitter</a>
</li><li class="listitem">
<a class="link" href="#xml-xpath-routing" title="38.5&nbsp;Routing XML Messages with XPath">XPath Router</a>
</li><li class="listitem">
<a class="link" href="#xml-xpath-header-enricher" title="38.6&nbsp;XPath Header Enricher">XPath Header Enricher</a>
</li><li class="listitem">
<a class="link" href="#xml-xpath-filter" title="38.7&nbsp;Using the XPath Filter">XPath Filter</a>
</li><li class="listitem">
<a class="link" href="#xpath-spel-function" title="38.8&nbsp;#xpath SpEL Function">#xpath SpEL Function</a>
</li><li class="listitem">
<a class="link" href="#xml-validating-filter" title="38.9&nbsp;XML Validating Filter">Validating Filter</a>
</li></ul></div>
<p>You need to include this dependency into your project:</p>
<div class="informalexample">
<p>
<b>Maven.&nbsp;</b>

</p><pre class="programlisting"><span class="hl-tag">&lt;dependency&gt;</span>
    <span class="hl-tag">&lt;groupId&gt;</span>org.springframework.integration<span class="hl-tag">&lt;/groupId&gt;</span>
    <span class="hl-tag">&lt;artifactId&gt;</span>spring-integration-xml<span class="hl-tag">&lt;/artifactId&gt;</span>
    <span class="hl-tag">&lt;version&gt;</span>5.1.2.RELEASE<span class="hl-tag">&lt;/version&gt;</span>
<span class="hl-tag">&lt;/dependency&gt;</span></pre><p>

</p>
<p>
<b>Gradle.&nbsp;</b>

</p><pre class="programlisting">compile <span class="hl-string">"org.springframework.integration:spring-integration-xml:5.1.2.RELEASE"</span></pre><p>

</p>
</div>
<p>These components make working with XML messages in Spring Integration simpler.
The messaging components work with XML that is represented in a range of formats, including instances of <code class="literal">java.lang.String</code>, <code class="literal">org.w3c.dom.Document</code>, and <code class="literal">javax.xml.transform.Source</code>.
However, where a DOM representation is required (for example, in order to evaluate an XPath expression), the <code class="literal">String</code> payload is converted into the required type and then converted back to <code class="literal">String</code>.
Components that require an instance of <code class="literal">DocumentBuilder</code> create a namespace-aware instance if you do not provide one.
When you require greater control over document creation, you can provide an appropriately configured instance of <code class="literal">DocumentBuilder</code>.</p>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xpath-namespace-support" href="#xpath-namespace-support"></a>38.1&nbsp;Namespace Support</h2></div></div></div>

<p>All components within the Spring Integration XML module provide namespace support.
In order to enable namespace support, you need to import the schema for the Spring Integration XML Module.
The following example shows a typical setup:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
  <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
  <span class="hl-attribute">xmlns:int</span>=<span class="hl-value">"http://www.springframework.org/schema/integration"</span>
  <span class="hl-attribute">xmlns:int-xml</span>=<span class="hl-value">"http://www.springframework.org/schema/integration/xml"</span>
  <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"http://www.springframework.org/schema/beans
    http://www.springframework.org/schema/beans/spring-beans.xsd
    http://www.springframework.org/schema/integration
    http://www.springframework.org/schema/integration/spring-integration.xsd
    http://www.springframework.org/schema/integration/xml
    http://www.springframework.org/schema/integration/xml/spring-integration-xml.xsd"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;/beans&gt;</span></pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="xml-xpath-expressions" href="#xml-xpath-expressions"></a>38.1.1&nbsp;XPath Expressions</h3></div></div></div>

<p>Many of the components within the Spring Integration XML module work with XPath Expressions.
Each of those components either references an XPath Expression that has been defined as a top-level element or uses a nested <code class="literal">&lt;xpath-expression/&gt;</code> element.</p>
<p>All forms of XPath expressions result in the creation of an <code class="literal">XPathExpression</code> that uses the Spring <code class="literal">org.springframework.xml.xpath.XPathExpressionFactory</code>.
When XPath expressions are created, the best XPath implementation that is available on the classpath is used (either JAXP 1.3+ or Jaxen, with JAXP being preferred).</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Internally, Spring Integration uses the XPath functionality provided by the Spring Web Services project (<a class="ulink" href="http://www.spring.io/spring-ws" target="_top">http://www.spring.io/spring-ws</a>).
Specifically, we use the Spring Web Services XML module (spring-xml-x.x.x.jar).
For a deeper understanding, see the respective documentation at <a class="ulink" href="http://docs.spring.io/spring-ws/docs/current/reference/html/common.html#xpath" target="_top">http://docs.spring.io/spring-ws/docs/current/reference/html/common.html#xpath</a>.</p>
</td></tr></table></div>
<p>Here is an overview of all available configuration parameters of the <code class="literal">xpath-expression</code> element:
The following listing shows the available attributes for the <code class="literal">xpath-expression</code> element:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-xml:xpath-expression</span> <span class="hl-attribute">expression</span>=<span class="hl-value">""</span> <a name="CO55-1" href="#CO55-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
          id=""                         <a name="CO55-2" href="#CO55-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
          namespace-map=""              <a name="CO55-3" href="#CO55-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
          ns-prefix=""                  <a name="CO55-4" href="#CO55-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
          ns-uri=""&gt;                    <a name="CO55-5" href="#CO55-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
    <span class="hl-tag">&lt;map&gt;</span><span class="hl-tag">&lt;/map&gt;</span>                         <a name="CO55-6" href="#CO55-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>
<span class="hl-tag">&lt;/int-xml:xpath-expression&gt;</span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO55-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Defines an XPath expression.
Required.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO55-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The identifier of the underlying bean definition.
It is an instance of <code class="literal">org.springframework.xml.xpath.XPathExpression</code>.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO55-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Reference to a map that contains namespaces.
The key of the map defines the namespace prefix, and the value of the map sets the namespace URI.
It is not valid to specify both this attribute and the <code class="literal">map</code> element or the <code class="literal">ns-prefix</code> and <code class="literal">ns-uri</code> attributes.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO55-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Lets you set the namespace prefix directly as an attribute on the XPath expression element.
If you set <code class="literal">ns-prefix</code>, you must also set the <code class="literal">ns-uri</code> attribute.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO55-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Lets you directly set the namespace URI as an attribute on the XPath expression element.
If you set <code class="literal">ns-uri</code>, you must also set the <code class="literal">ns-prefix</code> attribute.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO55-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Defines a map that contains namespaces.
Only one <code class="literal">map</code> child element is allowed.
The key of the map defines the namespace prefix, and the value of the map sets the namespace URI.
It is not valid to specify both this element and the <code class="literal">map</code> attribute or set the <code class="literal">ns-prefix</code> and <code class="literal">ns-uri</code> attributes.
Optional.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_providing_namespaces_optional_to_xpath_expressions" href="#_providing_namespaces_optional_to_xpath_expressions"></a>Providing Namespaces (Optional) to XPath Expressions</h4></div></div></div>

<p>For the XPath Expression Element, you can provide namespace information as configuration parameters.
You can define namespaces by using one of the following choices:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Reference a map by using the <code class="literal">namespace-map</code> attribute
</li><li class="listitem">
Provide a map of namespaces by using the <code class="literal">map</code> sub-element
</li><li class="listitem">
Specify the <code class="literal">ns-prefix</code> and <code class="literal">ns-uri</code> attributes
</li></ul></div>
<p>All three options are mutually exclusive.
Only one option can be set.</p>
<p>The following example shows several different ways to use XPath expressions, including the options for setting the XML namespaces <a class="link" href="#xpath-namespace-support" title="38.1&nbsp;Namespace Support">mentioned earlier</a>:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-xml:xpath-filter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"filterReferencingXPathExpression"</span>
                      <span class="hl-attribute">xpath-expression-ref</span>=<span class="hl-value">"refToXpathExpression"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int-xml:xpath-expression</span> <span class="hl-attribute">id</span>=<span class="hl-value">"refToXpathExpression"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"/name"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int-xml:xpath-filter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"filterWithoutNamespace"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int-xml:xpath-expression</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"/name"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-xml:xpath-filter&gt;</span>

<span class="hl-tag">&lt;int-xml:xpath-filter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"filterWithOneNamespace"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int-xml:xpath-expression</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"/ns1:name"</span>
                              <span class="hl-attribute">ns-prefix</span>=<span class="hl-value">"ns1"</span> <span class="hl-attribute">ns-uri</span>=<span class="hl-value">"www.example.org"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-xml:xpath-filter&gt;</span>

<span class="hl-tag">&lt;int-xml:xpath-filter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"filterWithTwoNamespaces"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int-xml:xpath-expression</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"/ns1:name/ns2:type"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;map&gt;</span>
            <span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"ns1"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"www.example.org/one"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"ns2"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"www.example.org/two"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/map&gt;</span>
    <span class="hl-tag">&lt;/int-xml:xpath-expression&gt;</span>
<span class="hl-tag">&lt;/int-xml:xpath-filter&gt;</span>

<span class="hl-tag">&lt;int-xml:xpath-filter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"filterWithNamespaceMapReference"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int-xml:xpath-expression</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"/ns1:name/ns2:type"</span>
                              <span class="hl-attribute">namespace-map</span>=<span class="hl-value">"defaultNamespaces"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-xml:xpath-filter&gt;</span>

<span class="hl-tag">&lt;util:map</span> <span class="hl-attribute">id</span>=<span class="hl-value">"defaultNamespaces"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;util:entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"ns1"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"www.example.org/one"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;util:entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"ns2"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"www.example.org/two"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/util:map&gt;</span></pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_using_xpath_expressions_with_default_namespaces" href="#_using_xpath_expressions_with_default_namespaces"></a>Using XPath Expressions with Default Namespaces</h4></div></div></div>

<p>When working with default namespaces, you may run into situations that behave differently than you might expect.
Assume we have the following XML document (which represents an order of two books):</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;order&gt;</span>
    <span class="hl-tag">&lt;orderItem&gt;</span>
        <span class="hl-tag">&lt;isbn&gt;</span>0321200683<span class="hl-tag">&lt;/isbn&gt;</span>
        <span class="hl-tag">&lt;quantity&gt;</span>2<span class="hl-tag">&lt;/quantity&gt;</span>
    <span class="hl-tag">&lt;/orderItem&gt;</span>
    <span class="hl-tag">&lt;orderItem&gt;</span>
        <span class="hl-tag">&lt;isbn&gt;</span>1590596439<span class="hl-tag">&lt;/isbn&gt;</span>
        <span class="hl-tag">&lt;quantity&gt;</span>1<span class="hl-tag">&lt;/quantity&gt;</span>
    <span class="hl-tag">&lt;/orderItem&gt;</span>
<span class="hl-tag">&lt;/order&gt;</span></pre>
</div>
<p>This document does not declare a namespace.
Therefore, applying the following XPath Expression works as expected:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-xml:xpath-expression</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"/order/orderItem"</span><span class="hl-tag"> /&gt;</span></pre>
</div>
<p>You might expect that the same expression also works for the following XML file:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;order</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.example.org/orders"</span><span class="hl-tag">&gt;</span>
	<span class="hl-tag">&lt;orderItem&gt;</span>
		<span class="hl-tag">&lt;isbn&gt;</span>0321200683<span class="hl-tag">&lt;/isbn&gt;</span>
		<span class="hl-tag">&lt;quantity&gt;</span>2<span class="hl-tag">&lt;/quantity&gt;</span>
	<span class="hl-tag">&lt;/orderItem&gt;</span>
	<span class="hl-tag">&lt;orderItem&gt;</span>
		<span class="hl-tag">&lt;isbn&gt;</span>1590596439<span class="hl-tag">&lt;/isbn&gt;</span>
		<span class="hl-tag">&lt;quantity&gt;</span>1<span class="hl-tag">&lt;/quantity&gt;</span>
	<span class="hl-tag">&lt;/orderItem&gt;</span>
<span class="hl-tag">&lt;/order&gt;</span></pre>
</div>
<p>The preceding example looks exactly the same as the previous example but declares a default namespace.</p>
<p>However, the previous XPath expression (<code class="literal">/order/orderItem</code>) fails in this case.</p>
<p>In order to solve this issue, you must provide a namespace prefix and a namespace URI either by setting the <code class="literal">ns-prefix</code> and <code class="literal">ns-uri</code> attributes or by setting the <code class="literal">namespace-map</code> attribute.
The namespace URI must match the namespace declared in your XML document.
In the preceding example, that is <code class="literal">http://www.example.org/orders</code>.</p>
<p>You can, however, arbitrarily choose the namespace prefix.
In fact, providing an empty string actually works.
(However, null is not allowed.)
In the case of a namespace prefix consisting of an empty string, your Xpath expression must use a colon (":") to indicate the default namespace.
If you leave off the colon, the XPath expression does not match.
The following XPath Expression matches against the XML document in the preceding example:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-xml:xpath-expression</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"/:order/:orderItem"</span>
    <span class="hl-attribute">ns-prefix</span>=<span class="hl-value">""</span> <span class="hl-attribute">ns-uri</span>=<span class="hl-value">"http://www.example.org/prodcuts"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>You can also provide any other arbitrarily chosen namespace prefix.
The following XPath expression (which use the <code class="literal">myorder</code> namespace prefix) also matches:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-xml:xpath-expression</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"/myorder:order/myorder:orderItem"</span>
    <span class="hl-attribute">ns-prefix</span>=<span class="hl-value">"myorder"</span> <span class="hl-attribute">ns-uri</span>=<span class="hl-value">"http://www.example.org/prodcuts"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>The namespace URI is the really important piece of information, not the prefix.
The <a class="ulink" href="http://jaxen.codehaus.org/faq.html" target="_top">Jaxen FAQ</a> summarizes the point very well:</p>
<div class="blockquote"><blockquote class="blockquote">
<p>In XPath 1.0, all unprefixed names are unqualified.
There is no requirement that the prefixes used in the XPath expression are the same as the prefixes used in the document being queried.
Only the namespace URIs need to match, not the prefixes.</p>
</blockquote></div>
</div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xml-transformation" href="#xml-transformation"></a>38.2&nbsp;Transforming XML Payloads</h2></div></div></div>

<p>This section covers how to transform XML payloads</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="xml-transformation-beans" href="#xml-transformation-beans"></a>38.2.1&nbsp;Configuring Transformers as Beans</h3></div></div></div>

<p>This section will explain the workings of the following transformers and how to configure them as beans:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="ulink" href="#xml-unmarshalling-transformer" target="_top">UnmarshallingTransformer</a>
</li><li class="listitem">
<a class="ulink" href="#xml-marshalling-transformer" target="_top">MarshallingTransformer</a>
</li><li class="listitem">
<a class="ulink" href="#xml-xslt-payload-transformers" target="_top">XsltPayloadTransformer</a>
</li></ul></div>
<p>All of the XML transformers extend either <a class="ulink" href="http://docs.spring.io/spring-integration/api/org/springframework/integration/transformer/AbstractTransformer.html" target="_top"><code class="literal">AbstractTransformer</code></a> or  <a class="ulink" href="http://docs.spring.io/spring-integration/api/org/springframework/integration/transformer/AbstractPayloadTransformer.html" target="_top"><code class="literal">AbstractPayloadTransformer</code></a> and therefore implement  <a class="ulink" href="http://docs.spring.io/spring-integration/api/org/springframework/integration/transformer/Transformer.html" target="_top"><code class="literal">Transformer</code></a>.
When configuring XML transformers as beans in Spring Integration, you would normally configure the <code class="literal">Transformer</code> in conjunction with a  <a class="ulink" href="http://docs.spring.io/spring-integration/api/org/springframework/integration/transformer/MessageTransformingHandler.html" target="_top"><code class="literal">MessageTransformingHandler</code></a>.
This lets the transformer be used as an endpoint.
Finally, we discuss the namespace support , which allows for configuring the transformers as elements in XML.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="xml-unmarshalling-transformer" href="#xml-unmarshalling-transformer"></a>UnmarshallingTransformer</h4></div></div></div>

<p>An <a class="ulink" href="http://docs.spring.io/spring-integration/api/org/springframework/integration/xml/transformer/UnmarshallingTransformer.html" target="_top"><code class="literal">UnmarshallingTransformer</code></a> lets an XML <code class="literal">Source</code> be unmarshalled by using implementations of the <a class="ulink" href="http://docs.spring.io/spring/docs/current/spring-framework-reference/html/oxm.html" target="_top">Spring OXM</a> <code class="literal">Unmarshaller</code>.
Spring&#8217;s Object/XML Mapping support provides several implementations that support marshalling and unmarshalling by using <a class="ulink" href="http://en.wikipedia.org/wiki/Java_Architecture_for_XML_Binding" target="_top">JAXB</a>, <a class="ulink" href="http://www.castor.org/" target="_top">Castor</a>, <a class="ulink" href="http://jibx.sourceforge.net/" target="_top">JiBX</a>, and others.
The unmarshaller requires an instance of <code class="literal">Source</code>.
If the message payload is not an instance of <code class="literal">Source</code>, conversion is still attempted.
Currently, <code class="literal">String</code>, <code class="literal">File</code>, <code class="literal">byte[]</code> and <code class="literal">org.w3c.dom.Document</code> payloads are supported.
To create a custom conversion to a <code class="literal">Source</code>, you can inject an implementation of a <a class="ulink" href="http://docs.spring.io/spring-integration/api/org/springframework/integration/xml/source/SourceFactory.html" target="_top"><code class="literal">SourceFactory</code></a>.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>If you do not explicitly set a <code class="literal">SourceFactory</code>, the property on the <code class="literal">UnmarshallingTransformer</code> is, by default, set to a <a class="ulink" href="http://docs.spring.io/spring-integration/api/org/springframework/integration/xml/source/DomSourceFactory.html" target="_top"><code class="literal">DomSourceFactory</code></a>.</p>
</td></tr></table></div>
<p>Starting with version 5.0, the <code class="literal">UnmarshallingTransformer</code> also supports an <code class="literal">org.springframework.ws.mime.MimeMessage</code> as the incoming payload.
This can be useful when we receive a raw <code class="literal">WebServiceMessage</code> with MTOM attachments over SOAP .
See <a class="xref" href="#mtom-support" title="37.6&nbsp;MTOM Support">Section&nbsp;37.6, &#8220;MTOM Support&#8221;</a> for more information.</p>
<p>The following example shows how to define an unmarshalling transformer:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"unmarshallingTransformer"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.xml.transformer.UnmarshallingTransformer"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.oxm.jaxb.Jaxb2Marshaller"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"contextPath"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"org.example"</span><span class="hl-tag"> /&gt;</span>
        <span class="hl-tag">&lt;/bean&gt;</span>
    <span class="hl-tag">&lt;/constructor-arg&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="xml-marshalling-transformer" href="#xml-marshalling-transformer"></a>Using <code class="literal">MarshallingTransformer</code></h4></div></div></div>

<p>The <a class="ulink" href="http://docs.spring.io/spring-integration/api/org/springframework/integration/xml/transformer/MarshallingTransformer.html" target="_top"><code class="literal">MarshallingTransformer</code></a> lets an object graph be converted into XML by using a Spring OXM <code class="literal">Marshaller</code>.
By default, the <code class="literal">MarshallingTransformer</code> returns a <code class="literal">DomResult</code>.
However, you can control the type of result by configuring an alternative <code class="literal">ResultFactory</code>, such as <code class="literal">StringResultFactory</code>.
In many cases, it is more convenient to transform the payload into an alternative XML format.
To do so, configure a <code class="literal">ResultTransformer</code>.
Spring integration provides two implementations, one that converts to <code class="literal">String</code> and another that converts to <code class="literal">Document</code>.
The following example configures a marshalling transformer that transforms to a document:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"marshallingTransformer"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.xml.transformer.MarshallingTransformer"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.oxm.jaxb.Jaxb2Marshaller"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"contextPath"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"org.example"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/bean&gt;</span>
    <span class="hl-tag">&lt;/constructor-arg&gt;</span>
    <span class="hl-tag">&lt;constructor-arg&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.xml.transformer.ResultToDocumentTransformer"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/constructor-arg&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
<p>By default, the <code class="literal">MarshallingTransformer</code> passes the payload object to the <code class="literal">Marshaller</code>.
However, if its boolean <code class="literal">extractPayload</code> property is set to <code class="literal">false</code>, the entire <code class="literal">Message</code> instance is passed to the <code class="literal">Marshaller</code> instead.
That may be useful for certain custom implementations of the <code class="literal">Marshaller</code> interface, but, typically, the payload is the appropriate source object for marshalling when you delegate to any of the various <code class="literal">Marshaller</code> implementations.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="xml-xslt-payload-transformers" href="#xml-xslt-payload-transformers"></a>XsltPayloadTransformer</h4></div></div></div>

<p>The <a class="ulink" href="http://docs.spring.io/spring-integration/api/org/springframework/integration/xml/transformer/XsltPayloadTransformer.html" target="_top"><code class="literal">XsltPayloadTransformer</code></a> transforms XML payloads by using <a class="ulink" href="http://en.wikipedia.org/wiki/XSL_Transformations" target="_top">Extensible Stylesheet Language Transformations</a> (XSLT).
The transformer&#8217;s constructor requires an instance of either <a class="ulink" href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/core/io/Resource.html" target="_top">Resource</a> or <a class="ulink" href="http://docs.oracle.com/javase/6/docs/api/javax/xml/transform/Templates.html" target="_top">Templates</a> to be passed in.
Passing in a <code class="literal">Templates</code> instance allows for greater configuration of the <code class="literal">TransformerFactory</code> used to create the template instance.</p>
<p>As with the <a class="ulink" href="#xml-unmarshalling-transformer" target="_top"><code class="literal">UnmarshallingTransformer</code></a>, the <code class="literal">XsltPayloadTransformer</code> does the actual XSLT transformation against instances of <code class="literal">Source</code>.
Therefore, if the message payload is not an instance of <code class="literal">Source</code>, conversion is still attempted.
<code class="literal">String</code> and <code class="literal">Document</code> payloads are supported directly.</p>
<p>To create a custom conversion to a <code class="literal">Source</code>, you can inject an implementation of a <a class="ulink" href="http://docs.spring.io/spring-integration/api/org/springframework/integration/xml/source/SourceFactory.html" target="_top"><code class="literal">SourceFactory</code></a>.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>If a <code class="literal">SourceFactory</code> is not set explicitly, the property on the <code class="literal">XsltPayloadTransformer</code> is, by default, set to a  <a class="ulink" href="http://docs.spring.io/spring-integration/api/org/springframework/integration/xml/source/DomSourceFactory.html" target="_top"><code class="literal">DomSourceFactory</code></a>.</p>
</td></tr></table></div>
<p>By default, the <code class="literal">XsltPayloadTransformer</code> creates a message with a <a class="ulink" href="http://docs.oracle.com/javase/6/docs/api/javax/xml/transform/Result.html" target="_top"><code class="literal">Result</code></a> payload, similar to the <code class="literal">XmlPayloadMarshallingTransformer</code>.
You can customize this by providing a <a class="ulink" href="http://docs.spring.io/spring-integration/api/org/springframework/integration/xml/result/ResultFactory.html" target="_top"><code class="literal">ResultFactory</code></a> or a  <a class="ulink" href="http://docs.spring.io/spring-integration/api/org/springframework/integration/xml/transformer/ResultTransformer.html" target="_top"><code class="literal">ResultTransformer</code></a>.</p>
<p>The following example configures a bean that works as an XSLT payload transformer:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"xsltPayloadTransformer"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.xml.transformer.XsltPayloadTransformer"</span><span class="hl-tag">&gt;</span>
  <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"classpath:org/example/xsl/transform.xsl"</span><span class="hl-tag">/&gt;</span>
  <span class="hl-tag">&lt;constructor-arg&gt;</span>
    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.xml.transformer.ResultToDocumentTransformer"</span><span class="hl-tag">/&gt;</span>
  <span class="hl-tag">&lt;/constructor-arg&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
<p>Starting with Spring Integration 3.0, you can specify the transformer factory class name by using a constructor argument.
You can do so by using the <code class="literal">transformer-factory-class</code> attribute when you use the namespace.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="xml-using-result-transformers" href="#xml-using-result-transformers"></a>Using <code class="literal">ResultTransformer</code> Implementations</h4></div></div></div>

<p>Both the <code class="literal">MarshallingTransformer</code> and the <code class="literal">XsltPayloadTransformer</code> let you specify a <a class="ulink" href="http://docs.spring.io/spring-integration/api/org/springframework/integration/xml/transformer/ResultTransformer.html" target="_top"><code class="literal">ResultTransformer</code></a>.
Thus, if the marshalling or XSLT transformation returns a <a class="ulink" href="http://docs.oracle.com/javase/6/docs/api/javax/xml/transform/Result.html" target="_top"><code class="literal">Result</code></a>, you have the option to also use a <code class="literal">ResultTransformer</code> to transform the <code class="literal">Result</code> into another format.
Spring Integration provides two concrete <code class="literal">ResultTransformer</code> implementations:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="ulink" href="http://docs.spring.io/spring-integration/api/org/springframework/integration/xml/transformer/ResultToDocumentTransformer.html" target="_top"><code class="literal">ResultToDocumentTransformer</code></a>
</li><li class="listitem">
<a class="ulink" href="http://docs.spring.io/spring-integration/api/org/springframework/integration/xml/transformer/ResultToStringTransformer.html" target="_top"><code class="literal">ResultToStringTransformer</code></a>
</li></ul></div>
<p>By default, the <code class="literal">MarshallingTransformer</code> always returns a <a class="ulink" href="http://docs.oracle.com/javase/6/docs/api/javax/xml/transform/Result.html" target="_top"><code class="literal">Result</code></a>.
By specifying a <code class="literal">ResultTransformer</code>, you can customize the type of payload returned.</p>
<p>The behavior is slightly more complex for the <code class="literal">XsltPayloadTransformer</code>.
By default, if the input payload is an instance of <code class="literal">String</code> or <a class="ulink" href="http://docs.oracle.com/javase/6/docs/api/org/w3c/dom/Document.html" target="_top"><code class="literal">Document</code></a> the <code class="literal">resultTransformer</code> property is ignored.</p>
<p>However, if the input payload is a <a class="ulink" href="http://docs.oracle.com/javase/6/docs/api/javax/xml/transform/Source.html" target="_top"><code class="literal">Source</code></a> or any other type, the <code class="literal">resultTransformer</code> property is applied.
Additionally, you can set the <code class="literal">alwaysUseResultFactory</code> property to <code class="literal">true</code>, which also causes the specified <code class="literal">resultTransformer</code> to be used.</p>
<p>For more information and examples, see <a class="xref" href="#xml-using-result-transformers-namespace" title="38.2.3&nbsp;Namespace Configuration and Result Transformers">Section&nbsp;38.2.3, &#8220;Namespace Configuration and Result Transformers&#8221;</a>.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="xml-transformer-namespace" href="#xml-transformer-namespace"></a>38.2.2&nbsp;Namespace Support for XML Transformers</h3></div></div></div>

<p>Namespace support for all XML transformers is provided in the Spring Integration XML namespace, a template for which was <a class="link" href="#xpath-namespace-support" title="38.1&nbsp;Namespace Support">shown earlier</a>.
The namespace support for transformers creates an instance of either <code class="literal">EventDrivenConsumer</code> or <code class="literal">PollingConsumer</code>, according to the type of the provided input channel.
The namespace support is designed to reduce the amount of XML configuration by allowing the creation of an endpoint and transformer that use one element.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_using_an_literal_unmarshallingtransformer_literal" href="#_using_an_literal_unmarshallingtransformer_literal"></a>Using an <code class="literal">UnmarshallingTransformer</code></h4></div></div></div>

<p>The namespace support for the <code class="literal">UnmarshallingTransformer</code> is shown below.
Since the namespace create an endpoint instance rather than a transformer, you can nest a poller within the element to control the polling of the input channel.
The following example shows how to do so:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-xml:unmarshalling-transformer</span> <span class="hl-attribute">id</span>=<span class="hl-value">"defaultUnmarshaller"</span>
    <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span>
    <span class="hl-attribute">unmarshaller</span>=<span class="hl-value">"unmarshaller"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int-xml:unmarshalling-transformer</span> <span class="hl-attribute">id</span>=<span class="hl-value">"unmarshallerWithPoller"</span>
    <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span>
    <span class="hl-attribute">unmarshaller</span>=<span class="hl-value">"unmarshaller"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"2000"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;int-xml:unmarshalling-transformer/&gt;</span></pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_using_a_literal_marshallingtransformer_literal" href="#_using_a_literal_marshallingtransformer_literal"></a>Using a <code class="literal">MarshallingTransformer</code></h4></div></div></div>

<p>The namespace support for the marshalling transformer requires an <code class="literal">input-channel</code>, an <code class="literal">output-channel</code>, and a reference to a <code class="literal">marshaller</code>.
You can use the optional <code class="literal">result-type</code> attribute to control the type of result created.
Valid values are <code class="literal">StringResult</code> or <code class="literal">DomResult</code> (the default).
The following example configures a marshalling transformer:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-xml:marshalling-transformer</span>
     <span class="hl-attribute">input-channel</span>=<span class="hl-value">"marshallingTransformerStringResultFactory"</span>
     <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span>
     <span class="hl-attribute">marshaller</span>=<span class="hl-value">"marshaller"</span>
     <span class="hl-attribute">result-type</span>=<span class="hl-value">"StringResult"</span><span class="hl-tag"> /&gt;</span>

<span class="hl-tag">&lt;int-xml:marshalling-transformer</span>
    <span class="hl-attribute">input-channel</span>=<span class="hl-value">"marshallingTransformerWithResultTransformer"</span>
    <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span>
    <span class="hl-attribute">marshaller</span>=<span class="hl-value">"marshaller"</span>
    <span class="hl-attribute">result-transformer</span>=<span class="hl-value">"resultTransformer"</span><span class="hl-tag"> /&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"resultTransformer"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.xml.transformer.ResultToStringTransformer"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>Where the provided result types do not suffice, you can provide a reference to a custom implementation of <code class="literal">ResultFactory</code> as an alternative to setting the <code class="literal">result-type</code> attribute by using the <code class="literal">result-factory</code> attribute.
The <code class="literal">result-type</code> and <code class="literal">result-factory</code> attributes  are mutually exclusive.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Internally, the <code class="literal">StringResult</code> and <code class="literal">DomResult</code> result types are represented by the <code class="literal">ResultFactory</code> implementations: <a class="ulink" href="http://docs.spring.io/spring-integration/api/org/springframework/integration/xml/result/StringResultFactory.html" target="_top"><code class="literal">StringResultFactory</code></a> and  <a class="ulink" href="http://docs.spring.io/spring-integration/api/org/springframework/integration/xml/result/DomResultFactory.html" target="_top"><code class="literal">DomResultFactory</code></a> respectively.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_using_an_literal_xsltpayloadtransformer_literal" href="#_using_an_literal_xsltpayloadtransformer_literal"></a>Using an <code class="literal">XsltPayloadTransformer</code></h4></div></div></div>

<p>Namespace support for the <code class="literal">XsltPayloadTransformer</code> lets you  either pass in a <code class="literal">Resource</code> (in order to create the <a class="ulink" href="http://docs.oracle.com/javase/6/docs/api/javax/xml/transform/Templates.html" target="_top"><code class="literal">Templates</code></a> instance) or  pass in a pre-created <code class="literal">Templates</code> instance as a reference.
As with the marshalling transformer, you can control the type of the result output by specifying either the <code class="literal">result-factory</code> or the <code class="literal">result-type</code> attribute.
When you need to convert result before sending, you can use a <code class="literal">result-transformer</code> attribute to reference an implementation of <code class="literal">ResultTransformer</code>.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>If you specify the <code class="literal">result-factory</code> or the <code class="literal">result-type</code> attribute, the <code class="literal">alwaysUseResultFactory</code> property on the underlying <a class="ulink" href="http://docs.spring.io/spring-integration/api/org/springframework/integration/xml/transformer/XsltPayloadTransformer.html" target="_top"><code class="literal">XsltPayloadTransformer</code></a> is set to <code class="literal">true</code> by the <a class="ulink" href="http://docs.spring.io/spring-integration/api/org/springframework/integration/xml/config/XsltPayloadTransformerParser.html" target="_top"><code class="literal">XsltPayloadTransformerParser</code></a>.</p>
</td></tr></table></div>
<p>The following example configures two XSLT transformers:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-xml:xslt-transformer</span> <span class="hl-attribute">id</span>=<span class="hl-value">"xsltTransformerWithResource"</span>
    <span class="hl-attribute">input-channel</span>=<span class="hl-value">"withResourceIn"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span>
    <span class="hl-attribute">xsl-resource</span>=<span class="hl-value">"org/springframework/integration/xml/config/test.xsl"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int-xml:xslt-transformer</span> <span class="hl-attribute">id</span>=<span class="hl-value">"xsltTransformerWithTemplatesAndResultTransformer"</span>
    <span class="hl-attribute">input-channel</span>=<span class="hl-value">"withTemplatesAndResultTransformerIn"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span>
    <span class="hl-attribute">xsl-templates</span>=<span class="hl-value">"templates"</span>
    <span class="hl-attribute">result-transformer</span>=<span class="hl-value">"resultTransformer"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>You may need to have access to <code class="literal">Message</code> data, such as the <code class="literal">Message</code> headers, in order to assist with transformation.
For example, you may need to get access to certain <code class="literal">Message</code> headers and pass them on as parameters to a transformer (for example, <code class="literal">transformer.setParameter(..)</code>).
Spring Integration provides two convenient ways to accomplish this, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-xml:xslt-transformer</span> <span class="hl-attribute">id</span>=<span class="hl-value">"paramHeadersCombo"</span>
    <span class="hl-attribute">input-channel</span>=<span class="hl-value">"paramHeadersComboChannel"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span>
    <span class="hl-attribute">xsl-resource</span>=<span class="hl-value">"classpath:transformer.xslt"</span>
    <span class="hl-attribute">xslt-param-headers</span>=<span class="hl-value">"testP*, *foo, bar, baz"</span><span class="hl-tag">&gt;</span>

    <span class="hl-tag">&lt;int-xml:xslt-param</span> <span class="hl-attribute">name</span>=<span class="hl-value">"helloParameter"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"hello"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int-xml:xslt-param</span> <span class="hl-attribute">name</span>=<span class="hl-value">"firstName"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"headers.fname"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-xml:xslt-transformer&gt;</span></pre>
</div>
<p>If message header names match one-to-one to parameter names, you can use the <code class="literal">xslt-param-headers</code>&nbsp;attribute.
In it, you can use wildcards for simple pattern matching.
It supports the following simple pattern styles: <code class="literal">xxx*</code>, <code class="literal">*xxx</code>, <code class="literal">*xxx*</code>, and <code class="literal">xxx*yyy</code>.</p>
<p>You can also configure individual XSLT parameters by using the <code class="literal">&lt;xslt-param/&gt;</code> element.
On that element, you can set the <code class="literal">expression</code> attribute&nbsp;or the <code class="literal">value</code> attribute.
The <code class="literal">expression</code> attribute should be any valid SpEL expression with the <code class="literal">Message</code> being the root object of the expression evaluation context.
The <code class="literal">value</code> attribute (as with any <code class="literal">value</code> in Spring beans) lets you specify simple scalar values.
You can also use property placeholders (such as <code class="literal">${some.value}</code>).
So, with the <code class="literal">expression</code> and <code class="literal">value</code> attributes, you can map XSLT parameters to any accessible part of the <code class="literal">Message</code> as well as any literal value.</p>
<p>Starting with Spring Integration 3.0, you can now specify the transformer factory class name by setting the <code class="literal">transformer-factory-class</code> attribute.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="xml-using-result-transformers-namespace" href="#xml-using-result-transformers-namespace"></a>38.2.3&nbsp;Namespace Configuration and Result Transformers</h3></div></div></div>

<p>We cover using result transformers in <a class="xref" href="#xml-using-result-transformers" title="Using ResultTransformer Implementations">the section called &#8220;Using <code class="literal">ResultTransformer</code> Implementations&#8221;</a>.
The examples in this section use XML namespace configuration to illustrates several special use cases.
First, we define the <code class="literal">ResultTransformer</code>, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;beans:bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"resultToDoc"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.xml.transformer.ResultToDocumentTransformer"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>This <code class="literal">ResultTransformer</code> accepts either a <code class="literal">StringResult</code> or a <code class="literal">DOMResult</code> as input and converts the input into a <code class="literal">Document</code>.</p>
<p>Now we can declare the transformer, as follows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-xml:xslt-transformer</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"in"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"fahrenheitChannel"</span>
    <span class="hl-attribute">xsl-resource</span>=<span class="hl-value">"classpath:noop.xslt"</span> <span class="hl-attribute">result-transformer</span>=<span class="hl-value">"resultToDoc"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>If the incoming message&#8217;s payload is of type <code class="literal">Source</code>, then, as a first step, the <code class="literal">Result</code> is determined by using the <code class="literal">ResultFactory</code>.
As we did not specify a <code class="literal">ResultFactory</code>, the default <code class="literal">DomResultFactory</code> is used, meaning that the transformation yields a <code class="literal">DomResult</code>.</p>
<p>However, as we specified a <code class="literal">ResultTransformer</code>, it is used and the resulting <code class="literal">Message</code> payload is of type <code class="literal">Document</code>.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>The specified <code class="literal">ResultTransformer</code> is ignored with <code class="literal">String</code> or <code class="literal">Document</code> payloads.
If the incoming message&#8217;s payload is of type <code class="literal">String</code>, the payload after the XSLT transformation is a <code class="literal">String</code>.
Similarly, if the incoming message&#8217;s payload is of type <code class="literal">Document</code>, the payload after the XSLT transformation is a`Document`.</p>
</td></tr></table></div>
<p>If the message payload is not a <code class="literal">Source</code>, a <code class="literal">String</code>, or a <code class="literal">Document</code>, as a fallback option, we try to create a`Source` by using the default  <a class="ulink" href="http://docs.spring.io/spring-integration/api/org/springframework/integration/xml/source/SourceFactory.html" target="_top"><code class="literal">SourceFactory</code></a>.
As we did not specify a <code class="literal">SourceFactory</code> explicitly by using the <code class="literal">source-factory</code> attribute, the default  <a class="ulink" href="http://docs.spring.io/spring-integration/api/org/springframework/integration/xml/source/DomSourceFactory.html" target="_top"><code class="literal">DomSourceFactory</code></a> is used.
If successful, the XSLT transformation is executed as if the payload was of type <code class="literal">Source</code>, as described in the previous paragraphs.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The <code class="literal">DomSourceFactory</code> supports the creation of a <code class="literal">DOMSource</code> from a <code class="literal">Document</code>, a <code class="literal">File</code>, or a <code class="literal">String</code> payload.</p>
</td></tr></table></div>
<p>The next transformer declaration adds a <code class="literal">result-type</code> attribute that uses <code class="literal">StringResult</code> as its value.
The <code class="literal">result-type</code> is internally represented by the <code class="literal">StringResultFactory</code>.
Thus, you could have also added a reference to a <code class="literal">StringResultFactory</code>, by using the <code class="literal">result-factory</code> attribute, which would have been the same.
The following example shows that transformer declaration:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-xml:xslt-transformer</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"in"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"fahrenheitChannel"</span>
		<span class="hl-attribute">xsl-resource</span>=<span class="hl-value">"classpath:noop.xslt"</span> <span class="hl-attribute">result-transformer</span>=<span class="hl-value">"resultToDoc"</span>
		<span class="hl-attribute">result-type</span>=<span class="hl-value">"StringResult"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>Because we use a <code class="literal">ResultFactory</code>, the <code class="literal">alwaysUseResultFactory</code> property of the <code class="literal">XsltPayloadTransformer</code> class is implicitly set to <code class="literal">true</code>.
Consequently, the referenced <code class="literal">ResultToDocumentTransformer</code> is used.</p>
<p>Therefore, if you transform a payload of type <code class="literal">String</code>, the resulting payload is of type <a class="ulink" href="http://docs.oracle.com/javase/6/docs/api/org/w3c/dom/Document.html" target="_top"><code class="literal">Document</code></a>.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_literal_xsltpayloadtransformer_literal_and_literal_xsl_output_method_text_literal" href="#_literal_xsltpayloadtransformer_literal_and_literal_xsl_output_method_text_literal"></a><code class="literal">XsltPayloadTransformer</code> and <code class="literal">&lt;xsl:output method="text"/&gt;</code></h4></div></div></div>

<p><code class="literal">&lt;xsl:output method="text"/&gt;</code> tells the XSLT template to produce only text content from the input source.
In this particular case, we have no reason to use a <code class="literal">DomResult</code>.
Therefore, the <a class="ulink" href="http://docs.spring.io/spring-integration/api/org/springframework/integration/xml/transformer/XsltPayloadTransformer.html" target="_top"><code class="literal">XsltPayloadTransformer</code></a> defaults to <code class="literal">StringResult</code> if the <a class="ulink" href="http://docs.oracle.com/javase/7/docs/api/javax/xml/transform/Transformer.html#getOutputProperties()" target="_top">output property</a> called <code class="literal">method</code> of the underlying <code class="literal">javax.xml.transform.Transformer</code> returns <code class="literal">text</code>.
This coercion is performed independently from the inbound payload type.
This behavior is available only you set the if the <code class="literal">result-type</code> attribute or the <code class="literal">result-factory</code> attribute for the <code class="literal">&lt;int-xml:xslt-transformer&gt;</code> component.</p>
</div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xml-xpath-transformer" href="#xml-xpath-transformer"></a>38.3&nbsp;Transforming XML Messages with XPath</h2></div></div></div>

<p>When it comes to message transformation, XPath is a great way to transform messages that have XML payloads.
You can do so by defining XPath transformers with the  <code class="literal">&lt;xpath-transformer/&gt;</code> element.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_simple_xpath_transformation" href="#_simple_xpath_transformation"></a>38.3.1&nbsp;Simple XPath Transformation</h3></div></div></div>

<p>Consider following transformer configuration:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-xml:xpath-transformer</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"inputChannel"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"outputChannel"</span>
      <span class="hl-attribute">xpath-expression</span>=<span class="hl-value">"/person/@name"</span><span class="hl-tag"> /&gt;</span></pre>
</div>
<p>Also consider the following <code class="literal">Message</code>:</p>
<div class="informalexample">
<pre class="programlisting">Message&lt;?&gt; message =
  MessageBuilder.withPayload(<span class="hl-string">"&lt;person name='John Doe' age='42' married='true'/&gt;"</span>).build();</pre>
</div>
<p>After sending this message to the <span class="emphasis"><em>inputChannel</em></span>, the XPath transformer configured earlier transforms this XML Message to a simple <code class="literal">Message</code> with a payload of <span class="emphasis"><em>John Doe</em></span>, all based on the simple XPath Expression specified in the <code class="literal">xpath-expression</code> attribute.</p>
<p>XPath also lets you perform simple conversion of an extracted element to a desired type.
Valid return types are defined in <code class="literal">javax.xml.xpath.XPathConstants</code> and follow the conversion rules specified by the <code class="literal">javax.xml.xpath.XPath</code> interface.</p>
<p>The following constants are defined by the <code class="literal">XPathConstants</code> class: <code class="literal">BOOLEAN</code>, <code class="literal">DOM_OBJECT_MODEL</code>, <code class="literal">NODE</code>, <code class="literal">NODESET</code>, <code class="literal">NUMBER</code>, and <code class="literal">STRING</code>.</p>
<p>You can configure the desired type by using the <code class="literal">evaluation-type</code> attribute of the <code class="literal">&lt;xpath-transformer/&gt;</code> element, as the following example shows (twice):</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-xml:xpath-transformer</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"numberInput"</span> <span class="hl-attribute">xpath-expression</span>=<span class="hl-value">"/person/@age"</span>
                           <span class="hl-attribute">evaluation-type</span>=<span class="hl-value">"NUMBER_RESULT"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int-xml:xpath-transformer</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"booleanInput"</span>
                           <span class="hl-attribute">xpath-expression</span>=<span class="hl-value">"/person/@married = 'true'"</span>
                           <span class="hl-attribute">evaluation-type</span>=<span class="hl-value">"BOOLEAN_RESULT"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span><span class="hl-tag">/&gt;</span></pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_node_mappers" href="#_node_mappers"></a>38.3.2&nbsp;Node Mappers</h3></div></div></div>

<p>If you need to provide custom mapping for the node extracted by the XPath expression, you can provide a reference to the implementation of the <code class="literal">org.springframework.xml.xpath.NodeMapper</code> (an interface used by <code class="literal">XPathOperations</code> implementations for mapping <code class="literal">Node</code> objects on a per-node basis).
To provide a reference to a <code class="literal">NodeMapper</code>, you can use the <code class="literal">node-mapper</code> attribute, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-xml:xpath-transformer</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"nodeMapperInput"</span> <span class="hl-attribute">xpath-expression</span>=<span class="hl-value">"/person/@age"</span>
                           <span class="hl-attribute">node-mapper</span>=<span class="hl-value">"testNodeMapper"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>The following example shows a <code class="literal">NodeMapper</code> implementation that works with the preceding example:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">class</span> TestNodeMapper <span class="hl-keyword">implements</span> NodeMapper {
  <span class="hl-keyword">public</span> Object mapNode(Node node, <span class="hl-keyword">int</span> nodeNum) <span class="hl-keyword">throws</span> DOMException {
    <span class="hl-keyword">return</span> node.getTextContent() + <span class="hl-string">"-mapped"</span>;
  }
}</pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_xml_payload_converter" href="#_xml_payload_converter"></a>38.3.3&nbsp;XML Payload Converter</h3></div></div></div>

<p>You can also use an implementation of the <code class="literal">org.springframework.integration.xml.XmlPayloadConverter</code> to provide more granular transformation.
The following example shows how to define one:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-xml:xpath-transformer</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"customConverterInput"</span>
                           <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span> <span class="hl-attribute">xpath-expression</span>=<span class="hl-value">"/test/@type"</span>
                           <span class="hl-attribute">converter</span>=<span class="hl-value">"testXmlPayloadConverter"</span><span class="hl-tag"> /&gt;</span></pre>
</div>
<p>The following example shows an <code class="literal">XmlPayloadConverter</code> implementation that works with the preceding example:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">class</span> TestXmlPayloadConverter <span class="hl-keyword">implements</span> XmlPayloadConverter {
  <span class="hl-keyword">public</span> Source convertToSource(Object object) {
    <span class="hl-keyword">throw</span> <span class="hl-keyword">new</span> UnsupportedOperationException();
  }
  <span class="hl-comment">//</span>
  <span class="hl-keyword">public</span> Node convertToNode(Object object) {
    <span class="hl-keyword">try</span> {
      <span class="hl-keyword">return</span> DocumentBuilderFactory.newInstance().newDocumentBuilder().parse(
          <span class="hl-keyword">new</span> InputSource(<span class="hl-keyword">new</span> StringReader(<span class="hl-string">"&lt;test type='custom'/&gt;"</span>)));
    }
    <span class="hl-keyword">catch</span> (Exception e) {
      <span class="hl-keyword">throw</span> <span class="hl-keyword">new</span> IllegalStateException(e);
    }
  }
  <span class="hl-comment">//</span>
  <span class="hl-keyword">public</span> Document convertToDocument(Object object) {
    <span class="hl-keyword">throw</span> <span class="hl-keyword">new</span> UnsupportedOperationException();
  }
}</pre>
</div>
<p>If you do not provide this reference, the <code class="literal">DefaultXmlPayloadConverter</code> is used.
It should suffice in most cases, because it can convert from <code class="literal">Node</code>, <code class="literal">Document</code>, <code class="literal">Source</code>, <code class="literal">File</code>, <code class="literal">String</code>, <code class="literal">InputStream</code>, and <code class="literal">byte[]</code> payloads.
If you need to extend beyond the capabilities of that default implementation, an upstream <code class="literal">Transformer</code> is probably a better option than providing a reference to a custom implementation of this strategy here.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xml-xpath-splitting" href="#xml-xpath-splitting"></a>38.4&nbsp;Splitting XML Messages</h2></div></div></div>

<p><code class="literal">XPathMessageSplitter</code> supports messages with either <code class="literal">String</code> or <code class="literal">Document</code> payloads.
The splitter uses the provided XPath expression to split the payload into a number of nodes.
By default, this results in each <code class="literal">Node</code> instance becoming the payload of a new message.
When each message should be a <code class="literal">Document</code>, you can set the <code class="literal">createDocuments</code> flag.
Where a <code class="literal">String</code> payload is passed in, the payload is converted and then split before being converted back to a number of <code class="literal">String</code> messages.
The XPath splitter implements <code class="literal">MessageHandler</code> and should therefore be configured in conjunction with an appropriate endpoint (see the namespace support example after the following example for a simpler configuration alternative).
The following example configures a bean that uses an <code class="literal">XPathMessageSplitter</code>:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"splittingEndpoint"</span>
      <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.endpoint.EventDrivenConsumer"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"orderChannel"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;constructor-arg&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.xml.splitter.XPathMessageSplitter"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"/order/items"</span><span class="hl-tag"> /&gt;</span>
            <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"documentBuilder"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"customisedDocumentBuilder"</span><span class="hl-tag"> /&gt;</span>
            <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"outputChannel"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"orderItemsChannel"</span><span class="hl-tag"> /&gt;</span>
        <span class="hl-tag">&lt;/bean&gt;</span>
    <span class="hl-tag">&lt;/constructor-arg&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
<p>XPath splitter namespace support lets you create a message endpoint with an input channel and output channel, as the following example shows:</p>
<pre class="programlisting"><span class="hl-comment">&lt;!-- Split the order into items and create a new message for each item node --&gt;</span>
<span class="hl-tag">&lt;int-xml:xpath-splitter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"orderItemSplitter"</span>
                       <span class="hl-attribute">input-channel</span>=<span class="hl-value">"orderChannel"</span>
                       <span class="hl-attribute">output-channel</span>=<span class="hl-value">"orderItemsChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int-xml:xpath-expression</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"/order/items"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-xml:xpath-splitter&gt;</span>

<span class="hl-comment">&lt;!-- Split the order into items, create a new document for each item--&gt;</span>
<span class="hl-tag">&lt;int-xml:xpath-splitter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"orderItemDocumentSplitter"</span>
                       <span class="hl-attribute">input-channel</span>=<span class="hl-value">"orderChannel"</span>
                       <span class="hl-attribute">output-channel</span>=<span class="hl-value">"orderItemsChannel"</span>
                       <span class="hl-attribute">create-documents</span>=<span class="hl-value">"true"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int-xml:xpath-expression</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"/order/items"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"2000"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-xml:xpath-splitter&gt;</span></pre>
<p>Starting with version 4.2, the <code class="literal">XPathMessageSplitter</code> exposes the <code class="literal">outputProperties</code> (such as <code class="literal">OutputKeys.OMIT_XML_DECLARATION</code>) property for an <code class="literal">javax.xml.transform.Transformer</code> instance when a request <code class="literal">payload</code> is not of type <code class="literal">org.w3c.dom.Node</code>.
The following example defines a property and uses it with the <code class="literal">output-properties</code> property:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;util:properties</span> <span class="hl-attribute">id</span>=<span class="hl-value">"outputProperties"</span><span class="hl-tag">&gt;</span>
	<span class="hl-tag">&lt;beans:prop</span> <span class="hl-attribute">key</span>=<span class="hl-value">"#{T (javax.xml.transform.OutputKeys).OMIT_XML_DECLARATION}"</span><span class="hl-tag">&gt;</span>yes<span class="hl-tag">&lt;/beans:prop&gt;</span>
<span class="hl-tag">&lt;/util:properties&gt;</span>

<span class="hl-tag">&lt;xpath-splitter</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span>
             <span class="hl-attribute">output-properties</span>=<span class="hl-value">"outputProperties"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;xpath-expression</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"/orders/order"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/xpath-splitter&gt;</span></pre>
</div>
<p>Starting with <code class="literal">version 4.2</code>, the <code class="literal">XPathMessageSplitter</code> exposes an <code class="literal">iterator</code> option as a <code class="literal">boolean</code> flag (defaults to <code class="literal">true</code>).
This allows the "<code class="literal">streaming</code>" of split nodes in the downstream flow.
With the <code class="literal">iterator</code> mode set to <code class="literal">true</code>, each node is transformed while iterating.
When <code class="literal">false</code>, all entries are first transformed, before the split nodes start being sent to the output channel. (You can think of the difference as "<code class="literal">transform, send, transform, send</code>" versus "<code class="literal">transform, transform, send, send</code>".)
See <a class="xref" href="#splitter" title="8.3&nbsp;Splitter">Section&nbsp;8.3, &#8220;Splitter&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xml-xpath-routing" href="#xml-xpath-routing"></a>38.5&nbsp;Routing XML Messages with XPath</h2></div></div></div>

<p>Similar to SpEL-based routers, Spring Integration provides support for routing messages based on XPath expressions, which lets you create a message endpoint with an input channel but no output channel.
Instead, one or more output channels are determined dynamically.
The following example shows how to create such a router:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-xml:xpath-router</span> <span class="hl-attribute">id</span>=<span class="hl-value">"orderTypeRouter"</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"orderChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int-xml:xpath-expression</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"/order/type"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-xml:xpath-router&gt;</span></pre>
</div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>For an overview of attributes that are common among Routers, see <a class="xref" href="#router-common-parameters" title="8.1.2&nbsp;Common Router Parameters">Section&nbsp;8.1.2, &#8220;Common Router Parameters&#8221;</a>.</p>
</td></tr></table></div>
<p>Internally, XPath expressions are evaluated as type <code class="literal">NODESET</code> and converted to a <code class="literal">List&lt;String&gt;</code> that represents channel names.
Typically, such a list contains a single channel name.
However, based on the results of an XPath Expression, the XPath router can also take on the characteristics of a recipient list router if the XPath expression returns more than one value.
In that case, the <code class="literal">List&lt;String&gt;</code> contains more than one channel name.
Consequently, messages are sent to all the channels in the list.</p>
<p>Thus, assuming that the XML file passed to the following router configuration contains many <code class="literal">responder</code> sub-elements that represent channel names, the message is sent to all of those channels:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-comment">&lt;!-- route the order to all responders--&gt;</span>
<span class="hl-tag">&lt;int-xml:xpath-router</span> <span class="hl-attribute">id</span>=<span class="hl-value">"responderRouter"</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"orderChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int-xml:xpath-expression</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"/request/responders"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-xml:xpath-router&gt;</span></pre>
</div>
<p>If the returned values do not represent the channel names directly, you can specify additional mapping parameters to map those returned values to actual channel names.
For example if the <code class="literal">/request/responders</code> expression results in two values (<code class="literal">responderA</code> and <code class="literal">responderB</code>), but you do not want to couple the responder names to channel names, you can provide additional mapping configuration, such as the following:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-comment">&lt;!-- route the order to all responders--&gt;</span>
<span class="hl-tag">&lt;int-xml:xpath-router</span> <span class="hl-attribute">id</span>=<span class="hl-value">"responderRouter"</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"orderChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int-xml:xpath-expression</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"/request/responders"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int-xml:mapping</span> <span class="hl-attribute">value</span>=<span class="hl-value">"responderA"</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"channelA"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int-xml:mapping</span> <span class="hl-attribute">value</span>=<span class="hl-value">"responderB"</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"channelB"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-xml:xpath-router&gt;</span></pre>
</div>
<p>As already mentioned, the default evaluation type for XPath expressions is <code class="literal">NODESET</code>, which is converted to a <code class="literal">List&lt;String&gt;</code> of channel names, which handles single channel scenarios as well as multiple channel scenarios.</p>
<p>Nonetheless, certain XPath expressions may evaluate as type <code class="literal">String</code> from the very beginning.
Consider, for example, the following XPath Expression:</p>
<div class="informalexample">
<pre class="programlisting">name(./node())</pre>
</div>
<p>This expression returns the name of the root node.
If the default evaluation type <code class="literal">NODESET</code> is being used, it results in an exception.</p>
<p>For these scenarios, you can use the <code class="literal">evaluate-as-string</code> attribute, which lets you manage the evaluation type.
It is <code class="literal">FALSE</code> by default.
However, if you set it to <code class="literal">TRUE</code>, the <code class="literal">String</code> evaluation type is used.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>XPath 1.0 specifies 4 data types:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Node-sets
</li><li class="listitem">
Strings
</li><li class="listitem">
Number
</li><li class="listitem">
Boolean
</li></ul></div>
<p>When the XPath Router evaluates expressions by using the optional <code class="literal">evaluate-as-string</code> attribute, the return value is determined by the <code class="literal">string()</code> function, as defined in the XPath specification.
This means that, if the expression selects multiple nodes, it return the string value of the first node.</p>
<p>For further information, see:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="ulink" href="http://www.w3.org/TR/xpath/" target="_top">Specification: XML Path Language (XPath) Version 1.0</a>
</li><li class="listitem">
<a class="ulink" href="http://www.w3.org/TR/xpath/#function-string" target="_top">XPath specification - string() function</a>
</li></ul></div>
</td></tr></table></div>
<p>For example, if we want to route based on the name of the root node, we can use the following configuration:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-xml:xpath-router</span> <span class="hl-attribute">id</span>=<span class="hl-value">"xpathRouterAsString"</span>
        <span class="hl-attribute">input-channel</span>=<span class="hl-value">"xpathStringChannel"</span>
        <span class="hl-attribute">evaluate-as-string</span>=<span class="hl-value">"true"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int-xml:xpath-expression</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"name(./node())"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-xml:xpath-router&gt;</span></pre>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="xpath-routing-converter" href="#xpath-routing-converter"></a>38.5.1&nbsp;XML Payload Converter</h3></div></div></div>

<p>For XPath Routers, you can also specify the Converter to use when converting payloads prior to XPath evaluation.
As such, the XPath Router supports custom implementations of the <code class="literal">XmlPayloadConverter</code> strategy, and when configuring an <code class="literal">xpath-router</code> element in XML, a reference to such an implementation may be provided via the <code class="literal">converter</code> attribute.</p>
<p>If this reference is not explicitly provided, the <code class="literal">DefaultXmlPayloadConverter</code> is used.
It should be sufficient in most cases, since it can convert from Node, Document, Source, File, and String typed payloads.
If you need to extend beyond the capabilities of that default implementation, then an upstream Transformer is generally a better option in most cases, rather than providing a reference to a custom implementation of this strategy here.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xml-xpath-header-enricher" href="#xml-xpath-header-enricher"></a>38.6&nbsp;XPath Header Enricher</h2></div></div></div>

<p>The XPath header enricher defines a header enricher message transformer that evaluates an XPath expression against the message payload and inserts the result of the evaluation into a message header.</p>
<p>The following listing shows all the available configuration parameters:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-xml:xpath-header-enricher</span> <span class="hl-attribute">default-overwrite</span>=<span class="hl-value">"true"</span>    <a name="CO56-1" href="#CO56-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
                               id=""                       <a name="CO56-2" href="#CO56-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
                               input-channel=""            <a name="CO56-3" href="#CO56-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
                               output-channel=""           <a name="CO56-4" href="#CO56-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
                               should-skip-nulls="true"&gt;   <a name="CO56-5" href="#CO56-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
    <span class="hl-tag">&lt;int:poller&gt;</span><span class="hl-tag">&lt;/int:poller&gt;</span>                              <a name="CO56-6" href="#CO56-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>
    <span class="hl-tag">&lt;int-xml:header</span> <span class="hl-attribute">name</span>=<span class="hl-value">""</span>                                <a name="CO56-7" href="#CO56-7"></a><span><img src="images/callouts/7.png" alt="7" border="0"></span>
                    evaluation-type="STRING_RESULT"        <a name="CO56-8" href="#CO56-8"></a><span><img src="images/callouts/8.png" alt="8" border="0"></span>
                    header-type="int"                      <a name="CO56-9" href="#CO56-9"></a><span><img src="images/callouts/9.png" alt="9" border="0"></span>
                    overwrite="true"                       <a name="CO56-10" href="#CO56-10"></a><span><img src="images/callouts/10.png" alt="10" border="0"></span>
                    xpath-expression=""                    <a name="CO56-11" href="#CO56-11"></a><span><img src="images/callouts/11.png" alt="11" border="0"></span>
                    xpath-expression-ref=""/&gt;              <a name="CO56-12" href="#CO56-12"></a><span><img src="images/callouts/12.png" alt="12" border="0"></span>
<span class="hl-tag">&lt;/int-xml:xpath-header-enricher&gt;</span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO56-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Specifies the default boolean value for whether to overwrite existing header values.
This takes effect only for child elements that do not provide their own <span class="emphasis"><em>overwrite</em></span> attribute.
If you do not set the <span class="emphasis"><em>default- overwrite</em></span> attribute, the specified header values do not overwrite any existing ones with the same header names.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO56-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>ID for the underlying bean definition.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO56-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The receiving message channel of this endpoint.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO56-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Channel to which enriched messages are sent.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO56-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Specifies whether null values, such as might be returned from an expression evaluation, should be skipped.
The default value is <code class="literal">true</code>.
If a null value should trigger removal of the corresponding header, set this to <code class="literal">false</code>.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO56-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A poller to use with the header enricher.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO56-7"><span><img src="images/callouts/7.png" alt="7" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The name of the header to be enriched.
Mandatory.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO56-8"><span><img src="images/callouts/8.png" alt="8" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The result type expected from the XPath evaluation.
If you did not set a <code class="literal">header-type</code> attribute, this is the type of the header value.
The following values are allowed: <code class="literal">BOOLEAN_RESULT</code>, <code class="literal">STRING_RESULT</code>, <code class="literal">NUMBER_RESULT</code>, <code class="literal">NODE_RESULT</code>, and <code class="literal">NODE_LIST_RESULT</code>.
If not set, it defaults internally to <code class="literal">XPathEvaluationType.STRING_RESULT</code>.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO56-9"><span><img src="images/callouts/9.png" alt="9" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The fully qualified class name for the header value type.
The result of the XPath evaluation is converted to this type by <code class="literal">ConversionService</code>.
This allows, for example, a <code class="literal">NUMBER_RESULT</code> (a double) to be converted to an <code class="literal">Integer</code>.
The type can be declared as a primitive (such as <code class="literal">int</code>), but the result is always the equivalent wrapper class (such as <code class="literal">Integer</code>).
The same integration <code class="literal">ConversionService</code> discussed in <a class="xref" href="#payload-type-conversion" title="10.1.6&nbsp;Payload Type Conversion">Section&nbsp;10.1.6, &#8220;Payload Type Conversion&#8221;</a> is used for the conversion, so conversion to custom types is supported by adding a custom converter to the service.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO56-10"><span><img src="images/callouts/10.png" alt="10" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Boolean value to indicate whether this header value should overwrite an existing header value for the same name if already present on the input <code class="literal">Message</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO56-11"><span><img src="images/callouts/11.png" alt="11" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The XPath expression as a <code class="literal">String</code>.
You must set either this attribute or <code class="literal">xpath-expression-ref</code>, but not both.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO56-12"><span><img src="images/callouts/12.png" alt="12" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The XPath expression reference.
You must set either this attribute or <code class="literal">xpath-expression</code>, but not both.</p>
</td></tr></table></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xml-xpath-filter" href="#xml-xpath-filter"></a>38.7&nbsp;Using the XPath Filter</h2></div></div></div>

<p>This component defines an XPath-based message filter.
Internally, this components uses a <code class="literal">MessageFilter</code> that wraps an instance of <code class="literal">AbstractXPathMessageSelector</code>.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>See <a class="xref" href="#filter" title="8.2&nbsp;Filter">Section&nbsp;8.2, &#8220;Filter&#8221;</a> for further details.</p>
</td></tr></table></div>
<p>to use the XPath filter you must, at a minimum, provide an XPath expression either by declaring the <code class="literal">xpath-expression</code> element or by referencing an XPath Expression in the <code class="literal">xpath-expression-ref</code> attribute.</p>
<p>If the provided XPath expression evaluates to a <code class="literal">boolean</code> value, no further configuration parameters are necessary.
However, if the XPath expression evaluates to a <code class="literal">String</code>, you should set the <code class="literal">match-value</code> attribute, against which the evaluation result is matched.</p>
<p><code class="literal">match-type</code> has three options:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">exact</code>: Correspond to <code class="literal">equals</code> on <code class="literal">java.lang.String</code>.
The underlying implementation uses a <code class="literal">StringValueTestXPathMessageSelector</code>
</li><li class="listitem">
<code class="literal">case-insensitive</code>: Correspond to <code class="literal">equals-ignore-case</code> on <code class="literal">java.lang.String</code>.
The underlying implementation uses a <code class="literal">StringValueTestXPathMessageSelector</code>
</li><li class="listitem">
<code class="literal">regex</code>: Matches operations one <code class="literal">java.lang.String</code>.
The underlying implementation uses a <code class="literal">RegexTestXPathMessageSelector</code>
</li></ul></div>
<p>When providing a <span class="emphasis"><em>match-type</em></span> value of <span class="emphasis"><em>regex</em></span>, the value provided with the <code class="literal">match-value</code> attribute must be a valid regular expression.</p>
<p>The following example shows all the available attributes for the <code class="literal">xpath-filter</code> element:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-xml:xpath-filter</span> <span class="hl-attribute">discard-channel</span>=<span class="hl-value">""</span>                      <a name="CO57-1" href="#CO57-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
                      id=""                                   <a name="CO57-2" href="#CO57-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
                      input-channel=""                        <a name="CO57-3" href="#CO57-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
                      match-type="exact"                      <a name="CO57-4" href="#CO57-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
                      match-value=""                          <a name="CO57-5" href="#CO57-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
                      output-channel=""                       <a name="CO57-6" href="#CO57-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>
                      throw-exception-on-rejection="false"    <a name="CO57-7" href="#CO57-7"></a><span><img src="images/callouts/7.png" alt="7" border="0"></span>
                      xpath-expression-ref=""&gt;                <a name="CO57-8" href="#CO57-8"></a><span><img src="images/callouts/8.png" alt="8" border="0"></span>
    <span class="hl-tag">&lt;int-xml:xpath-expression</span> <span class="hl-attribute">...</span><span class="hl-tag"> /&gt;</span>                          <a name="CO57-9" href="#CO57-9"></a><span><img src="images/callouts/9.png" alt="9" border="0"></span>
    <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">...</span><span class="hl-tag"> /&gt;</span>                                        <a name="CO57-10" href="#CO57-10"></a><span><img src="images/callouts/10.png" alt="10" border="0"></span>
<span class="hl-tag">&lt;/int-xml:xpath-filter&gt;</span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO57-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Message channel where you want rejected messages to be sent.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO57-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>ID for the underlying bean definition.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO57-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The receiving message channel of this endpoint.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO57-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Type of match to apply between the XPath evaluation result and the <code class="literal">match-value</code>.
The default is <code class="literal">exact</code>.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO57-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>String value to be matched against the XPath evaluation result.
If you do not set this attribute, the XPath evaluation must produce a boolean result.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO57-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The channel to which messages that matched the filter criteria are dispatched.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO57-7"><span><img src="images/callouts/7.png" alt="7" border="0"></span></a> </p></td><td valign="top" align="left">
<p>By default, this property is set to <code class="literal">false</code> and rejected messages (messages that did not match the filter criteria) are silently dropped.
However, if set to <code class="literal">true</code>, message rejection results in an error condition and an exception being propagated upstream to the caller.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO57-8"><span><img src="images/callouts/8.png" alt="8" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Reference to an XPath expression instance to evaluate.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO57-9"><span><img src="images/callouts/9.png" alt="9" border="0"></span></a> </p></td><td valign="top" align="left">
<p>This child element sets the XPath expression to be evaluated.
If you do not include this element, you must set the <code class="literal">xpath-expression-ref</code> attribute.
Also, you can include only one <code class="literal">xpath-expression</code> element.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO57-10"><span><img src="images/callouts/10.png" alt="10" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A poller to use with the XPath filter.
Optional.</p>
</td></tr></table></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xpath-spel-function" href="#xpath-spel-function"></a>38.8&nbsp;#xpath SpEL Function</h2></div></div></div>

<p>Spring Integration, since version 3.0, provides the built-in <code class="literal">#xpath</code> SpEL function, which invokes the <code class="literal">XPathUtils.evaluate(...)</code> static method.
This method delegates to an <code class="literal">org.springframework.xml.xpath.XPathExpression</code>.
The following listing shows some usage examples:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;transformer</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"#xpath(payload, '/name')"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;filter</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"#xpath(payload, headers.xpath, 'boolean')"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;splitter</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"#xpath(payload, '//book', 'document_list')"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;router</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"#xpath(payload, '/person/@age', 'number')"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;mapping</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"output1"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"16"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;mapping</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"output2"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"45"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/router&gt;</span></pre>
</div>
<p>The <code class="literal">#xpath()</code> also supports a third optional parameter for converting the result of the XPath evaluation.
It can be one of the String constants (<code class="literal">string</code>, <code class="literal">boolean</code>, <code class="literal">number</code>, <code class="literal">node</code>, <code class="literal">node_list</code> and <code class="literal">document_list</code>) or an <code class="literal">org.springframework.xml.xpath.NodeMapper</code> instance.
By default, the <code class="literal">#xpath</code> SpEL function returns a <code class="literal">String</code> representation of the XPath evaluation.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>To enable the <code class="literal">#xpath</code> SpEL function, you can add the <code class="literal">spring-integration-xml.jar</code> to the classpath.
You need no declare any components from the Spring Integration XML Namespace.</p>
</td></tr></table></div>
<p>For more information, see "`<a class="xref" href="#spel" title="Appendix&nbsp;A.&nbsp;Spring Expression Language (SpEL)">Appendix&nbsp;A, <i>Spring Expression Language (SpEL)</i></a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xml-validating-filter" href="#xml-validating-filter"></a>38.9&nbsp;XML Validating Filter</h2></div></div></div>

<p>The XML Validating Filter lets you validate incoming messages against provided schema instances.
The following schema types are supported:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
xml-schema (<a class="ulink" href="http://www.w3.org/2001/XMLSchema" target="_top">http://www.w3.org/2001/XMLSchema</a>)
</li><li class="listitem">
relax-ng (<a class="ulink" href="http://relaxng.org/ns/structure/1.0" target="_top">http://relaxng.org/ns/structure/1.0</a>)
</li></ul></div>
<p>Messages that fail validation can either be silently dropped or be forwarded to a definable <code class="literal">discard-channel</code>.
Furthermore, you can configure this filter to throw an <code class="literal">Exception</code> in case validation fails.</p>
<p>The following listing shows all the available configuration parameters:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-xml:validating-filter</span> <span class="hl-attribute">discard-channel</span>=<span class="hl-value">""</span>                    <a name="CO58-1" href="#CO58-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
                           id=""                                 <a name="CO58-2" href="#CO58-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
                           input-channel=""                      <a name="CO58-3" href="#CO58-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
                           output-channel=""                     <a name="CO58-4" href="#CO58-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
                           schema-location=""                    <a name="CO58-5" href="#CO58-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
                           schema-type="xml-schema"              <a name="CO58-6" href="#CO58-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>
                           throw-exception-on-rejection="false"  <a name="CO58-7" href="#CO58-7"></a><span><img src="images/callouts/7.png" alt="7" border="0"></span>
                           xml-converter=""                      <a name="CO58-8" href="#CO58-8"></a><span><img src="images/callouts/8.png" alt="8" border="0"></span>
                           xml-validator=""&gt;                     <a name="CO58-9" href="#CO58-9"></a><span><img src="images/callouts/9.png" alt="9" border="0"></span>
    <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">.../&gt;</span>                                            <a name="CO58-10" href="#CO58-10"></a><span><img src="images/callouts/10.png" alt="10" border="0"></span>
<span class="hl-tag">&lt;/int-xml:validating-filter&gt;</span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO58-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Message channel where you want rejected messages to be sent.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO58-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>ID for the underlying bean definition.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO58-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The receiving message channel of this endpoint.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO58-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Message channel where you want accepted messages to be sent.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO58-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Sets the location of the schema to validate the message&#8217;s payload against.
Internally uses the <code class="literal">org.springframework.core.io.Resource</code> interface.
You can set this attribute or the <code class="literal">xml-validator</code> attribute but not both.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO58-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Sets the schema type.
Can be either <code class="literal">xml-schema</code> or <code class="literal">relax-ng</code>.
Optional.
If not set, it defaults to <code class="literal">xml-schema</code>, which internally translates to <code class="literal">org.springframework.xml.validation.XmlValidatorFactory#SCHEMA_W3C_XML</code>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO58-7"><span><img src="images/callouts/7.png" alt="7" border="0"></span></a> </p></td><td valign="top" align="left">
<p>If <code class="literal">true</code>, a <code class="literal">MessageRejectedException</code> is thrown if validation fails for the provided Message&#8217;s payload.
Defaults to <code class="literal">false</code> if not set.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO58-8"><span><img src="images/callouts/8.png" alt="8" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Reference to a custom <code class="literal">org.springframework.integration.xml.XmlPayloadConverter</code> strategy.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO58-9"><span><img src="images/callouts/9.png" alt="9" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Reference to a custom <code class="literal">sorg.springframework.xml.validation.XmlValidator</code> strategy.
You can set this attribute or the <code class="literal">schema-location</code> attribute but not both.
Optional.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO58-10"><span><img src="images/callouts/10.png" alt="10" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A poller to use with the XPath filter.
Optional.</p>
</td></tr></table></div>
</div>
</div>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="xmpp" href="#xmpp"></a>39.&nbsp;XMPP Support</h2></div></div></div>

<p>Spring Integration provides channel adapters for <a class="ulink" href="http://www.xmpp.org" target="_top">XMPP</a>.
XMPP stands for "<code class="literal">Extensible Messaging and Presence Protocol</code>".</p>
<p>XMPP describes a way for multiple agents to communicate with each other in a distributed system.
The canonical use case is to send and receive chat messages, though XMPP can be (and is) used for other kinds of applications.
XMPP describes a network of actors.
Within that network, actors may address each other directly and broadcast status changes (such as "<code class="literal">presence</code>").</p>
<p>XMPP provides the messaging fabric that underlies some of the biggest instant messaging networks in the world, including Google Talk (GTalk, which is also available from within GMail) and Facebook Chat.
Many good open-source XMPP servers are available.
Two popular implementations are <a class="ulink" href="http://www.igniterealtime.org/projects/openfire/" target="_top">Openfire</a> and <a class="ulink" href="http://www.ejabberd.im" target="_top">ejabberd</a>.</p>
<p>Spring integration provides support for XMPP by providing XMPP adapters, which support sending and receiving both XMPP chat messages and presence changes from other entries in a client&#8217;s roster.</p>
<p>You need to include this dependency into your project:</p>
<div class="informalexample">
<p>
<b>Maven.&nbsp;</b>

</p><pre class="programlisting"><span class="hl-tag">&lt;dependency&gt;</span>
    <span class="hl-tag">&lt;groupId&gt;</span>org.springframework.integration<span class="hl-tag">&lt;/groupId&gt;</span>
    <span class="hl-tag">&lt;artifactId&gt;</span>spring-integration-xmpp<span class="hl-tag">&lt;/artifactId&gt;</span>
    <span class="hl-tag">&lt;version&gt;</span>5.1.2.RELEASE<span class="hl-tag">&lt;/version&gt;</span>
<span class="hl-tag">&lt;/dependency&gt;</span></pre><p>

</p>
<p>
<b>Gradle.&nbsp;</b>

</p><pre class="programlisting">compile <span class="hl-string">"org.springframework.integration:spring-integration-xmpp:5.1.2.RELEASE"</span></pre><p>

</p>
</div>
<p>As with other adapters, the XMPP adapters come with support for a convenient namespace-based configuration.
To configure the XMPP namespace, include the following elements in the headers of your XML configuration file:</p>
<div class="informalexample">
<pre class="programlisting">xmlns:int-xmpp="http://www.springframework.org/schema/integration/xmpp"
xsi:schemaLocation="http://www.springframework.org/schema/integration/xmpp
	http://www.springframework.org/schema/integration/xmpp/spring-integration-xmpp.xsd"</pre>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xmpp-connection" href="#xmpp-connection"></a>39.1&nbsp;XMPP Connection</h2></div></div></div>

<p>Before using inbound or outbound XMPP adapters to participate in the XMPP network, an actor must establish its XMPP connection.
All XMPP adapters connected to a particular account can share this connection object.
Typically this requires (at a minimum) <code class="literal">user</code>, <code class="literal">password</code>, and <code class="literal">host</code>.
To create a basic XMPP connection, you can use the convenience of the namespace, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-xmpp:xmpp-connection</span>
    <span class="hl-attribute">id</span>=<span class="hl-value">"myConnection"</span>
    <span class="hl-attribute">user</span>=<span class="hl-value">"user"</span>
    <span class="hl-attribute">password</span>=<span class="hl-value">"password"</span>
    <span class="hl-attribute">host</span>=<span class="hl-value">"host"</span>
    <span class="hl-attribute">port</span>=<span class="hl-value">"port"</span>
    <span class="hl-attribute">resource</span>=<span class="hl-value">"theNameOfTheResource"</span>
    <span class="hl-attribute">subscription-mode</span>=<span class="hl-value">"accept_all"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>For added convenience, you can rely on the default naming convention and omit the <code class="literal">id</code> attribute.
The default name (<code class="literal">xmppConnection</code>) is used for this connection bean.</p>
</td></tr></table></div>
<p>If the XMPP connection goes stale, reconnection attempts are made with an automatic login as long as the previous connection state was logged (authenticated).
We also register a <code class="literal">ConnectionListener</code>, which logs connection events if the <code class="literal">DEBUG</code> logging level is enabled.</p>
<p>The <code class="literal">subscription-mode</code> attribute initiates the roster listener to deal with incoming subscriptions from other users.
This functionality is not always available for the target XMPP servers.
For example, Google Cloud Messaging (GCM) and Firebase Cloud Messaging (FCM) fully disable it.
To switch off the roster listener for subscriptions, you can configure it with an empty string when using XML configuration (<code class="literal">subscription-mode=""</code>) or with <code class="literal">XmppConnectionFactoryBean.setSubscriptionMode(null)</code> when using Java Configuration.
Doing so disables the roster at the login phase as well.
See <a class="ulink" href="http://download.igniterealtime.org/smack/docs/latest/javadoc/org/jivesoftware/smack/roster/Roster.html#setRosterLoadedAtLogin-boolean-" target="_top"><code class="literal">Roster.setRosterLoadedAtLogin(boolean)</code></a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xmpp-messages" href="#xmpp-messages"></a>39.2&nbsp;XMPP Messages</h2></div></div></div>

<p>Spring Integration provides support for sending and receiving XMPP messages.
For receiving them, it offers an inbound message channel adapter.
For sending them, it offers an outbound message channel adapter.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="xmpp-message-inbound-channel-adapter" href="#xmpp-message-inbound-channel-adapter"></a>39.2.1&nbsp;Inbound Message Channel Adapter</h3></div></div></div>

<p>The Spring Integration adapters support receiving chat messages from other users in the system.
To do so, the inbound message channel adapter "<code class="literal">logs in</code>" as a user on your behalf and receives the messages sent to that user.
Those messages are then forwarded to your Spring Integration client.
The <code class="literal">inbound-channel-adapter</code> element provides Configuration support for the XMPP inbound message channel adapter.
The following example shows how to configure it:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-xmpp:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"xmppInboundAdapter"</span>
	<span class="hl-attribute">channel</span>=<span class="hl-value">"xmppInbound"</span>
	<span class="hl-attribute">xmpp-connection</span>=<span class="hl-value">"testConnection"</span>
	<span class="hl-attribute">payload-expression</span>=<span class="hl-value">"getExtension('google:mobile:data').json"</span>
	<span class="hl-attribute">stanza-filter</span>=<span class="hl-value">"stanzaFilter"</span>
	<span class="hl-attribute">auto-startup</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>Along with the usual attributes (for a message channel adapter), this adapter also requires a reference to an XMPP Connection.</p>
<p>The XMPP inbound adapter is event-driven and a <code class="literal">Lifecycle</code> implementation.
When started, it registers a <code class="literal">PacketListener</code> that listens for incoming XMPP chat messages.
It forwards any received messages to the underlying adapter, which converts them to Spring Integration messages and sends them to the specified <code class="literal">channel</code>.
When stopped, it unregisters the <code class="literal">PacketListener</code>.</p>
<p>Starting with version 4.3, the <code class="literal">ChatMessageListeningEndpoint</code> (and its <code class="literal">&lt;int-xmpp:inbound-channel-adapter&gt;</code>) supports the injection of a <code class="literal">org.jivesoftware.smack.filter.StanzaFilter</code> to be registered on the provided <code class="literal">XMPPConnection</code>, together with an internal <code class="literal">StanzaListener</code> implementation.
See the <a class="ulink" href="https://www.igniterealtime.org/builds/smack/docs/latest/javadoc/org/jivesoftware/smack/XMPPConnection.html#addAsyncStanzaListener%28org.jivesoftware.smack.StanzaListener,%20org.jivesoftware.smack.filter.StanzaFilter%29" target="_top">Javadoc</a> for more information.</p>
<p>Version 4.3 introduced the <code class="literal">payload-expression</code> attribute for the <code class="literal">ChatMessageListeningEndpoint</code>.
The incoming <code class="literal">org.jivesoftware.smack.packet.Message</code> represents a root object for the evaluation context.
This option is useful when you use <a class="link" href="#xmpp-extensions" title="39.6&nbsp;XMPP Extensions">XMPP extensions</a>.
For example, for the GCM protocol we can extract the body by using the following expression:</p>
<div class="informalexample">
<pre class="programlisting">payload-expression="getExtension('google:mobile:data').json"</pre>
</div>
<p>The following example extracts the body for the XHTML protocol:</p>
<div class="informalexample">
<pre class="programlisting">payload-expression="getExtension(T(org.jivesoftware.smackx.xhtmlim.packet.XHTMLExtension).NAMESPACE).bodies[0]"</pre>
</div>
<p>To simplify access to the extension in the XMPP Message, the <code class="literal">extension</code> variable is added into the <code class="literal">EvaluationContext</code>.
Note that it is added when only one extension is present in the message.
The preceding examples that show the <code class="literal">namespace</code> manipulations can be simplified to the following example:</p>
<div class="informalexample">
<pre class="programlisting">payload-expression="#extension.json"
payload-expression="#extension.bodies[0]"</pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="xmpp-message-outbound-channel-adapter" href="#xmpp-message-outbound-channel-adapter"></a>39.2.2&nbsp;Outbound Message Channel Adapter</h3></div></div></div>

<p>You can also send chat messages to other users on XMPP by using the outbound message channel adapter.
The <code class="literal">outbound-channel-adapter</code> element provides configuration support for the XMPP outbound message channel adapter.</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-xmpp:outbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"outboundEventAdapter"</span>
						<span class="hl-attribute">channel</span>=<span class="hl-value">"outboundEventChannel"</span>
						<span class="hl-attribute">xmpp-connection</span>=<span class="hl-value">"testConnection"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>The adapter expects its input to be (at a minimum) a payload of type <code class="literal">java.lang.String</code> and a header value for <code class="literal">XmppHeaders.CHAT_TO</code> that specifies to which user the message should be sent.
To create a message, you can use Java code similar to the following:</p>
<div class="informalexample">
<pre class="programlisting">Message&lt;String&gt; xmppOutboundMsg = MessageBuilder.withPayload(<span class="hl-string">"Hello, XMPP!"</span> )
						.setHeader(XmppHeaders.CHAT_TO, <span class="hl-string">"userhandle"</span>)
						.build();</pre>
</div>
<p>You can also set the header by using the XMPP header-enricher support, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-xmpp:header-enricher</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"input"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"output"</span><span class="hl-tag">&gt;</span>
	<span class="hl-tag">&lt;int-xmpp:chat-to</span> <span class="hl-attribute">value</span>=<span class="hl-value">"test1@example.org"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-xmpp:header-enricher&gt;</span></pre>
</div>
<p>Starting with version 4.3, the packet extension support has been added to the <code class="literal">ChatMessageSendingMessageHandler</code> (the <code class="literal">&lt;int-xmpp:outbound-channel-adapter&gt;</code> in XML configuration).
Along with the regular <code class="literal">String</code> and <code class="literal">org.jivesoftware.smack.packet.Message</code> payload, now you can send a message with a payload of <code class="literal">org.jivesoftware.smack.packet.ExtensionElement</code> (which is populated to the <code class="literal">org.jivesoftware.smack.packet.Message.addExtension()</code>) instead of <code class="literal">setBody()</code>.
For convenience, we added an <code class="literal">extension-provider</code> option for the <code class="literal">ChatMessageSendingMessageHandler</code>.
It lets you inject <code class="literal">org.jivesoftware.smack.provider.ExtensionElementProvider</code>, which builds an <code class="literal">ExtensionElement</code> against the payload at runtime.
For this case, the payload must be a string in JSON or XML format, depending of the XEP protocol.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xmpp-presence" href="#xmpp-presence"></a>39.3&nbsp;XMPP Presence</h2></div></div></div>

<p>XMPP also supports broadcasting state.
You can use this ability to let people who have you on their roster see your state changes.
This happens all the time with your IM clients.
You change your away status and set an away message, and everybody who has you on their roster sees your icon or username change to reflect this new state and might see your new "<code class="literal">away</code>" message.
If you would like to receive notifications or notify others of state changes, you can use Spring Integration&#8217;s "<code class="literal">presence</code>" adapters.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="xmpp-roster-inbound-channel-adapter" href="#xmpp-roster-inbound-channel-adapter"></a>39.3.1&nbsp;Inbound Presence Message Channel Adapter</h3></div></div></div>

<p>Spring Integration provides an inbound presence message channel adapter, which supports receiving presence events from other users in the system who are on your roster.
To do this, the adapter "<code class="literal">logs in</code>" as a user on your behalf, registers a <code class="literal">RosterListener</code>, and forwards received presence update events as messages to the channel identified by the <code class="literal">channel</code> attribute.
The payload of the message is a <code class="literal">org.jivesoftware.smack.packet.Presence</code> object (see <a class="ulink" href="https://www.igniterealtime.org/builds/smack/docs/latest/javadoc/org/jivesoftware/smack/packet/Presence.html" target="_top">https://www.igniterealtime.org/builds/smack/docs/latest/javadoc/org/jivesoftware/smack/packet/Presence.html</a>).</p>
<p>The <code class="literal">presence-inbound-channel-adapter</code> element provides configuration support for the XMPP inbound presence message channel adapter.
The following example configures an inbound presence message channel adapter:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-xmpp:presence-inbound-channel-adapter</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"outChannel"</span>
		<span class="hl-attribute">xmpp-connection</span>=<span class="hl-value">"testConnection"</span> <span class="hl-attribute">auto-startup</span>=<span class="hl-value">"false"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>Along with the usual attributes, this adapter requires a reference to an XMPP Connection.
This adapter is event-driven and a <code class="literal">Lifecycle</code> implementation.
It registers a <code class="literal">RosterListener</code> when started and unregisters that <code class="literal">RosterListener</code> when stopped.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="xmpp-roster-outbound-channel-adapter" href="#xmpp-roster-outbound-channel-adapter"></a>39.3.2&nbsp;Outbound Presence Message Channel Adapter</h3></div></div></div>

<p>Spring Integration also supports sending presence events to be seen by other users in the network who happen to have you on their roster.
When you send a message to the outbound presence message channel adapter, it extracts the payload (which is expected to be of type <code class="literal">org.jivesoftware.smack.packet.Presence</code>) and sends it to the XMPP Connection, thus advertising your presence events to the rest of the network.</p>
<p>The <code class="literal">presence-outbound-channel-adapter</code> element provides configuration support for the XMPP outbound presence message channel adapter.
The following example shows how to configure an outbound presence message channel adapter:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-xmpp:presence-outbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"eventOutboundPresenceChannel"</span>
	<span class="hl-attribute">xmpp-connection</span>=<span class="hl-value">"testConnection"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>It can also be a polling consumer (if it receives messages from a pollable channel) in which case you would need to register a poller.
The following example shows how to do so:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-xmpp:presence-outbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"pollingOutboundPresenceAdapter"</span>
		<span class="hl-attribute">xmpp-connection</span>=<span class="hl-value">"testConnection"</span>
		<span class="hl-attribute">channel</span>=<span class="hl-value">"pollingChannel"</span><span class="hl-tag">&gt;</span>
	<span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"1000"</span> <span class="hl-attribute">max-messages-per-poll</span>=<span class="hl-value">"1"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-xmpp:presence-outbound-channel-adapter&gt;</span></pre>
</div>
<p>Like its inbound counterpart, it requires a reference to an XMPP Connection.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>If you rely on the default naming convention for an XMPP Connection bean (<a class="link" href="#xmpp-connection" title="39.1&nbsp;XMPP Connection">described earlier</a>) and you have only one XMPP Connection bean configured in your application context, you can omit the <code class="literal">xmpp-connection</code> attribute.
In that case, the bean with named <code class="literal">xmppConnection</code> is located and injected into the adapter.</p>
</td></tr></table></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xmpp-advanced" href="#xmpp-advanced"></a>39.4&nbsp;Advanced Configuration</h2></div></div></div>

<p>Spring Integration&#8217;s XMPP support is based on the Smack 4.0 API (<a class="ulink" href="http://www.igniterealtime.org/projects/smack/" target="_top">http://www.igniterealtime.org/projects/smack/</a>), which allows more complex configuration of the XMPP Connection object.</p>
<p>As <a class="link" href="#xmpp-connection" title="39.1&nbsp;XMPP Connection">stated earlier</a>, the <code class="literal">xmpp-connection</code> namespace support is designed to simplify basic connection configuration and supports only a few common configuration attributes.
However, the <code class="literal">org.jivesoftware.smack.ConnectionConfiguration</code> object defines about 20 attributes, and adding namespace support for all of them offers no real value.
So, for more complex connection configurations, you can configure an instance of our <code class="literal">XmppConnectionFactoryBean</code> as a regular bean and inject a <code class="literal">org.jivesoftware.smack.ConnectionConfiguration</code> as a constructor argument to that <code class="literal">FactoryBean</code>.
You can specify every property you need directly on that <code class="literal">ConnectionConfiguration</code> instance.
(A bean definition with the <span class="emphasis"><em>p</em></span> namespace would work well.)
This way, you can directly set SSL (or any other attributes).
The following example shows how to do so:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"xmppConnection"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.xmpp.XmppConnectionFactoryBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.jivesoftware.smack.ConnectionConfiguration"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"myServiceName"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"socketFactory"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"..."</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/bean&gt;</span>
    <span class="hl-tag">&lt;/constructor-arg&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"outboundEventChannel"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int-xmpp:outbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"outboundEventAdapter"</span>
    <span class="hl-attribute">channel</span>=<span class="hl-value">"outboundEventChannel"</span>
    <span class="hl-attribute">xmpp-connection</span>=<span class="hl-value">"xmppConnection"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>The Smack API also offers static initializers, which can be helpful.
For more complex cases (such as registering a SASL mechanism), you may need to execute certain static initializers.
One of those static initializers is <code class="literal">SASLAuthentication</code>, which lets you register supported SASL mechanisms.
For that level of complexity, we recommend using Spring Java configuration for the XMPP connection configuration.
That way, you can configure the entire component through Java code and execute all other necessary Java code, including static initializers, at the appropriate time.
The following exampe shows how to configure an XMPP connection with an SASL (Simple Authentication and Security Layer) in Java:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Configuration</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> CustomConnectionConfiguration {
  <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
  <span class="hl-keyword">public</span> XMPPConnection xmppConnection() {
	SASLAuthentication.supportSASLMechanism(<span class="hl-string">"EXTERNAL"</span>, <span class="hl-number">0</span>); <span class="hl-comment">// static initializer</span>

	ConnectionConfiguration config = <span class="hl-keyword">new</span> ConnectionConfiguration(<span class="hl-string">"localhost"</span>, <span class="hl-number">5223</span>);
	config.setTrustorePath(<span class="hl-string">"path_to_truststore.jks"</span>);
	config.setSecurityEnabled(true);
	config.setSocketFactory(SSLSocketFactory.getDefault());
	<span class="hl-keyword">return</span> <span class="hl-keyword">new</span> XMPPConnection(config);
  }
}</pre>
</div>
<p>For more information on using Java for application context configuration, see the following section in the <a class="ulink" href="http://docs.spring.io/spring/docs/current/spring-framework-reference/html/beans.html#beans-java" target="_top">Spring Reference Manual</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xmpp-message-headers" href="#xmpp-message-headers"></a>39.5&nbsp;XMPP Message Headers</h2></div></div></div>

<p>The Spring Integration XMPP Adapters automatically map standard XMPP properties.
By default, these properties are copied to and from Spring Integration <code class="literal">MessageHeaders</code> by using
<a class="ulink" href="http://docs.spring.io/spring-integration/api/org/springframework/integration/xmpp/support/DefaultXmppHeaderMapper.html" target="_top"><code class="literal">DefaultXmppHeaderMapper</code></a>.</p>
<p>Any user-defined headers are not copied to or from an XMPP Message, unless explicitly specified by the <code class="literal">requestHeaderNames</code> or <code class="literal">replyHeaderNames</code> properties of the <code class="literal">DefaultXmppHeaderMapper</code>.</p>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>When mapping user-defined headers, the values can also contain simple wildcard patterns (such "thing*" or "*thing").</p>
</td></tr></table></div>
<p>Starting with version 4.1, <code class="literal">AbstractHeaderMapper</code> (a superclass of <code class="literal">DefaultXmppHeaderMapper</code>) lets you configure the <code class="literal">NON_STANDARD_HEADERS</code> token for the <code class="literal">requestHeaderNames</code> property (in addition to <code class="literal">STANDARD_REQUEST_HEADERS</code>), to map all user-defined headers.</p>
<p>The <code class="literal">org.springframework.xmpp.XmppHeaders</code> class identifies the default headers to be used by the <code class="literal">DefaultXmppHeaderMapper</code>:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">xmpp_from</code>
</li><li class="listitem">
<code class="literal">xmpp_subject</code>
</li><li class="listitem">
<code class="literal">xmpp_thread</code>
</li><li class="listitem">
<code class="literal">xmpp_to</code>
</li><li class="listitem">
<code class="literal">xmpp_type</code>
</li></ul></div>
<p>Starting with version 4.3, you can negate patterns in the header mappings by preceding the pattern with <code class="literal">!</code>.
Negated patterns get priority, so a list such as <code class="literal">STANDARD_REQUEST_HEADERS,thing1,thing*,!thing2,!thing3,qux,!thing1</code> does not map <code class="literal">thing1</code>, <code class="literal">thing2</code>,or <code class="literal">thing3</code>.
That list does map the standard headers plus <code class="literal">thing4</code> and <code class="literal">qux</code>.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>If you have a user-defined header that begins with <code class="literal">!</code> that you do wish to map, can escape it with <code class="literal">\</code> thus: <code class="literal">STANDARD_REQUEST_HEADERS,\!myBangHeader</code>.
In that example, the standard request headers and <code class="literal">!myBangHeader</code> are mapped.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="xmpp-extensions" href="#xmpp-extensions"></a>39.6&nbsp;XMPP Extensions</h2></div></div></div>

<p>Extensions put the "<code class="literal">Extensible</code>" in the "<code class="literal">Extensible Messaging and Presence Protocol</code>".</p>
<p>XMPP is based around XML, a data format that supports a concept known as namespacing.
Through namespacing, you can add bits to XMPP that are not defined in the original specifications.
The XMPP specification deliberately describes only a set of core features:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
How a client connects to a server
</li><li class="listitem">
Encryption (SSL/TLS)
</li><li class="listitem">
Authentication
</li><li class="listitem">
How servers can communicate with each other to relay messages
</li><li class="listitem">
A few other basic building blocks
</li></ul></div>
<p>Once you have implemented this, you have an XMPP client and can send any kind of data you like.
However, you may need to do more than the basics.
For example, you might need to include formatting (bold, italic, and so on) in a message, which is not defined in the core XMPP specification.
Well, you can make up a way to do that, but, unless everyone else does it the same way you do, no other software can interpret it (they ignore namespaces they cannot understand).</p>
<p>To solve that problem, the XMPP Standards Foundation (XSF) publishes a series of extra documents, known as <a class="ulink" href="http://xmpp.org/extensions/xep-0001.html" target="_top">XMPP Enhancement Proposals</a> (XEPs).
In general, each XEP describes a particular activity (from message formatting to file transfers, multi-user chats, and many more).
They also provide a standard format for everyone to use for that activity.</p>
<p>The Smack API provides many XEP implementations with its <code class="literal">extensions</code> and <code class="literal">experimental</code> <a class="ulink" href="http://www.igniterealtime.org/builds/smack/docs/latest/documentation/extensions/index.html" target="_top">projects</a>.
Starting with Spring Integration version 4.3, you can use any XEP with the existing XMPP channel adapters.</p>
<p>To be able to process XEPs or any other custom XMPP extensions, you must provide the Smack&#8217;s <code class="literal">ProviderManager</code> pre-configuration.
You can do so with <code class="literal">static</code> Java code, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting">ProviderManager.addIQProvider(<span class="hl-string">"element"</span>, <span class="hl-string">"namespace"</span>, <span class="hl-keyword">new</span> MyIQProvider());
ProviderManager.addExtensionProvider(<span class="hl-string">"element"</span>, <span class="hl-string">"namespace"</span>, <span class="hl-keyword">new</span> MyExtProvider());</pre>
</div>
<p>You can also use a  <code class="literal">.providers</code> configuration file in the specific instance and access it with a JVM argument, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting">-Dsmack.provider.file=file:///c:/my/provider/mycustom.providers</pre>
</div>
<p>The <code class="literal">mycustom.providers</code> file might be as follows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0"?&gt;</span>
<span class="hl-tag">&lt;smackProviders&gt;</span>
<span class="hl-tag">&lt;iqProvider&gt;</span>
    <span class="hl-tag">&lt;elementName&gt;</span>query<span class="hl-tag">&lt;/elementName&gt;</span>
    <span class="hl-tag">&lt;namespace&gt;</span>jabber:iq:time<span class="hl-tag">&lt;/namespace&gt;</span>
    <span class="hl-tag">&lt;className&gt;</span>org.jivesoftware.smack.packet.Time<span class="hl-tag">&lt;/className&gt;</span>
<span class="hl-tag">&lt;/iqProvider&gt;</span>

<span class="hl-tag">&lt;iqProvider&gt;</span>
    <span class="hl-tag">&lt;elementName&gt;</span>query<span class="hl-tag">&lt;/elementName&gt;</span>
    <span class="hl-tag">&lt;namespace&gt;</span>http://jabber.org/protocol/disco#items<span class="hl-tag">&lt;/namespace&gt;</span>
    <span class="hl-tag">&lt;className&gt;</span>org.jivesoftware.smackx.provider.DiscoverItemsProvider<span class="hl-tag">&lt;/className&gt;</span>
<span class="hl-tag">&lt;/iqProvider&gt;</span>

<span class="hl-tag">&lt;extensionProvider&gt;</span>
    <span class="hl-tag">&lt;elementName&gt;</span>subscription<span class="hl-tag">&lt;/elementName&gt;</span>
    <span class="hl-tag">&lt;namespace&gt;</span>http://jabber.org/protocol/pubsub<span class="hl-tag">&lt;/namespace&gt;</span>
    <span class="hl-tag">&lt;className&gt;</span>org.jivesoftware.smackx.pubsub.provider.SubscriptionProvider<span class="hl-tag">&lt;/className&gt;</span>
<span class="hl-tag">&lt;/extensionProvider&gt;</span>
<span class="hl-tag">&lt;/smackProviders&gt;</span></pre>
</div>
<p>For example, the most popular XMPP messaging extension is <a class="ulink" href="https://developers.google.com/cloud-messaging/" target="_top">Google Cloud Messaging</a> (GCM).
The Smack library provides <code class="literal">org.jivesoftware.smackx.gcm.provider.GcmExtensionProvider</code> for that purposes.
By default, it registers that class with the <code class="literal">smack-experimental</code> jar in the classpath by using the <code class="literal">experimental.providers</code> resource, as the following Maven example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-comment">&lt;!-- GCM JSON payload --&gt;</span>
<span class="hl-tag">&lt;extensionProvider&gt;</span>
    <span class="hl-tag">&lt;elementName&gt;</span>gcm<span class="hl-tag">&lt;/elementName&gt;</span>
    <span class="hl-tag">&lt;namespace&gt;</span>google:mobile:data<span class="hl-tag">&lt;/namespace&gt;</span>
    <span class="hl-tag">&lt;className&gt;</span>org.jivesoftware.smackx.gcm.provider.GcmExtensionProvider<span class="hl-tag">&lt;/className&gt;</span>
<span class="hl-tag">&lt;/extensionProvider&gt;</span></pre>
</div>
<p>Also, the <code class="literal">GcmPacketExtension</code> lets the target messaging protocol parse incoming packets and build outgoing packets, as the following examples show:</p>
<div class="informalexample">
<pre class="programlisting">GcmPacketExtension gcmExtension = (GcmPacketExtension) xmppMessage.getExtension(GcmPacketExtension.NAMESPACE);
String message = gcmExtension.getJson());</pre>
<pre class="programlisting">GcmPacketExtension packetExtension = <span class="hl-keyword">new</span> GcmPacketExtension(gcmJson);
Message smackMessage = <span class="hl-keyword">new</span> Message();
smackMessage.addExtension(packetExtension);</pre>
</div>
<p>See <a class="xref" href="#xmpp-message-inbound-channel-adapter" title="39.2.1&nbsp;Inbound Message Channel Adapter">Section&nbsp;39.2.1, &#8220;Inbound Message Channel Adapter&#8221;</a> and <a class="xref" href="#xmpp-message-outbound-channel-adapter" title="39.2.2&nbsp;Outbound Message Channel Adapter">Section&nbsp;39.2.2, &#8220;Outbound Message Channel Adapter&#8221;</a> earlier in this chapter for more information.</p>
</div>
</div>
<div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="zookeeper" href="#zookeeper"></a>40.&nbsp;Zookeeper Support</h2></div></div></div>

<p>Version 4.2 added <a class="ulink" href="https://zookeeper.apache.org/" target="_top">Zookeeper</a> support to the framework in version 4.2, which consists of:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="#zk-metadata-store" title="40.1&nbsp;Zookeeper Metadata Store">A metadata store</a>
</li><li class="listitem">
<a class="link" href="#zk-lock-registry" title="40.2&nbsp;Zookeeper Lock Registry">A lock registry</a>
</li><li class="listitem">
<a class="link" href="#zk-leadership" title="40.3&nbsp;Zookeeper Leadership Event Handling">Leadership event handling</a>
</li></ul></div>
<p>You need to include this dependency into your project:</p>
<div class="informalexample">
<p>
<b>Maven.&nbsp;</b>

</p><pre class="programlisting"><span class="hl-tag">&lt;dependency&gt;</span>
    <span class="hl-tag">&lt;groupId&gt;</span>org.springframework.integration<span class="hl-tag">&lt;/groupId&gt;</span>
    <span class="hl-tag">&lt;artifactId&gt;</span>spring-integration-zookeeper<span class="hl-tag">&lt;/artifactId&gt;</span>
    <span class="hl-tag">&lt;version&gt;</span>5.1.2.RELEASE<span class="hl-tag">&lt;/version&gt;</span>
<span class="hl-tag">&lt;/dependency&gt;</span></pre><p>

</p>
<p>
<b>Gradle.&nbsp;</b>

</p><pre class="programlisting">compile <span class="hl-string">"org.springframework.integration:spring-integration-zookeeper:5.1.2.RELEASE"</span></pre><p>

</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="zk-metadata-store" href="#zk-metadata-store"></a>40.1&nbsp;Zookeeper Metadata Store</h2></div></div></div>

<p>You ca use the <code class="literal">ZookeeperMetadataStore</code> where any <code class="literal">MetadataStore</code> is needed, such as for persistent file list filters.
See <a class="xref" href="#metadata-store" title="12.5&nbsp;Metadata Store">Section&nbsp;12.5, &#8220;Metadata Store&#8221;</a> for more information.
The following example configures a Zookeeper metadata store with XML:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"client"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.zookeeper.config.CuratorFrameworkFactoryBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"${connect.string}"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"meta"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.zookeeper.metadata.ZookeeperMetadataStore"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"client"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
</div>
<p>The following example shows how to configure a Zookeeper metadata store with Java:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> MetadataStore zkStore(CuratorFramework client) {
    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> ZookeeperMetadataStore(client);
}</pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="zk-lock-registry" href="#zk-lock-registry"></a>40.2&nbsp;Zookeeper Lock Registry</h2></div></div></div>

<p>The <code class="literal">ZookeeperLockRegistry</code> can be used where any <code class="literal">LockRegistry</code> is needed, such as when using an aggregator in a clustered environment with a shared <code class="literal">MessageStore</code>.</p>
<p>A <code class="literal">LockRegistry</code> is used to "<code class="literal">look up</code>" a lock based on a key (the aggregator uses <code class="literal">correlationId</code>).
By default, locks in the <code class="literal">ZookeeperLockRegistry</code> are maintained in zookeeper under the following path: <code class="literal">/SpringIntegration-LockRegistry/</code>.
You can customize the path by providing an implementation of <code class="literal">ZookeeperLockRegistry.KeyToPathStrategy</code>, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> KeyToPathStrategy {

    String pathFor(String key);

    <span class="hl-keyword">boolean</span> bounded();

}</pre>
</div>
<p>If the strategy returns <code class="literal">true</code> from <code class="literal">isBounded</code>, unused locks do not need to be harvested.
For unbounded strategies (such as the default), you need to periodically invoke <code class="literal">expireUnusedOlderThan(long age)</code> to remove old unused locks from memory.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="zk-leadership" href="#zk-leadership"></a>40.3&nbsp;Zookeeper Leadership Event Handling</h2></div></div></div>

<p>The following example uses XML to configure an application for leader election in Zookeeper:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-zk:leader-listener</span> <span class="hl-attribute">client</span>=<span class="hl-value">"client"</span> <span class="hl-attribute">path</span>=<span class="hl-value">"/siNamespace"</span> <span class="hl-attribute">role</span>=<span class="hl-value">"cluster"</span><span class="hl-tag"> /&gt;</span></pre>
</div>
<p><code class="literal">client</code> is a reference to a <code class="literal">CuratorFramework</code> bean.
A <code class="literal">CuratorFrameworkFactoryBean</code> is available.
When a leader is elected, an <code class="literal">OnGrantedEvent</code> is published for the role <code class="literal">cluster</code>.
Any endpoints in that role are started.
When leadership is revoked, an <code class="literal">OnRevokedEvent</code> is published for the role <code class="literal">cluster</code>.
Any endpoints in that role are stopped.
See <a class="xref" href="#endpoint-roles" title="10.2&nbsp;Endpoint Roles">Section&nbsp;10.2, &#8220;Endpoint Roles&#8221;</a> for more information.</p>
<p>You can use Java configuration to create an instance of the leader initiator, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> LeaderInitiatorFactoryBean leaderInitiator(CuratorFramework client) {
    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> LeaderInitiatorFactoryBean()
                .setClient(client)
                .setPath(<span class="hl-string">"/siTest/"</span>)
                .setRole(<span class="hl-string">"cluster"</span>);
}</pre>
</div>
</div>
</div>
</div>
<div class="part"><div class="titlepage"><div><div><h1 class="title"><a name="spring-integration-appendices" href="#spring-integration-appendices"></a>Part&nbsp;VI.&nbsp;Appendices</h1></div></div></div>

<div class="partintro"><div></div>
<p>Advanced Topics and Additional Resources</p>
</div>
<div class="appendix"><div class="titlepage"><div><div><h2 class="title"><a name="spel" href="#spel"></a>Appendix&nbsp;A.&nbsp;Spring Expression Language (SpEL)</h2></div></div></div>

<p>You can configure many Spring Integration components by using expressions written in the <a class="ulink" href="http://static.springsource.org/spring-framework/docs/current/spring-framework-reference/html/expressions.html" target="_top">Spring Expression Language</a>.</p>
<p>In most cases, the <code class="literal">#root</code> object is the <code class="literal">Message</code>, which has two properties (<code class="literal">headers</code> and <code class="literal">payload</code>) that allow such expressions as <code class="literal">payload</code>, <code class="literal">payload.thing</code>, <code class="literal">headers['my.header']</code>, and so on.</p>
<p>In some cases, additional variables are provided.
For example, <code class="literal">&lt;int-http:inbound-gateway/&gt;</code> provides <code class="literal">#requestParams</code> (parameters from the HTTP request) and <code class="literal">#pathVariables</code> (values from path placeholders in the URI).</p>
<p>For all SpEL expressions, a <code class="literal">BeanResolver</code> is available to enable references to any bean in the application context (for example, <code class="literal">@myBean.foo(payload)</code>).
In addition, two <code class="literal">PropertyAccessors</code> are available.
A <code class="literal">MapAccessor</code> enables accessing values in a <code class="literal">Map</code> by using a key and a <code class="literal">ReflectivePropertyAccessor</code>, which allows access to fields and JavaBean compliant properties (by using getters and setters).
This is how you can access the <code class="literal">Message</code> headers and payload properties.</p>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="spel-customization" href="#spel-customization"></a>A.1&nbsp;SpEL Evaluation Context Customization</h2></div></div></div>

<p>Starting with Spring Integration 3.0, you can add additional <code class="literal">PropertyAccessor</code> instances to the SpEL evaluation contexts used by the framework.
The framework provides the (read-only) <code class="literal">JsonPropertyAccessor</code>, which you can use to access fields from a <code class="literal">JsonNode</code> or JSON in a <code class="literal">String</code>.
You can also create your own <code class="literal">PropertyAccessor</code> if you have specific needs.</p>
<p>In addition, you can add custom functions.
Custom functions are <code class="literal">static</code> methods declared on a class.
Functions and property accessors are available in any SpEL expression used throughout the framework.</p>
<p>The following configuration shows how to directly configure the <code class="literal">IntegrationEvaluationContextFactoryBean</code> with custom property accessors and functions:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"integrationEvaluationContext"</span>
			<span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.config.IntegrationEvaluationContextFactoryBean"</span><span class="hl-tag">&gt;</span>
	<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"propertyAccessors"</span><span class="hl-tag">&gt;</span>
		<span class="hl-tag">&lt;util:map&gt;</span>
			<span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"things"</span><span class="hl-tag">&gt;</span>
				<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"things.MyCustomPropertyAccessor"</span><span class="hl-tag">/&gt;</span>
			<span class="hl-tag">&lt;/entry&gt;</span>
		<span class="hl-tag">&lt;/util:map&gt;</span>
	<span class="hl-tag">&lt;/property&gt;</span>
	<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"functions"</span><span class="hl-tag">&gt;</span>
		<span class="hl-tag">&lt;map&gt;</span>
			<span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"barcalc"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"#{T(things.MyFunctions).getMethod('calc', T(things.MyThing))}"</span><span class="hl-tag">/&gt;</span>
		<span class="hl-tag">&lt;/map&gt;</span>
	<span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
</div>
<p>For convenience, Spring Integration provides namespace support for both property accessors and functions, as described in the following sections.
The framework automatically configures the factory bean on your behalf.</p>
<p>This factory bean definition overrides the default <code class="literal">integrationEvaluationContext</code> bean definition.
It adds the custom accessor and one custom function to the list (which also includes the standard accessors <a class="link" href="#spel" title="Appendix&nbsp;A.&nbsp;Spring Expression Language (SpEL)">mentioned earlier</a>).</p>
<p>Note that custom functions are static methods.
In the preceding example, the custom function is a static method called <code class="literal">calc</code> on a class called <code class="literal">MyFunctions</code> and takes a single parameter of type <code class="literal">MyThing</code>.</p>
<p>Suppose you have a <code class="literal">Message</code> with a payload that has a type of <code class="literal">MyThing</code>.
Further suppose that you need to perform some action to create an object called <code class="literal">MyObject</code> from <code class="literal">MyThing</code> and then invoke a custom function called <code class="literal">calc</code> on that object.</p>
<p>The standard property accessors do not know how to get a <code class="literal">MyObject</code> from a <code class="literal">MyThing</code>, so you could write and configure a custom property accessor to do so.
As a result, your final expression might be <code class="literal">"#barcalc(payload.myObject)"</code>.</p>
<p>The factory bean has another property (<code class="literal">typeLocator</code>), which lets you customize the <code class="literal">TypeLocator</code> used during SpEL evaluation.
You might need to do so running in some environments that use a non-standard <code class="literal">ClassLoader</code>.
In the following example, SpEL expressions always use the bean factory&#8217;s class loader:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"integrationEvaluationContext"</span>
		<span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.config.IntegrationEvaluationContextFactoryBean"</span><span class="hl-tag">&gt;</span>
	<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"typeLocator"</span><span class="hl-tag">&gt;</span>
		<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.expression.spel.support.StandardTypeLocator"</span><span class="hl-tag">&gt;</span>
			<span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"#{beanFactory.beanClassLoader}"</span><span class="hl-tag">/&gt;</span>
		<span class="hl-tag">&lt;/bean&gt;</span>
	<span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="spel-functions" href="#spel-functions"></a>A.2&nbsp;SpEL Functions</h2></div></div></div>

<p>Spring Integration provides namespace support to let you create SpEL custom functions.
You can specify <code class="literal">&lt;spel-function/&gt;</code> components to provide <a class="ulink" href="http://static.springsource.org/spring-framework/docs/current/spring-framework-reference/html/expressions.html#expressions-ref-functions" target="_top">custom SpEL functions</a> to the <code class="literal">EvaluationContext</code> used throughout the framework.
Instead of configuring the factory bean shown earlier, you can add one or more of these components, and the framework automatically adds them to the default <code class="literal">integrationEvaluationContext</code> factory bean.</p>
<p>For example, suppose you have a useful static method to evaluate XPath.
The following example shows how you can create a custom function to use that method:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:spel-function</span> <span class="hl-attribute">id</span>=<span class="hl-value">"xpath"</span>
	<span class="hl-attribute">class</span>=<span class="hl-value">"com.something.test.XPathUtils"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"evaluate(java.lang.String, java.lang.Object)"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;int:transformer</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"in"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"out"</span>
		 <span class="hl-attribute">expression</span>=<span class="hl-value">"#xpath('//things/@mythings', payload)"</span><span class="hl-tag"> /&gt;</span></pre>
</div>
<p>Given the preceding example:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
The default <code class="literal">IntegrationEvaluationContextFactoryBean</code> bean with an ID of <code class="literal">integrationEvaluationContext</code> is registered with the application context.
</li><li class="listitem">
The <code class="literal">&lt;spel-function/&gt;</code> is parsed and added to the <code class="literal">functions</code> <code class="literal">Map</code> of <code class="literal">integrationEvaluationContext</code> as a map entry with its <code class="literal">id</code> as the key and the static <code class="literal">Method</code> as the value.
</li><li class="listitem">
The <code class="literal">integrationEvaluationContext</code> factory bean creates a new <code class="literal">StandardEvaluationContext</code> instance, and it is configured with the default <code class="literal">PropertyAccessor</code> instances, a <code class="literal">BeanResolver</code>, and the custom functions.
</li><li class="listitem">
That <code class="literal">EvaluationContext</code> instance is injected into the <code class="literal">ExpressionEvaluatingTransformer</code> bean.
</li></ul></div>
<p>To provide a SpEL Function by using Java configuration, you can declare a <code class="literal">SpelFunctionFactoryBean</code> bean for each function.
The following example shows how to create a custom function:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> SpelFunctionFactoryBean xpath() {
    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> SpelFunctionFactoryBean(XPathUtils.<span class="hl-keyword">class</span>, <span class="hl-string">"evaluate"</span>);
}</pre>
</div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>SpEL functions declared in a parent context are also made available in any child contexts.
Each context has its own instance of the <code class="literal">integrationEvaluationContext</code> factory bean, because each needs a different <code class="literal">BeanResolver</code>, but the function declarations are inherited and can be overridden by declaring a SpEL function with the same name.</p>
</td></tr></table></div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_built_in_spel_functions" href="#_built_in_spel_functions"></a>A.2.1&nbsp;Built-in SpEL Functions</h3></div></div></div>

<p>Spring Integration provides the folloiwng  standard functions, which are registered with the application context automatically on start up:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<p class="simpara"><code class="literal">#jsonPath</code>: Evaluates a <span class="emphasis"><em>jsonPath</em></span> on a specified object.
This function invokes <code class="literal">JsonPathUtils.evaluate(...)</code>, which delegates to the <a class="ulink" href="http://code.google.com/p/json-path" target="_top">Jayway JsonPath library</a>.
The following listing shows some usage examples:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;transformer</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"#jsonPath(payload, '$.store.book[0].author')"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;filter</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"#jsonPath(payload,'$..book[2].isbn') matches '\d-\d{3}-\d{5}-\d'"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;splitter</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"#jsonPath(payload, '$.store.book')"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;router</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"#jsonPath(payload, headers.jsonPath)"</span><span class="hl-tag">&gt;</span>
	<span class="hl-tag">&lt;mapping</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"output1"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"reference"</span><span class="hl-tag">/&gt;</span>
	<span class="hl-tag">&lt;mapping</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"output2"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"fiction"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/router&gt;</span></pre>
</div>
<p class="simpara"><code class="literal">#jsonPath</code> also supports a third (optional) parameter: an array of <a class="ulink" href="https://github.com/jayway/JsonPath/blob/master/json-path/src/main/java/com/jayway/jsonpath/Filter.java" target="_top"><code class="literal">com.jayway.jsonpath.Filter</code></a>, which can be provided by a reference to a bean or bean method (for example).</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Using this function requires the Jayway JsonPath library (<code class="literal">json-path.jar</code>) to be on the classpath.
Otherwise the <code class="literal">#jsonPath</code> SpEL function is not registered.</p>
</td></tr></table></div>
<p class="simpara">For more information regarding JSON see <span class="emphasis"><em>JSON Transformers</em></span> in <a class="xref" href="#transformer" title="9.1&nbsp;Transformer">Section&nbsp;9.1, &#8220;Transformer&#8221;</a>.</p>
</li><li class="listitem">
<code class="literal">#xpath</code>: To evaluate an <span class="emphasis"><em>xpath</em></span> on some provided object.
For more information regarding XML and XPath, see <a class="xref" href="#xml" title="38.&nbsp;XML Support - Dealing with XML Payloads">Chapter&nbsp;38, <i>XML Support - Dealing with XML Payloads</i></a>.
</li></ul></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="spel-property-accessors" href="#spel-property-accessors"></a>A.3&nbsp;Property Accessors</h2></div></div></div>

<p>Spring Integration provides namespace support to let you create SpEL custom <a class="ulink" href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/expression/PropertyAccessor.html" target="_top"><code class="literal">PropertyAccessor</code></a> implementations.
You can use the <code class="literal">&lt;spel-property-accessors/&gt;</code> component to provide a list of custom <code class="literal">PropertyAccessor</code> instances to the <code class="literal">EvaluationContext</code> used throughout the framework.
Instead of configuring the factory bean shown earlier, you can add one or more of these components, and the framework automatically adds the accessors to the default <code class="literal">integrationEvaluationContext</code> factory bean.
The following example shows how to do so:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:spel-property-accessors&gt;</span>
	<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"jsonPA"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.json.JsonPropertyAccessor"</span><span class="hl-tag">/&gt;</span>
	<span class="hl-tag">&lt;ref</span> <span class="hl-attribute">bean</span>=<span class="hl-value">"fooPropertyAccessor"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:spel-property-accessors&gt;</span></pre>
</div>
<p>In the preceding example, two custom <code class="literal">PropertyAccessor</code> instances are injected into the <code class="literal">EvaluationContext</code> (in the order in which they are declared).</p>
<p>To provide <code class="literal">PropertyAccessor</code> instances by using Java Configuration, you should declare a <code class="literal">SpelPropertyAccessorRegistrar</code> bean with a name of <code class="literal">spelPropertyAccessorRegistrar</code> (dictated by the <code class="literal">IntegrationContextUtils.SPEL_PROPERTY_ACCESSOR_REGISTRAR_BEAN_NAME</code> constant).
The following example shows how to configure two custom <code class="literal">PropertyAccessor</code> instances with Java:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> SpelPropertyAccessorRegistrar spelPropertyAccessorRegistrar() {
    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> SpelPropertyAccessorRegistrar(<span class="hl-keyword">new</span> JsonPropertyAccessor())
                    .add(fooPropertyAccessor());
}</pre>
</div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Custom <code class="literal">PropertyAccessor</code> instances declared in a parent context are also made available in any child contexts.
They are placed at the end of result list (but before the default <code class="literal">org.springframework.context.expression.MapAccessor</code> and <code class="literal">o.s.expression.spel.support.ReflectivePropertyAccessor</code>).
If you declare a <code class="literal">PropertyAccessor</code> with the same bean ID in a child context, it overrides the parent accessor.
Beans declared within a <code class="literal">&lt;spel-property-accessors/&gt;</code> must have an <span class="emphasis"><em>id</em></span> attribute.
The final order of usage is as follows:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
The accessors in the current context, in the order in which they are declared
</li><li class="listitem">
Any accessors from parent contexts, in order
</li><li class="listitem">
The <code class="literal">MapAccessor</code>
</li><li class="listitem">
The <code class="literal">ReflectivePropertyAccessor</code>
</li></ul></div>
</td></tr></table></div>
</div>
</div>
<div class="appendix"><div class="titlepage"><div><div><h2 class="title"><a name="message-publishing" href="#message-publishing"></a>Appendix&nbsp;B.&nbsp;Message Publishing</h2></div></div></div>

<p>The (Aspect-oriented Programming) AOP message publishing feature lets you construct and send a message as a by-product of a method invocation.
For example, imagine you have a component and, every time the state of this component changes, you want to be notified by a message.
The easiest way to send such notifications is to send a message to a dedicated channel, but how would you connect the method invocation that changes the state of the object to a message sending process, and how should the notification message be structured?
The AOP message publishing feature handles these responsibilities with a configuration-driven approach.</p>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="message-publishing-config" href="#message-publishing-config"></a>B.1&nbsp;Message Publishing Configuration</h2></div></div></div>

<p>Spring Integration provides two approaches: XML configuration and annotation-driven (Java) configuration.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="publisher-annotation" href="#publisher-annotation"></a>B.1.1&nbsp;Annotation-driven Configuration with the <code class="literal">@Publisher</code> Annotation</h3></div></div></div>

<p>The annotation-driven approach lets you annotate any method with the <code class="literal">@Publisher</code> annotation to specify a <span class="emphasis"><em>channel</em></span> attribute.
Starting with version 5.1, to switch this functionality on, you must use the <code class="literal">@EnablePublisher</code> annotation on some <code class="literal">@Configuration</code> class.
See <a class="xref" href="#configuration-enable-integration" title="5.5&nbsp;Configuration and @EnableIntegration">Section&nbsp;5.5, &#8220;Configuration and <code class="literal">@EnableIntegration</code>&#8221;</a> for more information.
The message is constructed from the return value of the method invocation and sent to the channel specified by the <span class="emphasis"><em>channel</em></span> attribute.
To further manage message structure, you can also use a combination of both <code class="literal">@Payload</code> and <code class="literal">@Header</code> annotations.</p>
<p>Internally, this message publishing feature of Spring Integration uses both Spring AOP by defining <code class="literal">PublisherAnnotationAdvisor</code> and the Spring Expression Language (SpEL), giving you considerable flexibility and control over the structure of the <code class="literal">Message</code> it publishes.</p>
<p>The <code class="literal">PublisherAnnotationAdvisor</code> defines and binds the following variables:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">#return</code>: Binds to a return value, letting you reference it or its attributes (for example, <code class="literal">#return.something</code>, where <span class="emphasis"><em>something</em></span> is an attribute of the object bound to <code class="literal">#return</code>)
</li><li class="listitem">
<code class="literal">#exception</code>: Binds to an exception if one is thrown by the method invocation
</li><li class="listitem">
<code class="literal">#args</code>: Binds to method arguments so that you can extract individual arguments by name (for example, <code class="literal">#args.fname</code>)
</li></ul></div>
<p>Consider the following example:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Publisher</span></em>
<span class="hl-keyword">public</span> String defaultPayload(String fname, String lname) {
  <span class="hl-keyword">return</span> fname + <span class="hl-string">" "</span> + lname;
}</pre>
</div>
<p>In the preceding example, the message is constructed with the following structure:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
The message payload is the return type and value of the method.
This is the default.
</li><li class="listitem">
A newly constructed message is sent to a default publisher channel that is configured with an annotation post processor (covered later in this section).
</li></ul></div>
<p>The following example is the same as the preceding example, except that it does not use a default publishing channel:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Publisher(channel="testChannel")</span></em>
<span class="hl-keyword">public</span> String defaultPayload(String fname, <em><span class="hl-annotation" style="color: gray">@Header("last")</span></em> String lname) {
  <span class="hl-keyword">return</span> fname + <span class="hl-string">" "</span> + lname;
}</pre>
</div>
<p>Instead of using a default publishing channel, we specify the publishing channel by setting the <span class="emphasis"><em>channel</em></span> attribute of the <code class="literal">@Publisher</code> annotation.
We also add a <code class="literal">@Header</code> annotation, which results in the message header named <span class="emphasis"><em>last</em></span> having the same value as the <span class="emphasis"><em>lname</em></span> method parameter.
That header is added to the newly constructed message.</p>
<p>The following example is almost identical to the preceding example:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Publisher(channel="testChannel")</span></em>
<em><span class="hl-annotation" style="color: gray">@Payload</span></em>
<span class="hl-keyword">public</span> String defaultPayloadButExplicitAnnotation(String fname, <em><span class="hl-annotation" style="color: gray">@Header</span></em> String lname) {
  <span class="hl-keyword">return</span> fname + <span class="hl-string">" "</span> + lname;
}</pre>
</div>
<p>The only difference is that we use a <code class="literal">@Payload</code> annotation on the method to explicitly specify that the return value of the method should be used as the payload of the message.</p>
<p>The following example expands on the previous configuration by using the Spring Expression Language in the <code class="literal">@Payload</code> annotation to further instruct the framework about how the message should be constructed:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Publisher(channel="testChannel")</span></em>
<em><span class="hl-annotation" style="color: gray">@Payload("#return + #args.lname")</span></em>
<span class="hl-keyword">public</span> String setName(String fname, String lname, <em><span class="hl-annotation" style="color: gray">@Header("x")</span></em> <span class="hl-keyword">int</span> num) {
  <span class="hl-keyword">return</span> fname + <span class="hl-string">" "</span> + lname;
}</pre>
</div>
<p>In the preceding example, the message is a concatenation of the return value of the method invocation and the <span class="emphasis"><em>lname</em></span> input argument.
The Message header named <span class="emphasis"><em>x</em></span> has its value determined by the <span class="emphasis"><em>num</em></span> input argument.
That header is added to the newly constructed message.</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Publisher(channel="testChannel")</span></em>
<span class="hl-keyword">public</span> String argumentAsPayload(<em><span class="hl-annotation" style="color: gray">@Payload</span></em> String fname, <em><span class="hl-annotation" style="color: gray">@Header</span></em> String lname) {
  <span class="hl-keyword">return</span> fname + <span class="hl-string">" "</span> + lname;
}</pre>
</div>
<p>In the preceding example, you see another usage of the <code class="literal">@Payload</code> annotation.
Here, we annotate a method argument that becomes the payload of the newly constructed message.</p>
<p>As with most other annotation-driven features in Spring, you need to register a post-processor (<code class="literal">PublisherAnnotationBeanPostProcessor</code>).
The following example shows how to do so:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.aop.PublisherAnnotationBeanPostProcessor"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>For a more concise configuration, you can instead use namespace support, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:annotation-config&gt;</span>
    <span class="hl-tag">&lt;int:enable-publisher</span> <span class="hl-attribute">default-publisher-channel</span>=<span class="hl-value">"defaultChannel"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:annotation-config&gt;</span></pre>
</div>
<p>For Java configuration, you must use the <code class="literal">@EnablePublisher</code> annotation, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Configuration</span></em>
<em><span class="hl-annotation" style="color: gray">@EnableIntegration</span></em>
<em><span class="hl-annotation" style="color: gray">@EnablePublisher("defaultChannel")</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> IntegrationConfiguration {
    ...
}</pre>
</div>
<p>Similar to other Spring annotations (<code class="literal">@Component</code>, <code class="literal">@Scheduled</code>, and so on), you can also use <code class="literal">@Publisher</code> as a meta-annotation.
This means that you can define your own annotations that are treated in the same way as the <code class="literal">@Publisher</code> itself.
The following example shows how to do so:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Target({ElementType.METHOD, ElementType.TYPE})</span></em>
<em><span class="hl-annotation" style="color: gray">@Retention(RetentionPolicy.RUNTIME)</span></em>
<em><span class="hl-annotation" style="color: gray">@Publisher(channel="auditChannel")</span></em>
<span class="hl-keyword">public</span> <em><span class="hl-annotation" style="color: gray">@interface</span></em> Audit {
...
}</pre>
</div>
<p>In the preceding example, we define the <code class="literal">@Audit</code> annotation, which is itself annotated with <code class="literal">@Publisher</code>.
Also note that you can define a <code class="literal">channel</code> attribute on the meta-annotation to encapsulate where messages are sent inside of this annotation.
Now you can annotate any method with the <code class="literal">@Audit</code> annotation, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Audit</span></em>
<span class="hl-keyword">public</span> String test() {
&nbsp;&nbsp; &nbsp;<span class="hl-keyword">return</span> <span class="hl-string">"Hello"</span>;
}</pre>
</div>
<p>In the preceding example, every invocation of the <code class="literal">test()</code> method results in a message with a payload created from its return value.
Each message is sent to&nbsp;the channel named <code class="literal">auditChannel</code>.
One of the benefits of this technique is that you can avoid the duplication of the same channel name across multiple annotations.
You also can provide a level of indirection between your own, potentially domain-specific, annotations and those provided by the framework.</p>
<p>You can also annotate the class, which lets you apply the properties of this annotation on every public method of that class, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Audit</span></em>
<span class="hl-keyword">static</span> <span class="hl-keyword">class</span> BankingOperationsImpl&nbsp;<span class="hl-keyword">implements</span>&nbsp;BankingOperations&nbsp;{

&nbsp;&nbsp;<span class="hl-keyword">public</span> String debit(String amount) {
&nbsp;&nbsp; &nbsp; . . .

&nbsp;&nbsp;}

&nbsp;&nbsp;<span class="hl-keyword">public</span>&nbsp;String credit(String amount) {
&nbsp;&nbsp; &nbsp; . . .
&nbsp;&nbsp;}

}</pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="aop-based-interceptor" href="#aop-based-interceptor"></a>B.1.2&nbsp;XML-based Approach with the <code class="literal">&lt;publishing-interceptor&gt;</code> element</h3></div></div></div>

<p>The XML-based approach lets you configure the same AOP-based message publishing functionality as a namespace-based configuration of a <code class="literal">MessagePublishingInterceptor</code>.
It certainly has some benefits over the annotation-driven approach, since it lets you use AOP pointcut expressions, thus possibly intercepting multiple methods at once or intercepting and publishing methods to which you do not have the source code.</p>
<p>To configure message publishing with XML, you need only do the following two things:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Provide configuration for <code class="literal">MessagePublishingInterceptor</code> by using the <code class="literal">&lt;publishing-interceptor&gt;</code> XML element.
</li><li class="listitem">
Provide AOP configuration to apply the <code class="literal">MessagePublishingInterceptor</code> to managed objects.
</li></ul></div>
<p>The following example shows how to configure a <code class="literal">publishing-interceptor</code> element:</p>
<pre class="programlisting"><span class="hl-tag">&lt;aop:config&gt;</span>
  <span class="hl-tag">&lt;aop:advisor</span> <span class="hl-attribute">advice-ref</span>=<span class="hl-value">"interceptor"</span> <span class="hl-attribute">pointcut</span>=<span class="hl-value">"bean(testBean)"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/aop:config&gt;</span>
<span class="hl-tag">&lt;publishing-interceptor</span> <span class="hl-attribute">id</span>=<span class="hl-value">"interceptor"</span> <span class="hl-attribute">default-channel</span>=<span class="hl-value">"defaultChannel"</span><span class="hl-tag">&gt;</span>
  <span class="hl-tag">&lt;method</span> <span class="hl-attribute">pattern</span>=<span class="hl-value">"echo"</span> <span class="hl-attribute">payload</span>=<span class="hl-value">"'Echoing: ' + #return"</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"echoChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;header</span> <span class="hl-attribute">name</span>=<span class="hl-value">"things"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"something"</span><span class="hl-tag">/&gt;</span>
  <span class="hl-tag">&lt;/method&gt;</span>
  <span class="hl-tag">&lt;method</span> <span class="hl-attribute">pattern</span>=<span class="hl-value">"repl*"</span> <span class="hl-attribute">payload</span>=<span class="hl-value">"'Echoing: ' + #return"</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"echoChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;header</span> <span class="hl-attribute">name</span>=<span class="hl-value">"things"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"'something'.toUpperCase()"</span><span class="hl-tag">/&gt;</span>
  <span class="hl-tag">&lt;/method&gt;</span>
  <span class="hl-tag">&lt;method</span> <span class="hl-attribute">pattern</span>=<span class="hl-value">"echoDef*"</span> <span class="hl-attribute">payload</span>=<span class="hl-value">"#return"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/publishing-interceptor&gt;</span></pre>
<p>The <code class="literal">&lt;publishing-interceptor&gt;</code> configuration looks rather similar to the annotation-based approach, and it also uses the power of the Spring Expression Language.</p>
<p>In the preceding example, the execution of the <code class="literal">echo</code> method of a <code class="literal">testBean</code> renders a <code class="literal">Message</code> with the following structure:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
The <code class="literal">Message</code> payload is of type <code class="literal">String</code> with the following content: <code class="literal">Echoing: [value]</code>, where <code class="literal">value</code> is the value returned by an executed method.
</li><li class="listitem">
The <code class="literal">Message</code> has a header with a name of <code class="literal">things</code> and a value of <code class="literal">something</code>.
</li><li class="listitem">
The <code class="literal">Message</code> is sent to <code class="literal">echoChannel</code>.
</li></ul></div>
<p>The second method is very similar to the first.
Here, every method that begins with <span class="emphasis"><em>repl</em></span> renders a <code class="literal">Message</code> with the following structure:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
The <code class="literal">Message</code> payload is the same as in the preceding sample.
</li><li class="listitem">
The <code class="literal">Message</code> has a header named <code class="literal">things</code> whose value is the result of the SpEL expression <code class="literal">'something'.toUpperCase()</code>.
</li><li class="listitem">
The <code class="literal">Message</code> is sent to <code class="literal">echoChannel</code>.
</li></ul></div>
<p>The second method, mapping the execution of any method that begins with <code class="literal">echoDef</code>, produces a <code class="literal">Message</code> with the following structure:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
The <code class="literal">Message</code> payload is the value returned by an executed method.
</li><li class="listitem">
Since the <code class="literal">channel</code> attribute is not provided, the <code class="literal">Message</code> is sent to the <code class="literal">defaultChannel</code> defined by the <code class="literal">publisher</code>.
</li></ul></div>
<p>For simple mapping rules you can rely on the <code class="literal">publisher</code> defaults, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;publishing-interceptor</span> <span class="hl-attribute">id</span>=<span class="hl-value">"anotherInterceptor"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>The preceding example maps the return value of every method that matches the pointcut expression to a payload and is sent to a <code class="literal">default-channel</code>.
If you do not specify the <code class="literal">defaultChannel</code> (as the preceding example does not do), the messages are sent to the global <code class="literal">nullChannel</code> (the equivalent of <code class="literal">/dev/null</code>).</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_asynchronous_publishing" href="#_asynchronous_publishing"></a>Asynchronous Publishing</h4></div></div></div>

<p>Publishing occurs in the same thread as your component&#8217;s execution.
So, by default, it is synchronous.
This means that the entire message flow has to wait until the publisher&#8217;s flow completes.&nbsp;
However, developers often want the complete opposite: to use this message-publishing feature to initiate asynchronous flows.
For example, you might host a service (HTTP, WS, and so on) which receives a remote request.
You may want to send this request internally into a process that might take a while.
However you may also want to reply to the user right away.
So, instead of sending inbound requests for processing to the output channel (the conventional way), you can use <span class="emphasis"><em>output-channel</em></span> or a <span class="emphasis"><em>replyChannel</em></span> header to send a simple&nbsp;acknowledgment-like reply back to the caller while using the message-publisher feature to initiate a complex flow.</p>
<p>The service in the following example receives a complex payload (which needs to be sent further for processing), but it also needs to reply to the caller with a simple acknowledgment:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> String echo(Object complexPayload) {
&nbsp;&nbsp; &nbsp;&nbsp;<span class="hl-keyword">return</span> <span class="hl-string">"ACK"</span>;&nbsp;
}</pre>
</div>
<p>So, instead of hooking up the complex flow to the output channel, we use the message-publishing feature instead.
We configure it to create a new message, by using the input argument of the service method (shown in the preceding example), and send that to the <span class="emphasis"><em>localProcessChannel</em></span>.
To make sure this flow is asynchronous, all we need to do is send it to any type of asynchronous channel (<code class="literal">ExecutorChannel</code> in the next example).
The following example shows how to an asynchronous <code class="literal">publishing-interceptor</code>:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:service-activator</span> <span class="hl-attribute">&nbsp;input-channel</span>=<span class="hl-value">"inputChannel"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"outputChannel"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"sampleservice"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"sampleservice"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"test.SampleService"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;aop:config&gt;</span>
  <span class="hl-tag">&lt;aop:advisor</span> <span class="hl-attribute">advice-ref</span>=<span class="hl-value">"interceptor"</span> <span class="hl-attribute">pointcut</span>=<span class="hl-value">"bean(sampleservice)"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/aop:config&gt;</span>

<span class="hl-tag">&lt;int:publishing-interceptor</span> <span class="hl-attribute">id</span>=<span class="hl-value">"interceptor"</span><span class="hl-tag"> &gt;</span>
  <span class="hl-tag">&lt;int:method</span> <span class="hl-attribute">pattern</span>=<span class="hl-value">"echo"</span> <span class="hl-attribute">payload</span>=<span class="hl-value">"#args[0]"</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"localProcessChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:header</span> <span class="hl-attribute">name</span>=<span class="hl-value">"sample_header"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"'some sample value'"</span><span class="hl-tag">/&gt;</span>
  <span class="hl-tag">&lt;/int:method&gt;</span>
<span class="hl-tag">&lt;/int:publishing-interceptor&gt;</span>

<span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"localProcessChannel"</span><span class="hl-tag">&gt;</span>
  <span class="hl-tag">&lt;int:dispatcher</span> <span class="hl-attribute">task-executor</span>=<span class="hl-value">"executor"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:channel&gt;</span>

<span class="hl-tag">&lt;task:executor</span> <span class="hl-attribute">id</span>=<span class="hl-value">"executor"</span> <span class="hl-attribute">pool-size</span>=<span class="hl-value">"5"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>Another way of handling this type of scenario is with a wire-tap. See <a class="xref" href="#channel-wiretap" title="Wire Tap">the section called &#8220;Wire Tap&#8221;</a>.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="scheduled-producer" href="#scheduled-producer"></a>B.1.3&nbsp;Producing and Publishing Messages Based on a Scheduled Trigger</h3></div></div></div>

<p>In the preceding sections, we looked at the message-publishing feature, which constructs and publishes messages as by-products of method invocations.
However, in those cases, you are still responsible for invoking the method.
Spring Integration 2.0 added support for scheduled message producers and publishers with the new <code class="literal">expression</code> attribute on the <span class="emphasis"><em>inbound-channel-adapter</em></span> element.
You can schedul based on several triggers, any one of which can be configured on the <span class="emphasis"><em>poller</em></span> element.
Currently, we support <code class="literal">cron</code>, <code class="literal">fixed-rate</code>, <code class="literal">fixed-delay</code> and any custom trigger implemented by you and referenced by the <span class="emphasis"><em>trigger</em></span> attribute value.</p>
<p>As mentioned earlier, support for scheduled producers and publishers is provided via the <code class="literal">&lt;inbound-channel-adapter&gt;</code> XML element.
Consider the following example:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"fixedDelayProducer"</span>
       <span class="hl-attribute">expression</span>=<span class="hl-value">"'fixedDelayTest'"</span>
       <span class="hl-attribute">channel</span>=<span class="hl-value">"fixedDelayChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">fixed-delay</span>=<span class="hl-value">"1000"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:inbound-channel-adapter&gt;</span></pre>
</div>
<p>The preceding example creates an inbound channel adapter that constructs a <code class="literal">Message</code>, with its payload being the result of the expression&nbsp; defined in the <code class="literal">expression</code> attribute.
Such messages are created and sent every time the delay specified by the <code class="literal">fixed-delay</code> attribute occurs.</p>
<p>The following example is similar to the preceding example, except that it uses the <code class="literal">fixed-rate</code> attribute:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"fixedRateProducer"</span>
       <span class="hl-attribute">expression</span>=<span class="hl-value">"'fixedRateTest'"</span>
       <span class="hl-attribute">channel</span>=<span class="hl-value">"fixedRateChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"1000"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:inbound-channel-adapter&gt;</span></pre>
</div>
<p>The <code class="literal">fixed-rate</code> attribute lets you send messages at a fixed rate (measuring from the start time of each task).</p>
<p>The following example shows how you can apply a Cron trigger with a value specified in the <code class="literal">cron</code> attribute:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"cronProducer"</span>
       <span class="hl-attribute">expression</span>=<span class="hl-value">"'cronTest'"</span>
       <span class="hl-attribute">channel</span>=<span class="hl-value">"cronChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">cron</span>=<span class="hl-value">"7 6 5 4 3 ?"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:inbound-channel-adapter&gt;</span></pre>
</div>
<p>The following example shows how to insert additional headers into the message:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"headerExpressionsProducer"</span>
       <span class="hl-attribute">expression</span>=<span class="hl-value">"'headerExpressionsTest'"</span>
       <span class="hl-attribute">channel</span>=<span class="hl-value">"headerExpressionsChannel"</span>
       <span class="hl-attribute">auto-startup</span>=<span class="hl-value">"false"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">fixed-delay</span>=<span class="hl-value">"5000"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int:header</span> <span class="hl-attribute">name</span>=<span class="hl-value">"foo"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"6 * 7"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int:header</span> <span class="hl-attribute">name</span>=<span class="hl-value">"bar"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"x"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:inbound-channel-adapter&gt;</span></pre>
<p>The additional message headers can take scalar values or the results of evaluating Spring expressions.</p>
<p>If you need to implement your own custom trigger, you can use the <code class="literal">trigger</code> attribute to provide a reference to any spring configured bean that implements&nbsp;the <code class="literal">org.springframework.scheduling.Trigger</code> interface.
The following example shows how to do so:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"triggerRefProducer"</span>
       <span class="hl-attribute">expression</span>=<span class="hl-value">"'triggerRefTest'"</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"triggerRefChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">trigger</span>=<span class="hl-value">"customTrigger"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:inbound-channel-adapter&gt;</span>

<span class="hl-tag">&lt;beans:bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"customTrigger"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.scheduling.support.PeriodicTrigger"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;beans:constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"9999"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/beans:bean&gt;</span></pre>
</div>
</div>
</div>
</div>
<div class="appendix"><div class="titlepage"><div><div><h2 class="title"><a name="transactions" href="#transactions"></a>Appendix&nbsp;C.&nbsp;Transaction Support</h2></div></div></div>

<p>This chapter covers Spring Integration&#8217;s support for transactions. It covers the following topics:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="xref" href="#understanding-transaction" title="C.1&nbsp;Understanding Transactions in Message flows">Section&nbsp;C.1, &#8220;Understanding Transactions in Message flows&#8221;</a>
</li><li class="listitem">
<a class="xref" href="#transaction-boundaries" title="C.2&nbsp;Transaction Boundaries">Section&nbsp;C.2, &#8220;Transaction Boundaries&#8221;</a>
</li><li class="listitem">
<a class="xref" href="#transaction-synchronization" title="C.3&nbsp;Transaction Synchronization">Section&nbsp;C.3, &#8220;Transaction Synchronization&#8221;</a>
</li><li class="listitem">
<a class="xref" href="#pseudo-transactions" title="C.4&nbsp;Pseudo Transactions">Section&nbsp;C.4, &#8220;Pseudo Transactions&#8221;</a>
</li></ul></div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="understanding-transaction" href="#understanding-transaction"></a>C.1&nbsp;Understanding Transactions in Message flows</h2></div></div></div>

<p>Spring Integration exposes several hooks to address the transactional needs of your message flows.
To better understand these hooks and how you can benefit from them, we must first revisit the six mechanisms that you can use to initiate message flows and see how you can address the transactional needs of these flows within each of these mechanisms.</p>
<p>The following six mechanisms initiate a message flow (details for each are provided throughout this manual):</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Gateway proxy: A basic messaging gateway.
</li><li class="listitem">
Message channel: Direct interactions with <code class="literal">MessageChannel</code> methods (for example, <code class="literal">channel.send(message)</code>).
</li><li class="listitem">
Message publisher: The way to initiate a message flow as the by-product of method invocations on Spring beans.
</li><li class="listitem">
Inbound channel adapters and gateways: The way to initiate a message flow based on connecting third-party system with the Spring Integration messaging system (for example, <code class="literal">[JmsMessage] -&gt; Jms Inbound Adapter[SI Message] -&gt; SI Channel</code>).
</li><li class="listitem">
Scheduler: The way to initiate a message flow based on scheduling events distributed by a pre-configured scheduler.
</li><li class="listitem">
Poller: Similar to the scheduler, this is the way to initiate message flow based on scheduling or interval-based events distributed by a pre-configured poller.
</li></ul></div>
<p>We can split these six mechanisms into two general categories:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Message flows initiated by a user process: Example scenarios in this category would be invoking a gateway method or explicitly sending a <code class="literal">Message</code> to a <code class="literal">MessageChannel</code>.
In other words, these message flows depend on a third party process (such as some code that you wrote) to be initiated.
</li><li class="listitem">
Message flows initiated by a daemon process: Example scenarios in this category include a Poller polling a message queue to initiate a new message flow with the polled message or a scheduler scheduling the process by creating a new message and initiating a message flow at a predefined time.
</li></ul></div>
<p>Clearly the&nbsp;gateway proxy, <code class="literal">MessageChannel.send(...)</code> and <code class="literal">MessagePublisher</code> all belong to the first category, and inbound adapters and gateways, scheduler, and poller belong to the second category.</p>
<p>So, how can you address transactional needs in various scenarios within each category, and is there a need for Spring Integration to provide something explicit with regard to transactions for a particular scenario?
Or can you use Spring&#8217;s transaction support instead?</p>
<p>Spring itself provides first class support for transaction management.
So our goal here is not to provide something new but rather use Spring to benefit from its existing support for transactions.
In other words, as a framework, we must expose hooks to Spring&#8217;s transaction management functionality.
However, since Spring Integration configuration is based on Spring configuration, we need not always expose these hooks, because Spring already exposes them .
After all, every Spring Integration component is a Spring Bean.</p>
<p>With this goal in mind, we can again consider the two scenarios: messgae flows initiated by a user process and message flows initiated by a daemon.</p>
<p>Message flows that are initiated by a user process and configured in a Spring application context are subject to the usual transactional configuration of such processes.
Therefore they need not be explicitly configured by Spring Integration to support transactions.
The transaction could and should be initiated through Spring&#8217;s standard transaction support.
The Spring Integration message flow naturally honors the transactional semantics of the components, because it is itself configured by Spring.
For example, a gateway or service activator method could be annotated with <code class="literal">@Transactional</code>, or a <code class="literal">TransactionInterceptor</code> could be defined in an XML configuration with a pointcut expression that pointa to specific methods that should be transactional.
The bottom line is that you have full control over transaction configuration and boundaries in these scenarios.</p>
<p>However, things are a bit different when it comes to message flows initiated by a daemon process.
Although configured by the developer, these flows do not directly involve a human or some other process to be initiated.
These are trigger-based flows that are initiated by a trigger process (a daemon process) based on the configuration of the process.
For example, we could have a scheduler initiate a message flow every Friday night.
We can also configure a trigger that initiates a message flow every second and so on.
As a result, we need a way to let these trigger-based processes know of our intention to make the resulting message flows be transactional, so that a Transaction context can be created whenever a new message flow is initiated.
In other words, we need to expose some transaction configuration, but only enough to delegate to the transaction support already provided by Spring (as we do in other scenarios).</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="transaction-poller" href="#transaction-poller"></a>C.1.1&nbsp;Poller Transaction Support</h3></div></div></div>

<p>Spring Integration provides transactional support for pollers.
Pollers are a special type of component because, within a poller task, we can call <code class="literal">receive()</code> against a resource that is itself transactional, thus including the <code class="literal">receive()</code> call in the the boundaries of the transaction, which lets it be rolled back in case of a task failure.
If we were to add the same support for channels, the added transactions would affect all downstream components starting with the <code class="literal">send()</code> call.
That provides a rather wide scope for transaction demarcation without any strong reason, especially when Spring already provides several ways to address the transactional needs of any component downstream.
However the <code class="literal">receive()</code> method being&nbsp;included&nbsp;in a transaction boundary is the "<code class="literal">strong reason</code>" for pollers.</p>
<p>Any time you configure a Poller, you can provide transactional configuration by using the <code class="literal">transactional</code> child element and its attributes,as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">max-messages-per-poll</span>=<span class="hl-value">"1"</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"1000"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;transactional</span> <span class="hl-attribute">transaction-manager</span>=<span class="hl-value">"txManager"</span><span class="hl-attribute">&nbsp;</span>
                   <span class="hl-attribute">isolation</span>=<span class="hl-value">"DEFAULT"</span>
                   <span class="hl-attribute">propagation</span>=<span class="hl-value">"REQUIRED"</span><span class="hl-attribute">&nbsp;</span>
                   <span class="hl-attribute">read-only</span>=<span class="hl-value">"true"</span><span class="hl-attribute">&nbsp;</span>
                   <span class="hl-attribute">timeout</span>=<span class="hl-value">"1000"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/poller&gt;</span></pre>
</div>
<p>The preceding configuration looks similar to a native Spring transaction configuration.
You must still provide a reference to a transaction manager and either specify transaction attributes or rely on defaults (for example, if the <span class="emphasis"><em>transaction-manager</em></span> attribute is not specified, it defaults to the bean named <span class="emphasis"><em>transactionManager</em></span>).
Internally, the process is wrapped in Spring&#8217;s native transaction, where <code class="literal">TransactionInterceptor</code> is responsible for handling transactions.
For more information on how to configure a transaction manager, the types of transaction managers (such as JTA, Datasource, and others), and other details related to transaction configuration, see the <a class="ulink" href="https://docs.spring.io/spring/docs/current/spring-framework-reference/data-access.html#transaction" target="_top">Spring Framework Reference Guide</a>.</p>
<p>With the preceding configuration, all message flows initiated by this poller are transactional.
For more information and details on a poller&#8217;s transactional configuration, see <a class="xref" href="#jdbc-polling-transactions" title="21.1.1&nbsp;Polling and Transactions">Section&nbsp;21.1.1, &#8220;Polling and Transactions&#8221;</a>.</p>
<p>Along with transactions, you might need to address several more cross-cutting concerns when you run a poller.
To help with that, the poller element accepts an <code class="literal">&lt;advice-chain&gt;</code> child element, which lets you define a custom chain of advice instances to be applied on the Poller.
(See <a class="xref" href="#pollable-message-source" title="6.2.2&nbsp;Pollable Message Source">Section&nbsp;6.2.2, &#8220;Pollable Message Source&#8221;</a> for more details.)
In Spring Integration 2.0, the Poller went through a refactoring effort and now uses a proxy mechanism to address transactional concerns as well as other cross-cutting concerns.
One of the significant changes evolving from this effort is that we made the <code class="literal">&lt;transactional&gt;</code> and <code class="literal">&lt;advice-chain&gt;</code> elements be mutually exclusive.
The rationale behind this is that, if you need more than one advice and one of them is Transaction advice, you can include it in the <code class="literal">&lt;advice-chain&gt;</code> with the same convenience as before but with much more control, since you now have an option to position the advice in the desired order.
The following example shows how to do so:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">max-messages-per-poll</span>=<span class="hl-value">"1"</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"10000"</span><span class="hl-tag">&gt;</span>
  <span class="hl-tag">&lt;advice-chain&gt;</span>
    <span class="hl-tag">&lt;ref</span> <span class="hl-attribute">bean</span>=<span class="hl-value">"txAdvice"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;ref</span> <span class="hl-attribute">bean</span>=<span class="hl-value">"someAotherAdviceBean"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;beans:bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"foo.bar.SampleAdvice"</span><span class="hl-tag">/&gt;</span>
  <span class="hl-tag">&lt;/advice-chain&gt;</span>
<span class="hl-tag">&lt;/poller&gt;</span>

<span class="hl-tag">&lt;tx:advice</span> <span class="hl-attribute">id</span>=<span class="hl-value">"txAdvice"</span> <span class="hl-attribute">transaction-manager</span>=<span class="hl-value">"txManager"</span><span class="hl-tag">&gt;</span>
  <span class="hl-tag">&lt;tx:attributes&gt;</span>
    <span class="hl-tag">&lt;tx:method</span> <span class="hl-attribute">name</span>=<span class="hl-value">"get*"</span> <span class="hl-attribute">read-only</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;tx:method</span> <span class="hl-attribute">name</span>=<span class="hl-value">"*"</span><span class="hl-tag">/&gt;</span>
  <span class="hl-tag">&lt;/tx:attributes&gt;</span>
<span class="hl-tag">&lt;/tx:advice&gt;</span></pre>
</div>
<p>The preceding example shows a basic XML-based configuration of Spring Transaction advice (<code class="literal">txAdvice</code>) and included it within the <code class="literal">&lt;advice-chain&gt;</code> defined by the Poller.
If you need to address only the transactional concerns of the poller, you can still use the <code class="literal">&lt;transactional&gt;</code> element as a convenience.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="transaction-boundaries" href="#transaction-boundaries"></a>C.2&nbsp;Transaction Boundaries</h2></div></div></div>

<p>Another important factor is the boundaries of Transactions within a Message flow.
When a transaction is started, the transaction context is bound to the current thread.
So regardless of how many endpoints and channels you have in your Message flow your transaction context will be preserved as long as you are ensuring that the flow continues on the same thread.
As soon as you break it by introducing a <span class="emphasis"><em>Pollable Channel</em></span> or <span class="emphasis"><em>Executor Channel</em></span> or initiate a new thread manually in some service, the Transactional boundary will be broken as well.
Essentially the Transaction will END right there, and if a successful handoff has transpired between the threads, the flow would be considered a success and a COMMIT signal would be sent even though the flow will continue and might still result in an Exception somewhere downstream.
If such a flow were synchronous, that Exception could be thrown back to the initiator of the Message flow who is also the initiator of the transactional context and the transaction would result in a ROLLBACK.
The middle ground is to use transactional channels at any point where a thread boundary is being broken.
For example, you can use a Queue-backed Channel that delegates to a transactional MessageStore strategy, or you could use a JMS-backed channel.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="transaction-synchronization" href="#transaction-synchronization"></a>C.3&nbsp;Transaction Synchronization</h2></div></div></div>

<p>In some environments, it help to synchronize operations with a transaction that encompasses the entire flow.
For example, consider a <code class="literal">&lt;file:inbound-channel-adapter/&gt;</code> at the start of a flow that performs a number of database updates.
If the transaction commits, we might want to move the file to a <code class="literal">success</code> directory, while we might want to move it to a <code class="literal">failure</code> directory if the transaction rolls back.</p>
<p>Spring Integration 2.2 introduced the capability of synchronizing these operations with a transaction.
In addition, you can configure a <code class="literal">PseudoTransactionManager</code> if you do not have a <span class="emphasis"><em>real</em></span> transaction but still want to perform different actions on success or failure.
For more information, see <a class="xref" href="#pseudo-transactions" title="C.4&nbsp;Pseudo Transactions">Section&nbsp;C.4, &#8220;Pseudo Transactions&#8221;</a>.</p>
<p>The following listing shows the key strategy interfaces for this feature:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> TransactionSynchronizationFactory {

    TransactionSynchronization create(Object key);
}

<span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> TransactionSynchronizationProcessor {

    <span class="hl-keyword">void</span> processBeforeCommit(IntegrationResourceHolder holder);

    <span class="hl-keyword">void</span> processAfterCommit(IntegrationResourceHolder holder);

    <span class="hl-keyword">void</span> processAfterRollback(IntegrationResourceHolder holder);

}</pre>
</div>
<p>The factory is responsible for creating a <a class="ulink" href="http://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/transaction/support/TransactionSynchronization.html" target="_top"><code class="literal">TransactionSynchronization</code></a> object.
You can implement your own or use the one provided by the framework: <code class="literal">DefaultTransactionSynchronizationFactory</code>.
This implementation returns a <code class="literal">TransactionSynchronization</code> that delegates to a default implementation of <code class="literal">TransactionSynchronizationProcessor</code>: <code class="literal">ExpressionEvaluatingTransactionSynchronizationProcessor</code>.
This processor supports three SpEL expressions: <code class="literal">beforeCommitExpression</code>, <code class="literal">afterCommitExpression</code>, and <code class="literal">afterRollbackExpression</code>.</p>
<p>These actions should be self-explanatory to those familiar with transactions.
In each case, the <code class="literal">#root</code> variable is the original <code class="literal">Message</code>.
In some cases, other SpEL variables are made available, depending on the <code class="literal">MessageSource</code> being polled by the poller.
For example, the <code class="literal">MongoDbMessageSource</code> provides the <code class="literal">#mongoTemplate</code> variable, which references the message source&#8217;s <code class="literal">MongoTemplate</code>.
Similarly, the <code class="literal">RedisStoreMessageSource</code> provides the <code class="literal">#store</code> variable, which references the <code class="literal">RedisStore</code> created by the poll.</p>
<p>To enable the feature for a particular poller, you can provide a reference to the <code class="literal">TransactionSynchronizationFactory</code> on the poller&#8217;s <code class="literal">&lt;transactional/&gt;</code> element by using the <code class="literal">synchronization-factory</code> attribute.</p>
<p>Starting with version 5.0, Spring Integration provides <code class="literal">PassThroughTransactionSynchronizationFactory</code>, which is applied by default to polling endpoints when no <code class="literal">TransactionSynchronizationFactory</code> is configured but an advice of type <code class="literal">TransactionInterceptor</code> exists in the advice chain.
When using any out-of-the-box <code class="literal">TransactionSynchronizationFactory</code> implementation, polling endpoints bind a polled message to the current transactional context and provide it as a <code class="literal">failedMessage</code> in a <code class="literal">MessagingException</code> if an exception is thrown after the transaction advice.
When using a custom transaction advice that does not implement <code class="literal">TransactionInterceptor</code>, you can explicitly configure a <code class="literal">PassThroughTransactionSynchronizationFactory</code> to achieve this behavior.
In either case, the <code class="literal">MessagingException</code> becomes the payload of the <code class="literal">ErrorMessage</code> that is sent to the <code class="literal">errorChannel</code>, and the cause is the raw exception thrown by the advice.
Previously, the <code class="literal">ErrorMessage</code> had a payload that was the raw exception thrown by the advice and did not provide a reference to the <code class="literal">failedMessage</code> information, making it difficult to determine the reasons for the transaction commit problem.</p>
<p>To simplify configuration of these components, Spring Integration provides namespace support for the default factory.
The following example shows how to use the namespace to configure a file inbound channel adapter:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-file:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"inputDirPoller"</span>
    <span class="hl-attribute">channel</span>=<span class="hl-value">"someChannel"</span>
    <span class="hl-attribute">directory</span>=<span class="hl-value">"/foo/bar"</span>
    <span class="hl-attribute">filter</span>=<span class="hl-value">"filter"</span>
    <span class="hl-attribute">comparator</span>=<span class="hl-value">"testComparator"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"5000"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;int:transactional</span> <span class="hl-attribute">transaction-manager</span>=<span class="hl-value">"transactionManager"</span> <span class="hl-attribute">synchronization-factory</span>=<span class="hl-value">"syncFactory"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;/int:poller&gt;</span>
<span class="hl-tag">&lt;/int-file:inbound-channel-adapter&gt;</span>

<span class="hl-tag">&lt;int:transaction-synchronization-factory</span> <span class="hl-attribute">id</span>=<span class="hl-value">"syncFactory"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:after-commit</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"payload.renameTo('/success/' + payload.name)"</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"committedChannel"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;int:after-rollback</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"payload.renameTo('/failed/' + payload.name)"</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"rolledBackChannel"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/int:transaction-synchronization-factory&gt;</span></pre>
</div>
<p>The result of the SpEL evaluation is sent as the payload to either <code class="literal">committedChannel</code> or <code class="literal">rolledBackChannel</code> (in this case, this would be <code class="literal">Boolean.TRUE</code> or <code class="literal">Boolean.FALSE</code>&#8201;&#8212;&#8201;the result of the <code class="literal">java.io.File.renameTo()</code> method call).</p>
<p>If you wish to send the entire payload for further Spring Integration processing, use the <span class="emphasis"><em>payload</em></span> expression.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>It is important to understand that this synchronizes the actions with a transaction.
It does not make a resource that is not inherently transactional actually be transactional.
Instead, the transaction (be it JDBC or otherwise) is started before the poll and either committed or rolled back when the flow completes, followed by the synchronized action.</p>
<p>If you provide a custom <code class="literal">TransactionSynchronizationFactory</code>, it is responsible for creating a resource synchronization that causes the bound resource to be unbound automatically when the transaction completes.
The default <code class="literal">TransactionSynchronizationFactory</code> does so by returning a subclass of <code class="literal">ResourceHolderSynchronization</code>, with the default <code class="literal">shouldUnbindAtCompletion()</code> returning <code class="literal">true</code>.</p>
</td></tr></table></div>
<p>In addition to the <code class="literal">after-commit</code> and <code class="literal">after-rollback</code> expressions, <code class="literal">before-commit</code> is also supported.
In that case, if the evaluation (or downstream processing) throws an exception, the transaction is rolled back instead of being committed.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="pseudo-transactions" href="#pseudo-transactions"></a>C.4&nbsp;Pseudo Transactions</h2></div></div></div>

<p>After reading the <a class="xref" href="#transaction-synchronization" title="C.3&nbsp;Transaction Synchronization">Section&nbsp;C.3, &#8220;Transaction Synchronization&#8221;</a> section, you might think it would be useful to take these <span class="emphasis"><em>success</em></span> or <span class="emphasis"><em>failure</em></span> actions when a flow completes, even if there is no "<code class="literal">real</code>" transactional resources (such as JDBC) downstream of the poller.
For example, consider a "<code class="literal">&lt;file:inbound-channel-adapter/&gt;</code>" followed by an "<code class="literal">&lt;ftp:outbout-channel-adapter/&gt;</code>".
Neither of these components is transactional, but we might want to move the input file to different directories, based on the success or failure of the FTP transfer.</p>
<p>To provide this functionality, the framework provides a <code class="literal">PseudoTransactionManager</code>, enabling the above configuration even when there is no real transactional resource involved.
If the flow completes normally, the <code class="literal">beforeCommit</code> and <code class="literal">afterCommit</code> synchronizations are called.
On failure, the <code class="literal">afterRollback</code> synchronization is called.
Because it is not a real transaction, no actual commit or rollback occurs.
The pseudo transaction is a vehicle used to enable the synchronization features.</p>
<p>To use a <code class="literal">PseudoTransactionManager</code>, you can define it as a &lt;bean/&gt;, in the same way you would configure a real transaction manager.
The following example shows how to do so:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"transactionManager"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.transaction.PseudoTransactionManager"</span><span class="hl-tag"> /&gt;</span></pre>
</div>
</div>
</div>
<div class="appendix"><div class="titlepage"><div><div><h2 class="title"><a name="security" href="#security"></a>Appendix&nbsp;D.&nbsp;Security in Spring Integration</h2></div></div></div>

<p>Security is one of the important functions in any modern enterprise (or cloud) application.
Moreover, it is critical for distributed systems, such as those built on Enterprise Integration Patterns.
Messaging independence and loose coupling let target systems communicate with each other with any type of data in the message&#8217;s <code class="literal">payload</code>.
We can either trust all those messages or secure our service against "<code class="literal">infecting</code>" messages.</p>
<p>Spring Integration, together with <a class="ulink" href="http://projects.spring.io/spring-security/" target="_top">Spring Security</a>, provides a simple and comprehensive way to secure message channels, as well as other part of the integration solution.</p>
<p>You need to include this dependency into your project:</p>
<div class="informalexample">
<p>
<b>Maven.&nbsp;</b>

</p><pre class="programlisting"><span class="hl-tag">&lt;dependency&gt;</span>
    <span class="hl-tag">&lt;groupId&gt;</span>org.springframework.integration<span class="hl-tag">&lt;/groupId&gt;</span>
    <span class="hl-tag">&lt;artifactId&gt;</span>spring-integration-security<span class="hl-tag">&lt;/artifactId&gt;</span>
    <span class="hl-tag">&lt;version&gt;</span>5.1.2.RELEASE<span class="hl-tag">&lt;/version&gt;</span>
<span class="hl-tag">&lt;/dependency&gt;</span></pre><p>

</p>
<p>
<b>Gradle.&nbsp;</b>

</p><pre class="programlisting">compile <span class="hl-string">"org.springframework.integration:spring-integration-security:5.1.2.RELEASE"</span></pre><p>

</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="securing-channels" href="#securing-channels"></a>D.1&nbsp;Securing channels</h2></div></div></div>

<p>Spring Integration provides the <code class="literal">ChannelSecurityInterceptor</code> interceptor, which extends <code class="literal">AbstractSecurityInterceptor</code> and intercepts send and receive calls on the channel.
Access decisions are then made with reference to a <code class="literal">ChannelSecurityMetadataSource</code>, which provides the metadata that describes the send and receive access policies for certain channels.
The interceptor requires that a valid <code class="literal">SecurityContext</code> has been established by authenticating with Spring Security.
See the <a class="ulink" href="https://docs.spring.io/spring-security/site/docs/current/reference/htmlsingle/" target="_top">Spring Security Reference Guide</a> for details.</p>
<p>Spring Integration provides Namespace support to allow easy configuration of security constraints.
This support consists of the secured channels tag, which allows definition of one or more channel name patterns in conjunction with a definition of the security configuration for send and receive.
The pattern is a <code class="literal">java.util.regexp.Pattern</code>.</p>
<p>The following example shows how to configure a bean that includes security and how to set up policies with patterns:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans:beans</span> <span class="hl-attribute">xmlns:int</span>=<span class="hl-value">"http://www.springframework.org/schema/integration"</span>
   <span class="hl-attribute">xmlns:int-security</span>=<span class="hl-value">"http://www.springframework.org/schema/integration/security"</span>
  <span class="hl-attribute">xmlns:beans</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
  <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
  <span class="hl-attribute">xmlns:security</span>=<span class="hl-value">"http://www.springframework.org/schema/security"</span>
  <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"http://www.springframework.org/schema/beans
      http://www.springframework.org/schema/beans/spring-beans.xsd
      http://www.springframework.org/schema/security
      http://www.springframework.org/schema/security/spring-security.xsd
      http://www.springframework.org/schema/integration
      http://www.springframework.org/schema/integration/spring-integration.xsd
      http://www.springframework.org/schema/integration/security
      http://www.springframework.org/schema/integration/security/spring-integration-security.xsd"</span><span class="hl-tag">&gt;</span>

<span class="hl-tag">&lt;int-security:secured-channels&gt;</span>
    <span class="hl-tag">&lt;int-security:access-policy</span> <span class="hl-attribute">pattern</span>=<span class="hl-value">"admin.*"</span> <span class="hl-attribute">send-access</span>=<span class="hl-value">"ROLE_ADMIN"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int-security:access-policy</span> <span class="hl-attribute">pattern</span>=<span class="hl-value">"user.*"</span> <span class="hl-attribute">receive-access</span>=<span class="hl-value">"ROLE_USER"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-security:secured-channels&gt;</span></pre>
</div>
<p>By default, the <code class="literal">secured-channels</code> namespace element expects a bean named <code class="literal">authenticationManager</code> (which implements <code class="literal">AuthenticationManager</code>) and a bean named <code class="literal">accessDecisionManager</code> (which implements <code class="literal">AccessDecisionManager</code>).
Where this is not the case, references to the appropriate beans can be configured as attributes of the <code class="literal">secured-channels</code> element, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int-security:secured-channels</span> <span class="hl-attribute">access-decision-manager</span>=<span class="hl-value">"customAccessDecisionManager"</span>
                              <span class="hl-attribute">authentication-manager</span>=<span class="hl-value">"customAuthenticationManager"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int-security:access-policy</span> <span class="hl-attribute">pattern</span>=<span class="hl-value">"admin.*"</span> <span class="hl-attribute">send-access</span>=<span class="hl-value">"ROLE_ADMIN"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int-security:access-policy</span> <span class="hl-attribute">pattern</span>=<span class="hl-value">"user.*"</span> <span class="hl-attribute">receive-access</span>=<span class="hl-value">"ROLE_USER"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int-security:secured-channels&gt;</span></pre>
</div>
<p>Starting with version 4.2, the <code class="literal">@SecuredChannel</code> annotation is available for Java configuration in <code class="literal">@Configuration</code> classes.</p>
<p>The following example shows the Java equivalent of the preceding XML examples:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Configuration</span></em>
<em><span class="hl-annotation" style="color: gray">@EnableIntegration</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ContextConfiguration {

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <em><span class="hl-annotation" style="color: gray">@SecuredChannel(interceptor = "channelSecurityInterceptor", sendAccess = "ROLE_ADMIN")</span></em>
    <span class="hl-keyword">public</span> SubscribableChannel adminChannel() {
    	<span class="hl-keyword">return</span> <span class="hl-keyword">new</span> DirectChannel();
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <em><span class="hl-annotation" style="color: gray">@SecuredChannel(interceptor = "channelSecurityInterceptor", receiveAccess = "ROLE_USER")</span></em>
    <span class="hl-keyword">public</span> SubscribableChannel userChannel() {
    	<span class="hl-keyword">return</span> <span class="hl-keyword">new</span> DirectChannel();
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> ChannelSecurityInterceptor channelSecurityInterceptor(
            AuthenticationManager authenticationManager,
    		AccessDecisionManager accessDecisionManager) {
    	ChannelSecurityInterceptor channelSecurityInterceptor = <span class="hl-keyword">new</span> ChannelSecurityInterceptor();
    	channelSecurityInterceptor.setAuthenticationManager(authenticationManager);
    	channelSecurityInterceptor.setAccessDecisionManager(accessDecisionManager);
    	<span class="hl-keyword">return</span> channelSecurityInterceptor;
    }

}</pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="security-context-propagation" href="#security-context-propagation"></a>D.2&nbsp;Security Context Propagation</h2></div></div></div>

<p>To be sure that our interaction with the application is secure, according to its security system rules, we should supply some security context with an authentication (principal) object.
The Spring Security project provides a flexible, canonical mechanism to authenticate our application clients over HTTP, WebSocket, or SOAP protocols (as can be done for any other integration protocol with a simple Spring Security extension).
It also provides a <code class="literal">SecurityContext</code> for further authorization checks on the application objects, such as message channels.
By default, the <code class="literal">SecurityContext</code> is tied to the execution state of the current <code class="literal">Thread</code> by using the (<code class="literal">ThreadLocalSecurityContextHolderStrategy</code>).
It is accessed by an AOP (Aspect-oriented Programming) interceptor on secured methods to check (for example) whether that <code class="literal">principal</code> of the invocation has sufficient permissions to call that method.
This works well with the current thread.
Often, though, processing logic can be performed on another thread, on several threads, or even on external systems.</p>
<p>Standard thread-bound behavior is easy to configure if our application is built on the Spring Integration components
and its message channels.
In this case, the secured objects can be any service activator or transformer, secured with a
<code class="literal">MethodSecurityInterceptor</code> in their <code class="literal">&lt;request-handler-advice-chain&gt;</code> (see <a class="xref" href="#message-handler-advice-chain" title="10.9&nbsp;Adding Behavior to Endpoints">Section&nbsp;10.9, &#8220;Adding Behavior to Endpoints&#8221;</a>) or even <code class="literal">MessageChannel</code> (see <a class="xref" href="#securing-channels" title="D.1&nbsp;Securing channels">Section&nbsp;D.1, &#8220;Securing channels&#8221;</a>, earlier).
When using <code class="literal">DirectChannel</code> communication, the <code class="literal">SecurityContext</code> is automatically available, because the downstream flow runs on the current thread.
However, in the cases of the <code class="literal">QueueChannel</code>, <code class="literal">ExecutorChannel</code>, and <code class="literal">PublishSubscribeChannel</code> with an <code class="literal">Executor</code>, messages are transferred from one thread to another (or several) by the nature of those channels.
In order to support such scenarios, we have two choices:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Transfer an <code class="literal">Authentication</code> object within the message headers and extract and authenticate it on the other side before secured object access.
</li><li class="listitem">
Propagate the <code class="literal">SecurityContext</code> to the thread that receives the transferred message.
</li></ul></div>
<p>Version 4.2 introduced <code class="literal">SecurityContext</code> propagation.
It is implemented as a <code class="literal">SecurityContextPropagationChannelInterceptor</code>, which you can add to any <code class="literal">MessageChannel</code> or configure as a <code class="literal">@GlobalChannelInterceptor</code>.
The logic of this interceptor is based on the <code class="literal">SecurityContext</code> extraction from the current thread (from the <code class="literal">preSend()</code> method) and its populating to another thread from the <code class="literal">postReceive()</code> (<code class="literal">beforeHandle()</code>) method.
Actually, this interceptor is an extension of the more generic <code class="literal">ThreadStatePropagationChannelInterceptor</code>, which wraps the message to send with the state to propagate in an internal <code class="literal">Message&lt;?&gt;</code> extension (<code class="literal">MessageWithThreadState&lt;S&gt;</code>) on one side and extracts the original message and the state to propagate on the other side.
You can extend the <code class="literal">ThreadStatePropagationChannelInterceptor</code> for any context propagation use case, and <code class="literal">SecurityContextPropagationChannelInterceptor</code> is a good example of doing so.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>The logic of the <code class="literal">ThreadStatePropagationChannelInterceptor</code> is based on message modification (it returns an internal <code class="literal">MessageWithThreadState</code> object to send).
Consequently, you should be careful when combining this interceptor with any other that can also modify messages (for example, through the <code class="literal">MessageBuilder.withPayload(...)...build()</code>).
The state to propagate may be lost.
In most cases, to overcome the issue, you can order the interceptors for the channel and ensure the <code class="literal">ThreadStatePropagationChannelInterceptor</code> is the last one in the stack.</p>
</td></tr></table></div>
<p>Propagation and population of <code class="literal">SecurityContext</code> is just one half of the work.
Since the message is not an owner of the threads in the message flow and we should be sure that we are secure against any incoming messages, we have to clean up the <code class="literal">SecurityContext</code> from <code class="literal">ThreadLocal</code>.
The <code class="literal">SecurityContextPropagationChannelInterceptor</code> provides the <code class="literal">afterMessageHandled()</code> interceptor method implementation.
It cleans up operation by freeing the thread at the end of invocation from that propagated principal.
This means that, when the thread that processes the handed-off message finishes processing the message (successful or otherwise), the context is cleared so that it cannot inadvertently be used when processing another message.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>When working with an <a class="link" href="#async-gateway" title="10.4.10&nbsp;Asynchronous Gateway">asynchronous gateway</a>, you should use an appropriate <code class="literal">AbstractDelegatingSecurityContextSupport</code> implementation from Spring Security <a class="ulink" href="http://docs.spring.io/spring-security/site/docs/current/reference/html/concurrency.html" target="_top">Concurrency Support</a>, to let security context propagation be ensured over gateway invocation.
The following example shows how to do so:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Configuration</span></em>
<em><span class="hl-annotation" style="color: gray">@EnableIntegration</span></em>
<em><span class="hl-annotation" style="color: gray">@IntegrationComponentScan</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ContextConfiguration {

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> AsyncTaskExecutor securityContextExecutor() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> DelegatingSecurityContextAsyncTaskExecutor(
                         <span class="hl-keyword">new</span> SimpleAsyncTaskExecutor());
    }

}

...

<em><span class="hl-annotation" style="color: gray">@MessagingGateway(asyncExecutor = "securityContextExecutor")</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> SecuredGateway {

    <em><span class="hl-annotation" style="color: gray">@Gateway(requestChannel = "queueChannel")</span></em>
    Future&lt;String&gt; send(String payload);

}</pre>
</td></tr></table></div>
</div>
</div>
<div class="appendix"><div class="titlepage"><div><div><h2 class="title"><a name="configuration" href="#configuration"></a>Appendix&nbsp;E.&nbsp;Configuration</h2></div></div></div>

<p>Spring Integration offers a number of configuration options.
Which option you choose depends upon your particular needs and at what level you prefer to work.
As with the Spring framework in general, you can mix and match the various techniques to suit the problem at hand.
For example, you can choose the XSD-based namespace for the majority of configuration and combine it with a handful of objects that you configure with annotations.
As much as possible, the two provide consistent naming.
The XML elements defined by the XSD schema match the names of the annotations, and the attributes of those XML elements match the names of annotation properties.
You can also use the API directly, but we expect most developers to choose one of the higher-level options or a combination of the namespace-based and annotation-driven configuration.</p>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="configuration-namespace" href="#configuration-namespace"></a>E.1&nbsp;Namespace Support</h2></div></div></div>

<p>You can configure Spring Integration components with XML elements that map directly to the terminology and concepts of enterprise integration.
In many cases, the element names match those of the <a class="ulink" href="http://www.eaipatterns.com" target="_top"><span class="emphasis"><em>Enterprise Integration Patterns</em></span></a> book.</p>
<p>To enable Spring Integration&#8217;s core namespace support within your Spring configuration files, add the following namespace reference and schema mapping in your top-level <span class="emphasis"><em>beans</em></span> element:</p>
<div class="informalexample">
<pre class="screen">&lt;beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       <span class="strong"><strong>xmlns:int="http://www.springframework.org/schema/integration"</strong></span>
       xsi:schemaLocation="http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans.xsd
           <span class="strong"><strong>http://www.springframework.org/schema/integration</strong></span>
           <span class="strong"><strong>http://www.springframework.org/schema/integration/spring-integration.xsd</strong></span>"&gt;</pre>
</div>
<p>(We have emphasized the lines that are particular to Spring Integration.)</p>
<p>You can choose any name after "xmlns:".
We use <code class="literal">int</code> (short for Integration) for clarity, but you might prefer another abbreviation.
On the other hand, if you use an XML editor or IDE support, the availability of auto-completion may convince you to keep the longer name for clarity.
Alternatively, you can create configuration files that use the Spring Integration schema as the primary namespace, as the following example shows:</p>
<div class="informalexample">
<pre class="screen"><span class="strong"><strong>&lt;beans:beans xmlns="http://www.springframework.org/schema/integration"</strong></span>
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:beans="http://www.springframework.org/schema/beans"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans.xsd
           <span class="strong"><strong>http://www.springframework.org/schema/integration</strong></span>
           <span class="strong"><strong>http://www.springframework.org/schema/integration/spring-integration.xsd</strong></span>"&gt;</pre>
</div>
<p>(We have emphasized the lines that are particular to Spring Integration.)</p>
<p>When using this alternative, no prefix is necessary for the Spring Integration elements.
On the other hand, if you define a generic Spring bean within the same configuration file, the bean element requires a prefix (<code class="literal">&lt;beans:bean .../&gt;</code>).
Since it is generally a good idea to modularize the configuration files themselves (based on responsibility or architectural layer), you may find it appropriate to use the latter approach in the integration-focused configuration files, since generic beans are seldom necessary within those files.
For the purposes of this documentation, we assume the integration namespace is the primary.</p>
<p>Spring Integration provides many other namespaces.
In fact, each adapter type (JMS, file, and so on) that provides namespace support defines its elements within a separate schema.
In order to use these elements, add the necessary namespaces with an <code class="literal">xmlns</code> entry and the corresponding <code class="literal">schemaLocation</code> mapping.
For example, the following root element shows several of these namespace declarations:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
  <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
  <span class="hl-attribute">xmlns:int</span>=<span class="hl-value">"http://www.springframework.org/schema/integration"</span>
  <span class="hl-attribute">xmlns:int-file</span>=<span class="hl-value">"http://www.springframework.org/schema/integration/file"</span>
  <span class="hl-attribute">xmlns:int-jms</span>=<span class="hl-value">"http://www.springframework.org/schema/integration/jms"</span>
  <span class="hl-attribute">xmlns:int-mail</span>=<span class="hl-value">"http://www.springframework.org/schema/integration/mail"</span>
  <span class="hl-attribute">xmlns:int-rmi</span>=<span class="hl-value">"http://www.springframework.org/schema/integration/rmi"</span>
  <span class="hl-attribute">xmlns:int-ws</span>=<span class="hl-value">"http://www.springframework.org/schema/integration/ws"</span>
  <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"http://www.springframework.org/schema/beans
    http://www.springframework.org/schema/beans/spring-beans.xsd
    http://www.springframework.org/schema/integration
    http://www.springframework.org/schema/integration/spring-integration.xsd
    http://www.springframework.org/schema/integration/file
    http://www.springframework.org/schema/integration/file/spring-integration-file.xsd
    http://www.springframework.org/schema/integration/jms
    http://www.springframework.org/schema/integration/jms/spring-integration-jms.xsd
    http://www.springframework.org/schema/integration/mail
    http://www.springframework.org/schema/integration/mail/spring-integration-mail.xsd
    http://www.springframework.org/schema/integration/rmi
    http://www.springframework.org/schema/integration/rmi/spring-integration-rmi.xsd
    http://www.springframework.org/schema/integration/ws
    http://www.springframework.org/schema/integration/ws/spring-integration-ws.xsd"</span><span class="hl-tag">&gt;</span>
 ...
<span class="hl-tag">&lt;/beans&gt;</span></pre>
</div>
<p>This reference manual provides specific examples of the various elements in their corresponding chapters.
Here, the main thing to recognize is the consistency of the naming for each namespace URI and schema location.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="namespace-taskscheduler" href="#namespace-taskscheduler"></a>E.2&nbsp;Configuring the Task Scheduler</h2></div></div></div>

<p>In Spring Integration, the <code class="literal">ApplicationContext</code> plays the central role of a message bus, and you need to consider only a couple of configuration options.
First, you may want to control the central <code class="literal">TaskScheduler</code> instance.
You can do so by providing a single bean named <code class="literal">taskScheduler</code>.
This is also defined as a constant, as follows:</p>
<div class="informalexample">
<pre class="programlisting">IntegrationContextUtils.TASK_SCHEDULER_BEAN_NAME</pre>
</div>
<p>By default, Spring Integration relies on an instance of <code class="literal">ThreadPoolTaskScheduler</code>, as described in the <a class="ulink" href="http://docs.spring.io/spring/docs/current/spring-framework-reference/html/scheduling.html" target="_top">Task Execution and Scheduling</a> section of the Spring Framework reference manual.
That default <code class="literal">TaskScheduler</code> starts up automatically with a pool of ten threads, but see <a class="xref" href="#global-properties" title="E.4&nbsp;Global Properties">Section&nbsp;E.4, &#8220;Global Properties&#8221;</a>.
If you provide your own <code class="literal">TaskScheduler</code> instance instead, you can set the <span class="emphasis"><em>autoStartup</em></span> property to <code class="literal">false</code> or provide your own pool size value.</p>
<p>When polling consumers provide an explicit task executor reference in their configuration, the invocation of the handler methods happens within that executor&#8217;s thread pool and not the main scheduler pool.
However, when no task executor is provided for an endpoint&#8217;s poller, it is invoked by one of the main scheduler&#8217;s threads.</p>
<div class="caution" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Caution"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Caution]" src="images/caution.png"></td><th align="left">Caution</th></tr><tr><td align="left" valign="top">
<p>Do not run long-running tasks on poller threads.
Use a task executor instead.
If you have a lot of polling endpoints, you can cause thread starvation, unless you increase the pool size.
Also, polling consumers have a default <code class="literal">receiveTimeout</code> of one second.
Since the poller thread blocks for this time, we recommend that you use a task executor when many such endpoints exist, again to avoid starvation.
Alternatively, you can reduce the <code class="literal">receiveTimeout</code>.</p>
</td></tr></table></div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>An endpoint is a Polling Consumer if its input channel is one of the queue-based (that is, pollable) channels.
Event-driven consumers are those having input channels that have dispatchers instead of queues (in other words, they are subscribable).
Such endpoints have no poller configuration, since their handlers are invoked directly.</p>
</td></tr></table></div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>When running in a JEE container, you may need to use Spring&#8217;s <code class="literal">TimerManagerTaskScheduler</code>, as described <a class="ulink" href="http://docs.spring.io/spring/docs/current/spring-framework-reference/html/scheduling.html#scheduling-task-scheduler-implementations" target="_top">here</a>, instead of the default <code class="literal">taskScheduler</code>.
To do so, define a bean with the appropriate JNDI name for your environment, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"taskScheduler"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.scheduling.commonj.TimerManagerTaskScheduler"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"timerManagerName"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"tm/MyTimerManager"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"resourceRef"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"true"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
</div>
</td></tr></table></div>
<p>The next section describes what happens if exceptions occur within the asynchronous invocations.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="namespace-errorhandler" href="#namespace-errorhandler"></a>E.3&nbsp;Error Handling</h2></div></div></div>

<p>As described in the <a class="link" href="#overview" title="5.&nbsp;Spring Integration Overview">overview</a> at the very beginning of this manual, one of the main motivations behind a message-oriented framework such as Spring Integration is to promote loose coupling between components.
The message channel plays an important role, in that producers and consumers do not have to know about each other.
However, the advantages also have some drawbacks.
Some things become more complicated in a loosely coupled environment, and one example is error handling.</p>
<p>When sending a message to a channel, the component that ultimately handles that message may or may not be operating within the same thread as the sender.
If using a simple default <code class="literal">DirectChannel</code> (when the <code class="literal">&lt;channel&gt;</code> element that has no <code class="literal">&lt;queue&gt;</code> child element and no <span class="emphasis"><em>task-executor</em></span> attribute),
the message handling occurs in the same thread that sends the initial message.
In that case, if an <code class="literal">Exception</code> is thrown, it can be caught by the sender (or it may propagate past the sender if it is an uncaught <code class="literal">RuntimeException</code>).
So far, everything is fine.
This is the same behavior as an exception-throwing operation in a normal call stack.</p>
<p>A message flow that runs on a caller thread might be invoked through a messaging gateway (see <a class="xref" href="#gateway" title="10.4&nbsp;Messaging Gateways">Section&nbsp;10.4, &#8220;Messaging Gateways&#8221;</a>) or a <code class="literal">MessagingTemplate</code> (see <a class="xref" href="#channel-template" title="6.1.4&nbsp;MessagingTemplate">Section&nbsp;6.1.4, &#8220;<code class="literal">MessagingTemplate</code>&#8221;</a>).
In either case, the default behavior is to throw any exceptions to the caller.
For the messaging gateway, see <a class="xref" href="#gateway-error-handling" title="10.4.8&nbsp;Error Handling">Section&nbsp;10.4.8, &#8220;Error Handling&#8221;</a> for details about how the exception is thrown and how to configure the gateway to route the errors to an error channel instead.
When using a <code class="literal">MessagingTemplate</code> or sending to a <code class="literal">MessageChannel</code> directly, exceptions are always thrown to the caller.</p>
<p>When adding asynchronous processing, things become rather more complicated.
For instance, if the <span class="emphasis"><em>channel</em></span> element does provide a <span class="emphasis"><em>queue</em></span> child element, the component that handles the message operates in a different thread than the sender.
The same is true when an <code class="literal">ExecutorChannel</code> is used.
The sender may have dropped the <code class="literal">Message</code> into the channel and moved on to other things.
There is no way for the <code class="literal">Exception</code> to be thrown directly back to that sender by using standard <code class="literal">Exception</code> throwing techniques.
Instead, handling errors for asynchronous processes requires that the error-handling mechanism also be asynchronous.</p>
<p>Spring Integration supports error handling for its components by publishing errors to a message channel.
Specifically, the <code class="literal">Exception</code> becomes the payload of a Spring Integration <code class="literal">ErrorMessage</code>.
That <code class="literal">Message</code> is then sent to a message channel that is resolved in a way that is similar to the <span class="emphasis"><em>replyChannel</em></span> resolution.
First, if the request <code class="literal">Message</code> being handled at the time the <code class="literal">Exception</code> occurred contains an <span class="emphasis"><em>errorChannel</em></span> header (the header name is defined in the <code class="literal">MessageHeaders.ERROR_CHANNEL</code> constant), the <code class="literal">ErrorMessage</code> is sent to that channel.
Otherwise, the error handler sends to a "<code class="literal">global</code>" channel whose bean name is <code class="literal">errorChannel</code> (this is also defined as a constant: <code class="literal">IntegrationContextUtils.ERROR_CHANNEL_BEAN_NAME</code>).</p>
<p>A default <code class="literal">errorChannel</code> bean is created internally by the Framework.
However, you can define your own if you want to control the settings.
The following example shows how to define an error channel backed by a queue with a capacity of 500:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"errorChannel"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:queue</span> <span class="hl-attribute">capacity</span>=<span class="hl-value">"500"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:channel&gt;</span></pre>
</div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The default error channel is a <code class="literal">PublishSubscribeChannel</code>.</p>
</td></tr></table></div>
<p>The most important thing to understand here is that the messaging-based error handling applies only to exceptions that are thrown by a Spring Integration task that is executing within a <code class="literal">TaskExecutor</code>.
This does not apply to exceptions thrown by a handler that operates within the same thread as the sender (for example, through a <code class="literal">DirectChannel</code> as described earlier in this section).</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>When exceptions occur in a scheduled poller task&#8217;s execution, those exceptions are wrapped in <code class="literal">ErrorMessage</code> instances and sent to the <span class="emphasis"><em>errorChannel</em></span> as well.</p>
</td></tr></table></div>
<p>To enable global error handling, register a handler on that channel.
For example, you can configure Spring Integration&#8217;s <code class="literal">ErrorMessageExceptionTypeRouter</code> as the handler of an endpoint that is subscribed to the <span class="emphasis"><em>errorChannel</em></span>.
That router can then spread the error messages across multiple channels, based on the <code class="literal">Exception</code> type.</p>
<p>Starting with version 4.3.10, Spring Integration provides the <code class="literal">ErrorMessagePublisher</code> and the <code class="literal">ErrorMessageStrategy</code>.
You can use them as a general mechanism for publishing <code class="literal">ErrorMessage</code> instances.
You can call or extend them in any error handling scenarios.
The <code class="literal">ErrorMessageSendingRecoverer</code> extends this class as a <code class="literal">RecoveryCallback</code> implementation that can be used with retry, such as the
<a class="link" href="#retry-advice" title="Retry Advice"><code class="literal">RequestHandlerRetryAdvice</code></a>.
The <code class="literal">ErrorMessageStrategy</code> is used to build an <code class="literal">ErrorMessage</code> based on the provided exception and an <code class="literal">AttributeAccessor</code> context.
It can be injected into any <code class="literal">MessageProducerSupport</code> or <code class="literal">MessagingGatewaySupport</code>.
The <code class="literal">requestMessage</code> is stored under <code class="literal">ErrorMessageUtils.INPUT_MESSAGE_CONTEXT_KEY</code> in the <code class="literal">AttributeAccessor</code> context.
The <code class="literal">ErrorMessageStrategy</code> can use that <code class="literal">requestMessage</code> as the <code class="literal">originalMessage</code> property of the <code class="literal">ErrorMessage</code> it creates.
The <code class="literal">DefaultErrorMessageStrategy</code> does exactly that.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="global-properties" href="#global-properties"></a>E.4&nbsp;Global Properties</h2></div></div></div>

<p>Certain global framework properties can be overridden by providing a properties file on the classpath.</p>
<p>The default properties can be found in <code class="literal">/META-INF/spring.integration.default.properties</code> in the <code class="literal">spring-integration-core</code> jar.
You can see them on GitHub <a class="ulink" href="https://github.com/spring-projects/spring-integration/blob/master/spring-integration-core/src/main/resources/META-INF/spring.integration.default.properties" target="_top">here</a>.
The following listing shows the default values:</p>
<div class="informalexample">
<pre class="screen">spring.integration.channels.autoCreate=true <a name="CO59-1" href="#CO59-1"></a><span><img src="images/callouts/1.png" alt="1" border="0"></span>
spring.integration.channels.maxUnicastSubscribers=0x7fffffff <a name="CO59-2" href="#CO59-2"></a><span><img src="images/callouts/2.png" alt="2" border="0"></span>
spring.integration.channels.maxBroadcastSubscribers=0x7fffffff <a name="CO59-3" href="#CO59-3"></a><span><img src="images/callouts/3.png" alt="3" border="0"></span>
spring.integration.taskScheduler.poolSize=10 <a name="CO59-4" href="#CO59-4"></a><span><img src="images/callouts/4.png" alt="4" border="0"></span>
spring.integration.messagingTemplate.throwExceptionOnLateReply=false <a name="CO59-5" href="#CO59-5"></a><span><img src="images/callouts/5.png" alt="5" border="0"></span>
spring.integration.readOnly.headers= <a name="CO59-6" href="#CO59-6"></a><span><img src="images/callouts/6.png" alt="6" border="0"></span>
spring.integration.endpoints.noAutoStartup= <a name="CO59-7" href="#CO59-7"></a><span><img src="images/callouts/7.png" alt="7" border="0"></span>
spring.integration.postProcessDynamicBeans=false <a name="CO59-8" href="#CO59-8"></a><span><img src="images/callouts/8.png" alt="8" border="0"></span></pre>
<div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO59-1"><span><img src="images/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left">
<p>When true, <code class="literal">input-channel</code> instances are automatically declared as <code class="literal">DirectChannel</code> instances when not explicitly found in the application context.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO59-2"><span><img src="images/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left">
<p>Sets the default number of subscribers allowed on, for example, a <code class="literal">DirectChannel</code>.
It can be used to avoid inadvertently subscribing multiple endpoints to the same channel.
You can override it on individual channels by setting the <code class="literal">max-subscribers</code> attribute.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO59-3"><span><img src="images/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left">
<p>This property provides the default number of subscribers allowed on, for example, a <code class="literal">PublishSubscribeChannel</code>.
It can be used to avoid inadvertently subscribing more than the expected number of endpoints to the same channel.
You can override it on individual channels by setting the <code class="literal">max-subscribers</code> attribute.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO59-4"><span><img src="images/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left">
<p>The number of threads available in the default <code class="literal">taskScheduler</code> bean.
See <a class="xref" href="#namespace-taskscheduler" title="E.2&nbsp;Configuring the Task Scheduler">Section&nbsp;E.2, &#8220;Configuring the Task Scheduler&#8221;</a>.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO59-5"><span><img src="images/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left">
<p>When <code class="literal">true</code>, messages that arrive at a gateway reply channel throw an exception when the gateway is not expecting a reply (because the sending thread has timed out or already received a reply).</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO59-6"><span><img src="images/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A comma-separated list of message header names that should not be populated into <code class="literal">Message</code> instances during a header copying operation.
The list is used by the <code class="literal">DefaultMessageBuilderFactory</code> bean and propagated to the <code class="literal">IntegrationMessageHeaderAccessor</code> instances (see <a class="xref" href="#message-header-accessor" title="7.2.1&nbsp;MessageHeaderAccessor API">Section&nbsp;7.2.1, &#8220;<code class="literal">MessageHeaderAccessor</code> API&#8221;</a>) used to build messages via <code class="literal">MessageBuilder</code> (see <a class="xref" href="#message-builder" title="7.4&nbsp;The MessageBuilder Helper Class">Section&nbsp;7.4, &#8220;The <code class="literal">MessageBuilder</code> Helper Class&#8221;</a>).
By default, only <code class="literal">MessageHeaders.ID</code> and <code class="literal">MessageHeaders.TIMESTAMP</code> are not copied during message building.
Since version 4.3.2.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO59-7"><span><img src="images/callouts/7.png" alt="7" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A comma-separated list of <code class="literal">AbstractEndpoint</code> bean names patterns (<code class="literal">xxx*</code>, <code class="literal">*xxx</code>, <code class="literal">*xxx*</code> or <code class="literal">xxx*yyy</code>) that should not be started automatically during application startup.
You can manually start these endpoints later by their bean name through a <code class="literal">Control Bus</code> (see <a class="xref" href="#control-bus" title="12.6&nbsp;Control Bus">Section&nbsp;12.6, &#8220;Control Bus&#8221;</a>), by their role with the <code class="literal">SmartLifecycleRoleController</code> (see <a class="xref" href="#endpoint-roles" title="10.2&nbsp;Endpoint Roles">Section&nbsp;10.2, &#8220;Endpoint Roles&#8221;</a>), or by <code class="literal">Lifecycle</code> bean injection.
You can explicitly override the effect of this global property by specifying <code class="literal">auto-startup</code> XML annotation or the <code class="literal">autoStartup</code> annotation attribute or by calling <code class="literal">AbstractEndpoint.setAutoStartup()</code> in the bean definition.
Since version 4.3.12.</p>
</td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO59-8"><span><img src="images/callouts/8.png" alt="8" border="0"></span></a> </p></td><td valign="top" align="left">
<p>A boolean flag to indicate that <code class="literal">BeanPostProcessor</code> instances should post-process beans registered at runtime (for example, message channels created by <code class="literal">IntegrationFlowContext</code> can be supplied with global channel interceptors).
Since version 4.3.15.</p>
</td></tr></table></div>
</div>
<p>These properties can be overridden by adding a <code class="literal">/META-INF/spring.integration.properties</code> file to the classpath.
You need not provide all the properties&#8201;&#8212;&#8201;only those that you want to override.</p>
<p>Starting with version 5.1, all the merged global properties are printed in the logs after application context startup when a <code class="literal">DEBUG</code> logic level is turned on for the <code class="literal">org.springframework.integration</code> category.
The output looks like this:</p>
<div class="informalexample">
<pre class="screen">Spring Integration global properties:

spring.integration.endpoints.noAutoStartup=fooService*
spring.integration.taskScheduler.poolSize=20
spring.integration.channels.maxUnicastSubscribers=0x7fffffff
spring.integration.channels.autoCreate=true
spring.integration.channels.maxBroadcastSubscribers=0x7fffffff
spring.integration.readOnly.headers=
spring.integration.messagingTemplate.throwExceptionOnLateReply=true</pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="annotations" href="#annotations"></a>E.5&nbsp;Annotation Support</h2></div></div></div>

<p>In addition to the XML namespace support for configuring message endpoints, you can also use annotations.
First, Spring Integration provides the class-level <code class="literal">@MessageEndpoint</code> as a stereotype annotation, meaning that it is itself annotated with Spring&#8217;s <code class="literal">@Component</code> annotation and is therefore automatically recognized as a bean definition by Spring&#8217;s component scanning.</p>
<p>Even more important are the various method-level annotations.
They indicate that the annotated method is capable of handling a message.
The following example demonstrates both class-level and method-level annotations:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@MessageEndpoint</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> FooService {

    <em><span class="hl-annotation" style="color: gray">@ServiceActivator</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> processMessage(Message message) {
        ...
    }
}</pre>
</div>
<p>Exactly what it means for the method to "<code class="literal">handle</code>" the Message depends on the particular annotation.
Annotations available in Spring Integration include:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">@Aggregator</code> (see <a class="xref" href="#aggregator" title="8.4&nbsp;Aggregator">Section&nbsp;8.4, &#8220;Aggregator&#8221;</a>)
</li><li class="listitem">
<code class="literal">@Filter</code> (see <a class="xref" href="#filter" title="8.2&nbsp;Filter">Section&nbsp;8.2, &#8220;Filter&#8221;</a>)
</li><li class="listitem">
<code class="literal">@Router</code> (see <a class="xref" href="#router" title="8.1&nbsp;Routers">Section&nbsp;8.1, &#8220;Routers&#8221;</a>)
</li><li class="listitem">
<code class="literal">@ServiceActivator</code> (see <a class="xref" href="#service-activator" title="10.5&nbsp;Service Activator">Section&nbsp;10.5, &#8220;Service Activator&#8221;</a>)
</li><li class="listitem">
<code class="literal">@Splitter</code> (see <a class="xref" href="#splitter" title="8.3&nbsp;Splitter">Section&nbsp;8.3, &#8220;Splitter&#8221;</a>)
</li><li class="listitem">
<code class="literal">@Transformer</code> (see <a class="xref" href="#transformer" title="9.1&nbsp;Transformer">Section&nbsp;9.1, &#8220;Transformer&#8221;</a>)
</li><li class="listitem">
<code class="literal">@InboundChannelAdapter</code> (see <a class="xref" href="#channel-adapter" title="6.3&nbsp;Channel Adapter">Section&nbsp;6.3, &#8220;Channel Adapter&#8221;</a>)
</li><li class="listitem">
<code class="literal">@BridgeFrom</code> (see <a class="xref" href="#bridge-annot" title="6.4.2&nbsp;Configuring a Bridge with Java Configuration">Section&nbsp;6.4.2, &#8220;Configuring a Bridge with Java Configuration&#8221;</a>)
</li><li class="listitem">
<code class="literal">@BridgeTo</code> (see <a class="xref" href="#bridge-annot" title="6.4.2&nbsp;Configuring a Bridge with Java Configuration">Section&nbsp;6.4.2, &#8220;Configuring a Bridge with Java Configuration&#8221;</a>)
</li><li class="listitem">
<code class="literal">@MessagingGateway</code> (see <a class="xref" href="#gateway" title="10.4&nbsp;Messaging Gateways">Section&nbsp;10.4, &#8220;Messaging Gateways&#8221;</a>)
</li><li class="listitem">
<code class="literal">@IntegrationComponentScan</code> (see <a class="xref" href="#configuration-enable-integration" title="5.5&nbsp;Configuration and @EnableIntegration">Section&nbsp;5.5, &#8220;Configuration and <code class="literal">@EnableIntegration</code>&#8221;</a>)
</li></ul></div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>If you use XML configuration in combination with annotations, the <code class="literal">@MessageEndpoint</code> annotation is not required.
If you want to configure a POJO reference from the <code class="literal">ref</code> attribute of a <code class="literal">&lt;service-activator/&gt;</code> element, you can provide only the method-level annotations.
In that case, the annotation prevents ambiguity even when no method-level attribute exists on the <code class="literal">&lt;service-activator/&gt;</code> element.</p>
</td></tr></table></div>
<p>In most cases, the annotated handler method should not require the <code class="literal">Message</code> type as its parameter.
Instead, the method parameter type can match the message&#8217;s payload type, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ThingService {

    <em><span class="hl-annotation" style="color: gray">@ServiceActivator</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> bar(Thing thing) {
        ...
    }

}</pre>
</div>
<p>When the method parameter should be mapped from a value in the <code class="literal">MessageHeaders</code>, another option is to use the parameter-level <code class="literal">@Header</code> annotation.
In general, methods annotated with the Spring Integration annotations can accept the <code class="literal">Message</code> itself, the message payload, or a header value (with <code class="literal">@Header</code>) as the parameter.
In fact, the method can accept a combination, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ThingService {

    <em><span class="hl-annotation" style="color: gray">@ServiceActivator</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> otherThing(String payload, <em><span class="hl-annotation" style="color: gray">@Header("x")</span></em> <span class="hl-keyword">int</span> valueX, <em><span class="hl-annotation" style="color: gray">@Header("y")</span></em> <span class="hl-keyword">int</span> valueY) {
        ...
    }

}</pre>
</div>
<p>You can also use the  <code class="literal">@Headers</code> annotation to provide all of the message headers as a <code class="literal">Map</code>, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ThingService {

    <em><span class="hl-annotation" style="color: gray">@ServiceActivator</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> otherThing(String payload, <em><span class="hl-annotation" style="color: gray">@Headers</span></em> Map&lt;String, Object&gt; headerMap) {
        ...
    }

}</pre>
</div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The value of the annotation can also be a SpEL expression (for example, <code class="literal">someHeader.toUpperCase()</code>), which is useful when you wish to manipulate the header value before injecting it.
It also provides an optional <code class="literal">required</code> property, which specifies whether the attribute value must be available within
the headers.
The default value for the <code class="literal">required</code> property is <code class="literal">true</code>.</p>
</td></tr></table></div>
<p>For several of these annotations, when a message-handling method returns a non-null value, the endpoint tries to send a reply.
This is consistent across both configuration options (namespace and annotations) in that such an endpoint&#8217;s output channel is used (if available), and the <code class="literal">REPLY_CHANNEL</code> message header value is used as a fallback.</p>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>The combination of output channels on endpoints and the reply channel message header enables a pipeline approach, where multiple components have an output channel and the final component allows the reply message to be forwarded to the reply channel (as specified in the original request message).
In other words, the final component depends on the information provided by the original sender and can dynamically support any number of clients as a result.
This is an example of the <a class="ulink" href="http://eaipatterns.com/ReturnAddress.html" target="_top">return address</a> pattern.</p>
</td></tr></table></div>
<p>In addition to the examples shown here, these annotations also support the <code class="literal">inputChannel</code> and <code class="literal">outputChannel</code> properties, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Service</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ThingService {

    <em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel="input", outputChannel="output")</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> otherThing(String payload, <em><span class="hl-annotation" style="color: gray">@Headers</span></em> Map&lt;String, Object&gt; headerMap) {
        ...
    }

}</pre>
</div>
<p>The processing of these annotations creates the same beans as the corresponding XML components&#8201;&#8212;&#8201;<code class="literal">AbstractEndpoint</code> instances and <code class="literal">MessageHandler</code> instances (or <code class="literal">MessageSource</code> instances for the inbound channel adapter).
See <a class="xref" href="#annotations_on_beans" title="E.6.1&nbsp;Annotations on @Bean Methods">Section&nbsp;E.6.1, &#8220;Annotations on <code class="literal">@Bean</code> Methods&#8221;</a>.
The bean names are generated from the following pattern: <code class="literal">[componentName].[methodName].[decapitalizedAnnotationClassShortName]</code>
(for example, for the preceding example the bean name is <code class="literal">thingService.otherThing.serviceActivator</code>) for the <code class="literal">AbstractEndpoint</code> and the same name with an additional <code class="literal">.handler</code> (<code class="literal">.source</code>) suffix for the <code class="literal">MessageHandler</code> (<code class="literal">MessageSource</code>) bean.
The <code class="literal">MessageHandler</code> instances (<code class="literal">MessageSource</code> instances) are also eligible to be tracked by <a class="link" href="#message-history" title="12.3&nbsp;Message History">the message history</a>.</p>
<p>Starting with version 4.0, all messaging annotations provide <code class="literal">SmartLifecycle</code> options (<code class="literal">autoStartup</code> and <code class="literal">phase</code>) to allow endpoint lifecycle control on application context initialization.
They default to <code class="literal">true</code> and <code class="literal">0</code>, respectively.
To change the state of an endpoint (such as ` start()` or <code class="literal">stop()</code>), you can obtain a reference to the endpoint bean by using the <code class="literal">BeanFactory</code> (or autowiring) and invoke the methods.
Alternatively, you can send a command message to the <code class="literal">Control Bus</code> (see <a class="xref" href="#control-bus" title="12.6&nbsp;Control Bus">Section&nbsp;12.6, &#8220;Control Bus&#8221;</a>).
For these purposes, you should use the <code class="literal">beanName</code> mentioned earlier in the preceding paragraph.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="configuration-using-poller-annotation" href="#configuration-using-poller-annotation"></a>E.5.1&nbsp;Using the <code class="literal">@Poller</code> Annotation</h3></div></div></div>

<p>Before Spring Integration 4.0, messaging annotations required that the <code class="literal">inputChannel</code> be a reference to a <code class="literal">SubscribableChannel</code>.
For <code class="literal">PollableChannel</code> instances, an <code class="literal">&lt;int:bridge/&gt;</code> element was needed to configure an <code class="literal">&lt;int:poller/&gt;</code> and make the composite endpoint be a <code class="literal">PollingConsumer</code>.
Version 4.0 introduced the <code class="literal">@Poller</code> annotation to allow the configuration of <code class="literal">poller</code> attributes directly on the messaging annotations, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> AnnotationService {

    <em><span class="hl-annotation" style="color: gray">@Transformer(inputChannel = "input", outputChannel = "output",
        poller = @Poller(maxMessagesPerPoll = "${poller.maxMessagesPerPoll}", fixedDelay = "${poller.fixedDelay}"))</span></em>
    <span class="hl-keyword">public</span> String handle(String payload) {
        ...
    }
}</pre>
</div>
<p>The <code class="literal">@Poller</code> annotation provides only simple <code class="literal">PollerMetadata</code> options.
You can configure the <code class="literal">@Poller</code> annotation&#8217;s attributes (<code class="literal">maxMessagesPerPoll</code>, <code class="literal">fixedDelay</code>, <code class="literal">fixedRate</code>, and <code class="literal">cron</code>) with property placeholders.
Also, starting with version 5.1, the <code class="literal">receiveTimeout</code> option for <code class="literal">PollingConsumer</code> s is also provided.
If it is necessary to provide more polling options (for example, <code class="literal">transaction</code>, <code class="literal">advice-chain</code>, <code class="literal">error-handler</code>, and others), you should configure the <code class="literal">PollerMetadata</code> as a generic bean and use its bean name as the <code class="literal">@Poller</code> 's <code class="literal">value</code> attribute.
In this case, no other attributes are allowed (they must be specified on the <code class="literal">PollerMetadata</code> bean).
Note, if <code class="literal">inputChannel</code> is a <code class="literal">PollableChannel</code> and no <code class="literal">@Poller</code> is configured, the default <code class="literal">PollerMetadata</code> is used (if it is present in the application context).
To declare the default poller by using a <code class="literal">@Configuration</code> annotation, use code similar to the following example:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean(name = PollerMetadata.DEFAULT_POLLER)</span></em>
<span class="hl-keyword">public</span> PollerMetadata defaultPoller() {
    PollerMetadata pollerMetadata = <span class="hl-keyword">new</span> PollerMetadata();
    pollerMetadata.setTrigger(<span class="hl-keyword">new</span> PeriodicTrigger(<span class="hl-number">10</span>));
    <span class="hl-keyword">return</span> pollerMetadata;
}</pre>
</div>
<p>The following example shows how to use the default poller:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> AnnotationService {

    <em><span class="hl-annotation" style="color: gray">@Transformer(inputChannel = "aPollableChannel", outputChannel = "output")</span></em>
    <span class="hl-keyword">public</span> String handle(String payload) {
        ...
    }
}</pre>
</div>
<p>The following example shows how to use a named poller:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> PollerMetadata myPoller() {
    PollerMetadata pollerMetadata = <span class="hl-keyword">new</span> PollerMetadata();
    pollerMetadata.setTrigger(<span class="hl-keyword">new</span> PeriodicTrigger(<span class="hl-number">1000</span>));
    <span class="hl-keyword">return</span> pollerMetadata;
}</pre>
</div>
<p>The following example shows an endpoint that uses the default poller:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> AnnotationService {

    <em><span class="hl-annotation" style="color: gray">@Transformer(inputChannel = "aPollableChannel", outputChannel = "output"
                           poller = @Poller("myPoller"))</span></em>
    <span class="hl-keyword">public</span> String handle(String payload) {
         ...
    }
}</pre>
</div>
<p>Starting with version 4.3.3, the <code class="literal">@Poller</code> annotation has the <code class="literal">errorChannel</code> attribute for easier configuration of the underlying <code class="literal">MessagePublishingErrorHandler</code>.
This attribute plays the same role as <code class="literal">error-channel</code> in the <code class="literal">&lt;poller&gt;</code> XML component.
See <a class="xref" href="#endpoint-namespace" title="10.1.4&nbsp;Endpoint Namespace Support">Section&nbsp;10.1.4, &#8220;Endpoint Namespace Support&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_using_the_literal_inboundchanneladapter_literal_annotation" href="#_using_the_literal_inboundchanneladapter_literal_annotation"></a>E.5.2&nbsp;Using the <code class="literal">@InboundChannelAdapter</code> Annotation</h3></div></div></div>

<p>Version 4.0 introduced the <code class="literal">@InboundChannelAdapter</code> method-level annotation.
It produces a <code class="literal">SourcePollingChannelAdapter</code> integration component based on a <code class="literal">MethodInvokingMessageSource</code> for the annotated method.
This annotation is an analogue of the <code class="literal">&lt;int:inbound-channel-adapter&gt;</code> XML component and has the same restrictions: The method cannot have parameters, and the return type must not be <code class="literal">void</code>.
It has two attributes: <code class="literal">value</code> (the required <code class="literal">MessageChannel</code> bean name) and <code class="literal">poller</code> (an optional <code class="literal">@Poller</code> annotation, as <a class="link" href="#configuration-using-poller-annotation" title="E.5.1&nbsp;Using the @Poller Annotation">described earlier</a>).
If you need to provide some <code class="literal">MessageHeaders</code>, use a <code class="literal">Message&lt;?&gt;</code> return type and use a <code class="literal">MessageBuilder</code> to build the <code class="literal">Message&lt;?&gt;</code>.
Using a <code class="literal">MessageBuilder</code> lets you configure the <code class="literal">MessageHeaders</code>.
The following example shows how to use an <code class="literal">@InboundChannelAdapter</code> annotation:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@InboundChannelAdapter("counterChannel")</span></em>
<span class="hl-keyword">public</span> Integer count() {
    <span class="hl-keyword">return</span> <span class="hl-keyword">this</span>.counter.incrementAndGet();
}

<em><span class="hl-annotation" style="color: gray">@InboundChannelAdapter(value = "fooChannel", poller = @Poller(fixed-rate = "5000"))</span></em>
<span class="hl-keyword">public</span> String foo() {
    <span class="hl-keyword">return</span> <span class="hl-string">"foo"</span>;
}</pre>
</div>
<p>Version 4.3 introduced the <code class="literal">channel</code> alias for the <code class="literal">value</code> annotation attribute, to provide better source code readability.
Also, the target <code class="literal">MessageChannel</code> bean is resolved in the <code class="literal">SourcePollingChannelAdapter</code> by the provided name (set by the <code class="literal">outputChannelName</code> option) on the first <code class="literal">receive()</code> call, not during the initialization phase.
It allows "<code class="literal">late binding</code>" logic: The target <code class="literal">MessageChannel</code> bean from the consumer perspective is created and registered a bit later than the <code class="literal">@InboundChannelAdapter</code> parsing phase.</p>
<p>The first example requires that the default poller has been declared elsewhere in the application context.</p>
<p>Using the <code class="literal">@MessagingGateway</code> Annotation</p>
<p>See <a class="xref" href="#messaging-gateway-annotation" title="10.4.6&nbsp;@MessagingGateway Annotation">Section&nbsp;10.4.6, &#8220;<code class="literal">@MessagingGateway</code> Annotation&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_using_the_literal_integrationcomponentscan_literal_annotation" href="#_using_the_literal_integrationcomponentscan_literal_annotation"></a>E.5.3&nbsp;Using the <code class="literal">@IntegrationComponentScan</code> Annotation</h3></div></div></div>

<p>The standard Spring Framework <code class="literal">@ComponentScan</code> annotation does not scan interfaces for stereotype <code class="literal">@Component</code> annotations.
To overcome this limitation and allow the configuration of <code class="literal">@MessagingGateway</code> (see <a class="xref" href="#messaging-gateway-annotation" title="10.4.6&nbsp;@MessagingGateway Annotation">Section&nbsp;10.4.6, &#8220;<code class="literal">@MessagingGateway</code> Annotation&#8221;</a>), we introduced the <code class="literal">@IntegrationComponentScan</code> mechanism.
This annotation must be placed with a <code class="literal">@Configuration</code> annotation and be customized to define its scanning options,
such as <code class="literal">basePackages</code> and <code class="literal">basePackageClasses</code>.
In this case, all discovered interfaces annotated with <code class="literal">@MessagingGateway</code> are parsed and registered as <code class="literal">GatewayProxyFactoryBean</code> instances.
All other class-based components are parsed by the standard <code class="literal">@ComponentScan</code>.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="meta-annotations" href="#meta-annotations"></a>E.6&nbsp;Messaging Meta-Annotations</h2></div></div></div>

<p>Starting with version 4.0, all messaging annotations can be configured as meta-annotations and all user-defined messaging annotations can define the same attributes to override their default values.
In addition, meta-annotations can be configured hierarchically, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Target({ElementType.METHOD, ElementType.ANNOTATION_TYPE})</span></em>
<em><span class="hl-annotation" style="color: gray">@Retention(RetentionPolicy.RUNTIME)</span></em>
<em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "annInput", outputChannel = "annOutput")</span></em>
<span class="hl-keyword">public</span> <em><span class="hl-annotation" style="color: gray">@interface</span></em> MyServiceActivator {

    String[] adviceChain = { <span class="hl-string">"annAdvice"</span> };
}

<em><span class="hl-annotation" style="color: gray">@Target({ElementType.METHOD, ElementType.ANNOTATION_TYPE})</span></em>
<em><span class="hl-annotation" style="color: gray">@Retention(RetentionPolicy.RUNTIME)</span></em>
<em><span class="hl-annotation" style="color: gray">@MyServiceActivator</span></em>
<span class="hl-keyword">public</span> <em><span class="hl-annotation" style="color: gray">@interface</span></em> MyServiceActivator1 {

    String inputChannel();

    String outputChannel();
}
...

<em><span class="hl-annotation" style="color: gray">@MyServiceActivator1(inputChannel = "inputChannel", outputChannel = "outputChannel")</span></em>
<span class="hl-keyword">public</span> Object service(Object payload) {
   ...
}</pre>
</div>
<p>Configuring meta-annotations hierarchically lets users set defaults for various attributes and enables isolation of framework Java dependencies to user annotations, avoiding their use in user classes.
If the framework finds a method with a user annotation that has a framework meta-annotation, it is treated as if the method were annotated directly with the framework annotation.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="annotations_on_beans" href="#annotations_on_beans"></a>E.6.1&nbsp;Annotations on <code class="literal">@Bean</code> Methods</h3></div></div></div>

<p>Starting with version 4.0, you can configure messaging annotations on <code class="literal">@Bean</code> method definitions in <code class="literal">@Configuration</code> classes, to produce message endpoints based on the beans, not the methods.
It is useful when <code class="literal">@Bean</code> definitions are "<code class="literal">out-of-the-box</code>" <code class="literal">MessageHandler</code> instances (<code class="literal">AggregatingMessageHandler</code>, <code class="literal">DefaultMessageSplitter</code>, and others), <code class="literal">Transformer</code> instances (<code class="literal">JsonToObjectTransformer</code>, <code class="literal">ClaimCheckOutTransformer</code>, and others), and <code class="literal">MessageSource</code> instances (<code class="literal">FileReadingMessageSource</code>, <code class="literal">RedisStoreMessageSource</code>, and others).
The following example shows how to use messaging annotations with <code class="literal">@Bean</code> annotations:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Configuration</span></em>
<em><span class="hl-annotation" style="color: gray">@EnableIntegration</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyFlowConfiguration {

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <em><span class="hl-annotation" style="color: gray">@InboundChannelAdapter(value = "inputChannel", poller = @Poller(fixedDelay = "1000"))</span></em>
    <span class="hl-keyword">public</span> MessageSource&lt;String&gt; consoleSource() {
        <span class="hl-keyword">return</span> CharacterStreamReadingMessageSource.stdin();
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <em><span class="hl-annotation" style="color: gray">@Transformer(inputChannel = "inputChannel", outputChannel = "httpChannel")</span></em>
    <span class="hl-keyword">public</span> ObjectToMapTransformer toMapTransformer() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> ObjectToMapTransformer();
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "httpChannel")</span></em>
    <span class="hl-keyword">public</span> MessageHandler httpHandler() {
    HttpRequestExecutingMessageHandler handler = <span class="hl-keyword">new</span> HttpRequestExecutingMessageHandler(<span class="hl-string">"http://foo/service"</span>);
        handler.setExpectedResponseType(String.<span class="hl-keyword">class</span>);
        handler.setOutputChannelName(<span class="hl-string">"outputChannel"</span>);
        <span class="hl-keyword">return</span> handler;
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "outputChannel")</span></em>
    <span class="hl-keyword">public</span> LoggingHandler loggingHandler() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> LoggingHandler(<span class="hl-string">"info"</span>);
    }

}</pre>
</div>
<p>Version 5.0 introduced support for a <code class="literal">@Bean</code> annotated with <code class="literal">@InboundChannelAdapter</code> that returns <code class="literal">java.util.function.Supplier</code>, which can produce either a POJO or a <code class="literal">Message</code>.
The followig example shows how to use that combination:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Configuration</span></em>
<em><span class="hl-annotation" style="color: gray">@EnableIntegration</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyFlowConfiguration {

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <em><span class="hl-annotation" style="color: gray">@InboundChannelAdapter(value = "inputChannel", poller = @Poller(fixedDelay = "1000"))</span></em>
    <span class="hl-keyword">public</span> Supplier&lt;String&gt; pojoSupplier() {
        <span class="hl-keyword">return</span> () -&gt; <span class="hl-string">"foo"</span>;
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <em><span class="hl-annotation" style="color: gray">@InboundChannelAdapter(value = "inputChannel", poller = @Poller(fixedDelay = "1000"))</span></em>
    <span class="hl-keyword">public</span> Supplier&lt;Message&lt;String&gt;&gt; messageSupplier() {
        <span class="hl-keyword">return</span> () -&gt; <span class="hl-keyword">new</span> GenericMessage&lt;&gt;(<span class="hl-string">"foo"</span>);
    }
}</pre>
</div>
<p>The meta-annotation rules work on <code class="literal">@Bean</code> methods as well (the <code class="literal">@MyServiceActivator</code> annotation <a class="link" href="#meta-annotations" title="E.6&nbsp;Messaging Meta-Annotations">described earlier</a> can be applied to a <code class="literal">@Bean</code> definition).</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>When you use these annotations on consumer <code class="literal">@Bean</code> definitions, if the bean definition returns an appropriate <code class="literal">MessageHandler</code> (depending on the annotation type), you must set attributes (such as <code class="literal">outputChannel</code>, <code class="literal">requiresReply</code>, <code class="literal">order</code>, and others), on the <code class="literal">MessageHandler</code> <code class="literal">@Bean</code> definition itself.
Only the following annotation attributes are used: <code class="literal">adviceChain</code>, <code class="literal">autoStartup</code>, <code class="literal">inputChannel</code>, <code class="literal">phase</code>, and <code class="literal">poller</code>.
All other attributes are for the handler.</p>
</td></tr></table></div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The bean names are generated with the following algorithm:</p>
</td></tr></table></div>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
The <code class="literal">MessageHandler</code> (<code class="literal">MessageSource</code>) <code class="literal">@Bean</code> gets its own standard name from the method name or <code class="literal">name</code> attribute on the <code class="literal">@Bean</code>.
This works as though there were no messaging annotation on the <code class="literal">@Bean</code> method.
</li><li class="listitem">
The <code class="literal">AbstractEndpoint</code> bean name is generated with the following pattern: <code class="literal">[configurationComponentName].[methodName].[decapitalizedAnnotationClassShortName]</code>.
For example, the <code class="literal">SourcePollingChannelAdapter</code> endpoint for the <code class="literal">consoleSource()</code> definition <a class="link" href="#annotations_on_beans" title="E.6.1&nbsp;Annotations on @Bean Methods">shown earlier</a> gets a bean name of <code class="literal">myFlowConfiguration.consoleSource.inboundChannelAdapter</code>.
See also <a class="xref" href="#endpoint-bean-names" title="5.4.8&nbsp;Endpoint Bean Names">Section&nbsp;5.4.8, &#8220;Endpoint Bean Names&#8221;</a>.
</li></ul></div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>When using these annotations on <code class="literal">@Bean</code> definitions, the <code class="literal">inputChannel</code> must reference a declared bean.
Channels are not automatically declared in this case.</p>
</td></tr></table></div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>With Java configuration, you can use any <code class="literal">@Conditional</code> (for example, <code class="literal">@Profile</code>) definition on the <code class="literal">@Bean</code> method level to skip the bean registration for some conditional reason.
The following example shows how to do so:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<em><span class="hl-annotation" style="color: gray">@ServiceActivator(inputChannel = "skippedChannel")</span></em>
<em><span class="hl-annotation" style="color: gray">@Profile("thing")</span></em>
<span class="hl-keyword">public</span> MessageHandler skipped() {
    <span class="hl-keyword">return</span> System.out::println;
}</pre>
</div>
<p>Together with the existing Spring container logic, the messaging endpoint bean (based on the <code class="literal">@ServiceActivator</code> annotation), is also not registered.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_creating_a_bridge_with_annotations" href="#_creating_a_bridge_with_annotations"></a>E.6.2&nbsp;Creating a Bridge with Annotations</h3></div></div></div>

<p>Starting with version 4.0, Java configuration provides the <code class="literal">@BridgeFrom</code> and <code class="literal">@BridgeTo</code> <code class="literal">@Bean</code> method annotations to mark <code class="literal">MessageChannel</code> beans in <code class="literal">@Configuration</code> classes.
These really exists for completeness, providing a convenient mechanism to declare a <code class="literal">BridgeHandler</code> and its message endpoint configuration:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> PollableChannel bridgeFromInput() {
    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> QueueChannel();
}

<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<em><span class="hl-annotation" style="color: gray">@BridgeFrom(value = "bridgeFromInput", poller = @Poller(fixedDelay = "1000"))</span></em>
<span class="hl-keyword">public</span> MessageChannel bridgeFromOutput() {
    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> DirectChannel();
}
<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> QueueChannel bridgeToOutput() {
    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> QueueChannel();
}

<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<em><span class="hl-annotation" style="color: gray">@BridgeTo("bridgeToOutput")</span></em>
<span class="hl-keyword">public</span> MessageChannel bridgeToInput() {
    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> DirectChannel();
}</pre>
</div>
<p>You can use these annotations as meta-annotations as well.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_advising_annotated_endpoints" href="#_advising_annotated_endpoints"></a>E.6.3&nbsp;Advising Annotated Endpoints</h3></div></div></div>

<p>See <a class="xref" href="#advising-with-annotations" title="10.9.7&nbsp;Advising Endpoints Using Annotations">Section&nbsp;10.9.7, &#8220;Advising Endpoints Using Annotations&#8221;</a>.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="message-mapping-rules" href="#message-mapping-rules"></a>E.7&nbsp;Message Mapping Rules and Conventions</h2></div></div></div>

<p>Spring Integration implements a flexible facility to map messages to methods and their arguments without providing extra configuration, by relying on some default rules and defining certain conventions.
The examples in the following sections articulate the rules.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="sample-scenarios" href="#sample-scenarios"></a>E.7.1&nbsp;Sample Scenarios</h3></div></div></div>

<p>The following example shows a single un-annotated parameter (object or primitive) that is not a <code class="literal">Map</code> or a <code class="literal">Properties</code> object with a non-void return type:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> String doSomething(Object o);</pre>
</div>
<p>The input parameter is a&nbsp;message payload.
If the parameter type is not compatible with&nbsp;a message payload,&nbsp;an attempt is made to convert it by using a conversion service provided by Spring 3.0.
The return value is incorporated as a payload of the returned message.</p>
<p>The following example shows a single un-annotated parameter&nbsp;(object or primitive)that is not a <code class="literal">Map</code> or a <code class="literal">Properties</code> with a <code class="literal">Message</code> return type:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> Message doSomething(Object o);</pre>
</div>
<p>The input parameter is&nbsp;a message payload.
If the parameter type is not compatible with&nbsp;a message payload,&nbsp;an attempt is made to convert it by using a conversion service provided by Spring 3.0.
The return value is a newly constructed message that is sent to the next destination.</p>
<p>The followig example shows a single parameter that is a message (or one of its subclasses) with an arbitrary object or primitive return type:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">int</span> doSomething(Message&nbsp; msg);</pre>
</div>
<p>The input parameter is&nbsp;itself a <code class="literal">Message</code>.&nbsp;
The return value becomes a payload of the <code class="literal">Message</code> that is sent to the next destination.</p>
<p>The following example shows a single parameter that is a <code class="literal">Message</code> (or one of its subclasses) with a <code class="literal">Message</code> (or one of its subclasses) as the return type:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> Message doSomething(Message&nbsp;msg);</pre>
</div>
<p>The input parameter is&nbsp;itself a <code class="literal">Message</code>.&nbsp;
The return value is a newly constructed <code class="literal">Message</code> that is sent to the next destination.</p>
<p>The following example shows a single parameter of type <code class="literal">Map</code> or <code class="literal">Properties</code> with a <code class="literal">Message</code> as the return type:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> Message doSomething(Map m);</pre>
</div>
<p>This one is a bit interesting.
Although, at first, it might seem like an easy mapping straight to message headers, preference is always given to a <code class="literal">Message</code> payload.
This means that if a <code class="literal">Message</code> payload is of type <code class="literal">Map</code>, this input argument represents a <code class="literal">Message</code> payload.
However, if the <code class="literal">Message</code> payload is not of type <code class="literal">Map</code>, the conversion service does not try to convert the payload, and the input argument is mapped to message headers.</p>
<p>The following example shows two parameters, where one of them is an arbitrary type (an object or a primitive) that is not a <code class="literal">Map</code> or a <code class="literal">Properties</code> object and the other is of type <code class="literal">Map</code> or <code class="literal">Properties</code> type (regardless of the return):</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> Message doSomething(Map h, &lt;T&gt; t);</pre>
</div>
<p>This combination contains two input parameters where one of them is of type <code class="literal">Map</code>.
The non-<code class="literal">Map</code> parameters (regardless of the order) are mapped to a <code class="literal">Message</code> payload and the <code class="literal">Map</code> or <code class="literal">Properties</code> (regardless of the order) is mapped to&nbsp;message headers, giving you a nice POJO way of interacting with <code class="literal">Message</code> structure.</p>
<p>The following example shows no parameters (regardless of the return):</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> String doSomething();</pre>
</div>
<p>This message handler method is invoked based on the Message sent to the input channel to which this handler is connected.
However no <code class="literal">Message</code> data is mapped, thus making the <code class="literal">Message</code> act as event or trigger to invoke the handler.
The output is mapped according to the rules <a class="link" href="#message-mapping-rules" title="E.7&nbsp;Message Mapping Rules and Conventions">described earlier</a>.</p>
<p>The following example shows no parameters and a void return:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">void</span> soSomething();</pre>
</div>
<p>This example is the same as the previous example, but it produces no output.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_annotation_based_mapping" href="#_annotation_based_mapping"></a>E.7.2&nbsp;Annotation-based Mapping</h3></div></div></div>

<p>Annotation-based mapping is the safest and least ambiguous approach to map messages to methods.
The following example shows how to explicitly map a method to a header:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> String doSomething(<em><span class="hl-annotation" style="color: gray">@Payload</span></em> String s,&nbsp;<em><span class="hl-annotation" style="color: gray">@Header("someheader")</span></em> String b)&nbsp;</pre>
<p>As you can see later on, without an annotation this signature would result in an ambiguous condition.
However, by explicitly mapping the first argument to a <code class="literal">Message</code> payload and the second argument to a value of the <code class="literal">someheader</code> message header, we avoid any ambiguity.</p>
<p>The following example is nearly identical to the preceding example:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> String doSomething(<em><span class="hl-annotation" style="color: gray">@Payload</span></em> String s, <em><span class="hl-annotation" style="color: gray">@RequestParam("something")</span></em> String b)&nbsp;</pre>
</div>
<p><code class="literal">@RequestMapping</code> or any other non-Spring Integration mapping annotation is irrelevant&nbsp;and is therefore ignored, leaving the second parameter unmapped.
Although the second parameter could easily be mapped to a payload, there can only be one payload.
Therefore, the annotations keep this method from being ambiguous.</p>
<p>The following example shows another similar method that would be ambiguous were it not for annotations to clarify the intent:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> String foo(String s, <em><span class="hl-annotation" style="color: gray">@Header("foo")</span></em> String b)&nbsp;</pre>
</div>
<p>The only difference is that the first argument is implicitly mapped to the message payload.</p>
<p>The following example shows yet another signature that would definitely be treated as ambiguous without annotations, because it has more than two arguments:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> String soSomething(<em><span class="hl-annotation" style="color: gray">@Headers</span></em> Map m, <em><span class="hl-annotation" style="color: gray">@Header("something")</span></em> Map f, <em><span class="hl-annotation" style="color: gray">@Header("someotherthing")</span></em> String bar)</pre>
</div>
<p>This example would be especially problematic, because two of its arguments are <code class="literal">Map</code> instances.
However, with annotation-based mapping, the ambiguity is easily avoided.
In this example the first argument is mapped to all the message headers, while the second and third argument map to the values of the message headers named <span class="emphasis"><em>something</em></span> and <span class="emphasis"><em>someotherthing</em></span>.
The payload is not being mapped to any argument.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="complex-scenarios" href="#complex-scenarios"></a>E.7.3&nbsp;Complex Scenarios</h3></div></div></div>

<p>The following example uses multiple parameters:</p>
<p>Multiple parameters can create a lot of ambiguity with regards to determining the appropriate mappings.
The general advice is to annotate your method parameters with <code class="literal">@Payload</code>, <code class="literal">@Header</code>, and <code class="literal">@Headers</code>.
The examples in this section show ambiguous conditions that result in an exception being raised.</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> String doSomething(String s, <span class="hl-keyword">int</span> i)</pre>
</div>
<p>The two parameters are equal in weight.
Therefore, there is no way to determine which one is a payload.</p>
<p>The following example shows a similar problem, only with three parameters:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> String foo(String s, Map m, String b)</pre>
</div>
<p>Although the Map could be easily mapped to message headers, there is no way to determine what to do with the two String parameters.</p>
<p>The following example shows another ambiguous method:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> String foo(Map m, Map f)</pre>
</div>
<p>Although one might argue that one <code class="literal">Map</code> could be mapped to the message payload and the other one to the message headers, we cannot rely on the order.</p>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>Any method signature with more than one method argument that is not (Map, &lt;T&gt;) and with unannotated parameters results in an ambiguous condition and triggers an exception.</p>
</td></tr></table></div>
<p>The next set of examples each show mutliple methods that result in ambiguity.</p>
<p>Message handlers with multiple methods are mapped based on the same rules that are described earlier (in the examples).
However, some scenarios might still look confusing.</p>
<p>The following example shows multiple methods with legal (mappable and unambiguous) signatures:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> Something {
    <span class="hl-keyword">public</span> String doSomething(String str, Map m);

    <span class="hl-keyword">public</span> String doSomething(Map m);
}</pre>
</div>
<p>(Whether the methods have the same name or different names makes no difference).
The <code class="literal">Message</code> could be mapped to either method.
The first method would be invoked when the message payload could be mapped to <code class="literal">str</code>&nbsp;and the message headers could be mapped to <code class="literal">m</code>.
The second method could also be a candidate by mapping only the message headers to <code class="literal">m</code>.
To make matters worse, both methods have the same name.
At first, that might look ambiguous because of the following configuration:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:service-activator&nbsp;input-channel="input"&nbsp;output-channel="output"&nbsp;method="doSomething"&gt;</span>
    <span class="hl-tag">&lt;bean&nbsp;class="org.things.Something"/&gt;</span>
<span class="hl-tag">&lt;/int:service-activator&gt;</span></pre>
</div>
<p>It works because mappings are based on the payload first and everything else next.
In other words, the method whose first argument can be mapped to a payload takes precedence over all other methods.</p>
<p>Now consider an alternate example, which produces a truly ambiguous condition:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> Something {
    <span class="hl-keyword">public</span> String doSomething(String str, Map m);

    <span class="hl-keyword">public</span> String doSomething(String str);
}</pre>
</div>
<p>Both methods have signatures that could be mapped to a message payload.
They also have the same name.
Such handler methods will trigger an exception.
However, if the method names were different, you could influence the mapping with a <code class="literal">method</code> attribute (shown in the next example).
The following example shows the same example with two different method names:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> Something {
    <span class="hl-keyword">public</span> String doSomething(String str, Map m);

    <span class="hl-keyword">public</span> String doSomethingElse(String str);
}</pre>
</div>
<p>The following example shows how to use the <code class="literal">method</code> attribute to dictate the mapping:</p>
<pre class="programlisting"><span class="hl-tag">&lt;int:service-activator&nbsp;input-channel="input"&nbsp;output-channel="output"&nbsp;method="doSomethingElse"&gt;</span>
    <span class="hl-tag">&lt;bean&nbsp;class="org.bar.Foo"/&gt;</span>
<span class="hl-tag">&lt;/int:service-activator&gt;</span></pre>
<p>Because the configuration explicitly maps the <code class="literal">doSomethingElse</code> method, we have eliminated the ambiguity.</p>
</div>
</div>
</div>
<div class="appendix"><div class="titlepage"><div><div><h2 class="title"><a name="testing" href="#testing"></a>Appendix&nbsp;F.&nbsp;Testing support</h2></div></div></div>

<p>Spring Integration provides a number of utilities and annotations to help you test your application.
Testing support is presented by two modules:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">spring-integration-test-support</code> contains core items and shared utilities
</li><li class="listitem">
<code class="literal">spring-integration-test</code> provides mocking and application context configuration components for integration tests
</li></ul></div>
<p><code class="literal">spring-integration-test-support</code> (<code class="literal">spring-integration-test</code> in versions before 5.0) provides basic, standalone utilities, rules, and matchers for unit testing.
(it also has no dependencies on Spring Integration itself and is used internally in Framework tests).
<code class="literal">spring-integration-test</code> aims to help with integration testing and provides a comprehensive high-level API to mock integration components and verify the behavior of individual components, including whole integration flows or only parts of them.</p>
<p>A thorough treatment of testing in the enterprise is beyond the scope of this reference manual.
See the <a class="ulink" href="http://www.enterpriseintegrationpatterns.com/docs/TestDrivenEAI.pdf" target="_top">"<code class="literal">Test-Driven Development in Enterprise Integration Projects</code>"</a> paper, by Gregor Hohpe and Wendy Istvanick, for a source of ideas and principles for testing your target integration solution.</p>
<p>The Spring Integration Test Framework and test utilities are fully based on existing JUnit, Hamcrest, and Mockito libraries.
The application context interaction is based on the <a class="ulink" href="http://docs.spring.io/spring-framework/docs/current/spring-framework-reference/htmlsingle/#testing" target="_top">Spring test framework</a>.
See the documentation for those projects for further information.</p>
<p>Thanks to the canonical implementation of the EIP in Spring Integration Framework and its first-class citizens (such as <code class="literal">MessageChannel</code>, <code class="literal">Endpoint</code> and <code class="literal">MessageHandler</code>), abstractions, and loose coupling principles, you can implement integration solutions of any complexity.
With the Spring Integration API for the flow definitions, you can improve, modify or even replace some part of the flow without impacting (mostly) other components in the integration solution.
Testing such an integration solution is still a challenge, both from an end-to-end approach and from an in-isolation approach.
Several existing tools can help to test or mock some integration protocols, and they work well with Spring Integration channel adapters. Examples of such tools include the following:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Spring <code class="literal">MockMVC</code> and its <code class="literal">MockRestServiceServer</code> can be used for testing HTTP.
</li><li class="listitem">
Some RDBMS vendors provide embedded data bases for JDBC or JPA support.
</li><li class="listitem">
ActiveMQ can be embedded for testing JMS or STOMP protocols.
</li><li class="listitem">
There are tools for embedded MongoDB and Redis.
</li><li class="listitem">
Tomcat and Jetty have embedded libraries to test real HTTP, Web Services, or WebSockets.
</li><li class="listitem">
The <code class="literal">FtpServer</code> and <code class="literal">SshServer</code> from the Apache Mina project can be used for testing the FTP and SFTP protocols.
</li><li class="listitem">
Gemfire and Hazelcast can be run as real-data grid nodes in the tests.
</li><li class="listitem">
The Curator Framework provides a <code class="literal">TestingServer</code> for Zookeeper interaction.
</li><li class="listitem">
Apache Kafka provides admin tools to embed a Kafka Broker in the tests.
</li></ul></div>
<p>Most of these tools and libraries are used in Spring Integration tests.
Also, from the GitHub <a class="ulink" href="https://github.com/spring-projects/spring-integration" target="_top">repository</a> (in the <code class="literal">test</code> directory of each module), you can discover ideas for how to build your own tests for integration solutions.</p>
<p>The rest of this chapter describes the testing tools and utilities provided by Spring Integration.</p>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="testing-utilities" href="#testing-utilities"></a>F.1&nbsp;Testing Utilities</h2></div></div></div>

<p>The <code class="literal">spring-integration-test-support</code> module provides utilities and helpers for unit testing.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_testutils" href="#_testutils"></a>F.1.1&nbsp;TestUtils</h3></div></div></div>

<p>The <code class="literal">TestUtils</code> class is mostly used for properties assertions in JUnit tests, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Test</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> loadBalancerRef() {
    MessageChannel channel = channels.get(<span class="hl-string">"lbRefChannel"</span>);
    LoadBalancingStrategy lbStrategy = TestUtils.getPropertyValue(channel,
                 <span class="hl-string">"dispatcher.loadBalancingStrategy"</span>, LoadBalancingStrategy.<span class="hl-keyword">class</span>);
    assertTrue(lbStrategy <span class="hl-keyword">instanceof</span> SampleLoadBalancingStrategy);
}</pre>
</div>
<p><code class="literal">TestUtils.getPropertyValue()</code> is based on Spring&#8217;s <code class="literal">DirectFieldAccessor</code> and provides the ability to get a value from the target private property.
As shown in the preceding example, it also supports nested properties access by using dotted notation.</p>
<p>The <code class="literal">createTestApplicationContext()</code> factory method produces a <code class="literal">TestApplicationContext</code> instance with the supplied Spring Integration environment.</p>
<p>See the <a class="ulink" href="https://docs.spring.io/spring-integration/api/org/springframework/integration/test/util/TestUtils.html" target="_top">Javadoc</a> of other <code class="literal">TestUtils</code> methods for more information about this class.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_using_the_literal_socketutils_literal_class" href="#_using_the_literal_socketutils_literal_class"></a>F.1.2&nbsp;Using the <code class="literal">SocketUtils</code> Class</h3></div></div></div>

<p>The <a class="ulink" href="https://docs.spring.io/spring-integration/api/org/springframework/integration/test/util/SocketUtils.html" target="_top"><code class="literal">SocketUtils</code> class</a> provides several methods that select one or more random ports for exposing server-side components without conflicts, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"socketUtils"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.test.util.SocketUtils"</span><span class="hl-tag"> /&gt;</span>

<span class="hl-tag">&lt;int-syslog:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"syslog"</span>
            <span class="hl-attribute">channel</span>=<span class="hl-value">"sysLogs"</span>
            <span class="hl-attribute">port</span>=<span class="hl-value">"#{socketUtils.findAvailableUdpSocket(1514)}"</span><span class="hl-tag"> /&gt;</span>

<span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"sysLogs"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:queue/&gt;</span>
<span class="hl-tag">&lt;/int:channel&gt;</span></pre>
</div>
<p>The following example shows how the preceding configuration is used from the unit test:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Autowired</span></em> <em><span class="hl-annotation" style="color: gray">@Qualifier("syslog.adapter")</span></em>
<span class="hl-keyword">private</span> UdpSyslogReceivingChannelAdapter adapter;

<em><span class="hl-annotation" style="color: gray">@Autowired</span></em>
<span class="hl-keyword">private</span> PollableChannel sysLogs;
...
<em><span class="hl-annotation" style="color: gray">@Test</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> testSimplestUdp() <span class="hl-keyword">throws</span> Exception {
    <span class="hl-keyword">int</span> port = TestUtils.getPropertyValue(adapter1, <span class="hl-string">"udpAdapter.port"</span>, Integer.<span class="hl-keyword">class</span>);
    <span class="hl-keyword">byte</span>[] buf = <span class="hl-string">"&lt;157&gt;JUL 26 22:08:35 WEBERN TESTING[70729]: TEST SYSLOG MESSAGE"</span>.getBytes(<span class="hl-string">"UTF-8"</span>);
    DatagramPacket packet = <span class="hl-keyword">new</span> DatagramPacket(buf, buf.length,
                              <span class="hl-keyword">new</span> InetSocketAddress(<span class="hl-string">"localhost"</span>, port));
    DatagramSocket socket = <span class="hl-keyword">new</span> DatagramSocket();
    socket.send(packet);
    socket.close();
    Message&lt;?&gt; message = foo.receive(<span class="hl-number">10000</span>);
    assertNotNull(message);
}</pre>
</div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>This technique is not foolproof.
Some other process could be allocated the "<code class="literal">free</code>" port before your test opens it.
It is generally more preferable to use server port <code class="literal">0</code>, let the operating system select the port for you, and then discover the selected port in your test.
We have converted most framework tests to use this preferred technique.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_using_literal_onlyoncetrigger_literal" href="#_using_literal_onlyoncetrigger_literal"></a>F.1.3&nbsp;Using <code class="literal">OnlyOnceTrigger</code></h3></div></div></div>

<p><a class="ulink" href="https://docs.spring.io/spring-integration/api/org/springframework/integration/test/util/OnlyOnceTrigger.html" target="_top"><code class="literal">OnlyOnceTrigger</code></a> is useful for polling endpoints when you need to produce only one test message and verify the behavior without impacting other period messages.
The following example shows how to configure <code class="literal">OnlyOnceTrigger</code>:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"testTrigger"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.test.util.OnlyOnceTrigger"</span><span class="hl-tag"> /&gt;</span>

<span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">id</span>=<span class="hl-value">"jpaPoller"</span> <span class="hl-attribute">trigger</span>=<span class="hl-value">"testTrigger"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:transactional</span> <span class="hl-attribute">transaction-manager</span>=<span class="hl-value">"transactionManager"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/int:poller&gt;</span></pre>
</div>
<p>The following example shows how to use the preceding configuration of <code class="literal">OnlyOnceTrigger</code> for testing:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Autowired</span></em>
<em><span class="hl-annotation" style="color: gray">@Qualifier("jpaPoller")</span></em>
PollerMetadata poller;

<em><span class="hl-annotation" style="color: gray">@Autowired</span></em>
OnlyOnceTrigger testTrigger;
...
<em><span class="hl-annotation" style="color: gray">@Test</span></em>
<em><span class="hl-annotation" style="color: gray">@DirtiesContext</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> testWithEntityClass() <span class="hl-keyword">throws</span> Exception {
    <span class="hl-keyword">this</span>.testTrigger.reset();
    ...
    JpaPollingChannelAdapter jpaPollingChannelAdapter = <span class="hl-keyword">new</span> JpaPollingChannelAdapter(jpaExecutor);

    SourcePollingChannelAdapter adapter = JpaTestUtils.getSourcePollingChannelAdapter(
    		jpaPollingChannelAdapter, <span class="hl-keyword">this</span>.outputChannel, <span class="hl-keyword">this</span>.poller, <span class="hl-keyword">this</span>.context,
    		<span class="hl-keyword">this</span>.getClass().getClassLoader());
    adapter.start();
    ...
}</pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_support_components" href="#_support_components"></a>F.1.4&nbsp;Support Components</h3></div></div></div>

<p>The <code class="literal">org.springframework.integration.test.support</code> package contains various abstract classes that you should implement in target tests</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="ulink" href="https://docs.spring.io/spring-integration/api/org/springframework/integration/test/support/AbstractRequestResponseScenarioTests.html" target="_top"><code class="literal">AbstractRequestResponseScenarioTests</code></a>
</li><li class="listitem">
<a class="ulink" href="https://docs.spring.io/spring-integration/api/org/springframework/integration/test/support/AbstractResponseValidator.html" target="_top"><code class="literal">AbstractResponseValidator</code></a>
</li><li class="listitem">
<a class="ulink" href="https://docs.spring.io/spring-integration/api/org/springframework/integration/test/support/LogAdjustingTestSupport.html" target="_top"><code class="literal">LogAdjustingTestSupport</code></a> (Deprecated)
</li><li class="listitem">
<a class="ulink" href="https://docs.spring.io/spring-integration/api/org/springframework/integration/test/support/MessageValidator.html" target="_top"><code class="literal">MessageValidator</code></a>
</li><li class="listitem">
<a class="ulink" href="https://docs.spring.io/spring-integration/api/org/springframework/integration/test/support/PayloadValidator.html" target="_top"><code class="literal">PayloadValidator</code></a>
</li><li class="listitem">
<a class="ulink" href="https://docs.spring.io/spring-integration/api/org/springframework/integration/test/support/RequestResponseScenario.html" target="_top"><code class="literal">RequestResponseScenario</code></a>
</li><li class="listitem">
<a class="ulink" href="https://docs.spring.io/spring-integration/api/org/springframework/integration/test/support/SingleRequestResponseScenarioTests.html" target="_top"><code class="literal">SingleRequestResponseScenarioTests</code></a>
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="test-junit-rules" href="#test-junit-rules"></a>F.1.5&nbsp;JUnit Rules and Conditions</h3></div></div></div>

<p>The <code class="literal">LongRunningIntegrationTest</code> JUnit 4 test rule is present to indicate if test should be run if <code class="literal">RUN_LONG_INTEGRATION_TESTS</code> environment or system property is set to <code class="literal">true</code>.
Otherwise it is skipped.
For the same reason since version 5.1, a <code class="literal">@LongRunningTest</code> conditional annotation is provided for JUnit 5 tests.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_hamcrest_and_mockito_matchers" href="#_hamcrest_and_mockito_matchers"></a>F.1.6&nbsp;Hamcrest and Mockito Matchers</h3></div></div></div>

<p>The <code class="literal">org.springframework.integration.test.matcher</code> package contains several <code class="literal">Matcher</code> implementations to assert <code class="literal">Message</code> and its properties in unit tests.
The following example shows how to use one such matcher (<code class="literal">PayloadMatcher</code>):</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">import</span> <span class="hl-keyword">static</span> org.springframework.integration.test.matcher.PayloadMatcher.hasPayload;
...
<em><span class="hl-annotation" style="color: gray">@Test</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> transform_withFilePayload_convertedToByteArray() <span class="hl-keyword">throws</span> Exception {
    Message&lt;?&gt; result = <span class="hl-keyword">this</span>.transformer.transform(message);
    assertThat(result, is(notNullValue()));
    assertThat(result, hasPayload(is(instanceOf(<span class="hl-keyword">byte</span>[].<span class="hl-keyword">class</span>))));
    assertThat(result, hasPayload(SAMPLE_CONTENT.getBytes(DEFAULT_ENCODING)));
}</pre>
</div>
<p>The <code class="literal">MockitoMessageMatchers</code> factory can be used for mocks for stubbing and verifications, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">static</span> <span class="hl-keyword">final</span> Date SOME_PAYLOAD = <span class="hl-keyword">new</span> Date();

<span class="hl-keyword">static</span> <span class="hl-keyword">final</span> String SOME_HEADER_VALUE = <span class="hl-string">"bar"</span>;

<span class="hl-keyword">static</span> <span class="hl-keyword">final</span> String SOME_HEADER_KEY = <span class="hl-string">"test.foo"</span>;
...
Message&lt;?&gt; message = MessageBuilder.withPayload(SOME_PAYLOAD)
                .setHeader(SOME_HEADER_KEY, SOME_HEADER_VALUE)
                .build();
MessageHandler handler = mock(MessageHandler.<span class="hl-keyword">class</span>);
handler.handleMessage(message);
verify(handler).handleMessage(messageWithPayload(SOME_PAYLOAD));
verify(handler).handleMessage(messageWithPayload(is(instanceOf(Date.<span class="hl-keyword">class</span>))));
...
MessageChannel channel = mock(MessageChannel.<span class="hl-keyword">class</span>);
when(channel.send(messageWithHeaderEntry(SOME_HEADER_KEY, is(instanceOf(Short.<span class="hl-keyword">class</span>)))))
        .thenReturn(true);
assertThat(channel.send(message), is(false));</pre>
</div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="test-context" href="#test-context"></a>F.2&nbsp;Spring Integration and the Test Context</h2></div></div></div>

<p>Typically, tests for Spring applications use the Spring Test Framework.
Since Spring Integration is based on the Spring Framework foundation, everything we can do with the Spring Test Framework also applies when testing integration flows.
The <code class="literal">org.springframework.integration.test.context</code> package provides some components for enhancing the test context for integration needs.
First of all, we configure our test class with a <code class="literal">@SpringIntegrationTest</code> annotation to enable the Spring Integration Test Framework, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@RunWith(SpringRunner.class)</span></em>
<em><span class="hl-annotation" style="color: gray">@SpringIntegrationTest(noAutoStartup = {"inboundChannelAdapter", "*Source*"})</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyIntegrationTests {

    <em><span class="hl-annotation" style="color: gray">@Autowired</span></em>
    <span class="hl-keyword">private</span> MockIntegrationContext mockIntegrationContext;

}</pre>
</div>
<p>The <code class="literal">@SpringIntegrationTest</code> annotation populates a <code class="literal">MockIntegrationContext</code> bean, which you can autowire to the test class to access its methods.
With the <code class="literal">noAutoStartup</code> option, the Spring Integration Test Framework prevents endpoints that are normally <code class="literal">autoStartup=true</code> from starting. The endpoints are matched to the provided patterns, which support the following simple pattern styles: <code class="literal">xxx*</code>, <code class="literal">*xxx</code>, <code class="literal">*xxx*</code>, and <code class="literal">xxx*yyy</code>.</p>
<p>This is useful when we would like to not have real connections to the target systems from inbound channel adapters (for example an AMQP Inbound Gateway, JDBC Polling Channel Adapter, WebSocket Message Producer in client mode, and so on).</p>
<p>The <code class="literal">MockIntegrationContext</code> is meant to be used in the target test cases for modifications to beans in the real application context.
For example, endpoints that have <code class="literal">autoStartup</code> overridden to <code class="literal">false</code> can be replaced with mocks, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Test</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> testMockMessageSource() {
    MessageSource&lt;String&gt; messageSource = () -&gt; <span class="hl-keyword">new</span> GenericMessage&lt;&gt;(<span class="hl-string">"foo"</span>);

    <span class="hl-keyword">this</span>.mockIntegrationContext.substituteMessageSourceFor(<span class="hl-string">"mySourceEndpoint"</span>, messageSource);

    Message&lt;?&gt; receive = <span class="hl-keyword">this</span>.results.receive(<span class="hl-number">10</span>_<span class="hl-number">000</span>);
    assertNotNull(receive);
}</pre>
</div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The <code class="literal">mySourceEndpoint</code> refers here to the bean name of the <code class="literal">SourcePollingChannelAdapter</code> for which we replace the real <code class="literal">MessageSource</code> with our mock.
Similarly the <code class="literal">MockIntegrationContext.substituteMessageHandlerFor()</code> expects a bean name for the <code class="literal">IntegrationConsumer</code>, which wraps a <code class="literal">MessageHandler</code> as an endpoint.</p>
</td></tr></table></div>
<p>After test is performed you can restore the state of endpoint beans to the real configuration using <code class="literal">MockIntegrationContext.resetBeans()</code>:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@After</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> tearDown() {
    <span class="hl-keyword">this</span>.mockIntegrationContext.resetBeans();
}</pre>
</div>
<p>See the <a class="ulink" href="https://docs.spring.io/spring-integration/api/org/springframework/integration/test/context/MockIntegrationContext.html" target="_top">Javadoc</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="testing-mocks" href="#testing-mocks"></a>F.3&nbsp;Integration Mocks</h2></div></div></div>

<p>The <code class="literal">org.springframework.integration.test.mock</code> package offers tools and utilities for mocking, stubbing, and verification of activity on Spring Integration components.
The mocking functionality is fully based on and compatible with the well known Mockito Framework.
(The current Mockito transitive dependency is on version 2.5.x or higher.)</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_mockintegration" href="#_mockintegration"></a>F.3.1&nbsp;MockIntegration</h3></div></div></div>

<p>The <code class="literal">MockIntegration</code> factory provides an API to build mocks for Spring Integration beans that are parts of the integration flow (<code class="literal">MessageSource</code>, <code class="literal">MessageProducer</code>, <code class="literal">MessageHandler</code>, and <code class="literal">MessageChannel</code>).
You can use the target mocks during the configuration phase as well as in the target test method to replace the real endpoints before performing verifications and assertions, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:inbound-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"inboundChannelAdapter"</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"results"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.test.mock.MockIntegration"</span> <span class="hl-attribute">factory-method</span>=<span class="hl-value">"mockMessageSource"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"a"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;constructor-arg&gt;</span>
            <span class="hl-tag">&lt;array&gt;</span>
                <span class="hl-tag">&lt;value&gt;</span>b<span class="hl-tag">&lt;/value&gt;</span>
                <span class="hl-tag">&lt;value&gt;</span>c<span class="hl-tag">&lt;/value&gt;</span>
            <span class="hl-tag">&lt;/array&gt;</span>
        <span class="hl-tag">&lt;/constructor-arg&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>
<span class="hl-tag">&lt;/int:inbound-channel-adapter&gt;</span></pre>
</div>
<p>The following example shows how to use Java Configuration to achieve the same configuration as the preceding example:</p>
<div class="informalexample">
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@InboundChannelAdapter(channel = "results")</span></em>
<em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> MessageSource&lt;Integer&gt; testingMessageSource() {
    <span class="hl-keyword">return</span> MockIntegration.mockMessageSource(<span class="hl-number">1</span>, <span class="hl-number">2</span>, <span class="hl-number">3</span>);
}
...
StandardIntegrationFlow flow = IntegrationFlows
        .from(MockIntegration.mockMessageSource(<span class="hl-string">"foo"</span>, <span class="hl-string">"bar"</span>, <span class="hl-string">"baz"</span>))
        .&lt;String, String&gt;transform(String::toUpperCase)
        .channel(out)
        .get();
IntegrationFlowRegistration registration = <span class="hl-keyword">this</span>.integrationFlowContext.registration(flow)
        .register();</pre>
</div>
<p>For this purpose, the aforementioned <code class="literal">MockIntegrationContext</code> should be used from the test, as the following example shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">this</span>.mockIntegrationContext.substituteMessageSourceFor(<span class="hl-string">"mySourceEndpoint"</span>,
        MockIntegration.mockMessageSource(<span class="hl-string">"foo"</span>, <span class="hl-string">"bar"</span>, <span class="hl-string">"baz"</span>));
Message&lt;?&gt; receive = <span class="hl-keyword">this</span>.results.receive(<span class="hl-number">10</span>_<span class="hl-number">000</span>);
assertNotNull(receive);
assertEquals(<span class="hl-string">"FOO"</span>, receive.getPayload());</pre>
</div>
<p>Unlike the Mockito <code class="literal">MessageSource</code> mock object, the <code class="literal">MockMessageHandler</code> is a regular <code class="literal">AbstractMessageProducingHandler</code> extension with a chain API to stub handling for incoming messages.
The <code class="literal">MockMessageHandler</code> provides <code class="literal">handleNext(Consumer&lt;Message&lt;?&gt;&gt;)</code> to specify a one-way stub for the next request message.
It is used to mock message handlers that do not produce replies.
<code class="literal">handleNextAndReply(Function&lt;Message&lt;?&gt;, ?&gt;)</code> is provided for performing the same stub logic for the next request message and producing a reply for it.
They can be chained to simulate any arbitrary request-reply scenarios for all expected request messages variants.
These consumers and functions are applied to the incoming messages, one at a time from the stack, until the last, which is then used for all remaining messages.
The behavior is similar to the Mockito <code class="literal">Answer</code> or <code class="literal">doReturn()</code> API.</p>
<p>In addition, you can supply a Mockito <code class="literal">ArgumentCaptor&lt;Message&lt;?&gt;&gt;</code> to the <code class="literal">MockMessageHandler</code> in a constructor argument.
Each request message for the <code class="literal">MockMessageHandler</code> is captured by that <code class="literal">ArgumentCaptor</code>.
During the test, you can use its <code class="literal">getValue()</code> and <code class="literal">getAllValues()</code> methods to verify and assert those request messages.</p>
<p>The <code class="literal">MockIntegrationContext</code> provides a <code class="literal">substituteMessageHandlerFor()</code> API that lets you replace the actual configured <code class="literal">MessageHandler</code> with a <code class="literal">MockMessageHandler</code> in the endpoint under test.</p>
<p>The following example shows a typical usage scenario:</p>
<div class="informalexample">
<pre class="programlisting">ArgumentCaptor&lt;Message&lt;?&gt;&gt; messageArgumentCaptor = ArgumentCaptor.forClass(Message.<span class="hl-keyword">class</span>);

MessageHandler mockMessageHandler =
        mockMessageHandler(messageArgumentCaptor)
                .handleNextAndReply(m -&gt; m.getPayload().toString().toUpperCase());

<span class="hl-keyword">this</span>.mockIntegrationContext.substituteMessageHandlerFor(<span class="hl-string">"myService.serviceActivator"</span>,
                               mockMessageHandler);
GenericMessage&lt;String&gt; message = <span class="hl-keyword">new</span> GenericMessage&lt;&gt;(<span class="hl-string">"foo"</span>);
<span class="hl-keyword">this</span>.myChannel.send(message);
Message&lt;?&gt; received = <span class="hl-keyword">this</span>.results.receive(<span class="hl-number">10000</span>);
assertNotNull(received);
assertEquals(<span class="hl-string">"FOO"</span>, received.getPayload());
assertSame(message, messageArgumentCaptor.getValue());</pre>
</div>
<p>See the <a class="ulink" href="https://docs.spring.io/spring-integration/api/org/springframework/integration/test/mock/MockIntegration.html" target="_top"><code class="literal">MockIntegration</code></a> and <a class="ulink" href="https://docs.spring.io/spring-integration/api/org/springframework/integration/test/mock/MockMessageHandler.html" target="_top"><code class="literal">MockMessageHandler</code></a> Javadoc for more information.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="testing-other-resources" href="#testing-other-resources"></a>F.4&nbsp;Other Resources</h2></div></div></div>

<p>As well as exploring the test cases in the framework itself, the <a class="ulink" href="https://github.com/spring-projects/spring-integration-samples" target="_top">Spring Integration Samples repository</a> has some sample applications specifically made to show testing, such as <code class="literal">testing-examples</code> and <code class="literal">advanced-testing-examples</code>.
In some cases, the samples themselves have comprehensive end-to-end tests, such as the <code class="literal">file-split-ftp</code> sample.</p>
</div>
</div>
<div class="appendix"><div class="titlepage"><div><div><h2 class="title"><a name="samples" href="#samples"></a>Appendix&nbsp;G.&nbsp;Spring Integration Samples</h2></div></div></div>

<p>As of Spring Integration 2.0, the Spring Integration distribution no&nbsp;longer includes the samples.
Instead, we have switched to a much simpler collaborative model that should promote better community participation and, ideally, more contributions.
Samples now have a dedicated Git repository and a dedicated JIRA Issue Tracking system.
Sample development also has its own lifecycle, which is not dependent on the lifecycle of the framework releases, although the repository is still tagged with each major release for compatibility reasons.</p>
<p>The great benefit to the community is that we can now add more samples and make them available to you right away without waiting for the next release.
Having its own JIRA that is not tied to the the actual framework is also a great benefit.
You now have a dedicated place to suggest samples as well as report issues with existing samples.
You can also submit a sample to us as an attachment through JIRA or, better, through the collaborative model that Git promotes.
If we believe your sample adds value, we would be more then glad to add it to the <span class="emphasis"><em>samples</em></span> repository, properly crediting you as the author.</p>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="samples-get" href="#samples-get"></a>G.1&nbsp;Where to Get Samples</h2></div></div></div>

<p>The Spring Integration Samples project is hosted on <a class="ulink" href="https://github.com/SpringSource/spring-integration-samples/" target="_top">GitHub</a>.
You can find the repository at:</p>
<p><a class="ulink" href="https://github.com/SpringSource/spring-integration-samples" target="_top">https://github.com/SpringSource/spring-integration-samples</a></p>
<p>In order to check out or clone the samples, you must have a Git client installed on your system.
There are several GUI-based products available for many platforms (such as <a class="ulink" href="http://eclipse.org/egit/" target="_top">EGit</a> for the Eclipse IDE).
A simple Google search can help you find them.
You can also use the command line interface for &lt;<a class="ulink" href="http://git-scm.com/,Git&gt;" target="_top">http://git-scm.com/,Git&gt;</a>.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>If you need more information on how to install or use Git, visit: <a class="ulink" href="http://git-scm.com/" target="_top">http://git-scm.com/</a>.</p>
</td></tr></table></div>
<p>To clone (check out) the Spring Integration samples repository by using the Git command line tool, issue the following command:</p>
<div class="informalexample">
<pre class="programlisting">$ git clone&nbsp;https://github.com/SpringSource/spring-integration-samples.git</pre>
</div>
<p>The preceding command clones the entire samples repository into a directory named <code class="literal">spring-integration-samples</code> within the working directory where you issued that <code class="literal">git</code> command.
Since the samples repository is a live repository, you might want to perform periodic pulls (updates) to get new samples and updates to the existing samples.
To do so, issue the following <code class="literal">git pull</code> command:</p>
<div class="informalexample">
<pre class="programlisting">$ git pull</pre>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_submitting_samples_or_sample_requests" href="#_submitting_samples_or_sample_requests"></a>G.2&nbsp;Submitting Samples or Sample Requests</h2></div></div></div>

<p>You can submit both new samples and requests for samples. We greatly appreciate any effort toward improving the samples, including the sharing of good ideas.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="samples-how-can-i-contribute" href="#samples-how-can-i-contribute"></a>G.2.1&nbsp;How Can I Contribute My Own Samples?</h3></div></div></div>

<p>Github is for social coding: if you want to submit your own code examples to the Spring Integration Samples project, we encourage contributions through <a class="ulink" href="http://help.github.com/send-pull-requests/" target="_top">pull requests</a> from <a class="ulink" href="http://help.github.com/fork-a-repo/" target="_top">forks</a> of this repository.
If you want to contribute code this way, please reference, if possible, a <a class="ulink" href="https://jira.springframework.org/browse/INTSAMPLES" target="_top">JIRA ticket</a> that provides some details regarding your sample.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important: Sign the contributor license agreement"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Sign the contributor license agreement</th></tr><tr><td align="left" valign="top">

<p>Very important: Before we can accept your Spring Integration sample, we need you to sign the SpringSource contributor license agreement (CLA).
Signing the contributor&#8217;s agreement does not grant anyone commit rights to the main repository, but it does mean that we can accept your contributions, and you will get an author credit if we do.
In order to read and sign the CLA, go to:</p>
<p><a class="ulink" href="https://support.springsource.com/spring_committer_signup" target="_top">https://support.springsource.com/spring_committer_signup</a></p>
<p>From the <span class="strong"><strong>Project</strong></span> drop down, select <span class="strong"><strong>Spring Integration</strong></span>.
The Project Lead is Gary Russell.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_code_contribution_process" href="#_code_contribution_process"></a>G.2.2&nbsp;Code Contribution Process</h3></div></div></div>

<p>For the actual code contribution process, read the the Contributor Guidelines for Spring Integration.
They apply for the samples project as well.
You can find them at <a class="ulink" href="https://github.com/spring-projects/spring-integration/blob/master/CONTRIBUTING.md" target="_top">https://github.com/spring-projects/spring-integration/blob/master/CONTRIBUTING.md</a></p>
<p>This process ensures that every commit gets peer-reviewed.
As a matter of fact, the core committers follow the exact same rules.
We gratefully look forward to your Spring Integration samples!</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_sample_requests" href="#_sample_requests"></a>G.2.3&nbsp;Sample Requests</h3></div></div></div>

<p>As <a class="link" href="#samples-how-can-i-contribute" title="G.2.1&nbsp;How Can I Contribute My Own Samples?">mentioned earlier</a>, the Spring Integration Samples project has a dedicated JIRA issue tracking system.
To submit new sample requests, visit the JIRA Issue Tracking system at <a class="ulink" href="https://jira.springframework.org/browse/INTSAMPLES" target="_top">https://jira.springframework.org/browse/INTSAMPLES</a>.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="samples-structure" href="#samples-structure"></a>G.3&nbsp;Samples Structure</h2></div></div></div>

<p>Starting with Spring Integration 2.0, the structure of the samples has changed.
With plans for more samples, we realized that not all samples have the same goals.
They all share the common goal of showing you how to apply and work with the Spring Integration framework.
However, they differ in that some samples concentrate on a technical use case, while others focus on a business use case.
Also, some samples are about showcasing various techniques that could be applied to address certain scenarios (both technical and business).
The new categorization of samples lets us better organize them based on the problem each sample addresses while giving you a simpler way of finding the right sample for your needs.</p>
<p>Currently there are four categories.
Within the samples repository, each category has its own directory, which is named after the category name:</p>
<div class="variablelist"><dl class="variablelist"><dt><span class="term">Basic (<code class="literal">samples/basic</code>)</span></dt><dd>
This is a good place to get started.
The samples here are technically motivated and demonstrate the bare minimum with regard to configuration and code.
These should help you to get started quickly by introducing you to the basic concepts, API, and configuration of Spring Integration as well as Enterprise Integration Patterns (EIP).
For example, if you are looking for an answer on how to implement and wire a service activator to a message channel, how to use a messaging gateway as a facade to your message exchange, or how to get started with MAIL, TCP/UDP or other modules, this is the right place to find a good sample.
The bottom line is <code class="literal">samples/basic</code> is a good place to get started.
</dd><dt><span class="term">Intermediate (<code class="literal">samples/intermediate</code>)</span></dt><dd>
This category targets developers who are already familiar with the Spring Integration framework (beyond getting started) but need some more guidance while resolving the&nbsp;more advanced technical problems they might encounter after switching to a messaging architecture.
For example, if you are looking for an answer on how to handle errors in various message exchange scenarios or how to properly configure the aggregator for a situation where some messages do not ever arrive for aggregation, or any other issue that goes beyond a basic implementation and configuration of a particular component and exposes "<code class="literal">what else</code>" types of problems, this is the right place to find these type of samples.
</dd><dt><span class="term">Advanced (<code class="literal">samples/advanced</code>)</span></dt><dd>
This category targets developers who are very familiar with the Spring Integration framework but are looking to extend it to address a specific custom need by using Spring Integration&#8217;s public API.
For example, if you are looking for samples showing you how to implement a custom channel or consumer (event-based or polling-based) or you are trying to figure out the most appropriate way to implement a custom bean parser on top of the Spring Integration&nbsp;bean parser&nbsp;hierarchy (perhaps when implementing your own namespace and schema for a custom component), this is the right place to look.
Here you can also find samples that will help you with adapter development.
Spring Integration comes with an extensive library of adapters to let you connect remote systems with the Spring Integration messaging framework.
However, you might need to integrate with a system for which the core framework does not provide an adapter.
If so, you might decide to implement your own (please consider contributing it).
This category would include samples showing you how.
</dd><dt><span class="term">Applications (<code class="literal">samples/applications</code>)</span></dt><dd>
This category targets developers and architects who have a good understanding of message-driven architecture and EIP and an above-average understanding of Spring and Spring Integration who are looking for samples that address a particular business problem.
In other words, the emphasis of the samples in this category is business use cases and how they can be solved with a message-driven architecture and Spring Integration in particular.
For example, if you want to see how a loan broker or travel agent process could be implemented and automated with Spring Integration, this is the right place to find these types of samples.
</dd></dl></div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Spring Integration is a community-driven framework. Therefore community participation is IMPORTANT.
That includes samples.
If you cannot find what you are looking for, let us know!</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="samples-impl" href="#samples-impl"></a>G.4&nbsp;Samples</h2></div></div></div>

<p>Currently, Spring Integration comes with quite a few samples and you can only expect more.
To help you better navigate through them, each sample comes with its own <code class="literal">readme.txt</code> file which covers several details about the sample (for example, what EIP patterns it addresses, what problem it is trying to solve, how to run the sample, and other details).
However, certain samples require a more detailed and sometimes graphical explanation.
In this section, you can find details on samples that we believe require special attention.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="samples-loan-broker" href="#samples-loan-broker"></a>G.4.1&nbsp;Loan Broker</h3></div></div></div>

<p>This section covers the loan broker sample application that is included in the Spring Integration samples.&nbsp;This sample is inspired by one of the samples featured in Gregor Hohpe and Bobby Woolf&#8217;s&nbsp;book, <a class="ulink" href="http://www.eaipatterns.com" target="_top"><span class="emphasis"><em>Enterprise Integration Patterns</em></span></a>.</p>
<p>The following diagram shows the entire process:</p>
<div class="figure"><a name="d5e26796" href="#d5e26796"></a><p class="title"><b>Figure&nbsp;G.1.&nbsp;Loan Broker Sample</b></p><div class="figure-contents">

<div class="mediaobject" align="center"><img src="images/loan-broker-eip.png" align="middle" alt="loan broker eip"></div>
</div></div><br class="figure-break">
<p>At the core of an EIP architecture are the very simple yet powerful concepts of pipes, filters, and, of course: messages.
Endpoints (filters) are connected with one another via channels (pipes).
Producing endpoints send messages to the channel, and the consuming endpoint retrieves the messages.
This architecture is meant to define various mechanisms that describe how information is exchanged between the endpoints, without any awareness of what those endpoints are or what information they are exchanging.
Thus, it provides for a very loosely coupled and flexible collaboration model while also decoupling integration concerns from business concerns.
EIP extends this architecture by further defining:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
The types of pipes (point-to-point channel, publish-subscribe channel, channel adapter, and others)
</li><li class="listitem">
The core filters and patterns around how filters collaborate with pipes (Message router, splitters and aggregators, various message transformation patterns, and others)
</li></ul></div>
<p><a name="samples-loan-broker-requirements" href="#samples-loan-broker-requirements"></a>Chapter 9 of the EIP book nicely describes the details and variations of this use case, but here is the brief summary: While shopping for the best loan quote, a consumer subscribes to the services of a loan broker, which handles such details as:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Consumer pre-screening (for example, obtaining and reviewing the consumer&#8217;s Credit history)
</li><li class="listitem">
Determining the most appropriate banks (for example, based on the consumer&#8217;s credit history or score)
</li><li class="listitem">
Sending a loan quote request to each selected bank
</li><li class="listitem">
Collecting responses from each bank
</li><li class="listitem">
Filtering responses and determining the best quotes, based on consumer&#8217;s requirements.
</li><li class="listitem">
Pass the Loan quotes back to the consumer.
</li></ul></div>
<p>The real process of obtaining a loan quote is generally a bit more complex.
However, since our goal is to demonstrate how Enterprise Integration Patterns are realized and implemented within Spring Integration, the use case has been simplified to concentrate only on the integration aspects of the process.
It is not an attempt to give you advice in consumer finances.</p>
<p>By engaging a loan broker, the consumer is isolated from the details of the loan broker&#8217;s operations, and each loan broker&#8217;s operations may defer from one another to maintain competitive advantage, so whatever we assemble and implement must be flexible so that any changes could be introduced quickly and painlessly.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The loan broker sample does not actually talk to any <span class="emphasis"><em>imaginary</em></span> Banks or Credit bureaus.
Those services are stubbed out.</p>
</td></tr></table></div>
<p>Our goal here is to assemble, orchestrate, and test the integration aspects of the process as a whole.
Only then can we start thinking about wiring such processes to the real services.
At that time, the assembled process and its configuration do not change regardless of the number of banks with which a particular loan broker deals or the type of communication media (or protocols) used (JMS, WS, TCP, and so on) to communicate with these banks.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_design" href="#_design"></a>Design</h4></div></div></div>

<p>As you analyze the <a class="link" href="#samples-loan-broker-requirements">six requirements</a> listed earlier, you can see that they are all integration concerns.
For example, in the consumer pre-screening step, we need to gather additional information about the consumer and the consumer&#8217;s desires and enrich the loan request with additional meta-information.
We then have to filter such information to select the most appropriate list of banks and so on.
Enrich, filter, and select are all integration concerns for which EIP defines a solution in the form of patterns.
Spring Integration provides an implementation of these patterns.</p>
<p>The following image shows a representation of a messaging gateway:</p>
<div class="figure"><a name="d5e26834" href="#d5e26834"></a><p class="title"><b>Figure&nbsp;G.2.&nbsp;Messaging Gateway</b></p><div class="figure-contents">

<div class="mediaobject" align="center"><img src="images/gateway.jpg" align="middle" alt="gateway"></div>
</div></div><br class="figure-break">
<p>The messaging gateway pattern provides a simple mechanism to access messaging systems, including our loan broker.
In Spring Integration, you can define the gateway as a plain old java interface (you need not provide an implementation), configure it with the XML <code class="literal">&lt;gateway&gt;</code> element or with an annotation in Java, and use it as you would any other Spring bean.
Spring Integration takes care of delegating and mapping method invocations to the messaging infrastructure by generating a message (the payload is mapped to an input parameter of the method) and sending it to the designated channel.
The following example shows how to define such a gateway with XML:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:gateway</span> <span class="hl-attribute">id</span>=<span class="hl-value">"loanBrokerGateway"</span>
  <span class="hl-attribute">default-request-channel</span>=<span class="hl-value">"loanBrokerPreProcessingChannel"</span>
  <span class="hl-attribute">service-interface</span>=<span class="hl-value">"org.springframework.integration.samples.loanbroker.LoanBrokerGateway"</span><span class="hl-tag">&gt;</span>
  <span class="hl-tag">&lt;int:method</span> <span class="hl-attribute">name</span>=<span class="hl-value">"getBestLoanQuote"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;int:header</span> <span class="hl-attribute">name</span>=<span class="hl-value">"RESPONSE_TYPE"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"BEST"</span><span class="hl-tag">/&gt;</span>
  <span class="hl-tag">&lt;/int:method&gt;</span>
<span class="hl-tag">&lt;/int:gateway&gt;</span></pre>
</div>
<p>Our current gateway provides two methods that could be invoked.
One that returns the best single quote and another one that returns all quotes.
Somehow, downstream, we need to know what type of reply the caller needs.
The best way to achieve this in messaging architecture is to enrich the content of the message with some metadata that describes your intentions.
Content Enricher is one of the patterns that addresses this.
Spring Integration does, as a convenience, provide a separate configuration element to enrich message headers with arbitrary data (described later)
However, since the <code class="literal">gateway</code> element is responsible for constructing the initial message, it includes ability to enrich the newly created message with arbitrary message headers.
In our example, we add a <code class="literal">RESPONSE_TYPE</code> header with a value of <code class="literal">BEST</code> whenever the <code class="literal">getBestQuote()</code> method is invoked.
For other methods, we do not add any header.
Now we can check downstream for the existence of this header.
Based on its presence and its value, we can determine what type of reply the caller wants.</p>
<p>Based on the use case, we also know tat some pre-screening steps need to be performed, such as getting and evaluating the consumer&#8217;s credit score, because some premiere banks only accept quote requests from consumers that meet a minimum credit score requirement.
So it would be nice if the message would be enriched with such information before it is forwarded to the banks.
It would also be nice if, when several processes need to be completed to provide such meta-information, those processes could be grouped in a single unit.
In our use case, we need to determine the credit score and, based on the credit score and some rule, select a list of message channels (bank channels) to which to send quote request.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_composed_message_processor" href="#_composed_message_processor"></a>Composed Message Processor</h4></div></div></div>

<p>The composed message processor pattern describes rules around building endpoints that maintain control over message flow, which consists of multiple message processors.
In Spring Integration, the composed message processor pattern is implemented by the <code class="literal">&lt;chain&gt;</code> element.</p>
<p>The following image shows the chain pattern:</p>
<div class="figure"><a name="d5e26856" href="#d5e26856"></a><p class="title"><b>Figure&nbsp;G.3.&nbsp;Chain</b></p><div class="figure-contents">

<div class="mediaobject" align="center"><img src="images/chain.png" align="middle" alt="chain"></div>
</div></div><br class="figure-break">
<p>The preceding image shows that we have a chain with an inner header-enricher element that further enriches the content of the message with the <code class="literal">CREDIT_SCORE</code> header and the value (which is determined by the call to a credit service&#8201;&#8212;&#8201;a simple POJO spring bean identified by <span class="emphasis"><em>creditBureau</em></span> name).
Then it delegates to the message router.</p>
<p>The following image shows the message router pattern:</p>
<div class="figure"><a name="d5e26867" href="#d5e26867"></a><p class="title"><b>Figure&nbsp;G.4.&nbsp;Message Router</b></p><div class="figure-contents">

<div class="mediaobject" align="center"><img src="images/bank-router.jpg" align="middle" alt="bank router"></div>
</div></div><br class="figure-break">
<p>Spring Integration offers several implementations of the message routing pattern.
In this case, we use a router that determines a list of channels based on evaluating an expression (in Spring Expression Language) that looks at the credit score (determined in the previous step) and selects the list of channels from the <code class="literal">Map</code> bean with an <code class="literal">id</code> of <code class="literal">banks</code> whose values are <code class="literal">premier</code> or <code class="literal">secondary</code>, based on the value of credit score.
Once the list of channels is selected, the message is routed to those channels.</p>
<p>Now, one last thing the loan broker needs to receive the loan quotes form the banks, aggregate them by consumer (we do not want to show quotes from one consumer to another), assemble the response based on the consumer&#8217;s selection criteria (single best quote or all quotes) and send the reply to the consumer.</p>
<p>The following image shows the message aggregator pattern:</p>
<div class="figure"><a name="d5e26882" href="#d5e26882"></a><p class="title"><b>Figure&nbsp;G.5.&nbsp;Message Aggregator</b></p><div class="figure-contents">

<div class="mediaobject" align="center"><img src="images/quotes-aggregator.jpg" align="middle" alt="quotes aggregator"></div>
</div></div><br class="figure-break">
<p>An aggregator pattern describes an endpoint that groups related messages into a single message.
Criteria and rules can be provided to determine an aggregation and correlation strategy.
Spring Integration provides several implementations of the aggregator pattern as well as a convenient namespace-based configuration.</p>
<p>The following example shows how to define an aggregator:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:aggregator</span> <span class="hl-attribute">id</span>=<span class="hl-value">"quotesAggregator"</span>
      <span class="hl-attribute">input-channel</span>=<span class="hl-value">"quotesAggregationChannel"</span>
      <span class="hl-attribute">method</span>=<span class="hl-value">"aggregateQuotes"</span><span class="hl-tag">&gt;</span>
  <span class="hl-tag">&lt;beans:bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.samples.loanbroker.LoanQuoteAggregator"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/int:aggregator&gt;</span></pre>
</div>
<p>Our Loan Broker defines a <span class="emphasis"><em>quotesAggregator</em></span> bean with the <code class="literal">&lt;aggregator&gt;</code> element, which provides a default aggregation and correlation strategy.
The default correlation strategy correlates messages based on the <code class="literal">correlationId</code> header (see <a class="ulink" href="http://www.enterpriseintegrationpatterns.com/patterns/messaging/CorrelationIdentifier.html" target="_top">the correlation identifier pattern in the EIP book</a>).
Note that we never provided the value for this header.
It was automatically set earlier by the router, when it generated a separate message for each bank channel.</p>
<p>Once the messages are correlated, they are released to the actual aggregator implementation.
Although Spring Integration provides a default aggregator, its strategy (gather the list of payloads from all messages and construct a new message with this list as its payload) does not satisfy our requirement.
Having all the results in the message is a problem, because our consumer might require a single best quote or all quotes.
To communicate the consumer&#8217;s intention, earlier in the process we set the <code class="literal">RESPONSE_TYPE</code> header.
Now we have to evaluate this header and return either all the quotes (the default aggregation strategy would work) or the best quote (the default aggregation strategy does not work because we have to determine which loan quote is the best).</p>
<p>In a more realistic application, selecting the best quote might be based on complex criteria that might influence the complexity of the aggregator implementation and configuration.
For now, though, we are making it simple.
If the consumer wants the best quote, we select a quote with the lowest interest rate.
To accomplish that, the <code class="literal">LoanQuoteAggregator</code> class sorts all the quotes by interest rate and returns the first one.
The <code class="literal">LoanQuote</code> class implements <code class="literal">Comparable</code> to compare quotes based on the rate attribute.
Once the response message is created, it is sent to the default reply channel of the messaging gateway (and, thus, to the consumer) that started the process.
Our consumer got the loan quote!</p>
<p>In conclusion, a rather complex process was assembled based on POJO (that is existing or legacy) logic and a light-weight, embeddable messaging framework (Spring Integration) with a loosely coupled programming model intended to simplify integration of heterogeneous systems without requiring a heavy-weight ESB-like engine or a proprietary development and deployment environment.
As a developer, you should not need to port your Swing or console-based application to an ESB-like server or implement proprietary interfaces just because you have an integration concern.</p>
<p>This sample and the other samples in this section are built on top of Enterprise Integration Patterns.
You can consider them to be "<code class="literal">building blocks</code>" for your solution.
They are not intended to be complete solutions.
Integration concerns exist in all types of application (whether server-based or not).
Our goal is to make is so that integrating applications does not require changes in design, testing, and deployment strategy.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="samples-cafe" href="#samples-cafe"></a>G.4.2&nbsp;The Cafe Sample</h3></div></div></div>

<p>This section covers the cafe sample application that is included in the Spring Integration samples.&nbsp;This sample is inspired by another sample featured in Gregor Hohpe&#8217;s&nbsp;<a class="ulink" href="http://www.eaipatterns.com/ramblings.html" target="_top">Ramblings</a>.</p>
<p>The domain is that of a cafe, and  the following diagram depicts the basic flow:</p>
<div class="figure"><a name="d5e26912" href="#d5e26912"></a><p class="title"><b>Figure&nbsp;G.6.&nbsp;Cafe Sample</b></p><div class="figure-contents">

<div class="mediaobject" align="center"><img src="images/cafe-eip.png" align="middle" alt="cafe eip"></div>
</div></div><br class="figure-break">
<p>The <code class="literal">Order</code> object may contain multiple <code class="literal">OrderItems</code>.
Once the order is placed, a splitter breaks the composite order message into a single message for each drink.
Each of these is then processed by a router that determines whether the drink is hot or cold (by checking the <code class="literal">OrderItem</code> object&#8217;s <span class="emphasis"><em>isIced</em></span> property).
The <code class="literal">Barista</code> prepares each drink, but hot and cold drink preparation are handled by two distinct methods: <span class="emphasis"><em>prepareHotDrink</em></span> and <span class="emphasis"><em>prepareColdDrink</em></span>.
The prepared drinks are then sent to the <code class="literal">Waiter</code> where they are aggregated into a <code class="literal">Delivery</code> object.</p>
<p>The following listing shows the XML configuration:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans:beans</span> <span class="hl-attribute">xmlns:int</span>=<span class="hl-value">"http://www.springframework.org/schema/integration"</span>
 <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
 <span class="hl-attribute">xmlns:beans</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
 <span class="hl-attribute">xmlns:int-stream</span>=<span class="hl-value">"http://www.springframework.org/schema/integration/stream"</span>
 <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"http://www.springframework.org/schema/beans
  http://www.springframework.org/schema/beans/spring-beans.xsd
  http://www.springframework.org/schema/integration
  http://www.springframework.org/schema/integration/spring-integration.xsd
  http://www.springframework.org/schema/integration/stream
  http://www.springframework.org/schema/integration/stream/spring-integration-stream.xsd"</span><span class="hl-tag">&gt;</span>

    <span class="hl-tag">&lt;int:gateway</span> <span class="hl-attribute">id</span>=<span class="hl-value">"cafe"</span> <span class="hl-attribute">service-interface</span>=<span class="hl-value">"o.s.i.samples.cafe.Cafe"</span><span class="hl-tag">/&gt;</span>

    <span class="hl-tag">&lt;int:channel</span>  <span class="hl-attribute">id</span>=<span class="hl-value">"orders"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int:splitter</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"orders"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"orderSplitter"</span>
                  <span class="hl-attribute">method</span>=<span class="hl-value">"split"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"drinks"</span><span class="hl-tag">/&gt;</span>

    <span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"drinks"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int:router</span>  <span class="hl-attribute">input-channel</span>=<span class="hl-value">"drinks"</span>
                 <span class="hl-attribute">ref</span>=<span class="hl-value">"drinkRouter"</span> <span class="hl-attribute">method</span>=<span class="hl-value">"resolveOrderItemChannel"</span><span class="hl-tag">/&gt;</span>

    <span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"coldDrinks"</span><span class="hl-tag">&gt;</span><span class="hl-tag">&lt;int:queue</span> <span class="hl-attribute">capacity</span>=<span class="hl-value">"10"</span><span class="hl-tag">/&gt;</span><span class="hl-tag">&lt;/int:channel&gt;</span>
    <span class="hl-tag">&lt;int:service-activator</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"coldDrinks"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"barista"</span>
                           <span class="hl-attribute">method</span>=<span class="hl-value">"prepareColdDrink"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"preparedDrinks"</span><span class="hl-tag">/&gt;</span>

    <span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"hotDrinks"</span><span class="hl-tag">&gt;</span><span class="hl-tag">&lt;int:queue</span> <span class="hl-attribute">capacity</span>=<span class="hl-value">"10"</span><span class="hl-tag">/&gt;</span><span class="hl-tag">&lt;/int:channel&gt;</span>
    <span class="hl-tag">&lt;int:service-activator</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"hotDrinks"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"barista"</span>
                           <span class="hl-attribute">method</span>=<span class="hl-value">"prepareHotDrink"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"preparedDrinks"</span><span class="hl-tag">/&gt;</span>

    <span class="hl-tag">&lt;int:channel</span> <span class="hl-attribute">id</span>=<span class="hl-value">"preparedDrinks"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;int:aggregator</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"preparedDrinks"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"waiter"</span>
                    <span class="hl-attribute">method</span>=<span class="hl-value">"prepareDelivery"</span> <span class="hl-attribute">output-channel</span>=<span class="hl-value">"deliveries"</span><span class="hl-tag">/&gt;</span>

    <span class="hl-tag">&lt;int-stream:stdout-channel-adapter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"deliveries"</span><span class="hl-tag">/&gt;</span>

    <span class="hl-tag">&lt;beans:bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"orderSplitter"</span>
                <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.samples.cafe.xml.OrderSplitter"</span><span class="hl-tag">/&gt;</span>

    <span class="hl-tag">&lt;beans:bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"drinkRouter"</span>
                <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.integration.samples.cafe.xml.DrinkRouter"</span><span class="hl-tag">/&gt;</span>

    <span class="hl-tag">&lt;beans:bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"barista"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.samples.cafe.xml.Barista"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;beans:bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"waiter"</span>  <span class="hl-attribute">class</span>=<span class="hl-value">"o.s.i.samples.cafe.xml.Waiter"</span><span class="hl-tag">/&gt;</span>

    <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">id</span>=<span class="hl-value">"poller"</span> <span class="hl-attribute">default</span>=<span class="hl-value">"true"</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"1000"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;/beans:beans&gt;</span></pre>
</div>
<p>Each message endpoint connects to input channels, output channels, or both.
Each endpoint manages its own lifecycle (by default, endpoints start automatically upon initialization, to prevent that, add the <code class="literal">auto-startup</code> attribute with a value of <code class="literal">false</code>).
Most importantly, notice that the objects are simple POJOs with strongly typed method arguments.
The following example shows the Splitter:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> OrderSplitter {
    <span class="hl-keyword">public</span> List&lt;OrderItem&gt; split(Order order) {
        <span class="hl-keyword">return</span> order.getItems();
    }
}</pre>
</div>
<p>In the case of the router, the return value does not have to be a <code class="literal">MessageChannel</code> instance (although it can be).
In this example, a <code class="literal">String</code> value that holds the channel name is returned instead, as the following listing shows.</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> DrinkRouter {
    <span class="hl-keyword">public</span> String resolveOrderItemChannel(OrderItem orderItem) {
        <span class="hl-keyword">return</span> (orderItem.isIced()) ? <span class="hl-string">"coldDrinks"</span> : <span class="hl-string">"hotDrinks"</span>;
    }
}</pre>
</div>
<p>Now, turning back to the XML, you can see that there are two <code class="literal">&lt;service-activator&gt;</code> elements.
Each of these is delegating to the same <code class="literal">Barista</code> instance but with different methods (<code class="literal">prepareHotDrink</code> or <code class="literal">prepareColdDrink</code>), each corresponding to one of the two channels where order items have been routed.
The following listing shows the Barista class (which contains the <code class="literal">prepareHotDrink</code> and <code class="literal">prepareColdDrink</code> methods)</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> Barista {

    <span class="hl-keyword">private</span> <span class="hl-keyword">long</span> hotDrinkDelay = <span class="hl-number">5000</span>;
    <span class="hl-keyword">private</span> <span class="hl-keyword">long</span> coldDrinkDelay = <span class="hl-number">1000</span>;

    <span class="hl-keyword">private</span> AtomicInteger hotDrinkCounter = <span class="hl-keyword">new</span> AtomicInteger();
    <span class="hl-keyword">private</span> AtomicInteger coldDrinkCounter = <span class="hl-keyword">new</span> AtomicInteger();

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setHotDrinkDelay(<span class="hl-keyword">long</span> hotDrinkDelay) {
        <span class="hl-keyword">this</span>.hotDrinkDelay = hotDrinkDelay;
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setColdDrinkDelay(<span class="hl-keyword">long</span> coldDrinkDelay) {
        <span class="hl-keyword">this</span>.coldDrinkDelay = coldDrinkDelay;
    }

    <span class="hl-keyword">public</span> Drink prepareHotDrink(OrderItem orderItem) {
        <span class="hl-keyword">try</span> {
            Thread.sleep(<span class="hl-keyword">this</span>.hotDrinkDelay);
            System.out.println(Thread.currentThread().getName()
                    + <span class="hl-string">" prepared hot drink #"</span> + hotDrinkCounter.incrementAndGet()
                    + <span class="hl-string">" for order #"</span> + orderItem.getOrder().getNumber()
                    + <span class="hl-string">": "</span> + orderItem);
            <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> Drink(orderItem.getOrder().getNumber(), orderItem.getDrinkType(),
                    orderItem.isIced(), orderItem.getShots());
        }
        <span class="hl-keyword">catch</span> (InterruptedException e) {
            Thread.currentThread().interrupt();
            <span class="hl-keyword">return</span> null;
        }
    }

    <span class="hl-keyword">public</span> Drink prepareColdDrink(OrderItem orderItem) {
        <span class="hl-keyword">try</span> {
            Thread.sleep(<span class="hl-keyword">this</span>.coldDrinkDelay);
            System.out.println(Thread.currentThread().getName()
                    + <span class="hl-string">" prepared cold drink #"</span> + coldDrinkCounter.incrementAndGet()
                    + <span class="hl-string">" for order #"</span> + orderItem.getOrder().getNumber() + <span class="hl-string">": "</span>
                    + orderItem);
            <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> Drink(orderItem.getOrder().getNumber(), orderItem.getDrinkType(),
                    orderItem.isIced(), orderItem.getShots());
        }
        <span class="hl-keyword">catch</span> (InterruptedException e) {
            Thread.currentThread().interrupt();
            <span class="hl-keyword">return</span> null;
        }
    }
}</pre>
</div>
<p>As you can see from the preceding code excerpt, the <code class="literal">Barista</code> methods have different delays (the hot drinks take five times as long to prepare).
This simulates work being completed at different rates.
When the <code class="literal">CafeDemo</code> <span class="emphasis"><em>main</em></span> method runs, it loops 100 times and sends a single hot drink and a single cold drink each time.
It actually sends the messages by invoking the <span class="emphasis"><em>placeOrder</em></span> method on the <code class="literal">Cafe</code> interface.
In the earlier XML configuration, you can see that the <code class="literal">&lt;gateway&gt;</code> element is specified.
This triggers the creation of a proxy that implements the given service interface and connects it to a channel.
The channel name is provided on the <code class="literal">@Gateway</code> annotation of the <code class="literal">Cafe</code> interface, as the following interface definition shows:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> Cafe {

    <em><span class="hl-annotation" style="color: gray">@Gateway(requestChannel="orders")</span></em>
    <span class="hl-keyword">void</span> placeOrder(Order order);

}</pre>
</div>
<p>Finally, have a look at the <code class="literal">main()</code> method of the <code class="literal">CafeDemo</code> itself:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main(String[] args) {
    AbstractApplicationContext context = null;
    <span class="hl-keyword">if</span> (args.length &gt; <span class="hl-number">0</span>) {
        context = <span class="hl-keyword">new</span> FileSystemXmlApplicationContext(args);
    }
    <span class="hl-keyword">else</span> {
        context = <span class="hl-keyword">new</span> ClassPathXmlApplicationContext(<span class="hl-string">"cafeDemo.xml"</span>, CafeDemo.<span class="hl-keyword">class</span>);
    }
    Cafe cafe = context.getBean(<span class="hl-string">"cafe"</span>, Cafe.<span class="hl-keyword">class</span>);
    <span class="hl-keyword">for</span> (<span class="hl-keyword">int</span> i = <span class="hl-number">1</span>; i &lt;= <span class="hl-number">100</span>; i++) {
        Order order = <span class="hl-keyword">new</span> Order(i);
        order.addItem(DrinkType.LATTE, <span class="hl-number">2</span>, false);
        order.addItem(DrinkType.MOCHA, <span class="hl-number">3</span>, true);
        cafe.placeOrder(order);
    }
}</pre>
</div>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>To run this sample as well as eight others, refer to the <code class="literal">README.txt</code> within the <code class="literal">samples</code> directory of the main distribution (as described at <a class="link" href="#samples" title="Appendix&nbsp;G.&nbsp;Spring Integration Samples">the beginning of this chapter</a>).</p>
</td></tr></table></div>
<p>When you run <code class="literal">cafeDemo</code>, you can see that the cold drinks are initially prepared more quickly than the hot drinks.
Because there is an aggregator, the cold drinks are effectively limited by the rate of the hot drink preparation.
This is to be expected, based on their respective delays of 1000 and 5000 milliseconds.
However, by configuring a poller with a concurrent task executor, you can dramatically change the results.
For example, you could use a thread pool executor with five workers for the hot drink barista while keeping the cold drink barista as it is.
The following listing configures such an arrangement:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;int:service-activator</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"hotDrinks"</span>
                     <span class="hl-attribute">ref</span>=<span class="hl-value">"barista"</span>
                     <span class="hl-attribute">method</span>=<span class="hl-value">"prepareHotDrink"</span>
                     <span class="hl-attribute">output-channel</span>=<span class="hl-value">"preparedDrinks"</span><span class="hl-tag">/&gt;</span>

  <span class="hl-tag">&lt;int:service-activator</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"hotDrinks"</span>
                     <span class="hl-attribute">ref</span>=<span class="hl-value">"barista"</span>
                     <span class="hl-attribute">method</span>=<span class="hl-value">"prepareHotDrink"</span>
                     <span class="hl-attribute">output-channel</span>=<span class="hl-value">"preparedDrinks"</span><span class="hl-tag">&gt;</span>
      <span class="hl-tag">&lt;int:poller</span> <span class="hl-attribute">task-executor</span>=<span class="hl-value">"pool"</span> <span class="hl-attribute">fixed-rate</span>=<span class="hl-value">"1000"</span><span class="hl-tag">/&gt;</span>
  <span class="hl-tag">&lt;/int:service-activator&gt;</span>

  <span class="hl-tag">&lt;task:executor</span> <span class="hl-attribute">id</span>=<span class="hl-value">"pool"</span> <span class="hl-attribute">pool-size</span>=<span class="hl-value">"5"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<p>Also, notice that the worker thread name is displayed with each invocation.
You can see that the hot drinks are prepared by the task-executor threads.
If you provide a much shorter poller interval (such as 100 milliseconds), you can see that it occasionally throttles the input by forcing the task scheduler (the caller) to invoke the operation.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>In addition to experimenting with the poller&#8217;s concurrency settings, you can also add the <span class="emphasis"><em>transactional</em></span> child element and then refer to any <code class="literal">PlatformTransactionManager</code> instance within the context.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="samples-xml-messaging" href="#samples-xml-messaging"></a>G.4.3&nbsp;The XML Messaging Sample</h3></div></div></div>

<p>The XML messaging sample in <code class="literal">basic/xml</code> shows how to use some of the provided components that deal with XML payloads.
The sample uses the idea of processing an order for books represented as XML.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>This sample shows that the namespace prefix can be whatever you want.
While we usually use, <code class="literal">int-xml</code> for integration XML components, the sample uses <code class="literal">si-xml</code>.
(<code class="literal">int</code> is short for "<code class="literal">Integration</code>", and <code class="literal">si</code> is short for "<code class="literal">Spring Integration</code>".)</p>
</td></tr></table></div>
<p>First, the order is split into a number of messages, each one representing a single order item from the XPath splitter component.
The following listing shows the configuration of the splitter:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;si-xml:xpath-splitter</span> <span class="hl-attribute">id</span>=<span class="hl-value">"orderItemSplitter"</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"ordersChannel"</span>
              <span class="hl-attribute">output-channel</span>=<span class="hl-value">"stockCheckerChannel"</span> <span class="hl-attribute">create-documents</span>=<span class="hl-value">"true"</span><span class="hl-tag">&gt;</span>
      <span class="hl-tag">&lt;si-xml:xpath-expression</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"/orderNs:order/orderNs:orderItem"</span>
                                <span class="hl-attribute">namespace-map</span>=<span class="hl-value">"orderNamespaceMap"</span><span class="hl-tag"> /&gt;</span>
  <span class="hl-tag">&lt;/si-xml:xpath-splitter&gt;</span></pre>
</div>
<p>A service activator then passes the message into a stock checker POJO.
The order item document is enriched with information from the stock checker about the order item stock level.
This enriched order item message is then used to route the message.
In the case where the order item is in stock, the message is routed to the warehouse.
The following listing configures the <code class="literal">xpath-router</code> that routes the messages:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;si-xml:xpath-router</span> <span class="hl-attribute">id</span>=<span class="hl-value">"instockRouter"</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"orderRoutingChannel"</span> <span class="hl-attribute">resolution-required</span>=<span class="hl-value">"true"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;si-xml:xpath-expression</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"/orderNs:orderItem/@in-stock"</span> <span class="hl-attribute">namespace-map</span>=<span class="hl-value">"orderNamespaceMap"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;si-xml:mapping</span> <span class="hl-attribute">value</span>=<span class="hl-value">"true"</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"warehouseDispatchChannel"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;si-xml:mapping</span> <span class="hl-attribute">value</span>=<span class="hl-value">"false"</span> <span class="hl-attribute">channel</span>=<span class="hl-value">"outOfStockChannel"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/si-xml:xpath-router&gt;</span></pre>
</div>
<p>When the order item is not in stock, the message is transformed with XSLT into a format suitable for sending to the supplier.
The following listing configures the XSLT transformer:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-tag">&lt;si-xml:xslt-transformer</span> <span class="hl-attribute">input-channel</span>=<span class="hl-value">"outOfStockChannel"</span>
  <span class="hl-attribute">output-channel</span>=<span class="hl-value">"resupplyOrderChannel"</span>
  <span class="hl-attribute">xsl-resource</span>=<span class="hl-value">"classpath:org/springframework/integration/samples/xml/bigBooksSupplierTransformer.xsl"</span><span class="hl-tag">/&gt;</span></pre>
</div>
</div>
</div>
</div>
<div class="appendix"><div class="titlepage"><div><div><h2 class="title"><a name="resources" href="#resources"></a>Appendix&nbsp;H.&nbsp;Additional Resources</h2></div></div></div>

<p>The definitive source of information about Spring Integration is the <a class="ulink" href="http://projects.spring.io/spring-integration/" target="_top">Spring Integration Home</a> at <a class="ulink" href="http://spring.io" target="_top">http://spring.io</a>.
That site serves as a hub of information and is the best place to find up-to-date announcements about the project as well as links to articles, blogs, and new sample applications.</p>
</div>
<div class="appendix"><div class="titlepage"><div><div><h2 class="title"><a name="history" href="#history"></a>Appendix&nbsp;I.&nbsp;Change History</h2></div></div></div>

<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="migration-4.3-5.0" href="#migration-4.3-5.0"></a>I.1&nbsp;Changes between 4.3 and 5.0</h2></div></div></div>

<p>See the <a class="ulink" href="https://github.com/spring-projects/spring-integration/wiki/Spring-Integration-4.3-to-5.0-Migration-Guide" target="_top">Migration Guide</a> for important changes that might affect your applications.
You can find migration guides for all versions back to 2.1 on the <a class="ulink" href="https://github.com/spring-projects/spring-integration/wiki" target="_top">wiki</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="x5.0-new-components" href="#x5.0-new-components"></a>I.2&nbsp;New Components</h2></div></div></div>

<p>Version 5.0 added a number of new components.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_java_dsl" href="#_java_dsl"></a>I.2.1&nbsp;Java DSL</h3></div></div></div>

<p>The separate <a class="ulink" href="https://github.com/spring-projects/spring-integration-java-dsl" target="_top">Spring Integration Java DSL</a> project has now been merged into the core Spring Integration project.
The <code class="literal">IntegrationComponentSpec</code> implementations for channel adapters and gateways are distributed to their specific modules.
See <a class="xref" href="#java-dsl" title="11.&nbsp;Java DSL">Chapter&nbsp;11, <i>Java DSL</i></a> for more information about Java DSL support.
See also the <a class="ulink" href="https://github.com/spring-projects/spring-integration/wiki/Spring-Integration-4.3-to-5.0-Migration-Guide#java-dsl" target="_top">4.3 to 5.0 Migration Guide</a> for the required steps to move to Spring Integration 5.0.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_testing_support" href="#_testing_support"></a>I.2.2&nbsp;Testing Support</h3></div></div></div>

<p>We created a new Spring Integration Test Framework to help with testing Spring Integration applications.
Now, with the <code class="literal">@SpringIntegrationTest</code> annotation on test classes and the <code class="literal">MockIntegration</code> factory, you can make your JUnit tests for integration flows somewhat easier.</p>
<p>See <a class="xref" href="#testing" title="Appendix&nbsp;F.&nbsp;Testing support">Appendix&nbsp;F, <i>Testing support</i></a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_mongodb_outbound_gateway" href="#_mongodb_outbound_gateway"></a>I.2.3&nbsp;MongoDB Outbound Gateway</h3></div></div></div>

<p>The new <code class="literal">MongoDbOutboundGateway</code> lets you make queries to the database on demand by sending a message to its request channel.</p>
<p>See <a class="xref" href="#mongodb-outbound-gateway" title="25.5&nbsp;MongoDB Outbound Gateway">Section&nbsp;25.5, &#8220;MongoDB Outbound Gateway&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_webflux_gateways_and_channel_adapters" href="#_webflux_gateways_and_channel_adapters"></a>I.2.4&nbsp;WebFlux Gateways and Channel Adapters</h3></div></div></div>

<p>We introduced the new WebFlux support module for Spring WebFlux Framework gateways and channel adapters.</p>
<p>See <a class="xref" href="#webflux" title="35.&nbsp;WebFlux Support">Chapter&nbsp;35, <i>WebFlux Support</i></a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_content_type_conversion" href="#_content_type_conversion"></a>I.2.5&nbsp;Content Type Conversion</h3></div></div></div>

<p>Now that we use the new <code class="literal">InvocableHandlerMethod</code>-based infrastructure for service method invocations, we can perform <code class="literal">contentType</code> conversion from the payload to a target method argument.</p>
<p>See <a class="xref" href="#content-type-conversion" title="10.1.7&nbsp;Content Type Conversion">Section&nbsp;10.1.7, &#8220;Content Type Conversion&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_literal_errormessagepublisher_literal_and_literal_errormessagestrategy_literal" href="#_literal_errormessagepublisher_literal_and_literal_errormessagestrategy_literal"></a>I.2.6&nbsp;<code class="literal">ErrorMessagePublisher</code> and <code class="literal">ErrorMessageStrategy</code></h3></div></div></div>

<p>We added <code class="literal">ErrorMessagePublisher</code> and the <code class="literal">ErrorMessageStrategy</code> for creating <code class="literal">ErrorMessage</code> instances.</p>
<p>See <a class="xref" href="#namespace-errorhandler" title="E.3&nbsp;Error Handling">Section&nbsp;E.3, &#8220;Error Handling&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_jdbc_metadata_store" href="#_jdbc_metadata_store"></a>I.2.7&nbsp;JDBC Metadata Store</h3></div></div></div>

<p>We added a JDBC implementation of the <code class="literal">MetadataStore</code> implementation.
This is useful when you need to ensure transactional boundaries for metadata.</p>
<p>See <a class="xref" href="#jdbc-metadata-store" title="21.7&nbsp;JDBC Metadata Store">Section&nbsp;21.7, &#8220;JDBC Metadata Store&#8221;</a> for more information.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="x5.0-general" href="#x5.0-general"></a>I.3&nbsp;General Changes</h2></div></div></div>

<p>Spring Integration is now fully based on Spring Framework <code class="literal">5.0</code> and Project Reactor <code class="literal">3.1</code>.
Previous Project Reactor versions are no longer supported.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_core_changes" href="#_core_changes"></a>I.3.1&nbsp;Core Changes</h3></div></div></div>

<p>The <code class="literal">@Poller</code> annotation now has the <code class="literal">errorChannel</code> attribute for easier configuration of the underlying <code class="literal">MessagePublishingErrorHandler</code>.
See <a class="xref" href="#annotations" title="E.5&nbsp;Annotation Support">Section&nbsp;E.5, &#8220;Annotation Support&#8221;</a> for more information.</p>
<p>All the request-reply endpoints (based on <code class="literal">AbstractReplyProducingMessageHandler</code>) can now start transactions and, therefore, make the whole downstream flow transactional.
See <a class="xref" href="#tx-handle-message-advice" title="10.9.5&nbsp;Transaction Support">Section&nbsp;10.9.5, &#8220;Transaction Support&#8221;</a> for more information.</p>
<p>The <code class="literal">SmartLifecycleRoleController</code> now provides methods to obtain status of endpoints in roles.
See <a class="xref" href="#endpoint-roles" title="10.2&nbsp;Endpoint Roles">Section&nbsp;10.2, &#8220;Endpoint Roles&#8221;</a> for more information.</p>
<p>By default, POJO methods are now invoked by using an <code class="literal">InvocableHandlerMethod</code>, but you can configure them to use SpEL, as before.
See <a class="xref" href="#pojo-invocation" title="5.8&nbsp;POJO Method invocation">Section&nbsp;5.8, &#8220;POJO Method invocation&#8221;</a> for more information.</p>
<p>When targeting POJO methods as message handlers, you can now mark one of the service methods with the <code class="literal">@Default</code> annotation to provide a fallback mechanism for non-matched conditions.
See <a class="xref" href="#service-activator-namespace" title="10.5.1&nbsp;Configuring Service Activator">Section&nbsp;10.5.1, &#8220;Configuring Service Activator&#8221;</a> for more information.</p>
<p>We added a simple <code class="literal">PassThroughTransactionSynchronizationFactory</code> to always store a polled message in the current transaction context.
That message is used as a <code class="literal">failedMessage</code> property of the <code class="literal">MessagingException</code>, which wraps any raw exception thrown during transaction completion.
See <a class="xref" href="#transaction-synchronization" title="C.3&nbsp;Transaction Synchronization">Section&nbsp;C.3, &#8220;Transaction Synchronization&#8221;</a> for more information.</p>
<p>The aggregator expression-based <code class="literal">ReleaseStrategy</code> now evaluates the expression against the <code class="literal">MessageGroup</code> instead of just the collection of <code class="literal">Message&lt;?&gt;</code>.
See <a class="xref" href="#aggregator-spel" title="Aggregators and Spring Expression Language (SpEL)">the section called &#8220;Aggregators and Spring Expression Language (SpEL)&#8221;</a> for more information.</p>
<p>You can now supply the <code class="literal">ObjectToMapTransformer</code> with a customized <code class="literal">JsonObjectMapper</code>.</p>
<p>See <a class="xref" href="#aggregator-spel" title="Aggregators and Spring Expression Language (SpEL)">the section called &#8220;Aggregators and Spring Expression Language (SpEL)&#8221;</a> for more information.</p>
<p>The <code class="literal">@GlobalChannelInterceptor</code> annotation and <code class="literal">&lt;int:channel-interceptor&gt;</code> now support negative patterns (via <code class="literal">!</code> prepending) for component names matching.
See <a class="xref" href="#global-channel-configuration-interceptors" title="Global Channel Interceptor Configuration">the section called &#8220;Global Channel Interceptor Configuration&#8221;</a> for more information.</p>
<p>When a candidate failed to acquire the lock, the <code class="literal">LockRegistryLeaderInitiator</code> now emits a new <code class="literal">OnFailedToAcquireMutexEvent</code> through <code class="literal">DefaultLeaderEventPublisher</code>.
See <code class="literal">&lt;&lt;leadership-event-handling&gt;&gt;</code> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_gateway_changes" href="#_gateway_changes"></a>I.3.2&nbsp;Gateway Changes</h3></div></div></div>

<p>When the gateway method has a <code class="literal">void</code> return type and an error channel is provided, the gateway now correctly sets the <code class="literal">errorChannel</code> header.
Previously, the header was not populated.
This caused synchronous downstream flows (running on the calling thread) to send the exception to the configured channel, but an exception on an asynchronous downstream flow would be sent to the default <code class="literal">errorChannel</code> instead.</p>
<p>The <code class="literal">RequestReplyExchanger</code> interface now has a <code class="literal">throws MessagingException</code> clause to meet the proposed messages exchange contract.</p>
<p>You can now specify the request and reply timeouts with SpEL expressions.
See <a class="xref" href="#gateway" title="10.4&nbsp;Messaging Gateways">Section&nbsp;10.4, &#8220;Messaging Gateways&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_aggregator_performance_changes" href="#_aggregator_performance_changes"></a>I.3.3&nbsp;Aggregator Performance Changes</h3></div></div></div>

<p>By default, aggregators now use a <code class="literal">SimpleSequenceSizeReleaseStrategy</code>, which is more efficient, especially with large groups.
Empty groups are now scheduled for removal after <code class="literal">empty-group-min-timeout</code>.
See <a class="xref" href="#aggregator" title="8.4&nbsp;Aggregator">Section&nbsp;8.4, &#8220;Aggregator&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_splitter_changes" href="#_splitter_changes"></a>I.3.4&nbsp;Splitter Changes</h3></div></div></div>

<p>The splitter component can now handle and split Java <code class="literal">Stream</code> and Reactive Streams <code class="literal">Publisher</code> objects.
If the output channel is a <code class="literal">ReactiveStreamsSubscribableChannel</code>, the <code class="literal">AbstractMessageSplitter</code> builds a <code class="literal">Flux</code> for subsequent iteration instead of a regular <code class="literal">Iterator</code>, independent of the object being split.
In addition, <code class="literal">AbstractMessageSplitter</code> provides <code class="literal">protected obtainSizeIfPossible()</code> methods to allow determination of the size of the <code class="literal">Iterable</code> and <code class="literal">Iterator</code> objects, if that is possible.
See <a class="xref" href="#splitter" title="8.3&nbsp;Splitter">Section&nbsp;8.3, &#8220;Splitter&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_jms_changes" href="#_jms_changes"></a>I.3.5&nbsp;JMS Changes</h3></div></div></div>

<p>Previously, Spring Integration JMS XML configuration used a default bean name of <code class="literal">connectionFactory</code> for the JMS connection factory, letting the property be omitted from component definitions.
We renamed it to <code class="literal">jmsConnectionFactory</code>, which is the bean name used by Spring Boot to auto-configure the JMS connection factory bean.</p>
<p>If your application relies on the previous behavior, you can rename your <code class="literal">connectionFactory</code> bean to <code class="literal">jmsConnectionFactory</code> or specifically configure your components to use your bean by using its current name.
See <a class="xref" href="#jms" title="23.&nbsp;JMS Support">Chapter&nbsp;23, <i>JMS Support</i></a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_mail_changes" href="#_mail_changes"></a>I.3.6&nbsp;Mail Changes</h3></div></div></div>

<p>Some inconsistencies with rendering IMAP mail content have been resolved.
See <a class="link" href="#imap-format-important" title="Important">the note in the "<code class="literal">Mail-receiving Channel Adapter</code>" section</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_feed_changes" href="#_feed_changes"></a>I.3.7&nbsp;Feed Changes</h3></div></div></div>

<p>Instead of the <code class="literal">com.rometools.fetcher.FeedFetcher</code>, which is deprecated in ROME, we introduced a new <code class="literal">Resource</code> property for the <code class="literal">FeedEntryMessageSource</code>.
See <a class="xref" href="#feed" title="16.&nbsp;Feed Adapter">Chapter&nbsp;16, <i>Feed Adapter</i></a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_file_changes" href="#_file_changes"></a>I.3.8&nbsp;File Changes</h3></div></div></div>

<p>We introduced the new <code class="literal">FileHeaders.RELATIVE_PATH</code> message header to represent relative path in <code class="literal">FileReadingMessageSource</code>.</p>
<p>The tail adapter now supports <code class="literal">idleEventInterval</code> to emit events when there is no data in the file during that period.</p>
<p>The flush predicates for the <code class="literal">FileWritingMessageHandler</code> now have an additional parameter.</p>
<p>The file outbound channel adapter and gateway (<code class="literal">FileWritingMessageHandler</code>) now support the <code class="literal">REPLACE_IF_MODIFIED</code> <code class="literal">FileExistsMode</code>.</p>
<p>They also now support setting file permissions on the newly written file.</p>
<p>A new <code class="literal">FileSystemMarkerFilePresentFileListFilter</code> is now available.
See <a class="xref" href="#file-incomplete" title="17.1.9&nbsp;Dealing With Incomplete Data">Section&nbsp;17.1.9, &#8220;Dealing With Incomplete Data&#8221;</a> for more information.</p>
<p>The <code class="literal">FileSplitter</code> now provides a <code class="literal">firstLineAsHeader</code> option to carry the first line of content as a header in the messages emitted for the remaining lines.</p>
<p>See <a class="xref" href="#files" title="17.&nbsp;File Support">Chapter&nbsp;17, <i>File Support</i></a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_ftp_and_sftp_changes" href="#_ftp_and_sftp_changes"></a>I.3.9&nbsp;FTP and SFTP Changes</h3></div></div></div>

<p>The inbound channel adapters now have a property called <code class="literal">max-fetch-size</code>, which is used to limit the number of files fetched during a poll when no files are currently in the local directory.
By default, they also are configured with a <code class="literal">FileSystemPersistentAcceptOnceFileListFilter</code> in the <code class="literal">local-filter</code>.</p>
<p>You can also provide a custom <code class="literal">DirectoryScanner</code> implementation to inbound channel adapters by setting the newly introduced <code class="literal">scanner</code> attribute.</p>
<p>You can now configure the regex and pattern filters to always pass directories.
This can be useful when you use recursion in the outbound gateways.</p>
<p>By default, all the inbound channel adapters (streaming and synchronization-based) now use an appropriate <code class="literal">AbstractPersistentAcceptOnceFileListFilter</code> implementation to prevent duplicate downloads of remote files.</p>
<p>The FTP and SFTP outbound gateways now support the <code class="literal">REPLACE_IF_MODIFIED</code> <code class="literal">FileExistsMode</code> when fetching remote files.</p>
<p>The FTP and SFTP streaming inbound channel adapters now add remote file information in a message header.</p>
<p>The FTP and SFTP outbound channel adapters (as well as the <code class="literal">PUT</code> command for outbound gateways) now support <code class="literal">InputStream</code> as <code class="literal">payload</code>, too.</p>
<p>The inbound channel adapters can now build file trees locally by using a newly introduced <code class="literal">RecursiveDirectoryScanner</code>.
See the <code class="literal">scanner</code> option in the <a class="xref" href="#ftp-inbound" title="18.4&nbsp;FTP Inbound Channel Adapter">Section&nbsp;18.4, &#8220;FTP Inbound Channel Adapter&#8221;</a> section for injection.
Also, you can now switch these adapters to the <code class="literal">WatchService</code> instead.</p>
<p>We added The <code class="literal">NLST</code> command to the <code class="literal">AbstractRemoteFileOutboundGateway</code> to perform the list files names remote command.</p>
<p>You can now supply the <code class="literal">FtpOutboundGateway</code> with <code class="literal">workingDirExpression</code> to change the FTP client working directory for the current request message.</p>
<p>The <code class="literal">RemoteFileTemplate</code> is supplied now with the <code class="literal">invoke(OperationsCallback&lt;F, T&gt; action)</code> to perform several <code class="literal">RemoteFileOperations</code> calls in the scope of the same, thread-bounded, <code class="literal">Session</code>.</p>
<p>We added new filters for detecting incomplete remote files.</p>
<p>The <code class="literal">FtpOutboundGateway</code> and <code class="literal">SftpOutboundGateway</code> now support an option to remove the remote file after a successful transfer by using the <code class="literal">GET</code> or <code class="literal">MGET</code> commands.</p>
<p>See <a class="xref" href="#ftp" title="18.&nbsp;FTP/FTPS Adapters">Chapter&nbsp;18, <i>FTP/FTPS Adapters</i></a> and <a class="xref" href="#sftp" title="30.&nbsp;SFTP Adapters">Chapter&nbsp;30, <i>SFTP Adapters</i></a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_integration_properties" href="#_integration_properties"></a>I.3.10&nbsp;Integration Properties</h3></div></div></div>

<p>Version 4.3.2 added a new <code class="literal">spring.integration.readOnly.headers</code> global property to let you customize the list of headers that should not be copied to a newly created <code class="literal">Message</code> by the <code class="literal">MessageBuilder</code>.
See <a class="xref" href="#global-properties" title="E.4&nbsp;Global Properties">Section&nbsp;E.4, &#8220;Global Properties&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_stream_changes" href="#_stream_changes"></a>I.3.11&nbsp;Stream Changes</h3></div></div></div>

<p>We added a new option on the <code class="literal">CharacterStreamReadingMessageSource</code> to let it be used to "<code class="literal">pipe</code>" stdin and publish an application event when the pipe is closed.
See <a class="xref" href="#stream-reading" title="32.1&nbsp;Reading from Streams">Section&nbsp;32.1, &#8220;Reading from Streams&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_barrier_changes" href="#_barrier_changes"></a>I.3.12&nbsp;Barrier Changes</h3></div></div></div>

<p>The <code class="literal">BarrierMessageHandler</code> now supports a discard channel to which late-arriving trigger messages are sent.
See <a class="xref" href="#barrier" title="8.8&nbsp;Thread Barrier">Section&nbsp;8.8, &#8220;Thread Barrier&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_amqp_changes" href="#_amqp_changes"></a>I.3.13&nbsp;AMQP Changes</h3></div></div></div>

<p>The AMQP outbound endpoints now support setting a delay expression when you use the RabbitMQ Delayed Message Exchange plugin.</p>
<p>The inbound endpoints now support the Spring AMQP <code class="literal">DirectMessageListenerContainer</code>.</p>
<p>Pollable AMQP-backed channels now block the poller thread for the poller&#8217;s configured <code class="literal">receiveTimeout</code> (default: one second).</p>
<p>Headers, such as <code class="literal">contentType</code>, that are added to message properties by the message converter are now used in the final message.
Previously, it depended on the converter type as to which headers and message properties appeared in the final message.
To override the headers set by the converter, set the <code class="literal">headersMappedLast</code> property to <code class="literal">true</code>.
See <a class="xref" href="#amqp" title="14.&nbsp;AMQP Support">Chapter&nbsp;14, <i>AMQP Support</i></a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_http_changes" href="#_http_changes"></a>I.3.14&nbsp;HTTP Changes</h3></div></div></div>

<p>By default, the <code class="literal">DefaultHttpHeaderMapper.userDefinedHeaderPrefix</code> property is now an empty string instead of <code class="literal">X-</code>.
See <a class="xref" href="#http-header-mapping" title="20.7&nbsp;HTTP Header Mappings">Section&nbsp;20.7, &#8220;HTTP Header Mappings&#8221;</a> for more information.</p>
<p>By default, <code class="literal">uriVariablesExpression</code> now uses a <code class="literal">SimpleEvaluationContext</code> (since 5.0.4).</p>
<p>See <a class="xref" href="#mapping-uri-variables" title="20.3.7&nbsp;Mapping URI Variables">Section&nbsp;20.3.7, &#8220;Mapping URI Variables&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_mqtt_changes" href="#_mqtt_changes"></a>I.3.15&nbsp;MQTT Changes</h3></div></div></div>

<p>Inbound messages are now mapped with the <code class="literal">RECEIVED_TOPIC</code>, <code class="literal">RECEIVED_QOS</code>, and <code class="literal">RECEIVED_RETAINED</code> headers to avoid inadvertent propagation to outbound messages when an application relays messages.</p>
<p>The outbound channel adapter now supports expressions for the topic, qos, and retained properties.
The defaults remain the same.
See <a class="xref" href="#mqtt" title="26.&nbsp;MQTT Support">Chapter&nbsp;26, <i>MQTT Support</i></a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_stomp_changes" href="#_stomp_changes"></a>I.3.16&nbsp;STOMP Changes</h3></div></div></div>

<p>We changed the STOMP module to use <code class="literal">ReactorNettyTcpStompClient</code>, based on the Project Reactor <code class="literal">3.1</code> and <code class="literal">reactor-netty</code> extension.
We renamed <code class="literal">Reactor2TcpStompSessionManager</code> to <code class="literal">ReactorNettyTcpStompSessionManager</code>, according to the <code class="literal">ReactorNettyTcpStompClient</code> foundation.
See <a class="xref" href="#stomp" title="31.&nbsp;STOMP Support">Chapter&nbsp;31, <i>STOMP Support</i></a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_web_services_changes" href="#_web_services_changes"></a>I.3.17&nbsp;Web Services Changes</h3></div></div></div>

<p>You can now supply <code class="literal">WebServiceOutboundGateway</code> instances with an externally configured <code class="literal">WebServiceTemplate</code> instances.</p>
<p><code class="literal">DefaultSoapHeaderMapper</code> can now map a <code class="literal">javax.xml.transform.Source</code> user-defined header to a SOAP header element.</p>
<p>Simple WebService inbound and outbound gateways can now deal with the complete <code class="literal">WebServiceMessage</code> as a <code class="literal">payload</code>, allowing the manipulation of MTOM attachments.</p>
<p>See <a class="xref" href="#ws" title="37.&nbsp;Web Services Support">Chapter&nbsp;37, <i>Web Services Support</i></a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_redis_changes" href="#_redis_changes"></a>I.3.18&nbsp;Redis Changes</h3></div></div></div>

<p>The <code class="literal">RedisStoreWritingMessageHandler</code> is supplied now with additional <code class="literal">String</code>-based setters for SpEL expressions (for convenience with Java configuration).
You can now configure the <code class="literal">zsetIncrementExpression</code> on the <code class="literal">RedisStoreWritingMessageHandler</code> as well.
In addition, this property has been changed from <code class="literal">true</code> to <code class="literal">false</code> since the <code class="literal">INCR</code> option on <code class="literal">ZADD</code> Redis command is optional.</p>
<p>You can now supply the <code class="literal">RedisInboundChannelAdapter</code> with an <code class="literal">Executor</code> for executing Redis listener invokers.
In addition, the received messages now contain a <code class="literal">RedisHeaders.MESSAGE_SOURCE</code> header to indicate the source of the message (topic or pattern).</p>
<p>See <a class="xref" href="#redis" title="27.&nbsp;Redis Support">Chapter&nbsp;27, <i>Redis Support</i></a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_tcp_changes" href="#_tcp_changes"></a>I.3.19&nbsp;TCP Changes</h3></div></div></div>

<p>We added a new <code class="literal">ThreadAffinityClientConnectionFactory</code> to bind TCP connections to threads.</p>
<p>You can now configure the TCP connection factories to support <code class="literal">PushbackInputStream</code> instances, letting deserializers "<code class="literal">unread</code>" (push back) bytes after "<code class="literal">reading ahead</code>".</p>
<p>We added a <code class="literal">ByteArrayElasticRawDeserializer</code> without <code class="literal">maxMessageSize</code> to control and buffer incoming data as needed.</p>
<p>See <a class="xref" href="#ip" title="34.&nbsp;TCP and UDP Support">Chapter&nbsp;34, <i>TCP and UDP Support</i></a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_gemfire_changes" href="#_gemfire_changes"></a>I.3.20&nbsp;Gemfire Changes</h3></div></div></div>

<p>The <code class="literal">GemfireMetadataStore</code> now implements <code class="literal">ListenableMetadataStore</code>, letting you listen to cache events by providing <code class="literal">MetadataStoreListener</code> instances to the store.
See <a class="xref" href="#gemfire" title="19.&nbsp;Pivotal GemFire and Apache Geode Support">Chapter&nbsp;19, <i>Pivotal GemFire and Apache Geode Support</i></a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_jdbc_changes" href="#_jdbc_changes"></a>I.3.21&nbsp;JDBC Changes</h3></div></div></div>

<p>The <code class="literal">JdbcMessageChannelStore</code> now provides a setter for <code class="literal">ChannelMessageStorePreparedStatementSetter</code>, letting you customize message insertion in the store.</p>
<p>The <code class="literal">ExpressionEvaluatingSqlParameterSourceFactory</code> now provides a setter for <code class="literal">sqlParameterTypes</code>, letting you customize the SQL types of the parameters.</p>
<p>See <a class="xref" href="#jdbc" title="21.&nbsp;JDBC Support">Chapter&nbsp;21, <i>JDBC Support</i></a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_metrics_changes" href="#_metrics_changes"></a>I.3.22&nbsp;Metrics Changes</h3></div></div></div>

<p><a class="ulink" href="http://micrometer.io/" target="_top">Micrometer</a> application monitoring is now supported (since version 5.0.2).
See <a class="xref" href="#micrometer-integration" title="12.1.2&nbsp;Micrometer Integration">Section&nbsp;12.1.2, &#8220;Micrometer Integration&#8221;</a> for more information.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Changes were made to the Micrometer <code class="literal">Meters</code> in version 5.0.3 to make them more suitable for use in dimensional systems.
Further changes were made in 5.0.4.
If you usie Micrometer, we recommend a minimum of version 5.0.4.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_literal_endpointid_literal_annotations" href="#_literal_endpointid_literal_annotations"></a>I.3.23&nbsp;<code class="literal">@EndpointId</code> Annotations</h3></div></div></div>

<p>Introduced in version 5.0.4, this annotation provides control over bean naming when you use Java configuration.
See <a class="xref" href="#endpoint-bean-names" title="5.4.8&nbsp;Endpoint Bean Names">Section&nbsp;5.4.8, &#8220;Endpoint Bean Names&#8221;</a> for more information.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="migration-4.2-4.3" href="#migration-4.2-4.3"></a>I.4&nbsp;Changes between 4.2 and 4.3</h2></div></div></div>

<p>See the <a class="ulink" href="https://github.com/spring-projects/spring-integration/wiki/Spring-Integration-4.2-to-4.3-Migration-Guide" target="_top">Migration Guide</a>
for important changes that might affect your applications.
You can find migration guides for all versions back to 2.1 on the <a class="ulink" href="https://github.com/spring-projects/spring-integration/wiki" target="_top">Wiki</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="x4.3-new-components" href="#x4.3-new-components"></a>I.5&nbsp;New Components</h2></div></div></div>

<p>Version 4.3 added a number of new components.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_amqp_async_outbound_gateway" href="#_amqp_async_outbound_gateway"></a>I.5.1&nbsp;AMQP Async Outbound Gateway</h3></div></div></div>

<p>See <a class="xref" href="#amqp-async-outbound-gateway" title="14.7&nbsp;Asynchronous Outbound Gateway">Section&nbsp;14.7, &#8220;Asynchronous Outbound Gateway&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_literal_messagegroupfactory_literal" href="#_literal_messagegroupfactory_literal"></a>I.5.2&nbsp;<code class="literal">MessageGroupFactory</code></h3></div></div></div>

<p>We introduced the <code class="literal">MessageGroupFactory</code> strategy to allow control over <code class="literal">MessageGroup</code> instances in <code class="literal">MessageGroupStore</code> logic.
We added <code class="literal">SimpleMessageGroupFactory</code> implementation for the <code class="literal">SimpleMessageGroup</code>, with the <code class="literal">GroupType.HASH_SET</code> as the default
factory for the standard <code class="literal">MessageGroupStore</code> implementations.
See <a class="xref" href="#message-store" title="12.4&nbsp;Message Store">Section&nbsp;12.4, &#8220;Message Store&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_literal_persistentmessagegroup_literal" href="#_literal_persistentmessagegroup_literal"></a>I.5.3&nbsp;<code class="literal">PersistentMessageGroup</code></h3></div></div></div>

<p>We added the <code class="literal">PersistentMessageGroup</code> (lazy-load proxy) implementation for persistent <code class="literal">MessageGroupStore</code> instances,
which return this instance for the <code class="literal">getMessageGroup()</code> when their <code class="literal">lazyLoadMessageGroups</code> is <code class="literal">true</code> (the default).
See <a class="xref" href="#message-store" title="12.4&nbsp;Message Store">Section&nbsp;12.4, &#8220;Message Store&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_ftp_and_sftp_streaming_inbound_channel_adapters" href="#_ftp_and_sftp_streaming_inbound_channel_adapters"></a>I.5.4&nbsp;FTP and SFTP Streaming Inbound Channel Adapters</h3></div></div></div>

<p>We added inbound channel adapters that return an <code class="literal">InputStream</code> for each file, letting you retrieve remote files without writing them to the local file system.
See <a class="xref" href="#ftp-streaming" title="18.5&nbsp;FTP Streaming Inbound Channel Adapter">Section&nbsp;18.5, &#8220;FTP Streaming Inbound Channel Adapter&#8221;</a> and <a class="xref" href="#sftp-streaming" title="30.7&nbsp;SFTP Streaming Inbound Channel Adapter">Section&nbsp;30.7, &#8220;SFTP Streaming Inbound Channel Adapter&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_literal_streamtransformer_literal" href="#_literal_streamtransformer_literal"></a>I.5.5&nbsp;<code class="literal">StreamTransformer</code></h3></div></div></div>

<p>We added <code class="literal">StreamTransformer</code> to transform an <code class="literal">InputStream</code> payload to either a <code class="literal">byte[]</code> or a <code class="literal">String</code>.
See <a class="xref" href="#stream-transformer" title="Stream Transformer">the section called &#8220;Stream Transformer&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_integration_graph" href="#_integration_graph"></a>I.5.6&nbsp;Integration Graph</h3></div></div></div>

<p>We added <code class="literal">IntegrationGraphServer</code>, together with the <code class="literal">IntegrationGraphController</code> REST service, to expose the runtime model of a Spring Integration application as a graph.
See <a class="xref" href="#integration-graph" title="12.8&nbsp;Integration Graph">Section&nbsp;12.8, &#8220;Integration Graph&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_jdbc_lock_registry" href="#_jdbc_lock_registry"></a>I.5.7&nbsp;JDBC Lock Registry</h3></div></div></div>

<p>We added <code class="literal">JdbcLockRegistry</code> for distributed locks shared through a database table.
See <a class="xref" href="#jdbc-lock-registry" title="21.6&nbsp;JDBC Lock Registry">Section&nbsp;21.6, &#8220;JDBC Lock Registry&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_literal_leaderinitiator_literal_for_literal_lockregistry_literal" href="#_literal_leaderinitiator_literal_for_literal_lockregistry_literal"></a>I.5.8&nbsp;<code class="literal">LeaderInitiator</code> for <code class="literal">LockRegistry</code></h3></div></div></div>

<p>We added <code class="literal">LeaderInitiator</code> implementation based on the <code class="literal">LockRegistry</code> strategy.
See <a class="xref" href="#leadership-event-handling" title="10.3&nbsp;Leadership Event Handling">Section&nbsp;10.3, &#8220;Leadership Event Handling&#8221;</a> for more information.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="x4.3-general" href="#x4.3-general"></a>I.6&nbsp;General Changes</h2></div></div></div>

<p>This section describes general changes that version 4.3 brought to Spring Integration.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_core_changes_2" href="#_core_changes_2"></a>I.6.1&nbsp;Core Changes</h3></div></div></div>

<p>This section describes general changes to the core of Spring Integration.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_outbound_gateway_within_a_chain" href="#_outbound_gateway_within_a_chain"></a>Outbound Gateway within a Chain</h4></div></div></div>

<p>Previously, you could specify a <code class="literal">reply-channel</code> on an outbound gateway within a chain.
It was completely ignored.
The gateway&#8217;s reply goes to the next chain element or, if the gateway is the last element, to the chain&#8217;s output channel.
This condition is now detected and disallowed.
If you have such a configuration, remove the <code class="literal">reply-channel</code>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_asynchronous_service_activator" href="#_asynchronous_service_activator"></a>Asynchronous Service Activator</h4></div></div></div>

<p>We added an option to make the service activator be synchronous.
See <a class="xref" href="#async-service-activator" title="10.5.2&nbsp;Asynchronous Service Activator">Section&nbsp;10.5.2, &#8220;Asynchronous Service Activator&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_messaging_annotation_support_changes" href="#_messaging_annotation_support_changes"></a>Messaging Annotation Support changes</h4></div></div></div>

<p>The messaging annotation support does not require a <code class="literal">@MessageEndpoint</code> (or any other <code class="literal">@Component</code>) annotation declaration on the class level.
To restore the previous behavior, set the <code class="literal">spring.integration.messagingAnnotations.require.componentAnnotation</code> of
<code class="literal">spring.integration.properties</code> to <code class="literal">true</code>.
See <a class="xref" href="#global-properties" title="E.4&nbsp;Global Properties">Section&nbsp;E.4, &#8220;Global Properties&#8221;</a> and <a class="xref" href="#annotations" title="E.5&nbsp;Annotation Support">Section&nbsp;E.5, &#8220;Annotation Support&#8221;</a> for more information.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_mail_changes_2" href="#_mail_changes_2"></a>I.6.2&nbsp;Mail Changes</h3></div></div></div>

<p>This section describes general changes to the Spring Integration Mail functionality.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_customizable_user_flag" href="#_customizable_user_flag"></a>Customizable User Flag</h4></div></div></div>

<p>The customizable <code class="literal">userFlag</code> (added in 4.2.2 to provide customization of the flag used to denote that the mail has been
seen) is now available in the XML namespace.
See <a class="xref" href="#imap-seen" title="24.5&nbsp;Marking IMAP Messages When \Recent Is Not Supported">Section&nbsp;24.5, &#8220;Marking IMAP Messages When <code class="literal">\Recent</code> Is Not Supported&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_mail_message_mapping" href="#_mail_message_mapping"></a>Mail Message Mapping</h4></div></div></div>

<p>You can now map inbound mail messages with the <code class="literal">MessageHeaders</code> containing the mail headers and the payload containing the email content.
Previously, the payload was always the raw <code class="literal">MimeMessage</code>.
See <a class="xref" href="#mail-mapping" title="24.3&nbsp;Inbound Mail Message Mapping">Section&nbsp;24.3, &#8220;Inbound Mail Message Mapping&#8221;</a> for more information.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_jms_changes_2" href="#_jms_changes_2"></a>I.6.3&nbsp;JMS Changes</h3></div></div></div>

<p>This section describes general changes to the Spring Integration JMS functionality.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_header_mapper" href="#_header_mapper"></a>Header Mapper</h4></div></div></div>

<p>The <code class="literal">DefaultJmsHeaderMapper</code> now maps the standard <code class="literal">correlationId</code> header as a message property by invoking its <code class="literal">toString()</code> method.
See <a class="xref" href="#jms-header-mapping" title="23.6&nbsp;Mapping Message Headers to and from JMS Message">Section&nbsp;23.6, &#8220;Mapping Message Headers to and from JMS Message&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_asynchronous_gateway" href="#_asynchronous_gateway"></a>Asynchronous Gateway</h4></div></div></div>

<p>The JMS outbound gateway now has an <code class="literal">async</code> property.
See <a class="xref" href="#jms-async-gateway" title="23.5.4&nbsp;Async Gateway">Section&nbsp;23.5.4, &#8220;Async Gateway&#8221;</a> for more information.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_aggregator_changes" href="#_aggregator_changes"></a>I.6.4&nbsp;Aggregator Changes</h3></div></div></div>

<p>There is a change in behavior when a POJO aggregator releases a collection of <code class="literal">Message&lt;?&gt;</code> objects.
This is rare, but, if your application does that, you need to make a small change to your POJO.
See this <a class="xref" href="#agg-message-collection" title="Important">Important</a> note for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_tcp_udp_changes" href="#_tcp_udp_changes"></a>I.6.5&nbsp;TCP/UDP Changes</h3></div></div></div>

<p>This section describes general changes to the Spring Integration TCP/UDP functionality.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_events" href="#_events"></a>Events</h4></div></div></div>

<p>A new <code class="literal">TcpConnectionServerListeningEvent</code> is emitted when a server connection factory is started.
See <a class="xref" href="#tcp-events" title="34.5&nbsp;TCP Connection Events">Section&nbsp;34.5, &#8220;TCP Connection Events&#8221;</a> for more information.</p>
<p>You can now use the <code class="literal">destination-expression</code> and <code class="literal">socket-expression</code> attributes on <code class="literal">&lt;int-ip:udp-outbound-channel-adapter&gt;</code>.
See <a class="xref" href="#udp-adapters" title="34.2&nbsp;UDP Adapters">Section&nbsp;34.2, &#8220;UDP Adapters&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_stream_deserializers" href="#_stream_deserializers"></a>Stream Deserializers</h4></div></div></div>

<p>The various deserializers that cannot allocate the final buffer until the whole message has been assembled now support pooling the raw buffer into which the data is received rather than creating and discarding a buffer for each message.
See <a class="xref" href="#tcp-connection-factories" title="34.3&nbsp;TCP Connection Factories">Section&nbsp;34.3, &#8220;TCP Connection Factories&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_tcp_message_mapper" href="#_tcp_message_mapper"></a>TCP Message Mapper</h4></div></div></div>

<p>The message mapper now, optionally, sets a configured content type header.
See <a class="xref" href="#ip-msg-headers" title="34.13&nbsp;IP Message Headers">Section&nbsp;34.13, &#8220;IP Message Headers&#8221;</a> for more information.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_file_changes_2" href="#_file_changes_2"></a>I.6.6&nbsp;File Changes</h3></div></div></div>

<p>This section describes general changes to the Spring Integration File functionality.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_destination_directory_creation" href="#_destination_directory_creation"></a>Destination Directory Creation</h4></div></div></div>

<p>The generated file name for the <code class="literal">FileWritingMessageHandler</code> can represent a sub-path to save the desired directory structure for a file in the target directory.
See <a class="xref" href="#file-writing-file-names" title="17.2.1&nbsp;Generating File Names">Section&nbsp;17.2.1, &#8220;Generating File Names&#8221;</a> for more information.</p>
<p>The <code class="literal">FileReadingMessageSource</code> now hides the <code class="literal">WatchService</code> directory scanning logic in the inner class.
We added the <code class="literal">use-watch-service</code> and <code class="literal">watch-events</code> options to enable this behavior.
We deprecated the top-level <code class="literal">WatchServiceDirectoryScanner</code> because of inconsistency around the API.
See <a class="xref" href="#watch-service-directory-scanner" title="17.1.4&nbsp;WatchServiceDirectoryScanner">Section&nbsp;17.1.4, &#8220;<code class="literal">WatchServiceDirectoryScanner</code>&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_buffer_size" href="#_buffer_size"></a>Buffer Size</h4></div></div></div>

<p>When writing files, you can now specify the buffer size.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_appending_and_flushing" href="#_appending_and_flushing"></a>Appending and Flushing</h4></div></div></div>

<p>You can now avoid flushing files when appending and use a number of strategies to flush the data during idle periods.
See <a class="xref" href="#file-flushing" title="17.2.4&nbsp;Flushing Files When Using APPEND_NO_FLUSH">Section&nbsp;17.2.4, &#8220;Flushing Files When Using <code class="literal">APPEND_NO_FLUSH</code>&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_preserving_timestamps" href="#_preserving_timestamps"></a>Preserving Timestamps</h4></div></div></div>

<p>You can now configure the outbound channel adapter to set the destination file&#8217;s <code class="literal">lastmodified</code> timestamp.
See <a class="xref" href="#file-timestamps" title="17.2.5&nbsp;File Timestamps">Section&nbsp;17.2.5, &#8220;File Timestamps&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_splitter_changes_2" href="#_splitter_changes_2"></a>Splitter Changes</h4></div></div></div>

<p>The <code class="literal">FileSplitter</code> now automatically closes an FTP or SFTP session when the file is completely read.
This applies when the outbound gateway returns an <code class="literal">InputStream</code> or when you use the new FTP or SFTP streaming channel adapters.
We also introduced a new <code class="literal">markers-json</code> option to convert <code class="literal">FileSplitter.FileMarker</code> to JSON <code class="literal">String</code> for relaxed downstream network interaction.
See <a class="xref" href="#file-splitter" title="17.4&nbsp;File Splitter">Section&nbsp;17.4, &#8220;File Splitter&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_file_filters" href="#_file_filters"></a>File Filters</h4></div></div></div>

<p>We added <code class="literal">ChainFileListFilter</code> as an alternative to <code class="literal">CompositeFileListFilter</code>.
See <a class="xref" href="#file-reading" title="17.1&nbsp;Reading Files">Section&nbsp;17.1, &#8220;Reading Files&#8221;</a> for more information.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_amqp_changes_2" href="#_amqp_changes_2"></a>I.6.7&nbsp;AMQP Changes</h3></div></div></div>

<p>This section describes general changes to the Spring Integration AMQP functionality.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_content_type_message_converter" href="#_content_type_message_converter"></a>Content Type Message Converter</h4></div></div></div>

<p>The outbound endpoints now support a <code class="literal">RabbitTemplate</code> configured with a <code class="literal">ContentTypeDelegatingMessageConverter</code> such
that you can choose the converter based on the message content type.
See <a class="xref" href="#content-type-conversion-outbound" title="14.8&nbsp;Outbound Message Conversion">Section&nbsp;14.8, &#8220;Outbound Message Conversion&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_headers_for_delayed_message_handling" href="#_headers_for_delayed_message_handling"></a>Headers for Delayed Message Handling</h4></div></div></div>

<p>Spring AMQP 1.6 adds support for <a class="ulink" href="https://www.rabbitmq.com/blog/2015/04/16/scheduling-messages-with-rabbitmq/" target="_top">delayed message exchanges</a>.
Header mapping now supports the headers (<code class="literal">amqp_delay</code> and <code class="literal">amqp_receivedDelay</code>) used by this feature.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_amqp_backed_channels" href="#_amqp_backed_channels"></a>AMQP-Backed Channels</h4></div></div></div>

<p>AMQP-backed channels now support message mapping.
See <a class="xref" href="#amqp-channels" title="14.11&nbsp;AMQP-backed Message Channels">Section&nbsp;14.11, &#8220;AMQP-backed Message Channels&#8221;</a> for more information.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_redis_changes_2" href="#_redis_changes_2"></a>I.6.8&nbsp;Redis Changes</h3></div></div></div>

<p>This section describes general changes to the Spring Integration Redis functionality.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_list_push_pop_direction" href="#_list_push_pop_direction"></a>List Push/Pop Direction</h4></div></div></div>

<p>Previously, the queue channel adapters always used the Redis list in a fixed direction, pushing to the left end and reading from the right end.
You can now configure the reading and writing direction with the <code class="literal">rightPop</code> and <code class="literal">leftPush</code> options for the
<code class="literal">RedisQueueMessageDrivenEndpoint</code> and <code class="literal">RedisQueueOutboundChannelAdapter</code>, respectively.
See <a class="xref" href="#redis-queue-inbound-channel-adapter" title="27.2.4&nbsp;Redis Queue Inbound Channel Adapter">Section&nbsp;27.2.4, &#8220;Redis Queue Inbound Channel Adapter&#8221;</a> and <a class="xref" href="#redis-queue-outbound-channel-adapter" title="27.2.5&nbsp;Redis Queue Outbound Channel Adapter">Section&nbsp;27.2.5, &#8220;Redis Queue Outbound Channel Adapter&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_queue_inbound_gateway_default_serializer" href="#_queue_inbound_gateway_default_serializer"></a>Queue Inbound Gateway Default Serializer</h4></div></div></div>

<p>The default serializer in the inbound gateway has been changed to a <code class="literal">JdkSerializationRedisSerializer</code> for compatibility with the outbound gateway.
See <a class="xref" href="#redis-queue-inbound-gateway" title="27.9&nbsp;Redis Queue Inbound Gateway">Section&nbsp;27.9, &#8220;Redis Queue Inbound Gateway&#8221;</a> for more information.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_http_changes_2" href="#_http_changes_2"></a>I.6.9&nbsp;HTTP Changes</h3></div></div></div>

<p>Previously, with requests that had a body (such as <code class="literal">POST</code>) that had no <code class="literal">content-type</code> header, the body was ignored.
With this release, the content type of such requests is considered to be <code class="literal">application/octet-stream</code> as recommended
by RFC 2616.
See <a class="xref" href="#http-inbound" title="20.1&nbsp;Http Inbound Components">Section&nbsp;20.1, &#8220;Http Inbound Components&#8221;</a> for more information.</p>
<p><code class="literal">uriVariablesExpression</code> now uses a <code class="literal">SimpleEvaluationContext</code> by default (since 4.3.15).
See <a class="xref" href="#mapping-uri-variables" title="20.3.7&nbsp;Mapping URI Variables">Section&nbsp;20.3.7, &#8220;Mapping URI Variables&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_sftp_changes" href="#_sftp_changes"></a>I.6.10&nbsp;SFTP Changes</h3></div></div></div>

<p>This section describes general changes to the Spring Integration SFTP functionality.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_factory_bean" href="#_factory_bean"></a>Factory Bean</h4></div></div></div>

<p>We added a new factory bean to simplify the configuration of Jsch proxies for SFTP.
See <a class="xref" href="#sftp-proxy-factory-bean" title="30.2&nbsp;Proxy Factory Bean">Section&nbsp;30.2, &#8220;Proxy Factory Bean&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_literal_chmod_literal_changes" href="#_literal_chmod_literal_changes"></a><code class="literal">chmod</code> Changes</h4></div></div></div>

<p>The SFTP outbound gateway (for <code class="literal">put</code> and <code class="literal">mput</code> commands) and the SFTP outbound channel adapter now support the <code class="literal">chmod</code> attribute to change the remote file permissions after uploading.
See <code class="literal">&lt;&lt;sftp-outbound&gt;&gt;</code> and <code class="literal">&lt;&lt;sftp-outbound-gateway&gt;&gt;</code> for more information.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_ftp_changes" href="#_ftp_changes"></a>I.6.11&nbsp;FTP Changes</h3></div></div></div>

<p>This section describes general changes to the Spring Integration FTP functionality.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_session_changes" href="#_session_changes"></a>Session Changes</h4></div></div></div>

<p>The <code class="literal">FtpSession</code> now supports <code class="literal">null</code> for the <code class="literal">list()</code> and <code class="literal">listNames()</code> methods, since underlying FTP Client can use it.
With that, you can now configure the <code class="literal">FtpOutboundGateway</code> without the <code class="literal">remoteDirectory</code> expression.
You can also configure the <code class="literal">&lt;int-ftp:inbound-channel-adapter&gt;</code> without <code class="literal">remote-directory</code> or <code class="literal">remote-directory-expression</code>.
See <a class="xref" href="#ftp" title="18.&nbsp;FTP/FTPS Adapters">Chapter&nbsp;18, <i>FTP/FTPS Adapters</i></a> for more information.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_router_changes" href="#_router_changes"></a>I.6.12&nbsp;Router Changes</h3></div></div></div>

<p>The <code class="literal">ErrorMessageExceptionTypeRouter</code> now supports the <code class="literal">Exception</code> superclass mappings to avoid duplication for the same channel in case of multiple inheritors.
For this purpose, the <code class="literal">ErrorMessageExceptionTypeRouter</code> loads mapping classes during initialization to fail-fast for a <code class="literal">ClassNotFoundException</code>.</p>
<p>See <a class="xref" href="#router" title="8.1&nbsp;Routers">Section&nbsp;8.1, &#8220;Routers&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_header_mapping" href="#_header_mapping"></a>I.6.13&nbsp;Header Mapping</h3></div></div></div>

<p>This section describes the changes to header mapping between version 4.2 and 4.3.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_general" href="#_general"></a>General</h4></div></div></div>

<p>AMQP, WS, and XMPP header mappings (such as <code class="literal">request-header-mapping</code> and <code class="literal">reply-header-mapping</code>) now support negated patterns.
See <a class="xref" href="#amqp-message-headers" title="14.12&nbsp;AMQP Message Headers">Section&nbsp;14.12, &#8220;AMQP Message Headers&#8221;</a>, <a class="xref" href="#ws-message-headers" title="37.5&nbsp;WS Message Headers">Section&nbsp;37.5, &#8220;WS Message Headers&#8221;</a>, and <a class="xref" href="#xmpp-message-headers" title="39.5&nbsp;XMPP Message Headers">Section&nbsp;39.5, &#8220;XMPP Message Headers&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_amqp_header_mapping" href="#_amqp_header_mapping"></a>AMQP Header Mapping</h4></div></div></div>

<p>Previously, only standard AMQP headers were mapped by default.
You had to explicitly enable mapping of user-defined headers.
With this release, all headers are mapped by default.
In addition, the inbound <code class="literal">amqp_deliveryMode</code> header is no longer mapped by default.
See <a class="xref" href="#amqp-message-headers" title="14.12&nbsp;AMQP Message Headers">Section&nbsp;14.12, &#8220;AMQP Message Headers&#8221;</a> for more information.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_groovy_scripts" href="#_groovy_scripts"></a>I.6.14&nbsp;Groovy Scripts</h3></div></div></div>

<p>You can now configure groovy scripts with the <code class="literal">compile-static</code> hint or any other <code class="literal">CompilerConfiguration</code> options.
See <a class="xref" href="#groovy-config" title="10.8.1&nbsp;Groovy Configuration">Section&nbsp;10.8.1, &#8220;Groovy Configuration&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_literal_inboundchanneladapter_literal_changes" href="#_literal_inboundchanneladapter_literal_changes"></a>I.6.15&nbsp;<code class="literal">@InboundChannelAdapter</code> Changes</h3></div></div></div>

<p>The <code class="literal">@InboundChannelAdapter</code> now has an alias <code class="literal">channel</code> attribute for the regular <code class="literal">value</code>.
In addition, the target <code class="literal">SourcePollingChannelAdapter</code> components can now resolve the target <code class="literal">outputChannel</code> bean from its provided name (<code class="literal">outputChannelName</code> options) in a late-binding manner.
See <a class="xref" href="#annotations" title="E.5&nbsp;Annotation Support">Section&nbsp;E.5, &#8220;Annotation Support&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_xmpp_changes" href="#_xmpp_changes"></a>I.6.16&nbsp;XMPP Changes</h3></div></div></div>

<p>The XMPP channel adapters now support the XMPP Extensions (XEP).
See <a class="xref" href="#xmpp-extensions" title="39.6&nbsp;XMPP Extensions">Section&nbsp;39.6, &#8220;XMPP Extensions&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_wiretap_late_binding" href="#_wiretap_late_binding"></a>I.6.17&nbsp;WireTap Late Binding</h3></div></div></div>

<p>The <code class="literal">WireTap</code> <code class="literal">ChannelInterceptor</code> now can accept a <code class="literal">channelName</code> that is resolved to the target <code class="literal">MessageChannel</code>
later, during the first active interceptor operation.
See <a class="xref" href="#channel-wiretap" title="Wire Tap">the section called &#8220;Wire Tap&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_literal_channelmessagestorequeryprovider_literal_changes" href="#_literal_channelmessagestorequeryprovider_literal_changes"></a>I.6.18&nbsp;<code class="literal">ChannelMessageStoreQueryProvider</code> Changes</h3></div></div></div>

<p>The <code class="literal">ChannelMessageStoreQueryProvider</code> now supports H2 databases.
See <a class="xref" href="#jdbc-message-store-channels" title="21.4.3&nbsp;Backing Message Channels">Section&nbsp;21.4.3, &#8220;Backing Message Channels&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_websocket_changes" href="#_websocket_changes"></a>I.6.19&nbsp;WebSocket Changes</h3></div></div></div>

<p>The <code class="literal">ServerWebSocketContainer</code> now exposes an <code class="literal">allowedOrigins</code> option, and <code class="literal">SockJsServiceOptions</code> exposes a <code class="literal">suppressCors</code> option.
See <a class="xref" href="#web-sockets" title="36.&nbsp;WebSockets Support">Chapter&nbsp;36, <i>WebSockets Support</i></a> for more information.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="migration-4.1-4.2" href="#migration-4.1-4.2"></a>I.7&nbsp;Changes between 4.1 and 4.2</h2></div></div></div>

<p>See the <a class="ulink" href="https://github.com/spring-projects/spring-integration/wiki/Spring-Integration-4.1-to-4.2-Migration-Guide" target="_top">Migration Guide</a> for important changes that might affect your applications.
You can find migration guides for all versions back to 2.1 on the <a class="ulink" href="https://github.com/spring-projects/spring-integration/wiki" target="_top">wiki</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="x4.2-new-components" href="#x4.2-new-components"></a>I.8&nbsp;New Components</h2></div></div></div>

<p>Version 4.2 added a number of new components.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="x4.2-JMX" href="#x4.2-JMX"></a>I.8.1&nbsp;Major Management/JMX Rework</h3></div></div></div>

<p>We added a new <code class="literal">MetricsFactory</code> strategy interface.
This change, together with other changes in the JMX and management infrastructure, provides much more control over management configuration and runtime performance.</p>
<p>However, this has some important implications for (some) user environments.</p>
<p>For complete details, see <a class="xref" href="#metrics-management" title="12.1&nbsp;Metrics and Management">Section&nbsp;12.1, &#8220;Metrics and Management&#8221;</a> and <a class="xref" href="#jmx-42-improvements" title="JMX Improvements">the section called &#8220;JMX Improvements&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="x4.2-mongodb-metadata-store" href="#x4.2-mongodb-metadata-store"></a>I.8.2&nbsp;MongoDB Metadata Store</h3></div></div></div>

<p>The <code class="literal">MongoDbMetadataStore</code> is now available.
For more information, see <a class="xref" href="#mongodb-metadata-store" title="25.2.2&nbsp;MongoDB Metadata Store">Section&nbsp;25.2.2, &#8220;MongoDB Metadata Store&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="x4.2-secured-channel-annotation" href="#x4.2-secured-channel-annotation"></a>I.8.3&nbsp;SecuredChannel Annotation</h3></div></div></div>

<p>We introduced the <code class="literal">@SecuredChannel</code> annotation, replacing the deprecated <code class="literal">ChannelSecurityInterceptorFactoryBean</code>.
For more information, see <a class="xref" href="#security" title="Appendix&nbsp;D.&nbsp;Security in Spring Integration">Appendix&nbsp;D, <i>Security in Spring Integration</i></a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="x4.2-security-context-propagation" href="#x4.2-security-context-propagation"></a>I.8.4&nbsp;<code class="literal">SecurityContext</code> Propagation</h3></div></div></div>

<p>We introduced the <code class="literal">SecurityContextPropagationChannelInterceptor</code> for the <code class="literal">SecurityContext</code> propagation from one message flow&#8217;s thread to another.
For more information, see <a class="xref" href="#security" title="Appendix&nbsp;D.&nbsp;Security in Spring Integration">Appendix&nbsp;D, <i>Security in Spring Integration</i></a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="x4.2-file-splitter" href="#x4.2-file-splitter"></a>I.8.5&nbsp;FileSplitter</h3></div></div></div>

<p>In 4.1.2, we added <code class="literal">FileSplitter</code>, which splits text files into lines.
It now has full support in the <code class="literal">int-file:</code> namespace.
See <a class="xref" href="#file-splitter" title="17.4&nbsp;File Splitter">Section&nbsp;17.4, &#8220;File Splitter&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="x4.2-zk" href="#x4.2-zk"></a>I.8.6&nbsp;Zookeeper Support</h3></div></div></div>

<p>We added Zookeeper support to the framework to assist when running on a clustered or multi-host environment.
The change impacts the following features:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">ZookeeperMetadataStore</code>
</li><li class="listitem">
<code class="literal">ZookeeperLockRegistry</code>
</li><li class="listitem">
Zookeeper Leadership
</li></ul></div>
<p>See <a class="xref" href="#zookeeper" title="40.&nbsp;Zookeeper Support">Chapter&nbsp;40, <i>Zookeeper Support</i></a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="x4.2-barrier" href="#x4.2-barrier"></a>I.8.7&nbsp;Thread Barrier</h3></div></div></div>

<p>A new thread <code class="literal">&lt;int:barrier/&gt;</code> component is available, letting a thread be suspended until some asynchronous event occurs.
See <a class="xref" href="#barrier" title="8.8&nbsp;Thread Barrier">Section&nbsp;8.8, &#8220;Thread Barrier&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="x4.2-stomp" href="#x4.2-stomp"></a>I.8.8&nbsp;STOMP Support</h3></div></div></div>

<p>We added STOMP support to the framework as an inbound and outbound channel adapters pair.
See <a class="xref" href="#stomp" title="31.&nbsp;STOMP Support">Chapter&nbsp;31, <i>STOMP Support</i></a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="x4.2-codec" href="#x4.2-codec"></a>I.8.9&nbsp;Codec</h3></div></div></div>

<p>A new <code class="literal">Codec</code> abstraction has been introduced, to encode and decode objects to and from <code class="literal">byte[]</code>.
We added an implementation that uses Kryo.
We also added codec-based transformers and message converters.
See <a class="xref" href="#codec" title="9.4&nbsp;Codec">Section&nbsp;9.4, &#8220;Codec&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="x4.2-prepared-statement-setter" href="#x4.2-prepared-statement-setter"></a>I.8.10&nbsp;Message PreparedStatement Setter</h3></div></div></div>

<p>A new <code class="literal">MessagePreparedStatementSetter</code> functional interface callback is available for the <code class="literal">JdbcMessageHandler</code> (<code class="literal">&lt;int-jdbc:outbound-gateway&gt;</code> and <code class="literal">&lt;int-jdbc:outbound-channel-adapter&gt;</code>) as an alternative to using <code class="literal">SqlParameterSourceFactory</code> to populate parameters on the <code class="literal">PreparedStatement</code> with the <code class="literal">requestMessage</code> context.
See <a class="xref" href="#jdbc-outbound-channel-adapter" title="21.2&nbsp;Outbound Channel Adapter">Section&nbsp;21.2, &#8220;Outbound Channel Adapter&#8221;</a> for more information.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="x4.2-general" href="#x4.2-general"></a>I.9&nbsp;General Changes</h2></div></div></div>

<p>This section describes general changes from version 4.1 to version 4.2.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="x4.2-wire-tap" href="#x4.2-wire-tap"></a>I.9.1&nbsp;WireTap</h3></div></div></div>

<p>As an alternative to the existing <code class="literal">selector</code> attribute, the <code class="literal">&lt;wire-tap/&gt;</code> element now supports the <code class="literal">selector-expression</code> attribute.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="x4.2-file-changes" href="#x4.2-file-changes"></a>I.9.2&nbsp;File Changes</h3></div></div></div>

<p>See <a class="xref" href="#files" title="17.&nbsp;File Support">Chapter&nbsp;17, <i>File Support</i></a> for more information about these changes.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_appending_new_lines" href="#_appending_new_lines"></a>Appending New Lines</h4></div></div></div>

<p>The <code class="literal">&lt;int-file:outbound-channel-adapter&gt;</code> and <code class="literal">&lt;int-file:outbound-gateway&gt;</code> now support an <code class="literal">append-new-line</code> attribute.
If set to <code class="literal">true</code>, a new line is appended to the file after a message is written.
The default attribute value is <code class="literal">false</code>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_ignoring_hidden_files" href="#_ignoring_hidden_files"></a>Ignoring Hidden Files</h4></div></div></div>

<p>We added the <code class="literal">ignore-hidden</code> attribute for the <code class="literal">&lt;int-file:inbound-channel-adapter&gt;</code> to let you set whether to pick up hidden files from the source directory.
It defaults to <code class="literal">true</code>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_writing_literal_inputstream_literal_payloads" href="#_writing_literal_inputstream_literal_payloads"></a>Writing <code class="literal">InputStream</code> Payloads</h4></div></div></div>

<p>The <code class="literal">FileWritingMessageHandler</code> now also accepts <code class="literal">InputStream</code> as a valid message payload type.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_literal_headdirectoryscanner_literal" href="#_literal_headdirectoryscanner_literal"></a><code class="literal">HeadDirectoryScanner</code></h4></div></div></div>

<p>You can now use the <code class="literal">HeadDirectoryScanner</code> with other <code class="literal">FileListFilter</code> implementations.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_last_modified_filter" href="#_last_modified_filter"></a>Last Modified Filter</h4></div></div></div>

<p>We added the <code class="literal">LastModifiedFileListFilter</code>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_watch_service_directory_scanner" href="#_watch_service_directory_scanner"></a>Watch Service Directory Scanner</h4></div></div></div>

<p>We added the <code class="literal">WatchServiceDirectoryScanner</code>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_persistent_file_list_filter_changes" href="#_persistent_file_list_filter_changes"></a>Persistent File List Filter Changes</h4></div></div></div>

<p>The <code class="literal">AbstractPersistentFileListFilter</code> has a new property (<code class="literal">flushOnUpdate</code>) which, when set to <code class="literal">true</code>, calls <code class="literal">flush()</code> on the metadata store if it implements <code class="literal">Flushable</code> (for example, <code class="literal">PropertiesPersistingMetadataStore</code>).</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="x4.2-class-package-change" href="#x4.2-class-package-change"></a>I.9.3&nbsp;Class Package Change</h3></div></div></div>

<p>We moved the <code class="literal">ScatterGatherHandler</code> class from the <code class="literal">org.springframework.integration.handler</code> to the <code class="literal">org.springframework.integration.scattergather</code>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_tcp_changes_2" href="#_tcp_changes_2"></a>I.9.4&nbsp;TCP Changes</h3></div></div></div>

<p>This section describes general changes to the Spring Integration TCP functionality.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.2-tcp-serializers" href="#x4.2-tcp-serializers"></a>TCP Serializers</h4></div></div></div>

<p>The TCP <code class="literal">Serializers</code> no longer <code class="literal">flush()</code> the <code class="literal">OutputStream</code>.
This is now done by the <code class="literal">TcpNxxConnection</code> classes.
If you use the serializers directly within your code, you may have to <code class="literal">flush()</code> the <code class="literal">OutputStream</code>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.2-tcp-server-exceptions" href="#x4.2-tcp-server-exceptions"></a>Server Socket Exceptions</h4></div></div></div>

<p><code class="literal">TcpConnectionServerExceptionEvent</code> instances are now published whenever an unexpected exception occurs on a TCP server socket (also added to 4.1.3 and 4.0.7).
See <a class="xref" href="#tcp-events" title="34.5&nbsp;TCP Connection Events">Section&nbsp;34.5, &#8220;TCP Connection Events&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.2-tcp-server-port" href="#x4.2-tcp-server-port"></a>TCP Server Port</h4></div></div></div>

<p>If you configure a TCP server socket factory to listen on a random port, you can now obtain the actual port chosen by the OS by using <code class="literal">getPort()</code>.
<code class="literal">getServerSocketAddress()</code> is also available.</p>
<p>See "<a class="xref" href="#tcp-connection-factories" title="34.3&nbsp;TCP Connection Factories">Section&nbsp;34.3, &#8220;TCP Connection Factories&#8221;</a>" for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.2-tcp-gw-rto" href="#x4.2-tcp-gw-rto"></a>TCP Gateway Remote Timeout</h4></div></div></div>

<p>The <code class="literal">TcpOutboundGateway</code> now supports <code class="literal">remote-timeout-expression</code> as an alternative to the existing <code class="literal">remote-timeout</code> attribute.
This allows setting the timeout based on each message.</p>
<p>Also, the <code class="literal">remote-timeout</code> no longer defaults to the same value as <code class="literal">reply-timeout</code>, which has a completely different meaning.</p>
<p>See <a class="xref" href="#tcp-ob-gateway-attributes" title="Table&nbsp;34.7.&nbsp;TCP Outbound Gateway Attributes">Table&nbsp;34.7, &#8220;TCP Outbound Gateway Attributes&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.2-tcp-ssl" href="#x4.2-tcp-ssl"></a>TCP SSLSession Available for Header Mapping</h4></div></div></div>

<p><code class="literal">TcpConnection</code> implementations now support <code class="literal">getSslSession()</code> to let you extract information from the session to add to message headers.
See <a class="xref" href="#ip-msg-headers" title="34.13&nbsp;IP Message Headers">Section&nbsp;34.13, &#8220;IP Message Headers&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.2-tcp-events" href="#x4.2-tcp-events"></a>TCP Events</h4></div></div></div>

<p>New events are now published whenever a correlation exception occurs&#8201;&#8212;&#8201;such as sending a message to a non-existent socket.</p>
<p>The <code class="literal">TcpConnectionEventListeningMessageProducer</code> is deprecated.
Use the generic event adapter instead.</p>
<p>See <a class="xref" href="#tcp-events" title="34.5&nbsp;TCP Connection Events">Section&nbsp;34.5, &#8220;TCP Connection Events&#8221;</a> for more information.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="x4.2-inbound-channel-adapter-annotation" href="#x4.2-inbound-channel-adapter-annotation"></a>I.9.5&nbsp;<code class="literal">@InboundChannelAdapter</code> Changes</h3></div></div></div>

<p>Previously, the <code class="literal">@Poller</code> on an inbound channel adapter defaulted the <code class="literal">maxMessagesPerPoll</code> attribute to <code class="literal">-1</code> (infinity).
This was inconsistent with the XML configuration of <code class="literal">&lt;inbound-channel-adapter/&gt;</code>, which defaults to <code class="literal">1</code>.
The annotation now defaults this attribute to <code class="literal">1</code>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="x4.2-api-changes" href="#x4.2-api-changes"></a>I.9.6&nbsp;API Changes</h3></div></div></div>

<p><code class="literal">o.s.integration.util.FunctionIterator</code> now requires a <code class="literal">o.s.integration.util.Function</code> instead of a <code class="literal">reactor.function.Function</code>.
This was done to remove an unnecessary hard dependency on Reactor.
Any uses of this iterator need to change the import.</p>
<p>Reactor is still supported for functionality such as the <code class="literal">Promise</code> gateway.
The dependency was removed for those users who do not need it.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="x4.2-jms-changes" href="#x4.2-jms-changes"></a>I.9.7&nbsp;JMS Changes</h3></div></div></div>

<p>This section describes general changes to the Spring Integration TCP functionality.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_reply_listener_lazy_initialization" href="#_reply_listener_lazy_initialization"></a>Reply Listener Lazy Initialization</h4></div></div></div>

<p>You can now configure the reply listener in JMS outbound gateways to be initialized on-demand and stopped after an idle period, instead of being controlled by the gateway&#8217;s lifecycle.
See <a class="xref" href="#jms-outbound-gateway" title="23.5&nbsp;Outbound Gateway">Section&nbsp;23.5, &#8220;Outbound Gateway&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_conversion_errors_in_message_driven_endpoints" href="#_conversion_errors_in_message_driven_endpoints"></a>Conversion Errors in Message-Driven Endpoints</h4></div></div></div>

<p>The <code class="literal">error-channel</code> is now used for the conversion errors. In previous versions, they caused transaction rollback and message redelivery.</p>
<p>See <a class="xref" href="#jms-message-driven-channel-adapter" title="23.2&nbsp;Message-driven Channel Adapter">Section&nbsp;23.2, &#8220;Message-driven Channel Adapter&#8221;</a> and <a class="xref" href="#jms-inbound-gateway" title="23.4&nbsp;Inbound Gateway">Section&nbsp;23.4, &#8220;Inbound Gateway&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_default_acknowledge_mode" href="#_default_acknowledge_mode"></a>Default Acknowledge Mode</h4></div></div></div>

<p>When using an implicitly defined <code class="literal">DefaultMessageListenerContainer</code>, the default <code class="literal">acknowledge</code> is now <code class="literal">transacted</code>.
We recommend using <code class="literal">transacted</code> when using this container, to avoid message loss.
This default now applies to the message-driven inbound adapter and the inbound gateway.
It was already the default for JMS-backed channels.</p>
<p>See <a class="xref" href="#jms-message-driven-channel-adapter" title="23.2&nbsp;Message-driven Channel Adapter">Section&nbsp;23.2, &#8220;Message-driven Channel Adapter&#8221;</a> and <a class="xref" href="#jms-inbound-gateway" title="23.4&nbsp;Inbound Gateway">Section&nbsp;23.4, &#8220;Inbound Gateway&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_shared_subscriptions" href="#_shared_subscriptions"></a>Shared Subscriptions</h4></div></div></div>

<p>We added Namespace support for shared subscriptions (JMS 2.0) to message-driven endpoints and the <code class="literal">&lt;int-jms:publish-subscribe-channel&gt;</code>.
Previously, you had to wire up listener containers as <code class="literal">&lt;bean/&gt;</code> declarations to use shared connections.</p>
<p>See <a class="xref" href="#jms" title="23.&nbsp;JMS Support">Chapter&nbsp;23, <i>JMS Support</i></a> for more information.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="x4.2-conditional-pollers" href="#x4.2-conditional-pollers"></a>I.9.8&nbsp;Conditional Pollers</h3></div></div></div>

<p>We now provide much more flexibility for dynamic polling.</p>
<p>See <a class="xref" href="#conditional-pollers" title="6.2.4&nbsp;Conditional Pollers for Message Sources">Section&nbsp;6.2.4, &#8220;Conditional Pollers for Message Sources&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="x4.2-amqp-changes" href="#x4.2-amqp-changes"></a>I.9.9&nbsp;AMQP Changes</h3></div></div></div>

<p>This section describes general changes to the Spring Integration AMQP functionality.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_publisher_confirmations" href="#_publisher_confirmations"></a>Publisher Confirmations</h4></div></div></div>

<p>The <code class="literal">&lt;int-amqp:outbound-gateway&gt;</code> now supports <code class="literal">confirm-correlation-expression</code>, <code class="literal">confirm-ack-channel</code>, and <code class="literal">confirm-nack-channel</code> attributes (which have a purpose similar to that of <code class="literal">&lt;int-amqp:outbound-channel-adapter&gt;</code>).</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_correlation_data" href="#_correlation_data"></a>Correlation Data</h4></div></div></div>

<p>For both the outbound channel adapter and the inbound gateway, if the correlation data is a <code class="literal">Message&lt;?&gt;</code>, it becomes the basis of the message on the ack or nack channel, with the additional header(s) added.
Previously, any correlation data (including <code class="literal">Message&lt;?&gt;</code>) was returned as the payload of the ack or nack message.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_inbound_gateway_properties" href="#_inbound_gateway_properties"></a>Inbound Gateway Properties</h4></div></div></div>

<p>The <code class="literal">&lt;int-amqp:inbound-gateway&gt;</code> now exposes the <code class="literal">amqp-template</code> attribute to allow more control over an external bean for the reply <code class="literal">RabbitTemplate</code>.
You can also provide your own <code class="literal">AmqpTemplate</code> implementation.
In addition, you can use <code class="literal">default-reply-to</code> if the request message does not have a <code class="literal">replyTo</code> property.</p>
<p>See <a class="xref" href="#amqp" title="14.&nbsp;AMQP Support">Chapter&nbsp;14, <i>AMQP Support</i></a> for more information.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="x4.2-xpath-splitter" href="#x4.2-xpath-splitter"></a>I.9.10&nbsp;XPath Splitter Improvements</h3></div></div></div>

<p>The <code class="literal">XPathMessageSplitter</code> (<code class="literal">&lt;int-xml:xpath-splitter&gt;</code>) now allows the configuration of <code class="literal">output-properties</code> for the internal <code class="literal">javax.xml.transform.Transformer</code> and supports an <code class="literal">Iterator</code> mode (defaults to <code class="literal">true</code>) for the XPath evaluation <code class="literal">org.w3c.dom.NodeList</code> result.</p>
<p>See <a class="xref" href="#xml-xpath-splitting" title="38.4&nbsp;Splitting XML Messages">Section&nbsp;38.4, &#8220;Splitting XML Messages&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="x4.2-http-changes" href="#x4.2-http-changes"></a>I.9.11&nbsp;HTTP Changes</h3></div></div></div>

<p>This section describes general changes to the Spring Integration HTTP functionality.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_cors" href="#_cors"></a>CORS</h4></div></div></div>

<p>The HTTP inbound endpoints (<code class="literal">&lt;int-http:inbound-channel-adapter&gt;</code> and <code class="literal">&lt;int-http:inbound-gateway&gt;</code>) now allow the
configuration of Cross-origin Resource Sharing (CORS).</p>
<p>See <a class="xref" href="#http-cors" title="20.3.3&nbsp;Cross-origin Resource Sharing (CORS) Support">Section&nbsp;20.3.3, &#8220;Cross-origin Resource Sharing (CORS) Support&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_inbound_gateway_timeout" href="#_inbound_gateway_timeout"></a>Inbound Gateway Timeout</h4></div></div></div>

<p>You can configure the HTTP inbound gate way to return a status code that you specify when a request times out.
The default is now <code class="literal">500 Internal Server Error</code> instead of <code class="literal">200 OK</code>.</p>
<p>See <a class="xref" href="#http-response-statuscode" title="20.3.4&nbsp;Response Status Code">Section&nbsp;20.3.4, &#8220;Response Status Code&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_form_data" href="#_form_data"></a>Form Data</h4></div></div></div>

<p>We added documentation for proxying <code class="literal">multipart/form-data</code> requests.
See <a class="xref" href="#http" title="20.&nbsp;HTTP Support">Chapter&nbsp;20, <i>HTTP Support</i></a> for more information.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="x4.2-gw" href="#x4.2-gw"></a>I.9.12&nbsp;Gateway Changes</h3></div></div></div>

<p>This section describes general changes to the Spring Integration Gateway functionality.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_gateway_methods_can_return_literal_completablefuture_literal" href="#_gateway_methods_can_return_literal_completablefuture_literal"></a>Gateway Methods can Return <code class="literal">CompletableFuture&lt;?&gt;</code></h4></div></div></div>

<p>When using Java 8, gateway methods can now return <code class="literal">CompletableFuture&lt;?&gt;</code>.
See <a class="xref" href="#gw-completable-future" title="CompletableFuture">the section called &#8220;<code class="literal">CompletableFuture</code>&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_messaginggateway_annotation" href="#_messaginggateway_annotation"></a>MessagingGateway Annotation</h4></div></div></div>

<p>The request and reply timeout properties are now <code class="literal">String</code> instead of <code class="literal">Long</code> to allow configuration with property placeholders or SpEL.
See <a class="xref" href="#messaging-gateway-annotation" title="10.4.6&nbsp;@MessagingGateway Annotation">Section&nbsp;10.4.6, &#8220;<code class="literal">@MessagingGateway</code> Annotation&#8221;</a>.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="x4.2-aggregator-changes" href="#x4.2-aggregator-changes"></a>I.9.13&nbsp;Aggregator Changes</h3></div></div></div>

<p>This section describes general changes to the Spring Integration aggregator functionality.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_aggregator_performance" href="#_aggregator_performance"></a>Aggregator Performance</h4></div></div></div>

<p>This release includes some performance improvements for aggregating components (aggregator, resequencer, and others), by more efficiently removing messages from groups when they are released.
New methods (<code class="literal">removeMessagesFromGroup</code>) have been added to the message store.
Set the <code class="literal">removeBatchSize</code> property (default: <code class="literal">100</code>) to adjust the number of messages deleted in each operation.
Currently, the JDBC, Redis, and MongoDB message stores support this property.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_output_message_group_processor" href="#_output_message_group_processor"></a>Output Message Group Processor</h4></div></div></div>

<p>When using a <code class="literal">ref</code> or inner bean for the aggregator, you can now directly bind a <code class="literal">MessageGroupProcessor</code>.
In addition, we added a <code class="literal">SimpleMessageGroupProcessor</code> that returns the collection of messages in the group.
When an output processor produces a collection of <code class="literal">Message&lt;?&gt;</code>, the aggregator releases those messages individually.
Configuring the <code class="literal">SimpleMessageGroupProcessor</code> makes the aggregator a message barrier, where messages are held up until they all arrive and are then released individually.
See <a class="xref" href="#aggregator" title="8.4&nbsp;Aggregator">Section&nbsp;8.4, &#8220;Aggregator&#8221;</a> for more information.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_ftp_and_sftp_changes_2" href="#_ftp_and_sftp_changes_2"></a>I.9.14&nbsp;FTP and SFTP Changes</h3></div></div></div>

<p>This section describes general changes to the Spring Integration FTP and SFTP functionality.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_inbound_channel_adapters" href="#_inbound_channel_adapters"></a>Inbound Channel Adapters</h4></div></div></div>

<p>You can now specify a <code class="literal">remote-directory-expression</code> on the inbound channel adapters, to determine the directory at runtime.
See <a class="xref" href="#ftp" title="18.&nbsp;FTP/FTPS Adapters">Chapter&nbsp;18, <i>FTP/FTPS Adapters</i></a> and <a class="xref" href="#sftp" title="30.&nbsp;SFTP Adapters">Chapter&nbsp;30, <i>SFTP Adapters</i></a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_gateway_partial_results" href="#_gateway_partial_results"></a>Gateway Partial Results</h4></div></div></div>

<p>When you use FTP or SFTP outbound gateways to operate on multiple files (with <code class="literal">mget</code> and <code class="literal">mput</code>), an exception can
occur after part of the request is completed.
If such a condition occurs, a <code class="literal">PartialSuccessException</code> that contains the partial results is thrown.
See <a class="xref" href="#ftp-outbound-gateway" title="18.9&nbsp;FTP Outbound Gateway">Section&nbsp;18.9, &#8220;FTP Outbound Gateway&#8221;</a> and <a class="xref" href="#sftp-outbound-gateway" title="30.11&nbsp;SFTP Outbound Gateway">Section&nbsp;30.11, &#8220;SFTP Outbound Gateway&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_delegating_session_factory" href="#_delegating_session_factory"></a>Delegating Session Factory</h4></div></div></div>

<p>We added a delegating session factory, enabling the selection of a particular session factory based on some thread context value.</p>
<p>See <a class="xref" href="#ftp-dsf" title="18.3&nbsp;Delegating Session Factory">Section&nbsp;18.3, &#8220;Delegating Session Factory&#8221;</a> and <a class="xref" href="#sftp-dsf" title="30.3&nbsp;Delegating Session Factory">Section&nbsp;30.3, &#8220;Delegating Session Factory&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_default_sftp_session_factory" href="#_default_sftp_session_factory"></a>Default Sftp Session Factory</h4></div></div></div>

<p>Previously, the <code class="literal">DefaultSftpSessionFactory</code> unconditionally allowed connections to unknown hosts.
This is now configurable (default: <code class="literal">false</code>).</p>
<p>The factory now requires a configured <code class="literal">knownHosts</code>, file unless the <code class="literal">allowUnknownKeys</code> property is <code class="literal">true</code> (default: <code class="literal">false</code>).</p>
<p>See <a class="xref" href="#sftp-unk-keys">Section&nbsp;30.1.1, &#8220;Configuration Properties&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_message_session_callback" href="#_message_session_callback"></a>Message Session Callback</h4></div></div></div>

<p>We introduced the <code class="literal">MessageSessionCallback&lt;F, T&gt;</code> to perform any custom <code class="literal">Session</code> operations with the <code class="literal">requestMessage</code> context in the <code class="literal">&lt;int-(s)ftp:outbound-gateway/&gt;</code>.</p>
<p>See <a class="xref" href="#ftp-session-callback" title="18.12&nbsp;Using MessageSessionCallback">Section&nbsp;18.12, &#8220;Using <code class="literal">MessageSessionCallback</code>&#8221;</a> and <a class="xref" href="#sftp-session-callback" title="30.13&nbsp;MessageSessionCallback">Section&nbsp;30.13, &#8220;MessageSessionCallback&#8221;</a> for more information.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_websocket_changes_2" href="#_websocket_changes_2"></a>I.9.15&nbsp;Websocket Changes</h3></div></div></div>

<p>We added <code class="literal">WebSocketHandlerDecoratorFactory</code> support to the <code class="literal">ServerWebSocketContainer</code> to allow chained customization for the internal <code class="literal">WebSocketHandler</code>.
See <a class="xref" href="#web-sockets-namespace" title="36.4&nbsp;WebSockets Namespace Support">Section&nbsp;36.4, &#8220;WebSockets Namespace Support&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_application_event_adapters_changes" href="#_application_event_adapters_changes"></a>I.9.16&nbsp;Application Event Adapters changes</h3></div></div></div>

<p>The <code class="literal">ApplicationEvent</code> adapters can now operate with <code class="literal">payload</code> as an <code class="literal">event</code> to directly allow omitting custom <code class="literal">ApplicationEvent</code> extensions.
For this purpose, we introduced the <code class="literal">publish-payload</code> boolean attribute has been introduced on the <code class="literal">&lt;int-event:outbound-channel-adapter&gt;</code>.
See <a class="xref" href="#applicationevent" title="15.&nbsp;Spring ApplicationEvent Support">Chapter&nbsp;15, <i>Spring <code class="literal">ApplicationEvent</code> Support</i></a> for more information.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="migration-4.0-4.1" href="#migration-4.0-4.1"></a>I.10&nbsp;Changes between 4.0 and 4.1</h2></div></div></div>

<p>See the <a class="ulink" href="https://github.com/spring-projects/spring-integration/wiki/Spring-Integration-4.0-to-4.1-Migration-Guide" target="_top">Migration Guide</a> for important changes that might affect your applications.
You can find migration guides for all versions back to 2.1 on the <a class="ulink" href="https://github.com/spring-projects/spring-integration/wiki" target="_top">wiki</a>.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_new_components" href="#_new_components"></a>I.10.1&nbsp;New Components</h3></div></div></div>

<p>Version 4.1 added a number of new components.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.1-promise-gateway" href="#x4.1-promise-gateway"></a>Promise&lt;?&gt; Gateway</h4></div></div></div>

<p>The messaging gateway methods now support a Reactor <code class="literal">Promise</code> return type.
See <a class="xref" href="#async-gateway" title="10.4.10&nbsp;Asynchronous Gateway">Section&nbsp;10.4.10, &#8220;Asynchronous Gateway&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.1-web-socket-adapters" href="#x4.1-web-socket-adapters"></a>WebSocket support</h4></div></div></div>

<p>The <code class="literal">WebSocket</code> module is now available.
It is fully based on the Spring WebSocket and Spring Messaging modules and provides an <code class="literal">&lt;inbound-channel-adapter&gt;</code> and an <code class="literal">&lt;outbound-channel-adapter&gt;</code>.
See <a class="xref" href="#web-sockets" title="36.&nbsp;WebSockets Support">Chapter&nbsp;36, <i>WebSockets Support</i></a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.1-scatter-gather" href="#x4.1-scatter-gather"></a>Scatter-Gather Enterprise Integration Pattern</h4></div></div></div>

<p>We implemented the scatter-gather enterprise integration pattern.
See <a class="xref" href="#scatter-gather" title="8.7&nbsp;Scatter-Gather">Section&nbsp;8.7, &#8220;Scatter-Gather&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.1-Routing-Slip" href="#x4.1-Routing-Slip"></a>Routing Slip Pattern</h4></div></div></div>

<p>We added the routing slip EIP pattern implementation.
See <a class="xref" href="#routing-slip" title="Routing Slip">the section called &#8220;Routing Slip&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.1-idempotent-receiver" href="#x4.1-idempotent-receiver"></a>Idempotent Receiver Pattern</h4></div></div></div>

<p>We added the idempotent receiver enterprise integration pattern implementation by adding the <code class="literal">&lt;idempotent-receiver&gt;</code> component in XML or the <code class="literal">IdempotentReceiverInterceptor</code> and <code class="literal">IdempotentReceiver</code> annotations for Java configuration.
See <a class="xref" href="#idempotent-receiver" title="10.9.10&nbsp;Idempotent Receiver Enterprise Integration Pattern">Section&nbsp;10.9.10, &#8220;Idempotent Receiver Enterprise Integration Pattern&#8221;</a> and the <a class="ulink" href="https://docs.spring.io/spring-integration/api/index.html" target="_top">Javadoc</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.1-BoonJsonObjectMapper" href="#x4.1-BoonJsonObjectMapper"></a>Boon <code class="literal">JsonObjectMapper</code></h4></div></div></div>

<p>We added the Boon <code class="literal">JsonObjectMapper</code> for the JSON transformers.
See <a class="xref" href="#transformer" title="9.1&nbsp;Transformer">Section&nbsp;9.1, &#8220;Transformer&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.1-redis-queue-gateways" href="#x4.1-redis-queue-gateways"></a>Redis Queue Gateways</h4></div></div></div>

<p>We added the <code class="literal">&lt;redis-queue-inbound-gateway&gt;</code> and <code class="literal">&lt;redis-queue-outbound-gateway&gt;</code> components.
See <a class="xref" href="#redis-queue-inbound-gateway" title="27.9&nbsp;Redis Queue Inbound Gateway">Section&nbsp;27.9, &#8220;Redis Queue Inbound Gateway&#8221;</a> and <a class="xref" href="#redis-queue-outbound-gateway" title="27.8&nbsp;Redis Queue Outbound Gateway">Section&nbsp;27.8, &#8220;Redis Queue Outbound Gateway&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.1-PollSkipAdvice" href="#x4.1-PollSkipAdvice"></a><code class="literal">PollSkipAdvice</code></h4></div></div></div>

<p>We added the <code class="literal">PollSkipAdvice</code>, which you can use within the <code class="literal">&lt;advice-chain&gt;</code> of the <code class="literal">&lt;poller&gt;</code> to determine if the current poll should be suppressed (skipped) by some condition that you implement with <code class="literal">PollSkipStrategy</code>.
See <a class="xref" href="#polling-consumer" title="6.2&nbsp;Poller">Section&nbsp;6.2, &#8220;Poller&#8221;</a> for more information.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="x4.1-general" href="#x4.1-general"></a>I.10.2&nbsp;General Changes</h3></div></div></div>

<p>This section describes general changes from version 4.0 to version 4.1.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.1-amqp-inbound-missing-queues" href="#x4.1-amqp-inbound-missing-queues"></a>AMQP Inbound Endpoints, Channel</h4></div></div></div>

<p>Elements that use a message listener container (inbound endpoints and channel) now support the <code class="literal">missing-queues-fatal</code> attribute.
See <a class="xref" href="#amqp" title="14.&nbsp;AMQP Support">Chapter&nbsp;14, <i>AMQP Support</i></a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.1-amqp-outbound-lazy-connect" href="#x4.1-amqp-outbound-lazy-connect"></a>AMQP Outbound Endpoints</h4></div></div></div>

<p>The AMQP outbound endpoints support a new property called <code class="literal">lazy-connect</code> (default: <code class="literal">true</code>).
When <code class="literal">true</code>, the connection to the broker is not established until the first message arrives (assuming there are no inbound endpoints, which always try to establish the connection during startup).
When set to <code class="literal">false</code>, an attempt to establish the connection is made during application startup.
See <a class="xref" href="#amqp" title="14.&nbsp;AMQP Support">Chapter&nbsp;14, <i>AMQP Support</i></a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.1-sms-copy-on-get" href="#x4.1-sms-copy-on-get"></a>SimpleMessageStore</h4></div></div></div>

<p>The <code class="literal">SimpleMessageStore</code> no longer makes a copy of the group when calling <code class="literal">getMessageGroup()</code>.
See <a class="xref" href="#sms-caution" title="Caution about SimpleMessageStore">Caution about <code class="literal">SimpleMessageStore</code></a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.1-ws-encode-uri" href="#x4.1-ws-encode-uri"></a>Web Service Outbound Gateway: <code class="literal">encode-uri</code></h4></div></div></div>

<p>The <code class="literal">&lt;ws:outbound-gateway/&gt;</code> now provides an <code class="literal">encode-uri</code> attribute to allow disabling the encoding of the URI object before sending the request.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.1-http-status-code" href="#x4.1-http-status-code"></a>Http Inbound Channel Adapter and Status Code</h4></div></div></div>

<p>The <code class="literal">&lt;http:inbound-channel-adapter&gt;</code> can now be configured with a <code class="literal">status-code-expression</code> to override the default <code class="literal">200 OK</code> status.
See <a class="xref" href="#http-namespace" title="20.3&nbsp;HTTP Namespace Support">Section&nbsp;20.3, &#8220;HTTP Namespace Support&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.1-mqtt" href="#x4.1-mqtt"></a>MQTT Adapter Changes</h4></div></div></div>

<p>You can now configure the MQTT channel adapters to connect to multiple servers&#8201;&#8212;&#8201;for example, to support High Availability (HA).
See <a class="xref" href="#mqtt" title="26.&nbsp;MQTT Support">Chapter&nbsp;26, <i>MQTT Support</i></a> for more information.</p>
<p>The MQTT message-driven channel adapter now supports specifying the QoS setting for each subscription.
See <a class="xref" href="#mqtt-inbound" title="26.1&nbsp;Inbound (Message-driven) Channel Adapter">Section&nbsp;26.1, &#8220;Inbound (Message-driven) Channel Adapter&#8221;</a> for more information.</p>
<p>The MQTT outbound channel adapter now supports asynchronous sends, avoiding blocking until delivery is confirmed.
See <a class="xref" href="#mqtt-outbound" title="26.2&nbsp;Outbound Channel Adapter">Section&nbsp;26.2, &#8220;Outbound Channel Adapter&#8221;</a> for more information.</p>
<p>It is now possible to programmatically subscribe to and unsubscribe from topics at runtime.
See <a class="xref" href="#mqtt-inbound" title="26.1&nbsp;Inbound (Message-driven) Channel Adapter">Section&nbsp;26.1, &#8220;Inbound (Message-driven) Channel Adapter&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.1-sftp" href="#x4.1-sftp"></a>FTP and SFTP Adapter Changes</h4></div></div></div>

<p>The FTP and SFTP outbound channel adapters now support appending to remote files and taking specific actions when a remote file already exists.
The remote file templates now also supports this, as well as <code class="literal">rmdir()</code> and <code class="literal">exists()</code>.
In addition, the remote file templates provide access to the underlying client object, enabling access to low-level APIs.</p>
<p>See <a class="xref" href="#ftp" title="18.&nbsp;FTP/FTPS Adapters">Chapter&nbsp;18, <i>FTP/FTPS Adapters</i></a> and <a class="xref" href="#sftp" title="30.&nbsp;SFTP Adapters">Chapter&nbsp;30, <i>SFTP Adapters</i></a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.1-splitter-iterator" href="#x4.1-splitter-iterator"></a>Splitter and Iterator</h4></div></div></div>

<p><code class="literal">Splitter</code> components now support an <code class="literal">Iterator</code> as the result object for producing output messages.
See <a class="xref" href="#splitter" title="8.3&nbsp;Splitter">Section&nbsp;8.3, &#8220;Splitter&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.1-aggregator" href="#x4.1-aggregator"></a>Aggregator</h4></div></div></div>

<p><code class="literal">Aggregator</code> instancess now support a new attribute <code class="literal">expire-groups-upon-timeout</code>.
See <a class="xref" href="#aggregator" title="8.4&nbsp;Aggregator">Section&nbsp;8.4, &#8220;Aggregator&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.1-content-enricher-improvement" href="#x4.1-content-enricher-improvement"></a>Content Enricher Improvements</h4></div></div></div>

<p>We added a <code class="literal">null-result-expression</code> attribute, which is evaluated and returned if <code class="literal">&lt;enricher&gt;</code> returns <code class="literal">null</code>.
You can add it in <code class="literal">&lt;header&gt;</code> and <code class="literal">&lt;property&gt;</code>.
See <a class="xref" href="#content-enricher" title="9.2&nbsp;Content Enricher">Section&nbsp;9.2, &#8220;Content Enricher&#8221;</a> for more information.</p>
<p>We added an <code class="literal">error-channel</code> attribute, which is used to handle an error flow if an <code class="literal">Exception</code> occurs downstream of the <code class="literal">request-channel</code>.
This lets you return an alternative object to use for enrichment.
See <a class="xref" href="#content-enricher" title="9.2&nbsp;Content Enricher">Section&nbsp;9.2, &#8220;Content Enricher&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.1-header-channel-registry" href="#x4.1-header-channel-registry"></a>Header Channel Registry</h4></div></div></div>

<p>The <code class="literal">&lt;header-enricher/&gt;</code> element&#8217;s <code class="literal">&lt;header-channels-to-string/&gt;</code> child element can now override the header channel registry&#8217;s default time for retaining channel mappings.
See <a class="xref" href="#header-channel-registry" title="Header Channel Registry">the section called &#8220;Header Channel Registry&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.1-orderly-shutdown" href="#x4.1-orderly-shutdown"></a>Orderly Shutdown</h4></div></div></div>

<p>We made improvements to the orderly shutdown algorithm.
See <a class="xref" href="#jmx-shutdown" title="12.7&nbsp;Orderly Shutdown">Section&nbsp;12.7, &#8220;Orderly Shutdown&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.1-recipientListRouter" href="#x4.1-recipientListRouter"></a>Management for <code class="literal">RecipientListRouter</code></h4></div></div></div>

<p>The <code class="literal">RecipientListRouter</code> now provides several management operations to configure recipients at runtime.
With that, you can now configure the <code class="literal">&lt;recipient-list-router&gt;</code> without any <code class="literal">&lt;recipient&gt;</code> from the start.
See <a class="xref" href="#recipient-list-router-management" title="RecipientListRouterManagement">the section called &#8220;<code class="literal">RecipientListRouterManagement</code>&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.1-AbstractHeaderMapper-changes" href="#x4.1-AbstractHeaderMapper-changes"></a>AbstractHeaderMapper: NON_STANDARD_HEADERS token</h4></div></div></div>

<p>The <code class="literal">AbstractHeaderMapper</code> implementation now provides the additional <code class="literal">NON_STANDARD_HEADERS</code> token to map any user-defined headers, which are not mapped by default.
See <a class="xref" href="#amqp-message-headers" title="14.12&nbsp;AMQP Message Headers">Section&nbsp;14.12, &#8220;AMQP Message Headers&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.1-amqp-channels" href="#x4.1-amqp-channels"></a>AMQP Channels: <code class="literal">template-channel-transacted</code></h4></div></div></div>

<p>We introduced the <code class="literal">template-channel-transacted</code> attribute for AMQP <code class="literal">MessageChannel</code> instances.
See <a class="xref" href="#amqp-channels" title="14.11&nbsp;AMQP-backed Message Channels">Section&nbsp;14.11, &#8220;AMQP-backed Message Channels&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.1-syslog" href="#x4.1-syslog"></a>Syslog Adapter</h4></div></div></div>

<p>The default syslog message converter now has an option to retain the original message in the payload while still setting the headers.
See <a class="xref" href="#syslog-inbound-adapter" title="33.1&nbsp;Syslog Inbound Channel Adapter">Section&nbsp;33.1, &#8220;Syslog Inbound Channel Adapter&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.1-async-gateway" href="#x4.1-async-gateway"></a>Asynchronous Gateway</h4></div></div></div>

<p>In addition to the <code class="literal">Promise</code> return type <a class="link" href="#x4.1-promise-gateway" title="Promise<?&gt; Gateway">mentioned earlier</a>, gateway methods may now return a <code class="literal">ListenableFuture</code>, introduced in Spring Framework 4.0.
You can also disable asynchronous processing in the gateway, letting a downstream flow directly return a <code class="literal">Future</code>.
See <a class="xref" href="#async-gateway" title="10.4.10&nbsp;Asynchronous Gateway">Section&nbsp;10.4.10, &#8220;Asynchronous Gateway&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.1-aggregator-advice-chain" href="#x4.1-aggregator-advice-chain"></a>Aggregator Advice Chain</h4></div></div></div>

<p><code class="literal">Aggregator</code> and <code class="literal">Resequencer</code> now support <code class="literal">&lt;expire-advice-chain/&gt;</code> and <code class="literal">&lt;expire-transactional/&gt;</code> child elements to advise the <code class="literal">forceComplete</code> operation.
See <a class="xref" href="#">???</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.1-script-outbound-channel-adapter" href="#x4.1-script-outbound-channel-adapter"></a>Outbound Channel Adapter and Scripts</h4></div></div></div>

<p>The <code class="literal">&lt;int:outbound-channel-adapter/&gt;</code> now supports the <code class="literal">&lt;script/&gt;</code> child element.
The underlying script must have a <code class="literal">void</code> return type or return <code class="literal">null</code>.
See <a class="xref" href="#groovy" title="10.8&nbsp;Groovy support">Section&nbsp;10.8, &#8220;Groovy support&#8221;</a> and <a class="xref" href="#scripting" title="10.7&nbsp;Scripting Support">Section&nbsp;10.7, &#8220;Scripting Support&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.1-reseq" href="#x4.1-reseq"></a>Resequencer Changes</h4></div></div></div>

<p>When a message group in a resequencer times out (using <code class="literal">group-timeout</code> or a <code class="literal">MessageGroupStoreReaper</code>), late arriving messages are now, by default, discarded immediately.
See <a class="xref" href="#resequencer" title="8.5&nbsp;Resequencer">Section&nbsp;8.5, &#8220;Resequencer&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.1-Optional-Parameter" href="#x4.1-Optional-Parameter"></a>Optional POJO method parameter</h4></div></div></div>

<p>Spring Integration now consistently handles the Java 8&#8217;s <code class="literal">Optional</code> type.
See <a class="xref" href="#service-activator-namespace" title="10.5.1&nbsp;Configuring Service Activator">Section&nbsp;10.5.1, &#8220;Configuring Service Activator&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.1-queue-channel-queue.typ" href="#x4.1-queue-channel-queue.typ"></a><code class="literal">QueueChannel</code> backed Queue type</h4></div></div></div>

<p>The <code class="literal">QueueChannel</code> backed <code class="literal">Queue type</code> has been changed from <code class="literal">BlockingQueue</code> to the more generic <code class="literal">Queue</code>.
This change allows the use of any external <code class="literal">Queue</code> implementation (for example, Reactor&#8217;s <code class="literal">PersistentQueue</code>).
See <a class="xref" href="#channel-configuration-queuechannel" title="QueueChannel Configuration">the section called &#8220;<code class="literal">QueueChannel</code> Configuration&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.1-channel-interceptor" href="#x4.1-channel-interceptor"></a><code class="literal">ChannelInterceptor</code> Changes</h4></div></div></div>

<p>The <code class="literal">ChannelInterceptor</code> now supports additional <code class="literal">afterSendCompletion()</code> and <code class="literal">afterReceiveCompletion()</code> methods.
See <a class="xref" href="#channel-interceptors" title="6.1.3&nbsp;Channel Interceptors">Section&nbsp;6.1.3, &#8220;Channel Interceptors&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.1-mail-peek" href="#x4.1-mail-peek"></a>IMAP PEEK</h4></div></div></div>

<p>Since version 4.1.1 there is a change of behavior if you explicitly set the <code class="literal">mail.[protocol].peek</code> JavaMail property to <code class="literal">false</code> (where <code class="literal">[protocol]</code> is <code class="literal">imap</code> or <code class="literal">imaps</code>).
See <a class="xref" href="#imap-peek" title="Important: IMAP PEEK">Important: IMAP PEEK</a>.</p>
</div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="migration-3.0-4.0" href="#migration-3.0-4.0"></a>I.11&nbsp;Changes between 3.0 and 4.0</h2></div></div></div>

<p>See the <a class="ulink" href="https://github.com/spring-projects/spring-integration/wiki/Spring-Integration-3.0-to-4.0-Migration-Guide" target="_top">Migration Guide</a> for important changes that might affect your applications.
You can find migration guides for all versions back to 2.1 on the <a class="ulink" href="https://github.com/spring-projects/spring-integration/wiki" target="_top">wiki</a>.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="x4.0-new-components" href="#x4.0-new-components"></a>I.11.1&nbsp;New Components</h3></div></div></div>

<p>Version 4.0 added a number of new components.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.0-mqtt" href="#x4.0-mqtt"></a>MQTT Channel Adapters</h4></div></div></div>

<p>The MQTT channel adapters (previously available in the Spring Integration Extensions repository) are now available as part of the normal Spring Integration distribution.
See <a class="xref" href="#mqtt" title="26.&nbsp;MQTT Support">Chapter&nbsp;26, <i>MQTT Support</i></a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.0-enable-configuration" href="#x4.0-enable-configuration"></a><code class="literal">@EnableIntegration</code></h4></div></div></div>

<p>We added the <code class="literal">@EnableIntegration</code> annotation to permit declaration of standard Spring Integration beans when using <code class="literal">@Configuration</code> classes.
See <a class="xref" href="#annotations" title="E.5&nbsp;Annotation Support">Section&nbsp;E.5, &#8220;Annotation Support&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.0-component-scan" href="#x4.0-component-scan"></a><code class="literal">@IntegrationComponentScan</code></h4></div></div></div>

<p>We added the <code class="literal">@IntegrationComponentScan</code> annotation to permit classpath scanning for Spring Integration-specific components.
See <a class="xref" href="#annotations" title="E.5&nbsp;Annotation Support">Section&nbsp;E.5, &#8220;Annotation Support&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.0-message-history" href="#x4.0-message-history"></a>"<code class="literal">@EnableMessageHistory</code>"</h4></div></div></div>

<p>You can now enable message history with the <code class="literal">@EnableMessageHistory</code> annotation in a <code class="literal">@Configuration</code> class.
In addition, a JMX MBean can modify the message history settings.
Also, <code class="literal">MessageHistory</code> can track auto-created <code class="literal">MessageHandler</code> instances for annotated endpoints (such as <code class="literal">@ServiceActivator</code>, <code class="literal">@Splitter</code>, and others).
For more information, see <a class="xref" href="#message-history" title="12.3&nbsp;Message History">Section&nbsp;12.3, &#8220;Message History&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.0-messaging-gateway" href="#x4.0-messaging-gateway"></a><code class="literal">@MessagingGateway</code></h4></div></div></div>

<p>You can now configure messaging gateway interfaces with the <code class="literal">@MessagingGateway</code> annotation.
It is an analogue of the <code class="literal">&lt;int:gateway/&gt;</code> XML element.
For more information, see <a class="xref" href="#messaging-gateway-annotation" title="10.4.6&nbsp;@MessagingGateway Annotation">Section&nbsp;10.4.6, &#8220;<code class="literal">@MessagingGateway</code> Annotation&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.0-boot" href="#x4.0-boot"></a>Spring Boot <code class="literal">@EnableAutoConfiguration</code></h4></div></div></div>

<p>As well as the <code class="literal">@EnableIntegration</code> annotation mentioned earlier, we introduced a hook to allow the Spring Integration infrastructure beans to be configured with Spring Boot&#8217;s <code class="literal">@EnableAutoConfiguration</code> annotation.
For more information, see <a class="ulink" href="http://docs.spring.io/spring-boot/docs/current/reference/html/using-boot-auto-configuration.html" target="_top">"<code class="literal">Auto-configuration</code>"</a> in the Spring Boot Reference Guide.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.0-global-channel-interceptor" href="#x4.0-global-channel-interceptor"></a><code class="literal">@GlobalChannelInterceptor</code></h4></div></div></div>

<p>As well as the <code class="literal">@EnableIntegration</code> annotation mentioned above, we introduced the <code class="literal">@GlobalChannelInterceptor</code> annotation.
For more information, see <a class="xref" href="#annotations" title="E.5&nbsp;Annotation Support">Section&nbsp;E.5, &#8220;Annotation Support&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.0-integration-converter" href="#x4.0-integration-converter"></a><code class="literal">@IntegrationConverter</code></h4></div></div></div>

<p>We introduced the <code class="literal">@IntegrationConverter</code> annotation as an analogue of the <code class="literal">&lt;int:converter/&gt;</code> component.
For more information, see <a class="xref" href="#annotations" title="E.5&nbsp;Annotation Support">Section&nbsp;E.5, &#8220;Annotation Support&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.0-enable-publisher" href="#x4.0-enable-publisher"></a><code class="literal">@EnablePublisher</code></h4></div></div></div>

<p>We added the <code class="literal">@EnablePublisher</code> annotation to allow the specification of a <code class="literal">default-publisher-channel</code> for <code class="literal">@Publisher</code> annotations.
See <a class="xref" href="#annotations" title="E.5&nbsp;Annotation Support">Section&nbsp;E.5, &#8220;Annotation Support&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.0-redis-cms" href="#x4.0-redis-cms"></a>Redis Channel Message Stores</h4></div></div></div>

<p>We added a Redis <code class="literal">MessageGroupStore</code> that is optimized for use when backing a <code class="literal">QueueChannel</code> for persistence.
For more information, see <a class="xref" href="#redis-cms" title="27.3.1&nbsp;Redis Channel Message Stores">Section&nbsp;27.3.1, &#8220;Redis Channel Message Stores&#8221;</a>.</p>
<p>We added a Redis <code class="literal">ChannelPriorityMessageStore</code>.
You can use it to retrieve messages by priority.
For more information, see <a class="xref" href="#redis-cms" title="27.3.1&nbsp;Redis Channel Message Stores">Section&nbsp;27.3.1, &#8220;Redis Channel Message Stores&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.0-priority-channel-mondodb" href="#x4.0-priority-channel-mondodb"></a>MongodDB Channel Message Store</h4></div></div></div>

<p>The MongoDB support now provides the <code class="literal">MongoDbChannelMessageStore</code>, which is a channel-specific <code class="literal">MessageStore</code> implementation.
With <code class="literal">priorityEnabled = true</code>, you can use it in <code class="literal">&lt;int:priority-queue&gt;</code> elements to achieve priority order polling of persisted messages.
For more information see <a class="xref" href="#mongodb-priority-channel-message-store" title="25.2.1&nbsp;MongoDB Channel Message Store">Section&nbsp;25.2.1, &#8220;MongoDB Channel Message Store&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.0-MBeanExport-annotation" href="#x4.0-MBeanExport-annotation"></a><code class="literal">@EnableIntegrationMBeanExport</code></h4></div></div></div>

<p>You can now enable the <code class="literal">IntegrationMBeanExporter</code> with the <code class="literal">@EnableIntegrationMBeanExport</code> annotation in a <code class="literal">@Configuration</code> class.
For more information, see <a class="xref" href="#jmx-mbean-exporter" title="12.2.7&nbsp;MBean Exporter">Section&nbsp;12.2.7, &#8220;MBean Exporter&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.0-channel-security-interceptor" href="#x4.0-channel-security-interceptor"></a><code class="literal">ChannelSecurityInterceptorFactoryBean</code></h4></div></div></div>

<p><code class="literal">ChannelSecurityInterceptorFactoryBean</code> now supports configuration of Spring Security for message channels that use <code class="literal">@Configuration</code> classes.
For more information, see <a class="xref" href="#security" title="Appendix&nbsp;D.&nbsp;Security in Spring Integration">Appendix&nbsp;D, <i>Security in Spring Integration</i></a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.0-redis-outbound-gateway" href="#x4.0-redis-outbound-gateway"></a>Redis Command Gateway</h4></div></div></div>

<p>The Redis support now provides the <code class="literal">&lt;outbound-gateway&gt;</code> component to perform generic Redis commands by using the <code class="literal">RedisConnection#execute</code> method.
For more information, see <a class="xref" href="#redis-outbound-gateway" title="27.7&nbsp;Redis Outbound Command Gateway">Section&nbsp;27.7, &#8220;Redis Outbound Command Gateway&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.0-redis-gemfire-lock-registry" href="#x4.0-redis-gemfire-lock-registry"></a><code class="literal">RedisLockRegistry</code> and <code class="literal">GemfireLockRegistry</code></h4></div></div></div>

<p>The <code class="literal">RedisLockRegistry</code> and <code class="literal">GemfireLockRegistry</code> are now available to support global locks visible to multiple application instances and servers.
These can be used with aggregating message handlers across multiple application instances such that group release occurs on only one instance.
For more information, see <a class="xref" href="#redis-lock-registry" title="27.10&nbsp;Redis Lock Registry">Section&nbsp;27.10, &#8220;Redis Lock Registry&#8221;</a>, <a class="xref" href="#gemfire-lock-registry" title="19.5&nbsp;Gemfire Lock Registry">Section&nbsp;19.5, &#8220;Gemfire Lock Registry&#8221;</a>, and <a class="xref" href="#aggregator" title="8.4&nbsp;Aggregator">Section&nbsp;8.4, &#8220;Aggregator&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.0-poller-annotation" href="#x4.0-poller-annotation"></a><code class="literal">@Poller</code></h4></div></div></div>

<p>Annotation-based messaging configuration can now have a <code class="literal">poller</code> attribute.
This means that methods annotated with <code class="literal">@ServiceActivator</code>, <code class="literal">@Aggregator</code>, and similar annotations can now use an <code class="literal">inputChannel</code> that is a reference to a <code class="literal">PollableChannel</code>.
For more information, see <a class="xref" href="#annotations" title="E.5&nbsp;Annotation Support">Section&nbsp;E.5, &#8220;Annotation Support&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.0-inbound-channel-adapter-annotation" href="#x4.0-inbound-channel-adapter-annotation"></a><code class="literal">@InboundChannelAdapter</code> and <code class="literal">SmartLifecycle</code> for Annotated Endpoints</h4></div></div></div>

<p>We added the <code class="literal">@InboundChannelAdapter</code> method annotation.
It is an analogue of the <code class="literal">&lt;int:inbound-channel-adapter&gt;</code> XML component.
In addition, all messaging annotations now provide <code class="literal">SmartLifecycle</code> options.
For more information, see <a class="xref" href="#annotations" title="E.5&nbsp;Annotation Support">Section&nbsp;E.5, &#8220;Annotation Support&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.0-twitter-sog" href="#x4.0-twitter-sog"></a>Twitter Search Outbound Gateway</h4></div></div></div>

<p>We added a new twitter endpoint: <code class="literal">&lt;int-twitter-search-outbound-gateway/&gt;</code>.
Unlike the search inbound adapter, which polls by using the same search query each time, the outbound gateway allows on-demand customized queries.
For more information, see <a class="ulink" href="https://github.com/spring-projects/spring-integration-extensions/tree/master/spring-integration-social-twitter" target="_top">Spring Integration Social Twitter</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.0-gemfire-metadata" href="#x4.0-gemfire-metadata"></a>Gemfire Metadata Store</h4></div></div></div>

<p>We added the <code class="literal">GemfireMetadataStore</code>, letting it be used, for example, in an <code class="literal">AbstractPersistentAcceptOnceFileListFilter</code> implementation in a multiple application instance or server environment.
For more information, see <a class="xref" href="#metadata-store" title="12.5&nbsp;Metadata Store">Section&nbsp;12.5, &#8220;Metadata Store&#8221;</a>, <a class="xref" href="#file-reading" title="17.1&nbsp;Reading Files">Section&nbsp;17.1, &#8220;Reading Files&#8221;</a>, <a class="xref" href="#ftp-inbound" title="18.4&nbsp;FTP Inbound Channel Adapter">Section&nbsp;18.4, &#8220;FTP Inbound Channel Adapter&#8221;</a>, and <a class="xref" href="#sftp-inbound" title="30.6&nbsp;SFTP Inbound Channel Adapter">Section&nbsp;30.6, &#8220;SFTP Inbound Channel Adapter&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.0-bridge-annotations" href="#x4.0-bridge-annotations"></a><code class="literal">@BridgeFrom</code> and <code class="literal">@BridgeTo</code> Annotations</h4></div></div></div>

<p>We introduced <code class="literal">@BridgeFrom</code> and <code class="literal">@BridgeTo</code> <code class="literal">@Bean</code> method annotations to mark <code class="literal">MessageChannel</code> beans in <code class="literal">@Configuration</code> classes.
For more information, see <a class="xref" href="#annotations" title="E.5&nbsp;Annotation Support">Section&nbsp;E.5, &#8220;Annotation Support&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.0-meta-messaging-annotations" href="#x4.0-meta-messaging-annotations"></a>Meta-messaging Annotations</h4></div></div></div>

<p>Messaging annotations (<code class="literal">@ServiceActivator</code>, <code class="literal">@Router</code>, <code class="literal">@MessagingGateway</code>, and others) can now be configured as meta-annotations for user-defined messaging annotations.
In addition, the user-defined annotations can have the same attributes (<code class="literal">inputChannel</code>, <code class="literal">@Poller</code>, <code class="literal">autoStartup</code>, and others).
For more information, see <a class="xref" href="#annotations" title="E.5&nbsp;Annotation Support">Section&nbsp;E.5, &#8220;Annotation Support&#8221;</a>.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="x4.0-general" href="#x4.0-general"></a>I.11.2&nbsp;General Changes</h3></div></div></div>

<p>This section describes general changes from version 3.0 to version 4.0.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_requires_spring_framework_4_0" href="#_requires_spring_framework_4_0"></a>Requires Spring Framework 4.0</h4></div></div></div>

<p>We moved the core messaging abstractions (<code class="literal">Message</code>, <code class="literal">MessageChannel</code>, and others) to the Spring Framework <code class="literal">spring-messaging</code> module.
Developers who reference these classes directly in their code need to make changes, as described in the first section of the <a class="ulink" href="https://github.com/spring-projects/spring-integration/wiki/Spring-Integration-3.0-to-4.0-Migration-Guide" target="_top">3.0 to 4.0 Migration Guide</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.0-xpath-header-enricher-header-type" href="#x4.0-xpath-header-enricher-header-type"></a>Header Type for XPath Header Enricher</h4></div></div></div>

<p>We introduced the <code class="literal">header-type</code> attribute for the <code class="literal">header</code> child element of the <code class="literal">&lt;int-xml:xpath-header-enricher&gt;</code>.
This attribute provides the target type for the header value (to which the result of the XPath expression evaluation is converted).
For more information see <a class="xref" href="#xml-xpath-header-enricher" title="38.6&nbsp;XPath Header Enricher">Section&nbsp;38.6, &#8220;XPath Header Enricher&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.0-object-to-json-transformer-result-type" href="#x4.0-object-to-json-transformer-result-type"></a>Object To JSON Transformer: Node Result</h4></div></div></div>

<p>We introduced the <code class="literal">result-type</code> attribute for the <code class="literal">&lt;int:object-to-json-transformer&gt;</code>.
This attribute provides the target type for the result of mapping an object to JSON.
It supports <code class="literal">STRING</code> (the default) and <code class="literal">NODE</code>.
For more information see <a class="xref" href="#transformer-xpath-spel-function">the section called &#8220;JSON Transformers&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.0-jms-header-mapping" href="#x4.0-jms-header-mapping"></a>JMS Header Mapping</h4></div></div></div>

<p>The <code class="literal">DefaultJmsHeaderMapper</code> now maps an incoming <code class="literal">JMSPriority</code> header to the Spring Integration <code class="literal">priority</code> header.
Previously, <code class="literal">priority</code> was only considered for outbound messages.
For more information, see <a class="xref" href="#jms-header-mapping" title="23.6&nbsp;Mapping Message Headers to and from JMS Message">Section&nbsp;23.6, &#8220;Mapping Message Headers to and from JMS Message&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.0-jms-ob" href="#x4.0-jms-ob"></a>JMS Outbound Channel Adapter</h4></div></div></div>

<p>The JMS outbound channel adapter now supports the <code class="literal">session-transacted</code> attribute (default: <code class="literal">false</code>).
Previously, you had to inject a customized <code class="literal">JmsTemplate</code> to use transactions.
See <a class="xref" href="#jms-outbound-channel-adapter" title="23.3&nbsp;Outbound Channel Adapter">Section&nbsp;23.3, &#8220;Outbound Channel Adapter&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.0-jms-ib" href="#x4.0-jms-ib"></a>JMS Inbound Channel Adapter</h4></div></div></div>

<p>The JMS inbound channel adapter now supports the <code class="literal">session-transacted</code> attribute (default: <code class="literal">false</code>).
Previously, you had to inject a customized <code class="literal">JmsTemplate</code> to use transactions.
The adapter allowed <span class="emphasis"><em>transacted</em></span> in the <code class="literal">acknowledgeMode</code>, which was incorrect and didn&#8217;t work.
This value is no longer allowed.
See <a class="xref" href="#jms-inbound-channel-adapter" title="23.1&nbsp;Inbound Channel Adapter">Section&nbsp;23.1, &#8220;Inbound Channel Adapter&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.0-datatype-channel" href="#x4.0-datatype-channel"></a>Datatype Channels</h4></div></div></div>

<p>You can now specify a <code class="literal">MessageConverter</code> to be used when converting (if necessary) payloads to one of the accepted <code class="literal">datatype</code> instances in a Datatype channel.
For more information, see <a class="xref" href="#channel-datatype-channel" title="Datatype Channel Configuration">the section called &#8220;Datatype Channel Configuration&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.0-retry-config" href="#x4.0-retry-config"></a>Simpler Retry Advice Configuration</h4></div></div></div>

<p>We added simplified namespace support to configure a <code class="literal">RequestHandlerRetryAdvice</code>.
For more information, see <a class="xref" href="#retry-config" title="Configuring the Retry Advice">the section called &#8220;Configuring the Retry Advice&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.0-release-strategy-group-timeout" href="#x4.0-release-strategy-group-timeout"></a>Correlation Endpoint: Time-based Release Strategy</h4></div></div></div>

<p>We added the mutually exclusive <code class="literal">group-timeout</code> and <code class="literal">group-timeout-expression</code> attributes to <code class="literal">&lt;int:aggregator&gt;</code> and <code class="literal">&lt;int:resequencer&gt;</code>.
These attributes allow forced completion of a partial <code class="literal">MessageGroup</code>, provided the <code class="literal">ReleaseStrategy</code> does not release a group and no further messages arrive within the time specified.
For more information, see <a class="xref" href="#">???</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.0-redis-metadata" href="#x4.0-redis-metadata"></a>Redis Metadata Store</h4></div></div></div>

<p>The <code class="literal">RedisMetadataStore</code> now implements <code class="literal">ConcurrentMetadataStore</code>, letting it be used, for example, in an <code class="literal">AbstractPersistentAcceptOnceFileListFilter</code> implementation in a multiple application instance or server environment.
For more information, see <a class="xref" href="#redis-metadata-store" title="27.4&nbsp;Redis Metadata Store">Section&nbsp;27.4, &#8220;Redis Metadata Store&#8221;</a>, <a class="xref" href="#file-reading" title="17.1&nbsp;Reading Files">Section&nbsp;17.1, &#8220;Reading Files&#8221;</a>, <a class="xref" href="#ftp-inbound" title="18.4&nbsp;FTP Inbound Channel Adapter">Section&nbsp;18.4, &#8220;FTP Inbound Channel Adapter&#8221;</a>, and <a class="xref" href="#sftp-inbound" title="30.6&nbsp;SFTP Inbound Channel Adapter">Section&nbsp;30.6, &#8220;SFTP Inbound Channel Adapter&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.0-jdbc-cs" href="#x4.0-jdbc-cs"></a><code class="literal">JdbcChannelMessageStore</code> and <code class="literal">PriorityChannel</code></h4></div></div></div>

<p>T`JdbcChannelMessageStore` now implements <code class="literal">PriorityCapableChannelMessageStore</code>, letting it be used as a <code class="literal">message-store</code> reference for <code class="literal">priority-queue</code> instances.
For more information, see <a class="xref" href="#jdbc-message-store-channels" title="21.4.3&nbsp;Backing Message Channels">Section&nbsp;21.4.3, &#8220;Backing Message Channels&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.0-amqp" href="#x4.0-amqp"></a>AMQP Endpoints Delivery Mode</h4></div></div></div>

<p>Spring AMQP, by default, creates persistent messages on the broker.
You can override this behavior by setting the <code class="literal">amqp_deliveryMode</code> header or customizing the mappers.
We added a convenient <code class="literal">default-delivery-mode</code> attribute to the adapters to provide easier configuration of this important setting.
For more information, see <a class="xref" href="#amqp-outbound-channel-adapter" title="14.5&nbsp;Outbound Channel Adapter">Section&nbsp;14.5, &#8220;Outbound Channel Adapter&#8221;</a> and <a class="xref" href="#amqp-outbound-gateway" title="14.6&nbsp;Outbound Gateway">Section&nbsp;14.6, &#8220;Outbound Gateway&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.0-ftp" href="#x4.0-ftp"></a>FTP Timeouts</h4></div></div></div>

<p>The <code class="literal">DefaultFtpSessionFactory</code> now exposes the <code class="literal">connectTimeout</code>, <code class="literal">defaultTimeout</code>, and <code class="literal">dataTimeout</code> properties, avoiding the need to subclass the factory to set these common properties.
The <code class="literal">postProcess*</code> methods are still available for more advanced configuration.
See <a class="xref" href="#ftp-session-factory" title="18.1&nbsp;FTP Session Factory">Section&nbsp;18.1, &#8220;FTP Session Factory&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.0-twitter-status-updating" href="#x4.0-twitter-status-updating"></a>Twitter: <code class="literal">StatusUpdatingMessageHandler</code></h4></div></div></div>

<p>The <code class="literal">StatusUpdatingMessageHandler</code> (<code class="literal">&lt;int-twitter:outbound-channel-adapter&gt;</code>) now supports the <code class="literal">tweet-data-expression</code> attribute to build a <code class="literal">org.springframework.social.twitter.api.TweetData</code> object for updating the timeline status.
This feature allows, for example, attaching an image.
See <a class="ulink" href="https://github.com/spring-projects/spring-integration-extensions/tree/master/spring-integration-social-twitter" target="_top">Spring Integration Social Twitter</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.0-jpa-id-expression" href="#x4.0-jpa-id-expression"></a>JPA Retrieving Gateway: <code class="literal">id-expression</code></h4></div></div></div>

<p>We introduced the <code class="literal">id-expression</code> attribute for <code class="literal">&lt;int-jpa:retrieving-outbound-gateway&gt;</code> to perform <code class="literal">EntityManager.find(Class entityClass, Object primaryKey)</code>.
See <a class="xref" href="#jpa-retrieving-outbound-gateway" title="22.7.5&nbsp;Retrieving Outbound Gateway">Section&nbsp;22.7.5, &#8220;Retrieving Outbound Gateway&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.0-tcp-deserializer-events" href="#x4.0-tcp-deserializer-events"></a>TCP Deserialization Events</h4></div></div></div>

<p>When one of the standard deserializers encounters a problem decoding the input stream to a message, it now emits a <code class="literal">TcpDeserializationExceptionEvent</code>, letting applications examine the data at the point at which the exception occurred.
See <a class="xref" href="#tcp-events" title="34.5&nbsp;TCP Connection Events">Section&nbsp;34.5, &#8220;TCP Connection Events&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x4.0-bean-messaging-annotations" href="#x4.0-bean-messaging-annotations"></a>Messaging Annotations on <code class="literal">@Bean</code> Definitions</h4></div></div></div>

<p>You can now configure messaging annotations (<code class="literal">@ServiceActivator</code>, <code class="literal">@Router</code>, <code class="literal">@InboundChannelAdapter</code>, and others) on <code class="literal">@Bean</code> definitions in <code class="literal">@Configuration</code> classes.
For more information, see <a class="xref" href="#annotations" title="E.5&nbsp;Annotation Support">Section&nbsp;E.5, &#8220;Annotation Support&#8221;</a>.</p>
</div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="migration-2.2-3.0" href="#migration-2.2-3.0"></a>I.12&nbsp;Changes Between 2.2 and 3.0</h2></div></div></div>

<p>See the <a class="ulink" href="https://github.com/spring-projects/spring-integration/wiki/Spring-Integration-2.2-to-3.0-Migration-Guide" target="_top">Migration Guide</a> for important changes that might affect your applications.
You can find migration guides for all versions back to 2.1 on the <a class="ulink" href="https://github.com/spring-projects/spring-integration/wiki" target="_top">wiki</a>.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="x3.0-new-components" href="#x3.0-new-components"></a>I.12.1&nbsp;New Components</h3></div></div></div>

<p>Version 3.0 added a number of new components.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x3.0-request-mapping" href="#x3.0-request-mapping"></a>HTTP Request Mapping</h4></div></div></div>

<p>The HTTP module now provides powerful request mapping support for inbound endpoints.
We replaced the <code class="literal">UriPathHandlerMapping</code> class with <code class="literal">IntegrationRequestMappingHandlerMapping</code>, which is registered under the bean name of <code class="literal">integrationRequestMappingHandlerMapping</code> in the application context.
Upon parsing of the HTTP inbound endpoint, either a new <code class="literal">IntegrationRequestMappingHandlerMapping</code> bean is registered or an existing bean is reused.
To achieve flexible request mapping configuration, Spring Integration provides the <code class="literal">&lt;request-mapping/&gt;</code> child element for <code class="literal">&lt;http:inbound-channel-adapter/&gt;</code> and the <code class="literal">&lt;http:inbound-gateway/&gt;</code>.
Both HTTP inbound endpoints are now fully based on the request mapping infrastructure that was introduced with Spring MVC 3.1.
For example, multiple paths are supported on a single inbound endpoint.
For more information see <a class="xref" href="#http-namespace" title="20.3&nbsp;HTTP Namespace Support">Section&nbsp;20.3, &#8220;HTTP Namespace Support&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x3.0-spel-customization" href="#x3.0-spel-customization"></a>Spring Expression Language (SpEL) Configuration</h4></div></div></div>

<p>We added a new <code class="literal">IntegrationEvaluationContextFactoryBean</code> to allow configuration of custom <code class="literal">PropertyAccessor</code> implementations and functions for use in SpEL expressions throughout the framework.
For more information, see <a class="xref" href="#spel" title="Appendix&nbsp;A.&nbsp;Spring Expression Language (SpEL)">Appendix&nbsp;A, <i>Spring Expression Language (SpEL)</i></a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x3.0-spel-functions" href="#x3.0-spel-functions"></a>SpEL Functions Support</h4></div></div></div>

<p>To customize the SpEL <code class="literal">EvaluationContext</code> with static <code class="literal">Method</code> functions, we introduced the <code class="literal">&lt;spel-function/&gt;</code> component.
We also added two built-in functions: <code class="literal">#jsonPath</code> and <code class="literal">#xpath</code>.
For more information, see <a class="xref" href="#spel-functions" title="A.2&nbsp;SpEL Functions">Section&nbsp;A.2, &#8220;SpEL Functions&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x3.0-spel-property-accessors" href="#x3.0-spel-property-accessors"></a>SpEL PropertyAccessors Support</h4></div></div></div>

<p>To customize the SpEL <code class="literal">EvaluationContext</code> with <code class="literal">PropertyAccessor</code> implementations, we added the <code class="literal">&lt;spel-property-accessors/&gt;</code> component.
For more information, see <a class="xref" href="#spel-property-accessors" title="A.3&nbsp;Property Accessors">Section&nbsp;A.3, &#8220;Property Accessors&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x3.0-redis-new-components" href="#x3.0-redis-new-components"></a>Redis: New Components</h4></div></div></div>

<p>We added a new Redis-based <a class="ulink" href="http://docs.spring.io/spring-integration/docs/latest-ga/api/org/springframework/integration/store/MetadataStore.html" target="_top"><code class="literal">MetadataStore</code></a> implementation.
You can use the <code class="literal">RedisMetadataStore</code> to maintain the state of a <code class="literal">MetadataStore</code> across application restarts.
This new <code class="literal">MetadataStore</code> implementation can be used with adapters, such as:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Twitter inbound adapters
</li><li class="listitem">
Feed inbound channel adapter
</li></ul></div>
<p>We added new queue-based components.
We added the <code class="literal">&lt;int-redis:queue-inbound-channel-adapter/&gt;</code> and <code class="literal">&lt;int-redis:queue-outbound-channel-adapter/&gt;</code> components to perform <span class="emphasis"><em>right pop</em></span> and <span class="emphasis"><em>left push</em></span> operations, respectively, on a Redis List.</p>
<p>For more information, "<code class="literal">see &lt;&lt;redis&gt;&gt;</code>".</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x3.0-hcr" href="#x3.0-hcr"></a>Header Channel Registry</h4></div></div></div>

<p>You can now instruct the framework to store reply channels and error channels in a registry for later resolution.
This is useful for cases where the <code class="literal">replyChannel</code> or <code class="literal">errorChannel</code> might be lost (for example, when serializing a message).
See <a class="xref" href="#header-enricher" title="9.2.1&nbsp;Header Enricher">Section&nbsp;9.2.1, &#8220;Header Enricher&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x3.0-configurable-mongo-MS" href="#x3.0-configurable-mongo-MS"></a>MongoDB support: New <code class="literal">ConfigurableMongoDbMessageStore</code></h4></div></div></div>

<p>In addition to the existing <code class="literal">eMongoDbMessageStore</code>, we introduced a new <code class="literal">ConfigurableMongoDbMessageStore</code>.
This provides a more robust and flexible implementation of <code class="literal">MessageStore</code> for MongoDB.
It does not have backward compatibility with the existing store, but we recommend using it for new applications.
Existing applications can use it, but messages in the old store are not available.
See <a class="xref" href="#mongodb" title="25.&nbsp;MongoDb Support">Chapter&nbsp;25, <i>MongoDb Support</i></a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x3.0-syslog" href="#x3.0-syslog"></a>Syslog Support</h4></div></div></div>

<p>Building on the 2.2 <code class="literal">SyslogToMapTransformer</code>, Spring Integration 3.0 introduces <code class="literal">UDP</code> and <code class="literal">TCP</code> inbound channel adapters especially tailored for receiving SYSLOG messages.
For more information, see <a class="xref" href="#syslog" title="33.&nbsp;Syslog Support">Chapter&nbsp;33, <i>Syslog Support</i></a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x3.0-tail" href="#x3.0-tail"></a><code class="literal">tail</code> Support</h4></div></div></div>

<p>We added file inbound channel adapters that use the <code class="literal">tail</code> command to generate messages when lines are added to the end of text files.
See <a class="xref" href="#file-tailing" title="17.1.8&nbsp;'tail&#8217;ing Files">Section&nbsp;17.1.8, &#8220;'tail&#8217;ing Files&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x3.0-jmx" href="#x3.0-jmx"></a>JMX Support</h4></div></div></div>

<p>We added <code class="literal">&lt;int-jmx:tree-polling-channel-adapter/&gt;</code>.
This adapter queries the JMX MBean tree and sends a message with a payload that is the graph of objects that match the query.
By default, the MBeans are mapped to primitives and simple Objects (such as <code class="literal">Map</code>, <code class="literal">List</code>, and arrays).
It permits simple transformation to, for example, JSON.</p>
<p>The <code class="literal">IntegrationMBeanExporter</code> now allows the configuration of a custom <code class="literal">ObjectNamingStrategy</code> by using the <code class="literal">naming-strategy</code> attribute.</p>
<p>For more information, see <a class="xref" href="#jmx" title="12.2&nbsp;JMX Support">Section&nbsp;12.2, &#8220;JMX Support&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x3.0-tcp-events" href="#x3.0-tcp-events"></a>TCP/IP Connection Events and Connection Management</h4></div></div></div>

<p><code class="literal">TcpConnection</code> instances now emit <code class="literal">ApplicationEvent</code> instances (specifically <code class="literal">TcpConnectionEvent</code> instances) when connections are opened or closed or when an exception occurs.
This change lets applications be informed of changes to TCP connections by using the normal Spring <code class="literal">ApplicationListener</code> mechanism.</p>
<p>We renamed <code class="literal">AbstractTcpConnection</code> to <code class="literal">TcpConnectionSupport</code>.
Custom connections that are subclasses of this class can use its methods to publish events.
Similarly, we renamed <code class="literal">AbstractTcpConnectionInterceptor</code> to <code class="literal">TcpConnectionInterceptorSupport</code>.</p>
<p>In addition, we added <code class="literal">&lt;int-ip:tcp-connection-event-inbound-channel-adapter/&gt;</code>.
By default, this adapter sends all <code class="literal">TcpConnectionEvent</code> instances to a <code class="literal">Channel</code>.</p>
<p>Further, the TCP connection factories now provide a new method called <code class="literal">getOpenConnectionIds()</code>, which returns a list of identifiers for all open connections.
It lets applications broadcast to all open connections, among other uses.</p>
<p>Finally, the connection factories also provide a new method called <code class="literal">closeConnection(String connectionId)</code>, which lets applications explicitly close a connection by using its ID.</p>
<p>For more information see <a class="xref" href="#tcp-events" title="34.5&nbsp;TCP Connection Events">Section&nbsp;34.5, &#8220;TCP Connection Events&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x3.0-inbound-script" href="#x3.0-inbound-script"></a>Inbound Channel Adapter Script Support</h4></div></div></div>

<p>The <code class="literal">&lt;int:inbound-channel-adapter/&gt;</code> now supports using <code class="literal">&lt;expression/&gt;</code> and <code class="literal">&lt;script/&gt;</code> child elements to create a <code class="literal">MessageSource</code>.
See <a class="xref" href="#channel-adapter-expressions-and-scripts" title="6.3.3&nbsp;Channel Adapter Expressions and Scripts">Section&nbsp;6.3.3, &#8220;Channel Adapter Expressions and Scripts&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x3.0-content-enricher-headers" href="#x3.0-content-enricher-headers"></a>Content Enricher: Headers Enrichment Support</h4></div></div></div>

<p>The content enricher now provides configuration for <code class="literal">&lt;header/&gt;</code> child elements, to enrich the outbound message with headers based on the reply message from the underlying message flow.
For more information see <a class="xref" href="#payload-enricher" title="9.2.2&nbsp;Payload Enricher">Section&nbsp;9.2.2, &#8220;Payload Enricher&#8221;</a>.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="x3.0-general" href="#x3.0-general"></a>I.12.2&nbsp;General Changes</h3></div></div></div>

<p>This section describes general changes from version 2.2 to version 3.0.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x3.0-message-id" href="#x3.0-message-id"></a>Message ID Generation</h4></div></div></div>

<p>Previously, message IDs were generated by using the JDK <code class="literal">UUID.randomUUID()</code> method.
With this release, the default mechanism has been changed to use a more efficient and significantly faster algorithm.
In addition, we added the ability to change the strategy used to generate message IDs.
For more information see <a class="xref" href="#message-id-generation" title="7.2.2&nbsp;Message ID Generation">Section&nbsp;7.2.2, &#8220;Message ID Generation&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x3.0-gateway" href="#x3.0-gateway"></a>"<code class="literal">&lt;gateway&gt;</code>" Changes</h4></div></div></div>

<p>You can now set common headers across all gateway methods, and we added more options for adding information to the message about which method was invoked.</p>
<p>You can now entirely customize the way that gateway method calls are mapped to messages.</p>
<p>The <code class="literal">GatewayMethodMetadata</code> is now a public class.
It lets you programmatically configure the <code class="literal">GatewayProxyFactoryBean</code> from Java.</p>
<p>For more information, see <a class="xref" href="#gateway" title="10.4&nbsp;Messaging Gateways">Section&nbsp;10.4, &#8220;Messaging Gateways&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x3.0-http-endpointss" href="#x3.0-http-endpointss"></a>HTTP Endpoint Changes</h4></div></div></div>

<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="strong"><strong>Outbound Endpoint <code class="literal">encode-uri</code></strong></span>: <code class="literal">&lt;http:outbound-gateway/&gt;</code> and <code class="literal">&lt;http:outbound-channel-adapter/&gt;</code> now provide an <code class="literal">encode-uri</code> attribute to allow disabling the encoding of the URI object before sending the request.
</li><li class="listitem">
<span class="strong"><strong>Inbound Endpoint <code class="literal">merge-with-default-converters</code></strong></span>: <code class="literal">&lt;http:inbound-gateway/&gt;</code> and <code class="literal">&lt;http:inbound-channel-adapter/&gt;</code> now have a <code class="literal">merge-with-default-converters</code> attribute to include the list of default <code class="literal">HttpMessageConverter</code> instances after the custom message converters.
</li><li class="listitem">
<span class="strong"><strong><code class="literal">If-Modified-Since</code> and <code class="literal">If-Unmodified-Since</code> HTTP Headers</strong></span>: Previously, the <code class="literal">If-Modified-Since</code> and <code class="literal">If-Unmodified-Since</code> HTTP headers were incorrectly processed within from and to HTTP headers mapped in the <code class="literal">DefaultHttpHeaderMapper</code>.
Now, in addition to correcting that issue, <code class="literal">DefaultHttpHeaderMapper</code> provides date parsing from formatted strings for any HTTP headers that accept date-time values.
</li><li class="listitem">
<span class="strong"><strong>Inbound Endpoint Expression Variables</strong></span>: In addition to the existing <code class="literal">#requestParams</code> and <code class="literal">#pathVariables</code>, the <code class="literal">&lt;http:inbound-gateway/&gt;</code> and <code class="literal">&lt;http:inbound-channel-adapter/&gt;</code> now support additional useful variables: <code class="literal">#matrixVariables</code>, <code class="literal">#requestAttributes</code>, <code class="literal">#requestHeaders</code>, and <code class="literal">#cookies</code>.
These variables are available in both payload and header expressions.
</li><li class="listitem">
<span class="strong"><strong>Outbound Endpoint <span class="emphasis"><em>uri-variables-expression</em></span></strong></span>: HTTP outbound endpoints now support the <code class="literal">uri-variables-expression</code> attribute to specify an <code class="literal">Expression</code> to evaluate a <code class="literal">Map</code> for all URI variable placeholders within URL template.
This allows selection of a different map of expressions based on the outgoing message.
</li></ul></div>
<p>For more information, see <a class="xref" href="#http" title="20.&nbsp;HTTP Support">Chapter&nbsp;20, <i>HTTP Support</i></a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x3.0-json-transformers" href="#x3.0-json-transformers"></a>Jackson Support (JSON)</h4></div></div></div>

<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
A new abstraction for JSON conversion has been introduced.
Implementations for Jackson 1.x and Jackson 2 are currently provided, with the version being determined by presence on the classpath.
Previously, only Jackson 1.x was supported.
</li><li class="listitem">
The <code class="literal">ObjectToJsonTransformer</code> and <code class="literal">JsonToObjectTransformer</code> now emit/consume headers containing type information.
</li></ul></div>
<p>For more information, see "<code class="literal">JSON Transformers</code>" in <a class="xref" href="#transformer" title="9.1&nbsp;Transformer">Section&nbsp;9.1, &#8220;Transformer&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x3.0-id-for-chain-sub-components" href="#x3.0-id-for-chain-sub-components"></a>Chain Elements <code class="literal">id</code> Attribute</h4></div></div></div>

<p>Previously, the <code class="literal">id</code> attribute for elements within a <code class="literal">&lt;chain&gt;</code> was ignored and, in some cases, disallowed.
Now, the <code class="literal">id</code> attribute is allowed for all elements within a <code class="literal">&lt;chain&gt;</code>.
The bean names of chain elements is a combination of the surrounding chain&#8217;s <code class="literal">id</code> and the <code class="literal">id</code> of the element itself.
For example: <span class="emphasis"><em>myChain$child.myTransformer.handler</em></span>.
For more information see, <a class="xref" href="#chain" title="8.6&nbsp;Message Handler Chain">Section&nbsp;8.6, &#8220;Message Handler Chain&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x3.0-corr-endpoint-empty-groups" href="#x3.0-corr-endpoint-empty-groups"></a>Aggregator <span class="emphasis"><em>empty-group-min-timeout</em></span> property</h4></div></div></div>

<p>The <code class="literal">AbstractCorrelatingMessageHandler</code> provides a new property called <code class="literal">empty-group-min-timeout</code> to allow empty group expiry to run on a longer schedule than expiring partial groups.
Empty groups are not removed from the <code class="literal">MessageStore</code> until they have not been modified for at least this number of milliseconds.
For more information, see <a class="xref" href="#">???</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x3.0-filelistfilter" href="#x3.0-filelistfilter"></a>Persistent File List Filters (file, (S)FTP)</h4></div></div></div>

<p>New <code class="literal">FileListFilter</code> implementations that use a persistent <code class="literal">MetadataStore</code> are now available.
You can use these to prevent duplicate files after a system restart.
See <a class="xref" href="#file-reading" title="17.1&nbsp;Reading Files">Section&nbsp;17.1, &#8220;Reading Files&#8221;</a>, <a class="xref" href="#ftp-inbound" title="18.4&nbsp;FTP Inbound Channel Adapter">Section&nbsp;18.4, &#8220;FTP Inbound Channel Adapter&#8221;</a>, and <a class="xref" href="#sftp-inbound" title="30.6&nbsp;SFTP Inbound Channel Adapter">Section&nbsp;30.6, &#8220;SFTP Inbound Channel Adapter&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x3.0-scripting-variables" href="#x3.0-scripting-variables"></a>Scripting Support: Variables Changes</h4></div></div></div>

<p>We introduced a new <code class="literal">variables</code> attribute for scripting components.
In addition, variable bindings are now allowed for inline scripts.
See <a class="xref" href="#groovy" title="10.8&nbsp;Groovy support">Section&nbsp;10.8, &#8220;Groovy support&#8221;</a> and <a class="xref" href="#scripting" title="10.7&nbsp;Scripting Support">Section&nbsp;10.7, &#8220;Scripting Support&#8221;</a> for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x3.0-direct-channel-lb-ref" href="#x3.0-direct-channel-lb-ref"></a>Direct Channel Load Balancing configuration</h4></div></div></div>

<p>Previously, when configuring <code class="literal">LoadBalancingStrategy</code> on the channel&#8217;s <code class="literal">dispatcher</code> child element, the only available option was to use a pre-defined enumeration of values which did not let developers set a custom implementation of the <code class="literal">LoadBalancingStrategy</code>.
You can now use <code class="literal">load-balancer-ref</code> to provide a reference to a custom implementation of the <code class="literal">LoadBalancingStrategy</code>.
For more information, see <a class="xref" href="#channel-implementations-directchannel" title="DirectChannel">the section called &#8220;<code class="literal">DirectChannel</code>&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x3.0-pub-sub" href="#x3.0-pub-sub"></a>PublishSubscribeChannel Behavior</h4></div></div></div>

<p>Previously, sending to a &lt;publish-subscribe-channel/&gt; that had no subscribers would return a <code class="literal">false</code> result.
If used in conjunction with a <code class="literal">MessagingTemplate</code>, this would result in an exception being thrown.
Now, the <code class="literal">PublishSubscribeChannel</code> has a property called <code class="literal">minSubscribers</code> (default: <code class="literal">0</code>).
If the message is sent to at least the minimum number of subscribers, the send operation is deemed to be successful (even if the number is zero).
If an application expects to get an exception under these conditions, set the minimum subscribers to at least 1.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x3.0--s-ftp-changes" href="#x3.0--s-ftp-changes"></a>FTP, SFTP and FTPS Changes</h4></div></div></div>

<p>The FTP, SFTP and FTPS endpoints no longer cache sessions by default.</p>
<p>We removed the deprecated <code class="literal">cached-sessions</code> attribute from all endpoints.
Previously, the embedded caching mechanism controlled by this attribute&#8217;s value did not provide a way to limit the size of the cache, which could grow indefinitely.
Release 2.1 introduced <code class="literal">CachingConnectionFactory</code>, and it became the preferred (and is now the only) way to cache sessions.</p>
<p><code class="literal">CachingConnectionFactory</code> now provides a new method: <code class="literal">resetCache()</code>.
This method immediately closes idle sessions and causes in-use sessions to be closed as and when they are returned to the cache.</p>
<p>The <code class="literal">DefaultSftpSessionFactory</code> (in conjunction with a <code class="literal">CachingSessionFactory</code>) now supports multiplexing channels over a single SSH connection (SFTP Only).</p>
<div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="_ftp_sftp_and_ftps_inbound_adapters" href="#_ftp_sftp_and_ftps_inbound_adapters"></a>FTP, SFTP and FTPS Inbound Adapters</h5></div></div></div>

<p>Previously, there was no way to override the default filter used to process files retrieved from a remote server.
The <code class="literal">filter</code> attribute determines which files are retrieved, but the <code class="literal">FileReadingMessageSource</code> uses an <code class="literal">AcceptOnceFileListFilter</code>.
This means that, if a new copy of a file is retrieved with the same name as a previously copied file, no message was sent from the adapter.</p>
<p>With this release, a new attribute <code class="literal">local-filter</code> lets you override the default filter (for example, with an <code class="literal">AcceptAllFileListFilter</code> or some other custom filter).</p>
<p>If you want the behavior of the <code class="literal">AcceptOnceFileListFilter</code> to be maintained across JVM executions, you can now configure a custom filter that retains state, perhaps on the file system.</p>
<p>Inbound channel adapters now support the <code class="literal">preserve-timestamp</code> attribute, which sets the local file modified timestamp to the timestamp from the server (default: <code class="literal">false</code>).</p>
</div>
<div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="_ftp_sftp_and_ftps_gateways" href="#_ftp_sftp_and_ftps_gateways"></a>FTP, SFTP, and FTPS Gateways</h5></div></div></div>

<p>The gateways now support the <code class="literal">mv</code> command, enabling the renaming of remote files.</p>
<p>The gateways now support recursive <code class="literal">ls</code> and <code class="literal">mget</code> commands, enabling the retrieval of a remote file tree.</p>
<p>The gateways now support <code class="literal">put</code> and <code class="literal">mput</code> commands, enabling sending files to the remote server.</p>
<p>The <code class="literal">local-filename-generator-expression</code> attribute is now supported, enabling the naming of local files during retrieval.
By default, the same name as the remote file is used.</p>
<p>The <code class="literal">local-directory-expression</code> attribute is now supported, enabling the naming of local directories during retrieval (based on the remote directory).</p>
</div>
<div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="_remote_file_template" href="#_remote_file_template"></a>Remote File Template</h5></div></div></div>

<p>A new higher-level abstraction (<code class="literal">RemoteFileTemplate</code>) is provided over the <code class="literal">Session</code> implementations used by the FTP and SFTP modules.
While it is used internally by endpoints, you can also use this abstraction programmatically.
Like all Spring <code class="literal">*Template</code> implementations, it reliably closes the underlying session while allowing low level access to the session.</p>
<p>For more information, see <a class="xref" href="#ftp" title="18.&nbsp;FTP/FTPS Adapters">Chapter&nbsp;18, <i>FTP/FTPS Adapters</i></a> and <a class="xref" href="#sftp" title="30.&nbsp;SFTP Adapters">Chapter&nbsp;30, <i>SFTP Adapters</i></a>.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x3.0-outbound-gateway-requires-reply" href="#x3.0-outbound-gateway-requires-reply"></a><span class="emphasis"><em>requires-reply</em></span> Attribute for Outbound Gateways</h4></div></div></div>

<p>All outbound gateways (such as <code class="literal">&lt;jdbc:outbound-gateway/&gt;</code> or <code class="literal">&lt;jms:outbound-gateway/&gt;</code>) are designed for <span class="emphasis"><em>request-reply</em></span> scenarios.
A response is expected from the external service and is published to the <code class="literal">reply-channel</code> or the <code class="literal">replyChannel</code> message header.
However, there are some cases where the external system might not always return a result (for example,
a <code class="literal">&lt;jdbc:outbound-gateway/&gt;</code> when a SELECT ends with an empty <code class="literal">ResultSet</code> or perhaps a one-way web service).
Consequently, developers needed an option to configure whether or not a reply is required.
For this purpose, we introduced the <code class="literal">requires-reply</code> attribute for outbound gateway components.
In most cases, the default value for <code class="literal">requires-reply</code> is <code class="literal">true</code>.
If there is no result, a <code class="literal">ReplyRequiredException</code> is thrown.
Changing the value to <code class="literal">false</code> means that, if an external service does not return anything, the message flow ends at that point, similar to an outbound channel adapter.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The WebService outbound gateway has an additional attribute called <code class="literal">ignore-empty-responses</code>.
It is used to treat an empty <code class="literal">String</code> response as if no response were received.
By default, it is <code class="literal">true</code>, but you can set it to <code class="literal">false</code> to allow the application to receive an empty <code class="literal">String</code> in the reply message payload.
When the attribute is <code class="literal">true</code>, an empty string is treated as no response for the purposes of the <code class="literal">requires-reply</code> attribute.
By default, <code class="literal">requires-reply</code> is false for the WebService outbound gateway.</p>
</td></tr></table></div>
<p>Note that the <code class="literal">requiresReply</code> property was previously present but set to <code class="literal">false</code> in the <code class="literal">AbstractReplyProducingMessageHandler</code>, and there was no way to configure it on outbound gateways by using the XML namespace.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>Previously, a gateway receiving no reply would silently end the flow (with a DEBUG log message).
By default, with this change, an exception is now thrown by most gateways.
To revert to the previous behavior, set <code class="literal">requires-reply</code> to <code class="literal">false</code>.</p>
</td></tr></table></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x3.0-amqp-mapping" href="#x3.0-amqp-mapping"></a>AMQP Outbound Gateway Header Mapping</h4></div></div></div>

<p>Previously, the &lt;int-amqp:outbound-gateway/&gt; mapped headers before invoking the message converter, and the converter could overwrite headers such as <code class="literal">content-type</code>.
The outbound adapter maps the headers after the conversion, which means headers like <code class="literal">content-type</code> from the outbound <code class="literal">Message</code> (if present) are used.</p>
<p>Starting with this release, the gateway now maps the headers after the message conversion, consistent with the adapter.
If your application relies on the previous behavior (where the converter&#8217;s headers overrode the mapped headers), you either need to filter those headers (before the message reaches the gateway) or set them appropriately.
The headers affected by the <code class="literal">SimpleMessageConverter</code> are <code class="literal">content-type</code> and <code class="literal">content-encoding</code>.
Custom message converters may set other headers.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x3.0-stored-proc-sql-return-type" href="#x3.0-stored-proc-sql-return-type"></a>Stored Procedure Components Improvements</h4></div></div></div>

<p>For more complex database-specific types not supported by the standard <code class="literal">CallableStatement.getObject</code> method, we introduced two new additional attributes to the <code class="literal">&lt;sql-parameter-definition/&gt;</code> element with OUT-direction:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">type-name</code>
</li><li class="listitem">
<code class="literal">return-type</code>
</li></ul></div>
<p>The <code class="literal">row-mapper</code> attribute of the stored procedure inbound channel adapter <code class="literal">&lt;returning-resultset/&gt;</code> child element now supports a reference to a <code class="literal">RowMapper</code> bean definition.
Previously, it contained only a class name (which is still supported).</p>
<p>For more information, see <a class="xref" href="#stored-procedures" title="21.5&nbsp;Stored Procedures">Section&nbsp;21.5, &#8220;Stored Procedures&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x3.0-ws-outbound-uri-substitution" href="#x3.0-ws-outbound-uri-substitution"></a>Web Service Outbound URI Configuration</h4></div></div></div>

<p>The web service outbound gateway <span class="emphasis"><em>uri</em></span> attribute now supports <code class="literal">&lt;uri-variable/&gt;</code> substitution for all URI schemes supported by Spring Web Services.
For more information, see <a class="xref" href="#outbound-uri" title="37.4&nbsp;Outbound URI Configuration">Section&nbsp;37.4, &#8220;Outbound URI Configuration&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x3.0-redis" href="#x3.0-redis"></a>Redis Adapter Changes</h4></div></div></div>

<p>The Redis inbound channel adapter can now use a <code class="literal">null</code> value for the <code class="literal">serializer</code> property, with the raw data being the message payload.</p>
<p>The Redis outbound channel adapter now has the <code class="literal">topic-expression</code> property to determine the Redis topic for the <code class="literal">Message</code> at runtime.</p>
<p>The Redis inbound channel adapter, in addition to the existing <code class="literal">topics</code> attribute, now has the <code class="literal">topic-patterns</code> attribute.</p>
<p>For more information, see <a class="xref" href="#redis" title="27.&nbsp;Redis Support">Chapter&nbsp;27, <i>Redis Support</i></a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x3.0-advising-filters" href="#x3.0-advising-filters"></a>Advising Filters</h4></div></div></div>

<p>Previously, when a <code class="literal">&lt;filter/&gt;</code> had a <code class="literal">&lt;request-handler-advice-chain/&gt;</code>, the discard action was all performed within the scope of the advice chain (including any downstream flow on the <code class="literal">discard-channel</code>).
The filter element now has an attribute called <code class="literal">discard-within-advice</code> (default: <code class="literal">true</code>) to allow the discard action to be performed after the advice chain completes.
See <a class="xref" href="#advising-filters" title="10.9.6&nbsp;Advising Filters">Section&nbsp;10.9.6, &#8220;Advising Filters&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x3.0-annotation-advice" href="#x3.0-annotation-advice"></a>Advising Endpoints using Annotations</h4></div></div></div>

<p>Request handler advice chains can now be configured using annotations.
See <a class="xref" href="#advising-with-annotations" title="10.9.7&nbsp;Advising Endpoints Using Annotations">Section&nbsp;10.9.7, &#8220;Advising Endpoints Using Annotations&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x3.0-o-t-s-t" href="#x3.0-o-t-s-t"></a>ObjectToStringTransformer Improvements</h4></div></div></div>

<p>This transformer now correctly transforms <code class="literal">byte[]</code> and <code class="literal">char[]</code> payloads to <code class="literal">String</code>.
For more information, see <a class="xref" href="#transformer" title="9.1&nbsp;Transformer">Section&nbsp;9.1, &#8220;Transformer&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x3.0-jpa-changes" href="#x3.0-jpa-changes"></a>JPA Support Changes</h4></div></div></div>

<p>Payloads to persist or merge can now be of type <code class="literal">http://docs.oracle.com/javase/7/docs/api/java/lang/Iterable.html[java.lang.Iterable]</code>.</p>
<p>In that case, each object returned by the <code class="literal">Iterable</code> is treated as an entity and persisted or merged by using the underlying <code class="literal">EntityManager</code>.
Null values returned by the iterator are ignored.</p>
<p>The JPA adapters now have additional attributes to optionally flush and clear entities from the associated persistence context after performing persistence operations.</p>
<p>Retrieving gateways had no mechanism to specify the first record to be retrieved, which is a common use case.
The retrieving gateways now support specifying this parameter by adding the <code class="literal">first-result</code> and <code class="literal">first-result-expression</code> attributes to the gateway definition.
For more information, see <a class="xref" href="#jpa-retrieving-outbound-gateway" title="22.7.5&nbsp;Retrieving Outbound Gateway">Section&nbsp;22.7.5, &#8220;Retrieving Outbound Gateway&#8221;</a>.</p>
<p>The JPA retrieving gateway and inbound adapter now have an attribute to specify the maximum number of results in a result set as an expression.
In addition, we introduced the <code class="literal">max-results</code> attribute to replace <code class="literal">max-number-of-results</code>, which has been deprecated.
<code class="literal">max-results</code> and <code class="literal">max-results-expression</code> are used to provide the maximum number of results or an expression to compute the maximum number of results, respectively, in the result set.</p>
<p>For more information, see <a class="xref" href="#jpa" title="22.&nbsp;JPA Support">Chapter&nbsp;22, <i>JPA Support</i></a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x3.0-dalay-expression" href="#x3.0-dalay-expression"></a>Delayer: delay expression</h4></div></div></div>

<p>Previously, the <code class="literal">&lt;delayer&gt;</code> provided a <code class="literal">delay-header-name</code> attribute to determine the delay value at runtime.
In complex cases, the <code class="literal">&lt;delayer&gt;</code> had to be preceded with a <code class="literal">&lt;header-enricher&gt;</code>.
Spring Integration 3.0 introduced the <code class="literal">expression</code> attribute and <code class="literal">expression</code> child element for dynamic delay determination.
The <code class="literal">delay-header-name</code> attribute is now deprecated, because you can specify the header evaluation in the <code class="literal">expression</code>.
In addition, we introduced the <code class="literal">ignore-expression-failures</code> to control the behavior when an expression evaluation fails.
For more information, see <a class="xref" href="#delayer" title="10.6&nbsp;Delayer">Section&nbsp;10.6, &#8220;Delayer&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x3.0-jdbc-mysql-v5_6_4" href="#x3.0-jdbc-mysql-v5_6_4"></a>JDBC Message Store Improvements</h4></div></div></div>

<p>Spring Integration 3.0 adds a new set of DDL scripts for MySQL version 5.6.4 and higher.
Now MySQL supports fractional seconds and is thus improving the FIFO ordering when polling from a MySQL-based message store.
For more information, see <a class="xref" href="#jdbc-message-store-generic" title="21.4.2&nbsp;The Generic JDBC Message Store">Section&nbsp;21.4.2, &#8220;The Generic JDBC Message Store&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x3.0-event-for-imap-idle" href="#x3.0-event-for-imap-idle"></a>IMAP Idle Connection Exceptions</h4></div></div></div>

<p>Previously, if an IMAP idle connection failed, it was logged, but there was no mechanism to inform an application.
Such exceptions now generate <code class="literal">ApplicationEvent</code> instances.
Applications can obtain these events by using an <code class="literal">&lt;int-event:inbound-channel-adapter&gt;</code> or any <code class="literal">ApplicationListener</code> configured to receive an <code class="literal">ImapIdleExceptionEvent</code> (or one of its super classes).</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x3.0-tcp-headers" href="#x3.0-tcp-headers"></a>Message Headers and TCP</h4></div></div></div>

<p>The TCP connection factories now enable the configuration of a flexible mechanism to transfer selected headers (as well as the payload) over TCP.
A new <code class="literal">TcpMessageMapper</code> enables the selection of the headers, and you need to configure an appropriate serializer or deserializer to write the resulting <code class="literal">Map</code> to the TCP stream.
We added a <code class="literal">MapJsonSerializer</code> as a convenient mechanism to transfer headers and payload over TCP.
For more information, see <a class="xref" href="#ip-headers" title="34.8.3&nbsp;Transferring Headers">Section&nbsp;34.8.3, &#8220;Transferring Headers&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x3.0-jms-mdca-te" href="#x3.0-jms-mdca-te"></a>JMS Message Driven Channel Adapter</h4></div></div></div>

<p>Previously, when configuring a <code class="literal">&lt;message-driven-channel-adapter/&gt;</code>, if you wished to use a specific <code class="literal">TaskExecutor</code>, you had to declare a container bean and provide it to the adapter by setting the <code class="literal">container</code> attribute.
We added the <code class="literal">task-executor</code>, letting it be set directly on the adapter.
This is in addition to several other container attributes that were already available.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x3.0-rmi-ec" href="#x3.0-rmi-ec"></a>RMI Inbound Gateway</h4></div></div></div>

<p>The RMI Inbound Gateway now supports an <code class="literal">error-channel</code> attribute.
See <a class="xref" href="#rmi-inbound" title="29.2&nbsp;Inbound RMI">Section&nbsp;29.2, &#8220;Inbound RMI&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x3.0-xslt-transformer" href="#x3.0-xslt-transformer"></a><code class="literal">XsltPayloadTransformer</code></h4></div></div></div>

<p>You can now specify the transformer factory class name by setting the <code class="literal">transformer-factory-class</code> attribute.
See <code class="literal">&lt;&lt;xml-xslt-payload-transformers&gt;&gt;</code>.</p>
</div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="migration-2.1-2.2" href="#migration-2.1-2.2"></a>I.13&nbsp;Changes between 2.1 and 2.2</h2></div></div></div>

<p>See the <a class="ulink" href="https://github.com/spring-projects/spring-integration/wiki/Spring-Integration-2.1-to-2.2-Migration-Guide" target="_top">Migration Guide</a> for important changes that might affect your applications.
You can find migration guides for all versions back to 2.1 on the <a class="ulink" href="https://github.com/spring-projects/spring-integration/wiki" target="_top">wiki</a>.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="x2.2-new-components" href="#x2.2-new-components"></a>I.13.1&nbsp;New Components</h3></div></div></div>

<p>Version 2.2 added a number of new components.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x2.2-redis-store-adapters" href="#x2.2-redis-store-adapters"></a><code class="literal">RedisStore</code> Inbound and Outbound Channel Adapters</h4></div></div></div>

<p>Spring Integration now has <code class="literal">RedisStore</code> Inbound and Outbound Channel Adapters, letting you write and read <code class="literal">Message</code> payloads to and from Redis collections.
For more information, see <a class="xref" href="#redis-store-outbound-channel-adapter" title="27.6&nbsp;RedisStore Outbound Channel Adapter">Section&nbsp;27.6, &#8220;RedisStore Outbound Channel Adapter&#8221;</a> and <a class="xref" href="#redis-store-inbound-channel-adapter" title="27.5&nbsp;Redis Store Inbound Channel Adapter">Section&nbsp;27.5, &#8220;Redis Store Inbound Channel Adapter&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x2.2-mongo-adapters" href="#x2.2-mongo-adapters"></a>MongoDB Inbound and Outbound Channel Adapters</h4></div></div></div>

<p>Spring Integration now has MongoDB inbound and outbound channel adapters, letting you write and read <code class="literal">Message</code> payloads to and from a MongoDB document store.
For more information, see <a class="xref" href="#mongodb-outbound-channel-adapter" title="25.4&nbsp;MongoDB Outbound Channel Adapter">Section&nbsp;25.4, &#8220;MongoDB Outbound Channel Adapter&#8221;</a> and <a class="xref" href="#mongodb-inbound-channel-adapter" title="25.3&nbsp;MongoDB Inbound Channel Adapter">Section&nbsp;25.3, &#8220;MongoDB Inbound Channel Adapter&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x2.2-jpa" href="#x2.2-jpa"></a>JPA Endpoints</h4></div></div></div>

<p>Spring Integration now includes components for the Java Persistence API (JPA) for retrieving and persisting JPA entity objects.
The JPA Adapter includes the following components:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="link" href="#jpa-inbound-channel-adapter" title="22.5&nbsp;Inbound Channel Adapter">Inbound channel adapter</a>
</li><li class="listitem">
<a class="link" href="#jpa-outbound-channel-adapter" title="22.6&nbsp;Outbound Channel Adapter">Outbound channel adapter</a>
</li><li class="listitem">
<a class="link" href="#jpa-updating-outbound-gateway" title="22.7.2&nbsp;Updating Outbound Gateway">Updating outbound gateway</a>
</li><li class="listitem">
<a class="link" href="#jpa-retrieving-outbound-gateway" title="22.7.5&nbsp;Retrieving Outbound Gateway">Retrieving outbound gateway</a>
</li></ul></div>
<p>For more information, see <a class="xref" href="#jpa" title="22.&nbsp;JPA Support">Chapter&nbsp;22, <i>JPA Support</i></a>.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="x2.2-general" href="#x2.2-general"></a>I.13.2&nbsp;General Changes</h3></div></div></div>

<p>This section describes general changes from version 2.1 to version 2.2.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x2.2-spring-31" href="#x2.2-spring-31"></a>Spring 3.1 Used by Default</h4></div></div></div>

<p>Spring Integration now uses Spring 3.1.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x2.2-handler-advice" href="#x2.2-handler-advice"></a>Adding Behavior to Endpoints</h4></div></div></div>

<p>The ability to add an <code class="literal">&lt;advice-chain/&gt;</code> to a poller has been available for some time.
However, the behavior added by this affects the entire integration flow.
It did not address the ability to add (for example) retry to an individual endpoint.
The 2.2. release introduced the <code class="literal">&lt;request-handler-advice-chain/&gt;</code> to many endpoints.</p>
<p>In addition, we added three standard advice classes for this purpose:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">MessageHandlerRetryAdvice</code>
</li><li class="listitem">
<code class="literal">MessageHandlerCircuitBreakerAdvice</code>
</li><li class="listitem">
<code class="literal">ExpressionEvaluatingMessageHandlerAdvice</code>
</li></ul></div>
<p>For more information, see <a class="xref" href="#message-handler-advice-chain" title="10.9&nbsp;Adding Behavior to Endpoints">Section&nbsp;10.9, &#8220;Adding Behavior to Endpoints&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x2.2-transaction-sync" href="#x2.2-transaction-sync"></a>Transaction Synchronization and Pseudo Transactions</h4></div></div></div>

<p>Pollers can now participate in Spring&#8217;s Transaction Synchronization feature.
This allows for synchronizing such operations as renaming files by an inbound channel adapter, depending on whether the transaction commits or rolls back.</p>
<p>In addition, you can enable these features when no "<code class="literal">real</code>" transaction is present, by means of a <code class="literal">PseudoTransactionManager</code>.</p>
<p>For more information, see <a class="xref" href="#transaction-synchronization" title="C.3&nbsp;Transaction Synchronization">Section&nbsp;C.3, &#8220;Transaction Synchronization&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x2.2-file-adapter" href="#x2.2-file-adapter"></a>File Adapter: Improved File Overwrite and Append Handling</h4></div></div></div>

<p>When using the file outbound channel adapter or the file outbound gateway, you can use a new <code class="literal">mode</code> property.
Prior to Spring Integration 2.2, target files were replaced when they existed.
Now you can specify the following options:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">REPLACE</code> (default)
</li><li class="listitem">
<code class="literal">APPEND</code>
</li><li class="listitem">
<code class="literal">FAIL</code>
</li><li class="listitem">
<code class="literal">IGNORE</code>
</li></ul></div>
<p>For more information, see <a class="xref" href="#file-writing-destination-exists" title="17.2.3&nbsp;Dealing with Existing Destination Files">Section&nbsp;17.2.3, &#8220;Dealing with Existing Destination Files&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x2.2-outbound-gateways" href="#x2.2-outbound-gateways"></a>Reply-Timeout Added to More Outbound Gateways</h4></div></div></div>

<p>The XML Namespace support adds the reply-timeout attribute to the following outbound gateways:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
AMQP Outbound Gateway
</li><li class="listitem">
File Outbound Gateway
</li><li class="listitem">
FTP Outbound Gateway
</li><li class="listitem">
SFTP Outbound Gateway
</li><li class="listitem">
WS Outbound Gateway
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x2.2-amqp-11" href="#x2.2-amqp-11"></a>Spring-AMQP 1.1</h4></div></div></div>

<p>Spring Integration now uses Spring AMQP 1.1.
This enables several features to be used within a Spring Integration application, including the following:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
A fixed reply queue for the outbound gateway
</li><li class="listitem">
HA (mirrored) queues
</li><li class="listitem">
Publisher confirmations
</li><li class="listitem">
Returned messages
</li><li class="listitem">
Support for dead letter exchanges and dead letter queues
</li></ul></div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x2.2-jdbc-11" href="#x2.2-jdbc-11"></a>JDBC Support - Stored Procedures Components</h4></div></div></div>

<div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="_spel_support_2" href="#_spel_support_2"></a>SpEL Support</h5></div></div></div>

<p>When using the stored procedure components of the Spring Integration JDBC Adapter, you can now provide stored procedure names or stored function names by using the Spring Expression Language (SpEL).</p>
<p>Doing so lets you specify the stored procedures to be invoked at runtime.
For example, you can provide stored procedure names that you would like to execute through message headers.
For more information, see <a class="xref" href="#stored-procedures" title="21.5&nbsp;Stored Procedures">Section&nbsp;21.5, &#8220;Stored Procedures&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="_jmx_support" href="#_jmx_support"></a>JMX Support</h5></div></div></div>

<p>The stored procedure components now provide basic JMX support, exposing some of their properties as MBeans:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Stored procedure name
</li><li class="listitem">
Stored procedure name expression
</li><li class="listitem">
<code class="literal">JdbcCallOperations</code> cache statistics
</li></ul></div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x2.2-jdbc-gateway-update-optional" href="#x2.2-jdbc-gateway-update-optional"></a>JDBC Support: Outbound Gateway</h4></div></div></div>

<p>When you use the JDBC outbound gateway, the update query is no longer mandatory.
You can now provide only a select query by using the request message as a source of parameters.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x2.2-jdbc-message-store-channels" href="#x2.2-jdbc-message-store-channels"></a>JDBC Support: Channel-specific Message Store Implementation</h4></div></div></div>

<p>We added a new message channel-specific message store implementation, providing a more scalable solution using database-specific SQL queries.
For more information, see <a class="xref" href="#jdbc-message-store-channels" title="21.4.3&nbsp;Backing Message Channels">Section&nbsp;21.4.3, &#8220;Backing Message Channels&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x2.2-shutdown" href="#x2.2-shutdown"></a>Orderly Shutdown</h4></div></div></div>

<p>We added a method called <code class="literal">stopActiveComponents()</code> to the <code class="literal">IntegrationMBeanExporter</code>.
It allows a Spring Integration application to be shut down in an orderly manner, disallowing new inbound messages to certain adapters and waiting for some time to allow in-flight messages to complete.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x2.2-jms-og" href="#x2.2-jms-og"></a>JMS Outbound Gateway Improvements</h4></div></div></div>

<p>You can now configure the JMS outbound gateway to use a <code class="literal">MessageListener</code> container to receive replies.
Doing so can improve performance of the gateway.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x2.2-o-t-j-t" href="#x2.2-o-t-j-t"></a><code class="literal">ObjectToJsonTransformer</code></h4></div></div></div>

<p>By default, the <code class="literal">ObjectToJsonTransformer</code> now sets the <code class="literal">content-type</code> header to <code class="literal">application/json</code>.
For more information, see <a class="xref" href="#transformer" title="9.1&nbsp;Transformer">Section&nbsp;9.1, &#8220;Transformer&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="httpChanges" href="#httpChanges"></a>HTTP Support</h4></div></div></div>

<p>Java serialization over HTTP is no longer enabled by default.
Previously, when setting an <code class="literal">expected-response-type</code> on a <code class="literal">Serializable</code> object, the <code class="literal">Accept</code> header was not properly set up.
We updated the <code class="literal">SerializingHttpMessageConverter</code> to set the <code class="literal">Accept</code> header to <code class="literal">application/x-java-serialized-object</code>.
However, because this could cause incompatibility with existing applications, we decided to no longer automatically add this converter to the HTTP endpoints.</p>
<p>If you wish to use Java serialization, you need to add the <code class="literal">SerializingHttpMessageConverter</code> to the appropriate endpoints by using the <code class="literal">message-converters</code> attribute (when you use XML configuration) or by using the <code class="literal">setMessageConverters()</code> method (in Java).</p>
<p>Alternatively, you may wish to consider using JSON instead.
It is enabled by having <code class="literal">Jackson</code> on the classpath.</p>
</div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="migration-2.0-2.1" href="#migration-2.0-2.1"></a>I.14&nbsp;Changes between 2.0 and 2.1</h2></div></div></div>

<p>See the <a class="ulink" href="https://github.com/spring-projects/spring-integration/wiki/Spring-Integration-2.0-to-2.1-Migration-Guide" target="_top">Migration Guide</a> for important changes that might affect your applications.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="x2.1-new-components" href="#x2.1-new-components"></a>I.14.1&nbsp;New Components</h3></div></div></div>

<p>Version 2.1 added a number of new components.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x2.1-new-scripting-support" href="#x2.1-new-scripting-support"></a>JSR-223 Scripting Support</h4></div></div></div>

<p>In Spring Integration 2.0, we added support for <a class="ulink" href="http://groovy.codehaus.org/" target="_top">Groovy</a>.
With Spring Integration 2.1, we expanded support for additional languages substantially by implementing support for <a class="ulink" href="http://www.jcp.org/en/jsr/detail?id=223" target="_top">JSR-223</a> ("<code class="literal">Scripting for the Java&#8482; Platform</code>").
Now you have the ability to use any scripting language that supports JSR-223 including:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Javascript
</li><li class="listitem">
Ruby and JRuby
</li><li class="listitem">
Python and Jython
</li><li class="listitem">
Groovy
</li></ul></div>
<p>For further details, see <a class="xref" href="#scripting" title="10.7&nbsp;Scripting Support">Section&nbsp;10.7, &#8220;Scripting Support&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x2.1-new-gemfire-support" href="#x2.1-new-gemfire-support"></a>GemFire Support</h4></div></div></div>

<p>Spring Integration provides support for <a class="ulink" href="http://www.vmware.com/products/application-platform/vfabric-gemfire/overview.html" target="_top">GemFire</a> by providing inbound adapters for entry and continuous query events, an outbound adapter to write entries to the cache, and <a class="ulink" href="http://static.springsource.org/spring-integration/api/org/springframework/integration/store/MessageStore.html" target="_top"><code class="literal">MessageStore</code></a> and <a class="ulink" href="http://static.springsource.org/spring-integration/api/org/springframework/integration/store/MessageGroupStore.html" target="_top"><code class="literal">MessageGroupStore</code></a> implementations.
Spring integration leverages the <a class="ulink" href="http://www.springsource.org/spring-gemfire" target="_top">Spring Gemfire</a> project, providing a thin wrapper over its components.</p>
<p>For further details, see <a class="xref" href="#gemfire" title="19.&nbsp;Pivotal GemFire and Apache Geode Support">Chapter&nbsp;19, <i>Pivotal GemFire and Apache Geode Support</i></a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x2.1-new-amqp-support" href="#x2.1-new-amqp-support"></a>AMQP Support</h4></div></div></div>

<p>Spring Integration 2.1 added several channel adapters for receiving and sending messages by using the <a class="ulink" href="http://www.amqp.org/" target="_top">Advanced Message Queuing Protocol</a> (AMQP).
Furthermore, Spring Integration also provides a point-to-point message channel and a publish-subscribe message channel, both of which are backed by AMQP Exchanges and Queues.</p>
<p>For further details, see <a class="xref" href="#amqp" title="14.&nbsp;AMQP Support">Chapter&nbsp;14, <i>AMQP Support</i></a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x2.1-new-mongodb-support" href="#x2.1-new-mongodb-support"></a>MongoDB Support</h4></div></div></div>

<p>As of version 2.1, Spring Integration provides support for <a class="ulink" href="http://www.mongodb.org/" target="_top">MongoDB</a> by providing a MongoDB-based <code class="literal">MessageStore</code>.</p>
<p>For further details, see <a class="xref" href="#mongodb" title="25.&nbsp;MongoDb Support">Chapter&nbsp;25, <i>MongoDb Support</i></a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x2.1-new-redis-support" href="#x2.1-new-redis-support"></a>Redis Support</h4></div></div></div>

<p>As of version 2.1, Spring Integration supports <a class="ulink" href="http://redis.io/" target="_top">Redis</a>, an advanced key-value store, by providing a Redis-based <code class="literal">MessageStore</code> as well as publish-subscribe messaging adapters.</p>
<p>For further details, see <a class="xref" href="#redis" title="27.&nbsp;Redis Support">Chapter&nbsp;27, <i>Redis Support</i></a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x2.1-new-resource-support" href="#x2.1-new-resource-support"></a>Support for Spring&#8217;s Resource abstraction</h4></div></div></div>

<p>In version 2.1, we introduced a new resource inbound channel adapter that builds upon Spring&#8217;s resource abstraction to support greater flexibility across a variety of actual types of underlying resources, such as a file, a URL, or a classpath resource.
Therefore, it is similar to but more generic than the file inbound channel adapter.</p>
<p>For further details, see <a class="xref" href="#resource-inbound-channel-adapter" title="28.1&nbsp;Resource Inbound Channel Adapter">Section&nbsp;28.1, &#8220;Resource Inbound Channel Adapter&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x2.1-new-stored-proc-support" href="#x2.1-new-stored-proc-support"></a>Stored Procedure Components</h4></div></div></div>

<p>With Spring Integration 2.1, the <code class="literal">JDBC</code> Module also provides stored procedure support by adding several new components, including inbound and outbound channel adapters and an outbound gateway.
The stored procedure support leverages  Spring&#8217;s <a class="ulink" href="http://static.springsource.org/spring/docs/3.0.x/javadoc-api/org/springframework/jdbc/core/simple/SimpleJdbcCall.html" target="_top"><code class="literal">SimpleJdbcCall</code></a> class and consequently supports stored procedures for:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Apache Derby
</li><li class="listitem">
DB2
</li><li class="listitem">
MySQL
</li><li class="listitem">
Microsoft SQL Server
</li><li class="listitem">
Oracle
</li><li class="listitem">
PostgreSQL
</li><li class="listitem">
Sybase
</li></ul></div>
<p>The stored procedure components also support SQL functions for the following databases:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
MySQL
</li><li class="listitem">
Microsoft SQL Server
</li><li class="listitem">
Oracle
</li><li class="listitem">
PostgreSQL
</li></ul></div>
<p>For further details, see <a class="xref" href="#stored-procedures" title="21.5&nbsp;Stored Procedures">Section&nbsp;21.5, &#8220;Stored Procedures&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x2.1-new-xpath-filter-support" href="#x2.1-new-xpath-filter-support"></a>XPath and XML Validating Filter</h4></div></div></div>

<p>Spring Integration 2.1 provides a new XPath-based message filter.
It is part of the <code class="literal">XML</code> module.
The XPath filter lets you filter messages by using XPath Expressions.
We also added documentation for the XML validating filter.</p>
<p>For more details, see <a class="xref" href="#xml-xpath-filter" title="38.7&nbsp;Using the XPath Filter">Section&nbsp;38.7, &#8220;Using the XPath Filter&#8221;</a> and <a class="xref" href="#xml-validating-filter" title="38.9&nbsp;XML Validating Filter">Section&nbsp;38.9, &#8220;XML Validating Filter&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x2.1-new-payload-enricher-support" href="#x2.1-new-payload-enricher-support"></a>Payload Enricher</h4></div></div></div>

<p>Since Spring Integration 2.1, we added the payload enricher.
A payload enricher defines an endpoint that typically passes a <a class="ulink" href="http://static.springsource.org/spring-integration/api/org/springframework/integration/Message.html" target="_top"><code class="literal">Message</code></a> to the exposed request channel and then expects a reply message.
The reply message then becomes the root object for evaluation of expressions to enrich the target payload.</p>
<p>For further details, see <a class="xref" href="#payload-enricher" title="9.2.2&nbsp;Payload Enricher">Section&nbsp;9.2.2, &#8220;Payload Enricher&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x2.1-new-ftp-outbound-gateway" href="#x2.1-new-ftp-outbound-gateway"></a>FTP and SFTP Outbound Gateways</h4></div></div></div>

<p>Spring Integration 2.1 provides two new outbound gateways to interact with remote File Transfer Protocol (FTP) or Secure File Transfer Protocol (SFT) servers.
These two gateways let you directly execute a limited set of remote commands.</p>
<p>For instance, you can use these outbound gateways to list, retrieve, and delete remote files and have the Spring Integration message flow continue with the remote server&#8217;s response.</p>
<p>For further details, see <a class="xref" href="#ftp-outbound-gateway" title="18.9&nbsp;FTP Outbound Gateway">Section&nbsp;18.9, &#8220;FTP Outbound Gateway&#8221;</a> and <a class="xref" href="#sftp-outbound-gateway" title="30.11&nbsp;SFTP Outbound Gateway">Section&nbsp;30.11, &#8220;SFTP Outbound Gateway&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x2.1-new-ftp-session-caching" href="#x2.1-new-ftp-session-caching"></a>FTP Session Caching</h4></div></div></div>

<p>As of version 2.1, we have exposed more flexibility with regards to session management for remote file adapters (for example, FTP, SFTP, and others).</p>
<p>Specifically, we deprecated the <code class="literal">cache-sessions</code> attribute (which is available via the XML namespace support).
As an alternative, we added the <code class="literal">sessionCacheSize</code> and <code class="literal">sessionWaitTimeout</code> attributes on the <code class="literal">CachingSessionFactory</code>.</p>
<p>For further details, see <a class="xref" href="#ftp-session-caching" title="18.10&nbsp;FTP Session Caching">Section&nbsp;18.10, &#8220;FTP Session Caching&#8221;</a> and <a class="xref" href="#sftp-session-caching" title="30.4&nbsp;SFTP Session Caching">Section&nbsp;30.4, &#8220;SFTP Session Caching&#8221;</a>.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="x2.1-framework-refactorings" href="#x2.1-framework-refactorings"></a>I.14.2&nbsp;Framework Refactoring</h3></div></div></div>

<p>We refactored the Spring Integration framework in a number of ways, all described in this section.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x2.1-router-standardization" href="#x2.1-router-standardization"></a>Standardizing Router Configuration</h4></div></div></div>

<p>We standardized router parameters across all router implementations with Spring Integration 2.1 to provide a more consistent user experience.</p>
<p>In Spring Integration 2.1, we removed the <code class="literal">ignore-channel-name-resolution-failures</code> attribute in favor of consolidating its behavior with the <code class="literal">resolution-required</code> attribute.
Also, the <code class="literal">resolution-required</code> attribute now defaults to <code class="literal">true</code>.</p>
<p>Starting with Spring Integration 2.1, routers no longer silently drop any messages if no default output channel was defined.
This means that, by default, routers now require at least one resolved channel (if no <code class="literal">default-output-channel</code> was set) and, by default, throw a <code class="literal">MessageDeliveryException</code> if no channel was determined (or an attempt to send was not successful).</p>
<p>If, however, you do want to drop messages silently, you can set <code class="literal">default-output-channel="nullChannel"</code>.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top">
<p>With the standardization of router parameters and the consolidation of the parameters described earlier, older Spring Integration based applications may break.</p>
</td></tr></table></div>
<p>For further details, see <code class="literal">&lt;&lt;router&gt;&gt;</code>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x2.1-schema-updated" href="#x2.1-schema-updated"></a>XML Schemas updated to 2.1</h4></div></div></div>

<p>Spring Integration 2.1 ships with an updated XML Schema (version 2.1).
It provides many improvements, such as the Router standardizations <a class="link" href="#x2.1-router-standardization" title="Standardizing Router Configuration">discussed earlier</a>.</p>
<p>From now on, developers must always declare the latest XML schema (currently version 2.1).
Alternatively, they can use the version-less schema.
Generally, the best option is to use version-less namespaces, as these automatically use the latest available version of Spring Integration.</p>
<p>The following example declares a version-less Spring Integration namespace:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
   <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
   <span class="hl-attribute">xmlns:int</span>=<span class="hl-value">"http://www.springframework.org/schema/integration"</span>
   <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"http://www.springframework.org/schema/integration
           http://www.springframework.org/schema/integration/spring-integration.xsd
           http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans.xsd"</span><span class="hl-tag">&gt;</span>
...
<span class="hl-tag">&lt;/beans&gt;</span></pre>
</div>
<p>The following example declares a Spring Integration namespace with an explicit version:</p>
<div class="informalexample">
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
   <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
   <span class="hl-attribute">xmlns:int</span>=<span class="hl-value">"http://www.springframework.org/schema/integration"</span>
   <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"http://www.springframework.org/schema/integration
           http://www.springframework.org/schema/integration/spring-integration-2.2.xsd
           http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans.xsd"</span><span class="hl-tag">&gt;</span>
...
<span class="hl-tag">&lt;/beans&gt;</span></pre>
</div>
<p>The old 1.0 and 2.0 schemas are still there.
However, if an application context still references one of those deprecated schemas, the validator fails on initialization.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="x2.1-source-control-infrastructure" href="#x2.1-source-control-infrastructure"></a>I.14.3&nbsp;Source Control Management and Build Infrastructure</h3></div></div></div>

<p>Version 2.1 introduced a number of changes to source control management and build infrastructure.
This section covers those changes.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x2.1-move-to-github" href="#x2.1-move-to-github"></a>Source Code Now Hosted on Github</h4></div></div></div>

<p>Since version 2.0, the Spring Integration project uses <a class="ulink" href="http://git-scm.com/" target="_top">Git</a> for version control.
To increase community visibility even further, the project was moved from SpringSource hosted Git repositories to <a class="ulink" href="http://www.github.com/" target="_top">Github</a>.
The Spring Integration Git repository is located at: <a class="ulink" href="https://github.com/spring-projects/spring-integration" target="_top">spring-integration</a>.</p>
<p>For the project, we also improved the process of providing code contributions.
Further, we ensure that every commit is peer-reviewed.
In fact, core committers now follow the same process as contributors.
For more details, see <a class="ulink" href="https://github.com/spring-projects/spring-integration/blob/master/CONTRIBUTING.adoc" target="_top">Contributing</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="x2.1-sonar" href="#x2.1-sonar"></a>Improved Source Code Visibility with Sonar</h4></div></div></div>

<p>In an effort to provide better source code visibility and consequently to monitor the quality of Spring Integration&#8217;s source code, we set up an instance of <a class="ulink" href="http://www.sonarsource.org/" target="_top">Sonar</a>.
We gather metrics nightly and make them available at <a class="ulink" href="https://sonar.spring.io/dashboard?id=org.springframework.integration%3Aspring-integration%3Amaster" target="_top">sonar.spring.io</a>.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="x2.1-new-samples" href="#x2.1-new-samples"></a>I.14.4&nbsp;New Samples</h3></div></div></div>

<p>For the 2.1 release of Spring Integration, we also expanded the Spring Integration Samples project and added many new samples, such as samples that cover AMQP support, a sample that showcases the new payload enricher, a sample illustrating techniques for testing Spring Integration flow fragments, and a sample for executing stored procedures against Oracle databases.
For details, visit <a class="ulink" href="https://github.com/spring-projects/spring-integration-samples" target="_top">spring-integration-samples</a>.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="migration-1.0-2.0" href="#migration-1.0-2.0"></a>I.15&nbsp;Changes between Versions 1.0 and 2.0</h2></div></div></div>

<p>See the <a class="ulink" href="https://github.com/spring-projects/spring-integration/wiki/Spring-Integration-1.0-to-2.0-Migration-Guide" target="_top">Migration Guide</a> for important changes that might affect your applications.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="migration-spring-30-support" href="#migration-spring-30-support"></a>I.15.1&nbsp;Spring 3 support</h3></div></div></div>

<p>Spring Integration 2.0 is built on top of Spring 3.0.5 and makes many of its features available to our users.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="spel-support" href="#spel-support"></a>Support for the Spring Expression Language (SpEL)</h4></div></div></div>

<p>You can now use SpEL expressions within the transformer, router, filter, splitter, aggregator, service-activator, header-enricher, and many more elements of the Spring Integration core namespace as well as within various adapters.
This guide includes many samples.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="conversion-support" href="#conversion-support"></a>Conversion Service and Converter</h4></div></div></div>

<p>You can now benefit from the conversion service support provided with Spring while configuring many Spring Integration components, such as a <a class="ulink" href="http://www.eaipatterns.com/DatatypeChannel.html" target="_top">Datatype channel</a>.
See <a class="xref" href="#channel-implementations" title="6.1.2&nbsp;Message Channel Implementations">Section&nbsp;6.1.2, &#8220;Message Channel Implementations&#8221;</a> and <a class="xref" href="#">???</a>.
Also, the SpEL support mentioned in the previous point also relies upon the conversion service.
Therefore, you can register converters once and take advantage of them anywhere you use SpEL expressions.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="task-scheduler-poller-support" href="#task-scheduler-poller-support"></a><code class="literal">TaskScheduler</code> and <code class="literal">Trigger</code></h4></div></div></div>

<p>Spring 3.0 defines two new strategies related to scheduling: <code class="literal">TaskScheduler</code> and <code class="literal">Trigger</code>.
Spring Integration (which uses a lot of scheduling) now builds upon these.
In fact, Spring Integration 1.0 had originally defined some of the components (such as <code class="literal">CronTrigger</code>) that have now been migrated into Spring 3.0&#8217;s core API.
Now you can benefit from reusing the same components within the entire application context (not just Spring Integration configuration).
We also greatly simplified configuration of Spring Integration pollers by providing attributes for directly configuring rates, delays, cron expressions, and trigger references.
See <a class="xref" href="#channel-adapter" title="6.3&nbsp;Channel Adapter">Section&nbsp;6.3, &#8220;Channel Adapter&#8221;</a> for sample configurations.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="rest-support" href="#rest-support"></a><code class="literal">RestTemplate</code> and <code class="literal">HttpMessageConverter</code></h4></div></div></div>

<p>Our outbound HTTP adapters now delegate to Spring&#8217;s <code class="literal">RestTemplate</code> for executing the HTTP request and handling its response.
This also means that you can reuse any custom <code class="literal">HttpMessageConverter</code> implementations.
See <a class="xref" href="#http-outbound" title="20.2&nbsp;HTTP Outbound Components">Section&nbsp;20.2, &#8220;HTTP Outbound Components&#8221;</a> for more details.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="new-eip" href="#new-eip"></a>I.15.2&nbsp;Enterprise Integration Pattern Additions</h3></div></div></div>

<p>Also in 2.0, we have added support for even more of the patterns described in Hohpe and Woolf&#8217;s <a class="ulink" href="http://www.eaipatterns.com/" target="_top">Enterprise Integration Patterns</a> book.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="new-message-history" href="#new-message-history"></a>Message History</h4></div></div></div>

<p>We now provide support for the <a class="ulink" href="http://www.eaipatterns.com/MessageHistory.html" target="_top">message history</a> pattern, letting you keep track of all traversed components, including the name of each channel and endpoint as well as the timestamp of that traversal.
See <a class="xref" href="#message-history" title="12.3&nbsp;Message History">Section&nbsp;12.3, &#8220;Message History&#8221;</a> for more details.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="new-message-store" href="#new-message-store"></a>Message Store</h4></div></div></div>

<p>We now provide support for the <a class="ulink" href="http://www.eaipatterns.com/MessageStore.html" target="_top">message store</a> pattern.
The message store provides a strategy for persisting messages on behalf of any process whose scope extends beyond a single transaction, such as the aggregator and the resequencer.
Many sections of this guide include samples of how to use a message store, as it affects several areas of Spring Integration.
See <a class="xref" href="#message-store" title="12.4&nbsp;Message Store">Section&nbsp;12.4, &#8220;Message Store&#8221;</a>, <a class="xref" href="#claim-check" title="9.3&nbsp;Claim Check">Section&nbsp;9.3, &#8220;Claim Check&#8221;</a>, <a class="xref" href="#channel" title="6.1&nbsp;Message Channels">Section&nbsp;6.1, &#8220;Message Channels&#8221;</a>, <a class="xref" href="#aggregator" title="8.4&nbsp;Aggregator">Section&nbsp;8.4, &#8220;Aggregator&#8221;</a>, <a class="xref" href="#jdbc" title="21.&nbsp;JDBC Support">Chapter&nbsp;21, <i>JDBC Support</i></a>`", and <a class="xref" href="#resequencer" title="8.5&nbsp;Resequencer">Section&nbsp;8.5, &#8220;Resequencer&#8221;</a> for more details.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="new-claim-check" href="#new-claim-check"></a>Claim Check</h4></div></div></div>

<p>We have added an implementation of the <a class="ulink" href="http://www.eaipatterns.com/StoreInLibrary.html" target="_top">claim check</a> pattern.
The idea behind the claim check pattern is that you can exchange a message payload for a "<code class="literal">claim ticket</code>".
This lets you reduce bandwidth and avoid potential security issues when sending messages across channels.
See <a class="xref" href="#claim-check" title="9.3&nbsp;Claim Check">Section&nbsp;9.3, &#8220;Claim Check&#8221;</a> for more details.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="new-control-bus" href="#new-control-bus"></a>Control Bus</h4></div></div></div>

<p>We have provided implementations of the <a class="ulink" href="http://www.eaipatterns.com/ControlBus.html" target="_top">control bus</a> pattern, which lets you use messaging to manage and monitor endpoints and channels.
The implementations include both a SpEL-based approach and one that runs Groovy scripts.
See <a class="xref" href="#control-bus" title="12.6&nbsp;Control Bus">Section&nbsp;12.6, &#8220;Control Bus&#8221;</a> and <a class="xref" href="#groovy-control-bus" title="10.8.4&nbsp;Control Bus">Section&nbsp;10.8.4, &#8220;Control Bus&#8221;</a> for more details.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="new-adapters" href="#new-adapters"></a>I.15.3&nbsp;New Channel Adapters and Gateways</h3></div></div></div>

<p>We have added several new channel adapters and messaging gateways in Spring Integration 2.0.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="new-ip" href="#new-ip"></a>TCP and UDP Adapters</h4></div></div></div>

<p>We have added channel adapters for receiving and sending messages over the TCP and UDP internet protocols.
See <a class="xref" href="#ip" title="34.&nbsp;TCP and UDP Support">Chapter&nbsp;34, <i>TCP and UDP Support</i></a> for more details.
See also the following blog: <a class="ulink" href="http://blog.springsource.com/2010/03/29/using-udp-and-tcp-adapters-in-spring-integration-2-0-m3/" target="_top">"<code class="literal">Using UDP and TCP Adapters in Spring Integration 2.0 M3</code>"</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="new-twitter" href="#new-twitter"></a>Twitter Adapters</h4></div></div></div>

<p>Twitter adapters provides support for sending and receiving Twitter status updates as well as direct messages.
You can also perform Twitter Searches with an inbound channel adapter.
See <a class="ulink" href="https://github.com/spring-projects/spring-integration-extensions/tree/master/spring-integration-social-twitter" target="_top">Spring Integration Social Twitter</a> for more details.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="new-xmpp" href="#new-xmpp"></a>XMPP Adapters</h4></div></div></div>

<p>The new XMPP adapters support both chat messages and presence events.
See <a class="xref" href="#xmpp" title="39.&nbsp;XMPP Support">Chapter&nbsp;39, <i>XMPP Support</i></a> for more details.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="new-ftp" href="#new-ftp"></a>FTP and FTPS Adapters</h4></div></div></div>

<p>Inbound and outbound file transfer support over FTP and FTPS is now available.
See <a class="xref" href="#ftp" title="18.&nbsp;FTP/FTPS Adapters">Chapter&nbsp;18, <i>FTP/FTPS Adapters</i></a> for more details.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="new-sftp" href="#new-sftp"></a>SFTP Adapters</h4></div></div></div>

<p>Inbound and outbound file transfer support over SFTP is now available.
See <a class="xref" href="#sftp" title="30.&nbsp;SFTP Adapters">Chapter&nbsp;30, <i>SFTP Adapters</i></a> for more details.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="new-feed" href="#new-feed"></a>Feed Adapters</h4></div></div></div>

<p>We have also added channel adapters for receiving news feeds (ATOM and RSS).
See <a class="xref" href="#feed" title="16.&nbsp;Feed Adapter">Chapter&nbsp;16, <i>Feed Adapter</i></a> for more details.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="new-other" href="#new-other"></a>I.15.4&nbsp;Other Additions</h3></div></div></div>

<p>Spring Integration adds a number of other features. This section describes them.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="new-groovy" href="#new-groovy"></a>Groovy Support</h4></div></div></div>

<p>Spring Integration 2.0 added Groovy support, letting you use the Groovy scripting language to provide integration and business logic.
See <a class="xref" href="#groovy" title="10.8&nbsp;Groovy support">Section&nbsp;10.8, &#8220;Groovy support&#8221;</a> for more details.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="new-map-transformer" href="#new-map-transformer"></a>Map Transformers</h4></div></div></div>

<p>These symmetrical transformers convert payload objects to and from <code class="literal">Map</code> objects.
See <a class="xref" href="#transformer" title="9.1&nbsp;Transformer">Section&nbsp;9.1, &#8220;Transformer&#8221;</a> for more details.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="new-json-transformer" href="#new-json-transformer"></a>JSON Transformers</h4></div></div></div>

<p>These symmetrical transformers convert payload objects to and from JSON.
See <a class="xref" href="#transformer" title="9.1&nbsp;Transformer">Section&nbsp;9.1, &#8220;Transformer&#8221;</a> for more details.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="new-serialize-transformer" href="#new-serialize-transformer"></a>Serialization Transformers</h4></div></div></div>

<p>These symmetrical transformers convert payload objects to and from byte arrays.
They also support the serializer and deserializer strategy interfaces that Spring 3.0.5 added.
See <a class="xref" href="#transformer" title="9.1&nbsp;Transformer">Section&nbsp;9.1, &#8220;Transformer&#8221;</a> for more details.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="new-refactoring" href="#new-refactoring"></a>I.15.5&nbsp;Framework Refactoring</h3></div></div></div>

<p>The core API went through some significant refactoring to make it simpler and more usable.
Although we anticipate that the impact to developers should be minimal, you should read through this document to find what was changed.
Specifically, you should read <a class="xref" href="#dynamic-routers" title="8.1.6&nbsp;Dynamic Routers">Section&nbsp;8.1.6, &#8220;Dynamic Routers&#8221;</a>, <a class="xref" href="#gateway" title="10.4&nbsp;Messaging Gateways">Section&nbsp;10.4, &#8220;Messaging Gateways&#8221;</a>, <a class="xref" href="#http-outbound" title="20.2&nbsp;HTTP Outbound Components">Section&nbsp;20.2, &#8220;HTTP Outbound Components&#8221;</a>, <a class="xref" href="#message" title="7.&nbsp;Message">Chapter&nbsp;7, <i>Message</i></a>, and <a class="xref" href="#aggregator" title="8.4&nbsp;Aggregator">Section&nbsp;8.4, &#8220;Aggregator&#8221;</a>.
If you directly depend on some of the core components (<code class="literal">Message</code>, <code class="literal">MessageHeaders</code>, <code class="literal">MessageChannel</code>, <code class="literal">MessageBuilder</code>, and others), you need to update any import statements.
We restructured some packaging to provide the flexibility we needed for extending the domain model while avoiding any cyclical dependencies (it is a policy of the framework to avoid such "<code class="literal">tangles</code>").</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="new-infrastructure" href="#new-infrastructure"></a>I.15.6&nbsp;New Source Control Management and Build Infrastructure</h3></div></div></div>

<p>With Spring Integration 2.0, we switched our build environment to use Git for source control.
To access our repository, visit <a class="ulink" href="http://git.springsource.org/spring-integration" target="_top">http://git.springsource.org/spring-integration</a>.
We have also switched our build system to <a class="ulink" href="http://gradle.org/" target="_top">Gradle</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="new-samples" href="#new-samples"></a>I.15.7&nbsp;New Spring Integration Samples</h3></div></div></div>

<p>With Spring Integration 2.0, we have decoupled the samples from our main release distribution.
Please read the following blog to get more information: <a class="ulink" href="http://blog.springsource.com/2010/09/29/new-spring-integration-samples/" target="_top">New Spring Integration Samples</a>. We have also created many new samples, including samples for every new adapter.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="new-sts" href="#new-sts"></a>I.15.8&nbsp;Spring Tool Suite Visual Editor for Spring Integration</h3></div></div></div>

<p>There is an amazing new visual editor for Spring Integration included within the latest version of SpringSource Tool Suite.
If you are not already using STS, you can download it athttps://spring.io/tools/sts[Spring Tool Suite].</p>
</div>
</div>
</div>
</div>
</div></body></html>