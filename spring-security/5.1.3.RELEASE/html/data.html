<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>14.&nbsp;Spring Data Integration</title><link rel="stylesheet" type="text/css" href="css/manual-multipage.css"><meta name="generator" content="DocBook XSL Stylesheets V1.78.1"><link rel="home" href="index.html" title="Spring Security Reference"><link rel="up" href="servlet-applications.html" title="Part&nbsp;II.&nbsp;Servlet Applications"><link rel="prev" href="servlet-webclient.html" title="13.&nbsp;WebClient for Servlet Environments"><link rel="next" href="appendix.html" title="15.&nbsp;Appendix"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">14.&nbsp;Spring Data Integration</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="servlet-webclient.html">Prev</a>&nbsp;</td><th width="60%" align="center">Part&nbsp;II.&nbsp;Servlet Applications</th><td width="20%" align="right">&nbsp;<a accesskey="n" href="appendix.html">Next</a></td></tr></table><hr></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="data" href="#data"></a>14.&nbsp;Spring Data Integration</h2></div></div></div>

<p>Spring Security provides Spring Data integration that allows referring to the current user within your queries.
It is not only useful but necessary to include the user in the queries to support paged results since filtering the results afterwards would not scale.</p>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="data-configuration" href="#data-configuration"></a>14.1&nbsp;Spring Data &amp; Spring Security Configuration</h2></div></div></div>

<p>To use this support, add <code class="literal">org.springframework.security:spring-security-data</code> dependency and provide a bean of type <code class="literal">SecurityEvaluationContextExtension</code>.
In Java Configuration, this would look like:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Bean</span></em>
<span class="hl-keyword">public</span> SecurityEvaluationContextExtension securityEvaluationContextExtension() {
    <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> SecurityEvaluationContextExtension();
}</pre>
<p>In XML Configuration, this would look like:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.security.data.repository.query.SecurityEvaluationContextExtension"</span><span class="hl-tag">/&gt;</span></pre>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="data-query" href="#data-query"></a>14.2&nbsp;Security Expressions within @Query</h2></div></div></div>

<p>Now Spring Security can be used within your queries.
For example:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Repository</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> MessageRepository <span class="hl-keyword">extends</span> PagingAndSortingRepository&lt;Message,Long&gt; {
    <em><span class="hl-annotation" style="color: gray">@Query("select m from Message m where m.to.id = ?#{ principal?.id }")</span></em>
    Page&lt;Message&gt; findInbox(Pageable pageable);
}</pre>
<p>This checks to see if the <code class="literal">Authentication.getPrincipal().getId()</code> is equal to the recipient of the <code class="literal">Message</code>.
Note that this example assumes you have customized the principal to be an Object that has an id property.
By exposing the <code class="literal">SecurityEvaluationContextExtension</code> bean, all of the <a class="link" href="authorization.html#common-expressions" title="Table&nbsp;11.1.&nbsp;Common built-in expressions">Common Security Expressions</a> are available within the Query.</p>
</div>
</div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="servlet-webclient.html">Prev</a>&nbsp;</td><td width="20%" align="center"><a accesskey="u" href="servlet-applications.html">Up</a></td><td width="40%" align="right">&nbsp;<a accesskey="n" href="appendix.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">13.&nbsp;WebClient for Servlet Environments&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top">&nbsp;15.&nbsp;Appendix</td></tr></table></div></body></html>